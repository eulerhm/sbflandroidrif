<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArrowView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.view</a> &gt; <span class="el_source">ArrowView.java</span></div><h1>ArrowView.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2014 Sean J. Barbeau (sjbarbeau@gmail.com), University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.view;

import org.onebusaway.android.R;
import org.onebusaway.android.util.LocationHelper;
import org.onebusaway.android.util.MathUtils;
import org.onebusaway.android.util.OrientationHelper;
import android.content.Context;
import android.graphics.Canvas;
import android.graphics.Color;
import android.graphics.Matrix;
import android.graphics.Paint;
import android.graphics.Path;
import android.location.Location;
import android.util.AttributeSet;
import android.view.View;
import java.util.ArrayList;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * View that draws an arrow that points towards the given bus mStop
 */
public class ArrowView extends View implements OrientationHelper.Listener, LocationHelper.Listener {

    public interface Listener {

        /**
         * Called when the ArrowView is showing information to the user
         */
        void onInitializationComplete();
    }

<span class="nc" id="L47">    ArrayList&lt;Listener&gt; mListeners = new ArrayList&lt;Listener&gt;();</span>

    private float mHeading;

    private Paint mArrowPaint;

    private Paint mArrowFillPaint;

    private Location mLastLocation;

<span class="nc" id="L57">    Location mStopLocation = new Location(&quot;stopLocation&quot;);</span>

    float mBearingToStop;

<span class="nc" id="L61">    boolean mInitialized = false;</span>

    public ArrowView(Context context, AttributeSet attrs) {
<span class="nc" id="L64">        super(context, attrs);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10575)) {</span>
<span class="nc" id="L66">            mArrowPaint = new Paint();</span>
        }
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10576)) {</span>
<span class="nc" id="L69">            mArrowPaint.setColor(Color.WHITE);</span>
        }
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10577)) {</span>
<span class="nc" id="L72">            mArrowPaint.setStyle(Paint.Style.STROKE);</span>
        }
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10578)) {</span>
<span class="nc" id="L75">            mArrowPaint.setStrokeWidth(4.0f);</span>
        }
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10579)) {</span>
<span class="nc" id="L78">            mArrowPaint.setAntiAlias(true);</span>
        }
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10580)) {</span>
<span class="nc" id="L81">            mArrowFillPaint = new Paint();</span>
        }
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10581)) {</span>
<span class="nc" id="L84">            mArrowFillPaint.setColor(Color.WHITE);</span>
        }
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10582)) {</span>
<span class="nc" id="L87">            mArrowFillPaint.setStyle(Paint.Style.FILL);</span>
        }
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10583)) {</span>
<span class="nc" id="L90">            mArrowFillPaint.setStrokeWidth(4.0f);</span>
        }
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10584)) {</span>
<span class="nc" id="L93">            mArrowFillPaint.setAntiAlias(true);</span>
        }
<span class="nc" id="L95">    }</span>

    public void setStopLocation(Location location) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10585)) {</span>
<span class="nc" id="L99">            mStopLocation = location;</span>
        }
<span class="nc" id="L101">    }</span>

    public synchronized void registerListener(Listener listener) {
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10587)) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (!mListeners.contains(listener)) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10586)) {</span>
<span class="nc" id="L107">                    mListeners.add(listener);</span>
                }
            }
        }
<span class="nc" id="L111">    }</span>

    public synchronized void unregisterListener(Listener listener) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10589)) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (mListeners.contains(listener)) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10588)) {</span>
<span class="nc" id="L117">                    mListeners.remove(listener);</span>
                }
            }
        }
<span class="nc" id="L121">    }</span>

    /**
     * Returns true if the view is initialized and ready to draw to the screen, false if it is not
     *
     * @return true if the view is initialized and ready to draw to the screen, false if it is not
     */
    public boolean isInitialized() {
<span class="nc" id="L129">        return mInitialized;</span>
    }

    @Override
    protected void onDraw(Canvas canvas) {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10591)) {</span>
<span class="nc bnc" id="L135" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(10590) ? (mStopLocation == null &amp;&amp; mLastLocation == null) : (mStopLocation == null || mLastLocation == null))) {</span>
<span class="nc" id="L136">                return;</span>
            }
        }
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10592)) {</span>
<span class="nc" id="L140">            drawArrow(canvas);</span>
        }
<span class="nc" id="L142">    }</span>

    @Override
    public void onOrientationChanged(float heading, float pitch, float xDelta, float yDelta) {
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10593)) {</span>
<span class="nc" id="L147">            mHeading = heading;</span>
        }
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10594)) {</span>
<span class="nc" id="L150">            invalidate();</span>
        }
<span class="nc" id="L152">    }</span>

    @Override
    public void onLocationChanged(Location location) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10595)) {</span>
<span class="nc" id="L157">            mLastLocation = location;</span>
        }
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10609)) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (mStopLocation != null) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10599)) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                    if (!mInitialized) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10596)) {</span>
<span class="nc" id="L164">                            mInitialized = true;</span>
                        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10598)) {</span>
                            {
<span class="nc" id="L168">                                long _loopCounter139 = 0;</span>
                                // Notify listeners that we have both stop and real-time location and can draw
<span class="nc bnc" id="L170" title="All 2 branches missed.">                                for (Listener l : mListeners) {</span>
<span class="nc" id="L171">                                    ListenerUtil.loopListener.listen(&quot;_loopCounter139&quot;, ++_loopCounter139);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(10597)) {</span>
<span class="nc" id="L173">                                        l.onInitializationComplete();</span>
                                    }
<span class="nc" id="L175">                                }</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L180" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10600)) {</span>
<span class="nc" id="L181">                    mBearingToStop = location.bearingTo(mStopLocation);</span>
                }
<span class="nc bnc" id="L183" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10607)) {</span>
                    // See http://stackoverflow.com/a/8043485/937715
<span class="nc bnc" id="L185" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(10605) ? (mBearingToStop &gt;= 0) : (ListenerUtil.mutListener.listen(10604) ? (mBearingToStop &lt;= 0) : (ListenerUtil.mutListener.listen(10603) ? (mBearingToStop &gt; 0) : (ListenerUtil.mutListener.listen(10602) ? (mBearingToStop != 0) : (ListenerUtil.mutListener.listen(10601) ? (mBearingToStop == 0) : (mBearingToStop &lt; 0))))))) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10606)) {</span>
<span class="nc" id="L187">                            mBearingToStop += 360;</span>
                        }
                    }
                }
<span class="nc bnc" id="L191" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10608)) {</span>
<span class="nc" id="L192">                    invalidate();</span>
                }
            }
        }
<span class="nc" id="L196">    }</span>

    private void drawArrow(Canvas c) {
<span class="nc" id="L199">        int height = getHeight();</span>
<span class="nc" id="L200">        int width = getWidth();</span>
        // Create a buffer around the arrow so when it rotates it doesn't get clipped by view edge
<span class="nc bnc" id="L202" title="All 8 branches missed.">        final float BUFFER = (ListenerUtil.mutListener.listen(10613) ? (width % 5) : (ListenerUtil.mutListener.listen(10612) ? (width * 5) : (ListenerUtil.mutListener.listen(10611) ? (width - 5) : (ListenerUtil.mutListener.listen(10610) ? (width + 5) : (width / 5)))));</span>
        // Height of the cutout in the bottom of the triangle that makes it an arrow (0=triangle)
<span class="nc bnc" id="L204" title="All 8 branches missed.">        final float CUTOUT_HEIGHT = (ListenerUtil.mutListener.listen(10617) ? (getHeight() % 5) : (ListenerUtil.mutListener.listen(10616) ? (getHeight() * 5) : (ListenerUtil.mutListener.listen(10615) ? (getHeight() - 5) : (ListenerUtil.mutListener.listen(10614) ? (getHeight() + 5) : (getHeight() / 5)))));</span>
        // Tip of arrow
        float x1, y1;
<span class="nc bnc" id="L207" title="All 8 branches missed.">        x1 = (ListenerUtil.mutListener.listen(10621) ? (width % 2) : (ListenerUtil.mutListener.listen(10620) ? (width * 2) : (ListenerUtil.mutListener.listen(10619) ? (width - 2) : (ListenerUtil.mutListener.listen(10618) ? (width + 2) : (width / 2)))));</span>
<span class="nc" id="L208">        y1 = BUFFER;</span>
        // lower left
        float x2, y2;
<span class="nc" id="L211">        x2 = BUFFER;</span>
<span class="nc bnc" id="L212" title="All 8 branches missed.">        y2 = (ListenerUtil.mutListener.listen(10625) ? (height % BUFFER) : (ListenerUtil.mutListener.listen(10624) ? (height / BUFFER) : (ListenerUtil.mutListener.listen(10623) ? (height * BUFFER) : (ListenerUtil.mutListener.listen(10622) ? (height + BUFFER) : (height - BUFFER)))));</span>
        // cutout in arrow bottom
        float x3, y3;
<span class="nc bnc" id="L215" title="All 8 branches missed.">        x3 = (ListenerUtil.mutListener.listen(10629) ? (width % 2) : (ListenerUtil.mutListener.listen(10628) ? (width * 2) : (ListenerUtil.mutListener.listen(10627) ? (width - 2) : (ListenerUtil.mutListener.listen(10626) ? (width + 2) : (width / 2)))));</span>
<span class="nc bnc" id="L216" title="All 48 branches missed.">        y3 = (ListenerUtil.mutListener.listen(10637) ? ((ListenerUtil.mutListener.listen(10633) ? (height % CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10632) ? (height / CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10631) ? (height * CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10630) ? (height + CUTOUT_HEIGHT) : (height - CUTOUT_HEIGHT))))) % BUFFER) : (ListenerUtil.mutListener.listen(10636) ? ((ListenerUtil.mutListener.listen(10633) ? (height % CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10632) ? (height / CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10631) ? (height * CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10630) ? (height + CUTOUT_HEIGHT) : (height - CUTOUT_HEIGHT))))) / BUFFER) : (ListenerUtil.mutListener.listen(10635) ? ((ListenerUtil.mutListener.listen(10633) ? (height % CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10632) ? (height / CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10631) ? (height * CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10630) ? (height + CUTOUT_HEIGHT) : (height - CUTOUT_HEIGHT))))) * BUFFER) : (ListenerUtil.mutListener.listen(10634) ? ((ListenerUtil.mutListener.listen(10633) ? (height % CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10632) ? (height / CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10631) ? (height * CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10630) ? (height + CUTOUT_HEIGHT) : (height - CUTOUT_HEIGHT))))) + BUFFER) : ((ListenerUtil.mutListener.listen(10633) ? (height % CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10632) ? (height / CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10631) ? (height * CUTOUT_HEIGHT) : (ListenerUtil.mutListener.listen(10630) ? (height + CUTOUT_HEIGHT) : (height - CUTOUT_HEIGHT))))) - BUFFER)))));</span>
        // lower right
        float x4, y4;
<span class="nc bnc" id="L219" title="All 8 branches missed.">        x4 = (ListenerUtil.mutListener.listen(10641) ? (width % BUFFER) : (ListenerUtil.mutListener.listen(10640) ? (width / BUFFER) : (ListenerUtil.mutListener.listen(10639) ? (width * BUFFER) : (ListenerUtil.mutListener.listen(10638) ? (width + BUFFER) : (width - BUFFER)))));</span>
<span class="nc bnc" id="L220" title="All 8 branches missed.">        y4 = (ListenerUtil.mutListener.listen(10645) ? (height % BUFFER) : (ListenerUtil.mutListener.listen(10644) ? (height / BUFFER) : (ListenerUtil.mutListener.listen(10643) ? (height * BUFFER) : (ListenerUtil.mutListener.listen(10642) ? (height + BUFFER) : (height - BUFFER)))));</span>
<span class="nc" id="L221">        Path path = new Path();</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10646)) {</span>
<span class="nc" id="L223">            path.setFillType(Path.FillType.EVEN_ODD);</span>
        }
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10647)) {</span>
<span class="nc" id="L226">            path.moveTo(x1, y1);</span>
        }
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10648)) {</span>
<span class="nc" id="L229">            path.lineTo(x2, y2);</span>
        }
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10649)) {</span>
<span class="nc" id="L232">            path.lineTo(x3, y3);</span>
        }
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10650)) {</span>
<span class="nc" id="L235">            path.lineTo(x4, y4);</span>
        }
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10651)) {</span>
<span class="nc" id="L238">            path.lineTo(x1, y1);</span>
        }
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10652)) {</span>
<span class="nc" id="L241">            path.close();</span>
        }
<span class="nc bnc" id="L243" title="All 8 branches missed.">        float direction = (ListenerUtil.mutListener.listen(10656) ? (mHeading % mBearingToStop) : (ListenerUtil.mutListener.listen(10655) ? (mHeading / mBearingToStop) : (ListenerUtil.mutListener.listen(10654) ? (mHeading * mBearingToStop) : (ListenerUtil.mutListener.listen(10653) ? (mHeading + mBearingToStop) : (mHeading - mBearingToStop)))));</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10657)) {</span>
            // Make sure value is between 0-360
<span class="nc" id="L246">            direction = MathUtils.mod(direction, 360.0f);</span>
        }
        // Rotate arrow around center point
<span class="nc" id="L249">        Matrix matrix = new Matrix();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10666)) {</span>
<span class="nc bnc" id="L251" title="All 16 branches missed.">            matrix.postRotate((float) -direction, (ListenerUtil.mutListener.listen(10661) ? (width % 2) : (ListenerUtil.mutListener.listen(10660) ? (width * 2) : (ListenerUtil.mutListener.listen(10659) ? (width - 2) : (ListenerUtil.mutListener.listen(10658) ? (width + 2) : (width / 2))))), (ListenerUtil.mutListener.listen(10665) ? (height % 2) : (ListenerUtil.mutListener.listen(10664) ? (height * 2) : (ListenerUtil.mutListener.listen(10663) ? (height - 2) : (ListenerUtil.mutListener.listen(10662) ? (height + 2) : (height / 2))))));</span>
        }
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10667)) {</span>
<span class="nc" id="L254">            path.transform(matrix);</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10668)) {</span>
<span class="nc" id="L257">            c.drawPath(path, mArrowPaint);</span>
        }
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10669)) {</span>
<span class="nc" id="L260">            c.drawPath(path, mArrowFillPaint);</span>
        }
        // Update content description, so screen readers can announce direction to stop
<span class="nc" id="L263">        String[] spokenDirections = getResources().getStringArray(R.array.spoken_compass_directions);</span>
<span class="nc" id="L264">        String directionName = spokenDirections[MathUtils.getHalfWindIndex(direction)];</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10670)) {</span>
<span class="nc" id="L266">            setContentDescription(directionName);</span>
        }
<span class="nc" id="L268">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>