<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySearchStopsFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">MySearchStopsFragment.java</span></div><h1>MySearchStopsFragment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2010-2017 Paul Watts (paulcwatts@gmail.com),
 * University of South  Florida (sjbarbeau@gmail.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import org.onebusaway.android.R;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.elements.ObaStop;
import org.onebusaway.android.io.request.ObaStopsForLocationRequest;
import org.onebusaway.android.io.request.ObaStopsForLocationResponse;
import org.onebusaway.android.util.ArrayAdapter;
import org.onebusaway.android.util.UIUtils;
import android.app.Activity;
import android.content.Context;
import android.location.Location;
import android.os.Bundle;
import android.view.ContextMenu;
import android.view.ContextMenu.ContextMenuInfo;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView.AdapterContextMenuInfo;
import android.widget.ListView;
import android.widget.TextView;
import java.util.Arrays;
import androidx.core.content.pm.ShortcutInfoCompat;
import androidx.loader.app.LoaderManager;
import androidx.loader.content.AsyncTaskLoader;
import androidx.loader.content.Loader;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L46">public class MySearchStopsFragment extends MySearchFragmentBase implements LoaderManager.LoaderCallbacks&lt;ObaStopsForLocationResponse&gt; {</span>

    // private static final String TAG = &quot;MySearchStopsFragment&quot;;
    private static final String QUERY_TEXT = &quot;query_text&quot;;

    public static final String TAB_NAME = &quot;search&quot;;

    private UIUtils.StopUserInfoMap mStopUserMap;

    private MyAdapter mAdapter;

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4771)) {</span>
<span class="nc" id="L60">            mStopUserMap = new UIUtils.StopUserInfoMap(getActivity());</span>
        }
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4772)) {</span>
<span class="nc" id="L63">            super.onActivityCreated(savedInstanceState);</span>
        }
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4773)) {</span>
<span class="nc" id="L66">            mAdapter = new MyAdapter();</span>
        }
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4774)) {</span>
<span class="nc" id="L69">            setListAdapter(mAdapter);</span>
        }
<span class="nc" id="L71">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup root, Bundle savedInstanceState) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4775)) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (root == null) {</span>
                // reason to create our view.
<span class="nc" id="L78">                return null;</span>
            }
        }
<span class="nc" id="L81">        return inflater.inflate(R.layout.my_search_stop_list, null);</span>
    }

    @Override
    public void onDestroy() {
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4777)) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (mStopUserMap != null) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4776)) {</span>
<span class="nc" id="L89">                    mStopUserMap.close();</span>
                }
            }
        }
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4778)) {</span>
<span class="nc" id="L94">            super.onDestroy();</span>
        }
<span class="nc" id="L96">    }</span>

    @Override
    public Loader&lt;ObaStopsForLocationResponse&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L100">        String query = args.getString(QUERY_TEXT);</span>
<span class="nc" id="L101">        return new MyLoader(getActivity(), query, getSearchCenter());</span>
    }

    @Override
    public void onLoadFinished(Loader&lt;ObaStopsForLocationResponse&gt; loader, ObaStopsForLocationResponse response) {
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4779)) {</span>
<span class="nc" id="L107">            UIUtils.showProgress(this, false);</span>
        }
        // Log.d(TAG, &quot;Loader finished&quot;);
<span class="nc" id="L110">        final int code = response.getCode();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4789)) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (code == ObaApi.OBA_OK) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4787)) {</span>
<span class="nc" id="L114">                    setEmptyText(getString(R.string.find_hint_noresults));</span>
                }
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4788)) {</span>
<span class="nc" id="L117">                    mAdapter.setData(Arrays.asList(response.getStops()));</span>
                }
<span class="nc bnc" id="L119" title="All 22 branches missed.">            } else if ((ListenerUtil.mutListener.listen(4784) ? (code &gt;= 0) : (ListenerUtil.mutListener.listen(4783) ? (code &lt;= 0) : (ListenerUtil.mutListener.listen(4782) ? (code &gt; 0) : (ListenerUtil.mutListener.listen(4781) ? (code &lt; 0) : (ListenerUtil.mutListener.listen(4780) ? (code == 0) : (code != 0))))))) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4786)) {</span>
                    // a 'communication' error. Just fake no results.
<span class="nc" id="L122">                    setEmptyText(getString(R.string.find_hint_noresults));</span>
                }
            } else {
<span class="nc bnc" id="L125" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4785)) {</span>
<span class="nc" id="L126">                    setEmptyText(getString(R.string.generic_comm_error));</span>
                }
            }
        }
<span class="nc" id="L130">    }</span>

    @Override
    public void onLoaderReset(Loader&lt;ObaStopsForLocationResponse&gt; loader) {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4790)) {</span>
<span class="nc" id="L135">            mAdapter.clear();</span>
        }
<span class="nc" id="L137">    }</span>

    // 
    @Override
    protected void doSearch(String text) {
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4791)) {</span>
<span class="nc" id="L143">            UIUtils.showProgress(this, true);</span>
        }
<span class="nc" id="L145">        Bundle args = new Bundle();</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4792)) {</span>
<span class="nc" id="L147">            args.putString(QUERY_TEXT, text);</span>
        }
<span class="nc" id="L149">        Loader&lt;?&gt; loader = getLoaderManager().restartLoader(0, args, this);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4793)) {</span>
<span class="nc" id="L151">            loader.onContentChanged();</span>
        }
<span class="nc" id="L153">    }</span>

    @Override
    protected int getEditBoxHintText() {
<span class="nc" id="L157">        return R.string.search_stop_hint;</span>
    }

    @Override
    protected int getMinSearchLength() {
<span class="nc" id="L162">        return 5;</span>
    }

    @Override
    protected CharSequence getHintText() {
<span class="nc" id="L167">        return getText(R.string.find_hint_nofavoritestops);</span>
    }

    @Override
    public void onListItemClick(ListView l, View v, int position, long id) {
<span class="nc bnc" id="L172" title="All 8 branches missed.">        ObaStop stop = (ObaStop) l.getAdapter().getItem((ListenerUtil.mutListener.listen(4797) ? (position % l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(4796) ? (position / l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(4795) ? (position * l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(4794) ? (position + l.getHeaderViewsCount()) : (position - l.getHeaderViewsCount()))))));</span>
<span class="nc" id="L173">        ArrivalsListActivity.Builder b = new ArrivalsListActivity.Builder(getActivity(), stop.getId());</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4798)) {</span>
<span class="nc" id="L175">            b.setStopName(stop.getName());</span>
        }
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4799)) {</span>
<span class="nc" id="L178">            b.setStopDirection(stop.getDirection());</span>
        }
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4804)) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (isShortcutMode()) {</span>
<span class="nc" id="L182">                final ShortcutInfoCompat shortcut = UIUtils.createStopShortcut(getContext(), stop.getName(), b);</span>
<span class="nc" id="L183">                Activity activity = getActivity();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4802)) {</span>
<span class="nc" id="L185">                    activity.setResult(Activity.RESULT_OK, shortcut.getIntent());</span>
                }
<span class="nc bnc" id="L187" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4803)) {</span>
<span class="nc" id="L188">                    activity.finish();</span>
                }
<span class="nc" id="L190">            } else {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4800)) {</span>
<span class="nc" id="L192">                    b.setUpMode(NavHelp.UP_MODE_BACK);</span>
                }
<span class="nc bnc" id="L194" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4801)) {</span>
<span class="nc" id="L195">                    b.start();</span>
                }
            }
        }
<span class="nc" id="L199">    }</span>

    @Override
    public void onCreateContextMenu(ContextMenu menu, View v, ContextMenuInfo menuInfo) {
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4805)) {</span>
<span class="nc" id="L204">            super.onCreateContextMenu(menu, v, menuInfo);</span>
        }
<span class="nc" id="L206">        AdapterContextMenuInfo info = (AdapterContextMenuInfo) menuInfo;</span>
<span class="nc" id="L207">        final TextView text = (TextView) info.targetView.findViewById(R.id.stop_name);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4806)) {</span>
<span class="nc" id="L209">            menu.setHeaderTitle(UIUtils.formatDisplayText(text.getText().toString()));</span>
        }
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4809)) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (isShortcutMode()) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4808)) {</span>
<span class="nc" id="L214">                    menu.add(0, CONTEXT_MENU_DEFAULT, 0, R.string.my_context_create_shortcut);</span>
                }
            } else {
<span class="nc bnc" id="L217" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4807)) {</span>
<span class="nc" id="L218">                    menu.add(0, CONTEXT_MENU_DEFAULT, 0, R.string.my_context_get_stop_info);</span>
                }
            }
        }
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4810)) {</span>
<span class="nc" id="L223">            menu.add(0, CONTEXT_MENU_SHOW_ON_MAP, 0, R.string.my_context_showonmap);</span>
        }
<span class="nc" id="L225">    }</span>

    @Override
    public boolean onContextItemSelected(MenuItem item) {
<span class="nc" id="L229">        AdapterContextMenuInfo info = (AdapterContextMenuInfo) item.getMenuInfo();</span>
<span class="nc bnc" id="L230" title="All 3 branches missed.">        switch(item.getItemId()) {</span>
            case CONTEXT_MENU_DEFAULT:
<span class="nc bnc" id="L232" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4811)) {</span>
                    // Fake a click
<span class="nc" id="L234">                    onListItemClick(getListView(), info.targetView, info.position, info.id);</span>
                }
<span class="nc" id="L236">                return true;</span>
            case CONTEXT_MENU_SHOW_ON_MAP:
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4812)) {</span>
<span class="nc" id="L239">                    showOnMap(getListView(), info.position);</span>
                }
<span class="nc" id="L241">                return true;</span>
            default:
<span class="nc" id="L243">                return super.onContextItemSelected(item);</span>
        }
    }

    private void showOnMap(ListView l, int position) {
<span class="nc bnc" id="L248" title="All 8 branches missed.">        ObaStop stop = (ObaStop) l.getAdapter().getItem((ListenerUtil.mutListener.listen(4816) ? (position % l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(4815) ? (position / l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(4814) ? (position * l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(4813) ? (position + l.getHeaderViewsCount()) : (position - l.getHeaderViewsCount()))))));</span>
<span class="nc" id="L249">        final String stopId = stop.getId();</span>
<span class="nc" id="L250">        final double lat = stop.getLatitude();</span>
<span class="nc" id="L251">        final double lon = stop.getLongitude();</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4817)) {</span>
<span class="nc" id="L253">            HomeActivity.start(getActivity(), stopId, lat, lon);</span>
        }
<span class="nc" id="L255">    }</span>

    // 
    private final class MyAdapter extends ArrayAdapter&lt;ObaStop&gt; {

<span class="nc" id="L260">        public MyAdapter() {</span>
<span class="nc" id="L261">            super(getActivity(), R.layout.stop_list_item);</span>
<span class="nc" id="L262">        }</span>

        @Override
        protected void initView(View view, ObaStop stop) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4818)) {</span>
<span class="nc" id="L267">                mStopUserMap.setView(view, stop.getId(), stop.getName());</span>
            }
<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4819)) {</span>
<span class="nc" id="L270">                UIUtils.setStopDirection(view.findViewById(R.id.direction), stop.getDirection(), true);</span>
            }
<span class="nc" id="L272">        }</span>
    }

    // 
    private static final class MyLoader extends AsyncTaskLoader&lt;ObaStopsForLocationResponse&gt; {

        private final String mQueryText;

        private final Location mCenter;

        public MyLoader(Context context, String query, Location center) {
<span class="nc" id="L283">            super(context);</span>
<span class="nc" id="L284">            mQueryText = query;</span>
<span class="nc" id="L285">            mCenter = center;</span>
<span class="nc" id="L286">        }</span>

        @Override
        public ObaStopsForLocationResponse loadInBackground() {
<span class="nc" id="L290">            return new ObaStopsForLocationRequest.Builder(getContext(), mCenter).setQuery(mQueryText).build().call();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>