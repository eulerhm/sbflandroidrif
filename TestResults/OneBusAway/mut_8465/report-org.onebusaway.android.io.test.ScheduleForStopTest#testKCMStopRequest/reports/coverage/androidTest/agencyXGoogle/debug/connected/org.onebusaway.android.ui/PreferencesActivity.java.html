<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PreferencesActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">PreferencesActivity.java</span></div><h1>PreferencesActivity.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2010-2017 Brian Ferris (bdferris@onebusaway.org),
 * University of South Florida (sjbarbeau@gmail.com),
 * Microsoft Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import static org.onebusaway.android.util.PermissionUtils.RESTORE_BACKUP_PERMISSION_REQUEST;
import static org.onebusaway.android.util.PermissionUtils.SAVE_BACKUP_PERMISSION_REQUEST;
import static org.onebusaway.android.util.PermissionUtils.STORAGE_PERMISSIONS;
import static org.onebusaway.android.util.UIUtils.setAppTheme;
import android.annotation.SuppressLint;
import android.app.Activity;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.preference.CheckBoxPreference;
import android.preference.ListPreference;
import android.preference.Preference;
import android.preference.Preference.OnPreferenceChangeListener;
import android.preference.PreferenceActivity;
import android.preference.PreferenceCategory;
import android.preference.PreferenceScreen;
import android.text.TextUtils;
import android.util.Log;
import android.util.Patterns;
import android.view.LayoutInflater;
import android.view.Window;
import android.widget.LinearLayout;
import android.widget.Toast;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatDelegate;
import androidx.appcompat.widget.Toolbar;
import androidx.core.app.ActivityCompat;
import com.google.firebase.analytics.FirebaseAnalytics;
import org.onebusaway.android.BuildConfig;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.elements.ObaRegion;
import org.onebusaway.android.provider.ObaContract;
import org.onebusaway.android.region.ObaRegionsTask;
import org.onebusaway.android.travelbehavior.TravelBehaviorManager;
import org.onebusaway.android.travelbehavior.io.coroutines.FirebaseDataPusher;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorUtils;
import org.onebusaway.android.util.BackupUtils;
import org.onebusaway.android.util.BuildFlavorUtils;
import org.onebusaway.android.util.PermissionUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.onebusaway.android.util.ShowcaseViewUtils;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L73">public class PreferencesActivity extends PreferenceActivity implements Preference.OnPreferenceClickListener, OnPreferenceChangeListener, SharedPreferences.OnSharedPreferenceChangeListener, ObaRegionsTask.Callback {</span>

    private static final String TAG = &quot;PreferencesActivity&quot;;

    public static final String SHOW_CHECK_REGION_DIALOG = &quot;.checkRegionDialog&quot;;

    public static final int REQUEST_CODE_RESTORE_BACKUP = 1234;

    Preference mPreference;

    Preference mLeftHandMode;

    Preference mCustomApiUrlPref;

    Preference mCustomOtpApiUrlPref;

    Preference mAnalyticsPref;

    CheckBoxPreference mTravelBehaviorPref;

    Preference mHideAlertsPref;

    Preference mTutorialPref;

    Preference mDonatePref;

    Preference mPoweredByObaPref;

    Preference mAboutPref;

    Preference mSaveBackup;

    Preference mRestoreBackup;

    Preference pushFirebaseData;

    boolean mAutoSelectInitialValue;

<span class="nc" id="L111">    boolean mOtpCustomAPIUrlChanged = false;</span>

    ListPreference preferredUnits;

    ListPreference mThemePref;

    private FirebaseAnalytics mFirebaseAnalytics;

    @SuppressWarnings(&quot;deprecation&quot;)
    public void onCreate(Bundle savedInstanceState) {
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2866)) {</span>
<span class="nc" id="L122">            requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);</span>
        }
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2867)) {</span>
<span class="nc" id="L125">            super.onCreate(savedInstanceState);</span>
        }
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2868)) {</span>
<span class="nc" id="L128">            setProgressBarIndeterminate(true);</span>
        }
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2869)) {</span>
<span class="nc" id="L131">            addPreferencesFromResource(R.xml.preferences);</span>
        }
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2870)) {</span>
<span class="nc" id="L134">            mFirebaseAnalytics = FirebaseAnalytics.getInstance(this);</span>
        }
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2871)) {</span>
<span class="nc" id="L137">            mPreference = findPreference(getString(R.string.preference_key_region));</span>
        }
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2872)) {</span>
<span class="nc" id="L140">            mPreference.setOnPreferenceClickListener(this);</span>
        }
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2873)) {</span>
<span class="nc" id="L143">            mLeftHandMode = findPreference(getString(R.string.preference_key_left_hand_mode));</span>
        }
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2874)) {</span>
<span class="nc" id="L146">            mLeftHandMode.setOnPreferenceChangeListener(this);</span>
        }
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2875)) {</span>
<span class="nc" id="L149">            mSaveBackup = findPreference(getString(R.string.preference_key_save_backup));</span>
        }
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2876)) {</span>
<span class="nc" id="L152">            mSaveBackup.setOnPreferenceClickListener(this);</span>
        }
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2877)) {</span>
<span class="nc" id="L155">            mRestoreBackup = findPreference(getString(R.string.preference_key_restore_backup));</span>
        }
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2878)) {</span>
<span class="nc" id="L158">            mRestoreBackup.setOnPreferenceClickListener(this);</span>
        }
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2879)) {</span>
<span class="nc" id="L161">            mCustomApiUrlPref = findPreference(getString(R.string.preference_key_oba_api_url));</span>
        }
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2880)) {</span>
<span class="nc" id="L164">            mCustomApiUrlPref.setOnPreferenceChangeListener(this);</span>
        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2881)) {</span>
<span class="nc" id="L167">            mCustomOtpApiUrlPref = findPreference(getString(R.string.preference_key_otp_api_url));</span>
        }
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2882)) {</span>
<span class="nc" id="L170">            mCustomOtpApiUrlPref.setOnPreferenceChangeListener(this);</span>
        }
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2883)) {</span>
<span class="nc" id="L173">            mAnalyticsPref = findPreference(getString(R.string.preferences_key_analytics));</span>
        }
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2884)) {</span>
<span class="nc" id="L176">            mAnalyticsPref.setOnPreferenceChangeListener(this);</span>
        }
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2885)) {</span>
<span class="nc" id="L179">            mTravelBehaviorPref = (CheckBoxPreference) findPreference(getString(R.string.preferences_key_travel_behavior));</span>
        }
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2886)) {</span>
<span class="nc" id="L182">            mTravelBehaviorPref.setOnPreferenceChangeListener(this);</span>
        }
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2891)) {</span>
<span class="nc bnc" id="L185" title="All 26 branches missed.">            if ((ListenerUtil.mutListener.listen(2888) ? (!TravelBehaviorUtils.isTravelBehaviorActiveInRegion() &amp;&amp; ((ListenerUtil.mutListener.listen(2887) ? (!TravelBehaviorUtils.allowEnrollMoreParticipantsInStudy() || !TravelBehaviorUtils.isUserParticipatingInStudy()) : (!TravelBehaviorUtils.allowEnrollMoreParticipantsInStudy() &amp;&amp; !TravelBehaviorUtils.isUserParticipatingInStudy())))) : (!TravelBehaviorUtils.isTravelBehaviorActiveInRegion() || ((ListenerUtil.mutListener.listen(2887) ? (!TravelBehaviorUtils.allowEnrollMoreParticipantsInStudy() || !TravelBehaviorUtils.isUserParticipatingInStudy()) : (!TravelBehaviorUtils.allowEnrollMoreParticipantsInStudy() &amp;&amp; !TravelBehaviorUtils.isUserParticipatingInStudy())))))) {</span>
<span class="nc" id="L186">                PreferenceCategory aboutCategory = (PreferenceCategory) findPreference(getString(R.string.preferences_category_about));</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2890)) {</span>
<span class="nc" id="L188">                    aboutCategory.removePreference(mTravelBehaviorPref);</span>
                }
<span class="nc" id="L190">            } else {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2889)) {</span>
<span class="nc" id="L192">                    mTravelBehaviorPref.setChecked(TravelBehaviorUtils.isUserParticipatingInStudy());</span>
                }
            }
        }
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2892)) {</span>
<span class="nc" id="L197">            pushFirebaseData = findPreference(getString(R.string.preference_key_push_firebase_data));</span>
        }
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2893)) {</span>
<span class="nc" id="L200">            pushFirebaseData.setOnPreferenceClickListener(this);</span>
        }
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2894)) {</span>
<span class="nc" id="L203">            mHideAlertsPref = findPreference(getString(R.string.preference_key_hide_alerts));</span>
        }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2895)) {</span>
<span class="nc" id="L206">            mHideAlertsPref.setOnPreferenceChangeListener(this);</span>
        }
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2896)) {</span>
<span class="nc" id="L209">            mTutorialPref = findPreference(getString(R.string.preference_key_tutorial));</span>
        }
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2897)) {</span>
<span class="nc" id="L212">            mTutorialPref.setOnPreferenceClickListener(this);</span>
        }
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2898)) {</span>
<span class="nc" id="L215">            mDonatePref = findPreference(getString(R.string.preferences_key_donate));</span>
        }
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2899)) {</span>
<span class="nc" id="L218">            mDonatePref.setOnPreferenceClickListener(this);</span>
        }
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2900)) {</span>
<span class="nc" id="L221">            mPoweredByObaPref = findPreference(getString(R.string.preferences_key_powered_by_oba));</span>
        }
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2901)) {</span>
<span class="nc" id="L224">            mPoweredByObaPref.setOnPreferenceClickListener(this);</span>
        }
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2902)) {</span>
<span class="nc" id="L227">            mAboutPref = findPreference(getString(R.string.preferences_key_about));</span>
        }
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2903)) {</span>
<span class="nc" id="L230">            mAboutPref.setOnPreferenceClickListener(this);</span>
        }
<span class="nc" id="L232">        SharedPreferences settings = Application.getPrefs();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2904)) {</span>
<span class="nc" id="L234">            mAutoSelectInitialValue = settings.getBoolean(getString(R.string.preference_key_auto_select_region), true);</span>
        }
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2905)) {</span>
<span class="nc" id="L237">            preferredUnits = (ListPreference) findPreference(getString(R.string.preference_key_preferred_units));</span>
        }
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2906)) {</span>
<span class="nc" id="L240">            mThemePref = (ListPreference) findPreference(getString(R.string.preference_key_app_theme));</span>
        }
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2907)) {</span>
<span class="nc" id="L243">            mThemePref.setOnPreferenceChangeListener(this);</span>
        }
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2908)) {</span>
<span class="nc" id="L246">            settings.registerOnSharedPreferenceChangeListener(this);</span>
        }
<span class="nc" id="L248">        PreferenceScreen preferenceScreen = getPreferenceScreen();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2912)) {</span>
            // Hide any preferences that shouldn't be shown if the region is hard-coded via build flavor
            if (BuildConfig.USE_FIXED_REGION) {
                PreferenceCategory regionCategory = (PreferenceCategory) findPreference(getString(R.string.preferences_category_location));
                if (!ListenerUtil.mutListener.listen(2909)) {
                    regionCategory.removeAll();
                }
                if (!ListenerUtil.mutListener.listen(2910)) {
                    preferenceScreen.removePreference(regionCategory);
                }
                PreferenceCategory advancedCategory = (PreferenceCategory) findPreference(getString(R.string.preferences_category_advanced));
                Preference experimentalRegion = findPreference(getString(R.string.preference_key_experimental_regions));
                if (!ListenerUtil.mutListener.listen(2911)) {
                    advancedCategory.removePreference(experimentalRegion);
                }
            }
        }
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2919)) {</span>
            // If the Android version is Oreo (8.0) hide &quot;Notification&quot; preference
<span class="nc bnc" id="L268" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(2917) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.O) : (ListenerUtil.mutListener.listen(2916) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.O) : (ListenerUtil.mutListener.listen(2915) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) : (ListenerUtil.mutListener.listen(2914) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.O) : (ListenerUtil.mutListener.listen(2913) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.O) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O))))))) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2918)) {</span>
<span class="nc" id="L270">                    getPreferenceScreen().removePreference(findPreference(getString(R.string.preference_key_notifications)));</span>
                }
            }
        }
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2932)) {</span>
            // If the Android version is lower than Nougat (7.0) and equal to or above Pie (9.0) hide &quot;Share trip logs&quot; preference
<span class="nc bnc" id="L276" title="All 90 branches missed.">            if ((ListenerUtil.mutListener.listen(2930) ? (((ListenerUtil.mutListener.listen(2924) ? (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(2923) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(2922) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(2921) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(2920) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.N) : (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.N))))))) &amp;&amp; ((ListenerUtil.mutListener.listen(2929) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2928) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2927) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2926) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2925) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.P) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P)))))))) : (((ListenerUtil.mutListener.listen(2924) ? (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(2923) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(2922) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(2921) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(2920) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.N) : (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.N))))))) || ((ListenerUtil.mutListener.listen(2929) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2928) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2927) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2926) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2925) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.P) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P)))))))))) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2931)) {</span>
<span class="nc" id="L278">                    getPreferenceScreen().removePreference(findPreference(getString(R.string.preferences_key_user_debugging_logs_category)));</span>
                }
            }
        }
        // If its the OBA brand flavor, then show the &quot;Donate&quot; preference and hide &quot;Powered by OBA&quot;
<span class="nc" id="L283">        PreferenceCategory aboutCategory = (PreferenceCategory) findPreference(getString(R.string.preferences_category_about));</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2935)) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (BuildConfig.FLAVOR_brand.equalsIgnoreCase(BuildFlavorUtils.OBA_FLAVOR_BRAND)) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2934)) {</span>
<span class="nc" id="L287">                    aboutCategory.removePreference(mPoweredByObaPref);</span>
                }
            } else {
<span class="nc bnc" id="L290" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2933)) {</span>
                    // Its not the OBA brand flavor, then hide the &quot;Donate&quot; preference and show &quot;Powered by OBA&quot;
<span class="nc" id="L292">                    aboutCategory.removePreference(mDonatePref);</span>
                }
            }
        }
<span class="nc" id="L296">        boolean showCheckRegionDialog = getIntent().getBooleanExtra(SHOW_CHECK_REGION_DIALOG, false);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2937)) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (showCheckRegionDialog) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2936)) {</span>
<span class="nc" id="L300">                    showCheckRegionDialog();</span>
                }
            }
        }
<span class="nc" id="L304">    }</span>

    @Override
    protected void onResume() {
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2938)) {</span>
<span class="nc" id="L309">            super.onResume();</span>
        }
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2939)) {</span>
<span class="nc" id="L312">            changePreferenceSummary(getString(R.string.preference_key_region));</span>
        }
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2940)) {</span>
<span class="nc" id="L315">            changePreferenceSummary(getString(R.string.preference_key_preferred_units));</span>
        }
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2941)) {</span>
<span class="nc" id="L318">            changePreferenceSummary(getString(R.string.preference_key_app_theme));</span>
        }
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2942)) {</span>
<span class="nc" id="L321">            changePreferenceSummary(getString(R.string.preference_key_otp_api_url));</span>
        }
        // Remove preferences for notifications if no trip planning
<span class="nc" id="L324">        ObaRegion obaRegion = Application.get().getCurrentRegion();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2947)) {</span>
<span class="nc bnc" id="L326" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(2943) ? (obaRegion != null || TextUtils.isEmpty(obaRegion.getOtpBaseUrl())) : (obaRegion != null &amp;&amp; TextUtils.isEmpty(obaRegion.getOtpBaseUrl())))) {</span>
<span class="nc" id="L327">                PreferenceCategory notifications = (PreferenceCategory) findPreference(getString(R.string.preference_key_notifications));</span>
<span class="nc" id="L328">                Preference tripPlan = findPreference(getString(R.string.preference_key_trip_plan_notifications));</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2946)) {</span>
<span class="nc bnc" id="L330" title="All 10 branches missed.">                    if ((ListenerUtil.mutListener.listen(2944) ? (notifications != null || tripPlan != null) : (notifications != null &amp;&amp; tripPlan != null))) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2945)) {</span>
<span class="nc" id="L332">                            notifications.removePreference(tripPlan);</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L338">    }</span>

    @Override
    protected void onPostCreate(Bundle savedInstanceState) {
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2948)) {</span>
<span class="nc" id="L343">            super.onPostCreate(savedInstanceState);</span>
        }
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2949)) {</span>
<span class="nc" id="L346">            setupActionBar();</span>
        }
<span class="nc" id="L348">    }</span>

    private void showCheckRegionDialog() {
<span class="nc" id="L351">        ObaRegion obaRegion = Application.get().getCurrentRegion();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2950)) {</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (obaRegion == null) {</span>
<span class="nc" id="L354">                return;</span>
            }
        }
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2951)) {</span>
<span class="nc" id="L358">            new AlertDialog.Builder(this).setTitle(getString(R.string.preference_region_dialog_title)).setMessage(getString(R.string.preference_region_dialog_message, obaRegion.getName())).setPositiveButton(&quot;OK&quot;, new DialogInterface.OnClickListener() {</span>

                public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L361">                }</span>
<span class="nc" id="L362">            }).show();</span>
        }
<span class="nc" id="L364">    }</span>

    /**
     * Changes the summary of a preference based on a given preference key
     *
     * @param preferenceKey preference key that triggers a change in summary
     */
    private void changePreferenceSummary(String preferenceKey) {
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2967)) {</span>
            // Change the current region summary and server API URL summary
<span class="nc bnc" id="L374" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(2952) ? (preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_region)) &amp;&amp; preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_oba_api_url))) : (preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_region)) || preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_oba_api_url))))) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2966)) {</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                    if (Application.get().getCurrentRegion() != null) {</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2961)) {</span>
<span class="nc" id="L378">                            mPreference.setSummary(Application.get().getCurrentRegion().getName());</span>
                        }
<span class="nc bnc" id="L380" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2962)) {</span>
<span class="nc" id="L381">                            mCustomApiUrlPref.setSummary(getString(R.string.preferences_oba_api_servername_summary));</span>
                        }
<span class="nc" id="L383">                        String customOtpApiUrl = Application.get().getCustomOtpApiUrl();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2965)) {</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                            if (!TextUtils.isEmpty(customOtpApiUrl)) {</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(2964)) {</span>
<span class="nc" id="L387">                                    mCustomOtpApiUrlPref.setSummary(customOtpApiUrl);</span>
                                }
                            } else {
<span class="nc bnc" id="L390" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(2963)) {</span>
<span class="nc" id="L391">                                    mCustomOtpApiUrlPref.setSummary(getString(R.string.preferences_otp_api_servername_summary));</span>
                                }
                            }
                        }
<span class="nc" id="L395">                    } else {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2959)) {</span>
<span class="nc" id="L397">                            mPreference.setSummary(getString(R.string.preferences_region_summary_custom_api));</span>
                        }
<span class="nc bnc" id="L399" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2960)) {</span>
<span class="nc" id="L400">                            mCustomApiUrlPref.setSummary(Application.get().getCustomApiUrl());</span>
                        }
                    }
                }
<span class="nc bnc" id="L404" title="All 2 branches missed.">            } else if (preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_preferred_units))) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2958)) {</span>
<span class="nc" id="L406">                    preferredUnits.setSummary(preferredUnits.getValue());</span>
                }
<span class="nc bnc" id="L408" title="All 2 branches missed.">            } else if (preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_app_theme))) {</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2957)) {</span>
<span class="nc" id="L410">                    mThemePref.setSummary(mThemePref.getValue());</span>
                }
<span class="nc bnc" id="L412" title="All 2 branches missed.">            } else if (preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_otp_api_url))) {</span>
<span class="nc" id="L413">                String customOtpApiUrl = Application.get().getCustomOtpApiUrl();</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2955)) {</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                    if (!TextUtils.isEmpty(customOtpApiUrl)) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2954)) {</span>
<span class="nc" id="L417">                            mCustomOtpApiUrlPref.setSummary(customOtpApiUrl);</span>
                        }
                    } else {
<span class="nc bnc" id="L420" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2953)) {</span>
<span class="nc" id="L421">                            mCustomOtpApiUrlPref.setSummary(getString(R.string.preferences_otp_api_servername_summary));</span>
                        }
                    }
                }
<span class="nc bnc" id="L425" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2956)) {</span>
<span class="nc" id="L426">                    Application.get().setUseOldOtpApiUrlVersion(false);</span>
                }
            }
        }
<span class="nc" id="L430">    }</span>

    @Override
    public boolean onPreferenceClick(Preference pref) {
<span class="nc bnc" id="L434" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2968)) {</span>
<span class="nc" id="L435">            Log.d(TAG, &quot;preference - &quot; + pref.getKey());</span>
        }
<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2982)) {</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">            if (pref.equals(mPreference)) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2981)) {</span>
<span class="nc" id="L440">                    RegionsActivity.start(this);</span>
                }
<span class="nc bnc" id="L442" title="All 2 branches missed.">            } else if (pref.equals(mTutorialPref)) {</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2978)) {</span>
<span class="nc" id="L444">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_button_press_tutorial), null);</span>
                }
<span class="nc bnc" id="L446" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2979)) {</span>
<span class="nc" id="L447">                    ShowcaseViewUtils.resetAllTutorials(this);</span>
                }
<span class="nc bnc" id="L449" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2980)) {</span>
<span class="nc" id="L450">                    NavHelp.goHome(this, true);</span>
                }
<span class="nc bnc" id="L452" title="All 2 branches missed.">            } else if (pref.equals(mDonatePref)) {</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2976)) {</span>
<span class="nc" id="L454">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_button_press_donate), null);</span>
                }
<span class="nc" id="L456">                Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(getString(R.string.donate_url)));</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2977)) {</span>
<span class="nc" id="L458">                    startActivity(intent);</span>
                }
<span class="nc bnc" id="L460" title="All 2 branches missed.">            } else if (pref.equals(mPoweredByObaPref)) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2974)) {</span>
<span class="nc" id="L462">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_button_press_powered_by_oba), null);</span>
                }
<span class="nc" id="L464">                Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(getString(R.string.powered_by_oba_url)));</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2975)) {</span>
<span class="nc" id="L466">                    startActivity(intent);</span>
                }
<span class="nc bnc" id="L468" title="All 2 branches missed.">            } else if (pref.equals(mAboutPref)) {</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2972)) {</span>
<span class="nc" id="L470">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_button_press_about), null);</span>
                }
<span class="nc bnc" id="L472" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2973)) {</span>
<span class="nc" id="L473">                    AboutActivity.start(this);</span>
                }
<span class="nc bnc" id="L475" title="All 2 branches missed.">            } else if (pref.equals(mSaveBackup)) {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2971)) {</span>
                    // been granted yet so we can handle permissions here
<span class="nc" id="L478">                    maybeRequestPermissions(SAVE_BACKUP_PERMISSION_REQUEST);</span>
                }
<span class="nc bnc" id="L480" title="All 2 branches missed.">            } else if (pref.equals(mRestoreBackup)) {</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2970)) {</span>
                    // been granted yet so we can handle permissions here.
<span class="nc" id="L483">                    maybeRequestPermissions(RESTORE_BACKUP_PERMISSION_REQUEST);</span>
                }
<span class="nc bnc" id="L485" title="All 2 branches missed.">            } else if (pref.equals(pushFirebaseData)) {</span>
                // Try to push firebase data to the server
<span class="nc" id="L487">                FirebaseDataPusher pusher = new FirebaseDataPusher();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2969)) {</span>
<span class="nc" id="L489">                    pusher.push(this);</span>
                }
            }
        }
<span class="nc" id="L493">        return true;</span>
    }

    private void maybeRequestPermissions(int permissionRequest) {
<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2984)) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">            if (!PermissionUtils.hasGrantedAllPermissions(this, STORAGE_PERMISSIONS)) {</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2983)) {</span>
                    // Request permissions from the user
<span class="nc" id="L501">                    ActivityCompat.requestPermissions(this, STORAGE_PERMISSIONS, permissionRequest);</span>
                }
            }
        }
<span class="nc" id="L505">    }</span>

    @SuppressLint(&quot;MissingPermission&quot;)
    @Override
    public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
<span class="nc" id="L510">        int result = PackageManager.PERMISSION_DENIED;</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2997)) {</span>
<span class="nc bnc" id="L512" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(2985) ? (requestCode == SAVE_BACKUP_PERMISSION_REQUEST &amp;&amp; requestCode == RESTORE_BACKUP_PERMISSION_REQUEST) : (requestCode == SAVE_BACKUP_PERMISSION_REQUEST || requestCode == RESTORE_BACKUP_PERMISSION_REQUEST))) {</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2996)) {</span>
<span class="nc bnc" id="L514" title="All 50 branches missed.">                    if ((ListenerUtil.mutListener.listen(2991) ? ((ListenerUtil.mutListener.listen(2990) ? (grantResults.length &gt;= 0) : (ListenerUtil.mutListener.listen(2989) ? (grantResults.length &lt;= 0) : (ListenerUtil.mutListener.listen(2988) ? (grantResults.length &lt; 0) : (ListenerUtil.mutListener.listen(2987) ? (grantResults.length != 0) : (ListenerUtil.mutListener.listen(2986) ? (grantResults.length == 0) : (grantResults.length &gt; 0)))))) || grantResults[0] == PackageManager.PERMISSION_GRANTED) : ((ListenerUtil.mutListener.listen(2990) ? (grantResults.length &gt;= 0) : (ListenerUtil.mutListener.listen(2989) ? (grantResults.length &lt;= 0) : (ListenerUtil.mutListener.listen(2988) ? (grantResults.length &lt; 0) : (ListenerUtil.mutListener.listen(2987) ? (grantResults.length != 0) : (ListenerUtil.mutListener.listen(2986) ? (grantResults.length == 0) : (grantResults.length &gt; 0)))))) &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED))) {</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2993)) {</span>
<span class="nc" id="L516">                            result = PackageManager.PERMISSION_GRANTED;</span>
                        }
<span class="nc bnc" id="L518" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2995)) {</span>
                            // User granted permission
<span class="nc bnc" id="L520" title="All 2 branches missed.">                            if (requestCode == SAVE_BACKUP_PERMISSION_REQUEST) {</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(2994)) {</span>
<span class="nc" id="L522">                                    BackupUtils.save(this);</span>
                                }
                            } else {
                            }
                        }
                    } else {
<span class="nc bnc" id="L528" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(2992)) {</span>
<span class="nc" id="L529">                            showStoragePermissionDialog(this, requestCode);</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L535">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2998)) {</span>
<span class="nc" id="L540">            super.onActivityResult(requestCode, resultCode, data);</span>
        }
<span class="nc bnc" id="L542" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3005)) {</span>
<span class="nc bnc" id="L543" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(3003) ? (requestCode &gt;= REQUEST_CODE_RESTORE_BACKUP) : (ListenerUtil.mutListener.listen(3002) ? (requestCode &lt;= REQUEST_CODE_RESTORE_BACKUP) : (ListenerUtil.mutListener.listen(3001) ? (requestCode &gt; REQUEST_CODE_RESTORE_BACKUP) : (ListenerUtil.mutListener.listen(3000) ? (requestCode &lt; REQUEST_CODE_RESTORE_BACKUP) : (ListenerUtil.mutListener.listen(2999) ? (requestCode != REQUEST_CODE_RESTORE_BACKUP) : (requestCode == REQUEST_CODE_RESTORE_BACKUP))))))) {</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3004)) {</span>
<span class="nc" id="L545">                    BackupUtils.restore(this, data.getData());</span>
                }
            }
        }
<span class="nc" id="L549">    }</span>

    /**
     * Shows the dialog to explain why storage permissions are needed
     * @param activity Activity used to show the dialog
     * @param requestCode The requesting permission code (SAVE_BACKUP_PERMISSION_REQUEST or RESTORE_BACKUP_PERMISSION_REQUEST)
     */
    private void showStoragePermissionDialog(Activity activity, int requestCode) {
<span class="nc" id="L557">        androidx.appcompat.app.AlertDialog.Builder builder = new androidx.appcompat.app.AlertDialog.Builder(this).setTitle(R.string.storage_permissions_title).setMessage(R.string.storage_permissions_message).setCancelable(false).setPositiveButton(R.string.ok, (dialog, which) -&gt; {</span>
            // Request permissions from the user
<span class="nc" id="L559">            ActivityCompat.requestPermissions(activity, STORAGE_PERMISSIONS, requestCode);</span>
<span class="nc" id="L560">        }).setNegativeButton(R.string.no_thanks, (dialog, which) -&gt; {</span>
<span class="nc" id="L561">        });</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3006)) {</span>
<span class="nc" id="L563">            builder.create().show();</span>
        }
<span class="nc" id="L565">    }</span>

    @Override
    public boolean onPreferenceChange(Preference preference, Object newValue) {
<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3015)) {</span>
<span class="nc bnc" id="L570" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(3007) ? (preference.equals(mCustomApiUrlPref) || newValue instanceof String) : (preference.equals(mCustomApiUrlPref) &amp;&amp; newValue instanceof String))) {</span>
<span class="nc" id="L571">                String apiUrl = (String) newValue;</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3014)) {</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                    if (!TextUtils.isEmpty(apiUrl)) {</span>
<span class="nc" id="L574">                        boolean validUrl = validateUrl(apiUrl);</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3011)) {</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                            if (!validUrl) {</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(3010)) {</span>
<span class="nc" id="L578">                                    Toast.makeText(this, getString(R.string.custom_api_url_error), Toast.LENGTH_SHORT).show();</span>
                                }
<span class="nc" id="L580">                                return false;</span>
                            }
                        }
<span class="nc bnc" id="L583" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3012)) {</span>
                            // User entered a custom API Url, so set the region info to null
<span class="nc" id="L585">                            Application.get().setCurrentRegion(null);</span>
                        }
<span class="nc bnc" id="L587" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3013)) {</span>
<span class="nc" id="L588">                            Log.d(TAG, &quot;User entered new API URL, set region to null.&quot;);</span>
                        }
<span class="nc" id="L590">                    } else {</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3008)) {</span>
                            // User cleared the API URL preference value, so re-initialize regions
<span class="nc" id="L593">                            Log.d(TAG, &quot;User entered blank API URL, re-initializing regions...&quot;);</span>
                        }
<span class="nc bnc" id="L595" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3009)) {</span>
<span class="nc" id="L596">                            NavHelp.goHome(this, false);</span>
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3032)) {</span>
<span class="nc bnc" id="L603" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(3016) ? (preference.equals(mCustomOtpApiUrlPref) || newValue instanceof String) : (preference.equals(mCustomOtpApiUrlPref) &amp;&amp; newValue instanceof String))) {</span>
<span class="nc" id="L604">                String apiUrl = (String) newValue;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3030)) {</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                    if (!TextUtils.isEmpty(apiUrl)) {</span>
<span class="nc" id="L607">                        boolean validUrl = validateUrl(apiUrl);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3029)) {</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">                            if (!validUrl) {</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(3028)) {</span>
<span class="nc" id="L611">                                    Toast.makeText(this, getString(R.string.custom_otp_api_url_error), Toast.LENGTH_SHORT).show();</span>
                                }
<span class="nc" id="L613">                                return false;</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L618" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3031)) {</span>
<span class="nc" id="L619">                    mOtpCustomAPIUrlChanged = true;</span>
                }
<span class="nc bnc" id="L621" title="All 10 branches missed.">            } else if ((ListenerUtil.mutListener.listen(3017) ? (preference.equals(mAnalyticsPref) || newValue instanceof Boolean) : (preference.equals(mAnalyticsPref) &amp;&amp; newValue instanceof Boolean))) {</span>
<span class="nc" id="L622">                Boolean isAnalyticsActive = (Boolean) newValue;</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3027)) {</span>
                    // Report if the analytics turns off, just before shared preference changed
<span class="nc" id="L625">                    ObaAnalytics.setSendAnonymousData(mFirebaseAnalytics, isAnalyticsActive);</span>
                }
<span class="nc bnc" id="L627" title="All 10 branches missed.">            } else if ((ListenerUtil.mutListener.listen(3018) ? (preference.equals(mTravelBehaviorPref) || newValue instanceof Boolean) : (preference.equals(mTravelBehaviorPref) &amp;&amp; newValue instanceof Boolean))) {</span>
<span class="nc" id="L628">                Boolean activateTravelBehaviorCollection = (Boolean) newValue;</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3026)) {</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">                    if (activateTravelBehaviorCollection) {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3025)) {</span>
<span class="nc" id="L632">                            new TravelBehaviorManager(this, getApplicationContext()).registerTravelBehaviorParticipant(true);</span>
                        }
                    } else {
<span class="nc bnc" id="L635" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3024)) {</span>
<span class="nc" id="L636">                            showOptOutDialog();</span>
                        }
<span class="nc" id="L638">                        return false;</span>
                    }
                }
<span class="nc bnc" id="L641" title="All 10 branches missed.">            } else if ((ListenerUtil.mutListener.listen(3019) ? (preference.equals(mLeftHandMode) || newValue instanceof Boolean) : (preference.equals(mLeftHandMode) &amp;&amp; newValue instanceof Boolean))) {</span>
<span class="nc" id="L642">                Boolean isLeftHandEnabled = (Boolean) newValue;</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3023)) {</span>
                    // Report if left handed mode is turned on, just before shared preference changed
<span class="nc" id="L645">                    ObaAnalytics.setLeftHanded(mFirebaseAnalytics, isLeftHandEnabled);</span>
                }
<span class="nc bnc" id="L647" title="All 10 branches missed.">            } else if ((ListenerUtil.mutListener.listen(3020) ? (preference.equals(mHideAlertsPref) || newValue instanceof Boolean) : (preference.equals(mHideAlertsPref) &amp;&amp; newValue instanceof Boolean))) {</span>
<span class="nc" id="L648">                Boolean hideAlerts = (Boolean) newValue;</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3022)) {</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                    if (hideAlerts) {</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3021)) {</span>
<span class="nc" id="L652">                            ObaContract.ServiceAlerts.hideAllAlerts();</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L658">        return true;</span>
    }

    /**
     * Shows the dialog to explain user is choosing to opt out of travel behavior research study
     */
    private void showOptOutDialog() {
<span class="nc" id="L665">        androidx.appcompat.app.AlertDialog.Builder builder = new androidx.appcompat.app.AlertDialog.Builder(this).setTitle(R.string.travel_behavior_dialog_opt_out_title).setMessage(R.string.travel_behavior_dialog_opt_out_message).setCancelable(false).setPositiveButton(R.string.ok, (dialog, which) -&gt; {</span>
            // Remove user from study
<span class="nc" id="L667">            new TravelBehaviorManager(this, getApplicationContext()).stopCollectingData();</span>
<span class="nc" id="L668">            TravelBehaviorManager.optOutUser();</span>
<span class="nc" id="L669">            TravelBehaviorManager.optOutUserOnServer();</span>
            // Change preference
<span class="nc" id="L671">            mTravelBehaviorPref.setChecked(false);</span>
<span class="nc" id="L672">            PreferenceUtils.saveBoolean(getString(R.string.preferences_key_travel_behavior), false);</span>
<span class="nc" id="L673">        }).setNegativeButton(R.string.cancel, (dialog, which) -&gt; {</span>
<span class="nc" id="L674">        });</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3033)) {</span>
<span class="nc" id="L676">            builder.create().show();</span>
        }
<span class="nc" id="L678">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc" id="L682">        SharedPreferences settings = Application.getPrefs();</span>
<span class="nc" id="L683">        boolean currentValue = settings.getBoolean(getString(R.string.preference_key_auto_select_region), true);</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3038)) {</span>
            // then run the auto-select by going to HomeFragment
<span class="nc bnc" id="L686" title="All 10 branches missed.">            if (((ListenerUtil.mutListener.listen(3034) ? (currentValue || !mAutoSelectInitialValue) : (currentValue &amp;&amp; !mAutoSelectInitialValue)))) {</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3036)) {</span>
<span class="nc" id="L688">                    Log.d(TAG, &quot;User re-enabled auto-select regions pref, auto-selecting via Home Activity...&quot;);</span>
                }
<span class="nc bnc" id="L690" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3037)) {</span>
<span class="nc" id="L691">                    NavHelp.goHome(this, false);</span>
                }
<span class="nc bnc" id="L693" title="All 2 branches missed.">            } else if (mOtpCustomAPIUrlChanged) {</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3035)) {</span>
                    // Redraw the navigation drawer when custom otp api url is entered
<span class="nc" id="L696">                    NavHelp.goHome(this, false);</span>
                }
            }
        }
<span class="nc bnc" id="L700" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3039)) {</span>
<span class="nc" id="L701">            super.onDestroy();</span>
        }
<span class="nc" id="L703">    }</span>

    @Override
    public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) {
<span class="nc" id="L707">        SharedPreferences settings = Application.getPrefs();</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3058)) {</span>
            // Listening to changes to a custom Preference doesn't seem to work, so we can listen to changes to the shared pref value instead
<span class="nc bnc" id="L710" title="All 2 branches missed.">            if (key.equals(getString(R.string.preference_key_experimental_regions))) {</span>
<span class="nc" id="L711">                boolean experimentalServers = settings.getBoolean(getString(R.string.preference_key_experimental_regions), false);</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3051)) {</span>
<span class="nc" id="L713">                    Log.d(TAG, &quot;Experimental regions shared preference changed to &quot; + experimentalServers);</span>
                }
<span class="nc bnc" id="L715" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3052)) {</span>
                    /*
            Force a refresh of the regions list, but don't using blocking progress dialog
            inside the ObaRegionsTask AsyncTask.
            We need to use our own Action Bar progress bar here so its linked to this activity,
            which will survive orientation changes.
            */
<span class="nc" id="L722">                    setProgressBarIndeterminateVisibility(true);</span>
                }
<span class="nc" id="L724">                List&lt;ObaRegionsTask.Callback&gt; callbacks = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3053)) {</span>
<span class="nc" id="L726">                    callbacks.add(this);</span>
                }
<span class="nc" id="L728">                ObaRegionsTask task = new ObaRegionsTask(this, callbacks, true, false);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3054)) {</span>
<span class="nc" id="L730">                    task.execute();</span>
                }
<span class="nc bnc" id="L732" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3057)) {</span>
                    // Analytics
<span class="nc bnc" id="L734" title="All 2 branches missed.">                    if (experimentalServers) {</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3056)) {</span>
<span class="nc" id="L736">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_button_press_experimental_on), null);</span>
                        }
                    } else {
<span class="nc bnc" id="L739" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3055)) {</span>
<span class="nc" id="L740">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_button_press_experimental_off), null);</span>
                        }
                    }
                }
<span class="nc bnc" id="L744" title="All 2 branches missed.">            } else if (key.equals(getString(R.string.preference_key_oba_api_url))) {</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3050)) {</span>
                    // Change the region preference description to show we're not using a region
<span class="nc" id="L747">                    changePreferenceSummary(key);</span>
                }
<span class="nc bnc" id="L749" title="All 2 branches missed.">            } else if (key.equals(getString(R.string.preference_key_otp_api_url))) {</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3049)) {</span>
                    // Change the otp url preference description
<span class="nc" id="L752">                    changePreferenceSummary(key);</span>
                }
<span class="nc bnc" id="L754" title="All 2 branches missed.">            } else if (key.equalsIgnoreCase(getString(R.string.preference_key_preferred_units))) {</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3048)) {</span>
                    // Change the preferred units description
<span class="nc" id="L757">                    changePreferenceSummary(key);</span>
                }
<span class="nc bnc" id="L759" title="All 2 branches missed.">            } else if (key.equalsIgnoreCase(getString(R.string.preference_key_app_theme))) {</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3046)) {</span>
                    // Change the app theme preference description
<span class="nc" id="L762">                    changePreferenceSummary(key);</span>
                }
<span class="nc bnc" id="L764" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3047)) {</span>
                    // Update the app theme
<span class="nc" id="L766">                    setAppTheme(settings.getString(key, getString(R.string.preferences_app_theme_option_system_default)));</span>
                }
<span class="nc bnc" id="L768" title="All 2 branches missed.">            } else if (key.equalsIgnoreCase(getString(R.string.preference_key_auto_select_region))) {</span>
                // Analytics
<span class="nc" id="L770">                boolean autoSelect = settings.getBoolean(getString(R.string.preference_key_auto_select_region), true);</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3045)) {</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                    if (autoSelect) {</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3044)) {</span>
<span class="nc" id="L774">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_button_press_auto), null);</span>
                        }
                    } else {
<span class="nc bnc" id="L777" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3043)) {</span>
<span class="nc" id="L778">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_button_press_manual), null);</span>
                        }
                    }
                }
<span class="nc bnc" id="L782" title="All 2 branches missed.">            } else if (key.equalsIgnoreCase(getString(R.string.preferences_key_analytics))) {</span>
<span class="nc" id="L783">                Boolean isAnalyticsActive = settings.getBoolean(Application.get().getString(R.string.preferences_key_analytics), Boolean.TRUE);</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3042)) {</span>
                    // Report if the analytics turns on, just after shared preference changed
<span class="nc" id="L786">                    ObaAnalytics.setSendAnonymousData(mFirebaseAnalytics, isAnalyticsActive);</span>
                }
<span class="nc bnc" id="L788" title="All 2 branches missed.">            } else if (key.equalsIgnoreCase(getString(R.string.preference_key_arrival_info_style))) {</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3041)) {</span>
                    // Change the arrival info description
<span class="nc" id="L791">                    changePreferenceSummary(key);</span>
                }
<span class="nc bnc" id="L793" title="All 2 branches missed.">            } else if (key.equalsIgnoreCase(getString(R.string.preference_key_show_negative_arrivals))) {</span>
<span class="nc" id="L794">                boolean showDepartedBuses = settings.getBoolean(Application.get().getString(R.string.preference_key_show_negative_arrivals), Boolean.FALSE);</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3040)) {</span>
<span class="nc" id="L796">                    ObaAnalytics.setShowDepartedVehicles(mFirebaseAnalytics, showDepartedBuses);</span>
                }
            }
        }
<span class="nc" id="L800">    }</span>

    /**
     * Returns true if the provided apiUrl could be a valid URL, false if it could not
     *
     * @param apiUrl the URL to validate
     * @return true if the provided apiUrl could be a valid URL, false if it could not
     */
    private boolean validateUrl(String apiUrl) {
        try {
            // URI.parse() doesn't tell us if the scheme is missing, so use URL() instead (#126)
<span class="nc" id="L811">            URL url = new URL(apiUrl);</span>
<span class="nc" id="L812">        } catch (MalformedURLException e) {</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(3059)) {</span>
                // Assume HTTPS scheme if none is provided
<span class="nc" id="L815">                apiUrl = getString(R.string.https_prefix) + apiUrl;</span>
            }
<span class="nc" id="L817">        }</span>
<span class="nc" id="L818">        return Patterns.WEB_URL.matcher(apiUrl).matches();</span>
    }

    /**
     * Imitate Action Bar with back button - from http://stackoverflow.com/a/27455363/937715
     */
    private void setupActionBar() {
<span class="nc" id="L825">        LinearLayout root = (LinearLayout) findViewById(android.R.id.list).getParent().getParent().getParent();</span>
<span class="nc" id="L826">        Toolbar bar = (Toolbar) LayoutInflater.from(this).inflate(R.layout.settings_toolbar, root, false);</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3060)) {</span>
            // insert at top
<span class="nc" id="L829">            root.addView(bar, 0);</span>
        }
<span class="nc bnc" id="L831" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3061)) {</span>
<span class="nc" id="L832">            bar.setNavigationOnClickListener(v -&gt; finish());</span>
        }
<span class="nc" id="L834">    }</span>

    // 
    public void onRegionTaskFinished(boolean currentRegionChanged) {
<span class="nc bnc" id="L838" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3062)) {</span>
<span class="nc" id="L839">            setProgressBarIndeterminateVisibility(false);</span>
        }
<span class="nc bnc" id="L841" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3068)) {</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            if (currentRegionChanged) {</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3065)) {</span>
                    // If region was auto-selected, show user the region we're using
<span class="nc bnc" id="L845" title="All 10 branches missed.">                    if ((ListenerUtil.mutListener.listen(3063) ? (Application.getPrefs().getBoolean(getString(R.string.preference_key_auto_select_region), true) || Application.get().getCurrentRegion() != null) : (Application.getPrefs().getBoolean(getString(R.string.preference_key_auto_select_region), true) &amp;&amp; Application.get().getCurrentRegion() != null))) {</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(3064)) {</span>
<span class="nc" id="L847">                            Toast.makeText(this, getString(R.string.region_region_found, Application.get().getCurrentRegion().getName()), Toast.LENGTH_LONG).show();</span>
                        }
                    }
                }
<span class="nc bnc" id="L851" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3066)) {</span>
                    // Update the preference summary to show the newly selected region
<span class="nc" id="L853">                    changePreferenceSummary(getString(R.string.preference_key_region));</span>
                }
<span class="nc bnc" id="L855" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3067)) {</span>
                    // Since the current region was updated as a result of enabling/disabling experimental servers, go home
<span class="nc" id="L857">                    NavHelp.goHome(this, false);</span>
                }
            }
        }
<span class="nc" id="L861">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>