<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DistanceToStopView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.view</a> &gt; <span class="el_source">DistanceToStopView.java</span></div><h1>DistanceToStopView.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2014 Sean J. Barbeau (sjbarbeau@gmail.com), University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.view;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.util.LocationHelper;
import android.content.Context;
import android.content.SharedPreferences;
import android.location.Location;
import android.util.AttributeSet;
import android.widget.TextView;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Locale;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * A TextView that updates itself with the distance to the given bus stop from the given location
 */
public class DistanceToStopView extends TextView implements LocationHelper.Listener {

    public interface Listener {

        /**
         * Called when the DistanceToStopView is showing information to the user
         */
        void onInitializationComplete();
    }

<span class="nc" id="L44">    private static String TAG = &quot;DistanceToStopView&quot;;</span>

    Context mContext;

    Location mStopLocation;

<span class="nc" id="L50">    ArrayList&lt;Listener&gt; mListeners = new ArrayList&lt;Listener&gt;();</span>

    private static final float MILES_TO_METERS = 0.000621371f;

    private static final float MILES_THRESHOLD = 0.25f;

    private static final float KILOMETERS_THRESHOLD = 0.25f;

    private static final float MILES_TO_FEET = 5280;

    NumberFormat mNumberFormat;

    Locale mLocale;

    private static String IMPERIAL;

    private static String METRIC;

    private static String AUTOMATIC;

    SharedPreferences mSettings;

    private String preferredUnits;

<span class="nc" id="L74">    boolean mInitialized = false;</span>

    public DistanceToStopView(Context context, AttributeSet attrs) {
<span class="nc" id="L77">        super(context, attrs);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10761)) {</span>
<span class="nc" id="L79">            mContext = context;</span>
        }
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10762)) {</span>
<span class="nc" id="L82">            mNumberFormat = NumberFormat.getInstance();</span>
        }
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10763)) {</span>
<span class="nc" id="L85">            mNumberFormat.setMaximumFractionDigits(1);</span>
        }
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10764)) {</span>
<span class="nc" id="L88">            mLocale = Locale.getDefault();</span>
        }
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10765)) {</span>
<span class="nc" id="L91">            IMPERIAL = mContext.getString(R.string.preferences_preferred_units_option_imperial);</span>
        }
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10766)) {</span>
<span class="nc" id="L94">            METRIC = mContext.getString(R.string.preferences_preferred_units_option_metric);</span>
        }
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10767)) {</span>
<span class="nc" id="L97">            AUTOMATIC = mContext.getString(R.string.preferences_preferred_units_option_automatic);</span>
        }
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10768)) {</span>
<span class="nc" id="L100">            mSettings = Application.getPrefs();</span>
        }
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10769)) {</span>
<span class="nc" id="L103">            preferredUnits = mSettings.getString(mContext.getString(R.string.preference_key_preferred_units), AUTOMATIC);</span>
        }
<span class="nc" id="L105">    }</span>

    public synchronized void registerListener(Listener listener) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10771)) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (!mListeners.contains(listener)) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10770)) {</span>
<span class="nc" id="L111">                    mListeners.add(listener);</span>
                }
            }
        }
<span class="nc" id="L115">    }</span>

    public synchronized void unregisterListener(Listener listener) {
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10773)) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (mListeners.contains(listener)) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10772)) {</span>
<span class="nc" id="L121">                    mListeners.remove(listener);</span>
                }
            }
        }
<span class="nc" id="L125">    }</span>

    /**
     * Sets the stop location that this view measures the distance to
     *
     * @param location stop location
     */
    public void setStopLocation(Location location) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10774)) {</span>
<span class="nc" id="L134">            mStopLocation = location;</span>
        }
<span class="nc" id="L136">    }</span>

    /**
     * Should be called when the view is being shown again and the preferences
     * may have changed (typically, in onResume() of the parent context)
     */
    public void refreshUnitsPreference() {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10775)) {</span>
<span class="nc" id="L144">            preferredUnits = mSettings.getString(mContext.getString(R.string.preference_key_preferred_units), AUTOMATIC);</span>
        }
<span class="nc" id="L146">    }</span>

    /**
     * Returns true if the view is initialized and ready to draw to the screen, false if it is not
     *
     * @return true if the view is initialized and ready to draw to the screen, false if it is not
     */
    public boolean isInitialized() {
<span class="nc" id="L154">        return mInitialized;</span>
    }

    @Override
    public void onLocationChanged(Location location) {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10792)) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (mStopLocation != null) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10779)) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                    if (!mInitialized) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10776)) {</span>
<span class="nc" id="L164">                            mInitialized = true;</span>
                        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10778)) {</span>
                            {
<span class="nc" id="L168">                                long _loopCounter140 = 0;</span>
                                // Notify listeners that we have both stop and real-time location
<span class="nc bnc" id="L170" title="All 2 branches missed.">                                for (Listener l : mListeners) {</span>
<span class="nc" id="L171">                                    ListenerUtil.loopListener.listen(&quot;_loopCounter140&quot;, ++_loopCounter140);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(10777)) {</span>
<span class="nc" id="L173">                                        l.onInitializationComplete();</span>
                                    }
<span class="nc" id="L175">                                }</span>
                            }
                        }
                    }
                }
<span class="nc" id="L180">                Float distance = location.distanceTo(mStopLocation);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10791)) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                    if (distance != null) {</span>
<span class="nc bnc" id="L183" title="All 8 branches missed.">                        double miles = (ListenerUtil.mutListener.listen(10783) ? (distance % MILES_TO_METERS) : (ListenerUtil.mutListener.listen(10782) ? (distance / MILES_TO_METERS) : (ListenerUtil.mutListener.listen(10781) ? (distance - MILES_TO_METERS) : (ListenerUtil.mutListener.listen(10780) ? (distance + MILES_TO_METERS) : (distance * MILES_TO_METERS)))));</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10784)) {</span>
                            // Convert meters to kilometers
<span class="nc" id="L186">                            distance /= 1000;</span>
                        }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10790)) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                            if (preferredUnits.equalsIgnoreCase(AUTOMATIC)) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(10789)) {</span>
                                    // TODO - Method of guessing metric/imperial can definitely be improved
<span class="nc bnc" id="L192" title="All 2 branches missed.">                                    if (mLocale.getISO3Country().equalsIgnoreCase(Locale.US.getISO3Country())) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(10788)) {</span>
                                            // Assume imperial
<span class="nc" id="L195">                                            setDistanceTextView(miles, IMPERIAL);</span>
                                        }
                                    } else {
<span class="nc bnc" id="L198" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(10787)) {</span>
                                            // Assume metric
<span class="nc" id="L200">                                            setDistanceTextView(distance, METRIC);</span>
                                        }
                                    }
                                }
<span class="nc bnc" id="L204" title="All 2 branches missed.">                            } else if (preferredUnits.equalsIgnoreCase(IMPERIAL)) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(10786)) {</span>
<span class="nc" id="L206">                                    setDistanceTextView(miles, IMPERIAL);</span>
                                }
<span class="nc bnc" id="L208" title="All 2 branches missed.">                            } else if (preferredUnits.equalsIgnoreCase(METRIC)) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(10785)) {</span>
<span class="nc" id="L210">                                    setDistanceTextView(distance, METRIC);</span>
                                }
                            }
                        }
<span class="nc" id="L214">                        return;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10793)) {</span>
            // If we've gotten this far, distance isn't valid, so clear current text
<span class="nc" id="L221">            setText(&quot;&quot;);</span>
        }
<span class="nc" id="L223">    }</span>

    /**
     * Sets the text view that contains distance with units based on input parameters
     *
     * @param distance the distance to be used, in miles (for imperial) or kilometers (for metric)
     * @param units    the units to be used from strings.xml, either preferences_preferred_units_option_metric
     *                 or preferences_preferred_units_option_imperial
     */
    private void setDistanceTextView(double distance, String units) {
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10822)) {</span>
            // TODO - Set ContentDescription to be read by screen readers
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (units.equalsIgnoreCase(mContext.getString(R.string.preferences_preferred_units_option_imperial))) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10821)) {</span>
                    // If the distance is greater than a quarter mile, show in miles, else show in feet
<span class="nc bnc" id="L238" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(10812) ? (distance &gt;= MILES_THRESHOLD) : (ListenerUtil.mutListener.listen(10811) ? (distance &lt;= MILES_THRESHOLD) : (ListenerUtil.mutListener.listen(10810) ? (distance &lt; MILES_THRESHOLD) : (ListenerUtil.mutListener.listen(10809) ? (distance != MILES_THRESHOLD) : (ListenerUtil.mutListener.listen(10808) ? (distance == MILES_THRESHOLD) : (distance &gt; MILES_THRESHOLD))))))) {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10819)) {</span>
                            // MILES
<span class="nc" id="L241">                            mNumberFormat.setMaximumFractionDigits(1);</span>
                        }
<span class="nc bnc" id="L243" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10820)) {</span>
<span class="nc" id="L244">                            setText(mNumberFormat.format(distance) + &quot; &quot; + mContext.getString(R.string.miles_abbreviation));</span>
                        }
                    } else {
<span class="nc bnc" id="L247" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10813)) {</span>
                            // FEET
<span class="nc" id="L249">                            mNumberFormat.setMaximumFractionDigits(0);</span>
                        }
<span class="nc bnc" id="L251" title="All 8 branches missed.">                        double feet = (ListenerUtil.mutListener.listen(10817) ? (distance % MILES_TO_FEET) : (ListenerUtil.mutListener.listen(10816) ? (distance / MILES_TO_FEET) : (ListenerUtil.mutListener.listen(10815) ? (distance - MILES_TO_FEET) : (ListenerUtil.mutListener.listen(10814) ? (distance + MILES_TO_FEET) : (distance * MILES_TO_FEET)))));</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10818)) {</span>
<span class="nc" id="L253">                            setText(mNumberFormat.format(feet) + &quot; &quot; + mContext.getString(R.string.feet_abbreviation));</span>
                        }
<span class="nc" id="L255">                    }</span>
                }
<span class="nc bnc" id="L257" title="All 2 branches missed.">            } else if (units.equalsIgnoreCase(mContext.getString(R.string.preferences_preferred_units_option_metric))) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10807)) {</span>
                    // METRIC
<span class="nc bnc" id="L260" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(10798) ? (distance &gt;= KILOMETERS_THRESHOLD) : (ListenerUtil.mutListener.listen(10797) ? (distance &lt;= KILOMETERS_THRESHOLD) : (ListenerUtil.mutListener.listen(10796) ? (distance &lt; KILOMETERS_THRESHOLD) : (ListenerUtil.mutListener.listen(10795) ? (distance != KILOMETERS_THRESHOLD) : (ListenerUtil.mutListener.listen(10794) ? (distance == KILOMETERS_THRESHOLD) : (distance &gt; KILOMETERS_THRESHOLD))))))) {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10805)) {</span>
                            // KILOMETERS
<span class="nc" id="L263">                            mNumberFormat.setMaximumFractionDigits(1);</span>
                        }
<span class="nc bnc" id="L265" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10806)) {</span>
<span class="nc" id="L266">                            setText(mNumberFormat.format(distance) + &quot; &quot; + mContext.getString(R.string.kilometers_abbreviation));</span>
                        }
                    } else {
<span class="nc bnc" id="L269" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10799)) {</span>
                            // METERS
<span class="nc" id="L271">                            mNumberFormat.setMaximumFractionDigits(0);</span>
                        }
<span class="nc bnc" id="L273" title="All 8 branches missed.">                        double meters = (ListenerUtil.mutListener.listen(10803) ? (distance % 1000) : (ListenerUtil.mutListener.listen(10802) ? (distance / 1000) : (ListenerUtil.mutListener.listen(10801) ? (distance - 1000) : (ListenerUtil.mutListener.listen(10800) ? (distance + 1000) : (distance * 1000)))));</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10804)) {</span>
<span class="nc" id="L275">                            setText(mNumberFormat.format(meters) + &quot; &quot; + mContext.getString(R.string.meters_abbreviation));</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L281">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>