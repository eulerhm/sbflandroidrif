<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StopMapController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.map</a> &gt; <span class="el_source">StopMapController.java</span></div><h1>StopMapController.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011-2014 Paul Watts (paulcwatts@gmail.com),
 * University of South Florida (sjbarbeau@gmail.com), and individual contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.map;

import com.google.android.gms.common.api.GoogleApiClient;

import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.elements.ObaStop;
import org.onebusaway.android.io.request.ObaStopsForLocationRequest;
import org.onebusaway.android.io.request.ObaStopsForLocationResponse;
import org.onebusaway.android.map.googlemapsv2.BaseMapFragment;
import org.onebusaway.android.util.RegionUtils;

import android.location.Location;
import android.os.Bundle;
import android.text.TextUtils;
import android.util.Log;

import java.util.Arrays;
import java.util.List;

import androidx.loader.app.LoaderManager;
import androidx.loader.content.AsyncTaskLoader;
import androidx.loader.content.Loader;

final class StopsRequest {

    private final Location mCenter;

    private final double mLatSpan;

    private final double mLonSpan;

    private final double mZoomLevel;

<span class="nc" id="L51">    StopsRequest(MapModeController.ObaMapView view) {</span>
<span class="nc" id="L52">        mCenter = view.getMapCenterAsLocation();</span>
<span class="nc" id="L53">        mLatSpan = view.getLatitudeSpanInDecDegrees();</span>
<span class="nc" id="L54">        mLonSpan = view.getLongitudeSpanInDecDegrees();</span>
<span class="nc" id="L55">        mZoomLevel = view.getZoomLevelAsFloat();</span>
<span class="nc" id="L56">    }</span>

    Location getCenter() {
<span class="nc" id="L59">        return mCenter;</span>
    }

    double getLatSpan() {
<span class="nc" id="L63">        return mLatSpan;</span>
    }

    double getLonSpan() {
<span class="nc" id="L67">        return mLonSpan;</span>
    }

    double getZoomLevel() {
<span class="nc" id="L71">        return mZoomLevel;</span>
    }
}

final class StopsResponse {

    private final StopsRequest mRequest;

    private final ObaStopsForLocationResponse mResponse;

<span class="nc" id="L81">    StopsResponse(StopsRequest req, ObaStopsForLocationResponse response) {</span>
<span class="nc" id="L82">        mRequest = req;</span>
<span class="nc" id="L83">        mResponse = response;</span>
<span class="nc" id="L84">    }</span>

    StopsRequest getRequest() {
<span class="nc" id="L87">        return mRequest;</span>
    }

    ObaStopsForLocationResponse getResponse() {
<span class="nc" id="L91">        return mResponse;</span>
    }

    /**
     * Returns true if newReq also fulfills response.
     */
    boolean fulfills(StopsRequest newReq) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (mRequest.getCenter() == null) {</span>
            //Log.d(TAG, &quot;No center&quot;);
<span class="nc" id="L100">            return false;</span>
        }
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (!mRequest.getCenter().equals(newReq.getCenter())) {</span>
            //Log.d(TAG, &quot;Center not the same&quot;);
<span class="nc" id="L104">            return false;</span>
        }
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (mResponse != null) {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if ((newReq.getZoomLevel() &gt; mRequest.getZoomLevel()) &amp;&amp;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    mResponse.getLimitExceeded()) {</span>
                //Log.d(TAG, &quot;Zooming in -- limit exceeded&quot;);
<span class="nc" id="L110">                return false;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            } else if (newReq.getZoomLevel() &lt; mRequest.getZoomLevel()) {</span>
                //Log.d(TAG, &quot;Zooming out&quot;);
<span class="nc" id="L113">                return false;</span>
            }
        }
<span class="nc" id="L116">        return true;</span>

        // Otherwise:

        // If the new request's is zoomed in and the current
        // response has limitExceeded, then no.

        // If the new request's lat/lon span is contained
        // entirely within the old one:
        //  Then the new request is fulfilled IFF the old request's
        //  limitExceeded == false.

        // If the new request's lat/lon span is not contained
        // entirely within the old one (fuzzy match)
        //  FALSE
    }
}

public class StopMapController extends BaseMapController implements
        LoaderManager.LoaderCallbacks&lt;StopsResponse&gt;,
        Loader.OnLoadCompleteListener&lt;StopsResponse&gt; {

    private static final String TAG = &quot;StopMapController&quot;;

    private static final int STOPS_LOADER = 5678;

    // In lieu of using an actual LoaderManager, which isn't
    // available in SherlockMapActivity
    private Loader&lt;StopsResponse&gt; mLoader;

    private MapWatcher mMapWatcher;

    /**
     * GoogleApiClient being used for Location Services
     */
    GoogleApiClient mGoogleApiClient;

    public StopMapController(Callback callback) {
<span class="nc" id="L154">        super(callback);</span>
<span class="nc" id="L155">    }</span>

    @Override
    protected void createLoader() {
<span class="nc" id="L159">        mLoader = onCreateLoader(STOPS_LOADER, null);</span>
<span class="nc" id="L160">        mLoader.registerListener(0, this);</span>
<span class="nc" id="L161">        mLoader.startLoading();</span>
<span class="nc" id="L162">    }</span>

    @Override
    public String getMode() {
<span class="nc" id="L166">        return MapParams.MODE_STOP;</span>
    }

    @Override
    public void onHidden(boolean hidden) {
        // No op for this controller
<span class="nc" id="L172">    }</span>

    @Override
    public Loader&lt;StopsResponse&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L176">        StopsLoader loader = new StopsLoader(mCallback);</span>
<span class="nc" id="L177">        StopsRequest req = new StopsRequest(mCallback.getMapView());</span>
<span class="nc" id="L178">        loader.update(req);</span>
<span class="nc" id="L179">        return loader;</span>
    }

    protected StopsLoader getLoader() {
        //Loader&lt;ObaStopsForLocationResponse&gt; l =
        //        mCallback.getLoaderManager().getLoader(STOPS_LOADER);
        //return (StopsLoader)l;
<span class="nc" id="L186">        return (StopsLoader) mLoader;</span>
    }

    @Override
    protected void updateData() {
<span class="nc" id="L191">        StopsLoader loader = getLoader();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (loader != null) {</span>
<span class="nc" id="L193">            StopsRequest req = new StopsRequest(mCallback.getMapView());</span>
<span class="nc" id="L194">            loader.update(req);</span>
        }

<span class="nc" id="L197">    }</span>
    @Override
    public void onLoadFinished(Loader&lt;StopsResponse&gt; loader,
                               StopsResponse _response) {
<span class="nc" id="L201">        mCallback.showProgress(false);</span>
<span class="nc" id="L202">        final ObaStopsForLocationResponse response = _response.getResponse();</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (response == null) {</span>
            // Initial install can generate a null response if all is still ok, so do nothing (#615)
<span class="nc" id="L206">            return;</span>
        }

<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (response.getCode() != ObaApi.OBA_OK) {</span>
<span class="nc" id="L210">            BaseMapFragment.showMapError(response);</span>
<span class="nc" id="L211">            return;</span>
        }

<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (response.getOutOfRange()) {</span>
<span class="nc" id="L215">            mCallback.notifyOutOfRange();</span>
<span class="nc" id="L216">            return;</span>
        }

        //Workaround for https://github.com/OneBusAway/onebusaway-application-modules/issues/59
        //where outOfRange response element is false even if the location was out of range
        //We need to also make sure the list of stops is empty, otherwise we screen out valid responses
        //TODO - After above issue #59 is resolved, we should also only do this check on OBA server
        //versions below the version number in which this is fixed.
<span class="nc" id="L224">        Location myLocation = Application.getLastKnownLocation(mCallback.getActivity(),</span>
                mGoogleApiClient);
<span class="nc bnc" id="L226" title="All 4 branches missed.">        if (myLocation != null &amp;&amp; Application.get().getCurrentRegion() != null) {</span>
<span class="nc" id="L227">            boolean inRegion = true;  // Assume user is in region unless we detect otherwise</span>
            try {
<span class="nc" id="L229">                inRegion = RegionUtils</span>
<span class="nc" id="L230">                        .isLocationWithinRegion(myLocation, Application.get().getCurrentRegion());</span>
<span class="nc" id="L231">            } catch (IllegalArgumentException e) {</span>
                // Issue #69 - some devices are providing invalid lat/long coordinates
<span class="nc" id="L233">                Log.e(TAG, &quot;Invalid latitude or longitude - lat = &quot; + myLocation.getLatitude()</span>
<span class="nc" id="L234">                        + &quot;, long = &quot; + myLocation.getLongitude());</span>
<span class="nc" id="L235">            }</span>

<span class="nc bnc" id="L237" title="All 4 branches missed.">            if (!inRegion &amp;&amp; Arrays.asList(response.getStops()).isEmpty()) {</span>
<span class="nc" id="L238">                Log.d(TAG, &quot;Device location is outside region range, notifying...&quot;);</span>
<span class="nc" id="L239">                mCallback.notifyOutOfRange();</span>
<span class="nc" id="L240">                return;</span>
            }
        }

<span class="nc" id="L244">        List&lt;ObaStop&gt; stops = Arrays.asList(response.getStops());</span>
<span class="nc" id="L245">        mCallback.showStops(stops, response);</span>
<span class="nc" id="L246">    }</span>

    @Override
    public void onLoaderReset(Loader&lt;StopsResponse&gt; loader) {
        // Clear the overlay.
<span class="nc" id="L251">        mCallback.showStops(null, null);</span>
<span class="nc" id="L252">    }</span>

    // Remove when adding back LoaderManager help.
    @Override
    public void onLoadComplete(Loader&lt;StopsResponse&gt; loader,
                               StopsResponse response) {
<span class="nc" id="L258">        onLoadFinished(loader, response);</span>
<span class="nc" id="L259">    }</span>


    //
    // Loader
    //
    private static class StopsLoader extends AsyncTaskLoader&lt;StopsResponse&gt; {

        private final Callback mFragment;

        private StopsRequest mRequest;

        private StopsResponse mResponse;

        public StopsLoader(Callback fragment) {
<span class="nc" id="L274">            super(fragment.getActivity());</span>
<span class="nc" id="L275">            mFragment = fragment;</span>
<span class="nc" id="L276">        }</span>

        @Override
        public StopsResponse loadInBackground() {
<span class="nc" id="L280">            StopsRequest req = mRequest;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            if (Application.get().getCurrentRegion() == null &amp;&amp;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                    TextUtils.isEmpty(Application.get().getCustomApiUrl())) {</span>
                //We don't have region info or manually entered API to know what server to contact
<span class="nc" id="L284">                Log.d(TAG, &quot;Trying to load stops from server without &quot; +</span>
                            &quot;OBA REST API endpoint, aborting...&quot;);
<span class="nc" id="L286">                return new StopsResponse(req, null);</span>
            }
            //Make OBA REST API call to the server and return result
<span class="nc" id="L289">            ObaStopsForLocationResponse response =</span>
<span class="nc" id="L290">                    new ObaStopsForLocationRequest.Builder(getContext(),</span>
<span class="nc" id="L291">                            req.getCenter())</span>
<span class="nc" id="L292">                            .setSpan(req.getLatSpan(), req.getLonSpan())</span>
<span class="nc" id="L293">                            .build()</span>
<span class="nc" id="L294">                            .call();</span>
<span class="nc" id="L295">            return new StopsResponse(req, response);</span>
        }

        @Override
        public void deliverResult(StopsResponse data) {
<span class="nc" id="L300">            mResponse = data;</span>
<span class="nc" id="L301">            super.deliverResult(data);</span>
<span class="nc" id="L302">        }</span>

        @Override
        public void onStartLoading() {
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if (takeContentChanged()) {</span>
<span class="nc" id="L307">                forceLoad();</span>
            }
<span class="nc" id="L309">        }</span>

        @Override
        public void onForceLoad() {
<span class="nc" id="L313">            mFragment.showProgress(true);</span>
<span class="nc" id="L314">            super.onForceLoad();</span>
<span class="nc" id="L315">        }</span>

        public void update(StopsRequest req) {
<span class="nc bnc" id="L318" title="All 4 branches missed.">            if (mResponse == null || !mResponse.fulfills(req)) {</span>
<span class="nc" id="L319">                mRequest = req;</span>
<span class="nc" id="L320">                onContentChanged();</span>
            }
<span class="nc" id="L322">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>