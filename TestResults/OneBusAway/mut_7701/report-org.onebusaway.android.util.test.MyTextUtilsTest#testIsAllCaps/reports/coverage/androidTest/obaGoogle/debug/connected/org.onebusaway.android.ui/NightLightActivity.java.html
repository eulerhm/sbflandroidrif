<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NightLightActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">NightLightActivity.java</span></div><h1>NightLightActivity.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2013-2015 Colin McDonough, University of South Florida,
 * Sean J. Barbeau
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.onebusaway.android.ui;

import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.graphics.Color;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.WindowManager;

import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.content.pm.ShortcutInfoCompat;
import androidx.core.content.pm.ShortcutManagerCompat;

import org.onebusaway.android.R;
import org.onebusaway.android.util.UIUtils;

/**
 * A flashing light that riders can show at night to flag bus drivers
 */
<span class="nc" id="L43">public class NightLightActivity extends AppCompatActivity {</span>

    private static final String TAG = &quot;NightLightActivity&quot;;

    private static final String PREFERENCE_SHOWED_DIALOG = &quot;showed_night_light_dialog&quot;;

    static final String INSTALL_SHORTCUT = &quot;com.android.launcher.action.INSTALL_SHORTCUT&quot;;

    private static final int COLOR_DARK = 0xCC000000;

    private boolean lightOn;

    private boolean dialogShown;

    private View screen;

<span class="nc" id="L59">    boolean active = true;</span>

    // Amount of time between flashes, in milliseconds
<span class="nc" id="L62">    private int[] waitTime = {100, 100, 400};</span>

    // Amount of time light is left on for single flash, in milliseconds
    private static final int FLASH_TIME_ON = 75;

<span class="nc" id="L67">    private int counter = 0;</span>

    private int[] mColors;

    private float mOldScreenBrightness;

    /**
     * Starts the activity
     */
    public static void start(Context context) {
<span class="nc" id="L77">        Intent i = new Intent(context, NightLightActivity.class);</span>
<span class="nc" id="L78">        context.startActivity(i);</span>
<span class="nc" id="L79">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L83">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L84">        UIUtils.setupActionBar(this);</span>

<span class="nc" id="L86">        Intent intent = getIntent();</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (Intent.ACTION_CREATE_SHORTCUT.equals(intent.getAction())) {</span>
<span class="nc" id="L88">            ShortcutInfoCompat shortcut = createShortcut();</span>
<span class="nc" id="L89">            setResult(RESULT_OK, shortcut.getIntent());</span>
<span class="nc" id="L90">            finish();</span>
        }

<span class="nc" id="L93">        setContentView(R.layout.night_light);</span>
<span class="nc" id="L94">        screen = findViewById(R.id.screen);</span>
<span class="nc" id="L95">        disableScreenSleep();</span>

        // Set up colors to flash on screen
<span class="nc" id="L98">        mColors = new int[3];</span>
<span class="nc" id="L99">        mColors[0] = Color.WHITE;</span>
<span class="nc" id="L100">        mColors[1] = getResources().getColor(R.color.theme_primary);</span>
<span class="nc" id="L101">        mColors[2] = Color.WHITE;</span>

<span class="nc" id="L103">        maybeShowIntroDialog();</span>
<span class="nc" id="L104">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L108">        super.onResume();</span>
<span class="nc" id="L109">        turnLightOn();</span>

<span class="nc" id="L111">        active = true;</span>

        // Flash the light via a Thread
<span class="nc" id="L114">        new Thread(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc bnc" id="L117" title="All 2 branches missed.">                while (active) {</span>
<span class="nc" id="L118">                    runOnUiThread(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L121">                            turnLightOn();</span>

<span class="nc" id="L123">                        }</span>
                    });

<span class="nc" id="L126">                    Log.d(TAG, &quot;Flashing for &quot; + FLASH_TIME_ON + &quot;ms&quot;);</span>

                    try {
<span class="nc" id="L129">                        Thread.sleep(FLASH_TIME_ON);</span>
<span class="nc" id="L130">                    } catch (InterruptedException e) {</span>
<span class="nc" id="L131">                        e.printStackTrace();</span>
<span class="nc" id="L132">                    }</span>

<span class="nc" id="L134">                    runOnUiThread(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L137">                            turnLightOff();</span>
<span class="nc" id="L138">                        }</span>
                    });

                    try {
<span class="nc" id="L142">                        Log.d(TAG, &quot;Sleeping for &quot; + waitTime[counter % 3] + &quot;ms&quot;);</span>
<span class="nc" id="L143">                        Thread.sleep(waitTime[counter % 3]);</span>
<span class="nc" id="L144">                    } catch (InterruptedException e) {</span>
<span class="nc" id="L145">                        e.printStackTrace();</span>
<span class="nc" id="L146">                    }</span>
<span class="nc" id="L147">                    counter++;</span>
                }
<span class="nc" id="L149">            }</span>
<span class="nc" id="L150">        }).start();</span>
<span class="nc" id="L151">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L155">        super.onPause();</span>
<span class="nc" id="L156">        turnLightOff();</span>
<span class="nc" id="L157">        active = false;</span>

<span class="nc" id="L159">        restoreScreenBrightness();</span>
<span class="nc" id="L160">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L164">        getMenuInflater().inflate(R.menu.night_light, menu);</span>
<span class="nc" id="L165">        return super.onCreateOptionsMenu(menu);</span>
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (item.getItemId() == R.id.create_shortcut) {</span>
<span class="nc" id="L171">            createShortcut();</span>
<span class="nc" id="L172">            return true;</span>
        }
<span class="nc" id="L174">        return false;</span>
    }

    /**
     * Called after its confirmed that the user has seen the intro dialog to start the flashing
     */
    public void onViewedDialog() {
<span class="nc" id="L181">        dialogShown = true;</span>

        // Set screen brightness to full
<span class="nc" id="L184">        setScreenBrightness();</span>

<span class="nc" id="L186">        turnLightOn();</span>
<span class="nc" id="L187">    }</span>

    private void disableScreenSleep() {
<span class="nc" id="L190">        getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);</span>
<span class="nc" id="L191">    }</span>

    /**
     * Shows the initial intro dialog if the user hasn't yet seen it, and then start the flashing.
     * If the user has already seen the dialog, immediately start flashing
     */
    private void maybeShowIntroDialog() {
<span class="nc" id="L198">        final SharedPreferences sp = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (!sp.getBoolean(PREFERENCE_SHOWED_DIALOG, false)) {</span>
<span class="nc" id="L200">            final AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc" id="L201">            builder.setTitle(R.string.night_light_dialog_title);</span>
<span class="nc" id="L202">            builder.setCancelable(false);</span>
<span class="nc" id="L203">            builder.setPositiveButton(R.string.night_light_start, (dialog, which) -&gt; {</span>
<span class="nc" id="L204">                sp.edit().putBoolean(PREFERENCE_SHOWED_DIALOG, true).commit();</span>
                // Start the flashing
<span class="nc" id="L206">                onViewedDialog();</span>
<span class="nc" id="L207">            });</span>
<span class="nc" id="L208">            builder.setNegativeButton(R.string.night_light_cancel, (dialog, which) -&gt; {</span>
                // Close the activity without starting the flashing
<span class="nc" id="L210">                finish();</span>
<span class="nc" id="L211">            });</span>
<span class="nc" id="L212">            builder.setMessage(R.string.night_light_dialog_message);</span>
<span class="nc" id="L213">            builder.create().show();</span>
<span class="nc" id="L214">        } else {</span>
            // Start the flashing
<span class="nc" id="L216">            onViewedDialog();</span>
        }
<span class="nc" id="L218">    }</span>

    /*
     * Called by the view (see main.xml)
     */
    public void toggleLight(View view) {
<span class="nc" id="L224">        toggleLight();</span>
<span class="nc" id="L225">    }</span>

    private void toggleLight() {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (lightOn) {</span>
<span class="nc" id="L229">            turnLightOff();</span>
        } else {
<span class="nc" id="L231">            turnLightOn();</span>
        }
<span class="nc" id="L233">    }</span>

    private void turnLightOn() {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (!dialogShown) {</span>
<span class="nc" id="L237">            return;</span>
        }

<span class="nc" id="L240">        lightOn = true;</span>

        // Use the screen as a flashlight
<span class="nc" id="L243">        screen.setBackgroundColor(mColors[counter % 3]);</span>
<span class="nc" id="L244">    }</span>

    private void turnLightOff() {
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (lightOn) {</span>
            // Set the background to dark
<span class="nc" id="L249">            screen.setBackgroundColor(COLOR_DARK);</span>
<span class="nc" id="L250">            lightOn = false;</span>
        }
<span class="nc" id="L252">    }</span>

    private void setScreenBrightness() {
<span class="nc" id="L255">        WindowManager.LayoutParams lp = this.getWindow().getAttributes();</span>
<span class="nc" id="L256">        mOldScreenBrightness = lp.screenBrightness;</span>
<span class="nc" id="L257">        lp.screenBrightness = 1.0f;</span>
<span class="nc" id="L258">        this.getWindow().setAttributes(lp);</span>
<span class="nc" id="L259">    }</span>

    private void restoreScreenBrightness() {
<span class="nc" id="L262">        WindowManager.LayoutParams lp = this.getWindow().getAttributes();</span>
<span class="nc" id="L263">        lp.screenBrightness = mOldScreenBrightness;</span>
<span class="nc" id="L264">    }</span>

    /**
     * Create a shortcut on the home screen
     * @return shortcut info that was created
     */
    private ShortcutInfoCompat createShortcut() {
<span class="nc" id="L271">        final ShortcutInfoCompat shortcut =</span>
<span class="nc" id="L272">                UIUtils.makeShortcutInfo(this,</span>
<span class="nc" id="L273">                        getString(R.string.stop_info_option_night_light),</span>
                        new Intent(this,
                                NightLightActivity.class),
                        R.drawable.ic_night_light);
<span class="nc" id="L277">        ShortcutManagerCompat.requestPinShortcut(this, shortcut, null);</span>
<span class="nc" id="L278">        return shortcut;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>