<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransitionBroadcastReceiver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.travelbehavior.receiver</a> &gt; <span class="el_source">TransitionBroadcastReceiver.java</span></div><h1>TransitionBroadcastReceiver.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2019 University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.travelbehavior.receiver;

import com.google.android.gms.location.ActivityRecognition;
import com.google.android.gms.location.ActivityRecognitionClient;
import com.google.android.gms.location.ActivityTransitionEvent;
import com.google.android.gms.location.ActivityTransitionResult;
import com.google.android.gms.location.FusedLocationProviderClient;
import com.google.android.gms.location.LocationServices;
import com.google.firebase.firestore.DocumentReference;

import org.onebusaway.android.app.Application;
import org.onebusaway.android.travelbehavior.constants.TravelBehaviorConstants;
import org.onebusaway.android.travelbehavior.io.worker.ArrivalsAndDeparturesDataReaderWorker;
import org.onebusaway.android.travelbehavior.io.worker.DestinationReminderReaderWorker;
import org.onebusaway.android.travelbehavior.io.worker.TripPlanDataReaderWorker;
import org.onebusaway.android.travelbehavior.model.TravelBehaviorInfo;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorFirebaseIOUtils;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorUtils;
import org.onebusaway.android.util.PermissionUtils;
import org.onebusaway.android.util.PreferenceUtils;

import android.Manifest;
import android.annotation.SuppressLint;
import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.location.LocationManager;
import android.util.Log;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.concurrent.TimeUnit;

import androidx.work.Data;
import androidx.work.OneTimeWorkRequest;
import androidx.work.WorkManager;

<span class="nc" id="L55">public class TransitionBroadcastReceiver extends BroadcastReceiver {</span>

    private static final String TAG = &quot;ActivityTransition&quot;;

    private Context mContext;
    private List&lt;TravelBehaviorInfo.TravelBehaviorActivity&gt; mActivityList;
    private String mUid;
    private String mRecordId;

    @Override
    public void onReceive(Context context, Intent intent) {
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (intent != null) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            if (ActivityTransitionResult.hasResult(intent)) {</span>
<span class="nc" id="L68">                mContext = context;</span>

<span class="nc" id="L70">                ActivityTransitionResult result = ActivityTransitionResult.extractResult(intent);</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">                if (result == null) {</span>
<span class="nc" id="L72">                    return;</span>
                }

<span class="nc" id="L75">                StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L76">                mActivityList = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">                for (ActivityTransitionEvent event : result.getTransitionEvents()) {</span>
<span class="nc" id="L79">                    sb.append(TravelBehaviorUtils.toActivityString(event.getActivityType())).append(&quot; -- &quot;);</span>
<span class="nc" id="L80">                    sb.append(TravelBehaviorUtils.toTransitionType(event.getTransitionType())).append(&quot;\n&quot;);</span>
<span class="nc" id="L81">                    mActivityList.add(new TravelBehaviorInfo.TravelBehaviorActivity(</span>
<span class="nc" id="L82">                            TravelBehaviorUtils.toActivityString(event.getActivityType()),</span>
<span class="nc" id="L83">                            TravelBehaviorUtils.toTransitionType(event.getTransitionType()),</span>
<span class="nc" id="L84">                            event.getElapsedRealTimeNanos()));</span>
<span class="nc" id="L85">                }</span>

<span class="nc" id="L87">                Log.d(TAG, &quot;Detected activity transition: &quot; + sb.toString());</span>
<span class="nc" id="L88">                TravelBehaviorUtils.showDebugToastMessageWithVibration(</span>
<span class="nc" id="L89">                        &quot;Detected activity transition: &quot; + sb.toString(), mContext);</span>

<span class="nc" id="L91">                mUid = PreferenceUtils.getString(TravelBehaviorConstants.USER_ID);</span>
<span class="nc" id="L92">                saveTravelBehavior();</span>
            }
        }
<span class="nc" id="L95">    }</span>

    private void saveTravelBehavior() {
<span class="nc" id="L98">        saveTravelBehavior(new TravelBehaviorInfo(mActivityList,</span>
<span class="nc" id="L99">                Application.isIgnoringBatteryOptimizations(mContext)));</span>

<span class="nc" id="L101">        startSaveTripPlansWorker();</span>

<span class="nc" id="L103">        startSaveArrivalAndDepartureWorker();</span>

<span class="nc" id="L105">        startSaveDestinationRemindersWorker();</span>

<span class="nc" id="L107">        requestActivityRecognition();</span>

<span class="nc" id="L109">        requestLocationUpdates();</span>
<span class="nc" id="L110">    }</span>

    private void saveTravelBehavior(TravelBehaviorInfo tbi) {
<span class="nc" id="L113">        long riPrefix = PreferenceUtils.getLong(TravelBehaviorConstants.RECORD_ID, 0);</span>
<span class="nc" id="L114">        mRecordId = riPrefix++ + &quot;-&quot; + UUID.randomUUID().toString();</span>
<span class="nc" id="L115">        PreferenceUtils.saveLong(TravelBehaviorConstants.RECORD_ID, riPrefix);</span>

<span class="nc" id="L117">        DocumentReference document = TravelBehaviorFirebaseIOUtils.</span>
<span class="nc" id="L118">                getFirebaseDocReferenceByUserIdAndRecordId(mUid, mRecordId,</span>
                        TravelBehaviorConstants.FIREBASE_ACTIVITY_TRANSITION_FOLDER);

<span class="nc" id="L121">        document.set(tbi).addOnCompleteListener(task -&gt; {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (task.isSuccessful()) {</span>
<span class="nc" id="L123">                Log.d(TAG, &quot;Activity transition document added with ID &quot; + document.getId());</span>
            } else {
<span class="nc" id="L125">                TravelBehaviorFirebaseIOUtils.logErrorMessage(task.getException(),</span>
                        &quot;Activity transition document failed to be added: &quot;);
            }
<span class="nc" id="L128">        });</span>
<span class="nc" id="L129">    }</span>

    private void startSaveArrivalAndDepartureWorker() {
<span class="nc" id="L132">        Data myData = new Data.Builder()</span>
<span class="nc" id="L133">                .putString(TravelBehaviorConstants.USER_ID, mUid)</span>
<span class="nc" id="L134">                .putString(TravelBehaviorConstants.RECORD_ID, mRecordId)</span>
<span class="nc" id="L135">                .build();</span>

<span class="nc" id="L137">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.</span>
                Builder(ArrivalsAndDeparturesDataReaderWorker.class)
<span class="nc" id="L139">                .setInputData(myData)</span>
<span class="nc" id="L140">                .build();</span>
<span class="nc" id="L141">        WorkManager.getInstance().enqueue(workRequest);</span>
<span class="nc" id="L142">    }</span>

    private void startSaveTripPlansWorker() {
<span class="nc" id="L145">        Data myData = new Data.Builder()</span>
<span class="nc" id="L146">                .putString(TravelBehaviorConstants.USER_ID, mUid)</span>
<span class="nc" id="L147">                .putString(TravelBehaviorConstants.RECORD_ID, mRecordId)</span>
<span class="nc" id="L148">                .build();</span>

<span class="nc" id="L150">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.Builder(TripPlanDataReaderWorker.class)</span>
<span class="nc" id="L151">                .setInputData(myData)</span>
<span class="nc" id="L152">                .build();</span>
<span class="nc" id="L153">        WorkManager.getInstance().enqueue(workRequest);</span>
<span class="nc" id="L154">    }</span>

    private void startSaveDestinationRemindersWorker() {
<span class="nc" id="L157">        Data myData = new Data.Builder()</span>
<span class="nc" id="L158">                .putString(TravelBehaviorConstants.USER_ID, mUid)</span>
<span class="nc" id="L159">                .putString(TravelBehaviorConstants.RECORD_ID, mRecordId)</span>
<span class="nc" id="L160">                .build();</span>

<span class="nc" id="L162">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.Builder(DestinationReminderReaderWorker.class)</span>
<span class="nc" id="L163">                .setInputData(myData)</span>
<span class="nc" id="L164">                .build();</span>
<span class="nc" id="L165">        WorkManager.getInstance().enqueue(workRequest);</span>
<span class="nc" id="L166">    }</span>

    private void requestActivityRecognition() {
<span class="nc" id="L169">        ActivityRecognitionClient client = ActivityRecognition.getClient(mContext);</span>
<span class="nc" id="L170">        Intent intent = new Intent(mContext, RecognitionBroadcastReceiver.class);</span>
<span class="nc" id="L171">        intent.putExtra(TravelBehaviorConstants.RECORD_ID, mRecordId);</span>

<span class="nc" id="L173">        int reqCode = PreferenceUtils.getInt(TravelBehaviorConstants.RECOGNITION_REQUEST_CODE, 0);</span>
        int flags;
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S) {</span>
<span class="nc" id="L176">            flags = PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_MUTABLE;</span>
        } else {
<span class="nc" id="L178">            flags = PendingIntent.FLAG_ONE_SHOT;</span>
        }
<span class="nc" id="L180">        PendingIntent pi = PendingIntent.getBroadcast(mContext, reqCode++, intent, flags);</span>
<span class="nc" id="L181">        PreferenceUtils.saveInt(TravelBehaviorConstants.RECOGNITION_REQUEST_CODE, reqCode);</span>
<span class="nc" id="L182">        client.requestActivityUpdates(TimeUnit.SECONDS.toMillis(10), pi);</span>
<span class="nc" id="L183">    }</span>

    private void requestLocationUpdates() {
<span class="nc" id="L186">        String[] requiredPermissions = {Manifest.permission.ACCESS_FINE_LOCATION,</span>
                Manifest.permission.ACCESS_COARSE_LOCATION};
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (PermissionUtils.hasGrantedAllPermissions(mContext, requiredPermissions)) {</span>
<span class="nc" id="L189">            Log.d(TAG, &quot;Location permissions are granted, requesting fused, GPS, and Network&quot; +</span>
                    &quot;locations&quot;);
<span class="nc" id="L191">            requestFusedLocation();</span>
<span class="nc" id="L192">            requestGPSNetworkLocation();</span>
        } else {
<span class="nc" id="L194">            Log.d(TAG, &quot;Location permissions not granted. Skipping location requests&quot;);</span>
        }
<span class="nc" id="L196">    }</span>

    @SuppressLint(&quot;MissingPermission&quot;)
    private void requestFusedLocation() {
<span class="nc" id="L200">        FusedLocationProviderClient client = LocationServices.getFusedLocationProviderClient(mContext);</span>
<span class="nc" id="L201">        client.getLastLocation().addOnSuccessListener(location -&gt; {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            if (location != null) {</span>
<span class="nc" id="L203">                TravelBehaviorFirebaseIOUtils.saveLocation(location, mUid, mRecordId);</span>
            }
<span class="nc" id="L205">        });</span>
<span class="nc" id="L206">    }</span>

    @SuppressLint(&quot;MissingPermission&quot;)
    private void requestGPSNetworkLocation() {
<span class="nc" id="L210">        LocationManager lm = (LocationManager) Application.get().getBaseContext()</span>
<span class="nc" id="L211">                .getSystemService(Context.LOCATION_SERVICE);</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (lm == null) return;</span>

<span class="nc" id="L215">        List&lt;String&gt; providers = lm.getProviders(true);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        for (String provider : providers) {</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (LocationManager.PASSIVE_PROVIDER.equals(provider)) continue;</span>

<span class="nc" id="L219">            int reqCode = PreferenceUtils.getInt(TravelBehaviorConstants.LOCATION_REQUEST_CODE, 0);</span>
<span class="nc" id="L220">            Intent intent = new Intent(mContext, LocationBroadcastReceiver.class);</span>
<span class="nc" id="L221">            intent.putExtra(TravelBehaviorConstants.RECORD_ID, mRecordId);</span>
            int flags;
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S) {</span>
<span class="nc" id="L224">                flags = PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_MUTABLE;</span>
            } else {
<span class="nc" id="L226">                flags = PendingIntent.FLAG_ONE_SHOT;</span>
            }
<span class="nc" id="L228">            PendingIntent pi = PendingIntent.getBroadcast(mContext, reqCode++, intent, flags);</span>
<span class="nc" id="L229">            lm.requestLocationUpdates(provider, 0, 0, pi);</span>
<span class="nc" id="L230">            PreferenceUtils.saveInt(TravelBehaviorConstants.LOCATION_REQUEST_CODE, reqCode);</span>
<span class="nc" id="L231">        }</span>
<span class="nc" id="L232">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>