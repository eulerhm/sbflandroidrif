<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StopMapController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.map</a> &gt; <span class="el_source">StopMapController.java</span></div><h1>StopMapController.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011-2014 Paul Watts (paulcwatts@gmail.com),
 * University of South Florida (sjbarbeau@gmail.com), and individual contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.map;

import com.google.android.gms.common.api.GoogleApiClient;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.elements.ObaStop;
import org.onebusaway.android.io.request.ObaStopsForLocationRequest;
import org.onebusaway.android.io.request.ObaStopsForLocationResponse;
import org.onebusaway.android.map.googlemapsv2.BaseMapFragment;
import org.onebusaway.android.util.RegionUtils;
import android.location.Location;
import android.os.Bundle;
import android.text.TextUtils;
import android.util.Log;
import java.util.Arrays;
import java.util.List;
import androidx.loader.app.LoaderManager;
import androidx.loader.content.AsyncTaskLoader;
import androidx.loader.content.Loader;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

final class StopsRequest {

    private final Location mCenter;

    private final double mLatSpan;

    private final double mLonSpan;

    private final double mZoomLevel;

<span class="nc" id="L48">    StopsRequest(MapModeController.ObaMapView view) {</span>
<span class="nc" id="L49">        mCenter = view.getMapCenterAsLocation();</span>
<span class="nc" id="L50">        mLatSpan = view.getLatitudeSpanInDecDegrees();</span>
<span class="nc" id="L51">        mLonSpan = view.getLongitudeSpanInDecDegrees();</span>
<span class="nc" id="L52">        mZoomLevel = view.getZoomLevelAsFloat();</span>
<span class="nc" id="L53">    }</span>

    Location getCenter() {
<span class="nc" id="L56">        return mCenter;</span>
    }

    double getLatSpan() {
<span class="nc" id="L60">        return mLatSpan;</span>
    }

    double getLonSpan() {
<span class="nc" id="L64">        return mLonSpan;</span>
    }

    double getZoomLevel() {
<span class="nc" id="L68">        return mZoomLevel;</span>
    }
}

final class StopsResponse {

    private final StopsRequest mRequest;

    private final ObaStopsForLocationResponse mResponse;

<span class="nc" id="L78">    StopsResponse(StopsRequest req, ObaStopsForLocationResponse response) {</span>
<span class="nc" id="L79">        mRequest = req;</span>
<span class="nc" id="L80">        mResponse = response;</span>
<span class="nc" id="L81">    }</span>

    StopsRequest getRequest() {
<span class="nc" id="L84">        return mRequest;</span>
    }

    ObaStopsForLocationResponse getResponse() {
<span class="nc" id="L88">        return mResponse;</span>
    }

    /**
     * Returns true if newReq also fulfills response.
     */
    boolean fulfills(StopsRequest newReq) {
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10256)) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (mRequest.getCenter() == null) {</span>
                // Log.d(TAG, &quot;No center&quot;);
<span class="nc" id="L98">                return false;</span>
            }
        }
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10257)) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (!mRequest.getCenter().equals(newReq.getCenter())) {</span>
                // Log.d(TAG, &quot;Center not the same&quot;);
<span class="nc" id="L104">                return false;</span>
            }
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10270)) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (mResponse != null) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10269)) {</span>
<span class="nc bnc" id="L110" title="All 50 branches missed.">                    if ((ListenerUtil.mutListener.listen(10263) ? (((ListenerUtil.mutListener.listen(10262) ? (newReq.getZoomLevel() &gt;= mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10261) ? (newReq.getZoomLevel() &lt;= mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10260) ? (newReq.getZoomLevel() &lt; mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10259) ? (newReq.getZoomLevel() != mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10258) ? (newReq.getZoomLevel() == mRequest.getZoomLevel()) : (newReq.getZoomLevel() &gt; mRequest.getZoomLevel()))))))) || mResponse.getLimitExceeded()) : (((ListenerUtil.mutListener.listen(10262) ? (newReq.getZoomLevel() &gt;= mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10261) ? (newReq.getZoomLevel() &lt;= mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10260) ? (newReq.getZoomLevel() &lt; mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10259) ? (newReq.getZoomLevel() != mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10258) ? (newReq.getZoomLevel() == mRequest.getZoomLevel()) : (newReq.getZoomLevel() &gt; mRequest.getZoomLevel()))))))) &amp;&amp; mResponse.getLimitExceeded()))) {</span>
                        // Log.d(TAG, &quot;Zooming in -- limit exceeded&quot;);
<span class="nc" id="L112">                        return false;</span>
<span class="nc bnc" id="L113" title="All 22 branches missed.">                    } else if ((ListenerUtil.mutListener.listen(10268) ? (newReq.getZoomLevel() &gt;= mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10267) ? (newReq.getZoomLevel() &lt;= mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10266) ? (newReq.getZoomLevel() &gt; mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10265) ? (newReq.getZoomLevel() != mRequest.getZoomLevel()) : (ListenerUtil.mutListener.listen(10264) ? (newReq.getZoomLevel() == mRequest.getZoomLevel()) : (newReq.getZoomLevel() &lt; mRequest.getZoomLevel()))))))) {</span>
                        // Log.d(TAG, &quot;Zooming out&quot;);
<span class="nc" id="L115">                        return false;</span>
                    }
                }
            }
        }
<span class="nc" id="L120">        return true;</span>
    }
}

public class StopMapController extends BaseMapController implements LoaderManager.LoaderCallbacks&lt;StopsResponse&gt;, Loader.OnLoadCompleteListener&lt;StopsResponse&gt; {

    private static final String TAG = &quot;StopMapController&quot;;

    private static final int STOPS_LOADER = 5678;

    // available in SherlockMapActivity
    private Loader&lt;StopsResponse&gt; mLoader;

    private MapWatcher mMapWatcher;

    /**
     * GoogleApiClient being used for Location Services
     */
    GoogleApiClient mGoogleApiClient;

    public StopMapController(Callback callback) {
<span class="nc" id="L141">        super(callback);</span>
<span class="nc" id="L142">    }</span>

    @Override
    protected void createLoader() {
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10271)) {</span>
<span class="nc" id="L147">            mLoader = onCreateLoader(STOPS_LOADER, null);</span>
        }
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10272)) {</span>
<span class="nc" id="L150">            mLoader.registerListener(0, this);</span>
        }
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10273)) {</span>
<span class="nc" id="L153">            mLoader.startLoading();</span>
        }
<span class="nc" id="L155">    }</span>

    @Override
    public String getMode() {
<span class="nc" id="L159">        return MapParams.MODE_STOP;</span>
    }

    @Override
    public void onHidden(boolean hidden) {
<span class="nc" id="L164">    }</span>

    @Override
    public Loader&lt;StopsResponse&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L168">        StopsLoader loader = new StopsLoader(mCallback);</span>
<span class="nc" id="L169">        StopsRequest req = new StopsRequest(mCallback.getMapView());</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10274)) {</span>
<span class="nc" id="L171">            loader.update(req);</span>
        }
<span class="nc" id="L173">        return loader;</span>
    }

    protected StopsLoader getLoader() {
        // return (StopsLoader)l;
<span class="nc" id="L178">        return (StopsLoader) mLoader;</span>
    }

    @Override
    protected void updateData() {
<span class="nc" id="L183">        StopsLoader loader = getLoader();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10276)) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (loader != null) {</span>
<span class="nc" id="L186">                StopsRequest req = new StopsRequest(mCallback.getMapView());</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10275)) {</span>
<span class="nc" id="L188">                    loader.update(req);</span>
                }
            }
        }
<span class="nc" id="L192">    }</span>

    @Override
    public void onLoadFinished(Loader&lt;StopsResponse&gt; loader, StopsResponse _response) {
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10277)) {</span>
<span class="nc" id="L197">            mCallback.showProgress(false);</span>
        }
<span class="nc" id="L199">        final ObaStopsForLocationResponse response = _response.getResponse();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10278)) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (response == null) {</span>
                // Initial install can generate a null response if all is still ok, so do nothing (#615)
<span class="nc" id="L203">                return;</span>
            }
        }
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10280)) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (response.getCode() != ObaApi.OBA_OK) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10279)) {</span>
<span class="nc" id="L209">                    BaseMapFragment.showMapError(response);</span>
                }
<span class="nc" id="L211">                return;</span>
            }
        }
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10282)) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (response.getOutOfRange()) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10281)) {</span>
<span class="nc" id="L217">                    mCallback.notifyOutOfRange();</span>
                }
<span class="nc" id="L219">                return;</span>
            }
        }
        // versions below the version number in which this is fixed.
<span class="nc" id="L223">        Location myLocation = Application.getLastKnownLocation(mCallback.getActivity(), mGoogleApiClient);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10290)) {</span>
<span class="nc bnc" id="L225" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(10283) ? (myLocation != null || Application.get().getCurrentRegion() != null) : (myLocation != null &amp;&amp; Application.get().getCurrentRegion() != null))) {</span>
                // Assume user is in region unless we detect otherwise
<span class="nc" id="L227">                boolean inRegion = true;</span>
                try {
<span class="nc bnc" id="L229" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(10285)) {</span>
<span class="nc" id="L230">                        inRegion = RegionUtils.isLocationWithinRegion(myLocation, Application.get().getCurrentRegion());</span>
                    }
<span class="nc" id="L232">                } catch (IllegalArgumentException e) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(10284)) {</span>
                        // Issue #69 - some devices are providing invalid lat/long coordinates
<span class="nc" id="L235">                        Log.e(TAG, &quot;Invalid latitude or longitude - lat = &quot; + myLocation.getLatitude() + &quot;, long = &quot; + myLocation.getLongitude());</span>
                    }
<span class="nc" id="L237">                }</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10289)) {</span>
<span class="nc bnc" id="L239" title="All 10 branches missed.">                    if ((ListenerUtil.mutListener.listen(10286) ? (!inRegion || Arrays.asList(response.getStops()).isEmpty()) : (!inRegion &amp;&amp; Arrays.asList(response.getStops()).isEmpty()))) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10287)) {</span>
<span class="nc" id="L241">                            Log.d(TAG, &quot;Device location is outside region range, notifying...&quot;);</span>
                        }
<span class="nc bnc" id="L243" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10288)) {</span>
<span class="nc" id="L244">                            mCallback.notifyOutOfRange();</span>
                        }
<span class="nc" id="L246">                        return;</span>
                    }
                }
            }
        }
<span class="nc" id="L251">        List&lt;ObaStop&gt; stops = Arrays.asList(response.getStops());</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10291)) {</span>
<span class="nc" id="L253">            mCallback.showStops(stops, response);</span>
        }
<span class="nc" id="L255">    }</span>

    @Override
    public void onLoaderReset(Loader&lt;StopsResponse&gt; loader) {
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10292)) {</span>
            // Clear the overlay.
<span class="nc" id="L261">            mCallback.showStops(null, null);</span>
        }
<span class="nc" id="L263">    }</span>

    // Remove when adding back LoaderManager help.
    @Override
    public void onLoadComplete(Loader&lt;StopsResponse&gt; loader, StopsResponse response) {
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10293)) {</span>
<span class="nc" id="L269">            onLoadFinished(loader, response);</span>
        }
<span class="nc" id="L271">    }</span>

    // 
    private static class StopsLoader extends AsyncTaskLoader&lt;StopsResponse&gt; {

        private final Callback mFragment;

        private StopsRequest mRequest;

        private StopsResponse mResponse;

        public StopsLoader(Callback fragment) {
<span class="nc" id="L283">            super(fragment.getActivity());</span>
<span class="nc" id="L284">            mFragment = fragment;</span>
<span class="nc" id="L285">        }</span>

        @Override
        public StopsResponse loadInBackground() {
<span class="nc" id="L289">            StopsRequest req = mRequest;</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10296)) {</span>
<span class="nc bnc" id="L291" title="All 10 branches missed.">                if ((ListenerUtil.mutListener.listen(10294) ? (Application.get().getCurrentRegion() == null || TextUtils.isEmpty(Application.get().getCustomApiUrl())) : (Application.get().getCurrentRegion() == null &amp;&amp; TextUtils.isEmpty(Application.get().getCustomApiUrl())))) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(10295)) {</span>
                        // We don't have region info or manually entered API to know what server to contact
<span class="nc" id="L294">                        Log.d(TAG, &quot;Trying to load stops from server without &quot; + &quot;OBA REST API endpoint, aborting...&quot;);</span>
                    }
<span class="nc" id="L296">                    return new StopsResponse(req, null);</span>
                }
            }
            // Make OBA REST API call to the server and return result
<span class="nc" id="L300">            ObaStopsForLocationResponse response = new ObaStopsForLocationRequest.Builder(getContext(), req.getCenter()).setSpan(req.getLatSpan(), req.getLonSpan()).build().call();</span>
<span class="nc" id="L301">            return new StopsResponse(req, response);</span>
        }

        @Override
        public void deliverResult(StopsResponse data) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10297)) {</span>
<span class="nc" id="L307">                mResponse = data;</span>
            }
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10298)) {</span>
<span class="nc" id="L310">                super.deliverResult(data);</span>
            }
<span class="nc" id="L312">        }</span>

        @Override
        public void onStartLoading() {
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10300)) {</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                if (takeContentChanged()) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(10299)) {</span>
<span class="nc" id="L319">                        forceLoad();</span>
                    }
                }
            }
<span class="nc" id="L323">        }</span>

        @Override
        public void onForceLoad() {
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10301)) {</span>
<span class="nc" id="L328">                mFragment.showProgress(true);</span>
            }
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10302)) {</span>
<span class="nc" id="L331">                super.onForceLoad();</span>
            }
<span class="nc" id="L333">        }</span>

        public void update(StopsRequest req) {
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10306)) {</span>
<span class="nc bnc" id="L337" title="All 10 branches missed.">                if ((ListenerUtil.mutListener.listen(10303) ? (mResponse == null &amp;&amp; !mResponse.fulfills(req)) : (mResponse == null || !mResponse.fulfills(req)))) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(10304)) {</span>
<span class="nc" id="L339">                        mRequest = req;</span>
                    }
<span class="nc bnc" id="L341" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(10305)) {</span>
<span class="nc" id="L342">                        onContentChanged();</span>
                    }
                }
            }
<span class="nc" id="L346">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>