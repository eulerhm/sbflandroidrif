<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NavigationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.nav</a> &gt; <span class="el_source">NavigationService.java</span></div><h1>NavigationService.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2005-2019 University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.nav;

import static android.app.PendingIntent.*;

import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.app.Service;
import android.content.Context;
import android.content.Intent;
import android.location.Location;
import android.os.Build;
import android.os.IBinder;
import android.util.Log;

import androidx.core.app.NotificationCompat;
import androidx.core.app.RemoteInput;
import androidx.work.PeriodicWorkRequest;
import androidx.work.WorkManager;

import com.google.firebase.analytics.FirebaseAnalytics;
import com.google.firebase.auth.FirebaseAuth;
import com.google.firebase.auth.FirebaseUser;

import org.apache.commons.io.FileUtils;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.nav.model.Path;
import org.onebusaway.android.nav.model.PathLink;
import org.onebusaway.android.provider.ObaContract;
import org.onebusaway.android.ui.FeedbackActivity;
import org.onebusaway.android.ui.TripDetailsListFragment;
import org.onebusaway.android.util.LocationHelper;
import org.onebusaway.android.util.LocationUtils;
import org.onebusaway.android.util.PreferenceUtils;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Locale;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

/**
 * Implements the &quot;destination reminders&quot; feature in the app that notifies the user as they
 * are approaching their destination stop on-board the transit vehicle.
 * &lt;p&gt;
 * The NavigationService is started when the user begins a trip, this service listens for location
 * updates and passes the locations to its instance of NavigationServiceProvider each time.
 * NavigationServiceProvider is responsible for computing the statuses of the trips and issuing
 * notifications/TTS messages. Once the NavigationServiceProvider is completed, the
 * NavigationService will stop itself.
 */
<span class="nc" id="L73">public class NavigationService extends Service implements LocationHelper.Listener {</span>
    public static final String TAG = &quot;NavigationService&quot;;

    public static final String DESTINATION_ID = &quot;.DestinationId&quot;;
    public static final String BEFORE_STOP_ID = &quot;.BeforeId&quot;;
    public static final String TRIP_ID = &quot;.TripId&quot;;
    public static final String FIRST_FEEDBACK = &quot;firstFeedback&quot;;
    public static final String KEY_TEXT_REPLY = &quot;trip_feedback&quot;;

    public static final String LOG_DIRECTORY = &quot;ObaNavLog&quot;;

<span class="nc" id="L84">    public static boolean mFirstFeedback = true;</span>

    private static final int RECORDING_THRESHOLD = NavigationServiceProvider.DISTANCE_THRESHOLD + 100;

<span class="nc" id="L88">    private LocationHelper mLocationHelper = null;</span>
<span class="nc" id="L89">    private Location mLastLocation = null;</span>

    private String mDestinationStopId;              // Destination Stop ID
    private String mBeforeStopId;                   // Before Destination Stop ID
    private String mTripId;                         // Trip ID

<span class="nc" id="L95">    private int mCoordId = 0;</span>

    private NavigationServiceProvider mNavProvider;
<span class="nc" id="L98">    private File mLogFile = null;</span>

    private long mFinishedTime;

    private FirebaseAuth mAuth;
    private FirebaseAnalytics mFirebaseAnalytics;

    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
<span class="nc" id="L107">        Log.d(TAG, &quot;Starting Service&quot;);</span>
<span class="nc" id="L108">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(this);</span>
<span class="nc" id="L109">        long currentTime = System.currentTimeMillis();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (intent != null) {</span>
<span class="nc" id="L111">            mDestinationStopId = intent.getStringExtra(DESTINATION_ID);</span>
<span class="nc" id="L112">            mBeforeStopId = intent.getStringExtra(BEFORE_STOP_ID);</span>
<span class="nc" id="L113">            mTripId = intent.getStringExtra(TRIP_ID);</span>

<span class="nc" id="L115">            ObaContract.NavStops.insert(Application.get().getApplicationContext(), currentTime,</span>
<span class="nc" id="L116">                    1, 1, mTripId, mDestinationStopId, mBeforeStopId);</span>


<span class="nc" id="L119">            mNavProvider = new NavigationServiceProvider(mTripId, mDestinationStopId);</span>
        } else {
<span class="nc" id="L121">            String[] args = ObaContract.NavStops.getDetails(Application.get().getApplicationContext(), &quot;1&quot;);</span>
<span class="nc bnc" id="L122" title="All 4 branches missed.">            if (args != null &amp;&amp; args.length == 3) {</span>
<span class="nc" id="L123">                mTripId = args[0];</span>
<span class="nc" id="L124">                mDestinationStopId = args[1];</span>
<span class="nc" id="L125">                mBeforeStopId = args[2];</span>
<span class="nc" id="L126">                mNavProvider = new NavigationServiceProvider(mTripId, mDestinationStopId, 1);</span>

            }
        }

        // Log in anonymously via Firebase
<span class="nc" id="L132">        initAnonFirebaseLogin();</span>

        // Setup file for logging.
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (mLogFile == null) {</span>
<span class="nc" id="L136">            setupLog();</span>
        }

<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (mLocationHelper == null) {</span>
<span class="nc" id="L140">            mLocationHelper = new LocationHelper(this, 1);</span>
        }

<span class="nc" id="L143">        Log.d(TAG, &quot;Requesting Location Updates&quot;);</span>
<span class="nc" id="L144">        mLocationHelper.registerListener(this);</span>

<span class="nc" id="L146">        Location dest = ObaContract.Stops.getLocation(Application.get().getApplicationContext(), mDestinationStopId);</span>
<span class="nc" id="L147">        Location last = ObaContract.Stops.getLocation(Application.get().getApplicationContext(), mBeforeStopId);</span>
<span class="nc" id="L148">        PathLink pathLink = new PathLink(currentTime, null, last, dest, mTripId);</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (mNavProvider != null) {</span>
            // TODO Support more than one path link
<span class="nc" id="L152">            ArrayList&lt;PathLink&gt; links = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L153">            links.add(pathLink);</span>
<span class="nc" id="L154">            Path path = new Path(links);</span>
<span class="nc" id="L155">            mNavProvider.navigate(path);</span>
        }
<span class="nc" id="L157">        Notification notification = mNavProvider.getForegroundStartingNotification();</span>
<span class="nc" id="L158">        startForeground(NavigationServiceProvider.NOTIFICATION_ID, notification);</span>
<span class="nc" id="L159">        return START_STICKY;</span>
    }


    @Override
    public IBinder onBind(Intent intent) {
<span class="nc" id="L165">        return null;</span>
    }

    @Override
    public boolean onUnbind(Intent intent) {
<span class="nc" id="L170">        return false;</span>
    }

    @Override
    public void onRebind(Intent intent) {

<span class="nc" id="L176">    }</span>

    @Override
    public void onDestroy() {
<span class="nc" id="L180">        Log.d(TAG, &quot;Destroying Service.&quot;);</span>
<span class="nc" id="L181">        mLocationHelper.unregisterListener(this);</span>
<span class="nc" id="L182">        super.onDestroy();</span>

        // Send Broadcast
<span class="nc" id="L185">        sendBroadcast();</span>
<span class="nc" id="L186">    }</span>

    /**
     * Sends broadcast so that flag of destination alert is removed from trip detail screen
     */
    private void sendBroadcast() {
<span class="nc" id="L192">        Intent intent = new Intent(TripDetailsListFragment.ACTION_SERVICE_DESTROYED);</span>
<span class="nc" id="L193">        sendBroadcast(intent);</span>
<span class="nc" id="L194">    }</span>

    @Override
    public synchronized void onLocationChanged(Location location) {
<span class="nc" id="L198">        Log.d(TAG, &quot;Location Updated&quot;);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (mLastLocation == null) {</span>
<span class="nc" id="L200">            mNavProvider.locationUpdated(location);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        } else if (!LocationUtils.isDuplicate(mLastLocation, location)) {</span>
<span class="nc" id="L202">            mNavProvider.locationUpdated(location);</span>
        }

<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (mNavProvider.mSectoCurDistance &lt;= RECORDING_THRESHOLD) {</span>
<span class="nc" id="L206">            writeToLog(location);</span>
        }
<span class="nc" id="L208">        mLastLocation = location;</span>

        // Is trip is finished? If so end service.
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (mNavProvider.getFinished()) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (mFinishedTime == 0) {</span>
<span class="nc" id="L213">                mFinishedTime = System.currentTimeMillis();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            } else if (System.currentTimeMillis() - mFinishedTime &gt;= 30000) {</span>
<span class="nc" id="L215">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_destination_reminder), getString(R.string.analytics_label_destination_reminder_variant_ended));</span>
<span class="nc" id="L216">                getUserFeedback();</span>
<span class="nc" id="L217">                stopSelf();</span>
<span class="nc" id="L218">                setupLogCleanupTask();</span>
            }
        }
<span class="nc" id="L221">    }</span>

    private void initAnonFirebaseLogin() {
<span class="nc" id="L224">        mAuth = FirebaseAuth.getInstance();</span>
<span class="nc" id="L225">        int numCores = Runtime.getRuntime().availableProcessors();</span>
<span class="nc" id="L226">        ThreadPoolExecutor executor = new ThreadPoolExecutor(numCores * 2, numCores * 2,</span>
                60L, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;Runnable&gt;());
<span class="nc" id="L228">        mAuth.signInAnonymously()</span>
<span class="nc" id="L229">                .addOnCompleteListener(executor, task -&gt; {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                    if (task.isSuccessful()) {</span>
                        // Sign in success
<span class="nc" id="L232">                        FirebaseUser user = mAuth.getCurrentUser();</span>
<span class="nc" id="L233">                        Log.d(TAG, &quot;signInAnonymously:success&quot;);</span>
<span class="nc" id="L234">                    } else {</span>
                        // Sign in failed
<span class="nc" id="L236">                        Log.w(TAG, &quot;signInAnonymously:failure&quot;, task.getException());</span>
                    }
<span class="nc" id="L238">                });</span>
<span class="nc" id="L239">    }</span>

    /**
     * Creates the log file that GPS data and navigation performance is written to - see DESTINATION_ALERTS.md
     */
    private void setupLog() {
        try {
            // Get the counter that's incremented for each test
<span class="nc" id="L247">            final String NAV_TEST_ID = getString(R.string.preference_key_nav_test_id);</span>
<span class="nc" id="L248">            int counter = Application.getPrefs().getInt(NAV_TEST_ID, 0);</span>
<span class="nc" id="L249">            counter++;</span>
<span class="nc" id="L250">            PreferenceUtils.saveInt(NAV_TEST_ID, counter);</span>

<span class="nc" id="L252">            SimpleDateFormat sdf = new SimpleDateFormat(&quot;EEE, MMM d yyyy, hh:mm aaa&quot;);</span>
<span class="nc" id="L253">            String readableDate = sdf.format(Calendar.getInstance().getTime());</span>

<span class="nc" id="L255">            File subFolder = new File(Application.get().getApplicationContext()</span>
<span class="nc" id="L256">                    .getFilesDir().getAbsolutePath() + File.separator + LOG_DIRECTORY);</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (!subFolder.exists()) {</span>
<span class="nc" id="L259">                subFolder.mkdirs();</span>
            }

<span class="nc" id="L262">            mLogFile = new File(subFolder, counter + &quot;-&quot; + readableDate + &quot;.csv&quot;);</span>

<span class="nc" id="L264">            Log.d(TAG, &quot;:&quot; + mLogFile.getAbsolutePath());</span>

<span class="nc" id="L266">            Location dest = ObaContract.Stops.getLocation(Application.get().getApplicationContext(), mDestinationStopId);</span>
<span class="nc" id="L267">            Location last = ObaContract.Stops.getLocation(Application.get().getApplicationContext(), mBeforeStopId);</span>

<span class="nc" id="L269">            String header = String.format(Locale.US, &quot;%s,%s,%f,%f,%s,%f,%f\n&quot;, mTripId, mDestinationStopId,</span>
<span class="nc" id="L270">                    dest.getLatitude(), dest.getLongitude(), mBeforeStopId, last.getLatitude(), last.getLongitude());</span>

<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (mLogFile != null) {</span>
<span class="nc" id="L273">                FileUtils.write(mLogFile, header, false);</span>
            } else {
<span class="nc" id="L275">                Log.e(TAG, &quot;Failed to write to file - null file&quot;);</span>
            }
<span class="nc" id="L277">        } catch (IOException e) {</span>
<span class="nc" id="L278">            Log.e(TAG, &quot;File write failed: &quot; + e.toString());</span>
<span class="nc" id="L279">        }</span>
<span class="nc" id="L280">    }</span>

    private void writeToLog(Location l) {
        try {
<span class="nc" id="L284">            String nanoTime = &quot;&quot;;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) {</span>
<span class="nc" id="L286">                nanoTime = Long.toString(l.getElapsedRealtimeNanos());</span>
            }

<span class="nc" id="L289">            int satellites = 0;</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">            if (l.getExtras() != null) {</span>
<span class="nc" id="L291">                satellites = l.getExtras().getInt(&quot;satellites&quot;, 0);</span>
            }

            // mGetReadyFlag =mNavProvider.getGetReady();
            //  mPullTheCordFlag = mNavProvider.getFinished();

            // TODO: Add isMockProvider
<span class="nc" id="L298">            String log = String.format(Locale.US, &quot;%d,%s,%s,%s,%d,%f,%f,%f,%f,%f,%f,%d,%s\n&quot;,</span>
<span class="nc" id="L299">                    mCoordId, mNavProvider.getGetReady(), mNavProvider.getFinished(), nanoTime, l.getTime(),</span>
<span class="nc" id="L300">                    l.getLatitude(), l.getLongitude(), l.getAltitude(), l.getSpeed(),</span>
<span class="nc" id="L301">                    l.getBearing(), l.getAccuracy(), satellites, l.getProvider());</span>


            //Increments the id for each coordinate
<span class="nc" id="L305">            mCoordId++;</span>

<span class="nc bnc" id="L307" title="All 4 branches missed.">            if (mLogFile != null &amp;&amp; mLogFile.canWrite()) {</span>
<span class="nc" id="L308">                FileUtils.write(mLogFile, log, true);</span>
            } else {
<span class="nc" id="L310">                Log.e(TAG, &quot;Failed to write to file&quot;);</span>
            }

<span class="nc" id="L313">        } catch (IOException e) {</span>
<span class="nc" id="L314">            Log.e(TAG, &quot;File write failed: &quot; + e.toString());</span>
<span class="nc" id="L315">        }</span>
<span class="nc" id="L316">    }</span>

    public void getUserFeedback() {
<span class="nc" id="L319">        Application app = Application.get();</span>
        NotificationCompat.Builder mBuilder;

<span class="nc" id="L322">        String message = Application.get().getString(R.string.feedback_notify_dialog_msg);</span>
<span class="nc" id="L323">        mFirstFeedback = Application.getPrefs().getBoolean(FIRST_FEEDBACK, true);</span>

        // Create delete intent to set flag for snackbar creation next time the app is opened.
<span class="nc" id="L326">        Intent delIntent = new Intent(app.getApplicationContext(), FeedbackReceiver.class);</span>
<span class="nc" id="L327">        delIntent.putExtra(FeedbackReceiver.NOTIFICATION_ID, mNavProvider.NOTIFICATION_ID + 1);</span>

<span class="nc bnc" id="L329" title="All 6 branches missed.">        if ((mFirstFeedback) || (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.N) || (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P)) {</span>

<span class="nc" id="L331">            Intent fdIntent = new Intent(app.getApplicationContext(), FeedbackActivity.class);</span>
<span class="nc" id="L332">            fdIntent.setAction(FeedbackReceiver.ACTION_REPLY);</span>
<span class="nc" id="L333">            fdIntent.putExtra(FeedbackActivity.RESPONSE, FeedbackActivity.FEEDBACK_NO);</span>
<span class="nc" id="L334">            fdIntent.putExtra(FeedbackActivity.NOTIFICATION_ID, mNavProvider.NOTIFICATION_ID + 1);</span>
<span class="nc" id="L335">            fdIntent.putExtra(FeedbackActivity.TRIP_ID, mTripId);</span>
<span class="nc" id="L336">            fdIntent.putExtra(FeedbackActivity.LOG_FILE, mLogFile.getAbsolutePath());</span>

            int flags;
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S) {</span>
<span class="nc" id="L340">                flags = FLAG_UPDATE_CURRENT | FLAG_MUTABLE;</span>
            } else {
<span class="nc" id="L342">                flags = FLAG_UPDATE_CURRENT;</span>
            }

            //Pending intent used to handle feedback when user taps on 'No'
<span class="nc" id="L346">            PendingIntent fdPendingIntentNo = getActivity(app.getApplicationContext()</span>
                    , 1, fdIntent, flags);

<span class="nc" id="L349">            fdIntent = new Intent(app.getApplicationContext(), FeedbackActivity.class);</span>
<span class="nc" id="L350">            fdIntent.setAction(FeedbackReceiver.ACTION_REPLY);</span>
<span class="nc" id="L351">            fdIntent.putExtra(FeedbackActivity.RESPONSE, FeedbackActivity.FEEDBACK_YES);</span>
<span class="nc" id="L352">            fdIntent.putExtra(FeedbackActivity.NOTIFICATION_ID, mNavProvider.NOTIFICATION_ID + 1);</span>
<span class="nc" id="L353">            fdIntent.putExtra(FeedbackActivity.TRIP_ID, mTripId);</span>
<span class="nc" id="L354">            fdIntent.putExtra(FeedbackActivity.LOG_FILE, mLogFile.getAbsolutePath());</span>

            //Pending intent used to handle feedback when user taps on 'Yes'
<span class="nc" id="L357">            PendingIntent fdPendingIntentYes = getActivity(app.getApplicationContext()</span>
                    , 2, fdIntent, flags);

<span class="nc" id="L360">            delIntent.setAction(FeedbackReceiver.ACTION_DISMISS_FEEDBACK);</span>
            int delFlags;
<span class="nc bnc" id="L362" title="All 2 branches missed.">            if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S) {</span>
<span class="nc" id="L363">                delFlags = FLAG_MUTABLE;</span>
            } else {
<span class="nc" id="L365">                delFlags = 0;</span>
            }
<span class="nc" id="L367">            PendingIntent pDelIntent = getBroadcast(app.getApplicationContext(),</span>
                    0, delIntent, delFlags);

<span class="nc" id="L370">            mBuilder = new NotificationCompat.Builder(Application.get().getApplicationContext()</span>
                    , Application.CHANNEL_DESTINATION_ALERT_ID)
<span class="nc" id="L372">                    .setSmallIcon(R.drawable.ic_stat_notification)</span>
<span class="nc" id="L373">                    .setContentTitle(Application.get().getResources()</span>
<span class="nc" id="L374">                            .getString(R.string.feedback_notify_title))</span>
<span class="nc" id="L375">                    .setContentText(message)</span>
<span class="nc" id="L376">                    .addAction(0, Application.get().getResources()</span>
<span class="nc" id="L377">                            .getString(R.string.feedback_action_reply_no), fdPendingIntentNo)</span>
<span class="nc" id="L378">                    .addAction(0, Application.get().getResources()</span>
<span class="nc" id="L379">                            .getString(R.string.feedback_action_reply_yes), fdPendingIntentYes)</span>
<span class="nc" id="L380">                    .setDeleteIntent(pDelIntent)</span>
<span class="nc" id="L381">                    .setAutoCancel(true);</span>
<span class="nc" id="L382">        } else {</span>

            //Intent to handle user feedback when a user taps on 'No'
<span class="nc" id="L385">            Intent intentNo = new Intent(Application.get().getApplicationContext(), FeedbackReceiver.class);</span>
<span class="nc" id="L386">            intentNo.setAction(FeedbackReceiver.ACTION_REPLY);</span>
<span class="nc" id="L387">            intentNo.putExtra(FeedbackReceiver.NOTIFICATION_ID, mNavProvider.NOTIFICATION_ID + 1);</span>
<span class="nc" id="L388">            intentNo.putExtra(FeedbackReceiver.TRIP_ID, mTripId);</span>
<span class="nc" id="L389">            intentNo.putExtra(FeedbackReceiver.RESPONSE, FeedbackReceiver.FEEDBACK_NO);</span>
<span class="nc" id="L390">            intentNo.putExtra(FeedbackReceiver.LOG_FILE, mLogFile.getAbsolutePath());</span>

            int flags;
<span class="nc bnc" id="L393" title="All 2 branches missed.">            if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S) {</span>
<span class="nc" id="L394">                flags = FLAG_MUTABLE;</span>
            } else {
<span class="nc" id="L396">                flags = 0;</span>
            }

            //PendingIntent to handle user feedback when a user taps on 'No'
<span class="nc" id="L400">            PendingIntent fdPendingIntentNo = getBroadcast(Application.get()</span>
<span class="nc" id="L401">                    .getApplicationContext(), 100, intentNo, flags);</span>

<span class="nc" id="L403">            String replyLabelNo = Application.get().getResources()</span>
<span class="nc" id="L404">                    .getString(R.string.feedback_action_reply_no);</span>

<span class="nc" id="L406">            RemoteInput remoteInput = new RemoteInput.Builder(KEY_TEXT_REPLY)</span>
<span class="nc" id="L407">                    .setLabel(replyLabelNo)</span>
<span class="nc" id="L408">                    .build();</span>

<span class="nc" id="L410">            NotificationCompat.Action replyActionNo = new NotificationCompat.Action.Builder(</span>
                    0, replyLabelNo, fdPendingIntentNo)
<span class="nc" id="L412">                    .addRemoteInput(remoteInput)</span>
<span class="nc" id="L413">                    .build();</span>

            //Intent to handle user feedback when a user taps on 'Yes'
<span class="nc" id="L416">            Intent intentYes = new Intent(Application.get().getApplicationContext(), FeedbackReceiver.class);</span>
<span class="nc" id="L417">            intentYes.setAction(FeedbackReceiver.ACTION_REPLY);</span>
<span class="nc" id="L418">            intentYes.putExtra(FeedbackReceiver.NOTIFICATION_ID, mNavProvider.NOTIFICATION_ID + 1);</span>
<span class="nc" id="L419">            intentYes.putExtra(FeedbackReceiver.TRIP_ID, mTripId);</span>
<span class="nc" id="L420">            intentYes.putExtra(FeedbackReceiver.RESPONSE, FeedbackReceiver.FEEDBACK_YES);</span>
<span class="nc" id="L421">            intentYes.putExtra(FeedbackReceiver.LOG_FILE, mLogFile.getAbsolutePath());</span>

            //PendingIntent to handle user feedback when a user taps on 'No'
<span class="nc" id="L424">            PendingIntent fdPendingIntentYes = getBroadcast(Application.get()</span>
<span class="nc" id="L425">                    .getApplicationContext(), 101, intentYes, flags);</span>

<span class="nc" id="L427">            String replyLabelYes = Application.get().getResources()</span>
<span class="nc" id="L428">                    .getString(R.string.feedback_action_reply_yes);</span>

<span class="nc" id="L430">            RemoteInput remoteInput1 = new RemoteInput.Builder(KEY_TEXT_REPLY)</span>
<span class="nc" id="L431">                    .setLabel(replyLabelYes)</span>
<span class="nc" id="L432">                    .build();</span>

<span class="nc" id="L434">            NotificationCompat.Action replyActionYes = new NotificationCompat.Action.Builder(</span>
                    0, replyLabelYes, fdPendingIntentYes)
<span class="nc" id="L436">                    .addRemoteInput(remoteInput1)</span>
<span class="nc" id="L437">                    .build();</span>

<span class="nc" id="L439">            delIntent.setAction(FeedbackReceiver.ACTION_DISMISS_FEEDBACK);</span>
<span class="nc" id="L440">            PendingIntent pDelIntent = getBroadcast(app.getApplicationContext(),</span>
                    0, delIntent, flags);

<span class="nc" id="L443">            mBuilder = new NotificationCompat.Builder(Application.get().getApplicationContext()</span>
                    , Application.CHANNEL_DESTINATION_ALERT_ID)
<span class="nc" id="L445">                    .setSmallIcon(R.drawable.ic_stat_notification)</span>
<span class="nc" id="L446">                    .setContentTitle(Application.get().getResources().getString(R.string.feedback_notify_title))</span>
<span class="nc" id="L447">                    .setContentText(message)</span>
<span class="nc" id="L448">                    .addAction(replyActionNo)</span>
<span class="nc" id="L449">                    .addAction(replyActionYes)</span>
<span class="nc" id="L450">                    .setDeleteIntent(pDelIntent)</span>
<span class="nc" id="L451">                    .setAutoCancel(true);</span>
        }

<span class="nc" id="L454">        mBuilder.setOngoing(false);</span>

        NotificationManager mNotificationManager = (NotificationManager)
<span class="nc" id="L457">                Application.get().getSystemService(Context.NOTIFICATION_SERVICE);</span>
<span class="nc" id="L458">        mNotificationManager.notify(mNavProvider.NOTIFICATION_ID + 1, mBuilder.build());</span>

<span class="nc" id="L460">    }</span>

    private void setupLogCleanupTask() {
<span class="nc" id="L463">        PeriodicWorkRequest.Builder cleanupLogsBuilder =</span>
                new PeriodicWorkRequest.Builder(NavigationCleanupWorker.class, 24,
                        TimeUnit.HOURS);

        // Create the actual work object:
<span class="nc" id="L468">        PeriodicWorkRequest cleanUpCheckWork = cleanupLogsBuilder.build();</span>

        // Then enqueue the recurring task:
<span class="nc" id="L471">        WorkManager.getInstance().enqueue(cleanUpCheckWork);</span>
<span class="nc" id="L472">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>