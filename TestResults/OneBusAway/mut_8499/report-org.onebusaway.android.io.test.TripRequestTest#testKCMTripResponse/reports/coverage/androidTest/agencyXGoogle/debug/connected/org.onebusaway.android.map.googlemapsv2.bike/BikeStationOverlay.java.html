<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BikeStationOverlay.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.map.googlemapsv2.bike</a> &gt; <span class="el_source">BikeStationOverlay.java</span></div><h1>BikeStationOverlay.java</h1><pre class="source lang-java linenums">/*
* Copyright (C) Sean J. Barbeau (sjbarbeau@gmail.com)
*
* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
* you may not use this file except in compliance with the License.
 You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
package org.onebusaway.android.map.googlemapsv2.bike;

import android.app.Activity;
import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.Canvas;
import android.graphics.drawable.Drawable;

import androidx.core.content.ContextCompat;

import com.google.android.gms.maps.GoogleMap;
import com.google.android.gms.maps.model.BitmapDescriptor;
import com.google.android.gms.maps.model.BitmapDescriptorFactory;
import com.google.android.gms.maps.model.LatLng;
import com.google.android.gms.maps.model.Marker;
import com.google.android.gms.maps.model.MarkerOptions;
import com.google.firebase.analytics.FirebaseAnalytics;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.map.googlemapsv2.BaseMapFragment;
import org.onebusaway.android.map.googlemapsv2.MapHelpV2;
import org.onebusaway.android.map.googlemapsv2.MarkerListeners;
import org.onebusaway.android.util.LayerUtils;
import org.onebusaway.android.util.RegionUtils;
import org.onebusaway.android.util.UIUtils;
import org.opentripplanner.routing.bike_rental.BikeRentalStation;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Class to hold bike stations and control their display on the map.
 */
public class BikeStationOverlay
        implements MarkerListeners,
        BikeInfoWindowAdapter.BikeStationsInfo,
        GoogleMap.OnInfoWindowClickListener {

    private GoogleMap mMap;

    private BikeStationData mBikeStationData;

    private BaseMapFragment.OnFocusChangedListener mOnFocusChangedListener;

    private BitmapDescriptor mSmallBikeStationIcon;

    private BitmapDescriptor mBigBikeStationIcon;

    private BitmapDescriptor mBigFloatingBikeIcon;

    private Context mContext;

    private FirebaseAnalytics mFirebaseAnalytics;

<span class="nc" id="L74">    private BikeInfoWindowAdapter mBikeInfoWindowAdapter = null;</span>

    /**
     * Indicates if the map is in DIRECTIONS_MODE. When in directions mode, the bike markers
     * should be displayed regardless of the bikeshare layer being active or not in the main map.
     */
<span class="nc" id="L80">    private boolean mIsInDirectionsMode = false;</span>

<span class="nc" id="L82">    public BikeStationOverlay(Activity activity, GoogleMap map, boolean isInDirectionsMode) {</span>
<span class="nc" id="L83">        mContext = activity;</span>
<span class="nc" id="L84">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(mContext);</span>
<span class="nc" id="L85">        mMap = map;</span>
<span class="nc" id="L86">        mIsInDirectionsMode = isInDirectionsMode;</span>
<span class="nc" id="L87">        mBikeStationData = new BikeStationData();</span>
<span class="nc" id="L88">        mBikeInfoWindowAdapter = new BikeInfoWindowAdapter(activity, this);</span>
<span class="nc" id="L89">        setupInfoWindow();</span>

<span class="nc" id="L91">        mSmallBikeStationIcon = BitmapDescriptorFactory.fromBitmap(createBitmapFromShape());</span>
<span class="nc" id="L92">        mBigBikeStationIcon = BitmapDescriptorFactory</span>
<span class="nc" id="L93">                .fromResource(R.drawable.bike_station_marker_big);</span>
<span class="nc" id="L94">        mBigFloatingBikeIcon = BitmapDescriptorFactory</span>
<span class="nc" id="L95">                .fromResource(R.drawable.bike_floating_marker_big);</span>
<span class="nc" id="L96">    }</span>

    private void setupInfoWindow() {
<span class="nc" id="L99">        mMap.setInfoWindowAdapter(mBikeInfoWindowAdapter);</span>
<span class="nc" id="L100">        mMap.setOnInfoWindowClickListener(this);</span>
<span class="nc" id="L101">    }</span>

    public void setOnFocusChangeListener(
            BaseMapFragment.OnFocusChangedListener onFocusChangedListener) {
<span class="nc" id="L105">        mOnFocusChangedListener = onFocusChangedListener;</span>
<span class="nc" id="L106">    }</span>


    /**
     * Add the bike stations to the map keeping the currently selected marker.
     *
     * @param bikeStations list of bikeStations to display on the map
     */
    public void addBikeStations(List&lt;BikeRentalStation&gt; bikeStations) {
<span class="nc" id="L115">        mBikeInfoWindowAdapter = new BikeInfoWindowAdapter(mContext, this);</span>

        // bike station associated with the selected marker (if any)
<span class="nc" id="L118">        BikeRentalStation selectedBikeStation = getBikeStationForSelectedMarker();</span>
<span class="nc" id="L119">        mBikeStationData.addBikeStations(bikeStations);</span>
        // show the info window again if a marker was previously selected
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (selectedBikeStation != null) {</span>
            /**
             * Add the selected marker to the map. Since the method to add the markers has already
             * been called, there is already a marker in the position. But addMarker will replace
             * it with a new one and it its info window needs to be displayed and also added as
             * selected in the bikeStationData.
             */
<span class="nc" id="L128">            Marker selectedMarker = mBikeStationData.addMarker(selectedBikeStation);</span>
<span class="nc" id="L129">            mBikeStationData.updateMarkerView(selectedMarker, selectedBikeStation,</span>
<span class="nc" id="L130">                    LayerUtils.isBikeshareLayerVisible());</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (selectedMarker != null) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                if (selectedMarker.isVisible()) {</span>
<span class="nc" id="L133">                    selectedMarker.showInfoWindow();</span>
                }
<span class="nc" id="L135">                mBikeStationData.selectMaker(selectedMarker);</span>
            }
        }
<span class="nc" id="L138">    }</span>

    /**
     * @return the bike station associated with the selected bike marker if a marker is selected
     */
    private BikeRentalStation getBikeStationForSelectedMarker() {
<span class="nc" id="L144">        Marker selectedMarker = mBikeStationData.getSelectedMarker();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (selectedMarker != null) {</span>
<span class="nc" id="L146">            return mBikeStationData.getBikeStationOnMarker(selectedMarker);</span>
        } else {
<span class="nc" id="L148">            return null;</span>
        }
    }

    public void clearBikeStations() {
<span class="nc" id="L153">        mBikeStationData.clearBikeStationMarkers();</span>
<span class="nc" id="L154">    }</span>

    @Override
    public boolean markerClicked(Marker marker) {

<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (mBikeStationData.containsMaker(marker)) {</span>
            // Set the info window adapter before showing the info window as it may have changed by
            // another overlay.
<span class="nc" id="L162">            setupInfoWindow();</span>
<span class="nc" id="L163">            BikeRentalStation bikeRentalStation = mBikeStationData.getBikeStationOnMarker(marker);</span>
<span class="nc" id="L164">            marker.showInfoWindow();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (mOnFocusChangedListener != null) {</span>
<span class="nc" id="L166">                mOnFocusChangedListener.onFocusChanged(bikeRentalStation);</span>
            }

<span class="nc" id="L169">            mBikeStationData.selectMaker(marker);</span>

<span class="nc" id="L171">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                    mContext.getString(bikeRentalStation.isFloatingBike ?</span>
<span class="nc" id="L173">                            R.string.analytics_label_bike_station_marker_clicked :</span>
<span class="nc" id="L174">                            R.string.analytics_label_floating_bike_marker_clicked),</span>
                    null);
<span class="nc" id="L176">            return true;</span>
        } else {
<span class="nc" id="L178">            mBikeStationData.removeMarkerSelection();</span>
        }
<span class="nc" id="L180">        return false;</span>
    }

    @Override
    public void removeMarkerClicked(LatLng latLng) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (mOnFocusChangedListener != null) {</span>
<span class="nc" id="L186">            mOnFocusChangedListener.onFocusChanged(null);</span>
        }
<span class="nc" id="L188">        mBikeStationData.removeMarkerSelection();</span>
<span class="nc" id="L189">    }</span>

    private Bitmap createBitmapFromShape() {
<span class="nc" id="L192">        int px = Application.get().getResources()</span>
<span class="nc" id="L193">                .getDimensionPixelSize(R.dimen.bikeshare_small_marker_size);</span>

<span class="nc" id="L195">        Bitmap bitmap = Bitmap.createBitmap(px, px, Bitmap.Config.ARGB_8888);</span>

<span class="nc" id="L197">        Canvas c = new Canvas(bitmap);</span>
<span class="nc" id="L198">        Drawable shape = ContextCompat.getDrawable(Application.get(), R.drawable.bike_marker_small);</span>
<span class="nc" id="L199">        shape.setBounds(0, 0, bitmap.getWidth(), bitmap.getHeight());</span>
<span class="nc" id="L200">        shape.draw(c);</span>

<span class="nc" id="L202">        return bitmap;</span>
    }

    @Override
    public BikeRentalStation getBikeStationOnMarker(Marker marker) {
<span class="nc" id="L207">        return mBikeStationData.getBikeStationOnMarker(marker);</span>
    }

    @Override
    public void onInfoWindowClick(Marker marker) {
        // Proof of concept for deep-linking integration hard-coded for Tampa region (id = 0)
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (Application.get().getCurrentRegion() != null</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                &amp;&amp; Application.get().getCurrentRegion().getId() == RegionUtils.TAMPA_REGION_ID) {</span>
<span class="nc" id="L215">            BikeRentalStation bikeStation = mBikeStationData.getBikeStationOnMarker(marker);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">            if (bikeStation != null) {</span>
<span class="nc" id="L217">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                        mContext.getString(bikeStation.isFloatingBike ?</span>
<span class="nc" id="L219">                                R.string.analytics_label_bike_station_balloon_clicked :</span>
<span class="nc" id="L220">                                R.string.analytics_label_floating_bike_balloon_clicked),</span>
                        null);

<span class="nc" id="L223">                UIUtils.launchTampaHoprApp(mContext);</span>
            }
        }
<span class="nc" id="L226">    }</span>

    private class BikeStationData {

        /*
        Store the current map zoom level to detect zoom level band changes. The bands are used to
        show bike markers in different formats. Currently there are three bands:
        . &lt;= 12
        . 12 to 15
        . &gt; 15
         */
<span class="nc" id="L237">        private float mCurrentMapZoomLevel = 0;</span>

        // Limit of bike markers to keep on memory to avoid markers to flick on screen
        private static final int FUZZY_MAX_MARKER_COUNT = 200;

        // Store the selected marker in order to continue displaying the info window when markers
        // are added/ removed from map
<span class="nc" id="L244">        private Marker mSelectedMarker = null;</span>

        // Keep track of markers displayed on map and associated BikeRentalStation
        private HashMap&lt;Marker, BikeRentalStation&gt; mMarkers;

        // Keep track of existing bike stations displayed on the map. This is used to verify if a
        // bike station is already on the map
        private List&lt;String&gt; mBikeStationKeys;

<span class="nc" id="L253">        public BikeStationData() {</span>
<span class="nc" id="L254">            mMarkers = new HashMap&lt;&gt;();</span>
<span class="nc" id="L255">            mBikeStationKeys = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L256">        }</span>

        public synchronized void addBikeStations(List&lt;BikeRentalStation&gt; bikeStations) {
            // Clear cache of markers if maximum number has been reached
<span class="nc bnc" id="L260" title="All 2 branches missed.">            if (mMarkers.size() &gt; FUZZY_MAX_MARKER_COUNT) {</span>
<span class="nc" id="L261">                clearBikeStationMarkers();</span>
            }
<span class="nc bnc" id="L263" title="All 4 branches missed.">            boolean showBikeMarkers = mIsInDirectionsMode || LayerUtils.isBikeshareLayerVisible();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (hasZoomLevelChangedBands()) {</span>
                // Update existing markers according to new zoom band and bike station type
<span class="nc bnc" id="L266" title="All 2 branches missed.">                for (Map.Entry&lt;Marker, BikeRentalStation&gt; entry : mMarkers.entrySet()) {</span>
<span class="nc" id="L267">                    updateMarkerView(entry.getKey(), entry.getValue(), showBikeMarkers);</span>
<span class="nc" id="L268">                }</span>
            }
            // Add markers for the bike stations that are not already visible on the map
<span class="nc bnc" id="L271" title="All 2 branches missed.">            for (BikeRentalStation bikeStation : bikeStations) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                if (!mBikeStationKeys.contains(bikeStation.id)) {</span>
<span class="nc" id="L273">                    Marker marker = addMarker(bikeStation);</span>
<span class="nc" id="L274">                    updateMarkerView(marker, bikeStation, showBikeMarkers);</span>
                }
<span class="nc" id="L276">            }</span>
            // Store the new zoom level in order to detect when the zoom level bands change
<span class="nc" id="L278">            mCurrentMapZoomLevel = mMap.getCameraPosition().zoom;</span>
<span class="nc" id="L279">        }</span>

        // Detect map zoom level changes between bands &lt;= 12 | 12 - 15 | &gt; 15
        private boolean hasZoomLevelChangedBands() {
<span class="nc bnc" id="L283" title="All 6 branches missed.">            return (mCurrentMapZoomLevel &lt;= 12 &amp;&amp; mMap.getCameraPosition().zoom &gt; 12) ||</span>
<span class="nc bnc" id="L284" title="All 6 branches missed.">                    (mCurrentMapZoomLevel &gt; 15 &amp;&amp; mMap.getCameraPosition().zoom &lt;= 15) ||</span>
                    (mCurrentMapZoomLevel &gt; 12 &amp;&amp; mCurrentMapZoomLevel &lt;= 15 &amp;&amp;
<span class="nc bnc" id="L286" title="All 2 branches missed.">                            (mMap.getCameraPosition().zoom &lt;= 12</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                                    || mMap.getCameraPosition().zoom &gt; 15));</span>
        }

        /**
         * Add a marker on the map for a bike staton. The default marker is added. The method
         * updateMarkerView needs to be called to update it's appearance.
         *
         * @param bikeStation bike station to be added to the map
         */
        private synchronized Marker addMarker(BikeRentalStation bikeStation) {
<span class="nc" id="L297">            MarkerOptions options = new MarkerOptions()</span>
<span class="nc" id="L298">                    .position(MapHelpV2.makeLatLng(bikeStation.y, bikeStation.x));</span>
<span class="nc" id="L299">            Marker m = mMap.addMarker(options);</span>
<span class="nc" id="L300">            mMarkers.put(m, bikeStation);</span>
<span class="nc" id="L301">            mBikeStationKeys.add(bikeStation.id);</span>
<span class="nc" id="L302">            return m;</span>
        }

        /**
         * Change marker appearance according to the zoom level and type of bike station is
         * represents
         *
         * @param marker         the marker to update its display
         * @param station        the bike station/floating bike associated with the marker
         * @param showBikeMarker used to control if the marker should be displayed or not. Included
         *                       to control bike markers display when the layer is deactivated
         *                       while the bike data was loading (it was deactivated between the
         *                       request has been sent to the server and the results have arrived)
         */
        private synchronized void updateMarkerView(Marker marker, BikeRentalStation station,
                boolean showBikeMarker) {
<span class="nc bnc" id="L318" title="All 4 branches missed.">            if (mMap.getCameraPosition().zoom &gt; 12 &amp;&amp; showBikeMarker) {</span>
<span class="nc" id="L319">                marker.setVisible(true);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                if (mMap.getCameraPosition().zoom &gt; 15) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                    if (station.isFloatingBike) {</span>
<span class="nc" id="L322">                        marker.setIcon(mBigFloatingBikeIcon);</span>
                    } else {
<span class="nc" id="L324">                        marker.setIcon(mBigBikeStationIcon);</span>
                    }
                } else {
<span class="nc" id="L327">                    marker.setIcon(mSmallBikeStationIcon);</span>
                }
            } else {
<span class="nc" id="L330">                marker.setVisible(false);</span>
            }
<span class="nc" id="L332">        }</span>

        /**
         * Remove all bike markers from map and clear the list of markers in memory.
         */
        private synchronized void clearBikeStationMarkers() {
<span class="nc bnc" id="L338" title="All 2 branches missed.">            for (Marker marker : mMarkers.keySet()) {</span>
<span class="nc" id="L339">                marker.remove();</span>
<span class="nc" id="L340">            }</span>
<span class="nc" id="L341">            mMarkers.clear();</span>
<span class="nc" id="L342">            mBikeStationKeys.clear();</span>
<span class="nc" id="L343">        }</span>

        public BikeRentalStation getBikeStationOnMarker(Marker marker) {
<span class="nc" id="L346">            return mMarkers.get(marker);</span>
        }

        public boolean containsMaker(Marker marker) {
<span class="nc" id="L350">            return mMarkers.containsKey(marker);</span>
        }

        public void selectMaker(Marker marker) {
<span class="nc" id="L354">            mSelectedMarker = marker;</span>
<span class="nc" id="L355">        }</span>

        public void removeMarkerSelection() {
<span class="nc" id="L358">            mSelectedMarker = null;</span>
<span class="nc" id="L359">        }</span>

        public Marker getSelectedMarker() {
<span class="nc" id="L362">            return mSelectedMarker;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>