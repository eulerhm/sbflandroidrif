<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TripRequest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.directions.tasks</a> &gt; <span class="el_source">TripRequest.java</span></div><h1>TripRequest.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2011 Marcy Gordon
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package org.onebusaway.android.directions.tasks;

import android.os.AsyncTask;
import android.util.Log;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.directions.util.JacksonConfig;
import org.opentripplanner.api.model.TripPlan;
import org.opentripplanner.api.ws.Message;
import org.opentripplanner.api.ws.Request;
import org.opentripplanner.api.ws.Response;
import org.opentripplanner.routing.core.TraverseMode;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

public class TripRequest extends AsyncTask&lt;Request, Integer, Long&gt; {

    public interface Callback {

        void onTripRequestComplete(TripPlan tripPlan, String url);

        void onTripRequestFailure(int errorCode, String url);
    }

<span class="nc" id="L45">    public static int NO_SERVER_SELECTED = 1000;</span>

    // Constants that are defined in OTPApp in CUTR OTP Android app
    private static final String TAG = &quot;TripRequest&quot;;

    private static final String FOLDER_STRUCTURE_PREFIX_NEW = &quot;/routers/default&quot;;

    public static final String OTP_RENTAL_QUALIFIER = &quot;_RENT&quot;;

    public static final String PLAN_LOCATION = &quot;/plan&quot;;

    public static final int HTTP_CONNECTION_TIMEOUT = 15000;

    public static final int HTTP_SOCKET_TIMEOUT = 15000;

    private Response mResponse;

    private String mBaseUrl;

    private String mRequestUrl;

    private Callback mCallback;

    // change Server object to baseUrl string.
<span class="nc" id="L69">    public TripRequest(String baseUrl, Callback callback) {</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5260)) {</span>
<span class="nc" id="L71">            mBaseUrl = baseUrl;</span>
        }
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5261)) {</span>
<span class="nc" id="L74">            mCallback = callback;</span>
        }
<span class="nc" id="L76">    }</span>

    /**
     * Show the progress dialog for this request. Called when request starts, or by caller activity
     * (i.e., in onCreate() after a rotation)
     * @param reqs
     * @return
     */
    protected Long doInBackground(Request... reqs) {
<span class="nc" id="L85">        long totalSize = 0;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5265)) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (mBaseUrl == null) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5264)) {</span>
<span class="nc" id="L89">                    mCallback.onTripRequestFailure(NO_SERVER_SELECTED, null);</span>
                }
<span class="nc" id="L91">                return null;</span>
            } else {
<span class="nc" id="L93">                String prefix = FOLDER_STRUCTURE_PREFIX_NEW;</span>
<span class="nc" id="L94">                boolean useOldUrlVersion = Application.get().getUseOldOtpApiUrlVersion();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5263)) {</span>
                    {
<span class="nc" id="L97">                        long _loopCounter44 = 0;</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                        for (Request req : reqs) {</span>
<span class="nc" id="L99">                            ListenerUtil.loopListener.listen(&quot;_loopCounter44&quot;, ++_loopCounter44);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(5262)) {</span>
<span class="nc" id="L101">                                mResponse = requestPlan(req, prefix, mBaseUrl, useOldUrlVersion);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L108">        return totalSize;</span>
    }

    protected void onCancelled(Long result) {
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5266)) {</span>
<span class="nc" id="L113">            mCallback.onTripRequestFailure(Message.REQUEST_TIMEOUT.getId(), mRequestUrl);</span>
        }
<span class="nc" id="L115">    }</span>

    protected void onPostExecute(Long result) {
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5267)) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (result == null) {</span>
<span class="nc" id="L120">                return;</span>
            }
        }
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5276)) {</span>
<span class="nc bnc" id="L124" title="All 26 branches missed.">            if ((ListenerUtil.mutListener.listen(5269) ? ((ListenerUtil.mutListener.listen(5268) ? (mResponse != null || mResponse.getPlan() != null) : (mResponse != null &amp;&amp; mResponse.getPlan() != null)) || mResponse.getPlan().getItinerary().get(0) != null) : ((ListenerUtil.mutListener.listen(5268) ? (mResponse != null || mResponse.getPlan() != null) : (mResponse != null &amp;&amp; mResponse.getPlan() != null)) &amp;&amp; mResponse.getPlan().getItinerary().get(0) != null))) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5275)) {</span>
<span class="nc" id="L126">                    mCallback.onTripRequestComplete(mResponse.getPlan(), mRequestUrl);</span>
                }
            } else {
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5270)) {</span>
<span class="nc" id="L130">                    Log.e(TAG, &quot;Error retrieving routing from OTP server: &quot; + mResponse);</span>
                }
<span class="nc" id="L132">                int errorCode = -1;</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5273)) {</span>
<span class="nc bnc" id="L134" title="All 10 branches missed.">                    if ((ListenerUtil.mutListener.listen(5271) ? (mResponse != null || mResponse.getError() != null) : (mResponse != null &amp;&amp; mResponse.getError() != null))) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5272)) {</span>
<span class="nc" id="L136">                            errorCode = mResponse.getError().getId();</span>
                        }
                    }
                }
<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5274)) {</span>
<span class="nc" id="L141">                    mCallback.onTripRequestFailure(errorCode, mRequestUrl);</span>
                }
            }
        }
<span class="nc" id="L145">    }</span>

    protected Response requestPlan(Request requestParams, String prefix, String baseURL, boolean useOldUrlStructure) {
<span class="nc" id="L148">        HashMap&lt;String, String&gt; tmp = requestParams.getParameters();</span>
<span class="nc" id="L149">        Collection c = tmp.entrySet();</span>
<span class="nc" id="L150">        Iterator itr = c.iterator();</span>
<span class="nc" id="L151">        String params = &quot;&quot;;</span>
<span class="nc" id="L152">        boolean first = true;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5281)) {</span>
            {
<span class="nc" id="L155">                long _loopCounter45 = 0;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                while (itr.hasNext()) {</span>
<span class="nc" id="L157">                    ListenerUtil.loopListener.listen(&quot;_loopCounter45&quot;, ++_loopCounter45);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5280)) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                        if (first) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(5278)) {</span>
<span class="nc" id="L161">                                params += &quot;?&quot; + itr.next();</span>
                            }
<span class="nc bnc" id="L163" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(5279)) {</span>
<span class="nc" id="L164">                                first = false;</span>
                            }
                        } else {
<span class="nc bnc" id="L167" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(5277)) {</span>
<span class="nc" id="L168">                                params += &quot;&amp;&quot; + itr.next();</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5283)) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (requestParams.getBikeRental()) {</span>
                String updatedString;
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if (prefix.equals(FOLDER_STRUCTURE_PREFIX_NEW)) {</span>
<span class="nc" id="L179">                    updatedString = params.replace(TraverseMode.BICYCLE.toString(), TraverseMode.BICYCLE.toString() + OTP_RENTAL_QUALIFIER);</span>
                } else {
<span class="nc" id="L181">                    updatedString = params.replace(TraverseMode.BICYCLE.toString(), TraverseMode.BICYCLE.toString() + &quot;, &quot; + TraverseMode.WALK.toString());</span>
                }
<span class="nc bnc" id="L183" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5282)) {</span>
<span class="nc" id="L184">                    params = updatedString;</span>
                }
            }
        }
        String u;
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (!useOldUrlStructure) {</span>
<span class="nc" id="L190">            u = baseURL + prefix + PLAN_LOCATION + params;</span>
        } else {
<span class="nc" id="L192">            u = baseURL + PLAN_LOCATION + params;</span>
        }
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5284)) {</span>
            // Save url for error reporting purposes
<span class="nc" id="L196">            mRequestUrl = u;</span>
        }
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5285)) {</span>
<span class="nc" id="L199">            Log.d(TAG, &quot;URL: &quot; + u);</span>
        }
<span class="nc" id="L201">        HttpURLConnection urlConnection = null;</span>
        URL url;
<span class="nc" id="L203">        Response plan = null;</span>
        try {
<span class="nc" id="L205">            url = new URL(u);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5301)) {</span>
<span class="nc" id="L207">                urlConnection = (HttpURLConnection) url.openConnection();</span>
            }
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5302)) {</span>
<span class="nc" id="L210">                urlConnection.setConnectTimeout(HTTP_CONNECTION_TIMEOUT);</span>
            }
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5303)) {</span>
<span class="nc" id="L213">                urlConnection.setReadTimeout(HTTP_SOCKET_TIMEOUT);</span>
            }
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5304)) {</span>
<span class="nc" id="L216">                plan = JacksonConfig.getObjectReaderInstance().readValue(urlConnection.getInputStream());</span>
            }
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5306)) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                if (useOldUrlStructure) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5305)) {</span>
                        // If the old url structure is successful then cache it
<span class="nc" id="L222">                        Application.get().setUseOldOtpApiUrlVersion(true);</span>
                    }
                }
            }
<span class="nc" id="L226">        } catch (java.net.SocketTimeoutException e) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5286)) {</span>
<span class="nc" id="L228">                Log.e(TAG, &quot;Timeout fetching JSON or XML: &quot; + e);</span>
            }
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5287)) {</span>
<span class="nc" id="L231">                e.printStackTrace();</span>
            }
<span class="nc bnc" id="L233" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5288)) {</span>
<span class="nc" id="L234">                cancel(true);</span>
            }
<span class="nc" id="L236">        } catch (FileNotFoundException e) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5295)) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (!useOldUrlStructure) {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5292)) {</span>
<span class="nc" id="L240">                        Log.v(TAG, &quot;The OTP url might be old, trying  old url structure&quot;);</span>
                    }
<span class="nc bnc" id="L242" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5294)) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                        if (urlConnection != null) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(5293)) {</span>
<span class="nc" id="L245">                                urlConnection.disconnect();</span>
                            }
                        }
                    }
<span class="nc" id="L249">                    return requestPlan(requestParams, prefix, baseURL, true);</span>
                } else {
<span class="nc bnc" id="L251" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5289)) {</span>
<span class="nc" id="L252">                        Log.e(TAG, &quot;Error fetching JSON or XML: &quot; + e);</span>
                    }
<span class="nc bnc" id="L254" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5290)) {</span>
<span class="nc" id="L255">                        e.printStackTrace();</span>
                    }
<span class="nc bnc" id="L257" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5291)) {</span>
<span class="nc" id="L258">                        cancel(true);</span>
                    }
                }
            }
<span class="nc" id="L262">        } catch (IOException e) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5296)) {</span>
<span class="nc" id="L264">                Log.e(TAG, &quot;Error fetching JSON or XML: &quot; + e);</span>
            }
<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5297)) {</span>
<span class="nc" id="L267">                e.printStackTrace();</span>
            }
<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5298)) {</span>
<span class="nc" id="L270">                cancel(true);</span>
            }
        } finally {
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5300)) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                if (urlConnection != null) {</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5299)) {</span>
<span class="nc" id="L276">                        urlConnection.disconnect();</span>
                    }
                }
            }
        }
<span class="nc" id="L281">        return plan;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>