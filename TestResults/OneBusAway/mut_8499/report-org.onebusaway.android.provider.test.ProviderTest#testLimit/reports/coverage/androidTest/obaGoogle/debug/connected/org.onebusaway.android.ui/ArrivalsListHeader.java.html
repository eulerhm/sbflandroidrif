<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArrivalsListHeader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">ArrivalsListHeader.java</span></div><h1>ArrivalsListHeader.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011-2017 Paul Watts (paulcwatts@gmail.com),
 * University of South Florida (sjbarbeau@gmail.com),
 * Microsoft Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import android.annotation.TargetApi;
import android.content.ContentQueryMap;
import android.content.ContentValues;
import android.content.Context;
import android.content.Intent;
import android.content.res.Resources;
import android.graphics.Paint;
import android.graphics.drawable.ColorDrawable;
import android.graphics.drawable.GradientDrawable;
import android.location.Location;
import android.net.Uri;
import android.os.Build;
import android.text.TextUtils;
import android.text.format.DateUtils;
import android.text.style.ClickableSpan;
import android.util.Log;
import android.view.KeyEvent;
import android.view.LayoutInflater;
import android.view.MotionEvent;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.Animation;
import android.view.animation.RotateAnimation;
import android.view.inputmethod.EditorInfo;
import android.widget.EditText;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.PopupWindow;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TableLayout;
import android.widget.TextView;

import androidx.fragment.app.FragmentManager;

import com.google.firebase.analytics.FirebaseAnalytics;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.elements.ObaArrivalInfo;
import org.onebusaway.android.io.elements.ObaRegion;
import org.onebusaway.android.io.elements.Status;
import org.onebusaway.android.provider.ObaContract;
import org.onebusaway.android.util.ArrivalInfoUtils;
import org.onebusaway.android.util.UIUtils;

import java.util.ArrayList;
import java.util.List;

//
// A helper class that gets most of the header interaction
// out of the Fragment itself.
//
class ArrivalsListHeader {

    interface Controller {
        Location getStopLocation();

        String getStopName();

        String getStopDirection();

        String getUserStopName();

        String getStopId();

        void setUserStopName(String userName);

        long getLastGoodResponseTime();

        // Returns a sorted list (by ETA) of arrival times for the current stop
        ArrayList&lt;ArrivalInfo&gt; getArrivalInfo();

        ArrayList&lt;String&gt; getRoutesFilter();

        void setRoutesFilter(ArrayList&lt;String&gt; filter);

        int getNumRoutes();

        boolean isFavoriteStop();

        boolean setFavoriteStop(boolean favorite);

        AlertList getAlertList();

        List&lt;String&gt; getRouteDisplayNames();

        /**
         * Gets the range of arrival info (i.e., arrival info for the next &quot;minutesAfter&quot; minutes),
         * or -1 if this information isn't available
         *
         * @return minutesAfter the range of arrival info (i.e., arrival info for the next
         * &quot;minutesAfter&quot; minutes), or -1 if this information isn't available
         */
        int getMinutesAfter();

        /**
         * Shows the list item menu for the given view and arrival info
         *
         * @param v    view for the container of the arrival info
         * @param stop arrival info to show a list for
         */
        void showListItemMenu(View v, final ArrivalInfo stop);

        /**
         * Triggers a local refresh of the controller content (i.e., does not trigger another
         * call to the server)
         */
        void refreshLocal();

        /**
         * Triggers a full refresh of arrivals from the OBA server
         */
        void refresh();
    }

    private static final String TAG = &quot;ArrivalsListHeader&quot;;

    private Controller mController;

    private Context mContext;

    private Resources mResources;

    private FragmentManager mFragmentManager;

    //
    // Cached views
    //
    private View mView;  // Entire header parent view

    private View mMainContainerView; // Holds everything except for the mFilterGroup

    private View mNameContainerView;

    private View mEditNameContainerView;

    private TextView mNameView;

    private TextView mDirectionView;

    private EditText mEditNameView;

    private ImageButton mStopFavorite;

    private View mFilterGroup;

    private TextView mShowAllView;

    private ClickableSpan mShowAllClick;

<span class="nc" id="L172">    private boolean mInNameEdit = false;</span>

    // Default state for the header is inside a sliding fragment
<span class="nc" id="L175">    private boolean mIsSlidingPanelCollapsed = true;</span>

    private int mShortAnimationDuration;

    private ProgressBar mProgressBar;

    private ImageButton mStopInfo;

    private ImageView mExpandCollapse;

    /**
     * Variables used to show/hide alerts in the header
     */
    private ImageView mAlertView;

<span class="nc" id="L190">    boolean mHasWarning = false;</span>

<span class="nc" id="L192">    boolean mHasError = false;</span>

<span class="nc" id="L194">    boolean mIsAlertHidden = false;</span>

    // All arrival info returned by the adapter
    private ArrayList&lt;ArrivalInfo&gt; mArrivalInfo;

    // Arrival info for the two rows of arrival info in the header
<span class="nc" id="L200">    private ArrayList&lt;ArrivalInfo&gt; mHeaderArrivalInfo = new ArrayList&lt;&gt;(2);</span>

    // Trip (e.g., reminder) content for this stop
    protected ContentQueryMap mTripsForStop;

    /**
     * Views to show ETA information in header
     */

<span class="nc" id="L209">    private boolean mShowArrivals = true;  // Allows external classes to show/hide arrivals</span>

    // Number of arrival current shown in the header - needed for various header view sizing.
<span class="nc" id="L212">    int mNumHeaderArrivals = -1;  // -1 if mArrivalInfo hasn't been refreshed</span>

    private TextView mNoArrivals;

<span class="nc" id="L216">    private final float ETA_TEXT_SIZE_SP = 30;</span>

<span class="nc" id="L218">    private final float ETA_TEXT_NOW_SIZE_SP = 28;</span>

    // Row 1
    private View mEtaContainer1;

    private ImageButton mEtaRouteFavorite1;

    private ImageButton mEtaReminder1;

    private TextView mEtaRouteName1;

    private TextView mEtaRouteDirection1;

    private RelativeLayout mEtaAndMin1;

    private TextView mEtaArrivalInfo1;

    private TextView mEtaMin1;

    private ViewGroup mEtaRealtime1;

    private ImageButton mEtaMoreVert1;

    private PopupWindow mPopup1;

    private View mEtaSeparator;

    // Row 2
    private View mEtaContainer2;

    private ImageButton mEtaRouteFavorite2;

    private ImageButton mEtaReminder2;

    private TextView mEtaRouteName2;

    private TextView mEtaRouteDirection2;

    private RelativeLayout mEtaAndMin2;

    private TextView mEtaArrivalInfo2;

    private TextView mEtaMin2;

    private ViewGroup mEtaRealtime2;

    private ImageButton mEtaMoreVert2;

    private PopupWindow mPopup2;

    // Animations
    private static final float ANIM_PIVOT_VALUE = 0.5f;  // 50%

    private static final float ANIM_STATE_NORMAL = 0.0f;  // 0 degrees (no rotation)

    private static final float ANIM_STATE_INVERTED = 180.0f;  // 180 degrees

    private static final long ANIM_DURATION = 300;  // milliseconds

    // Manages header size in &quot;stop name edit mode&quot;
    private int cachedExpandCollapseViewVisibility;

    private static float HEADER_HEIGHT_NO_ARRIVALS_DP;

    private static float HEADER_HEIGHT_ONE_ARRIVAL_DP;

    private static float HEADER_HEIGHT_TWO_ARRIVALS_DP;

    private static float HEADER_HEIGHT_EDIT_NAME_DP;

    private static float HEADER_OFFSET_FILTER_ROUTES_DP;

    // Controller to change parent sliding panel
    HomeActivity.SlidingPanelController mSlidingPanelController;

    private FirebaseAnalytics mFirebaseAnalytics;

<span class="nc" id="L295">    ArrivalsListHeader(Context context, Controller controller, FragmentManager fm) {</span>
<span class="nc" id="L296">        mController = controller;</span>
<span class="nc" id="L297">        mContext = context;</span>
<span class="nc" id="L298">        mResources = context.getResources();</span>
<span class="nc" id="L299">        mFragmentManager = fm;</span>
<span class="nc" id="L300">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(context);</span>

        // Retrieve and cache the system's default &quot;short&quot; animation time.
<span class="nc" id="L303">        mShortAnimationDuration = mResources.getInteger(</span>
                android.R.integer.config_shortAnimTime);
<span class="nc" id="L305">    }</span>

    void initView(View view) {
        // Clear any existing arrival info
<span class="nc" id="L309">        mArrivalInfo = null;</span>
<span class="nc" id="L310">        mHeaderArrivalInfo.clear();</span>
<span class="nc" id="L311">        mNumHeaderArrivals = -1;</span>

        // Cache the ArrivalsListHeader height values
<span class="nc" id="L314">        HEADER_HEIGHT_NO_ARRIVALS_DP =</span>
<span class="nc" id="L315">                view.getResources().getDimension(R.dimen.arrival_header_height_no_arrivals)</span>
<span class="nc" id="L316">                        / view.getResources().getDisplayMetrics().density;</span>
<span class="nc" id="L317">        HEADER_HEIGHT_ONE_ARRIVAL_DP =</span>
<span class="nc" id="L318">                view.getResources().getDimension(R.dimen.arrival_header_height_one_arrival)</span>
<span class="nc" id="L319">                / view.getResources().getDisplayMetrics().density;</span>
<span class="nc" id="L320">        HEADER_HEIGHT_TWO_ARRIVALS_DP =</span>
<span class="nc" id="L321">                view.getResources().getDimension(R.dimen.arrival_header_height_two_arrivals)</span>
<span class="nc" id="L322">                        / view.getResources().getDisplayMetrics().density;</span>
<span class="nc" id="L323">        HEADER_OFFSET_FILTER_ROUTES_DP = view.getResources()</span>
<span class="nc" id="L324">                .getDimension(R.dimen.arrival_header_height_offset_filter_routes)</span>
<span class="nc" id="L325">                / view.getResources().getDisplayMetrics().density;</span>
<span class="nc" id="L326">        HEADER_HEIGHT_EDIT_NAME_DP =</span>
<span class="nc" id="L327">                view.getResources().getDimension(R.dimen.arrival_header_height_edit_name)</span>
<span class="nc" id="L328">                        / view.getResources().getDisplayMetrics().density;</span>

        // Init views
<span class="nc" id="L331">        mView = view;</span>
<span class="nc" id="L332">        mMainContainerView = mView.findViewById(R.id.main_header_content);</span>
<span class="nc" id="L333">        mNameContainerView = mView.findViewById(R.id.stop_name_and_info_container);</span>
<span class="nc" id="L334">        mEditNameContainerView = mView.findViewById(R.id.edit_name_container);</span>
<span class="nc" id="L335">        mNameView = (TextView) mView.findViewById(R.id.stop_name);</span>
<span class="nc" id="L336">        mDirectionView = (TextView) mView.findViewById(R.id.stop_direction);</span>
<span class="nc" id="L337">        mEditNameView = (EditText) mView.findViewById(R.id.edit_name);</span>
<span class="nc" id="L338">        mStopFavorite = (ImageButton) mView.findViewById(R.id.stop_favorite);</span>
<span class="nc" id="L339">        mStopFavorite.setColorFilter(mView.getResources().getColor(R.color.header_text_color));</span>

<span class="nc" id="L341">        mFilterGroup = mView.findViewById(R.id.filter_group);</span>

<span class="nc" id="L343">        mShowAllView = (TextView) mView.findViewById(R.id.show_all);</span>
        // Remove any previous clickable spans - we're recycling views between fragments for efficiency
<span class="nc" id="L345">        UIUtils.removeAllClickableSpans(mShowAllView);</span>
<span class="nc" id="L346">        mShowAllClick = new ClickableSpan() {</span>
            public void onClick(View v) {
<span class="nc" id="L348">                mController.setRoutesFilter(new ArrayList&lt;String&gt;());</span>
<span class="nc" id="L349">            }</span>
        };
<span class="nc" id="L351">        UIUtils.setClickableSpan(mShowAllView, mShowAllClick);</span>

<span class="nc" id="L353">        mNoArrivals = (TextView) mView.findViewById(R.id.no_arrivals);</span>

        // First ETA row
<span class="nc" id="L356">        mEtaContainer1 = mView.findViewById(R.id.eta_container1);</span>
<span class="nc" id="L357">        mEtaRouteFavorite1 = (ImageButton) mEtaContainer1.findViewById(R.id.eta_route_favorite);</span>
<span class="nc" id="L358">        mEtaRouteFavorite1.setColorFilter(mView.getResources().getColor(R.color.header_text_color));</span>
<span class="nc" id="L359">        mEtaReminder1 = (ImageButton) mEtaContainer1.findViewById(R.id.reminder);</span>
<span class="nc" id="L360">        mEtaReminder1.setColorFilter(mView.getResources().getColor(R.color.header_text_color));</span>
<span class="nc" id="L361">        mEtaRouteName1 = (TextView) mEtaContainer1.findViewById(R.id.eta_route_name);</span>
<span class="nc" id="L362">        mEtaRouteDirection1 = (TextView) mEtaContainer1.findViewById(R.id.eta_route_direction);</span>
<span class="nc" id="L363">        mEtaAndMin1 = (RelativeLayout) mEtaContainer1.findViewById(R.id.eta_and_min);</span>
<span class="nc" id="L364">        mEtaArrivalInfo1 = (TextView) mEtaContainer1.findViewById(R.id.eta);</span>
<span class="nc" id="L365">        mEtaMin1 = (TextView) mEtaContainer1.findViewById(R.id.eta_min);</span>
<span class="nc" id="L366">        mEtaRealtime1 = (ViewGroup) mEtaContainer1.findViewById(R.id.eta_realtime_indicator);</span>
<span class="nc" id="L367">        mEtaMoreVert1 = (ImageButton) mEtaContainer1.findViewById(R.id.eta_more_vert);</span>
<span class="nc" id="L368">        mEtaMoreVert1.setColorFilter(mView.getResources().getColor(R.color.header_text_color));</span>

<span class="nc" id="L370">        mEtaSeparator = mView.findViewById(R.id.eta_separator);</span>

        // Second ETA row
<span class="nc" id="L373">        mEtaContainer2 = mView.findViewById(R.id.eta_container2);</span>
<span class="nc" id="L374">        mEtaRouteFavorite2 = (ImageButton) mEtaContainer2.findViewById(R.id.eta_route_favorite);</span>
<span class="nc" id="L375">        mEtaRouteFavorite2.setColorFilter(mView.getResources().getColor(R.color.header_text_color));</span>
<span class="nc" id="L376">        mEtaReminder2 = (ImageButton) mEtaContainer2.findViewById(R.id.reminder);</span>
<span class="nc" id="L377">        mEtaReminder2.setColorFilter(mView.getResources().getColor(R.color.header_text_color));</span>
<span class="nc" id="L378">        mEtaRouteName2 = (TextView) mEtaContainer2.findViewById(R.id.eta_route_name);</span>
<span class="nc" id="L379">        mEtaAndMin2 = (RelativeLayout) mEtaContainer2.findViewById(R.id.eta_and_min);</span>
<span class="nc" id="L380">        mEtaRouteDirection2 = (TextView) mEtaContainer2.findViewById(R.id.eta_route_direction);</span>
<span class="nc" id="L381">        mEtaArrivalInfo2 = (TextView) mEtaContainer2.findViewById(R.id.eta);</span>
<span class="nc" id="L382">        mEtaMin2 = (TextView) mEtaContainer2.findViewById(R.id.eta_min);</span>
<span class="nc" id="L383">        mEtaRealtime2 = (ViewGroup) mEtaContainer2.findViewById(R.id.eta_realtime_indicator);</span>
<span class="nc" id="L384">        mEtaMoreVert2 = (ImageButton) mEtaContainer2.findViewById(R.id.eta_more_vert);</span>
<span class="nc" id="L385">        mEtaMoreVert2.setColorFilter(mView.getResources().getColor(R.color.header_text_color));</span>

<span class="nc" id="L387">        mProgressBar = (ProgressBar) mView.findViewById(R.id.header_loading_spinner);</span>
<span class="nc" id="L388">        mStopInfo = (ImageButton) mView.findViewById(R.id.stop_info_button);</span>
<span class="nc" id="L389">        mExpandCollapse = (ImageView) mView.findViewById(R.id.expand_collapse);</span>
<span class="nc" id="L390">        mAlertView = (ImageView) mView.findViewById(R.id.alert);</span>
<span class="nc" id="L391">        mAlertView.setColorFilter(mView.getResources().getColor(R.color.header_text_color));</span>
<span class="nc" id="L392">        mAlertView.setVisibility(View.GONE);</span>

<span class="nc" id="L394">        resetExpandCollapseAnimation();</span>

        // Initialize right margin view visibilities
<span class="nc" id="L397">        UIUtils.showViewWithAnimation(mProgressBar, mShortAnimationDuration);</span>

<span class="nc" id="L399">        UIUtils.hideViewWithAnimation(mEtaContainer1, mShortAnimationDuration);</span>
<span class="nc" id="L400">        UIUtils.hideViewWithAnimation(mEtaSeparator, mShortAnimationDuration);</span>
<span class="nc" id="L401">        UIUtils.hideViewWithAnimation(mEtaContainer2, mShortAnimationDuration);</span>

        // Initialize stop info view
<span class="nc" id="L404">        final ObaRegion obaRegion = Application.get().getCurrentRegion();</span>

<span class="nc bnc" id="L406" title="All 4 branches missed.">        if (obaRegion == null || TextUtils.isEmpty(obaRegion.getStopInfoUrl())) {</span>
            // This region doesn't support StopInfo - hide the info icon
<span class="nc" id="L408">            mStopInfo.setVisibility(View.GONE);</span>
        } else {
<span class="nc" id="L410">            mStopInfo.setVisibility(View.VISIBLE);</span>

<span class="nc" id="L412">            mStopInfo.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
                    // Assemble StopInfo URL for the current stop
<span class="nc" id="L416">                    Uri stopInfoUri = Uri.parse(obaRegion.getStopInfoUrl());</span>
<span class="nc" id="L417">                    Uri.Builder stopInfoBuilder = stopInfoUri.buildUpon();</span>
<span class="nc" id="L418">                    stopInfoBuilder.appendPath(mContext.getString(R.string.stop_info_url_path));</span>
<span class="nc" id="L419">                    stopInfoBuilder.appendPath(mController.getStopId());</span>

<span class="nc" id="L421">                    Log.d(TAG, &quot;StopInfoUrl - &quot; + stopInfoBuilder.build());</span>

<span class="nc" id="L423">                    Intent i = new Intent(Intent.ACTION_VIEW);</span>
<span class="nc" id="L424">                    i.setData(stopInfoBuilder.build());</span>
<span class="nc" id="L425">                    mContext.startActivity(i);</span>
                    //Analytics
<span class="nc bnc" id="L427" title="All 2 branches missed.">                    if (obaRegion.getName() != null) {</span>
<span class="nc" id="L428">                        ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L429">                                mContext.getString(R.string.analytics_label_button_press_stopinfo),</span>
                                null);
                    }
<span class="nc" id="L432">                }</span>
            });
        }

<span class="nc" id="L436">        mStopFavorite.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc bnc" id="L439" title="All 2 branches missed.">                mController.setFavoriteStop(!mController.isFavoriteStop());</span>
<span class="nc" id="L440">                refreshStopFavorite();</span>
<span class="nc" id="L441">            }</span>
        });

<span class="nc" id="L444">        mNameView.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L447">                beginNameEdit(null);</span>
<span class="nc" id="L448">            }</span>
        });

        // Implement the &quot;Save&quot; and &quot;Clear&quot; buttons
<span class="nc" id="L452">        View save = mView.findViewById(R.id.edit_name_save);</span>
<span class="nc" id="L453">        save.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L456">                mController.setUserStopName(mEditNameView.getText().toString());</span>
<span class="nc" id="L457">                endNameEdit();</span>
<span class="nc" id="L458">            }</span>
        });

<span class="nc" id="L461">        mEditNameView.setOnEditorActionListener(new TextView.OnEditorActionListener() {</span>
            @Override
            public boolean onEditorAction(TextView v, int actionId, KeyEvent event) {
<span class="nc bnc" id="L464" title="All 2 branches missed.">                if (actionId == EditorInfo.IME_ACTION_DONE) {</span>
<span class="nc" id="L465">                    mController.setUserStopName(mEditNameView.getText().toString());</span>
<span class="nc" id="L466">                    endNameEdit();</span>
<span class="nc" id="L467">                    return true;</span>
                }
<span class="nc" id="L469">                return false;</span>
            }
        });

        // &quot;Cancel&quot;
<span class="nc" id="L474">        View cancel = mView.findViewById(R.id.edit_name_cancel);</span>
<span class="nc" id="L475">        cancel.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L478">                endNameEdit();</span>
<span class="nc" id="L479">            }</span>
        });

<span class="nc" id="L482">        View clear = mView.findViewById(R.id.edit_name_revert);</span>
<span class="nc" id="L483">        clear.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L486">                mController.setUserStopName(null);</span>
<span class="nc" id="L487">                endNameEdit();</span>
<span class="nc" id="L488">            }</span>
        });
<span class="nc" id="L490">    }</span>

    /**
     * Used to give the header control over the containing sliding panel, primarily to change the
     * panel header height
     */
    public void setSlidingPanelController(HomeActivity.SlidingPanelController controller) {
<span class="nc" id="L497">        mSlidingPanelController = controller;</span>
<span class="nc" id="L498">    }</span>

    /**
     * Should be called from onPause() of context hosting this header
     */
    public void onPause() {
        // If we're editing a stop name, close out the editing session
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (mInNameEdit) {</span>
<span class="nc" id="L506">            mController.setUserStopName(null);</span>
<span class="nc" id="L507">            endNameEdit();</span>
        }
<span class="nc" id="L509">    }</span>

    synchronized public void setSlidingPanelCollapsed(boolean collapsed) {
        // If the state has changed and image is initialized, then rotate the expand/collapse image
<span class="nc bnc" id="L513" title="All 4 branches missed.">        if (mExpandCollapse != null &amp;&amp; collapsed != mIsSlidingPanelCollapsed) {</span>
            // Update value
<span class="nc" id="L515">            mIsSlidingPanelCollapsed = collapsed;</span>

<span class="nc" id="L517">            doExpandCollapseRotation(collapsed);</span>
        }
<span class="nc" id="L519">    }</span>

    /**
     * Sets the trip details (e.g., reminders) for this stop
     */
    public void setTripsForStop(ContentQueryMap tripsForStop) {
<span class="nc" id="L525">        mTripsForStop = tripsForStop;</span>
<span class="nc" id="L526">        refreshArrivalInfoVisibilityAndListeners();</span>
<span class="nc" id="L527">    }</span>

    @TargetApi(Build.VERSION_CODES.HONEYCOMB_MR1)
    private void doExpandCollapseRotation(boolean collapsed) {
<span class="nc bnc" id="L531" title="All 2 branches missed.">        if (!UIUtils.canAnimateViewModern()) {</span>
<span class="nc" id="L532">            rotateExpandCollapseImageViewLegacy(collapsed);</span>
<span class="nc" id="L533">            return;</span>
        }
<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (!collapsed) {</span>
            // Rotate clockwise
<span class="nc" id="L537">            mExpandCollapse.animate()</span>
<span class="nc" id="L538">                    .setDuration(ANIM_DURATION)</span>
<span class="nc" id="L539">                    .rotationBy(ANIM_STATE_INVERTED);</span>
        } else {
            // Rotate counter-clockwise
<span class="nc" id="L542">            mExpandCollapse.animate()</span>
<span class="nc" id="L543">                    .setDuration(ANIM_DURATION)</span>
<span class="nc" id="L544">                    .rotationBy(-ANIM_STATE_INVERTED);</span>
        }
<span class="nc" id="L546">    }</span>

    private void rotateExpandCollapseImageViewLegacy(boolean isSlidingPanelCollapsed) {
        RotateAnimation rotate;

<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (!isSlidingPanelCollapsed) {</span>
            // Rotate clockwise
<span class="nc" id="L553">            rotate = getRotation(ANIM_STATE_NORMAL, ANIM_STATE_INVERTED);</span>
        } else {
            // Rotate counter-clockwise
<span class="nc" id="L556">            rotate = getRotation(ANIM_STATE_INVERTED, ANIM_STATE_NORMAL);</span>
        }

<span class="nc" id="L559">        mExpandCollapse.setAnimation(rotate);</span>
<span class="nc" id="L560">    }</span>

    /**
     * Resets the animation that has been applied to the expand/collapse indicator image
     */
    @TargetApi(Build.VERSION_CODES.HONEYCOMB_MR1)
    private synchronized void resetExpandCollapseAnimation() {
<span class="nc bnc" id="L567" title="All 2 branches missed.">        if (mExpandCollapse == null) {</span>
<span class="nc" id="L568">            return;</span>
        }
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (UIUtils.canAnimateViewModern()) {</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">            if (mExpandCollapse.getRotation() != 0) {</span>
<span class="nc" id="L572">                mExpandCollapse.setRotation(0);</span>
            }
        } else {
<span class="nc" id="L575">            mExpandCollapse.clearAnimation();</span>
        }
<span class="nc" id="L577">    }</span>

    /**
     * Allows external classes to set whether or not the expand/collapse indicator should be
     * shown (e.g., if the header is not in a sliding window, we don't want to show it)
     *
     * @param value true if the expand/collapse indicator should be shown, false if it should not
     */
    public void showExpandCollapseIndicator(boolean value) {
<span class="nc bnc" id="L586" title="All 2 branches missed.">        if (mExpandCollapse != null) {</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">            if (value) {</span>
<span class="nc" id="L588">                mExpandCollapse.setVisibility(View.VISIBLE);</span>
            } else {
<span class="nc" id="L590">                mExpandCollapse.setVisibility(View.GONE);</span>
            }
        }
<span class="nc" id="L593">    }</span>

    /**
     * Allows external classes to show or hide arrival information in the header
     *
     * @param value true if the arrival info should be shown, false if it should not
     */
    public void showArrivals(boolean value) {
<span class="nc" id="L601">        mShowArrivals = value;</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if (mView != null) {</span>
<span class="nc" id="L603">            TableLayout arrivalTable = (TableLayout) mView.findViewById(R.id.eta_table);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">            if (arrivalTable != null) {</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                if (mShowArrivals) {</span>
<span class="nc" id="L606">                    arrivalTable.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L607">                    mProgressBar.setVisibility(View.VISIBLE);</span>
                } else {
<span class="nc" id="L609">                    arrivalTable.setVisibility(View.GONE);</span>
<span class="nc" id="L610">                    mProgressBar.setVisibility(View.GONE);</span>
                }
            }
        }
<span class="nc" id="L614">    }</span>

    /**
     * Returns true if the header is showing arrival info, false if it is not
     *
     * @return true if the header is showing arrival info, false if it is not
     */
    public boolean isShowingArrivals() {
<span class="nc" id="L622">        return mShowArrivals;</span>
    }

    /**
     * Creates and returns a new rotation animation for the expand/collapse image based on the
     * provided startState and endState.
     *
     * @param startState beginning state of the image, either ANIM_STATE_NORMAL or
     *                   ANIM_STATE_INVERTED
     * @param endState   end state of the image, either ANIM_STATE_NORMAL or ANIM_STATE_INVERTED
     * @return a new rotation animation for the expand/collapse image
     */
    private static RotateAnimation getRotation(float startState, float endState) {
<span class="nc" id="L635">        RotateAnimation r = new RotateAnimation(startState, endState,</span>
                Animation.RELATIVE_TO_SELF, ANIM_PIVOT_VALUE,
                Animation.RELATIVE_TO_SELF, ANIM_PIVOT_VALUE);
<span class="nc" id="L638">        r.setDuration(ANIM_DURATION);</span>
<span class="nc" id="L639">        r.setFillAfter(true);</span>
<span class="nc" id="L640">        return r;</span>
    }

    synchronized void refresh() {
<span class="nc" id="L644">        refreshName();</span>
<span class="nc" id="L645">        refreshArrivalInfoData();</span>
<span class="nc" id="L646">        refreshStopFavorite();</span>
<span class="nc" id="L647">        refreshFilter();</span>
<span class="nc" id="L648">        refreshError();</span>
<span class="nc" id="L649">        refreshHiddenAlerts();</span>
<span class="nc" id="L650">        refreshArrivalInfoVisibilityAndListeners();</span>
<span class="nc" id="L651">        refreshHeaderSize();</span>
<span class="nc" id="L652">    }</span>

    private void refreshName() {
<span class="nc bnc" id="L655" title="All 2 branches missed.">        if (mController == null) {</span>
<span class="nc" id="L656">            return;</span>
        }
<span class="nc" id="L658">        String name = mController.getStopName();</span>
<span class="nc" id="L659">        String userName = mController.getUserStopName();</span>
<span class="nc" id="L660">        String stopDirection = mController.getStopDirection();</span>

<span class="nc bnc" id="L662" title="All 2 branches missed.">        if (!TextUtils.isEmpty(userName)) {</span>
<span class="nc" id="L663">            mNameView.setText(UIUtils.formatDisplayText(userName));</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">        } else if (name != null) {</span>
<span class="nc" id="L665">            mNameView.setText(UIUtils.formatDisplayText(name));</span>
        }

<span class="nc bnc" id="L668" title="All 2 branches missed.">        if (!TextUtils.isEmpty(stopDirection)) {</span>
<span class="nc" id="L669">            mDirectionView.setText(mContext.getString(R.string.arrival_list_stop_directions,</span>
                    stopDirection));
<span class="nc" id="L671">            mDirectionView.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L673">            mDirectionView.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L675">    }</span>

    /**
     * Refreshes the arrival info data to be displayed in the header based on the most recent
     * arrival info, and sets the number of arrival rows that should be displayed in the header
     */
    private void refreshArrivalInfoData() {
<span class="nc bnc" id="L682" title="All 2 branches missed.">        if (mController == null) {</span>
<span class="nc" id="L683">            return;</span>
        }
<span class="nc" id="L685">        mArrivalInfo = mController.getArrivalInfo();</span>
<span class="nc" id="L686">        mHeaderArrivalInfo.clear();</span>

<span class="nc bnc" id="L688" title="All 4 branches missed.">        if (mArrivalInfo != null &amp;&amp; !mInNameEdit) {</span>
            // Get the indexes for arrival times that should be featured in the header
<span class="nc" id="L690">            ArrayList&lt;Integer&gt; etaIndexes = ArrivalInfoUtils.findPreferredArrivalIndexes(mArrivalInfo);</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">            if (etaIndexes != null) {</span>
                // We have a non-negative ETA for at least one bus - fill the first arrival row
<span class="nc" id="L693">                final int i1 = etaIndexes.get(0);</span>
<span class="nc" id="L694">                ObaArrivalInfo info1 = mArrivalInfo.get(i1).getInfo();</span>
<span class="nc" id="L695">                boolean isFavorite = ObaContract.RouteHeadsignFavorites.isFavorite(</span>
<span class="nc" id="L696">                        info1.getRouteId(),</span>
<span class="nc" id="L697">                        info1.getHeadsign(),</span>
<span class="nc" id="L698">                        info1.getStopId());</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">                mEtaRouteFavorite1.setImageResource(isFavorite ?</span>
<span class="nc" id="L700">                        R.drawable.focus_star_on :</span>
<span class="nc" id="L701">                        R.drawable.focus_star_off);</span>

<span class="nc bnc" id="L703" title="All 4 branches missed.">                if (info1.getTripStatus() != null &amp;&amp; Status.CANCELED.equals(info1.getTripStatus().getStatus())) {</span>
                    // Trip is canceled - strike through text fields
<span class="nc" id="L705">                    mEtaRouteName1.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
<span class="nc" id="L706">                    mEtaRouteDirection1.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
<span class="nc" id="L707">                    mEtaArrivalInfo1.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
<span class="nc" id="L708">                    mEtaMin1.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
                }

<span class="nc" id="L711">                mEtaRouteName1.setText(info1.getShortName());</span>
<span class="nc" id="L712">                mEtaRouteDirection1.setText(UIUtils.formatDisplayText(info1.getHeadsign()));</span>
<span class="nc" id="L713">                long eta = mArrivalInfo.get(i1).getEta();</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                if (eta == 0) {</span>
<span class="nc" id="L715">                    mEtaArrivalInfo1.setText(mContext.getString(R.string.stop_info_eta_now));</span>
<span class="nc" id="L716">                    mEtaArrivalInfo1.setTextSize(ETA_TEXT_NOW_SIZE_SP);</span>
<span class="nc" id="L717">                    UIUtils.hideViewWithAnimation(mEtaMin1, mShortAnimationDuration);</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                } else if (eta &gt; 0) {</span>
<span class="nc" id="L719">                    mEtaArrivalInfo1.setText(Long.toString(eta));</span>
<span class="nc" id="L720">                    mEtaArrivalInfo1.setTextSize(ETA_TEXT_SIZE_SP);</span>
<span class="nc" id="L721">                    UIUtils.showViewWithAnimation(mEtaMin1, mShortAnimationDuration);</span>
                }

<span class="nc" id="L724">                mEtaAndMin1.setBackgroundResource(</span>
                        R.drawable.round_corners_style_b_header_status);
<span class="nc" id="L726">                GradientDrawable d1 = (GradientDrawable) mEtaAndMin1.getBackground();</span>
<span class="nc" id="L727">                final int c1 = mArrivalInfo.get(i1).getColor();</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">                if (c1 != R.color.stop_info_ontime) {</span>
                    // Show early/late/scheduled color
<span class="nc" id="L730">                    d1.setColor(mResources.getColor(c1));</span>
                } else {
                    // For on-time, use header on time color for better customization (#429)
<span class="nc" id="L733">                    d1.setColor(mResources.getColor(R.color.header_stop_info_ontime));</span>
                }
<span class="nc" id="L735">                mEtaAndMin1.setOnClickListener(new View.OnClickListener() {</span>
                    @Override
                    public void onClick(View v) {
<span class="nc bnc" id="L738" title="All 4 branches missed.">                        if (mPopup1 != null &amp;&amp; mPopup1.isShowing()) {</span>
<span class="nc" id="L739">                            mPopup1.dismiss();</span>
<span class="nc" id="L740">                            return;</span>
                        }
<span class="nc" id="L742">                        mPopup1 = setupPopup(0, c1, mArrivalInfo.get(i1).getStatusText());</span>
<span class="nc" id="L743">                        mPopup1.showAsDropDown(mEtaAndMin1);</span>
<span class="nc" id="L744">                    }</span>
                });

<span class="nc bnc" id="L747" title="All 2 branches missed.">                if (mArrivalInfo.get(i1).getPredicted()) {</span>
                    // We have real-time data - show the indicator
<span class="nc" id="L749">                    UIUtils.showViewWithAnimation(mEtaRealtime1, mShortAnimationDuration);</span>
                } else {
                    // We only have schedule data - hide the indicator
<span class="nc" id="L752">                    mEtaRealtime1.setVisibility(View.INVISIBLE);</span>
                    // If this is frequency-based data, indicate that arrival is approximate
<span class="nc bnc" id="L754" title="All 2 branches missed.">                    if (mArrivalInfo.get(i1).getInfo().getFrequency() != null) {</span>
<span class="nc" id="L755">                        mEtaArrivalInfo1.setText(</span>
<span class="nc" id="L756">                                mResources.getString(R.string.stop_info_frequency_approximate)</span>
<span class="nc" id="L757">                                        + mEtaArrivalInfo1.getText());</span>
                    }
                }
                // Save the arrival info for the options menu later
<span class="nc" id="L761">                mHeaderArrivalInfo.add(mArrivalInfo.get(i1));</span>

                // If there is another arrival, fill the second row with it
<span class="nc bnc" id="L764" title="All 2 branches missed.">                if (etaIndexes.size() &gt;= 2) {</span>
<span class="nc" id="L765">                    final int i2 = etaIndexes.get(1);</span>
<span class="nc" id="L766">                    ObaArrivalInfo info2 = mArrivalInfo.get(i2).getInfo();</span>
<span class="nc" id="L767">                    boolean isFavorite2 = ObaContract.RouteHeadsignFavorites.isFavorite(</span>
<span class="nc" id="L768">                            info2.getRouteId(),</span>
<span class="nc" id="L769">                            info2.getHeadsign(),</span>
<span class="nc" id="L770">                            info2.getStopId());</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">                    mEtaRouteFavorite2.setImageResource(isFavorite2 ?</span>
<span class="nc" id="L772">                            R.drawable.focus_star_on :</span>
<span class="nc" id="L773">                            R.drawable.focus_star_off);</span>

<span class="nc bnc" id="L775" title="All 4 branches missed.">                    if (info2.getTripStatus() != null &amp;&amp; Status.CANCELED.equals(info2.getTripStatus().getStatus())) {</span>
                        // Trip is canceled - strike through text fields
<span class="nc" id="L777">                        mEtaRouteName2.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
<span class="nc" id="L778">                        mEtaRouteDirection2.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
<span class="nc" id="L779">                        mEtaArrivalInfo2.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
<span class="nc" id="L780">                        mEtaMin2.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
                    }

<span class="nc" id="L783">                    mEtaRouteName2.setText(info2.getShortName());</span>
<span class="nc" id="L784">                    mEtaRouteDirection2.setText(UIUtils.formatDisplayText(info2.getHeadsign()));</span>
<span class="nc" id="L785">                    eta = mArrivalInfo.get(i2).getEta();</span>

<span class="nc bnc" id="L787" title="All 2 branches missed.">                    if (eta == 0) {</span>
<span class="nc" id="L788">                        mEtaArrivalInfo2.setText(mContext.getString(R.string.stop_info_eta_now));</span>
<span class="nc" id="L789">                        mEtaArrivalInfo2.setTextSize(ETA_TEXT_NOW_SIZE_SP);</span>
<span class="nc" id="L790">                        UIUtils.hideViewWithAnimation(mEtaMin2, mShortAnimationDuration);</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">                    } else if (eta &gt; 0) {</span>
<span class="nc" id="L792">                        mEtaArrivalInfo2.setText(Long.toString(eta));</span>
<span class="nc" id="L793">                        mEtaArrivalInfo2.setTextSize(ETA_TEXT_SIZE_SP);</span>
<span class="nc" id="L794">                        UIUtils.showViewWithAnimation(mEtaMin2, mShortAnimationDuration);</span>
                    }
<span class="nc" id="L796">                    mEtaAndMin2.setBackgroundResource(</span>
                            R.drawable.round_corners_style_b_header_status);
<span class="nc" id="L798">                    GradientDrawable d2 = (GradientDrawable) mEtaAndMin2.getBackground();</span>
<span class="nc" id="L799">                    final int c2 = mArrivalInfo.get(i2).getColor();</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">                    if (c2 != R.color.stop_info_ontime) {</span>
                        // Show early/late/scheduled color
<span class="nc" id="L802">                        d2.setColor(mResources.getColor(c2));</span>
                    } else {
                        // For on-time, use header on time color for better customization (#429)
<span class="nc" id="L805">                        d2.setColor(mResources.getColor(R.color.header_stop_info_ontime));</span>
                    }
<span class="nc" id="L807">                    mEtaAndMin2.setOnClickListener(new View.OnClickListener() {</span>
                        @Override
                        public void onClick(View v) {
<span class="nc bnc" id="L810" title="All 4 branches missed.">                            if (mPopup2 != null &amp;&amp; mPopup2.isShowing()) {</span>
<span class="nc" id="L811">                                mPopup2.dismiss();</span>
<span class="nc" id="L812">                                return;</span>
                            }
<span class="nc" id="L814">                            mPopup2 = setupPopup(1, c2, mArrivalInfo.get(i2).getStatusText());</span>
<span class="nc" id="L815">                            mPopup2.showAsDropDown(mEtaAndMin2);</span>
<span class="nc" id="L816">                        }</span>
                    });

<span class="nc bnc" id="L819" title="All 2 branches missed.">                    if (mArrivalInfo.get(i2).getPredicted()) {</span>
                        // We have real-time data - show the indicator
<span class="nc" id="L821">                        UIUtils.showViewWithAnimation(mEtaRealtime2, mShortAnimationDuration);</span>
                    } else {
                        // We only have schedule data - hide the indicator
<span class="nc" id="L824">                        mEtaRealtime2.setVisibility(View.INVISIBLE);</span>
                        // If this is frequency-based data, indicate that arrival is approximate
<span class="nc bnc" id="L826" title="All 2 branches missed.">                        if (mArrivalInfo.get(i2).getInfo().getFrequency() != null) {</span>
<span class="nc" id="L827">                            mEtaArrivalInfo2.setText(</span>
<span class="nc" id="L828">                                    mResources.getString(R.string.stop_info_frequency_approximate)</span>
<span class="nc" id="L829">                                            + mEtaArrivalInfo2.getText());</span>
                        }
                    }

<span class="nc" id="L833">                    mNumHeaderArrivals = 2;</span>

                    // Save the arrival info for the options menu later
<span class="nc" id="L836">                    mHeaderArrivalInfo.add(mArrivalInfo.get(i2));</span>
<span class="nc" id="L837">                } else {</span>
<span class="nc" id="L838">                    mNumHeaderArrivals = 1;</span>
                }
<span class="nc" id="L840">            } else {</span>
                // Show abbreviated &quot;no upcoming arrivals&quot; message (e.g., &quot;35+ min&quot;)
<span class="nc" id="L842">                int minAfter = mController.getMinutesAfter();</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">                if (minAfter != -1) {</span>
<span class="nc" id="L844">                    mNoArrivals</span>
<span class="nc" id="L845">                            .setText(</span>
<span class="nc" id="L846">                                    UIUtils.getNoArrivalsMessage(mContext, minAfter, false, false));</span>
                } else {
<span class="nc" id="L848">                    minAfter = 35;  // Assume 35 minutes, because that's the API default</span>
<span class="nc" id="L849">                    mNoArrivals</span>
<span class="nc" id="L850">                            .setText(</span>
<span class="nc" id="L851">                                    UIUtils.getNoArrivalsMessage(mContext, minAfter, false, false));</span>
                }
<span class="nc" id="L853">                mNumHeaderArrivals = 0;</span>
            }
        }
<span class="nc" id="L856">    }</span>

    /**
     * Sets the popup for the status
     *
     * @param index      0 if this is for the top ETA row, 1 if it is for the second
     * @param color      color resource id to use for the popup background
     * @param statusText text to show in the status popup
     * @return a new PopupWindow initialized based on the provided parameters
     */
    private PopupWindow setupPopup(final int index, int color, String statusText) {
<span class="nc" id="L867">        LayoutInflater inflater = LayoutInflater.from(mContext);</span>
<span class="nc" id="L868">        TextView statusView = (TextView) inflater</span>
<span class="nc" id="L869">                .inflate(R.layout.arrivals_list_tv_template_style_b_status_large, null);</span>
<span class="nc" id="L870">        statusView.setBackgroundResource(</span>
                R.drawable.round_corners_style_b_status);
<span class="nc" id="L872">        GradientDrawable d = (GradientDrawable) statusView.getBackground();</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">        if (color != R.color.stop_info_ontime) {</span>
            // Show early/late color
<span class="nc" id="L875">            d.setColor(mResources.getColor(color));</span>
        } else {
            // For on-time, use header on time color for better customization (#429)
<span class="nc" id="L878">            d.setColor(mResources.getColor(R.color.header_stop_info_ontime));</span>
        }
<span class="nc" id="L880">        d.setStroke(UIUtils.dpToPixels(mContext, 1),</span>
<span class="nc" id="L881">                mResources.getColor(R.color.header_text_color));</span>
<span class="nc" id="L882">        int pSides = UIUtils.dpToPixels(mContext, 5);</span>
<span class="nc" id="L883">        int pTopBottom = UIUtils.dpToPixels(mContext, 2);</span>
<span class="nc" id="L884">        statusView.setPadding(pSides, pTopBottom, pSides, pTopBottom);</span>
<span class="nc" id="L885">        statusView.setLayoutParams(</span>
                new ViewGroup.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,
                        ViewGroup.LayoutParams.WRAP_CONTENT));
<span class="nc" id="L888">        statusView.measure(TextView.MeasureSpec.UNSPECIFIED,</span>
                TextView.MeasureSpec.UNSPECIFIED);
<span class="nc" id="L890">        statusView.setText(statusText);</span>
<span class="nc" id="L891">        PopupWindow p = new PopupWindow(statusView, statusView.getWidth(), statusView.getHeight());</span>
<span class="nc" id="L892">        p.setWindowLayoutMode(ViewGroup.LayoutParams.WRAP_CONTENT,</span>
                ViewGroup.LayoutParams.WRAP_CONTENT);
<span class="nc" id="L894">        p.setBackgroundDrawable(</span>
<span class="nc" id="L895">                new ColorDrawable(mResources.getColor(android.R.color.transparent)));</span>
<span class="nc" id="L896">        p.setOutsideTouchable(true);</span>
<span class="nc" id="L897">        p.setTouchInterceptor(new View.OnTouchListener() {</span>
            @Override
            public boolean onTouch(View v, MotionEvent event) {
                boolean touchInView;
<span class="nc bnc" id="L901" title="All 2 branches missed.">                if (index == 0) {</span>
<span class="nc" id="L902">                    touchInView = UIUtils.isTouchInView(mEtaAndMin1, event);</span>
                } else {
<span class="nc" id="L904">                    touchInView = UIUtils.isTouchInView(mEtaAndMin2, event);</span>
                }
<span class="nc" id="L906">                return touchInView;</span>
            }
        });
<span class="nc" id="L909">        return p;</span>
    }

    private void refreshStopFavorite() {
<span class="nc bnc" id="L913" title="All 2 branches missed.">        mStopFavorite.setImageResource(mController.isFavoriteStop() ?</span>
<span class="nc" id="L914">                R.drawable.focus_star_on :</span>
<span class="nc" id="L915">                R.drawable.focus_star_off);</span>
<span class="nc" id="L916">    }</span>

    /**
     * Refreshes the routes filter, and displays/hides it if necessary
     */
    private void refreshFilter() {
<span class="nc bnc" id="L922" title="All 2 branches missed.">        if (mController == null) {</span>
<span class="nc" id="L923">            return;</span>
        }
<span class="nc" id="L925">        TextView v = (TextView) mView.findViewById(R.id.filter_text);</span>
<span class="nc" id="L926">        ArrayList&lt;String&gt; routesFilter = mController.getRoutesFilter();</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">        final int num = (routesFilter != null) ? routesFilter.size() : 0;</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">        if (num &gt; 0) {</span>
<span class="nc" id="L929">            final int total = mController.getNumRoutes();</span>
<span class="nc" id="L930">            v.setText(mContext.getString(R.string.stop_info_filter_header, num, total));</span>
            // Show the filter text (except when in name edit mode)
<span class="nc bnc" id="L932" title="All 2 branches missed.">            if (mInNameEdit) {</span>
<span class="nc" id="L933">                mFilterGroup.setVisibility(View.GONE);</span>
            } else {
<span class="nc" id="L935">                mFilterGroup.setVisibility(View.VISIBLE);</span>
            }
<span class="nc" id="L937">        } else {</span>
<span class="nc" id="L938">            mFilterGroup.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L940">    }</span>

    /**
     * Returns true if we're filtering routes from the user's view, or false if we're not
     *
     * @return true if we're filtering routes from the user's view, or false if we're not
     */
    private boolean isFilteringRoutes() {
<span class="nc" id="L948">        ArrayList&lt;String&gt; routesFilter = mController.getRoutesFilter();</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">        final int num = (routesFilter != null) ? routesFilter.size() : 0;</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">        return num &gt; 0;</span>
    }

    /**
     * Hides the progress bar, and replaces it with the correct content depending on sliding
     * panel state and arrival info
     */
    @TargetApi(Build.VERSION_CODES.HONEYCOMB)
    private void refreshArrivalInfoVisibilityAndListeners() {
<span class="nc bnc" id="L959" title="All 2 branches missed.">        if (mInNameEdit) {</span>
            // If the user is editing a stop name, we shouldn't show any of these views
<span class="nc" id="L961">            return;</span>
        }
<span class="nc bnc" id="L963" title="All 2 branches missed.">        if (mArrivalInfo == null) {</span>
            // We don't have any arrival info yet, so make sure the progress bar is running
<span class="nc" id="L965">            UIUtils.showViewWithAnimation(mProgressBar, mShortAnimationDuration);</span>
            // Hide all the arrival views
<span class="nc" id="L967">            UIUtils.hideViewWithAnimation(mNoArrivals, mShortAnimationDuration);</span>
<span class="nc" id="L968">            UIUtils.hideViewWithAnimation(mEtaContainer1, mShortAnimationDuration);</span>
<span class="nc" id="L969">            UIUtils.hideViewWithAnimation(mEtaSeparator, mShortAnimationDuration);</span>
<span class="nc" id="L970">            UIUtils.hideViewWithAnimation(mEtaContainer2, mShortAnimationDuration);</span>
<span class="nc" id="L971">            return;</span>
        }

<span class="nc bnc" id="L974" title="All 2 branches missed.">        if (mNumHeaderArrivals == 0) {</span>
            // &quot;No routes&quot; message should be shown
<span class="nc" id="L976">            UIUtils.showViewWithAnimation(mNoArrivals, mShortAnimationDuration);</span>
            // Hide all others
<span class="nc" id="L978">            UIUtils.hideViewWithAnimation(mEtaContainer1, mShortAnimationDuration);</span>
<span class="nc" id="L979">            UIUtils.hideViewWithAnimation(mEtaSeparator, mShortAnimationDuration);</span>
<span class="nc" id="L980">            UIUtils.hideViewWithAnimation(mEtaContainer2, mShortAnimationDuration);</span>
        }

        // Show at least the first row of arrival info, if we have one or more records
<span class="nc bnc" id="L984" title="All 2 branches missed.">        if (mNumHeaderArrivals &gt;= 1) {</span>
            // Show the first row of arrival info
<span class="nc" id="L986">            UIUtils.showViewWithAnimation(mEtaContainer1, mShortAnimationDuration);</span>
            // Hide no arrivals
<span class="nc" id="L988">            UIUtils.hideViewWithAnimation(mNoArrivals, mShortAnimationDuration);</span>

            // Setup tapping on star for first row
<span class="nc" id="L991">            final ObaArrivalInfo info1 = mHeaderArrivalInfo.get(0).getInfo();</span>
<span class="nc" id="L992">            final boolean isRouteFavorite = ObaContract.RouteHeadsignFavorites.isFavorite(</span>
<span class="nc" id="L993">                    info1.getRouteId(), info1.getHeadsign(), info1.getStopId());</span>
<span class="nc" id="L994">            mEtaRouteFavorite1.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
                    // Show dialog for setting route favorite
<span class="nc" id="L998">                    RouteFavoriteDialogFragment dialog = new RouteFavoriteDialogFragment.Builder(</span>
<span class="nc" id="L999">                            info1.getRouteId(), UIUtils.formatDisplayText(info1.getHeadsign()))</span>
<span class="nc" id="L1000">                            .setRouteShortName(info1.getShortName())</span>
<span class="nc" id="L1001">                            .setRouteLongName(info1.getRouteLongName())</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">                            .setStopId(info1.getStopId())</span>
<span class="nc" id="L1003">                            .setFavorite(!isRouteFavorite)</span>
<span class="nc" id="L1004">                            .build();</span>

<span class="nc" id="L1006">                    dialog.setCallback(new RouteFavoriteDialogFragment.Callback() {</span>
                        @Override
                        public void onSelectionComplete(boolean savedFavorite) {
<span class="nc bnc" id="L1009" title="All 2 branches missed.">                            if (savedFavorite) {</span>
<span class="nc" id="L1010">                                mController.refreshLocal();</span>
                            }
<span class="nc" id="L1012">                        }</span>
                    });
<span class="nc" id="L1014">                    dialog.show(mFragmentManager, RouteFavoriteDialogFragment.TAG);</span>

<span class="nc" id="L1016">                }</span>
            });

<span class="nc" id="L1019">            mEtaReminder1.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
                    // Add / edit reminder
<span class="nc" id="L1023">                    TripInfoActivity.start(mContext,</span>
<span class="nc" id="L1024">                            info1.getTripId(),</span>
<span class="nc" id="L1025">                            mController.getStopId(),</span>
<span class="nc" id="L1026">                            info1.getRouteId(),</span>
<span class="nc" id="L1027">                            info1.getShortName(),</span>
<span class="nc" id="L1028">                            mController.getStopName(),</span>
<span class="nc" id="L1029">                            info1.getScheduledDepartureTime(),</span>
<span class="nc" id="L1030">                            info1.getHeadsign());</span>
<span class="nc" id="L1031">                }</span>
            });

            // Setup &quot;more&quot; button click for first row
<span class="nc" id="L1035">            mEtaMoreVert1.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
<span class="nc" id="L1038">                    mController.showListItemMenu(mEtaContainer1, mHeaderArrivalInfo.get(0));</span>
<span class="nc" id="L1039">                }</span>
            });

            // Show or hide reminder for first row
<span class="nc" id="L1043">            View r = mEtaContainer1.findViewById(R.id.reminder);</span>
<span class="nc" id="L1044">            refreshReminder(mHeaderArrivalInfo.get(0).getInfo().getTripId(), r);</span>
        }

<span class="nc bnc" id="L1047" title="All 2 branches missed.">        if (mNumHeaderArrivals &gt;= 2) {</span>
            // Also show the 2nd row of arrival info
<span class="nc" id="L1049">            UIUtils.showViewWithAnimation(mEtaSeparator, mShortAnimationDuration);</span>
<span class="nc" id="L1050">            UIUtils.showViewWithAnimation(mEtaContainer2, mShortAnimationDuration);</span>

            // Setup tapping on star for second row
<span class="nc" id="L1053">            final ObaArrivalInfo info2 = mHeaderArrivalInfo.get(1).getInfo();</span>
<span class="nc" id="L1054">            final boolean isRouteFavorite2 = ObaContract.RouteHeadsignFavorites.isFavorite(</span>
<span class="nc" id="L1055">                    info2.getRouteId(), info2.getHeadsign(), info2.getStopId());</span>
<span class="nc" id="L1056">            mEtaRouteFavorite2.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
                    // Show dialog for setting route favorite
<span class="nc" id="L1060">                    RouteFavoriteDialogFragment dialog = new RouteFavoriteDialogFragment.Builder(</span>
<span class="nc" id="L1061">                            info2.getRouteId(), info2.getHeadsign())</span>
<span class="nc" id="L1062">                            .setRouteShortName(info2.getShortName())</span>
<span class="nc" id="L1063">                            .setRouteLongName(info2.getRouteLongName())</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">                            .setStopId(info2.getStopId())</span>
<span class="nc" id="L1065">                            .setFavorite(!isRouteFavorite2)</span>
<span class="nc" id="L1066">                            .build();</span>

<span class="nc" id="L1068">                    dialog.setCallback(new RouteFavoriteDialogFragment.Callback() {</span>
                        @Override
                        public void onSelectionComplete(boolean savedFavorite) {
<span class="nc bnc" id="L1071" title="All 2 branches missed.">                            if (savedFavorite) {</span>
<span class="nc" id="L1072">                                mController.refreshLocal();</span>
                            }
<span class="nc" id="L1074">                        }</span>
                    });
<span class="nc" id="L1076">                    dialog.show(mFragmentManager, RouteFavoriteDialogFragment.TAG);</span>
<span class="nc" id="L1077">                }</span>
            });

<span class="nc" id="L1080">            mEtaReminder2.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
                    // Add / edit reminder
<span class="nc" id="L1084">                    TripInfoActivity.start(mContext,</span>
<span class="nc" id="L1085">                            info2.getTripId(),</span>
<span class="nc" id="L1086">                            mController.getStopId(),</span>
<span class="nc" id="L1087">                            info2.getRouteId(),</span>
<span class="nc" id="L1088">                            info2.getShortName(),</span>
<span class="nc" id="L1089">                            mController.getStopName(),</span>
<span class="nc" id="L1090">                            info2.getScheduledDepartureTime(),</span>
<span class="nc" id="L1091">                            info2.getHeadsign());</span>
<span class="nc" id="L1092">                }</span>
            });

            // Setup &quot;more&quot; button click for second row
<span class="nc" id="L1096">            mEtaMoreVert2.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
<span class="nc" id="L1099">                    mController.showListItemMenu(mEtaContainer2, mHeaderArrivalInfo.get(1));</span>
<span class="nc" id="L1100">                }</span>
            });

            // Show or hide reminder for second row
<span class="nc" id="L1104">            View r = mEtaContainer2.findViewById(R.id.reminder);</span>
<span class="nc" id="L1105">            refreshReminder(mHeaderArrivalInfo.get(1).getInfo().getTripId(), r);</span>
<span class="nc" id="L1106">        } else {</span>
            // Hide the 2nd row of arrival info and related views - we only had one arrival info
<span class="nc" id="L1108">            UIUtils.hideViewWithAnimation(mEtaSeparator, mShortAnimationDuration);</span>
<span class="nc" id="L1109">            UIUtils.hideViewWithAnimation(mEtaContainer2, mShortAnimationDuration);</span>
        }

        // Hide progress bar
<span class="nc" id="L1113">        UIUtils.hideViewWithAnimation(mProgressBar, mShortAnimationDuration);</span>
<span class="nc" id="L1114">    }</span>

    /**
     * Shows or hides a reminder in the header, based on whether there is a saved reminder for
     * the given tripId and the current stop
     * @param tripId tripId to search for reminders for in the database
     * @param v reminder view to show or hide, based on whether the there is or isn't a reminder for
     *          this tripId and stop
     */
    void refreshReminder(String tripId, View v) {
<span class="nc" id="L1124">        ContentValues values = null;</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">        if (mTripsForStop != null) {</span>
<span class="nc" id="L1126">            values = mTripsForStop.getValues(tripId);</span>
        }
<span class="nc bnc" id="L1128" title="All 2 branches missed.">        if (values != null) {</span>
            // A reminder exists for this trip
<span class="nc" id="L1130">            v.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L1132">            v.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L1134">    }</span>

    /**
     * Sets the header to the correct size based on the number of arrivals currently
     * shown in the header, and whether the panel is collapsed, anchored, or expanded.
     */
    void refreshHeaderSize() {
<span class="nc bnc" id="L1141" title="All 2 branches missed.">        if (mInNameEdit) {</span>
            // When editing the stop name, the header size is always the same.
            // Only set the height if we're not showing any arrivals (originally commented out as a
            // workaround to #314, but we shouldn't have the same issue if the header isn't in the
            // sliding panel - the only case where we're allowing the user to hide arrivals in the
            // header)
<span class="nc bnc" id="L1147" title="All 2 branches missed.">            if (!mShowArrivals) {</span>
<span class="nc" id="L1148">                setHeaderSize(HEADER_HEIGHT_EDIT_NAME_DP);</span>
            }
<span class="nc" id="L1150">            return;</span>
        }

<span class="nc" id="L1153">        float newSize = 0;</span>

        // Change the header size based on arrival info and if a route filter is used
<span class="nc bnc" id="L1156" title="All 2 branches missed.">        if (!mShowArrivals) {</span>
            // If the external class has selected not to show arrivals, we should change the header
            // size
<span class="nc" id="L1159">            newSize = HEADER_HEIGHT_NO_ARRIVALS_DP;</span>
<span class="nc bnc" id="L1160" title="All 4 branches missed.">        } else if (mNumHeaderArrivals == 0 || mNumHeaderArrivals == 1) {</span>
<span class="nc" id="L1161">            newSize = HEADER_HEIGHT_ONE_ARRIVAL_DP;</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">        } else if (mNumHeaderArrivals == 2) {</span>
<span class="nc" id="L1163">            newSize = HEADER_HEIGHT_TWO_ARRIVALS_DP;</span>
        }

        // If we're showing the route filter, than add the offset so this filter view has room
<span class="nc bnc" id="L1167" title="All 2 branches missed.">        if (isFilteringRoutes()) {</span>
<span class="nc" id="L1168">            newSize += HEADER_OFFSET_FILTER_ROUTES_DP;</span>
        }

<span class="nc bnc" id="L1171" title="All 2 branches missed.">        if (newSize != 0) {</span>
<span class="nc" id="L1172">            setHeaderSize(newSize);</span>
        }
<span class="nc" id="L1174">    }</span>


    /**
     * Re-size the header layout to the provided size, in dp
     *
     * @param newHeightDp the new header layout height, in dp
     */
    void setHeaderSize(float newHeightDp) {
<span class="nc" id="L1183">        int heightPixels = UIUtils.dpToPixels(mContext, newHeightDp);</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">        if (mSlidingPanelController != null) {</span>
<span class="nc" id="L1185">            mSlidingPanelController.setPanelHeightPixels(heightPixels);</span>
        } else {
            // If we're in the ArrivalListActivity and not the sliding panel, resize the header here
<span class="nc" id="L1188">            mView.getLayoutParams().height = heightPixels;</span>
<span class="nc" id="L1189">            mMainContainerView.getLayoutParams().height = heightPixels;</span>
        }
<span class="nc" id="L1191">    }</span>

    private static class ResponseError implements AlertList.Alert {

        private final CharSequence mString;

<span class="nc" id="L1197">        ResponseError(CharSequence seq) {</span>
<span class="nc" id="L1198">            mString = seq;</span>
<span class="nc" id="L1199">        }</span>

        @Override
        public String getId() {
<span class="nc" id="L1203">            return &quot;STATIC: RESPONSE ERROR&quot;;</span>
        }

        @Override
        public int getType() {
<span class="nc" id="L1208">            return TYPE_ERROR;</span>
        }

        @Override
        public int getFlags() {
<span class="nc" id="L1213">            return 0;</span>
        }

        @Override
        public CharSequence getString() {
<span class="nc" id="L1218">            return mString;</span>
        }

        @Override
        public void onClick() {
<span class="nc" id="L1223">        }</span>

        @Override
        public int hashCode() {
<span class="nc" id="L1227">            return getId().hashCode();</span>
        }

        @Override
        public boolean equals(Object obj) {
<span class="nc bnc" id="L1232" title="All 2 branches missed.">            if (this == obj) {</span>
<span class="nc" id="L1233">                return true;</span>
            }
<span class="nc bnc" id="L1235" title="All 2 branches missed.">            if (obj == null) {</span>
<span class="nc" id="L1236">                return false;</span>
            }
<span class="nc bnc" id="L1238" title="All 2 branches missed.">            if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L1239">                return false;</span>
            }
<span class="nc" id="L1241">            ResponseError other = (ResponseError) obj;</span>
<span class="nc bnc" id="L1242" title="All 2 branches missed.">            if (!getId().equals(other.getId())) {</span>
<span class="nc" id="L1243">                return false;</span>
            }
<span class="nc" id="L1245">            return true;</span>
        }
    }

<span class="nc" id="L1249">    private ResponseError mResponseError = null;</span>

    private void refreshError() {
<span class="nc bnc" id="L1252" title="All 2 branches missed.">        if (mController == null) {</span>
<span class="nc" id="L1253">            return;</span>
        }
<span class="nc" id="L1255">        final long now = System.currentTimeMillis();</span>
<span class="nc" id="L1256">        final long responseTime = mController.getLastGoodResponseTime();</span>
<span class="nc" id="L1257">        AlertList alerts = mController.getAlertList();</span>
<span class="nc" id="L1258">        mHasWarning = false;</span>
<span class="nc" id="L1259">        mHasError = false;</span>

<span class="nc bnc" id="L1261" title="All 2 branches missed.">        if (mResponseError != null) {</span>
<span class="nc" id="L1262">            alerts.remove(mResponseError);</span>
        }

<span class="nc bnc" id="L1265" title="All 4 branches missed.">        if ((responseTime) != 0 &amp;&amp;</span>
                ((now - responseTime) &gt;= 2 * DateUtils.MINUTE_IN_MILLIS)) {
<span class="nc" id="L1267">            CharSequence relativeTime =</span>
<span class="nc" id="L1268">                    DateUtils.getRelativeTimeSpanString(responseTime,</span>
                            now,
                            DateUtils.MINUTE_IN_MILLIS,
                            0);
<span class="nc" id="L1272">            CharSequence s = mContext.getString(R.string.stop_info_old_data,</span>
                    relativeTime);
<span class="nc" id="L1274">            mResponseError = new ResponseError(s);</span>
<span class="nc" id="L1275">            alerts.insert(mResponseError, 0);</span>
        }

        // If there is a warning or error alert, and show the alert icon in the header

<span class="nc bnc" id="L1280" title="All 2 branches missed.">        for (int i = 0; i &lt; alerts.getCount(); i++) {</span>
<span class="nc" id="L1281">            AlertList.Alert a = alerts.getItem(i);</span>
<span class="nc bnc" id="L1282" title="All 2 branches missed.">            if (a.getType() == AlertList.Alert.TYPE_WARNING) {</span>
<span class="nc" id="L1283">                mHasWarning = true;</span>
            }
<span class="nc bnc" id="L1285" title="All 2 branches missed.">            if (a.getType() == AlertList.Alert.TYPE_ERROR) {</span>
<span class="nc" id="L1286">                mHasError = true;</span>
            }
        }

<span class="nc bnc" id="L1290" title="All 2 branches missed.">        if (mHasError) {</span>
            //UIHelp.showViewWithAnimation(mAlertView, mShortAnimationDuration);
<span class="nc" id="L1292">            mAlertView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1293">            mAlertView.setColorFilter(mResources.getColor(R.color.alert_icon_error));</span>
<span class="nc" id="L1294">            mAlertView.setContentDescription(</span>
<span class="nc" id="L1295">                    mResources.getString(R.string.alert_content_description_error));</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">        } else if (mHasWarning) {</span>
            //UIHelp.showViewWithAnimation(mAlertView, mShortAnimationDuration);
<span class="nc" id="L1298">            mAlertView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1299">            mAlertView.setColorFilter(mResources.getColor(R.color.alert_icon_warning));</span>
<span class="nc" id="L1300">            mAlertView.setContentDescription(</span>
<span class="nc" id="L1301">                    mResources.getString(R.string.alert_content_description_warning));</span>
        } else {
            // Don't show the header icon for info-level or no alerts
            //UIHelp.hideViewWithAnimation(mAlertView, mShortAnimationDuration);
<span class="nc" id="L1305">            mAlertView.setVisibility(View.GONE);</span>
<span class="nc" id="L1306">            mAlertView.setContentDescription(&quot;&quot;);</span>
        }
<span class="nc" id="L1308">    }</span>

<span class="nc" id="L1310">    private ShowHiddenAlert mShowHiddenAlert = null;</span>

    private static class ShowHiddenAlert implements AlertList.Alert {

        private final CharSequence mString;

        private final Controller mController;

<span class="nc" id="L1318">        ShowHiddenAlert(CharSequence seq, Controller controller) {</span>
<span class="nc" id="L1319">            mString = seq;</span>
<span class="nc" id="L1320">            mController = controller;</span>
<span class="nc" id="L1321">        }</span>

        @Override
        public String getId() {
<span class="nc" id="L1325">            return &quot;STATIC: SHOW HIDDEN ALERT&quot;;</span>
        }

        @Override
        public int getType() {
<span class="nc" id="L1330">            return TYPE_SHOW_HIDDEN_ALERTS;</span>
        }

        @Override
        public int getFlags() {
<span class="nc" id="L1335">            return FLAG_HASMORE;</span>
        }

        @Override
        public CharSequence getString() {
<span class="nc" id="L1340">            return mString;</span>
        }

        @Override
        public void onClick() {
<span class="nc" id="L1345">            ObaContract.ServiceAlerts.showAllAlerts();</span>
<span class="nc" id="L1346">            mController.refresh();</span>
<span class="nc" id="L1347">        }</span>

        @Override
        public int hashCode() {
<span class="nc" id="L1351">            return getId().hashCode();</span>
        }

        @Override
        public boolean equals(Object obj) {
<span class="nc bnc" id="L1356" title="All 2 branches missed.">            if (this == obj) {</span>
<span class="nc" id="L1357">                return true;</span>
            }
<span class="nc bnc" id="L1359" title="All 2 branches missed.">            if (obj == null) {</span>
<span class="nc" id="L1360">                return false;</span>
            }
<span class="nc bnc" id="L1362" title="All 2 branches missed.">            if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L1363">                return false;</span>
            }
<span class="nc" id="L1365">            ShowHiddenAlert other = (ShowHiddenAlert) obj;</span>
<span class="nc" id="L1366">            return getId().equals(other.getId());</span>
        }
    }

    private void refreshHiddenAlerts() {
<span class="nc bnc" id="L1371" title="All 2 branches missed.">        if (mController == null) {</span>
<span class="nc" id="L1372">            return;</span>
        }
<span class="nc" id="L1374">        AlertList alerts = mController.getAlertList();</span>
<span class="nc" id="L1375">        mIsAlertHidden = alerts.isAlertHidden();</span>

<span class="nc bnc" id="L1377" title="All 2 branches missed.">        if (mShowHiddenAlert != null) {</span>
<span class="nc" id="L1378">            alerts.remove(mShowHiddenAlert);</span>
        }

<span class="nc bnc" id="L1381" title="All 2 branches missed.">        if (mIsAlertHidden) {</span>
<span class="nc" id="L1382">            CharSequence cs = mContext.getResources()</span>
<span class="nc" id="L1383">                    .getQuantityString(R.plurals.alert_filter_text, alerts.getHiddenAlertCount(),</span>
<span class="nc" id="L1384">                            alerts.getHiddenAlertCount());</span>
<span class="nc" id="L1385">            mShowHiddenAlert = new ShowHiddenAlert(cs, mController);</span>
<span class="nc" id="L1386">            alerts.insert(mShowHiddenAlert, alerts.getCount());</span>
        }
<span class="nc" id="L1388">    }</span>

    synchronized void beginNameEdit(String initial) {
        // If we can click on this, then we're definitely not
        // editable, so we should go into edit mode.
<span class="nc bnc" id="L1393" title="All 2 branches missed.">        mEditNameView.setText((initial != null) ? initial : mNameView.getText());</span>
<span class="nc" id="L1394">        mNameContainerView.setVisibility(View.GONE);</span>
<span class="nc" id="L1395">        mFilterGroup.setVisibility(View.GONE);</span>
<span class="nc" id="L1396">        mStopFavorite.setVisibility(View.GONE);</span>
<span class="nc" id="L1397">        mEtaContainer1.setVisibility(View.GONE);</span>
<span class="nc" id="L1398">        mEtaSeparator.setVisibility(View.GONE);</span>
<span class="nc" id="L1399">        mEtaContainer2.setVisibility(View.GONE);</span>
<span class="nc" id="L1400">        mNoArrivals.setVisibility(View.GONE);</span>
<span class="nc" id="L1401">        mAlertView.setVisibility(View.GONE);</span>

        // Save mExpandCollapse visibility state
<span class="nc" id="L1404">        cachedExpandCollapseViewVisibility = mExpandCollapse.getVisibility();</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">        if (!UIUtils.canAnimateViewModern()) {</span>
            // View won't disappear without clearing the legacy rotation animation
<span class="nc" id="L1407">            mExpandCollapse.clearAnimation();</span>
        }
<span class="nc" id="L1409">        mExpandCollapse.setVisibility(View.GONE);</span>
<span class="nc" id="L1410">        mEditNameContainerView.setVisibility(View.VISIBLE);</span>

        // When editing the stop name, the header size is always the same.
        // Only set the height if we're not showing any arrivals (originally commented out as a
        // workaround to #314, but we shouldn't have the same issue if the header isn't in the
        // sliding panel - the only case where we're allowing the user to hide arrivals in the
        // header)
<span class="nc bnc" id="L1417" title="All 2 branches missed.">        if (!mShowArrivals) {</span>
<span class="nc" id="L1418">            setHeaderSize(HEADER_HEIGHT_EDIT_NAME_DP);</span>
        }

<span class="nc" id="L1421">        mEditNameView.requestFocus();</span>
<span class="nc" id="L1422">        mEditNameView.setSelection(mEditNameView.getText().length());</span>
<span class="nc" id="L1423">        mInNameEdit = true;</span>

        // Open soft keyboard if no physical keyboard is open
<span class="nc" id="L1426">        UIUtils.openKeyboard(mContext);</span>
<span class="nc" id="L1427">    }</span>

    synchronized void endNameEdit() {
<span class="nc" id="L1430">        mInNameEdit = false;</span>
<span class="nc" id="L1431">        mNameContainerView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1432">        mEditNameContainerView.setVisibility(View.GONE);</span>
<span class="nc" id="L1433">        mStopFavorite.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1434">        mExpandCollapse.setVisibility(cachedExpandCollapseViewVisibility);</span>
<span class="nc" id="L1435">        mNoArrivals.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L1436" title="All 4 branches missed.">        if (mHasError || mHasWarning) {</span>
<span class="nc" id="L1437">            mAlertView.setVisibility(View.VISIBLE);</span>
        }
        // Hide soft keyboard
<span class="nc" id="L1440">        UIUtils.closeKeyboard(mContext, mEditNameView);</span>
<span class="nc" id="L1441">        refresh();</span>
<span class="nc" id="L1442">    }</span>

    /**
     * Closes any open status popups displayed by the header
     */
    public void closeStatusPopups() {
<span class="nc bnc" id="L1448" title="All 2 branches missed.">        if (mPopup1 != null) {</span>
<span class="nc" id="L1449">            mPopup1.dismiss();</span>
        }
<span class="nc bnc" id="L1451" title="All 2 branches missed.">        if (mPopup2 != null) {</span>
<span class="nc" id="L1452">            mPopup2.dismiss();</span>
        }
<span class="nc" id="L1454">    }</span>

    public void showProgress(boolean visibility) {
<span class="nc bnc" id="L1457" title="All 2 branches missed.">        if (mProgressBar == null)</span>
<span class="nc" id="L1458">            return;</span>

<span class="nc bnc" id="L1460" title="All 2 branches missed.">        if (visibility) {</span>
<span class="nc" id="L1461">            mProgressBar.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L1463">            mProgressBar.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L1465">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>