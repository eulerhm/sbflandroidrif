<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TravelBehaviorManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.travelbehavior</a> &gt; <span class="el_source">TravelBehaviorManager.java</span></div><h1>TravelBehaviorManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2019 University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.travelbehavior;

import android.app.AlertDialog;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.graphics.drawable.Drawable;
import android.os.Build;
import android.text.Html;
import android.text.TextUtils;
import android.util.Log;
import android.util.Patterns;
import android.view.LayoutInflater;
import android.view.View;
import android.widget.CheckBox;
import android.widget.EditText;
import android.widget.Toast;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.drawable.DrawableCompat;
import androidx.work.Constraints;
import androidx.work.Data;
import androidx.work.NetworkType;
import androidx.work.OneTimeWorkRequest;
import androidx.work.WorkInfo;
import androidx.work.WorkManager;
import com.google.android.gms.location.ActivityRecognition;
import com.google.android.gms.location.ActivityTransition;
import com.google.android.gms.location.ActivityTransitionRequest;
import com.google.android.gms.location.DetectedActivity;
import com.google.android.gms.tasks.Task;
import com.google.common.util.concurrent.FutureCallback;
import com.google.common.util.concurrent.Futures;
import com.google.common.util.concurrent.ListenableFuture;
import com.google.firebase.analytics.FirebaseAnalytics;
import org.checkerframework.checker.nullness.compatqual.NullableDecl;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.elements.ObaArrivalInfo;
import org.onebusaway.android.travelbehavior.constants.TravelBehaviorConstants;
import org.onebusaway.android.travelbehavior.io.TravelBehaviorFileSaverExecutorManager;
import org.onebusaway.android.travelbehavior.io.task.ArrivalAndDepartureDataSaverTask;
import org.onebusaway.android.travelbehavior.io.task.DestinationReminderDataSaverTask;
import org.onebusaway.android.travelbehavior.io.task.TripPlanDataSaverTask;
import org.onebusaway.android.travelbehavior.io.worker.OptOutTravelBehaviorParticipantWorker;
import org.onebusaway.android.travelbehavior.io.worker.RegisterTravelBehaviorParticipantWorker;
import org.onebusaway.android.travelbehavior.io.worker.UpdateDeviceInfoWorker;
import org.onebusaway.android.travelbehavior.receiver.TransitionBroadcastReceiver;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorFirebaseIOUtils;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorUtils;
import org.onebusaway.android.ui.HomeActivity;
import org.onebusaway.android.util.PermissionUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.opentripplanner.api.model.TripPlan;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

public class TravelBehaviorManager {

    private static final String TAG = &quot;TravelBehaviorManager&quot;;

    private Context mActivityContext;

    private Context mApplicationContext;

    private FirebaseAnalytics mFirebaseAnalytics;

<span class="nc" id="L87">    public TravelBehaviorManager(Context activityContext, Context applicationContext) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9901)) {</span>
<span class="nc" id="L89">            mActivityContext = activityContext;</span>
        }
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9902)) {</span>
<span class="nc" id="L92">            mApplicationContext = applicationContext;</span>
        }
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9903)) {</span>
<span class="nc" id="L95">            mFirebaseAnalytics = FirebaseAnalytics.getInstance(activityContext);</span>
        }
<span class="nc" id="L97">    }</span>

    public void registerTravelBehaviorParticipant() {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9904)) {</span>
<span class="nc" id="L101">            registerTravelBehaviorParticipant(false);</span>
        }
<span class="nc" id="L103">    }</span>

    public void registerTravelBehaviorParticipant(boolean forceStart) {
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9905)) {</span>
            // Do not register if enrolling is no more allowed;
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (!TravelBehaviorUtils.allowEnrollMoreParticipantsInStudy()) {</span>
<span class="nc" id="L109">                return;</span>
            }
        }
<span class="nc" id="L112">        boolean isUserOptOut = PreferenceUtils.getBoolean(TravelBehaviorConstants.USER_OPT_OUT, false);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9907)) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            if (forceStart)</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9906)) {</span>
<span class="nc" id="L116">                    isUserOptOut = false;</span>
                }
        }
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9910)) {</span>
            // If user opt out or Global switch is off then do nothing
<span class="nc bnc" id="L121" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(9908) ? (!TravelBehaviorUtils.isTravelBehaviorActiveInRegion() &amp;&amp; isUserOptOut) : (!TravelBehaviorUtils.isTravelBehaviorActiveInRegion() || isUserOptOut))) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9909)) {</span>
<span class="nc" id="L123">                    stopCollectingData();</span>
                }
<span class="nc" id="L125">                return;</span>
            }
        }
<span class="nc" id="L128">        boolean isUserOptIn = PreferenceUtils.getBoolean(TravelBehaviorConstants.USER_OPT_IN, false);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9912)) {</span>
            // If the user not opt in yet
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (!isUserOptIn) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9911)) {</span>
<span class="nc" id="L133">                    showParticipationDialog();</span>
                }
            }
        }
<span class="nc" id="L137">    }</span>

    private void showParticipationDialog() {
<span class="nc" id="L140">        View v = LayoutInflater.from(mActivityContext).inflate(R.layout.research_participation_dialog, null);</span>
<span class="nc" id="L141">        CheckBox neverShowDialog = v.findViewById(R.id.research_never_ask_again);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9913)) {</span>
<span class="nc" id="L143">            new AlertDialog.Builder(mActivityContext).setView(v).setTitle(R.string.travel_behavior_opt_in_title).setIcon(createIcon()).setCancelable(false).setPositiveButton(R.string.travel_behavior_dialog_learn_more, (dialog, which) -&gt; showAgeDialog()).setNegativeButton(R.string.travel_behavior_dialog_not_now, (dialog, which) -&gt; {</span>
                // If the user has chosen not to see the dialog again opt them out of the study, otherwise do nothing so they are prompted again later
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (neverShowDialog.isChecked()) {</span>
<span class="nc" id="L146">                    optOutUser();</span>
<span class="nc" id="L147">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics, mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_out_at_first_dialog), null);</span>
                } else {
<span class="nc" id="L149">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics, mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_enroll_not_now), null);</span>
                }
<span class="nc" id="L151">            }).create().show();</span>
        }
<span class="nc" id="L153">    }</span>

    private void showAgeDialog() {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9914)) {</span>
<span class="nc" id="L157">            new AlertDialog.Builder(mActivityContext).setMessage(R.string.travel_behavior_age_message).setTitle(R.string.travel_behavior_opt_in_title).setIcon(createIcon()).setCancelable(false).setPositiveButton(R.string.travel_behavior_dialog_yes, (dialog, which) -&gt; {</span>
<span class="nc" id="L158">                showInformedConsent();</span>
<span class="nc" id="L159">                dialog.dismiss();</span>
<span class="nc" id="L160">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics, mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_in_over_18), null);</span>
<span class="nc" id="L161">            }).setNegativeButton(R.string.travel_behavior_dialog_no, (dialog, which) -&gt; {</span>
<span class="nc" id="L162">                Toast.makeText(mApplicationContext, R.string.travel_behavior_age_invalid_message, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L163">                optOutUser();</span>
<span class="nc" id="L164">                dialog.dismiss();</span>
<span class="nc" id="L165">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics, mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_out_under_18), null);</span>
<span class="nc" id="L166">            }).create().show();</span>
        }
<span class="nc" id="L168">    }</span>

    private void showInformedConsent() {
<span class="nc" id="L171">        String consentHtml = getHtmlConsentDocument();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9915)) {</span>
<span class="nc" id="L173">            new AlertDialog.Builder(mActivityContext).setMessage(Html.fromHtml(consentHtml)).setTitle(R.string.travel_behavior_opt_in_title).setIcon(createIcon()).setCancelable(false).setPositiveButton(R.string.travel_behavior_dialog_consent_agree, (dialog, which) -&gt; {</span>
<span class="nc" id="L174">                showEmailDialog();</span>
<span class="nc" id="L175">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics, mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_in_informed_consent), null);</span>
<span class="nc" id="L176">            }).setNegativeButton(R.string.travel_behavior_dialog_consent_disagree, (dialog, which) -&gt; {</span>
<span class="nc" id="L177">                optOutUser();</span>
<span class="nc" id="L178">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics, mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_out_informed_consent), null);</span>
<span class="nc" id="L179">            }).create().show();</span>
        }
<span class="nc" id="L181">    }</span>

    private String getHtmlConsentDocument() {
<span class="nc" id="L184">        InputStream inputStream = mApplicationContext.getResources().openRawResource(R.raw.travel_behavior_informed_consent);</span>
<span class="nc" id="L185">        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span>
<span class="nc" id="L186">        byte[] buf = new byte[1024];</span>
        int len;
        try {
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9923)) {</span>
                {
<span class="nc" id="L191">                    long _loopCounter130 = 0;</span>
<span class="nc bnc" id="L192" title="All 22 branches missed.">                    while ((ListenerUtil.mutListener.listen(9922) ? ((len = inputStream.read(buf)) &gt;= -1) : (ListenerUtil.mutListener.listen(9921) ? ((len = inputStream.read(buf)) &lt;= -1) : (ListenerUtil.mutListener.listen(9920) ? ((len = inputStream.read(buf)) &gt; -1) : (ListenerUtil.mutListener.listen(9919) ? ((len = inputStream.read(buf)) &lt; -1) : (ListenerUtil.mutListener.listen(9918) ? ((len = inputStream.read(buf)) == -1) : ((len = inputStream.read(buf)) != -1))))))) {</span>
<span class="nc" id="L193">                        ListenerUtil.loopListener.listen(&quot;_loopCounter130&quot;, ++_loopCounter130);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(9917)) {</span>
<span class="nc" id="L195">                            outputStream.write(buf, 0, len);</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9924)) {</span>
<span class="nc" id="L201">                outputStream.close();</span>
            }
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9925)) {</span>
<span class="nc" id="L204">                inputStream.close();</span>
            }
<span class="nc" id="L206">        } catch (IOException e) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9916)) {</span>
<span class="nc" id="L208">                e.printStackTrace();</span>
            }
<span class="nc" id="L210">        }</span>
<span class="nc" id="L211">        return outputStream.toString();</span>
    }

    private void showEmailDialog() {
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9926)) {</span>
<span class="nc" id="L216">            showEmailDialog(null);</span>
        }
<span class="nc" id="L218">    }</span>

    private void showEmailDialog(String email) {
<span class="nc" id="L221">        LayoutInflater inflater = ((AppCompatActivity) mActivityContext).getLayoutInflater();</span>
<span class="nc" id="L222">        final View editTextView = inflater.inflate(R.layout.travel_behavior_email_dialog, null);</span>
<span class="nc" id="L223">        EditText emailEditText = editTextView.findViewById(R.id.tb_email_edittext);</span>
<span class="nc" id="L224">        EditText emailEditTextConfirm = editTextView.findViewById(R.id.tb_email_edittext_confirm);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9928)) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            if (email != null) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9927)) {</span>
<span class="nc" id="L228">                    emailEditText.setText(email);</span>
                }
            }
        }
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9929)) {</span>
<span class="nc" id="L233">            new AlertDialog.Builder(mActivityContext).setTitle(R.string.travel_behavior_opt_in_title).setMessage(R.string.travel_behavior_email_message).setIcon(createIcon()).setCancelable(false).setView(editTextView).setPositiveButton(R.string.travel_behavior_dialog_email_save, (dialog, which) -&gt; {</span>
<span class="nc" id="L234">                String currentEmail = emailEditText.getText().toString();</span>
<span class="nc" id="L235">                String currentEmailConfirm = emailEditTextConfirm.getText().toString();</span>
<span class="nc bnc" id="L236" title="All 6 branches missed.">                if (!TextUtils.isEmpty(currentEmail) &amp;&amp; Patterns.EMAIL_ADDRESS.matcher(currentEmail).matches() &amp;&amp; currentEmail.equalsIgnoreCase(currentEmailConfirm)) {</span>
<span class="nc" id="L237">                    registerUser(currentEmail);</span>
<span class="nc" id="L238">                    checkPermissions();</span>
                } else {
<span class="nc" id="L240">                    Toast.makeText(mApplicationContext, R.string.travel_behavior_email_invalid, Toast.LENGTH_LONG).show();</span>
                    // Show the dialog again if the email is invalid
<span class="nc" id="L242">                    showEmailDialog(currentEmail);</span>
                }
<span class="nc" id="L244">            }).create().show();</span>
        }
<span class="nc" id="L246">    }</span>

    private void checkPermissions() {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9937)) {</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (!PermissionUtils.hasGrantedAllPermissions(mApplicationContext, TravelBehaviorConstants.PERMISSIONS)) {</span>
<span class="nc" id="L251">                HomeActivity homeActivity = (HomeActivity) mActivityContext;</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9936)) {</span>
<span class="nc bnc" id="L253" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(9934) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.M) : (ListenerUtil.mutListener.listen(9933) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.M) : (ListenerUtil.mutListener.listen(9932) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.M) : (ListenerUtil.mutListener.listen(9931) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.M) : (ListenerUtil.mutListener.listen(9930) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.M) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M))))))) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(9935)) {</span>
                            // Request activity permission here, and then background location the subsequent callback set up in HomeActivity
<span class="nc" id="L256">                            homeActivity.requestPhysicalActivityPermission();</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L262">    }</span>

    private void registerUser(String email) {
<span class="nc" id="L265">        Data myData = new Data.Builder().putString(TravelBehaviorConstants.USER_EMAIL, email).build();</span>
<span class="nc" id="L266">        Constraints constraints = new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build();</span>
<span class="nc" id="L267">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.Builder(RegisterTravelBehaviorParticipantWorker.class).setInputData(myData).setConstraints(constraints).build();</span>
<span class="nc" id="L268">        WorkManager workManager = WorkManager.getInstance();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9938)) {</span>
<span class="nc" id="L270">            workManager.enqueue(workRequest);</span>
        }
<span class="nc" id="L272">        ListenableFuture&lt;WorkInfo&gt; listenableFuture = workManager.getWorkInfoById(workRequest.getId());</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9941)) {</span>
<span class="nc" id="L274">            Futures.addCallback(listenableFuture, new FutureCallback&lt;WorkInfo&gt;() {</span>

                @Override
                public void onSuccess(@NullableDecl WorkInfo result) {
<span class="nc" id="L278">                    AppCompatActivity activity = (AppCompatActivity) mActivityContext;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9939)) {</span>
<span class="nc" id="L280">                        activity.runOnUiThread(() -&gt; Toast.makeText(mApplicationContext, R.string.travel_behavior_enroll_success, Toast.LENGTH_LONG).show());</span>
                    }
<span class="nc" id="L282">                }</span>

                @Override
                public void onFailure(Throwable t) {
<span class="nc" id="L286">                    AppCompatActivity activity = (AppCompatActivity) mActivityContext;</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9940)) {</span>
<span class="nc" id="L288">                        activity.runOnUiThread(() -&gt; Toast.makeText(mApplicationContext, R.string.travel_behavior_enroll_fail, Toast.LENGTH_LONG).show());</span>
                    }
<span class="nc" id="L290">                }</span>
<span class="nc" id="L291">            }, TravelBehaviorFileSaverExecutorManager.getInstance().getThreadPoolExecutor());</span>
        }
<span class="nc" id="L293">    }</span>

    public static void startCollectingData(Context applicationContext) {
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9943)) {</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">            if (TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9942)) {</span>
<span class="nc" id="L299">                    new TravelBehaviorManager(null, applicationContext).startCollectingData();</span>
                }
            }
        }
<span class="fc" id="L303">    }</span>

    private void startCollectingData() {
<span class="nc" id="L306">        int[] activities = { DetectedActivity.IN_VEHICLE, DetectedActivity.ON_BICYCLE, DetectedActivity.WALKING, DetectedActivity.STILL, DetectedActivity.RUNNING };</span>
<span class="nc" id="L307">        List&lt;ActivityTransition&gt; transitions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9946)) {</span>
            {
<span class="nc" id="L310">                long _loopCounter131 = 0;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                for (int activity : activities) {</span>
<span class="nc" id="L312">                    ListenerUtil.loopListener.listen(&quot;_loopCounter131&quot;, ++_loopCounter131);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9944)) {</span>
<span class="nc" id="L314">                        transitions.add(new ActivityTransition.Builder().setActivityType(activity).setActivityTransition(ActivityTransition.ACTIVITY_TRANSITION_ENTER).build());</span>
                    }
<span class="nc bnc" id="L316" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9945)) {</span>
<span class="nc" id="L317">                        transitions.add(new ActivityTransition.Builder().setActivityType(activity).setActivityTransition(ActivityTransition.ACTIVITY_TRANSITION_EXIT).build());</span>
                    }
                }
            }
        }
<span class="nc" id="L322">        ActivityTransitionRequest atr = new ActivityTransitionRequest(transitions);</span>
<span class="nc" id="L323">        Intent intent = new Intent(mApplicationContext, TransitionBroadcastReceiver.class);</span>
        int flags;
<span class="nc bnc" id="L325" title="All 22 branches missed.">        if ((ListenerUtil.mutListener.listen(9951) ? (android.os.Build.VERSION.SDK_INT &lt;= android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(9950) ? (android.os.Build.VERSION.SDK_INT &gt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(9949) ? (android.os.Build.VERSION.SDK_INT &lt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(9948) ? (android.os.Build.VERSION.SDK_INT != android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(9947) ? (android.os.Build.VERSION.SDK_INT == android.os.Build.VERSION_CODES.S) : (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S))))))) {</span>
<span class="nc" id="L326">            flags = PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_MUTABLE;</span>
        } else {
<span class="nc" id="L328">            flags = PendingIntent.FLAG_UPDATE_CURRENT;</span>
        }
<span class="nc" id="L330">        PendingIntent pi = PendingIntent.getBroadcast(mApplicationContext, 100, intent, flags);</span>
<span class="nc" id="L331">        Task&lt;Void&gt; task = ActivityRecognition.getClient(mApplicationContext).requestActivityTransitionUpdates(atr, pi);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9952)) {</span>
<span class="nc" id="L333">            task.addOnCompleteListener(task1 -&gt; {</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                if (task1.isSuccessful()) {</span>
<span class="nc" id="L335">                    Log.d(TAG, &quot;Travel behavior activity-transition-update set up&quot;);</span>
                } else {
<span class="nc" id="L337">                    TravelBehaviorFirebaseIOUtils.logErrorMessage(task1.getException(), &quot;Travel behavior activity-transition-update failed set up: &quot;);</span>
                }
<span class="nc" id="L339">            });</span>
        }
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9953)) {</span>
<span class="nc" id="L342">            saveDeviceInformation();</span>
        }
<span class="nc" id="L344">    }</span>

    private void saveDeviceInformation() {
<span class="nc" id="L347">        String uid = PreferenceUtils.getString(TravelBehaviorConstants.USER_ID);</span>
<span class="nc" id="L348">        Data myData = new Data.Builder().putString(TravelBehaviorConstants.USER_ID, uid).build();</span>
<span class="nc" id="L349">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.Builder(UpdateDeviceInfoWorker.class).setInputData(myData).build();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9954)) {</span>
<span class="nc" id="L351">            WorkManager.getInstance().enqueue(workRequest);</span>
        }
<span class="nc" id="L353">    }</span>

    public void stopCollectingData() {
<span class="nc" id="L356">        Intent intent = new Intent(mApplicationContext, TransitionBroadcastReceiver.class);</span>
        int flags;
<span class="nc bnc" id="L358" title="All 22 branches missed.">        if ((ListenerUtil.mutListener.listen(9959) ? (android.os.Build.VERSION.SDK_INT &lt;= android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(9958) ? (android.os.Build.VERSION.SDK_INT &gt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(9957) ? (android.os.Build.VERSION.SDK_INT &lt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(9956) ? (android.os.Build.VERSION.SDK_INT != android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(9955) ? (android.os.Build.VERSION.SDK_INT == android.os.Build.VERSION_CODES.S) : (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S))))))) {</span>
<span class="nc" id="L359">            flags = PendingIntent.FLAG_NO_CREATE | PendingIntent.FLAG_MUTABLE;</span>
        } else {
<span class="nc" id="L361">            flags = PendingIntent.FLAG_NO_CREATE;</span>
        }
<span class="nc" id="L363">        PendingIntent pi = PendingIntent.getBroadcast(mApplicationContext, 100, intent, flags);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9962)) {</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (pi != null) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9960)) {</span>
<span class="nc" id="L367">                    ActivityRecognition.getClient(mApplicationContext).removeActivityUpdates(pi);</span>
                }
<span class="nc bnc" id="L369" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9961)) {</span>
<span class="nc" id="L370">                    pi.cancel();</span>
                }
            }
        }
<span class="nc" id="L374">    }</span>

    private Drawable createIcon() {
<span class="nc" id="L377">        Drawable icon = mApplicationContext.getResources().getDrawable(R.drawable.ic_light_bulb);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9963)) {</span>
<span class="nc" id="L379">            DrawableCompat.setTint(icon, mApplicationContext.getResources().getColor(R.color.theme_primary));</span>
        }
<span class="nc" id="L381">        return icon;</span>
    }

    public static void optOutUser() {
<span class="nc bnc" id="L385" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9964)) {</span>
<span class="nc" id="L386">            PreferenceUtils.saveBoolean(TravelBehaviorConstants.USER_OPT_OUT, true);</span>
        }
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9965)) {</span>
<span class="nc" id="L389">            PreferenceUtils.saveBoolean(TravelBehaviorConstants.USER_OPT_IN, false);</span>
        }
<span class="nc" id="L391">    }</span>

    public static void optOutUserOnServer() {
<span class="nc" id="L394">        String uid = PreferenceUtils.getString(TravelBehaviorConstants.USER_ID);</span>
<span class="nc" id="L395">        Data myData = new Data.Builder().putString(TravelBehaviorConstants.USER_ID, uid).build();</span>
<span class="nc" id="L396">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.Builder(OptOutTravelBehaviorParticipantWorker.class).setInputData(myData).build();</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9966)) {</span>
<span class="nc" id="L398">            WorkManager.getInstance().enqueue(workRequest);</span>
        }
<span class="nc" id="L400">    }</span>

    public static void optInUser(String uid) {
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9967)) {</span>
<span class="nc" id="L404">            PreferenceUtils.saveString(TravelBehaviorConstants.USER_ID, uid);</span>
        }
<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9968)) {</span>
<span class="nc" id="L407">            PreferenceUtils.saveBoolean(TravelBehaviorConstants.USER_OPT_IN, true);</span>
        }
<span class="nc bnc" id="L409" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9969)) {</span>
<span class="nc" id="L410">            PreferenceUtils.saveBoolean(TravelBehaviorConstants.USER_OPT_OUT, false);</span>
        }
<span class="nc" id="L412">    }</span>

    public static void saveDestinationReminders(String currStopId, String destStopId, String tripId, String routeId, Long serverTime) {
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9971)) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">            if (TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc" id="L417">                DestinationReminderDataSaverTask saverTask = new DestinationReminderDataSaverTask(currStopId, destStopId, tripId, routeId, serverTime, Application.get().getApplicationContext());</span>
<span class="nc" id="L418">                TravelBehaviorFileSaverExecutorManager manager = TravelBehaviorFileSaverExecutorManager.getInstance();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9970)) {</span>
<span class="nc" id="L420">                    manager.runTask(saverTask);</span>
                }
            }
        }
<span class="nc" id="L424">    }</span>

    public static void saveArrivalInfo(ObaArrivalInfo[] info, String url, long serverTime, String stopId) {
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9973)) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            if (TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc" id="L429">                ArrivalAndDepartureDataSaverTask saverTask = new ArrivalAndDepartureDataSaverTask(info, serverTime, url, stopId, Application.get().getApplicationContext());</span>
<span class="nc" id="L430">                TravelBehaviorFileSaverExecutorManager manager = TravelBehaviorFileSaverExecutorManager.getInstance();</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9972)) {</span>
<span class="nc" id="L432">                    manager.runTask(saverTask);</span>
                }
            }
        }
<span class="nc" id="L436">    }</span>

    public static void saveTripPlan(TripPlan tripPlan, String url, Context applicationContext) {
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9975)) {</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">            if (TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc" id="L441">                TripPlanDataSaverTask dataSaverTask = new TripPlanDataSaverTask(tripPlan, url, applicationContext);</span>
<span class="nc" id="L442">                TravelBehaviorFileSaverExecutorManager executorManager = TravelBehaviorFileSaverExecutorManager.getInstance();</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9974)) {</span>
<span class="nc" id="L444">                    executorManager.runTask(dataSaverTask);</span>
                }
            }
        }
<span class="nc" id="L448">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>