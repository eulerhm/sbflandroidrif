<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RealtimeService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.directions.realtime</a> &gt; <span class="el_source">RealtimeService.java</span></div><h1>RealtimeService.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2016 Cambridge Systematics, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.directions.realtime;

import android.app.Activity;
import android.app.AlarmManager;
import android.app.IntentService;
import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.util.Log;
import androidx.core.app.NotificationCompat;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.directions.model.ItineraryDescription;
import org.onebusaway.android.directions.tasks.TripRequest;
import org.onebusaway.android.directions.util.OTPConstants;
import org.onebusaway.android.directions.util.TripRequestBuilder;
import org.opentripplanner.api.model.Itinerary;
import org.opentripplanner.api.model.Leg;
import org.opentripplanner.api.model.TripPlan;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * This service is started after a trip is planned by the user so they can be notified if the
 * trip results for their request change in the near future. For example, if a user plans a trip,
 * and then the top result for that trip gets delayed by 20 minutes, the user will be notified
 * that new trip results are available.
 */
public class RealtimeService extends IntentService {

    private static final String TAG = &quot;RealtimeService&quot;;

    private static final String ITINERARY_DESC = &quot;.ItineraryDesc&quot;;

    private static final String ITINERARY_END_DATE = &quot;.ItineraryEndDate&quot;;

    public RealtimeService() {
<span class="nc" id="L60">        super(&quot;RealtimeService&quot;);</span>
<span class="nc" id="L61">    }</span>

    /**
     * Start realtime updates.
     *
     * @param source Activity from which updates are started
     * @param bundle Bundle with selected itinerary/parameters
     */
    public static void start(Activity source, Bundle bundle) {
<span class="nc" id="L70">        SharedPreferences prefs = Application.getPrefs();</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6118)) {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (!prefs.getBoolean(OTPConstants.PREFERENCE_KEY_LIVE_UPDATES, true)) {</span>
<span class="nc" id="L73">                return;</span>
            }
        }
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6119)) {</span>
<span class="nc" id="L77">            bundle.putSerializable(OTPConstants.NOTIFICATION_TARGET, source.getClass());</span>
        }
<span class="nc" id="L79">        Intent intent = new Intent(OTPConstants.INTENT_START_CHECKS);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6120)) {</span>
<span class="nc" id="L81">            intent.putExtras(bundle);</span>
        }
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6121)) {</span>
<span class="nc" id="L84">            source.sendBroadcast(intent);</span>
        }
<span class="nc" id="L86">    }</span>

    @Override
    public void onHandleIntent(Intent intent) {
<span class="nc" id="L90">        Bundle bundle = intent.getExtras();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6126)) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (intent.getAction().equals(OTPConstants.INTENT_START_CHECKS)) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6123)) {</span>
<span class="nc" id="L94">                    disableListenForTripUpdates();</span>
                }
<span class="nc bnc" id="L96" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6125)) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                    if (!rescheduleRealtimeUpdates(bundle)) {</span>
<span class="nc" id="L98">                        Itinerary itinerary = getItinerary(bundle);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6124)) {</span>
<span class="nc" id="L100">                            startRealtimeUpdates(bundle, itinerary);</span>
                        }
<span class="nc" id="L102">                    }</span>
                }
<span class="nc bnc" id="L104" title="All 2 branches missed.">            } else if (intent.getAction().equals(OTPConstants.INTENT_CHECK_TRIP_TIME)) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6122)) {</span>
<span class="nc" id="L106">                    checkForItineraryChange(bundle);</span>
                }
            }
        }
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6127)) {</span>
<span class="nc" id="L111">            RealtimeWakefulReceiver.completeWakefulIntent(intent);</span>
        }
<span class="nc" id="L113">    }</span>

    // Depending on preferences / whether there is realtime info, start updates.
    private void startRealtimeUpdates(Bundle params, Itinerary itinerary) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6128)) {</span>
<span class="nc" id="L118">            Log.d(TAG, &quot;Checking whether to start realtime updates.&quot;);</span>
        }
<span class="nc" id="L120">        boolean realtimeLegsOnItineraries = false;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6131)) {</span>
            {
<span class="nc" id="L123">                long _loopCounter60 = 0;</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">                for (Leg leg : itinerary.legs) {</span>
<span class="nc" id="L125">                    ListenerUtil.loopListener.listen(&quot;_loopCounter60&quot;, ++_loopCounter60);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6130)) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                        if (leg.realTime) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6129)) {</span>
<span class="nc" id="L129">                                realtimeLegsOnItineraries = true;</span>
                            }
                        }
                    }
<span class="nc" id="L133">                }</span>
            }
        }
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6135)) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (realtimeLegsOnItineraries) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6133)) {</span>
<span class="nc" id="L139">                    Log.d(TAG, &quot;Starting realtime updates for itinerary&quot;);</span>
                }
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6134)) {</span>
                    // init alarm mgr
<span class="nc" id="L143">                    getAlarmManager().setInexactRepeating(AlarmManager.RTC, new Date().getTime(), OTPConstants.DEFAULT_UPDATE_INTERVAL_TRIP_TIME, getAlarmIntent(params));</span>
                }
            } else {
<span class="nc bnc" id="L146" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6132)) {</span>
<span class="nc" id="L147">                    Log.d(TAG, &quot;No realtime legs on itinerary&quot;);</span>
                }
            }
        }
<span class="nc" id="L151">    }</span>

    /**
     * Check to see if the start of real-time trip updates should be rescheduled, and if necessary
     * reschedule it
     *
     * @param bundle trip details to be passed to TripRequestBuilder constructor
     * @return true if the start of trip real-time updates has been rescheduled, false if updates
     * should begin immediately
     */
    private boolean rescheduleRealtimeUpdates(Bundle bundle) {
        // Delay if this trip doesn't start for at least an hour
<span class="nc" id="L163">        Date start = new TripRequestBuilder(bundle).getDateTime();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6136)) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (start == null) {</span>
                // FIXME - Figure out why sometimes the bundle is empty - see #790 and #791
<span class="nc" id="L167">                return true;</span>
            }
        }
<span class="nc bnc" id="L170" title="All 8 branches missed.">        Date queryStart = new Date((ListenerUtil.mutListener.listen(6140) ? (start.getTime() % OTPConstants.REALTIME_SERVICE_QUERY_WINDOW) : (ListenerUtil.mutListener.listen(6139) ? (start.getTime() / OTPConstants.REALTIME_SERVICE_QUERY_WINDOW) : (ListenerUtil.mutListener.listen(6138) ? (start.getTime() * OTPConstants.REALTIME_SERVICE_QUERY_WINDOW) : (ListenerUtil.mutListener.listen(6137) ? (start.getTime() + OTPConstants.REALTIME_SERVICE_QUERY_WINDOW) : (start.getTime() - OTPConstants.REALTIME_SERVICE_QUERY_WINDOW))))));</span>
<span class="nc" id="L171">        boolean reschedule = new Date().before(queryStart);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6149)) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (reschedule) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6141)) {</span>
<span class="nc" id="L175">                    Log.d(TAG, &quot;Start service at &quot; + queryStart);</span>
                }
<span class="nc" id="L177">                Intent future = new Intent(OTPConstants.INTENT_START_CHECKS);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6142)) {</span>
<span class="nc" id="L179">                    future.putExtras(bundle);</span>
                }
                int flags;
<span class="nc bnc" id="L182" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6147) ? (android.os.Build.VERSION.SDK_INT &lt;= android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6146) ? (android.os.Build.VERSION.SDK_INT &gt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6145) ? (android.os.Build.VERSION.SDK_INT &lt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6144) ? (android.os.Build.VERSION.SDK_INT != android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6143) ? (android.os.Build.VERSION.SDK_INT == android.os.Build.VERSION_CODES.S) : (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S))))))) {</span>
<span class="nc" id="L183">                    flags = PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_MUTABLE;</span>
                } else {
<span class="nc" id="L185">                    flags = PendingIntent.FLAG_CANCEL_CURRENT;</span>
                }
<span class="nc" id="L187">                PendingIntent pendingIntent = PendingIntent.getBroadcast(getApplicationContext(), 0, future, flags);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6148)) {</span>
<span class="nc" id="L189">                    getAlarmManager().set(AlarmManager.RTC_WAKEUP, queryStart.getTime(), pendingIntent);</span>
                }
            }
        }
<span class="nc" id="L193">        return reschedule;</span>
    }

    private void checkForItineraryChange(final Bundle bundle) {
<span class="nc" id="L197">        TripRequestBuilder builder = TripRequestBuilder.initFromBundleSimple(bundle);</span>
<span class="nc" id="L198">        ItineraryDescription desc = getItineraryDescription(bundle);</span>
<span class="nc" id="L199">        Class target = getNotificationTarget(bundle);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6151)) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (target == null) {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6150)) {</span>
<span class="nc" id="L203">                    disableListenForTripUpdates();</span>
                }
<span class="nc" id="L205">                return;</span>
            }
        }
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6152)) {</span>
<span class="nc" id="L209">            checkForItineraryChange(target, builder, desc);</span>
        }
<span class="nc" id="L211">    }</span>

    private void checkForItineraryChange(final Class&lt;? extends Activity&gt; source, final TripRequestBuilder builder, final ItineraryDescription itineraryDescription) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6153)) {</span>
<span class="nc" id="L215">            Log.d(TAG, &quot;Check for change&quot;);</span>
        }
<span class="nc" id="L217">        TripRequest.Callback callback = new TripRequest.Callback() {</span>

            @Override
            public void onTripRequestComplete(TripPlan tripPlan, String url) {
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6157)) {</span>
<span class="nc bnc" id="L222" title="All 26 branches missed.">                    if ((ListenerUtil.mutListener.listen(6155) ? ((ListenerUtil.mutListener.listen(6154) ? (tripPlan == null &amp;&amp; tripPlan.itineraries == null) : (tripPlan == null || tripPlan.itineraries == null)) &amp;&amp; tripPlan.itineraries.isEmpty()) : ((ListenerUtil.mutListener.listen(6154) ? (tripPlan == null &amp;&amp; tripPlan.itineraries == null) : (tripPlan == null || tripPlan.itineraries == null)) || tripPlan.itineraries.isEmpty()))) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6156)) {</span>
<span class="nc" id="L224">                            onTripRequestFailure(-1, null);</span>
                        }
<span class="nc" id="L226">                        return;</span>
                    }
                }
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6181)) {</span>
                    {
<span class="nc" id="L231">                        long _loopCounter61 = 0;</span>
                        // or has a lower rank.
<span class="nc bnc" id="L233" title="All 22 branches missed.">                        for (int i = 0; (ListenerUtil.mutListener.listen(6180) ? (i &gt;= tripPlan.itineraries.size()) : (ListenerUtil.mutListener.listen(6179) ? (i &lt;= tripPlan.itineraries.size()) : (ListenerUtil.mutListener.listen(6178) ? (i &gt; tripPlan.itineraries.size()) : (ListenerUtil.mutListener.listen(6177) ? (i != tripPlan.itineraries.size()) : (ListenerUtil.mutListener.listen(6176) ? (i == tripPlan.itineraries.size()) : (i &lt; tripPlan.itineraries.size())))))); i++) {</span>
<span class="nc" id="L234">                            ListenerUtil.loopListener.listen(&quot;_loopCounter61&quot;, ++_loopCounter61);</span>
<span class="nc" id="L235">                            ItineraryDescription other = new ItineraryDescription(tripPlan.itineraries.get(i));</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6175)) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                                if (itineraryDescription.itineraryMatches(other)) {</span>
<span class="nc" id="L238">                                    long delay = itineraryDescription.getDelay(other);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(6158)) {</span>
<span class="nc" id="L240">                                        Log.d(TAG, &quot;Schedule deviation on itinerary: &quot; + delay);</span>
                                    }
<span class="nc bnc" id="L242" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(6172)) {</span>
<span class="nc bnc" id="L243" title="All 22 branches missed.">                                        if ((ListenerUtil.mutListener.listen(6163) ? (Math.abs(delay) &gt;= OTPConstants.REALTIME_SERVICE_DELAY_THRESHOLD) : (ListenerUtil.mutListener.listen(6162) ? (Math.abs(delay) &lt;= OTPConstants.REALTIME_SERVICE_DELAY_THRESHOLD) : (ListenerUtil.mutListener.listen(6161) ? (Math.abs(delay) &lt; OTPConstants.REALTIME_SERVICE_DELAY_THRESHOLD) : (ListenerUtil.mutListener.listen(6160) ? (Math.abs(delay) != OTPConstants.REALTIME_SERVICE_DELAY_THRESHOLD) : (ListenerUtil.mutListener.listen(6159) ? (Math.abs(delay) == OTPConstants.REALTIME_SERVICE_DELAY_THRESHOLD) : (Math.abs(delay) &gt; OTPConstants.REALTIME_SERVICE_DELAY_THRESHOLD))))))) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(6164)) {</span>
<span class="nc" id="L245">                                                Log.d(TAG, &quot;Notify due to large early/late schedule deviation.&quot;);</span>
                                            }
<span class="nc bnc" id="L247" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(6170)) {</span>
<span class="nc bnc" id="L248" title="All 22 branches missed.">                                                showNotification(itineraryDescription, ((ListenerUtil.mutListener.listen(6169) ? (delay &gt;= 0) : (ListenerUtil.mutListener.listen(6168) ? (delay &lt;= 0) : (ListenerUtil.mutListener.listen(6167) ? (delay &lt; 0) : (ListenerUtil.mutListener.listen(6166) ? (delay != 0) : (ListenerUtil.mutListener.listen(6165) ? (delay == 0) : (delay &gt; 0))))))) ? R.string.trip_plan_delay : R.string.trip_plan_early, R.string.trip_plan_notification_new_plan_text, source, builder.getBundle(), tripPlan.itineraries);</span>
                                            }
<span class="nc bnc" id="L250" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(6171)) {</span>
<span class="nc" id="L251">                                                disableListenForTripUpdates();</span>
                                            }
<span class="nc" id="L253">                                            return;</span>
                                        }
                                    }
<span class="nc bnc" id="L256" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(6173)) {</span>
                                        // Otherwise, we are still good.
<span class="nc" id="L258">                                        Log.d(TAG, &quot;Itinerary exists and no large schedule deviation.&quot;);</span>
                                    }
<span class="nc bnc" id="L260" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(6174)) {</span>
<span class="nc" id="L261">                                        checkDisableDueToTimeout(itineraryDescription);</span>
                                    }
<span class="nc" id="L263">                                    return;</span>
                                }
                            }
                        }
                    }
                }
<span class="nc bnc" id="L269" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6182)) {</span>
<span class="nc" id="L270">                    Log.d(TAG, &quot;Did not find a matching itinerary in new call - notify user that something has changed.&quot;);</span>
                }
<span class="nc bnc" id="L272" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6183)) {</span>
<span class="nc" id="L273">                    showNotification(itineraryDescription, R.string.trip_plan_notification_new_plan_title, R.string.trip_plan_notification_new_plan_text, source, builder.getBundle(), tripPlan.itineraries);</span>
                }
<span class="nc bnc" id="L275" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6184)) {</span>
<span class="nc" id="L276">                    disableListenForTripUpdates();</span>
                }
<span class="nc" id="L278">            }</span>

            @Override
            public void onTripRequestFailure(int result, String url) {
<span class="nc bnc" id="L282" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6185)) {</span>
<span class="nc" id="L283">                    Log.e(TAG, &quot;Failure checking itineraries. Result=&quot; + result + &quot;, url=&quot; + url);</span>
                }
<span class="nc bnc" id="L285" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6186)) {</span>
<span class="nc" id="L286">                    disableListenForTripUpdates();</span>
                }
<span class="nc" id="L288">            }</span>
        };
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6187)) {</span>
<span class="nc" id="L291">            builder.setListener(callback);</span>
        }
        try {
<span class="nc bnc" id="L294" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6190)) {</span>
<span class="nc" id="L295">                builder.execute();</span>
            }
<span class="nc" id="L297">        } catch (Exception e) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6188)) {</span>
<span class="nc" id="L299">                e.printStackTrace();</span>
            }
<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6189)) {</span>
<span class="nc" id="L302">                disableListenForTripUpdates();</span>
            }
<span class="nc" id="L304">        }</span>
<span class="nc" id="L305">    }</span>

    private void showNotification(ItineraryDescription description, int title, int message, Class&lt;? extends Activity&gt; notificationTarget, Bundle params, List&lt;Itinerary&gt; itineraries) {
<span class="nc" id="L308">        String titleText = getResources().getString(title);</span>
<span class="nc" id="L309">        String messageText = getResources().getString(message);</span>
<span class="nc" id="L310">        Intent openIntent = new Intent(getApplicationContext(), notificationTarget);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6191)) {</span>
<span class="nc" id="L312">            openIntent.putExtras(params);</span>
        }
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6192)) {</span>
<span class="nc" id="L315">            openIntent.putExtra(OTPConstants.INTENT_SOURCE, OTPConstants.Source.NOTIFICATION);</span>
        }
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6193)) {</span>
<span class="nc" id="L318">            openIntent.putExtra(OTPConstants.ITINERARIES, (ArrayList&lt;Itinerary&gt;) itineraries);</span>
        }
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6194)) {</span>
<span class="nc" id="L321">            openIntent.setFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
        }
        int flags;
<span class="nc bnc" id="L324" title="All 22 branches missed.">        if ((ListenerUtil.mutListener.listen(6199) ? (android.os.Build.VERSION.SDK_INT &lt;= android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6198) ? (android.os.Build.VERSION.SDK_INT &gt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6197) ? (android.os.Build.VERSION.SDK_INT &lt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6196) ? (android.os.Build.VERSION.SDK_INT != android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6195) ? (android.os.Build.VERSION.SDK_INT == android.os.Build.VERSION_CODES.S) : (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S))))))) {</span>
<span class="nc" id="L325">            flags = PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_MUTABLE;</span>
        } else {
<span class="nc" id="L327">            flags = PendingIntent.FLAG_CANCEL_CURRENT;</span>
        }
<span class="nc" id="L329">        PendingIntent openPendingIntent = PendingIntent.getActivity(getApplicationContext(), 0, openIntent, flags);</span>
<span class="nc" id="L330">        NotificationCompat.Builder mBuilder = new NotificationCompat.Builder(getApplicationContext(), Application.CHANNEL_TRIP_PLAN_UPDATES_ID).setSmallIcon(R.drawable.ic_stat_notification).setContentTitle(titleText).setStyle(new NotificationCompat.BigTextStyle().bigText(messageText)).setContentText(messageText).setPriority(NotificationCompat.PRIORITY_MAX).setContentIntent(openPendingIntent);</span>
<span class="nc" id="L331">        NotificationManager notificationManager = (NotificationManager) getApplicationContext().getSystemService(Context.NOTIFICATION_SERVICE);</span>
<span class="nc" id="L332">        Notification notification = mBuilder.build();</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6200)) {</span>
<span class="nc" id="L334">            notification.defaults = Notification.DEFAULT_ALL;</span>
        }
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6201)) {</span>
<span class="nc" id="L337">            notification.flags |= Notification.FLAG_AUTO_CANCEL | Notification.FLAG_SHOW_LIGHTS;</span>
        }
<span class="nc" id="L339">        Integer notificationId = description.getId();</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6202)) {</span>
<span class="nc" id="L341">            notificationManager.notify(notificationId, notification);</span>
        }
<span class="nc" id="L343">    }</span>

    // If the end time for this itinerary has passed, disable trip updates.
    private void checkDisableDueToTimeout(ItineraryDescription itineraryDescription) {
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6205)) {</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (itineraryDescription.isExpired()) {</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6203)) {</span>
<span class="nc" id="L350">                    Log.d(TAG, &quot;End of trip has passed.&quot;);</span>
                }
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6204)) {</span>
<span class="nc" id="L353">                    disableListenForTripUpdates();</span>
                }
            }
        }
<span class="nc" id="L357">    }</span>

    public void disableListenForTripUpdates() {
<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6206)) {</span>
<span class="nc" id="L361">            Log.d(TAG, &quot;Disable trip updates.&quot;);</span>
        }
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6207)) {</span>
<span class="nc" id="L364">            getAlarmManager().cancel(getAlarmIntent(null));</span>
        }
<span class="nc" id="L366">    }</span>

    private AlarmManager getAlarmManager() {
<span class="nc" id="L369">        return (AlarmManager) getApplicationContext().getSystemService(Context.ALARM_SERVICE);</span>
    }

    private PendingIntent getAlarmIntent(Bundle bundle) {
<span class="nc" id="L373">        Intent intent = new Intent(OTPConstants.INTENT_CHECK_TRIP_TIME);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6209)) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            if (bundle != null) {</span>
<span class="nc" id="L376">                Bundle extras = getSimplifiedBundle(bundle);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6208)) {</span>
<span class="nc" id="L378">                    intent.putExtras(extras);</span>
                }
            }
        }
        int flags;
<span class="nc bnc" id="L383" title="All 22 branches missed.">        if ((ListenerUtil.mutListener.listen(6214) ? (android.os.Build.VERSION.SDK_INT &lt;= android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6213) ? (android.os.Build.VERSION.SDK_INT &gt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6212) ? (android.os.Build.VERSION.SDK_INT &lt; android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6211) ? (android.os.Build.VERSION.SDK_INT != android.os.Build.VERSION_CODES.S) : (ListenerUtil.mutListener.listen(6210) ? (android.os.Build.VERSION.SDK_INT == android.os.Build.VERSION_CODES.S) : (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S))))))) {</span>
<span class="nc" id="L384">            flags = PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_MUTABLE;</span>
        } else {
<span class="nc" id="L386">            flags = PendingIntent.FLAG_UPDATE_CURRENT;</span>
        }
<span class="nc" id="L388">        PendingIntent alarmIntent = PendingIntent.getBroadcast(getApplicationContext(), 0, intent, flags);</span>
<span class="nc" id="L389">        return alarmIntent;</span>
    }

    private Itinerary getItinerary(Bundle bundle) {
<span class="nc" id="L393">        ArrayList&lt;Itinerary&gt; itineraries = (ArrayList&lt;Itinerary&gt;) bundle.getSerializable(OTPConstants.ITINERARIES);</span>
<span class="nc" id="L394">        int i = bundle.getInt(OTPConstants.SELECTED_ITINERARY);</span>
<span class="nc" id="L395">        return itineraries.get(i);</span>
    }

    private ItineraryDescription getItineraryDescription(Bundle bundle) {
<span class="nc" id="L399">        String[] ids = bundle.getStringArray(ITINERARY_DESC);</span>
<span class="nc" id="L400">        long date = bundle.getLong(ITINERARY_END_DATE);</span>
<span class="nc" id="L401">        return new ItineraryDescription(Arrays.asList(ids), new Date(date));</span>
    }

    private Class getNotificationTarget(Bundle bundle) {
<span class="nc" id="L405">        String name = bundle.getString(OTPConstants.NOTIFICATION_TARGET);</span>
        try {
<span class="nc" id="L407">            return Class.forName(name);</span>
<span class="nc" id="L408">        } catch (ClassNotFoundException e) {</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6215)) {</span>
<span class="nc" id="L410">                Log.e(TAG, &quot;unable to find class for name &quot; + name);</span>
            }
        }
<span class="nc" id="L413">        return null;</span>
    }

    private Bundle getSimplifiedBundle(Bundle params) {
<span class="nc" id="L417">        Itinerary itinerary = getItinerary(params);</span>
<span class="nc" id="L418">        ItineraryDescription desc = new ItineraryDescription(itinerary);</span>
<span class="nc" id="L419">        Bundle extras = new Bundle();</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6216)) {</span>
<span class="nc" id="L421">            new TripRequestBuilder(params).copyIntoBundleSimple(extras);</span>
        }
<span class="nc" id="L423">        List&lt;String&gt; idList = desc.getTripIds();</span>
<span class="nc" id="L424">        String[] ids = idList.toArray(new String[idList.size()]);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6217)) {</span>
<span class="nc" id="L426">            extras.putStringArray(ITINERARY_DESC, ids);</span>
        }
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6218)) {</span>
<span class="nc" id="L429">            extras.putLong(ITINERARY_END_DATE, desc.getEndDate().getTime());</span>
        }
<span class="nc" id="L431">        Class&lt;? extends Activity&gt; source = (Class&lt;? extends Activity&gt;) params.getSerializable(OTPConstants.NOTIFICATION_TARGET);</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6219)) {</span>
<span class="nc" id="L433">            extras.putString(OTPConstants.NOTIFICATION_TARGET, source.getName());</span>
        }
<span class="nc" id="L435">        return extras;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>