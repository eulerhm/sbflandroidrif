<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnimationUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.map.googlemapsv2</a> &gt; <span class="el_source">AnimationUtil.java</span></div><h1>AnimationUtil.java</h1><pre class="source lang-java linenums">/* Copyright 2013 Google Inc.
   Licensed under Apache 2.0: http://www.apache.org/licenses/LICENSE-2.0.html
   Source - https://gist.github.com/broady/6314689
   Video - https://www.youtube.com/watch?v=WKfZsCKSXVQ&amp;feature=youtu.be
   */

package org.onebusaway.android.map.googlemapsv2;

import com.google.android.gms.maps.model.LatLng;
import com.google.android.gms.maps.model.Marker;

import android.animation.ObjectAnimator;
import android.animation.TypeEvaluator;
import android.animation.ValueAnimator;
import android.annotation.TargetApi;
import android.os.Build;
import android.os.Handler;
import android.os.SystemClock;
import android.util.Property;
import android.view.animation.AccelerateDecelerateInterpolator;
import android.view.animation.Interpolator;

/**
 * Animation utilities for markers with Maps API.
 *
 * Note - this class must remain in this .map.googleMapsv2 package so that the Google build flavors
 * work correctly.
 */
<span class="nc" id="L29">public class AnimationUtil {</span>

    /**
     * Animates a marker from it's current position to the provided finalPosition
     *
     * @param marker        marker to animate
     * @param finalPosition the final position of the marker after the animation
     */
    public static void animateMarkerTo(final Marker marker, final LatLng finalPosition) {
        // Use the appropriate implementation per API Level
<span class="nc bnc" id="L39" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.ICE_CREAM_SANDWICH) {</span>
<span class="nc" id="L40">            animateMarkerToICS(marker, finalPosition);</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">        } else if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB_MR1) {</span>
<span class="nc" id="L42">            animateMarkerToHC(marker, finalPosition);</span>
        } else {
<span class="nc" id="L44">            animateMarkerToGB(marker, finalPosition);</span>
        }
<span class="nc" id="L46">    }</span>

    private static void animateMarkerToGB(final Marker marker, final LatLng finalPosition) {
<span class="nc" id="L49">        final LatLngInterpolator latLngInterpolator = new LatLngInterpolator.Linear();</span>
<span class="nc" id="L50">        final LatLng startPosition = marker.getPosition();</span>
<span class="nc" id="L51">        final Handler handler = new Handler();</span>
<span class="nc" id="L52">        final long start = SystemClock.uptimeMillis();</span>
<span class="nc" id="L53">        final Interpolator interpolator = new AccelerateDecelerateInterpolator();</span>
<span class="nc" id="L54">        final float durationInMs = 3000;</span>

<span class="nc" id="L56">        handler.post(new Runnable() {</span>
            long elapsed;

            float t;

            float v;

            @Override
            public void run() {
                // Calculate progress using interpolator
<span class="nc" id="L66">                elapsed = SystemClock.uptimeMillis() - start;</span>
<span class="nc" id="L67">                t = elapsed / durationInMs;</span>
<span class="nc" id="L68">                v = interpolator.getInterpolation(t);</span>

<span class="nc" id="L70">                marker.setPosition(latLngInterpolator.interpolate(v, startPosition, finalPosition));</span>

                // Repeat till progress is complete.
<span class="nc bnc" id="L73" title="All 2 branches missed.">                if (t &lt; 1) {</span>
                    // Post again 16ms later.
<span class="nc" id="L75">                    handler.postDelayed(this, 16);</span>
                }
<span class="nc" id="L77">            }</span>
        });
<span class="nc" id="L79">    }</span>

    @TargetApi(Build.VERSION_CODES.HONEYCOMB_MR1)
    private static void animateMarkerToHC(final Marker marker, final LatLng finalPosition) {
<span class="nc" id="L83">        final LatLngInterpolator latLngInterpolator = new LatLngInterpolator.Linear();</span>
<span class="nc" id="L84">        final LatLng startPosition = marker.getPosition();</span>

<span class="nc" id="L86">        ValueAnimator valueAnimator = new ValueAnimator();</span>
<span class="nc" id="L87">        valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {</span>
            @Override
            public void onAnimationUpdate(ValueAnimator animation) {
<span class="nc" id="L90">                float v = animation.getAnimatedFraction();</span>
<span class="nc" id="L91">                LatLng newPosition = latLngInterpolator</span>
<span class="nc" id="L92">                        .interpolate(v, startPosition, finalPosition);</span>
<span class="nc" id="L93">                marker.setPosition(newPosition);</span>
<span class="nc" id="L94">            }</span>
        });
<span class="nc" id="L96">        valueAnimator.setFloatValues(0, 1); // Ignored.</span>
<span class="nc" id="L97">        valueAnimator.setDuration(3000);</span>
<span class="nc" id="L98">        valueAnimator.start();</span>
<span class="nc" id="L99">    }</span>

    @TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH)
    private static void animateMarkerToICS(Marker marker, LatLng finalPosition) {
<span class="nc" id="L103">        final LatLngInterpolator latLngInterpolator = new LatLngInterpolator.Linear();</span>
<span class="nc" id="L104">        TypeEvaluator&lt;LatLng&gt; typeEvaluator = new TypeEvaluator&lt;LatLng&gt;() {</span>
            @Override
            public LatLng evaluate(float fraction, LatLng startValue, LatLng endValue) {
<span class="nc" id="L107">                return latLngInterpolator.interpolate(fraction, startValue, endValue);</span>
            }
        };
<span class="nc" id="L110">        Property&lt;Marker, LatLng&gt; property = Property.of(Marker.class, LatLng.class, &quot;position&quot;);</span>
<span class="nc" id="L111">        ObjectAnimator animator = ObjectAnimator</span>
<span class="nc" id="L112">                .ofObject(marker, property, typeEvaluator, finalPosition);</span>
<span class="nc" id="L113">        animator.setDuration(3000);</span>
<span class="nc" id="L114">        animator.start();</span>
<span class="nc" id="L115">    }</span>

    /**
     * For other LatLngInterpolator interpolators, see https://gist.github.com/broady/6314689
     */
    interface LatLngInterpolator {

        LatLng interpolate(float fraction, LatLng a, LatLng b);

<span class="nc" id="L124">        class Linear implements LatLngInterpolator {</span>

            @Override
            public LatLng interpolate(float fraction, LatLng a, LatLng b) {
<span class="nc" id="L128">                double lat = (b.latitude - a.latitude) * fraction + a.latitude;</span>
<span class="nc" id="L129">                double lngDelta = b.longitude - a.longitude;</span>

                // Take the shortest path across the 180th meridian.
<span class="nc bnc" id="L132" title="All 2 branches missed.">                if (Math.abs(lngDelta) &gt; 180) {</span>
<span class="nc" id="L133">                    lngDelta -= Math.signum(lngDelta) * 360;</span>
                }
<span class="nc" id="L135">                double lng = lngDelta * fraction + a.longitude;</span>
<span class="nc" id="L136">                return new LatLng(lat, lng);</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>