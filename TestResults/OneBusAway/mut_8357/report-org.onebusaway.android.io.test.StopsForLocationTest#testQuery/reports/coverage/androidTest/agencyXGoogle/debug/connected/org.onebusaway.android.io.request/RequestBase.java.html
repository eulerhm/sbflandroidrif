<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.io.request</a> &gt; <span class="el_source">RequestBase.java</span></div><h1>RequestBase.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2010-2016 Paul Watts (paulcwatts@gmail.com)
 * University of South Florida (cagricetin@mail.usf.edu)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.io.request;

import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.ObaConnection;
import org.onebusaway.android.io.ObaContext;
import android.content.Context;
import android.net.Uri;
import android.os.Build;
import android.util.Log;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.Reader;
import java.net.HttpURLConnection;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * The base class for Oba requests.
 *
 * @author Paul Watts (paulcwatts@gmail.com)
 */
public class RequestBase {

    private static final String TAG = &quot;RequestBase&quot;;

    protected final Uri mUri;

    protected final String mPostData;

<span class="fc" id="L45">    protected RequestBase(Uri uri) {</span>
<span class="fc" id="L46">        mUri = uri;</span>
<span class="fc" id="L47">        mPostData = null;</span>
<span class="fc" id="L48">    }</span>

<span class="nc" id="L50">    protected RequestBase(Uri uri, String postData) {</span>
<span class="nc" id="L51">        mUri = uri;</span>
<span class="nc" id="L52">        mPostData = postData;</span>
<span class="nc" id="L53">    }</span>

    public Uri getUri() {
<span class="nc" id="L56">        return mUri;</span>
    }

    public static class BuilderBase {

        protected static final String BASE_PATH = &quot;api/where&quot;;

        protected final Uri.Builder mBuilder;

        protected ObaContext mObaContext;

        protected Context mContext;

<span class="fc" id="L69">        protected boolean mIsOtp = false;</span>

        protected BuilderBase(Context context, String path) {
<span class="fc" id="L72">            this(context, null, path);</span>
<span class="fc" id="L73">        }</span>

<span class="fc" id="L75">        protected BuilderBase(Context context, ObaContext obaContext, String path) {</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8445)) {</span>
<span class="fc" id="L77">                mContext = context;</span>
            }
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8446)) {</span>
<span class="fc" id="L80">                mObaContext = obaContext;</span>
            }
<span class="fc" id="L82">            mBuilder = new Uri.Builder();</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8447)) {</span>
<span class="fc" id="L84">                mBuilder.path(path);</span>
            }
<span class="fc" id="L86">        }</span>

        protected static String getPathWithId(String pathElement, String id) {
<span class="nc" id="L89">            StringBuilder builder = new StringBuilder(BASE_PATH);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8448)) {</span>
<span class="nc" id="L91">                builder.append(pathElement);</span>
            }
<span class="nc bnc" id="L93" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8449)) {</span>
<span class="nc" id="L94">                builder.append(Uri.encode(id));</span>
            }
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8450)) {</span>
<span class="nc" id="L97">                builder.append(&quot;.json&quot;);</span>
            }
<span class="nc" id="L99">            return builder.toString();</span>
        }

        protected Uri buildUri() {
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">            ObaContext context = (mObaContext != null) ? mObaContext : ObaApi.getDefaultContext();</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8456)) {</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">                if (mIsOtp) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8455)) {</span>
<span class="nc" id="L107">                        context.setBaseOtpUrl(mContext, mBuilder);</span>
                    }
                } else {
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8451)) {</span>
<span class="fc" id="L111">                        context.setBaseUrl(mContext, mBuilder);</span>
                    }
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8452)) {</span>
<span class="fc" id="L114">                        context.setAppInfo(mBuilder);</span>
                    }
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8453)) {</span>
<span class="fc" id="L117">                        mBuilder.appendQueryParameter(&quot;version&quot;, &quot;2&quot;);</span>
                    }
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8454)) {</span>
<span class="fc" id="L120">                        mBuilder.appendQueryParameter(&quot;key&quot;, context.getApiKey());</span>
                    }
                }
            }
<span class="fc" id="L124">            return mBuilder.build();</span>
        }

        public ObaContext getObaContext() {
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8458)) {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (mObaContext == null) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8457)) {</span>
<span class="nc" id="L131">                        mObaContext = ObaApi.getDefaultContext().clone();</span>
                    }
                }
            }
<span class="nc" id="L135">            return mObaContext;</span>
        }

        protected void setIsOtp(Boolean isOtp) {
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8459)) {</span>
<span class="nc" id="L140">                mIsOtp = isOtp;</span>
            }
<span class="nc" id="L142">        }</span>
    }

    /**
     * Subclass for BuilderBase that can handle post data as well.
     *
     * @author paulw
     */
    public static class PostBuilderBase extends BuilderBase {

        protected final Uri.Builder mPostData;

        protected PostBuilderBase(Context context, String path) {
<span class="nc" id="L155">            super(context, path);</span>
<span class="nc" id="L156">            mPostData = new Uri.Builder();</span>
<span class="nc" id="L157">        }</span>

        public String buildPostData() {
<span class="nc" id="L160">            return mPostData.build().getEncodedQuery();</span>
        }
    }

    protected &lt;T&gt; T call(Class&lt;T&gt; cls) {
<span class="fc" id="L165">        ObaApi.SerializationHandler handler = ObaApi.getSerializer(cls);</span>
<span class="fc" id="L166">        ObaConnection conn = null;</span>
        try {
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8464)) {</span>
<span class="fc" id="L169">                conn = ObaApi.getDefaultContext().getConnectionFactory().newConnection(mUri);</span>
            }
            Reader reader;
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">            if (mPostData != null) {</span>
<span class="nc" id="L173">                reader = conn.post(mPostData);</span>
            } else {
<span class="pc bpc" id="L175" title="16 of 22 branches missed.">                if ((ListenerUtil.mutListener.listen(8469) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.GINGERBREAD) : (ListenerUtil.mutListener.listen(8468) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.GINGERBREAD) : (ListenerUtil.mutListener.listen(8467) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.GINGERBREAD) : (ListenerUtil.mutListener.listen(8466) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.GINGERBREAD) : (ListenerUtil.mutListener.listen(8465) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.GINGERBREAD) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.GINGERBREAD))))))) {</span>
                    // before you read the response???
<span class="fc" id="L177">                    int responseCode = conn.getResponseCode();</span>
<span class="pc bpc" id="L178" title="16 of 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(8474) ? (responseCode &gt;= HttpURLConnection.HTTP_OK) : (ListenerUtil.mutListener.listen(8473) ? (responseCode &lt;= HttpURLConnection.HTTP_OK) : (ListenerUtil.mutListener.listen(8472) ? (responseCode &gt; HttpURLConnection.HTTP_OK) : (ListenerUtil.mutListener.listen(8471) ? (responseCode &lt; HttpURLConnection.HTTP_OK) : (ListenerUtil.mutListener.listen(8470) ? (responseCode == HttpURLConnection.HTTP_OK) : (responseCode != HttpURLConnection.HTTP_OK))))))) {</span>
<span class="nc" id="L179">                        return handler.createFromError(cls, responseCode, &quot;&quot;);</span>
                    }
                }
<span class="fc" id="L182">                reader = conn.get();</span>
            }
<span class="fc" id="L184">            T t = handler.deserialize(reader, cls);</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8476)) {</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">                if (t == null) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8475)) {</span>
<span class="nc" id="L188">                        t = handler.createFromError(cls, ObaApi.OBA_INTERNAL_ERROR, &quot;Json error&quot;);</span>
                    }
                }
            }
<span class="fc" id="L192">            return t;</span>
<span class="nc" id="L193">        } catch (FileNotFoundException e) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8460)) {</span>
<span class="nc" id="L195">                Log.e(TAG, e.toString());</span>
            }
<span class="nc" id="L197">            return handler.createFromError(cls, ObaApi.OBA_NOT_FOUND, e.toString());</span>
<span class="nc" id="L198">        } catch (IOException e) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8461)) {</span>
<span class="nc" id="L200">                Log.e(TAG, e.toString());</span>
            }
<span class="nc" id="L202">            return handler.createFromError(cls, ObaApi.OBA_IO_EXCEPTION, e.toString());</span>
        } finally {
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8463)) {</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">                if (conn != null) {</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8462)) {</span>
<span class="fc" id="L207">                        conn.disconnect();</span>
                    }
                }
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>