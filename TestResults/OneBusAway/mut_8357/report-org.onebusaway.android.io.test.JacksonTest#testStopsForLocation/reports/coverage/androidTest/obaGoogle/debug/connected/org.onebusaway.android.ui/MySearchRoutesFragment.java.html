<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySearchRoutesFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">MySearchRoutesFragment.java</span></div><h1>MySearchRoutesFragment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2010-2017 Paul Watts (paulcwatts@gmail.com),
 * University of South  Florida (sjbarbeau@gmail.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.onebusaway.android.ui;

import org.onebusaway.android.R;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.elements.ObaRoute;
import org.onebusaway.android.io.request.ObaRoutesForLocationRequest;
import org.onebusaway.android.io.request.ObaRoutesForLocationResponse;
import org.onebusaway.android.util.ArrayAdapter;
import org.onebusaway.android.util.LocationUtils;
import org.onebusaway.android.util.UIUtils;

import android.app.Activity;
import android.content.Context;
import android.location.Location;
import android.os.Bundle;
import android.view.ContextMenu;
import android.view.ContextMenu.ContextMenuInfo;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView.AdapterContextMenuInfo;
import android.widget.ListAdapter;
import android.widget.ListView;
import android.widget.TextView;

import java.util.Arrays;

import androidx.core.content.pm.ShortcutInfoCompat;
import androidx.loader.app.LoaderManager;
import androidx.loader.content.AsyncTaskLoader;
import androidx.loader.content.Loader;

<span class="nc" id="L51">public class MySearchRoutesFragment extends MySearchFragmentBase</span>
        implements LoaderManager.LoaderCallbacks&lt;ObaRoutesForLocationResponse&gt; {

    //private static final String TAG = &quot;MySearchRoutesActivity&quot;;
    private static final String QUERY_TEXT = &quot;query_text&quot;;

    public static final String TAB_NAME = &quot;search&quot;;

    private MyAdapter mAdapter;

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L63">        super.onActivityCreated(savedInstanceState);</span>

<span class="nc" id="L65">        mAdapter = new MyAdapter(getActivity());</span>
<span class="nc" id="L66">        setListAdapter(mAdapter);</span>
<span class="nc" id="L67">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater,
            ViewGroup root,
            Bundle savedInstanceState) {
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (root == null) {</span>
            // Currently in a layout without a container, so no
            // reason to create our view.
<span class="nc" id="L76">            return null;</span>
        }
<span class="nc" id="L78">        return inflater.inflate(R.layout.my_search_route_list, null);</span>
    }

    @Override
    public Loader&lt;ObaRoutesForLocationResponse&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L83">        String query = args.getString(QUERY_TEXT);</span>
<span class="nc" id="L84">        return new MyLoader(getActivity(), query, getSearchCenter());</span>
    }

    @Override
    public void onLoadFinished(Loader&lt;ObaRoutesForLocationResponse&gt; loader,
            ObaRoutesForLocationResponse response) {
<span class="nc" id="L90">        UIUtils.showProgress(this, false);</span>
        //Log.d(TAG, &quot;Loader finished&quot;);
<span class="nc" id="L92">        final int code = response.getCode();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (code == ObaApi.OBA_OK) {</span>
<span class="nc" id="L94">            setEmptyText(getString(R.string.find_hint_noresults));</span>
<span class="nc" id="L95">            mAdapter.setData(Arrays.asList(response.getRoutesForLocation()));</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        } else if (code != 0) {</span>
            // If we get anything other than a '0' error, that means
            // the server actually returned something to us,
            // (even if it was an error) so we shouldn't show
            // a 'communication' error. Just fake no results.
<span class="nc" id="L101">            setEmptyText(getString(R.string.find_hint_noresults));</span>
        } else {
<span class="nc" id="L103">            setEmptyText(getString(R.string.generic_comm_error));</span>
        }
<span class="nc" id="L105">    }</span>

    @Override
    public void onLoaderReset(Loader&lt;ObaRoutesForLocationResponse&gt; loader) {
<span class="nc" id="L109">        mAdapter.clear();</span>
<span class="nc" id="L110">    }</span>

    //
    // Base class
    //
    @Override
    protected void doSearch(String text) {
<span class="nc" id="L117">        UIUtils.showProgress(this, true);</span>
<span class="nc" id="L118">        Bundle args = new Bundle();</span>
<span class="nc" id="L119">        args.putString(QUERY_TEXT, text);</span>
<span class="nc" id="L120">        Loader&lt;?&gt; loader = getLoaderManager().restartLoader(0, args, this);</span>
<span class="nc" id="L121">        loader.onContentChanged();</span>
<span class="nc" id="L122">    }</span>

    @Override
    protected int getEditBoxHintText() {
<span class="nc" id="L126">        return R.string.search_route_hint;</span>
    }

    @Override
    protected int getMinSearchLength() {
<span class="nc" id="L131">        return 1;</span>
    }

    @Override
    protected CharSequence getHintText() {
<span class="nc" id="L136">        return getString(R.string.find_hint_nofavoriteroutes);</span>
    }

    @Override
    public void onListItemClick(ListView l, View v, int position, long id) {
        // Get the adapter (this may or may not be a SimpleCursorAdapter)
<span class="nc" id="L142">        ListAdapter adapter = l.getAdapter();</span>
<span class="nc" id="L143">        ObaRoute route = (ObaRoute) adapter.getItem(position - l.getHeaderViewsCount());</span>
<span class="nc" id="L144">        final String routeId = route.getId();</span>
<span class="nc" id="L145">        final String routeName = UIUtils.getRouteDisplayName(route);</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (isShortcutMode()) {</span>
<span class="nc" id="L148">            final ShortcutInfoCompat shortcut = UIUtils.createRouteShortcut(getContext(), routeId, routeName);</span>
<span class="nc" id="L149">            Activity activity = getActivity();</span>
<span class="nc" id="L150">            activity.setResult(Activity.RESULT_OK, shortcut.getIntent());</span>
<span class="nc" id="L151">            activity.finish();</span>
<span class="nc" id="L152">        } else {</span>
<span class="nc" id="L153">            RouteInfoActivity.start(getActivity(), routeId);</span>
        }
<span class="nc" id="L155">    }</span>

    @Override
    public void onCreateContextMenu(ContextMenu menu, View v, ContextMenuInfo menuInfo) {
<span class="nc" id="L159">        super.onCreateContextMenu(menu, v, menuInfo);</span>
<span class="nc" id="L160">        AdapterContextMenuInfo info = (AdapterContextMenuInfo) menuInfo;</span>
<span class="nc" id="L161">        final TextView text = (TextView) info.targetView.findViewById(R.id.short_name);</span>
<span class="nc" id="L162">        menu.setHeaderTitle(getString(R.string.route_name, text.getText()));</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (isShortcutMode()) {</span>
<span class="nc" id="L164">            menu.add(0, CONTEXT_MENU_DEFAULT, 0, R.string.my_context_create_shortcut);</span>
        } else {
<span class="nc" id="L166">            menu.add(0, CONTEXT_MENU_DEFAULT, 0, R.string.my_context_get_route_info);</span>
        }
<span class="nc" id="L168">        menu.add(0, CONTEXT_MENU_SHOW_ON_MAP, 0, R.string.my_context_showonmap);</span>
<span class="nc" id="L169">        final String url = getUrl(getListView(), info.position);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (url != null) {</span>
<span class="nc" id="L171">            menu.add(0, CONTEXT_MENU_SHOW_URL, 0, R.string.my_context_show_schedule);</span>
        }
<span class="nc" id="L173">        menu.add(0, CONTEXT_MENU_CREATE_SHORTCUT, 0,</span>
                R.string.my_context_create_shortcut);
<span class="nc" id="L175">    }</span>

    @Override
    public boolean onContextItemSelected(MenuItem item) {
<span class="nc" id="L179">        AdapterContextMenuInfo info = (AdapterContextMenuInfo) item.getMenuInfo();</span>
<span class="nc bnc" id="L180" title="All 5 branches missed.">        switch (item.getItemId()) {</span>
            case CONTEXT_MENU_DEFAULT:
                // Fake a click
<span class="nc" id="L183">                onListItemClick(getListView(), info.targetView, info.position, info.id);</span>
<span class="nc" id="L184">                return true;</span>
            case CONTEXT_MENU_SHOW_ON_MAP:
<span class="nc" id="L186">                HomeActivity.start(getActivity(), getId(getListView(), info.position));</span>
<span class="nc" id="L187">                return true;</span>
            case CONTEXT_MENU_SHOW_URL:
<span class="nc" id="L189">                UIUtils.goToUrl(getActivity(), getUrl(getListView(), info.position));</span>
<span class="nc" id="L190">                return true;</span>
            case CONTEXT_MENU_CREATE_SHORTCUT:
<span class="nc" id="L192">                String id = QueryUtils.RouteList.getId(getListView(), info.position);</span>
<span class="nc" id="L193">                String shortName = QueryUtils.RouteList.getShortName(getListView(), info.position);</span>
<span class="nc" id="L194">                UIUtils.createRouteShortcut(getContext(), id, shortName);</span>
<span class="nc" id="L195">                return true;</span>
            default:
<span class="nc" id="L197">                return super.onContextItemSelected(item);</span>
        }
    }

    private String getId(ListView l, int position) {
<span class="nc" id="L202">        ListAdapter adapter = l.getAdapter();</span>
<span class="nc" id="L203">        ObaRoute route = (ObaRoute) adapter.getItem(position - l.getHeaderViewsCount());</span>
<span class="nc" id="L204">        return route.getId();</span>
    }

    private String getUrl(ListView l, int position) {
<span class="nc" id="L208">        ListAdapter adapter = l.getAdapter();</span>
<span class="nc" id="L209">        ObaRoute route = (ObaRoute) adapter.getItem(position - l.getHeaderViewsCount());</span>
<span class="nc" id="L210">        return route.getUrl();</span>
    }

    //
    // Adapter
    //
    private static final class MyAdapter extends ArrayAdapter&lt;ObaRoute&gt; {

        public MyAdapter(Context context) {
<span class="nc" id="L219">            super(context, R.layout.route_list_item);</span>
<span class="nc" id="L220">        }</span>

        @Override
        protected void initView(View view, ObaRoute route) {
<span class="nc" id="L224">            UIUtils.setRouteView(view, route);</span>
<span class="nc" id="L225">        }</span>
    }

    //
    // Loader
    //
    private static final class MyLoader extends AsyncTaskLoader&lt;ObaRoutesForLocationResponse&gt; {

        private final String mQueryText;

        private final Location mCenter;

        public MyLoader(Context context, String query, Location center) {
<span class="nc" id="L238">            super(context);</span>
<span class="nc" id="L239">            mQueryText = query;</span>
<span class="nc" id="L240">            mCenter = center;</span>
<span class="nc" id="L241">        }</span>

        @Override
        public ObaRoutesForLocationResponse loadInBackground() {
<span class="nc" id="L245">            ObaRoutesForLocationResponse response =</span>
<span class="nc" id="L246">                    new ObaRoutesForLocationRequest.Builder(getContext(), mCenter)</span>
<span class="nc" id="L247">                            .setQuery(mQueryText)</span>
<span class="nc" id="L248">                            .build()</span>
<span class="nc" id="L249">                            .call();</span>
            // If there is no results from the user-centered query,
            // open a wider next in some &quot;default&quot; location
            //Log.d(TAG, &quot;Server returns: &quot; + response.getCode());
<span class="nc bnc" id="L253" title="All 2 branches missed.">            if (response.getCode() == ObaApi.OBA_OK) {</span>
<span class="nc" id="L254">                ObaRoute[] routes = response.getRoutesForLocation();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                if (routes.length != 0) {</span>
<span class="nc" id="L256">                    return response;</span>
                }
            }

<span class="nc" id="L260">            Location center = LocationUtils.getDefaultSearchCenter();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (center != null) {</span>
<span class="nc" id="L262">                return new ObaRoutesForLocationRequest.Builder(getContext(), center)</span>
<span class="nc" id="L263">                        .setRadius(LocationUtils.DEFAULT_SEARCH_RADIUS)</span>
<span class="nc" id="L264">                        .setQuery(mQueryText)</span>
<span class="nc" id="L265">                        .build()</span>
<span class="nc" id="L266">                        .call();</span>
            }
<span class="nc" id="L268">            return response;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>