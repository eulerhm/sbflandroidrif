<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NightLightActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">NightLightActivity.java</span></div><h1>NightLightActivity.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2013-2015 Colin McDonough, University of South Florida,
 * Sean J. Barbeau
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.graphics.Color;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.WindowManager;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.content.pm.ShortcutInfoCompat;
import androidx.core.content.pm.ShortcutManagerCompat;
import org.onebusaway.android.R;
import org.onebusaway.android.util.UIUtils;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * A flashing light that riders can show at night to flag bus drivers
 */
<span class="nc" id="L41">public class NightLightActivity extends AppCompatActivity {</span>

    private static final String TAG = &quot;NightLightActivity&quot;;

    private static final String PREFERENCE_SHOWED_DIALOG = &quot;showed_night_light_dialog&quot;;

    static final String INSTALL_SHORTCUT = &quot;com.android.launcher.action.INSTALL_SHORTCUT&quot;;

    private static final int COLOR_DARK = 0xCC000000;

    private boolean lightOn;

    private boolean dialogShown;

    private View screen;

<span class="nc" id="L57">    boolean active = true;</span>

    // Amount of time between flashes, in milliseconds
<span class="nc" id="L60">    private int[] waitTime = { 100, 100, 400 };</span>

    // Amount of time light is left on for single flash, in milliseconds
    private static final int FLASH_TIME_ON = 75;

<span class="nc" id="L65">    private int counter = 0;</span>

    private int[] mColors;

    private float mOldScreenBrightness;

    /**
     * Starts the activity
     */
    public static void start(Context context) {
<span class="nc" id="L75">        Intent i = new Intent(context, NightLightActivity.class);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1002)) {</span>
<span class="nc" id="L77">            context.startActivity(i);</span>
        }
<span class="nc" id="L79">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1003)) {</span>
<span class="nc" id="L84">            super.onCreate(savedInstanceState);</span>
        }
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1004)) {</span>
<span class="nc" id="L87">            UIUtils.setupActionBar(this);</span>
        }
<span class="nc" id="L89">        Intent intent = getIntent();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1007)) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if (Intent.ACTION_CREATE_SHORTCUT.equals(intent.getAction())) {</span>
<span class="nc" id="L92">                ShortcutInfoCompat shortcut = createShortcut();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1005)) {</span>
<span class="nc" id="L94">                    setResult(RESULT_OK, shortcut.getIntent());</span>
                }
<span class="nc bnc" id="L96" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1006)) {</span>
<span class="nc" id="L97">                    finish();</span>
                }
            }
        }
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1008)) {</span>
<span class="nc" id="L102">            setContentView(R.layout.night_light);</span>
        }
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1009)) {</span>
<span class="nc" id="L105">            screen = findViewById(R.id.screen);</span>
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1010)) {</span>
<span class="nc" id="L108">            disableScreenSleep();</span>
        }
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1011)) {</span>
            // Set up colors to flash on screen
<span class="nc" id="L112">            mColors = new int[3];</span>
        }
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1012)) {</span>
<span class="nc" id="L115">            mColors[0] = Color.WHITE;</span>
        }
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1013)) {</span>
<span class="nc" id="L118">            mColors[1] = getResources().getColor(R.color.theme_primary);</span>
        }
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1014)) {</span>
<span class="nc" id="L121">            mColors[2] = Color.WHITE;</span>
        }
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1015)) {</span>
<span class="nc" id="L124">            maybeShowIntroDialog();</span>
        }
<span class="nc" id="L126">    }</span>

    @Override
    public void onResume() {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1016)) {</span>
<span class="nc" id="L131">            super.onResume();</span>
        }
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1017)) {</span>
<span class="nc" id="L134">            turnLightOn();</span>
        }
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1018)) {</span>
<span class="nc" id="L137">            active = true;</span>
        }
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1039)) {</span>
            // Flash the light via a Thread
<span class="nc" id="L141">            new Thread(new Runnable() {</span>

                @Override
                public void run() {
<span class="nc bnc" id="L145" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1038)) {</span>
                        {
<span class="nc" id="L147">                            long _loopCounter12 = 0;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                            while (active) {</span>
<span class="nc" id="L149">                                ListenerUtil.loopListener.listen(&quot;_loopCounter12&quot;, ++_loopCounter12);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1020)) {</span>
<span class="nc" id="L151">                                    runOnUiThread(new Runnable() {</span>

                                        @Override
                                        public void run() {
<span class="nc bnc" id="L155" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(1019)) {</span>
<span class="nc" id="L156">                                                turnLightOn();</span>
                                            }
<span class="nc" id="L158">                                        }</span>
                                    });
                                }
<span class="nc bnc" id="L161" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1021)) {</span>
<span class="nc" id="L162">                                    Log.d(TAG, &quot;Flashing for &quot; + FLASH_TIME_ON + &quot;ms&quot;);</span>
                                }
                                try {
<span class="nc bnc" id="L165" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(1023)) {</span>
<span class="nc" id="L166">                                        Thread.sleep(FLASH_TIME_ON);</span>
                                    }
<span class="nc" id="L168">                                } catch (InterruptedException e) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(1022)) {</span>
<span class="nc" id="L170">                                        e.printStackTrace();</span>
                                    }
<span class="nc" id="L172">                                }</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1025)) {</span>
<span class="nc" id="L174">                                    runOnUiThread(new Runnable() {</span>

                                        @Override
                                        public void run() {
<span class="nc bnc" id="L178" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(1024)) {</span>
<span class="nc" id="L179">                                                turnLightOff();</span>
                                            }
<span class="nc" id="L181">                                        }</span>
                                    });
                                }
                                try {
<span class="nc bnc" id="L185" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(1031)) {</span>
<span class="nc bnc" id="L186" title="All 8 branches missed.">                                        Log.d(TAG, &quot;Sleeping for &quot; + waitTime[(ListenerUtil.mutListener.listen(1030) ? (counter / 3) : (ListenerUtil.mutListener.listen(1029) ? (counter * 3) : (ListenerUtil.mutListener.listen(1028) ? (counter - 3) : (ListenerUtil.mutListener.listen(1027) ? (counter + 3) : (counter % 3)))))] + &quot;ms&quot;);</span>
                                    }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(1036)) {</span>
<span class="nc bnc" id="L189" title="All 8 branches missed.">                                        Thread.sleep(waitTime[(ListenerUtil.mutListener.listen(1035) ? (counter / 3) : (ListenerUtil.mutListener.listen(1034) ? (counter * 3) : (ListenerUtil.mutListener.listen(1033) ? (counter - 3) : (ListenerUtil.mutListener.listen(1032) ? (counter + 3) : (counter % 3)))))]);</span>
                                    }
<span class="nc" id="L191">                                } catch (InterruptedException e) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(1026)) {</span>
<span class="nc" id="L193">                                        e.printStackTrace();</span>
                                    }
<span class="nc" id="L195">                                }</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1037)) {</span>
<span class="nc" id="L197">                                    counter++;</span>
                                }
                            }
                        }
                    }
<span class="nc" id="L202">                }</span>
<span class="nc" id="L203">            }).start();</span>
        }
<span class="nc" id="L205">    }</span>

    @Override
    public void onPause() {
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1040)) {</span>
<span class="nc" id="L210">            super.onPause();</span>
        }
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1041)) {</span>
<span class="nc" id="L213">            turnLightOff();</span>
        }
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1042)) {</span>
<span class="nc" id="L216">            active = false;</span>
        }
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1043)) {</span>
<span class="nc" id="L219">            restoreScreenBrightness();</span>
        }
<span class="nc" id="L221">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1044)) {</span>
<span class="nc" id="L226">            getMenuInflater().inflate(R.menu.night_light, menu);</span>
        }
<span class="nc" id="L228">        return super.onCreateOptionsMenu(menu);</span>
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1046)) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (item.getItemId() == R.id.create_shortcut) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1045)) {</span>
<span class="nc" id="L236">                    createShortcut();</span>
                }
<span class="nc" id="L238">                return true;</span>
            }
        }
<span class="nc" id="L241">        return false;</span>
    }

    /**
     * Called after its confirmed that the user has seen the intro dialog to start the flashing
     */
    public void onViewedDialog() {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1047)) {</span>
<span class="nc" id="L249">            dialogShown = true;</span>
        }
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1048)) {</span>
            // Set screen brightness to full
<span class="nc" id="L253">            setScreenBrightness();</span>
        }
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1049)) {</span>
<span class="nc" id="L256">            turnLightOn();</span>
        }
<span class="nc" id="L258">    }</span>

    private void disableScreenSleep() {
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1050)) {</span>
<span class="nc" id="L262">            getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);</span>
        }
<span class="nc" id="L264">    }</span>

    /**
     * Shows the initial intro dialog if the user hasn't yet seen it, and then start the flashing.
     * If the user has already seen the dialog, immediately start flashing
     */
    private void maybeShowIntroDialog() {
<span class="nc" id="L271">        final SharedPreferences sp = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1058)) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (!sp.getBoolean(PREFERENCE_SHOWED_DIALOG, false)) {</span>
<span class="nc" id="L274">                final AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1052)) {</span>
<span class="nc" id="L276">                    builder.setTitle(R.string.night_light_dialog_title);</span>
                }
<span class="nc bnc" id="L278" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1053)) {</span>
<span class="nc" id="L279">                    builder.setCancelable(false);</span>
                }
<span class="nc bnc" id="L281" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1054)) {</span>
<span class="nc" id="L282">                    builder.setPositiveButton(R.string.night_light_start, (dialog, which) -&gt; {</span>
<span class="nc" id="L283">                        sp.edit().putBoolean(PREFERENCE_SHOWED_DIALOG, true).commit();</span>
                        // Start the flashing
<span class="nc" id="L285">                        onViewedDialog();</span>
<span class="nc" id="L286">                    });</span>
                }
<span class="nc bnc" id="L288" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1055)) {</span>
<span class="nc" id="L289">                    builder.setNegativeButton(R.string.night_light_cancel, (dialog, which) -&gt; {</span>
                        // Close the activity without starting the flashing
<span class="nc" id="L291">                        finish();</span>
<span class="nc" id="L292">                    });</span>
                }
<span class="nc bnc" id="L294" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1056)) {</span>
<span class="nc" id="L295">                    builder.setMessage(R.string.night_light_dialog_message);</span>
                }
<span class="nc bnc" id="L297" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1057)) {</span>
<span class="nc" id="L298">                    builder.create().show();</span>
                }
<span class="nc" id="L300">            } else {</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1051)) {</span>
                    // Start the flashing
<span class="nc" id="L303">                    onViewedDialog();</span>
                }
            }
        }
<span class="nc" id="L307">    }</span>

    /*
     * Called by the view (see main.xml)
     */
    public void toggleLight(View view) {
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1059)) {</span>
<span class="nc" id="L314">            toggleLight();</span>
        }
<span class="nc" id="L316">    }</span>

    private void toggleLight() {
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1062)) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (lightOn) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1061)) {</span>
<span class="nc" id="L322">                    turnLightOff();</span>
                }
            } else {
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1060)) {</span>
<span class="nc" id="L326">                    turnLightOn();</span>
                }
            }
        }
<span class="nc" id="L330">    }</span>

    private void turnLightOn() {
<span class="nc bnc" id="L333" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1063)) {</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            if (!dialogShown) {</span>
<span class="nc" id="L335">                return;</span>
            }
        }
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1064)) {</span>
<span class="nc" id="L339">            lightOn = true;</span>
        }
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1069)) {</span>
            // Use the screen as a flashlight
<span class="nc bnc" id="L343" title="All 8 branches missed.">            screen.setBackgroundColor(mColors[(ListenerUtil.mutListener.listen(1068) ? (counter / 3) : (ListenerUtil.mutListener.listen(1067) ? (counter * 3) : (ListenerUtil.mutListener.listen(1066) ? (counter - 3) : (ListenerUtil.mutListener.listen(1065) ? (counter + 3) : (counter % 3)))))]);</span>
        }
<span class="nc" id="L345">    }</span>

    private void turnLightOff() {
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1072)) {</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">            if (lightOn) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1070)) {</span>
                    // Set the background to dark
<span class="nc" id="L352">                    screen.setBackgroundColor(COLOR_DARK);</span>
                }
<span class="nc bnc" id="L354" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1071)) {</span>
<span class="nc" id="L355">                    lightOn = false;</span>
                }
            }
        }
<span class="nc" id="L359">    }</span>

    private void setScreenBrightness() {
<span class="nc" id="L362">        WindowManager.LayoutParams lp = this.getWindow().getAttributes();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1073)) {</span>
<span class="nc" id="L364">            mOldScreenBrightness = lp.screenBrightness;</span>
        }
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1074)) {</span>
<span class="nc" id="L367">            lp.screenBrightness = 1.0f;</span>
        }
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1075)) {</span>
<span class="nc" id="L370">            this.getWindow().setAttributes(lp);</span>
        }
<span class="nc" id="L372">    }</span>

    private void restoreScreenBrightness() {
<span class="nc" id="L375">        WindowManager.LayoutParams lp = this.getWindow().getAttributes();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1076)) {</span>
<span class="nc" id="L377">            lp.screenBrightness = mOldScreenBrightness;</span>
        }
<span class="nc" id="L379">    }</span>

    /**
     * Create a shortcut on the home screen
     * @return shortcut info that was created
     */
    private ShortcutInfoCompat createShortcut() {
<span class="nc" id="L386">        final ShortcutInfoCompat shortcut = UIUtils.makeShortcutInfo(this, getString(R.string.stop_info_option_night_light), new Intent(this, NightLightActivity.class), R.drawable.ic_night_light);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1077)) {</span>
<span class="nc" id="L388">            ShortcutManagerCompat.requestPinShortcut(this, shortcut, null);</span>
        }
<span class="nc" id="L390">        return shortcut;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>