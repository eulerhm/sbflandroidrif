<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArrivalsListFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">ArrivalsListFragment.java</span></div><h1>ArrivalsListFragment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2012-2017 Paul Watts (paulcwatts@gmail.com),
 * University of South Florida,
 * Benjamin Du (bendu@me.com),
 * Microsoft Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.Dialog;
import android.content.ContentQueryMap;
import android.content.ContentResolver;
import android.content.ContentValues;
import android.content.Context;
import android.content.DialogInterface;
import android.content.DialogInterface.OnMultiChoiceClickListener;
import android.content.Intent;
import android.database.Cursor;
import android.location.Location;
import android.net.Uri;
import android.os.Bundle;
import android.os.Handler;
import android.text.TextUtils;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.ListAdapter;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.util.Pair;
import androidx.fragment.app.DialogFragment;
import androidx.loader.app.LoaderManager;
import androidx.loader.content.CursorLoader;
import androidx.loader.content.Loader;

import com.google.firebase.analytics.FirebaseAnalytics;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.elements.ObaArrivalInfo;
import org.onebusaway.android.io.elements.ObaReferences;
import org.onebusaway.android.io.elements.ObaRoute;
import org.onebusaway.android.io.elements.ObaSituation;
import org.onebusaway.android.io.elements.ObaStop;
import org.onebusaway.android.io.elements.ObaTrip;
import org.onebusaway.android.io.elements.Occupancy;
import org.onebusaway.android.io.elements.OccupancyState;
import org.onebusaway.android.io.request.ObaArrivalInfoResponse;
import org.onebusaway.android.map.MapParams;
import org.onebusaway.android.provider.ObaContract;
import org.onebusaway.android.report.ui.InfrastructureIssueActivity;
import org.onebusaway.android.travelbehavior.TravelBehaviorManager;
import org.onebusaway.android.util.ArrayAdapterWithIcon;
import org.onebusaway.android.util.ArrivalInfoUtils;
import org.onebusaway.android.util.BuildFlavorUtils;
import org.onebusaway.android.util.DBUtil;
import org.onebusaway.android.util.FragmentUtils;
import org.onebusaway.android.util.LocationUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.onebusaway.android.util.ShowcaseViewUtils;
import org.onebusaway.android.util.UIUtils;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

//
// We don't use the ListFragment because the support library's version of
// the ListFragment doesn't work well with our header.
//
<span class="nc" id="L97">public class ArrivalsListFragment extends ListFragment</span>
        implements LoaderManager.LoaderCallbacks&lt;ObaArrivalInfoResponse&gt;,
        ArrivalsListHeader.Controller {

    private static final String TAG = &quot;ArrivalsListFragment&quot;;

    public static final String STOP_NAME = &quot;.StopName&quot;;

    public static final String STOP_CODE = &quot;.StopCode&quot;;

    public static final String STOP_DIRECTION = &quot;.StopDir&quot;;

    /**
     * Comma-delimited set of routes that serve this stop
     * See {@link UIUtils#serializeRouteDisplayNames(ObaStop,
     * HashMap)}
     */
    public static final String STOP_ROUTES = &quot;.StopRoutes&quot;;

    public static final String STOP_LAT = &quot;.StopLatitude&quot;;

    public static final String STOP_LON = &quot;.StopLongitude&quot;;

    /**
     * If set to true, the fragment is using a header external to this layout, and shouldn't
     * instantiate its own header view
     */
    public static final String EXTERNAL_HEADER = &quot;.ExternalHeader&quot;;

    private static final long RefreshPeriod = 60 * 1000;

<span class="nc" id="L128">    private static int TRIPS_FOR_STOP_LOADER = 1;</span>

<span class="nc" id="L130">    private static int ARRIVALS_LIST_LOADER = 2;</span>

    private ArrivalsListAdapterBase mAdapter;

    private ArrivalsListHeader mHeader;

    private View mHeaderView;

    private View mFooter;

    private View mEmptyList;

    private AlertList mAlertList;

    private ObaStop mStop;

    private String mStopId;

    private Uri mStopUri;

    private ObaReferences mObaReferences;

    // The list of route_ids that should have their arrival info and alerts displayed. (All if empty or null)
    private ArrayList&lt;String&gt; mRoutesFilter;

<span class="nc" id="L155">    private int mLastResponseLength = -1; // Keep copy locally, since loader overwrites</span>

    // encapsulated info before onLoadFinished() is called
<span class="nc" id="L158">    private boolean mLoadedMoreArrivals = false;</span>

<span class="nc" id="L160">    private boolean mFavorite = false;</span>

    private String mStopUserName;

    private TripsForStopCallback mTripsForStopCallback;

    // The list of situation alerts
    private ArrayList&lt;SituationAlert&gt; mSituationAlerts;

    // Set to true if we're using an external header not in this layout (e.g., if this fragment is in a sliding panel)
<span class="nc" id="L170">    private boolean mExternalHeader = false;</span>

    private Listener mListener;

    ObaArrivalInfo[] mArrivalInfo;

    private FirebaseAnalytics mFirebaseAnalytics;

    public interface Listener {

        /**
         * Called when the ListView has been created
         *
         * @param listView the ListView that was just created
         */
        void onListViewCreated(ListView listView);

        /**
         * Called when new arrival times have been retrieved
         *
         * @param response new arrival information
         */
        void onArrivalTimesUpdated(final ObaArrivalInfoResponse response);

        /**
         * Called when the user selects the &quot;Show route on map&quot; for a particular route/trip
         *
         * @param arrivalInfo The arrival information for the route/trip that the user selected
         * @return true if the listener has consumed the event, false otherwise
         */
        boolean onShowRouteOnMapSelected(ArrivalInfo arrivalInfo);

        /**
         * Called when the user selects the &quot;Sort by&quot; option
         */
        void onSortBySelected();
    }

    /**
     * Builds an intent used to set the stop for the ArrivalListFragment directly
     * (i.e., when ArrivalsListActivity is not used)
     */
    public static class IntentBuilder {

        private Intent mIntent;

<span class="nc" id="L216">        public IntentBuilder(Context context, String stopId) {</span>
<span class="nc" id="L217">            mIntent = new Intent(context, ArrivalsListFragment.class);</span>
<span class="nc" id="L218">            mIntent.setData(Uri.withAppendedPath(ObaContract.Stops.CONTENT_URI, stopId));</span>
<span class="nc" id="L219">        }</span>

        /**
         * @param stop   ObaStop to be set
         * @param routes a HashMap of all route display names that may serve this stop - key is
         *               routeId
         */
<span class="nc" id="L226">        public IntentBuilder(Context context, ObaStop stop, HashMap&lt;String, ObaRoute&gt; routes) {</span>
<span class="nc" id="L227">            mIntent = new Intent(context, ArrivalsListFragment.class);</span>
<span class="nc" id="L228">            mIntent.setData(Uri.withAppendedPath(ObaContract.Stops.CONTENT_URI, stop.getId()));</span>
<span class="nc" id="L229">            setStopName(stop.getName());</span>
<span class="nc" id="L230">            setStopCode(stop.getStopCode());</span>
<span class="nc" id="L231">            setStopDirection(stop.getDirection());</span>
<span class="nc" id="L232">            setStopRoutes(UIUtils.serializeRouteDisplayNames(stop, routes));</span>
<span class="nc" id="L233">            setStopLocation(stop.getLocation());</span>
<span class="nc" id="L234">        }</span>

        public IntentBuilder setStopName(String stopName) {
<span class="nc" id="L237">            mIntent.putExtra(ArrivalsListFragment.STOP_NAME, stopName);</span>
<span class="nc" id="L238">            return this;</span>
        }

        public IntentBuilder setStopCode(String stopCode) {
<span class="nc" id="L242">            mIntent.putExtra(ArrivalsListFragment.STOP_CODE, stopCode);</span>
<span class="nc" id="L243">            return this;</span>
        }

        public IntentBuilder setStopDirection(String stopDir) {
<span class="nc" id="L247">            mIntent.putExtra(ArrivalsListFragment.STOP_DIRECTION, stopDir);</span>
<span class="nc" id="L248">            return this;</span>
        }

        public IntentBuilder setStopLocation(Location stopLocation) {
<span class="nc" id="L252">            mIntent.putExtra(ArrivalsListFragment.STOP_LAT, stopLocation.getLatitude());</span>
<span class="nc" id="L253">            mIntent.putExtra(ArrivalsListFragment.STOP_LON, stopLocation.getLongitude());</span>
<span class="nc" id="L254">            return this;</span>
        }

        /**
         * Sets the routes that serve this stop via a comma-delimited set of route display names
         * &lt;p/&gt;
         * See {@link UIUtils#serializeRouteDisplayNames(ObaStop,
         * HashMap)}
         *
         * @param routes comma-delimited list of route display names that serve this stop
         */
        public IntentBuilder setStopRoutes(String routes) {
<span class="nc" id="L266">            mIntent.putExtra(ArrivalsListFragment.STOP_ROUTES, routes);</span>
<span class="nc" id="L267">            return this;</span>
        }

        public Intent build() {
<span class="nc" id="L271">            return mIntent;</span>
        }
    }

    @Override
    public View onCreateView(LayoutInflater inflater,
                             ViewGroup root, Bundle savedInstanceState) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (root == null) {</span>
            // Currently in a layout without a container, so no
            // reason to create our view.
<span class="nc" id="L281">            return null;</span>
        }

<span class="nc" id="L284">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(getContext());</span>

<span class="nc" id="L286">        initArrivalInfoViews(inflater);</span>

<span class="nc" id="L288">        return inflater.inflate(R.layout.fragment_arrivals_list, null);</span>
    }

    @Override
    public void onViewStateRestored(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L293">        super.onViewStateRestored(savedInstanceState);</span>
        //This is required to avoid an NullPointerException when the user rotates
        // their phone while setting a route favorite - see #480
<span class="nc" id="L296">        RouteFavoriteDialogFragment dialogFragment = (RouteFavoriteDialogFragment)</span>
<span class="nc" id="L297">                getFragmentManager().findFragmentByTag(RouteFavoriteDialogFragment.TAG);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (dialogFragment != null) {</span>
<span class="nc" id="L299">            setCallbackToDialogFragment(dialogFragment);</span>
        }
<span class="nc" id="L301">    }</span>

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L305">        super.onActivityCreated(savedInstanceState);</span>

        // Set the list view properties for Style B
<span class="nc" id="L308">        setListViewProperties(BuildFlavorUtils.getArrivalInfoStyleFromPreferences());</span>

        // We have a menu item to show in action bar.
<span class="nc" id="L311">        setHasOptionsMenu(true);</span>

<span class="nc" id="L313">        mAlertList = new AlertList(getActivity());</span>
<span class="nc" id="L314">        mAlertList.initView(getView().findViewById(R.id.arrivals_alert_list));</span>

<span class="nc" id="L316">        setupHeader(savedInstanceState);</span>

<span class="nc" id="L318">        setupFooter();</span>

<span class="nc" id="L320">        setupEmptyList(null);</span>

        // This sets the stopId and uri
<span class="nc" id="L323">        setStopId();</span>
<span class="nc" id="L324">        setUserInfo();</span>

        // Create an empty adapter we will use to display the loaded data
<span class="nc" id="L327">        instantiateAdapter(BuildFlavorUtils.getArrivalInfoStyleFromPreferences());</span>

        // Start out with a progress indicator.
<span class="nc" id="L330">        setListShown(false);</span>

<span class="nc" id="L332">        mRoutesFilter = ObaContract.StopRouteFilters.get(getActivity(), mStopId);</span>

<span class="nc" id="L334">        mTripsForStopCallback = new TripsForStopCallback();</span>

        //LoaderManager.enableDebugLogging(true);
<span class="nc" id="L337">        LoaderManager mgr = getLoaderManager();</span>

<span class="nc" id="L339">        mgr.initLoader(TRIPS_FOR_STOP_LOADER, null, mTripsForStopCallback);</span>
<span class="nc" id="L340">        mgr.initLoader(ARRIVALS_LIST_LOADER, getArguments(), this);</span>

        // Set initial minutesAfter value in the empty list view
<span class="nc" id="L343">        setEmptyText(</span>
<span class="nc" id="L344">                UIUtils.getNoArrivalsMessage(getActivity(), getArrivalsLoader().getMinutesAfter(),</span>
                        false, false)
        );
<span class="nc" id="L347">    }</span>

    @Override
    public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L351">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L352">        outState.putBoolean(EXTERNAL_HEADER, mExternalHeader);</span>
<span class="nc" id="L353">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L357">        mRefreshHandler.removeCallbacks(mRefresh);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (mHeader != null) {</span>
<span class="nc" id="L359">            mHeader.onPause();</span>
        }
<span class="nc" id="L361">        super.onPause();</span>
<span class="nc" id="L362">    }</span>

    @Override
    public void onResume() {
        // Make sure we're using the correct adapter based on user preferences, in case they changed
        // after the Fragment was initialized
<span class="nc" id="L368">        checkAdapterStylePreference();</span>

        // Notify listener that ListView is now created
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (mListener != null) {</span>
<span class="nc" id="L372">            mListener.onListViewCreated(getListView());</span>
        }

        // Try to show any old data just in case we're coming out of sleep
<span class="nc" id="L376">        ArrivalsListLoader loader = getArrivalsLoader();</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (loader != null) {</span>
<span class="nc" id="L378">            ObaArrivalInfoResponse lastGood = loader.getLastGoodResponse();</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">            if (lastGood != null) {</span>
<span class="nc" id="L380">                setResponseData(lastGood.getArrivalInfo(), UIUtils.getAllSituations(lastGood, mRoutesFilter),</span>
<span class="nc" id="L381">                        lastGood.getRefs());</span>
            }
        }

<span class="nc" id="L385">        getLoaderManager().restartLoader(TRIPS_FOR_STOP_LOADER, null, mTripsForStopCallback);</span>

        // If our timer would have gone off, then refresh.
<span class="nc" id="L388">        long lastResponseTime = getArrivalsLoader().getLastResponseTime();</span>
<span class="nc" id="L389">        long newPeriod = Math.min(RefreshPeriod, (lastResponseTime + RefreshPeriod)</span>
<span class="nc" id="L390">                - System.currentTimeMillis());</span>
        // Wait at least one second at least, and the full minute at most.
        //Log.d(TAG, &quot;Refresh period:&quot; + newPeriod);
<span class="nc bnc" id="L393" title="All 2 branches missed.">        if (newPeriod &lt;= 0) {</span>
<span class="nc" id="L394">            refresh();</span>
        } else {
<span class="nc" id="L396">            mRefreshHandler.postDelayed(mRefresh, newPeriod);</span>
        }

        // Refresh the favorite status and stop name, in case we're returning from another view
<span class="nc" id="L400">        setUserInfo();</span>

<span class="nc bnc" id="L402" title="All 2 branches missed.">        if (mHeader != null) {</span>
<span class="nc" id="L403">            mHeader.refresh();</span>
        }

<span class="nc" id="L406">        super.onResume();</span>
<span class="nc" id="L407">    }</span>

    @Override
    public Loader&lt;ObaArrivalInfoResponse&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L411">        return new ArrivalsListLoader(getActivity(), mStopId);</span>
    }

    //
    // This is where the bulk of the initialization takes place to create
    // this screen.
    //
    @Override
    public void onLoadFinished(Loader&lt;ObaArrivalInfoResponse&gt; loader,
                               final ObaArrivalInfoResponse result) {
<span class="nc" id="L421">        showProgress(false);</span>

<span class="nc" id="L423">        ObaArrivalInfo[] info = null;</span>
<span class="nc" id="L424">        List&lt;ObaSituation&gt; situations = null;</span>
<span class="nc" id="L425">        ObaReferences refs = null;</span>

<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (result.getCode() == ObaApi.OBA_OK) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            if (mStop == null) {</span>
<span class="nc" id="L429">                mStop = result.getStop();</span>
<span class="nc" id="L430">                DBUtil.addToDB(mStop);</span>
            }
<span class="nc" id="L432">            info = result.getArrivalInfo();</span>
<span class="nc" id="L433">            situations = UIUtils.getAllSituations(result, mRoutesFilter);</span>
<span class="nc" id="L434">            refs = result.getRefs();</span>

<span class="nc" id="L436">            TravelBehaviorManager.saveArrivalInfo(info, result.getUrl(),</span>
<span class="nc" id="L437">                    result.getCurrentTime(), mStopId);</span>

            // Report Stop distance metric
<span class="nc" id="L440">            Location stopLocation = mStop.getLocation();</span>
<span class="nc" id="L441">            Location myLocation = Application.getLastKnownLocation(getActivity(), null);</span>
<span class="nc" id="L442">            ObaAnalytics.reportViewStopEvent(mFirebaseAnalytics, mStop.getId(), mStop.getName(), myLocation, stopLocation);</span>
<span class="nc" id="L443">        } else {</span>
            // If there was a last good response, then this is a refresh
            // and we should use a toast. Otherwise, it's a initial
            // page load and we want to display the error in the empty text.
<span class="nc" id="L447">            ObaArrivalInfoResponse lastGood =</span>
<span class="nc" id="L448">                    getArrivalsLoader().getLastGoodResponse();</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">            if (lastGood != null) {</span>
                // Refresh error
<span class="nc" id="L451">                Toast.makeText(getActivity(),</span>
                        R.string.generic_comm_error_toast,
<span class="nc" id="L453">                        Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L454">                info = lastGood.getArrivalInfo();</span>
<span class="nc" id="L455">                situations = UIUtils.getAllSituations(lastGood, mRoutesFilter);</span>
            } else {
<span class="nc" id="L457">                setEmptyText(UIUtils.getStopErrorString(getActivity(), result.getCode()));</span>
            }
        }

<span class="nc" id="L461">        setResponseData(info, situations, refs);</span>

        // The list should now be shown.
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (isResumed()) {</span>
<span class="nc" id="L465">            setListShown(true);</span>
        } else {
<span class="nc bnc" id="L467" title="All 2 branches missed.">            if (isAdded()) {</span>
<span class="nc" id="L468">                setListShownNoAnimation(true);</span>
            }
        }

        // Clear any pending refreshes
<span class="nc" id="L473">        mRefreshHandler.removeCallbacks(mRefresh);</span>

        // Post an update
<span class="nc" id="L476">        mRefreshHandler.postDelayed(mRefresh, RefreshPeriod);</span>

        // If the user just tried to load more arrivals, determine if we
        // should show a Toast in the case where no additional arrivals were loaded
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (mLoadedMoreArrivals) {</span>
<span class="nc bnc" id="L481" title="All 6 branches missed.">            if (info == null || info.length == 0 || mLastResponseLength != info.length) {</span>
                /*
                Don't show the toast, since:
                 1) an error occurred (and user has already seen the error message),
                 2) no records were returned (and empty list message is already shown), or
                 3) more arrivals were actually loaded
                */
<span class="nc" id="L488">                mLoadedMoreArrivals = false;</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            } else if (mLastResponseLength == info.length) {</span>
                // No additional arrivals were included in the response, show a toast
<span class="nc" id="L491">                Toast.makeText(getActivity(),</span>
<span class="nc" id="L492">                        UIUtils.getNoArrivalsMessage(getActivity(),</span>
<span class="nc" id="L493">                                getArrivalsLoader().getMinutesAfter(), true, false),</span>
                        Toast.LENGTH_LONG
<span class="nc" id="L495">                ).show();</span>
<span class="nc" id="L496">                mLoadedMoreArrivals = false;  // Only show the toast once</span>
            }
        }

<span class="nc" id="L500">        ShowcaseViewUtils.showTutorial(ShowcaseViewUtils.TUTORIAL_ARRIVAL_SORT,</span>
<span class="nc" id="L501">                (AppCompatActivity) getActivity(), null, false);</span>

        // Notify listener that we have new arrival info
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (mListener != null) {</span>
<span class="nc" id="L505">            mListener.onArrivalTimesUpdated(result);</span>
        }
<span class="nc" id="L507">    }</span>

    @Override
    protected void showProgress(boolean visibility) {
<span class="nc" id="L511">        super.showProgress(visibility);</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (mHeader != null) {</span>
<span class="nc" id="L513">            mHeader.showProgress(visibility);</span>
        }
<span class="nc" id="L515">    }</span>

    /**
     * Sets the header for this list to be instantiated in another layout, but still controlled by
     * this fragment
     *
     * @param header     header that will be controlled by this fragment
     * @param headerView View that contains this header
     */
    public void setHeader(ArrivalsListHeader header, View headerView) {
<span class="nc" id="L525">        mHeader = header;</span>
<span class="nc" id="L526">        mHeaderView = headerView;</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (header != null) {</span>
<span class="nc" id="L528">            mHeader.initView(mHeaderView);</span>
        }
<span class="nc" id="L530">        mExternalHeader = true;</span>
<span class="nc" id="L531">    }</span>

    private void setResponseData(ObaArrivalInfo[] info, List&lt;ObaSituation&gt; situations,
                                 ObaReferences refs) {
<span class="nc" id="L535">        mArrivalInfo = info;</span>

<span class="nc" id="L537">        mObaReferences = refs;</span>

        // Convert any stop situations into a list of alerts
<span class="nc bnc" id="L540" title="All 2 branches missed.">        if (situations != null) {</span>
<span class="nc" id="L541">            refreshSituations(situations);</span>
        } else {
<span class="nc" id="L543">            refreshSituations(new ArrayList&lt;&gt;());</span>
        }

<span class="nc bnc" id="L546" title="All 2 branches missed.">        if (info != null) {</span>
<span class="nc" id="L547">            ArrivalsListLoader loader = getArrivalsLoader();</span>
            int minutesAfter;
<span class="nc bnc" id="L549" title="All 2 branches missed.">            if (loader != null) {</span>
<span class="nc" id="L550">                minutesAfter = loader.getMinutesAfter();</span>
            } else {
<span class="nc" id="L552">                minutesAfter = ArrivalsListLoader.DEFAULT_MINUTES_AFTER;</span>
            }
            // Reset the empty text just in case there is no data.
<span class="nc" id="L555">            setEmptyText(UIUtils.getNoArrivalsMessage(Application.get().getApplicationContext(),</span>
                    minutesAfter, false, false));
<span class="nc" id="L557">            mAdapter.setData(info, mRoutesFilter, System.currentTimeMillis());</span>
        }

<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (mHeader != null) {</span>
<span class="nc" id="L561">            mHeader.refresh();</span>
        }
<span class="nc" id="L563">    }</span>

    @Override
    public void onLoaderReset(Loader&lt;ObaArrivalInfoResponse&gt; loader) {
<span class="nc" id="L567">        showProgress(false);</span>
<span class="nc" id="L568">        mAdapter.setData(null, mRoutesFilter, System.currentTimeMillis());</span>

<span class="nc" id="L570">        mArrivalInfo = null;</span>

<span class="nc bnc" id="L572" title="All 2 branches missed.">        if (mHeader != null) {</span>
<span class="nc" id="L573">            mHeader.refresh();</span>
        }
<span class="nc" id="L575">    }</span>

    //
    // Action Bar / Options Menu
    //
    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span class="nc" id="L582">        inflater.inflate(R.menu.arrivals_list, menu);</span>
<span class="nc" id="L583">    }</span>

    @Override
    public void onPrepareOptionsMenu(Menu menu) {
<span class="nc bnc" id="L587" title="All 2 branches missed.">        if (!isAdded()) {</span>
            // not attached to an activity (possibly due to screen rotation)
<span class="nc" id="L589">            return;</span>
        }

<span class="nc bnc" id="L592" title="All 2 branches missed.">        String title = mFavorite ?</span>
<span class="nc" id="L593">                getString(R.string.stop_info_option_removestar) :</span>
<span class="nc" id="L594">                getString(R.string.stop_info_option_addstar);</span>
<span class="nc" id="L595">        menu.findItem(R.id.toggle_favorite)</span>
<span class="nc" id="L596">                .setTitle(title)</span>
<span class="nc" id="L597">                .setTitleCondensed(title);</span>

<span class="nc" id="L599">        MenuItem menuItemHeaderArrivals = menu.findItem(R.id.show_header_arrivals);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (mHeader != null) {</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">            title = mHeader.isShowingArrivals() ?</span>
<span class="nc" id="L602">                    getString(R.string.stop_info_option_hide_header_arrivals) :</span>
<span class="nc" id="L603">                    getString(R.string.stop_info_option_show_header_arrivals);</span>
<span class="nc" id="L604">            menuItemHeaderArrivals.setTitle(title);</span>
<span class="nc" id="L605">            menuItemHeaderArrivals.setTitleCondensed(title);</span>
        }

<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (mExternalHeader) {</span>
            // If we're using an external header, it means that this fragment is being shown
            // in the bottom sliding panel, and therefore the map is already visible.
            // So, we can remove the &quot;Show Map&quot; option
<span class="nc" id="L612">            menu.findItem(R.id.show_on_map).setVisible(false);</span>
            // We want to hide the &quot;show/hide arrivals in header&quot; setting if we are in the sliding panel
<span class="nc" id="L614">            menuItemHeaderArrivals.setVisible(false);</span>
        }
<span class="nc" id="L616">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc" id="L620">        final int id = item.getItemId();</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">        if (id == R.id.show_on_map) {</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">            if (mStop != null) {</span>
<span class="nc" id="L623">                HomeActivity.start(getActivity(), mStop);</span>
            }
<span class="nc" id="L625">            return true;</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">        } else if (id == R.id.refresh) {</span>
<span class="nc" id="L627">            refresh();</span>
<span class="nc" id="L628">            return true;</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">        } else if (id == R.id.sort_arrivals) {</span>
<span class="nc" id="L630">            ShowcaseViewUtils.doNotShowTutorial(ShowcaseViewUtils.TUTORIAL_ARRIVAL_SORT);</span>
<span class="nc" id="L631">            showSortByDialog();</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">        } else if (id == R.id.filter) {</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">            if (mStop != null) {</span>
<span class="nc" id="L634">                showRoutesFilterDialog();</span>
            }
<span class="nc bnc" id="L636" title="All 2 branches missed.">        } else if (id == R.id.show_header_arrivals) {</span>
<span class="nc" id="L637">            doShowHideHeaderArrivals();</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">        } else if (id == R.id.edit_name) {</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">            if (mHeader != null) {</span>
<span class="nc" id="L640">                mHeader.beginNameEdit(null);</span>
            }
<span class="nc bnc" id="L642" title="All 2 branches missed.">        } else if (id == R.id.toggle_favorite) {</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">            setFavoriteStop(!mFavorite);</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">            if (mHeader != null) {</span>
<span class="nc" id="L645">                mHeader.refresh();</span>
            }
<span class="nc bnc" id="L647" title="All 2 branches missed.">        } else if (id == R.id.show_stop_details) {</span>
<span class="nc" id="L648">            showStopDetailsDialog();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">        } else if (id == R.id.report_stop_problem) {</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">            if (mStop != null) {</span>
<span class="nc" id="L651">                Intent intent = makeIntent(getActivity(), mStop.getId(), mStop.getName(),</span>
<span class="nc" id="L652">                        mStop.getStopCode(), mStop.getLatitude(), mStop.getLongitude());</span>
<span class="nc" id="L653">                InfrastructureIssueActivity.startWithService(getActivity(), intent,</span>
<span class="nc" id="L654">                        getString(R.string.ri_selected_service_stop));</span>
<span class="nc" id="L655">            }</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">        } else if (id == R.id.night_light) {</span>
<span class="nc" id="L657">            NightLightActivity.start(getActivity());</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">        } else if (id == R.id.hide_alerts) {</span>
<span class="nc bnc" id="L659" title="All 4 branches missed.">            if (mSituationAlerts == null || mSituationAlerts.isEmpty()) {</span>
<span class="nc" id="L660">                return false;</span>
            }
            // Update the database to hide all currently active alerts at this stop
<span class="nc bnc" id="L663" title="All 2 branches missed.">            for (SituationAlert alert : mSituationAlerts) {</span>
<span class="nc" id="L664">                ObaContract.ServiceAlerts</span>
<span class="nc" id="L665">                        .insertOrUpdate(alert.getId(), new ContentValues(), false,</span>
<span class="nc" id="L666">                                true);</span>
<span class="nc" id="L667">            }</span>
<span class="nc" id="L668">            refresh();</span>
        }
<span class="nc" id="L670">        return false;</span>
    }

    public static Intent makeIntent(Context context,
                                    String focusId,
                                    String stopName,
                                    String stopCode,
                                    double lat,
                                    double lon) {
<span class="nc" id="L679">        Intent myIntent = new Intent(context, HomeActivity.class);</span>
<span class="nc" id="L680">        myIntent.putExtra(MapParams.STOP_ID, focusId);</span>
<span class="nc" id="L681">        myIntent.putExtra(MapParams.STOP_NAME, stopName);</span>
<span class="nc" id="L682">        myIntent.putExtra(MapParams.STOP_CODE, stopCode);</span>
<span class="nc" id="L683">        myIntent.putExtra(MapParams.CENTER_LAT, lat);</span>
<span class="nc" id="L684">        myIntent.putExtra(MapParams.CENTER_LON, lon);</span>
<span class="nc" id="L685">        return myIntent;</span>
    }

    @Override
    public void onListItemClick(ListView l, View v, int position, long id) {
<span class="nc" id="L690">        final ArrivalInfo stop = (ArrivalInfo) getListView().getItemAtPosition(position);</span>
<span class="nc" id="L691">        showListItemMenu(v, stop);</span>
<span class="nc" id="L692">    }</span>

    public void showListItemMenu(View v, final ArrivalInfo arrivalInfo) {
<span class="nc bnc" id="L695" title="All 2 branches missed.">        if (arrivalInfo == null) {</span>
<span class="nc" id="L696">            return;</span>
        }
<span class="nc" id="L698">        Log.d(TAG, &quot;Tapped on route=&quot; + arrivalInfo.getInfo().getShortName() +</span>
<span class="nc" id="L699">                &quot;, tripId=&quot; + arrivalInfo.getInfo().getTripId() +</span>
<span class="nc" id="L700">                &quot;, vehicleId=&quot; + arrivalInfo.getInfo().getVehicleId());</span>

<span class="nc" id="L702">        ArrivalsListLoader loader = getArrivalsLoader();</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">        if (loader == null) {</span>
<span class="nc" id="L704">            return;</span>
        }
<span class="nc" id="L706">        final ObaArrivalInfoResponse response = loader.getLastGoodResponse();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">        if (response == null) {</span>
<span class="nc" id="L708">            return;</span>
        }

<span class="nc" id="L711">        AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());</span>
<span class="nc" id="L712">        builder.setTitle(R.string.stop_info_item_options_title);</span>

<span class="nc" id="L714">        final String routeId = arrivalInfo.getInfo().getRouteId();</span>
<span class="nc" id="L715">        final ObaRoute route = response.getRoute(routeId);</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">        final String url = route != null ? route.getUrl() : null;</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">        final boolean hasUrl = !TextUtils.isEmpty(url);</span>
        // Check to see if the reminder is visible, for whether we show &quot;add&quot; or &quot;edit&quot; reminder
        // (we don't have any other state, so this is good enough)
<span class="nc" id="L720">        View tripView = v.findViewById(R.id.reminder);</span>
<span class="nc bnc" id="L721" title="All 4 branches missed.">        boolean isReminderVisible = tripView != null &amp;&amp; tripView.getVisibility() != View.GONE;</span>
        // Check route favorite, for whether we show &quot;Add star&quot; or &quot;Remove star&quot;
<span class="nc" id="L723">        final boolean isRouteFavorite = ObaContract.RouteHeadsignFavorites.isFavorite(routeId,</span>
<span class="nc" id="L724">                arrivalInfo.getInfo().getHeadsign(), arrivalInfo.getInfo().getStopId());</span>
        // Check to see if there is a route filter, for whether we show &quot;Show all routes&quot; or &quot;Show only this route&quot;
<span class="nc bnc" id="L726" title="All 2 branches missed.">        boolean hasRouteFilter = !mRoutesFilter.isEmpty();</span>

        final Occupancy occupancy;
        final OccupancyState occupancyState;
<span class="nc bnc" id="L730" title="All 2 branches missed.">        if (arrivalInfo.getPredictedOccupancy() != null) {</span>
<span class="nc" id="L731">            occupancy = arrivalInfo.getPredictedOccupancy();</span>
<span class="nc" id="L732">            occupancyState = OccupancyState.PREDICTED;</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">        } else if (arrivalInfo.getHistoricalOccupancy() != null) {</span>
<span class="nc" id="L734">            occupancy = arrivalInfo.getHistoricalOccupancy();</span>
<span class="nc" id="L735">            occupancyState = OccupancyState.HISTORICAL;</span>
        } else {
<span class="nc" id="L737">            occupancy = null;</span>
<span class="nc" id="L738">            occupancyState = null;</span>
        }

<span class="nc" id="L741">        List&lt;String&gt; items = UIUtils</span>
<span class="nc" id="L742">                .buildTripOptions(getActivity(), isRouteFavorite, hasUrl, isReminderVisible, hasRouteFilter, occupancy, occupancyState);</span>
<span class="nc" id="L743">        List&lt;Integer&gt; icons = UIUtils.buildTripOptionsIcons(isRouteFavorite, hasUrl, occupancy);</span>

<span class="nc" id="L745">        ListAdapter adapter = new ArrayAdapterWithIcon(getActivity(), items, icons);</span>

<span class="nc" id="L747">        builder.setAdapter(adapter, new DialogInterface.OnClickListener() {</span>
            public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L749" title="All 2 branches missed.">                if (which == 0) {</span>
                    // Show dialog for setting route favorite
<span class="nc" id="L751">                    RouteFavoriteDialogFragment routeDialog</span>
                            = new RouteFavoriteDialogFragment.Builder(
<span class="nc" id="L753">                            route.getId(), arrivalInfo.getInfo().getHeadsign())</span>
<span class="nc" id="L754">                            .setRouteShortName(route.getShortName())</span>
<span class="nc" id="L755">                            .setRouteLongName(arrivalInfo.getInfo().getRouteLongName())</span>
<span class="nc" id="L756">                            .setRouteUrl(route.getUrl())</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">                            .setStopId(arrivalInfo.getInfo().getStopId())</span>
<span class="nc" id="L758">                            .setFavorite(!isRouteFavorite)</span>
<span class="nc" id="L759">                            .build();</span>

<span class="nc" id="L761">                    setCallbackToDialogFragment(routeDialog);</span>

<span class="nc" id="L763">                    routeDialog.show(getFragmentManager(), RouteFavoriteDialogFragment.TAG);</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">                } else if (which == 1) {</span>
<span class="nc" id="L765">                    showRouteOnMap(arrivalInfo);</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">                } else if (which == 2) {</span>
<span class="nc" id="L767">                    goToTripDetails(arrivalInfo);</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">                } else if (which == 3) {</span>
<span class="nc" id="L769">                    goToTrip(arrivalInfo);</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">                } else if (which == 4) {</span>
<span class="nc" id="L771">                    ArrayList&lt;String&gt; routes = new ArrayList&lt;String&gt;(1);</span>
<span class="nc" id="L772">                    routes.add(arrivalInfo.getInfo().getRouteId());</span>
                    // toggle route filter - if user selection equals existing route filter, clear it
<span class="nc bnc" id="L774" title="All 4 branches missed.">                    if (routes.equals(mRoutesFilter) || mRoutesFilter.size() &gt; routes.size()) {</span>
<span class="nc" id="L775">                        routes.clear();</span>
                    }
<span class="nc" id="L777">                    setRoutesFilter(routes);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">                    if (mHeader != null) {</span>
<span class="nc" id="L779">                        mHeader.refresh();</span>
                    }
<span class="nc bnc" id="L781" title="All 4 branches missed.">                } else if (hasUrl &amp;&amp; which == 5) {</span>
<span class="nc" id="L782">                    UIUtils.goToUrl(getActivity(), url);</span>
<span class="nc bnc" id="L783" title="All 8 branches missed.">                } else if ((!hasUrl &amp;&amp; which == 5) || (hasUrl &amp;&amp; which == 6)) {</span>
                    // Find agency name
<span class="nc" id="L785">                    String routeId = arrivalInfo.getInfo().getRouteId();</span>
<span class="nc" id="L786">                    String agencyName = null;</span>
<span class="nc" id="L787">                    String blockId = null;</span>

<span class="nc bnc" id="L789" title="All 2 branches missed.">                    if (mObaReferences != null) {</span>
<span class="nc" id="L790">                        String agencyId = mObaReferences.getRoute(routeId).getAgencyId();</span>
<span class="nc" id="L791">                        agencyName = mObaReferences.getAgency(agencyId).getName();</span>
<span class="nc" id="L792">                        ObaTrip trip = mObaReferences.getTrip(arrivalInfo.getInfo().getTripId());</span>
<span class="nc" id="L793">                        blockId = trip.getBlockId();</span>
                    }

<span class="nc" id="L796">                    Intent intent = makeIntent(getActivity(), mStop.getId(), mStop.getName(),</span>
<span class="nc" id="L797">                            mStop.getStopCode(), mStop.getLatitude(), mStop.getLongitude());</span>

<span class="nc" id="L799">                    InfrastructureIssueActivity.startWithService(getActivity(), intent,</span>
<span class="nc" id="L800">                            getString(R.string.ri_selected_service_trip), arrivalInfo.getInfo(),</span>
                            agencyName, blockId);
<span class="nc bnc" id="L802" title="All 10 branches missed.">                } else if (occupancy != null &amp;&amp;</span>
                        ((!hasUrl &amp;&amp; which == 6) || (hasUrl &amp;&amp; which == 7))) {
<span class="nc" id="L804">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L805">                            getActivity().getString(R.string.analytics_label_button_press_about_occupancy),</span>
                            null);
<span class="nc" id="L807">                    createOccupancyDialog().show();</span>
                }
<span class="nc" id="L809">            }</span>
        });
<span class="nc" id="L811">        AlertDialog dialog = builder.create();</span>
<span class="nc" id="L812">        dialog.setOwnerActivity(getActivity());</span>
<span class="nc" id="L813">        dialog.show();</span>
<span class="nc" id="L814">    }</span>

    private void setCallbackToDialogFragment(RouteFavoriteDialogFragment routeDialog) {
<span class="nc" id="L817">        routeDialog.setCallback(new RouteFavoriteDialogFragment.Callback() {</span>
            @Override
            public void onSelectionComplete(boolean savedFavorite) {
<span class="nc bnc" id="L820" title="All 2 branches missed.">                if (savedFavorite) {</span>
<span class="nc" id="L821">                    refreshLocal();</span>
                }
<span class="nc" id="L823">            }</span>
        });
<span class="nc" id="L825">    }</span>

    public void showRouteOnMap(ArrivalInfo arrivalInfo) {
<span class="nc" id="L828">        boolean handled = false;</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">        if (mListener != null) {</span>
<span class="nc" id="L830">            handled = mListener.onShowRouteOnMapSelected(arrivalInfo);</span>
        }
        // If the event hasn't been handled by the listener, start a new activity
<span class="nc bnc" id="L833" title="All 2 branches missed.">        if (!handled) {</span>
<span class="nc" id="L834">            HomeActivity.start(getActivity(), arrivalInfo.getInfo().getRouteId());</span>
        }
<span class="nc" id="L836">    }</span>

    //
    // ActivityListHeader.Controller
    //
    @Override
    public String getStopId() {
<span class="nc" id="L843">        return mStopId;</span>
    }

    @Override
    public Location getStopLocation() {
<span class="nc" id="L848">        Location location = null;</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">        if (mStop != null) {</span>
<span class="nc" id="L850">            location = mStop.getLocation();</span>
        } else {
            // Check the arguments
<span class="nc" id="L853">            Bundle args = getArguments();</span>
<span class="nc" id="L854">            double latitude = args.getDouble(STOP_LAT);</span>
<span class="nc" id="L855">            double longitude = args.getDouble(STOP_LON);</span>
<span class="nc bnc" id="L856" title="All 4 branches missed.">            if (latitude != 0 &amp;&amp; longitude != 0) {</span>
<span class="nc" id="L857">                location = LocationUtils.makeLocation(latitude, longitude);</span>
            }
        }
<span class="nc" id="L860">        return location;</span>
    }

    @Override
    public String getStopName() {
        String name;
<span class="nc bnc" id="L866" title="All 2 branches missed.">        if (mStop != null) {</span>
<span class="nc" id="L867">            name = mStop.getName();</span>
        } else {
            // Check the arguments
<span class="nc" id="L870">            Bundle args = getArguments();</span>
<span class="nc" id="L871">            name = args.getString(STOP_NAME);</span>
        }
<span class="nc" id="L873">        return UIUtils.formatDisplayText(name);</span>
    }

    @Override
    public String getStopDirection() {
<span class="nc bnc" id="L878" title="All 2 branches missed.">        if (mStop != null) {</span>
<span class="nc" id="L879">            return mStop.getDirection();</span>
        } else {
            // Check the arguments
<span class="nc" id="L882">            Bundle args = getArguments();</span>
<span class="nc" id="L883">            return args.getString(STOP_DIRECTION);</span>
        }
    }

    /**
     * Returns a sorted list (by ETA) of arrival times for the current stop
     *
     * @return a sorted list (by ETA) of arrival times for the current stop
     */
    @Override
    public ArrayList&lt;ArrivalInfo&gt; getArrivalInfo() {
<span class="nc" id="L894">        ArrayList&lt;ArrivalInfo&gt; list = null;</span>

<span class="nc bnc" id="L896" title="All 2 branches missed.">        if (mArrivalInfo != null) {</span>
<span class="nc" id="L897">            list = ArrivalInfoUtils.convertObaArrivalInfo(getActivity(), mArrivalInfo, mRoutesFilter,</span>
<span class="nc" id="L898">                    System.currentTimeMillis(), true);</span>
        }
<span class="nc" id="L900">        return list;</span>
    }

    /**
     * Returns the range of arrival times (i.e., for the next &quot;minutesAfter&quot; minutes), or -1 if
     * this information isn't available
     *
     * @return the range of arrival times (i.e., for the next &quot;minutesAfter&quot; minutes), or -1 if
     * this information isn't available
     */
    @Override
    public int getMinutesAfter() {
<span class="nc" id="L912">        ArrivalsListLoader loader = getArrivalsLoader();</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (loader != null) {</span>
<span class="nc" id="L914">            return loader.getMinutesAfter();</span>
        } else {
<span class="nc" id="L916">            return -1;</span>
        }
    }

    @Override
    public String getUserStopName() {
<span class="nc" id="L922">        return mStopUserName;</span>
    }

    @Override
    public void setUserStopName(String name) {
<span class="nc" id="L927">        ContentResolver cr = getActivity().getContentResolver();</span>
<span class="nc" id="L928">        ContentValues values = new ContentValues();</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">        if (TextUtils.isEmpty(name)) {</span>
<span class="nc" id="L930">            values.putNull(ObaContract.Stops.USER_NAME);</span>
<span class="nc" id="L931">            mStopUserName = null;</span>
        } else {
<span class="nc" id="L933">            values.put(ObaContract.Stops.USER_NAME, name);</span>
<span class="nc" id="L934">            mStopUserName = name;</span>
        }
<span class="nc" id="L936">        cr.update(mStopUri, values, null, null);</span>
<span class="nc" id="L937">    }</span>

    @Override
    public ArrayList&lt;String&gt; getRoutesFilter() {
        // If mStop is null, we don't want the ArrivalsListHeader calling
        // getNumRoutes, so if we don't have a stop we pretend we don't have
        // a route filter at all.
<span class="nc bnc" id="L944" title="All 2 branches missed.">        if (mStop != null) {</span>
<span class="nc" id="L945">            return mRoutesFilter;</span>
        } else {
<span class="nc" id="L947">            return null;</span>
        }
    }

    @Override
    public void setRoutesFilter(ArrayList&lt;String&gt; routes) {
<span class="nc" id="L953">        mRoutesFilter = routes;</span>
<span class="nc" id="L954">        ObaContract.StopRouteFilters.set(getActivity(), mStopId, mRoutesFilter);</span>
<span class="nc" id="L955">        refreshSituations(UIUtils.getAllSituations(getArrivalsLoader().getLastGoodResponse(), mRoutesFilter));</span>
<span class="nc" id="L956">        refreshLocal();</span>
<span class="nc" id="L957">    }</span>

    @Override
    public long getLastGoodResponseTime() {
<span class="nc" id="L961">        ArrivalsListLoader loader = getArrivalsLoader();</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">        if (loader == null) {</span>
<span class="nc" id="L963">            return 0;</span>
        }
<span class="nc" id="L965">        return loader.getLastGoodResponseTime();</span>
    }


    @Override
    public List&lt;String&gt; getRouteDisplayNames() {
<span class="nc bnc" id="L971" title="All 4 branches missed.">        if (mStop != null &amp;&amp; getArrivalsLoader() != null) {</span>
<span class="nc" id="L972">            ObaArrivalInfoResponse response =</span>
<span class="nc" id="L973">                    getArrivalsLoader().getLastGoodResponse();</span>
<span class="nc" id="L974">            List&lt;ObaRoute&gt; routes = response.getRoutes(mStop.getRouteIds());</span>
<span class="nc" id="L975">            ArrayList&lt;String&gt; displayNames = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">            for (ObaRoute r : routes) {</span>
<span class="nc" id="L977">                displayNames.add(UIUtils.getRouteDisplayName(r));</span>
<span class="nc" id="L978">            }</span>
<span class="nc" id="L979">            return displayNames;</span>
        } else {
            // Check the arguments
<span class="nc" id="L982">            Bundle args = getArguments();</span>
<span class="nc" id="L983">            String serializedRoutes = args.getString(STOP_ROUTES);</span>
<span class="nc bnc" id="L984" title="All 2 branches missed.">            if (serializedRoutes != null) {</span>
<span class="nc" id="L985">                return UIUtils.deserializeRouteDisplayNames(serializedRoutes);</span>
            }
        }
        // If we've gotten this far, we don't have any routeIds to share
<span class="nc" id="L989">        return null;</span>
    }

    @Override
    public int getNumRoutes() {
<span class="nc bnc" id="L994" title="All 2 branches missed.">        if (mStop != null) {</span>
<span class="nc" id="L995">            return mStop.getRouteIds().length;</span>
        } else {
<span class="nc" id="L997">            return 0;</span>
        }
    }

    @Override
    public boolean isFavoriteStop() {
<span class="nc" id="L1003">        return mFavorite;</span>
    }

    @Override
    public boolean setFavoriteStop(boolean favorite) {
<span class="nc bnc" id="L1008" title="All 2 branches missed.">        if (ObaContract.Stops.markAsFavorite(getActivity(), mStopUri, favorite)) {</span>
<span class="nc" id="L1009">            mFavorite = favorite;</span>
        }
        // Apparently we can't rely on onPrepareOptionsMenu to set the
        // menus like we did before...
<span class="nc" id="L1013">        getActivity().supportInvalidateOptionsMenu();</span>

<span class="nc" id="L1015">        ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1016">                getString(R.string.analytics_label_edit_field_bookmark),</span>
                null);

<span class="nc" id="L1019">        return mFavorite;</span>
    }

    @Override
    public AlertList getAlertList() {
<span class="nc" id="L1024">        return mAlertList;</span>
    }

    /**
     * Checks to see if the user has changed the arrival info style preference after this Fragment
     * was initialized
     */
    private void checkAdapterStylePreference() {
<span class="nc" id="L1032">        int currentArrivalInfoStyle = BuildFlavorUtils.getArrivalInfoStyleFromPreferences();</span>

<span class="nc bnc" id="L1034" title="All 4 branches missed.">        if (currentArrivalInfoStyle == BuildFlavorUtils.ARRIVAL_INFO_STYLE_A &amp;&amp;</span>
                !(mAdapter instanceof ArrivalsListAdapterStyleA)) {
            // Change to Style A adapter
<span class="nc" id="L1037">            reinitAdapterStyleOnPreferenceChange(BuildFlavorUtils.ARRIVAL_INFO_STYLE_A);</span>
<span class="nc bnc" id="L1038" title="All 4 branches missed.">        } else if (currentArrivalInfoStyle == BuildFlavorUtils.ARRIVAL_INFO_STYLE_B &amp;&amp;</span>
                !(mAdapter instanceof ArrivalsListAdapterStyleB)) {
            // Change to Style B adapter
<span class="nc" id="L1041">            reinitAdapterStyleOnPreferenceChange(BuildFlavorUtils.ARRIVAL_INFO_STYLE_B);</span>
        }
<span class="nc" id="L1043">    }</span>

    /**
     * Reinitializes the adapter style after there has been a preference changed
     *
     * @param arrivalInfoStyle the adapter style to change to - should be one of the
     *                         BuildFlavorUtil.ARRIVAL_INFO_STYLE_* contants
     */
    private void reinitAdapterStyleOnPreferenceChange(int arrivalInfoStyle) {
<span class="nc" id="L1052">        LayoutInflater inflater = LayoutInflater.from(getActivity());</span>
        // Remove any existing footer view
<span class="nc bnc" id="L1054" title="All 2 branches missed.">        if (mFooter != null) {</span>
<span class="nc" id="L1055">            getListView().removeFooterView(mFooter);</span>
        }
<span class="nc" id="L1057">        CharSequence emptyText = null;</span>
        // Remove any existing empty list view
<span class="nc bnc" id="L1059" title="All 2 branches missed.">        if (mEmptyList != null) {</span>
<span class="nc" id="L1060">            TextView noArrivals = (TextView) mEmptyList.findViewById(R.id.noArrivals);</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">            if (noArrivals != null) {</span>
<span class="nc" id="L1062">                emptyText = noArrivals.getText();</span>
            }
<span class="nc" id="L1064">            ((ViewGroup) getListView().getParent()).removeView(mEmptyList);</span>
        }

<span class="nc" id="L1067">        initArrivalInfoViews(inflater);</span>
<span class="nc" id="L1068">        setupFooter();</span>
<span class="nc" id="L1069">        setupEmptyList(emptyText);</span>
<span class="nc" id="L1070">        setListViewProperties(arrivalInfoStyle);</span>
<span class="nc" id="L1071">        instantiateAdapter(arrivalInfoStyle);</span>
<span class="nc" id="L1072">    }</span>

    /**
     * Initializes the adapter views
     *
     * @param inflater         inflater to use
     */
    private void initArrivalInfoViews(LayoutInflater inflater) {
        // Use a card-styled footer
<span class="nc" id="L1081">        mFooter = inflater.inflate(R.layout.arrivals_list_footer_style, null);</span>
<span class="nc" id="L1082">        mEmptyList = inflater.inflate(R.layout.arrivals_list_empty_style, null);</span>
<span class="nc" id="L1083">    }</span>

    /**
     * Sets up the footer with the load more arrivals button
     */
    private void setupFooter() {
        // Setup list footer button to load more arrivals (when arrivals are shown)
<span class="nc" id="L1090">        Button loadMoreArrivals = (Button) mFooter.findViewById(R.id.load_more_arrivals);</span>
<span class="nc" id="L1091">        loadMoreArrivals.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L1094">                loadMoreArrivals();</span>
<span class="nc" id="L1095">            }</span>
        });
<span class="nc" id="L1097">        getListView().addFooterView(mFooter);</span>
<span class="nc" id="L1098">        mFooter.requestLayout();</span>
<span class="nc" id="L1099">    }</span>

    /**
     * Sets up the load more arrivals button in the empty list view
     *
     * @param currentText the text that should populate the empty list entry, or null if no text
     *                    should be set at this point
     */
    private void setupEmptyList(CharSequence currentText) {
<span class="nc" id="L1108">        Button loadMoreArrivalsEmptyList = (Button) mEmptyList</span>
<span class="nc" id="L1109">                .findViewById(R.id.load_more_arrivals);</span>
<span class="nc" id="L1110">        loadMoreArrivalsEmptyList.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L1113">                loadMoreArrivals();</span>
<span class="nc" id="L1114">            }</span>
        });
        // Set and add the view that is shown if no arrival information is returned by the REST API
<span class="nc" id="L1117">        getListView().setEmptyView(mEmptyList);</span>
<span class="nc" id="L1118">        ((ViewGroup) getListView().getParent()).addView(mEmptyList);</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">        if (currentText != null) {</span>
<span class="nc" id="L1120">            setEmptyText(currentText);</span>
        }
<span class="nc" id="L1122">    }</span>

    /**
     * Initializes the list view properties
     *
     * @param arrivalInfoStyle the adapter style to use - should be one of the
     *                         BuildFlavorUtil.ARRIVAL_INFO_STYLE_* contants
     */
    private void setListViewProperties(int arrivalInfoStyle) {
<span class="nc" id="L1131">        ListView.MarginLayoutParams listParam = (ListView.MarginLayoutParams) getListView()</span>
<span class="nc" id="L1132">                .getLayoutParams();</span>
        // Set margins for the CardViews
<span class="nc" id="L1134">        listParam.bottomMargin = UIUtils.dpToPixels(getActivity(), 2);</span>
<span class="nc" id="L1135">        listParam.topMargin = UIUtils.dpToPixels(getActivity(), 3);</span>
<span class="nc" id="L1136">        listParam.leftMargin = UIUtils.dpToPixels(getActivity(), 5);</span>
<span class="nc" id="L1137">        listParam.rightMargin = UIUtils.dpToPixels(getActivity(), 5);</span>
        // Set the listview background to give the cards more contrast
<span class="nc" id="L1139">        getListView().getRootView().setBackgroundColor(</span>
<span class="nc" id="L1140">                getResources().getColor(R.color.stop_info_arrival_list_background));</span>
        // Update the layout parameters
<span class="nc" id="L1142">        getListView().setLayoutParams(listParam);</span>
<span class="nc" id="L1143">    }</span>

    /**
     * Instantiates the adapter based on the style to be used
     *
     * @param arrivalInfoStyle the adapter style to use - should be one of the
     *                         BuildFlavorUtil.ARRIVAL_INFO_STYLE_* contants
     */
    private void instantiateAdapter(int arrivalInfoStyle) {
<span class="nc bnc" id="L1152" title="All 2 branches missed.">        if (UIUtils.canSupportArrivalInfoStyleB()) {</span>
<span class="nc bnc" id="L1153" title="All 3 branches missed.">            switch (arrivalInfoStyle) {</span>
                case BuildFlavorUtils.ARRIVAL_INFO_STYLE_A:
<span class="nc" id="L1155">                    mAdapter = new ArrivalsListAdapterStyleA(getActivity());</span>
<span class="nc" id="L1156">                    break;</span>
                case BuildFlavorUtils.ARRIVAL_INFO_STYLE_B:
<span class="nc" id="L1158">                    mAdapter = new ArrivalsListAdapterStyleB(getActivity());</span>
<span class="nc" id="L1159">                    ((ArrivalsListAdapterStyleB) mAdapter).setFragment(this);</span>
<span class="nc" id="L1160">                    break;</span>
            }
        } else {
            // Always use Style A on Gingerbread
<span class="nc" id="L1164">            mAdapter = new ArrivalsListAdapterStyleA(getActivity());</span>
        }

        // We present arrivals as cards, so hide the divider in the listview
<span class="nc" id="L1168">        getListView().setDivider(null);</span>
<span class="nc" id="L1169">        setListAdapter(mAdapter);</span>
<span class="nc" id="L1170">    }</span>

    private void showSortByDialog() {
        // Do callback when user taps on button, so they can see result of dialog selection
<span class="nc bnc" id="L1174" title="All 2 branches missed.">        if (mListener != null) {</span>
<span class="nc" id="L1175">            mListener.onSortBySelected();</span>
        }

<span class="nc" id="L1178">        AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());</span>
<span class="nc" id="L1179">        builder.setTitle(R.string.menu_option_sort_by);</span>

<span class="nc" id="L1181">        int currentArrivalInfoStyle = BuildFlavorUtils.getArrivalInfoStyleFromPreferences();</span>
<span class="nc" id="L1182">        builder.setSingleChoiceItems(R.array.sort_arrivals, currentArrivalInfoStyle,</span>
<span class="nc" id="L1183">                new DialogInterface.OnClickListener() {</span>
                    public void onClick(DialogInterface dialog, int index) {
<span class="nc bnc" id="L1185" title="All 2 branches missed.">                        if (index == 0) {</span>
                            // Sort by eta
<span class="nc" id="L1187">                            Log.d(TAG, &quot;Sort by ETA&quot;);</span>
<span class="nc" id="L1188">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1189">                                    getString(R.string.analytics_label_sort_by_eta_arrival),</span>
                                    null);
<span class="nc bnc" id="L1191" title="All 2 branches missed.">                        } else if (index == 1) {</span>
                            // Sort by route
<span class="nc" id="L1193">                            Log.d(TAG, &quot;Sort by route&quot;);</span>
<span class="nc" id="L1194">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1195">                                    getString(R.string.analytics_label_sort_by_route_arrival),</span>
                                    null);
                        }
<span class="nc" id="L1198">                        String[] styles = getResources()</span>
<span class="nc" id="L1199">                                .getStringArray(R.array.arrival_info_style_options);</span>
<span class="nc" id="L1200">                        PreferenceUtils.saveString(getResources()</span>
<span class="nc" id="L1201">                                        .getString(R.string.preference_key_arrival_info_style),</span>
                                styles[index]);
<span class="nc" id="L1203">                        checkAdapterStylePreference();</span>
<span class="nc" id="L1204">                        refreshLocal();</span>
<span class="nc" id="L1205">                        getLoaderManager()</span>
<span class="nc" id="L1206">                                .restartLoader(TRIPS_FOR_STOP_LOADER, null, mTripsForStopCallback);</span>
<span class="nc" id="L1207">                        dialog.dismiss();</span>
<span class="nc" id="L1208">                    }</span>
                });
<span class="nc" id="L1210">        AlertDialog dialog = builder.create();</span>
<span class="nc" id="L1211">        dialog.setOwnerActivity(getActivity());</span>
<span class="nc" id="L1212">        dialog.show();</span>
<span class="nc" id="L1213">    }</span>

    /**
     * Toggle the visibility of arrivals in the header
     */
    private void doShowHideHeaderArrivals() {
<span class="nc bnc" id="L1219" title="All 2 branches missed.">        if (mHeader == null) {</span>
<span class="nc" id="L1220">            return;</span>
        }
<span class="nc" id="L1222">        boolean showArrivals = Application.getPrefs()</span>
<span class="nc" id="L1223">                .getBoolean(getString(R.string.preference_key_show_header_arrivals), false);</span>

<span class="nc bnc" id="L1225" title="All 2 branches missed.">        if (showArrivals) {</span>
            // Currently we're showing arrivals in header - we need to remove them
<span class="nc" id="L1227">            mHeader.showArrivals(false);</span>
<span class="nc" id="L1228">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1229">                    getString(R.string.analytics_label_hide_arrivals_in_header),</span>
                    null);
        } else {
            // Currently we're hiding arrivals - we need to show them
<span class="nc" id="L1233">            mHeader.showArrivals(true);</span>
<span class="nc" id="L1234">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1235">                    getString(R.string.analytics_label_show_arrivals_in_header),</span>
                    null);
        }

<span class="nc" id="L1239">        PreferenceUtils.saveBoolean(getResources()</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">                .getString(R.string.preference_key_show_header_arrivals), !showArrivals);</span>
<span class="nc" id="L1241">        mHeader.refresh();</span>
<span class="nc" id="L1242">    }</span>

    private void showRoutesFilterDialog() {
<span class="nc" id="L1245">        ObaArrivalInfoResponse response =</span>
<span class="nc" id="L1246">                getArrivalsLoader().getLastGoodResponse();</span>
<span class="nc" id="L1247">        final List&lt;ObaRoute&gt; routes = response.getRoutes(mStop.getRouteIds());</span>
<span class="nc" id="L1248">        final int len = routes.size();</span>
<span class="nc" id="L1249">        final ArrayList&lt;String&gt; filter = mRoutesFilter;</span>

        // mRouteIds = new ArrayList&lt;String&gt;(len);
<span class="nc" id="L1252">        String[] items = new String[len];</span>
<span class="nc" id="L1253">        boolean[] checks = new boolean[len];</span>

        // Go through all the stops, add them to the Ids and Names
        // For each stop, if it is in the enabled list, mark it as checked.
<span class="nc bnc" id="L1257" title="All 2 branches missed.">        for (int i = 0; i &lt; len; ++i) {</span>
<span class="nc" id="L1258">            final ObaRoute route = routes.get(i);</span>
            // final String id = route.getId();
            // mRouteIds.add(i, id);
<span class="nc" id="L1261">            items[i] = UIUtils.getRouteDisplayName(route);</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">            if (filter.contains(route.getId())) {</span>
<span class="nc" id="L1263">                checks[i] = true;</span>
            }
        }

        // Arguments
<span class="nc" id="L1268">        Bundle args = new Bundle();</span>
<span class="nc" id="L1269">        args.putStringArray(RoutesFilterDialog.ITEMS, items);</span>
<span class="nc" id="L1270">        args.putBooleanArray(RoutesFilterDialog.CHECKS, checks);</span>
<span class="nc" id="L1271">        RoutesFilterDialog frag = new RoutesFilterDialog();</span>
<span class="nc" id="L1272">        frag.setArguments(args);</span>
<span class="nc" id="L1273">        frag.show(getActivity().getSupportFragmentManager(), &quot;.RoutesFilterDialog&quot;);</span>
<span class="nc" id="L1274">    }</span>

    private void showStopDetailsDialog() {
        // Create dialog contents
<span class="nc" id="L1278">        String stopCode = null;</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">        if (mStop != null) {</span>
<span class="nc" id="L1280">            stopCode = mStop.getStopCode();</span>
        }
<span class="nc" id="L1282">        Pair stopDetails = UIUtils.createStopDetailsDialogText(getContext(),</span>
<span class="nc" id="L1283">                getStopName(),</span>
<span class="nc" id="L1284">                getUserStopName(),</span>
                stopCode,
<span class="nc" id="L1286">                getStopDirection(),</span>
<span class="nc" id="L1287">                getRouteDisplayNames());</span>

<span class="nc" id="L1289">        UIUtils.buildAlertDialog(getContext(),</span>
                (String) stopDetails.first,
<span class="nc" id="L1291">                (String) stopDetails.second).show();</span>

<span class="nc" id="L1293">        ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1294">                getActivity().getString(R.string.analytics_label_button_press_stop_details),</span>
                null);
<span class="nc" id="L1296">    }</span>

    /**
     * Sets the listener
     *
     * @param listener the listener
     */
    public void setListener(Listener listener) {
<span class="nc" id="L1304">        this.mListener = listener;</span>
<span class="nc" id="L1305">    }</span>

    private void setupHeader(Bundle bundle) {
<span class="nc bnc" id="L1308" title="All 2 branches missed.">        if (bundle != null) {</span>
<span class="nc" id="L1309">            mExternalHeader = bundle.getBoolean(EXTERNAL_HEADER);</span>
        }

<span class="nc bnc" id="L1312" title="All 4 branches missed.">        if (mHeader == null &amp;&amp; !mExternalHeader) {</span>
            // We should use the header contained in this fragment's layout, if none was provided
            // by the Activity via setHeader()
<span class="nc" id="L1315">            mHeader = new ArrivalsListHeader(getActivity(), this, getFragmentManager());</span>
<span class="nc" id="L1316">            mHeaderView = getView().findViewById(R.id.arrivals_list_header);</span>
<span class="nc" id="L1317">            mHeader.initView(mHeaderView);</span>
<span class="nc" id="L1318">            mHeader.showExpandCollapseIndicator(false);</span>
            // Header is not in a sliding panel, so set collapsed state to false
<span class="nc" id="L1320">            mHeader.setSlidingPanelCollapsed(false);</span>
            // Show or hide the header arrivals based on user preference
<span class="nc" id="L1322">            boolean showArrivals = Application.getPrefs()</span>
<span class="nc" id="L1323">                    .getBoolean(getString(R.string.preference_key_show_header_arrivals), false);</span>
<span class="nc" id="L1324">            mHeader.showArrivals(showArrivals);</span>
<span class="nc" id="L1325">        } else {</span>
            // The header is in another layout (e.g., sliding panel), so we need to remove the header in this layout
<span class="nc" id="L1327">            getView().findViewById(R.id.arrivals_list_header).setVisibility(View.GONE);</span>
        }

<span class="nc bnc" id="L1330" title="All 2 branches missed.">        if (mHeader != null) {</span>
<span class="nc" id="L1331">            mHeader.refresh();</span>
        }
<span class="nc" id="L1333">    }</span>

<span class="nc" id="L1335">    public static class RoutesFilterDialog extends DialogFragment</span>
            implements OnMultiChoiceClickListener,
            DialogInterface.OnClickListener {

        static final String ITEMS = &quot;.items&quot;;

        static final String CHECKS = &quot;.checks&quot;;

        private boolean[] mChecks;

        @Override
        public Dialog onCreateDialog(Bundle savedInstanceState) {
<span class="nc" id="L1347">            Bundle args = getArguments();</span>
<span class="nc" id="L1348">            String[] items = args.getStringArray(ITEMS);</span>
<span class="nc" id="L1349">            mChecks = args.getBooleanArray(CHECKS);</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">            if (savedInstanceState != null) {</span>
<span class="nc" id="L1351">                mChecks = args.getBooleanArray(CHECKS);</span>
            }

<span class="nc" id="L1354">            AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());</span>
<span class="nc" id="L1355">            return builder.setTitle(R.string.stop_info_filter_title)</span>
<span class="nc" id="L1356">                    .setMultiChoiceItems(items, mChecks, this)</span>
<span class="nc" id="L1357">                    .setPositiveButton(R.string.stop_info_save, this)</span>
<span class="nc" id="L1358">                    .setNegativeButton(R.string.stop_info_cancel, null)</span>
<span class="nc" id="L1359">                    .create();</span>
        }

        @Override
        public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L1364">            outState.putBooleanArray(CHECKS, mChecks);</span>
<span class="nc" id="L1365">        }</span>

        @Override
        public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L1369">            Activity act = getActivity();</span>
<span class="nc" id="L1370">            ArrivalsListFragment frag = null;</span>

            // Get the fragment we want...
<span class="nc bnc" id="L1373" title="All 2 branches missed.">            if (act instanceof ArrivalsListActivity) {</span>
<span class="nc" id="L1374">                frag = ((ArrivalsListActivity) act).getArrivalsListFragment();</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">            } else if (act instanceof HomeActivity) {</span>
<span class="nc" id="L1376">                frag = ((HomeActivity) act).getArrivalsListFragment();</span>
            }

<span class="nc" id="L1379">            frag.setRoutesFilter(mChecks);</span>
<span class="nc" id="L1380">            dialog.dismiss();</span>
<span class="nc" id="L1381">        }</span>

        @Override
        public void onClick(DialogInterface arg0, int which, boolean isChecked) {
<span class="nc" id="L1385">            mChecks[which] = isChecked;</span>
<span class="nc" id="L1386">        }</span>
    }

    private void setRoutesFilter(boolean[] checks) {
<span class="nc" id="L1390">        final int len = checks.length;</span>
<span class="nc" id="L1391">        final ArrayList&lt;String&gt; newFilter = new ArrayList&lt;String&gt;(len);</span>

<span class="nc" id="L1393">        ObaArrivalInfoResponse response =</span>
<span class="nc" id="L1394">                getArrivalsLoader().getLastGoodResponse();</span>
<span class="nc" id="L1395">        final List&lt;ObaRoute&gt; routes = response.getRoutes(mStop.getRouteIds());</span>
<span class="nc bnc" id="L1396" title="All 2 branches missed.">        if (routes.size() != len) {</span>
<span class="nc" id="L1397">            throw new IllegalArgumentException(&quot;checks.length must be equal to routes.size()&quot;);</span>
        }

<span class="nc bnc" id="L1400" title="All 2 branches missed.">        for (int i = 0; i &lt; len; ++i) {</span>
<span class="nc" id="L1401">            final ObaRoute route = routes.get(i);</span>
<span class="nc bnc" id="L1402" title="All 2 branches missed.">            if (checks[i]) {</span>
<span class="nc" id="L1403">                newFilter.add(route.getId());</span>
            }
        }
        // If the size of the filter is the number of routes
        // (i.e., the user selected every checkbox) act then
        // don't select any.
<span class="nc bnc" id="L1409" title="All 2 branches missed.">        if (newFilter.size() == len) {</span>
<span class="nc" id="L1410">            newFilter.clear();</span>
        }

<span class="nc" id="L1413">        setRoutesFilter(newFilter);</span>
<span class="nc" id="L1414">    }</span>

    //
    // Navigation
    //
    private void goToTrip(ArrivalInfo stop) {
<span class="nc" id="L1420">        ObaArrivalInfo stopInfo = stop.getInfo();</span>
<span class="nc" id="L1421">        TripInfoActivity.start(getActivity(),</span>
<span class="nc" id="L1422">                stopInfo.getTripId(),</span>
                mStopId,
<span class="nc" id="L1424">                stopInfo.getRouteId(),</span>
<span class="nc" id="L1425">                stopInfo.getShortName(),</span>
<span class="nc" id="L1426">                mStop.getName(),</span>
<span class="nc" id="L1427">                stopInfo.getScheduledDepartureTime(),</span>
<span class="nc" id="L1428">                stopInfo.getHeadsign());</span>
<span class="nc" id="L1429">    }</span>

    private void goToTripDetails(ArrivalInfo stop) {
<span class="nc" id="L1432">        TripDetailsActivity.start(getActivity(),</span>
<span class="nc" id="L1433">                stop.getInfo().getTripId(), stop.getInfo().getStopId(),</span>
                TripDetailsListFragment.SCROLL_MODE_STOP);
<span class="nc" id="L1435">    }</span>

    private void goToRoute(ArrivalInfo stop) {
<span class="nc" id="L1438">        RouteInfoActivity.start(getActivity(),</span>
<span class="nc" id="L1439">                stop.getInfo().getRouteId());</span>
<span class="nc" id="L1440">    }</span>

    //
    // Helpers
    //
    private ArrivalsListLoader getArrivalsLoader() {
        // If the Fragment hasn't been attached to an Activity yet, return null
<span class="nc bnc" id="L1447" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1448">            return null;</span>
        }
<span class="nc" id="L1450">        Loader&lt;ObaArrivalInfoResponse&gt; l =</span>
<span class="nc" id="L1451">                getLoaderManager().getLoader(ARRIVALS_LIST_LOADER);</span>
<span class="nc" id="L1452">        return (ArrivalsListLoader) l;</span>
    }

    @Override
    public void setEmptyText(CharSequence text) {
<span class="nc" id="L1457">        TextView noArrivals = (TextView) mEmptyList.findViewById(R.id.noArrivals);</span>
<span class="nc" id="L1458">        noArrivals.setText(text);</span>
<span class="nc" id="L1459">    }</span>

    private void loadMoreArrivals() {
<span class="nc" id="L1462">        getArrivalsLoader().incrementMinutesAfter();</span>
<span class="nc" id="L1463">        mLoadedMoreArrivals = true;</span>
<span class="nc" id="L1464">        refresh();</span>

<span class="nc" id="L1466">        ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1467">                getActivity().getString(R.string.analytics_label_load_more_arrivals),</span>
                null);
<span class="nc" id="L1469">    }</span>

    /**
     * Full refresh of data from the OBA server
     */
    public void refresh() {
<span class="nc bnc" id="L1475" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L1476">            showProgress(true);</span>
            // Get last response length now, since its overwritten within
            // ArrivalsListLoader before onLoadFinished() is called
<span class="nc" id="L1479">            ObaArrivalInfoResponse lastGood =</span>
<span class="nc" id="L1480">                    getArrivalsLoader().getLastGoodResponse();</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">            if (lastGood != null) {</span>
<span class="nc" id="L1482">                mLastResponseLength = lastGood.getArrivalInfo().length;</span>
            }
<span class="nc" id="L1484">            getArrivalsLoader().onContentChanged();</span>
        }
<span class="nc" id="L1486">    }</span>

    /**
     * Refreshes ListFragment content using the most recent server response.  Does not trigger
     * another call to the OBA server.
     */
    public void refreshLocal() {
<span class="nc" id="L1493">        ArrivalsListLoader loader = getArrivalsLoader();</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">        if (loader != null) {</span>
<span class="nc" id="L1495">            ObaArrivalInfoResponse response = loader.getLastGoodResponse();</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">            if (response == null) {</span>
                // Nothing to refresh yet
<span class="nc" id="L1498">                return;</span>
            }
<span class="nc" id="L1500">            mAdapter.setData(response.getArrivalInfo(), mRoutesFilter, System.currentTimeMillis());</span>
        }
<span class="nc bnc" id="L1502" title="All 2 branches missed.">        if (mHeader != null) {</span>
<span class="nc" id="L1503">            mHeader.refresh();</span>
        }
<span class="nc" id="L1505">    }</span>

<span class="nc" id="L1507">    private final Handler mRefreshHandler = new Handler();</span>

<span class="nc" id="L1509">    private final Runnable mRefresh = new Runnable() {</span>
        public void run() {
<span class="nc" id="L1511">            refresh();</span>
<span class="nc" id="L1512">        }</span>
    };

    private void setStopId() {
<span class="nc" id="L1516">        Uri uri = (Uri) getArguments().getParcelable(FragmentUtils.URI);</span>
<span class="nc bnc" id="L1517" title="All 2 branches missed.">        if (uri == null) {</span>
<span class="nc" id="L1518">            Log.e(TAG, &quot;No URI in arguments&quot;);</span>
<span class="nc" id="L1519">            return;</span>
        }
<span class="nc" id="L1521">        mStopId = uri.getLastPathSegment();</span>
<span class="nc" id="L1522">        mStopUri = uri;</span>
<span class="nc" id="L1523">    }</span>

<span class="nc" id="L1525">    private static final String[] USER_PROJECTION = {</span>
            ObaContract.Stops.FAVORITE,
            ObaContract.Stops.USER_NAME
    };

    private void setUserInfo() {
<span class="nc" id="L1531">        ContentResolver cr = getActivity().getContentResolver();</span>
<span class="nc" id="L1532">        Cursor c = cr.query(mStopUri, USER_PROJECTION, null, null, null);</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">        if (c != null) {</span>
            try {
<span class="nc bnc" id="L1535" title="All 2 branches missed.">                if (c.moveToNext()) {</span>
<span class="nc bnc" id="L1536" title="All 2 branches missed.">                    mFavorite = (c.getInt(0) == 1);</span>
<span class="nc" id="L1537">                    mStopUserName = c.getString(1);</span>
                }
            } finally {
<span class="nc" id="L1540">                c.close();</span>
            }
        }
<span class="nc" id="L1543">    }</span>

<span class="nc" id="L1545">    private static final String[] TRIPS_PROJECTION = {</span>
            ObaContract.Trips._ID, ObaContract.Trips.NAME
    };

    //
    // The asynchronously loads the trips for stop list.
    //
<span class="nc" id="L1552">    private class TripsForStopCallback</span>
            implements LoaderManager.LoaderCallbacks&lt;Cursor&gt; {

        @Override
        public Loader&lt;Cursor&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L1557">            return new CursorLoader(getActivity(),</span>
                    ObaContract.Trips.CONTENT_URI,
<span class="nc" id="L1559">                    TRIPS_PROJECTION,</span>
                    ObaContract.Trips.STOP_ID + &quot;=?&quot;,
<span class="nc" id="L1561">                    new String[]{mStopId},</span>
                    null);
        }

        @Override
        public void onLoadFinished(Loader&lt;Cursor&gt; loader, Cursor c) {
<span class="nc" id="L1567">            ContentQueryMap map =</span>
                    new ContentQueryMap(c, ObaContract.Trips._ID, true, null);
            // Call back into the adapter and header and say we've finished this.
<span class="nc" id="L1570">            mAdapter.setTripsForStop(map);</span>
<span class="nc bnc" id="L1571" title="All 2 branches missed.">            if (mHeader != null) {</span>
<span class="nc" id="L1572">                mHeader.setTripsForStop(map);</span>
            }
<span class="nc" id="L1574">        }</span>

        @Override
        public void onLoaderReset(Loader&lt;Cursor&gt; loader) {
<span class="nc" id="L1578">        }</span>
    }

    //
    // Situations
    //
    private class SituationAlert implements AlertList.Alert {

        private final ObaSituation mSituation;

<span class="nc" id="L1588">        SituationAlert(ObaSituation situation) {</span>
<span class="nc" id="L1589">            mSituation = situation;</span>
<span class="nc" id="L1590">        }</span>

        @Override
        public String getId() {
<span class="nc" id="L1594">            return mSituation.getId();</span>
        }

        @Override
        public int getType() {
<span class="nc bnc" id="L1599" title="All 2 branches missed.">            if (ObaSituation.SEVERITY_NO_IMPACT.equals(mSituation.getSeverity())) {</span>
<span class="nc" id="L1600">                return TYPE_INFO;</span>
<span class="nc bnc" id="L1601" title="All 2 branches missed.">            } else if (ObaSituation.SEVERITY_SEVERE.equals(mSituation.getSeverity())</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">                    || ObaSituation.SEVERITY_VERY_SEVERE.equals(</span>
<span class="nc" id="L1603">                    mSituation.getSeverity())) {</span>
<span class="nc" id="L1604">                return TYPE_ERROR;</span>
            } else {
                // Treat all other ObaSituation.SEVERITY_* types as a warning
<span class="nc" id="L1607">                return TYPE_WARNING;</span>
            }
        }

        @Override
        public int getFlags() {
<span class="nc" id="L1613">            return FLAG_HASMORE;</span>
        }

        @Override
        public CharSequence getString() {
<span class="nc" id="L1618">            return mSituation.getSummary();</span>
        }

        @Override
        public void onClick() {
<span class="nc" id="L1623">            SituationDialogFragment dialog = SituationDialogFragment.newInstance(mSituation);</span>
<span class="nc" id="L1624">            dialog.setListener(new SituationDialogFragment.Listener() {</span>
                @Override
                public void onDismiss(boolean isAlertHidden) {
<span class="nc bnc" id="L1627" title="All 2 branches missed.">                    if (isAlertHidden) {</span>
                        // User hid a service alert, so we need to refresh the list
                        // TODO - refreshLocal() should support refreshing local situations
<span class="nc" id="L1630">                        refresh();</span>
                    }
<span class="nc" id="L1632">                }</span>

                @Override
                public void onUndo() {
                    // User hit undo, so we need to refresh the list
                    // TODO - refreshLocal() should support refreshing local situations
<span class="nc" id="L1638">                    refresh();</span>
<span class="nc" id="L1639">                }</span>
            });
<span class="nc" id="L1641">            dialog.show(getFragmentManager(), SituationDialogFragment.TAG);</span>

<span class="nc" id="L1643">            reportAnalytics(mSituation);</span>
<span class="nc" id="L1644">        }</span>

        @Override
        public int hashCode() {
<span class="nc" id="L1648">            return getId().hashCode();</span>
        }

        @Override
        public boolean equals(Object obj) {
<span class="nc bnc" id="L1653" title="All 2 branches missed.">            if (this == obj) {</span>
<span class="nc" id="L1654">                return true;</span>
            }
<span class="nc bnc" id="L1656" title="All 2 branches missed.">            if (obj == null) {</span>
<span class="nc" id="L1657">                return false;</span>
            }
<span class="nc bnc" id="L1659" title="All 2 branches missed.">            if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L1660">                return false;</span>
            }
<span class="nc" id="L1662">            SituationAlert other = (SituationAlert) obj;</span>
<span class="nc bnc" id="L1663" title="All 2 branches missed.">            if (!getId().equals(other.getId())) {</span>
<span class="nc" id="L1664">                return false;</span>
            }
<span class="nc" id="L1666">            return true;</span>
        }
    }

    private void reportAnalytics(ObaSituation situation) {
<span class="nc" id="L1671">        ObaSituation.AllAffects[] allAffects = situation.getAllAffects();</span>
<span class="nc" id="L1672">        Set&lt;String&gt; agencyIds = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1673" title="All 2 branches missed.">        for (int i = 0; i &lt; allAffects.length; i++) {</span>
<span class="nc" id="L1674">            agencyIds.add(allAffects[i].getAgencyId());</span>
        }

<span class="nc bnc" id="L1677" title="All 2 branches missed.">        for (String agencyId : agencyIds) {</span>
<span class="nc" id="L1678">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1679">                    getString(R.string.analytics_service_alerts),</span>
<span class="nc" id="L1680">                    getString(R.string.analytics_label_service_alerts) + agencyId);</span>
<span class="nc" id="L1681">        }</span>
<span class="nc" id="L1682">    }</span>

    private void refreshSituations(List&lt;ObaSituation&gt; situations) {
        // First, remove any existing situations
<span class="nc bnc" id="L1686" title="All 2 branches missed.">        if (mSituationAlerts != null) {</span>
<span class="nc bnc" id="L1687" title="All 2 branches missed.">            for (SituationAlert alert : mSituationAlerts) {</span>
<span class="nc" id="L1688">                mAlertList.remove(alert);</span>
<span class="nc" id="L1689">            }</span>
        }
<span class="nc" id="L1691">        mAlertList.setAlertHidden(false);</span>
<span class="nc" id="L1692">        mSituationAlerts = null;</span>

<span class="nc bnc" id="L1694" title="All 2 branches missed.">        if (situations.isEmpty()) {</span>
            // The normal scenario
<span class="nc" id="L1696">            return;</span>
        }

<span class="nc" id="L1699">        mSituationAlerts = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1701">        ContentValues values = new ContentValues();</span>

<span class="nc" id="L1703">        int hiddenCount = 0;</span>

<span class="nc bnc" id="L1705" title="All 2 branches missed.">        for (ObaSituation situation : situations) {</span>
<span class="nc" id="L1706">            values.clear();</span>

            // Make sure this situation is added to the database
<span class="nc" id="L1709">            ObaContract.ServiceAlerts.insertOrUpdate(situation.getId(), values, false, null);</span>

<span class="nc" id="L1711">            boolean isActive = UIUtils</span>
<span class="nc" id="L1712">                    .isActiveWindowForSituation(situation, System.currentTimeMillis());</span>
<span class="nc" id="L1713">            boolean isHidden = ObaContract.ServiceAlerts.isHidden(situation.getId());</span>

<span class="nc bnc" id="L1715" title="All 4 branches missed.">            if (isActive &amp;&amp; !isHidden) {</span>
<span class="nc" id="L1716">                SituationAlert alert = new SituationAlert(situation);</span>
<span class="nc" id="L1717">                mSituationAlerts.add(alert);</span>
            }
<span class="nc bnc" id="L1719" title="All 2 branches missed.">            if (isHidden) {</span>
<span class="nc" id="L1720">                mAlertList.setAlertHidden(true);</span>
<span class="nc" id="L1721">                hiddenCount++;</span>
            }
<span class="nc" id="L1723">        }</span>
<span class="nc" id="L1724">        mAlertList.setHiddenAlertCount(hiddenCount);</span>
<span class="nc" id="L1725">        mAlertList.addAll(mSituationAlerts);</span>
<span class="nc" id="L1726">    }</span>

    /**
     * Creates the dialog that will be shown to the user to explain the occupancy feature
     *
     * @return the dialog that will be shown to the user to explain the occupancy feature
     */
    private Dialog createOccupancyDialog() {
<span class="nc" id="L1734">        androidx.appcompat.app.AlertDialog.Builder builder = new androidx.appcompat.app.AlertDialog.Builder(getContext());</span>
<span class="nc" id="L1735">        builder.setTitle(R.string.menu_title_about_occupancy);</span>

<span class="nc" id="L1737">        LayoutInflater inflater = LayoutInflater.from(getContext());</span>
<span class="nc" id="L1738">        View occupancyDialogView = inflater.inflate(R.layout.occupancy_dialog, null);</span>
<span class="nc" id="L1739">        builder.setView(occupancyDialogView);</span>
<span class="nc" id="L1740">        ViewGroup realtimeOccupancy = occupancyDialogView.findViewById(R.id.realtime_occupancy);</span>
<span class="nc" id="L1741">        ViewGroup historicalOccupancy = occupancyDialogView.findViewById(R.id.historical_occupancy);</span>

<span class="nc" id="L1743">        UIUtils.setOccupancyVisibilityAndColor(realtimeOccupancy, Occupancy.FULL, OccupancyState.REALTIME);</span>
<span class="nc" id="L1744">        UIUtils.setOccupancyVisibilityAndColor(historicalOccupancy, Occupancy.FULL, OccupancyState.HISTORICAL);</span>

<span class="nc" id="L1746">        builder.setNeutralButton(R.string.main_help_close, (dialogInterface, i) -&gt; dialogInterface.dismiss());</span>
<span class="nc" id="L1747">        return builder.create();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>