<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrientationHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.util</a> &gt; <span class="el_source">OrientationHelper.java</span></div><h1>OrientationHelper.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2014 Sean J. Barbeau (sjbarbeau@gmail.com), University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.util;

import org.onebusaway.android.app.Application;
import android.annotation.TargetApi;
import android.content.Context;
import android.hardware.Sensor;
import android.hardware.SensorEvent;
import android.hardware.SensorEventListener;
import android.hardware.SensorManager;
import android.os.Build;
import android.util.Log;
import android.view.Surface;
import android.view.WindowManager;
import java.util.ArrayList;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * A sensor-based orientation helperclass , which allows listeners to receive orientation updates
 */
public class OrientationHelper implements SensorEventListener {

    public interface Listener {

        /**
         * Called every time there is an update to the orientation
         *
         * @param deltaHeading change in heading from last heading value
         * @param deltaPitch   change in pitch from last pitch value
         */
        void onOrientationChanged(float heading, float pitch, float deltaHeading, float deltaPitch);
    }

    static final String TAG = &quot;OrientationHelper&quot;;

    Context mContext;

    SensorManager mSensorManager;

<span class="nc" id="L54">    private float[] mRotationMatrix = new float[16];</span>

<span class="nc" id="L56">    private static float[] mRemappedMatrix = new float[16];</span>

<span class="nc" id="L58">    private float[] mOrientation = new float[9];</span>

<span class="nc" id="L60">    private float[] history = new float[2];</span>

<span class="nc" id="L62">    private static float[] mTruncatedRotationVector = new float[4];</span>

<span class="nc" id="L64">    private static boolean mTruncateVector = false;</span>

    private float mHeading;

    private float mPitch;

<span class="nc" id="L70">    ArrayList&lt;Listener&gt; mListeners = new ArrayList&lt;Listener&gt;();</span>

<span class="nc" id="L72">    public OrientationHelper(Context context) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6441)) {</span>
<span class="nc" id="L74">            mContext = context;</span>
        }
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6442)) {</span>
<span class="nc" id="L77">            mSensorManager = (SensorManager) mContext.getSystemService(Context.SENSOR_SERVICE);</span>
        }
<span class="nc" id="L79">    }</span>

    public synchronized void registerListener(Listener listener) {
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6444)) {</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            if (!mListeners.contains(listener)) {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6443)) {</span>
<span class="nc" id="L85">                    mListeners.add(listener);</span>
                }
            }
        }
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6451)) {</span>
            // If this is the first listener, make sure we're monitoring the sensors to provide updates
<span class="nc bnc" id="L91" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(6449) ? (mListeners.size() &gt;= 1) : (ListenerUtil.mutListener.listen(6448) ? (mListeners.size() &lt;= 1) : (ListenerUtil.mutListener.listen(6447) ? (mListeners.size() &gt; 1) : (ListenerUtil.mutListener.listen(6446) ? (mListeners.size() &lt; 1) : (ListenerUtil.mutListener.listen(6445) ? (mListeners.size() != 1) : (mListeners.size() == 1))))))) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6450)) {</span>
<span class="nc" id="L93">                    mSensorManager.registerListener(this, mSensorManager.getDefaultSensor(Sensor.TYPE_ROTATION_VECTOR), SensorManager.SENSOR_DELAY_UI);</span>
                }
            }
        }
<span class="nc" id="L97">    }</span>

    public synchronized void unregisterListener(Listener listener) {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6453)) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (mListeners.contains(listener)) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6452)) {</span>
<span class="nc" id="L103">                    mListeners.remove(listener);</span>
                }
            }
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6460)) {</span>
<span class="nc bnc" id="L108" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(6458) ? (mListeners.size() &gt;= 0) : (ListenerUtil.mutListener.listen(6457) ? (mListeners.size() &lt;= 0) : (ListenerUtil.mutListener.listen(6456) ? (mListeners.size() &gt; 0) : (ListenerUtil.mutListener.listen(6455) ? (mListeners.size() &lt; 0) : (ListenerUtil.mutListener.listen(6454) ? (mListeners.size() != 0) : (mListeners.size() == 0))))))) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6459)) {</span>
<span class="nc" id="L110">                    mSensorManager.unregisterListener(this);</span>
                }
            }
        }
<span class="nc" id="L114">    }</span>

    public synchronized void onResume() {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6461)) {</span>
<span class="nc" id="L118">            mSensorManager.registerListener(this, mSensorManager.getDefaultSensor(Sensor.TYPE_ROTATION_VECTOR), SensorManager.SENSOR_DELAY_UI);</span>
        }
<span class="nc" id="L120">    }</span>

    public synchronized void onPause() {
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6462)) {</span>
<span class="nc" id="L124">            mSensorManager.unregisterListener(this);</span>
        }
<span class="nc" id="L126">    }</span>

    @TargetApi(Build.VERSION_CODES.GINGERBREAD)
    @Override
    public void onSensorChanged(SensorEvent event) {
<span class="nc" id="L131">        float xDelta = 0f;</span>
<span class="nc" id="L132">        float yDelta = 0f;</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6498)) {</span>
<span class="nc bnc" id="L134" title="All 3 branches missed.">            switch(event.sensor.getType()) {</span>
                case Sensor.TYPE_ROTATION_VECTOR:
<span class="nc bnc" id="L136" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6468)) {</span>
                        // Modern rotation vector sensors
<span class="nc bnc" id="L138" title="All 2 branches missed.">                        if (!mTruncateVector) {</span>
                            try {
<span class="nc bnc" id="L140" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6467)) {</span>
<span class="nc" id="L141">                                    SensorManager.getRotationMatrixFromVector(mRotationMatrix, event.values);</span>
                                }
<span class="nc" id="L143">                            } catch (IllegalArgumentException e) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6464)) {</span>
                                    // Truncate the array, since we can deal with only the first four values
<span class="nc" id="L146">                                    Log.e(TAG, &quot;Samsung device error? Will truncate vectors - &quot; + e);</span>
                                }
<span class="nc bnc" id="L148" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6465)) {</span>
<span class="nc" id="L149">                                    mTruncateVector = true;</span>
                                }
<span class="nc bnc" id="L151" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6466)) {</span>
                                    // Do the truncation here the first time the exception occurs
<span class="nc" id="L153">                                    getRotationMatrixFromTruncatedVector(event.values);</span>
                                }
<span class="nc" id="L155">                            }</span>
                        } else {
<span class="nc bnc" id="L157" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6463)) {</span>
                                // Truncate the array to avoid the exception on some devices (see #39)
<span class="nc" id="L159">                                getRotationMatrixFromTruncatedVector(event.values);</span>
                            }
                        }
                    }
<span class="nc" id="L163">                    WindowManager windowManager = (WindowManager) mContext.getSystemService(Context.WINDOW_SERVICE);</span>
<span class="nc" id="L164">                    int rot = windowManager.getDefaultDisplay().getRotation();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6477)) {</span>
<span class="nc bnc" id="L166" title="All 5 branches missed.">                        switch(rot) {</span>
                            case Surface.ROTATION_0:
<span class="nc bnc" id="L168" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6469)) {</span>
                                    // No orientation change, use default coordinate system
<span class="nc" id="L170">                                    SensorManager.getOrientation(mRotationMatrix, mOrientation);</span>
                                }
                                // Log.d(TAG, &quot;Rotation-0&quot;);
                                break;
                            case Surface.ROTATION_90:
<span class="nc bnc" id="L175" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6470)) {</span>
                                    // Log.d(TAG, &quot;Rotation-90&quot;);
<span class="nc" id="L177">                                    SensorManager.remapCoordinateSystem(mRotationMatrix, SensorManager.AXIS_Y, SensorManager.AXIS_MINUS_X, mRemappedMatrix);</span>
                                }
<span class="nc bnc" id="L179" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6471)) {</span>
<span class="nc" id="L180">                                    SensorManager.getOrientation(mRemappedMatrix, mOrientation);</span>
                                }
                                break;
                            case Surface.ROTATION_180:
<span class="nc bnc" id="L184" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6472)) {</span>
                                    // Log.d(TAG, &quot;Rotation-180&quot;);
<span class="nc" id="L186">                                    SensorManager.remapCoordinateSystem(mRotationMatrix, SensorManager.AXIS_MINUS_X, SensorManager.AXIS_MINUS_Y, mRemappedMatrix);</span>
                                }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6473)) {</span>
<span class="nc" id="L189">                                    SensorManager.getOrientation(mRemappedMatrix, mOrientation);</span>
                                }
                                break;
                            case Surface.ROTATION_270:
<span class="nc bnc" id="L193" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6474)) {</span>
                                    // Log.d(TAG, &quot;Rotation-270&quot;);
<span class="nc" id="L195">                                    SensorManager.remapCoordinateSystem(mRotationMatrix, SensorManager.AXIS_MINUS_Y, SensorManager.AXIS_X, mRemappedMatrix);</span>
                                }
<span class="nc bnc" id="L197" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6475)) {</span>
<span class="nc" id="L198">                                    SensorManager.getOrientation(mRemappedMatrix, mOrientation);</span>
                                }
                                break;
                            default:
<span class="nc bnc" id="L202" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6476)) {</span>
                                    // This shouldn't happen - assume default orientation
<span class="nc" id="L204">                                    SensorManager.getOrientation(mRotationMatrix, mOrientation);</span>
                                }
                                // Log.d(TAG, &quot;Rotation-Unknown&quot;);
                                break;
                        }
                    }
<span class="nc bnc" id="L210" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6478)) {</span>
<span class="nc" id="L211">                        mHeading = (float) Math.toDegrees(mOrientation[0]);</span>
                    }
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6479)) {</span>
<span class="nc" id="L214">                        mPitch = (float) Math.toDegrees(mOrientation[1]);</span>
                    }
<span class="nc bnc" id="L216" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6484)) {</span>
<span class="nc bnc" id="L217" title="All 8 branches missed.">                        xDelta = (ListenerUtil.mutListener.listen(6483) ? (history[0] % mHeading) : (ListenerUtil.mutListener.listen(6482) ? (history[0] / mHeading) : (ListenerUtil.mutListener.listen(6481) ? (history[0] * mHeading) : (ListenerUtil.mutListener.listen(6480) ? (history[0] + mHeading) : (history[0] - mHeading)))));</span>
                    }
<span class="nc bnc" id="L219" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6489)) {</span>
<span class="nc bnc" id="L220" title="All 8 branches missed.">                        yDelta = (ListenerUtil.mutListener.listen(6488) ? (history[1] % mPitch) : (ListenerUtil.mutListener.listen(6487) ? (history[1] / mPitch) : (ListenerUtil.mutListener.listen(6486) ? (history[1] * mPitch) : (ListenerUtil.mutListener.listen(6485) ? (history[1] + mPitch) : (history[1] - mPitch)))));</span>
                    }
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6490)) {</span>
<span class="nc" id="L223">                        history[0] = mHeading;</span>
                    }
<span class="nc bnc" id="L225" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6491)) {</span>
<span class="nc" id="L226">                        history[1] = mPitch;</span>
                    }
                    break;
                case Sensor.TYPE_ORIENTATION:
<span class="nc bnc" id="L230" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6492)) {</span>
                        // Legacy orientation sensors
<span class="nc" id="L232">                        mHeading = event.values[0];</span>
                    }
<span class="nc bnc" id="L234" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6497)) {</span>
<span class="nc bnc" id="L235" title="All 8 branches missed.">                        xDelta = (ListenerUtil.mutListener.listen(6496) ? (history[0] % mHeading) : (ListenerUtil.mutListener.listen(6495) ? (history[0] / mHeading) : (ListenerUtil.mutListener.listen(6494) ? (history[0] * mHeading) : (ListenerUtil.mutListener.listen(6493) ? (history[0] + mHeading) : (history[0] - mHeading)))));</span>
                    }
                    break;
                default:
                    // A sensor we're not using, so return
<span class="nc" id="L240">                    return;</span>
            }
        }
        // Use magnetic field to compute true (geographic) north, if data is available
<span class="nc" id="L244">        Float magneticDeclination = Application.getMagneticDeclination();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6500)) {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (magneticDeclination != null) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6499)) {</span>
<span class="nc" id="L248">                    mHeading += magneticDeclination;</span>
                }
            }
        }
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6501)) {</span>
            // Make sure value is between 0-360
<span class="nc" id="L254">            mHeading = MathUtils.mod(mHeading, 360.0f);</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6503)) {</span>
            {
<span class="nc" id="L258">                long _loopCounter67 = 0;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                for (Listener l : mListeners) {</span>
<span class="nc" id="L260">                    ListenerUtil.loopListener.listen(&quot;_loopCounter67&quot;, ++_loopCounter67);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6502)) {</span>
<span class="nc" id="L262">                        l.onOrientationChanged(mHeading, mPitch, xDelta, yDelta);</span>
                    }
<span class="nc" id="L264">                }</span>
            }
        }
<span class="nc" id="L267">    }</span>

    @Override
    public void onAccuracyChanged(Sensor sensor, int accuracy) {
<span class="nc" id="L271">    }</span>

    @TargetApi(Build.VERSION_CODES.GINGERBREAD)
    private void getRotationMatrixFromTruncatedVector(float[] vector) {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6504)) {</span>
<span class="nc" id="L276">            System.arraycopy(vector, 0, mTruncatedRotationVector, 0, 4);</span>
        }
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6505)) {</span>
<span class="nc" id="L279">            SensorManager.getRotationMatrixFromVector(mRotationMatrix, mTruncatedRotationVector);</span>
        }
<span class="nc" id="L281">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>