<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DistanceToStopView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.view</a> &gt; <span class="el_source">DistanceToStopView.java</span></div><h1>DistanceToStopView.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2014 Sean J. Barbeau (sjbarbeau@gmail.com), University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.view;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.util.LocationHelper;

import android.content.Context;
import android.content.SharedPreferences;
import android.location.Location;
import android.util.AttributeSet;
import android.widget.TextView;

import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Locale;

/**
 * A TextView that updates itself with the distance to the given bus stop from the given location
 */
public class DistanceToStopView extends TextView implements LocationHelper.Listener {

    public interface Listener {

        /**
         * Called when the DistanceToStopView is showing information to the user
         */
        void onInitializationComplete();
    }

<span class="nc" id="L45">    private static String TAG = &quot;DistanceToStopView&quot;;</span>

    Context mContext;

    Location mStopLocation;

<span class="nc" id="L51">    ArrayList&lt;Listener&gt; mListeners = new ArrayList&lt;Listener&gt;();</span>

    private static final float MILES_TO_METERS = 0.000621371f;

    private static final float MILES_THRESHOLD = 0.25f;

    private static final float KILOMETERS_THRESHOLD = 0.25f;

    private static final float MILES_TO_FEET = 5280;

    NumberFormat mNumberFormat;

    Locale mLocale;

    private static String IMPERIAL;

    private static String METRIC;

    private static String AUTOMATIC;

    SharedPreferences mSettings;

    private String preferredUnits;

<span class="nc" id="L75">    boolean mInitialized = false;</span>

    public DistanceToStopView(Context context, AttributeSet attrs) {
<span class="nc" id="L78">        super(context, attrs);</span>
<span class="nc" id="L79">        mContext = context;</span>

<span class="nc" id="L81">        mNumberFormat = NumberFormat.getInstance();</span>
<span class="nc" id="L82">        mNumberFormat.setMaximumFractionDigits(1);</span>

<span class="nc" id="L84">        mLocale = Locale.getDefault();</span>
<span class="nc" id="L85">        IMPERIAL = mContext.getString(R.string.preferences_preferred_units_option_imperial);</span>
<span class="nc" id="L86">        METRIC = mContext.getString(R.string.preferences_preferred_units_option_metric);</span>
<span class="nc" id="L87">        AUTOMATIC = mContext.getString(R.string.preferences_preferred_units_option_automatic);</span>

<span class="nc" id="L89">        mSettings = Application.getPrefs();</span>
<span class="nc" id="L90">        preferredUnits = mSettings</span>
<span class="nc" id="L91">                .getString(mContext.getString(R.string.preference_key_preferred_units),</span>
                        AUTOMATIC);
<span class="nc" id="L93">    }</span>

    public synchronized void registerListener(Listener listener) {
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (!mListeners.contains(listener)) {</span>
<span class="nc" id="L97">            mListeners.add(listener);</span>
        }
<span class="nc" id="L99">    }</span>

    public synchronized void unregisterListener(Listener listener) {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (mListeners.contains(listener)) {</span>
<span class="nc" id="L103">            mListeners.remove(listener);</span>
        }
<span class="nc" id="L105">    }</span>

    /**
     * Sets the stop location that this view measures the distance to
     *
     * @param location stop location
     */
    public void setStopLocation(Location location) {
<span class="nc" id="L113">        mStopLocation = location;</span>
<span class="nc" id="L114">    }</span>

    /**
     * Should be called when the view is being shown again and the preferences
     * may have changed (typically, in onResume() of the parent context)
     */
    public void refreshUnitsPreference() {
<span class="nc" id="L121">        preferredUnits = mSettings</span>
<span class="nc" id="L122">                .getString(mContext.getString(R.string.preference_key_preferred_units),</span>
                        AUTOMATIC);
<span class="nc" id="L124">    }</span>

    /**
     * Returns true if the view is initialized and ready to draw to the screen, false if it is not
     *
     * @return true if the view is initialized and ready to draw to the screen, false if it is not
     */
    public boolean isInitialized() {
<span class="nc" id="L132">        return mInitialized;</span>
    }

    @Override
    public void onLocationChanged(Location location) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (mStopLocation != null) {</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (!mInitialized) {</span>
<span class="nc" id="L140">                mInitialized = true;</span>
                // Notify listeners that we have both stop and real-time location
<span class="nc bnc" id="L142" title="All 2 branches missed.">                for (Listener l : mListeners) {</span>
<span class="nc" id="L143">                    l.onInitializationComplete();</span>
<span class="nc" id="L144">                }</span>
            }

<span class="nc" id="L147">            Float distance = location.distanceTo(mStopLocation);</span>

<span class="nc bnc" id="L149" title="All 2 branches missed.">            if (distance != null) {</span>
<span class="nc" id="L150">                double miles = distance * MILES_TO_METERS;</span>
<span class="nc" id="L151">                distance /= 1000; // Convert meters to kilometers</span>

<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (preferredUnits.equalsIgnoreCase(AUTOMATIC)) {</span>
                    // Log.d(TAG, &quot;Setting units automatically&quot;);
                    // If the country is set to USA, assume imperial, otherwise metric
                    // TODO - Method of guessing metric/imperial can definitely be improved
<span class="nc bnc" id="L157" title="All 2 branches missed.">                    if (mLocale.getISO3Country().equalsIgnoreCase(Locale.US.getISO3Country())) {</span>
                        // Assume imperial
<span class="nc" id="L159">                        setDistanceTextView(miles, IMPERIAL);</span>
                    } else {
                        // Assume metric
<span class="nc" id="L162">                        setDistanceTextView(distance, METRIC);</span>
                    }
<span class="nc bnc" id="L164" title="All 2 branches missed.">                } else if (preferredUnits.equalsIgnoreCase(IMPERIAL)) {</span>
<span class="nc" id="L165">                    setDistanceTextView(miles, IMPERIAL);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                } else if (preferredUnits.equalsIgnoreCase(METRIC)) {</span>
<span class="nc" id="L167">                    setDistanceTextView(distance, METRIC);</span>
                }
<span class="nc" id="L169">                return;</span>
            }
        }

        // If we've gotten this far, distance isn't valid, so clear current text
<span class="nc" id="L174">        setText(&quot;&quot;);</span>
<span class="nc" id="L175">    }</span>

    /**
     * Sets the text view that contains distance with units based on input parameters
     *
     * @param distance the distance to be used, in miles (for imperial) or kilometers (for metric)
     * @param units    the units to be used from strings.xml, either preferences_preferred_units_option_metric
     *                 or preferences_preferred_units_option_imperial
     */
    private void setDistanceTextView(double distance, String units) {
        // Set TextView text
        // TODO - Set ContentDescription to be read by screen readers
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (units.equalsIgnoreCase(</span>
<span class="nc" id="L188">                mContext.getString(R.string.preferences_preferred_units_option_imperial))) {</span>
            // IMPERIAL
            // If the distance is greater than a quarter mile, show in miles, else show in feet
<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (distance &gt; MILES_THRESHOLD) {</span>
                // MILES
<span class="nc" id="L193">                mNumberFormat.setMaximumFractionDigits(1);</span>
<span class="nc" id="L194">                setText(mNumberFormat.format(distance) + &quot; &quot; + mContext</span>
<span class="nc" id="L195">                        .getString(R.string.miles_abbreviation));</span>
            } else {
                // FEET
<span class="nc" id="L198">                mNumberFormat.setMaximumFractionDigits(0);</span>
<span class="nc" id="L199">                double feet = distance * MILES_TO_FEET;</span>
<span class="nc" id="L200">                setText(mNumberFormat.format(feet) + &quot; &quot; + mContext</span>
<span class="nc" id="L201">                        .getString(R.string.feet_abbreviation));</span>
<span class="nc" id="L202">            }</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        } else if (units.equalsIgnoreCase(mContext.getString(</span>
                R.string.preferences_preferred_units_option_metric))) {
            // METRIC
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (distance &gt; KILOMETERS_THRESHOLD) {</span>
                // KILOMETERS
<span class="nc" id="L208">                mNumberFormat.setMaximumFractionDigits(1);</span>
<span class="nc" id="L209">                setText(mNumberFormat.format(distance) + &quot; &quot; + mContext</span>
<span class="nc" id="L210">                        .getString(R.string.kilometers_abbreviation));</span>
            } else {
                // METERS
<span class="nc" id="L213">                mNumberFormat.setMaximumFractionDigits(0);</span>
<span class="nc" id="L214">                double meters = distance * 1000;</span>
<span class="nc" id="L215">                setText(mNumberFormat.format(meters) + &quot; &quot; + mContext</span>
<span class="nc" id="L216">                        .getString(R.string.meters_abbreviation));</span>
            }
        }
<span class="nc" id="L219">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>