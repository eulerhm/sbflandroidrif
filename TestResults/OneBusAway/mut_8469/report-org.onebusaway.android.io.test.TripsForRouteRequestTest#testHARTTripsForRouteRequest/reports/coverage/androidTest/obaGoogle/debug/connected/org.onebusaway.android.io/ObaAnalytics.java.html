<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ObaAnalytics.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.io</a> &gt; <span class="el_source">ObaAnalytics.java</span></div><h1>ObaAnalytics.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2014-2019 University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.io;

import android.content.SharedPreferences;
import android.location.Location;
import android.os.Bundle;

import com.google.firebase.analytics.FirebaseAnalytics;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;

import static android.text.TextUtils.isEmpty;

/**
 * Analytics class for tracking the app
 *
 * @author Cagri Cetin, Sean Barbeau
 */

<span class="nc" id="L35">public class ObaAnalytics {</span>

    /**
     * Users location accuracy should be less then 50f
     */
    private static final float LOCATION_ACCURACY_THRESHOLD = 50f;

    /**
     * To measure the distance when the bus stop tapped.
     */
<span class="nc" id="L45">    public enum ObaStopDistance {</span>
<span class="nc" id="L46">        DISTANCE_1(&quot;User Distance: 00000-00050m&quot;, 50),</span>
<span class="nc" id="L47">        DISTANCE_2(&quot;User Distance: 00050-00100m&quot;, 100),</span>
<span class="nc" id="L48">        DISTANCE_3(&quot;User Distance: 00100-00200m&quot;, 200),</span>
<span class="nc" id="L49">        DISTANCE_4(&quot;User Distance: 00200-00400m&quot;, 400),</span>
<span class="nc" id="L50">        DISTANCE_5(&quot;User Distance: 00400-00800m&quot;, 800),</span>
<span class="nc" id="L51">        DISTANCE_6(&quot;User Distance: 00800-01600m&quot;, 1600),</span>
<span class="nc" id="L52">        DISTANCE_7(&quot;User Distance: 01600-03200m&quot;, 3200),</span>
<span class="nc" id="L53">        DISTANCE_8(&quot;User Distance: 03200-INFINITY&quot;, 0);</span>

        private final String stringValue;
        private final int distanceInMeters;

<span class="nc" id="L58">        ObaStopDistance(final String s, final int i) {</span>
<span class="nc" id="L59">            stringValue = s;</span>
<span class="nc" id="L60">            distanceInMeters = i;</span>
<span class="nc" id="L61">        }</span>

        public String toString() {
<span class="nc" id="L64">            return stringValue;</span>
        }

        public int getDistanceInMeters() {
<span class="nc" id="L68">            return distanceInMeters;</span>
        }
    }

    /**
     * Reports UI events using Firebase
     * @param analytics Firebase singleton
     * @param id ID of the UI element to report
     * @param state the state or variant of the UI item, or null if the item doesn't have a state or variant
     */
    public static void reportUiEvent(FirebaseAnalytics analytics, String id, String state) {
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L80">            return;</span>
        }
<span class="fc" id="L82">        Bundle bundle = new Bundle();</span>
<span class="fc" id="L83">        bundle.putString(FirebaseAnalytics.Param.ITEM_ID, id);</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (!isEmpty(state)) {</span>
<span class="fc" id="L85">            bundle.putString(FirebaseAnalytics.Param.ITEM_VARIANT, state);</span>
        }
<span class="fc" id="L87">        analytics.logEvent(FirebaseAnalytics.Event.SELECT_CONTENT, bundle);</span>
<span class="fc" id="L88">    }</span>

    /**
     * Reports Login events using Firebase
     * @param analytics Firebase singleton
     * @param signUpMethod Sign up method of the login, or null if unknown
     */
    public static void reportLoginEvent(FirebaseAnalytics analytics, String signUpMethod) {
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L97">            return;</span>
        }
<span class="nc" id="L99">        Bundle bundle = null;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (!isEmpty(signUpMethod)) {</span>
<span class="nc" id="L101">            bundle = new Bundle();</span>
<span class="nc" id="L102">            bundle.putString(FirebaseAnalytics.Param.METHOD, signUpMethod);</span>
        }
<span class="nc" id="L104">        analytics.logEvent(FirebaseAnalytics.Event.LOGIN, bundle);</span>
<span class="nc" id="L105">    }</span>

    /**
     * Reports Search events using Firebase
     * @param analytics Firebase singleton
     * @param searchTerm search term used, or null if unknown
     */
    public static void reportSearchEvent(FirebaseAnalytics analytics, String searchTerm) {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L114">            return;</span>
        }
<span class="nc" id="L116">        Bundle bundle = null;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!isEmpty(searchTerm)) {</span>
<span class="nc" id="L118">            bundle = new Bundle();</span>
<span class="nc" id="L119">            bundle.putString(FirebaseAnalytics.Param.SEARCH_TERM, searchTerm);</span>
        }
<span class="nc" id="L121">        analytics.logEvent(FirebaseAnalytics.Event.SEARCH, bundle);</span>
<span class="nc" id="L122">    }</span>

    /**
     * Reports the distance between bus stop location and device current location
     *
     * @param analytics Firebase singleton
     * @param stopId       bus stop ID
     * @param stopName bus stop name
     * @param myLocation   the device location
     * @param stopLocation bus stop location
     */
    public static void reportViewStopEvent(FirebaseAnalytics analytics, String stopId, String stopName, Location myLocation, Location stopLocation) {
<span class="nc bnc" id="L134" title="All 4 branches missed.">        if (!isAnalyticsActive() || myLocation == null) {</span>
<span class="nc" id="L135">            return;</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (myLocation.getAccuracy() &lt; LOCATION_ACCURACY_THRESHOLD) {</span>
<span class="nc" id="L138">            float distanceInMeters = myLocation.distanceTo(stopLocation);</span>
            ObaStopDistance stopDistance;

<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (distanceInMeters &lt; ObaStopDistance.DISTANCE_1.getDistanceInMeters()) {</span>
<span class="nc" id="L142">                stopDistance = ObaStopDistance.DISTANCE_1;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            } else if (distanceInMeters &lt; ObaStopDistance.DISTANCE_2.getDistanceInMeters()) {</span>
<span class="nc" id="L144">                stopDistance = ObaStopDistance.DISTANCE_2;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            } else if (distanceInMeters &lt; ObaStopDistance.DISTANCE_3.getDistanceInMeters()) {</span>
<span class="nc" id="L146">                stopDistance = ObaStopDistance.DISTANCE_3;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            } else if (distanceInMeters &lt; ObaStopDistance.DISTANCE_4.getDistanceInMeters()) {</span>
<span class="nc" id="L148">                stopDistance = ObaStopDistance.DISTANCE_4;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">            } else if (distanceInMeters &lt; ObaStopDistance.DISTANCE_5.getDistanceInMeters()) {</span>
<span class="nc" id="L150">                stopDistance = ObaStopDistance.DISTANCE_5;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            } else if (distanceInMeters &lt; ObaStopDistance.DISTANCE_6.getDistanceInMeters()) {</span>
<span class="nc" id="L152">                stopDistance = ObaStopDistance.DISTANCE_6;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">            } else if (distanceInMeters &lt; ObaStopDistance.DISTANCE_7.getDistanceInMeters()) {</span>
<span class="nc" id="L154">                stopDistance = ObaStopDistance.DISTANCE_7;</span>
            } else {
<span class="nc" id="L156">                stopDistance = ObaStopDistance.DISTANCE_8;</span>
            }

<span class="nc" id="L159">            reportViewStopEvent(analytics, stopId, stopName, stopDistance.toString());</span>
        }
<span class="nc" id="L161">    }</span>

    /**
     * Reports the user viewing a particular bus stop, as well as a categorized distance from that stop
     *
     * @param analytics       Firebase singleton
     * @param stopId          ID of the stop
     * @param stopName        Name of the stop
     * @param proximityToStopCategory a label indicating the proximity of the user to the stop
     */
    private static void reportViewStopEvent(FirebaseAnalytics analytics, String stopId, String stopName, String proximityToStopCategory) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L173">            return;</span>
        }
<span class="nc" id="L175">        Bundle bundle = new Bundle();</span>
<span class="nc" id="L176">        bundle.putString(FirebaseAnalytics.Param.ITEM_ID, stopId);</span>
<span class="nc" id="L177">        bundle.putString(FirebaseAnalytics.Param.ITEM_NAME, stopName);</span>
<span class="nc" id="L178">        bundle.putString(FirebaseAnalytics.Param.ITEM_CATEGORY, Application.get().getString(R.string.analytics_label_stop_category));</span>
<span class="nc" id="L179">        bundle.putString(FirebaseAnalytics.Param.LOCATION_ID, proximityToStopCategory);</span>
<span class="nc" id="L180">        analytics.logEvent(FirebaseAnalytics.Event.VIEW_ITEM, bundle);</span>
<span class="nc" id="L181">    }</span>

    /**
     * Sets the current region as a user property in Firebase Analytics
     * @param analytics Firebase singleton
     * @param regionName name of the region that was selected
     */
    public static void setRegion(FirebaseAnalytics analytics, String regionName) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L190">            return;</span>
        }
<span class="nc" id="L192">        analytics.setUserProperty(Application.get().getString(R.string.analytics_label_region_name), regionName);</span>
<span class="nc" id="L193">    }</span>

    /**
     * Sets if the user has set the preference to send anonymous usage data
     * @param analytics Firebase singleton
     * @param isAnalyticsActive true if the user has enabled the preference, or false if they have disabled it
     */
    public static void setSendAnonymousData(FirebaseAnalytics analytics, boolean isAnalyticsActive) {
<span class="nc bnc" id="L201" title="All 2 branches missed.">        analytics.setUserProperty(Application.get().getString(R.string.analytics_label_analytics_property), isAnalyticsActive ? &quot;YES&quot; : &quot;NO&quot;);</span>
<span class="nc" id="L202">        analytics.setAnalyticsCollectionEnabled(isAnalyticsActive);</span>
<span class="nc" id="L203">    }</span>

    /**
     * Sets if the user has set the preference for left handed mode
     * @param analytics Firebase singleton
     * @param isLeftHanded true if the user has enabled the left handed preference, or false if they have disabled it (default)
     */
    public static void setLeftHanded(FirebaseAnalytics analytics, boolean isLeftHanded) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L212">            return;</span>
        }
<span class="nc bnc" id="L214" title="All 2 branches missed.">        analytics.setUserProperty(Application.get().getString(R.string.analytics_label_left_hand_property), isLeftHanded ? &quot;YES&quot; : &quot;NO&quot;);</span>
<span class="nc" id="L215">    }</span>

    /**
     * Sets if the user has chosen to hide departed vehicles (i.e, negative prediction times)
     * @param analytics Firebase singleton
     * @param showDepartedVehicles true if the user has the preference enabled to see departed vehicles (default), or false if they have it disabled
     */
    public static void setShowDepartedVehicles(FirebaseAnalytics analytics, boolean showDepartedVehicles) {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L224">            return;</span>
        }
<span class="nc bnc" id="L226" title="All 2 branches missed.">        analytics.setUserProperty(Application.get().getString(R.string.analytics_label_show_departed_vehicles_property), showDepartedVehicles ? &quot;YES&quot; : &quot;NO&quot;);</span>
<span class="nc" id="L227">    }</span>

    /**
     * Sets if the user has enabled touch exploration (accessibility) on their device
     * @param analytics Firebase singleton
     * @param isAccessibilityActive true if the user has enabled touch exploration (accessibility) on their device, and false if they have not
     */
    public static void setAccessibility(FirebaseAnalytics analytics, boolean isAccessibilityActive) {
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L236">            return;</span>
        }
<span class="nc bnc" id="L238" title="All 2 branches missed.">        analytics.setUserProperty(Application.get().getString(R.string.analytics_accessibility), isAccessibilityActive ? &quot;YES&quot; : &quot;NO&quot;);</span>
<span class="nc" id="L239">    }</span>

    /**
     * @return is GA enabled or disabled from settings
     */
    private static Boolean isAnalyticsActive() {
<span class="fc" id="L245">        SharedPreferences settings = Application.getPrefs();</span>
<span class="fc" id="L246">        return settings.getBoolean(Application.get().getString(R.string.preferences_key_analytics), Boolean.TRUE);</span>
    }

    /**
     * Reports destination reminder feedback using Firebase
     * @param analytics Firebase singleton
     * @param wasGoodReminder true if the user responded that they got the reminder at the right time, or false if they responded that they did not get the reminder at the right time
     * @param feedbackText plain text feedback submitted by the user, or null if the user didn't enter any feedback text
     * @param fileName the name of the file that was uploaded that contains the data for this particular trip, or null if the user didn't upload data
     */
    public static void reportDestinationReminderFeedback(FirebaseAnalytics analytics, boolean wasGoodReminder, String feedbackText, String fileName) {
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (!isAnalyticsActive()) {</span>
<span class="nc" id="L258">            return;</span>
        }
<span class="nc" id="L260">        Bundle bundle = new Bundle();</span>
<span class="nc" id="L261">        bundle.putString(FirebaseAnalytics.Param.ITEM_ID, Application.get().getString(R.string.analytics_label_button_press_destination_reminder_feedback));</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (wasGoodReminder) {</span>
<span class="nc" id="L263">            bundle.putString(FirebaseAnalytics.Param.ITEM_VARIANT, Application.get().getString(R.string.analytics_label_destination_reminder_yes));</span>
        } else {
<span class="nc" id="L265">            bundle.putString(FirebaseAnalytics.Param.ITEM_VARIANT, Application.get().getString(R.string.analytics_label_destination_reminder_no));</span>
        }
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (!isEmpty(feedbackText)) {</span>
<span class="nc" id="L268">            bundle.putString(FirebaseAnalytics.Param.CONTENT, feedbackText);</span>
        }
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (!isEmpty(fileName)) {</span>
<span class="nc" id="L271">            bundle.putString(FirebaseAnalytics.Param.LOCATION_ID, fileName);</span>
        }
<span class="nc" id="L273">        analytics.logEvent(FirebaseAnalytics.Event.SELECT_CONTENT, bundle);</span>
<span class="nc" id="L274">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>