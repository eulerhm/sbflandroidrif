<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TripRequestBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.directions.util</a> &gt; <span class="el_source">TripRequestBuilder.java</span></div><h1>TripRequestBuilder.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2016 Cambridge Systematics, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.onebusaway.android.directions.util;

import android.app.Activity;
import android.os.Bundle;
import android.text.TextUtils;
import android.util.Log;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.directions.tasks.TripRequest;
import org.onebusaway.android.ui.TripModes;
import org.onebusaway.android.util.RegionUtils;
import org.opentripplanner.api.ws.Request;
import org.opentripplanner.routing.core.OptimizeType;
import org.opentripplanner.routing.core.TraverseMode;

import java.io.UnsupportedEncodingException;
import java.lang.ref.WeakReference;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLEncoder;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

public class TripRequestBuilder {

    private static final String ENCODING = &quot;UTF-8&quot;;
    private static final String TAG = &quot;TripRequestBuilder&quot;;

    private static final String ARRIVE_BY = &quot;.ARRIVE_BY&quot;;
    private static final String FROM_ADDRESS = &quot;.FROM_ADDRESS&quot;;
    private static final String FROM_LAT = &quot;.FROM_LAT&quot;;
    private static final String FROM_LON = &quot;.FROM_LON&quot;;
    private static final String FROM_NAME = &quot;.FROM_NAME&quot;;
    private static final String TO_ADDRESS = &quot;.TO_ADDRESS&quot;;
    private static final String TO_LAT = &quot;.TO_LAT&quot;;
    private static final String TO_LON = &quot;.TO_LON&quot;;
    private static final String TO_NAME = &quot;.TO_NAME&quot;;
    private static final String OPTIMIZE_TRANSFERS = &quot;.OPTIMIZE_TRANSFERS&quot;;
    private static final String WHEELCHAIR_ACCESSIBLE = &quot;.WHEELCHAIR_ACCESSIBLE&quot;;
    private static final String MAX_WALK_DISTANCE = &quot;.MAX_WALK_DISTANCE&quot;;
    private static final String MODE_SET = &quot;.MODE_SET&quot;;
    private static final String DATE_TIME = &quot;.DATE_TIME&quot;;

    private TripRequest.Callback mListener;

    private Bundle mBundle;

    private int mModeId;

<span class="nc" id="L70">    public TripRequestBuilder(Bundle bundle) {</span>
<span class="nc" id="L71">        this.mBundle = bundle;</span>
<span class="nc" id="L72">    }</span>

    public TripRequestBuilder setDepartureTime(Calendar calendar) {
<span class="nc" id="L75">        mBundle.putBoolean(ARRIVE_BY, false);</span>
<span class="nc" id="L76">        setDateTime(calendar.getTime());</span>
<span class="nc" id="L77">        return this;</span>
    }

    public TripRequestBuilder setArrivalTime(Calendar calendar) {
<span class="nc" id="L81">        mBundle.putBoolean(ARRIVE_BY, true);</span>
<span class="nc" id="L82">        setDateTime(calendar.getTime());</span>
<span class="nc" id="L83">        return this;</span>
    }

    // default value is false
    public boolean getArriveBy() {
<span class="nc" id="L88">        Boolean b = mBundle.getBoolean(ARRIVE_BY);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        return b == null ? false : b;</span>
    }

    public TripRequestBuilder setFrom(CustomAddress from) {
<span class="nc" id="L93">        mBundle.putParcelable(FROM_ADDRESS, from);</span>
<span class="nc" id="L94">        return this;</span>
    }

    public CustomAddress getFrom() {
<span class="nc" id="L98">        return (CustomAddress) mBundle.getParcelable(FROM_ADDRESS);</span>
    }

    public CustomAddress getTo() {
<span class="nc" id="L102">        return (CustomAddress) mBundle.getParcelable(TO_ADDRESS);</span>
    }

    public TripRequestBuilder setTo(CustomAddress to) {
<span class="nc" id="L106">        mBundle.putParcelable(TO_ADDRESS, to);</span>
<span class="nc" id="L107">        return this;</span>
    }

    public TripRequestBuilder setListener(TripRequest.Callback listener) {
<span class="nc" id="L111">        this.mListener = listener;</span>
<span class="nc" id="L112">        return this;</span>
    }

    public TripRequestBuilder setOptimizeTransfers(boolean set) {
<span class="nc bnc" id="L116" title="All 2 branches missed.">        mBundle.putSerializable(OPTIMIZE_TRANSFERS, set ? OptimizeType.TRANSFERS : OptimizeType.QUICK);</span>
<span class="nc" id="L117">        return this;</span>
    }

    private OptimizeType getOptimizeType() {
<span class="nc" id="L121">        OptimizeType type = (OptimizeType) mBundle.getSerializable(OPTIMIZE_TRANSFERS);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        return type == null ? OptimizeType.QUICK : type;</span>
    }

    public boolean getOptimizeTransfers() {
<span class="nc bnc" id="L126" title="All 2 branches missed.">        return getOptimizeType() == OptimizeType.TRANSFERS;</span>
    }

    public TripRequestBuilder setWheelchairAccessible(boolean wheelchair) {
<span class="nc" id="L130">        mBundle.putBoolean(WHEELCHAIR_ACCESSIBLE, wheelchair);</span>
<span class="nc" id="L131">        return this;</span>
    }

    public boolean getWheelchairAccessible() {
<span class="nc" id="L135">        return mBundle.getBoolean(WHEELCHAIR_ACCESSIBLE);</span>
    }

    public TripRequestBuilder setMaxWalkDistance(double walkDistance) {
<span class="nc" id="L139">        mBundle.putDouble(MAX_WALK_DISTANCE, walkDistance);</span>
<span class="nc" id="L140">        return this;</span>
    }

    public Double getMaxWalkDistance() {
<span class="nc" id="L144">        Double d = mBundle.getDouble(MAX_WALK_DISTANCE);</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">        return (d != 0 &amp;&amp; d != Double.MAX_VALUE) ? d : null;</span>
    }

    // Built in TraverseModeSet does not work properly so we cannot use request.setMode
    // This is built from examining dropdown on the OTP webapp
    // there are also airplane, bike, bike + ride, park + ride, kiss + ride, etc options
    // transit -&gt; TRANSIT,WALK
    // bus only -&gt; BUS,WALK
    // rail only -&gt; RAIL,TRAM,WALK (TRAM is included to allow light rail)
    public TripRequestBuilder setModeSetById(int id) {
        List&lt;String&gt; modes;

<span class="nc" id="L157">        mModeId = id;</span>
<span class="nc bnc" id="L158" title="All 6 branches missed.">        switch (id) {</span>
            // Transit only
            case TripModes.TRANSIT_ONLY:
<span class="nc" id="L161">                modes = Arrays.asList(TraverseMode.TRANSIT.toString(), TraverseMode.WALK.toString());</span>
<span class="nc" id="L162">                break;</span>
            // Transit &amp; bikeshare
            case TripModes.TRANSIT_AND_BIKE:
<span class="nc bnc" id="L165" title="All 2 branches missed.">                if (Application.isBikeshareEnabled()) {</span>
<span class="nc" id="L166">                    modes = Arrays.asList(TraverseMode.TRANSIT.toString(),</span>
<span class="nc" id="L167">                            TraverseMode.WALK.toString(),</span>
<span class="nc" id="L168">                            Application.get().getString(R.string.traverse_mode_bicycle_rent));</span>
                } else {
<span class="nc" id="L170">                    modes = Arrays.asList(TraverseMode.TRANSIT.toString(), TraverseMode.WALK.toString());</span>
                }
<span class="nc" id="L172">                break;</span>
            case TripModes.BUS_ONLY:
<span class="nc" id="L174">                modes = Arrays.asList(TraverseMode.BUS.toString(), TraverseMode.WALK.toString());</span>
<span class="nc" id="L175">                break;</span>
            case TripModes.RAIL_ONLY:
<span class="nc" id="L177">                modes = Arrays.asList(TraverseMode.RAIL.toString(), TraverseMode.TRAM.toString(),</span>
<span class="nc" id="L178">                        TraverseMode.WALK.toString());</span>
<span class="nc" id="L179">                break;</span>
            case TripModes.BIKESHARE:
<span class="nc" id="L181">                modes = Arrays.asList(Application.get().getString(R.string.traverse_mode_bicycle_rent));</span>
<span class="nc" id="L182">                break;</span>
            default:
<span class="nc" id="L184">                Log.e(TAG, &quot;Invalid mode set ID&quot;);</span>
<span class="nc" id="L185">                modes = Arrays.asList(TraverseMode.TRANSIT.toString(), TraverseMode.WALK.toString());</span>
<span class="nc" id="L186">                mModeId = -1;</span>
        }

<span class="nc" id="L189">        String modeString = TextUtils.join(&quot;,&quot;, modes);</span>
<span class="nc" id="L190">        mBundle.putString(MODE_SET, modeString);</span>
<span class="nc" id="L191">        return this;</span>
    }

    public int getModeSetId() {
        // IF bike mode is selected in the trip plan additional preferences but bikeshare is not enabled use the default mode (TRANSTI)
<span class="nc bnc" id="L196" title="All 4 branches missed.">        if (TripModes.BIKESHARE == mModeId &amp;&amp; !Application.isBikeshareEnabled()) {</span>
<span class="nc" id="L197">            return TripModes.TRANSIT_ONLY;</span>
        }
<span class="nc" id="L199">        return mModeId;</span>
    }

    private List&lt;String&gt; getModes() {
<span class="nc" id="L203">        String modeString = mBundle.getString(MODE_SET);</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (TextUtils.isEmpty(modeString)) {</span>
<span class="nc" id="L206">            return Arrays.asList(TraverseMode.TRANSIT.toString(), TraverseMode.WALK.toString());</span>
        }

<span class="nc" id="L209">        return Arrays.asList(TextUtils.split(modeString, &quot;,&quot;));</span>
    }

    private String getModeString() {
<span class="nc" id="L213">        return mBundle.getString(MODE_SET);</span>
    }

    public TripRequest execute(Activity activity) {
<span class="nc" id="L217">        String from = getAddressString(getFrom());</span>
<span class="nc" id="L218">        String to = getAddressString(getTo());</span>

<span class="nc bnc" id="L220" title="All 4 branches missed.">        if (TextUtils.isEmpty(from) || TextUtils.isEmpty(to)) {</span>
<span class="nc" id="L221">            throw new IllegalArgumentException(&quot;Must supply start and end to route between.&quot;);</span>
        }

<span class="nc" id="L224">        Request request = new Request();</span>
<span class="nc" id="L225">        request.setArriveBy(getArriveBy());</span>
<span class="nc" id="L226">        request.setFrom(from);</span>
<span class="nc" id="L227">        request.setTo(to);</span>
<span class="nc" id="L228">        request.setOptimize(getOptimizeType());</span>
<span class="nc" id="L229">        request.setWheelchair(getWheelchairAccessible());</span>

<span class="nc" id="L231">        Double maxWalkDistance = getMaxWalkDistance();</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (maxWalkDistance != null) {</span>
<span class="nc" id="L233">            request.setMaxWalkDistance(maxWalkDistance);</span>
        }

<span class="nc" id="L236">        Date d = getDateTime();</span>

        // OTP expects date/time in this format
<span class="nc" id="L239">        String date = getFormattedDate(OTPConstants.FORMAT_OTP_SERVER_DATE_REQUEST, d);</span>
<span class="nc" id="L240">        String time = getFormattedDate(OTPConstants.FORMAT_OTP_SERVER_TIME_REQUEST, d);</span>
<span class="nc" id="L241">        request.setDateTime(date, time);</span>

        // Request mode set does not work properly
<span class="nc" id="L244">        String modeString = mBundle.getString(MODE_SET);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (modeString != null) {</span>
<span class="nc" id="L246">            request.getParameters().put(&quot;mode&quot;, modeString);</span>
        }

        // Our default. This could be configurable.
<span class="nc" id="L250">        request.setShowIntermediateStops(true);</span>

        // TripRequest will accept a null value and give a user-friendly error
        String otpBaseUrl;
<span class="nc" id="L254">        Application app = Application.get();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (!TextUtils.isEmpty(app.getCustomOtpApiUrl())) {</span>
<span class="nc" id="L256">            otpBaseUrl = app.getCustomOtpApiUrl();</span>
<span class="nc" id="L257">            Log.d(TAG, &quot;Using custom OTP API URL set by user '&quot; + otpBaseUrl + &quot;'.&quot;);</span>
        } else {
<span class="nc" id="L259">            otpBaseUrl = app.getCurrentRegion().getOtpBaseUrl();</span>
        }
        try {
            // URI.parse() doesn't tell us if the scheme is missing, so use URL() instead (#126)
<span class="nc" id="L263">            URL url = new URL(otpBaseUrl);</span>
<span class="nc" id="L264">        } catch (MalformedURLException e) {</span>
            // Assume HTTPS scheme, since without a scheme the Uri won't parse the authority
<span class="nc" id="L266">            otpBaseUrl = activity.getString(R.string.https_prefix) + otpBaseUrl;</span>
<span class="nc" id="L267">        }</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        String fmtOtpBaseUrl = otpBaseUrl != null ? RegionUtils.formatOtpBaseUrl(otpBaseUrl) : null;</span>

        TripRequest tripRequest;

<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (activity == null) {</span>
<span class="nc" id="L273">            tripRequest = new TripRequest(fmtOtpBaseUrl, mListener);</span>
        } else {
<span class="nc" id="L275">            WeakReference&lt;Activity&gt; ref = new WeakReference&lt;Activity&gt;(activity);</span>
<span class="nc" id="L276">            tripRequest = new TripRequest(fmtOtpBaseUrl, mListener);</span>
        }

<span class="nc" id="L279">        tripRequest.execute(request);</span>
<span class="nc" id="L280">        return tripRequest;</span>
    }

    public void execute() {
<span class="nc" id="L284">        execute(null);</span>
<span class="nc" id="L285">    }</span>

    private String getAddressString(CustomAddress address) {
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (address == null) {</span>
<span class="nc" id="L289">            return null;</span>
        }

<span class="nc bnc" id="L292" title="All 4 branches missed.">        if (address.hasLatitude() &amp;&amp; address.hasLongitude()) {</span>
<span class="nc" id="L293">            double lat = address.getLatitude();</span>
<span class="nc" id="L294">            double lon = address.getLongitude();</span>
<span class="nc" id="L295">            return String.format(OTPConstants.OTP_LOCALE, &quot;%g,%g&quot;, lat, lon);</span>
        }
        // Not set via geocoder OR via location service. Use raw string (set in TripPlanFragment to first line of address).
<span class="nc" id="L298">        String line = address.getAddressLine(0);</span>
        try {
<span class="nc" id="L300">            return URLEncoder.encode(line, ENCODING);</span>
<span class="nc" id="L301">        } catch (UnsupportedEncodingException ex) {</span>
<span class="nc" id="L302">            Log.e(TAG, &quot;Error encoding address: &quot; + ex);</span>
<span class="nc" id="L303">            return &quot;&quot;;</span>
        }
    }

    public TripRequestBuilder setDateTime(Date d) {
<span class="nc" id="L308">        mBundle.putLong(DATE_TIME, d.getTime());</span>
<span class="nc" id="L309">        return this;</span>
    }

    public TripRequestBuilder setDateTime(Calendar cal) {
<span class="nc" id="L313">        return setDateTime(cal.getTime());</span>
    }

    public Date getDateTime() {
<span class="nc" id="L317">        Long time = mBundle.getLong(DATE_TIME);</span>
<span class="nc bnc" id="L318" title="All 4 branches missed.">        if (time == null || time == 0L) {</span>
<span class="nc" id="L319">            return null;</span>
        } else {
<span class="nc" id="L321">            return new Date(time);</span>
        }
    }

    public Bundle getBundle() {
<span class="nc" id="L326">        return mBundle;</span>
    }

    /**
     * Copy all the data from this builder's bundle into another bundle
     * @param target bundle
     */
    public void copyIntoBundle(Bundle target) {
<span class="nc" id="L334">        target.putBoolean(ARRIVE_BY, getArriveBy());</span>
<span class="nc" id="L335">        target.putParcelable(FROM_ADDRESS, getFrom());</span>
<span class="nc" id="L336">        target.putParcelable(TO_ADDRESS, getTo());</span>
<span class="nc" id="L337">        target.putSerializable(OPTIMIZE_TRANSFERS, getOptimizeType());</span>
<span class="nc" id="L338">        target.putBoolean(WHEELCHAIR_ACCESSIBLE, getWheelchairAccessible());</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (getMaxWalkDistance() != null) {</span>
<span class="nc" id="L340">            target.putDouble(MAX_WALK_DISTANCE, getMaxWalkDistance());</span>
        }
<span class="nc" id="L342">        target.putString(MODE_SET, getModeString());</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (getDateTime() != null) {</span>
<span class="nc" id="L344">            target.putLong(DATE_TIME, getDateTime().getTime());</span>
        }
<span class="nc" id="L346">    }</span>

    /**
     * Copy all the data from this builder's bundle into another bundle, but only use simple data types
     * @param target bundle
     */
    public void copyIntoBundleSimple(Bundle target) {
<span class="nc" id="L353">        target.putBoolean(ARRIVE_BY, getArriveBy());</span>
<span class="nc" id="L354">        CustomAddress from = getFrom(), to = getTo();</span>
<span class="nc" id="L355">        target.putDouble(FROM_LAT, from.getLatitude());</span>
<span class="nc" id="L356">        target.putDouble(FROM_LON, from.getLongitude());</span>
<span class="nc" id="L357">        target.putString(FROM_NAME, from.toString());</span>
<span class="nc" id="L358">        target.putDouble(TO_LAT, to.getLatitude());</span>
<span class="nc" id="L359">        target.putDouble(TO_LON, to.getLongitude());</span>
<span class="nc" id="L360">        target.putString(TO_NAME, to.toString());</span>
<span class="nc" id="L361">        target.putString(OPTIMIZE_TRANSFERS, getOptimizeType().toString());</span>
<span class="nc" id="L362">        target.putBoolean(WHEELCHAIR_ACCESSIBLE, getWheelchairAccessible());</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (getMaxWalkDistance() != null) {</span>
<span class="nc" id="L364">            target.putDouble(MAX_WALK_DISTANCE, getMaxWalkDistance());</span>
        }
<span class="nc" id="L366">        target.putString(MODE_SET, getModeString());</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (getDateTime() != null) {</span>
<span class="nc" id="L368">            target.putLong(DATE_TIME, getDateTime().getTime());</span>
        }
<span class="nc" id="L370">    }</span>

    /**
     * Initialize from a BaseBundle
     */
    public static TripRequestBuilder initFromBundleSimple(Bundle bundle) {
<span class="nc" id="L376">        Bundle target = new Bundle();</span>
<span class="nc" id="L377">        target.putBoolean(ARRIVE_BY, bundle.getBoolean(ARRIVE_BY));</span>

<span class="nc" id="L379">        CustomAddress from = new CustomAddress();</span>
<span class="nc" id="L380">        from.setLatitude(bundle.getDouble(FROM_LAT));</span>
<span class="nc" id="L381">        from.setLongitude(bundle.getDouble(FROM_LON));</span>
<span class="nc" id="L382">        from.setAddressLine(0, bundle.getString(FROM_NAME));</span>
<span class="nc" id="L383">        CustomAddress to = new CustomAddress();</span>
<span class="nc" id="L384">        to.setLatitude(bundle.getDouble(TO_LAT));</span>
<span class="nc" id="L385">        to.setLongitude(bundle.getDouble(TO_LON));</span>
<span class="nc" id="L386">        to.setAddressLine(0, bundle.getString(TO_NAME));</span>

<span class="nc" id="L388">        target.putParcelable(FROM_ADDRESS, from);</span>
<span class="nc" id="L389">        target.putParcelable(TO_ADDRESS, to);</span>

<span class="nc" id="L391">        String optName = bundle.getString(OPTIMIZE_TRANSFERS);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (optName != null) {</span>
<span class="nc" id="L393">            target.putSerializable(OPTIMIZE_TRANSFERS, OptimizeType.valueOf(optName));</span>
        }

<span class="nc" id="L396">        target.putBoolean(WHEELCHAIR_ACCESSIBLE, bundle.getBoolean(WHEELCHAIR_ACCESSIBLE));</span>
<span class="nc" id="L397">        target.putDouble(MAX_WALK_DISTANCE, bundle.getDouble(MAX_WALK_DISTANCE));</span>

<span class="nc" id="L399">        target.putString(MODE_SET, bundle.getString(MODE_SET));</span>
<span class="nc" id="L400">        target.putLong(DATE_TIME, bundle.getLong(DATE_TIME));</span>

<span class="nc" id="L402">        return new TripRequestBuilder(target);</span>
    }

    /**
     * Determine whether this trip request can be submitted to an OTP server.
     * @return true if ready to submit, false otherwise
     */
    public boolean ready() {
<span class="nc bnc" id="L410" title="All 6 branches missed.">        return getFrom() != null &amp;&amp; getFrom().isSet() &amp;&amp; getTo() != null</span>
<span class="nc bnc" id="L411" title="All 4 branches missed.">                &amp;&amp; getTo().isSet() &amp;&amp; getDateTime() != null;</span>
    }

    private static String getFormattedDate(String format, Date date) {
<span class="nc" id="L415">        return new SimpleDateFormat(format, OTPConstants.OTP_LOCALE).format(date);</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>