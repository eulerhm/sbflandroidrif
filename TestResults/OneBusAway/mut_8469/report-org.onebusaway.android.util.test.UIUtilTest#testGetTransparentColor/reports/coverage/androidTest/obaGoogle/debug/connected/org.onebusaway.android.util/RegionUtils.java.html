<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegionUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.util</a> &gt; <span class="el_source">RegionUtils.java</span></div><h1>RegionUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2012-2017 Paul Watts (paulcwatts@gmail.com),
 * University of South Florida (sjbarbeau@gmail.com),
 * Microsoft Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.util;

import org.onebusaway.android.BuildConfig;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.elements.ObaRegion;
import org.onebusaway.android.io.elements.ObaRegionElement;
import org.onebusaway.android.io.request.ObaRegionsRequest;
import org.onebusaway.android.io.request.ObaRegionsResponse;
import org.onebusaway.android.provider.ObaContract;

import android.content.ContentResolver;
import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.location.Location;
import android.net.Uri;
import android.util.Log;

import java.security.MessageDigest;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

/**
 * A class containing utility methods related to handling multiple regions in OneBusAway
 */
<span class="nc" id="L49">public class RegionUtils {</span>

    private static final String TAG = &quot;RegionUtils&quot;;

    public static final int TAMPA_REGION_ID = 0;

    public static final int PUGET_SOUND_REGION_ID = 1;

    public static final int ATLANTA_REGION_ID = 3;

    public static final double METERS_TO_MILES = 0.000621371;

    private static final int DISTANCE_LIMITER = 100;  // miles

    /**
     * Get the closest region from a list of regions and a given location
     *
     * This method also enforces the constraints in isRegionUsable() to
     * ensure the returned region is actually usable by the app
     *
     * @param regions list of regions
     * @param loc     location
     * @param enforceThreshold true if the DISTANCE_LIMITER threshold should be enforced, false if
     *                         it should not
     * @return the closest region to the given location from the list of regions, or null if a
     * enforceThreshold is true and the closest region exceeded DISTANCE_LIMITER threshold or a
     * region couldn't be found
     */
    public static ObaRegion getClosestRegion(ArrayList&lt;ObaRegion&gt; regions, Location loc,
            boolean enforceThreshold) {
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">        if (loc == null) {</span>
<span class="nc" id="L80">            return null;</span>
        }
<span class="fc" id="L82">        float minDist = Float.MAX_VALUE;</span>
<span class="fc" id="L83">        ObaRegion closestRegion = null;</span>
        Float distToRegion;

<span class="fc" id="L86">        NumberFormat fmt = NumberFormat.getInstance();</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if (fmt instanceof DecimalFormat) {</span>
<span class="fc" id="L88">            ((DecimalFormat) fmt).setMaximumFractionDigits(1);</span>
        }
        double miles;

<span class="fc" id="L92">        Log.d(TAG, &quot;Finding region closest to &quot; + loc.getLatitude() + &quot;,&quot; + loc.getLongitude());</span>

<span class="fc bfc" id="L94" title="All 2 branches covered.">        for (ObaRegion region : regions) {</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">            if (!isRegionUsable(region)) {</span>
<span class="fc" id="L96">                Log.d(TAG,</span>
<span class="fc" id="L97">                        &quot;Excluding '&quot; + region.getName() + &quot;' from 'closest region' consideration&quot;);</span>
<span class="fc" id="L98">                continue;</span>
            }

<span class="fc" id="L101">            distToRegion = getDistanceAway(region, loc.getLatitude(), loc.getLongitude());</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">            if (distToRegion == null) {</span>
<span class="nc" id="L103">                Log.e(TAG, &quot;Couldn't measure distance to region '&quot; + region.getName() + &quot;'&quot;);</span>
<span class="nc" id="L104">                continue;</span>
            }
<span class="fc" id="L106">            miles = distToRegion * METERS_TO_MILES;</span>
<span class="fc" id="L107">            Log.d(TAG, &quot;Region '&quot; + region.getName() + &quot;' is &quot; + fmt.format(miles) + &quot; miles away&quot;);</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">            if (distToRegion &lt; minDist) {</span>
<span class="fc" id="L109">                closestRegion = region;</span>
<span class="fc" id="L110">                minDist = distToRegion;</span>
            }
<span class="fc" id="L112">        }</span>

<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (enforceThreshold) {</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">            if (minDist * METERS_TO_MILES &lt; DISTANCE_LIMITER) {</span>
<span class="fc" id="L116">                return closestRegion;</span>
            } else {
<span class="fc" id="L118">                return null;</span>
            }
        }
<span class="fc" id="L121">        return closestRegion;</span>
    }

    /**
     * Get the region name if it is available. If there is a custom url instead of a region from
     * the region api, then hash the custom url and return it.
     *
     * @return regionName
     */
    public static String getObaRegionName() {
<span class="nc" id="L131">        String regionName = null;</span>
<span class="nc" id="L132">        ObaRegion region = Application.get().getCurrentRegion();</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">        if (region != null &amp;&amp; region.getName() != null) {</span>
<span class="nc" id="L134">            regionName = region.getName();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        } else if (Application.get().getCustomApiUrl() != null) {</span>
<span class="nc" id="L136">            regionName = createHashCode(Application.get().getCustomApiUrl().getBytes());</span>
        }
<span class="nc" id="L138">        return regionName;</span>
    }

    private static String createHashCode(byte[] bytes) {
        MessageDigest digest;
        try {
<span class="nc" id="L144">            digest = MessageDigest.getInstance(&quot;SHA-1&quot;);</span>
<span class="nc" id="L145">            digest.update(bytes);</span>
<span class="nc" id="L146">            return Application.get().getString(R.string.analytics_label_custom_url) +</span>
<span class="nc" id="L147">                    &quot;: &quot; + Application.getHex(digest.digest());</span>
<span class="nc" id="L148">        } catch (Exception e) {</span>
<span class="nc" id="L149">            return Application.get().getString(R.string.analytics_label_custom_url);</span>
        }
    }

    /**
     * Returns the distance from the specified location
     * to the center of the closest bound in this region.
     *
     * @return distance from the specified location to the center of the closest bound in this
     * region, in meters
     */
    public static Float getDistanceAway(ObaRegion region, double lat, double lon) {
<span class="fc" id="L161">        ObaRegion.Bounds[] bounds = region.getBounds();</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if (bounds == null) {</span>
<span class="nc" id="L163">            return null;</span>
        }
<span class="fc" id="L165">        float[] results = new float[1];</span>
<span class="fc" id="L166">        float minDistance = Float.MAX_VALUE;</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">        for (ObaRegion.Bounds bound : bounds) {</span>
<span class="fc" id="L168">            Location.distanceBetween(lat, lon, bound.getLat(), bound.getLon(), results);</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">            if (results[0] &lt; minDistance) {</span>
<span class="fc" id="L170">                minDistance = results[0];</span>
            }
        }
<span class="fc" id="L173">        return minDistance;</span>
    }

    public static Float getDistanceAway(ObaRegion region, Location loc) {
<span class="fc" id="L177">        return getDistanceAway(region, loc.getLatitude(), loc.getLongitude());</span>
    }

    /**
     * Returns the center and lat/lon span for the entire region.
     *
     * @param results Array to receive results.
     *                results[0] == latSpan of region
     *                results[1] == lonSpan of region
     *                results[2] == lat center of region
     *                results[3] == lon center of region
     */
    public static void getRegionSpan(ObaRegion region, double[] results) {
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        if (results.length &lt; 4) {</span>
<span class="nc" id="L191">            throw new IllegalArgumentException(&quot;Results array is &lt; 4&quot;);</span>
        }
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (region == null) {</span>
<span class="nc" id="L194">            throw new IllegalArgumentException(&quot;Region is null&quot;);</span>
        }
<span class="fc" id="L196">        double latMin = 90;</span>
<span class="fc" id="L197">        double latMax = -90;</span>
<span class="fc" id="L198">        double lonMin = 180;</span>
<span class="fc" id="L199">        double lonMax = -180;</span>

        // This is fairly simplistic
<span class="fc bfc" id="L202" title="All 2 branches covered.">        for (ObaRegion.Bounds bound : region.getBounds()) {</span>
            // Get the top bound
<span class="fc" id="L204">            double lat = bound.getLat();</span>
<span class="fc" id="L205">            double latSpanHalf = bound.getLatSpan() / 2.0;</span>
<span class="fc" id="L206">            double lat1 = lat - latSpanHalf;</span>
<span class="fc" id="L207">            double lat2 = lat + latSpanHalf;</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">            if (lat1 &lt; latMin) {</span>
<span class="fc" id="L209">                latMin = lat1;</span>
            }
<span class="fc bfc" id="L211" title="All 2 branches covered.">            if (lat2 &gt; latMax) {</span>
<span class="fc" id="L212">                latMax = lat2;</span>
            }

<span class="fc" id="L215">            double lon = bound.getLon();</span>
<span class="fc" id="L216">            double lonSpanHalf = bound.getLonSpan() / 2.0;</span>
<span class="fc" id="L217">            double lon1 = lon - lonSpanHalf;</span>
<span class="fc" id="L218">            double lon2 = lon + lonSpanHalf;</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">            if (lon1 &lt; lonMin) {</span>
<span class="fc" id="L220">                lonMin = lon1;</span>
            }
<span class="fc bfc" id="L222" title="All 2 branches covered.">            if (lon2 &gt; lonMax) {</span>
<span class="fc" id="L223">                lonMax = lon2;</span>
            }
        }

<span class="fc" id="L227">        results[0] = latMax - latMin;</span>
<span class="fc" id="L228">        results[1] = lonMax - lonMin;</span>
<span class="fc" id="L229">        results[2] = latMin + ((latMax - latMin) / 2.0);</span>
<span class="fc" id="L230">        results[3] = lonMin + ((lonMax - lonMin) / 2.0);</span>
<span class="fc" id="L231">    }</span>

    /**
     * Determines if the provided location is within the provided region span
     *
     * Note: This does not handle cases when the region span crosses the
     * International Date Line properly
     *
     * @param location   that will be compared to the provided regionSpan
     * @param regionSpan span information for the region
     *                   regionSpan[0] == latSpan of region
     *                   regionSpan[1] == lonSpan of region
     *                   regionSpan[2] == lat center of region
     *                   regionSpan[3] == lon center of region
     * @return true if the location is within the region span, false if it is not
     */
    public static boolean isLocationWithinRegion(Location location, double[] regionSpan) {
<span class="nc bnc" id="L248" title="All 4 branches missed.">        if (regionSpan == null || regionSpan.length &lt; 4) {</span>
<span class="nc" id="L249">            throw new IllegalArgumentException(&quot;regionSpan is null or has length &lt; 4&quot;);</span>
        }

<span class="nc bnc" id="L252" title="All 6 branches missed.">        if (location == null || location.getLongitude() &gt; 180.0 || location.getLongitude() &lt; -180.0</span>
                ||
<span class="nc bnc" id="L254" title="All 4 branches missed.">                location.getLatitude() &gt; 90 || location.getLatitude() &lt; -90) {</span>
<span class="nc" id="L255">            throw new IllegalArgumentException(&quot;Location must be a valid location&quot;);</span>
        }

<span class="nc" id="L258">        double minLat = regionSpan[2] - (regionSpan[0] / 2);</span>
<span class="nc" id="L259">        double minLon = regionSpan[3] - (regionSpan[1] / 2);</span>
<span class="nc" id="L260">        double maxLat = regionSpan[2] + (regionSpan[0] / 2);</span>
<span class="nc" id="L261">        double maxLon = regionSpan[3] + (regionSpan[1] / 2);</span>

<span class="nc bnc" id="L263" title="All 4 branches missed.">        return minLat &lt;= location.getLatitude() &amp;&amp; location.getLatitude() &lt;= maxLat</span>
<span class="nc bnc" id="L264" title="All 4 branches missed.">                &amp;&amp; minLon &lt;= location.getLongitude() &amp;&amp; location.getLongitude() &lt;= maxLon;</span>
    }

    /**
     * Determines if the provided location is within the provided region
     *
     * Note: This does not handle cases when the region span crosses the
     * International Date Line properly
     *
     * @param location that will be compared to the provided region
     * @param region   provided region
     * @return true if the location is within the region, false if it is not
     */
    public static boolean isLocationWithinRegion(Location location, ObaRegion region) {
<span class="nc" id="L278">        double[] regionSpan = new double[4];</span>
<span class="nc" id="L279">        getRegionSpan(region, regionSpan);</span>
<span class="nc" id="L280">        return isLocationWithinRegion(location, regionSpan);</span>
    }

    /**
     * Checks if the given region is usable by the app, based on what this app supports
     * - Is the region active?
     * - Does the region support the OBA Discovery APIs?
     * - Does the region support the OBA Realtime APIs?
     * - Is the region experimental, and if so, did the user opt-in via preferences?
     *
     * @param region region to be checked
     * @return true if the region is usable by this application, false if it is not
     */
    public static boolean isRegionUsable(ObaRegion region) {
<span class="fc bfc" id="L294" title="All 2 branches covered.">        if (!region.getActive()) {</span>
<span class="fc" id="L295">            Log.d(TAG, &quot;Region '&quot; + region.getName() + &quot;' is not active.&quot;);</span>
<span class="fc" id="L296">            return false;</span>
        }
<span class="fc bfc" id="L298" title="All 2 branches covered.">        if (!region.getSupportsObaDiscoveryApis()) {</span>
<span class="fc" id="L299">            Log.d(TAG, &quot;Region '&quot; + region.getName() + &quot;' does not support OBA Discovery APIs.&quot;);</span>
<span class="fc" id="L300">            return false;</span>
        }
<span class="fc bfc" id="L302" title="All 2 branches covered.">        if (!region.getSupportsObaRealtimeApis()) {</span>
<span class="fc" id="L303">            Log.d(TAG, &quot;Region '&quot; + region.getName() + &quot;' does not support OBA Realtime APIs.&quot;);</span>
<span class="fc" id="L304">            return false;</span>
        }
<span class="pc bpc" id="L306" title="1 of 4 branches missed.">        if (region.getExperimental() &amp;&amp; !Application.getPrefs().getBoolean(</span>
<span class="fc" id="L307">                Application.get().getString(R.string.preference_key_experimental_regions), false)) {</span>
<span class="fc" id="L308">            Log.d(TAG,</span>
<span class="fc" id="L309">                    &quot;Region '&quot; + region.getName() + &quot;' is experimental and user hasn't opted in.&quot;);</span>
<span class="fc" id="L310">            return false;</span>
        }

<span class="fc" id="L313">        return true;</span>
    }

    /**
     * Format the OTP base URL so query parameters can be added safely.
     *
     * @param baseUrl OpenTripPlanner base URL from the Region
     * @return OTP server URL with trailing slash trimmed.
     */
    public static String formatOtpBaseUrl(String baseUrl) {
<span class="nc" id="L323">        return baseUrl.replaceFirst(&quot;/$&quot;, &quot;&quot;);</span>
    }

    /**
     * Gets regions from either the server, local provider, or if both fails the regions file
     * packaged
     * with the APK.  Includes fail-over logic to prefer sources in above order, with server being
     * the first preference.
     *
     * @param forceReload true if a reload from the server should be forced, false if it should not
     * @return a list of regions from either the server, the local provider, or the packaged
     * resource file
     */
    public synchronized static ArrayList&lt;ObaRegion&gt; getRegions(Context context,
            boolean forceReload) {
        ArrayList&lt;ObaRegion&gt; results;
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (!forceReload) {</span>
            //
            // Check the DB
            //
<span class="nc" id="L343">            results = RegionUtils.getRegionsFromProvider(context);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (results != null) {</span>
<span class="nc" id="L345">                Log.d(TAG, &quot;Retrieved regions from database.&quot;);</span>
<span class="nc" id="L346">                return results;</span>
            }
<span class="nc" id="L348">            Log.d(TAG, &quot;Regions list retrieved from database was null.&quot;);</span>
        }

<span class="nc" id="L351">        results = RegionUtils.getRegionsFromServer(context);</span>
<span class="nc bnc" id="L352" title="All 4 branches missed.">        if (results == null || results.isEmpty()) {</span>
<span class="nc" id="L353">            Log.d(TAG, &quot;Regions list retrieved from server was null or empty.&quot;);</span>

<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (forceReload) {</span>
                //If we tried to force a reload from the server, then we haven't tried to reload from local provider yet
<span class="nc" id="L357">                results = RegionUtils.getRegionsFromProvider(context);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                if (results != null) {</span>
<span class="nc" id="L359">                    Log.d(TAG, &quot;Retrieved regions from database.&quot;);</span>
<span class="nc" id="L360">                    return results;</span>
                } else {
<span class="nc" id="L362">                    Log.d(TAG, &quot;Regions list retrieved from database was null.&quot;);</span>
                }
            }

            //If we reach this point, the call to the Regions REST API failed and no results were
            //available locally from a prior server request.        
            //Fetch regions from local resource file as last resort (otherwise user can't use app)
<span class="nc" id="L369">            results = RegionUtils.getRegionsFromResources(context);</span>

<span class="nc bnc" id="L371" title="All 2 branches missed.">            if (results == null) {</span>
                //This is a complete failure to load region info from all sources, app will be useless
<span class="nc" id="L373">                Log.d(TAG, &quot;Regions list retrieved from local resource file was null.&quot;);</span>
<span class="nc" id="L374">                return results;</span>
            }

<span class="nc" id="L377">            Log.d(TAG, &quot;Retrieved regions from local resource file.&quot;);</span>
        } else {
<span class="nc" id="L379">            Log.d(TAG, &quot;Retrieved regions list from server.&quot;);</span>
            //Update local time for when the last region info was retrieved from the server
<span class="nc" id="L381">            Application.get().setLastRegionUpdateDate(new Date().getTime());</span>
        }

        //If the region info came from the server or local resource file, we need to save it to the local provider
<span class="nc" id="L385">        RegionUtils.saveToProvider(context, results);</span>
<span class="nc" id="L386">        return results;</span>
    }

    public static ArrayList&lt;ObaRegion&gt; getRegionsFromProvider(Context context) {
        // Prefetch the bounds to limit the number of DB calls.
<span class="fc" id="L391">        HashMap&lt;Long, ArrayList&lt;ObaRegionElement.Bounds&gt;&gt; allBounds = getBoundsFromProvider(</span>
                context);

<span class="fc" id="L394">        HashMap&lt;Long, ArrayList&lt;ObaRegionElement.Open311Server&gt;&gt; allOpen311Servers =</span>
<span class="fc" id="L395">                getOpen311ServersFromProvider(context);</span>

<span class="fc" id="L397">        Cursor c = null;</span>
        try {
<span class="fc" id="L399">            final String[] PROJECTION = {</span>
                    ObaContract.Regions._ID,
                    ObaContract.Regions.NAME,
                    ObaContract.Regions.OBA_BASE_URL,
                    ObaContract.Regions.SIRI_BASE_URL,
                    ObaContract.Regions.LANGUAGE,
                    ObaContract.Regions.CONTACT_EMAIL,
                    ObaContract.Regions.SUPPORTS_OBA_DISCOVERY,
                    ObaContract.Regions.SUPPORTS_OBA_REALTIME,
                    ObaContract.Regions.SUPPORTS_SIRI_REALTIME,
                    ObaContract.Regions.TWITTER_URL,
                    ObaContract.Regions.EXPERIMENTAL,
                    ObaContract.Regions.STOP_INFO_URL,
                    ObaContract.Regions.OTP_BASE_URL,
                    ObaContract.Regions.OTP_CONTACT_EMAIL,
                    ObaContract.Regions.SUPPORTS_OTP_BIKESHARE,
                    ObaContract.Regions.SUPPORTS_EMBEDDED_SOCIAL,
                    ObaContract.Regions.PAYMENT_ANDROID_APP_ID,
                    ObaContract.Regions.PAYMENT_WARNING_TITLE,
                    ObaContract.Regions.PAYMENT_WARNING_BODY,
                    ObaContract.Regions.TRAVEL_BEHAVIOR_DATA_COLLECTION,
                    ObaContract.Regions.ENROLL_PARTICIPANTS_IN_STUDY
            };

<span class="fc" id="L423">            ContentResolver cr = context.getContentResolver();</span>
<span class="fc" id="L424">            c = cr.query(</span>
                    ObaContract.Regions.CONTENT_URI, PROJECTION, null, null,
                    ObaContract.Regions._ID);
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">            if (c == null) {</span>
<span class="nc" id="L428">                return null;</span>
            }
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">            if (c.getCount() == 0) {</span>
<span class="nc" id="L431">                c.close();</span>
<span class="nc" id="L432">                return null;</span>
            }
<span class="fc" id="L434">            ArrayList&lt;ObaRegion&gt; results = new ArrayList&lt;ObaRegion&gt;();</span>

<span class="fc" id="L436">            c.moveToFirst();</span>
            do {
<span class="fc" id="L438">                long id = c.getLong(0);</span>
<span class="fc" id="L439">                ArrayList&lt;ObaRegionElement.Bounds&gt; bounds = allBounds.get(id);</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">                ObaRegionElement.Bounds[] bounds2 = (bounds != null) ?</span>
<span class="fc" id="L441">                        bounds.toArray(new ObaRegionElement.Bounds[]{}) :</span>
<span class="pc" id="L442">                        null;</span>

<span class="fc" id="L444">                ArrayList&lt;ObaRegionElement.Open311Server&gt; open311Servers = allOpen311Servers.get(id);</span>
<span class="fc bfc" id="L445" title="All 2 branches covered.">                ObaRegionElement.Open311Server[] open311Servers2 = (open311Servers != null) ?</span>
<span class="fc" id="L446">                        open311Servers.toArray(new ObaRegionElement.Open311Server[]{}) :</span>
<span class="fc" id="L447">                        null;</span>

<span class="fc" id="L449">                results.add(new ObaRegionElement(id,   // id</span>
<span class="fc" id="L450">                        c.getString(1),             // Name</span>
                        true,                       // Active
<span class="fc" id="L452">                        c.getString(2),             // OBA Base URL</span>
<span class="fc" id="L453">                        c.getString(3),             // SIRI Base URL</span>
                        bounds2,                    // Bounds
                        open311Servers2,            // Open311 servers
<span class="fc" id="L456">                        c.getString(4),             // Lang</span>
<span class="fc" id="L457">                        c.getString(5),             // Contact Email</span>
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">                        c.getInt(6) &gt; 0,            // Supports Oba Discovery</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">                        c.getInt(7) &gt; 0,            // Supports Oba Realtime</span>
<span class="fc bfc" id="L460" title="All 2 branches covered.">                        c.getInt(8) &gt; 0,            // Supports Siri Realtime</span>
<span class="fc" id="L461">                        c.getString(9),              // Twitter URL</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">                        c.getInt(10) &gt; 0,            // Experimental</span>
<span class="fc" id="L463">                        c.getString(11),             // StopInfoUrl</span>
<span class="fc" id="L464">                        c.getString(12),             // OTP Base URL</span>
<span class="fc" id="L465">                        c.getString(13),              // OTP Contact Email</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">                        c.getInt(14) &gt; 0,           // Supports Otp Bikeshare</span>
<span class="pc bpc" id="L467" title="1 of 2 branches missed.">                        c.getInt(15) &gt; 0,            // Supports Embedded Social</span>
<span class="fc" id="L468">                        c.getString(16),              // Android App ID for mobile fare payment app of region</span>
<span class="fc" id="L469">                        c.getString(17),               // Payment Warning Title</span>
<span class="fc" id="L470">                        c.getString(18),    // Payment Warning Body</span>
<span class="pc bpc" id="L471" title="1 of 2 branches missed.">                        c.getInt(19) &gt; 0, // travel behavior data collection enabled for region</span>
<span class="fc bfc" id="L472" title="All 2 branches covered.">                        c.getInt(20) &gt; 0 // enrolling participants for travel behavior data collection</span>
                ));

<span class="fc bfc" id="L475" title="All 2 branches covered.">            } while (c.moveToNext());</span>

<span class="fc" id="L477">            return results;</span>

        } finally {
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">            if (c != null) {</span>
<span class="fc" id="L481">                c.close();</span>
            }
        }
    }

    private static HashMap&lt;Long, ArrayList&lt;ObaRegionElement.Bounds&gt;&gt; getBoundsFromProvider(
            Context context) {
        // Prefetch the bounds to limit the number of DB calls.
<span class="fc" id="L489">        Cursor c = null;</span>
        try {
<span class="fc" id="L491">            final String[] PROJECTION = {</span>
                    ObaContract.RegionBounds.REGION_ID,
                    ObaContract.RegionBounds.LATITUDE,
                    ObaContract.RegionBounds.LONGITUDE,
                    ObaContract.RegionBounds.LAT_SPAN,
                    ObaContract.RegionBounds.LON_SPAN
            };
<span class="fc" id="L498">            HashMap&lt;Long, ArrayList&lt;ObaRegionElement.Bounds&gt;&gt; results</span>
                    = new HashMap&lt;Long, ArrayList&lt;ObaRegionElement.Bounds&gt;&gt;();

<span class="fc" id="L501">            ContentResolver cr = context.getContentResolver();</span>
<span class="fc" id="L502">            c = cr.query(ObaContract.RegionBounds.CONTENT_URI, PROJECTION, null, null, null);</span>
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">            if (c == null) {</span>
<span class="nc" id="L504">                return results;</span>
            }
<span class="pc bpc" id="L506" title="1 of 2 branches missed.">            if (c.getCount() == 0) {</span>
<span class="nc" id="L507">                c.close();</span>
<span class="nc" id="L508">                return results;</span>
            }
<span class="fc" id="L510">            c.moveToFirst();</span>
            do {
<span class="fc" id="L512">                long regionId = c.getLong(0);</span>
<span class="fc" id="L513">                ArrayList&lt;ObaRegionElement.Bounds&gt; bounds = results.get(regionId);</span>
<span class="fc" id="L514">                ObaRegionElement.Bounds b = new ObaRegionElement.Bounds(</span>
<span class="fc" id="L515">                        c.getDouble(1),</span>
<span class="fc" id="L516">                        c.getDouble(2),</span>
<span class="fc" id="L517">                        c.getDouble(3),</span>
<span class="fc" id="L518">                        c.getDouble(4));</span>
<span class="fc bfc" id="L519" title="All 2 branches covered.">                if (bounds != null) {</span>
<span class="fc" id="L520">                    bounds.add(b);</span>
                } else {
<span class="fc" id="L522">                    bounds = new ArrayList&lt;ObaRegionElement.Bounds&gt;();</span>
<span class="fc" id="L523">                    bounds.add(b);</span>
<span class="fc" id="L524">                    results.put(regionId, bounds);</span>
                }

<span class="fc bfc" id="L527" title="All 2 branches covered.">            } while (c.moveToNext());</span>

<span class="fc" id="L529">            return results;</span>

        } finally {
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">            if (c != null) {</span>
<span class="fc" id="L533">                c.close();</span>
            }
        }
    }

    private static HashMap&lt;Long, ArrayList&lt;ObaRegionElement.Open311Server&gt;&gt; getOpen311ServersFromProvider(
            Context context) {
        // Prefetch the bounds to limit the number of DB calls.
<span class="fc" id="L541">        Cursor c = null;</span>
        try {
<span class="fc" id="L543">            final String[] PROJECTION = {</span>
                    ObaContract.RegionOpen311Servers.REGION_ID,
                    ObaContract.RegionOpen311Servers.JURISDICTION,
                    ObaContract.RegionOpen311Servers.API_KEY,
                    ObaContract.RegionOpen311Servers.BASE_URL
            };
<span class="fc" id="L549">            HashMap&lt;Long, ArrayList&lt;ObaRegionElement.Open311Server&gt;&gt; results</span>
                    = new HashMap&lt;Long, ArrayList&lt;ObaRegionElement.Open311Server&gt;&gt;();

<span class="fc" id="L552">            ContentResolver cr = context.getContentResolver();</span>
<span class="fc" id="L553">            c = cr.query(ObaContract.RegionOpen311Servers.CONTENT_URI, PROJECTION, null, null, null);</span>
<span class="pc bpc" id="L554" title="1 of 2 branches missed.">            if (c == null) {</span>
<span class="nc" id="L555">                return results;</span>
            }
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">            if (c.getCount() == 0) {</span>
<span class="nc" id="L558">                c.close();</span>
<span class="nc" id="L559">                return results;</span>
            }
<span class="fc" id="L561">            c.moveToFirst();</span>
            do {
<span class="fc" id="L563">                long regionId = c.getLong(0);</span>
<span class="fc" id="L564">                ArrayList&lt;ObaRegionElement.Open311Server&gt; open311Servers = results.get(regionId);</span>
<span class="fc" id="L565">                ObaRegionElement.Open311Server b = new ObaRegionElement.Open311Server(</span>
<span class="fc" id="L566">                        c.getString(1),</span>
<span class="fc" id="L567">                        c.getString(2),</span>
<span class="fc" id="L568">                        c.getString(3));</span>
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">                if (open311Servers != null) {</span>
<span class="nc" id="L570">                    open311Servers.add(b);</span>
                } else {
<span class="fc" id="L572">                    open311Servers = new ArrayList&lt;ObaRegionElement.Open311Server&gt;();</span>
<span class="fc" id="L573">                    open311Servers.add(b);</span>
<span class="fc" id="L574">                    results.put(regionId, open311Servers);</span>
                }

<span class="pc bpc" id="L577" title="1 of 2 branches missed.">            } while (c.moveToNext());</span>

<span class="fc" id="L579">            return results;</span>

        } finally {
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">            if (c != null) {</span>
<span class="fc" id="L583">                c.close();</span>
            }
        }
    }

    private synchronized static ArrayList&lt;ObaRegion&gt; getRegionsFromServer(Context context) {
<span class="nc" id="L589">        ObaRegionsResponse response = ObaRegionsRequest.newRequest(context).call();</span>
<span class="nc" id="L590">        return new ArrayList&lt;ObaRegion&gt;(Arrays.asList(response.getRegions()));</span>
    }

    /**
     * Retrieves region information from a regions file bundled within the app APK
     *
     * IMPORTANT - this should be a last resort, and we should always try to pull regions
     * info from the local provider or Regions REST API instead of from the bundled file.
     *
     * This method is only intended to be a fail-safe in case the Regions REST API goes
     * offline and a user downloads and installs OBA Android during that period
     * (i.e., local OBA servers are available, but Regions REST API failure would block initial
     * execution of the app).  This avoids a potential central point of failure for OBA
     * Android installations on devices in multiple regions.
     *
     * @return list of regions retrieved from the regions file in app resources
     */
    public static ArrayList&lt;ObaRegion&gt; getRegionsFromResources(Context context) {
<span class="fc" id="L608">        final Uri.Builder builder = new Uri.Builder();</span>
<span class="fc" id="L609">        builder.scheme(ContentResolver.SCHEME_ANDROID_RESOURCE);</span>
<span class="fc" id="L610">        builder.authority(context.getPackageName());</span>
<span class="fc" id="L611">        builder.path(Integer.toString(R.raw.regions_v3));</span>
<span class="fc" id="L612">        ObaRegionsResponse response = ObaRegionsRequest.newRequest(context, builder.build()).call();</span>
<span class="fc" id="L613">        return new ArrayList&lt;ObaRegion&gt;(Arrays.asList(response.getRegions()));</span>
    }

    /**
     * Retrieves hard-coded region information from the build flavor defined in build.gradle.
     * If a fixed region is defined in a build flavor, it does not allow region roaming.
     *
     * @return hard-coded region information from the build flavor defined in build.gradle
     */
    public static ObaRegion getRegionFromBuildFlavor() {
<span class="nc" id="L623">        final int regionId = Integer.MAX_VALUE; // This doesn't get used, but needs to be positive</span>
<span class="nc" id="L624">        ObaRegionElement.Bounds[] boundsArray = new ObaRegionElement.Bounds[1];</span>
<span class="nc" id="L625">        ObaRegionElement.Bounds bounds = new ObaRegionElement.Bounds(</span>
                BuildConfig.FIXED_REGION_BOUNDS_LAT, BuildConfig.FIXED_REGION_BOUNDS_LON,
                BuildConfig.FIXED_REGION_BOUNDS_LAT_SPAN, BuildConfig.FIXED_REGION_BOUNDS_LON_SPAN);
<span class="nc" id="L628">        boundsArray[0] = bounds;</span>

<span class="nc" id="L630">        ObaRegionElement.Open311Server[] open311Array = new ObaRegionElement.Open311Server[1];</span>
        ObaRegionElement.Open311Server open311Server;

<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (BuildConfig.FIXED_REGION_OPEN311_BASE_URL != null) {</span>
<span class="nc" id="L634">            open311Server = new ObaRegionElement.Open311Server (</span>
                    BuildConfig.FIXED_REGION_OPEN311_JURISDICTION_ID,
                    BuildConfig.FIXED_REGION_OPEN311_API_KEY,
                    BuildConfig.FIXED_REGION_OPEN311_BASE_URL);
<span class="nc" id="L638">            open311Array[0] = open311Server;</span>
        } else {
<span class="nc" id="L640">            open311Array = null;</span>
        }

<span class="nc" id="L643">        ObaRegionElement region = new ObaRegionElement(regionId,</span>
                BuildConfig.FIXED_REGION_NAME, true,
                BuildConfig.FIXED_REGION_OBA_BASE_URL, BuildConfig.FIXED_REGION_SIRI_BASE_URL,
                boundsArray, open311Array, BuildConfig.FIXED_REGION_LANG,
                BuildConfig.FIXED_REGION_CONTACT_EMAIL,
                BuildConfig.FIXED_REGION_SUPPORTS_OBA_DISCOVERY_APIS,
                BuildConfig.FIXED_REGION_SUPPORTS_OBA_REALTIME_APIS,
                BuildConfig.FIXED_REGION_SUPPORTS_SIRI_REALTIME_APIS,
                BuildConfig.FIXED_REGION_TWITTER_URL, false,
                BuildConfig.FIXED_REGION_STOP_INFO_URL,
                BuildConfig.FIXED_REGION_OTP_BASE_URL,
                BuildConfig.FIXED_REGION_OTP_CONTACT_EMAIL,
                BuildConfig.FIXED_REGION_SUPPORTS_OTP_BIKESHARE,
                false,
                BuildConfig.FIXED_REGION_PAYMENT_ANDROID_APP_ID,
                BuildConfig.FIXED_REGION_PAYMENT_WARNING_TITLE,
                BuildConfig.FIXED_REGION_PAYMENT_WARNING_BODY,
                BuildConfig.FIXED_REGION_TRAVEL_BEHAVIOR_DATA_COLLECTION,
                BuildConfig.FIXED_REGION_ENROLL_PARTICIPANTS_IN_STUDY);
<span class="nc" id="L662">        return region;</span>
    }

    //
    // Saving
    //
    public synchronized static void saveToProvider(Context context, List&lt;ObaRegion&gt; regions) {
        // Delete all the existing regions
<span class="fc" id="L670">        ContentResolver cr = context.getContentResolver();</span>
<span class="fc" id="L671">        cr.delete(ObaContract.Regions.CONTENT_URI, null, null);</span>
        // Should be a no-op?
<span class="fc" id="L673">        cr.delete(ObaContract.RegionBounds.CONTENT_URI, null, null);</span>
        // Delete all existing open311 endpoints
<span class="fc" id="L675">        cr.delete(ObaContract.RegionOpen311Servers.CONTENT_URI, null, null);</span>

<span class="fc bfc" id="L677" title="All 2 branches covered.">        for (ObaRegion region : regions) {</span>
<span class="fc bfc" id="L678" title="All 2 branches covered.">            if (!isRegionUsable(region)) {</span>
<span class="fc" id="L679">                Log.d(TAG, &quot;Skipping insert of '&quot; + region.getName() + &quot;' to provider...&quot;);</span>
<span class="fc" id="L680">                continue;</span>
            }

<span class="fc" id="L683">            cr.insert(ObaContract.Regions.CONTENT_URI, toContentValues(region));</span>
<span class="fc" id="L684">            Log.d(TAG, &quot;Saved region '&quot; + region.getName() + &quot;' to provider&quot;);</span>
<span class="fc" id="L685">            long regionId = region.getId();</span>
            // Bulk insert the bounds
<span class="fc" id="L687">            ObaRegion.Bounds[] bounds = region.getBounds();</span>
<span class="pc bpc" id="L688" title="1 of 2 branches missed.">            if (bounds != null) {</span>
<span class="fc" id="L689">                ContentValues[] values = new ContentValues[bounds.length];</span>
<span class="fc bfc" id="L690" title="All 2 branches covered.">                for (int i = 0; i &lt; bounds.length; ++i) {</span>
<span class="fc" id="L691">                    values[i] = toContentValues(regionId, bounds[i]);</span>
                }
<span class="fc" id="L693">                cr.bulkInsert(ObaContract.RegionBounds.CONTENT_URI, values);</span>
            }

<span class="fc" id="L696">            ObaRegion.Open311Server[] open311Servers = region.getOpen311Servers();</span>

<span class="pc bpc" id="L698" title="1 of 2 branches missed.">            if (open311Servers != null) {</span>
<span class="fc" id="L699">                ContentValues[] values = new ContentValues[open311Servers.length];</span>
<span class="fc bfc" id="L700" title="All 2 branches covered.">                for (int i = 0; i &lt; open311Servers.length; ++i) {</span>
<span class="fc" id="L701">                    values[i] = toContentValues(regionId, open311Servers[i]);</span>
                }
<span class="fc" id="L703">                cr.bulkInsert(ObaContract.RegionOpen311Servers.CONTENT_URI, values);</span>
            }
<span class="fc" id="L705">        }</span>
<span class="fc" id="L706">    }</span>

    private static ContentValues toContentValues(ObaRegion region) {
<span class="fc" id="L709">        ContentValues values = new ContentValues();</span>
<span class="fc" id="L710">        values.put(ObaContract.Regions._ID, region.getId());</span>
<span class="fc" id="L711">            values.put(ObaContract.Regions.NAME, region.getName());</span>
<span class="fc" id="L712">        String obaUrl = region.getObaBaseUrl();</span>
<span class="pc bpc" id="L713" title="1 of 2 branches missed.">        values.put(ObaContract.Regions.OBA_BASE_URL, obaUrl != null ? obaUrl : &quot;&quot;);</span>
<span class="fc" id="L714">        String siriUrl = region.getSiriBaseUrl();</span>
<span class="fc bfc" id="L715" title="All 2 branches covered.">        values.put(ObaContract.Regions.SIRI_BASE_URL, siriUrl != null ? siriUrl : &quot;&quot;);</span>
<span class="fc" id="L716">        values.put(ObaContract.Regions.LANGUAGE, region.getLanguage());</span>
<span class="fc" id="L717">        values.put(ObaContract.Regions.CONTACT_EMAIL, region.getContactEmail());</span>
<span class="fc" id="L718">        values.put(ObaContract.Regions.SUPPORTS_OBA_DISCOVERY,</span>
<span class="pc bpc" id="L719" title="1 of 2 branches missed.">                region.getSupportsObaDiscoveryApis() ? 1 : 0);</span>
<span class="fc" id="L720">        values.put(ObaContract.Regions.SUPPORTS_OBA_REALTIME,</span>
<span class="pc bpc" id="L721" title="1 of 2 branches missed.">                region.getSupportsObaRealtimeApis() ? 1 : 0);</span>
<span class="fc" id="L722">        values.put(ObaContract.Regions.SUPPORTS_SIRI_REALTIME,</span>
<span class="fc bfc" id="L723" title="All 2 branches covered.">                region.getSupportsSiriRealtimeApis() ? 1 : 0);</span>
<span class="fc" id="L724">        values.put(ObaContract.Regions.TWITTER_URL, region.getTwitterUrl());</span>
<span class="fc" id="L725">        values.put(ObaContract.Regions.EXPERIMENTAL, region.getExperimental());</span>
<span class="fc" id="L726">        values.put(ObaContract.Regions.STOP_INFO_URL, region.getStopInfoUrl());</span>
<span class="fc" id="L727">        values.put(ObaContract.Regions.OTP_BASE_URL, region.getOtpBaseUrl());</span>
<span class="fc" id="L728">        values.put(ObaContract.Regions.OTP_CONTACT_EMAIL, region.getOtpContactEmail());</span>
<span class="fc" id="L729">        values.put(ObaContract.Regions.SUPPORTS_OTP_BIKESHARE,</span>
<span class="fc bfc" id="L730" title="All 2 branches covered.">                region.getSupportsOtpBikeshare() ? 1 : 0);</span>
<span class="fc" id="L731">        values.put(ObaContract.Regions.SUPPORTS_EMBEDDED_SOCIAL,</span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">                region.getSupportsEmbeddedSocial() ? 1 : 0);</span>
<span class="fc" id="L733">        values.put(ObaContract.Regions.PAYMENT_ANDROID_APP_ID, region.getPaymentAndroidAppId());</span>
<span class="fc" id="L734">        values.put(ObaContract.Regions.PAYMENT_WARNING_TITLE, region.getPaymentWarningTitle());</span>
<span class="fc" id="L735">        values.put(ObaContract.Regions.PAYMENT_WARNING_BODY, region.getPaymentWarningBody());</span>
<span class="fc" id="L736">        values.put(ObaContract.Regions.TRAVEL_BEHAVIOR_DATA_COLLECTION,</span>
<span class="pc bpc" id="L737" title="1 of 2 branches missed.">                region.isTravelBehaviorDataCollectionEnabled() ? 1 : 0);</span>
<span class="fc" id="L738">        values.put(ObaContract.Regions.ENROLL_PARTICIPANTS_IN_STUDY,</span>
<span class="fc bfc" id="L739" title="All 2 branches covered.">                region.isEnrollParticipantsInStudy() ? 1 : 0);</span>
<span class="fc" id="L740">        return values;</span>
    }

    private static ContentValues toContentValues(long region, ObaRegion.Bounds bounds) {
<span class="fc" id="L744">        ContentValues values = new ContentValues();</span>
<span class="fc" id="L745">        values.put(ObaContract.RegionBounds.REGION_ID, region);</span>
<span class="fc" id="L746">        values.put(ObaContract.RegionBounds.LATITUDE, bounds.getLat());</span>
<span class="fc" id="L747">        values.put(ObaContract.RegionBounds.LONGITUDE, bounds.getLon());</span>
<span class="fc" id="L748">        values.put(ObaContract.RegionBounds.LAT_SPAN, bounds.getLatSpan());</span>
<span class="fc" id="L749">        values.put(ObaContract.RegionBounds.LON_SPAN, bounds.getLonSpan());</span>
<span class="fc" id="L750">        return values;</span>
    }

    private static ContentValues toContentValues(long region, ObaRegion.Open311Server open311Server) {
<span class="fc" id="L754">        ContentValues values = new ContentValues();</span>
<span class="fc" id="L755">        values.put(ObaContract.RegionOpen311Servers.REGION_ID, region);</span>
<span class="fc" id="L756">        values.put(ObaContract.RegionOpen311Servers.BASE_URL, open311Server.getBaseUrl());</span>
<span class="fc" id="L757">        values.put(ObaContract.RegionOpen311Servers.JURISDICTION, open311Server.getJuridisctionId());</span>
<span class="fc" id="L758">        values.put(ObaContract.RegionOpen311Servers.API_KEY, open311Server.getApiKey());</span>
<span class="fc" id="L759">        return values;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>