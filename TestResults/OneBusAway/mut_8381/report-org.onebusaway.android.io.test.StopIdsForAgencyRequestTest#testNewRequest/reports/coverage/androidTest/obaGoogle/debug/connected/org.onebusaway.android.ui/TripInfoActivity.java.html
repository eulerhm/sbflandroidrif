<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TripInfoActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">TripInfoActivity.java</span></div><h1>TripInfoActivity.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011-2015 Paul Watts (paulcwatts@gmail.com), University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import android.app.AlertDialog;
import android.app.Dialog;
import android.content.ContentResolver;
import android.content.ContentValues;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.res.Resources;
import android.database.Cursor;
import android.net.Uri;
import android.os.Bundle;
import android.text.format.DateUtils;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

import org.onebusaway.android.R;
import org.onebusaway.android.provider.ObaContract;
import org.onebusaway.android.tripservice.TripService;
import org.onebusaway.android.util.FragmentUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.onebusaway.android.util.UIUtils;

import java.util.List;

import androidx.appcompat.app.AppCompatActivity;
import androidx.fragment.app.DialogFragment;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.loader.app.LoaderManager;
import androidx.loader.content.CursorLoader;
import androidx.loader.content.Loader;

<span class="nc" id="L60">public class TripInfoActivity extends AppCompatActivity {</span>

    private static final String TAG = &quot;TripInfoActivity&quot;;

    private static final String ROUTE_ID = &quot;.RouteId&quot;;

    private static final String ROUTE_NAME = &quot;.RouteName&quot;;

    private static final String STOP_NAME = &quot;.StopName&quot;;

    private static final String HEADSIGN = &quot;.Headsign&quot;;

    private static final String DEPARTURE_TIME = &quot;.Depart&quot;;

    // Save/restore values
    private static final String TRIP_NAME = &quot;.TripName&quot;;

    private static final String REMINDER_TIME = &quot;.ReminderTime&quot;;

    private static final String REMINDER_DAYS = &quot;.ReminderDays&quot;;

    public static void start(Context context, String tripId, String stopId) {
<span class="nc" id="L82">        Intent myIntent = new Intent(context, TripInfoActivity.class);</span>
<span class="nc" id="L83">        myIntent.setData(ObaContract.Trips.buildUri(tripId, stopId));</span>
<span class="nc" id="L84">        context.startActivity(myIntent);</span>
<span class="nc" id="L85">    }</span>

    public static void start(Context context,
            String tripId,
            String stopId,
            String routeId,
            String routeName,
            String stopName,
            long departureTime,
            String headsign) {
<span class="nc" id="L95">        Intent myIntent = new Intent(context, TripInfoActivity.class);</span>
<span class="nc" id="L96">        myIntent.setData(ObaContract.Trips.buildUri(tripId, stopId));</span>
<span class="nc" id="L97">        myIntent.putExtra(ROUTE_ID, routeId);</span>
<span class="nc" id="L98">        myIntent.putExtra(ROUTE_NAME, routeName);</span>
<span class="nc" id="L99">        myIntent.putExtra(STOP_NAME, stopName);</span>
<span class="nc" id="L100">        myIntent.putExtra(DEPARTURE_TIME, departureTime);</span>
<span class="nc" id="L101">        myIntent.putExtra(HEADSIGN, headsign);</span>
<span class="nc" id="L102">        context.startActivity(myIntent);</span>
<span class="nc" id="L103">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L107">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L108">        UIUtils.setupActionBar(this);</span>

<span class="nc" id="L110">        FragmentManager fm = getSupportFragmentManager();</span>

        // Create the list fragment and add it as our sole content.
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (fm.findFragmentById(android.R.id.content) == null) {</span>
<span class="nc" id="L114">            TripInfoFragment content = new TripInfoFragment();</span>
<span class="nc" id="L115">            content.setArguments(FragmentUtils.getIntentArgs(getIntent()));</span>

<span class="nc" id="L117">            fm.beginTransaction().add(android.R.id.content, content).commit();</span>
        }
<span class="nc" id="L119">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (item.getItemId() == android.R.id.home) {</span>
            //UIHelp.goHome(this);
            // Since this screen isn't part of a defined heirarchy, we always
            // go up from here.
<span class="nc" id="L127">            finish();</span>
<span class="nc" id="L128">            return true;</span>
        }
<span class="nc" id="L130">        return false;</span>
    }

    TripInfoFragment getTripInfoFragment() {
<span class="nc" id="L134">        FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L135">        return (TripInfoFragment) fm.findFragmentById(android.R.id.content);</span>
    }

<span class="nc" id="L138">    public static final class TripInfoFragment extends Fragment</span>
            implements LoaderManager.LoaderCallbacks&lt;Cursor&gt; {

        private static final String TAG_DELETE_DIALOG = &quot;.DeleteDialog&quot;;

<span class="nc" id="L143">        private static final String[] PROJECTION = {</span>
                ObaContract.Trips.NAME,
                ObaContract.Trips.REMINDER,
                ObaContract.Trips.DAYS,
                ObaContract.Trips.ROUTE_ID,
                ObaContract.Trips.HEADSIGN,
                ObaContract.Trips.DEPARTURE
        };

        private static final int COL_NAME = 0;

        private static final int COL_REMINDER = 1;

        private static final int COL_DAYS = 2;

        private static final int COL_ROUTE_ID = 3;

        private static final int COL_HEADSIGN = 4;

        private static final int COL_DEPARTURE = 5;

        private Uri mTripUri;

        private String mTripId;

        private String mRouteId;

        private String mRouteName;

        private String mStopId;

        private String mStopName;

        private String mHeadsign;

        private String mTripName;

        private long mDepartTime;

        private int mReminderTime; // DB Value, not selection value

        private int mReminderDays;

<span class="nc" id="L186">        private boolean mNewTrip = true;</span>


        @Override
        public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L191">            super.onActivityCreated(savedInstanceState);</span>

<span class="nc" id="L193">            setHasOptionsMenu(true);</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (savedInstanceState != null) {</span>
<span class="nc" id="L196">                initFromBundle(savedInstanceState);</span>
<span class="nc" id="L197">                initForm();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            } else if (initFromBundle(getArguments())) {</span>
<span class="nc" id="L199">                getLoaderManager().initLoader(0, null, this);</span>
            } else {
<span class="nc" id="L201">                Log.e(TAG, &quot;Information missing from intent&quot;);</span>
<span class="nc" id="L202">                return;</span>
            }
<span class="nc" id="L204">        }</span>

        @Override
        public View onCreateView(LayoutInflater inflater,
                ViewGroup root, Bundle savedInstanceState) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (root == null) {</span>
                // Currently in a layout without a container, so no
                // reason to create our view.
<span class="nc" id="L212">                return null;</span>
            }
<span class="nc" id="L214">            return inflater.inflate(R.layout.trip_info, null);</span>
        }

        @Override
        public Loader&lt;Cursor&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L219">            return new CursorLoader(getActivity(), mTripUri,</span>
                    PROJECTION, null, null, null);
        }

        @Override
        public void onLoadFinished(Loader&lt;Cursor&gt; loader, Cursor data) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">            mNewTrip = !initFromCursor(data);</span>
<span class="nc" id="L226">            initForm();</span>
<span class="nc" id="L227">            getActivity().supportInvalidateOptionsMenu();</span>
<span class="nc" id="L228">        }</span>

        @Override
        public void onLoaderReset(Loader&lt;Cursor&gt; loader) {
<span class="nc" id="L232">        }</span>

        private boolean initFromBundle(Bundle bundle) {
<span class="nc" id="L235">            final Uri data = bundle.getParcelable(FragmentUtils.URI);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L237">                return false;</span>
            }
<span class="nc" id="L239">            List&lt;String&gt; segments = data.getPathSegments();</span>
<span class="nc" id="L240">            mTripId = segments.get(1);</span>
<span class="nc" id="L241">            mStopId = segments.get(2);</span>
<span class="nc" id="L242">            mTripUri = data;</span>

<span class="nc bnc" id="L244" title="All 4 branches missed.">            if (mTripId == null || mStopId == null) {</span>
<span class="nc" id="L245">                return false;</span>
            }

<span class="nc" id="L248">            mRouteId = bundle.getString(ROUTE_ID);</span>
<span class="nc" id="L249">            mHeadsign = bundle.getString(HEADSIGN);</span>
<span class="nc" id="L250">            mDepartTime = bundle.getLong(DEPARTURE_TIME);</span>

<span class="nc" id="L252">            mStopName = bundle.getString(STOP_NAME);</span>
<span class="nc" id="L253">            mRouteName = bundle.getString(ROUTE_NAME);</span>
            // If we get this, update it in the DB.
<span class="nc bnc" id="L255" title="All 2 branches missed.">            if (mRouteName != null) {</span>
<span class="nc" id="L256">                ContentValues values = new ContentValues();</span>
<span class="nc" id="L257">                values.put(ObaContract.Routes.SHORTNAME, mRouteName);</span>
<span class="nc" id="L258">                ObaContract.Routes</span>
<span class="nc" id="L259">                        .insertOrUpdate(getActivity(), mRouteId, values, false);</span>
            }
<span class="nc" id="L261">            String name = bundle.getString(TRIP_NAME);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">            if (name != null) {</span>
<span class="nc" id="L263">                mTripName = name;</span>
            }

<span class="nc" id="L266">            mReminderTime = bundle.getInt(REMINDER_TIME, mReminderTime);</span>
<span class="nc" id="L267">            mReminderDays = bundle.getInt(REMINDER_DAYS, mReminderDays);</span>
<span class="nc" id="L268">            return true;</span>
        }

        private boolean initFromCursor(Cursor cursor) {
<span class="nc bnc" id="L272" title="All 4 branches missed.">            if (cursor == null || cursor.getCount() &lt; 1) {</span>
                // Reminder defaults to 10 in the UI
<span class="nc" id="L274">                mReminderTime = PreferenceUtils.getInt(getString(R.string.preference_key_default_reminder_time), 10);</span>
<span class="nc" id="L275">                return false;</span>
            }
<span class="nc" id="L277">            cursor.moveToFirst();</span>
<span class="nc" id="L278">            mTripName = cursor.getString(COL_NAME);</span>
<span class="nc" id="L279">            mReminderTime = cursor.getInt(COL_REMINDER);</span>
<span class="nc" id="L280">            mReminderDays = cursor.getInt(COL_DAYS);</span>

            // If some values weren't set in the bundle, assign them the
            // values in the db.
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (mRouteId == null) {</span>
<span class="nc" id="L285">                mRouteId = cursor.getString(COL_ROUTE_ID);</span>
            }
<span class="nc bnc" id="L287" title="All 2 branches missed.">            if (mHeadsign == null) {</span>
<span class="nc" id="L288">                mHeadsign = cursor.getString(COL_HEADSIGN);</span>
            }
<span class="nc bnc" id="L290" title="All 2 branches missed.">            if (mDepartTime == 0) {</span>
<span class="nc" id="L291">                mDepartTime = ObaContract.Trips.convertDBToTime(cursor</span>
<span class="nc" id="L292">                        .getInt(COL_DEPARTURE));</span>
            }

            // If we don't have the route name, look it up in the DB
<span class="nc bnc" id="L296" title="All 2 branches missed.">            if (mRouteName == null) {</span>
<span class="nc" id="L297">                mRouteName = TripService.getRouteShortName(getActivity(), mRouteId);</span>
            }
<span class="nc bnc" id="L299" title="All 2 branches missed.">            if (mStopName == null) {</span>
<span class="nc" id="L300">                mStopName = UIUtils.stringForQuery(getActivity(), Uri.withAppendedPath(</span>
                                ObaContract.Stops.CONTENT_URI, mStopId),
                        ObaContract.Stops.NAME
                );
            }
<span class="nc" id="L305">            return true;</span>
        }

        private void initForm() {
<span class="nc" id="L309">            View view = getView();</span>
<span class="nc" id="L310">            final Spinner reminder = (Spinner) view.findViewById(R.id.trip_info_reminder_time);</span>
<span class="nc" id="L311">            ArrayAdapter&lt;?&gt; adapter = ArrayAdapter.createFromResource(</span>
<span class="nc" id="L312">                    getActivity(), R.array.reminder_time, android.R.layout.simple_spinner_item);</span>
<span class="nc" id="L313">            adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);</span>
<span class="nc" id="L314">            reminder.setAdapter(adapter);</span>

            //
            // Static (header values)
            //
<span class="nc" id="L319">            final TextView stopName = (TextView) view.findViewById(R.id.stop_name);</span>
<span class="nc" id="L320">            stopName.setText(UIUtils.formatDisplayText(mStopName));</span>

<span class="nc" id="L322">            final TextView routeName = (TextView) view.findViewById(R.id.route_name);</span>
<span class="nc" id="L323">            routeName.setText(</span>
<span class="nc" id="L324">                    UIUtils.formatDisplayText(getString(R.string.trip_info_route, mRouteName)));</span>

<span class="nc" id="L326">            final TextView headsign = (TextView) view.findViewById(R.id.headsign);</span>
<span class="nc" id="L327">            headsign.setText(UIUtils.formatDisplayText(mHeadsign));</span>

<span class="nc" id="L329">            final TextView departText = (TextView) view.findViewById(R.id.departure_time);</span>
<span class="nc" id="L330">            departText.setText(getDepartureTime(getActivity(), mDepartTime));</span>

<span class="nc" id="L332">            final TextView tripName = (TextView) view.findViewById(R.id.name);</span>
<span class="nc" id="L333">            tripName.setText(mTripName);</span>

<span class="nc" id="L335">            reminder.setSelection(reminderToSelection(mReminderTime));</span>

<span class="nc" id="L337">            final Button repeats = (Button) view.findViewById(R.id.trip_info_reminder_days);</span>
<span class="nc" id="L338">            repeats.setText(getRepeatText(getActivity(), mReminderDays));</span>
            //
            // Buttons
            //
<span class="nc" id="L342">            repeats.setOnClickListener(new View.OnClickListener() {</span>
                public void onClick(View v) {
<span class="nc" id="L344">                    showReminderDaysDialog();</span>
<span class="nc" id="L345">                }</span>
            });
<span class="nc" id="L347">        }</span>

        void finish() {
            // TODO: We want to be a better citizen, we should not finish our parents
            // activity in the case we have some form of dual pane mode for larger screens.
            // But for now, the retains original, pre-fragment functionality.
<span class="nc" id="L353">            getActivity().finish();</span>
<span class="nc" id="L354">        }</span>

        @Override
        public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L358">            super.onSaveInstanceState(outState);</span>

<span class="nc" id="L360">            outState.putParcelable(FragmentUtils.URI, mTripUri);</span>
<span class="nc" id="L361">            outState.putString(ROUTE_ID, mRouteId);</span>
<span class="nc" id="L362">            outState.putString(ROUTE_NAME, mRouteName);</span>
<span class="nc" id="L363">            outState.putString(STOP_NAME, mStopName);</span>
<span class="nc" id="L364">            outState.putString(HEADSIGN, mHeadsign);</span>
<span class="nc" id="L365">            outState.putLong(DEPARTURE_TIME, mDepartTime);</span>

<span class="nc" id="L367">            View view = getView();</span>
<span class="nc" id="L368">            Spinner reminderView = (Spinner) view.findViewById(R.id.trip_info_reminder_time);</span>
<span class="nc" id="L369">            TextView nameView = (TextView) view.findViewById(R.id.name);</span>

<span class="nc" id="L371">            final int reminder = selectionToReminder(reminderView</span>
<span class="nc" id="L372">                    .getSelectedItemPosition());</span>
<span class="nc" id="L373">            outState.putString(TRIP_NAME, nameView.getText().toString());</span>
<span class="nc" id="L374">            outState.putInt(REMINDER_TIME, reminder);</span>
<span class="nc" id="L375">            outState.putInt(REMINDER_DAYS, mReminderDays);</span>
<span class="nc" id="L376">        }</span>

        @Override
        public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span class="nc" id="L380">            inflater.inflate(R.menu.trip_info_options, menu);</span>
<span class="nc" id="L381">        }</span>

        @Override
        public void onPrepareOptionsMenu(Menu menu) {
<span class="nc bnc" id="L385" title="All 2 branches missed.">            menu.findItem(R.id.trip_info_delete).setVisible(!mNewTrip);</span>
<span class="nc" id="L386">        }</span>

        @Override
        public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc" id="L390">            int id = item.getItemId();</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">            if (id == R.id.trip_info_save) {</span>
<span class="nc" id="L392">                saveTrip();</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">            } else if (id == R.id.trip_info_delete) {</span>
<span class="nc" id="L394">                Bundle args = new Bundle();</span>
<span class="nc" id="L395">                args.putParcelable(&quot;uri&quot;, mTripUri);</span>
<span class="nc" id="L396">                DeleteDialog dialog = new DeleteDialog();</span>
<span class="nc" id="L397">                dialog.setArguments(args);</span>
<span class="nc" id="L398">                dialog.show(getActivity().getSupportFragmentManager(), TAG_DELETE_DIALOG);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">            } else if (id == R.id.show_route) {</span>
<span class="nc" id="L400">                RouteInfoActivity.start(getActivity(), mRouteId);</span>
<span class="nc" id="L401">                return true;</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">            } else if (id == R.id.show_stop) {</span>
<span class="nc" id="L403">                new ArrivalsListActivity.Builder(getActivity(), mStopId)</span>
<span class="nc" id="L404">                        .setStopName(mStopName)</span>
<span class="nc" id="L405">                        .start();</span>
<span class="nc" id="L406">                return true;</span>
            }
<span class="nc" id="L408">            return false;</span>
        }

        public void saveTrip() {
            // Things that need updating:
            // Any constant values (trip info not editable by user)
            // Trip name
            // Reminder time
            // Repeats
            //
<span class="nc" id="L418">            View view = getView();</span>
<span class="nc" id="L419">            final Spinner reminderView = (Spinner) view.findViewById(R.id.trip_info_reminder_time);</span>
<span class="nc" id="L420">            final TextView nameView = (TextView) view.findViewById(R.id.name);</span>

<span class="nc" id="L422">            final int reminder = selectionToReminder(reminderView</span>
<span class="nc" id="L423">                    .getSelectedItemPosition());</span>

<span class="nc" id="L425">            ContentValues values = new ContentValues();</span>
<span class="nc" id="L426">            values.put(ObaContract.Trips.ROUTE_ID, mRouteId);</span>
<span class="nc" id="L427">            values.put(ObaContract.Trips.DEPARTURE, ObaContract.Trips</span>
<span class="nc" id="L428">                    .convertTimeToDB(mDepartTime));</span>
<span class="nc" id="L429">            values.put(ObaContract.Trips.HEADSIGN, mHeadsign);</span>
<span class="nc" id="L430">            values.put(ObaContract.Trips.NAME, nameView.getText().toString());</span>
<span class="nc" id="L431">            values.put(ObaContract.Trips.REMINDER, reminder);</span>
<span class="nc" id="L432">            values.put(ObaContract.Trips.DAYS, mReminderDays);</span>

            // Insert or update?
<span class="nc" id="L435">            ContentResolver cr = getActivity().getContentResolver();</span>
<span class="nc" id="L436">            Cursor c = cr.query(mTripUri, new String[]{ObaContract.Trips._ID},</span>
                    null, null, null);
<span class="nc bnc" id="L438" title="All 4 branches missed.">            if (c != null &amp;&amp; c.getCount() &gt; 0) {</span>
                // Update
<span class="nc" id="L440">                cr.update(mTripUri, values, null, null);</span>
            } else {
<span class="nc" id="L442">                values.put(ObaContract.Trips._ID, mTripId);</span>
<span class="nc" id="L443">                values.put(ObaContract.Trips.STOP_ID, mStopId);</span>
<span class="nc" id="L444">                cr.insert(ObaContract.Trips.CONTENT_URI, values);</span>
            }
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (c != null) {</span>
<span class="nc" id="L447">                c.close();</span>
            }
<span class="nc" id="L449">            TripService.scheduleAll(getActivity(), true);</span>

<span class="nc" id="L451">            PreferenceUtils.saveInt(getString(R.string.preference_key_default_reminder_time), reminder);</span>

<span class="nc" id="L453">            Toast.makeText(getActivity(), R.string.trip_info_saved, Toast.LENGTH_SHORT)</span>
<span class="nc" id="L454">                    .show();</span>
<span class="nc" id="L455">            finish();</span>
<span class="nc" id="L456">        }</span>

        void showReminderDaysDialog() {
<span class="nc" id="L459">            final boolean[] checks = ObaContract.Trips.daysToArray(mReminderDays);</span>
<span class="nc" id="L460">            Bundle args = new Bundle();</span>
<span class="nc" id="L461">            args.putBooleanArray(ReminderDaysDialog.CHECKS, checks);</span>
<span class="nc" id="L462">            ReminderDaysDialog frag = new ReminderDaysDialog();</span>
<span class="nc" id="L463">            frag.setArguments(args);</span>
<span class="nc" id="L464">            frag.show(getActivity().getSupportFragmentManager(), &quot;.ReminderDaysDialog&quot;);</span>
<span class="nc" id="L465">        }</span>

<span class="nc" id="L467">        public static class ReminderDaysDialog extends DialogFragment</span>
                implements DialogInterface.OnMultiChoiceClickListener,
                DialogInterface.OnClickListener {

            static final String CHECKS = &quot;.checks&quot;;

            private boolean[] mChecks;

            @Override
            public Dialog onCreateDialog(Bundle savedInstanceState) {
<span class="nc" id="L477">                Bundle args = getArguments();</span>
<span class="nc" id="L478">                mChecks = args.getBooleanArray(CHECKS);</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">                if (savedInstanceState != null) {</span>
<span class="nc" id="L480">                    mChecks = args.getBooleanArray(CHECKS);</span>
                }

<span class="nc" id="L483">                AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());</span>
<span class="nc" id="L484">                return builder.setTitle(R.string.trip_info_reminder_repeat)</span>
<span class="nc" id="L485">                        .setMultiChoiceItems(R.array.reminder_days, mChecks, this)</span>
<span class="nc" id="L486">                        .setPositiveButton(R.string.trip_info_save, this)</span>
<span class="nc" id="L487">                        .setNegativeButton(R.string.trip_info_dismiss, null)</span>
<span class="nc" id="L488">                        .create();</span>
            }

            @Override
            public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L493">                outState.putBooleanArray(CHECKS, mChecks);</span>
<span class="nc" id="L494">            }</span>

            @Override
            public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L498">                TripInfoActivity act = (TripInfoActivity) getActivity();</span>
                // Get the fragment we want...
<span class="nc" id="L500">                TripInfoFragment frag = act.getTripInfoFragment();</span>
<span class="nc" id="L501">                frag.setReminderDays(mChecks);</span>
<span class="nc" id="L502">                dialog.dismiss();</span>
<span class="nc" id="L503">            }</span>

            @Override
            public void onClick(DialogInterface arg0, int which, boolean isChecked) {
<span class="nc" id="L507">                mChecks[which] = isChecked;</span>
<span class="nc" id="L508">            }</span>
        }

        private void setReminderDays(boolean[] checks) {
<span class="nc" id="L512">            View view = getView();</span>
<span class="nc" id="L513">            mReminderDays = ObaContract.Trips.arrayToDays(checks);</span>
<span class="nc" id="L514">            final Button repeats = (Button) view.findViewById(R.id.trip_info_reminder_days);</span>
<span class="nc" id="L515">            repeats.setText(getRepeatText(getActivity(), mReminderDays));</span>
<span class="nc" id="L516">        }</span>

<span class="nc" id="L518">        public static class DeleteDialog extends DialogFragment {</span>

            @Override
            public Dialog onCreateDialog(Bundle savedInstanceState) {
<span class="nc" id="L522">                Bundle args = getArguments();</span>
<span class="nc" id="L523">                final Uri tripUri = args.getParcelable(&quot;uri&quot;);</span>

<span class="nc" id="L525">                AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());</span>
<span class="nc" id="L526">                builder</span>
<span class="nc" id="L527">                        .setMessage(R.string.trip_info_delete_trip)</span>
<span class="nc" id="L528">                        .setTitle(R.string.trip_info_delete)</span>
<span class="nc" id="L529">                        .setIcon(android.R.drawable.ic_dialog_alert)</span>
<span class="nc" id="L530">                        .setPositiveButton(android.R.string.ok,</span>
<span class="nc" id="L531">                                new DialogInterface.OnClickListener() {</span>
                                    public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L533">                                        ContentResolver cr = getActivity().getContentResolver();</span>
<span class="nc" id="L534">                                        cr.delete(tripUri, null, null);</span>
<span class="nc" id="L535">                                        TripService.scheduleAll(getActivity(), true);</span>
<span class="nc" id="L536">                                        getActivity().finish();</span>
<span class="nc" id="L537">                                    }</span>
                                }
                        )
<span class="nc" id="L540">                        .setNegativeButton(android.R.string.cancel,</span>
<span class="nc" id="L541">                                new DialogInterface.OnClickListener() {</span>
                                    public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L543">                                        dialog.dismiss();</span>
<span class="nc" id="L544">                                    }</span>
                                }
                        );
<span class="nc" id="L547">                return builder.create();</span>
            }
        }

        // This converts what's in the database to what can be displayed in the spinner.
        private static int reminderToSelection(int reminder) {
<span class="nc bnc" id="L553" title="All 10 branches missed.">            switch (reminder) {</span>
                case 0:
<span class="nc" id="L555">                    return 0;</span>
                case 1:
<span class="nc" id="L557">                    return 1;</span>
                case 3:
<span class="nc" id="L559">                    return 2;</span>
                case 5:
<span class="nc" id="L561">                    return 3;</span>
                case 10:
<span class="nc" id="L563">                    return 4;</span>
                case 15:
<span class="nc" id="L565">                    return 5;</span>
                case 20:
<span class="nc" id="L567">                    return 6;</span>
                case 25:
<span class="nc" id="L569">                    return 7;</span>
                case 30:
<span class="nc" id="L571">                    return 8;</span>
                default:
<span class="nc" id="L573">                    Log.e(TAG, &quot;Invalid reminder value in DB: &quot; + reminder);</span>
<span class="nc" id="L574">                    return 0;</span>
            }
        }

        private static int selectionToReminder(int selection) {
<span class="nc bnc" id="L579" title="All 10 branches missed.">            switch (selection) {</span>
                case 0:
<span class="nc" id="L581">                    return 0;</span>
                case 1:
<span class="nc" id="L583">                    return 1;</span>
                case 2:
<span class="nc" id="L585">                    return 3;</span>
                case 3:
<span class="nc" id="L587">                    return 5;</span>
                case 4:
<span class="nc" id="L589">                    return 10;</span>
                case 5:
<span class="nc" id="L591">                    return 15;</span>
                case 6:
<span class="nc" id="L593">                    return 20;</span>
                case 7:
<span class="nc" id="L595">                    return 25;</span>
                case 8:
<span class="nc" id="L597">                    return 30;</span>
                default:
<span class="nc" id="L599">                    Log.e(TAG, &quot;Invalid selection: &quot; + selection);</span>
<span class="nc" id="L600">                    return 0;</span>
            }
        }
    }

    static String getDepartureTime(Context ctx, long departure) {
<span class="nc" id="L606">        return ctx.getString(R.string.trip_info_depart,</span>
<span class="nc" id="L607">                DateUtils.formatDateTime(ctx,</span>
                        departure,
                        DateUtils.FORMAT_SHOW_TIME |
                                DateUtils.FORMAT_NO_NOON |
                                DateUtils.FORMAT_NO_MIDNIGHT
                )
        );
    }

    static String getRepeatText(Context ctx, int days) {
<span class="nc" id="L617">        final Resources res = ctx.getResources();</span>

<span class="nc bnc" id="L619" title="All 2 branches missed.">        if ((days &amp; ObaContract.Trips.DAY_ALL) == ObaContract.Trips.DAY_ALL) {</span>
<span class="nc" id="L620">            return res.getString(R.string.trip_info_repeat_everyday);</span>
        }
<span class="nc bnc" id="L622" title="All 4 branches missed.">        if (((days &amp; ObaContract.Trips.DAY_WEEKDAY) == ObaContract.Trips.DAY_WEEKDAY)</span>
                &amp;&amp; (days &amp; ~ObaContract.Trips.DAY_WEEKDAY) == 0) {
<span class="nc" id="L624">            return res.getString(R.string.trip_info_repeat_weekdays);</span>
        }
<span class="nc bnc" id="L626" title="All 2 branches missed.">        if (days == 0) {</span>
<span class="nc" id="L627">            return res.getString(R.string.trip_info_repeat_norepeat);</span>
        }
        // Otherwise, it's not normal -- format a string
<span class="nc" id="L630">        final boolean[] array = ObaContract.Trips.daysToArray(days);</span>
<span class="nc" id="L631">        final String[] dayNames = res.getStringArray(R.array.reminder_days);</span>

<span class="nc" id="L633">        StringBuffer buf = new StringBuffer();</span>

        // Find the first day
<span class="nc" id="L636">        int rangeStart = 0;</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">        while (rangeStart &lt; 7) {</span>
<span class="nc bnc" id="L638" title="All 4 branches missed.">            for (; rangeStart &lt; 7 &amp;&amp; !array[rangeStart]; ++rangeStart) {</span>
            }

<span class="nc bnc" id="L641" title="All 2 branches missed.">            if (rangeStart == 7) {</span>
<span class="nc" id="L642">                break;</span>
            }

<span class="nc" id="L645">            int rangeEnd = rangeStart + 1;</span>
<span class="nc bnc" id="L646" title="All 4 branches missed.">            for (; rangeEnd &lt; 7 &amp;&amp; array[rangeEnd]; ++rangeEnd) {</span>
            }

<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (buf.length() != 0) {</span>
                // TODO: Move to string table
<span class="nc" id="L651">                buf.append(&quot;, &quot;);</span>
            }

            // Single day?
<span class="nc bnc" id="L655" title="All 2 branches missed.">            if ((rangeEnd - rangeStart) == 1) {</span>
<span class="nc" id="L656">                buf.append(dayNames[rangeStart]);</span>
            } else {
<span class="nc" id="L658">                buf.append(dayNames[rangeStart]);</span>
                // TODO: Move to string table
<span class="nc" id="L660">                buf.append(&quot; - &quot;);</span>
<span class="nc" id="L661">                buf.append(dayNames[rangeEnd - 1]);</span>
            }
<span class="nc" id="L663">            rangeStart = rangeEnd;</span>
<span class="nc" id="L664">        }</span>

<span class="nc" id="L666">        return res.getString(R.string.trip_info_repeat_every, buf.toString());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>