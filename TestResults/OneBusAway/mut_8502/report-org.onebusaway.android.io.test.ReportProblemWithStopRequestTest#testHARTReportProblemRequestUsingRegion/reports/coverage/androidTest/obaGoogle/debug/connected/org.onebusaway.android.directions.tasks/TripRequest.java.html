<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TripRequest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.directions.tasks</a> &gt; <span class="el_source">TripRequest.java</span></div><h1>TripRequest.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2011 Marcy Gordon
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */

package org.onebusaway.android.directions.tasks;

import android.os.AsyncTask;
import android.util.Log;

import org.onebusaway.android.app.Application;
import org.onebusaway.android.directions.util.JacksonConfig;
import org.opentripplanner.api.model.TripPlan;
import org.opentripplanner.api.ws.Message;
import org.opentripplanner.api.ws.Request;
import org.opentripplanner.api.ws.Response;
import org.opentripplanner.routing.core.TraverseMode;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;

/**
 * AsyncTask that invokes a trip planning request to the OTP Server
 *
 * @author Khoa Tran
 * @author Sean Barbeau (conversion to Jackson)
 * @author Simon Jacobs (integration for onebusaway-android)
 */

public class TripRequest extends AsyncTask&lt;Request, Integer, Long&gt; {

    public interface Callback {
        void onTripRequestComplete(TripPlan tripPlan, String url);
        void onTripRequestFailure(int errorCode, String url);
    }

<span class="nc" id="L53">    public static int NO_SERVER_SELECTED = 1000;</span>

    // Constants that are defined in OTPApp in CUTR OTP Android app
    private static final String TAG = &quot;TripRequest&quot;;
    private static final String FOLDER_STRUCTURE_PREFIX_NEW = &quot;/routers/default&quot;;
    public static final String OTP_RENTAL_QUALIFIER = &quot;_RENT&quot;;
    public static final String PLAN_LOCATION = &quot;/plan&quot;;
    public static final int HTTP_CONNECTION_TIMEOUT = 15000;
    public static final int HTTP_SOCKET_TIMEOUT = 15000;

    private Response mResponse;

    private String mBaseUrl;

    private String mRequestUrl;

    private Callback mCallback;

    // change Server object to baseUrl string.
<span class="nc" id="L72">    public TripRequest(String baseUrl, Callback callback) {</span>
<span class="nc" id="L73">        mBaseUrl = baseUrl;</span>
<span class="nc" id="L74">        mCallback = callback;</span>
<span class="nc" id="L75">    }</span>

    /**
     * Show the progress dialog for this request. Called when request starts, or by caller activity
     * (i.e., in onCreate() after a rotation)
     * @param reqs
     * @return
     */
    protected Long doInBackground(Request... reqs) {
<span class="nc" id="L84">        long totalSize = 0;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (mBaseUrl == null) {</span>
<span class="nc" id="L86">            mCallback.onTripRequestFailure(NO_SERVER_SELECTED, null);</span>
<span class="nc" id="L87">            return null;</span>
        } else {
<span class="nc" id="L89">            String prefix = FOLDER_STRUCTURE_PREFIX_NEW;</span>
<span class="nc" id="L90">            boolean useOldUrlVersion = Application.get().getUseOldOtpApiUrlVersion();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            for (Request req : reqs) {</span>
<span class="nc" id="L92">                mResponse = requestPlan(req, prefix, mBaseUrl, useOldUrlVersion);</span>
            }
        }
<span class="nc" id="L95">        return totalSize;</span>
    }

    protected void onCancelled(Long result) {
<span class="nc" id="L99">        mCallback.onTripRequestFailure(Message.REQUEST_TIMEOUT.getId(), mRequestUrl);</span>
<span class="nc" id="L100">    }</span>

    protected void onPostExecute(Long result) {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (result == null) {</span>
<span class="nc" id="L104">            return;</span>
        }

<span class="nc bnc" id="L107" title="All 4 branches missed.">        if (mResponse != null &amp;&amp; mResponse.getPlan() != null</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                &amp;&amp; mResponse.getPlan().getItinerary().get(0) != null) {</span>
<span class="nc" id="L109">            mCallback.onTripRequestComplete(mResponse.getPlan(), mRequestUrl);</span>
        } else {
<span class="nc" id="L111">            Log.e(TAG, &quot;Error retrieving routing from OTP server: &quot; + mResponse);</span>
<span class="nc" id="L112">            int errorCode = -1;</span>
<span class="nc bnc" id="L113" title="All 4 branches missed.">            if (mResponse != null &amp;&amp; mResponse.getError() != null) {</span>
<span class="nc" id="L114">                errorCode = mResponse.getError().getId();</span>
            }
<span class="nc" id="L116">            mCallback.onTripRequestFailure(errorCode, mRequestUrl);</span>
        }
<span class="nc" id="L118">    }</span>

    protected Response requestPlan(Request requestParams, String prefix, String baseURL,
                                   boolean useOldUrlStructure) {
<span class="nc" id="L122">        HashMap&lt;String, String&gt; tmp = requestParams.getParameters();</span>

<span class="nc" id="L124">        Collection c = tmp.entrySet();</span>
<span class="nc" id="L125">        Iterator itr = c.iterator();</span>

<span class="nc" id="L127">        String params = &quot;&quot;;</span>
<span class="nc" id="L128">        boolean first = true;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        while (itr.hasNext()) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (first) {</span>
<span class="nc" id="L131">                params += &quot;?&quot; + itr.next();</span>
<span class="nc" id="L132">                first = false;</span>
            } else {
<span class="nc" id="L134">                params += &quot;&amp;&quot; + itr.next();</span>
            }
        }

<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (requestParams.getBikeRental()) {</span>
            String updatedString;
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (prefix.equals(FOLDER_STRUCTURE_PREFIX_NEW)) {</span>
<span class="nc" id="L141">                updatedString = params.replace(TraverseMode.BICYCLE.toString(),</span>
<span class="nc" id="L142">                        TraverseMode.BICYCLE.toString() + OTP_RENTAL_QUALIFIER);</span>
            } else {
<span class="nc" id="L144">                updatedString = params.replace(TraverseMode.BICYCLE.toString(),</span>
<span class="nc" id="L145">                        TraverseMode.BICYCLE.toString() + &quot;, &quot; + TraverseMode.WALK.toString());</span>
            }
<span class="nc" id="L147">            params = updatedString;</span>
        }

        String u;

<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (!useOldUrlStructure) {</span>
<span class="nc" id="L153">            u = baseURL + prefix + PLAN_LOCATION + params;</span>
        } else {
<span class="nc" id="L155">            u = baseURL + PLAN_LOCATION + params;</span>
        }

        // Save url for error reporting purposes
<span class="nc" id="L159">        mRequestUrl = u;</span>

<span class="nc" id="L161">        Log.d(TAG, &quot;URL: &quot; + u);</span>

<span class="nc" id="L163">        HttpURLConnection urlConnection = null;</span>
        URL url;
<span class="nc" id="L165">        Response plan = null;</span>

        try {
<span class="nc" id="L168">            url = new URL(u);</span>

<span class="nc" id="L170">            urlConnection = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L171">            urlConnection.setConnectTimeout(HTTP_CONNECTION_TIMEOUT);</span>
<span class="nc" id="L172">            urlConnection.setReadTimeout(HTTP_SOCKET_TIMEOUT);</span>
<span class="nc" id="L173">            plan = JacksonConfig.getObjectReaderInstance()</span>
<span class="nc" id="L174">                    .readValue(urlConnection.getInputStream());</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (useOldUrlStructure) {</span>
                // If the old url structure is successful then cache it
<span class="nc" id="L178">                Application.get().setUseOldOtpApiUrlVersion(true);</span>
            }
<span class="nc" id="L180">        } catch (java.net.SocketTimeoutException e) {</span>
<span class="nc" id="L181">            Log.e(TAG, &quot;Timeout fetching JSON or XML: &quot; + e);</span>
<span class="nc" id="L182">            e.printStackTrace();</span>
<span class="nc" id="L183">            cancel(true);</span>
<span class="nc" id="L184">        } catch (FileNotFoundException e) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (!useOldUrlStructure) {</span>
<span class="nc" id="L186">                Log.v(TAG, &quot;The OTP url might be old, trying  old url structure&quot;);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                if (urlConnection != null) {</span>
<span class="nc" id="L188">                    urlConnection.disconnect();</span>
                }
<span class="nc" id="L190">                return requestPlan(requestParams, prefix, baseURL, true);</span>
            } else {
<span class="nc" id="L192">                Log.e(TAG, &quot;Error fetching JSON or XML: &quot; + e);</span>
<span class="nc" id="L193">                e.printStackTrace();</span>
<span class="nc" id="L194">                cancel(true);</span>
            }
<span class="nc" id="L196">        } catch (IOException e) {</span>
<span class="nc" id="L197">            Log.e(TAG, &quot;Error fetching JSON or XML: &quot; + e);</span>
<span class="nc" id="L198">            e.printStackTrace();</span>
<span class="nc" id="L199">            cancel(true);</span>
            // Reset timestamps to show there was an error
            // requestStartTime = 0;
            // requestEndTime = 0;
        } finally {
<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (urlConnection != null) {</span>
<span class="nc" id="L205">                urlConnection.disconnect();</span>
            }
        }
<span class="nc" id="L208">        return plan;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>