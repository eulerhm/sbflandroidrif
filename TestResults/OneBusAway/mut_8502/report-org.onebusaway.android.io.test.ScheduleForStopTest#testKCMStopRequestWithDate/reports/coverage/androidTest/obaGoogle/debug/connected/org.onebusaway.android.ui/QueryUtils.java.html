<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QueryUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">QueryUtils.java</span></div><h1>QueryUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011 Paul Watts (paulcwatts@gmail.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.request.ObaRouteRequest;
import org.onebusaway.android.io.request.ObaRouteResponse;
import org.onebusaway.android.provider.ObaContract;
import org.onebusaway.android.util.UIUtils;

import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.net.Uri;
import android.os.Bundle;
import android.text.TextUtils;
import android.text.format.DateUtils;
import android.view.View;
import android.widget.ImageView;
import android.widget.ListView;

import androidx.cursoradapter.widget.SimpleCursorAdapter;
import androidx.loader.app.LoaderManager;
import androidx.loader.content.AsyncTaskLoader;
import androidx.loader.content.CursorLoader;
import androidx.loader.content.Loader;

/**
 * Utilities mainly to support queries for the Stops and Routes lists
 *
 * @author paulw
 */
<span class="nc" id="L48">public final class QueryUtils {</span>

    static protected CursorLoader newRecentQuery(
            final Context context,
            final Uri uri,
            final String[] projection,
            final String accessTime,
            final String useCount) {
        // &quot;Recently&quot; means seven days in the past
<span class="nc" id="L57">        final long last = System.currentTimeMillis() - 7 * DateUtils.DAY_IN_MILLIS;</span>
<span class="nc" id="L58">        Uri limit = uri.buildUpon().appendQueryParameter(&quot;limit&quot;, &quot;20&quot;).build();</span>

<span class="nc" id="L60">        String regionWhere = &quot;&quot;;</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (Application.get().getCurrentRegion() != null) {</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">            if (projection.equals(QueryUtils.StopList.Columns.PROJECTION)) {</span>
<span class="nc" id="L63">                regionWhere = &quot; AND &quot; + StopList.getRegionWhere();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">            } else if (projection.equals(QueryUtils.RouteList.Columns.PROJECTION)) {</span>
<span class="nc" id="L65">                regionWhere = &quot; AND &quot; + RouteList.getRegionWhere();</span>
            }
        }

<span class="nc" id="L69">        return new CursorLoader(context,</span>
                limit,
                projection,
                &quot;((&quot; +
                        accessTime + &quot; IS NOT NULL AND &quot; +
                        accessTime + &quot; &gt; &quot; + last +
                        &quot;) OR (&quot; + useCount + &quot; &gt; 0))&quot; + regionWhere,
                null,
                accessTime + &quot; desc, &quot; +
                        useCount + &quot; desc&quot;
        );
    }

<span class="nc" id="L82">    static final class RouteList {</span>

        public interface Columns {

<span class="nc" id="L86">            public static final String[] PROJECTION = {</span>
                    ObaContract.Routes._ID,
                    ObaContract.Routes.SHORTNAME,
                    ObaContract.Routes.LONGNAME,
                    ObaContract.Routes.URL
            };
            public static final int COL_ID = 0;
            public static final int COL_SHORTNAME = 1;
            // private static final int COL_LONGNAME = 2;
            public static final int COL_URL = 3;
        }

        public static SimpleCursorAdapter newAdapter(Context context) {
<span class="nc" id="L99">            final String[] from = {</span>
                    ObaContract.Routes.SHORTNAME,
                    ObaContract.Routes.LONGNAME
            };
<span class="nc" id="L103">            final int[] to = {</span>
                    R.id.short_name,
                    R.id.long_name
            };
<span class="nc" id="L107">            SimpleCursorAdapter simpleAdapter =</span>
                    new SimpleCursorAdapter(context, R.layout.route_list_item,
                            null, from, to, 0);
<span class="nc" id="L110">            return simpleAdapter;</span>
        }

        static protected String getId(ListView l, int position) {
            // Get the cursor and fetch the route ID from that.
<span class="nc" id="L115">            SimpleCursorAdapter cursorAdapter = (SimpleCursorAdapter) l.getAdapter();</span>
<span class="nc" id="L116">            Cursor c = cursorAdapter.getCursor();</span>
<span class="nc" id="L117">            c.moveToPosition(position - l.getHeaderViewsCount());</span>
<span class="nc" id="L118">            return c.getString(Columns.COL_ID);</span>
        }

        static protected String getShortName(ListView l, int position) {
            // Get the cursor and fetch the route short name from that.
<span class="nc" id="L123">            SimpleCursorAdapter cursorAdapter = (SimpleCursorAdapter) l.getAdapter();</span>
<span class="nc" id="L124">            Cursor c = cursorAdapter.getCursor();</span>
<span class="nc" id="L125">            c.moveToPosition(position - l.getHeaderViewsCount());</span>
<span class="nc" id="L126">            return c.getString(Columns.COL_SHORTNAME);</span>
        }

        static protected String getUrl(ListView l, int position) {
            // Get the cursor and fetch the route URL from that.
<span class="nc" id="L131">            SimpleCursorAdapter cursorAdapter = (SimpleCursorAdapter) l.getAdapter();</span>
<span class="nc" id="L132">            Cursor c = cursorAdapter.getCursor();</span>
<span class="nc" id="L133">            c.moveToPosition(position - l.getHeaderViewsCount());</span>
<span class="nc" id="L134">            return c.getString(Columns.COL_URL);</span>
        }

        static protected String getRegionWhere() {
<span class="nc bnc" id="L138" title="All 2 branches missed.">            return Application.get().getCurrentRegion() == null ? &quot;&quot; :</span>
<span class="nc" id="L139">                    QueryUtils.getRegionWhere(ObaContract.Routes.REGION_ID,</span>
<span class="nc" id="L140">                            Application.get().getCurrentRegion().getId());</span>
        }
    }

<span class="nc" id="L144">    static final class StopList {</span>

        public interface Columns {

<span class="nc" id="L148">            public static final String[] PROJECTION = {</span>
                    ObaContract.Stops._ID,
                    ObaContract.Stops.UI_NAME,
                    ObaContract.Stops.DIRECTION,
                    ObaContract.Stops.LATITUDE,
                    ObaContract.Stops.LONGITUDE,
                    ObaContract.Stops.UI_NAME,
                    ObaContract.Stops.FAVORITE
            };
            public static final int COL_ID = 0;
            public static final int COL_NAME = 1;
            public static final int COL_DIRECTION = 2;
            public static final int COL_LATITUDE = 3;
            public static final int COL_LONGITUDE = 4;
            public static final int COL_UI_NAME = 5;
            public static final int COL_FAVORITE = 6;
        }

        public static SimpleCursorAdapter newAdapter(Context context) {
<span class="nc" id="L167">            String[] from = new String[]{</span>
                    ObaContract.Stops.UI_NAME,
                    ObaContract.Stops.DIRECTION,
                    ObaContract.Stops.FAVORITE
            };
<span class="nc" id="L172">            int[] to = new int[]{</span>
                    R.id.stop_name,
                    R.id.direction,
                    R.id.stop_favorite
            };
<span class="nc" id="L177">            SimpleCursorAdapter simpleAdapter =</span>
                    new SimpleCursorAdapter(context, R.layout.stop_list_item, null, from, to, 0);

            // We need to convert the direction text (N/NW/E/etc)
            // to user level text (North/Northwest/etc..)
<span class="nc" id="L182">            simpleAdapter.setViewBinder(new SimpleCursorAdapter.ViewBinder() {</span>
                public boolean setViewValue(View view, Cursor cursor, int columnIndex) {
<span class="nc bnc" id="L184" title="All 2 branches missed.">                    if (columnIndex == Columns.COL_FAVORITE) {</span>
<span class="nc" id="L185">                        ImageView favorite = (ImageView) view.findViewById(R.id.stop_favorite);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                        if (cursor.getInt(columnIndex) == 1) {</span>
<span class="nc" id="L187">                            favorite.setVisibility(View.VISIBLE);</span>
                            // Make sure the star is visible against white background
<span class="nc" id="L189">                            favorite.setColorFilter(</span>
<span class="nc" id="L190">                                    favorite.getResources().getColor(R.color.navdrawer_icon_tint));</span>
                        } else {
<span class="nc" id="L192">                            favorite.setVisibility(View.GONE);</span>
                        }
<span class="nc" id="L194">                        return true;</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                    } else if (columnIndex == Columns.COL_DIRECTION) {</span>
<span class="nc" id="L196">                        UIUtils.setStopDirection(view.findViewById(R.id.direction),</span>
<span class="nc" id="L197">                                cursor.getString(columnIndex),</span>
                                true);
<span class="nc" id="L199">                        return true;</span>
                    }
<span class="nc" id="L201">                    return false;</span>
                }
            });
<span class="nc" id="L204">            return simpleAdapter;</span>
        }

        static protected String getId(ListView l, int position) {
            // Get the cursor and fetch the stop ID from that.
<span class="nc" id="L209">            SimpleCursorAdapter cursorAdapter = (SimpleCursorAdapter) l.getAdapter();</span>
<span class="nc" id="L210">            Cursor c = cursorAdapter.getCursor();</span>
<span class="nc" id="L211">            c.moveToPosition(position - l.getHeaderViewsCount());</span>
<span class="nc" id="L212">            return c.getString(Columns.COL_ID);</span>
        }

        static protected String getRegionWhere() {
<span class="nc bnc" id="L216" title="All 2 branches missed.">            return Application.get().getCurrentRegion() == null ? &quot;&quot; :</span>
<span class="nc" id="L217">                    QueryUtils.getRegionWhere(ObaContract.Stops.REGION_ID,</span>
<span class="nc" id="L218">                            Application.get().getCurrentRegion().getId());</span>
        }
    }

    public static String getRegionWhere(String regionFieldName, long regionId) {
<span class="nc" id="L223">        return &quot;(&quot; + regionFieldName + &quot;=&quot; + regionId +</span>
                &quot; OR &quot; + regionFieldName + &quot; IS NULL)&quot;;
    }

    /**
     * Sets the given route and headsign and stop as a favorite, including checking to make sure that the
     * route has already been added to the local provider.  If this route/headsign should be marked
     * as a favorite for all stops, stopId should be null.
     *
     * @param routeUri Uri for the route to be added
     * @param headsign the headsign to be marked as favorite, along with the routeUri
     * @param stopId the stopId to be marked as a favorite, along with with route and headsign.  If
     *               this route/headsign should be marked for all stops, then stopId should be null
     * @param routeValues   content routeValues to be set for the route details (see ObaContract.RouteColumns)
     *                 (may be null)
     * @param favorite true if this route/headsign should be marked as a favorite, false if it
     *                 should not
     */
    public static void setFavoriteRouteAndHeadsign(Context context, Uri routeUri,
            String headsign, String stopId, ContentValues routeValues, boolean favorite) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (routeValues == null) {</span>
<span class="nc" id="L244">            routeValues = new ContentValues();</span>
        }
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (Application.get().getCurrentRegion() != null) {</span>
<span class="nc" id="L247">            routeValues.put(ObaContract.Routes.REGION_ID,</span>
<span class="nc" id="L248">                    Application.get().getCurrentRegion().getId());</span>
        }

<span class="nc" id="L251">        String routeId = routeUri.getLastPathSegment();</span>

        // Make sure this route has been inserted into the routes table
<span class="nc" id="L254">        ObaContract.Routes.insertOrUpdate(context, routeId, routeValues, true);</span>
        // Mark the combination of route and headsign as a favorite or not favorite
<span class="nc" id="L256">        ObaContract.RouteHeadsignFavorites</span>
<span class="nc" id="L257">                .markAsFavorite(context, routeId, headsign, stopId, favorite);</span>
<span class="nc" id="L258">    }</span>

    final static class RouteInfoLoader extends AsyncTaskLoader&lt;ObaRouteResponse&gt; {

        private final String mRouteId;

        RouteInfoLoader(Context context, String routeId) {
<span class="nc" id="L265">            super(context);</span>
<span class="nc" id="L266">            mRouteId = routeId;</span>
<span class="nc" id="L267">        }</span>

        @Override
        public void onStartLoading() {
<span class="nc" id="L271">            forceLoad();</span>
<span class="nc" id="L272">        }</span>

        @Override
        public ObaRouteResponse loadInBackground() {
<span class="nc" id="L276">            return ObaRouteRequest.newRequest(getContext(), mRouteId).call();</span>
        }
    }

    final static class RouteLoaderCallback
            implements LoaderManager.LoaderCallbacks&lt;ObaRouteResponse&gt; {

        private String mRouteId;
        private Context mContext;

        public RouteLoaderCallback(Context context, String routeId) {
<span class="nc" id="L287">            super();</span>
<span class="nc" id="L288">            mRouteId = routeId;</span>
<span class="nc" id="L289">            mContext = context;</span>
<span class="nc" id="L290">        }</span>

        @Override
        public Loader&lt;ObaRouteResponse&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L294">            return new QueryUtils.RouteInfoLoader(mContext, mRouteId);</span>
        }

        @Override
        public void onLoadFinished(Loader&lt;ObaRouteResponse&gt; loader,
                                   ObaRouteResponse data) {
<span class="nc" id="L300">            recordRouteInfo(data);</span>
<span class="nc" id="L301">        }</span>

        @Override
        public void onLoaderReset(Loader&lt;ObaRouteResponse&gt; loader) {
            // Nothing to do right here...
<span class="nc" id="L306">        }</span>

        private void recordRouteInfo(ObaRouteResponse routeInfo) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (routeInfo.getCode() == ObaApi.OBA_OK) {</span>
<span class="nc" id="L310">                String url = routeInfo.getUrl();</span>

<span class="nc" id="L312">                String shortName = routeInfo.getShortName();</span>
<span class="nc" id="L313">                String longName = routeInfo.getLongName();</span>

<span class="nc bnc" id="L315" title="All 2 branches missed.">                if (TextUtils.isEmpty(shortName)) {</span>
<span class="nc" id="L316">                    shortName = longName;</span>
                }
<span class="nc bnc" id="L318" title="All 4 branches missed.">                if (TextUtils.isEmpty(longName) || shortName.equals(longName)) {</span>
<span class="nc" id="L319">                    longName = routeInfo.getDescription();</span>
                }

<span class="nc" id="L322">                ContentValues values = new ContentValues();</span>
<span class="nc" id="L323">                values.put(ObaContract.Routes.SHORTNAME, shortName);</span>
<span class="nc" id="L324">                values.put(ObaContract.Routes.LONGNAME, longName);</span>
<span class="nc" id="L325">                values.put(ObaContract.Routes.URL, url);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                if (Application.get().getCurrentRegion() != null) {</span>
<span class="nc" id="L327">                    values.put(ObaContract.Routes.REGION_ID,</span>
<span class="nc" id="L328">                            Application.get().getCurrentRegion().getId());</span>
                }
<span class="nc" id="L330">                ObaContract.Routes.insertOrUpdate(mContext, routeInfo.getId(), values,</span>
                        true);
            }
<span class="nc" id="L333">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>