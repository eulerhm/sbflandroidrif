<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySearchRoutesFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">MySearchRoutesFragment.java</span></div><h1>MySearchRoutesFragment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2010-2017 Paul Watts (paulcwatts@gmail.com),
 * University of South  Florida (sjbarbeau@gmail.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import org.onebusaway.android.R;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.elements.ObaRoute;
import org.onebusaway.android.io.request.ObaRoutesForLocationRequest;
import org.onebusaway.android.io.request.ObaRoutesForLocationResponse;
import org.onebusaway.android.util.ArrayAdapter;
import org.onebusaway.android.util.LocationUtils;
import org.onebusaway.android.util.UIUtils;
import android.app.Activity;
import android.content.Context;
import android.location.Location;
import android.os.Bundle;
import android.view.ContextMenu;
import android.view.ContextMenu.ContextMenuInfo;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView.AdapterContextMenuInfo;
import android.widget.ListAdapter;
import android.widget.ListView;
import android.widget.TextView;
import java.util.Arrays;
import androidx.core.content.pm.ShortcutInfoCompat;
import androidx.loader.app.LoaderManager;
import androidx.loader.content.AsyncTaskLoader;
import androidx.loader.content.Loader;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L48">public class MySearchRoutesFragment extends MySearchFragmentBase implements LoaderManager.LoaderCallbacks&lt;ObaRoutesForLocationResponse&gt; {</span>

    // private static final String TAG = &quot;MySearchRoutesActivity&quot;;
    private static final String QUERY_TEXT = &quot;query_text&quot;;

    public static final String TAB_NAME = &quot;search&quot;;

    private MyAdapter mAdapter;

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3074)) {</span>
<span class="nc" id="L60">            super.onActivityCreated(savedInstanceState);</span>
        }
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3075)) {</span>
<span class="nc" id="L63">            mAdapter = new MyAdapter(getActivity());</span>
        }
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3076)) {</span>
<span class="nc" id="L66">            setListAdapter(mAdapter);</span>
        }
<span class="nc" id="L68">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup root, Bundle savedInstanceState) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3077)) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (root == null) {</span>
                // reason to create our view.
<span class="nc" id="L75">                return null;</span>
            }
        }
<span class="nc" id="L78">        return inflater.inflate(R.layout.my_search_route_list, null);</span>
    }

    @Override
    public Loader&lt;ObaRoutesForLocationResponse&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L83">        String query = args.getString(QUERY_TEXT);</span>
<span class="nc" id="L84">        return new MyLoader(getActivity(), query, getSearchCenter());</span>
    }

    @Override
    public void onLoadFinished(Loader&lt;ObaRoutesForLocationResponse&gt; loader, ObaRoutesForLocationResponse response) {
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3078)) {</span>
<span class="nc" id="L90">            UIUtils.showProgress(this, false);</span>
        }
        // Log.d(TAG, &quot;Loader finished&quot;);
<span class="nc" id="L93">        final int code = response.getCode();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3088)) {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (code == ObaApi.OBA_OK) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3086)) {</span>
<span class="nc" id="L97">                    setEmptyText(getString(R.string.find_hint_noresults));</span>
                }
<span class="nc bnc" id="L99" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3087)) {</span>
<span class="nc" id="L100">                    mAdapter.setData(Arrays.asList(response.getRoutesForLocation()));</span>
                }
<span class="nc bnc" id="L102" title="All 22 branches missed.">            } else if ((ListenerUtil.mutListener.listen(3083) ? (code &gt;= 0) : (ListenerUtil.mutListener.listen(3082) ? (code &lt;= 0) : (ListenerUtil.mutListener.listen(3081) ? (code &gt; 0) : (ListenerUtil.mutListener.listen(3080) ? (code &lt; 0) : (ListenerUtil.mutListener.listen(3079) ? (code == 0) : (code != 0))))))) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3085)) {</span>
                    // a 'communication' error. Just fake no results.
<span class="nc" id="L105">                    setEmptyText(getString(R.string.find_hint_noresults));</span>
                }
            } else {
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3084)) {</span>
<span class="nc" id="L109">                    setEmptyText(getString(R.string.generic_comm_error));</span>
                }
            }
        }
<span class="nc" id="L113">    }</span>

    @Override
    public void onLoaderReset(Loader&lt;ObaRoutesForLocationResponse&gt; loader) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3089)) {</span>
<span class="nc" id="L118">            mAdapter.clear();</span>
        }
<span class="nc" id="L120">    }</span>

    // 
    @Override
    protected void doSearch(String text) {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3090)) {</span>
<span class="nc" id="L126">            UIUtils.showProgress(this, true);</span>
        }
<span class="nc" id="L128">        Bundle args = new Bundle();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3091)) {</span>
<span class="nc" id="L130">            args.putString(QUERY_TEXT, text);</span>
        }
<span class="nc" id="L132">        Loader&lt;?&gt; loader = getLoaderManager().restartLoader(0, args, this);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3092)) {</span>
<span class="nc" id="L134">            loader.onContentChanged();</span>
        }
<span class="nc" id="L136">    }</span>

    @Override
    protected int getEditBoxHintText() {
<span class="nc" id="L140">        return R.string.search_route_hint;</span>
    }

    @Override
    protected int getMinSearchLength() {
<span class="nc" id="L145">        return 1;</span>
    }

    @Override
    protected CharSequence getHintText() {
<span class="nc" id="L150">        return getString(R.string.find_hint_nofavoriteroutes);</span>
    }

    @Override
    public void onListItemClick(ListView l, View v, int position, long id) {
        // Get the adapter (this may or may not be a SimpleCursorAdapter)
<span class="nc" id="L156">        ListAdapter adapter = l.getAdapter();</span>
<span class="nc bnc" id="L157" title="All 8 branches missed.">        ObaRoute route = (ObaRoute) adapter.getItem((ListenerUtil.mutListener.listen(3096) ? (position % l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3095) ? (position / l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3094) ? (position * l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3093) ? (position + l.getHeaderViewsCount()) : (position - l.getHeaderViewsCount()))))));</span>
<span class="nc" id="L158">        final String routeId = route.getId();</span>
<span class="nc" id="L159">        final String routeName = UIUtils.getRouteDisplayName(route);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3100)) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (isShortcutMode()) {</span>
<span class="nc" id="L162">                final ShortcutInfoCompat shortcut = UIUtils.createRouteShortcut(getContext(), routeId, routeName);</span>
<span class="nc" id="L163">                Activity activity = getActivity();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3098)) {</span>
<span class="nc" id="L165">                    activity.setResult(Activity.RESULT_OK, shortcut.getIntent());</span>
                }
<span class="nc bnc" id="L167" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3099)) {</span>
<span class="nc" id="L168">                    activity.finish();</span>
                }
<span class="nc" id="L170">            } else {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3097)) {</span>
<span class="nc" id="L172">                    RouteInfoActivity.start(getActivity(), routeId);</span>
                }
            }
        }
<span class="nc" id="L176">    }</span>

    @Override
    public void onCreateContextMenu(ContextMenu menu, View v, ContextMenuInfo menuInfo) {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3101)) {</span>
<span class="nc" id="L181">            super.onCreateContextMenu(menu, v, menuInfo);</span>
        }
<span class="nc" id="L183">        AdapterContextMenuInfo info = (AdapterContextMenuInfo) menuInfo;</span>
<span class="nc" id="L184">        final TextView text = (TextView) info.targetView.findViewById(R.id.short_name);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3102)) {</span>
<span class="nc" id="L186">            menu.setHeaderTitle(getString(R.string.route_name, text.getText()));</span>
        }
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3105)) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (isShortcutMode()) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3104)) {</span>
<span class="nc" id="L191">                    menu.add(0, CONTEXT_MENU_DEFAULT, 0, R.string.my_context_create_shortcut);</span>
                }
            } else {
<span class="nc bnc" id="L194" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3103)) {</span>
<span class="nc" id="L195">                    menu.add(0, CONTEXT_MENU_DEFAULT, 0, R.string.my_context_get_route_info);</span>
                }
            }
        }
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3106)) {</span>
<span class="nc" id="L200">            menu.add(0, CONTEXT_MENU_SHOW_ON_MAP, 0, R.string.my_context_showonmap);</span>
        }
<span class="nc" id="L202">        final String url = getUrl(getListView(), info.position);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3108)) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (url != null) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3107)) {</span>
<span class="nc" id="L206">                    menu.add(0, CONTEXT_MENU_SHOW_URL, 0, R.string.my_context_show_schedule);</span>
                }
            }
        }
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3109)) {</span>
<span class="nc" id="L211">            menu.add(0, CONTEXT_MENU_CREATE_SHORTCUT, 0, R.string.my_context_create_shortcut);</span>
        }
<span class="nc" id="L213">    }</span>

    @Override
    public boolean onContextItemSelected(MenuItem item) {
<span class="nc" id="L217">        AdapterContextMenuInfo info = (AdapterContextMenuInfo) item.getMenuInfo();</span>
<span class="nc bnc" id="L218" title="All 5 branches missed.">        switch(item.getItemId()) {</span>
            case CONTEXT_MENU_DEFAULT:
<span class="nc bnc" id="L220" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3110)) {</span>
                    // Fake a click
<span class="nc" id="L222">                    onListItemClick(getListView(), info.targetView, info.position, info.id);</span>
                }
<span class="nc" id="L224">                return true;</span>
            case CONTEXT_MENU_SHOW_ON_MAP:
<span class="nc bnc" id="L226" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3111)) {</span>
<span class="nc" id="L227">                    HomeActivity.start(getActivity(), getId(getListView(), info.position));</span>
                }
<span class="nc" id="L229">                return true;</span>
            case CONTEXT_MENU_SHOW_URL:
<span class="nc bnc" id="L231" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3112)) {</span>
<span class="nc" id="L232">                    UIUtils.goToUrl(getActivity(), getUrl(getListView(), info.position));</span>
                }
<span class="nc" id="L234">                return true;</span>
            case CONTEXT_MENU_CREATE_SHORTCUT:
<span class="nc" id="L236">                String id = QueryUtils.RouteList.getId(getListView(), info.position);</span>
<span class="nc" id="L237">                String shortName = QueryUtils.RouteList.getShortName(getListView(), info.position);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3113)) {</span>
<span class="nc" id="L239">                    UIUtils.createRouteShortcut(getContext(), id, shortName);</span>
                }
<span class="nc" id="L241">                return true;</span>
            default:
<span class="nc" id="L243">                return super.onContextItemSelected(item);</span>
        }
    }

    private String getId(ListView l, int position) {
<span class="nc" id="L248">        ListAdapter adapter = l.getAdapter();</span>
<span class="nc bnc" id="L249" title="All 8 branches missed.">        ObaRoute route = (ObaRoute) adapter.getItem((ListenerUtil.mutListener.listen(3117) ? (position % l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3116) ? (position / l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3115) ? (position * l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3114) ? (position + l.getHeaderViewsCount()) : (position - l.getHeaderViewsCount()))))));</span>
<span class="nc" id="L250">        return route.getId();</span>
    }

    private String getUrl(ListView l, int position) {
<span class="nc" id="L254">        ListAdapter adapter = l.getAdapter();</span>
<span class="nc bnc" id="L255" title="All 8 branches missed.">        ObaRoute route = (ObaRoute) adapter.getItem((ListenerUtil.mutListener.listen(3121) ? (position % l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3120) ? (position / l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3119) ? (position * l.getHeaderViewsCount()) : (ListenerUtil.mutListener.listen(3118) ? (position + l.getHeaderViewsCount()) : (position - l.getHeaderViewsCount()))))));</span>
<span class="nc" id="L256">        return route.getUrl();</span>
    }

    // 
    private static final class MyAdapter extends ArrayAdapter&lt;ObaRoute&gt; {

        public MyAdapter(Context context) {
<span class="nc" id="L263">            super(context, R.layout.route_list_item);</span>
<span class="nc" id="L264">        }</span>

        @Override
        protected void initView(View view, ObaRoute route) {
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(3122)) {</span>
<span class="nc" id="L269">                UIUtils.setRouteView(view, route);</span>
            }
<span class="nc" id="L271">        }</span>
    }

    // 
    private static final class MyLoader extends AsyncTaskLoader&lt;ObaRoutesForLocationResponse&gt; {

        private final String mQueryText;

        private final Location mCenter;

        public MyLoader(Context context, String query, Location center) {
<span class="nc" id="L282">            super(context);</span>
<span class="nc" id="L283">            mQueryText = query;</span>
<span class="nc" id="L284">            mCenter = center;</span>
<span class="nc" id="L285">        }</span>

        @Override
        public ObaRoutesForLocationResponse loadInBackground() {
<span class="nc" id="L289">            ObaRoutesForLocationResponse response = new ObaRoutesForLocationRequest.Builder(getContext(), mCenter).setQuery(mQueryText).build().call();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(3124)) {</span>
                // Log.d(TAG, &quot;Server returns: &quot; + response.getCode());
<span class="nc bnc" id="L292" title="All 2 branches missed.">                if (response.getCode() == ObaApi.OBA_OK) {</span>
<span class="nc" id="L293">                    ObaRoute[] routes = response.getRoutesForLocation();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3123)) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                        if (routes.length != 0) {</span>
<span class="nc" id="L296">                            return response;</span>
                        }
                    }
                }
            }
<span class="nc" id="L301">            Location center = LocationUtils.getDefaultSearchCenter();</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(3125)) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                if (center != null) {</span>
<span class="nc" id="L304">                    return new ObaRoutesForLocationRequest.Builder(getContext(), center).setRadius(LocationUtils.DEFAULT_SEARCH_RADIUS).setQuery(mQueryText).build().call();</span>
                }
            }
<span class="nc" id="L307">            return response;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>