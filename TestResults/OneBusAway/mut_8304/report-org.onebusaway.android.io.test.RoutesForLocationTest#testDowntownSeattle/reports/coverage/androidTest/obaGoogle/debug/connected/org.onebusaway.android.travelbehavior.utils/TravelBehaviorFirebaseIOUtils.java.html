<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TravelBehaviorFirebaseIOUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.travelbehavior.utils</a> &gt; <span class="el_source">TravelBehaviorFirebaseIOUtils.java</span></div><h1>TravelBehaviorFirebaseIOUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2019 University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.travelbehavior.utils;

import com.google.firebase.firestore.DocumentReference;
import com.google.firebase.firestore.FieldValue;
import com.google.firebase.firestore.FirebaseFirestore;

import org.onebusaway.android.travelbehavior.constants.TravelBehaviorConstants;
import org.onebusaway.android.travelbehavior.model.ArrivalAndDepartureData;
import org.onebusaway.android.travelbehavior.model.ArrivalAndDepartureInfo;
import org.onebusaway.android.travelbehavior.model.DestinationReminderData;
import org.onebusaway.android.travelbehavior.model.DestinationReminderInfo;
import org.onebusaway.android.travelbehavior.model.DeviceInformation;
import org.onebusaway.android.travelbehavior.model.TravelBehaviorInfo;
import org.onebusaway.android.travelbehavior.model.TripPlanData;
import org.onebusaway.android.travelbehavior.model.TripPlanInfo;
import org.onebusaway.android.util.PreferenceUtils;

import android.location.Location;
import android.util.Log;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

<span class="nc" id="L40">public class TravelBehaviorFirebaseIOUtils {</span>

    private static final String TAG = &quot;TravelBehaviorFirebase&quot;;

    private static String buildDocumentPathByUid(String uid, String folder) {
<span class="nc" id="L45">        StringBuilder pathBuilder = new StringBuilder();</span>
<span class="nc" id="L46">        pathBuilder.append(&quot;users/&quot;).append(uid).append(&quot;/&quot;).</span>
<span class="nc" id="L47">                append(folder);</span>
<span class="nc" id="L48">        return pathBuilder.toString();</span>
    }

    public static DocumentReference getFirebaseDocReferenceByUserIdAndRecordId(String userId,
                                                                               String recordId,
                                                                               String folder) {
<span class="nc" id="L54">        String path = TravelBehaviorFirebaseIOUtils.buildDocumentPathByUid(userId, folder);</span>
<span class="nc" id="L55">        FirebaseFirestore db = FirebaseFirestore.getInstance();</span>
<span class="nc" id="L56">        return db.collection(path).document(recordId);</span>
    }

    public static void saveLocation(Location location, String userId, String recordId) {
<span class="nc" id="L60">        TravelBehaviorInfo.LocationInfo locationInfo = new TravelBehaviorInfo.LocationInfo(location);</span>
<span class="nc" id="L61">        Map locationMap = TravelBehaviorUtils.getLocationMapByLocationInfo(locationInfo);</span>

<span class="nc" id="L63">        DocumentReference document = TravelBehaviorFirebaseIOUtils.</span>
<span class="nc" id="L64">                getFirebaseDocReferenceByUserIdAndRecordId(userId, recordId,</span>
                        TravelBehaviorConstants.FIREBASE_ACTIVITY_TRANSITION_FOLDER);
<span class="nc" id="L66">        document.update(&quot;locationInfoList&quot;, FieldValue.arrayUnion(locationMap)).</span>
<span class="nc" id="L67">                addOnCompleteListener(task -&gt; {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                    if (task.isSuccessful()) {</span>
<span class="nc" id="L69">                        Log.d(TAG, &quot;Location update saved with provider: &quot; +</span>
<span class="nc" id="L70">                                location.getProvider());</span>
                    } else {
<span class="nc" id="L72">                        logErrorMessage(task.getException(), &quot;Location update failed: &quot;);</span>
                    }
<span class="nc" id="L74">                });</span>
<span class="nc" id="L75">    }</span>

    public static void saveArrivalsAndDepartures(List&lt;ArrivalAndDepartureData&gt; arrivalAndDepartureList,
                                                 String userId, String recordId) {
<span class="nc" id="L79">        DocumentReference document = TravelBehaviorFirebaseIOUtils.</span>
<span class="nc" id="L80">                getFirebaseDocReferenceByUserIdAndRecordId(userId, recordId,</span>
                        TravelBehaviorConstants.FIREBASE_ARRIVAL_AND_DEPARTURE_FOLDER);

<span class="nc" id="L83">        document.set(new ArrivalAndDepartureInfo(arrivalAndDepartureList)).</span>
<span class="nc" id="L84">                addOnCompleteListener(task -&gt; {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    if (task.isSuccessful()) {</span>
<span class="nc" id="L86">                        Log.d(TAG, &quot;Arrivals and departure are saved with ID: &quot; +</span>
<span class="nc" id="L87">                                document.getId());</span>
                    } else {
<span class="nc" id="L89">                        logErrorMessage(task.getException(),</span>
                                &quot;Arrivals and departure are failed to be saved &quot;);
                    }
<span class="nc" id="L92">                });</span>
<span class="nc" id="L93">    }</span>

    public static void saveTripPlans(List&lt;TripPlanData&gt; tripPlanDataList,
                                     String userId, String recordId) {
<span class="nc" id="L97">        DocumentReference document = TravelBehaviorFirebaseIOUtils.</span>
<span class="nc" id="L98">                getFirebaseDocReferenceByUserIdAndRecordId(userId, recordId,</span>
                        TravelBehaviorConstants.FIREBASE_TRIP_PLAN_FOLDER);

<span class="nc" id="L101">        document.set(new TripPlanInfo(tripPlanDataList)).</span>
<span class="nc" id="L102">                addOnCompleteListener(task -&gt; {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                    if (task.isSuccessful()) {</span>
<span class="nc" id="L104">                        Log.d(TAG, &quot;Trip plans are saved with ID: &quot; +</span>
<span class="nc" id="L105">                                document.getId());</span>
                    } else {
<span class="nc" id="L107">                        logErrorMessage(task.getException(),</span>
                                &quot;Trip plans are failed to be saved &quot;);
                    }
<span class="nc" id="L110">                });</span>
<span class="nc" id="L111">    }</span>

    public static void saveDestinationReminders(List&lt;DestinationReminderData&gt; reminderData,
                                                String userId, String recordId) {
<span class="nc" id="L115">        DocumentReference document = TravelBehaviorFirebaseIOUtils.</span>
<span class="nc" id="L116">                getFirebaseDocReferenceByUserIdAndRecordId(userId, recordId,</span>
                        TravelBehaviorConstants.FIREBASE_DESTINATION_REMINDER_FOLDER);

<span class="nc" id="L119">        document.set(new DestinationReminderInfo(reminderData)).</span>
<span class="nc" id="L120">                addOnCompleteListener(task -&gt; {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                    if (task.isSuccessful()) {</span>
<span class="nc" id="L122">                        Log.d(TAG, &quot;Destination reminders are saved with ID: &quot; +</span>
<span class="nc" id="L123">                                document.getId());</span>
                    } else {
<span class="nc" id="L125">                        logErrorMessage(task.getException(),</span>
                                &quot;Destination reminders are failed to be saved &quot;);
                    }
<span class="nc" id="L128">                });</span>
<span class="nc" id="L129">    }</span>

    public static void saveDeviceInfo(DeviceInformation deviceInformation, String userId,
                                      String recordId, int hashCode) {
<span class="nc" id="L133">        deviceInformation.setTimestamp(recordId);</span>

<span class="nc" id="L135">        DocumentReference document = TravelBehaviorFirebaseIOUtils.</span>
<span class="nc" id="L136">                getFirebaseDocReferenceByUserIdAndRecordId(userId, recordId,</span>
                        TravelBehaviorConstants.FIREBASE_DEVICE_INFO_FOLDER);

<span class="nc" id="L139">        document.set(deviceInformation).addOnCompleteListener(task -&gt; {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (task.isSuccessful()) {</span>
<span class="nc" id="L141">                Log.d(TAG, &quot;Device Info document added with ID &quot; + document.getId());</span>
<span class="nc" id="L142">                PreferenceUtils.saveInt(TravelBehaviorConstants.DEVICE_INFO_HASH, hashCode);</span>
            } else {
<span class="nc" id="L144">                logErrorMessage(task.getException(),</span>
                        &quot;Device Info transition document failed to be added: &quot;);
            }
<span class="nc" id="L147">        });</span>
<span class="nc" id="L148">    }</span>

    public static void initFirebaseUserWithId(String userId) {
<span class="nc" id="L151">        FirebaseFirestore db = FirebaseFirestore.getInstance();</span>
<span class="nc" id="L152">        DocumentReference document = db.collection(&quot;users/&quot;).document(userId + &quot;/&quot;);</span>
<span class="nc" id="L153">        Map&lt;String, String&gt; m = new HashMap&lt;&gt;();</span>
<span class="nc" id="L154">        m.put(&quot;userId&quot;, userId);</span>
<span class="nc" id="L155">        document.set(m).addOnCompleteListener(task -&gt; {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (task.isSuccessful()) {</span>
<span class="nc" id="L157">                Log.d(TAG, &quot;Firebase initialized with user id: &quot; + userId);</span>
            } else {
<span class="nc" id="L159">                logErrorMessage(task.getException(),</span>
                        &quot;Firebase failed to initialize with user id&quot;);
            }
<span class="nc" id="L162">        });</span>
<span class="nc" id="L163">    }</span>

    public static void logErrorMessage(Exception e, String message) {
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L167">            Log.d(TAG, message +</span>
<span class="nc" id="L168">                    e.getMessage());</span>
<span class="nc" id="L169">            e.printStackTrace();</span>
        } else {
<span class="nc" id="L171">            Log.d(TAG, message);</span>
        }
<span class="nc" id="L173">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>