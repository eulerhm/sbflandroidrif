<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExperimentalRegionsPreference.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.region</a> &gt; <span class="el_source">ExperimentalRegionsPreference.java</span></div><h1>ExperimentalRegionsPreference.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2013 University of South Florida (sjbarbeau@gmail.com).
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.region;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.util.PreferenceUtils;
import android.app.AlertDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.res.TypedArray;
import android.os.Parcel;
import android.os.Parcelable;
import android.preference.CheckBoxPreference;
import android.preference.Preference;
import android.util.AttributeSet;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Custom preference to handle enabling and disabling experimental
 * (i.e., non-production) OBA regions
 * &lt;p/&gt;
 * Code for saving/restoring state based on example at:
 * http://developer.android.com/guide/topics/ui/settings.html
 * &lt;p/&gt;
 * and Android internal YesNoPreference:
 * https://github.com/android/platform_frameworks_base/blob/master/core/java/com/android/internal/preference/YesNoPreference.java
 *
 * @author Sean Barbeau
 */
public class ExperimentalRegionsPreference extends CheckBoxPreference {

    private boolean mCurrentValue;

<span class="nc" id="L48">    private final boolean DEFAULT_VALUE = false;</span>

    // 
    public ExperimentalRegionsPreference(Context context) {
<span class="nc" id="L52">        super(context);</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10476)) {</span>
<span class="nc" id="L54">            initCheckedState();</span>
        }
<span class="nc" id="L56">    }</span>

    public ExperimentalRegionsPreference(Context context, AttributeSet attrs) {
<span class="nc" id="L59">        super(context, attrs);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10477)) {</span>
<span class="nc" id="L61">            initCheckedState();</span>
        }
<span class="nc" id="L63">    }</span>

    public ExperimentalRegionsPreference(Context context, AttributeSet attrs, int defStyle) {
<span class="nc" id="L66">        super(context, attrs, defStyle);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10478)) {</span>
<span class="nc" id="L68">            initCheckedState();</span>
        }
<span class="nc" id="L70">    }</span>

    protected void initCheckedState() {
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10479)) {</span>
<span class="nc" id="L74">            setChecked(Application.getPrefs().getBoolean(getContext().getString(R.string.preference_key_experimental_regions), DEFAULT_VALUE));</span>
        }
<span class="nc" id="L76">    }</span>

    @Override
    public boolean isPersistent() {
<span class="nc" id="L80">        return true;</span>
    }

    @Override
    protected void onClick() {
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10492)) {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (!isChecked()) {</span>
                /*
            Warn the user before enabling, since experimental regions
            may not have real-time info or may be unavailable.
            */
<span class="nc" id="L91">                AlertDialog dialog = new AlertDialog.Builder(getContext()).setMessage(R.string.preferences_experimental_regions_enable_warning).setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {</span>

                    @Override
                    public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L95" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10489)) {</span>
<span class="nc" id="L96">                            dialog.dismiss();</span>
                        }
<span class="nc bnc" id="L98" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10490)) {</span>
<span class="nc" id="L99">                            setValue(true);</span>
                        }
<span class="nc" id="L101">                    }</span>
<span class="nc" id="L102">                }).setNegativeButton(android.R.string.cancel, new DialogInterface.OnClickListener() {</span>

                    @Override
                    public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L106" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10488)) {</span>
<span class="nc" id="L107">                            dialog.dismiss();</span>
                        }
<span class="nc" id="L109">                    }</span>
<span class="nc" id="L110">                }).create();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10491)) {</span>
<span class="nc" id="L112">                    dialog.show();</span>
                }
<span class="nc" id="L114">            } else {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10487)) {</span>
<span class="nc bnc" id="L116" title="All 10 branches missed.">                    if ((ListenerUtil.mutListener.listen(10480) ? (Application.get().getCurrentRegion() != null || Application.get().getCurrentRegion().getExperimental()) : (Application.get().getCurrentRegion() != null &amp;&amp; Application.get().getCurrentRegion().getExperimental()))) {</span>
                        // If the user is currently using an experimental region, warn that it won't be available
<span class="nc" id="L118">                        AlertDialog dialog = new AlertDialog.Builder(getContext()).setMessage(R.string.preferences_experimental_regions_disable_warning).setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {</span>

                            @Override
                            public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L122" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(10483)) {</span>
<span class="nc" id="L123">                                    dialog.dismiss();</span>
                                }
<span class="nc bnc" id="L125" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(10484)) {</span>
                                    // Set the region info to null, so we no longer use the current experimental region
<span class="nc" id="L127">                                    Application.get().setCurrentRegion(null);</span>
                                }
<span class="nc bnc" id="L129" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(10485)) {</span>
<span class="nc" id="L130">                                    setValue(false);</span>
                                }
<span class="nc" id="L132">                            }</span>
<span class="nc" id="L133">                        }).setNegativeButton(android.R.string.cancel, new DialogInterface.OnClickListener() {</span>

                            @Override
                            public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(10482)) {</span>
<span class="nc" id="L138">                                    dialog.dismiss();</span>
                                }
<span class="nc" id="L140">                            }</span>
<span class="nc" id="L141">                        }).create();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10486)) {</span>
<span class="nc" id="L143">                            dialog.show();</span>
                        }
<span class="nc" id="L145">                    } else {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(10481)) {</span>
<span class="nc" id="L147">                            setValue(false);</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L153">    }</span>

    /**
     * Sets the experimental regions preference (both user interface and shared preference value)
     * to
     * the input value
     *
     * @param newValue true if the preference should be set to true, false if it should be set to
     *                 false
     */
    public void setValue(boolean newValue) {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10493)) {</span>
<span class="nc" id="L165">            mCurrentValue = newValue;</span>
        }
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10494)) {</span>
<span class="nc" id="L168">            setChecked(newValue);</span>
        }
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10495)) {</span>
<span class="nc" id="L171">            PreferenceUtils.saveBoolean(getContext().getString(R.string.preference_key_experimental_regions), newValue);</span>
        }
<span class="nc" id="L173">    }</span>

    @Override
    protected void onSetInitialValue(boolean restorePersistedValue, Object defaultValue) {
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10499)) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (restorePersistedValue) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10498)) {</span>
                    // Restore existing state
<span class="nc" id="L181">                    mCurrentValue = this.getPersistedBoolean(mCurrentValue);</span>
                }
            } else {
<span class="nc bnc" id="L184" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10496)) {</span>
                    // Set default state from the XML attribute
<span class="nc" id="L186">                    mCurrentValue = (Boolean) defaultValue;</span>
                }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10497)) {</span>
<span class="nc" id="L189">                    persistBoolean(mCurrentValue);</span>
                }
            }
        }
<span class="nc" id="L193">    }</span>

    @Override
    protected Object onGetDefaultValue(TypedArray a, int index) {
<span class="nc" id="L197">        return a.getBoolean(index, DEFAULT_VALUE);</span>
    }

    @Override
    protected Parcelable onSaveInstanceState() {
<span class="nc" id="L202">        final Parcelable superState = super.onSaveInstanceState();</span>
        // Create instance of custom BaseSavedState
<span class="nc" id="L204">        final SavedState myState = new SavedState(superState);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10500)) {</span>
            // Set the state's value with the class member that holds current setting value
<span class="nc" id="L207">            myState.value = mCurrentValue;</span>
        }
<span class="nc" id="L209">        return myState;</span>
    }

    @Override
    protected void onRestoreInstanceState(Parcelable state) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10503)) {</span>
            // Check whether we saved the state in onSaveInstanceState
<span class="nc bnc" id="L216" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(10501) ? (state == null &amp;&amp; !state.getClass().equals(SavedState.class)) : (state == null || !state.getClass().equals(SavedState.class)))) {</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(10502)) {</span>
                    // Didn't save the state, so call superclass
<span class="nc" id="L219">                    super.onRestoreInstanceState(state);</span>
                }
<span class="nc" id="L221">                return;</span>
            }
        }
        // Cast state to custom BaseSavedState and pass to superclass
<span class="nc" id="L225">        SavedState myState = (SavedState) state;</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10504)) {</span>
<span class="nc" id="L227">            super.onRestoreInstanceState(myState.getSuperState());</span>
        }
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(10505)) {</span>
            // Set this Preference to reflect the restored state
<span class="nc" id="L231">            setValue(myState.value);</span>
        }
<span class="nc" id="L233">    }</span>

    /**
     * Used to handle onSaveInstanceState()/onRestoreInstanceState properly, based on example
     * at http://developer.android.com/guide/topics/ui/settings.html
     */
    private static class SavedState extends Preference.BaseSavedState {

        // Member that holds the setting's value
        boolean value;

        public SavedState(Parcelable superState) {
<span class="nc" id="L245">            super(superState);</span>
<span class="nc" id="L246">        }</span>

        public SavedState(Parcel source) {
<span class="nc" id="L249">            super(source);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10506)) {</span>
                // Get the current preference's value
<span class="nc bnc" id="L252" title="All 2 branches missed.">                value = source.readByte() != 0;</span>
            }
<span class="nc" id="L254">        }</span>

        @Override
        public void writeToParcel(Parcel dest, int flags) {
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10507)) {</span>
<span class="nc" id="L259">                super.writeToParcel(dest, flags);</span>
            }
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(10508)) {</span>
                // Write the preference's value
<span class="nc bnc" id="L263" title="All 2 branches missed.">                dest.writeByte((byte) (value ? 1 : 0));</span>
            }
<span class="nc" id="L265">        }</span>

        // Standard creator object using an instance of this class
<span class="nc" id="L268">        public static final Parcelable.Creator&lt;SavedState&gt; CREATOR = new Parcelable.Creator&lt;SavedState&gt;() {</span>

            public SavedState createFromParcel(Parcel in) {
<span class="nc" id="L271">                return new SavedState(in);</span>
            }

            public SavedState[] newArray(int size) {
<span class="nc" id="L275">                return new SavedState[size];</span>
            }
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>