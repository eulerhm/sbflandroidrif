<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExperimentalRegionsPreference.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.region</a> &gt; <span class="el_source">ExperimentalRegionsPreference.java</span></div><h1>ExperimentalRegionsPreference.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2013 University of South Florida (sjbarbeau@gmail.com).
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.region;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.util.PreferenceUtils;

import android.app.AlertDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.res.TypedArray;
import android.os.Parcel;
import android.os.Parcelable;
import android.preference.CheckBoxPreference;
import android.preference.Preference;
import android.util.AttributeSet;

/**
 * Custom preference to handle enabling and disabling experimental
 * (i.e., non-production) OBA regions
 * &lt;p/&gt;
 * Code for saving/restoring state based on example at:
 * http://developer.android.com/guide/topics/ui/settings.html
 * &lt;p/&gt;
 * and Android internal YesNoPreference:
 * https://github.com/android/platform_frameworks_base/blob/master/core/java/com/android/internal/preference/YesNoPreference.java
 *
 * @author Sean Barbeau
 */
public class ExperimentalRegionsPreference extends CheckBoxPreference {

    private boolean mCurrentValue;

<span class="nc" id="L48">    private final boolean DEFAULT_VALUE = false;</span>

    //
    // Needed constructors.
    //
    public ExperimentalRegionsPreference(Context context) {
<span class="nc" id="L54">        super(context);</span>
<span class="nc" id="L55">        initCheckedState();</span>
<span class="nc" id="L56">    }</span>

    public ExperimentalRegionsPreference(Context context, AttributeSet attrs) {
<span class="nc" id="L59">        super(context, attrs);</span>
<span class="nc" id="L60">        initCheckedState();</span>
<span class="nc" id="L61">    }</span>

    public ExperimentalRegionsPreference(Context context, AttributeSet attrs, int defStyle) {
<span class="nc" id="L64">        super(context, attrs, defStyle);</span>
<span class="nc" id="L65">        initCheckedState();</span>
<span class="nc" id="L66">    }</span>

    protected void initCheckedState() {
<span class="nc" id="L69">        setChecked(Application.getPrefs()</span>
<span class="nc" id="L70">                .getBoolean(getContext().getString(R.string.preference_key_experimental_regions),</span>
                        DEFAULT_VALUE));
<span class="nc" id="L72">    }</span>

    @Override
    public boolean isPersistent() {
<span class="nc" id="L76">        return true;</span>
    }

    @Override
    protected void onClick() {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (!isChecked()) {</span>
            /*
            Warn the user before enabling, since experimental regions
            may not have real-time info or may be unavailable.
            */
<span class="nc" id="L86">            AlertDialog dialog = new AlertDialog.Builder(getContext())</span>
<span class="nc" id="L87">                    .setMessage(R.string.preferences_experimental_regions_enable_warning)</span>
<span class="nc" id="L88">                    .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {</span>
                        @Override
                        public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L91">                            dialog.dismiss();</span>
<span class="nc" id="L92">                            setValue(true);</span>
<span class="nc" id="L93">                        }</span>
                    })
<span class="nc" id="L95">                    .setNegativeButton(android.R.string.cancel,</span>
<span class="nc" id="L96">                            new DialogInterface.OnClickListener() {</span>
                                @Override
                                public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L99">                                    dialog.dismiss();</span>
<span class="nc" id="L100">                                }</span>
                            }
                    )
<span class="nc" id="L103">                    .create();</span>
<span class="nc" id="L104">            dialog.show();</span>
<span class="nc" id="L105">        } else {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (Application.get().getCurrentRegion() != null &amp;&amp;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                    Application.get().getCurrentRegion().getExperimental()) {</span>
                // If the user is currently using an experimental region, warn that it won't be available
<span class="nc" id="L109">                AlertDialog dialog = new AlertDialog.Builder(getContext())</span>
<span class="nc" id="L110">                        .setMessage(R.string.preferences_experimental_regions_disable_warning)</span>
<span class="nc" id="L111">                        .setPositiveButton(android.R.string.ok,</span>
<span class="nc" id="L112">                                new DialogInterface.OnClickListener() {</span>
                                    @Override
                                    public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L115">                                        dialog.dismiss();</span>
                                        // Set the region info to null, so we no longer use the current experimental region
<span class="nc" id="L117">                                        Application.get().setCurrentRegion(null);</span>
<span class="nc" id="L118">                                        setValue(false);</span>
<span class="nc" id="L119">                                    }</span>
                                }
                        )
<span class="nc" id="L122">                        .setNegativeButton(android.R.string.cancel,</span>
<span class="nc" id="L123">                                new DialogInterface.OnClickListener() {</span>
                                    @Override
                                    public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L126">                                        dialog.dismiss();</span>
<span class="nc" id="L127">                                    }</span>
                                }
                        )
<span class="nc" id="L130">                        .create();</span>
<span class="nc" id="L131">                dialog.show();</span>
<span class="nc" id="L132">            } else {</span>
<span class="nc" id="L133">                setValue(false);</span>
            }
        }
<span class="nc" id="L136">    }</span>

    /**
     * Sets the experimental regions preference (both user interface and shared preference value)
     * to
     * the input value
     *
     * @param newValue true if the preference should be set to true, false if it should be set to
     *                 false
     */
    public void setValue(boolean newValue) {
<span class="nc" id="L147">        mCurrentValue = newValue;</span>
<span class="nc" id="L148">        setChecked(newValue);</span>
<span class="nc" id="L149">        PreferenceUtils</span>
<span class="nc" id="L150">                .saveBoolean(getContext().getString(R.string.preference_key_experimental_regions),</span>
                        newValue);
<span class="nc" id="L152">    }</span>

    @Override
    protected void onSetInitialValue(boolean restorePersistedValue, Object defaultValue) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (restorePersistedValue) {</span>
            // Restore existing state
<span class="nc" id="L158">            mCurrentValue = this.getPersistedBoolean(mCurrentValue);</span>
        } else {
            // Set default state from the XML attribute
<span class="nc" id="L161">            mCurrentValue = (Boolean) defaultValue;</span>
<span class="nc" id="L162">            persistBoolean(mCurrentValue);</span>
        }
<span class="nc" id="L164">    }</span>

    @Override
    protected Object onGetDefaultValue(TypedArray a, int index) {
<span class="nc" id="L168">        return a.getBoolean(index, DEFAULT_VALUE);</span>
    }

    @Override
    protected Parcelable onSaveInstanceState() {
<span class="nc" id="L173">        final Parcelable superState = super.onSaveInstanceState();</span>

        // Create instance of custom BaseSavedState
<span class="nc" id="L176">        final SavedState myState = new SavedState(superState);</span>
        // Set the state's value with the class member that holds current setting value
<span class="nc" id="L178">        myState.value = mCurrentValue;</span>
<span class="nc" id="L179">        return myState;</span>
    }

    @Override
    protected void onRestoreInstanceState(Parcelable state) {
        // Check whether we saved the state in onSaveInstanceState
<span class="nc bnc" id="L185" title="All 4 branches missed.">        if (state == null || !state.getClass().equals(SavedState.class)) {</span>
            // Didn't save the state, so call superclass
<span class="nc" id="L187">            super.onRestoreInstanceState(state);</span>
<span class="nc" id="L188">            return;</span>
        }

        // Cast state to custom BaseSavedState and pass to superclass
<span class="nc" id="L192">        SavedState myState = (SavedState) state;</span>
<span class="nc" id="L193">        super.onRestoreInstanceState(myState.getSuperState());</span>

        // Set this Preference to reflect the restored state
<span class="nc" id="L196">        setValue(myState.value);</span>
<span class="nc" id="L197">    }</span>

    /**
     * Used to handle onSaveInstanceState()/onRestoreInstanceState properly, based on example
     * at http://developer.android.com/guide/topics/ui/settings.html
     */
    private static class SavedState extends Preference.BaseSavedState {

        // Member that holds the setting's value
        boolean value;

        public SavedState(Parcelable superState) {
<span class="nc" id="L209">            super(superState);</span>
<span class="nc" id="L210">        }</span>

        public SavedState(Parcel source) {
<span class="nc" id="L213">            super(source);</span>
            // Get the current preference's value
<span class="nc bnc" id="L215" title="All 2 branches missed.">            value = source.readByte() != 0;</span>
<span class="nc" id="L216">        }</span>

        @Override
        public void writeToParcel(Parcel dest, int flags) {
<span class="nc" id="L220">            super.writeToParcel(dest, flags);</span>
            // Write the preference's value
<span class="nc bnc" id="L222" title="All 2 branches missed.">            dest.writeByte((byte) (value ? 1 : 0));</span>
<span class="nc" id="L223">        }</span>

        // Standard creator object using an instance of this class
<span class="nc" id="L226">        public static final Parcelable.Creator&lt;SavedState&gt; CREATOR =</span>
<span class="nc" id="L227">                new Parcelable.Creator&lt;SavedState&gt;() {</span>

                    public SavedState createFromParcel(Parcel in) {
<span class="nc" id="L230">                        return new SavedState(in);</span>
                    }

                    public SavedState[] newArray(int size) {
<span class="nc" id="L234">                        return new SavedState[size];</span>
                    }
                };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>