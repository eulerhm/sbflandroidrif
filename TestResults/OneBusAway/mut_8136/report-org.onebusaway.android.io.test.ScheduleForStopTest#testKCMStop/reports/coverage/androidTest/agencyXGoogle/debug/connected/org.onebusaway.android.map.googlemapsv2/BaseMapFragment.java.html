<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseMapFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.map.googlemapsv2</a> &gt; <span class="el_source">BaseMapFragment.java</span></div><h1>BaseMapFragment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011-2014 Paul Watts (paulcwatts@gmail.com),
 * University of South Florida (sjbarbeau@gmail.com), and individual contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.map.googlemapsv2;

import static org.onebusaway.android.util.PermissionUtils.LOCATION_PERMISSIONS;
import static org.onebusaway.android.util.PermissionUtils.LOCATION_PERMISSION_REQUEST;
import static org.onebusaway.android.util.UIUtils.canManageDialog;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.app.Dialog;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.content.res.Configuration;
import android.graphics.drawable.Drawable;
import android.location.Location;
import android.os.Bundle;
import android.os.Handler;
import android.provider.Settings;
import android.text.TextUtils;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.CheckBox;
import android.widget.Toast;

import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatDelegate;
import androidx.core.graphics.drawable.DrawableCompat;
import androidx.fragment.app.DialogFragment;

import com.google.android.gms.common.api.GoogleApiClient;
import com.google.android.gms.maps.CameraUpdateFactory;
import com.google.android.gms.maps.GoogleMap;
import com.google.android.gms.maps.LocationSource;
import com.google.android.gms.maps.OnMapReadyCallback;
import com.google.android.gms.maps.SupportMapFragment;
import com.google.android.gms.maps.UiSettings;
import com.google.android.gms.maps.model.CameraPosition;
import com.google.android.gms.maps.model.LatLng;
import com.google.android.gms.maps.model.LatLngBounds;
import com.google.android.gms.maps.model.MapStyleOptions;
import com.google.android.gms.maps.model.Marker;
import com.google.android.gms.maps.model.Polyline;
import com.google.android.gms.maps.model.PolylineOptions;
import com.google.android.gms.maps.model.VisibleRegion;
import com.google.firebase.analytics.FirebaseAnalytics;

import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.elements.ObaReferences;
import org.onebusaway.android.io.elements.ObaRegion;
import org.onebusaway.android.io.elements.ObaRoute;
import org.onebusaway.android.io.elements.ObaShape;
import org.onebusaway.android.io.elements.ObaStop;
import org.onebusaway.android.io.request.ObaResponse;
import org.onebusaway.android.io.request.ObaTripsForRouteResponse;
import org.onebusaway.android.map.DirectionsMapController;
import org.onebusaway.android.map.MapModeController;
import org.onebusaway.android.map.MapParams;
import org.onebusaway.android.map.RouteMapController;
import org.onebusaway.android.map.StopMapController;
import org.onebusaway.android.map.bike.BikeshareMapController;
import org.onebusaway.android.map.googlemapsv2.bike.BikeStationOverlay;
import org.onebusaway.android.region.ObaRegionsTask;
import org.onebusaway.android.ui.HomeActivity;
import org.onebusaway.android.ui.LayersSpeedDialAdapter;
import org.onebusaway.android.util.LocationHelper;
import org.onebusaway.android.util.LocationUtils;
import org.onebusaway.android.util.PermissionUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.onebusaway.android.util.UIUtils;
import org.opentripplanner.routing.bike_rental.BikeRentalStation;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.concurrent.TimeUnit;

/**
 * The MapFragment class is split into two basic modes:
 * stop mode and route mode. It needs to be able to switch
 * between the two.
 * &lt;p/&gt;
 * So this class handles the common functionality between
 * the two modes: zooming, the options menu,
 * saving/restoring state, and other minor bookkeeping
 * (the stop user map).
 * &lt;p/&gt;
 * Everything else is handed off to a specific
 * MapFragmentController instance.
 *
 * @author paulw, barbeau
 */
<span class="nc" id="L115">public class BaseMapFragment extends SupportMapFragment</span>
        implements MapModeController.Callback, ObaRegionsTask.Callback,
        MapModeController.ObaMapView,
        LocationSource, LocationHelper.Listener,
        com.google.android.gms.maps.GoogleMap.OnCameraChangeListener,
        StopOverlay.OnFocusChangedListener, OnMapReadyCallback,
        VehicleOverlay.Controller, LayersSpeedDialAdapter.LayerActivationListener {

    public static final String TAG = &quot;BaseMapFragment&quot;;

    private static final int REQUEST_NO_LOCATION = 41;

    //
    // Location Services and Maps API v2 constants
    //
    public static final float CAMERA_DEFAULT_ZOOM = 16.0f;

    public static final float DEFAULT_MAP_PADDING_DP = 20.0f;

    // Keep track of current map padding
<span class="nc" id="L135">    private int mMapPaddingLeft = 0;</span>

<span class="nc" id="L137">    private int mMapPaddingTop = 0;</span>

<span class="nc" id="L139">    private int mMapPaddingRight = 0;</span>

<span class="nc" id="L141">    private int mMapPaddingBottom = 0;</span>

    // Use fully-qualified class name to avoid import statement, because it interferes with scripted
    // copying of Maps API v2 classes between Google/Amazon build flavors (see #254)
    // TODO: We've eliminated Amazon Fire support. Let's reverse this.
    private com.google.android.gms.maps.GoogleMap mMap;

    private String mFocusStopId;

    // The Fragment controls the stop overlay, since that
    // is used by both modes.
    private StopOverlay mStopOverlay;

    private VehicleOverlay mVehicleOverlay;

    private BikeStationOverlay mBikeStationOverlay;

    // We only display the out of range dialog once
<span class="nc" id="L159">    private boolean mWarnOutOfRange = true;</span>

<span class="nc" id="L161">    private boolean mRunning = false;</span>

    private List&lt;MapModeController&gt; mControllers;

<span class="nc" id="L165">    private String mMapMode = &quot;&quot;;</span>

<span class="nc" id="L167">    private ArrayList&lt;Polyline&gt; mLineOverlay = new ArrayList&lt;Polyline&gt;();</span>

    // Markers that are added to the map by classes external to this map package
    private SimpleMarkerOverlay mSimpleMarkerOverlay;

    // We have to convert from LatLng to Location, so hold references to both
    private LatLng mCenter;

    private Location mCenterLocation;

    private OnLocationChangedListener mListener;

    // Listen to map tap events
    OnFocusChangedListener mOnFocusChangedListener;

    // Listen to map loading/progress bar events
    OnProgressBarChangedListener mOnProgressBarChangedListener;

    // Listen to location permission request results
    OnLocationPermissionResultListener mOnLocationPermissionResultListener;

    LocationHelper mLocationHelper;

    Bundle mLastSavedInstanceState;

<span class="nc" id="L192">    private boolean mUserDeniedPermission = false;</span>

    private FirebaseAnalytics mFirebaseAnalytics;

    private AlertDialog locationPermissionDialog;

    @Override
    public void onActivateLayer(LayerInfo layer) {
<span class="nc bnc" id="L200" title="All 2 branches missed.">        switch (layer.getLayerlabel()) {</span>
            case &quot;Bikeshare&quot;: {
<span class="nc bnc" id="L202" title="All 2 branches missed.">                for (MapModeController controller : mControllers) {</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">                    if (controller instanceof BikeshareMapController) {</span>
<span class="nc" id="L204">                        ((BikeshareMapController) controller).showBikes(true);</span>
<span class="nc" id="L205">                        ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L206">                                getString(R.string.analytics_layer_bikeshare),</span>
<span class="nc" id="L207">                                getString(R.string.analytics_label_bikeshare_activated));</span>
                    }
<span class="nc" id="L209">                }</span>
                break;
            }
        }
<span class="nc" id="L213">    }</span>

    @Override
    public void onDeactivateLayer(LayerInfo layer) {
<span class="nc bnc" id="L217" title="All 2 branches missed.">        switch (layer.getLayerlabel()) {</span>
            case &quot;Bikeshare&quot;: {
<span class="nc bnc" id="L219" title="All 2 branches missed.">                for (MapModeController controller : mControllers) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                    if (controller instanceof BikeshareMapController) {</span>
<span class="nc" id="L221">                        ((BikeshareMapController) controller).showBikes(false);</span>
<span class="nc" id="L222">                        ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L223">                                getString(R.string.analytics_layer_bikeshare),</span>
<span class="nc" id="L224">                                getString(R.string.analytics_label_bikeshare_deactivated));</span>
                    }
<span class="nc" id="L226">                }</span>
                break;
            }
        }
<span class="nc" id="L230">    }</span>

    public interface OnFocusChangedListener {

        /**
         * Called when a stop on the map is clicked (i.e., tapped), which sets focus to a stop,
         * or when the user taps on an area away from the map for the first time after a stop
         * is already selected, which removes focus
         *
         * @param stop     the ObaStop that obtained focus, or null if no stop is in focus
         * @param routes   a HashMap of all route display names that serve this stop - key is
         *                 routeId
         * @param location the user touch location on the map
         */
        void onFocusChanged(ObaStop stop, HashMap&lt;String, ObaRoute&gt; routes, Location location);

        void onFocusChanged(BikeRentalStation bikeRentalStation);
    }

    public interface OnProgressBarChangedListener {

        /**
         * Called when the map is loading information.  If showProgressBar is true, then the map is
         * loading information and the progress bar should be shown, but if it's false, then the
         * map
         * is finished loading information and the progress bar should be hidden.
         *
         * @param showProgressBar true if the map is loading information and the progress bar
         *                        should
         *                        be shown, false if the map is finished loading information and
         *                        the
         *                        progress bar should be hidden.
         */
        void onProgressBarChanged(boolean showProgressBar);
    }

    public interface OnLocationPermissionResultListener {

        /**
         * Called when a result has been obtained after requesting user location permission.
         * @param grantResult The grant results for the location permission which is either PackageManager.PERMISSION_GRANTED or PackageManager.PERMISSION_DENIED. Never null.
         */
        void onLocationPermissionResult(int grantResult);
    }

    public static BaseMapFragment newInstance() {
<span class="nc" id="L276">        return new BaseMapFragment();</span>
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
<span class="nc" id="L282">        View v = super.onCreateView(inflater, container, savedInstanceState);</span>

<span class="nc" id="L284">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(getActivity());</span>

<span class="nc" id="L286">        mUserDeniedPermission = PreferenceUtils.userDeniedLocationPermission();</span>

<span class="nc" id="L288">        mLocationHelper = new LocationHelper(getActivity());</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (MapHelpV2.isMapsInstalled(getActivity())) {</span>
            // Save the savedInstanceState
<span class="nc" id="L292">            mLastSavedInstanceState = savedInstanceState;</span>
            // Register for an async callback when the map is ready
<span class="nc" id="L294">            getMapAsync(this);</span>
        } else {
<span class="nc" id="L296">            MapHelpV2.promptUserInstallMaps(getActivity());</span>
        }

        // If we have a recent location, show this while we're waiting on the LocationHelper
<span class="nc" id="L300">        Location l = Application</span>
<span class="nc" id="L301">                .getLastKnownLocation(getActivity(), mLocationHelper.getGoogleApiClient());</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (l != null) {</span>
<span class="nc" id="L303">            final long TIME_THRESHOLD = TimeUnit.MINUTES.toMillis(5);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            if (System.currentTimeMillis() - l.getTime() &lt; TIME_THRESHOLD) {</span>
<span class="nc" id="L305">                onLocationChanged(l);</span>
            }
        }

<span class="nc" id="L309">        return v;</span>
    }

    public void zoomIn() {
<span class="nc" id="L313">        mMap.animateCamera(CameraUpdateFactory.zoomIn());</span>
<span class="nc" id="L314">    }</span>

    public void zoomOut() {
<span class="nc" id="L317">        mMap.animateCamera(CameraUpdateFactory.zoomOut());</span>
<span class="nc" id="L318">    }</span>

    @Override
    public void onMapReady(com.google.android.gms.maps.GoogleMap map) {
<span class="nc" id="L322">        mMap = map;</span>

<span class="nc" id="L324">        MapClickListeners mapClickListeners = new MapClickListeners();</span>

<span class="nc" id="L326">        mMap.setOnMarkerClickListener(mapClickListeners);</span>
<span class="nc" id="L327">        mMap.setOnMapClickListener(mapClickListeners);</span>

        if (
<span class="nc bnc" id="L330" title="All 2 branches missed.">                AppCompatDelegate.getDefaultNightMode() == AppCompatDelegate.MODE_NIGHT_YES || (</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                        AppCompatDelegate.getDefaultNightMode() != AppCompatDelegate.MODE_NIGHT_NO &amp;&amp;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                                (getResources().getConfiguration().uiMode &amp; Configuration.UI_MODE_NIGHT_MASK) == Configuration.UI_MODE_NIGHT_YES</span>
                )
        ) {
<span class="nc" id="L335">            mMap.setMapStyle(MapStyleOptions.loadRawResourceStyle(getContext(), R.raw.dark_map));</span>
        }

<span class="nc" id="L338">        initMap(mLastSavedInstanceState);</span>
<span class="nc" id="L339">    }</span>

    private void initMap(Bundle savedInstanceState) {
<span class="nc" id="L342">        UiSettings uiSettings = mMap.getUiSettings();</span>
<span class="nc" id="L343">        mUserDeniedPermission = PreferenceUtils.userDeniedLocationPermission();</span>

<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (!mUserDeniedPermission) {</span>
<span class="nc" id="L346">            requestPermissionAndInit(getActivity());</span>
        }

        // Set location source
<span class="nc" id="L350">        mMap.setLocationSource(this);</span>
        // Listener for camera changes
<span class="nc" id="L352">        mMap.setOnCameraChangeListener(this);</span>
        // Hide MyLocation button on map, since we have our own button
<span class="nc" id="L354">        uiSettings.setMyLocationButtonEnabled(false);</span>
        // Hide Toolbar
<span class="nc" id="L356">        uiSettings.setMapToolbarEnabled(false);</span>
        // Instantiate class that holds generic markers to be added by outside classes
<span class="nc" id="L358">        mSimpleMarkerOverlay = new SimpleMarkerOverlay(mMap);</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L361">            initMapState(savedInstanceState);</span>
        } else {
<span class="nc" id="L363">            Bundle args = getActivity().getIntent().getExtras();</span>
            // The rest of this code assumes a bundle exists, even if it's empty
<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (args == null) {</span>
<span class="nc" id="L366">                args = new Bundle();</span>
            }
<span class="nc" id="L368">            double lat = args.getDouble(MapParams.CENTER_LAT, 0.0d);</span>
<span class="nc" id="L369">            double lon = args.getDouble(MapParams.CENTER_LON, 0.0d);</span>
<span class="nc bnc" id="L370" title="All 4 branches missed.">            if (lat == 0.0d &amp;&amp; lon == 0.0d) {</span>
                // Try to restore the latest map view location
<span class="nc" id="L372">                PreferenceUtils.maybeRestoreMapViewToBundle(args);</span>
            }
<span class="nc" id="L374">            initMapState(args);</span>
        }
<span class="nc" id="L376">    }</span>

    private void initMapState(Bundle args) {
<span class="nc" id="L379">        mFocusStopId = args.getString(MapParams.STOP_ID);</span>

<span class="nc" id="L381">        mMapPaddingLeft = args.getInt(MapParams.MAP_PADDING_LEFT, MapParams.DEFAULT_MAP_PADDING);</span>
<span class="nc" id="L382">        mMapPaddingTop = args.getInt(MapParams.MAP_PADDING_TOP, MapParams.DEFAULT_MAP_PADDING);</span>
<span class="nc" id="L383">        mMapPaddingRight = args.getInt(MapParams.MAP_PADDING_RIGHT, MapParams.DEFAULT_MAP_PADDING);</span>

<span class="nc" id="L385">        mMapPaddingBottom = args</span>
<span class="nc" id="L386">                .getInt(MapParams.MAP_PADDING_BOTTOM, MapParams.DEFAULT_MAP_PADDING);</span>
<span class="nc" id="L387">        setPadding(mMapPaddingLeft, mMapPaddingTop, mMapPaddingRight, mMapPaddingBottom);</span>

<span class="nc" id="L389">        String mode = args.getString(MapParams.MODE);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (mode == null) {</span>
<span class="nc" id="L391">            mode = MapParams.MODE_STOP;</span>
        }
<span class="nc" id="L393">        setMapMode(mode, args);</span>
<span class="nc" id="L394">    }</span>

    @SuppressLint(&quot;MissingPermission&quot;)
    private void requestPermissionAndInit(final Activity activity) {
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (PermissionUtils.hasGrantedAtLeastOnePermission(activity, LOCATION_PERMISSIONS)) {</span>
            // Show the location on the map
<span class="nc" id="L400">            mMap.setMyLocationEnabled(true);</span>
            // Make sure location helper is registered
<span class="nc" id="L402">            mLocationHelper.registerListener(this);</span>
        } else {
            // Explain permission to user
<span class="nc" id="L405">            showLocationPermissionDialog();</span>
        }
<span class="nc" id="L407">    }</span>

    @SuppressLint(&quot;MissingPermission&quot;)
    @Override
    public void onRequestPermissionsResult(
            int requestCode, String[] permissions, int[] grantResults) {
<span class="nc" id="L413">        int result = PackageManager.PERMISSION_DENIED;</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">        if (requestCode == LOCATION_PERMISSION_REQUEST) {</span>
<span class="nc bnc" id="L415" title="All 4 branches missed.">            if (grantResults.length &gt; 0 &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc" id="L416">                mUserDeniedPermission = false;</span>
                // Show the location on the map
<span class="nc" id="L418">                mMap.setMyLocationEnabled(true);</span>
                // Make sure location helper is registered
<span class="nc" id="L420">                mLocationHelper.registerListener(this);</span>
<span class="nc" id="L421">                result = PackageManager.PERMISSION_GRANTED;</span>
            } else {
<span class="nc" id="L423">                mUserDeniedPermission = true;</span>
            }
<span class="nc bnc" id="L425" title="All 2 branches missed.">        } else if (HomeActivity.BATTERY_OPTIMIZATIONS_PERMISSION_REQUEST == requestCode) {</span>
<span class="nc bnc" id="L426" title="All 4 branches missed.">            if (grantResults.length &gt; 0 &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc" id="L427">                UIUtils.openBatteryIgnoreIntent(getActivity());</span>
            }
        }

<span class="nc bnc" id="L431" title="All 4 branches missed.">        if (requestCode == LOCATION_PERMISSION_REQUEST &amp;&amp; mOnLocationPermissionResultListener != null) {</span>
<span class="nc" id="L432">            mOnLocationPermissionResultListener.onLocationPermissionResult(result);</span>
        }
<span class="nc" id="L434">    }</span>

    @Override
    public void onDestroy() {
<span class="nc" id="L438">        mLocationHelper.unregisterListener(this);</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L441">                controller.destroy();</span>
<span class="nc" id="L442">            }</span>
        }
<span class="nc" id="L444">        super.onDestroy();</span>
<span class="nc" id="L445">    }</span>

    @Override
    public void onPause() {
<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (mLocationHelper != null) {</span>
<span class="nc" id="L450">            mLocationHelper.onPause();</span>
        }
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L454">                controller.onPause();</span>
<span class="nc" id="L455">            }</span>
        }

<span class="nc" id="L458">        Location center = getMapCenterAsLocation();</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (center != null) {</span>
<span class="nc" id="L460">            PreferenceUtils.saveMapViewToPreferences(center.getLatitude(), center.getLongitude(),</span>
<span class="nc" id="L461">                    getZoomLevelAsFloat());</span>
        }

<span class="nc" id="L464">        mRunning = false;</span>
<span class="nc" id="L465">        super.onPause();</span>
<span class="nc" id="L466">    }</span>

    /**
     * This is called when fm.beginTransaction().hide() or fm.beginTransaction().show() is called
     *
     * @param hidden True if the fragment is now hidden, false if it is not visible.
     */
    @Override
    public void onHiddenChanged(boolean hidden) {
<span class="nc bnc" id="L475" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L477">                controller.onHidden(hidden);</span>
<span class="nc" id="L478">            }</span>
        }
<span class="nc" id="L480">        super.onHiddenChanged(hidden);</span>
<span class="nc" id="L481">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L485">        mUserDeniedPermission = PreferenceUtils.userDeniedLocationPermission();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (mLocationHelper != null) {</span>
<span class="nc" id="L487">            mLocationHelper.onResume();</span>
        }
<span class="nc" id="L489">        mRunning = true;</span>

<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L493">                controller.onResume();</span>
<span class="nc" id="L494">                controller.notifyMapChanged();</span>
<span class="nc" id="L495">            }</span>
        }

<span class="nc" id="L498">        super.onResume();</span>
<span class="nc" id="L499">    }</span>

    @Override
    public void onSaveInstanceState(Bundle outState) {
<span class="nc bnc" id="L503" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L505">                controller.onSaveInstanceState(outState);</span>
<span class="nc" id="L506">            }</span>
        }
<span class="nc" id="L508">        outState.putString(MapParams.MODE, getMapMode());</span>
<span class="nc" id="L509">        outState.putString(MapParams.STOP_ID, mFocusStopId);</span>
<span class="nc" id="L510">        Location center = getMapCenterAsLocation();</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc" id="L512">            outState.putDouble(MapParams.CENTER_LAT, center.getLatitude());</span>
<span class="nc" id="L513">            outState.putDouble(MapParams.CENTER_LON, center.getLongitude());</span>
<span class="nc" id="L514">            outState.putFloat(MapParams.ZOOM, getZoomLevelAsFloat());</span>
        }
<span class="nc" id="L516">        outState.putInt(MapParams.MAP_PADDING_LEFT, mMapPaddingLeft);</span>
<span class="nc" id="L517">        outState.putInt(MapParams.MAP_PADDING_TOP, mMapPaddingTop);</span>
<span class="nc" id="L518">        outState.putInt(MapParams.MAP_PADDING_RIGHT, mMapPaddingRight);</span>
<span class="nc" id="L519">        outState.putInt(MapParams.MAP_PADDING_BOTTOM, mMapPaddingBottom);</span>
<span class="nc" id="L520">    }</span>

    @Override
    public void onViewStateRestored(Bundle savedInstanceState) {
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L526">                controller.onViewStateRestored(savedInstanceState);</span>
<span class="nc" id="L527">            }</span>
        }
<span class="nc" id="L529">        super.onViewStateRestored(savedInstanceState);</span>
<span class="nc" id="L530">    }</span>

    public boolean isRouteDisplayed() {
<span class="nc" id="L533">        return MapParams.MODE_ROUTE.equals(mMapMode);</span>
    }

    /**
     * Initialize the Stop Overlay
     *
     * @return true if the overlay was successfully initialized, false if it was not
     */
    public boolean setupStopOverlay() {
<span class="nc bnc" id="L542" title="All 2 branches missed.">        if (mStopOverlay != null) {</span>
            // Overlay was previously initialized and can be used
<span class="nc" id="L544">            return true;</span>
        }
<span class="nc bnc" id="L546" title="All 2 branches missed.">        if (mMap == null) {</span>
            // We need a map reference to initialize the overlay
<span class="nc" id="L548">            return false;</span>
        }
<span class="nc" id="L550">        mStopOverlay = new StopOverlay(getActivity(), mMap);</span>
<span class="nc" id="L551">        mStopOverlay.setOnFocusChangeListener(this);</span>
<span class="nc" id="L552">        return true;</span>
    }

    public void setupVehicleOverlay() {
<span class="nc" id="L556">        Activity a = getActivity();</span>
<span class="nc bnc" id="L557" title="All 4 branches missed.">        if (mVehicleOverlay == null &amp;&amp; a != null) {</span>
<span class="nc" id="L558">            mVehicleOverlay = new VehicleOverlay(a, mMap);</span>
<span class="nc" id="L559">            mVehicleOverlay.setController(this);</span>
        }
<span class="nc" id="L561">    }</span>

    public void setupBikeStationOverlay(boolean isInDirectionsMode) {
<span class="nc" id="L564">        Activity activity = getActivity();</span>
<span class="nc bnc" id="L565" title="All 4 branches missed.">        if (mBikeStationOverlay == null &amp;&amp; activity != null) {</span>
<span class="nc" id="L566">            mBikeStationOverlay = new BikeStationOverlay(activity, mMap, isInDirectionsMode);</span>
<span class="nc" id="L567">            mBikeStationOverlay.setOnFocusChangeListener(mOnFocusChangedListener);</span>
        }
<span class="nc" id="L569">    }</span>

    protected void showDialog(int id) {
<span class="nc" id="L572">        MapDialogFragment.newInstance(id, this).show(getFragmentManager(), MapDialogFragment.TAG);</span>
<span class="nc" id="L573">    }</span>

    //
    // Fragment Controller
    //
    @Override
    public String getMapMode() {
<span class="nc bnc" id="L580" title="All 2 branches missed.">        if (!&quot;&quot;.equals(mMapMode)) {</span>
<span class="nc" id="L581">            return mMapMode;</span>
        }
<span class="nc" id="L583">        return null;</span>
    }

    @Override
    public void setMapMode(String mode, Bundle args) {
<span class="nc" id="L588">        String oldMode = getMapMode();</span>
<span class="nc bnc" id="L589" title="All 4 branches missed.">        if (oldMode != null &amp;&amp; oldMode.equals(mode)) {</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L591">                controller.setState(args);</span>
<span class="nc" id="L592">            }</span>
<span class="nc" id="L593">            return;</span>
        }
<span class="nc bnc" id="L595" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L597">                controller.destroy();</span>
<span class="nc" id="L598">            }</span>
<span class="nc" id="L599">            mControllers.clear();</span>
        } else {
<span class="nc" id="L601">            mControllers = new ArrayList&lt;&gt;();</span>
        }
<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (mStopOverlay != null) {</span>
<span class="nc" id="L604">            mStopOverlay.clear(false);</span>
        }
<span class="nc" id="L606">        BikeshareMapController bikeshareMapController = new BikeshareMapController(this);</span>
<span class="nc" id="L607">        setupBikeStationOverlay(MapParams.MODE_DIRECTIONS.equals(mode));</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (MapParams.MODE_ROUTE.equals(mode)) {</span>
<span class="nc" id="L609">            RouteMapController controller = new RouteMapController(this);</span>
<span class="nc" id="L610">            mControllers.add(controller);</span>
<span class="nc" id="L611">            bikeshareMapController.setMode(controller.getMode());</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">        } else if (MapParams.MODE_STOP.equals(mode)) {</span>
<span class="nc" id="L613">            StopMapController controller = new StopMapController(this);</span>
<span class="nc" id="L614">            mControllers.add(controller);</span>
<span class="nc" id="L615">            bikeshareMapController.setMode(controller.getMode());</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">        } else if (MapParams.MODE_DIRECTIONS.equals(mode)) {</span>
<span class="nc" id="L617">            DirectionsMapController controller = new DirectionsMapController(this);</span>
<span class="nc" id="L618">            mControllers.add(controller);</span>
<span class="nc" id="L619">            bikeshareMapController.setMode(controller.getMode());</span>
        }
<span class="nc" id="L621">        mControllers.add(bikeshareMapController);</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L623">            controller.setState(args);</span>
<span class="nc" id="L624">            controller.onResume();</span>
<span class="nc" id="L625">        }</span>
<span class="nc" id="L626">        mMapMode = mode;</span>
<span class="nc" id="L627">    }</span>

    @Override
    public MapModeController.ObaMapView getMapView() {
        // We implement the ObaMapView interface too (since we're using MapFragment)
<span class="nc" id="L632">        return this;</span>
    }

    /**
     * Adds a generic marker to the map and returns the ID associated with that marker, which can
     * be used to remove the marker via removeMarker()
     *
     * @param location Location at which the marker should be added
     * @param hue      The hue (color) of the marker. Value must be greater or equal to 0 and less than 360, or null if the default color should be used.
     * @return the ID associated with the marker that was just added, or -1 if the addition failed
     */
    @Override
    public int addMarker(Location location, Float hue) {
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (mSimpleMarkerOverlay == null) {</span>
<span class="nc" id="L646">            return -1;</span>
        }
<span class="nc" id="L648">        return mSimpleMarkerOverlay.addMarker(location, hue);</span>
    }

    /**
     * Removes the marker from the map that has the given ID, which was previously generated by
     * addMarker() in this class
     *
     * @param markerId the ID for the marker that should be removed from the map
     */
    @Override
    public void removeMarker(int markerId) {
<span class="nc bnc" id="L659" title="All 2 branches missed.">        if (mSimpleMarkerOverlay == null) {</span>
<span class="nc" id="L660">            return;</span>
        }
<span class="nc" id="L662">        mSimpleMarkerOverlay.removeMarker(markerId);</span>
<span class="nc" id="L663">    }</span>

    /**
     * Define a visible region on the map, to signal to the map that portions of the map around
     * the edges may be obscured, by setting padding on each of the four edges of the map.
     *
     * @param left   the number of pixels of padding to be added on the left of the map, or null
     *               if the existing padding should be used
     * @param top    the number of pixels of padding to be added on the top of the map, or null
     *               if the existing padding should be used
     * @param right  the number of pixels of padding to be added on the right of the map, or null
     *               if the existing padding should be used
     * @param bottom the number of pixels of padding to be added on the bottom of the map, or null
     *               if the existing padding should be used
     */
    @Override
    public void setPadding(Integer left, Integer top, Integer right, Integer bottom) {

<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (left != null) {</span>
<span class="nc" id="L682">            mMapPaddingLeft = left;</span>
        }
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (top != null) {</span>
<span class="nc" id="L685">            mMapPaddingTop = top;</span>
        }
<span class="nc bnc" id="L687" title="All 2 branches missed.">        if (right != null) {</span>
<span class="nc" id="L688">            mMapPaddingRight = right;</span>
        }
<span class="nc bnc" id="L690" title="All 2 branches missed.">        if (bottom != null) {</span>
<span class="nc" id="L691">            mMapPaddingBottom = bottom;</span>
        }

<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc" id="L695">            mMap.setPadding(mMapPaddingLeft, mMapPaddingTop, mMapPaddingRight, mMapPaddingBottom);</span>
        }
<span class="nc" id="L697">    }</span>

    @Override
    public void showProgress(boolean show) {
<span class="nc bnc" id="L701" title="All 2 branches missed.">        if (mOnProgressBarChangedListener != null) {</span>
<span class="nc" id="L702">            mOnProgressBarChangedListener.onProgressBarChanged(show);</span>
        }
<span class="nc" id="L704">    }</span>

    @Override
    public void showStops(List&lt;ObaStop&gt; stops, ObaReferences refs) {
        // Make sure that the stop overlay has been successfully initialized
<span class="nc bnc" id="L709" title="All 4 branches missed.">        if (setupStopOverlay() &amp;&amp; stops != null) {</span>
<span class="nc" id="L710">            mStopOverlay.populateStops(stops, refs);</span>
        }
<span class="nc" id="L712">    }</span>

    @Override
    public void showBikeStations(List&lt;BikeRentalStation&gt; bikeStations) {
<span class="nc" id="L716">        setupBikeStationOverlay(MapParams.MODE_DIRECTIONS.equals(mMapMode));</span>
<span class="nc" id="L717">        mBikeStationOverlay.addBikeStations(bikeStations);</span>
<span class="nc" id="L718">    }</span>

    @Override
    public void clearBikeStations() {
<span class="nc bnc" id="L722" title="All 2 branches missed.">        if (mBikeStationOverlay != null) {</span>
<span class="nc" id="L723">            mBikeStationOverlay.clearBikeStations();</span>
        }
<span class="nc" id="L725">    }</span>

    @Override
    public void notifyOutOfRange() {
        //Before we trigger the out of range warning, make sure we have region info
        //or have a API URL that was custom set by the user in via Preferences
        //Otherwise, its premature since we don't know the device's relationship to
        //available OBA regions or the manually set API region
<span class="nc" id="L733">        String serverName = Application.get().getCustomApiUrl();</span>
<span class="nc bnc" id="L734" title="All 4 branches missed.">        if (mWarnOutOfRange &amp;&amp; (Application.get().getCurrentRegion() != null || !TextUtils</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                .isEmpty(serverName))) {</span>
<span class="nc bnc" id="L736" title="All 4 branches missed.">            if (mRunning &amp;&amp; canManageDialog(getActivity())) {</span>
<span class="nc" id="L737">                showDialog(MapDialogFragment.OUTOFRANGE_DIALOG);</span>
            }
        }
<span class="nc" id="L740">    }</span>

    //
    // Region Task Callback
    //
    @Override
    public void onRegionTaskFinished(boolean currentRegionChanged) {
<span class="nc bnc" id="L747" title="All 2 branches missed.">        if (!isAdded()) {</span>
            // Too early or late in the Fragment lifecycle to take any action
<span class="nc" id="L749">            return;</span>
        }

<span class="nc" id="L752">        Location l = Application</span>
<span class="nc" id="L753">                .getLastKnownLocation(getActivity(), mLocationHelper.getGoogleApiClient());</span>
        // If the region changed, and we don't have a location or the map center is still (0,0),
        // then zoom to the region (or location if we have it)
<span class="nc" id="L756">        Location mapCenter = getMapCenterAsLocation();</span>
<span class="nc bnc" id="L757" title="All 6 branches missed.">        if (currentRegionChanged &amp;&amp;</span>
                (l == null ||
<span class="nc bnc" id="L759" title="All 2 branches missed.">                        (mapCenter != null &amp;&amp; mapCenter.getLatitude() == 0.0 &amp;&amp;</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">                                mapCenter.getLongitude() == 0.0))) {</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">            if (l != null) {</span>
<span class="nc" id="L762">                setMyLocation(true, false);</span>
            } else {
<span class="nc" id="L764">                zoomToRegion();</span>
            }
        }
<span class="nc" id="L767">    }</span>

    public void setOnFocusChangeListener(OnFocusChangedListener onFocusChangedListener) {
<span class="nc" id="L770">        mOnFocusChangedListener = onFocusChangedListener;</span>
<span class="nc" id="L771">    }</span>

    public void setOnProgressBarChangedListener(
            OnProgressBarChangedListener onProgressBarChangedListener) {
<span class="nc" id="L775">        mOnProgressBarChangedListener = onProgressBarChangedListener;</span>
<span class="nc" id="L776">    }</span>

    public void setOnLocationPermissionResultListener(OnLocationPermissionResultListener onLocationPermissionResultListener) {
<span class="nc" id="L779">        mOnLocationPermissionResultListener = onLocationPermissionResultListener;</span>
<span class="nc" id="L780">    }</span>

    //
    // Stop changed handler
    //
<span class="nc" id="L785">    final Handler mStopChangedHandler = new Handler();</span>

    public void onFocusChanged(final ObaStop stop, final HashMap&lt;String, ObaRoute&gt; routes,
                               final Location location) {
        // Run in a separate thread, to avoid blocking UI for long running events
<span class="nc" id="L790">        mStopChangedHandler.post(new Runnable() {</span>
            public void run() {
<span class="nc bnc" id="L792" title="All 2 branches missed.">                if (stop != null) {</span>
<span class="nc" id="L793">                    mFocusStopId = stop.getId();</span>
                    //Log.d(TAG, &quot;Focused changed to &quot; + stop.getName());
                } else {
<span class="nc" id="L796">                    mFocusStopId = null;</span>
                    //Log.d(TAG, &quot;Removed focus&quot;);
                }

                // Pass overlay focus event up to listeners for this fragment
<span class="nc bnc" id="L801" title="All 2 branches missed.">                if (mOnFocusChangedListener != null) {</span>
<span class="nc" id="L802">                    mOnFocusChangedListener.onFocusChanged(stop, routes, location);</span>
                }
<span class="nc" id="L804">            }</span>
        });
<span class="nc" id="L806">    }</span>

    /**
     * Sets the map view to the last available location
     *
     * @param useDefaultZoom    true if the CAMERA_DEFAULT_ZOOM should be used, false if the
     *                          current
     *                          zoom level should be kept
     * @param animateToLocation true if the map should animate the transition to the new view, or
     *                          false if it should snap to the new view without animation
     * @return true if there was a a location to set the map view to, false if there was not
     */
    @Override
    @SuppressWarnings(&quot;deprecation&quot;)
    public boolean setMyLocation(boolean useDefaultZoom, boolean animateToLocation) {
<span class="nc bnc" id="L821" title="All 6 branches missed.">        if (!LocationUtils.isLocationEnabled(getActivity()) &amp;&amp; mRunning &amp;&amp; UIUtils.canManageDialog(</span>
<span class="nc" id="L822">                getActivity())) {</span>
            // If the user hasn't opted out of &quot;Enable location&quot; dialog, show it to them
<span class="nc" id="L824">            SharedPreferences prefs = Application.getPrefs();</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">            if (!prefs.getBoolean(getString(R.string.preference_key_never_show_location_dialog), false)) {</span>
<span class="nc" id="L826">                showDialog(MapDialogFragment.NOLOCATION_DIALOG);</span>
            }
<span class="nc" id="L828">            return false;</span>
        }

<span class="nc" id="L831">        GoogleApiClient apiClient = null;</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">        if (mLocationHelper != null) {</span>
<span class="nc" id="L833">            apiClient = mLocationHelper.getGoogleApiClient();</span>
        }

<span class="nc" id="L836">        Location lastLocation = Application.getLastKnownLocation(getActivity(), apiClient);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">        if (lastLocation == null) {</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">            if (!PermissionUtils.hasGrantedAtLeastOnePermission(Application.get(), LOCATION_PERMISSIONS)) {</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">                if (!PreferenceUtils.userDeniedLocationPermission()) {</span>
<span class="nc" id="L840">                    requestPermissionAndInit(getActivity());</span>
                }
            } else {
<span class="nc" id="L843">                Toast.makeText(getActivity(),</span>
<span class="nc" id="L844">                        getResources().getString(R.string.main_waiting_for_location),</span>
<span class="nc" id="L845">                        Toast.LENGTH_SHORT).show();</span>

            }
<span class="nc" id="L848">            return false;</span>
        }

<span class="nc" id="L851">        setMyLocation(lastLocation, useDefaultZoom, animateToLocation);</span>
<span class="nc" id="L852">        return true;</span>
    }

    private void setMyLocation(Location l, boolean useDefaultZoom, boolean animateToLocation) {
<span class="nc bnc" id="L856" title="All 2 branches missed.">        if (mMap != null) {</span>
            // Move camera to current location
<span class="nc" id="L858">            CameraPosition.Builder cameraPosition = new CameraPosition.Builder()</span>
<span class="nc" id="L859">                    .target(MapHelpV2.makeLatLng(l));</span>

<span class="nc bnc" id="L861" title="All 2 branches missed.">            if (useDefaultZoom) {</span>
                // Use default zoom level
<span class="nc" id="L863">                cameraPosition.zoom(CAMERA_DEFAULT_ZOOM);</span>
            } else {
                // Use current zoom level
<span class="nc" id="L866">                cameraPosition.zoom(mMap.getCameraPosition().zoom);</span>
            }

<span class="nc bnc" id="L869" title="All 2 branches missed.">            if (animateToLocation) {</span>
                // Smooth animation to position
<span class="nc" id="L871">                mMap.animateCamera(CameraUpdateFactory.newCameraPosition(cameraPosition.build()));</span>
            } else {
                // Abrupt change to position
<span class="nc" id="L874">                mMap.moveCamera(CameraUpdateFactory.newCameraPosition(cameraPosition.build()));</span>
            }
        }

<span class="nc bnc" id="L878" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L880">                controller.onLocation();</span>
<span class="nc" id="L881">            }</span>
        }
<span class="nc" id="L883">    }</span>

    public void zoomToRegion() {
        // If we have a region, then zoom to it.
<span class="nc" id="L887">        ObaRegion region = Application.get().getCurrentRegion();</span>

<span class="nc bnc" id="L889" title="All 4 branches missed.">        if (region != null &amp;&amp; mMap != null) {</span>
<span class="nc" id="L890">            LatLngBounds b = MapHelpV2.getRegionBounds(region);</span>

            // Use screen dimensions to avoid IllegalStateException (#581)
<span class="nc" id="L893">            int width = getResources().getDisplayMetrics().widthPixels;</span>
<span class="nc" id="L894">            int height = getResources().getDisplayMetrics().heightPixels;</span>
<span class="nc" id="L895">            int padding = 0;</span>
<span class="nc" id="L896">            mMap.animateCamera((CameraUpdateFactory.newLatLngBounds(b, width, height, padding)));</span>
        }
<span class="nc" id="L898">    }</span>

    @Override
    public Location getSouthWest() {
<span class="nc bnc" id="L902" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc" id="L903">            Location southWest = new Location(&quot;&quot;);</span>
<span class="nc" id="L904">            southWest.setLatitude(mMap.getProjection().getVisibleRegion().latLngBounds.southwest.latitude);</span>
<span class="nc" id="L905">            southWest.setLongitude(mMap.getProjection().getVisibleRegion().latLngBounds.southwest.longitude);</span>
<span class="nc" id="L906">            return southWest;</span>
        }
<span class="nc" id="L908">        return null;</span>
    }

    @Override
    public Location getNorthEast() {
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc" id="L914">            Location northEast = new Location(&quot;&quot;);</span>
<span class="nc" id="L915">            northEast.setLatitude(mMap.getProjection().getVisibleRegion().latLngBounds.northeast.latitude);</span>
<span class="nc" id="L916">            northEast.setLongitude(mMap.getProjection().getVisibleRegion().latLngBounds.northeast.longitude);</span>
<span class="nc" id="L917">            return northEast;</span>
        }
<span class="nc" id="L919">        return null;</span>
    }

    /**
     * Shows error messages related to stops, routes, and vehicles on the map, based on the
     * response
     * from the server
     *
     * @param response the response from the server, or null if the response object was null
     */
    public static void showMapError(ObaResponse response) {
<span class="nc" id="L930">        Context context = Application.get().getApplicationContext();</span>
        int code;
<span class="nc bnc" id="L932" title="All 2 branches missed.">        if (response != null) {</span>
<span class="nc" id="L933">            code = response.getCode();</span>
        } else {
            // If we don't even have a response object, something went really wrong
<span class="nc" id="L936">            code = ObaApi.OBA_INTERNAL_ERROR;</span>
        }
<span class="nc bnc" id="L938" title="All 2 branches missed.">        if (canManageDialog(context)) {</span>
<span class="nc" id="L939">            Toast.makeText(context,</span>
<span class="nc" id="L940">                    context.getString(UIUtils.getMapErrorString(context, code)),</span>
<span class="nc" id="L941">                    Toast.LENGTH_LONG).show();</span>
        }
<span class="nc" id="L943">    }</span>

    //
    // MapView interactions
    //

    @Override
    public void setZoom(float zoomLevel) {
<span class="nc bnc" id="L951" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc" id="L952">            mMap.moveCamera(CameraUpdateFactory.zoomTo(zoomLevel));</span>
        }
<span class="nc" id="L954">    }</span>

    @Override
    public Location getMapCenterAsLocation() {
        // If the center is the same as the last call to this method, pass back the same Location
        // object
<span class="nc bnc" id="L960" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc" id="L961">            LatLng center = mMap.getCameraPosition().target;</span>
<span class="nc bnc" id="L962" title="All 4 branches missed.">            if (mCenter == null || mCenter != center) {</span>
<span class="nc" id="L963">                mCenter = center;</span>
<span class="nc" id="L964">                mCenterLocation = MapHelpV2.makeLocation(mCenter);</span>
            }
        }
<span class="nc" id="L967">        return mCenterLocation;</span>
    }

    /**
     * Sets the map center to the given parameter
     *
     * @param location          location to center on
     * @param animateToLocation true if the map should animate to the location, false if it should
     *                          snap to it
     * @param overlayExpanded   true if the sliding panel is expanded, false if it is not
     */
    @Override
    public void setMapCenter(Location location, boolean animateToLocation,
                             boolean overlayExpanded) {
<span class="nc bnc" id="L981" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc" id="L982">            CameraPosition cp = mMap.getCameraPosition();</span>

<span class="nc" id="L984">            LatLng target = MapHelpV2.makeLatLng(location);</span>
            LatLng offsetTarget;

<span class="nc bnc" id="L987" title="All 4 branches missed.">            if (isRouteDisplayed() &amp;&amp; overlayExpanded) {</span>
                // Adjust camera target if the route header is currently displayed - map padding
                // doesn't get this quite right, as the header is slid up some and full padding doesn't apply
<span class="nc" id="L990">                double percentageOffset = 0.2;</span>
<span class="nc" id="L991">                double bias =</span>
<span class="nc" id="L992">                        (getLongitudeSpanInDecDegrees() * percentageOffset) / 2;</span>
<span class="nc" id="L993">                offsetTarget = new LatLng(target.latitude - bias, target.longitude);</span>
<span class="nc" id="L994">                target = offsetTarget;</span>
            }

<span class="nc bnc" id="L997" title="All 2 branches missed.">            if (animateToLocation) {</span>
<span class="nc" id="L998">                mMap.animateCamera(CameraUpdateFactory.newCameraPosition(</span>
<span class="nc" id="L999">                        new CameraPosition.Builder().target(target)</span>
<span class="nc" id="L1000">                                .zoom(cp.zoom)</span>
<span class="nc" id="L1001">                                .bearing(cp.bearing)</span>
<span class="nc" id="L1002">                                .tilt(cp.tilt)</span>
<span class="nc" id="L1003">                                .build()</span>
                ));
            } else {
<span class="nc" id="L1006">                mMap.moveCamera(CameraUpdateFactory.newCameraPosition(</span>
<span class="nc" id="L1007">                        new CameraPosition.Builder().target(target)</span>
<span class="nc" id="L1008">                                .zoom(cp.zoom)</span>
<span class="nc" id="L1009">                                .bearing(cp.bearing)</span>
<span class="nc" id="L1010">                                .tilt(cp.tilt)</span>
<span class="nc" id="L1011">                                .build()</span>
                ));
            }
        }
<span class="nc" id="L1015">    }</span>

    @Override
    public double getLatitudeSpanInDecDegrees() {
<span class="nc" id="L1019">        VisibleRegion vr = mMap.getProjection().getVisibleRegion();</span>
<span class="nc" id="L1020">        return Math.abs(vr.latLngBounds.northeast.latitude - vr.latLngBounds.southwest.latitude);</span>
    }

    @Override
    public double getLongitudeSpanInDecDegrees() {
<span class="nc" id="L1025">        VisibleRegion vr = mMap.getProjection().getVisibleRegion();</span>
<span class="nc" id="L1026">        return Math.abs(vr.latLngBounds.northeast.longitude - vr.latLngBounds.southwest.longitude);</span>
    }

    @Override
    public float getZoomLevelAsFloat() {
<span class="nc" id="L1031">        return mMap.getCameraPosition().zoom;</span>
    }

    @Override
    public void setRouteOverlay(int lineOverlayColor, ObaShape[] shapes, boolean clear) {
<span class="nc bnc" id="L1036" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">            if (clear) {</span>
<span class="nc" id="L1038">                mLineOverlay.clear();</span>
            }
            PolylineOptions lineOptions;

<span class="nc" id="L1042">            int totalPoints = 0;</span>

<span class="nc bnc" id="L1044" title="All 2 branches missed.">            for (ObaShape s : shapes) {</span>
<span class="nc" id="L1045">                lineOptions = new PolylineOptions();</span>
<span class="nc" id="L1046">                lineOptions.color(lineOverlayColor);</span>

<span class="nc bnc" id="L1048" title="All 2 branches missed.">                for (Location l : s.getPoints()) {</span>
<span class="nc" id="L1049">                    lineOptions.add(MapHelpV2.makeLatLng(l));</span>
<span class="nc" id="L1050">                }</span>
                // Add the line to the map, and keep a reference in the ArrayList
<span class="nc" id="L1052">                mLineOverlay.add(mMap.addPolyline(lineOptions));</span>

<span class="nc" id="L1054">                totalPoints += lineOptions.getPoints().size();</span>
            }

<span class="nc" id="L1057">            Log.d(TAG, &quot;Total points for route polylines = &quot; + totalPoints);</span>
        }
<span class="nc" id="L1059">    }</span>

    @Override
    public void setRouteOverlay(int lineOverlayColor, ObaShape[] shapes) {
<span class="nc" id="L1063">        setRouteOverlay(lineOverlayColor, shapes, true);</span>
<span class="nc" id="L1064">    }</span>

    /**
     * Updates markers for the provided routeIds from the status info from the given
     * ObaTripsForRouteResponse
     *
     * @param routeIds markers representing real-time positions for the provided routeIds will be
     *                 added to the map
     * @param response response that contains the real-time status info
     */
    @Override
    public void updateVehicles(HashSet&lt;String&gt; routeIds, ObaTripsForRouteResponse response) {
<span class="nc" id="L1076">        setupVehicleOverlay();</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">        if (mVehicleOverlay != null) {</span>
<span class="nc" id="L1078">            mVehicleOverlay.updateVehicles(routeIds, response);</span>
        }
<span class="nc" id="L1080">    }</span>

    @Override
    public void removeVehicleOverlay() {
<span class="nc bnc" id="L1084" title="All 2 branches missed.">        if (mVehicleOverlay != null) {</span>
<span class="nc" id="L1085">            mVehicleOverlay.clear();</span>
        }
<span class="nc" id="L1087">    }</span>

    @Override
    public void zoomToRoute() {
<span class="nc bnc" id="L1091" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">            if (!mLineOverlay.isEmpty()) {</span>
<span class="nc" id="L1093">                LatLngBounds.Builder builder = new LatLngBounds.Builder();</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">                for (Polyline p : mLineOverlay) {</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">                    for (LatLng l : p.getPoints()) {</span>
<span class="nc" id="L1096">                        builder.include(l);</span>
<span class="nc" id="L1097">                    }</span>
<span class="nc" id="L1098">                }</span>

<span class="nc" id="L1100">                Activity a = getActivity();</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">                if (a != null) {</span>
<span class="nc" id="L1102">                    int padding = UIUtils.dpToPixels(a, DEFAULT_MAP_PADDING_DP);</span>
<span class="nc" id="L1103">                    mMap.moveCamera(</span>
<span class="nc" id="L1104">                            (CameraUpdateFactory.newLatLngBounds(builder.build(), padding)));</span>
                }
<span class="nc" id="L1106">            } else {</span>
<span class="nc" id="L1107">                Toast.makeText(getActivity(), getString(R.string.route_info_no_shape_data),</span>
<span class="nc" id="L1108">                        Toast.LENGTH_SHORT).show();</span>
            }
        }
<span class="nc" id="L1111">    }</span>

    @Override
    public void zoomToItinerary() {
<span class="nc bnc" id="L1115" title="All 2 branches missed.">        if (mMap != null) {</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">            if (!mLineOverlay.isEmpty()) {</span>
<span class="nc" id="L1117">                LatLngBounds.Builder builder = new LatLngBounds.Builder();</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">                for (Polyline p : mLineOverlay) {</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">                    for (LatLng l : p.getPoints()) {</span>
<span class="nc" id="L1120">                        builder.include(l);</span>
<span class="nc" id="L1121">                    }</span>
<span class="nc" id="L1122">                }</span>

<span class="nc" id="L1124">                Activity a = getActivity();</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                if (a != null) {</span>
<span class="nc" id="L1126">                    int padding = UIUtils.dpToPixels(a, DEFAULT_MAP_PADDING_DP);</span>
<span class="nc" id="L1127">                    mMap.moveCamera(</span>
<span class="nc" id="L1128">                            (CameraUpdateFactory.newLatLngBounds(builder.build(),</span>
<span class="nc" id="L1129">                                    getResources().getDisplayMetrics().widthPixels,</span>
<span class="nc" id="L1130">                                    getResources().getDisplayMetrics().heightPixels,</span>
                                    padding)));
                }
            }
        }
<span class="nc" id="L1135">    }</span>

    /**
     * Zoom to include the current map bounds plus the location of the nearest vehicle
     *
     * @param routeIds markers representing real-time positions for the provided routeIds will be
     *                 checked for proximity to the location (all other routes are ignored)
     * @param response trips-for-route API response, which includes real-time vehicle locations in
     *                 status
     */
    @Override
    public void zoomIncludeClosestVehicle(HashSet&lt;String&gt; routeIds,
                                          ObaTripsForRouteResponse response) {
<span class="nc bnc" id="L1148" title="All 2 branches missed.">        if (mMap == null) {</span>
<span class="nc" id="L1149">            return;</span>
        }
<span class="nc" id="L1151">        LatLng closestVehicleLocation = MapHelpV2</span>
<span class="nc" id="L1152">                .getClosestVehicle(response, routeIds, getMapCenterAsLocation());</span>

<span class="nc" id="L1154">        LatLngBounds visibleBounds = mMap.getProjection().getVisibleRegion().latLngBounds;</span>

<span class="nc bnc" id="L1156" title="All 4 branches missed.">        if (closestVehicleLocation == null || visibleBounds.contains(closestVehicleLocation)) {</span>
            // Closest vehicle is already in view or is null - don't change camera
<span class="nc" id="L1158">            return;</span>
        }

        // Zoom to include current map bounds and closest vehicle location
<span class="nc" id="L1162">        LatLngBounds.Builder builder = new LatLngBounds.Builder();</span>
<span class="nc" id="L1163">        builder.include(visibleBounds.northeast);</span>
<span class="nc" id="L1164">        builder.include(visibleBounds.southwest);</span>
<span class="nc" id="L1165">        builder.include(closestVehicleLocation);</span>

<span class="nc" id="L1167">        Activity a = getActivity();</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">        if (a != null) {</span>
<span class="nc" id="L1169">            int padding = UIUtils.dpToPixels(a, DEFAULT_MAP_PADDING_DP);</span>
<span class="nc" id="L1170">            mMap.animateCamera(CameraUpdateFactory.newLatLngBounds(builder.build(), padding));</span>
        }
<span class="nc" id="L1172">    }</span>

    @Override
    public void removeRouteOverlay() {
<span class="nc bnc" id="L1176" title="All 2 branches missed.">        for (Polyline p : mLineOverlay) {</span>
<span class="nc" id="L1177">            p.remove();</span>
<span class="nc" id="L1178">        }</span>

<span class="nc" id="L1180">        mLineOverlay.clear();</span>
<span class="nc" id="L1181">    }</span>

    /**
     * Clears any stop markers from the map
     *
     * @param clearFocusedStop true to clear the currently focused stop, false to leave it on map
     */
    @Override
    public void removeStopOverlay(boolean clearFocusedStop) {
<span class="nc bnc" id="L1190" title="All 2 branches missed.">        if (mStopOverlay != null) {</span>
<span class="nc" id="L1191">            mStopOverlay.clear(clearFocusedStop);</span>
        }
<span class="nc" id="L1193">    }</span>

    @Override
    public boolean canWatchMapChanges() {
        // Android Map API v2 has an OnCameraChangeListener
<span class="nc" id="L1198">        return true;</span>
    }

    /**
     * Sets focus to a particular stop, or pass in null for the stop to clear the focus
     *
     * @param stop   ObaStop to focus on, or null to clear the focus
     * @param routes a list of all route display names that serve this stop, or null to clear the
     *               focus
     */
    @Override
    public void setFocusStop(ObaStop stop, List&lt;ObaRoute&gt; routes) {
        // Make sure that the stop overlay has been successfully initialized before setting focus
<span class="nc bnc" id="L1211" title="All 2 branches missed.">        if (setupStopOverlay()) {</span>
<span class="nc" id="L1212">            mStopOverlay.setFocus(stop, routes);</span>
        }
<span class="nc" id="L1214">    }</span>

    @Override
    public void onCameraChange(CameraPosition cameraPosition) {
<span class="nc" id="L1218">        Log.d(TAG, &quot;onCameraChange&quot;);</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">        if (mControllers != null) {</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">            for (MapModeController controller : mControllers) {</span>
<span class="nc" id="L1221">                controller.notifyMapChanged();</span>
<span class="nc" id="L1222">            }</span>
        }
<span class="nc" id="L1224">    }</span>

    // Maps V2 Location updates

    @Override
    public void activate(OnLocationChangedListener listener) {
<span class="nc" id="L1230">        mListener = listener;</span>
<span class="nc" id="L1231">    }</span>

    @Override
    public void deactivate() {
<span class="nc" id="L1235">        mListener = null;</span>
<span class="nc" id="L1236">    }</span>

    public void onLocationChanged(Location l) {
<span class="nc bnc" id="L1239" title="All 2 branches missed.">        if (mListener != null) {</span>
            // Show real-time location on map
<span class="nc" id="L1241">            mListener.onLocationChanged(l);</span>
        }
<span class="nc" id="L1243">    }</span>

    @Override
    public void postInvalidate() {
        // Do nothing - calling `this.postInvalidate()` causes a StackOverflowError
<span class="nc" id="L1248">    }</span>

    //
    // VehicleOverlay.Controller
    //
    @Override
    public String getFocusedStopId() {
<span class="nc" id="L1255">        return mFocusStopId;</span>
    }

    //
    // Dialogs
    //

<span class="nc" id="L1262">    public static class MapDialogFragment extends DialogFragment {</span>

        private static final String TAG = &quot;MapDialogFragment&quot;;

        int mDialogType;

        private static BaseMapFragment mMapFragment;

        private final static String DIALOG_TYPE_KEY = &quot;dialog_type&quot;;

        private static final int NOLOCATION_DIALOG = 103;

        private static final int OUTOFRANGE_DIALOG = 104;

        /**
         * Creates a new dialog of type NOLOCATION_DIALOG or OUTOFRANGE_DIALOG
         *
         * @param dialogType NOLOCATION_DIALOG to create a no location dialog, or OUTOFRANGE_DIALOG
         *                   to create an out of range dialog
         * @return a fragment to show the dialog
         */
        static MapDialogFragment newInstance(int dialogType, BaseMapFragment fragment) {
<span class="nc" id="L1284">            mMapFragment = fragment;</span>
<span class="nc" id="L1285">            MapDialogFragment f = new MapDialogFragment();</span>

            // Provide dialog type as an argument.
<span class="nc" id="L1288">            Bundle args = new Bundle();</span>
<span class="nc" id="L1289">            args.putInt(DIALOG_TYPE_KEY, dialogType);</span>
<span class="nc" id="L1290">            f.setArguments(args);</span>
<span class="nc" id="L1291">            f.setCancelable(false);</span>

<span class="nc" id="L1293">            return f;</span>
        }

        @Override
        public Dialog onCreateDialog(Bundle savedInstanceState) {
<span class="nc" id="L1298">            mDialogType = getArguments().getInt(DIALOG_TYPE_KEY);</span>

<span class="nc bnc" id="L1300" title="All 3 branches missed.">            switch (mDialogType) {</span>
                case NOLOCATION_DIALOG:
<span class="nc" id="L1302">                    return createNoLocationDialog();</span>
                case OUTOFRANGE_DIALOG:
<span class="nc" id="L1304">                    return createOutOfRangeDialog();</span>
                default:
<span class="nc" id="L1306">                    throw new IllegalArgumentException(</span>
                            &quot;Invalid map dialog type - &quot; + DIALOG_TYPE_KEY);
            }
        }

        private Dialog createOutOfRangeDialog() {
<span class="nc" id="L1312">            Drawable icon = getResources().getDrawable(android.R.drawable.ic_dialog_map);</span>
<span class="nc" id="L1313">            DrawableCompat.setTint(icon, getResources().getColor(R.color.theme_primary));</span>

<span class="nc" id="L1315">            AlertDialog.Builder builder = new AlertDialog.Builder(getActivity())</span>
<span class="nc" id="L1316">                    .setTitle(R.string.main_outofrange_title)</span>
<span class="nc" id="L1317">                    .setIcon(icon)</span>
<span class="nc" id="L1318">                    .setCancelable(false)</span>
<span class="nc" id="L1319">                    .setMessage(getString(R.string.main_outofrange,</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">                            Application.get().getCurrentRegion() != null ?</span>
<span class="nc" id="L1321">                                    Application.get().getCurrentRegion().getName() : &quot;&quot;</span>
                    ))
<span class="nc" id="L1323">                    .setPositiveButton(R.string.main_outofrange_yes,</span>
                            (dialog, which) -&gt; {
<span class="nc bnc" id="L1325" title="All 4 branches missed.">                                if (mMapFragment != null &amp;&amp; mMapFragment.isAdded()) {</span>
<span class="nc" id="L1326">                                    mMapFragment.zoomToRegion();</span>
                                }
<span class="nc" id="L1328">                            }</span>
                    )
<span class="nc" id="L1330">                    .setNegativeButton(R.string.main_outofrange_no,</span>
                            (dialog, which) -&gt; {
<span class="nc bnc" id="L1332" title="All 4 branches missed.">                                if (mMapFragment != null &amp;&amp; mMapFragment.isAdded()) {</span>
<span class="nc" id="L1333">                                    mMapFragment.mWarnOutOfRange = false;</span>
                                }
<span class="nc" id="L1335">                            }</span>
                    );
<span class="nc" id="L1337">            return builder.create();</span>
        }

        @SuppressWarnings(&quot;deprecation&quot;)
        private Dialog createNoLocationDialog() {
<span class="nc" id="L1342">            View view = getActivity().getLayoutInflater().inflate(R.layout.no_location_dialog, null);</span>
<span class="nc" id="L1343">            CheckBox neverShowDialog = view.findViewById(R.id.location_never_ask_again);</span>

<span class="nc" id="L1345">            neverShowDialog.setOnCheckedChangeListener((compoundButton, isChecked) -&gt; {</span>
                // Save the preference
<span class="nc" id="L1347">                PreferenceUtils.saveBoolean(getString(R.string.preference_key_never_show_location_dialog), isChecked);</span>
<span class="nc" id="L1348">            });</span>

<span class="nc" id="L1350">            Drawable icon = getResources().getDrawable(android.R.drawable.ic_dialog_map);</span>
<span class="nc" id="L1351">            DrawableCompat.setTint(icon, getResources().getColor(R.color.theme_primary));</span>

<span class="nc" id="L1353">            AlertDialog.Builder builder = new AlertDialog.Builder(getActivity())</span>
<span class="nc" id="L1354">                    .setTitle(R.string.main_nolocation_title)</span>
<span class="nc" id="L1355">                    .setIcon(icon)</span>
<span class="nc" id="L1356">                    .setCancelable(false)</span>
<span class="nc" id="L1357">                    .setView(view)</span>
<span class="nc" id="L1358">                    .setPositiveButton(R.string.rt_yes,</span>
<span class="nc" id="L1359">                            (dialog, which) -&gt; startActivityForResult(</span>
                                    new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS),
                                    REQUEST_NO_LOCATION)
                    )
<span class="nc" id="L1363">                    .setNegativeButton(R.string.rt_no,</span>
                            (dialog, which) -&gt; {
                                // Ok, I suppose we can just try looking from where we
                                // are.
<span class="nc bnc" id="L1367" title="All 2 branches missed.">                                for (MapModeController controller : mMapFragment.mControllers) {</span>
<span class="nc" id="L1368">                                    controller.onLocation();</span>
<span class="nc" id="L1369">                                }</span>
<span class="nc" id="L1370">                            }</span>
                    );
<span class="nc" id="L1372">            return builder.create();</span>
        }
    }

    /**
     * Shows the dialog to explain why location permissions are needed.  If this provided activity
     * can't manage dialogs then this method is a no-op.
     * &lt;p&gt;
     * NOTE - this dialog can't be managed under the old dialog framework as the method
     * ActivityCompat.shouldShowRequestPermissionRationale() always returns false.
     */
    public void showLocationPermissionDialog() {
<span class="nc bnc" id="L1384" title="All 2 branches missed.">        if (!canManageDialog(getActivity())) {</span>
<span class="nc" id="L1385">            return;</span>
        }
<span class="nc bnc" id="L1387" title="All 4 branches missed.">        if (locationPermissionDialog != null &amp;&amp; locationPermissionDialog.isShowing()) {</span>
<span class="nc" id="L1388">            return;</span>
        }
<span class="nc" id="L1390">        AlertDialog.Builder builder = new AlertDialog.Builder(getActivity())</span>
<span class="nc" id="L1391">                .setTitle(R.string.location_permissions_title)</span>
<span class="nc" id="L1392">                .setMessage(R.string.location_permissions_message)</span>
<span class="nc" id="L1393">                .setCancelable(false)</span>
<span class="nc" id="L1394">                .setPositiveButton(R.string.ok,</span>
                        (dialog, which) -&gt; {
<span class="nc" id="L1396">                            PreferenceUtils.setUserDeniedLocationPermissions(false);</span>
                            // Request permissions from the user
<span class="nc" id="L1398">                            requestPermissions(LOCATION_PERMISSIONS, LOCATION_PERMISSION_REQUEST);</span>
<span class="nc" id="L1399">                        }</span>
                )
<span class="nc" id="L1401">                .setNegativeButton(R.string.no_thanks,</span>
                        (dialog, which) -&gt; {
<span class="nc bnc" id="L1403" title="All 2 branches missed.">                            if (mOnLocationPermissionResultListener != null) {</span>
<span class="nc" id="L1404">                                mUserDeniedPermission = true;</span>
<span class="nc" id="L1405">                                PreferenceUtils.setUserDeniedLocationPermissions(true);</span>
<span class="nc" id="L1406">                                mOnLocationPermissionResultListener.onLocationPermissionResult(PackageManager.PERMISSION_DENIED);</span>
                            }
<span class="nc" id="L1408">                        }</span>
                );
<span class="nc" id="L1410">        locationPermissionDialog = builder.create();</span>
<span class="nc" id="L1411">        locationPermissionDialog.show();</span>
<span class="nc" id="L1412">    }</span>

    /**
     * Class responsible for listening to the clicks on the map or markers and propagating these
     * clicks to the overlays visible on the map.
     */
<span class="nc" id="L1418">    private class MapClickListeners implements GoogleMap.OnMarkerClickListener, GoogleMap.OnMapClickListener {</span>

        @Override
        public void onMapClick(LatLng latLng) {
<span class="nc bnc" id="L1422" title="All 2 branches missed.">            if (mStopOverlay != null) {</span>
<span class="nc" id="L1423">                mStopOverlay.removeMarkerClicked(latLng);</span>
            }

<span class="nc bnc" id="L1426" title="All 2 branches missed.">            if (mBikeStationOverlay != null) {</span>
<span class="nc" id="L1427">                mBikeStationOverlay.removeMarkerClicked(latLng);</span>
            }

<span class="nc bnc" id="L1430" title="All 2 branches missed.">            if (mVehicleOverlay != null) {</span>
<span class="nc" id="L1431">                mVehicleOverlay.removeMarkerClicked(latLng);</span>
            }

<span class="nc" id="L1434">        }</span>

        @Override
        public boolean onMarkerClick(Marker marker) {
<span class="nc bnc" id="L1438" title="All 2 branches missed.">            if (mStopOverlay != null) {</span>
<span class="nc bnc" id="L1439" title="All 2 branches missed.">                if (mStopOverlay.markerClicked(marker)) {</span>
<span class="nc" id="L1440">                    return true;</span>
                }
            }
<span class="nc bnc" id="L1443" title="All 2 branches missed.">            if (mBikeStationOverlay != null) {</span>
<span class="nc bnc" id="L1444" title="All 2 branches missed.">                if (mBikeStationOverlay.markerClicked(marker)) {</span>
<span class="nc" id="L1445">                    return true;</span>
                }
            }
<span class="nc bnc" id="L1448" title="All 2 branches missed.">            if (mVehicleOverlay != null) {</span>
<span class="nc" id="L1449">                return mVehicleOverlay.markerClicked(marker);</span>
            }
<span class="nc" id="L1451">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>