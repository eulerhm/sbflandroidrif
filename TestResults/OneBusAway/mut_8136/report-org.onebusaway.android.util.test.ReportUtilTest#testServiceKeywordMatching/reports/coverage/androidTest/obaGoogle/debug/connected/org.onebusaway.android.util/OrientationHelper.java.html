<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrientationHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">obaGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.util</a> &gt; <span class="el_source">OrientationHelper.java</span></div><h1>OrientationHelper.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2014 Sean J. Barbeau (sjbarbeau@gmail.com), University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.util;

import org.onebusaway.android.app.Application;

import android.annotation.TargetApi;
import android.content.Context;
import android.hardware.Sensor;
import android.hardware.SensorEvent;
import android.hardware.SensorEventListener;
import android.hardware.SensorManager;
import android.os.Build;
import android.util.Log;
import android.view.Surface;
import android.view.WindowManager;

import java.util.ArrayList;

/**
 * A sensor-based orientation helperclass , which allows listeners to receive orientation updates
 */
public class OrientationHelper implements SensorEventListener {

    public interface Listener {

        /**
         * Called every time there is an update to the orientation
         *
         * @param deltaHeading change in heading from last heading value
         * @param deltaPitch   change in pitch from last pitch value
         */
        void onOrientationChanged(float heading, float pitch, float deltaHeading, float deltaPitch);
    }

    static final String TAG = &quot;OrientationHelper&quot;;

    Context mContext;

    SensorManager mSensorManager;

<span class="nc" id="L55">    private float[] mRotationMatrix = new float[16];</span>

<span class="nc" id="L57">    private static float[] mRemappedMatrix = new float[16];</span>

<span class="nc" id="L59">    private float[] mOrientation = new float[9];</span>

<span class="nc" id="L61">    private float[] history = new float[2];</span>

<span class="nc" id="L63">    private static float[] mTruncatedRotationVector = new float[4];</span>

<span class="nc" id="L65">    private static boolean mTruncateVector = false;</span>

    private float mHeading;

    private float mPitch;

<span class="nc" id="L71">    ArrayList&lt;Listener&gt; mListeners = new ArrayList&lt;Listener&gt;();</span>

<span class="nc" id="L73">    public OrientationHelper(Context context) {</span>
<span class="nc" id="L74">        mContext = context;</span>
<span class="nc" id="L75">        mSensorManager = (SensorManager) mContext.getSystemService(Context.SENSOR_SERVICE);</span>
<span class="nc" id="L76">    }</span>

    public synchronized void registerListener(Listener listener) {
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (!mListeners.contains(listener)) {</span>
<span class="nc" id="L80">            mListeners.add(listener);</span>
        }

        // If this is the first listener, make sure we're monitoring the sensors to provide updates
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (mListeners.size() == 1) {</span>
<span class="nc" id="L85">            mSensorManager.registerListener(this,</span>
<span class="nc" id="L86">                    mSensorManager.getDefaultSensor(Sensor.TYPE_ROTATION_VECTOR),</span>
                    SensorManager.SENSOR_DELAY_UI);
        }
<span class="nc" id="L89">    }</span>

    public synchronized void unregisterListener(Listener listener) {
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (mListeners.contains(listener)) {</span>
<span class="nc" id="L93">            mListeners.remove(listener);</span>
        }

<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (mListeners.size() == 0) {</span>
<span class="nc" id="L97">            mSensorManager.unregisterListener(this);</span>
        }
<span class="nc" id="L99">    }</span>

    public synchronized void onResume() {
<span class="nc" id="L102">        mSensorManager.registerListener(this,</span>
<span class="nc" id="L103">                mSensorManager.getDefaultSensor(Sensor.TYPE_ROTATION_VECTOR),</span>
                SensorManager.SENSOR_DELAY_UI);
<span class="nc" id="L105">    }</span>

    public synchronized void onPause() {
<span class="nc" id="L108">        mSensorManager.unregisterListener(this);</span>
<span class="nc" id="L109">    }</span>

    @TargetApi(Build.VERSION_CODES.GINGERBREAD)
    @Override
    public void onSensorChanged(SensorEvent event) {
<span class="nc" id="L114">        float xDelta = 0f;</span>
<span class="nc" id="L115">        float yDelta = 0f;</span>

<span class="nc bnc" id="L117" title="All 3 branches missed.">        switch (event.sensor.getType()) {</span>
            case Sensor.TYPE_ROTATION_VECTOR:

                // Modern rotation vector sensors
<span class="nc bnc" id="L121" title="All 2 branches missed.">                if (!mTruncateVector) {</span>
                    try {
<span class="nc" id="L123">                        SensorManager.getRotationMatrixFromVector(mRotationMatrix, event.values);</span>
<span class="nc" id="L124">                    } catch (IllegalArgumentException e) {</span>
                        // On some Samsung devices, an exception is thrown if this vector &gt; 4
                        // See https://github.com/barbeau/gpstest/issues/39
                        // Truncate the array, since we can deal with only the first four values
<span class="nc" id="L128">                        Log.e(TAG, &quot;Samsung device error? Will truncate vectors - &quot; + e);</span>
<span class="nc" id="L129">                        mTruncateVector = true;</span>
                        // Do the truncation here the first time the exception occurs
<span class="nc" id="L131">                        getRotationMatrixFromTruncatedVector(event.values);</span>
<span class="nc" id="L132">                    }</span>
                } else {
                    // Truncate the array to avoid the exception on some devices (see #39)
<span class="nc" id="L135">                    getRotationMatrixFromTruncatedVector(event.values);</span>
                }

<span class="nc" id="L138">                WindowManager windowManager = (WindowManager) mContext.getSystemService(</span>
                        Context.WINDOW_SERVICE);
<span class="nc" id="L140">                int rot = windowManager.getDefaultDisplay().getRotation();</span>

<span class="nc bnc" id="L142" title="All 5 branches missed.">                switch (rot) {</span>
                    case Surface.ROTATION_0:
                        // No orientation change, use default coordinate system
<span class="nc" id="L145">                        SensorManager.getOrientation(mRotationMatrix, mOrientation);</span>
                        // Log.d(TAG, &quot;Rotation-0&quot;);
<span class="nc" id="L147">                        break;</span>
                    case Surface.ROTATION_90:
                        // Log.d(TAG, &quot;Rotation-90&quot;);
<span class="nc" id="L150">                        SensorManager.remapCoordinateSystem(mRotationMatrix, SensorManager.AXIS_Y,</span>
                                SensorManager.AXIS_MINUS_X, mRemappedMatrix);
<span class="nc" id="L152">                        SensorManager.getOrientation(mRemappedMatrix, mOrientation);</span>
<span class="nc" id="L153">                        break;</span>
                    case Surface.ROTATION_180:
                        // Log.d(TAG, &quot;Rotation-180&quot;);
<span class="nc" id="L156">                        SensorManager</span>
<span class="nc" id="L157">                                .remapCoordinateSystem(mRotationMatrix, SensorManager.AXIS_MINUS_X,</span>
                                        SensorManager.AXIS_MINUS_Y, mRemappedMatrix);
<span class="nc" id="L159">                        SensorManager.getOrientation(mRemappedMatrix, mOrientation);</span>
<span class="nc" id="L160">                        break;</span>
                    case Surface.ROTATION_270:
                        // Log.d(TAG, &quot;Rotation-270&quot;);
<span class="nc" id="L163">                        SensorManager</span>
<span class="nc" id="L164">                                .remapCoordinateSystem(mRotationMatrix, SensorManager.AXIS_MINUS_Y,</span>
                                        SensorManager.AXIS_X, mRemappedMatrix);
<span class="nc" id="L166">                        SensorManager.getOrientation(mRemappedMatrix, mOrientation);</span>
<span class="nc" id="L167">                        break;</span>
                    default:
                        // This shouldn't happen - assume default orientation
<span class="nc" id="L170">                        SensorManager.getOrientation(mRotationMatrix, mOrientation);</span>
                        // Log.d(TAG, &quot;Rotation-Unknown&quot;);
                        break;
                }

<span class="nc" id="L175">                mHeading = (float) Math.toDegrees(mOrientation[0]);</span>
<span class="nc" id="L176">                mPitch = (float) Math.toDegrees(mOrientation[1]);</span>

<span class="nc" id="L178">                xDelta = history[0] - mHeading;</span>
<span class="nc" id="L179">                yDelta = history[1] - mPitch;</span>

<span class="nc" id="L181">                history[0] = mHeading;</span>
<span class="nc" id="L182">                history[1] = mPitch;</span>
<span class="nc" id="L183">                break;</span>
            case Sensor.TYPE_ORIENTATION:
                // Legacy orientation sensors
<span class="nc" id="L186">                mHeading = event.values[0];</span>
<span class="nc" id="L187">                xDelta = history[0] - mHeading;</span>
<span class="nc" id="L188">                break;</span>
            default:
                // A sensor we're not using, so return
<span class="nc" id="L191">                return;</span>
        }

        // Use magnetic field to compute true (geographic) north, if data is available
<span class="nc" id="L195">        Float magneticDeclination = Application.getMagneticDeclination();</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (magneticDeclination != null) {</span>
<span class="nc" id="L197">            mHeading += magneticDeclination;</span>
        }

        // Make sure value is between 0-360
<span class="nc" id="L201">        mHeading = MathUtils.mod(mHeading, 360.0f);</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">        for (Listener l : mListeners) {</span>
<span class="nc" id="L204">            l.onOrientationChanged(mHeading, mPitch, xDelta, yDelta);</span>
<span class="nc" id="L205">        }</span>
<span class="nc" id="L206">    }</span>

    @Override
    public void onAccuracyChanged(Sensor sensor, int accuracy) {
<span class="nc" id="L210">    }</span>

    @TargetApi(Build.VERSION_CODES.GINGERBREAD)
    private void getRotationMatrixFromTruncatedVector(float[] vector) {
<span class="nc" id="L214">        System.arraycopy(vector, 0, mTruncatedRotationVector, 0, 4);</span>
<span class="nc" id="L215">        SensorManager.getRotationMatrixFromVector(mRotationMatrix, mTruncatedRotationVector);</span>
<span class="nc" id="L216">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>