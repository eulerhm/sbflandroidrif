<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocationHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.util</a> &gt; <span class="el_source">LocationHelper.java</span></div><h1>LocationHelper.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2014 Sean J. Barbeau (sjbarbeau@gmail.com), University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.util;

import com.google.android.gms.common.ConnectionResult;
import com.google.android.gms.common.GoogleApiAvailability;
import com.google.android.gms.common.api.GoogleApiClient;
import com.google.android.gms.location.FusedLocationProviderClient;
import com.google.android.gms.location.LocationCallback;
import com.google.android.gms.location.LocationRequest;
import com.google.android.gms.location.LocationResult;
import com.google.android.gms.location.LocationServices;
import org.onebusaway.android.app.Application;
import android.content.Context;
import android.location.Location;
import android.location.LocationManager;
import android.os.Bundle;
import android.util.Log;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import static com.google.android.gms.location.LocationServices.getFusedLocationProviderClient;
import static org.onebusaway.android.util.PermissionUtils.LOCATION_PERMISSIONS;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * A helper class that keeps listeners updated with the best location available from
 * multiple providers
 */
public class LocationHelper implements com.google.android.gms.location.LocationListener, android.location.LocationListener, GoogleApiClient.ConnectionCallbacks, GoogleApiClient.OnConnectionFailedListener {

    public interface Listener {

        /**
         * Called every time there is an update to the best location available
         */
        void onLocationChanged(Location location);
    }

    static final String TAG = &quot;LocationHelper&quot;;

    Context mContext;

    LocationManager mLocationManager;

<span class="nc" id="L59">    ArrayList&lt;Listener&gt; mListeners = new ArrayList&lt;Listener&gt;();</span>

    /**
     * GoogleApiClient being used for Location Services
     */
    protected GoogleApiClient mGoogleApiClient;

    LocationRequest mLocationRequest;

    LocationCallback mLocationCallback;

    private static final int MILLISECONDS_PER_SECOND = 1000;

    private static final int UPDATE_INTERVAL_IN_SECONDS = 5;

<span class="nc" id="L74">    private long UPDATE_INTERVAL = MILLISECONDS_PER_SECOND * UPDATE_INTERVAL_IN_SECONDS;</span>

    private static final int FASTEST_INTERVAL_IN_SECONDS = 1;

    private static final long FASTEST_INTERVAL = MILLISECONDS_PER_SECOND * FASTEST_INTERVAL_IN_SECONDS;

<span class="nc" id="L80">    public LocationHelper(Context context) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8077)) {</span>
<span class="nc" id="L82">            mContext = context;</span>
        }
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8078)) {</span>
<span class="nc" id="L85">            mLocationManager = (LocationManager) Application.get().getBaseContext().getSystemService(Context.LOCATION_SERVICE);</span>
        }
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8079)) {</span>
            // Create the LocationRequest object
<span class="nc" id="L89">            mLocationRequest = LocationRequest.create();</span>
        }
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8080)) {</span>
            // Use high accuracy
<span class="nc" id="L93">            mLocationRequest.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);</span>
        }
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8081)) {</span>
            // Set the update interval to 5 seconds
<span class="nc" id="L97">            mLocationRequest.setInterval(UPDATE_INTERVAL);</span>
        }
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8082)) {</span>
            // Set the fastest update interval to 1 second
<span class="nc" id="L101">            mLocationRequest.setFastestInterval(FASTEST_INTERVAL);</span>
        }
<span class="nc" id="L103">    }</span>

    /**
     * @param context
     * @param interval Faster interval in seconds.
     */
<span class="nc" id="L109">    public LocationHelper(Context context, int interval) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8083)) {</span>
<span class="nc" id="L111">            mContext = context;</span>
        }
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8088)) {</span>
<span class="nc bnc" id="L114" title="All 8 branches missed.">            UPDATE_INTERVAL = (ListenerUtil.mutListener.listen(8087) ? (interval % MILLISECONDS_PER_SECOND) : (ListenerUtil.mutListener.listen(8086) ? (interval / MILLISECONDS_PER_SECOND) : (ListenerUtil.mutListener.listen(8085) ? (interval - MILLISECONDS_PER_SECOND) : (ListenerUtil.mutListener.listen(8084) ? (interval + MILLISECONDS_PER_SECOND) : (interval * MILLISECONDS_PER_SECOND)))));</span>
        }
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8089)) {</span>
<span class="nc" id="L117">            mLocationManager = (LocationManager) Application.get().getBaseContext().getSystemService(Context.LOCATION_SERVICE);</span>
        }
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8090)) {</span>
<span class="nc" id="L120">            setupGooglePlayServices();</span>
        }
<span class="nc" id="L122">    }</span>

    /**
     * Registers the provided listener for location updates, but first checks to see if Location
     * permissions are granted.  If permissions haven't been granted, returns false and does not
     * register any listeners.  After the caller has received permission from the user it can
     * call this method again.
     * @param listener listener for updates
     * @return true if permissions have been granted and the listener was registered, false if
     * permissions have not been granted and no listener was registered
     */
    public synchronized boolean registerListener(Listener listener) {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8091)) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (!PermissionUtils.hasGrantedAtLeastOnePermission(mContext, LOCATION_PERMISSIONS)) {</span>
<span class="nc" id="L136">                return false;</span>
            }
        }
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8093)) {</span>
            // User has granted permissions - continue to register listener for location updates
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (!mListeners.contains(listener)) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8092)) {</span>
<span class="nc" id="L143">                    mListeners.add(listener);</span>
                }
            }
        }
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8100)) {</span>
            // If this is the first listener, make sure we're monitoring the sensors to provide updates
<span class="nc bnc" id="L149" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(8098) ? (mListeners.size() &gt;= 1) : (ListenerUtil.mutListener.listen(8097) ? (mListeners.size() &lt;= 1) : (ListenerUtil.mutListener.listen(8096) ? (mListeners.size() &gt; 1) : (ListenerUtil.mutListener.listen(8095) ? (mListeners.size() &lt; 1) : (ListenerUtil.mutListener.listen(8094) ? (mListeners.size() != 1) : (mListeners.size() == 1))))))) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8099)) {</span>
                    // Listen for location
<span class="nc" id="L152">                    registerAllProviders();</span>
                }
            }
        }
<span class="nc" id="L156">        return true;</span>
    }

    public synchronized void unregisterListener(Listener listener) {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8101)) {</span>
<span class="nc" id="L161">            mListeners.remove(listener);</span>
        }
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8109)) {</span>
<span class="nc bnc" id="L164" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(8106) ? (mListeners.size() &gt;= 0) : (ListenerUtil.mutListener.listen(8105) ? (mListeners.size() &lt;= 0) : (ListenerUtil.mutListener.listen(8104) ? (mListeners.size() &gt; 0) : (ListenerUtil.mutListener.listen(8103) ? (mListeners.size() &lt; 0) : (ListenerUtil.mutListener.listen(8102) ? (mListeners.size() != 0) : (mListeners.size() == 0))))))) {</span>
                try {
<span class="nc bnc" id="L166" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8108)) {</span>
<span class="nc" id="L167">                        mLocationManager.removeUpdates(this);</span>
                    }
<span class="nc" id="L169">                } catch (SecurityException e) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8107)) {</span>
                        // permissions after the listener was registered
<span class="nc" id="L172">                        Log.w(TAG, &quot;User may have denied location permission - &quot; + e);</span>
                    }
<span class="nc" id="L174">                }</span>
            }
        }
<span class="nc" id="L177">    }</span>

    /**
     * Returns the GoogleApiClient being used for fused provider location updates
     *
     * @return the GoogleApiClient being used for fused provider location updates
     */
    public GoogleApiClient getGoogleApiClient() {
<span class="nc" id="L185">        return mGoogleApiClient;</span>
    }

    public synchronized void onResume() {
        try {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8111)) {</span>
<span class="nc" id="L191">                registerAllProviders();</span>
            }
<span class="nc" id="L193">        } catch (SecurityException e) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8110)) {</span>
                // If we resume after the user has denied location permissions, log the warning and continue
<span class="nc" id="L196">                Log.w(TAG, &quot;User may have denied location permission - &quot; + e);</span>
            }
<span class="nc" id="L198">        }</span>
<span class="nc" id="L199">    }</span>

    public synchronized void onPause() {
        try {
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8113)) {</span>
<span class="nc" id="L204">                mLocationManager.removeUpdates(this);</span>
            }
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8118)) {</span>
                // Tear down GoogleApiClient
<span class="nc bnc" id="L208" title="All 26 branches missed.">                if ((ListenerUtil.mutListener.listen(8115) ? ((ListenerUtil.mutListener.listen(8114) ? (mGoogleApiClient != null || mGoogleApiClient.isConnected()) : (mGoogleApiClient != null &amp;&amp; mGoogleApiClient.isConnected())) || mLocationCallback != null) : ((ListenerUtil.mutListener.listen(8114) ? (mGoogleApiClient != null || mGoogleApiClient.isConnected()) : (mGoogleApiClient != null &amp;&amp; mGoogleApiClient.isConnected())) &amp;&amp; mLocationCallback != null))) {</span>
<span class="nc" id="L209">                    FusedLocationProviderClient client = getFusedLocationProviderClient(mContext);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8116)) {</span>
<span class="nc" id="L211">                        client.removeLocationUpdates(mLocationCallback);</span>
                    }
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8117)) {</span>
<span class="nc" id="L214">                        mGoogleApiClient.disconnect();</span>
                    }
                }
            }
<span class="nc" id="L218">        } catch (SecurityException e) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8112)) {</span>
                // permissions after the listener was registered
<span class="nc" id="L221">                Log.w(TAG, &quot;User may have denied location permission - &quot; + e);</span>
            }
<span class="nc" id="L223">        }</span>
<span class="nc" id="L224">    }</span>

    @Override
    public void onLocationChanged(Location location) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8119)) {</span>
            // stored location
<span class="nc" id="L230">            Application.setLastKnownLocation(location);</span>
        }
        // that was just generated above)
<span class="nc" id="L233">        Location lastLocation = Application.getLastKnownLocation(mContext, mGoogleApiClient);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8123)) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (lastLocation != null) {</span>
                // We need to copy the location, it case this object is reset in Application
<span class="nc" id="L237">                Location locationForListeners = new Location(&quot;for listeners&quot;);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8120)) {</span>
<span class="nc" id="L239">                    locationForListeners.set(lastLocation);</span>
                }
<span class="nc bnc" id="L241" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8122)) {</span>
                    {
<span class="nc" id="L243">                        long _loopCounter103 = 0;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                        for (Listener l : mListeners) {</span>
<span class="nc" id="L245">                            ListenerUtil.loopListener.listen(&quot;_loopCounter103&quot;, ++_loopCounter103);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8121)) {</span>
<span class="nc" id="L247">                                l.onLocationChanged(locationForListeners);</span>
                            }
<span class="nc" id="L249">                        }</span>
                    }
                }
            }
        }
<span class="nc" id="L254">    }</span>

    @Override
    public void onStatusChanged(String provider, int status, Bundle extras) {
<span class="nc" id="L258">    }</span>

    @Override
    public void onProviderEnabled(String provider) {
<span class="nc" id="L262">    }</span>

    @Override
    public void onProviderDisabled(String provider) {
<span class="nc" id="L266">    }</span>

    private void registerAllProviders() throws SecurityException {
        // Register the network and GPS provider (and anything else available)
<span class="nc" id="L270">        List&lt;String&gt; providers = mLocationManager.getProviders(true);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8125)) {</span>
            {
<span class="nc" id="L273">                long _loopCounter104 = 0;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                for (Iterator&lt;String&gt; i = providers.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L275">                    ListenerUtil.loopListener.listen(&quot;_loopCounter104&quot;, ++_loopCounter104);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8124)) {</span>
<span class="nc" id="L277">                        mLocationManager.requestLocationUpdates(i.next(), 0, 0, this);</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8126)) {</span>
<span class="nc" id="L283">            setupGooglePlayServices();</span>
        }
<span class="nc" id="L285">    }</span>

    /**
     * Request connection to Google Play Services for the fused location provider.
     * onConnected() will be called after connection.
     */
    private void setupGooglePlayServices() {
<span class="nc" id="L292">        GoogleApiAvailability api = GoogleApiAvailability.getInstance();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8129)) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            if (api.isGooglePlayServicesAvailable(mContext) == ConnectionResult.SUCCESS) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8127)) {</span>
<span class="nc" id="L296">                    mGoogleApiClient = new GoogleApiClient.Builder(mContext).addApi(LocationServices.API).addConnectionCallbacks(this).addOnConnectionFailedListener(this).build();</span>
                }
<span class="nc bnc" id="L298" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8128)) {</span>
<span class="nc" id="L299">                    mGoogleApiClient.connect();</span>
                }
            }
        }
<span class="nc" id="L303">    }</span>

    @Override
    public void onConnected(Bundle bundle) {
<span class="nc bnc" id="L307" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8130)) {</span>
<span class="nc" id="L308">            Log.d(TAG, &quot;Location Services connected&quot;);</span>
        }
        // Request location updates from the fused location provider
<span class="nc" id="L311">        FusedLocationProviderClient client = getFusedLocationProviderClient(mContext);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8133)) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            if (mLocationCallback == null) {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8132)) {</span>
<span class="nc" id="L315">                    mLocationCallback = new LocationCallback() {</span>

                        @Override
                        public void onLocationResult(LocationResult locationResult) {
<span class="nc bnc" id="L319" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8131)) {</span>
<span class="nc" id="L320">                                onLocationChanged(locationResult.getLastLocation());</span>
                            }
<span class="nc" id="L322">                        }</span>
                    };
                }
            }
        }
        try {
<span class="nc bnc" id="L328" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8135)) {</span>
<span class="nc" id="L329">                client.requestLocationUpdates(mLocationRequest, mLocationCallback, null);</span>
            }
<span class="nc" id="L331">        } catch (SecurityException e) {</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8134)) {</span>
                // in between log the warning and continue
<span class="nc" id="L334">                Log.w(TAG, &quot;User may have denied location permission - &quot; + e);</span>
            }
<span class="nc" id="L336">        }</span>
<span class="nc" id="L337">    }</span>

    @Override
    public void onConnectionSuspended(int i) {
<span class="nc" id="L341">    }</span>

    @Override
    public void onConnectionFailed(ConnectionResult connectionResult) {
<span class="nc" id="L345">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>