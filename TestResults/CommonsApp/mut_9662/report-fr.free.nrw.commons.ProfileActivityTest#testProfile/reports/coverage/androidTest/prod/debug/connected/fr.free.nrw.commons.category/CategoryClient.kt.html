<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CategoryClient.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.category</a> &gt; <span class="el_source">CategoryClient.kt</span></div><h1>CategoryClient.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.category

import io.reactivex.Single
import org.wikipedia.dataclient.mwapi.MwQueryResponse
import javax.inject.Inject
import javax.inject.Singleton

const val CATEGORY_PREFIX = &quot;Category:&quot;
const val SUB_CATEGORY_CONTINUATION_PREFIX = &quot;sub_category_&quot;
const val PARENT_CATEGORY_CONTINUATION_PREFIX = &quot;parent_category_&quot;
const val CATEGORY_UNCATEGORISED = &quot;uncategorised&quot;
const val CATEGORY_NEEDING_CATEGORIES = &quot;needing categories&quot;

/**
 * Category Client to handle custom calls to Commons MediaWiki APIs
 */
@Singleton
<span class="nc" id="L18">class CategoryClient @Inject constructor(private val categoryInterface: CategoryInterface) :</span>
<span class="nc" id="L19">    ContinuationClient&lt;MwQueryResponse, CategoryItem&gt;() {</span>

    /**
     * Searches for categories containing the specified string.
     *
     * @param filter    The string to be searched
     * @param itemLimit How many results are returned
     * @param offset    Starts returning items from the nth result. If offset is 9, the response starts with the 9th item of the search result
     * @return
     */
    @JvmOverloads
<span class="nc" id="L30">    fun searchCategories(filter: String?, itemLimit: Int, offset: Int = 0):</span>
            Single&lt;List&lt;CategoryItem&gt;&gt; {
<span class="nc" id="L32">        return responseMapper(categoryInterface.searchCategories(filter, itemLimit, offset))</span>
    }

    /**
     * Searches for categories starting with the specified string.
     *
     * @param prefix    The prefix to be searched
     * @param itemLimit How many results are returned
     * @param offset    Starts returning items from the nth result. If offset is 9, the response starts with the 9th item of the search result
     * @return
     */
    @JvmOverloads
<span class="nc" id="L44">    fun searchCategoriesForPrefix(prefix: String?, itemLimit: Int, offset: Int = 0):</span>
            Single&lt;List&lt;CategoryItem&gt;&gt; {
<span class="nc" id="L46">        return responseMapper(</span>
<span class="nc" id="L47">            categoryInterface.searchCategoriesForPrefix(prefix, itemLimit, offset)</span>
        )
    }

    /**
     * Fetches categories starting and ending with a specified name.
     *
     * @param startingCategoryName Name of the category to start
     * @param endingCategoryName Name of the category to end
     * @param itemLimit How many categories to return
     * @param offset offset
     * @return MwQueryResponse
     */
    @JvmOverloads
<span class="nc" id="L61">    fun getCategoriesByName(startingCategoryName: String?, endingCategoryName: String?,</span>
<span class="nc" id="L62">                            itemLimit: Int, offset: Int = 0): Single&lt;List&lt;CategoryItem&gt;&gt; {</span>
<span class="nc" id="L63">        return responseMapper(</span>
<span class="nc" id="L64">            categoryInterface.getCategoriesByName(startingCategoryName, endingCategoryName,</span>
<span class="nc" id="L65">                itemLimit, offset)</span>
        )
    }

    /**
     * The method takes categoryName as input and returns a List of Subcategories
     * It uses the generator query API to get the subcategories in a category, 500 at a time.
     *
     * @param categoryName Category name as defined on commons
     * @return Observable emitting the categories returned. If our search yielded &quot;Category:Test&quot;, &quot;Test&quot; is emitted.
     */
    fun getSubCategoryList(categoryName: String): Single&lt;List&lt;CategoryItem&gt;&gt; {
<span class="nc" id="L77">        return continuationRequest(SUB_CATEGORY_CONTINUATION_PREFIX, categoryName) {</span>
<span class="nc" id="L78">            categoryInterface.getSubCategoryList(</span>
<span class="nc" id="L79">                categoryName, it</span>
            )
        }
    }

    /**
     * The method takes categoryName as input and returns a List of parent categories
     * It uses the generator query API to get the parent categories of a category, 500 at a time.
     *
     * @param categoryName Category name as defined on commons
     * @return
     */
    fun getParentCategoryList(categoryName: String): Single&lt;List&lt;CategoryItem&gt;&gt; {
<span class="nc" id="L92">        return continuationRequest(PARENT_CATEGORY_CONTINUATION_PREFIX, categoryName) {</span>
<span class="nc" id="L93">            categoryInterface.getParentCategoryList(categoryName, it)</span>
        }
    }

    fun resetSubCategoryContinuation(category: String) {
<span class="nc" id="L98">        resetContinuation(SUB_CATEGORY_CONTINUATION_PREFIX, category)</span>
<span class="nc" id="L99">    }</span>

    fun resetParentCategoryContinuation(category: String) {
<span class="nc" id="L102">        resetContinuation(PARENT_CATEGORY_CONTINUATION_PREFIX, category)</span>
<span class="nc" id="L103">    }</span>

    override fun responseMapper(
        networkResult: Single&lt;MwQueryResponse&gt;,
        key: String?
    ): Single&lt;List&lt;CategoryItem&gt;&gt; {
<span class="nc" id="L109">        return networkResult</span>
<span class="nc" id="L110">            .map {</span>
<span class="nc" id="L111">                handleContinuationResponse(it.continuation(), key)</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">                it.query()?.pages() ?: emptyList()</span>
            }
<span class="nc" id="L114">            .map {</span>
<span class="nc" id="L115">                it.filter {</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">                    page -&gt; page.categoryInfo() == null || !page.categoryInfo().isHidden</span>
<span class="nc" id="L117">                }.map {</span>
<span class="nc" id="L118">                    CategoryItem(it.title().replace(CATEGORY_PREFIX, &quot;&quot;),</span>
<span class="nc" id="L119">                        it.description().toString(), it.thumbUrl().toString(), false)</span>
                }
            }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>