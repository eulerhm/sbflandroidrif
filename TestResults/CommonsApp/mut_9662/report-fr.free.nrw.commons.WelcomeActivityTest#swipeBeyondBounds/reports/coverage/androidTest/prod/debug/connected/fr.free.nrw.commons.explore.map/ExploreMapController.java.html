<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExploreMapController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.explore.map</a> &gt; <span class="el_source">ExploreMapController.java</span></div><h1>ExploreMapController.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.explore.map;

import static fr.free.nrw.commons.utils.LengthUtils.computeDistanceBetween;
import static fr.free.nrw.commons.utils.LengthUtils.formatDistanceBetween;
import android.content.Context;
import android.content.res.Resources;
import android.graphics.Bitmap;
import android.graphics.drawable.Drawable;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.vectordrawable.graphics.drawable.VectorDrawableCompat;
import com.bumptech.glide.Glide;
import com.bumptech.glide.request.RequestOptions;
import com.bumptech.glide.request.target.CustomTarget;
import com.bumptech.glide.request.transition.Transition;
import com.mapbox.mapboxsdk.annotations.IconFactory;
import com.mapbox.mapboxsdk.annotations.Marker;
import fr.free.nrw.commons.MapController;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.location.LatLng;
import fr.free.nrw.commons.nearby.NearbyBaseMarker;
import fr.free.nrw.commons.nearby.Place;
import fr.free.nrw.commons.utils.ImageUtils;
import fr.free.nrw.commons.utils.LocationUtils;
import fr.free.nrw.commons.utils.PlaceUtils;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.inject.Inject;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

public class ExploreMapController extends MapController {

    private final ExploreMapCalls exploreMapCalls;

    // Can be current and camera target on search this area button is used
    public LatLng latestSearchLocation;

    // current location of user
    public LatLng currentLocation;

    // Any last search radius
<span class="nc" id="L46">    public double latestSearchRadius = 0;</span>

    // Search radius of only searches around current location
<span class="nc" id="L49">    public double currentLocationSearchRadius = 0;</span>

    @Inject
<span class="nc" id="L52">    public ExploreMapController(ExploreMapCalls explorePlaces) {</span>
<span class="nc" id="L53">        this.exploreMapCalls = explorePlaces;</span>
<span class="nc" id="L54">    }</span>

    /**
     * Takes location as parameter and returns ExplorePlaces info that holds curLatLng, mediaList,
     * explorePlaceList and boundaryCoordinates
     *
     * @param curLatLng                     is current geolocation
     * @param searchLatLng                  is the location that we want to search around
     * @param checkingAroundCurrentLocation is a boolean flag. True if we want to check around
     *                                      current location, false if another location
     * @return explorePlacesInfo info that holds curLatLng, mediaList, explorePlaceList and
     * boundaryCoordinates
     */
    public ExplorePlacesInfo loadAttractionsFromLocation(LatLng curLatLng, LatLng searchLatLng, boolean checkingAroundCurrentLocation) {
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4277)) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (searchLatLng == null) {</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4276)) {</span>
<span class="nc" id="L71">                    Timber.d(&quot;Loading attractions explore map, but search is null&quot;);</span>
                }
<span class="nc" id="L73">                return null;</span>
            }
        }
<span class="nc" id="L76">        ExplorePlacesInfo explorePlacesInfo = new ExplorePlacesInfo();</span>
        try {
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4279)) {</span>
<span class="nc" id="L79">                explorePlacesInfo.curLatLng = curLatLng;</span>
            }
<span class="nc bnc" id="L81" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4280)) {</span>
<span class="nc" id="L82">                latestSearchLocation = searchLatLng;</span>
            }
<span class="nc" id="L84">            List&lt;Media&gt; mediaList = exploreMapCalls.callCommonsQuery(searchLatLng);</span>
<span class="nc" id="L85">            LatLng[] boundaryCoordinates = { // south</span>
<span class="nc" id="L86">            mediaList.get(0).getCoordinates(), // north</span>
<span class="nc" id="L87">            mediaList.get(0).getCoordinates(), // west</span>
<span class="nc" id="L88">            mediaList.get(0).getCoordinates(), // east, init with a random location</span>
<span class="nc" id="L89">            mediaList.get(0).getCoordinates() };</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4312)) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                if (searchLatLng != null) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4281)) {</span>
<span class="nc" id="L93">                        Timber.d(&quot;Sorting places by distance...&quot;);</span>
                    }
<span class="nc" id="L95">                    final Map&lt;Media, Double&gt; distances = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4311)) {</span>
                        {
<span class="nc" id="L98">                            long _loopCounter62 = 0;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                            for (Media media : mediaList) {</span>
<span class="nc" id="L100">                                ListenerUtil.loopListener.listen(&quot;_loopCounter62&quot;, ++_loopCounter62);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(4282)) {</span>
<span class="nc" id="L102">                                    distances.put(media, computeDistanceBetween(media.getCoordinates(), searchLatLng));</span>
                                }
<span class="nc bnc" id="L104" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(4289)) {</span>
                                    // Find boundaries with basic find max approach
<span class="nc bnc" id="L106" title="All 22 branches missed.">                                    if ((ListenerUtil.mutListener.listen(4287) ? (media.getCoordinates().getLatitude() &gt;= boundaryCoordinates[0].getLatitude()) : (ListenerUtil.mutListener.listen(4286) ? (media.getCoordinates().getLatitude() &lt;= boundaryCoordinates[0].getLatitude()) : (ListenerUtil.mutListener.listen(4285) ? (media.getCoordinates().getLatitude() &gt; boundaryCoordinates[0].getLatitude()) : (ListenerUtil.mutListener.listen(4284) ? (media.getCoordinates().getLatitude() != boundaryCoordinates[0].getLatitude()) : (ListenerUtil.mutListener.listen(4283) ? (media.getCoordinates().getLatitude() == boundaryCoordinates[0].getLatitude()) : (media.getCoordinates().getLatitude() &lt; boundaryCoordinates[0].getLatitude()))))))) {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4288)) {</span>
<span class="nc" id="L108">                                            boundaryCoordinates[0] = media.getCoordinates();</span>
                                        }
                                    }
                                }
<span class="nc bnc" id="L112" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(4296)) {</span>
<span class="nc bnc" id="L113" title="All 22 branches missed.">                                    if ((ListenerUtil.mutListener.listen(4294) ? (media.getCoordinates().getLatitude() &gt;= boundaryCoordinates[1].getLatitude()) : (ListenerUtil.mutListener.listen(4293) ? (media.getCoordinates().getLatitude() &lt;= boundaryCoordinates[1].getLatitude()) : (ListenerUtil.mutListener.listen(4292) ? (media.getCoordinates().getLatitude() &lt; boundaryCoordinates[1].getLatitude()) : (ListenerUtil.mutListener.listen(4291) ? (media.getCoordinates().getLatitude() != boundaryCoordinates[1].getLatitude()) : (ListenerUtil.mutListener.listen(4290) ? (media.getCoordinates().getLatitude() == boundaryCoordinates[1].getLatitude()) : (media.getCoordinates().getLatitude() &gt; boundaryCoordinates[1].getLatitude()))))))) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4295)) {</span>
<span class="nc" id="L115">                                            boundaryCoordinates[1] = media.getCoordinates();</span>
                                        }
                                    }
                                }
<span class="nc bnc" id="L119" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(4303)) {</span>
<span class="nc bnc" id="L120" title="All 22 branches missed.">                                    if ((ListenerUtil.mutListener.listen(4301) ? (media.getCoordinates().getLongitude() &gt;= boundaryCoordinates[2].getLongitude()) : (ListenerUtil.mutListener.listen(4300) ? (media.getCoordinates().getLongitude() &lt;= boundaryCoordinates[2].getLongitude()) : (ListenerUtil.mutListener.listen(4299) ? (media.getCoordinates().getLongitude() &gt; boundaryCoordinates[2].getLongitude()) : (ListenerUtil.mutListener.listen(4298) ? (media.getCoordinates().getLongitude() != boundaryCoordinates[2].getLongitude()) : (ListenerUtil.mutListener.listen(4297) ? (media.getCoordinates().getLongitude() == boundaryCoordinates[2].getLongitude()) : (media.getCoordinates().getLongitude() &lt; boundaryCoordinates[2].getLongitude()))))))) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4302)) {</span>
<span class="nc" id="L122">                                            boundaryCoordinates[2] = media.getCoordinates();</span>
                                        }
                                    }
                                }
<span class="nc bnc" id="L126" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(4310)) {</span>
<span class="nc bnc" id="L127" title="All 22 branches missed.">                                    if ((ListenerUtil.mutListener.listen(4308) ? (media.getCoordinates().getLongitude() &gt;= boundaryCoordinates[3].getLongitude()) : (ListenerUtil.mutListener.listen(4307) ? (media.getCoordinates().getLongitude() &lt;= boundaryCoordinates[3].getLongitude()) : (ListenerUtil.mutListener.listen(4306) ? (media.getCoordinates().getLongitude() &lt; boundaryCoordinates[3].getLongitude()) : (ListenerUtil.mutListener.listen(4305) ? (media.getCoordinates().getLongitude() != boundaryCoordinates[3].getLongitude()) : (ListenerUtil.mutListener.listen(4304) ? (media.getCoordinates().getLongitude() == boundaryCoordinates[3].getLongitude()) : (media.getCoordinates().getLongitude() &gt; boundaryCoordinates[3].getLongitude()))))))) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4309)) {</span>
<span class="nc" id="L129">                                            boundaryCoordinates[3] = media.getCoordinates();</span>
                                        }
                                    }
                                }
<span class="nc" id="L133">                            }</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4313)) {</span>
<span class="nc" id="L139">                explorePlacesInfo.mediaList = mediaList;</span>
            }
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4314)) {</span>
<span class="nc" id="L142">                explorePlacesInfo.explorePlaceList = PlaceUtils.mediaToExplorePlace(mediaList);</span>
            }
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4315)) {</span>
<span class="nc" id="L145">                explorePlacesInfo.boundaryCoordinates = boundaryCoordinates;</span>
            }
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4323)) {</span>
                {
<span class="nc" id="L149">                    long _loopCounter63 = 0;</span>
                    // Sets latestSearchRadius to maximum distance among boundaries and search location
<span class="nc bnc" id="L151" title="All 2 branches missed.">                    for (LatLng bound : boundaryCoordinates) {</span>
<span class="nc" id="L152">                        ListenerUtil.loopListener.listen(&quot;_loopCounter63&quot;, ++_loopCounter63);</span>
<span class="nc" id="L153">                        double distance = LocationUtils.commonsLatLngToMapBoxLatLng(bound).distanceTo(LocationUtils.commonsLatLngToMapBoxLatLng(latestSearchLocation));</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(4322)) {</span>
<span class="nc bnc" id="L155" title="All 22 branches missed.">                            if ((ListenerUtil.mutListener.listen(4320) ? (distance &gt;= latestSearchRadius) : (ListenerUtil.mutListener.listen(4319) ? (distance &lt;= latestSearchRadius) : (ListenerUtil.mutListener.listen(4318) ? (distance &lt; latestSearchRadius) : (ListenerUtil.mutListener.listen(4317) ? (distance != latestSearchRadius) : (ListenerUtil.mutListener.listen(4316) ? (distance == latestSearchRadius) : (distance &gt; latestSearchRadius))))))) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(4321)) {</span>
<span class="nc" id="L157">                                    latestSearchRadius = distance;</span>
                                }
                            }
                        }
                    }
                }
            }
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4326)) {</span>
                // Our radius searched around us, will be used to understand when user search their own location, we will follow them
<span class="nc bnc" id="L166" title="All 2 branches missed.">                if (checkingAroundCurrentLocation) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4324)) {</span>
<span class="nc" id="L168">                        currentLocationSearchRadius = latestSearchRadius;</span>
                    }
<span class="nc bnc" id="L170" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4325)) {</span>
<span class="nc" id="L171">                        currentLocation = curLatLng;</span>
                    }
                }
            }
<span class="nc" id="L175">        } catch (Exception e) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4278)) {</span>
<span class="nc" id="L177">                e.printStackTrace();</span>
            }
<span class="nc" id="L179">        }</span>
<span class="nc" id="L180">        return explorePlacesInfo;</span>
    }

    /**
     * Loads attractions from location for map view, we need to return places in Place data type
     *
     * @return baseMarkerOptions list that holds nearby places with their icons
     */
    public static List&lt;NearbyBaseMarker&gt; loadAttractionsFromLocationToBaseMarkerOptions(LatLng curLatLng, final List&lt;Place&gt; placeList, Context context, NearbyBaseMarkerThumbCallback callback, Marker selectedMarker, ExplorePlacesInfo explorePlacesInfo) {
<span class="nc" id="L189">        List&lt;NearbyBaseMarker&gt; baseMarkerOptions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4327)) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (placeList == null) {</span>
<span class="nc" id="L192">                return baseMarkerOptions;</span>
            }
        }
<span class="nc" id="L195">        VectorDrawableCompat vectorDrawable = null;</span>
        try {
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4328)) {</span>
<span class="nc" id="L198">                vectorDrawable = VectorDrawableCompat.create(context.getResources(), R.drawable.ic_custom_map_marker, context.getTheme());</span>
            }
<span class="nc" id="L200">        } catch (Resources.NotFoundException e) {</span>
<span class="nc" id="L201">        }</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4344)) {</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (vectorDrawable != null) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4343)) {</span>
                    {
<span class="nc" id="L206">                        long _loopCounter64 = 0;</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                        for (Place explorePlace : placeList) {</span>
<span class="nc" id="L208">                            ListenerUtil.loopListener.listen(&quot;_loopCounter64&quot;, ++_loopCounter64);</span>
<span class="nc" id="L209">                            final NearbyBaseMarker nearbyBaseMarker = new NearbyBaseMarker();</span>
<span class="nc" id="L210">                            String distance = formatDistanceBetween(curLatLng, explorePlace.location);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(4329)) {</span>
<span class="nc" id="L212">                                explorePlace.setDistance(distance);</span>
                            }
<span class="nc bnc" id="L214" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(4330)) {</span>
<span class="nc" id="L215">                                nearbyBaseMarker.title(explorePlace.name.substring(5, explorePlace.name.lastIndexOf(&quot;.&quot;)));</span>
                            }
<span class="nc bnc" id="L217" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(4331)) {</span>
<span class="nc" id="L218">                                nearbyBaseMarker.position(new com.mapbox.mapboxsdk.geometry.LatLng(explorePlace.location.getLatitude(), explorePlace.location.getLongitude()));</span>
                            }
<span class="nc bnc" id="L220" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(4332)) {</span>
<span class="nc" id="L221">                                nearbyBaseMarker.place(explorePlace);</span>
                            }
<span class="nc bnc" id="L223" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(4342)) {</span>
<span class="nc" id="L224">                                Glide.with(context).asBitmap().load(explorePlace.getThumb()).placeholder(R.drawable.image_placeholder_96).apply(new RequestOptions().override(96, 96).centerCrop()).into(new CustomTarget&lt;Bitmap&gt;() {</span>

                                    // We add icons to markers when bitmaps are ready
                                    @Override
                                    public void onResourceReady(@NonNull Bitmap resource, @Nullable Transition&lt;? super Bitmap&gt; transition) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4333)) {</span>
<span class="nc" id="L230">                                            nearbyBaseMarker.setIcon(IconFactory.getInstance(context).fromBitmap(ImageUtils.addRedBorder(resource, 6, context)));</span>
                                        }
<span class="nc bnc" id="L232" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4334)) {</span>
<span class="nc" id="L233">                                            baseMarkerOptions.add(nearbyBaseMarker);</span>
                                        }
<span class="nc bnc" id="L235" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4336)) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                                            if (baseMarkerOptions.size() == placeList.size()) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(4335)) {</span>
                                                    // if true, we added all markers to list and can trigger thumbs ready callback
<span class="nc" id="L239">                                                    callback.onNearbyBaseMarkerThumbsReady(baseMarkerOptions, explorePlacesInfo, selectedMarker);</span>
                                                }
                                            }
                                        }
<span class="nc" id="L243">                                    }</span>

                                    @Override
                                    public void onLoadCleared(@Nullable Drawable placeholder) {
<span class="nc" id="L247">                                    }</span>

                                    // We add thumbnail icon for images that couldn't be loaded
                                    @Override
                                    public void onLoadFailed(@Nullable final Drawable errorDrawable) {
<span class="nc bnc" id="L252" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4337)) {</span>
<span class="nc" id="L253">                                            super.onLoadFailed(errorDrawable);</span>
                                        }
<span class="nc bnc" id="L255" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4338)) {</span>
<span class="nc" id="L256">                                            nearbyBaseMarker.setIcon(IconFactory.getInstance(context).fromResource(R.drawable.image_placeholder_96));</span>
                                        }
<span class="nc bnc" id="L258" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4339)) {</span>
<span class="nc" id="L259">                                            baseMarkerOptions.add(nearbyBaseMarker);</span>
                                        }
<span class="nc bnc" id="L261" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(4341)) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                                            if (baseMarkerOptions.size() == placeList.size()) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(4340)) {</span>
                                                    // if true, we added all markers to list and can trigger thumbs ready callback
<span class="nc" id="L265">                                                    callback.onNearbyBaseMarkerThumbsReady(baseMarkerOptions, explorePlacesInfo, selectedMarker);</span>
                                                }
                                            }
                                        }
<span class="nc" id="L269">                                    }</span>
                                });
                            }
<span class="nc" id="L272">                        }</span>
                    }
                }
            }
        }
<span class="nc" id="L277">        return baseMarkerOptions;</span>
    }

    interface NearbyBaseMarkerThumbCallback {

        // Callback to notify thumbnails of explore markers are added as icons and ready
        void onNearbyBaseMarkerThumbsReady(List&lt;NearbyBaseMarker&gt; baseMarkers, ExplorePlacesInfo explorePlacesInfo, Marker selectedMarker);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>