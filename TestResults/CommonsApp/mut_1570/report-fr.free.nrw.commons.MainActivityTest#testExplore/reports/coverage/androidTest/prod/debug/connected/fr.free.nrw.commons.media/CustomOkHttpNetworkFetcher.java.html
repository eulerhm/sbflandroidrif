<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomOkHttpNetworkFetcher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.media</a> &gt; <span class="el_source">CustomOkHttpNetworkFetcher.java</span></div><h1>CustomOkHttpNetworkFetcher.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.media;

import android.net.Uri;
import android.os.Looper;
import android.os.SystemClock;
import androidx.annotation.Nullable;
import com.facebook.imagepipeline.common.BytesRange;
import com.facebook.imagepipeline.image.EncodedImage;
import com.facebook.imagepipeline.producers.BaseNetworkFetcher;
import com.facebook.imagepipeline.producers.BaseProducerContextCallbacks;
import com.facebook.imagepipeline.producers.Consumer;
import com.facebook.imagepipeline.producers.FetchState;
import com.facebook.imagepipeline.producers.NetworkFetcher;
import com.facebook.imagepipeline.producers.ProducerContext;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.Executor;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;
import okhttp3.CacheControl;
import okhttp3.Call;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import okhttp3.ResponseBody;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

// https://github.com/facebook/fresco/blob/master/imagepipeline-backends/imagepipeline-okhttp3/src/main/java/com/facebook/imagepipeline/backends/okhttp3/OkHttpNetworkFetcher.java
@Singleton
public class CustomOkHttpNetworkFetcher extends BaseNetworkFetcher&lt;CustomOkHttpNetworkFetcher.OkHttpNetworkFetchState&gt; {

    private static final String QUEUE_TIME = &quot;queue_time&quot;;

    private static final String FETCH_TIME = &quot;fetch_time&quot;;

    private static final String TOTAL_TIME = &quot;total_time&quot;;

    private static final String IMAGE_SIZE = &quot;image_size&quot;;

    private final Call.Factory mCallFactory;

    @Nullable
    private final CacheControl mCacheControl;

    private final Executor mCancellationExecutor;

    private final JsonKvStore defaultKvStore;

    /**
     * @param okHttpClient client to use
     */
    @Inject
    public CustomOkHttpNetworkFetcher(final OkHttpClient okHttpClient, @Named(&quot;default_preferences&quot;) final JsonKvStore defaultKvStore) {
<span class="fc" id="L59">        this(okHttpClient, okHttpClient.dispatcher().executorService(), defaultKvStore);</span>
<span class="fc" id="L60">    }</span>

    /**
     * @param callFactory          custom {@link Call.Factory} for fetching image from the network
     * @param cancellationExecutor executor on which fetching cancellation is performed if
     *                             cancellation is requested from the UI Thread
     */
    public CustomOkHttpNetworkFetcher(final Call.Factory callFactory, final Executor cancellationExecutor, final JsonKvStore defaultKvStore) {
<span class="fc" id="L68">        this(callFactory, cancellationExecutor, defaultKvStore, true);</span>
<span class="fc" id="L69">    }</span>

    /**
     * @param callFactory          custom {@link Call.Factory} for fetching image from the network
     * @param cancellationExecutor executor on which fetching cancellation is performed if
     *                             cancellation is requested from the UI Thread
     * @param disableOkHttpCache   true if network requests should not be cached by OkHttp
     */
<span class="fc" id="L77">    public CustomOkHttpNetworkFetcher(final Call.Factory callFactory, final Executor cancellationExecutor, final JsonKvStore defaultKvStore, final boolean disableOkHttpCache) {</span>
<span class="fc" id="L78">        this.defaultKvStore = defaultKvStore;</span>
<span class="fc" id="L79">        mCallFactory = callFactory;</span>
<span class="fc" id="L80">        mCancellationExecutor = cancellationExecutor;</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        mCacheControl = disableOkHttpCache ? new CacheControl.Builder().noStore().build() : null;</span>
<span class="fc" id="L82">    }</span>

    @Override
    public OkHttpNetworkFetchState createFetchState(final Consumer&lt;EncodedImage&gt; consumer, final ProducerContext context) {
<span class="fc" id="L86">        return new OkHttpNetworkFetchState(consumer, context);</span>
    }

    @Override
    public void fetch(final OkHttpNetworkFetchState fetchState, final NetworkFetcher.Callback callback) {
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9250)) {</span>
<span class="fc" id="L92">            fetchState.submitTime = SystemClock.elapsedRealtime();</span>
        }
<span class="fc" id="L94">        final Uri uri = fetchState.getUri();</span>
        try {
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9254)) {</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">                if (defaultKvStore.getBoolean(CommonsApplication.IS_LIMITED_CONNECTION_MODE_ENABLED, false)) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9252)) {</span>
<span class="nc" id="L99">                        Timber.d(&quot;Skipping loading of image as limited connection mode is enabled&quot;);</span>
                    }
<span class="nc bnc" id="L101" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9253)) {</span>
<span class="nc" id="L102">                        callback.onFailure(new Exception(&quot;Failing image request as limited connection mode is enabled&quot;));</span>
                    }
<span class="nc" id="L104">                    return;</span>
                }
            }
<span class="fc" id="L107">            final Request.Builder requestBuilder = new Request.Builder().url(uri.toString()).get();</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9256)) {</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">                if (mCacheControl != null) {</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9255)) {</span>
<span class="fc" id="L111">                        requestBuilder.cacheControl(mCacheControl);</span>
                    }
                }
            }
<span class="fc" id="L115">            final BytesRange bytesRange = fetchState.getContext().getImageRequest().getBytesRange();</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9258)) {</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">                if (bytesRange != null) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9257)) {</span>
<span class="nc" id="L119">                        requestBuilder.addHeader(&quot;Range&quot;, bytesRange.toHttpRangeHeaderValue());</span>
                    }
                }
            }
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9259)) {</span>
<span class="fc" id="L124">                fetchWithRequest(fetchState, callback, requestBuilder.build());</span>
            }
<span class="nc" id="L126">        } catch (final Exception e) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9251)) {</span>
                // handle error while creating the request
<span class="nc" id="L129">                callback.onFailure(e);</span>
            }
<span class="fc" id="L131">        }</span>
<span class="fc" id="L132">    }</span>

    @Override
    public void onFetchCompletion(final OkHttpNetworkFetchState fetchState, final int byteSize) {
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9260)) {</span>
<span class="nc" id="L137">            fetchState.fetchCompleteTime = SystemClock.elapsedRealtime();</span>
        }
<span class="nc" id="L139">    }</span>

    @Override
    public Map&lt;String, String&gt; getExtraMap(final OkHttpNetworkFetchState fetchState, final int byteSize) {
<span class="nc" id="L143">        final Map&lt;String, String&gt; extraMap = new HashMap&lt;&gt;(4);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9265)) {</span>
<span class="nc bnc" id="L145" title="All 8 branches missed.">            extraMap.put(QUEUE_TIME, Long.toString((ListenerUtil.mutListener.listen(9264) ? (fetchState.responseTime % fetchState.submitTime) : (ListenerUtil.mutListener.listen(9263) ? (fetchState.responseTime / fetchState.submitTime) : (ListenerUtil.mutListener.listen(9262) ? (fetchState.responseTime * fetchState.submitTime) : (ListenerUtil.mutListener.listen(9261) ? (fetchState.responseTime + fetchState.submitTime) : (fetchState.responseTime - fetchState.submitTime)))))));</span>
        }
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9270)) {</span>
<span class="nc bnc" id="L148" title="All 8 branches missed.">            extraMap.put(FETCH_TIME, Long.toString((ListenerUtil.mutListener.listen(9269) ? (fetchState.fetchCompleteTime % fetchState.responseTime) : (ListenerUtil.mutListener.listen(9268) ? (fetchState.fetchCompleteTime / fetchState.responseTime) : (ListenerUtil.mutListener.listen(9267) ? (fetchState.fetchCompleteTime * fetchState.responseTime) : (ListenerUtil.mutListener.listen(9266) ? (fetchState.fetchCompleteTime + fetchState.responseTime) : (fetchState.fetchCompleteTime - fetchState.responseTime)))))));</span>
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9275)) {</span>
<span class="nc bnc" id="L151" title="All 8 branches missed.">            extraMap.put(TOTAL_TIME, Long.toString((ListenerUtil.mutListener.listen(9274) ? (fetchState.fetchCompleteTime % fetchState.submitTime) : (ListenerUtil.mutListener.listen(9273) ? (fetchState.fetchCompleteTime / fetchState.submitTime) : (ListenerUtil.mutListener.listen(9272) ? (fetchState.fetchCompleteTime * fetchState.submitTime) : (ListenerUtil.mutListener.listen(9271) ? (fetchState.fetchCompleteTime + fetchState.submitTime) : (fetchState.fetchCompleteTime - fetchState.submitTime)))))));</span>
        }
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9276)) {</span>
<span class="nc" id="L154">            extraMap.put(IMAGE_SIZE, Integer.toString(byteSize));</span>
        }
<span class="nc" id="L156">        return extraMap;</span>
    }

    protected void fetchWithRequest(final OkHttpNetworkFetchState fetchState, final NetworkFetcher.Callback callback, final Request request) {
<span class="fc" id="L160">        final Call call = mCallFactory.newCall(request);</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9278)) {</span>
<span class="fc" id="L162">            fetchState.getContext().addCallbacks(new BaseProducerContextCallbacks() {</span>

                @Override
                public void onCancellationRequested() {
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9277)) {</span>
<span class="fc" id="L167">                        onFetchCancellationRequested(call);</span>
                    }
<span class="fc" id="L169">                }</span>
            });
        }
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9281)) {</span>
<span class="fc" id="L173">            call.enqueue(new okhttp3.Callback() {</span>

                @Override
                public void onResponse(final Call call, final Response response) {
<span class="nc bnc" id="L177" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9279)) {</span>
<span class="nc" id="L178">                        onFetchResponse(fetchState, call, response, callback);</span>
                    }
<span class="nc" id="L180">                }</span>

                @Override
                public void onFailure(final Call call, final IOException e) {
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9280)) {</span>
<span class="fc" id="L185">                        handleException(call, e, callback);</span>
                    }
<span class="fc" id="L187">                }</span>
            });
        }
<span class="fc" id="L190">    }</span>

    private void onFetchCancellationRequested(final Call call) {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9284)) {</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">            if (Looper.myLooper() != Looper.getMainLooper()) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9283)) {</span>
<span class="nc" id="L196">                    call.cancel();</span>
                }
            } else {
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9282)) {</span>
<span class="fc" id="L200">                    mCancellationExecutor.execute(call::cancel);</span>
                }
            }
        }
<span class="fc" id="L204">    }</span>

    private void onFetchResponse(final OkHttpNetworkFetchState fetchState, final Call call, final Response response, final NetworkFetcher.Callback callback) {
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9285)) {</span>
<span class="nc" id="L208">            fetchState.responseTime = SystemClock.elapsedRealtime();</span>
        }
<span class="nc" id="L210">        try (final ResponseBody body = response.body()) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9288)) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (!response.isSuccessful()) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9287)) {</span>
<span class="nc" id="L214">                        handleException(call, new IOException(&quot;Unexpected HTTP code &quot; + response), callback);</span>
                    }
<span class="nc" id="L216">                    return;</span>
                }
            }
<span class="nc" id="L219">            final BytesRange responseRange = BytesRange.fromContentRangeHeader(response.header(&quot;Content-Range&quot;));</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9293)) {</span>
<span class="nc bnc" id="L221" title="All 26 branches missed.">                if ((ListenerUtil.mutListener.listen(9290) ? (responseRange != null || !((ListenerUtil.mutListener.listen(9289) ? (responseRange.from == 0 || responseRange.to == BytesRange.TO_END_OF_CONTENT) : (responseRange.from == 0 &amp;&amp; responseRange.to == BytesRange.TO_END_OF_CONTENT)))) : (responseRange != null &amp;&amp; !((ListenerUtil.mutListener.listen(9289) ? (responseRange.from == 0 || responseRange.to == BytesRange.TO_END_OF_CONTENT) : (responseRange.from == 0 &amp;&amp; responseRange.to == BytesRange.TO_END_OF_CONTENT)))))) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9291)) {</span>
                        // Only treat as a partial image if the range is not all of the content
<span class="nc" id="L224">                        fetchState.setResponseBytesRange(responseRange);</span>
                    }
<span class="nc bnc" id="L226" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9292)) {</span>
<span class="nc" id="L227">                        fetchState.setOnNewResultStatusFlags(Consumer.IS_PARTIAL_RESULT);</span>
                    }
                }
            }
<span class="nc" id="L231">            long contentLength = body.contentLength();</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9300)) {</span>
<span class="nc bnc" id="L233" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(9298) ? (contentLength &gt;= 0) : (ListenerUtil.mutListener.listen(9297) ? (contentLength &lt;= 0) : (ListenerUtil.mutListener.listen(9296) ? (contentLength &gt; 0) : (ListenerUtil.mutListener.listen(9295) ? (contentLength != 0) : (ListenerUtil.mutListener.listen(9294) ? (contentLength == 0) : (contentLength &lt; 0))))))) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(9299)) {</span>
<span class="nc" id="L235">                        contentLength = 0;</span>
                    }
                }
            }
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9301)) {</span>
<span class="nc" id="L240">                callback.onResponse(body.byteStream(), (int) contentLength);</span>
            }
<span class="nc bnc" id="L242" title="All 2 branches missed.">        } catch (final Exception e) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(9286)) {</span>
<span class="nc" id="L244">                handleException(call, e, callback);</span>
            }
<span class="nc" id="L246">        }</span>
<span class="nc" id="L247">    }</span>

    /**
     * Handles exceptions.
     *
     * &lt;p&gt;OkHttp notifies callers of cancellations via an IOException. If IOException is caught
     * after request cancellation, then the exception is interpreted as successful cancellation and
     * onCancellation is called. Otherwise onFailure is called.
     */
    private void handleException(final Call call, final Exception e, final Callback callback) {
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(9304)) {</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">            if (call.isCanceled()) {</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9303)) {</span>
<span class="fc" id="L260">                    callback.onCancellation();</span>
                }
            } else {
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(9302)) {</span>
<span class="nc" id="L264">                    callback.onFailure(e);</span>
                }
            }
        }
<span class="fc" id="L268">    }</span>

    public static class OkHttpNetworkFetchState extends FetchState {

        public long submitTime;

        public long responseTime;

        public long fetchCompleteTime;

        public OkHttpNetworkFetchState(final Consumer&lt;EncodedImage&gt; consumer, final ProducerContext producerContext) {
<span class="fc" id="L279">            super(consumer, producerContext);</span>
<span class="fc" id="L280">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>