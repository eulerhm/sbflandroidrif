<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DepictEditHelper.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.upload.depicts</a> &gt; <span class="el_source">DepictEditHelper.kt</span></div><h1>DepictEditHelper.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.upload.depicts

import android.content.Context
import android.content.Intent
import android.net.Uri
import fr.free.nrw.commons.BuildConfig
import fr.free.nrw.commons.Media
import fr.free.nrw.commons.R
import fr.free.nrw.commons.notification.NotificationHelper
import fr.free.nrw.commons.utils.ViewUtilWrapper
import fr.free.nrw.commons.wikidata.WikidataEditService
import io.reactivex.Observable
import timber.log.Timber
import javax.inject.Inject

<span class="nc" id="L16">class DepictEditHelper @Inject constructor (notificationHelper: NotificationHelper,</span>
                                            wikidataEditService: WikidataEditService,
                                            viewUtilWrapper: ViewUtilWrapper) {

    /**
     * Class for making post operations
     */
    @Inject
<span class="nc bnc" id="L24" title="All 2 branches missed.">    lateinit var wikidataEditService: WikidataEditService</span>

    /**
     * Class for creating notification
     */
    @Inject
<span class="nc bnc" id="L30" title="All 2 branches missed.">    lateinit var notificationHelper: NotificationHelper</span>

    /**
     * Class for showing toast
     */
    @Inject
<span class="nc bnc" id="L36" title="All 2 branches missed.">    lateinit var viewUtilWrapper: ViewUtilWrapper</span>

    /**
     * Public interface to edit depictions
     *
     * @param context context
     * @param media media
     * @param depictions selected depictions to be added ex: [&quot;Q12&quot;, &quot;Q234&quot;]
     * @return Single&lt;Boolean&gt;
     */
    fun makeDepictionEdit(
        context: Context,
        media: Media,
        depictions: List&lt;String&gt;
    ): Observable&lt;Boolean&gt; {
<span class="nc" id="L51">        viewUtilWrapper.showShortToast(</span>
<span class="nc" id="L52">            context,</span>
<span class="nc" id="L53">            context.getString(R.string.depictions_edit_helper_make_edit_toast)</span>
        )
<span class="nc" id="L55">        return addDepiction(media, depictions)</span>
<span class="nc" id="L56">            .flatMap { result: Boolean -&gt;</span>
<span class="nc" id="L57">                Observable.just(</span>
<span class="nc" id="L58">                    showDepictionEditNotification(context, media, result)</span>
                )
            }
    }

    /**
     * Appends new depictions
     *
     * @param media media
     * @param depictions to be added
     * @return Observable&lt;Boolean&gt;
     */
     private fun addDepiction(media: Media, depictions: List&lt;String&gt;): Observable&lt;Boolean&gt; {
<span class="nc" id="L71">        Timber.d(&quot;thread is adding depiction %s&quot;, Thread.currentThread().name)</span>
<span class="nc" id="L72">        return wikidataEditService.updateDepictsProperty(media.filename, depictions)</span>
    }

    /**
     * Helps to create notification about condition of editing depictions
     *
     * @param context context
     * @param media media
     * @param result response of result
     * @return Single&lt;Boolean&gt;
     */
    private fun showDepictionEditNotification(
        context: Context,
        media: Media,
        result: Boolean
    ): Boolean {
        val message: String
<span class="nc" id="L89">        var title = context.getString(R.string.depictions_edit_helper_show_edit_title)</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (result) {</span>
<span class="nc" id="L91">            title += &quot;: &quot; + context.getString(R.string.category_edit_helper_show_edit_title_success)</span>
<span class="nc" id="L92">            val depictsInMessage = StringBuilder()</span>
<span class="nc" id="L93">            val depictIdList = media.depictionIds</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            for (depiction in depictIdList) {</span>
<span class="nc" id="L95">                depictsInMessage.append(depiction)</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                if (depiction == depictIdList[depictIdList.size - 1]) {</span>
<span class="nc" id="L97">                    continue</span>
                }
<span class="nc" id="L99">                depictsInMessage.append(&quot;,&quot;)</span>
            }
<span class="nc" id="L101">            message = context.resources.getQuantityString(</span>
<span class="nc" id="L102">                R.plurals.depictions_edit_helper_show_edit_message_if,</span>
<span class="nc" id="L103">                depictIdList.size,</span>
<span class="nc" id="L104">                depictsInMessage.toString()</span>
            )
        } else {
<span class="nc" id="L107">            title += &quot;: &quot; + context.getString(R.string.depictions_edit_helper_show_edit_title)</span>
<span class="nc" id="L108">            message = context.getString(R.string.depictions_edit_helper_edit_message_else)</span>
        }
<span class="nc" id="L110">        val urlForFile = BuildConfig.COMMONS_URL + &quot;/wiki/&quot; + media.filename</span>
<span class="nc" id="L111">        val browserIntent = Intent(Intent.ACTION_VIEW, Uri.parse(urlForFile))</span>
<span class="nc" id="L112">        notificationHelper.showNotification(</span>
<span class="nc" id="L113">            context,</span>
<span class="nc" id="L114">            title,</span>
<span class="nc" id="L115">            message,</span>
<span class="nc" id="L116">            NotificationHelper.NOTIFICATION_EDIT_DEPICTIONS,</span>
<span class="nc" id="L117">            browserIntent</span>
        )
<span class="nc" id="L119">        return result</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>