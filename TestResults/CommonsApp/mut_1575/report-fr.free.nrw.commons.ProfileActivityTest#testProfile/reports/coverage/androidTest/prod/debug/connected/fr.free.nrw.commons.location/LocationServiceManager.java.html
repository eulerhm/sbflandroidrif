<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocationServiceManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.location</a> &gt; <span class="el_source">LocationServiceManager.java</span></div><h1>LocationServiceManager.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.location;

import static com.mapbox.mapboxsdk.Mapbox.getApplicationContext;
import android.Manifest.permission;
import android.app.Activity;
import android.content.Context;
import android.content.pm.PackageManager;
import android.location.Location;
import android.location.LocationListener;
import android.location.LocationManager;
import android.os.Bundle;
import androidx.core.app.ActivityCompat;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.concurrent.CopyOnWriteArrayList;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

public class LocationServiceManager implements LocationListener {

    // Maybe these values can be improved for efficiency
    private static final long MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS = 10 * 100;

    private static final long MIN_LOCATION_UPDATE_REQUEST_DISTANCE_IN_METERS = 1;

    private LocationManager locationManager;

    private Location lastLocation;

    // private Location lastLocationDuplicate; // Will be used for nearby card view on contributions activity
<span class="fc" id="L32">    private final List&lt;LocationUpdateListener&gt; locationListeners = new CopyOnWriteArrayList&lt;&gt;();</span>

<span class="fc" id="L34">    private boolean isLocationManagerRegistered = false;</span>

<span class="fc" id="L36">    private Set&lt;Activity&gt; locationExplanationDisplayed = new HashSet&lt;&gt;();</span>

    /**
     * Constructs a new instance of LocationServiceManager.
     *
     * @param context the context
     */
<span class="fc" id="L43">    public LocationServiceManager(Context context) {</span>
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1562)) {</span>
<span class="fc" id="L45">            this.locationManager = (LocationManager) context.getSystemService(Context.LOCATION_SERVICE);</span>
        }
<span class="fc" id="L47">    }</span>

    public LatLng getLastLocation() {
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1565)) {</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">            if (lastLocation == null) {</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1563)) {</span>
<span class="fc" id="L53">                    lastLocation = getLastKnownLocation();</span>
                }
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1564)) {</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">                    if (lastLocation != null) {</span>
<span class="nc" id="L57">                        return LatLng.from(lastLocation);</span>
                    } else {
<span class="fc" id="L59">                        return null;</span>
                    }
                }
            }
        }
<span class="fc" id="L64">        return LatLng.from(lastLocation);</span>
    }

    // INJECTED-FAULT (IF-CC): Inject a falt that skips location from being considered
    private Location getLastKnownLocation() {
<span class="fc" id="L69">        List&lt;String&gt; providers = locationManager.getProviders(true);</span>
<span class="fc" id="L70">        Location bestLocation = null;</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1578)) {</span>
            {
<span class="fc" id="L73">                long _loopCounter19 = 0;</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">                for (String provider : providers) {</span>
<span class="fc" id="L75">                    ListenerUtil.loopListener.listen(&quot;_loopCounter19&quot;, ++_loopCounter19);</span>
<span class="fc" id="L76">                    Location l = null;</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1568)) {</span>
<span class="pc bpc" id="L78" title="7 of 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(1566) ? (ActivityCompat.checkSelfPermission(getApplicationContext(), permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED || ActivityCompat.checkSelfPermission(getApplicationContext(), permission.ACCESS_COARSE_LOCATION) == PackageManager.PERMISSION_GRANTED) : (ActivityCompat.checkSelfPermission(getApplicationContext(), permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED &amp;&amp; ActivityCompat.checkSelfPermission(getApplicationContext(), permission.ACCESS_COARSE_LOCATION) == PackageManager.PERMISSION_GRANTED))) {</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(1567)) {</span>
<span class="fc" id="L80">                                l = locationManager.getLastKnownLocation(provider);</span>
                            }
                        }
                    }
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1569)) {</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">                        if (l != null) {</span>
<span class="fc" id="L86">                            continue;</span>
                        }
                    }
<span class="nc bnc" id="L89" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1577)) {</span>
<span class="nc bnc" id="L90" title="All 50 branches missed.">                        if ((ListenerUtil.mutListener.listen(1575) ? (bestLocation == null &amp;&amp; (ListenerUtil.mutListener.listen(1574) ? (l.getAccuracy() &gt;= bestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1573) ? (l.getAccuracy() &lt;= bestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1572) ? (l.getAccuracy() &gt; bestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1571) ? (l.getAccuracy() != bestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1570) ? (l.getAccuracy() == bestLocation.getAccuracy()) : (l.getAccuracy() &lt; bestLocation.getAccuracy()))))))) : (bestLocation == null || (ListenerUtil.mutListener.listen(1574) ? (l.getAccuracy() &gt;= bestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1573) ? (l.getAccuracy() &lt;= bestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1572) ? (l.getAccuracy() &gt; bestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1571) ? (l.getAccuracy() != bestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1570) ? (l.getAccuracy() == bestLocation.getAccuracy()) : (l.getAccuracy() &lt; bestLocation.getAccuracy()))))))))) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(1576)) {</span>
<span class="nc" id="L92">                                bestLocation = l;</span>
                            }
                        }
                    }
<span class="nc" id="L96">                }</span>
            }
        }
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1579)) {</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">            if (bestLocation == null) {</span>
<span class="fc" id="L101">                return null;</span>
            }
        }
<span class="nc" id="L104">        return bestLocation;</span>
    }

    /**
     * Registers a LocationManager to listen for current location.
     */
    public void registerLocationManager() {
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1582)) {</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">            if (!isLocationManagerRegistered) {</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1581)) {</span>
<span class="pc bpc" id="L114" title="7 of 10 branches missed.">                    isLocationManagerRegistered = (ListenerUtil.mutListener.listen(1580) ? (requestLocationUpdatesFromProvider(LocationManager.NETWORK_PROVIDER) || requestLocationUpdatesFromProvider(LocationManager.GPS_PROVIDER)) : (requestLocationUpdatesFromProvider(LocationManager.NETWORK_PROVIDER) &amp;&amp; requestLocationUpdatesFromProvider(LocationManager.GPS_PROVIDER)));</span>
                }
            }
        }
<span class="fc" id="L118">    }</span>

    /**
     * Requests location updates from the specified provider.
     *
     * @param locationProvider the location provider
     * @return true if successful
     */
    public boolean requestLocationUpdatesFromProvider(String locationProvider) {
        try {
            // If both providers are not available
<span class="pc bpc" id="L129" title="7 of 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1585) ? (locationManager == null &amp;&amp; !(locationManager.getAllProviders().contains(locationProvider))) : (locationManager == null || !(locationManager.getAllProviders().contains(locationProvider))))) {</span>
<span class="nc" id="L130">                return false;</span>
            }
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1586)) {</span>
<span class="fc" id="L133">                locationManager.requestLocationUpdates(locationProvider, MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS, MIN_LOCATION_UPDATE_REQUEST_DISTANCE_IN_METERS, this);</span>
            }
<span class="fc" id="L135">            return true;</span>
<span class="nc" id="L136">        } catch (IllegalArgumentException e) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1583)) {</span>
<span class="nc" id="L138">                Timber.e(e, &quot;Illegal argument exception&quot;);</span>
            }
<span class="nc" id="L140">            return false;</span>
<span class="nc" id="L141">        } catch (SecurityException e) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1584)) {</span>
<span class="nc" id="L143">                Timber.e(e, &quot;Security exception&quot;);</span>
            }
<span class="nc" id="L145">            return false;</span>
        }
    }

    /**
     * Returns whether a given location is better than the current best location.
     *
     * @param location            the location to be tested
     * @param currentBestLocation the current best location
     * @return LOCATION_SIGNIFICANTLY_CHANGED if location changed significantly
     * LOCATION_SLIGHTLY_CHANGED if location changed slightly
     */
    private LocationChangeType isBetterLocation(Location location, Location currentBestLocation) {
<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (currentBestLocation == null) {</span>
            // A new location is always better than no location
<span class="fc" id="L160">            return LocationChangeType.LOCATION_SIGNIFICANTLY_CHANGED;</span>
        }
        // Check whether the new location fix is newer or older
<span class="pc bpc" id="L163" title="4 of 8 branches missed.">        long timeDelta = (ListenerUtil.mutListener.listen(1590) ? (location.getTime() % currentBestLocation.getTime()) : (ListenerUtil.mutListener.listen(1589) ? (location.getTime() / currentBestLocation.getTime()) : (ListenerUtil.mutListener.listen(1588) ? (location.getTime() * currentBestLocation.getTime()) : (ListenerUtil.mutListener.listen(1587) ? (location.getTime() + currentBestLocation.getTime()) : (location.getTime() - currentBestLocation.getTime())))));</span>
<span class="pc bpc" id="L164" title="15 of 22 branches missed.">        boolean isSignificantlyNewer = (ListenerUtil.mutListener.listen(1595) ? (timeDelta &gt;= MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS) : (ListenerUtil.mutListener.listen(1594) ? (timeDelta &lt;= MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS) : (ListenerUtil.mutListener.listen(1593) ? (timeDelta &lt; MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS) : (ListenerUtil.mutListener.listen(1592) ? (timeDelta != MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS) : (ListenerUtil.mutListener.listen(1591) ? (timeDelta == MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS) : (timeDelta &gt; MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS))))));</span>
<span class="pc bpc" id="L165" title="16 of 22 branches missed.">        boolean isNewer = (ListenerUtil.mutListener.listen(1600) ? (timeDelta &gt;= 0) : (ListenerUtil.mutListener.listen(1599) ? (timeDelta &lt;= 0) : (ListenerUtil.mutListener.listen(1598) ? (timeDelta &lt; 0) : (ListenerUtil.mutListener.listen(1597) ? (timeDelta != 0) : (ListenerUtil.mutListener.listen(1596) ? (timeDelta == 0) : (timeDelta &gt; 0))))));</span>
        // Check whether the new location fix is more or less accurate
<span class="pc bpc" id="L167" title="4 of 8 branches missed.">        int accuracyDelta = (int) ((ListenerUtil.mutListener.listen(1604) ? (location.getAccuracy() % currentBestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1603) ? (location.getAccuracy() / currentBestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1602) ? (location.getAccuracy() * currentBestLocation.getAccuracy()) : (ListenerUtil.mutListener.listen(1601) ? (location.getAccuracy() + currentBestLocation.getAccuracy()) : (location.getAccuracy() - currentBestLocation.getAccuracy()))))));</span>
<span class="pc bpc" id="L168" title="15 of 22 branches missed.">        boolean isLessAccurate = (ListenerUtil.mutListener.listen(1609) ? (accuracyDelta &gt;= 0) : (ListenerUtil.mutListener.listen(1608) ? (accuracyDelta &lt;= 0) : (ListenerUtil.mutListener.listen(1607) ? (accuracyDelta &lt; 0) : (ListenerUtil.mutListener.listen(1606) ? (accuracyDelta != 0) : (ListenerUtil.mutListener.listen(1605) ? (accuracyDelta == 0) : (accuracyDelta &gt; 0))))));</span>
<span class="pc bpc" id="L169" title="15 of 22 branches missed.">        boolean isMoreAccurate = (ListenerUtil.mutListener.listen(1614) ? (accuracyDelta &gt;= 0) : (ListenerUtil.mutListener.listen(1613) ? (accuracyDelta &lt;= 0) : (ListenerUtil.mutListener.listen(1612) ? (accuracyDelta &gt; 0) : (ListenerUtil.mutListener.listen(1611) ? (accuracyDelta != 0) : (ListenerUtil.mutListener.listen(1610) ? (accuracyDelta == 0) : (accuracyDelta &lt; 0))))));</span>
<span class="pc bpc" id="L170" title="16 of 22 branches missed.">        boolean isSignificantlyLessAccurate = (ListenerUtil.mutListener.listen(1619) ? (accuracyDelta &gt;= 200) : (ListenerUtil.mutListener.listen(1618) ? (accuracyDelta &lt;= 200) : (ListenerUtil.mutListener.listen(1617) ? (accuracyDelta &lt; 200) : (ListenerUtil.mutListener.listen(1616) ? (accuracyDelta != 200) : (ListenerUtil.mutListener.listen(1615) ? (accuracyDelta == 200) : (accuracyDelta &gt; 200))))));</span>
        // Check if the old and new location are from the same provider
<span class="fc" id="L172">        boolean isFromSameProvider = isSameProvider(location.getProvider(), currentBestLocation.getProvider());</span>
<span class="fc" id="L173">        float[] results = new float[5];</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1620)) {</span>
<span class="fc" id="L175">            Location.distanceBetween(currentBestLocation.getLatitude(), currentBestLocation.getLongitude(), location.getLatitude(), location.getLongitude(), results);</span>
        }
        // because the user has likely moved
<span class="pc bpc" id="L178" title="132 of 138 branches missed.">        if ((ListenerUtil.mutListener.listen(1626) ? ((ListenerUtil.mutListener.listen(1623) ? ((ListenerUtil.mutListener.listen(1621) ? (isSignificantlyNewer &amp;&amp; isMoreAccurate) : (isSignificantlyNewer || isMoreAccurate)) &amp;&amp; ((ListenerUtil.mutListener.listen(1622) ? (isNewer || !isLessAccurate) : (isNewer &amp;&amp; !isLessAccurate)))) : ((ListenerUtil.mutListener.listen(1621) ? (isSignificantlyNewer &amp;&amp; isMoreAccurate) : (isSignificantlyNewer || isMoreAccurate)) || ((ListenerUtil.mutListener.listen(1622) ? (isNewer || !isLessAccurate) : (isNewer &amp;&amp; !isLessAccurate))))) &amp;&amp; ((ListenerUtil.mutListener.listen(1625) ? ((ListenerUtil.mutListener.listen(1624) ? (isNewer || !isSignificantlyLessAccurate) : (isNewer &amp;&amp; !isSignificantlyLessAccurate)) || isFromSameProvider) : ((ListenerUtil.mutListener.listen(1624) ? (isNewer || !isSignificantlyLessAccurate) : (isNewer &amp;&amp; !isSignificantlyLessAccurate)) &amp;&amp; isFromSameProvider)))) : ((ListenerUtil.mutListener.listen(1623) ? ((ListenerUtil.mutListener.listen(1621) ? (isSignificantlyNewer &amp;&amp; isMoreAccurate) : (isSignificantlyNewer || isMoreAccurate)) &amp;&amp; ((ListenerUtil.mutListener.listen(1622) ? (isNewer || !isLessAccurate) : (isNewer &amp;&amp; !isLessAccurate)))) : ((ListenerUtil.mutListener.listen(1621) ? (isSignificantlyNewer &amp;&amp; isMoreAccurate) : (isSignificantlyNewer || isMoreAccurate)) || ((ListenerUtil.mutListener.listen(1622) ? (isNewer || !isLessAccurate) : (isNewer &amp;&amp; !isLessAccurate))))) || ((ListenerUtil.mutListener.listen(1625) ? ((ListenerUtil.mutListener.listen(1624) ? (isNewer || !isSignificantlyLessAccurate) : (isNewer &amp;&amp; !isSignificantlyLessAccurate)) || isFromSameProvider) : ((ListenerUtil.mutListener.listen(1624) ? (isNewer || !isSignificantlyLessAccurate) : (isNewer &amp;&amp; !isSignificantlyLessAccurate)) &amp;&amp; isFromSameProvider)))))) {</span>
<span class="pc bpc" id="L179" title="16 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(1631) ? (results[0] &gt;= 1000) : (ListenerUtil.mutListener.listen(1630) ? (results[0] &lt;= 1000) : (ListenerUtil.mutListener.listen(1629) ? (results[0] &gt; 1000) : (ListenerUtil.mutListener.listen(1628) ? (results[0] != 1000) : (ListenerUtil.mutListener.listen(1627) ? (results[0] == 1000) : (results[0] &lt; 1000))))))) {</span>
                // Means change is smaller than 1000 meter
<span class="fc" id="L181">                return LocationChangeType.LOCATION_SLIGHTLY_CHANGED;</span>
            } else {
<span class="nc" id="L183">                return LocationChangeType.LOCATION_SIGNIFICANTLY_CHANGED;</span>
            }
        } else {
<span class="nc" id="L186">            return LocationChangeType.LOCATION_NOT_CHANGED;</span>
        }
    }

    /**
     * Checks whether two providers are the same
     */
    private boolean isSameProvider(String provider1, String provider2) {
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1632)) {</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">            if (provider1 == null) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                return provider2 == null;</span>
            }
        }
<span class="fc" id="L199">        return provider1.equals(provider2);</span>
    }

    /**
     * Unregisters location manager.
     */
    public void unregisterLocationManager() {
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1633)) {</span>
<span class="fc" id="L207">            isLocationManagerRegistered = false;</span>
        }
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1634)) {</span>
<span class="fc" id="L210">            locationExplanationDisplayed.clear();</span>
        }
        try {
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1636)) {</span>
<span class="fc" id="L214">                locationManager.removeUpdates(this);</span>
            }
<span class="nc" id="L216">        } catch (SecurityException e) {</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1635)) {</span>
<span class="nc" id="L218">                Timber.e(e, &quot;Security exception&quot;);</span>
            }
<span class="fc" id="L220">        }</span>
<span class="fc" id="L221">    }</span>

    /**
     * Adds a new listener to the list of location listeners.
     *
     * @param listener the new listener
     */
    public void addLocationListener(LocationUpdateListener listener) {
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1638)) {</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">            if (!locationListeners.contains(listener)) {</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1637)) {</span>
<span class="fc" id="L232">                    locationListeners.add(listener);</span>
                }
            }
        }
<span class="fc" id="L236">    }</span>

    /**
     * Removes a listener from the list of location listeners.
     *
     * @param listener the listener to be removed
     */
    public void removeLocationListener(LocationUpdateListener listener) {
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1639)) {</span>
<span class="fc" id="L245">            locationListeners.remove(listener);</span>
        }
<span class="fc" id="L247">    }</span>

    @Override
    public void onLocationChanged(Location location) {
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1640)) {</span>
<span class="fc" id="L252">            Timber.d(&quot;on location changed&quot;);</span>
        }
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1654)) {</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">            if (isBetterLocation(location, lastLocation).equals(LocationChangeType.LOCATION_SIGNIFICANTLY_CHANGED)) {</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1651)) {</span>
<span class="fc" id="L257">                    lastLocation = location;</span>
                }
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1653)) {</span>
                    {
<span class="fc" id="L261">                        long _loopCounter22 = 0;</span>
                        // lastLocationDuplicate = location;
<span class="fc bfc" id="L263" title="All 2 branches covered.">                        for (LocationUpdateListener listener : locationListeners) {</span>
<span class="fc" id="L264">                            ListenerUtil.loopListener.listen(&quot;_loopCounter22&quot;, ++_loopCounter22);</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(1652)) {</span>
<span class="fc" id="L266">                                listener.onLocationChangedSignificantly(LatLng.from(lastLocation));</span>
                            }
<span class="fc" id="L268">                        }</span>
<span class="fc" id="L269">                    }</span>
                }
<span class="pc bpc" id="L271" title="16 of 22 branches missed.">            } else if ((ListenerUtil.mutListener.listen(1645) ? (location.distanceTo(lastLocation) &lt;= 500) : (ListenerUtil.mutListener.listen(1644) ? (location.distanceTo(lastLocation) &gt; 500) : (ListenerUtil.mutListener.listen(1643) ? (location.distanceTo(lastLocation) &lt; 500) : (ListenerUtil.mutListener.listen(1642) ? (location.distanceTo(lastLocation) != 500) : (ListenerUtil.mutListener.listen(1641) ? (location.distanceTo(lastLocation) == 500) : (location.distanceTo(lastLocation) &gt;= 500))))))) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1650)) {</span>
                    {
<span class="nc" id="L274">                        long _loopCounter21 = 0;</span>
                        // Update nearby notification card at every 500 meters.
<span class="nc bnc" id="L276" title="All 2 branches missed.">                        for (LocationUpdateListener listener : locationListeners) {</span>
<span class="nc" id="L277">                            ListenerUtil.loopListener.listen(&quot;_loopCounter21&quot;, ++_loopCounter21);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(1649)) {</span>
<span class="nc" id="L279">                                listener.onLocationChangedMedium(LatLng.from(lastLocation));</span>
                            }
<span class="nc" id="L281">                        }</span>
<span class="nc" id="L282">                    }</span>
                }
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">            } else if (isBetterLocation(location, lastLocation).equals(LocationChangeType.LOCATION_SLIGHTLY_CHANGED)) {</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1646)) {</span>
<span class="fc" id="L286">                    lastLocation = location;</span>
                }
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1648)) {</span>
                    {
<span class="fc" id="L290">                        long _loopCounter20 = 0;</span>
                        // lastLocationDuplicate = location;
<span class="fc bfc" id="L292" title="All 2 branches covered.">                        for (LocationUpdateListener listener : locationListeners) {</span>
<span class="fc" id="L293">                            ListenerUtil.loopListener.listen(&quot;_loopCounter20&quot;, ++_loopCounter20);</span>
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(1647)) {</span>
<span class="fc" id="L295">                                listener.onLocationChangedSlightly(LatLng.from(lastLocation));</span>
                            }
<span class="fc" id="L297">                        }</span>
                    }
                }
            }
        }
<span class="fc" id="L302">    }</span>

    @Override
    public void onStatusChanged(String provider, int status, Bundle extras) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1655)) {</span>
<span class="nc" id="L307">            Timber.d(&quot;%s's status changed to %d&quot;, provider, status);</span>
        }
<span class="nc" id="L309">    }</span>

    @Override
    public void onProviderEnabled(String provider) {
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1656)) {</span>
<span class="nc" id="L314">            Timber.d(&quot;Provider %s enabled&quot;, provider);</span>
        }
<span class="nc" id="L316">    }</span>

    @Override
    public void onProviderDisabled(String provider) {
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1657)) {</span>
<span class="nc" id="L321">            Timber.d(&quot;Provider %s disabled&quot;, provider);</span>
        }
<span class="nc" id="L323">    }</span>

    public boolean isNetworkProviderEnabled() {
<span class="nc" id="L326">        return locationManager.isProviderEnabled(LocationManager.NETWORK_PROVIDER);</span>
    }

    public boolean isGPSProviderEnabled() {
<span class="nc" id="L330">        return locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER);</span>
    }

<span class="fc" id="L333">    public enum LocationChangeType {</span>

        // Went out of borders of nearby markers
<span class="fc" id="L336">        LOCATION_SIGNIFICANTLY_CHANGED,</span>
        // User might be walking or driving
<span class="fc" id="L338">        LOCATION_SLIGHTLY_CHANGED,</span>
        // Between slight and significant changes, will be used for nearby card view updates.
<span class="fc" id="L340">        LOCATION_MEDIUM_CHANGED,</span>
<span class="fc" id="L341">        LOCATION_NOT_CHANGED,</span>
<span class="fc" id="L342">        PERMISSION_JUST_GRANTED,</span>
<span class="fc" id="L343">        MAP_UPDATED,</span>
<span class="fc" id="L344">        SEARCH_CUSTOM_AREA,</span>
<span class="fc" id="L345">        CUSTOM_QUERY</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>