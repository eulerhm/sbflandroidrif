<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaConverter.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.explore.media</a> &gt; <span class="el_source">MediaConverter.kt</span></div><h1>MediaConverter.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.explore.media

import fr.free.nrw.commons.Media
import fr.free.nrw.commons.location.LatLng
import fr.free.nrw.commons.upload.structure.depictions.get
import fr.free.nrw.commons.utils.CommonsDateUtil
import fr.free.nrw.commons.utils.MediaDataExtractorUtil
import fr.free.nrw.commons.wikidata.WikidataProperties
import org.apache.commons.lang3.StringUtils
import org.wikipedia.dataclient.mwapi.MwQueryPage
import org.wikipedia.gallery.ExtMetadata
import org.wikipedia.gallery.ImageInfo
import org.wikipedia.wikidata.DataValue
import org.wikipedia.wikidata.Entities
import java.text.ParseException
import java.util.*
import javax.inject.Inject

<span class="fc" id="L19">class MediaConverter @Inject constructor() {</span>
    fun convert(page: MwQueryPage, entity: Entities.Entity, imageInfo: ImageInfo): Media {
<span class="fc" id="L21">        val metadata = imageInfo.metadata</span>
<span class="pc bpc" id="L22" title="1 of 2 branches missed.">        requireNotNull(metadata) { &quot;No metadata&quot; }</span>
        // Stores mapping of title attribute to hidden attribute of each category
<span class="fc" id="L24">        val myMap = mutableMapOf&lt;String, Boolean&gt;()</span>
<span class="pc bpc" id="L25" title="1 of 2 branches missed.">        page.categories()?.forEach { myMap[it.title()] = (it.hidden()) }</span>

<span class="fc" id="L27">        return Media(</span>
<span class="fc" id="L28">            page.pageId().toString(),</span>
<span class="pc bpc" id="L29" title="3 of 6 branches missed.">            imageInfo.thumbUrl.takeIf { it.isNotBlank() } ?: imageInfo.originalUrl,</span>
<span class="fc" id="L30">            imageInfo.originalUrl,</span>
<span class="fc" id="L31">            page.title(),</span>
<span class="fc" id="L32">            metadata.imageDescription(),</span>
<span class="fc" id="L33">            safeParseDate(metadata.dateTime()),</span>
<span class="fc" id="L34">            metadata.licenseShortName(),</span>
<span class="fc" id="L35">            metadata.prefixedLicenseUrl,</span>
<span class="fc" id="L36">            getAuthor(metadata),</span>
<span class="fc" id="L37">            imageInfo.user,</span>
<span class="fc" id="L38">            MediaDataExtractorUtil.extractCategoriesFromList(metadata.categories),</span>
<span class="fc" id="L39">            metadata.latLng,</span>
<span class="fc" id="L40">            entity.labels().mapValues { it.value.value() },</span>
<span class="pc" id="L41">            entity.descriptions().mapValues { it.value.value() },</span>
<span class="fc" id="L42">            entity.depictionIds(),</span>
<span class="fc" id="L43">            myMap</span>
        )
    }

    /**
     * Creating Media object from MWQueryPage.
     * Earlier only basic details were set for the media object but going forward,
     * a full media object(with categories, descriptions, coordinates etc) can be constructed using this method
     *
     * @param page response from the API
     * @return Media object
     */

    private fun safeParseDate(dateStr: String): Date? {
<span class="fc" id="L57">        return try {</span>
<span class="fc" id="L58">            CommonsDateUtil.getMediaSimpleDateFormat().parse(dateStr)</span>
<span class="nc" id="L59">        } catch (e: ParseException) {</span>
<span class="pc" id="L60">            null</span>
        }
    }


    /**
     * This method extracts the Commons Username from the artist HTML information
     * @param metadata
     * @return
     */
    private fun getAuthor(metadata: ExtMetadata): String? {
<span class="pc" id="L71">        return try {</span>
<span class="fc" id="L72">            val authorHtml = metadata.artist()</span>
<span class="fc" id="L73">            val anchorStartTagTerminalChars = &quot;\&quot;&gt;&quot;</span>
<span class="fc" id="L74">            val anchorCloseTag = &quot;&lt;/a&gt;&quot;</span>

<span class="fc" id="L76">            return authorHtml.substring(</span>
<span class="fc" id="L77">                authorHtml.indexOf(anchorStartTagTerminalChars) + anchorStartTagTerminalChars</span>
<span class="fc" id="L78">                    .length, authorHtml.indexOf(anchorCloseTag)</span>
            )
<span class="nc" id="L80">        } catch (ex: java.lang.Exception) {</span>
<span class="nc" id="L81">            &quot;&quot;</span>
        }
    }
}

private fun Entities.Entity.depictionIds() =
<span class="pc bpc" id="L87" title="3 of 8 branches missed.">    this[WikidataProperties.DEPICTS]?.mapNotNull { (it.mainSnak.dataValue as? DataValue.EntityId)?.value?.id }</span>
<span class="fc" id="L88">        ?: emptyList()</span>

private val ExtMetadata.prefixedLicenseUrl: String
<span class="fc" id="L91">    get() = licenseUrl().let {</span>
<span class="pc bpc" id="L92" title="2 of 4 branches missed.">        if (!it.startsWith(&quot;http://&quot;) &amp;&amp; !it.startsWith(&quot;https://&quot;))</span>
<span class="nc" id="L93">            &quot;https://$it&quot;</span>
        else
<span class="fc" id="L95">            it</span>
<span class="fc" id="L96">    }</span>

private val ExtMetadata.latLng: LatLng?
<span class="pc bpc" id="L99" title="1 of 4 branches missed.">    get() = if (!StringUtils.isBlank(gpsLatitude) &amp;&amp; !StringUtils.isBlank(gpsLongitude))</span>
<span class="fc" id="L100">        LatLng(gpsLatitude.toDouble(), gpsLongitude.toDouble(), 0.0f)</span>
    else
<span class="fc" id="L102">        null</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>