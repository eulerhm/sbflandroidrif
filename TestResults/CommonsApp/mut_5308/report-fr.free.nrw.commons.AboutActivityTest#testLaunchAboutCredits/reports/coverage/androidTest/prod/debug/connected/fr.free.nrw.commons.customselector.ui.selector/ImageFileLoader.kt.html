<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImageFileLoader.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.customselector.ui.selector</a> &gt; <span class="el_source">ImageFileLoader.kt</span></div><h1>ImageFileLoader.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.customselector.ui.selector

import android.content.ContentUris
import android.content.Context
import android.provider.MediaStore
import android.text.format.DateFormat
import fr.free.nrw.commons.customselector.listeners.ImageLoaderListener
import fr.free.nrw.commons.customselector.model.Image
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File
import java.util.*
import kotlin.coroutines.CoroutineContext

/**
 * Custom Selector Image File Loader.
 * Loads device images.
 */
<span class="nc" id="L21">class ImageFileLoader(val context: Context) : CoroutineScope{</span>

    /**
     * Coroutine context for fetching images.
     */
<span class="nc" id="L26">    override val coroutineContext: CoroutineContext = Dispatchers.Main</span>

    /**
     * Media paramerters required.
     */
<span class="nc" id="L31">    private val projection = arrayOf(</span>
<span class="nc" id="L32">        MediaStore.Images.Media._ID,</span>
<span class="nc" id="L33">        MediaStore.Images.Media.DISPLAY_NAME,</span>
<span class="nc" id="L34">        MediaStore.Images.Media.DATA,</span>
<span class="nc" id="L35">        MediaStore.Images.Media.BUCKET_ID,</span>
<span class="nc" id="L36">        MediaStore.Images.Media.BUCKET_DISPLAY_NAME,</span>
<span class="nc" id="L37">        MediaStore.Images.Media.DATE_ADDED</span>
    )

    /**
     * Load Device Images under coroutine.
     */
    fun loadDeviceImages(listener: ImageLoaderListener) {
<span class="nc" id="L44">        launch(Dispatchers.Main) {</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">            withContext(Dispatchers.IO) {</span>
<span class="nc" id="L46">                getImages(listener)</span>
<span class="nc" id="L47">            }</span>
<span class="nc" id="L48">        }</span>
<span class="nc" id="L49">    }</span>


    /**
     * Load Device images using cursor
     */
    private fun getImages(listener:ImageLoaderListener) {
<span class="nc" id="L56">        val cursor = context.contentResolver.query(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, projection, null, null, MediaStore.Images.Media.DATE_ADDED + &quot; DESC&quot;)</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (cursor == null) {</span>
<span class="nc" id="L58">            listener.onFailed(NullPointerException())</span>
<span class="nc" id="L59">            return</span>
        }

<span class="nc" id="L62">        val idColumn = cursor.getColumnIndex(MediaStore.Images.Media._ID)</span>
<span class="nc" id="L63">        val nameColumn = cursor.getColumnIndex(MediaStore.Images.Media.DISPLAY_NAME)</span>
<span class="nc" id="L64">        val dataColumn = cursor.getColumnIndex(MediaStore.Images.Media.DATA)</span>
<span class="nc" id="L65">        val bucketIdColumn = cursor.getColumnIndex(MediaStore.Images.Media.BUCKET_ID)</span>
<span class="nc" id="L66">        val bucketNameColumn = cursor.getColumnIndex(MediaStore.Images.Media.BUCKET_DISPLAY_NAME)</span>
<span class="nc" id="L67">        val dateColumn = cursor.getColumnIndex(MediaStore.Images.Media.DATE_ADDED)</span>

<span class="nc" id="L69">        val images = arrayListOf&lt;Image&gt;()</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (cursor.moveToFirst()) {</span>
            do {
<span class="nc bnc" id="L72" title="All 2 branches missed.">                if (Thread.interrupted()) {</span>
<span class="nc" id="L73">                    listener.onFailed(NullPointerException())</span>
<span class="nc" id="L74">                    return</span>
                }
<span class="nc" id="L76">                val id = cursor.getLong(idColumn)</span>
<span class="nc" id="L77">                val name = cursor.getString(nameColumn)</span>
<span class="nc" id="L78">                val path = cursor.getString(dataColumn)</span>
<span class="nc" id="L79">                val bucketId = cursor.getLong(bucketIdColumn)</span>
<span class="nc" id="L80">                val bucketName = cursor.getString(bucketNameColumn)</span>
<span class="nc" id="L81">                val date = cursor.getLong(dateColumn)</span>

<span class="nc" id="L83">                val file =</span>
<span class="nc bnc" id="L84" title="All 6 branches missed.">                    if (path == null || path.isEmpty()) {</span>
<span class="nc" id="L85">                        null</span>
<span class="nc" id="L86">                    } else try {</span>
<span class="nc" id="L87">                        File(path)</span>
<span class="nc" id="L88">                    } catch (ignored: Exception) {</span>
<span class="nc" id="L89">                        null</span>
                    }

<span class="nc bnc" id="L92" title="All 10 branches missed.">                if (file != null &amp;&amp; file.exists() &amp;&amp; name != null &amp;&amp; path != null &amp;&amp; bucketName != null) {</span>
<span class="nc" id="L93">                    val uri = ContentUris.withAppendedId(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, id)</span>

<span class="nc" id="L95">                    val calendar = Calendar.getInstance()</span>
<span class="nc" id="L96">                    calendar.timeInMillis = date * 1000L</span>
<span class="nc" id="L97">                    val date: Date = calendar.time</span>
<span class="nc" id="L98">                    val dateFormat = DateFormat.getMediumDateFormat(context)</span>
<span class="nc" id="L99">                    val formattedDate = dateFormat.format(date)</span>

<span class="nc" id="L101">                    val image = Image(</span>
<span class="nc" id="L102">                        id,</span>
<span class="nc" id="L103">                        name,</span>
<span class="nc" id="L104">                        uri,</span>
<span class="nc" id="L105">                        path,</span>
<span class="nc" id="L106">                        bucketId,</span>
<span class="nc" id="L107">                        bucketName,</span>
<span class="nc" id="L108">                        date = (formattedDate)</span>
                    )
<span class="nc" id="L110">                    images.add(image)</span>
                }

<span class="nc bnc" id="L113" title="All 2 branches missed.">            } while (cursor.moveToNext())</span>
        }
<span class="nc" id="L115">        cursor.close()</span>
<span class="nc" id="L116">        listener.onImageLoaded(images)</span>
<span class="nc" id="L117">    }</span>


    /**
     * Abort loading images.
     */
    fun abortLoadImage(){
        //todo Abort loading images.
<span class="nc" id="L125">    }</span>

    /*
     *
     * TODO
     * Sha1 for image (original image).
     *
     */
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>