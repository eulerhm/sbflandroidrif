<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReviewController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.review</a> &gt; <span class="el_source">ReviewController.java</span></div><h1>ReviewController.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.review;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.app.NotificationManager;
import android.content.Context;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.core.app.NotificationCompat;
import org.wikipedia.dataclient.mwapi.MwQueryPage;
import java.util.ArrayList;
import java.util.concurrent.Callable;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.actions.PageEditClient;
import fr.free.nrw.commons.actions.ThanksClient;
import fr.free.nrw.commons.delete.DeleteHelper;
import fr.free.nrw.commons.di.ApplicationlessInjection;
import fr.free.nrw.commons.utils.ViewUtil;
import io.reactivex.Observable;
import io.reactivex.ObservableSource;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.schedulers.Schedulers;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

@Singleton
public class ReviewController {

    private static final int NOTIFICATION_SEND_THANK = 0x102;

    private static final int NOTIFICATION_CHECK_CATEGORY = 0x101;

    protected static ArrayList&lt;String&gt; categories;

    @Inject
    ThanksClient thanksClient;

    private final DeleteHelper deleteHelper;

    @Nullable
    MwQueryPage.Revision // TODO: maybe we can expand this class to include fileName
    firstRevision;

    @Inject
    @Named(&quot;commons-page-edit&quot;)
    PageEditClient pageEditClient;

    private NotificationManager notificationManager;

    private NotificationCompat.Builder notificationBuilder;

    private Media media;

<span class="fc" id="L59">    ReviewController(DeleteHelper deleteHelper, Context context) {</span>
<span class="fc" id="L60">        this.deleteHelper = deleteHelper;</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5819)) {</span>
<span class="fc" id="L62">            CommonsApplication.createNotificationChannel(context.getApplicationContext());</span>
        }
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5820)) {</span>
<span class="fc" id="L65">            notificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);</span>
        }
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5821)) {</span>
<span class="fc" id="L68">            notificationBuilder = new NotificationCompat.Builder(context, CommonsApplication.NOTIFICATION_CHANNEL_ID_ALL);</span>
        }
<span class="fc" id="L70">    }</span>

    void onImageRefreshed(Media media) {
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5822)) {</span>
<span class="nc" id="L74">            this.media = media;</span>
        }
<span class="nc" id="L76">    }</span>

    public Media getMedia() {
<span class="nc" id="L79">        return media;</span>
    }

<span class="nc" id="L82">    public enum DeleteReason {</span>

<span class="nc" id="L84">        SPAM, COPYRIGHT_VIOLATION</span>
    }

    void reportSpam(@NonNull Activity activity, ReviewCallback reviewCallback) {
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5823)) {</span>
<span class="nc" id="L89">            Timber.d(&quot;Report spam for %s&quot;, media.getFilename());</span>
        }
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5824)) {</span>
<span class="nc" id="L92">            deleteHelper.askReasonAndExecute(media, activity, activity.getResources().getString(R.string.review_spam_report_question), DeleteReason.SPAM, reviewCallback);</span>
        }
<span class="nc" id="L94">    }</span>

    void reportPossibleCopyRightViolation(@NonNull Activity activity, ReviewCallback reviewCallback) {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5825)) {</span>
<span class="nc" id="L98">            Timber.d(&quot;Report spam for %s&quot;, media.getFilename());</span>
        }
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5826)) {</span>
<span class="nc" id="L101">            deleteHelper.askReasonAndExecute(media, activity, activity.getResources().getString(R.string.review_c_violation_report_question), DeleteReason.COPYRIGHT_VIOLATION, reviewCallback);</span>
        }
<span class="nc" id="L103">    }</span>

    @SuppressLint(&quot;CheckResult&quot;)
    void reportWrongCategory(@NonNull Activity activity, ReviewCallback reviewCallback) {
<span class="nc" id="L107">        Context context = activity.getApplicationContext();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5827)) {</span>
<span class="nc" id="L109">            ApplicationlessInjection.getInstance(context).getCommonsApplicationComponent().inject(this);</span>
        }
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5828)) {</span>
<span class="nc" id="L112">            ViewUtil.showShortToast(context, context.getString(R.string.check_category_toast, media.getDisplayTitle()));</span>
        }
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5829)) {</span>
<span class="nc" id="L115">            publishProgress(context, 0);</span>
        }
<span class="nc" id="L117">        String summary = context.getString(R.string.check_category_edit_summary);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5830)) {</span>
<span class="nc" id="L119">            Observable.defer((Callable&lt;ObservableSource&lt;Boolean&gt;&gt;) () -&gt; pageEditClient.appendEdit(media.getFilename(), &quot;\n{{subst:chc}}\n&quot;, summary)).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).subscribe((result) -&gt; {</span>
<span class="nc" id="L120">                publishProgress(context, 2);</span>
                String message;
                String title;
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (result) {</span>
<span class="nc" id="L124">                    title = context.getString(R.string.check_category_success_title);</span>
<span class="nc" id="L125">                    message = context.getString(R.string.check_category_success_message, media.getDisplayTitle());</span>
<span class="nc" id="L126">                    reviewCallback.onSuccess();</span>
                } else {
<span class="nc" id="L128">                    title = context.getString(R.string.check_category_failure_title);</span>
<span class="nc" id="L129">                    message = context.getString(R.string.check_category_failure_message, media.getDisplayTitle());</span>
<span class="nc" id="L130">                    reviewCallback.onFailure();</span>
                }
<span class="nc" id="L132">                showNotification(title, message);</span>
<span class="nc" id="L133">            }, Timber::e);</span>
        }
<span class="nc" id="L135">    }</span>

    private void publishProgress(@NonNull Context context, int i) {
<span class="nc" id="L138">        int[] messages = new int[] { R.string.getting_edit_token, R.string.check_category_adding_template };</span>
<span class="nc" id="L139">        String message = &quot;&quot;;</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5843)) {</span>
<span class="nc bnc" id="L141" title="All 90 branches missed.">            if ((ListenerUtil.mutListener.listen(5841) ? ((ListenerUtil.mutListener.listen(5835) ? (0 &gt;= i) : (ListenerUtil.mutListener.listen(5834) ? (0 &lt;= i) : (ListenerUtil.mutListener.listen(5833) ? (0 &gt; i) : (ListenerUtil.mutListener.listen(5832) ? (0 != i) : (ListenerUtil.mutListener.listen(5831) ? (0 == i) : (0 &lt; i)))))) || (ListenerUtil.mutListener.listen(5840) ? (i &gt;= messages.length) : (ListenerUtil.mutListener.listen(5839) ? (i &lt;= messages.length) : (ListenerUtil.mutListener.listen(5838) ? (i &gt; messages.length) : (ListenerUtil.mutListener.listen(5837) ? (i != messages.length) : (ListenerUtil.mutListener.listen(5836) ? (i == messages.length) : (i &lt; messages.length))))))) : ((ListenerUtil.mutListener.listen(5835) ? (0 &gt;= i) : (ListenerUtil.mutListener.listen(5834) ? (0 &lt;= i) : (ListenerUtil.mutListener.listen(5833) ? (0 &gt; i) : (ListenerUtil.mutListener.listen(5832) ? (0 != i) : (ListenerUtil.mutListener.listen(5831) ? (0 == i) : (0 &lt; i)))))) &amp;&amp; (ListenerUtil.mutListener.listen(5840) ? (i &gt;= messages.length) : (ListenerUtil.mutListener.listen(5839) ? (i &lt;= messages.length) : (ListenerUtil.mutListener.listen(5838) ? (i &gt; messages.length) : (ListenerUtil.mutListener.listen(5837) ? (i != messages.length) : (ListenerUtil.mutListener.listen(5836) ? (i == messages.length) : (i &lt; messages.length))))))))) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5842)) {</span>
<span class="nc" id="L143">                    message = context.getString(messages[i]);</span>
                }
            }
        }
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5844)) {</span>
<span class="nc" id="L148">            notificationBuilder.setContentTitle(context.getString(R.string.check_category_notification_title, media.getDisplayTitle())).setStyle(new NotificationCompat.BigTextStyle().bigText(message)).setSmallIcon(R.drawable.ic_launcher).setProgress(messages.length, i, false).setOngoing(true);</span>
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5845)) {</span>
<span class="nc" id="L151">            notificationManager.notify(NOTIFICATION_CHECK_CATEGORY, notificationBuilder.build());</span>
        }
<span class="nc" id="L153">    }</span>

    @SuppressLint({ &quot;CheckResult&quot;, &quot;StringFormatInvalid&quot; })
    void sendThanks(@NonNull Activity activity) {
<span class="nc" id="L157">        Context context = activity.getApplicationContext();</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5846)) {</span>
<span class="nc" id="L159">            ApplicationlessInjection.getInstance(context).getCommonsApplicationComponent().inject(this);</span>
        }
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5847)) {</span>
<span class="nc" id="L162">            ViewUtil.showShortToast(context, context.getString(R.string.send_thank_toast, media.getDisplayTitle()));</span>
        }
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5848)) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (firstRevision == null) {</span>
<span class="nc" id="L166">                return;</span>
            }
        }
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5849)) {</span>
<span class="nc" id="L170">            Observable.defer((Callable&lt;ObservableSource&lt;Boolean&gt;&gt;) () -&gt; thanksClient.thank(firstRevision.getRevisionId())).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).subscribe((result) -&gt; {</span>
<span class="nc" id="L171">                displayThanksToast(context, result);</span>
<span class="nc" id="L172">            }, Timber::e);</span>
        }
<span class="nc" id="L174">    }</span>

    @SuppressLint(&quot;StringFormatInvalid&quot;)
    private void displayThanksToast(final Context context, final boolean result) {
        final String message;
        final String title;
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (result) {</span>
<span class="nc" id="L181">            title = context.getString(R.string.send_thank_success_title);</span>
<span class="nc" id="L182">            message = context.getString(R.string.send_thank_success_message, media.getDisplayTitle());</span>
        } else {
<span class="nc" id="L184">            title = context.getString(R.string.send_thank_failure_title);</span>
<span class="nc" id="L185">            message = context.getString(R.string.send_thank_failure_message, media.getDisplayTitle());</span>
        }
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5850)) {</span>
<span class="nc" id="L188">            ViewUtil.showShortToast(context, message);</span>
        }
<span class="nc" id="L190">    }</span>

    private void showNotification(String title, String message) {
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5851)) {</span>
<span class="nc" id="L194">            notificationBuilder.setDefaults(NotificationCompat.DEFAULT_ALL).setContentTitle(title).setStyle(new NotificationCompat.BigTextStyle().bigText(message)).setSmallIcon(R.drawable.ic_launcher).setProgress(0, 0, false).setOngoing(false).setPriority(NotificationCompat.PRIORITY_HIGH);</span>
        }
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5852)) {</span>
<span class="nc" id="L197">            notificationManager.notify(NOTIFICATION_SEND_THANK, notificationBuilder.build());</span>
        }
<span class="nc" id="L199">    }</span>

    public interface ReviewCallback {

        void onSuccess();

        void onFailure();
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>