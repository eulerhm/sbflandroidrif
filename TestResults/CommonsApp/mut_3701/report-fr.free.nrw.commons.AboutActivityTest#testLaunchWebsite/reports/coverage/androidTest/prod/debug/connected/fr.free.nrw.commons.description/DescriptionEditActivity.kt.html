<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DescriptionEditActivity.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.description</a> &gt; <span class="el_source">DescriptionEditActivity.kt</span></div><h1>DescriptionEditActivity.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.description

import android.app.Activity.RESULT_OK
import android.app.ProgressDialog
import android.content.Intent
import android.os.Bundle
import android.os.Parcelable
import android.speech.RecognizerIntent
import android.view.View
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import fr.free.nrw.commons.R
import fr.free.nrw.commons.databinding.ActivityDescriptionEditBinding
import fr.free.nrw.commons.description.EditDescriptionConstants.LIST_OF_DESCRIPTION_AND_CAPTION
import fr.free.nrw.commons.description.EditDescriptionConstants.UPDATED_WIKITEXT
import fr.free.nrw.commons.description.EditDescriptionConstants.WIKITEXT
import fr.free.nrw.commons.recentlanguages.RecentLanguagesDao
import fr.free.nrw.commons.settings.Prefs
import fr.free.nrw.commons.theme.BaseActivity
import fr.free.nrw.commons.upload.UploadMediaDetail
import fr.free.nrw.commons.upload.UploadMediaDetailAdapter
import fr.free.nrw.commons.utils.DialogUtil.showAlertDialog
import timber.log.Timber
import javax.inject.Inject

/**
 * Activity for populating and editing existing description and caption
 */
<span class="nc" id="L29">class DescriptionEditActivity : BaseActivity(), UploadMediaDetailAdapter.EventListener {</span>
    /**
     * Adapter for showing UploadMediaDetail in the activity
     */
    private lateinit var uploadMediaDetailAdapter: UploadMediaDetailAdapter

    /**
     * Recyclerview for recycling data in views
     */
    @JvmField
    var rvDescriptions: RecyclerView? = null

    /**
     * Current wikitext
     */
<span class="nc" id="L44">    var wikiText: String? = null</span>

    /**
     * Saved language
     */
    private lateinit var savedLanguageValue: String

    /**
     * For showing progress dialog
     */
    private var progressDialog: ProgressDialog? = null

    @Inject
<span class="nc bnc" id="L57" title="All 2 branches missed.">    lateinit var recentLanguagesDao: RecentLanguagesDao</span>

    private lateinit var binding: ActivityDescriptionEditBinding

<span class="nc" id="L61">    private val REQUEST_CODE_FOR_VOICE_INPUT = 1213</span>

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L64">        super.onCreate(savedInstanceState)</span>

<span class="nc" id="L66">        binding = ActivityDescriptionEditBinding.inflate(layoutInflater)</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        setContentView(binding.root)</span>

<span class="nc" id="L69">        val bundle = intent.extras</span>
<span class="nc" id="L70">        val descriptionAndCaptions: ArrayList&lt;UploadMediaDetail&gt; =</span>
<span class="nc" id="L71">            bundle!!.getParcelableArrayList(LIST_OF_DESCRIPTION_AND_CAPTION)!!</span>
<span class="nc" id="L72">        wikiText = bundle.getString(WIKITEXT)</span>
<span class="nc" id="L73">        savedLanguageValue = bundle.getString(Prefs.DESCRIPTION_LANGUAGE)!!</span>
<span class="nc" id="L74">        initRecyclerView(descriptionAndCaptions)</span>

<span class="nc bnc" id="L76" title="All 2 branches missed.">        binding.btnEditSubmit.setOnClickListener(::onSubmitButtonClicked)</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        binding.toolbarBackButton.setOnClickListener(::onBackButtonClicked)</span>
<span class="nc" id="L78">    }</span>

    /**
     * Initializes the RecyclerView
     * @param descriptionAndCaptions list of description and caption
     */
    private fun initRecyclerView(descriptionAndCaptions: ArrayList&lt;UploadMediaDetail&gt;?) {
<span class="nc" id="L85">        uploadMediaDetailAdapter = UploadMediaDetailAdapter(this,</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            savedLanguageValue, descriptionAndCaptions, recentLanguagesDao)</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        uploadMediaDetailAdapter.setCallback { titleStringID: Int, messageStringId: Int -&gt;</span>
<span class="nc" id="L88">            showInfoAlert(</span>
<span class="nc" id="L89">                titleStringID,</span>
<span class="nc" id="L90">                messageStringId</span>
            )
<span class="nc" id="L92">        }</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        uploadMediaDetailAdapter.setEventListener(this)</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        rvDescriptions = binding.rvDescriptionsCaptions</span>
<span class="nc" id="L95">        rvDescriptions!!.layoutManager = LinearLayoutManager(this)</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        rvDescriptions!!.adapter = uploadMediaDetailAdapter</span>
<span class="nc" id="L97">    }</span>

    /**
     * show dialog with info
     * @param titleStringID Title ID
     * @param messageStringId Message ID
     */
    private fun showInfoAlert(titleStringID: Int, messageStringId: Int) {
<span class="nc" id="L105">        showAlertDialog(</span>
<span class="nc" id="L106">            this, getString(titleStringID),</span>
<span class="nc" id="L107">            getString(messageStringId), getString(android.R.string.ok),</span>
<span class="nc" id="L108">            null, true</span>
        )
<span class="nc" id="L110">    }</span>

<span class="nc" id="L112">    override fun onPrimaryCaptionTextChange(isNotEmpty: Boolean) {}</span>

    /**
     * Adds new language item to RecyclerView
     */
    override fun addLanguage() {
<span class="nc" id="L118">        val uploadMediaDetail = UploadMediaDetail()</span>
<span class="nc" id="L119">        uploadMediaDetail.isManuallyAdded = true //This was manually added by the user</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        uploadMediaDetailAdapter.addDescription(uploadMediaDetail)</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        rvDescriptions!!.smoothScrollToPosition(uploadMediaDetailAdapter.itemCount - 1)</span>
<span class="nc" id="L122">    }</span>

    private fun onBackButtonClicked(view: View) {
<span class="nc" id="L125">        onBackPressed()</span>
<span class="nc" id="L126">    }</span>

    private fun onSubmitButtonClicked(view: View) {
<span class="nc" id="L129">        showLoggingProgressBar()</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        val uploadMediaDetails = uploadMediaDetailAdapter.items</span>
<span class="nc" id="L131">        updateDescription(uploadMediaDetails)</span>
<span class="nc" id="L132">        finish()</span>
<span class="nc" id="L133">    }</span>

    /**
     * Updates newly added descriptions in the wikiText and send to calling fragment
     * @param uploadMediaDetails descriptions and captions
     */
    private fun updateDescription(uploadMediaDetails: List&lt;UploadMediaDetail?&gt;) {
<span class="nc" id="L140">        var descriptionIndex = wikiText!!.indexOf(&quot;description=&quot;)</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (descriptionIndex == -1) {</span>
<span class="nc" id="L142">            descriptionIndex = wikiText!!.indexOf(&quot;Description=&quot;)</span>
        }
<span class="nc" id="L144">        val buffer = StringBuilder()</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (descriptionIndex != -1) {</span>
<span class="nc" id="L146">            val descriptionStart = wikiText!!.substring(0, descriptionIndex + 12)</span>
<span class="nc" id="L147">            val descriptionToEnd = wikiText!!.substring(descriptionIndex + 12)</span>
<span class="nc" id="L148">            val descriptionEndIndex = descriptionToEnd.indexOf(&quot;\n&quot;)</span>
<span class="nc" id="L149">            val descriptionEnd = wikiText!!.substring(</span>
<span class="nc" id="L150">                descriptionStart.length</span>
<span class="nc" id="L151">                        + descriptionEndIndex</span>
            )
<span class="nc" id="L153">            buffer.append(descriptionStart)</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            for (i in uploadMediaDetails.indices) {</span>
<span class="nc" id="L155">                val uploadDetails = uploadMediaDetails[i]</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (uploadDetails!!.descriptionText != &quot;&quot;) {</span>
<span class="nc" id="L157">                    buffer.append(&quot;{{&quot;)</span>
<span class="nc" id="L158">                    buffer.append(uploadDetails.languageCode)</span>
<span class="nc" id="L159">                    buffer.append(&quot;|1=&quot;)</span>
<span class="nc" id="L160">                    buffer.append(uploadDetails.descriptionText)</span>
<span class="nc" id="L161">                    buffer.append(&quot;}}&quot;)</span>
                }
            }
<span class="nc" id="L164">            buffer.replace(&quot;, $&quot;.toRegex(), &quot;&quot;)</span>
<span class="nc" id="L165">            buffer.append(descriptionEnd)</span>
        }
<span class="nc" id="L167">        val returningIntent = Intent()</span>
<span class="nc" id="L168">        returningIntent.putExtra(UPDATED_WIKITEXT, buffer.toString())</span>
<span class="nc" id="L169">        returningIntent.putParcelableArrayListExtra(</span>
<span class="nc" id="L170">            LIST_OF_DESCRIPTION_AND_CAPTION,</span>
<span class="nc" id="L171">            uploadMediaDetails as ArrayList&lt;out Parcelable?&gt;</span>
        )
<span class="nc" id="L173">        setResult(RESULT_OK, returningIntent)</span>
<span class="nc" id="L174">        finish()</span>
<span class="nc" id="L175">    }</span>

    private fun showLoggingProgressBar() {
<span class="nc" id="L178">        progressDialog = ProgressDialog(this)</span>
<span class="nc" id="L179">        progressDialog!!.isIndeterminate = true</span>
<span class="nc" id="L180">        progressDialog!!.setTitle(getString(R.string.updating_caption_title))</span>
<span class="nc" id="L181">        progressDialog!!.setMessage(getString(R.string.updating_caption_message))</span>
<span class="nc" id="L182">        progressDialog!!.setCanceledOnTouchOutside(false)</span>
<span class="nc" id="L183">        progressDialog!!.show()</span>
<span class="nc" id="L184">    }</span>

    override
    fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
<span class="nc" id="L188">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (requestCode == REQUEST_CODE_FOR_VOICE_INPUT) {</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">            if (resultCode == RESULT_OK &amp;&amp; data != null) {</span>
<span class="nc" id="L191">                val result = data.getStringArrayListExtra( RecognizerIntent.EXTRA_RESULTS )</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                uploadMediaDetailAdapter.handleSpeechResult(result!![0]) }</span>
<span class="nc" id="L193">            else { Timber.e(&quot;Error %s&quot;, resultCode) }</span>
        }
<span class="nc" id="L195">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>