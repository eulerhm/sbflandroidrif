<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NearbyNotificationCardView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.nearby</a> &gt; <span class="el_source">NearbyNotificationCardView.java</span></div><h1>NearbyNotificationCardView.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.nearby;

import android.content.Context;
import android.util.AttributeSet;
import android.view.View;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ProgressBar;
import android.widget.TextView;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.contributions.MainActivity;
import fr.free.nrw.commons.utils.SwipableCardView;
import fr.free.nrw.commons.utils.ViewUtil;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Custom card view for nearby notification card view on main screen, above contributions list
 */
public class NearbyNotificationCardView extends SwipableCardView {

    public Button permissionRequestButton;

    private LinearLayout contentLayout;

    private TextView notificationTitle;

    private TextView notificationDistance;

    private ImageView notificationIcon;

    private ImageView notificationCompass;

    private ProgressBar progressBar;

    public CardViewVisibilityState cardViewVisibilityState;

    public PermissionType permissionType;

    public NearbyNotificationCardView(@NonNull Context context) {
<span class="nc" id="L44">        super(context);</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3620)) {</span>
<span class="nc" id="L46">            cardViewVisibilityState = CardViewVisibilityState.INVISIBLE;</span>
        }
<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3621)) {</span>
<span class="nc" id="L49">            init();</span>
        }
<span class="nc" id="L51">    }</span>

    public NearbyNotificationCardView(@NonNull Context context, @Nullable AttributeSet attrs) {
<span class="fc" id="L54">        super(context, attrs);</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3622)) {</span>
<span class="fc" id="L56">            cardViewVisibilityState = CardViewVisibilityState.INVISIBLE;</span>
        }
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3623)) {</span>
<span class="fc" id="L59">            init();</span>
        }
<span class="fc" id="L61">    }</span>

    public NearbyNotificationCardView(@NonNull Context context, @Nullable AttributeSet attrs, int defStyleAttr) {
<span class="nc" id="L64">        super(context, attrs, defStyleAttr);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3624)) {</span>
<span class="nc" id="L66">            cardViewVisibilityState = CardViewVisibilityState.INVISIBLE;</span>
        }
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3625)) {</span>
<span class="nc" id="L69">            init();</span>
        }
<span class="nc" id="L71">    }</span>

    /**
     * Initializes views and action listeners
     */
    private void init() {
<span class="fc" id="L77">        View rootView = inflate(getContext(), R.layout.nearby_card_view, this);</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3626)) {</span>
<span class="fc" id="L79">            permissionRequestButton = rootView.findViewById(R.id.permission_request_button);</span>
        }
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3627)) {</span>
<span class="fc" id="L82">            contentLayout = rootView.findViewById(R.id.content_layout);</span>
        }
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3628)) {</span>
<span class="fc" id="L85">            notificationTitle = rootView.findViewById(R.id.nearby_title);</span>
        }
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3629)) {</span>
<span class="fc" id="L88">            notificationDistance = rootView.findViewById(R.id.nearby_distance);</span>
        }
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3630)) {</span>
<span class="fc" id="L91">            notificationIcon = rootView.findViewById(R.id.nearby_icon);</span>
        }
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3631)) {</span>
<span class="fc" id="L94">            notificationCompass = rootView.findViewById(R.id.nearby_compass);</span>
        }
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3632)) {</span>
<span class="fc" id="L97">            progressBar = rootView.findViewById(R.id.progressBar);</span>
        }
<span class="fc" id="L99">    }</span>

    @Override
    protected void onAttachedToWindow() {
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3633)) {</span>
<span class="fc" id="L104">            super.onAttachedToWindow();</span>
        }
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3638)) {</span>
            // If you don't setVisibility after getting layout params, then you will se an empty space in place of nearby NotificationCardView
<span class="pc bpc" id="L108" title="21 of 26 branches missed.">            if ((ListenerUtil.mutListener.listen(3635) ? ((ListenerUtil.mutListener.listen(3634) ? (getContext() instanceof MainActivity || ((MainActivity) getContext()).defaultKvStore.getBoolean(&quot;displayNearbyCardView&quot;, true)) : (getContext() instanceof MainActivity &amp;&amp; ((MainActivity) getContext()).defaultKvStore.getBoolean(&quot;displayNearbyCardView&quot;, true))) || this.cardViewVisibilityState == NearbyNotificationCardView.CardViewVisibilityState.READY) : ((ListenerUtil.mutListener.listen(3634) ? (getContext() instanceof MainActivity || ((MainActivity) getContext()).defaultKvStore.getBoolean(&quot;displayNearbyCardView&quot;, true)) : (getContext() instanceof MainActivity &amp;&amp; ((MainActivity) getContext()).defaultKvStore.getBoolean(&quot;displayNearbyCardView&quot;, true))) &amp;&amp; this.cardViewVisibilityState == NearbyNotificationCardView.CardViewVisibilityState.READY))) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3637)) {</span>
<span class="nc" id="L110">                    setVisibility(VISIBLE);</span>
                }
            } else {
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3636)) {</span>
<span class="fc" id="L114">                    setVisibility(GONE);</span>
                }
            }
        }
<span class="fc" id="L118">    }</span>

    private void setActionListeners(Place place) {
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3639)) {</span>
<span class="nc" id="L122">            this.setOnClickListener(view -&gt; {</span>
<span class="nc" id="L123">                ((MainActivity) getContext()).centerMapToPlace(place);</span>
<span class="nc" id="L124">            });</span>
        }
<span class="nc" id="L126">    }</span>

    @Override
    public boolean onSwipe(View view) {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3640)) {</span>
<span class="nc" id="L131">            view.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3641)) {</span>
            // Save shared preference for nearby card view accordingly
<span class="nc" id="L135">            ((MainActivity) getContext()).defaultKvStore.putBoolean(&quot;displayNearbyCardView&quot;, false);</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3642)) {</span>
<span class="nc" id="L138">            ViewUtil.showLongToast(getContext(), getResources().getString(R.string.nearby_notification_dismiss_message));</span>
        }
<span class="nc" id="L140">        return true;</span>
    }

    /**
     * Time is up, data for card view is not ready, so do not display it
     */
    private void errorOccurred() {
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3643)) {</span>
<span class="nc" id="L148">            this.setVisibility(GONE);</span>
        }
<span class="nc" id="L150">    }</span>

    /**
     * Data for card view is ready, display card view
     */
    private void succeeded() {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3644)) {</span>
<span class="nc" id="L157">            this.setVisibility(VISIBLE);</span>
        }
<span class="nc" id="L159">    }</span>

    /**
     * Pass place information to views
     *
     * @param place Closes place where we will get information from
     */
    public void updateContent(Place place) {
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3645)) {</span>
<span class="nc" id="L168">            Timber.d(&quot;Update nearby card notification content&quot;);</span>
        }
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3646)) {</span>
<span class="nc" id="L171">            this.setVisibility(VISIBLE);</span>
        }
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3647)) {</span>
<span class="nc" id="L174">            cardViewVisibilityState = CardViewVisibilityState.READY;</span>
        }
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3648)) {</span>
<span class="nc" id="L177">            permissionRequestButton.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3649)) {</span>
<span class="nc" id="L180">            contentLayout.setVisibility(VISIBLE);</span>
        }
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3650)) {</span>
            // Make progress bar invisible once data is ready
<span class="nc" id="L184">            progressBar.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3651)) {</span>
<span class="nc" id="L187">            setActionListeners(place);</span>
        }
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3652)) {</span>
            // And content views visible since they are ready
<span class="nc" id="L191">            notificationTitle.setVisibility(VISIBLE);</span>
        }
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3653)) {</span>
<span class="nc" id="L194">            notificationDistance.setVisibility(VISIBLE);</span>
        }
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3654)) {</span>
<span class="nc" id="L197">            notificationIcon.setVisibility(VISIBLE);</span>
        }
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3655)) {</span>
<span class="nc" id="L200">            notificationTitle.setText(place.name);</span>
        }
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3656)) {</span>
<span class="nc" id="L203">            notificationDistance.setText(place.distance);</span>
        }
<span class="nc" id="L205">    }</span>

    @Override
    protected void onVisibilityChanged(@NonNull View changedView, int visibility) {
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3657)) {</span>
<span class="fc" id="L210">            super.onVisibilityChanged(changedView, visibility);</span>
        }
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3676)) {</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">            if (visibility == VISIBLE) {</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3675)) {</span>
                    /*
              Sometimes we need to preserve previous state of notification card view without getting
              any data from user. Ie. wen user came back from Media Details fragment to Contrib List
              fragment, we need to know what was the state of card view, and set it to exact same state.
             */
<span class="pc bpc" id="L220" title="3 of 4 branches missed.">                    switch(cardViewVisibilityState) {</span>
                        case READY:
<span class="nc bnc" id="L222" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3658)) {</span>
<span class="nc" id="L223">                                permissionRequestButton.setVisibility(GONE);</span>
                            }
<span class="nc bnc" id="L225" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3659)) {</span>
<span class="nc" id="L226">                                contentLayout.setVisibility(VISIBLE);</span>
                            }
<span class="nc bnc" id="L228" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3660)) {</span>
                                // Make progress bar invisible once data is ready
<span class="nc" id="L230">                                progressBar.setVisibility(GONE);</span>
                            }
<span class="nc bnc" id="L232" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3661)) {</span>
                                // And content views visible since they are ready
<span class="nc" id="L234">                                notificationTitle.setVisibility(VISIBLE);</span>
                            }
<span class="nc bnc" id="L236" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3662)) {</span>
<span class="nc" id="L237">                                notificationDistance.setVisibility(VISIBLE);</span>
                            }
<span class="nc bnc" id="L239" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3663)) {</span>
<span class="nc" id="L240">                                notificationIcon.setVisibility(VISIBLE);</span>
                            }
<span class="nc bnc" id="L242" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3664)) {</span>
<span class="nc" id="L243">                                notificationCompass.setVisibility(VISIBLE);</span>
                            }
                            break;
                        case LOADING:
<span class="nc bnc" id="L247" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3665)) {</span>
<span class="nc" id="L248">                                permissionRequestButton.setVisibility(GONE);</span>
                            }
<span class="nc bnc" id="L250" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3666)) {</span>
<span class="nc" id="L251">                                contentLayout.setVisibility(VISIBLE);</span>
                            }
<span class="nc bnc" id="L253" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3667)) {</span>
                                // Set visibility of elements in content layout once it become visible
<span class="nc" id="L255">                                progressBar.setVisibility(VISIBLE);</span>
                            }
<span class="nc bnc" id="L257" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3668)) {</span>
<span class="nc" id="L258">                                notificationTitle.setVisibility(GONE);</span>
                            }
<span class="nc bnc" id="L260" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3669)) {</span>
<span class="nc" id="L261">                                notificationDistance.setVisibility(GONE);</span>
                            }
<span class="nc bnc" id="L263" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3670)) {</span>
<span class="nc" id="L264">                                notificationIcon.setVisibility(GONE);</span>
                            }
<span class="nc bnc" id="L266" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3671)) {</span>
<span class="nc" id="L267">                                notificationCompass.setVisibility(GONE);</span>
                            }
<span class="nc bnc" id="L269" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3672)) {</span>
<span class="nc" id="L270">                                permissionRequestButton.setVisibility(GONE);</span>
                            }
                            break;
                        case ASK_PERMISSION:
<span class="nc bnc" id="L274" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3673)) {</span>
<span class="nc" id="L275">                                contentLayout.setVisibility(GONE);</span>
                            }
<span class="nc bnc" id="L277" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3674)) {</span>
<span class="nc" id="L278">                                permissionRequestButton.setVisibility(VISIBLE);</span>
                            }
                            break;
                        default:
                            break;
                    }
                }
            }
        }
<span class="fc" id="L287">    }</span>

    /**
     * This states will help us to preserve progress bar and content layout states
     */
<span class="fc" id="L292">    public enum CardViewVisibilityState {</span>

<span class="fc" id="L294">        LOADING, READY, INVISIBLE, ASK_PERMISSION, ERROR_OCCURRED</span>
    }

    /**
     * We need to know which kind of permission we need to request, then update permission request
     * button action accordingly
     */
<span class="fc" id="L301">    public enum PermissionType {</span>

<span class="fc" id="L303">        ENABLE_GPS,</span>
        // For only after Marshmallow
<span class="fc" id="L305">        ENABLE_LOCATION_PERMISSION,</span>
<span class="fc" id="L306">        NO_PERMISSION_NEEDED</span>
    }

    /**
     * Rotates the compass arrow in tandem with the rotation of device
     *
     * @param rotateDegree Degree by which device was rotated
     * @param direction Direction in which arrow has to point
     */
    public void rotateCompass(float rotateDegree, float direction) {
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3681)) {</span>
<span class="pc bpc" id="L317" title="4 of 8 branches missed.">            notificationCompass.setRotation(-((ListenerUtil.mutListener.listen(3680) ? (rotateDegree % direction) : (ListenerUtil.mutListener.listen(3679) ? (rotateDegree / direction) : (ListenerUtil.mutListener.listen(3678) ? (rotateDegree * direction) : (ListenerUtil.mutListener.listen(3677) ? (rotateDegree + direction) : (rotateDegree - direction)))))));</span>
        }
<span class="fc" id="L319">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>