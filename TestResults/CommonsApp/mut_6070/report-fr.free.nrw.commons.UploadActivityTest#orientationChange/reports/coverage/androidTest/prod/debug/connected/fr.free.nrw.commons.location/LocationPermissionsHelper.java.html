<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocationPermissionsHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.location</a> &gt; <span class="el_source">LocationPermissionsHelper.java</span></div><h1>LocationPermissionsHelper.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.location;

import android.Manifest.permission;
import android.app.Activity;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.provider.Settings;
import androidx.core.app.ActivityCompat;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.filepicker.Constants;
import fr.free.nrw.commons.filepicker.Constants.RequestCodes;
import fr.free.nrw.commons.utils.DialogUtil;
import fr.free.nrw.commons.utils.PermissionUtils;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Helper class to handle location permissions
 */
public class LocationPermissionsHelper {

    Activity activity;

    LocationServiceManager locationManager;

    LocationPermissionCallback callback;

<span class="nc" id="L27">    public LocationPermissionsHelper(Activity activity, LocationServiceManager locationManager, LocationPermissionCallback callback) {</span>
<span class="nc bnc" id="L28" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1658)) {</span>
<span class="nc" id="L29">            this.activity = activity;</span>
        }
<span class="nc bnc" id="L31" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1659)) {</span>
<span class="nc" id="L32">            this.locationManager = locationManager;</span>
        }
<span class="nc bnc" id="L34" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1660)) {</span>
<span class="nc" id="L35">            this.callback = callback;</span>
        }
<span class="nc" id="L37">    }</span>

    public static class Dialog {

        int dialogTitleResource;

        int dialogTextResource;

<span class="nc" id="L45">        public Dialog(int dialogTitle, int dialogText) {</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1661)) {</span>
<span class="nc" id="L47">                dialogTitleResource = dialogTitle;</span>
            }
<span class="nc bnc" id="L49" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1662)) {</span>
<span class="nc" id="L50">                dialogTextResource = dialogText;</span>
            }
<span class="nc" id="L52">        }</span>
    }

    /**
     * Handles the entire location permissions flow
     *
     * @param locationAccessDialog
     * @param locationOffDialog
     */
    public void handleLocationPermissions(Dialog locationAccessDialog, Dialog locationOffDialog) {
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1663)) {</span>
<span class="nc" id="L63">            requestForLocationAccess(locationAccessDialog, locationOffDialog);</span>
        }
<span class="nc" id="L65">    }</span>

    /**
     * Ask for location permission if the user agrees on attaching location with pictures
     * and the app does not have the access to location
     *
     * @param locationAccessDialog
     * @param locationOffDialog
     */
    private void requestForLocationAccess(Dialog locationAccessDialog, Dialog locationOffDialog) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1670)) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (PermissionUtils.hasPermission(activity, new String[] { permission.ACCESS_FINE_LOCATION })) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1669)) {</span>
<span class="nc" id="L78">                    callback.onLocationPermissionGranted();</span>
                }
            } else {
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1668)) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    if (ActivityCompat.shouldShowRequestPermissionRationale(activity, permission.ACCESS_FINE_LOCATION)) {</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1667)) {</span>
<span class="nc bnc" id="L84" title="All 10 branches missed.">                            if ((ListenerUtil.mutListener.listen(1665) ? (locationAccessDialog != null || locationOffDialog != null) : (locationAccessDialog != null &amp;&amp; locationOffDialog != null))) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1666)) {</span>
<span class="nc" id="L86">                                    DialogUtil.showAlertDialog(activity, activity.getString(locationAccessDialog.dialogTitleResource), activity.getString(locationAccessDialog.dialogTextResource), activity.getString(android.R.string.ok), activity.getString(android.R.string.cancel), () -&gt; {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                                        if (!isLocationAccessToAppsTurnedOn()) {</span>
<span class="nc" id="L88">                                            showLocationOffDialog(activity);</span>
                                        } else {
<span class="nc" id="L90">                                            ActivityCompat.requestPermissions(activity, new String[] { permission.ACCESS_FINE_LOCATION }, 1);</span>
                                        }
<span class="nc" id="L92">                                    }, () -&gt; callback.onLocationPermissionDenied(activity.getString(R.string.in_app_camera_location_permission_denied)), null, false);</span>
                                }
                            }
                        }
                    } else {
<span class="nc bnc" id="L97" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1664)) {</span>
<span class="nc" id="L98">                            ActivityCompat.requestPermissions(activity, new String[] { permission.ACCESS_FINE_LOCATION }, RequestCodes.LOCATION);</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L104">    }</span>

    public void showLocationOffDialog(Activity activity) {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1671)) {</span>
<span class="nc" id="L108">            DialogUtil.showAlertDialog(activity, activity.getString(R.string.ask_to_turn_location_on), activity.getString(R.string.in_app_camera_needs_location), activity.getString(R.string.title_app_shortcut_setting), activity.getString(R.string.cancel), () -&gt; openLocationSettings(activity), () -&gt; callback.onLocationPermissionDenied(activity.getString(R.string.in_app_camera_location_unavailable)));</span>
        }
<span class="nc" id="L110">    }</span>

    public void openLocationSettings(Activity activity) {
<span class="nc" id="L113">        final Intent intent = new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS);</span>
<span class="nc" id="L114">        final PackageManager packageManager = activity.getPackageManager();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1673)) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (intent.resolveActivity(packageManager) != null) {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1672)) {</span>
<span class="nc" id="L118">                    activity.startActivity(intent);</span>
                }
            }
        }
<span class="nc" id="L122">    }</span>

    /**
     * Check if apps have access to location even after having individual access
     *
     * @return
     */
    public boolean isLocationAccessToAppsTurnedOn() {
<span class="nc bnc" id="L130" title="All 10 branches missed.">        return ((ListenerUtil.mutListener.listen(1674) ? (locationManager.isNetworkProviderEnabled() &amp;&amp; locationManager.isGPSProviderEnabled()) : (locationManager.isNetworkProviderEnabled() || locationManager.isGPSProviderEnabled())));</span>
    }

    /**
     * Handle onPermissionDenied within individual classes based on the requirements
     */
    public interface LocationPermissionCallback {

        void onLocationPermissionDenied(String toastMessage);

        void onLocationPermissionGranted();
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>