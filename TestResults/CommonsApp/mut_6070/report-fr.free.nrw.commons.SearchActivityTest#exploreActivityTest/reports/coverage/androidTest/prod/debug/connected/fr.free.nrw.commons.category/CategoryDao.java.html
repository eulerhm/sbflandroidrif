<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CategoryDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.category</a> &gt; <span class="el_source">CategoryDao.java</span></div><h1>CategoryDao.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.category;

import android.content.ContentProviderClient;
import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.os.RemoteException;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Provider;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

public class CategoryDao {

    private final Provider&lt;ContentProviderClient&gt; clientProvider;

    @Inject
<span class="nc" id="L23">    public CategoryDao(@Named(&quot;category&quot;) Provider&lt;ContentProviderClient&gt; clientProvider) {</span>
<span class="nc" id="L24">        this.clientProvider = clientProvider;</span>
<span class="nc" id="L25">    }</span>

    public void save(Category category) {
<span class="nc" id="L28">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L30" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(431)) {</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">                if (category.getContentUri() == null) {</span>
<span class="nc bnc" id="L32" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(430)) {</span>
<span class="nc" id="L33">                        category.setContentUri(db.insert(CategoryContentProvider.BASE_URI, toContentValues(category)));</span>
                    }
                } else {
<span class="nc bnc" id="L36" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(429)) {</span>
<span class="nc" id="L37">                        db.update(category.getContentUri(), toContentValues(category), null, null);</span>
                    }
                }
            }
<span class="nc" id="L41">        } catch (RemoteException e) {</span>
<span class="nc" id="L42">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L44" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(428)) {</span>
<span class="nc" id="L45">                db.release();</span>
            }
        }
<span class="nc" id="L48">    }</span>

    /**
     * Find persisted category in database, based on its name.
     *
     * @param name Category's name
     * @return category from database, or null if not found
     */
    @Nullable
    Category find(String name) {
<span class="nc" id="L58">        Cursor cursor = null;</span>
<span class="nc" id="L59">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L61" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(435)) {</span>
<span class="nc" id="L62">                cursor = db.query(CategoryContentProvider.BASE_URI, Table.ALL_FIELDS, Table.COLUMN_NAME + &quot;=?&quot;, new String[] { name }, null);</span>
            }
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(437)) {</span>
<span class="nc bnc" id="L65" title="All 10 branches missed.">                if ((ListenerUtil.mutListener.listen(436) ? (cursor != null || cursor.moveToFirst()) : (cursor != null &amp;&amp; cursor.moveToFirst()))) {</span>
<span class="nc" id="L66">                    return fromCursor(cursor);</span>
                }
            }
<span class="nc" id="L69">        } catch (RemoteException e) {</span>
            // This feels lazy, but to hell with checked exceptions. :)
<span class="nc" id="L71">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(433)) {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">                if (cursor != null) {</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(432)) {</span>
<span class="nc" id="L76">                        cursor.close();</span>
                    }
                }
            }
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(434)) {</span>
<span class="nc" id="L81">                db.release();</span>
            }
        }
<span class="nc" id="L84">        return null;</span>
    }

    /**
     * Retrieve recently-used categories, ordered by descending date.
     *
     * @return a list containing recent categories
     */
    @NonNull
    List&lt;CategoryItem&gt; recentCategories(int limit) {
<span class="nc" id="L94">        List&lt;CategoryItem&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L95">        Cursor cursor = null;</span>
<span class="nc" id="L96">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L98" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(441)) {</span>
<span class="nc" id="L99">                cursor = db.query(CategoryContentProvider.BASE_URI, Table.ALL_FIELDS, null, new String[] {}, Table.COLUMN_LAST_USED + &quot; DESC&quot;);</span>
            }
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(451)) {</span>
                {
<span class="nc" id="L103">                    long _loopCounter10 = 0;</span>
                    // fixme add a limit on the original query instead of falling out of the loop?
<span class="nc bnc" id="L105" title="All 66 branches missed.">                    while ((ListenerUtil.mutListener.listen(450) ? ((ListenerUtil.mutListener.listen(444) ? (cursor != null || cursor.moveToNext()) : (cursor != null &amp;&amp; cursor.moveToNext())) || (ListenerUtil.mutListener.listen(449) ? (cursor.getPosition() &gt;= limit) : (ListenerUtil.mutListener.listen(448) ? (cursor.getPosition() &lt;= limit) : (ListenerUtil.mutListener.listen(447) ? (cursor.getPosition() &gt; limit) : (ListenerUtil.mutListener.listen(446) ? (cursor.getPosition() != limit) : (ListenerUtil.mutListener.listen(445) ? (cursor.getPosition() == limit) : (cursor.getPosition() &lt; limit))))))) : ((ListenerUtil.mutListener.listen(444) ? (cursor != null || cursor.moveToNext()) : (cursor != null &amp;&amp; cursor.moveToNext())) &amp;&amp; (ListenerUtil.mutListener.listen(449) ? (cursor.getPosition() &gt;= limit) : (ListenerUtil.mutListener.listen(448) ? (cursor.getPosition() &lt;= limit) : (ListenerUtil.mutListener.listen(447) ? (cursor.getPosition() &gt; limit) : (ListenerUtil.mutListener.listen(446) ? (cursor.getPosition() != limit) : (ListenerUtil.mutListener.listen(445) ? (cursor.getPosition() == limit) : (cursor.getPosition() &lt; limit))))))))) {</span>
<span class="nc" id="L106">                        ListenerUtil.loopListener.listen(&quot;_loopCounter10&quot;, ++_loopCounter10);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(443)) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                            if (fromCursor(cursor).getName() != null) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(442)) {</span>
<span class="nc" id="L110">                                    items.add(new CategoryItem(fromCursor(cursor).getName(), fromCursor(cursor).getDescription(), fromCursor(cursor).getThumbnail(), false));</span>
                                }
                            }
                        }
                    }
                }
            }
<span class="nc" id="L117">        } catch (RemoteException e) {</span>
<span class="nc" id="L118">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(439)) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                if (cursor != null) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(438)) {</span>
<span class="nc" id="L123">                        cursor.close();</span>
                    }
                }
            }
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(440)) {</span>
<span class="nc" id="L128">                db.release();</span>
            }
        }
<span class="nc" id="L131">        return items;</span>
    }

    @NonNull
    Category fromCursor(Cursor cursor) {
        // Hardcoding column positions!
<span class="nc" id="L137">        return new Category(CategoryContentProvider.uriForId(cursor.getInt(cursor.getColumnIndex(Table.COLUMN_ID))), cursor.getString(cursor.getColumnIndex(Table.COLUMN_NAME)), cursor.getString(cursor.getColumnIndex(Table.COLUMN_DESCRIPTION)), cursor.getString(cursor.getColumnIndex(Table.COLUMN_THUMBNAIL)), new Date(cursor.getLong(cursor.getColumnIndex(Table.COLUMN_LAST_USED))), cursor.getInt(cursor.getColumnIndex(Table.COLUMN_TIMES_USED)));</span>
    }

    private ContentValues toContentValues(Category category) {
<span class="nc" id="L141">        ContentValues cv = new ContentValues();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(452)) {</span>
<span class="nc" id="L143">            cv.put(CategoryDao.Table.COLUMN_NAME, category.getName());</span>
        }
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(453)) {</span>
<span class="nc" id="L146">            cv.put(Table.COLUMN_DESCRIPTION, category.getDescription());</span>
        }
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(454)) {</span>
<span class="nc" id="L149">            cv.put(Table.COLUMN_THUMBNAIL, category.getThumbnail());</span>
        }
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(455)) {</span>
<span class="nc" id="L152">            cv.put(CategoryDao.Table.COLUMN_LAST_USED, category.getLastUsed().getTime());</span>
        }
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(456)) {</span>
<span class="nc" id="L155">            cv.put(CategoryDao.Table.COLUMN_TIMES_USED, category.getTimesUsed());</span>
        }
<span class="nc" id="L157">        return cv;</span>
    }

<span class="nc" id="L160">    public static class Table {</span>

        public static final String TABLE_NAME = &quot;categories&quot;;

        public static final String COLUMN_ID = &quot;_id&quot;;

        static final String COLUMN_NAME = &quot;name&quot;;

        static final String COLUMN_DESCRIPTION = &quot;description&quot;;

        static final String COLUMN_THUMBNAIL = &quot;thumbnail&quot;;

        static final String COLUMN_LAST_USED = &quot;last_used&quot;;

        static final String COLUMN_TIMES_USED = &quot;times_used&quot;;

        // NOTE! KEEP IN SAME ORDER AS THEY ARE DEFINED UP THERE. HELPS HARD CODE COLUMN INDICES.
<span class="fc" id="L177">        public static final String[] ALL_FIELDS = { COLUMN_ID, COLUMN_NAME, COLUMN_DESCRIPTION, COLUMN_THUMBNAIL, COLUMN_LAST_USED, COLUMN_TIMES_USED };</span>

        static final String DROP_TABLE_STATEMENT = &quot;DROP TABLE IF EXISTS &quot; + TABLE_NAME;

        static final String CREATE_TABLE_STATEMENT = &quot;CREATE TABLE &quot; + TABLE_NAME + &quot; (&quot; + COLUMN_ID + &quot; INTEGER PRIMARY KEY,&quot; + COLUMN_NAME + &quot; STRING,&quot; + COLUMN_DESCRIPTION + &quot; STRING,&quot; + COLUMN_THUMBNAIL + &quot; STRING,&quot; + COLUMN_LAST_USED + &quot; INTEGER,&quot; + COLUMN_TIMES_USED + &quot; INTEGER&quot; + &quot;);&quot;;

        public static void onCreate(SQLiteDatabase db) {
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(457)) {</span>
<span class="fc" id="L185">                db.execSQL(CREATE_TABLE_STATEMENT);</span>
            }
<span class="fc" id="L187">        }</span>

        public static void onDelete(SQLiteDatabase db) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(458)) {</span>
<span class="nc" id="L191">                db.execSQL(DROP_TABLE_STATEMENT);</span>
            }
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(459)) {</span>
<span class="nc" id="L194">                onCreate(db);</span>
            }
<span class="nc" id="L196">        }</span>

        public static void onUpdate(SQLiteDatabase db, int from, int to) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(465)) {</span>
<span class="nc bnc" id="L200" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(464) ? (from &gt;= to) : (ListenerUtil.mutListener.listen(463) ? (from &lt;= to) : (ListenerUtil.mutListener.listen(462) ? (from &gt; to) : (ListenerUtil.mutListener.listen(461) ? (from &lt; to) : (ListenerUtil.mutListener.listen(460) ? (from != to) : (from == to))))))) {</span>
<span class="nc" id="L201">                    return;</span>
                }
            }
<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(473)) {</span>
<span class="nc bnc" id="L205" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(470) ? (from &gt;= 4) : (ListenerUtil.mutListener.listen(469) ? (from &lt;= 4) : (ListenerUtil.mutListener.listen(468) ? (from &gt; 4) : (ListenerUtil.mutListener.listen(467) ? (from != 4) : (ListenerUtil.mutListener.listen(466) ? (from == 4) : (from &lt; 4))))))) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(471)) {</span>
                        // doesn't exist yet
<span class="nc" id="L208">                        from++;</span>
                    }
<span class="nc bnc" id="L210" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(472)) {</span>
<span class="nc" id="L211">                        onUpdate(db, from, to);</span>
                    }
<span class="nc" id="L213">                    return;</span>
                }
            }
<span class="nc bnc" id="L216" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(482)) {</span>
<span class="nc bnc" id="L217" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(478) ? (from &gt;= 4) : (ListenerUtil.mutListener.listen(477) ? (from &lt;= 4) : (ListenerUtil.mutListener.listen(476) ? (from &gt; 4) : (ListenerUtil.mutListener.listen(475) ? (from &lt; 4) : (ListenerUtil.mutListener.listen(474) ? (from != 4) : (from == 4))))))) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(479)) {</span>
                        // table added in version 5
<span class="nc" id="L220">                        onCreate(db);</span>
                    }
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(480)) {</span>
<span class="nc" id="L223">                        from++;</span>
                    }
<span class="nc bnc" id="L225" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(481)) {</span>
<span class="nc" id="L226">                        onUpdate(db, from, to);</span>
                    }
<span class="nc" id="L228">                    return;</span>
                }
            }
<span class="nc bnc" id="L231" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(490)) {</span>
<span class="nc bnc" id="L232" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(487) ? (from &gt;= 5) : (ListenerUtil.mutListener.listen(486) ? (from &lt;= 5) : (ListenerUtil.mutListener.listen(485) ? (from &gt; 5) : (ListenerUtil.mutListener.listen(484) ? (from &lt; 5) : (ListenerUtil.mutListener.listen(483) ? (from != 5) : (from == 5))))))) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(488)) {</span>
<span class="nc" id="L234">                        from++;</span>
                    }
<span class="nc bnc" id="L236" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(489)) {</span>
<span class="nc" id="L237">                        onUpdate(db, from, to);</span>
                    }
<span class="nc" id="L239">                    return;</span>
                }
            }
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(500)) {</span>
<span class="nc bnc" id="L243" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(495) ? (from &gt;= 17) : (ListenerUtil.mutListener.listen(494) ? (from &lt;= 17) : (ListenerUtil.mutListener.listen(493) ? (from &gt; 17) : (ListenerUtil.mutListener.listen(492) ? (from &lt; 17) : (ListenerUtil.mutListener.listen(491) ? (from != 17) : (from == 17))))))) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(496)) {</span>
<span class="nc" id="L245">                        db.execSQL(&quot;ALTER TABLE categories ADD COLUMN description STRING;&quot;);</span>
                    }
<span class="nc bnc" id="L247" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(497)) {</span>
<span class="nc" id="L248">                        db.execSQL(&quot;ALTER TABLE categories ADD COLUMN thumbnail STRING;&quot;);</span>
                    }
<span class="nc bnc" id="L250" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(498)) {</span>
<span class="nc" id="L251">                        from++;</span>
                    }
<span class="nc bnc" id="L253" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(499)) {</span>
<span class="nc" id="L254">                        onUpdate(db, from, to);</span>
                    }
<span class="nc" id="L256">                    return;</span>
                }
            }
<span class="nc" id="L259">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>