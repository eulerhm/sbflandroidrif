<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadMediaPresenter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.upload.mediaDetails</a> &gt; <span class="el_source">UploadMediaPresenter.java</span></div><h1>UploadMediaPresenter.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.upload.mediaDetails;

import static fr.free.nrw.commons.di.CommonsApplicationModule.IO_THREAD;
import static fr.free.nrw.commons.di.CommonsApplicationModule.MAIN_THREAD;
import static fr.free.nrw.commons.utils.ImageUtils.EMPTY_CAPTION;
import static fr.free.nrw.commons.utils.ImageUtils.FILE_NAME_EXISTS;
import static fr.free.nrw.commons.utils.ImageUtils.IMAGE_KEEP;
import static fr.free.nrw.commons.utils.ImageUtils.IMAGE_OK;
import androidx.annotation.Nullable;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.filepicker.UploadableFile;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LatLng;
import fr.free.nrw.commons.nearby.Place;
import fr.free.nrw.commons.repository.UploadRepository;
import fr.free.nrw.commons.upload.ImageCoordinates;
import fr.free.nrw.commons.upload.SimilarImageInterface;
import fr.free.nrw.commons.upload.UploadItem;
import fr.free.nrw.commons.upload.UploadMediaDetail;
import fr.free.nrw.commons.upload.mediaDetails.UploadMediaDetailsContract.UserActionListener;
import fr.free.nrw.commons.upload.mediaDetails.UploadMediaDetailsContract.View;
import io.github.coordinates2country.Coordinates2Country;
import io.reactivex.Maybe;
import io.reactivex.Scheduler;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.disposables.Disposable;
import java.lang.reflect.Proxy;
import java.net.UnknownHostException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import javax.inject.Inject;
import javax.inject.Named;
import org.jetbrains.annotations.NotNull;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

public class UploadMediaPresenter implements UserActionListener, SimilarImageInterface {

<span class="nc" id="L43">    private static final UploadMediaDetailsContract.View DUMMY = (UploadMediaDetailsContract.View) Proxy.newProxyInstance(UploadMediaDetailsContract.View.class.getClassLoader(), new Class[] { UploadMediaDetailsContract.View.class }, (proxy, method, methodArgs) -&gt; null);</span>

    private final UploadRepository repository;

<span class="nc" id="L47">    private UploadMediaDetailsContract.View view = DUMMY;</span>

    private CompositeDisposable compositeDisposable;

    private final JsonKvStore defaultKVStore;

    private Scheduler ioScheduler;

    private Scheduler mainThreadScheduler;

<span class="nc" id="L57">    private final List&lt;String&gt; WLM_SUPPORTED_COUNTRIES = Arrays.asList(&quot;am&quot;, &quot;at&quot;, &quot;az&quot;, &quot;br&quot;, &quot;hr&quot;, &quot;sv&quot;, &quot;fi&quot;, &quot;fr&quot;, &quot;de&quot;, &quot;gh&quot;, &quot;in&quot;, &quot;ie&quot;, &quot;il&quot;, &quot;mk&quot;, &quot;my&quot;, &quot;mt&quot;, &quot;pk&quot;, &quot;pe&quot;, &quot;pl&quot;, &quot;ru&quot;, &quot;rw&quot;, &quot;si&quot;, &quot;es&quot;, &quot;se&quot;, &quot;tw&quot;, &quot;ug&quot;, &quot;ua&quot;, &quot;us&quot;);</span>

<span class="nc" id="L59">    private Map&lt;String, String&gt; countryNamesAndCodes = null;</span>

    @Inject
<span class="nc" id="L62">    public UploadMediaPresenter(UploadRepository uploadRepository, @Named(&quot;default_preferences&quot;) JsonKvStore defaultKVStore, @Named(IO_THREAD) Scheduler ioScheduler, @Named(MAIN_THREAD) Scheduler mainThreadScheduler) {</span>
<span class="nc" id="L63">        this.repository = uploadRepository;</span>
<span class="nc" id="L64">        this.defaultKVStore = defaultKVStore;</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6625)) {</span>
<span class="nc" id="L66">            this.ioScheduler = ioScheduler;</span>
        }
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6626)) {</span>
<span class="nc" id="L69">            this.mainThreadScheduler = mainThreadScheduler;</span>
        }
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6627)) {</span>
<span class="nc" id="L72">            compositeDisposable = new CompositeDisposable();</span>
        }
<span class="nc" id="L74">    }</span>

    @Override
    public void onAttachView(View view) {
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6628)) {</span>
<span class="nc" id="L79">            this.view = view;</span>
        }
<span class="nc" id="L81">    }</span>

    @Override
    public void onDetachView() {
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6629)) {</span>
<span class="nc" id="L86">            this.view = DUMMY;</span>
        }
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6630)) {</span>
<span class="nc" id="L89">            compositeDisposable.clear();</span>
        }
<span class="nc" id="L91">    }</span>

    /**
     * Sets the Upload Media Details for the corresponding upload item
     *
     * @param uploadMediaDetails
     * @param uploadItemIndex
     */
    @Override
    public void setUploadMediaDetails(List&lt;UploadMediaDetail&gt; uploadMediaDetails, int uploadItemIndex) {
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6631)) {</span>
<span class="nc" id="L102">            repository.getUploads().get(uploadItemIndex).setMediaDetails(uploadMediaDetails);</span>
        }
<span class="nc" id="L104">    }</span>

    /**
     * Receives the corresponding uploadable file, processes it and return the view with and uplaod item
     *  @param uploadableFile
     * @param place
     */
    @Override
    public void receiveImage(final UploadableFile uploadableFile, final Place place, LatLng inAppPictureLocation) {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6632)) {</span>
<span class="nc" id="L114">            view.showProgress(true);</span>
        }
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6633)) {</span>
<span class="nc" id="L117">            compositeDisposable.add(repository.preProcessImage(uploadableFile, place, this, inAppPictureLocation).map(uploadItem -&gt; {</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">                if (place != null &amp;&amp; place.isMonument()) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                    if (place.location != null) {</span>
<span class="nc" id="L120">                        final String countryCode = reverseGeoCode(place.location);</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">                        if (countryCode != null &amp;&amp; WLM_SUPPORTED_COUNTRIES.contains(countryCode.toLowerCase())) {</span>
<span class="nc" id="L122">                            uploadItem.setWLMUpload(true);</span>
<span class="nc" id="L123">                            uploadItem.setCountryCode(countryCode.toLowerCase());</span>
                        }
                    }
                }
<span class="nc" id="L127">                return uploadItem;</span>
<span class="nc" id="L128">            }).subscribeOn(ioScheduler).observeOn(mainThreadScheduler).subscribe(uploadItem -&gt; {</span>
<span class="nc" id="L129">                view.onImageProcessed(uploadItem, place);</span>
<span class="nc" id="L130">                view.updateMediaDetails(uploadItem.getUploadMediaDetails());</span>
<span class="nc" id="L131">                final ImageCoordinates gpsCoords = uploadItem.getGpsCoords();</span>
<span class="nc bnc" id="L132" title="All 4 branches missed.">                final boolean hasImageCoordinates = gpsCoords != null &amp;&amp; gpsCoords.getImageCoordsExists();</span>
<span class="nc" id="L133">                view.showProgress(false);</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">                if (hasImageCoordinates &amp;&amp; place == null) {</span>
<span class="nc" id="L135">                    checkNearbyPlaces(uploadItem);</span>
                }
<span class="nc" id="L137">            }, throwable -&gt; Timber.e(throwable, &quot;Error occurred in processing images&quot;)));</span>
        }
<span class="nc" id="L139">    }</span>

    @Nullable
    private String reverseGeoCode(final LatLng latLng) {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6635)) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if (countryNamesAndCodes == null) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6634)) {</span>
<span class="nc" id="L146">                    countryNamesAndCodes = getCountryNamesAndCodes();</span>
                }
            }
        }
<span class="nc" id="L150">        return countryNamesAndCodes.get(Coordinates2Country.country(latLng.getLatitude(), latLng.getLongitude()));</span>
    }

    /**
     * Creates HashMap containing all ISO countries 2-letter codes provided by &lt;code&gt;Locale.getISOCountries()&lt;/code&gt;
     * and their english names
     *
     * @return HashMap where Key is country english name and Value is 2-letter country code
     * e.g. [&quot;Germany&quot;:&quot;DE&quot;, ...]
     */
    private Map&lt;String, String&gt; getCountryNamesAndCodes() {
<span class="nc" id="L161">        final Map&lt;String, String&gt; result = new HashMap&lt;&gt;();</span>
<span class="nc" id="L162">        final String[] isoCountries = Locale.getISOCountries();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6637)) {</span>
            {
<span class="nc" id="L165">                long _loopCounter102 = 0;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                for (final String isoCountry : isoCountries) {</span>
<span class="nc" id="L167">                    ListenerUtil.loopListener.listen(&quot;_loopCounter102&quot;, ++_loopCounter102);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6636)) {</span>
<span class="nc" id="L169">                        result.put(new Locale(&quot;en&quot;, isoCountry).getDisplayCountry(Locale.ENGLISH), isoCountry);</span>
                    }
                }
            }
        }
<span class="nc" id="L174">        return result;</span>
    }

    /**
     * This method checks for the nearest location that needs images and suggests it to the user.
     * @param uploadItem
     */
    private void checkNearbyPlaces(final UploadItem uploadItem) {
<span class="nc" id="L182">        final Disposable checkNearbyPlaces = Maybe.fromCallable(() -&gt; repository.checkNearbyPlaces(uploadItem.getGpsCoords().getDecLatitude(), uploadItem.getGpsCoords().getDecLongitude())).subscribeOn(ioScheduler).observeOn(mainThreadScheduler).subscribe(place -&gt; {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (place != null) {</span>
<span class="nc" id="L184">                view.onNearbyPlaceFound(uploadItem, place);</span>
            }
<span class="nc" id="L186">        }, throwable -&gt; Timber.e(throwable, &quot;Error occurred in processing images&quot;));</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6638)) {</span>
<span class="nc" id="L188">            compositeDisposable.add(checkNearbyPlaces);</span>
        }
<span class="nc" id="L190">    }</span>

    /**
     * asks the repository to verify image quality
     *
     * @param uploadItemIndex
     */
    @Override
    public boolean verifyImageQuality(int uploadItemIndex, LatLng inAppPictureLocation) {
<span class="nc" id="L199">        final List&lt;UploadItem&gt; uploadItems = repository.getUploads();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6641)) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (uploadItems.size() == 0) {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6639)) {</span>
<span class="nc" id="L203">                    view.showProgress(false);</span>
                }
<span class="nc bnc" id="L205" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6640)) {</span>
                    // No internationalization required for this error message because it's an internal error.
<span class="nc" id="L207">                    view.showMessage(&quot;Internal error: Zero upload items received by the Upload Media Detail Fragment. Sorry, please upload again.&quot;, R.color.color_error);</span>
                }
<span class="nc" id="L209">                return false;</span>
            }
        }
<span class="nc" id="L212">        UploadItem uploadItem = uploadItems.get(uploadItemIndex);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6646)) {</span>
<span class="nc bnc" id="L214" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(6642) ? (uploadItem.getGpsCoords().getDecimalCoords() == null || inAppPictureLocation == null) : (uploadItem.getGpsCoords().getDecimalCoords() == null &amp;&amp; inAppPictureLocation == null))) {</span>
<span class="nc" id="L215">                final Runnable onSkipClicked = () -&gt; {</span>
<span class="nc" id="L216">                    view.showProgress(true);</span>
<span class="nc" id="L217">                    compositeDisposable.add(repository.getImageQuality(uploadItem, inAppPictureLocation).observeOn(mainThreadScheduler).subscribe(imageResult -&gt; {</span>
<span class="nc" id="L218">                        view.showProgress(false);</span>
<span class="nc" id="L219">                        handleImageResult(imageResult, uploadItem);</span>
<span class="nc" id="L220">                    }, throwable -&gt; {</span>
<span class="nc" id="L221">                        view.showProgress(false);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                        if (throwable instanceof UnknownHostException) {</span>
<span class="nc" id="L223">                            view.showConnectionErrorPopup();</span>
                        } else {
<span class="nc" id="L225">                            view.showMessage(&quot;&quot; + throwable.getLocalizedMessage(), R.color.color_error);</span>
                        }
<span class="nc" id="L227">                        Timber.e(throwable, &quot;Error occurred while handling image&quot;);</span>
<span class="nc" id="L228">                    }));</span>
<span class="nc" id="L229">                };</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6645)) {</span>
<span class="nc" id="L231">                    view.displayAddLocationDialog(onSkipClicked);</span>
                }
<span class="nc" id="L233">            } else {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6643)) {</span>
<span class="nc" id="L235">                    view.showProgress(true);</span>
                }
<span class="nc bnc" id="L237" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6644)) {</span>
<span class="nc" id="L238">                    compositeDisposable.add(repository.getImageQuality(uploadItem, inAppPictureLocation).observeOn(mainThreadScheduler).subscribe(imageResult -&gt; {</span>
<span class="nc" id="L239">                        view.showProgress(false);</span>
<span class="nc" id="L240">                        handleImageResult(imageResult, uploadItem);</span>
<span class="nc" id="L241">                    }, throwable -&gt; {</span>
<span class="nc" id="L242">                        view.showProgress(false);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                        if (throwable instanceof UnknownHostException) {</span>
<span class="nc" id="L244">                            view.showConnectionErrorPopup();</span>
                        } else {
<span class="nc" id="L246">                            view.showMessage(&quot;&quot; + throwable.getLocalizedMessage(), R.color.color_error);</span>
                        }
<span class="nc" id="L248">                        Timber.e(throwable, &quot;Error occurred while handling image&quot;);</span>
<span class="nc" id="L249">                    }));</span>
                }
            }
        }
<span class="nc" id="L253">        return true;</span>
    }

    /**
     * Copies the caption and description of the current item to the subsequent media
     *
     * @param indexInViewFlipper
     */
    @Override
    public void copyTitleAndDescriptionToSubsequentMedia(int indexInViewFlipper) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6657)) {</span>
            {
<span class="nc" id="L265">                long _loopCounter103 = 0;</span>
<span class="nc bnc" id="L266" title="All 30 branches missed.">                for (int i = (ListenerUtil.mutListener.listen(6656) ? (indexInViewFlipper % 1) : (ListenerUtil.mutListener.listen(6655) ? (indexInViewFlipper / 1) : (ListenerUtil.mutListener.listen(6654) ? (indexInViewFlipper * 1) : (ListenerUtil.mutListener.listen(6653) ? (indexInViewFlipper - 1) : (indexInViewFlipper + 1))))); (ListenerUtil.mutListener.listen(6652) ? (i &gt;= repository.getCount()) : (ListenerUtil.mutListener.listen(6651) ? (i &lt;= repository.getCount()) : (ListenerUtil.mutListener.listen(6650) ? (i &gt; repository.getCount()) : (ListenerUtil.mutListener.listen(6649) ? (i != repository.getCount()) : (ListenerUtil.mutListener.listen(6648) ? (i == repository.getCount()) : (i &lt; repository.getCount())))))); i++) {</span>
<span class="nc" id="L267">                    ListenerUtil.loopListener.listen(&quot;_loopCounter103&quot;, ++_loopCounter103);</span>
<span class="nc" id="L268">                    final UploadItem subsequentUploadItem = repository.getUploads().get(i);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6647)) {</span>
<span class="nc" id="L270">                        subsequentUploadItem.setMediaDetails(deepCopy(repository.getUploads().get(indexInViewFlipper).getUploadMediaDetails()));</span>
                    }
                }
            }
        }
<span class="nc" id="L275">    }</span>

    /**
     * Fetches and set the caption and description of the item
     *
     * @param indexInViewFlipper
     */
    @Override
    public void fetchTitleAndDescription(int indexInViewFlipper) {
<span class="nc" id="L284">        final UploadItem currentUploadItem = repository.getUploads().get(indexInViewFlipper);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6658)) {</span>
<span class="nc" id="L286">            view.updateMediaDetails(currentUploadItem.getUploadMediaDetails());</span>
        }
<span class="nc" id="L288">    }</span>

    @NotNull
    private List&lt;UploadMediaDetail&gt; deepCopy(List&lt;UploadMediaDetail&gt; uploadMediaDetails) {
<span class="nc" id="L292">        final ArrayList&lt;UploadMediaDetail&gt; newList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6660)) {</span>
            {
<span class="nc" id="L295">                long _loopCounter104 = 0;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                for (UploadMediaDetail uploadMediaDetail : uploadMediaDetails) {</span>
<span class="nc" id="L297">                    ListenerUtil.loopListener.listen(&quot;_loopCounter104&quot;, ++_loopCounter104);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6659)) {</span>
<span class="nc" id="L299">                        newList.add(uploadMediaDetail.javaCopy());</span>
                    }
<span class="nc" id="L301">                }</span>
            }
        }
<span class="nc" id="L304">        return newList;</span>
    }

    @Override
    public void useSimilarPictureCoordinates(ImageCoordinates imageCoordinates, int uploadItemIndex) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6661)) {</span>
<span class="nc" id="L310">            repository.useSimilarPictureCoordinates(imageCoordinates, uploadItemIndex);</span>
        }
<span class="nc" id="L312">    }</span>

    @Override
    public void onMapIconClicked(int indexInViewFlipper) {
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6662)) {</span>
<span class="nc" id="L317">            view.showExternalMap(repository.getUploads().get(indexInViewFlipper));</span>
        }
<span class="nc" id="L319">    }</span>

    @Override
    public void onEditButtonClicked(int indexInViewFlipper) {
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6663)) {</span>
<span class="nc" id="L324">            view.showEditActivity(repository.getUploads().get(indexInViewFlipper));</span>
        }
<span class="nc" id="L326">    }</span>

    @Override
    public void onUserConfirmedUploadIsOfPlace(Place place, int uploadItemPosition) {
<span class="nc" id="L330">        final List&lt;UploadMediaDetail&gt; uploadMediaDetails = repository.getUploads().get(uploadItemPosition).getUploadMediaDetails();</span>
<span class="nc" id="L331">        UploadItem uploadItem = repository.getUploads().get(uploadItemPosition);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6664)) {</span>
<span class="nc" id="L333">            uploadItem.setPlace(place);</span>
        }
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6665)) {</span>
<span class="nc" id="L336">            uploadMediaDetails.set(0, new UploadMediaDetail(place));</span>
        }
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6666)) {</span>
<span class="nc" id="L339">            view.updateMediaDetails(uploadMediaDetails);</span>
        }
<span class="nc" id="L341">    }</span>

    /**
     * handles image quality verifications
     *
     * @param imageResult
     * @param uploadItem
     */
    public void handleImageResult(Integer imageResult, UploadItem uploadItem) {
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6671)) {</span>
<span class="nc bnc" id="L351" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(6667) ? (imageResult == IMAGE_KEEP &amp;&amp; imageResult == IMAGE_OK) : (imageResult == IMAGE_KEEP || imageResult == IMAGE_OK))) {</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6669)) {</span>
<span class="nc" id="L353">                    view.onImageValidationSuccess();</span>
                }
<span class="nc bnc" id="L355" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6670)) {</span>
<span class="nc" id="L356">                    uploadItem.setHasInvalidLocation(false);</span>
                }
            } else {
<span class="nc bnc" id="L359" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6668)) {</span>
<span class="nc" id="L360">                    handleBadImage(imageResult, uploadItem);</span>
                }
            }
        }
<span class="nc" id="L364">    }</span>

    /**
     * Handle  images, say empty caption, duplicate file name, bad picture(in all other cases)
     *
     * @param errorCode
     * @param uploadItem
     */
    public void handleBadImage(Integer errorCode, UploadItem uploadItem) {
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6672)) {</span>
<span class="nc" id="L374">            Timber.d(&quot;Handle bad picture with error code %d&quot;, errorCode);</span>
        }
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6679)) {</span>
<span class="nc bnc" id="L377" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(6677) ? (errorCode &lt;= 8) : (ListenerUtil.mutListener.listen(6676) ? (errorCode &gt; 8) : (ListenerUtil.mutListener.listen(6675) ? (errorCode &lt; 8) : (ListenerUtil.mutListener.listen(6674) ? (errorCode != 8) : (ListenerUtil.mutListener.listen(6673) ? (errorCode == 8) : (errorCode &gt;= 8))))))) {</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6678)) {</span>
                    // If location of image and nearby does not match
<span class="nc" id="L380">                    uploadItem.setHasInvalidLocation(true);</span>
                }
            }
        }
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6682)) {</span>
            // If errorCode is empty caption show message
<span class="nc bnc" id="L386" title="All 2 branches missed.">            if (errorCode == EMPTY_CAPTION) {</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6680)) {</span>
<span class="nc" id="L388">                    Timber.d(&quot;Captions are empty. Showing toast&quot;);</span>
                }
<span class="nc bnc" id="L390" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6681)) {</span>
<span class="nc" id="L391">                    view.showMessage(R.string.add_caption_toast, R.color.color_error);</span>
                }
            }
        }
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6690)) {</span>
            // If image with same file name exists check the bit in errorCode is set or not
<span class="nc bnc" id="L397" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(6687) ? ((errorCode &amp; FILE_NAME_EXISTS) &gt;= 0) : (ListenerUtil.mutListener.listen(6686) ? ((errorCode &amp; FILE_NAME_EXISTS) &lt;= 0) : (ListenerUtil.mutListener.listen(6685) ? ((errorCode &amp; FILE_NAME_EXISTS) &gt; 0) : (ListenerUtil.mutListener.listen(6684) ? ((errorCode &amp; FILE_NAME_EXISTS) &lt; 0) : (ListenerUtil.mutListener.listen(6683) ? ((errorCode &amp; FILE_NAME_EXISTS) == 0) : ((errorCode &amp; FILE_NAME_EXISTS) != 0))))))) {</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6688)) {</span>
<span class="nc" id="L399">                    Timber.d(&quot;Trying to show duplicate picture popup&quot;);</span>
                }
<span class="nc bnc" id="L401" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6689)) {</span>
<span class="nc" id="L402">                    view.showDuplicatePicturePopup(uploadItem);</span>
                }
            }
        }
<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6693)) {</span>
            // If image has some other problems, show popup accordingly
<span class="nc bnc" id="L408" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(6691) ? (errorCode != EMPTY_CAPTION || errorCode != FILE_NAME_EXISTS) : (errorCode != EMPTY_CAPTION &amp;&amp; errorCode != FILE_NAME_EXISTS))) {</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6692)) {</span>
<span class="nc" id="L410">                    view.showBadImagePopup(errorCode, uploadItem);</span>
                }
            }
        }
<span class="nc" id="L414">    }</span>

    /**
     * notifies the user that a similar image exists
     * @param originalFilePath
     * @param possibleFilePath
     * @param similarImageCoordinates
     */
    @Override
    public void showSimilarImageFragment(String originalFilePath, String possibleFilePath, ImageCoordinates similarImageCoordinates) {
<span class="nc bnc" id="L424" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6694)) {</span>
<span class="nc" id="L425">            view.showSimilarImageFragment(originalFilePath, possibleFilePath, similarImageCoordinates);</span>
        }
<span class="nc" id="L427">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>