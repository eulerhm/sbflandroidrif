<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoginActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.auth</a> &gt; <span class="el_source">LoginActivity.java</span></div><h1>LoginActivity.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.auth;

import android.accounts.AccountAuthenticatorActivity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextWatcher;
import android.view.KeyEvent;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.inputmethod.InputMethodManager;
import android.widget.TextView;
import androidx.annotation.ColorRes;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.StringRes;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatDelegate;
import androidx.core.app.NavUtils;
import androidx.core.content.ContextCompat;
import fr.free.nrw.commons.auth.login.LoginClient;
import fr.free.nrw.commons.auth.login.LoginResult;
import fr.free.nrw.commons.databinding.ActivityLoginBinding;
import fr.free.nrw.commons.utils.ActivityUtils;
import java.util.Locale;
import org.wikipedia.dataclient.mwapi.MwQueryResponse;
import fr.free.nrw.commons.auth.login.LoginCallback;
import javax.inject.Inject;
import javax.inject.Named;
import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.Utils;
import fr.free.nrw.commons.contributions.MainActivity;
import fr.free.nrw.commons.di.ApplicationlessInjection;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.utils.ConfigUtils;
import fr.free.nrw.commons.utils.SystemThemeUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import io.reactivex.disposables.CompositeDisposable;
import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;
import timber.log.Timber;
import static android.view.KeyEvent.KEYCODE_ENTER;
import static android.view.View.VISIBLE;
import static android.view.inputmethod.EditorInfo.IME_ACTION_DONE;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="fc" id="L54">public class LoginActivity extends AccountAuthenticatorActivity {</span>

    @Inject
    SessionManager sessionManager;

    @Inject
    @Named(&quot;default_preferences&quot;)
    JsonKvStore applicationKvStore;

    @Inject
    LoginClient loginClient;

    @Inject
    SystemThemeUtils systemThemeUtils;

    private ActivityLoginBinding binding;

    ProgressDialog progressDialog;

    private AppCompatDelegate delegate;

<span class="fc" id="L75">    private LoginTextWatcher textWatcher = new LoginTextWatcher();</span>

<span class="fc" id="L77">    private CompositeDisposable compositeDisposable = new CompositeDisposable();</span>

    private Call&lt;MwQueryResponse&gt; loginToken;

<span class="fc" id="L81">    final String saveProgressDailog = &quot;ProgressDailog_state&quot;;</span>

<span class="fc" id="L83">    final String saveErrorMessage = &quot;errorMessage&quot;;</span>

<span class="fc" id="L85">    final String saveUsername = &quot;username&quot;;</span>

<span class="fc" id="L87">    final String savePassword = &quot;password&quot;;</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1291)) {</span>
<span class="fc" id="L92">            super.onCreate(savedInstanceState);</span>
        }
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1292)) {</span>
<span class="fc" id="L95">            ApplicationlessInjection.getInstance(this.getApplicationContext()).getCommonsApplicationComponent().inject(this);</span>
        }
<span class="fc" id="L97">        boolean isDarkTheme = systemThemeUtils.isDeviceInNightMode();</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1293)) {</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">            setTheme(isDarkTheme ? R.style.DarkAppTheme : R.style.LightAppTheme);</span>
        }
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1294)) {</span>
<span class="fc" id="L102">            getDelegate().installViewFactory();</span>
        }
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1295)) {</span>
<span class="fc" id="L105">            getDelegate().onCreate(savedInstanceState);</span>
        }
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1296)) {</span>
<span class="fc" id="L108">            binding = ActivityLoginBinding.inflate(getLayoutInflater());</span>
        }
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1297)) {</span>
<span class="fc" id="L111">            setContentView(binding.getRoot());</span>
        }
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1298)) {</span>
<span class="fc" id="L114">            binding.loginUsername.addTextChangedListener(textWatcher);</span>
        }
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1299)) {</span>
<span class="fc" id="L117">            binding.loginPassword.addTextChangedListener(textWatcher);</span>
        }
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1300)) {</span>
<span class="fc" id="L120">            binding.loginTwoFactor.addTextChangedListener(textWatcher);</span>
        }
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1301)) {</span>
<span class="pc" id="L123">            binding.skipLogin.setOnClickListener(view -&gt; skipLogin());</span>
        }
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1302)) {</span>
<span class="pc" id="L126">            binding.forgotPassword.setOnClickListener(view -&gt; forgotPassword());</span>
        }
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1303)) {</span>
<span class="pc" id="L129">            binding.aboutPrivacyPolicy.setOnClickListener(view -&gt; onPrivacyPolicyClicked());</span>
        }
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1304)) {</span>
<span class="pc" id="L132">            binding.signUpButton.setOnClickListener(view -&gt; signUp());</span>
        }
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1305)) {</span>
<span class="fc" id="L135">            binding.loginButton.setOnClickListener(view -&gt; performLogin());</span>
        }
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1306)) {</span>
<span class="fc" id="L138">            binding.loginPassword.setOnEditorActionListener(this::onEditorAction);</span>
        }
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1307)) {</span>
<span class="fc" id="L141">            binding.loginPassword.setOnFocusChangeListener(this::onPasswordFocusChanged);</span>
        }
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1310)) {</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">            if (ConfigUtils.isBetaFlavour()) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1309)) {</span>
<span class="nc" id="L146">                    binding.loginCredentials.setText(getString(R.string.login_credential));</span>
                }
            } else {
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1308)) {</span>
<span class="fc" id="L150">                    binding.loginCredentials.setVisibility(View.GONE);</span>
                }
            }
        }
<span class="fc" id="L154">    }</span>

    /**
     * Hides the keyboard if the user's focus is not on the password (hasFocus is false).
     * @param view The keyboard
     * @param hasFocus Set to true if the keyboard has focus
     */
    void onPasswordFocusChanged(View view, boolean hasFocus) {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1312)) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (!hasFocus) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1311)) {</span>
<span class="nc" id="L165">                    ViewUtil.hideKeyboard(view);</span>
                }
            }
        }
<span class="nc" id="L169">    }</span>

    boolean onEditorAction(TextView textView, int actionId, KeyEvent keyEvent) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1317)) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (binding.loginButton.isEnabled()) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1316)) {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                    if (actionId == IME_ACTION_DONE) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1315)) {</span>
<span class="nc" id="L177">                            performLogin();</span>
                        }
<span class="nc" id="L179">                        return true;</span>
<span class="nc bnc" id="L180" title="All 10 branches missed.">                    } else if ((ListenerUtil.mutListener.listen(1313) ? ((keyEvent != null) || keyEvent.getKeyCode() == KEYCODE_ENTER) : ((keyEvent != null) &amp;&amp; keyEvent.getKeyCode() == KEYCODE_ENTER))) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1314)) {</span>
<span class="nc" id="L182">                            performLogin();</span>
                        }
<span class="nc" id="L184">                        return true;</span>
                    }
                }
            }
        }
<span class="nc" id="L189">        return false;</span>
    }

    protected void skipLogin() {
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1318)) {</span>
<span class="nc" id="L194">            new AlertDialog.Builder(this).setTitle(R.string.skip_login_title).setMessage(R.string.skip_login_message).setCancelable(false).setPositiveButton(R.string.yes, (dialog, which) -&gt; {</span>
<span class="nc" id="L195">                dialog.cancel();</span>
<span class="nc" id="L196">                performSkipLogin();</span>
<span class="nc" id="L197">            }).setNegativeButton(R.string.no, (dialog, which) -&gt; dialog.cancel()).show();</span>
        }
<span class="nc" id="L199">    }</span>

    protected void forgotPassword() {
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1319)) {</span>
<span class="nc" id="L203">            Utils.handleWebUrl(this, Uri.parse(BuildConfig.FORGOT_PASSWORD_URL));</span>
        }
<span class="nc" id="L205">    }</span>

    protected void onPrivacyPolicyClicked() {
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1320)) {</span>
<span class="nc" id="L209">            Utils.handleWebUrl(this, Uri.parse(BuildConfig.PRIVACY_POLICY_URL));</span>
        }
<span class="nc" id="L211">    }</span>

    protected void signUp() {
<span class="nc" id="L214">        Intent intent = new Intent(this, SignupActivity.class);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1321)) {</span>
<span class="nc" id="L216">            startActivity(intent);</span>
        }
<span class="nc" id="L218">    }</span>

    @Override
    protected void onPostCreate(Bundle savedInstanceState) {
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1322)) {</span>
<span class="fc" id="L223">            super.onPostCreate(savedInstanceState);</span>
        }
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1323)) {</span>
<span class="fc" id="L226">            getDelegate().onPostCreate(savedInstanceState);</span>
        }
<span class="fc" id="L228">    }</span>

    @Override
    protected void onResume() {
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1324)) {</span>
<span class="fc" id="L233">            super.onResume();</span>
        }
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1328)) {</span>
<span class="pc bpc" id="L236" title="8 of 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1325) ? (sessionManager.getCurrentAccount() != null || sessionManager.isUserLoggedIn()) : (sessionManager.getCurrentAccount() != null &amp;&amp; sessionManager.isUserLoggedIn()))) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1326)) {</span>
<span class="nc" id="L238">                    applicationKvStore.putBoolean(&quot;login_skipped&quot;, false);</span>
                }
<span class="nc bnc" id="L240" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1327)) {</span>
<span class="nc" id="L241">                    startMainActivity();</span>
                }
            }
        }
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1330)) {</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">            if (applicationKvStore.getBoolean(&quot;login_skipped&quot;, false)) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1329)) {</span>
<span class="nc" id="L248">                    performSkipLogin();</span>
                }
            }
        }
<span class="fc" id="L252">    }</span>

    @Override
    protected void onDestroy() {
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1331)) {</span>
<span class="fc" id="L257">            compositeDisposable.clear();</span>
        }
        try {
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1335)) {</span>
                // To prevent leaked window when finish() is called, see http://stackoverflow.com/questions/32065854/activity-has-leaked-window-at-alertdialog-show-method
<span class="pc bpc" id="L262" title="7 of 10 branches missed.">                if ((ListenerUtil.mutListener.listen(1333) ? (progressDialog != null || progressDialog.isShowing()) : (progressDialog != null &amp;&amp; progressDialog.isShowing()))) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1334)) {</span>
<span class="nc" id="L264">                        progressDialog.dismiss();</span>
                    }
                }
            }
<span class="nc" id="L268">        } catch (Exception e) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1332)) {</span>
<span class="nc" id="L270">                e.printStackTrace();</span>
            }
<span class="fc" id="L272">        }</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1336)) {</span>
<span class="fc" id="L274">            binding.loginUsername.removeTextChangedListener(textWatcher);</span>
        }
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1337)) {</span>
<span class="fc" id="L277">            binding.loginPassword.removeTextChangedListener(textWatcher);</span>
        }
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1338)) {</span>
<span class="fc" id="L280">            binding.loginTwoFactor.removeTextChangedListener(textWatcher);</span>
        }
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1339)) {</span>
<span class="fc" id="L283">            delegate.onDestroy();</span>
        }
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1341)) {</span>
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">            if (null != loginClient) {</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1340)) {</span>
<span class="fc" id="L288">                    loginClient.cancel();</span>
                }
            }
        }
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1342)) {</span>
<span class="fc" id="L293">            binding = null;</span>
        }
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1343)) {</span>
<span class="fc" id="L296">            super.onDestroy();</span>
        }
<span class="fc" id="L298">    }</span>

    public void performLogin() {
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1344)) {</span>
<span class="fc" id="L302">            Timber.d(&quot;Login to start!&quot;);</span>
        }
<span class="fc" id="L304">        final String username = binding.loginUsername.getText().toString();</span>
<span class="fc" id="L305">        final String rawUsername = binding.loginUsername.getText().toString().trim();</span>
<span class="fc" id="L306">        final String password = binding.loginPassword.getText().toString();</span>
<span class="fc" id="L307">        String twoFactorCode = binding.loginTwoFactor.getText().toString();</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1345)) {</span>
<span class="fc" id="L309">            showLoggingProgressBar();</span>
        }
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1346)) {</span>
<span class="fc" id="L312">            doLogin(username, password, twoFactorCode);</span>
        }
<span class="fc" id="L314">    }</span>

    private void doLogin(String username, String password, String twoFactorCode) {
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1347)) {</span>
<span class="fc" id="L318">            progressDialog.show();</span>
        }
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1348)) {</span>
<span class="fc" id="L321">            loginToken = loginClient.getLoginToken();</span>
        }
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1363)) {</span>
<span class="fc" id="L324">            loginToken.enqueue(new Callback&lt;MwQueryResponse&gt;() {</span>

                @Override
                public void onResponse(Call&lt;MwQueryResponse&gt; call, Response&lt;MwQueryResponse&gt; response) {
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1360)) {</span>
<span class="fc" id="L329">                        loginClient.login(username, password, null, twoFactorCode, response.body().query().loginToken(), Locale.getDefault().getLanguage(), new LoginCallback() {</span>

                            @Override
                            public void success(@NonNull LoginResult result) {
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1349)) {</span>
<span class="fc" id="L334">                                    Timber.d(&quot;Login Success&quot;);</span>
                                }
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1350)) {</span>
<span class="fc" id="L337">                                    onLoginSuccess(result);</span>
                                }
<span class="fc" id="L339">                            }</span>

                            @Override
                            public void twoFactorPrompt(@NonNull Throwable caught, @Nullable String token) {
<span class="nc bnc" id="L343" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1351)) {</span>
<span class="nc" id="L344">                                    Timber.d(&quot;Requesting 2FA prompt&quot;);</span>
                                }
<span class="nc bnc" id="L346" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1352)) {</span>
<span class="nc" id="L347">                                    hideProgress();</span>
                                }
<span class="nc bnc" id="L349" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1353)) {</span>
<span class="nc" id="L350">                                    askUserForTwoFactorAuth();</span>
                                }
<span class="nc" id="L352">                            }</span>

                            @Override
                            public void passwordResetPrompt(@Nullable String token) {
<span class="nc bnc" id="L356" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1354)) {</span>
<span class="nc" id="L357">                                    Timber.d(&quot;Showing password reset prompt&quot;);</span>
                                }
<span class="nc bnc" id="L359" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1355)) {</span>
<span class="nc" id="L360">                                    hideProgress();</span>
                                }
<span class="nc bnc" id="L362" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1356)) {</span>
<span class="nc" id="L363">                                    showPasswordResetPrompt();</span>
                                }
<span class="nc" id="L365">                            }</span>

                            @Override
                            public void error(@NonNull Throwable caught) {
<span class="nc bnc" id="L369" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1357)) {</span>
<span class="nc" id="L370">                                    Timber.e(caught);</span>
                                }
<span class="nc bnc" id="L372" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1358)) {</span>
<span class="nc" id="L373">                                    hideProgress();</span>
                                }
<span class="nc bnc" id="L375" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1359)) {</span>
<span class="nc" id="L376">                                    showMessageAndCancelDialog(caught.getLocalizedMessage());</span>
                                }
<span class="nc" id="L378">                            }</span>
                        });
                    }
<span class="fc" id="L381">                }</span>

                @Override
                public void onFailure(Call&lt;MwQueryResponse&gt; call, Throwable t) {
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1361)) {</span>
<span class="nc" id="L386">                        Timber.e(t);</span>
                    }
<span class="nc bnc" id="L388" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1362)) {</span>
<span class="nc" id="L389">                        showMessageAndCancelDialog(t.getLocalizedMessage());</span>
                    }
<span class="nc" id="L391">                }</span>
            });
        }
<span class="fc" id="L394">    }</span>

    private void hideProgress() {
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1364)) {</span>
<span class="nc" id="L398">            progressDialog.dismiss();</span>
        }
<span class="nc" id="L400">    }</span>

    private void showPasswordResetPrompt() {
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1365)) {</span>
<span class="nc" id="L404">            showMessageAndCancelDialog(getString(R.string.you_must_reset_your_passsword));</span>
        }
<span class="nc" id="L406">    }</span>

    /**
     * This function is called when user skips the login.
     * It redirects the user to Explore Activity.
     */
    private void performSkipLogin() {
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1366)) {</span>
<span class="nc" id="L414">            applicationKvStore.putBoolean(&quot;login_skipped&quot;, true);</span>
        }
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1367)) {</span>
<span class="nc" id="L417">            MainActivity.startYourself(this);</span>
        }
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1368)) {</span>
<span class="nc" id="L420">            finish();</span>
        }
<span class="nc" id="L422">    }</span>

    private void showLoggingProgressBar() {
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1369)) {</span>
<span class="fc" id="L426">            progressDialog = new ProgressDialog(this);</span>
        }
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1370)) {</span>
<span class="fc" id="L429">            progressDialog.setIndeterminate(true);</span>
        }
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1371)) {</span>
<span class="fc" id="L432">            progressDialog.setTitle(getString(R.string.logging_in_title));</span>
        }
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1372)) {</span>
<span class="fc" id="L435">            progressDialog.setMessage(getString(R.string.logging_in_message));</span>
        }
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1373)) {</span>
<span class="fc" id="L438">            progressDialog.setCanceledOnTouchOutside(false);</span>
        }
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1374)) {</span>
<span class="fc" id="L441">            progressDialog.show();</span>
        }
<span class="fc" id="L443">    }</span>

    private void onLoginSuccess(LoginResult loginResult) {
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1375)) {</span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">            if (!progressDialog.isShowing()) {</span>
                // no longer attached to activity!
<span class="nc" id="L449">                return;</span>
            }
        }
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1376)) {</span>
<span class="fc" id="L453">            compositeDisposable.clear();</span>
        }
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1377)) {</span>
<span class="fc" id="L456">            sessionManager.setUserLoggedIn(true);</span>
        }
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1378)) {</span>
<span class="fc" id="L459">            sessionManager.updateAccount(loginResult);</span>
        }
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1379)) {</span>
<span class="fc" id="L462">            progressDialog.dismiss();</span>
        }
<span class="pc bpc" id="L464" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1380)) {</span>
<span class="fc" id="L465">            showSuccessAndDismissDialog();</span>
        }
<span class="pc bpc" id="L467" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1381)) {</span>
<span class="fc" id="L468">            startMainActivity();</span>
        }
<span class="fc" id="L470">    }</span>

    @Override
    protected void onStart() {
<span class="pc bpc" id="L474" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1382)) {</span>
<span class="fc" id="L475">            super.onStart();</span>
        }
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1383)) {</span>
<span class="fc" id="L478">            delegate.onStart();</span>
        }
<span class="fc" id="L480">    }</span>

    @Override
    protected void onStop() {
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1384)) {</span>
<span class="fc" id="L485">            super.onStop();</span>
        }
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1385)) {</span>
<span class="fc" id="L488">            delegate.onStop();</span>
        }
<span class="fc" id="L490">    }</span>

    @Override
    protected void onPostResume() {
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1386)) {</span>
<span class="fc" id="L495">            super.onPostResume();</span>
        }
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1387)) {</span>
<span class="fc" id="L498">            getDelegate().onPostResume();</span>
        }
<span class="fc" id="L500">    }</span>

    @Override
    public void setContentView(View view, ViewGroup.LayoutParams params) {
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1388)) {</span>
<span class="nc" id="L505">            getDelegate().setContentView(view, params);</span>
        }
<span class="nc" id="L507">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1390)) {</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">            switch(item.getItemId()) {</span>
                case android.R.id.home:
<span class="nc bnc" id="L514" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1389)) {</span>
<span class="nc" id="L515">                        NavUtils.navigateUpFromSameTask(this);</span>
                    }
<span class="nc" id="L517">                    return true;</span>
            }
        }
<span class="nc" id="L520">        return super.onOptionsItemSelected(item);</span>
    }

    @Override
    @NonNull
    public MenuInflater getMenuInflater() {
<span class="nc" id="L526">        return getDelegate().getMenuInflater();</span>
    }

    public void askUserForTwoFactorAuth() {
<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1391)) {</span>
<span class="nc" id="L531">            progressDialog.dismiss();</span>
        }
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1392)) {</span>
<span class="nc" id="L534">            binding.twoFactorContainer.setVisibility(VISIBLE);</span>
        }
<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1393)) {</span>
<span class="nc" id="L537">            binding.loginTwoFactor.setVisibility(VISIBLE);</span>
        }
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1394)) {</span>
<span class="nc" id="L540">            binding.loginTwoFactor.requestFocus();</span>
        }
<span class="nc" id="L542">        InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1395)) {</span>
<span class="nc" id="L544">            imm.toggleSoftInput(InputMethodManager.SHOW_FORCED, InputMethodManager.HIDE_IMPLICIT_ONLY);</span>
        }
<span class="nc bnc" id="L546" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1396)) {</span>
<span class="nc" id="L547">            showMessageAndCancelDialog(R.string.login_failed_2fa_needed);</span>
        }
<span class="nc" id="L549">    }</span>

    public void showMessageAndCancelDialog(@StringRes int resId) {
<span class="nc bnc" id="L552" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1397)) {</span>
<span class="nc" id="L553">            showMessage(resId, R.color.secondaryDarkColor);</span>
        }
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1399)) {</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">            if (progressDialog != null) {</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1398)) {</span>
<span class="nc" id="L558">                    progressDialog.cancel();</span>
                }
            }
        }
<span class="nc" id="L562">    }</span>

    public void showMessageAndCancelDialog(String error) {
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1400)) {</span>
<span class="nc" id="L566">            showMessage(error, R.color.secondaryDarkColor);</span>
        }
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1402)) {</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">            if (progressDialog != null) {</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1401)) {</span>
<span class="nc" id="L571">                    progressDialog.cancel();</span>
                }
            }
        }
<span class="nc" id="L575">    }</span>

    public void showSuccessAndDismissDialog() {
<span class="pc bpc" id="L578" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1403)) {</span>
<span class="fc" id="L579">            showMessage(R.string.login_success, R.color.primaryDarkColor);</span>
        }
<span class="pc bpc" id="L581" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1404)) {</span>
<span class="fc" id="L582">            progressDialog.dismiss();</span>
        }
<span class="fc" id="L584">    }</span>

    public void startMainActivity() {
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1405)) {</span>
<span class="fc" id="L588">            ActivityUtils.startActivityWithFlags(this, MainActivity.class, Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
        }
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1406)) {</span>
<span class="fc" id="L591">            finish();</span>
        }
<span class="fc" id="L593">    }</span>

    private void showMessage(@StringRes int resId, @ColorRes int colorResId) {
<span class="pc bpc" id="L596" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1407)) {</span>
<span class="fc" id="L597">            binding.errorMessage.setText(getString(resId));</span>
        }
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1408)) {</span>
<span class="fc" id="L600">            binding.errorMessage.setTextColor(ContextCompat.getColor(this, colorResId));</span>
        }
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1409)) {</span>
<span class="fc" id="L603">            binding.errorMessageContainer.setVisibility(VISIBLE);</span>
        }
<span class="fc" id="L605">    }</span>

    private void showMessage(String message, @ColorRes int colorResId) {
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1410)) {</span>
<span class="nc" id="L609">            binding.errorMessage.setText(message);</span>
        }
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1411)) {</span>
<span class="nc" id="L612">            binding.errorMessage.setTextColor(ContextCompat.getColor(this, colorResId));</span>
        }
<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1412)) {</span>
<span class="nc" id="L615">            binding.errorMessageContainer.setVisibility(VISIBLE);</span>
        }
<span class="nc" id="L617">    }</span>

    private AppCompatDelegate getDelegate() {
<span class="pc bpc" id="L620" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1414)) {</span>
<span class="fc bfc" id="L621" title="All 2 branches covered.">            if (delegate == null) {</span>
<span class="pc bpc" id="L622" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1413)) {</span>
<span class="fc" id="L623">                    delegate = AppCompatDelegate.create(this, null);</span>
                }
            }
        }
<span class="fc" id="L627">        return delegate;</span>
    }

<span class="fc" id="L630">    private class LoginTextWatcher implements TextWatcher {</span>

        @Override
        public void beforeTextChanged(CharSequence charSequence, int start, int count, int after) {
<span class="fc" id="L634">        }</span>

        @Override
        public void onTextChanged(CharSequence charSequence, int start, int count, int after) {
<span class="fc" id="L638">        }</span>

        @Override
        public void afterTextChanged(Editable editable) {
<span class="pc bpc" id="L642" title="66 of 74 branches missed.">            boolean enabled = (ListenerUtil.mutListener.listen(1418) ? ((ListenerUtil.mutListener.listen(1415) ? (binding.loginUsername.getText().length() != 0 || binding.loginPassword.getText().length() != 0) : (binding.loginUsername.getText().length() != 0 &amp;&amp; binding.loginPassword.getText().length() != 0)) || ((ListenerUtil.mutListener.listen(1417) ? ((ListenerUtil.mutListener.listen(1416) ? (BuildConfig.DEBUG &amp;&amp; binding.loginTwoFactor.getText().length() != 0) : (BuildConfig.DEBUG || binding.loginTwoFactor.getText().length() != 0)) &amp;&amp; binding.loginTwoFactor.getVisibility() != VISIBLE) : ((ListenerUtil.mutListener.listen(1416) ? (BuildConfig.DEBUG &amp;&amp; binding.loginTwoFactor.getText().length() != 0) : (BuildConfig.DEBUG || binding.loginTwoFactor.getText().length() != 0)) || binding.loginTwoFactor.getVisibility() != VISIBLE)))) : ((ListenerUtil.mutListener.listen(1415) ? (binding.loginUsername.getText().length() != 0 || binding.loginPassword.getText().length() != 0) : (binding.loginUsername.getText().length() != 0 &amp;&amp; binding.loginPassword.getText().length() != 0)) &amp;&amp; ((ListenerUtil.mutListener.listen(1417) ? ((ListenerUtil.mutListener.listen(1416) ? (BuildConfig.DEBUG &amp;&amp; binding.loginTwoFactor.getText().length() != 0) : (BuildConfig.DEBUG || binding.loginTwoFactor.getText().length() != 0)) &amp;&amp; binding.loginTwoFactor.getVisibility() != VISIBLE) : ((ListenerUtil.mutListener.listen(1416) ? (BuildConfig.DEBUG &amp;&amp; binding.loginTwoFactor.getText().length() != 0) : (BuildConfig.DEBUG || binding.loginTwoFactor.getText().length() != 0)) || binding.loginTwoFactor.getVisibility() != VISIBLE)))));</span>
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1419)) {</span>
<span class="fc" id="L644">                binding.loginButton.setEnabled(enabled);</span>
            }
<span class="fc" id="L646">        }</span>
    }

    public static void startYourself(Context context) {
<span class="nc" id="L650">        Intent intent = new Intent(context, LoginActivity.class);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1420)) {</span>
<span class="nc" id="L652">            context.startActivity(intent);</span>
        }
<span class="nc" id="L654">    }</span>

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc bnc" id="L658" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1424)) {</span>
            // we maintain visibility of progressDailog after configuration change
<span class="nc bnc" id="L660" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1421) ? (progressDialog != null || progressDialog.isShowing()) : (progressDialog != null &amp;&amp; progressDialog.isShowing()))) {</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1423)) {</span>
<span class="nc" id="L662">                    outState.putBoolean(saveProgressDailog, true);</span>
                }
            } else {
<span class="nc bnc" id="L665" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1422)) {</span>
<span class="nc" id="L666">                    outState.putBoolean(saveProgressDailog, false);</span>
                }
            }
        }
<span class="nc bnc" id="L670" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1425)) {</span>
            // Save the errorMessage
<span class="nc" id="L672">            outState.putString(saveErrorMessage, binding.errorMessage.getText().toString());</span>
        }
<span class="nc bnc" id="L674" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1426)) {</span>
            // Save the username
<span class="nc" id="L676">            outState.putString(saveUsername, getUsername());</span>
        }
<span class="nc bnc" id="L678" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1427)) {</span>
            // Save the password
<span class="nc" id="L680">            outState.putString(savePassword, getPassword());</span>
        }
<span class="nc" id="L682">    }</span>

    private String getUsername() {
<span class="nc" id="L685">        return binding.loginUsername.getText().toString();</span>
    }

    private String getPassword() {
<span class="nc" id="L689">        return binding.loginPassword.getText().toString();</span>
    }

    @Override
    protected void onRestoreInstanceState(final Bundle savedInstanceState) {
<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1428)) {</span>
<span class="nc" id="L695">            super.onRestoreInstanceState(savedInstanceState);</span>
        }
<span class="nc bnc" id="L697" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1429)) {</span>
<span class="nc" id="L698">            binding.loginUsername.setText(savedInstanceState.getString(saveUsername));</span>
        }
<span class="nc bnc" id="L700" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1430)) {</span>
<span class="nc" id="L701">            binding.loginPassword.setText(savedInstanceState.getString(savePassword));</span>
        }
<span class="nc bnc" id="L703" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1432)) {</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">            if (savedInstanceState.getBoolean(saveProgressDailog)) {</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1431)) {</span>
<span class="nc" id="L706">                    performLogin();</span>
                }
            }
        }
<span class="nc" id="L710">        String errorMessage = savedInstanceState.getString(saveErrorMessage);</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1435)) {</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">            if (sessionManager.isUserLoggedIn()) {</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1434)) {</span>
<span class="nc" id="L714">                    showMessage(R.string.login_success, R.color.primaryDarkColor);</span>
                }
            } else {
<span class="nc bnc" id="L717" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1433)) {</span>
<span class="nc" id="L718">                    showMessage(errorMessage, R.color.secondaryDarkColor);</span>
                }
            }
        }
<span class="nc" id="L722">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>