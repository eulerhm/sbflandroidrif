<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookmarkPicturesDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.bookmarks.pictures</a> &gt; <span class="el_source">BookmarkPicturesDao.java</span></div><h1>BookmarkPicturesDao.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.bookmarks.pictures;

import android.content.ContentProviderClient;
import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.os.RemoteException;
import androidx.annotation.NonNull;
import java.util.ArrayList;
import java.util.List;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Provider;
import javax.inject.Singleton;
import fr.free.nrw.commons.bookmarks.models.Bookmark;
import static fr.free.nrw.commons.bookmarks.pictures.BookmarkPicturesContentProvider.BASE_URI;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

@Singleton
public class BookmarkPicturesDao {

    private final Provider&lt;ContentProviderClient&gt; clientProvider;

    @Inject
<span class="nc" id="L25">    public BookmarkPicturesDao(@Named(&quot;bookmarks&quot;) Provider&lt;ContentProviderClient&gt; clientProvider) {</span>
<span class="nc" id="L26">        this.clientProvider = clientProvider;</span>
<span class="nc" id="L27">    }</span>

    /**
     * Find all persisted pictures bookmarks on database
     *
     * @return list of bookmarks
     */
    @NonNull
    public List&lt;Bookmark&gt; getAllBookmarks() {
<span class="nc" id="L36">        List&lt;Bookmark&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L37">        Cursor cursor = null;</span>
<span class="nc" id="L38">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L40" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4743)) {</span>
<span class="nc" id="L41">                cursor = db.query(BookmarkPicturesContentProvider.BASE_URI, Table.ALL_FIELDS, null, new String[] {}, null);</span>
            }
<span class="nc bnc" id="L43" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4746)) {</span>
                {
<span class="nc" id="L45">                    long _loopCounter68 = 0;</span>
<span class="nc bnc" id="L46" title="All 10 branches missed.">                    while ((ListenerUtil.mutListener.listen(4745) ? (cursor != null || cursor.moveToNext()) : (cursor != null &amp;&amp; cursor.moveToNext()))) {</span>
<span class="nc" id="L47">                        ListenerUtil.loopListener.listen(&quot;_loopCounter68&quot;, ++_loopCounter68);</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(4744)) {</span>
<span class="nc" id="L49">                            items.add(fromCursor(cursor));</span>
                        }
                    }
                }
            }
<span class="nc" id="L54">        } catch (RemoteException e) {</span>
<span class="nc" id="L55">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L57" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4741)) {</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">                if (cursor != null) {</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4740)) {</span>
<span class="nc" id="L60">                        cursor.close();</span>
                    }
                }
            }
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4742)) {</span>
<span class="nc" id="L65">                db.release();</span>
            }
        }
<span class="nc" id="L68">        return items;</span>
    }

    /**
     * Look for a bookmark in database and in order to insert or delete it
     *
     * @param bookmark : Bookmark object
     * @return boolean : is bookmark now fav ?
     */
    public boolean updateBookmark(Bookmark bookmark) {
<span class="nc" id="L78">        boolean bookmarkExists = findBookmark(bookmark);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4749)) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (bookmarkExists) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4748)) {</span>
<span class="nc" id="L82">                    deleteBookmark(bookmark);</span>
                }
            } else {
<span class="nc bnc" id="L85" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4747)) {</span>
<span class="nc" id="L86">                    addBookmark(bookmark);</span>
                }
            }
        }
<span class="nc bnc" id="L90" title="All 2 branches missed.">        return !bookmarkExists;</span>
    }

    /**
     * Add a Bookmark to database
     *
     * @param bookmark : Bookmark to add
     */
    private void addBookmark(Bookmark bookmark) {
<span class="nc" id="L99">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4751)) {</span>
<span class="nc" id="L102">                db.insert(BASE_URI, toContentValues(bookmark));</span>
            }
<span class="nc" id="L104">        } catch (RemoteException e) {</span>
<span class="nc" id="L105">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4750)) {</span>
<span class="nc" id="L108">                db.release();</span>
            }
        }
<span class="nc" id="L111">    }</span>

    /**
     * Delete a bookmark from database
     *
     * @param bookmark : Bookmark to delete
     */
    private void deleteBookmark(Bookmark bookmark) {
<span class="nc" id="L119">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4754)) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (bookmark.getContentUri() == null) {</span>
<span class="nc" id="L123">                    throw new RuntimeException(&quot;tried to delete item with no content URI&quot;);</span>
                } else {
<span class="nc bnc" id="L125" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4753)) {</span>
<span class="nc" id="L126">                        db.delete(bookmark.getContentUri(), null, null);</span>
                    }
                }
            }
<span class="nc" id="L130">        } catch (RemoteException e) {</span>
<span class="nc" id="L131">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L133" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4752)) {</span>
<span class="nc" id="L134">                db.release();</span>
            }
        }
<span class="nc" id="L137">    }</span>

    /**
     * Find a bookmark from database based on its name
     *
     * @param bookmark : Bookmark to find
     * @return boolean : is bookmark in database ?
     */
    public boolean findBookmark(Bookmark bookmark) {
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4755)) {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (bookmark == null) {</span>
                // Avoiding NPE's
<span class="nc" id="L149">                return false;</span>
            }
        }
<span class="nc" id="L152">        Cursor cursor = null;</span>
<span class="nc" id="L153">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4759)) {</span>
<span class="nc" id="L156">                cursor = db.query(BookmarkPicturesContentProvider.BASE_URI, Table.ALL_FIELDS, Table.COLUMN_MEDIA_NAME + &quot;=?&quot;, new String[] { bookmark.getMediaName() }, null);</span>
            }
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4761)) {</span>
<span class="nc bnc" id="L159" title="All 10 branches missed.">                if ((ListenerUtil.mutListener.listen(4760) ? (cursor != null || cursor.moveToFirst()) : (cursor != null &amp;&amp; cursor.moveToFirst()))) {</span>
<span class="nc" id="L160">                    return true;</span>
                }
            }
<span class="nc" id="L163">        } catch (RemoteException e) {</span>
            // This feels lazy, but to hell with checked exceptions. :)
<span class="nc" id="L165">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4757)) {</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">                if (cursor != null) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4756)) {</span>
<span class="nc" id="L170">                        cursor.close();</span>
                    }
                }
            }
<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4758)) {</span>
<span class="nc" id="L175">                db.release();</span>
            }
        }
<span class="nc" id="L178">        return false;</span>
    }

    @NonNull
    Bookmark fromCursor(Cursor cursor) {
<span class="nc" id="L183">        String fileName = cursor.getString(cursor.getColumnIndex(Table.COLUMN_MEDIA_NAME));</span>
<span class="nc" id="L184">        return new Bookmark(fileName, cursor.getString(cursor.getColumnIndex(Table.COLUMN_CREATOR)), BookmarkPicturesContentProvider.uriForName(fileName));</span>
    }

    private ContentValues toContentValues(Bookmark bookmark) {
<span class="nc" id="L188">        ContentValues cv = new ContentValues();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4762)) {</span>
<span class="nc" id="L190">            cv.put(BookmarkPicturesDao.Table.COLUMN_MEDIA_NAME, bookmark.getMediaName());</span>
        }
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4763)) {</span>
<span class="nc" id="L193">            cv.put(BookmarkPicturesDao.Table.COLUMN_CREATOR, bookmark.getMediaCreator());</span>
        }
<span class="nc" id="L195">        return cv;</span>
    }

<span class="nc" id="L198">    public static class Table {</span>

        public static final String TABLE_NAME = &quot;bookmarks&quot;;

        public static final String COLUMN_MEDIA_NAME = &quot;media_name&quot;;

        public static final String COLUMN_CREATOR = &quot;media_creator&quot;;

        // NOTE! KEEP IN SAME ORDER AS THEY ARE DEFINED UP THERE. HELPS HARD CODE COLUMN INDICES.
<span class="nc" id="L207">        public static final String[] ALL_FIELDS = { COLUMN_MEDIA_NAME, COLUMN_CREATOR };</span>

        public static final String DROP_TABLE_STATEMENT = &quot;DROP TABLE IF EXISTS &quot; + TABLE_NAME;

        public static final String CREATE_TABLE_STATEMENT = &quot;CREATE TABLE &quot; + TABLE_NAME + &quot; (&quot; + COLUMN_MEDIA_NAME + &quot; STRING PRIMARY KEY,&quot; + COLUMN_CREATOR + &quot; STRING&quot; + &quot;);&quot;;

        public static void onCreate(SQLiteDatabase db) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4764)) {</span>
<span class="nc" id="L215">                db.execSQL(CREATE_TABLE_STATEMENT);</span>
            }
<span class="nc" id="L217">        }</span>

        public static void onDelete(SQLiteDatabase db) {
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4765)) {</span>
<span class="nc" id="L221">                db.execSQL(DROP_TABLE_STATEMENT);</span>
            }
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4766)) {</span>
<span class="nc" id="L224">                onCreate(db);</span>
            }
<span class="nc" id="L226">        }</span>

        public static void onUpdate(SQLiteDatabase db, int from, int to) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4772)) {</span>
<span class="nc bnc" id="L230" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(4771) ? (from &gt;= to) : (ListenerUtil.mutListener.listen(4770) ? (from &lt;= to) : (ListenerUtil.mutListener.listen(4769) ? (from &gt; to) : (ListenerUtil.mutListener.listen(4768) ? (from &lt; to) : (ListenerUtil.mutListener.listen(4767) ? (from != to) : (from == to))))))) {</span>
<span class="nc" id="L231">                    return;</span>
                }
            }
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4780)) {</span>
<span class="nc bnc" id="L235" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(4777) ? (from &gt;= 7) : (ListenerUtil.mutListener.listen(4776) ? (from &lt;= 7) : (ListenerUtil.mutListener.listen(4775) ? (from &gt; 7) : (ListenerUtil.mutListener.listen(4774) ? (from != 7) : (ListenerUtil.mutListener.listen(4773) ? (from == 7) : (from &lt; 7))))))) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4778)) {</span>
                        // doesn't exist yet
<span class="nc" id="L238">                        from++;</span>
                    }
<span class="nc bnc" id="L240" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4779)) {</span>
<span class="nc" id="L241">                        onUpdate(db, from, to);</span>
                    }
<span class="nc" id="L243">                    return;</span>
                }
            }
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4789)) {</span>
<span class="nc bnc" id="L247" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(4785) ? (from &gt;= 7) : (ListenerUtil.mutListener.listen(4784) ? (from &lt;= 7) : (ListenerUtil.mutListener.listen(4783) ? (from &gt; 7) : (ListenerUtil.mutListener.listen(4782) ? (from &lt; 7) : (ListenerUtil.mutListener.listen(4781) ? (from != 7) : (from == 7))))))) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4786)) {</span>
                        // table added in version 8
<span class="nc" id="L250">                        onCreate(db);</span>
                    }
<span class="nc bnc" id="L252" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4787)) {</span>
<span class="nc" id="L253">                        from++;</span>
                    }
<span class="nc bnc" id="L255" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4788)) {</span>
<span class="nc" id="L256">                        onUpdate(db, from, to);</span>
                    }
<span class="nc" id="L258">                    return;</span>
                }
            }
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4797)) {</span>
<span class="nc bnc" id="L262" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(4794) ? (from &gt;= 8) : (ListenerUtil.mutListener.listen(4793) ? (from &lt;= 8) : (ListenerUtil.mutListener.listen(4792) ? (from &gt; 8) : (ListenerUtil.mutListener.listen(4791) ? (from &lt; 8) : (ListenerUtil.mutListener.listen(4790) ? (from != 8) : (from == 8))))))) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4795)) {</span>
<span class="nc" id="L264">                        from++;</span>
                    }
<span class="nc bnc" id="L266" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(4796)) {</span>
<span class="nc" id="L267">                        onUpdate(db, from, to);</span>
                    }
<span class="nc" id="L269">                    return;</span>
                }
            }
<span class="nc" id="L272">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>