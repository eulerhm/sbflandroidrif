<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadableFile.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.filepicker</a> &gt; <span class="el_source">UploadableFile.java</span></div><h1>UploadableFile.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.filepicker;

import android.annotation.SuppressLint;
import android.content.Context;
import android.database.Cursor;
import android.net.Uri;
import android.os.Parcel;
import android.os.Parcelable;
import androidx.annotation.Nullable;
import androidx.exifinterface.media.ExifInterface;
import fr.free.nrw.commons.upload.FileUtils;
import java.io.File;
import java.io.IOException;
import java.util.Date;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

public class UploadableFile implements Parcelable {

<span class="nc" id="L20">    public static final Creator&lt;UploadableFile&gt; CREATOR = new Creator&lt;UploadableFile&gt;() {</span>

        @Override
        public UploadableFile createFromParcel(Parcel in) {
<span class="nc" id="L24">            return new UploadableFile(in);</span>
        }

        @Override
        public UploadableFile[] newArray(int size) {
<span class="nc" id="L29">            return new UploadableFile[size];</span>
        }
    };

    private final Uri contentUri;

    private final File file;

<span class="nc" id="L37">    public UploadableFile(Uri contentUri, File file) {</span>
<span class="nc" id="L38">        this.contentUri = contentUri;</span>
<span class="nc" id="L39">        this.file = file;</span>
<span class="nc" id="L40">    }</span>

<span class="nc" id="L42">    public UploadableFile(File file) {</span>
<span class="nc" id="L43">        this.file = file;</span>
<span class="nc" id="L44">        this.contentUri = Uri.fromFile(new File(file.getPath()));</span>
<span class="nc" id="L45">    }</span>

<span class="nc" id="L47">    public UploadableFile(Parcel in) {</span>
<span class="nc" id="L48">        this.contentUri = in.readParcelable(Uri.class.getClassLoader());</span>
<span class="nc" id="L49">        file = (File) in.readSerializable();</span>
<span class="nc" id="L50">    }</span>

    public Uri getContentUri() {
<span class="nc" id="L53">        return contentUri;</span>
    }

    public File getFile() {
<span class="nc" id="L57">        return file;</span>
    }

    public String getFilePath() {
<span class="nc" id="L61">        return file.getPath();</span>
    }

    public Uri getMediaUri() {
<span class="nc" id="L65">        return Uri.parse(getFilePath());</span>
    }

    public String getMimeType(Context context) {
<span class="nc" id="L69">        return FileUtils.getMimeType(context, getMediaUri());</span>
    }

    @Override
    public int describeContents() {
<span class="nc" id="L74">        return 0;</span>
    }

    /**
     * First try to get the file creation date from EXIF else fall back to CP
     * @param context
     * @return
     */
    @Nullable
    public DateTimeWithSource getFileCreatedDate(Context context) {
<span class="nc" id="L84">        DateTimeWithSource dateTimeFromExif = getDateTimeFromExif();</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (dateTimeFromExif == null) {</span>
<span class="nc" id="L86">            return getFileCreatedDateFromCP(context);</span>
        } else {
<span class="nc" id="L88">            return dateTimeFromExif;</span>
        }
    }

    /**
     * Get filePath creation date from uri from all possible content providers
     *
     * @return
     */
    private DateTimeWithSource getFileCreatedDateFromCP(Context context) {
        try {
<span class="nc" id="L99">            Cursor cursor = context.getContentResolver().query(contentUri, null, null, null, null);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (cursor == null) {</span>
                // Could not fetch last_modified
<span class="nc" id="L102">                return null;</span>
            }
            // If gallery is opened from in app
<span class="nc" id="L105">            int lastModifiedColumnIndex = cursor.getColumnIndex(&quot;last_modified&quot;);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6224)) {</span>
<span class="nc bnc" id="L107" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6222) ? (lastModifiedColumnIndex &gt;= -1) : (ListenerUtil.mutListener.listen(6221) ? (lastModifiedColumnIndex &lt;= -1) : (ListenerUtil.mutListener.listen(6220) ? (lastModifiedColumnIndex &gt; -1) : (ListenerUtil.mutListener.listen(6219) ? (lastModifiedColumnIndex &lt; -1) : (ListenerUtil.mutListener.listen(6218) ? (lastModifiedColumnIndex != -1) : (lastModifiedColumnIndex == -1))))))) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6223)) {</span>
<span class="nc" id="L109">                        lastModifiedColumnIndex = cursor.getColumnIndex(&quot;datetaken&quot;);</span>
                    }
                }
            }
            // If both the content providers do not give the data, lets leave it to Jesus
<span class="nc bnc" id="L114" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(6229) ? (lastModifiedColumnIndex &gt;= -1) : (ListenerUtil.mutListener.listen(6228) ? (lastModifiedColumnIndex &lt;= -1) : (ListenerUtil.mutListener.listen(6227) ? (lastModifiedColumnIndex &gt; -1) : (ListenerUtil.mutListener.listen(6226) ? (lastModifiedColumnIndex &lt; -1) : (ListenerUtil.mutListener.listen(6225) ? (lastModifiedColumnIndex != -1) : (lastModifiedColumnIndex == -1))))))) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6230)) {</span>
<span class="nc" id="L116">                    cursor.close();</span>
                }
<span class="nc" id="L118">                return null;</span>
            }
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6231)) {</span>
<span class="nc" id="L121">                cursor.moveToFirst();</span>
            }
<span class="nc" id="L123">            return new DateTimeWithSource(cursor.getLong(lastModifiedColumnIndex), DateTimeWithSource.CP_SOURCE);</span>
<span class="nc" id="L124">        } catch (Exception e) {</span>
            // //Could not fetch last_modified
<span class="nc" id="L126">            return null;</span>
        }
    }

    /**
     * Indicate whether the EXIF contains the location (both latitude and longitude).
     *
     * @return whether the location exists for the file's EXIF
     */
    public boolean hasLocation() {
        try {
<span class="nc" id="L137">            ExifInterface exif = new ExifInterface(file.getAbsolutePath());</span>
<span class="nc" id="L138">            final String latitude = exif.getAttribute(ExifInterface.TAG_GPS_LATITUDE);</span>
<span class="nc" id="L139">            final String longitude = exif.getAttribute(ExifInterface.TAG_GPS_LATITUDE);</span>
<span class="nc bnc" id="L140" title="All 10 branches missed.">            return (ListenerUtil.mutListener.listen(6234) ? (latitude != null || longitude != null) : (latitude != null &amp;&amp; longitude != null));</span>
<span class="nc" id="L141">        } catch (IOException | NumberFormatException | IndexOutOfBoundsException e) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6232)) {</span>
<span class="nc" id="L143">                Timber.tag(&quot;UploadableFile&quot;);</span>
            }
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6233)) {</span>
<span class="nc" id="L146">                Timber.d(e);</span>
            }
        }
<span class="nc" id="L149">        return false;</span>
    }

    /**
     * Get filePath creation date from uri from EXIF
     *
     * @return
     */
    private DateTimeWithSource getDateTimeFromExif() {
        try {
<span class="nc" id="L159">            ExifInterface exif = new ExifInterface(file.getAbsolutePath());</span>
            // See issue https://github.com/commons-app/apps-android-commons/issues/1971
<span class="nc" id="L161">            String dateTimeSubString = exif.getAttribute(ExifInterface.TAG_DATETIME_ORIGINAL);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6244)) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                if (dateTimeSubString != null) {</span>
                    // getAttribute may return null
<span class="nc" id="L165">                    String year = dateTimeSubString.substring(0, 4);</span>
<span class="nc" id="L166">                    String month = dateTimeSubString.substring(5, 7);</span>
<span class="nc" id="L167">                    String day = dateTimeSubString.substring(8, 10);</span>
                    // This date is stored as a string (not as a date), the rason is we don't want to include timezones
<span class="nc" id="L169">                    String dateCreatedString = String.format(&quot;%04d-%02d-%02d&quot;, Integer.parseInt(year), Integer.parseInt(month), Integer.parseInt(day));</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6243)) {</span>
<span class="nc bnc" id="L171" title="All 22 branches missed.">                        if ((ListenerUtil.mutListener.listen(6241) ? (dateCreatedString.length() &gt;= 10) : (ListenerUtil.mutListener.listen(6240) ? (dateCreatedString.length() &lt;= 10) : (ListenerUtil.mutListener.listen(6239) ? (dateCreatedString.length() &gt; 10) : (ListenerUtil.mutListener.listen(6238) ? (dateCreatedString.length() &lt; 10) : (ListenerUtil.mutListener.listen(6237) ? (dateCreatedString.length() != 10) : (dateCreatedString.length() == 10))))))) {</span>
                            // yyyy-MM-dd format of date is expected
                            @SuppressLint(&quot;RestrictedApi&quot;)
<span class="nc" id="L174">                            Long dateTime = exif.getDateTimeOriginal();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6242)) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                                if (dateTime != null) {</span>
<span class="nc" id="L177">                                    Date date = new Date(dateTime);</span>
<span class="nc" id="L178">                                    return new DateTimeWithSource(date, dateCreatedString, DateTimeWithSource.EXIF_SOURCE);</span>
                                }
                            }
                        }
                    }
                }
            }
<span class="nc" id="L185">        } catch (IOException | NumberFormatException | IndexOutOfBoundsException e) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6235)) {</span>
<span class="nc" id="L187">                Timber.tag(&quot;UploadableFile&quot;);</span>
            }
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6236)) {</span>
<span class="nc" id="L190">                Timber.d(e);</span>
            }
<span class="nc" id="L192">        }</span>
<span class="nc" id="L193">        return null;</span>
    }

    @Override
    public void writeToParcel(Parcel parcel, int i) {
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6245)) {</span>
<span class="nc" id="L199">            parcel.writeParcelable(contentUri, 0);</span>
        }
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6246)) {</span>
<span class="nc" id="L202">            parcel.writeSerializable(file);</span>
        }
<span class="nc" id="L204">    }</span>

    /**
     * This class contains the epochDate along with the source from which it was extracted
     */
    public class DateTimeWithSource {

        public static final String CP_SOURCE = &quot;contentProvider&quot;;

        public static final String EXIF_SOURCE = &quot;exif&quot;;

        private final long epochDate;

        // this does not includes timezone information
        private String dateString;

        private final String source;

<span class="nc" id="L222">        public DateTimeWithSource(long epochDate, String source) {</span>
<span class="nc" id="L223">            this.epochDate = epochDate;</span>
<span class="nc" id="L224">            this.source = source;</span>
<span class="nc" id="L225">        }</span>

<span class="nc" id="L227">        public DateTimeWithSource(Date date, String source) {</span>
<span class="nc" id="L228">            this.epochDate = date.getTime();</span>
<span class="nc" id="L229">            this.source = source;</span>
<span class="nc" id="L230">        }</span>

<span class="nc" id="L232">        public DateTimeWithSource(Date date, String dateString, String source) {</span>
<span class="nc" id="L233">            this.epochDate = date.getTime();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6247)) {</span>
<span class="nc" id="L235">                this.dateString = dateString;</span>
            }
<span class="nc" id="L237">            this.source = source;</span>
<span class="nc" id="L238">        }</span>

        public long getEpochDate() {
<span class="nc" id="L241">            return epochDate;</span>
        }

        public String getDateString() {
<span class="nc" id="L245">            return dateString;</span>
        }

        public String getSource() {
<span class="nc" id="L249">            return source;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>