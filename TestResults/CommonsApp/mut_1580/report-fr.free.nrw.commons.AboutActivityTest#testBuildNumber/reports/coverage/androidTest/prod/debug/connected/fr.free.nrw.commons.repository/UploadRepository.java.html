<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.repository</a> &gt; <span class="el_source">UploadRepository.java</span></div><h1>UploadRepository.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.repository;

import androidx.annotation.Nullable;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.category.CategoriesModel;
import fr.free.nrw.commons.category.CategoryItem;
import fr.free.nrw.commons.contributions.Contribution;
import fr.free.nrw.commons.contributions.ContributionDao;
import fr.free.nrw.commons.filepicker.UploadableFile;
import fr.free.nrw.commons.location.LatLng;
import fr.free.nrw.commons.nearby.NearbyPlaces;
import fr.free.nrw.commons.nearby.Place;
import fr.free.nrw.commons.upload.ImageCoordinates;
import fr.free.nrw.commons.upload.SimilarImageInterface;
import fr.free.nrw.commons.upload.UploadController;
import fr.free.nrw.commons.upload.UploadItem;
import fr.free.nrw.commons.upload.UploadModel;
import fr.free.nrw.commons.upload.structure.depictions.DepictModel;
import fr.free.nrw.commons.upload.structure.depictions.DepictedItem;
import io.reactivex.Flowable;
import io.reactivex.Observable;
import io.reactivex.Single;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Set;
import javax.inject.Inject;
import javax.inject.Singleton;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * The repository class for UploadActivity
 */
@Singleton
public class UploadRepository {

    private final UploadModel uploadModel;

    private final UploadController uploadController;

    private final CategoriesModel categoriesModel;

    private final NearbyPlaces nearbyPlaces;

    private final DepictModel depictModel;

    // 100 meters
    private static final double NEARBY_RADIUS_IN_KILO_METERS = 0.1;

    private final ContributionDao contributionDao;

    @Inject
<span class="nc" id="L55">    public UploadRepository(UploadModel uploadModel, UploadController uploadController, CategoriesModel categoriesModel, NearbyPlaces nearbyPlaces, DepictModel depictModel, ContributionDao contributionDao) {</span>
<span class="nc" id="L56">        this.uploadModel = uploadModel;</span>
<span class="nc" id="L57">        this.uploadController = uploadController;</span>
<span class="nc" id="L58">        this.categoriesModel = categoriesModel;</span>
<span class="nc" id="L59">        this.nearbyPlaces = nearbyPlaces;</span>
<span class="nc" id="L60">        this.depictModel = depictModel;</span>
<span class="nc" id="L61">        this.contributionDao = contributionDao;</span>
<span class="nc" id="L62">    }</span>

    /**
     * asks the RemoteDataSource to build contributions
     *
     * @return
     */
    public Observable&lt;Contribution&gt; buildContributions() {
<span class="nc" id="L70">        return uploadModel.buildContributions();</span>
    }

    public void prepareMedia(Contribution contribution) {
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(182)) {</span>
<span class="nc" id="L75">            uploadController.prepareMedia(contribution);</span>
        }
<span class="nc" id="L77">    }</span>

    public void saveContribution(Contribution contribution) {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(183)) {</span>
<span class="nc" id="L81">            contributionDao.save(contribution).blockingAwait();</span>
        }
<span class="nc" id="L83">    }</span>

    /**
     * Fetches and returns all the Upload Items
     *
     * @return
     */
    public List&lt;UploadItem&gt; getUploads() {
<span class="nc" id="L91">        return uploadModel.getUploads();</span>
    }

    /**
     *Prepare for a fresh upload
     */
    public void cleanup() {
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(184)) {</span>
<span class="nc" id="L99">            uploadModel.cleanUp();</span>
        }
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(185)) {</span>
            // This needs further refactoring, this should not be here, right now the structure wont suppoort rhis
<span class="nc" id="L103">            categoriesModel.cleanUp();</span>
        }
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(186)) {</span>
<span class="nc" id="L106">            depictModel.cleanUp();</span>
        }
<span class="nc" id="L108">    }</span>

    /**
     * Fetches and returns the selected categories for the current upload
     *
     * @return
     */
    public List&lt;CategoryItem&gt; getSelectedCategories() {
<span class="nc" id="L116">        return categoriesModel.getSelectedCategories();</span>
    }

    /**
     * all categories from MWApi
     *
     * @param query
     * @param imageTitleList
     * @param selectedDepictions
     * @return
     */
    public Observable&lt;List&lt;CategoryItem&gt;&gt; searchAll(String query, List&lt;String&gt; imageTitleList, List&lt;DepictedItem&gt; selectedDepictions) {
<span class="nc" id="L128">        return categoriesModel.searchAll(query, imageTitleList, selectedDepictions);</span>
    }

    /**
     * sets the list of selected categories for the current upload
     *
     * @param categoryStringList
     */
    public void setSelectedCategories(List&lt;String&gt; categoryStringList) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(187)) {</span>
<span class="nc" id="L138">            uploadModel.setSelectedCategories(categoryStringList);</span>
        }
<span class="nc" id="L140">    }</span>

    /**
     * handles the category selection/deselection
     *
     * @param categoryItem
     */
    public void onCategoryClicked(CategoryItem categoryItem, final Media media) {
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(188)) {</span>
<span class="nc" id="L149">            categoriesModel.onCategoryItemClicked(categoryItem, media);</span>
        }
<span class="nc" id="L151">    }</span>

    /**
     * prunes the category list for irrelevant categories see #750
     *
     * @param name
     * @return
     */
    public boolean containsYear(String name) {
<span class="nc" id="L160">        return categoriesModel.containsYear(name);</span>
    }

    /**
     * retursn the string list of available license from the LocalDataSource
     *
     * @return
     */
    public List&lt;String&gt; getLicenses() {
<span class="nc" id="L169">        return uploadModel.getLicenses();</span>
    }

    /**
     * returns the selected license for the current upload
     *
     * @return
     */
    public String getSelectedLicense() {
<span class="nc" id="L178">        return uploadModel.getSelectedLicense();</span>
    }

    /**
     * returns the number of Upload Items
     *
     * @return
     */
    public int getCount() {
<span class="nc" id="L187">        return uploadModel.getCount();</span>
    }

    /**
     * ask the RemoteDataSource to pre process the image
     *
     * @param uploadableFile
     * @param place
     * @param similarImageInterface
     * @return
     */
    public Observable&lt;UploadItem&gt; preProcessImage(UploadableFile uploadableFile, Place place, SimilarImageInterface similarImageInterface, LatLng inAppPictureLocation) {
<span class="nc" id="L199">        return uploadModel.preProcessImage(uploadableFile, place, similarImageInterface, inAppPictureLocation);</span>
    }

    /**
     * query the RemoteDataSource for image quality
     *
     * @param uploadItem
     * @return
     */
    public Single&lt;Integer&gt; getImageQuality(UploadItem uploadItem, LatLng location) {
<span class="nc" id="L209">        return uploadModel.getImageQuality(uploadItem, location);</span>
    }

    /**
     * asks the LocalDataSource to delete the file with the given file path
     *
     * @param filePath
     */
    public void deletePicture(String filePath) {
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(189)) {</span>
<span class="nc" id="L219">            uploadModel.deletePicture(filePath);</span>
        }
<span class="nc" id="L221">    }</span>

    /**
     * fetches and returns the upload item
     *
     * @param index
     * @return
     */
    public UploadItem getUploadItem(int index) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(195)) {</span>
<span class="nc bnc" id="L231" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(194) ? (index &lt;= 0) : (ListenerUtil.mutListener.listen(193) ? (index &gt; 0) : (ListenerUtil.mutListener.listen(192) ? (index &lt; 0) : (ListenerUtil.mutListener.listen(191) ? (index != 0) : (ListenerUtil.mutListener.listen(190) ? (index == 0) : (index &gt;= 0))))))) {</span>
<span class="nc" id="L232">                return uploadModel.getItems().get(index);</span>
            }
        }
        // There is no item to copy details
<span class="nc" id="L236">        return null;</span>
    }

    /**
     * set selected license for the current upload
     *
     * @param licenseName
     */
    public void setSelectedLicense(String licenseName) {
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(196)) {</span>
<span class="nc" id="L246">            uploadModel.setSelectedLicense(licenseName);</span>
        }
<span class="nc" id="L248">    }</span>

    public void onDepictItemClicked(DepictedItem depictedItem, final Media media) {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(197)) {</span>
<span class="nc" id="L252">            uploadModel.onDepictItemClicked(depictedItem, media);</span>
        }
<span class="nc" id="L254">    }</span>

    public List&lt;DepictedItem&gt; getSelectedDepictions() {
<span class="nc" id="L257">        return uploadModel.getSelectedDepictions();</span>
    }

    /**
     * Provides selected existing depicts
     *
     * @return selected existing depicts
     */
    public List&lt;String&gt; getSelectedExistingDepictions() {
<span class="nc" id="L266">        return uploadModel.getSelectedExistingDepictions();</span>
    }

    /**
     * Initialize existing depicts
     *
     * @param selectedExistingDepictions existing depicts
     */
    public void setSelectedExistingDepictions(final List&lt;String&gt; selectedExistingDepictions) {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(198)) {</span>
<span class="nc" id="L276">            uploadModel.setSelectedExistingDepictions(selectedExistingDepictions);</span>
        }
<span class="nc" id="L278">    }</span>

    public Flowable&lt;List&lt;DepictedItem&gt;&gt; searchAllEntities(String query) {
<span class="nc" id="L281">        return depictModel.searchAllEntities(query, this);</span>
    }

    /**
     * Gets the depiction for each unique {@link Place} associated with an {@link UploadItem}
     * from {@link #getUploads()}
     *
     * @return a single that provides the depictions
     */
    public Single&lt;List&lt;DepictedItem&gt;&gt; getPlaceDepictions() {
<span class="nc" id="L291">        final Set&lt;String&gt; qids = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(201)) {</span>
            {
<span class="nc" id="L294">                long _loopCounter2 = 0;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                for (final UploadItem item : getUploads()) {</span>
<span class="nc" id="L296">                    ListenerUtil.loopListener.listen(&quot;_loopCounter2&quot;, ++_loopCounter2);</span>
<span class="nc" id="L297">                    final Place place = item.getPlace();</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(200)) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                        if (place != null) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(199)) {</span>
<span class="nc" id="L301">                                qids.add(place.getWikiDataEntityId());</span>
                            }
                        }
                    }
<span class="nc" id="L305">                }</span>
            }
        }
<span class="nc" id="L308">        return depictModel.getPlaceDepictions(new ArrayList&lt;&gt;(qids));</span>
    }

    /**
     * Gets the category for each unique {@link Place} associated with an {@link UploadItem}
     * from {@link #getUploads()}
     *
     * @return a single that provides the categories
     */
    public Single&lt;List&lt;CategoryItem&gt;&gt; getPlaceCategories() {
<span class="nc" id="L318">        final Set&lt;String&gt; qids = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(204)) {</span>
            {
<span class="nc" id="L321">                long _loopCounter3 = 0;</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                for (final UploadItem item : getUploads()) {</span>
<span class="nc" id="L323">                    ListenerUtil.loopListener.listen(&quot;_loopCounter3&quot;, ++_loopCounter3);</span>
<span class="nc" id="L324">                    final Place place = item.getPlace();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(203)) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                        if (place != null) {</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(202)) {</span>
<span class="nc" id="L328">                                qids.add(place.getCategory());</span>
                            }
                        }
                    }
<span class="nc" id="L332">                }</span>
            }
        }
<span class="nc" id="L335">        return Single.fromObservable(categoriesModel.getCategoriesByName(new ArrayList&lt;&gt;(qids)));</span>
    }

    /**
     * Takes depict IDs as a parameter, converts into a slash separated String and Gets DepictItem
     * from the server
     *
     * @param depictionsQIDs IDs of Depiction
     * @return Flowable&lt;List&lt;DepictedItem&gt;&gt;
     */
    public Flowable&lt;List&lt;DepictedItem&gt;&gt; getDepictions(final List&lt;String&gt; depictionsQIDs) {
<span class="nc" id="L346">        final String ids = joinQIDs(depictionsQIDs);</span>
<span class="nc" id="L347">        return depictModel.getDepictions(ids).toFlowable();</span>
    }

    /**
     * Builds a string by joining all IDs divided by &quot;|&quot;
     *
     * @param depictionsQIDs IDs of depiction ex. [&quot;Q11023&quot;,&quot;Q1356&quot;]
     * @return string ex. &quot;Q11023|Q1356&quot;
     */
    private String joinQIDs(final List&lt;String&gt; depictionsQIDs) {
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(220)) {</span>
<span class="nc bnc" id="L358" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(205) ? (depictionsQIDs != null || !depictionsQIDs.isEmpty()) : (depictionsQIDs != null &amp;&amp; !depictionsQIDs.isEmpty()))) {</span>
<span class="nc" id="L359">                final StringBuilder buffer = new StringBuilder(depictionsQIDs.get(0));</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(219)) {</span>
<span class="nc bnc" id="L361" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(210) ? (depictionsQIDs.size() &gt;= 1) : (ListenerUtil.mutListener.listen(209) ? (depictionsQIDs.size() &lt;= 1) : (ListenerUtil.mutListener.listen(208) ? (depictionsQIDs.size() &lt; 1) : (ListenerUtil.mutListener.listen(207) ? (depictionsQIDs.size() != 1) : (ListenerUtil.mutListener.listen(206) ? (depictionsQIDs.size() == 1) : (depictionsQIDs.size() &gt; 1))))))) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(218)) {</span>
                            {
<span class="nc" id="L364">                                long _loopCounter4 = 0;</span>
<span class="nc bnc" id="L365" title="All 22 branches missed.">                                for (int i = 1; (ListenerUtil.mutListener.listen(217) ? (i &gt;= depictionsQIDs.size()) : (ListenerUtil.mutListener.listen(216) ? (i &lt;= depictionsQIDs.size()) : (ListenerUtil.mutListener.listen(215) ? (i &gt; depictionsQIDs.size()) : (ListenerUtil.mutListener.listen(214) ? (i != depictionsQIDs.size()) : (ListenerUtil.mutListener.listen(213) ? (i == depictionsQIDs.size()) : (i &lt; depictionsQIDs.size())))))); i++) {</span>
<span class="nc" id="L366">                                    ListenerUtil.loopListener.listen(&quot;_loopCounter4&quot;, ++_loopCounter4);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(211)) {</span>
<span class="nc" id="L368">                                        buffer.append(&quot;|&quot;);</span>
                                    }
<span class="nc bnc" id="L370" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(212)) {</span>
<span class="nc" id="L371">                                        buffer.append(depictionsQIDs.get(i));</span>
                                    }
                                }
                            }
                        }
                    }
                }
<span class="nc" id="L378">                return buffer.toString();</span>
            }
        }
<span class="nc" id="L381">        return null;</span>
    }

    /**
     * Returns nearest place matching the passed latitude and longitude
     * @param decLatitude
     * @param decLongitude
     * @return
     */
    @Nullable
    public Place checkNearbyPlaces(final double decLatitude, final double decLongitude) {
        try {
<span class="nc" id="L393">            final List&lt;Place&gt; fromWikidataQuery = nearbyPlaces.getFromWikidataQuery(new LatLng(decLatitude, decLongitude, 0.0f), Locale.getDefault().getLanguage(), NEARBY_RADIUS_IN_KILO_METERS, false, null);</span>
<span class="nc bnc" id="L394" title="All 50 branches missed.">            return ((ListenerUtil.mutListener.listen(227) ? (fromWikidataQuery != null || (ListenerUtil.mutListener.listen(226) ? (fromWikidataQuery.size() &gt;= 0) : (ListenerUtil.mutListener.listen(225) ? (fromWikidataQuery.size() &lt;= 0) : (ListenerUtil.mutListener.listen(224) ? (fromWikidataQuery.size() &lt; 0) : (ListenerUtil.mutListener.listen(223) ? (fromWikidataQuery.size() != 0) : (ListenerUtil.mutListener.listen(222) ? (fromWikidataQuery.size() == 0) : (fromWikidataQuery.size() &gt; 0))))))) : (fromWikidataQuery != null &amp;&amp; (ListenerUtil.mutListener.listen(226) ? (fromWikidataQuery.size() &gt;= 0) : (ListenerUtil.mutListener.listen(225) ? (fromWikidataQuery.size() &lt;= 0) : (ListenerUtil.mutListener.listen(224) ? (fromWikidataQuery.size() &lt; 0) : (ListenerUtil.mutListener.listen(223) ? (fromWikidataQuery.size() != 0) : (ListenerUtil.mutListener.listen(222) ? (fromWikidataQuery.size() == 0) : (fromWikidataQuery.size() &gt; 0))))))))) ? fromWikidataQuery.get(0) : null;</span>
<span class="nc" id="L395">        } catch (final Exception e) {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(221)) {</span>
<span class="nc" id="L397">                Timber.e(&quot;Error fetching nearby places: %s&quot;, e.getMessage());</span>
            }
<span class="nc" id="L399">            return null;</span>
        }
    }

    public void useSimilarPictureCoordinates(ImageCoordinates imageCoordinates, int uploadItemIndex) {
<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(228)) {</span>
<span class="nc" id="L405">            uploadModel.useSimilarPictureCoordinates(imageCoordinates, uploadItemIndex);</span>
        }
<span class="nc" id="L407">    }</span>

    public boolean isWMLSupportedForThisPlace() {
<span class="nc" id="L410">        return uploadModel.getItems().get(0).isWLMUpload();</span>
    }

    /**
     * Provides selected existing categories
     *
     * @return selected existing categories
     */
    public List&lt;String&gt; getSelectedExistingCategories() {
<span class="nc" id="L419">        return categoriesModel.getSelectedExistingCategories();</span>
    }

    /**
     * Initialize existing categories
     *
     * @param selectedExistingCategories existing categories
     */
    public void setSelectedExistingCategories(final List&lt;String&gt; selectedExistingCategories) {
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(229)) {</span>
<span class="nc" id="L429">            categoriesModel.setSelectedExistingCategories(selectedExistingCategories);</span>
        }
<span class="nc" id="L431">    }</span>

    /**
     * Takes category names and Gets CategoryItem from the server
     *
     * @param categories names of Category
     * @return Observable&lt;List&lt;CategoryItem&gt;&gt;
     */
    public Observable&lt;List&lt;CategoryItem&gt;&gt; getCategories(final List&lt;String&gt; categories) {
<span class="nc" id="L440">        return categoriesModel.getCategoriesByName(categories);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>