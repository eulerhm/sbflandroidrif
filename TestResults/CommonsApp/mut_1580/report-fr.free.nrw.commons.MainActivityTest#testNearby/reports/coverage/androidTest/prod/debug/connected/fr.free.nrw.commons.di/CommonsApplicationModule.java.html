<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonsApplicationModule.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.di</a> &gt; <span class="el_source">CommonsApplicationModule.java</span></div><h1>CommonsApplicationModule.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.di;

import android.app.Activity;
import android.content.ContentProviderClient;
import android.content.ContentResolver;
import android.content.Context;
import android.view.inputmethod.InputMethodManager;
import androidx.collection.LruCache;
import androidx.room.Room;
import androidx.room.migration.Migration;
import androidx.sqlite.db.SupportSQLiteDatabase;
import com.google.gson.Gson;
import dagger.Module;
import dagger.Provides;
import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.auth.AccountUtil;
import fr.free.nrw.commons.auth.SessionManager;
import fr.free.nrw.commons.contributions.ContributionDao;
import fr.free.nrw.commons.customselector.database.NotForUploadStatusDao;
import fr.free.nrw.commons.customselector.database.UploadedStatusDao;
import fr.free.nrw.commons.customselector.ui.selector.ImageFileLoader;
import fr.free.nrw.commons.data.DBOpenHelper;
import fr.free.nrw.commons.db.AppDatabase;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LocationServiceManager;
import fr.free.nrw.commons.review.ReviewDao;
import fr.free.nrw.commons.settings.Prefs;
import fr.free.nrw.commons.upload.UploadController;
import fr.free.nrw.commons.upload.depicts.DepictsDao;
import fr.free.nrw.commons.utils.ConfigUtils;
import fr.free.nrw.commons.wikidata.WikidataEditListener;
import fr.free.nrw.commons.wikidata.WikidataEditListenerImpl;
import io.reactivex.Scheduler;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.schedulers.Schedulers;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import javax.inject.Named;
import javax.inject.Singleton;
import org.wikipedia.AppAdapter;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * The Dependency Provider class for Commons Android.
 *
 * Provides all sorts of ContentProviderClients used by the app
 * along with the Liscences, AccountUtility, UploadController, Logged User,
 * Location manager etc
 */
@Module
@SuppressWarnings({ &quot;WeakerAccess&quot;, &quot;unused&quot; })
public class CommonsApplicationModule {

    private Context applicationContext;

    public static final String IO_THREAD = &quot;io_thread&quot;;

    public static final String MAIN_THREAD = &quot;main_thread&quot;;

    private AppDatabase appDatabase;

<span class="fc" id="L66">    static final Migration MIGRATION_1_2 = new Migration(1, 2) {</span>

        @Override
        public void migrate(SupportSQLiteDatabase database) {
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(256)) {</span>
<span class="nc" id="L71">                database.execSQL(&quot;ALTER TABLE contribution &quot; + &quot; ADD COLUMN hasInvalidLocation INTEGER NOT NULL DEFAULT 0&quot;);</span>
            }
<span class="nc" id="L73">        }</span>
    };

<span class="fc" id="L76">    public CommonsApplicationModule(Context applicationContext) {</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(257)) {</span>
<span class="fc" id="L78">            this.applicationContext = applicationContext;</span>
        }
<span class="fc" id="L80">    }</span>

    /**
     * Provides ImageFileLoader used to fetch device images.
     * @param context
     * @return
     */
    @Provides
    public ImageFileLoader providesImageFileLoader(Context context) {
<span class="nc" id="L89">        return new ImageFileLoader(context);</span>
    }

    @Provides
    public Context providesApplicationContext() {
<span class="fc" id="L94">        return this.applicationContext;</span>
    }

    @Provides
    public InputMethodManager provideInputMethodManager() {
<span class="nc" id="L99">        return (InputMethodManager) applicationContext.getSystemService(Activity.INPUT_METHOD_SERVICE);</span>
    }

    @Provides
    @Named(&quot;licenses&quot;)
    public List&lt;String&gt; provideLicenses(Context context) {
<span class="nc" id="L105">        List&lt;String&gt; licenseItems = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(258)) {</span>
<span class="nc" id="L107">            licenseItems.add(context.getString(R.string.license_name_cc0));</span>
        }
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(259)) {</span>
<span class="nc" id="L110">            licenseItems.add(context.getString(R.string.license_name_cc_by));</span>
        }
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(260)) {</span>
<span class="nc" id="L113">            licenseItems.add(context.getString(R.string.license_name_cc_by_sa));</span>
        }
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(261)) {</span>
<span class="nc" id="L116">            licenseItems.add(context.getString(R.string.license_name_cc_by_four));</span>
        }
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(262)) {</span>
<span class="nc" id="L119">            licenseItems.add(context.getString(R.string.license_name_cc_by_sa_four));</span>
        }
<span class="nc" id="L121">        return licenseItems;</span>
    }

    @Provides
    @Named(&quot;licenses_by_name&quot;)
    public Map&lt;String, String&gt; provideLicensesByName(Context context) {
<span class="nc" id="L127">        Map&lt;String, String&gt; byName = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(263)) {</span>
<span class="nc" id="L129">            byName.put(context.getString(R.string.license_name_cc0), Prefs.Licenses.CC0);</span>
        }
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(264)) {</span>
<span class="nc" id="L132">            byName.put(context.getString(R.string.license_name_cc_by), Prefs.Licenses.CC_BY_3);</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(265)) {</span>
<span class="nc" id="L135">            byName.put(context.getString(R.string.license_name_cc_by_sa), Prefs.Licenses.CC_BY_SA_3);</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(266)) {</span>
<span class="nc" id="L138">            byName.put(context.getString(R.string.license_name_cc_by_four), Prefs.Licenses.CC_BY_4);</span>
        }
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(267)) {</span>
<span class="nc" id="L141">            byName.put(context.getString(R.string.license_name_cc_by_sa_four), Prefs.Licenses.CC_BY_SA_4);</span>
        }
<span class="nc" id="L143">        return byName;</span>
    }

    @Provides
    public AccountUtil providesAccountUtil(Context context) {
<span class="nc" id="L148">        return new AccountUtil();</span>
    }

    /**
     * Provides an instance of CategoryContentProviderClient i.e. the categories
     * that are there in local storage
     */
    @Provides
    @Named(&quot;category&quot;)
    public ContentProviderClient provideCategoryContentProviderClient(Context context) {
<span class="nc" id="L158">        return context.getContentResolver().acquireContentProviderClient(BuildConfig.CATEGORY_AUTHORITY);</span>
    }

    /**
     * This method is used to provide instance of RecentSearchContentProviderClient
     * which provides content of Recent Searches from database
     * @param context
     * @return returns RecentSearchContentProviderClient
     */
    @Provides
    @Named(&quot;recentsearch&quot;)
    public ContentProviderClient provideRecentSearchContentProviderClient(Context context) {
<span class="nc" id="L170">        return context.getContentResolver().acquireContentProviderClient(BuildConfig.RECENT_SEARCH_AUTHORITY);</span>
    }

    @Provides
    @Named(&quot;contribution&quot;)
    public ContentProviderClient provideContributionContentProviderClient(Context context) {
<span class="nc" id="L176">        return context.getContentResolver().acquireContentProviderClient(BuildConfig.CONTRIBUTION_AUTHORITY);</span>
    }

    @Provides
    @Named(&quot;modification&quot;)
    public ContentProviderClient provideModificationContentProviderClient(Context context) {
<span class="nc" id="L182">        return context.getContentResolver().acquireContentProviderClient(BuildConfig.MODIFICATION_AUTHORITY);</span>
    }

    @Provides
    @Named(&quot;bookmarks&quot;)
    public ContentProviderClient provideBookmarkContentProviderClient(Context context) {
<span class="nc" id="L188">        return context.getContentResolver().acquireContentProviderClient(BuildConfig.BOOKMARK_AUTHORITY);</span>
    }

    @Provides
    @Named(&quot;bookmarksLocation&quot;)
    public ContentProviderClient provideBookmarkLocationContentProviderClient(Context context) {
<span class="fc" id="L194">        return context.getContentResolver().acquireContentProviderClient(BuildConfig.BOOKMARK_LOCATIONS_AUTHORITY);</span>
    }

    @Provides
    @Named(&quot;bookmarksItem&quot;)
    public ContentProviderClient provideBookmarkItemContentProviderClient(Context context) {
<span class="nc" id="L200">        return context.getContentResolver().acquireContentProviderClient(BuildConfig.BOOKMARK_ITEMS_AUTHORITY);</span>
    }

    /**
     * This method is used to provide instance of RecentLanguagesContentProvider
     * which provides content of recent used languages from database
     * @param context Context
     * @return returns RecentLanguagesContentProvider
     */
    @Provides
    @Named(&quot;recent_languages&quot;)
    public ContentProviderClient provideRecentLanguagesContentProviderClient(final Context context) {
<span class="nc" id="L212">        return context.getContentResolver().acquireContentProviderClient(BuildConfig.RECENT_LANGUAGE_AUTHORITY);</span>
    }

    /**
     * Provides a Json store instance(JsonKvStore) which keeps
     * the provided Gson in it's instance
     * @param gson stored inside the store instance
     */
    @Provides
    @Named(&quot;default_preferences&quot;)
    public JsonKvStore providesDefaultKvStore(Context context, Gson gson) {
<span class="fc" id="L223">        String storeName = context.getPackageName() + &quot;_preferences&quot;;</span>
<span class="fc" id="L224">        return new JsonKvStore(context, storeName, gson);</span>
    }

    @Provides
    public UploadController providesUploadController(SessionManager sessionManager, @Named(&quot;default_preferences&quot;) JsonKvStore kvStore, Context context, ContributionDao contributionDao) {
<span class="nc" id="L229">        return new UploadController(sessionManager, context, kvStore);</span>
    }

    @Provides
    @Singleton
    public LocationServiceManager provideLocationServiceManager(Context context) {
<span class="fc" id="L235">        return new LocationServiceManager(context);</span>
    }

    @Provides
    @Singleton
    public DBOpenHelper provideDBOpenHelper(Context context) {
<span class="fc" id="L241">        return new DBOpenHelper(context);</span>
    }

    @Provides
    @Singleton
    @Named(&quot;thumbnail-cache&quot;)
    public LruCache&lt;String, String&gt; provideLruCache() {
<span class="nc" id="L248">        return new LruCache&lt;&gt;(1024);</span>
    }

    @Provides
    @Singleton
    public WikidataEditListener provideWikidataEditListener() {
<span class="fc" id="L254">        return new WikidataEditListenerImpl();</span>
    }

    /**
     * Provides app flavour. Can be used to alter flows in the app
     * @return
     */
    @Named(&quot;isBeta&quot;)
    @Provides
    @Singleton
    public boolean provideIsBetaVariant() {
<span class="nc" id="L265">        return ConfigUtils.isBetaFlavour();</span>
    }

    /**
     * Provide JavaRx IO scheduler which manages IO operations
     * across various Threads
     */
    @Named(IO_THREAD)
    @Provides
    public Scheduler providesIoThread() {
<span class="fc" id="L275">        return Schedulers.io();</span>
    }

    @Named(MAIN_THREAD)
    @Provides
    public Scheduler providesMainThread() {
<span class="fc" id="L281">        return AndroidSchedulers.mainThread();</span>
    }

    @Named(&quot;username&quot;)
    @Provides
    public String provideLoggedInUsername(SessionManager sessionManager) {
<span class="nc" id="L287">        return Objects.toString(sessionManager.getUserName(), &quot;&quot;);</span>
    }

    @Provides
    @Singleton
    public AppDatabase provideAppDataBase() {
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(268)) {</span>
<span class="fc" id="L294">            appDatabase = Room.databaseBuilder(applicationContext, AppDatabase.class, &quot;commons_room.db&quot;).addMigrations(MIGRATION_1_2).fallbackToDestructiveMigration().build();</span>
        }
<span class="fc" id="L296">        return appDatabase;</span>
    }

    @Provides
    public ContributionDao providesContributionsDao(AppDatabase appDatabase) {
<span class="fc" id="L301">        return appDatabase.contributionDao();</span>
    }

    /**
     * Get the reference of DepictsDao class.
     */
    @Provides
    public DepictsDao providesDepictDao(AppDatabase appDatabase) {
<span class="nc" id="L309">        return appDatabase.DepictsDao();</span>
    }

    /**
     * Get the reference of UploadedStatus class.
     */
    @Provides
    public UploadedStatusDao providesUploadedStatusDao(AppDatabase appDatabase) {
<span class="nc" id="L317">        return appDatabase.UploadedStatusDao();</span>
    }

    /**
     * Get the reference of NotForUploadStatus class.
     */
    @Provides
    public NotForUploadStatusDao providesNotForUploadStatusDao(AppDatabase appDatabase) {
<span class="nc" id="L325">        return appDatabase.NotForUploadStatusDao();</span>
    }

    /**
     * Get the reference of ReviewDao class
     */
    @Provides
    public ReviewDao providesReviewDao(AppDatabase appDatabase) {
<span class="nc" id="L333">        return appDatabase.ReviewDao();</span>
    }

    @Provides
    public ContentResolver providesContentResolver(Context context) {
<span class="nc" id="L338">        return context.getContentResolver();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>