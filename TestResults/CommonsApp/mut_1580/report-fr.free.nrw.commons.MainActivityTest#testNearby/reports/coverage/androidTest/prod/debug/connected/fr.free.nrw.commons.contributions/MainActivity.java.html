<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.contributions</a> &gt; <span class="el_source">MainActivity.java</span></div><h1>MainActivity.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.contributions;

import android.Manifest.permission;
import android.annotation.SuppressLint;
import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Build.VERSION;
import android.os.Build.VERSION_CODES;
import android.os.Bundle;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.FrameLayout;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.work.ExistingWorkPolicy;
import butterknife.BindView;
import butterknife.ButterKnife;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.WelcomeActivity;
import fr.free.nrw.commons.auth.SessionManager;
import fr.free.nrw.commons.bookmarks.BookmarkFragment;
import fr.free.nrw.commons.explore.ExploreFragment;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LocationServiceManager;
import fr.free.nrw.commons.media.MediaDetailPagerFragment;
import fr.free.nrw.commons.navtab.MoreBottomSheetFragment;
import fr.free.nrw.commons.navtab.MoreBottomSheetLoggedOutFragment;
import fr.free.nrw.commons.navtab.NavTab;
import fr.free.nrw.commons.navtab.NavTabLayout;
import fr.free.nrw.commons.navtab.NavTabLoggedOut;
import fr.free.nrw.commons.nearby.Place;
import fr.free.nrw.commons.nearby.fragments.NearbyParentFragment;
import fr.free.nrw.commons.nearby.fragments.NearbyParentFragment.NearbyParentFragmentInstanceReadyCallback;
import fr.free.nrw.commons.notification.NotificationActivity;
import fr.free.nrw.commons.notification.NotificationController;
import fr.free.nrw.commons.quiz.QuizChecker;
import fr.free.nrw.commons.settings.SettingsFragment;
import fr.free.nrw.commons.theme.BaseActivity;
import fr.free.nrw.commons.upload.worker.WorkRequestHelper;
import fr.free.nrw.commons.utils.PermissionUtils;
import fr.free.nrw.commons.utils.ViewUtilWrapper;
import io.reactivex.Completable;
import io.reactivex.schedulers.Schedulers;
import java.util.Collections;
import java.util.List;
import javax.inject.Inject;
import javax.inject.Named;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="fc" id="L58">public class MainActivity extends BaseActivity implements FragmentManager.OnBackStackChangedListener {</span>

    @Inject
    SessionManager sessionManager;

    @Inject
    ContributionController controller;

    @Inject
    ContributionDao contributionDao;

    @BindView(R.id.toolbar)
    Toolbar toolbar;

    @BindView(R.id.pager)
    public UnswipableViewPager viewPager;

    @BindView(R.id.fragmentContainer)
    public FrameLayout fragmentContainer;

    @BindView(R.id.fragment_main_nav_tab_layout)
    NavTabLayout tabLayout;

    private ContributionsFragment contributionsFragment;

    private NearbyParentFragment nearbyParentFragment;

    private ExploreFragment exploreFragment;

    private BookmarkFragment bookmarkFragment;

    public ActiveFragment activeFragment;

    private MediaDetailPagerFragment mediaDetailPagerFragment;

    private NavTabLayout.OnNavigationItemSelectedListener navListener;

    @Inject
    public LocationServiceManager locationManager;

    @Inject
    NotificationController notificationController;

    @Inject
    QuizChecker quizChecker;

    @Inject
    @Named(&quot;default_preferences&quot;)
    public JsonKvStore applicationKvStore;

    @Inject
    ViewUtilWrapper viewUtilWrapper;

    public Menu menu;

    /**
     * Consumers should be simply using this method to use this activity.
     *
     * @param context A Context of the application package implementing this class.
     */
    public static void startYourself(Context context) {
<span class="nc" id="L119">        Intent intent = new Intent(context, MainActivity.class);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(619)) {</span>
<span class="nc" id="L121">            intent.addFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
        }
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(620)) {</span>
<span class="nc" id="L124">            context.startActivity(intent);</span>
        }
<span class="nc" id="L126">    }</span>

    @Override
    public boolean onSupportNavigateUp() {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(624)) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (activeFragment == ActiveFragment.CONTRIBUTIONS) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(623)) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                    if (!contributionsFragment.backButtonClicked()) {</span>
<span class="nc" id="L134">                        return false;</span>
                    }
                }
            } else {
<span class="nc bnc" id="L138" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(621)) {</span>
<span class="nc" id="L139">                    onBackPressed();</span>
                }
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(622)) {</span>
<span class="nc" id="L142">                    showTabs();</span>
                }
            }
        }
<span class="nc" id="L146">        return true;</span>
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(625)) {</span>
<span class="fc" id="L152">            super.onCreate(savedInstanceState);</span>
        }
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(626)) {</span>
<span class="fc" id="L155">            loadLocale();</span>
        }
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(627)) {</span>
<span class="fc" id="L158">            setContentView(R.layout.main);</span>
        }
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(628)) {</span>
<span class="fc" id="L161">            ButterKnife.bind(this);</span>
        }
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(629)) {</span>
<span class="fc" id="L164">            setSupportActionBar(toolbar);</span>
        }
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(630)) {</span>
<span class="fc" id="L167">            toolbar.setNavigationOnClickListener(view -&gt; {</span>
<span class="nc" id="L168">                onSupportNavigateUp();</span>
<span class="nc" id="L169">            });</span>
        }
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(631)) {</span>
            /*
        &quot;first_edit_depict&quot; is a key for getting information about opening the depiction editor
        screen for the first time after opening the app.

        Getting true by the key means the depiction editor screen is opened for the first time
        after opening the app.
        Getting false by the key means the depiction editor screen is not opened for the first time
        after opening the app.
         */
<span class="fc" id="L181">            applicationKvStore.putBoolean(&quot;first_edit_depict&quot;, true);</span>
        }
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(652)) {</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">            if (applicationKvStore.getBoolean(&quot;login_skipped&quot;) == true) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(650)) {</span>
<span class="nc" id="L186">                    setTitle(getString(R.string.navigation_item_explore));</span>
                }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(651)) {</span>
<span class="nc" id="L189">                    setUpLoggedOutPager();</span>
                }
            } else {
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(633)) {</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">                    if (applicationKvStore.getBoolean(&quot;firstrun&quot;, true)) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(632)) {</span>
<span class="nc" id="L195">                            applicationKvStore.putBoolean(&quot;hasAlreadyLaunchedBigMultiupload&quot;, false);</span>
                        }
                    }
                }
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(640)) {</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">                    if (savedInstanceState == null) {</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(639)) {</span>
                            // Open Last opened screen if it is Contributions or Nearby, otherwise Contributions
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">                            if (applicationKvStore.getBoolean(&quot;last_opened_nearby&quot;)) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(636)) {</span>
<span class="nc" id="L205">                                    setTitle(getString(R.string.nearby_fragment));</span>
                                }
<span class="nc bnc" id="L207" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(637)) {</span>
<span class="nc" id="L208">                                    showNearby();</span>
                                }
<span class="nc bnc" id="L210" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(638)) {</span>
<span class="nc" id="L211">                                    loadFragment(NearbyParentFragment.newInstance(), false);</span>
                                }
                            } else {
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(634)) {</span>
<span class="fc" id="L215">                                    setTitle(getString(R.string.contributions_fragment));</span>
                                }
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(635)) {</span>
<span class="fc" id="L218">                                    loadFragment(ContributionsFragment.newInstance(), false);</span>
                                }
                            }
                        }
                    }
                }
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(641)) {</span>
<span class="fc" id="L225">                    setUpPager();</span>
                }
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(648)) {</span>
                    /**
                     * Ask the user for media location access just after login
                     * so that location in the EXIF metadata of the images shared by the user
                     * is retained on devices running Android 10 or above
                     */
<span class="pc bpc" id="L233" title="16 of 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(646) ? (VERSION.SDK_INT &lt;= VERSION_CODES.Q) : (ListenerUtil.mutListener.listen(645) ? (VERSION.SDK_INT &gt; VERSION_CODES.Q) : (ListenerUtil.mutListener.listen(644) ? (VERSION.SDK_INT &lt; VERSION_CODES.Q) : (ListenerUtil.mutListener.listen(643) ? (VERSION.SDK_INT != VERSION_CODES.Q) : (ListenerUtil.mutListener.listen(642) ? (VERSION.SDK_INT == VERSION_CODES.Q) : (VERSION.SDK_INT &gt;= VERSION_CODES.Q))))))) {</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(647)) {</span>
<span class="fc" id="L235">                            PermissionUtils.checkPermissionsAndPerformAction(this, () -&gt; {</span>
<span class="fc" id="L236">                            }, R.string.media_location_permission_denied, R.string.add_location_manually, permission.ACCESS_MEDIA_LOCATION);</span>
                        }
                    }
                }
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(649)) {</span>
<span class="fc" id="L241">                    checkAndResumeStuckUploads();</span>
                }
            }
        }
<span class="fc" id="L245">    }</span>

    public void setSelectedItemId(int id) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(653)) {</span>
<span class="nc" id="L249">            tabLayout.setSelectedItemId(id);</span>
        }
<span class="nc" id="L251">    }</span>

    private void setUpPager() {
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(654)) {</span>
<span class="fc" id="L255">            tabLayout.setOnNavigationItemSelectedListener(navListener = (item) -&gt; {</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">                if (!item.getTitle().equals(getString(R.string.more))) {</span>
                    // do not change title for more fragment
<span class="fc" id="L258">                    setTitle(item.getTitle());</span>
                }
                // set last_opened_nearby true if item is nearby screen else set false
<span class="fc" id="L261">                applicationKvStore.putBoolean(&quot;last_opened_nearby&quot;, item.getTitle().equals(getString(R.string.nearby_fragment)));</span>
<span class="fc" id="L262">                final Fragment fragment = NavTab.of(item.getOrder()).newInstance();</span>
<span class="fc" id="L263">                return loadFragment(fragment, true);</span>
            });
        }
<span class="fc" id="L266">    }</span>

    private void setUpLoggedOutPager() {
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(655)) {</span>
<span class="nc" id="L270">            loadFragment(ExploreFragment.newInstance(), false);</span>
        }
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(656)) {</span>
<span class="nc" id="L273">            tabLayout.setOnNavigationItemSelectedListener(item -&gt; {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                if (!item.getTitle().equals(getString(R.string.more))) {</span>
                    // do not change title for more fragment
<span class="nc" id="L276">                    setTitle(item.getTitle());</span>
                }
<span class="nc" id="L278">                Fragment fragment = NavTabLoggedOut.of(item.getOrder()).newInstance();</span>
<span class="nc" id="L279">                return loadFragment(fragment, true);</span>
            });
        }
<span class="nc" id="L282">    }</span>

    private boolean loadFragment(Fragment fragment, boolean showBottom) {
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(674)) {</span>
            // from the saved instance state.
<span class="fc bfc" id="L287" title="All 2 branches covered.">            if (fragment instanceof ContributionsFragment) {</span>
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(671)) {</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">                    if (activeFragment == ActiveFragment.CONTRIBUTIONS) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(670)) {</span>
                            // scroll to top if already on the Contributions tab
<span class="nc" id="L292">                            contributionsFragment.scrollToTop();</span>
                        }
<span class="nc" id="L294">                        return true;</span>
                    }
                }
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(672)) {</span>
<span class="fc" id="L298">                    contributionsFragment = (ContributionsFragment) fragment;</span>
                }
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(673)) {</span>
<span class="fc" id="L301">                    activeFragment = ActiveFragment.CONTRIBUTIONS;</span>
                }
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">            } else if (fragment instanceof NearbyParentFragment) {</span>
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(667)) {</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">                    if (activeFragment == ActiveFragment.NEARBY) {</span>
                        // Do nothing if same tab
<span class="nc" id="L307">                        return true;</span>
                    }
                }
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(668)) {</span>
<span class="fc" id="L311">                    nearbyParentFragment = (NearbyParentFragment) fragment;</span>
                }
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(669)) {</span>
<span class="fc" id="L314">                    activeFragment = ActiveFragment.NEARBY;</span>
                }
<span class="nc bnc" id="L316" title="All 2 branches missed.">            } else if (fragment instanceof ExploreFragment) {</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(664)) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                    if (activeFragment == ActiveFragment.EXPLORE) {</span>
                        // Do nothing if same tab
<span class="nc" id="L320">                        return true;</span>
                    }
                }
<span class="nc bnc" id="L323" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(665)) {</span>
<span class="nc" id="L324">                    exploreFragment = (ExploreFragment) fragment;</span>
                }
<span class="nc bnc" id="L326" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(666)) {</span>
<span class="nc" id="L327">                    activeFragment = ActiveFragment.EXPLORE;</span>
                }
<span class="nc bnc" id="L329" title="All 2 branches missed.">            } else if (fragment instanceof BookmarkFragment) {</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(661)) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                    if (activeFragment == ActiveFragment.BOOKMARK) {</span>
                        // Do nothing if same tab
<span class="nc" id="L333">                        return true;</span>
                    }
                }
<span class="nc bnc" id="L336" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(662)) {</span>
<span class="nc" id="L337">                    bookmarkFragment = (BookmarkFragment) fragment;</span>
                }
<span class="nc bnc" id="L339" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(663)) {</span>
<span class="nc" id="L340">                    activeFragment = ActiveFragment.BOOKMARK;</span>
                }
<span class="nc bnc" id="L342" title="All 10 branches missed.">            } else if ((ListenerUtil.mutListener.listen(657) ? (fragment == null || showBottom) : (fragment == null &amp;&amp; showBottom))) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(660)) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                    if (applicationKvStore.getBoolean(&quot;login_skipped&quot;) == true) {</span>
                        // If logged out, more sheet is different
<span class="nc" id="L346">                        MoreBottomSheetLoggedOutFragment bottomSheet = new MoreBottomSheetLoggedOutFragment();</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(659)) {</span>
<span class="nc" id="L348">                            bottomSheet.show(getSupportFragmentManager(), &quot;MoreBottomSheetLoggedOut&quot;);</span>
                        }
<span class="nc" id="L350">                    } else {</span>
<span class="nc" id="L351">                        MoreBottomSheetFragment bottomSheet = new MoreBottomSheetFragment();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(658)) {</span>
<span class="nc" id="L353">                            bottomSheet.show(getSupportFragmentManager(), &quot;MoreBottomSheet&quot;);</span>
                        }
                    }
                }
            }
        }
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(676)) {</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">            if (fragment != null) {</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(675)) {</span>
<span class="fc" id="L362">                    getSupportFragmentManager().beginTransaction().replace(R.id.fragmentContainer, fragment).commit();</span>
                }
<span class="fc" id="L364">                return true;</span>
            }
        }
<span class="nc" id="L367">        return false;</span>
    }

    public void hideTabs() {
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(677)) {</span>
<span class="nc" id="L372">            tabLayout.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L374">    }</span>

    public void showTabs() {
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(678)) {</span>
<span class="nc" id="L378">            tabLayout.setVisibility(View.VISIBLE);</span>
        }
<span class="nc" id="L380">    }</span>

    /**
     * Adds number of uploads next to tab text &quot;Contributions&quot; then it will look like
     * &quot;Contributions (NUMBER)&quot;
     * @param uploadCount
     */
    public void setNumOfUploads(int uploadCount) {
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(685)) {</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">            if (activeFragment == ActiveFragment.CONTRIBUTIONS) {</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(684)) {</span>
<span class="nc bnc" id="L391" title="All 22 branches missed.">                    setTitle(getResources().getString(R.string.contributions_fragment) + &quot; &quot; + (!((ListenerUtil.mutListener.listen(683) ? (uploadCount &gt;= 0) : (ListenerUtil.mutListener.listen(682) ? (uploadCount &lt;= 0) : (ListenerUtil.mutListener.listen(681) ? (uploadCount &gt; 0) : (ListenerUtil.mutListener.listen(680) ? (uploadCount &lt; 0) : (ListenerUtil.mutListener.listen(679) ? (uploadCount != 0) : (uploadCount == 0))))))) ? getResources().getQuantityString(R.plurals.contributions_subtitle, uploadCount, uploadCount) : getString(R.string.contributions_subtitle_zero)));</span>
                }
            }
        }
<span class="nc" id="L395">    }</span>

    /**
     * Resume the uploads that got stuck because of the app being killed
     * or the device being rebooted.
     *
     * When the app is terminated or the device is restarted, contributions remain in the
     * 'STATE_IN_PROGRESS' state. This status persists and doesn't change during these events.
     * So, retrieving contributions labeled as 'STATE_IN_PROGRESS'
     * from the database will provide the list of uploads that appear as stuck on opening the app again
     */
    @SuppressLint(&quot;CheckResult&quot;)
    private void checkAndResumeStuckUploads() {
<span class="fc" id="L408">        List&lt;Contribution&gt; stuckUploads = contributionDao.getContribution(Collections.singletonList(Contribution.STATE_IN_PROGRESS)).subscribeOn(Schedulers.io()).blockingGet();</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(686)) {</span>
<span class="fc" id="L410">            Timber.d(&quot;Resuming &quot; + stuckUploads.size() + &quot; uploads...&quot;);</span>
        }
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(691)) {</span>
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">            if (!stuckUploads.isEmpty()) {</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(689)) {</span>
                    {
<span class="nc" id="L416">                        long _loopCounter12 = 0;</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                        for (Contribution contribution : stuckUploads) {</span>
<span class="nc" id="L418">                            ListenerUtil.loopListener.listen(&quot;_loopCounter12&quot;, ++_loopCounter12);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(687)) {</span>
<span class="nc" id="L420">                                contribution.setState(Contribution.STATE_QUEUED);</span>
                            }
<span class="nc bnc" id="L422" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(688)) {</span>
<span class="nc" id="L423">                                Completable.fromAction(() -&gt; contributionDao.saveSynchronous(contribution)).subscribeOn(Schedulers.io()).subscribe();</span>
                            }
<span class="nc" id="L425">                        }</span>
                    }
                }
<span class="nc bnc" id="L428" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(690)) {</span>
<span class="nc" id="L429">                    WorkRequestHelper.Companion.makeOneTimeWorkRequest(this, ExistingWorkPolicy.APPEND_OR_REPLACE);</span>
                }
            }
        }
<span class="fc" id="L433">    }</span>

    @Override
    protected void onPostCreate(@Nullable Bundle savedInstanceState) {
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(692)) {</span>
<span class="fc" id="L438">            super.onPostCreate(savedInstanceState);</span>
        }
<span class="fc" id="L440">    }</span>

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(693)) {</span>
<span class="nc" id="L445">            super.onSaveInstanceState(outState);</span>
        }
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(694)) {</span>
<span class="nc" id="L448">            outState.putInt(&quot;viewPagerCurrentItem&quot;, viewPager.getCurrentItem());</span>
        }
<span class="nc bnc" id="L450" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(695)) {</span>
<span class="nc" id="L451">            outState.putString(&quot;activeFragment&quot;, activeFragment.name());</span>
        }
<span class="nc" id="L453">    }</span>

    @Override
    protected void onRestoreInstanceState(Bundle savedInstanceState) {
<span class="nc bnc" id="L457" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(696)) {</span>
<span class="nc" id="L458">            super.onRestoreInstanceState(savedInstanceState);</span>
        }
<span class="nc" id="L460">        String activeFragmentName = savedInstanceState.getString(&quot;activeFragment&quot;);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(698)) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (activeFragmentName != null) {</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(697)) {</span>
<span class="nc" id="L464">                    restoreActiveFragment(activeFragmentName);</span>
                }
            }
        }
<span class="nc" id="L468">    }</span>

    private void restoreActiveFragment(@NonNull String fragmentName) {
<span class="nc bnc" id="L471" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(707)) {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            if (fragmentName.equals(ActiveFragment.CONTRIBUTIONS.name())) {</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(705)) {</span>
<span class="nc" id="L474">                    setTitle(getString(R.string.contributions_fragment));</span>
                }
<span class="nc bnc" id="L476" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(706)) {</span>
<span class="nc" id="L477">                    loadFragment(ContributionsFragment.newInstance(), false);</span>
                }
<span class="nc bnc" id="L479" title="All 2 branches missed.">            } else if (fragmentName.equals(ActiveFragment.NEARBY.name())) {</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(703)) {</span>
<span class="nc" id="L481">                    setTitle(getString(R.string.nearby_fragment));</span>
                }
<span class="nc bnc" id="L483" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(704)) {</span>
<span class="nc" id="L484">                    loadFragment(NearbyParentFragment.newInstance(), false);</span>
                }
<span class="nc bnc" id="L486" title="All 2 branches missed.">            } else if (fragmentName.equals(ActiveFragment.EXPLORE.name())) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(701)) {</span>
<span class="nc" id="L488">                    setTitle(getString(R.string.navigation_item_explore));</span>
                }
<span class="nc bnc" id="L490" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(702)) {</span>
<span class="nc" id="L491">                    loadFragment(ExploreFragment.newInstance(), false);</span>
                }
<span class="nc bnc" id="L493" title="All 2 branches missed.">            } else if (fragmentName.equals(ActiveFragment.BOOKMARK.name())) {</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(699)) {</span>
<span class="nc" id="L495">                    setTitle(getString(R.string.bookmarks));</span>
                }
<span class="nc bnc" id="L497" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(700)) {</span>
<span class="nc" id="L498">                    loadFragment(BookmarkFragment.newInstance(), false);</span>
                }
            }
        }
<span class="nc" id="L502">    }</span>

    @Override
    public void onBackPressed() {
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(723)) {</span>
<span class="nc bnc" id="L507" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(708) ? (contributionsFragment != null || activeFragment == ActiveFragment.CONTRIBUTIONS) : (contributionsFragment != null &amp;&amp; activeFragment == ActiveFragment.CONTRIBUTIONS))) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(722)) {</span>
                    // Means that contribution fragment is visible
<span class="nc bnc" id="L510" title="All 2 branches missed.">                    if (!contributionsFragment.backButtonClicked()) {</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(721)) {</span>
                            // the back press, let the activity do so
<span class="nc" id="L513">                            super.onBackPressed();</span>
                        }
                    }
                }
<span class="nc bnc" id="L517" title="All 10 branches missed.">            } else if ((ListenerUtil.mutListener.listen(709) ? (nearbyParentFragment != null || activeFragment == ActiveFragment.NEARBY) : (nearbyParentFragment != null &amp;&amp; activeFragment == ActiveFragment.NEARBY))) {</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(720)) {</span>
                    /* If function nearbyParentFragment.backButtonClick() returns false, it means that the bottomsheet is
              not expanded. So if the back button is pressed, then go back to the Contributions tab */
<span class="nc bnc" id="L521" title="All 2 branches missed.">                    if (!nearbyParentFragment.backButtonClicked()) {</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(718)) {</span>
<span class="nc" id="L523">                            getSupportFragmentManager().beginTransaction().remove(nearbyParentFragment).commit();</span>
                        }
<span class="nc bnc" id="L525" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(719)) {</span>
<span class="nc" id="L526">                            setSelectedItemId(NavTab.CONTRIBUTIONS.code());</span>
                        }
                    }
                }
<span class="nc bnc" id="L530" title="All 10 branches missed.">            } else if ((ListenerUtil.mutListener.listen(710) ? (exploreFragment != null || activeFragment == ActiveFragment.EXPLORE) : (exploreFragment != null &amp;&amp; activeFragment == ActiveFragment.EXPLORE))) {</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(717)) {</span>
                    // Means that explore fragment is visible
<span class="nc bnc" id="L533" title="All 2 branches missed.">                    if (!exploreFragment.onBackPressed()) {</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(716)) {</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                            if (applicationKvStore.getBoolean(&quot;login_skipped&quot;)) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(715)) {</span>
<span class="nc" id="L537">                                    super.onBackPressed();</span>
                                }
                            } else {
<span class="nc bnc" id="L540" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(714)) {</span>
<span class="nc" id="L541">                                    setSelectedItemId(NavTab.CONTRIBUTIONS.code());</span>
                                }
                            }
                        }
                    }
                }
<span class="nc bnc" id="L547" title="All 10 branches missed.">            } else if ((ListenerUtil.mutListener.listen(711) ? (bookmarkFragment != null || activeFragment == ActiveFragment.BOOKMARK) : (bookmarkFragment != null &amp;&amp; activeFragment == ActiveFragment.BOOKMARK))) {</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(713)) {</span>
                    // Means that bookmark fragment is visible
<span class="nc" id="L550">                    bookmarkFragment.onBackPressed();</span>
                }
            } else {
<span class="nc bnc" id="L553" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(712)) {</span>
<span class="nc" id="L554">                    super.onBackPressed();</span>
                }
            }
        }
<span class="nc" id="L558">    }</span>

    @Override
    public void onBackStackChanged() {
<span class="nc" id="L562">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">        switch(item.getItemId()) {</span>
            case R.id.notifications:
<span class="nc bnc" id="L568" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(724)) {</span>
                    // Starts notification activity on click to notification icon
<span class="nc" id="L570">                    NotificationActivity.startYourself(this, &quot;unread&quot;);</span>
                }
<span class="nc" id="L572">                return true;</span>
            default:
<span class="fc" id="L574">                return super.onOptionsItemSelected(item);</span>
        }
    }

    /**
     * Retry all failed uploads as soon as the user returns to the app
     */
    @SuppressLint(&quot;CheckResult&quot;)
    private void retryAllFailedUploads() {
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(725)) {</span>
<span class="fc" id="L584">            contributionDao.getContribution(Collections.singletonList(Contribution.STATE_FAILED)).subscribeOn(Schedulers.io()).subscribe(failedUploads -&gt; {</span>
                {
<span class="fc" id="L586">                    long _loopCounter13 = 0;</span>
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">                    for (Contribution contribution : failedUploads) {</span>
<span class="nc" id="L588">                        ListenerUtil.loopListener.listen(&quot;_loopCounter13&quot;, ++_loopCounter13);</span>
<span class="nc" id="L589">                        contributionsFragment.retryUpload(contribution);</span>
<span class="nc" id="L590">                    }</span>
                }
<span class="fc" id="L592">            });</span>
        }
<span class="fc" id="L594">    }</span>

    public void toggleLimitedConnectionMode() {
<span class="nc bnc" id="L597" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(726)) {</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">            defaultKvStore.putBoolean(CommonsApplication.IS_LIMITED_CONNECTION_MODE_ENABLED, !defaultKvStore.getBoolean(CommonsApplication.IS_LIMITED_CONNECTION_MODE_ENABLED, false));</span>
        }
<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(730)) {</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">            if (defaultKvStore.getBoolean(CommonsApplication.IS_LIMITED_CONNECTION_MODE_ENABLED, false)) {</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(729)) {</span>
<span class="nc" id="L603">                    viewUtilWrapper.showShortToast(getBaseContext(), getString(R.string.limited_connection_enabled));</span>
                }
            } else {
<span class="nc bnc" id="L606" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(727)) {</span>
<span class="nc" id="L607">                    WorkRequestHelper.Companion.makeOneTimeWorkRequest(getApplicationContext(), ExistingWorkPolicy.APPEND_OR_REPLACE);</span>
                }
<span class="nc bnc" id="L609" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(728)) {</span>
<span class="nc" id="L610">                    viewUtilWrapper.showShortToast(getBaseContext(), getString(R.string.limited_connection_disabled));</span>
                }
            }
        }
<span class="nc" id="L614">    }</span>

    public void centerMapToPlace(Place place) {
<span class="nc bnc" id="L617" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(731)) {</span>
<span class="nc" id="L618">            setSelectedItemId(NavTab.NEARBY.code());</span>
        }
<span class="nc bnc" id="L620" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(733)) {</span>
<span class="nc" id="L621">            nearbyParentFragment.setNearbyParentFragmentInstanceReadyCallback(new NearbyParentFragmentInstanceReadyCallback() {</span>

                // so that nearbyParentFragemt.centerMaptoPlace(place) not throw any null pointer exception
                @Override
                public void onReady() {
<span class="nc bnc" id="L626" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(732)) {</span>
<span class="nc" id="L627">                        nearbyParentFragment.centerMapToPlace(place);</span>
                    }
<span class="nc" id="L629">                }</span>
            });
        }
<span class="nc" id="L632">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(734)) {</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">            Timber.d(data != null ? data.toString() : &quot;onActivityResult data is null&quot;);</span>
        }
<span class="nc bnc" id="L639" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(735)) {</span>
<span class="nc" id="L640">            super.onActivityResult(requestCode, resultCode, data);</span>
        }
<span class="nc bnc" id="L642" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(736)) {</span>
<span class="nc" id="L643">            controller.handleActivityResult(this, requestCode, resultCode, data);</span>
        }
<span class="nc" id="L645">    }</span>

    @Override
    protected void onResume() {
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(737)) {</span>
<span class="fc" id="L650">            super.onResume();</span>
        }
<span class="pc bpc" id="L652" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(741)) {</span>
<span class="pc bpc" id="L653" title="8 of 10 branches missed.">            if ((ListenerUtil.mutListener.listen(738) ? ((applicationKvStore.getBoolean(&quot;firstrun&quot;, true)) || (!applicationKvStore.getBoolean(&quot;login_skipped&quot;))) : ((applicationKvStore.getBoolean(&quot;firstrun&quot;, true)) &amp;&amp; (!applicationKvStore.getBoolean(&quot;login_skipped&quot;))))) {</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(739)) {</span>
<span class="nc" id="L655">                    defaultKvStore.putBoolean(&quot;inAppCameraFirstRun&quot;, true);</span>
                }
<span class="nc bnc" id="L657" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(740)) {</span>
<span class="nc" id="L658">                    WelcomeActivity.startYourself(this);</span>
                }
            }
        }
<span class="pc bpc" id="L662" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(742)) {</span>
<span class="fc" id="L663">            retryAllFailedUploads();</span>
        }
<span class="fc" id="L665">    }</span>

    @Override
    protected void onDestroy() {
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(743)) {</span>
<span class="fc" id="L670">            quizChecker.cleanup();</span>
        }
<span class="pc bpc" id="L672" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(744)) {</span>
<span class="fc" id="L673">            locationManager.unregisterLocationManager();</span>
        }
<span class="pc bpc" id="L675" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(745)) {</span>
            // Remove ourself from hashmap to prevent memory leaks
<span class="fc" id="L677">            locationManager = null;</span>
        }
<span class="pc bpc" id="L679" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(746)) {</span>
<span class="fc" id="L680">            super.onDestroy();</span>
        }
<span class="fc" id="L682">    }</span>

    /**
     * Public method to show nearby from the reference of this.
     */
    public void showNearby() {
<span class="nc bnc" id="L688" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(747)) {</span>
<span class="nc" id="L689">            tabLayout.setSelectedItemId(NavTab.NEARBY.code());</span>
        }
<span class="nc" id="L691">    }</span>

<span class="fc" id="L693">    public enum ActiveFragment {</span>

<span class="fc" id="L695">        CONTRIBUTIONS, NEARBY, EXPLORE, BOOKMARK, MORE</span>
    }

    /**
     * Load default language in onCreate from SharedPreferences
     */
    private void loadLocale() {
<span class="fc" id="L702">        final SharedPreferences preferences = getSharedPreferences(&quot;Settings&quot;, Activity.MODE_PRIVATE);</span>
<span class="fc" id="L703">        final String language = preferences.getString(&quot;language&quot;, &quot;&quot;);</span>
<span class="fc" id="L704">        final SettingsFragment settingsFragment = new SettingsFragment();</span>
<span class="pc bpc" id="L705" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(748)) {</span>
<span class="fc" id="L706">            settingsFragment.setLocale(this, language);</span>
        }
<span class="fc" id="L708">    }</span>

    public NavTabLayout.OnNavigationItemSelectedListener getNavListener() {
<span class="nc" id="L711">        return navListener;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>