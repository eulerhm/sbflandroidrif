<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.upload</a> &gt; <span class="el_source">UploadController.java</span></div><h1>UploadController.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.upload;

import android.accounts.Account;
import android.annotation.SuppressLint;
import android.content.ComponentName;
import android.content.ContentResolver;
import android.content.Context;
import android.content.Intent;
import android.content.ServiceConnection;
import android.content.res.AssetFileDescriptor;
import android.database.Cursor;
import android.net.Uri;
import android.os.IBinder;
import android.provider.MediaStore;
import android.text.TextUtils;
import androidx.work.OneTimeWorkRequest;
import androidx.work.WorkManager;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.auth.SessionManager;
import fr.free.nrw.commons.contributions.Contribution;
import fr.free.nrw.commons.contributions.ContributionDao;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.settings.Prefs;
import fr.free.nrw.commons.upload.worker.UploadWorker;
import fr.free.nrw.commons.utils.ViewUtil;
import io.reactivex.Single;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.Disposable;
import io.reactivex.schedulers.Schedulers;
import java.io.BufferedInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.Date;
import javax.inject.Inject;
import javax.inject.Singleton;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

@Singleton
public class UploadController {

    private final SessionManager sessionManager;

    private final Context context;

    private final JsonKvStore store;

    @Inject
<span class="nc" id="L51">    public UploadController(final SessionManager sessionManager, final Context context, final JsonKvStore store) {</span>
<span class="nc" id="L52">        this.sessionManager = sessionManager;</span>
<span class="nc" id="L53">        this.context = context;</span>
<span class="nc" id="L54">        this.store = store;</span>
<span class="nc" id="L55">    }</span>

    /**
     * Starts a new upload task.
     *
     * @param contribution the contribution object
     */
    @SuppressLint(&quot;StaticFieldLeak&quot;)
    public void prepareMedia(final Contribution contribution) {
        // If author name is enabled and set, use it
<span class="nc" id="L65">        final Media media = contribution.getMedia();</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7715)) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            if (store.getBoolean(&quot;useAuthorName&quot;, false)) {</span>
<span class="nc" id="L68">                final String authorName = store.getString(&quot;authorName&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(7714)) {</span>
<span class="nc" id="L70">                    media.setAuthor(authorName);</span>
                }
            }
        }
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7721)) {</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (TextUtils.isEmpty(media.getAuthor())) {</span>
<span class="nc" id="L76">                final Account currentAccount = sessionManager.getCurrentAccount();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(7719)) {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                    if (currentAccount == null) {</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(7716)) {</span>
<span class="nc" id="L80">                            Timber.d(&quot;Current account is null&quot;);</span>
                        }
<span class="nc bnc" id="L82" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(7717)) {</span>
<span class="nc" id="L83">                            ViewUtil.showLongToast(context, context.getString(R.string.user_not_logged_in));</span>
                        }
<span class="nc bnc" id="L85" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(7718)) {</span>
<span class="nc" id="L86">                            sessionManager.forceLogin(context);</span>
                        }
<span class="nc" id="L88">                        return;</span>
                    }
                }
<span class="nc bnc" id="L91" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(7720)) {</span>
<span class="nc" id="L92">                    media.setAuthor(sessionManager.getUserName());</span>
                }
            }
        }
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7723)) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (media.getFallbackDescription() == null) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(7722)) {</span>
<span class="nc" id="L99">                    media.setFallbackDescription(&quot;&quot;);</span>
                }
            }
        }
<span class="nc" id="L103">        final String license = store.getString(Prefs.DEFAULT_LICENSE, Prefs.Licenses.CC_BY_SA_3);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7724)) {</span>
<span class="nc" id="L105">            media.setLicense(license);</span>
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7725)) {</span>
<span class="nc" id="L108">            buildUpload(contribution);</span>
        }
<span class="nc" id="L110">    }</span>

    /**
     * Make the Contribution object ready to be uploaded
     * @param contribution
     * @return
     */
    private void buildUpload(final Contribution contribution) {
<span class="nc" id="L118">        final ContentResolver contentResolver = context.getContentResolver();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7726)) {</span>
<span class="nc" id="L120">            contribution.setDataLength(resolveDataLength(contentResolver, contribution));</span>
        }
<span class="nc" id="L122">        final String mimeType = resolveMimeType(contentResolver, contribution);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7732)) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (mimeType != null) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(7727)) {</span>
<span class="nc" id="L126">                    Timber.d(&quot;MimeType is: %s&quot;, mimeType);</span>
                }
<span class="nc bnc" id="L128" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(7728)) {</span>
<span class="nc" id="L129">                    contribution.setMimeType(mimeType);</span>
                }
<span class="nc bnc" id="L131" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(7731)) {</span>
<span class="nc bnc" id="L132" title="All 10 branches missed.">                    if ((ListenerUtil.mutListener.listen(7729) ? (mimeType.startsWith(&quot;image/&quot;) || contribution.getDateCreated() == null) : (mimeType.startsWith(&quot;image/&quot;) &amp;&amp; contribution.getDateCreated() == null))) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(7730)) {</span>
<span class="nc" id="L134">                            contribution.setDateCreated(resolveDateTakenOrNow(contentResolver, contribution));</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L140">    }</span>

    private String resolveMimeType(final ContentResolver contentResolver, final Contribution contribution) {
<span class="nc" id="L143">        final String mimeType = contribution.getMimeType();</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7735)) {</span>
<span class="nc bnc" id="L145" title="All 26 branches missed.">            if ((ListenerUtil.mutListener.listen(7734) ? ((ListenerUtil.mutListener.listen(7733) ? (mimeType == null &amp;&amp; TextUtils.isEmpty(mimeType)) : (mimeType == null || TextUtils.isEmpty(mimeType))) &amp;&amp; mimeType.endsWith(&quot;*&quot;)) : ((ListenerUtil.mutListener.listen(7733) ? (mimeType == null &amp;&amp; TextUtils.isEmpty(mimeType)) : (mimeType == null || TextUtils.isEmpty(mimeType))) || mimeType.endsWith(&quot;*&quot;)))) {</span>
<span class="nc" id="L146">                return contentResolver.getType(contribution.getLocalUri());</span>
            }
        }
<span class="nc" id="L149">        return mimeType;</span>
    }

    private long resolveDataLength(final ContentResolver contentResolver, final Contribution contribution) {
        try {
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(7749)) {</span>
<span class="nc bnc" id="L155" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(7741) ? (contribution.getDataLength() &gt;= 0) : (ListenerUtil.mutListener.listen(7740) ? (contribution.getDataLength() &gt; 0) : (ListenerUtil.mutListener.listen(7739) ? (contribution.getDataLength() &lt; 0) : (ListenerUtil.mutListener.listen(7738) ? (contribution.getDataLength() != 0) : (ListenerUtil.mutListener.listen(7737) ? (contribution.getDataLength() == 0) : (contribution.getDataLength() &lt;= 0))))))) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(7742)) {</span>
<span class="nc" id="L157">                        Timber.d(&quot;UploadController/doInBackground, contribution.getLocalUri():%s&quot;, contribution.getLocalUri());</span>
                    }
<span class="nc" id="L159">                    final AssetFileDescriptor assetFileDescriptor = contentResolver.openAssetFileDescriptor(Uri.fromFile(new File(contribution.getLocalUri().getPath())), &quot;r&quot;);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(7748)) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                        if (assetFileDescriptor != null) {</span>
<span class="nc" id="L162">                            final long length = assetFileDescriptor.getLength();</span>
<span class="nc bnc" id="L163" title="All 22 branches missed.">                            return (ListenerUtil.mutListener.listen(7747) ? (length &gt;= -1) : (ListenerUtil.mutListener.listen(7746) ? (length &lt;= -1) : (ListenerUtil.mutListener.listen(7745) ? (length &gt; -1) : (ListenerUtil.mutListener.listen(7744) ? (length &lt; -1) : (ListenerUtil.mutListener.listen(7743) ? (length == -1) : (length != -1)))))) ? length : countBytes(contentResolver.openInputStream(contribution.getLocalUri()));</span>
                        }
                    }
                }
            }
<span class="nc" id="L168">        } catch (final IOException | NullPointerException | SecurityException e) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(7736)) {</span>
<span class="nc" id="L170">                Timber.e(e, &quot;Exception occurred while uploading image&quot;);</span>
            }
<span class="nc" id="L172">        }</span>
<span class="nc" id="L173">        return contribution.getDataLength();</span>
    }

    private Date resolveDateTakenOrNow(final ContentResolver contentResolver, final Contribution contribution) {
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7750)) {</span>
<span class="nc" id="L178">            Timber.d(&quot;local uri   %s&quot;, contribution.getLocalUri());</span>
        }
<span class="nc" id="L180">        try (final Cursor cursor = dateTakenCursor(contentResolver, contribution)) {</span>
<span class="nc bnc" id="L181" title="All 26 branches missed.">            if ((ListenerUtil.mutListener.listen(7752) ? ((ListenerUtil.mutListener.listen(7751) ? (cursor != null || cursor.getCount() != 0) : (cursor != null &amp;&amp; cursor.getCount() != 0)) || cursor.getColumnCount() != 0) : ((ListenerUtil.mutListener.listen(7751) ? (cursor != null || cursor.getCount() != 0) : (cursor != null &amp;&amp; cursor.getCount() != 0)) &amp;&amp; cursor.getColumnCount() != 0))) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(7753)) {</span>
<span class="nc" id="L183">                    cursor.moveToFirst();</span>
                }
<span class="nc" id="L185">                final Date dateCreated = new Date(cursor.getLong(0));</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (dateCreated.after(new Date(0))) {</span>
<span class="nc" id="L187">                    return dateCreated;</span>
                }
            }
<span class="nc" id="L190">            return new Date();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">        }</span>
    }

    private Cursor dateTakenCursor(final ContentResolver contentResolver, final Contribution contribution) {
<span class="nc" id="L195">        return contentResolver.query(contribution.getLocalUri(), new String[] { MediaStore.Images.ImageColumns.DATE_TAKEN }, null, null, null);</span>
    }

    /**
     * Counts the number of bytes in {@code stream}.
     *
     * @param stream the stream
     * @return the number of bytes in {@code stream}
     * @throws IOException if an I/O error occurs
     */
    private long countBytes(final InputStream stream) throws IOException {
<span class="nc" id="L206">        long count = 0;</span>
<span class="nc" id="L207">        final BufferedInputStream bis = new BufferedInputStream(stream);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(7760)) {</span>
            {
<span class="nc" id="L210">                long _loopCounter122 = 0;</span>
<span class="nc bnc" id="L211" title="All 22 branches missed.">                while ((ListenerUtil.mutListener.listen(7759) ? (bis.read() &gt;= -1) : (ListenerUtil.mutListener.listen(7758) ? (bis.read() &lt;= -1) : (ListenerUtil.mutListener.listen(7757) ? (bis.read() &gt; -1) : (ListenerUtil.mutListener.listen(7756) ? (bis.read() &lt; -1) : (ListenerUtil.mutListener.listen(7755) ? (bis.read() == -1) : (bis.read() != -1))))))) {</span>
<span class="nc" id="L212">                    ListenerUtil.loopListener.listen(&quot;_loopCounter122&quot;, ++_loopCounter122);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(7754)) {</span>
<span class="nc" id="L214">                        count++;</span>
                    }
                }
            }
        }
<span class="nc" id="L219">        return count;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>