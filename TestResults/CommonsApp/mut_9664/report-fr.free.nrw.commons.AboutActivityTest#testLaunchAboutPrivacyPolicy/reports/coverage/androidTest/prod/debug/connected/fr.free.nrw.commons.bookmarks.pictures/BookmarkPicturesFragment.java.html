<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookmarkPicturesFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.bookmarks.pictures</a> &gt; <span class="el_source">BookmarkPicturesFragment.java</span></div><h1>BookmarkPicturesFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.bookmarks.pictures;

import static android.view.View.GONE;
import static android.view.View.VISIBLE;
import android.annotation.SuppressLint;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.GridView;
import android.widget.ListAdapter;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TextView;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import butterknife.BindView;
import butterknife.ButterKnife;
import dagger.android.support.DaggerFragment;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.bookmarks.BookmarkListRootFragment;
import fr.free.nrw.commons.category.GridViewAdapter;
import fr.free.nrw.commons.utils.NetworkUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.schedulers.Schedulers;
import java.util.List;
import javax.inject.Inject;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L35">public class BookmarkPicturesFragment extends DaggerFragment {</span>

    private GridViewAdapter gridAdapter;

<span class="nc" id="L39">    private CompositeDisposable compositeDisposable = new CompositeDisposable();</span>

    @BindView(R.id.statusMessage)
    TextView statusTextView;

    @BindView(R.id.loadingImagesProgressBar)
    ProgressBar progressBar;

    @BindView(R.id.bookmarkedPicturesList)
    GridView gridView;

    @BindView(R.id.parentLayout)
    RelativeLayout parentLayout;

    @Inject
    BookmarkPicturesController controller;

    /**
     * Create an instance of the fragment with the right bundle parameters
     * @return an instance of the fragment
     */
    public static BookmarkPicturesFragment newInstance() {
<span class="nc" id="L61">        return new BookmarkPicturesFragment();</span>
    }

    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L66">        View v = inflater.inflate(R.layout.fragment_bookmarks_pictures, container, false);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4800)) {</span>
<span class="nc" id="L68">            ButterKnife.bind(this, v);</span>
        }
<span class="nc" id="L70">        return v;</span>
    }

    @Override
    public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4801)) {</span>
<span class="nc" id="L76">            super.onViewCreated(view, savedInstanceState);</span>
        }
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4802)) {</span>
<span class="nc" id="L79">            gridView.setOnItemClickListener((AdapterView.OnItemClickListener) getParentFragment());</span>
        }
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4803)) {</span>
<span class="nc" id="L82">            initList();</span>
        }
<span class="nc" id="L84">    }</span>

    @Override
    public void onStop() {
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4804)) {</span>
<span class="nc" id="L89">            super.onStop();</span>
        }
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4805)) {</span>
<span class="nc" id="L92">            controller.stop();</span>
        }
<span class="nc" id="L94">    }</span>

    @Override
    public void onDestroy() {
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4806)) {</span>
<span class="nc" id="L99">            super.onDestroy();</span>
        }
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4807)) {</span>
<span class="nc" id="L102">            compositeDisposable.clear();</span>
        }
<span class="nc" id="L104">    }</span>

    @Override
    public void onResume() {
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4808)) {</span>
<span class="nc" id="L109">            super.onResume();</span>
        }
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4814)) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (controller.needRefreshBookmarkedPictures()) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4809)) {</span>
<span class="nc" id="L114">                    gridView.setVisibility(GONE);</span>
                }
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4812)) {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    if (gridAdapter != null) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(4810)) {</span>
<span class="nc" id="L119">                            gridAdapter.clear();</span>
                        }
<span class="nc bnc" id="L121" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(4811)) {</span>
<span class="nc" id="L122">                            ((BookmarkListRootFragment) getParentFragment()).viewPagerNotifyDataSetChanged();</span>
                        }
                    }
                }
<span class="nc bnc" id="L126" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4813)) {</span>
<span class="nc" id="L127">                    initList();</span>
                }
            }
        }
<span class="nc" id="L131">    }</span>

    /**
     * Checks for internet connection and then initializes
     * the recycler view with bookmarked pictures
     */
    @SuppressLint(&quot;CheckResult&quot;)
    private void initList() {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4816)) {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (!NetworkUtils.isInternetConnectionEstablished(getContext())) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4815)) {</span>
<span class="nc" id="L142">                    handleNoInternet();</span>
                }
<span class="nc" id="L144">                return;</span>
            }
        }
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4817)) {</span>
<span class="nc" id="L148">            progressBar.setVisibility(VISIBLE);</span>
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4818)) {</span>
<span class="nc" id="L151">            statusTextView.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4819)) {</span>
<span class="nc" id="L154">            compositeDisposable.add(controller.loadBookmarkedPictures().subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).subscribe(this::handleSuccess, this::handleError));</span>
        }
<span class="nc" id="L156">    }</span>

    /**
     * Handles the UI updates for no internet scenario
     */
    private void handleNoInternet() {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4820)) {</span>
<span class="nc" id="L163">            progressBar.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4825)) {</span>
<span class="nc bnc" id="L166" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(4821) ? (gridAdapter == null &amp;&amp; gridAdapter.isEmpty()) : (gridAdapter == null || gridAdapter.isEmpty()))) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4823)) {</span>
<span class="nc" id="L168">                    statusTextView.setVisibility(VISIBLE);</span>
                }
<span class="nc bnc" id="L170" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4824)) {</span>
<span class="nc" id="L171">                    statusTextView.setText(getString(R.string.no_internet));</span>
                }
            } else {
<span class="nc bnc" id="L174" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4822)) {</span>
<span class="nc" id="L175">                    ViewUtil.showShortSnackbar(parentLayout, R.string.no_internet);</span>
                }
            }
        }
<span class="nc" id="L179">    }</span>

    /**
     * Logs and handles API error scenario
     * @param throwable
     */
    private void handleError(Throwable throwable) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4826)) {</span>
<span class="nc" id="L187">            Timber.e(throwable, &quot;Error occurred while loading images inside a category&quot;);</span>
        }
        try {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4828)) {</span>
<span class="nc" id="L191">                ViewUtil.showShortSnackbar(parentLayout, R.string.error_loading_images);</span>
            }
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4829)) {</span>
<span class="nc" id="L194">                initErrorView();</span>
            }
<span class="nc" id="L196">        } catch (Exception e) {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(4827)) {</span>
<span class="nc" id="L198">                e.printStackTrace();</span>
            }
<span class="nc" id="L200">        }</span>
<span class="nc" id="L201">    }</span>

    /**
     * Handles the UI updates for a error scenario
     */
    private void initErrorView() {
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4830)) {</span>
<span class="nc" id="L208">            progressBar.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4835)) {</span>
<span class="nc bnc" id="L211" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(4831) ? (gridAdapter == null &amp;&amp; gridAdapter.isEmpty()) : (gridAdapter == null || gridAdapter.isEmpty()))) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4833)) {</span>
<span class="nc" id="L213">                    statusTextView.setVisibility(VISIBLE);</span>
                }
<span class="nc bnc" id="L215" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4834)) {</span>
<span class="nc" id="L216">                    statusTextView.setText(getString(R.string.no_images_found));</span>
                }
            } else {
<span class="nc bnc" id="L219" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4832)) {</span>
<span class="nc" id="L220">                    statusTextView.setVisibility(GONE);</span>
                }
            }
        }
<span class="nc" id="L224">    }</span>

    /**
     * Handles the UI updates when there is no bookmarks
     */
    private void initEmptyBookmarkListView() {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4836)) {</span>
<span class="nc" id="L231">            progressBar.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4841)) {</span>
<span class="nc bnc" id="L234" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(4837) ? (gridAdapter == null &amp;&amp; gridAdapter.isEmpty()) : (gridAdapter == null || gridAdapter.isEmpty()))) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4839)) {</span>
<span class="nc" id="L236">                    statusTextView.setVisibility(VISIBLE);</span>
                }
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4840)) {</span>
<span class="nc" id="L239">                    statusTextView.setText(getString(R.string.bookmark_empty));</span>
                }
            } else {
<span class="nc bnc" id="L242" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4838)) {</span>
<span class="nc" id="L243">                    statusTextView.setVisibility(GONE);</span>
                }
            }
        }
<span class="nc" id="L247">    }</span>

    /**
     * Handles the success scenario
     * On first load, it initializes the grid view. On subsequent loads, it adds items to the adapter
     * @param collection List of new Media to be displayed
     */
    private void handleSuccess(List&lt;Media&gt; collection) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4843)) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (collection == null) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4842)) {</span>
<span class="nc" id="L258">                    initErrorView();</span>
                }
<span class="nc" id="L260">                return;</span>
            }
        }
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4845)) {</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (collection.isEmpty()) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4844)) {</span>
<span class="nc" id="L266">                    initEmptyBookmarkListView();</span>
                }
<span class="nc" id="L268">                return;</span>
            }
        }
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4854)) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (gridAdapter == null) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4853)) {</span>
<span class="nc" id="L274">                    setAdapter(collection);</span>
                }
            } else {
<span class="nc bnc" id="L277" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4850)) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                    if (gridAdapter.containsAll(collection)) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(4846)) {</span>
<span class="nc" id="L280">                            progressBar.setVisibility(GONE);</span>
                        }
<span class="nc bnc" id="L282" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(4847)) {</span>
<span class="nc" id="L283">                            statusTextView.setVisibility(GONE);</span>
                        }
<span class="nc bnc" id="L285" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(4848)) {</span>
<span class="nc" id="L286">                            gridView.setVisibility(VISIBLE);</span>
                        }
<span class="nc bnc" id="L288" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(4849)) {</span>
<span class="nc" id="L289">                            gridView.setAdapter(gridAdapter);</span>
                        }
<span class="nc" id="L291">                        return;</span>
                    }
                }
<span class="nc bnc" id="L294" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4851)) {</span>
<span class="nc" id="L295">                    gridAdapter.addItems(collection);</span>
                }
<span class="nc bnc" id="L297" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(4852)) {</span>
<span class="nc" id="L298">                    ((BookmarkListRootFragment) getParentFragment()).viewPagerNotifyDataSetChanged();</span>
                }
            }
        }
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4855)) {</span>
<span class="nc" id="L303">            progressBar.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4856)) {</span>
<span class="nc" id="L306">            statusTextView.setVisibility(GONE);</span>
        }
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4857)) {</span>
<span class="nc" id="L309">            gridView.setVisibility(VISIBLE);</span>
        }
<span class="nc" id="L311">    }</span>

    /**
     * Initializes the adapter with a list of Media objects
     * @param mediaList List of new Media to be displayed
     */
    private void setAdapter(List&lt;Media&gt; mediaList) {
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4858)) {</span>
<span class="nc" id="L319">            gridAdapter = new GridViewAdapter(this.getContext(), R.layout.layout_category_images, mediaList);</span>
        }
<span class="nc bnc" id="L321" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(4859)) {</span>
<span class="nc" id="L322">            gridView.setAdapter(gridAdapter);</span>
        }
<span class="nc" id="L324">    }</span>

    /**
     * It return an instance of gridView adapter which helps in extracting media details
     * used by the gridView
     * @return  GridView Adapter
     */
    public ListAdapter getAdapter() {
<span class="nc" id="L332">        return gridView.getAdapter();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>