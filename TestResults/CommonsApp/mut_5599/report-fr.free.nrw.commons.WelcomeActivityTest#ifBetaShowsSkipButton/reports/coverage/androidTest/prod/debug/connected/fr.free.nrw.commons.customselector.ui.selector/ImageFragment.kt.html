<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImageFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.customselector.ui.selector</a> &gt; <span class="el_source">ImageFragment.kt</span></div><h1>ImageFragment.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.customselector.ui.selector

import android.app.Activity
import android.content.Context.MODE_PRIVATE
import android.content.SharedPreferences
import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ProgressBar
import android.widget.Switch
import androidx.appcompat.app.AlertDialog
import androidx.constraintlayout.widget.ConstraintLayout
import androidx.lifecycle.Observer
import androidx.lifecycle.ViewModelProvider
import androidx.recyclerview.widget.GridLayoutManager
import androidx.recyclerview.widget.RecyclerView
import fr.free.nrw.commons.customselector.database.NotForUploadStatusDao
import fr.free.nrw.commons.customselector.database.UploadedStatusDao
import fr.free.nrw.commons.customselector.helper.ImageHelper
import fr.free.nrw.commons.customselector.helper.ImageHelper.CUSTOM_SELECTOR_PREFERENCE_KEY
import fr.free.nrw.commons.customselector.helper.ImageHelper.SHOW_ALREADY_ACTIONED_IMAGES_PREFERENCE_KEY
import fr.free.nrw.commons.customselector.listeners.ImageSelectListener
import fr.free.nrw.commons.customselector.listeners.PassDataListener
import fr.free.nrw.commons.customselector.listeners.RefreshUIListener
import fr.free.nrw.commons.customselector.model.CallbackStatus
import fr.free.nrw.commons.customselector.model.Image
import fr.free.nrw.commons.customselector.model.Result
import fr.free.nrw.commons.customselector.ui.adapter.ImageAdapter
import fr.free.nrw.commons.databinding.FragmentCustomSelectorBinding
import fr.free.nrw.commons.databinding.ProgressDialogBinding
import fr.free.nrw.commons.di.CommonsDaggerSupportFragment
import fr.free.nrw.commons.media.MediaClient
import fr.free.nrw.commons.theme.BaseActivity
import fr.free.nrw.commons.upload.FileProcessor
import fr.free.nrw.commons.upload.FileUtilsWrapper
import java.util.*
import javax.inject.Inject

/**
 * Custom Selector Image Fragment.
 */
<span class="nc" id="L43">class ImageFragment : CommonsDaggerSupportFragment(), RefreshUIListener, PassDataListener {</span>

    private var _binding: FragmentCustomSelectorBinding? = null
<span class="nc" id="L46">    private val binding get() = _binding</span>

    /**
     * Current bucketId.
     */
    private var bucketId: Long? = null

    /**
     * Last ImageItem Id.
     */
    private var lastItemId: Long? = null

    /**
     * View model for images.
     */
    private var viewModel: CustomSelectorViewModel? = null

    /**
     * View Elements.
     */
    private var selectorRV: RecyclerView? = null
    private var loader: ProgressBar? = null
    private var switch: Switch? = null
<span class="nc bnc" id="L69" title="All 2 branches missed.">    lateinit var filteredImages: ArrayList&lt;Image&gt;</span>

    /**
     * Stores all images
     */
<span class="nc" id="L74">    var allImages: ArrayList&lt;Image&gt; = ArrayList()</span>

    /**
     * View model Factory.
     */
<span class="nc bnc" id="L79" title="All 2 branches missed.">    lateinit var customSelectorViewModelFactory: CustomSelectorViewModelFactory</span>
<span class="nc" id="L80">        @Inject set</span>

    /**
     * Image loader for adapter.
     */
<span class="nc" id="L85">    var imageLoader: ImageLoader? = null</span>
<span class="nc" id="L86">        @Inject set</span>

    /**
     * Image Adapter for recycle view.
     */
    private lateinit var imageAdapter: ImageAdapter

    /**
     * GridLayoutManager for recycler view.
     */
    private lateinit var gridLayoutManager: GridLayoutManager

    /**
     * For showing progress
     */
    private var progressLayout: ConstraintLayout? = null

    private lateinit var progressDialog: AlertDialog
    private lateinit var progressDialogLayout: ProgressDialogBinding


    /**
     * NotForUploadStatus Dao class for database operations
     */
    @Inject
<span class="nc bnc" id="L111" title="All 2 branches missed.">    lateinit var notForUploadStatusDao: NotForUploadStatusDao</span>

    /**
     * UploadedStatus Dao class for database operations
     */
    @Inject
<span class="nc bnc" id="L117" title="All 2 branches missed.">    lateinit var uploadedStatusDao: UploadedStatusDao</span>

    /**
     * FileUtilsWrapper class to get imageSHA1 from uri
     */
    @Inject
<span class="nc bnc" id="L123" title="All 2 branches missed.">    lateinit var fileUtilsWrapper: FileUtilsWrapper</span>

    /**
     * FileProcessor to pre-process the file.
     */
    @Inject
<span class="nc bnc" id="L129" title="All 2 branches missed.">    lateinit var fileProcessor: FileProcessor</span>

    /**
     * MediaClient for SHA1 query.
     */
    @Inject
<span class="nc bnc" id="L135" title="All 2 branches missed.">    lateinit var mediaClient: MediaClient</span>

    companion object {

        /**
         * Switch state
         */
<span class="nc" id="L142">        var showAlreadyActionedImages: Boolean = true</span>

        /**
         * BucketId args name
         */
        const val BUCKET_ID = &quot;BucketId&quot;
        const val LAST_ITEM_ID = &quot;LastItemId&quot;

        /**
         * newInstance from bucketId.
         */
        fun newInstance(bucketId: Long, lastItemId: Long): ImageFragment {
<span class="nc" id="L154">            val fragment = ImageFragment()</span>
<span class="nc" id="L155">            val args = Bundle()</span>
<span class="nc" id="L156">            args.putLong(BUCKET_ID, bucketId)</span>
<span class="nc" id="L157">            args.putLong(LAST_ITEM_ID, lastItemId)</span>
<span class="nc" id="L158">            fragment.arguments = args</span>
<span class="nc" id="L159">            return fragment</span>
        }
    }

    /**
     * OnCreate
     * Get BucketId, view Model.
     */
    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L168">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        bucketId = arguments?.getLong(BUCKET_ID)</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        lastItemId = arguments?.getLong(LAST_ITEM_ID, 0)</span>
<span class="nc" id="L171">        viewModel = ViewModelProvider(requireActivity(), customSelectorViewModelFactory).get(</span>
            CustomSelectorViewModel::class.java
        )
<span class="nc" id="L174">    }</span>

    /**
     * OnCreateView
     * Init imageAdapter, gridLayoutManger.
     * SetUp recycler view.
     */
    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
<span class="nc" id="L186">        _binding = FragmentCustomSelectorBinding.inflate(inflater, container, false)</span>
<span class="nc" id="L187">        imageAdapter =</span>
<span class="nc" id="L188">            ImageAdapter(requireActivity(), activity as ImageSelectListener, imageLoader!!)</span>
<span class="nc" id="L189">        gridLayoutManager = GridLayoutManager(context, getSpanCount())</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        with(binding?.selectorRv) {</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">            this?.layoutManager = gridLayoutManager</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            this?.setHasFixedSize(true)</span>
<span class="nc bnc" id="L193" title="All 4 branches missed.">            this?.adapter = imageAdapter</span>
<span class="nc" id="L194">        }</span>

<span class="nc bnc" id="L196" title="All 4 branches missed.">        viewModel?.result?.observe(viewLifecycleOwner, Observer {</span>
<span class="nc" id="L197">            handleResult(it)</span>
<span class="nc" id="L198">        })</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">        switch = binding?.switchWidget</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        switch?.visibility = View.VISIBLE</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        switch?.setOnCheckedChangeListener { _, isChecked -&gt; onChangeSwitchState(isChecked) }</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        selectorRV = binding?.selectorRv</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        loader = binding?.loader</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        progressLayout = binding?.progressLayout</span>

<span class="nc" id="L207">        val sharedPreferences: SharedPreferences =</span>
<span class="nc" id="L208">            requireContext().getSharedPreferences(CUSTOM_SELECTOR_PREFERENCE_KEY, MODE_PRIVATE)</span>
<span class="nc" id="L209">        showAlreadyActionedImages =</span>
<span class="nc" id="L210">            sharedPreferences.getBoolean(SHOW_ALREADY_ACTIONED_IMAGES_PREFERENCE_KEY, true)</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        switch?.isChecked = showAlreadyActionedImages</span>

<span class="nc" id="L213">        val builder = AlertDialog.Builder(requireActivity())</span>
<span class="nc" id="L214">        builder.setCancelable(false)</span>
<span class="nc" id="L215">        progressDialogLayout = ProgressDialogBinding.inflate(layoutInflater, container, false)</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        builder.setView(progressDialogLayout.root)</span>
<span class="nc" id="L217">        progressDialog = builder.create()</span>

<span class="nc bnc" id="L219" title="All 2 branches missed.">        return binding?.root</span>
    }

    private fun onChangeSwitchState(checked: Boolean) {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (checked) {</span>
<span class="nc" id="L224">            showAlreadyActionedImages = true</span>
<span class="nc" id="L225">            val sharedPreferences: SharedPreferences =</span>
<span class="nc" id="L226">                requireContext().getSharedPreferences(CUSTOM_SELECTOR_PREFERENCE_KEY, MODE_PRIVATE)</span>
<span class="nc" id="L227">            val editor = sharedPreferences.edit()</span>
<span class="nc" id="L228">            editor.putBoolean(SHOW_ALREADY_ACTIONED_IMAGES_PREFERENCE_KEY, true)</span>
<span class="nc" id="L229">            editor.apply()</span>
        } else {
<span class="nc" id="L231">            showAlreadyActionedImages = false</span>
<span class="nc" id="L232">            val sharedPreferences: SharedPreferences =</span>
<span class="nc" id="L233">                requireContext().getSharedPreferences(CUSTOM_SELECTOR_PREFERENCE_KEY, MODE_PRIVATE)</span>
<span class="nc" id="L234">            val editor = sharedPreferences.edit()</span>
<span class="nc" id="L235">            editor.putBoolean(SHOW_ALREADY_ACTIONED_IMAGES_PREFERENCE_KEY, false)</span>
<span class="nc" id="L236">            editor.apply()</span>
        }

<span class="nc bnc" id="L239" title="All 2 branches missed.">        imageAdapter.init(allImages, allImages, TreeMap())</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        imageAdapter.notifyDataSetChanged()</span>
<span class="nc" id="L241">    }</span>

    /**
     * Attaching data listener
     */
    override fun onAttach(activity: Activity) {
<span class="nc" id="L247">        super.onAttach(activity)</span>
<span class="nc" id="L248">        try {</span>
<span class="nc" id="L249">            (getActivity() as CustomSelectorActivity).setOnDataListener(this)</span>
<span class="nc" id="L250">        } catch (ex: Exception) {</span>
<span class="nc" id="L251">            ex.printStackTrace()</span>
        }
<span class="nc" id="L253">    }</span>

    /**
     * Handle view model result.
     */
    private fun handleResult(result: Result) {
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (result.status is CallbackStatus.SUCCESS) {</span>
<span class="nc" id="L260">            val images = result.images</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">            if (images.isNotEmpty()) {</span>
<span class="nc" id="L262">                filteredImages = ImageHelper.filterImages(images, bucketId)</span>
<span class="nc" id="L263">                allImages = ArrayList(filteredImages)</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                imageAdapter.init(filteredImages, allImages, TreeMap())</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                selectorRV?.let {</span>
<span class="nc" id="L266">                    it.visibility = View.VISIBLE</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                    lastItemId?.let { pos -&gt;</span>
<span class="nc" id="L268">                        (it.layoutManager as GridLayoutManager)</span>
<span class="nc" id="L269">                            .scrollToPosition(ImageHelper.getIndexFromId(filteredImages, pos))</span>
<span class="nc" id="L270">                    }</span>
                }
            } else {
<span class="nc bnc" id="L273" title="All 4 branches missed.">                binding?.emptyText?.let {</span>
<span class="nc" id="L274">                    it.visibility = View.VISIBLE</span>
<span class="nc" id="L275">                }</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                selectorRV?.let {</span>
<span class="nc" id="L277">                    it.visibility = View.GONE</span>
<span class="nc" id="L278">                }</span>
            }
        }
<span class="nc bnc" id="L281" title="All 2 branches missed.">        loader?.let {</span>
<span class="nc" id="L282">            it.visibility =</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                if (result.status is CallbackStatus.FETCHING) View.VISIBLE else View.GONE</span>
<span class="nc" id="L284">        }</span>
<span class="nc" id="L285">    }</span>

    /**
     * getSpanCount for GridViewManager.
     *
     * @return spanCount.
     */
    private fun getSpanCount(): Int {
<span class="nc" id="L293">        return 3</span>
        // todo change span count depending on the device orientation and other factos.
    }

    /**
     * onResume
     * notifyDataSetChanged, rebuild the holder views to account for deleted images.
     */
    override fun onResume() {
<span class="nc bnc" id="L302" title="All 2 branches missed.">        imageAdapter.notifyDataSetChanged()</span>
<span class="nc" id="L303">        super.onResume()</span>
<span class="nc" id="L304">    }</span>

    /**
     * OnDestroy
     * Cleanup the imageLoader coroutine.
     * Save the Image Fragment state.
     */
    override fun onDestroy() {
<span class="nc bnc" id="L312" title="All 2 branches missed.">        imageAdapter.cleanUp()</span>

<span class="nc bnc" id="L314" title="All 2 branches missed.">        val position = (selectorRV?.layoutManager as GridLayoutManager)</span>
<span class="nc" id="L315">            .findFirstVisibleItemPosition()</span>

        // Check for empty RecyclerView.
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (position != -1) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            context?.let { context -&gt;</span>
<span class="nc" id="L320">                context.getSharedPreferences(</span>
<span class="nc" id="L321">                    &quot;CustomSelector&quot;,</span>
<span class="nc" id="L322">                    BaseActivity.MODE_PRIVATE</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                )?.let { prefs -&gt;</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                    prefs.edit()?.let { editor -&gt;</span>
<span class="nc bnc" id="L325" title="All 4 branches missed.">                        editor.putLong(&quot;ItemId&quot;, imageAdapter.getImageIdAt(position))?.apply()</span>
                    }
                }
            }
        }
<span class="nc" id="L330">        super.onDestroy()</span>
<span class="nc" id="L331">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L334">        _binding = null</span>
<span class="nc" id="L335">        super.onDestroyView()</span>
<span class="nc" id="L336">    }</span>

    override fun refresh() {
<span class="nc bnc" id="L339" title="All 2 branches missed.">        imageAdapter.refresh(filteredImages, allImages)</span>
<span class="nc" id="L340">    }</span>

    /**
     * Passes selected images and other information from Activity to Fragment and connects it with
     * the adapter
     */
    override fun passSelectedImages(selectedImages: ArrayList&lt;Image&gt;, shouldRefresh: Boolean) {
<span class="nc bnc" id="L347" title="All 2 branches missed.">        imageAdapter.setSelectedImages(selectedImages)</span>

<span class="nc bnc" id="L349" title="All 4 branches missed.">        if (!showAlreadyActionedImages &amp;&amp; shouldRefresh) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            imageAdapter.init(filteredImages, allImages, TreeMap())</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">            imageAdapter.setSelectedImages(selectedImages)</span>
        }
<span class="nc" id="L353">    }</span>

    /**
     * Shows mark/unmark progress dialog
     */
    fun showMarkUnmarkProgressDialog(text: String) {
<span class="nc bnc" id="L359" title="All 4 branches missed.">        if (!progressDialog.isShowing) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            progressDialogLayout.progressDialogText.text = text</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">            progressDialog.show()</span>
        }
<span class="nc" id="L363">    }</span>

    /**
     * Dismisses mark/unmark progress dialog
     */
    fun dismissMarkUnmarkProgressDialog() {
<span class="nc bnc" id="L369" title="All 4 branches missed.">        if (progressDialog.isShowing) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">            progressDialog.dismiss()</span>
        }
<span class="nc" id="L372">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>