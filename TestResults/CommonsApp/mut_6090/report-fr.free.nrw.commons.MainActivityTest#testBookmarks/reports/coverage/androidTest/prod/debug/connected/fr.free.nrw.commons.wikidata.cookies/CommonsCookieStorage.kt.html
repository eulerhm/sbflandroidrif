<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonsCookieStorage.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.wikidata.cookies</a> &gt; <span class="el_source">CommonsCookieStorage.kt</span></div><h1>CommonsCookieStorage.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.wikidata.cookies

import com.google.gson.GsonBuilder
import com.google.gson.TypeAdapter
import com.google.gson.stream.JsonReader
import com.google.gson.stream.JsonWriter
import fr.free.nrw.commons.kvstore.JsonKvStore
import okhttp3.Cookie
import okhttp3.HttpUrl
import okhttp3.HttpUrl.Companion.toHttpUrlOrNull
import org.wikipedia.dataclient.WikiSite

private const val COOKIE_STORE = &quot;cookie_store&quot;

<span class="fc" id="L15">class CommonsCookieStorage(private val preferences: JsonKvStore? = null) {</span>
<span class="fc" id="L16">    private val gson = GsonBuilder().registerTypeAdapter(</span>
            CommonsCookieStorage::class.java,
<span class="fc" id="L18">            CookieStorageTypeAdapter()</span>
<span class="fc" id="L19">        ).create()</span>
<span class="fc" id="L20">    private val cookieMap: MutableMap&lt;String, List&lt;Cookie&gt;&gt; = mutableMapOf()</span>

<span class="fc" id="L22">    val domains : Set&lt;String&gt; get() = cookieMap.keys.toSet()</span>

    operator fun set(domainSpec: String, cookies: MutableList&lt;Cookie&gt;) =
<span class="fc" id="L25">        cookieMap.put(domainSpec, cookies.toList())</span>

    operator fun get(domainSpec: String): MutableList&lt;Cookie&gt; =
<span class="pc bpc" id="L28" title="2 of 4 branches missed.">        cookieMap[domainSpec]?.toMutableList() ?: mutableListOf()</span>

    fun clear() {
<span class="nc" id="L31">        cookieMap.clear()</span>
<span class="nc" id="L32">        save()</span>
<span class="nc" id="L33">    }</span>

    fun load() {
<span class="fc" id="L36">        cookieMap.clear()</span>
<span class="fc" id="L37">        val json = preferences!!.getString(COOKIE_STORE, null)</span>
<span class="pc bpc" id="L38" title="3 of 6 branches missed.">        if (!json.isNullOrEmpty()) {</span>
<span class="fc" id="L39">            val serializedData = gson.fromJson(json, CommonsCookieStorage::class.java)</span>
<span class="fc" id="L40">            cookieMap.putAll(serializedData.cookieMap)</span>
        }
<span class="fc" id="L42">    }</span>

    fun save() =
<span class="fc" id="L45">        preferences!!.putString(COOKIE_STORE, gson.toJson(this))</span>

    fun contains(domainSpec: String): Boolean =
<span class="fc" id="L48">        cookieMap.containsKey(domainSpec)</span>

    companion object {
<span class="fc" id="L51">        fun from(map: Map&lt;String, List&lt;Cookie&gt;&gt;) = CommonsCookieStorage().apply {</span>
<span class="fc" id="L52">            cookieMap.clear()</span>
<span class="fc" id="L53">            cookieMap.putAll(map)</span>
<span class="fc" id="L54">        }</span>
    }
<span class="fc" id="L56">}</span>

<span class="fc" id="L58">private class CookieStorageTypeAdapter : TypeAdapter&lt;CommonsCookieStorage&gt;() {</span>
    override fun write(out: JsonWriter, value: CommonsCookieStorage) {
<span class="fc" id="L60">        out.beginObject()</span>
<span class="fc" id="L61">        value.domains.forEach { domain -&gt;</span>
<span class="fc" id="L62">            out.name(domain).beginArray()</span>
<span class="fc" id="L63">            value[domain].forEach { out.value(it.toString()) }</span>
<span class="fc" id="L64">            out.endArray()</span>
<span class="fc" id="L65">        }</span>
<span class="fc" id="L66">        out.endObject()</span>
<span class="fc" id="L67">    }</span>

    override fun read(input: JsonReader): CommonsCookieStorage {
<span class="fc" id="L70">        val map = mutableMapOf&lt;String, List&lt;Cookie&gt;&gt;()</span>
<span class="fc" id="L71">        input.beginObject()</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">        while (input.hasNext()) {</span>
<span class="fc" id="L73">            val key = input.nextName()</span>
<span class="fc" id="L74">            map[key] = input.readCookies((WikiSite.DEFAULT_SCHEME + &quot;://&quot; + key).toHttpUrlOrNull())</span>
        }
<span class="fc" id="L76">        input.endObject()</span>
<span class="fc" id="L77">        return CommonsCookieStorage.from(map)</span>
    }

    private fun JsonReader.readCookies(url: HttpUrl?): MutableList&lt;Cookie&gt; {
<span class="fc" id="L81">        val list = mutableListOf&lt;Cookie&gt;()</span>
<span class="fc" id="L82">        beginArray()</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">        while (hasNext()) {</span>
<span class="fc" id="L84">            val str = nextString()</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">            url?.let {</span>
<span class="fc" id="L86">                val element: Cookie? = Cookie.parse(url, str)</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">                element?.let { list += element }</span>
            }
        }
<span class="fc" id="L90">        endArray()</span>
<span class="fc" id="L91">        return list</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>