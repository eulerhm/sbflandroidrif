<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SessionManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.auth</a> &gt; <span class="el_source">SessionManager.java</span></div><h1>SessionManager.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.auth;

import android.accounts.Account;
import android.accounts.AccountManager;
import android.content.Context;
import android.os.Build;
import android.text.TextUtils;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import fr.free.nrw.commons.auth.login.LoginResult;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;
import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import io.reactivex.Completable;
import io.reactivex.Observable;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Manage the current logged in user session.
 */
@Singleton
public class SessionManager {

    private final Context context;

    // Unlike a savings account...  ;-)
    private Account currentAccount;

    private JsonKvStore defaultKvStore;

    @Inject
<span class="fc" id="L34">    public SessionManager(Context context, @Named(&quot;default_preferences&quot;) JsonKvStore defaultKvStore) {</span>
<span class="fc" id="L35">        this.context = context;</span>
<span class="pc bpc" id="L36" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1458)) {</span>
<span class="fc" id="L37">            this.currentAccount = null;</span>
        }
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1459)) {</span>
<span class="fc" id="L40">            this.defaultKvStore = defaultKvStore;</span>
        }
<span class="fc" id="L42">    }</span>

    private boolean createAccount(@NonNull String userName, @NonNull String password) {
<span class="nc" id="L45">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1464)) {</span>
<span class="nc bnc" id="L47" title="All 26 branches missed.">            if ((ListenerUtil.mutListener.listen(1461) ? ((ListenerUtil.mutListener.listen(1460) ? (account == null &amp;&amp; TextUtils.isEmpty(account.name)) : (account == null || TextUtils.isEmpty(account.name))) &amp;&amp; !account.name.equals(userName)) : ((ListenerUtil.mutListener.listen(1460) ? (account == null &amp;&amp; TextUtils.isEmpty(account.name)) : (account == null || TextUtils.isEmpty(account.name))) || !account.name.equals(userName)))) {</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1462)) {</span>
<span class="nc" id="L49">                    removeAccount();</span>
                }
<span class="nc bnc" id="L51" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1463)) {</span>
<span class="nc" id="L52">                    account = new Account(userName, BuildConfig.ACCOUNT_TYPE);</span>
                }
<span class="nc" id="L54">                return accountManager().addAccountExplicitly(account, password, null);</span>
            }
        }
<span class="nc" id="L57">        return true;</span>
    }

    private void removeAccount() {
<span class="nc" id="L61">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1473)) {</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (account != null) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1472)) {</span>
<span class="nc bnc" id="L65" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(1469) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.LOLLIPOP_MR1) : (ListenerUtil.mutListener.listen(1468) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.LOLLIPOP_MR1) : (ListenerUtil.mutListener.listen(1467) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP_MR1) : (ListenerUtil.mutListener.listen(1466) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.LOLLIPOP_MR1) : (ListenerUtil.mutListener.listen(1465) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.LOLLIPOP_MR1) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP_MR1))))))) {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1471)) {</span>
<span class="nc" id="L67">                            accountManager().removeAccountExplicitly(account);</span>
                        }
                    } else {
<span class="nc bnc" id="L70" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1470)) {</span>
                            // noinspection deprecation
<span class="nc" id="L72">                            accountManager().removeAccount(account, null, null);</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L78">    }</span>

    public void updateAccount(LoginResult result) {
<span class="nc" id="L81">        boolean accountCreated = createAccount(result.getUserName(), result.getPassword());</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1475)) {</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            if (accountCreated) {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1474)) {</span>
<span class="nc" id="L85">                    setPassword(result.getPassword());</span>
                }
            }
        }
<span class="nc" id="L89">    }</span>

    private void setPassword(@NonNull String password) {
<span class="nc" id="L92">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1477)) {</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            if (account != null) {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1476)) {</span>
<span class="nc" id="L96">                    accountManager().setPassword(account, password);</span>
                }
            }
        }
<span class="nc" id="L100">    }</span>

    /**
     * @return Account|null
     */
    @Nullable
    public Account getCurrentAccount() {
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1480)) {</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            if (currentAccount == null) {</span>
<span class="fc" id="L109">                AccountManager accountManager = AccountManager.get(context);</span>
<span class="fc" id="L110">                Account[] allAccounts = accountManager.getAccountsByType(BuildConfig.ACCOUNT_TYPE);</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1479)) {</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">                    if (allAccounts.length != 0) {</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1478)) {</span>
<span class="fc" id="L114">                            currentAccount = allAccounts[0];</span>
                        }
                    }
                }
            }
        }
<span class="fc" id="L120">        return currentAccount;</span>
    }

    public boolean doesAccountExist() {
<span class="nc bnc" id="L124" title="All 2 branches missed.">        return getCurrentAccount() != null;</span>
    }

    @Nullable
    public String getUserName() {
<span class="fc" id="L129">        Account account = getCurrentAccount();</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        return account == null ? null : account.name;</span>
    }

    @Nullable
    public String getPassword() {
<span class="nc" id="L135">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        return account == null ? null : accountManager().getPassword(account);</span>
    }

    private AccountManager accountManager() {
<span class="nc" id="L140">        return AccountManager.get(context);</span>
    }

    public boolean isUserLoggedIn() {
<span class="nc" id="L144">        return defaultKvStore.getBoolean(&quot;isUserLoggedIn&quot;, false);</span>
    }

    void setUserLoggedIn(boolean isLoggedIn) {
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1481)) {</span>
<span class="nc" id="L149">            defaultKvStore.putBoolean(&quot;isUserLoggedIn&quot;, isLoggedIn);</span>
        }
<span class="nc" id="L151">    }</span>

    public void forceLogin(Context context) {
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1483)) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (context != null) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1482)) {</span>
<span class="nc" id="L157">                    LoginActivity.startYourself(context);</span>
                }
            }
        }
<span class="nc" id="L161">    }</span>

    /**
     * 1. Clears existing accounts from account manager
     * 2. Calls MediaWikiApi's logout function to clear cookies
     * @return
     */
    public Completable logout() {
<span class="nc" id="L169">        AccountManager accountManager = AccountManager.get(context);</span>
<span class="nc" id="L170">        Account[] allAccounts = accountManager.getAccountsByType(BuildConfig.ACCOUNT_TYPE);</span>
<span class="nc" id="L171">        return Completable.fromObservable(Observable.fromArray(allAccounts).map(a -&gt; accountManager.removeAccount(a, null, null).getResult())).doOnComplete(() -&gt; {</span>
<span class="nc" id="L172">            currentAccount = null;</span>
<span class="nc" id="L173">        });</span>
    }

    /**
     * Return a corresponding boolean preference
     *
     * @param key
     * @return
     */
    public boolean getPreference(String key) {
<span class="nc" id="L183">        return defaultKvStore.getBoolean(key);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>