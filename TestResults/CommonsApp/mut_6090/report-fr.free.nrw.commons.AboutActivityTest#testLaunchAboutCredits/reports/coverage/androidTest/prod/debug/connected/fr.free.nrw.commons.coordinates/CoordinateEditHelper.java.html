<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CoordinateEditHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.coordinates</a> &gt; <span class="el_source">CoordinateEditHelper.java</span></div><h1>CoordinateEditHelper.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.coordinates;

import static fr.free.nrw.commons.notification.NotificationHelper.NOTIFICATION_EDIT_COORDINATES;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.actions.PageEditClient;
import fr.free.nrw.commons.notification.NotificationHelper;
import fr.free.nrw.commons.utils.ViewUtilWrapper;
import io.reactivex.Observable;
import io.reactivex.Single;
import io.reactivex.schedulers.Schedulers;
import java.util.Objects;
import javax.inject.Inject;
import javax.inject.Named;
import org.apache.commons.lang3.StringUtils;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Helper class for edit and update given coordinates and showing notification about new coordinates
 * upgradation
 */
public class CoordinateEditHelper {

    /**
     * notificationHelper: helps creating notification
     */
    private final NotificationHelper notificationHelper;

    /**
     * * pageEditClient: methods provided by this member posts the edited coordinates
     * to the Media wiki api
     */
    public final PageEditClient pageEditClient;

    /**
     * viewUtil: helps to show Toast
     */
    private final ViewUtilWrapper viewUtil;

    @Inject
<span class="nc" id="L46">    public CoordinateEditHelper(final NotificationHelper notificationHelper, @Named(&quot;commons-page-edit&quot;) final PageEditClient pageEditClient, final ViewUtilWrapper viewUtil) {</span>
<span class="nc" id="L47">        this.notificationHelper = notificationHelper;</span>
<span class="nc" id="L48">        this.pageEditClient = pageEditClient;</span>
<span class="nc" id="L49">        this.viewUtil = viewUtil;</span>
<span class="nc" id="L50">    }</span>

    /**
     * Public interface to edit coordinates
     * @param context to be added
     * @param media to be added
     * @param Accuracy to be added
     * @return Single&lt;Boolean&gt;
     */
    public Single&lt;Boolean&gt; makeCoordinatesEdit(final Context context, final Media media, final String Latitude, final String Longitude, final String Accuracy) {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(529)) {</span>
<span class="nc" id="L61">            viewUtil.showShortToast(context, context.getString(R.string.coordinates_edit_helper_make_edit_toast));</span>
        }
<span class="nc" id="L63">        return addCoordinates(media, Latitude, Longitude, Accuracy).flatMapSingle(result -&gt; Single.just(showCoordinatesEditNotification(context, media, Latitude, Longitude, Accuracy, result))).firstOrError();</span>
    }

    /**
     * Replaces new coordinates
     * @param media to be added
     * @param Latitude to be added
     * @param Longitude to be added
     * @param Accuracy to be added
     * @return Observable&lt;Boolean&gt;
     */
    private Observable&lt;Boolean&gt; addCoordinates(final Media media, final String Latitude, final String Longitude, final String Accuracy) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(530)) {</span>
<span class="nc" id="L76">            Timber.d(&quot;thread is coordinates adding %s&quot;, Thread.currentThread().getName());</span>
        }
<span class="nc" id="L78">        final String summary = &quot;Adding Coordinates&quot;;</span>
<span class="nc" id="L79">        final StringBuilder buffer = new StringBuilder();</span>
<span class="nc" id="L80">        final String wikiText = pageEditClient.getCurrentWikiText(media.getFilename()).subscribeOn(Schedulers.io()).blockingGet();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(532)) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">            if (Latitude != null) {</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(531)) {</span>
<span class="nc" id="L84">                    buffer.append(&quot;\n{{Location|&quot;).append(Latitude).append(&quot;|&quot;).append(Longitude).append(&quot;|&quot;).append(Accuracy).append(&quot;}}&quot;);</span>
                }
            }
        }
<span class="nc" id="L88">        final String editedLocation = buffer.toString();</span>
<span class="nc" id="L89">        final String appendText = getFormattedWikiText(wikiText, editedLocation);</span>
<span class="nc" id="L90">        return pageEditClient.edit(Objects.requireNonNull(media.getFilename()), appendText, summary);</span>
    }

    /**
     * Helps to get formatted wikitext with upgraded location
     * @param wikiText current wikitext
     * @param editedLocation new location
     * @return String
     */
    private String getFormattedWikiText(final String wikiText, final String editedLocation) {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(557)) {</span>
<span class="nc bnc" id="L101" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(533) ? (wikiText.contains(&quot;filedesc&quot;) || wikiText.contains(&quot;Location&quot;)) : (wikiText.contains(&quot;filedesc&quot;) &amp;&amp; wikiText.contains(&quot;Location&quot;)))) {</span>
<span class="nc" id="L102">                final String fromLocationToEnd = wikiText.substring(wikiText.indexOf(&quot;{{Location&quot;));</span>
<span class="nc" id="L103">                final String firstHalf = wikiText.substring(0, wikiText.indexOf(&quot;{{Location&quot;));</span>
<span class="nc bnc" id="L104" title="All 8 branches missed.">                final String lastHalf = fromLocationToEnd.substring((ListenerUtil.mutListener.listen(537) ? (fromLocationToEnd.indexOf(&quot;}}&quot;) % 2) : (ListenerUtil.mutListener.listen(536) ? (fromLocationToEnd.indexOf(&quot;}}&quot;) / 2) : (ListenerUtil.mutListener.listen(535) ? (fromLocationToEnd.indexOf(&quot;}}&quot;) * 2) : (ListenerUtil.mutListener.listen(534) ? (fromLocationToEnd.indexOf(&quot;}}&quot;) - 2) : (fromLocationToEnd.indexOf(&quot;}}&quot;) + 2))))));</span>
<span class="nc" id="L105">                final int startOfSecondSection = StringUtils.ordinalIndexOf(wikiText, &quot;==&quot;, 3);</span>
<span class="nc" id="L106">                final StringBuilder buffer = new StringBuilder();</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(544)) {</span>
<span class="nc bnc" id="L108" title="All 10 branches missed.">                    if (wikiText.charAt((ListenerUtil.mutListener.listen(541) ? (wikiText.indexOf(&quot;{{Location&quot;) % 1) : (ListenerUtil.mutListener.listen(540) ? (wikiText.indexOf(&quot;{{Location&quot;) / 1) : (ListenerUtil.mutListener.listen(539) ? (wikiText.indexOf(&quot;{{Location&quot;) * 1) : (ListenerUtil.mutListener.listen(538) ? (wikiText.indexOf(&quot;{{Location&quot;) + 1) : (wikiText.indexOf(&quot;{{Location&quot;) - 1)))))) == '\n') {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(543)) {</span>
<span class="nc" id="L110">                            buffer.append(editedLocation.substring(1));</span>
                        }
                    } else {
<span class="nc bnc" id="L113" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(542)) {</span>
<span class="nc" id="L114">                            buffer.append(editedLocation);</span>
                        }
                    }
                }
<span class="nc bnc" id="L118" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(556)) {</span>
<span class="nc bnc" id="L119" title="All 66 branches missed.">                    if ((ListenerUtil.mutListener.listen(554) ? ((ListenerUtil.mutListener.listen(549) ? (startOfSecondSection &gt;= -1) : (ListenerUtil.mutListener.listen(548) ? (startOfSecondSection &lt;= -1) : (ListenerUtil.mutListener.listen(547) ? (startOfSecondSection &gt; -1) : (ListenerUtil.mutListener.listen(546) ? (startOfSecondSection &lt; -1) : (ListenerUtil.mutListener.listen(545) ? (startOfSecondSection == -1) : (startOfSecondSection != -1)))))) || wikiText.charAt((ListenerUtil.mutListener.listen(553) ? (startOfSecondSection % 1) : (ListenerUtil.mutListener.listen(552) ? (startOfSecondSection / 1) : (ListenerUtil.mutListener.listen(551) ? (startOfSecondSection * 1) : (ListenerUtil.mutListener.listen(550) ? (startOfSecondSection + 1) : (startOfSecondSection - 1)))))) != '\n') : ((ListenerUtil.mutListener.listen(549) ? (startOfSecondSection &gt;= -1) : (ListenerUtil.mutListener.listen(548) ? (startOfSecondSection &lt;= -1) : (ListenerUtil.mutListener.listen(547) ? (startOfSecondSection &gt; -1) : (ListenerUtil.mutListener.listen(546) ? (startOfSecondSection &lt; -1) : (ListenerUtil.mutListener.listen(545) ? (startOfSecondSection == -1) : (startOfSecondSection != -1)))))) &amp;&amp; wikiText.charAt((ListenerUtil.mutListener.listen(553) ? (startOfSecondSection % 1) : (ListenerUtil.mutListener.listen(552) ? (startOfSecondSection / 1) : (ListenerUtil.mutListener.listen(551) ? (startOfSecondSection * 1) : (ListenerUtil.mutListener.listen(550) ? (startOfSecondSection + 1) : (startOfSecondSection - 1)))))) != '\n'))) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(555)) {</span>
<span class="nc" id="L121">                            buffer.append(&quot;\n&quot;);</span>
                        }
                    }
                }
<span class="nc" id="L125">                return firstHalf + buffer + lastHalf;</span>
            }
        }
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(565)) {</span>
<span class="nc bnc" id="L129" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(558) ? (wikiText.contains(&quot;filedesc&quot;) || !wikiText.contains(&quot;Location&quot;)) : (wikiText.contains(&quot;filedesc&quot;) &amp;&amp; !wikiText.contains(&quot;Location&quot;)))) {</span>
<span class="nc" id="L130">                final int startOfSecondSection = StringUtils.ordinalIndexOf(wikiText, &quot;==&quot;, 3);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(564)) {</span>
<span class="nc bnc" id="L132" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(563) ? (startOfSecondSection &gt;= -1) : (ListenerUtil.mutListener.listen(562) ? (startOfSecondSection &lt;= -1) : (ListenerUtil.mutListener.listen(561) ? (startOfSecondSection &gt; -1) : (ListenerUtil.mutListener.listen(560) ? (startOfSecondSection &lt; -1) : (ListenerUtil.mutListener.listen(559) ? (startOfSecondSection == -1) : (startOfSecondSection != -1))))))) {</span>
<span class="nc" id="L133">                        final String firstHalf = wikiText.substring(0, startOfSecondSection);</span>
<span class="nc" id="L134">                        final String lastHalf = wikiText.substring(startOfSecondSection);</span>
<span class="nc" id="L135">                        final String buffer = editedLocation.substring(1) + &quot;\n&quot;;</span>
<span class="nc" id="L136">                        return firstHalf + buffer + lastHalf;</span>
                    }
                }
<span class="nc" id="L139">                return wikiText + editedLocation;</span>
            }
        }
<span class="nc" id="L142">        return &quot;== {{int:filedesc}} ==&quot; + editedLocation + wikiText;</span>
    }

    /**
     * Update coordinates and shows notification about coordinates update
     * @param context to be added
     * @param media to be added
     * @param latitude to be added
     * @param longitude to be added
     * @param Accuracy to be added
     * @param result to be added
     * @return boolean
     */
    private boolean showCoordinatesEditNotification(final Context context, final Media media, final String latitude, final String longitude, final String Accuracy, final boolean result) {
        final String message;
<span class="nc" id="L157">        String title = context.getString(R.string.coordinates_edit_helper_show_edit_title);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (result) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(567)) {</span>
<span class="nc" id="L160">                media.setCoordinates(new fr.free.nrw.commons.location.LatLng(Double.parseDouble(latitude), Double.parseDouble(longitude), Float.parseFloat(Accuracy)));</span>
            }
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(568)) {</span>
<span class="nc" id="L163">                title += &quot;: &quot; + context.getString(R.string.coordinates_edit_helper_show_edit_title_success);</span>
            }
<span class="nc" id="L165">            final StringBuilder coordinatesInMessage = new StringBuilder();</span>
<span class="nc" id="L166">            final String mediaCoordinate = String.valueOf(media.getCoordinates());</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(569)) {</span>
<span class="nc" id="L168">                coordinatesInMessage.append(mediaCoordinate);</span>
            }
<span class="nc" id="L170">            message = context.getString(R.string.coordinates_edit_helper_show_edit_message, coordinatesInMessage.toString());</span>
<span class="nc" id="L171">        } else {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(566)) {</span>
<span class="nc" id="L173">                title += &quot;: &quot; + context.getString(R.string.coordinates_edit_helper_show_edit_title);</span>
            }
<span class="nc" id="L175">            message = context.getString(R.string.coordinates_edit_helper_edit_message_else);</span>
        }
<span class="nc" id="L177">        final String urlForFile = BuildConfig.COMMONS_URL + &quot;/wiki/&quot; + media.getFilename();</span>
<span class="nc" id="L178">        final Intent browserIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(urlForFile));</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(570)) {</span>
<span class="nc" id="L180">            notificationHelper.showNotification(context, title, message, NOTIFICATION_EDIT_COORDINATES, browserIntent);</span>
        }
<span class="nc" id="L182">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>