<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PicOfDayAppWidget.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.widget</a> &gt; <span class="el_source">PicOfDayAppWidget.java</span></div><h1>PicOfDayAppWidget.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.widget;

import android.app.PendingIntent;
import android.appwidget.AppWidgetManager;
import android.appwidget.AppWidgetProvider;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.Canvas;
import android.graphics.Paint;
import android.net.Uri;
import android.widget.RemoteViews;
import androidx.annotation.Nullable;
import com.facebook.common.executors.CallerThreadExecutor;
import com.facebook.common.references.CloseableReference;
import com.facebook.datasource.DataSource;
import com.facebook.drawee.backends.pipeline.Fresco;
import com.facebook.imagepipeline.core.ImagePipeline;
import com.facebook.imagepipeline.datasource.BaseBitmapDataSubscriber;
import com.facebook.imagepipeline.image.CloseableImage;
import com.facebook.imagepipeline.request.ImageRequest;
import com.facebook.imagepipeline.request.ImageRequestBuilder;
import fr.free.nrw.commons.media.MediaClient;
import javax.inject.Inject;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.contributions.MainActivity;
import fr.free.nrw.commons.di.ApplicationlessInjection;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.schedulers.Schedulers;
import timber.log.Timber;
import static android.content.Intent.ACTION_VIEW;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Implementation of App Widget functionality.
 */
<span class="nc" id="L38">public class PicOfDayAppWidget extends AppWidgetProvider {</span>

<span class="nc" id="L40">    private CompositeDisposable compositeDisposable = new CompositeDisposable();</span>

    @Inject
    MediaClient mediaClient;

    void updateAppWidget(Context context, AppWidgetManager appWidgetManager, int appWidgetId) {
<span class="nc" id="L46">        RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.pic_of_day_app_widget);</span>
        // Launch App on Button Click
<span class="nc" id="L48">        Intent viewIntent = new Intent(context, MainActivity.class);</span>
<span class="nc" id="L49">        PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, viewIntent, PendingIntent.FLAG_IMMUTABLE);</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(274)) {</span>
<span class="nc" id="L51">            views.setOnClickPendingIntent(R.id.camera_button, pendingIntent);</span>
        }
<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(275)) {</span>
<span class="nc" id="L54">            appWidgetManager.updateAppWidget(appWidgetId, views);</span>
        }
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(276)) {</span>
<span class="nc" id="L57">            loadPictureOfTheDay(context, views, appWidgetManager, appWidgetId);</span>
        }
<span class="nc" id="L59">    }</span>

    /**
     * Loads the picture of the day using media wiki API
     * @param context
     * @param views
     * @param appWidgetManager
     * @param appWidgetId
     */
    private void loadPictureOfTheDay(Context context, RemoteViews views, AppWidgetManager appWidgetManager, int appWidgetId) {
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(277)) {</span>
<span class="nc" id="L70">            compositeDisposable.add(mediaClient.getPictureOfTheDay().subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).subscribe(response -&gt; {</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">                if (response != null) {</span>
<span class="nc" id="L72">                    views.setTextViewText(R.id.appwidget_title, response.getDisplayTitle());</span>
                    // View in browser
<span class="nc" id="L74">                    Intent viewIntent = new Intent();</span>
<span class="nc" id="L75">                    viewIntent.setAction(ACTION_VIEW);</span>
<span class="nc" id="L76">                    viewIntent.setData(Uri.parse(response.getPageTitle().getMobileUri()));</span>
<span class="nc" id="L77">                    PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, viewIntent, PendingIntent.FLAG_IMMUTABLE);</span>
<span class="nc" id="L78">                    views.setOnClickPendingIntent(R.id.appwidget_image, pendingIntent);</span>
<span class="nc" id="L79">                    loadImageFromUrl(response.getThumbUrl(), context, views, appWidgetManager, appWidgetId);</span>
                }
<span class="nc" id="L81">            }, t -&gt; Timber.e(t, &quot;Fetching picture of the day failed&quot;)));</span>
        }
<span class="nc" id="L83">    }</span>

    /**
     * Uses Fresco to load an image from Url
     * @param imageUrl
     * @param context
     * @param views
     * @param appWidgetManager
     * @param appWidgetId
     */
    private void loadImageFromUrl(String imageUrl, Context context, RemoteViews views, AppWidgetManager appWidgetManager, int appWidgetId) {
<span class="nc" id="L94">        ImageRequest request = ImageRequestBuilder.newBuilderWithSource(Uri.parse(imageUrl)).build();</span>
<span class="nc" id="L95">        ImagePipeline imagePipeline = Fresco.getImagePipeline();</span>
<span class="nc" id="L96">        DataSource&lt;CloseableReference&lt;CloseableImage&gt;&gt; dataSource = imagePipeline.fetchDecodedImage(request, context);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(283)) {</span>
<span class="nc" id="L98">            dataSource.subscribe(new BaseBitmapDataSubscriber() {</span>

                @Override
                protected void onNewResultImpl(@Nullable Bitmap tempBitmap) {
<span class="nc" id="L102">                    Bitmap bitmap = null;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(280)) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                        if (tempBitmap != null) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(278)) {</span>
<span class="nc" id="L106">                                bitmap = Bitmap.createBitmap(tempBitmap.getWidth(), tempBitmap.getHeight(), Bitmap.Config.ARGB_8888);</span>
                            }
<span class="nc" id="L108">                            Canvas canvas = new Canvas(bitmap);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(279)) {</span>
<span class="nc" id="L110">                                canvas.drawBitmap(tempBitmap, 0f, 0f, new Paint());</span>
                            }
                        }
                    }
<span class="nc bnc" id="L114" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(281)) {</span>
<span class="nc" id="L115">                        views.setImageViewBitmap(R.id.appwidget_image, bitmap);</span>
                    }
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(282)) {</span>
<span class="nc" id="L118">                        appWidgetManager.updateAppWidget(appWidgetId, views);</span>
                    }
<span class="nc" id="L120">                }</span>

                @Override
                protected void onFailureImpl(DataSource&lt;CloseableReference&lt;CloseableImage&gt;&gt; dataSource) {
<span class="nc" id="L124">                }</span>
<span class="nc" id="L125">            }, CallerThreadExecutor.getInstance());</span>
        }
<span class="nc" id="L127">    }</span>

    @Override
    public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] appWidgetIds) {
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(284)) {</span>
<span class="nc" id="L132">            ApplicationlessInjection.getInstance(context.getApplicationContext()).getCommonsApplicationComponent().inject(this);</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(286)) {</span>
            {
<span class="nc" id="L136">                long _loopCounter6 = 0;</span>
                // There may be multiple widgets active, so update all of them
<span class="nc bnc" id="L138" title="All 2 branches missed.">                for (int appWidgetId : appWidgetIds) {</span>
<span class="nc" id="L139">                    ListenerUtil.loopListener.listen(&quot;_loopCounter6&quot;, ++_loopCounter6);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(285)) {</span>
<span class="nc" id="L141">                        updateAppWidget(context, appWidgetManager, appWidgetId);</span>
                    }
                }
            }
        }
<span class="nc" id="L146">    }</span>

    @Override
    public void onEnabled(Context context) {
<span class="nc" id="L150">    }</span>

    @Override
    public void onDisabled(Context context) {
<span class="nc" id="L154">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>