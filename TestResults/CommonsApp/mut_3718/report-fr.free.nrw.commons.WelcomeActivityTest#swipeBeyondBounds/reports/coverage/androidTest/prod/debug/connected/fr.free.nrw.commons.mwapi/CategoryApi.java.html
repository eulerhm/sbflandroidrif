<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CategoryApi.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.mwapi</a> &gt; <span class="el_source">CategoryApi.java</span></div><h1>CategoryApi.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.mwapi;

import static fr.free.nrw.commons.category.CategoryClientKt.CATEGORY_PREFIX;
import com.google.gson.Gson;
import fr.free.nrw.commons.category.CategoryItem;
import io.reactivex.Single;
import java.util.ArrayList;
import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Set;
import javax.inject.Inject;
import javax.inject.Named;
import okhttp3.HttpUrl;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import okhttp3.ResponseBody;
import org.wikipedia.dataclient.mwapi.MwQueryPage;
import org.wikipedia.dataclient.mwapi.MwQueryResponse;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Uses the OkHttp library to implement calls to the Commons MediaWiki API to match GPS coordinates
 * with nearby Commons categories. Parses the results using GSON to obtain a list of relevant
 * categories.  Note: that caller is responsible for executing the request() method on a background
 * thread.
 */
public class CategoryApi {

    private final OkHttpClient okHttpClient;

    private final String commonsBaseUrl;

    private final Gson gson;

    @Inject
<span class="nc" id="L39">    public CategoryApi(OkHttpClient okHttpClient, Gson gson, @Named(&quot;wikimedia_api_host&quot;) String commonsBaseUrl) {</span>
<span class="nc" id="L40">        this.okHttpClient = okHttpClient;</span>
<span class="nc" id="L41">        this.commonsBaseUrl = commonsBaseUrl;</span>
<span class="nc" id="L42">        this.gson = gson;</span>
<span class="nc" id="L43">    }</span>

    public Single&lt;List&lt;CategoryItem&gt;&gt; request(String coords) {
<span class="nc" id="L46">        return Single.fromCallable(() -&gt; {</span>
<span class="nc" id="L47">            HttpUrl apiUrl = buildUrl(coords);</span>
<span class="nc" id="L48">            Timber.d(&quot;URL: %s&quot;, apiUrl.toString());</span>
<span class="nc" id="L49">            Request request = new Request.Builder().get().url(apiUrl).build();</span>
<span class="nc" id="L50">            Response response = okHttpClient.newCall(request).execute();</span>
<span class="nc" id="L51">            ResponseBody body = response.body();</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if (body == null) {</span>
<span class="nc" id="L53">                return Collections.emptyList();</span>
            }
<span class="nc" id="L55">            MwQueryResponse apiResponse = gson.fromJson(body.charStream(), MwQueryResponse.class);</span>
<span class="nc" id="L56">            Set&lt;CategoryItem&gt; categories = new LinkedHashSet&lt;&gt;();</span>
<span class="nc bnc" id="L57" title="All 6 branches missed.">            if (apiResponse != null &amp;&amp; apiResponse.query() != null &amp;&amp; apiResponse.query().pages() != null) {</span>
                {
<span class="nc" id="L59">                    long _loopCounter89 = 0;</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">                    for (MwQueryPage page : apiResponse.query().pages()) {</span>
<span class="nc" id="L61">                        ListenerUtil.loopListener.listen(&quot;_loopCounter89&quot;, ++_loopCounter89);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">                        if (page.categories() != null) {</span>
                            {
<span class="nc" id="L64">                                long _loopCounter88 = 0;</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                                for (MwQueryPage.Category category : page.categories()) {</span>
<span class="nc" id="L66">                                    ListenerUtil.loopListener.listen(&quot;_loopCounter88&quot;, ++_loopCounter88);</span>
<span class="nc" id="L67">                                    categories.add(new CategoryItem(category.title().replace(CATEGORY_PREFIX, &quot;&quot;), &quot;&quot;, &quot;&quot;, false));</span>
<span class="nc" id="L68">                                }</span>
                            }
                        }
<span class="nc" id="L71">                    }</span>
                }
            }
<span class="nc" id="L74">            return new ArrayList&lt;&gt;(categories);</span>
        });
    }

    /**
     * Builds URL with image coords for MediaWiki API calls
     * Example URL: https://commons.wikimedia.org/w/api.php?action=query&amp;prop=categories|coordinates|pageprops&amp;format=json&amp;clshow=!hidden&amp;coprop=type|name|dim|country|region|globe&amp;codistancefrompoint=38.11386944444445|13.356263888888888&amp;generator=geosearch&amp;redirects=&amp;ggscoord=38.11386944444445|1.356263888888888&amp;ggsradius=100&amp;ggslimit=10&amp;ggsnamespace=6&amp;ggsprop=type|name|dim|country|region|globe&amp;ggsprimary=all&amp;formatversion=2
     *
     * @param coords Coordinates to build query with
     * @return URL for API query
     */
    private HttpUrl buildUrl(String coords) {
<span class="nc" id="L86">        return HttpUrl.parse(commonsBaseUrl).newBuilder().addQueryParameter(&quot;action&quot;, &quot;query&quot;).addQueryParameter(&quot;prop&quot;, &quot;categories|coordinates|pageprops&quot;).addQueryParameter(&quot;format&quot;, &quot;json&quot;).addQueryParameter(&quot;clshow&quot;, &quot;!hidden&quot;).addQueryParameter(&quot;coprop&quot;, &quot;type|name|dim|country|region|globe&quot;).addQueryParameter(&quot;codistancefrompoint&quot;, coords).addQueryParameter(&quot;generator&quot;, &quot;geosearch&quot;).addQueryParameter(&quot;ggscoord&quot;, coords).addQueryParameter(&quot;ggsradius&quot;, &quot;10000&quot;).addQueryParameter(&quot;ggslimit&quot;, &quot;10&quot;).addQueryParameter(&quot;ggsnamespace&quot;, &quot;6&quot;).addQueryParameter(&quot;ggsprop&quot;, &quot;type|name|dim|country|region|globe&quot;).addQueryParameter(&quot;ggsprimary&quot;, &quot;all&quot;).addQueryParameter(&quot;formatversion&quot;, &quot;2&quot;).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>