<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoreBottomSheetFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.navtab</a> &gt; <span class="el_source">MoreBottomSheetFragment.java</span></div><h1>MoreBottomSheetFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.navtab;

import android.accounts.Account;
import android.accounts.AccountManager;
import android.content.ActivityNotFoundException;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.TextView;
import android.widget.Toast;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AlertDialog;
import com.google.android.material.bottomsheet.BottomSheetDialogFragment;
import fr.free.nrw.commons.AboutActivity;
import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.WelcomeActivity;
import fr.free.nrw.commons.actions.PageEditClient;
import fr.free.nrw.commons.auth.LoginActivity;
import fr.free.nrw.commons.databinding.FragmentMoreBottomSheetBinding;
import fr.free.nrw.commons.di.ApplicationlessInjection;
import fr.free.nrw.commons.feedback.FeedbackContentCreator;
import fr.free.nrw.commons.feedback.model.Feedback;
import fr.free.nrw.commons.feedback.FeedbackDialog;
import fr.free.nrw.commons.kvstore.BasicKvStore;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.logging.CommonsLogSender;
import fr.free.nrw.commons.profile.ProfileActivity;
import fr.free.nrw.commons.review.ReviewActivity;
import fr.free.nrw.commons.settings.SettingsActivity;
import io.reactivex.Single;
import io.reactivex.SingleSource;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.schedulers.Schedulers;
import java.util.concurrent.Callable;
import javax.inject.Inject;
import javax.inject.Named;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L47">public class MoreBottomSheetFragment extends BottomSheetDialogFragment {</span>

    @Inject
    CommonsLogSender commonsLogSender;

    private TextView moreProfile;

    @Inject
    @Named(&quot;default_preferences&quot;)
    JsonKvStore store;

    @Inject
    @Named(&quot;commons-page-edit&quot;)
    PageEditClient pageEditClient;

    @Nullable
    @Override
    public View onCreateView(@NonNull final LayoutInflater inflater, @Nullable final ViewGroup container, @Nullable final Bundle savedInstanceState) {
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5942)) {</span>
<span class="nc" id="L66">            super.onCreateView(inflater, container, savedInstanceState);</span>
        }
        @NonNull
<span class="nc" id="L69">        final FragmentMoreBottomSheetBinding binding = FragmentMoreBottomSheetBinding.inflate(inflater, container, false);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5943)) {</span>
<span class="nc" id="L71">            moreProfile = binding.moreProfile;</span>
        }
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5945)) {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            if (store.getBoolean(CommonsApplication.IS_LIMITED_CONNECTION_MODE_ENABLED)) {</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5944)) {</span>
<span class="nc" id="L76">                    binding.morePeerReview.setVisibility(View.GONE);</span>
                }
            }
        }
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5946)) {</span>
<span class="nc" id="L81">            binding.moreLogout.setOnClickListener(v -&gt; onLogoutClicked());</span>
        }
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5947)) {</span>
<span class="nc" id="L84">            binding.moreFeedback.setOnClickListener(v -&gt; onFeedbackClicked());</span>
        }
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5948)) {</span>
<span class="nc" id="L87">            binding.moreAbout.setOnClickListener(v -&gt; onAboutClicked());</span>
        }
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5949)) {</span>
<span class="nc" id="L90">            binding.moreTutorial.setOnClickListener(v -&gt; onTutorialClicked());</span>
        }
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5950)) {</span>
<span class="nc" id="L93">            binding.moreSettings.setOnClickListener(v -&gt; onSettingsClicked());</span>
        }
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5951)) {</span>
<span class="nc" id="L96">            binding.moreProfile.setOnClickListener(v -&gt; onProfileClicked());</span>
        }
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5952)) {</span>
<span class="nc" id="L99">            binding.morePeerReview.setOnClickListener(v -&gt; onPeerReviewClicked());</span>
        }
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5953)) {</span>
<span class="nc" id="L102">            setUserName();</span>
        }
<span class="nc" id="L104">        return binding.getRoot();</span>
    }

    @Override
    public void onAttach(@NonNull final Context context) {
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5954)) {</span>
<span class="nc" id="L110">            super.onAttach(context);</span>
        }
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5955)) {</span>
<span class="nc" id="L113">            ApplicationlessInjection.getInstance(requireActivity().getApplicationContext()).getCommonsApplicationComponent().inject(this);</span>
        }
<span class="nc" id="L115">    }</span>

    /**
     * Set the username and user achievements level (if available) in navigationHeader.
     */
    private void setUserName() {
<span class="nc" id="L121">        BasicKvStore store = new BasicKvStore(this.getContext(), getUserName());</span>
<span class="nc" id="L122">        String level = store.getString(&quot;userAchievementsLevel&quot;, &quot;0&quot;);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5958)) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (level.equals(&quot;0&quot;)) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5957)) {</span>
<span class="nc" id="L126">                    moreProfile.setText(getUserName() + &quot; (&quot; + getString(R.string.see_your_achievements) + &quot;)&quot;);</span>
                }
            } else {
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5956)) {</span>
<span class="nc" id="L130">                    moreProfile.setText(getUserName() + &quot; (&quot; + getString(R.string.level) + &quot; &quot; + level + &quot;)&quot;);</span>
                }
            }
        }
<span class="nc" id="L134">    }</span>

    private String getUserName() {
<span class="nc" id="L137">        final AccountManager accountManager = AccountManager.get(getActivity());</span>
<span class="nc" id="L138">        final Account[] allAccounts = accountManager.getAccountsByType(BuildConfig.ACCOUNT_TYPE);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5959)) {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (allAccounts.length != 0) {</span>
<span class="nc" id="L141">                return allAccounts[0].name;</span>
            }
        }
<span class="nc" id="L144">        return &quot;&quot;;</span>
    }

    protected void onLogoutClicked() {
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5960)) {</span>
<span class="nc" id="L149">            new AlertDialog.Builder(requireActivity()).setMessage(R.string.logout_verification).setCancelable(false).setPositiveButton(R.string.yes, (dialog, which) -&gt; {</span>
<span class="nc" id="L150">                final CommonsApplication app = (CommonsApplication) requireContext().getApplicationContext();</span>
<span class="nc" id="L151">                app.clearApplicationData(requireContext(), new BaseLogoutListener());</span>
<span class="nc" id="L152">            }).setNegativeButton(R.string.no, (dialog, which) -&gt; dialog.cancel()).show();</span>
        }
<span class="nc" id="L154">    }</span>

    protected void onFeedbackClicked() {
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5961)) {</span>
<span class="nc" id="L158">            showFeedbackDialog();</span>
        }
<span class="nc" id="L160">    }</span>

    /**
     * Creates and shows a dialog asking feedback from users
     */
    private void showFeedbackDialog() {
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5962)) {</span>
<span class="nc" id="L167">            new FeedbackDialog(getContext(), this::uploadFeedback).show();</span>
        }
<span class="nc" id="L169">    }</span>

    /**
     * uploads feedback data on the server
     */
    void uploadFeedback(final Feedback feedback) {
<span class="nc" id="L175">        final FeedbackContentCreator feedbackContentCreator = new FeedbackContentCreator(getContext(), feedback);</span>
<span class="nc" id="L176">        Single&lt;Boolean&gt; single = pageEditClient.prependEdit(&quot;Commons:Mobile_app/Feedback&quot;, feedbackContentCreator.toString(), &quot;Summary&quot;).flatMapSingle(result -&gt; Single.just(result)).firstOrError();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5963)) {</span>
<span class="nc" id="L178">            Single.defer((Callable&lt;SingleSource&lt;Boolean&gt;&gt;) () -&gt; single).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).subscribe(aBoolean -&gt; {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (aBoolean) {</span>
<span class="nc" id="L180">                    Toast.makeText(getContext(), getString(R.string.thanks_feedback), Toast.LENGTH_SHORT).show();</span>
                } else {
<span class="nc" id="L182">                    Toast.makeText(getContext(), getString(R.string.error_feedback), Toast.LENGTH_SHORT).show();</span>
                }
<span class="nc" id="L184">            });</span>
        }
<span class="nc" id="L186">    }</span>

    /**
     * This method shows the alert dialog when a user wants to send feedback about the app.
     */
    private void showAlertDialog() {
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5964)) {</span>
<span class="nc" id="L193">            new AlertDialog.Builder(requireActivity()).setMessage(R.string.feedback_sharing_data_alert).setCancelable(false).setPositiveButton(R.string.ok, (dialog, which) -&gt; sendFeedback()).show();</span>
        }
<span class="nc" id="L195">    }</span>

    /**
     * This method collects the feedback message and starts the activity with implicit intent
     * to available email client.
     */
    private void sendFeedback() {
<span class="nc" id="L202">        final String technicalInfo = commonsLogSender.getExtraInfo();</span>
<span class="nc" id="L203">        final Intent feedbackIntent = new Intent(Intent.ACTION_SENDTO);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5965)) {</span>
<span class="nc" id="L205">            feedbackIntent.setType(&quot;message/rfc822&quot;);</span>
        }
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5966)) {</span>
<span class="nc" id="L208">            feedbackIntent.setData(Uri.parse(&quot;mailto:&quot;));</span>
        }
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5967)) {</span>
<span class="nc" id="L211">            feedbackIntent.putExtra(Intent.EXTRA_EMAIL, new String[] { CommonsApplication.FEEDBACK_EMAIL });</span>
        }
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5968)) {</span>
<span class="nc" id="L214">            feedbackIntent.putExtra(Intent.EXTRA_SUBJECT, CommonsApplication.FEEDBACK_EMAIL_SUBJECT);</span>
        }
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5969)) {</span>
<span class="nc" id="L217">            feedbackIntent.putExtra(Intent.EXTRA_TEXT, String.format(&quot;\n\n%s\n%s&quot;, CommonsApplication.FEEDBACK_EMAIL_TEMPLATE_HEADER, technicalInfo));</span>
        }
        try {
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5971)) {</span>
<span class="nc" id="L221">                startActivity(feedbackIntent);</span>
            }
<span class="nc" id="L223">        } catch (final ActivityNotFoundException e) {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5970)) {</span>
<span class="nc" id="L225">                Toast.makeText(getActivity(), R.string.no_email_client, Toast.LENGTH_SHORT).show();</span>
            }
<span class="nc" id="L227">        }</span>
<span class="nc" id="L228">    }</span>

    protected void onAboutClicked() {
<span class="nc" id="L231">        final Intent intent = new Intent(getActivity(), AboutActivity.class);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5972)) {</span>
<span class="nc" id="L233">            intent.addFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
        }
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5973)) {</span>
<span class="nc" id="L236">            requireActivity().startActivity(intent);</span>
        }
<span class="nc" id="L238">    }</span>

    protected void onTutorialClicked() {
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5974)) {</span>
<span class="nc" id="L242">            WelcomeActivity.startYourself(getActivity());</span>
        }
<span class="nc" id="L244">    }</span>

    protected void onSettingsClicked() {
<span class="nc" id="L247">        final Intent intent = new Intent(getActivity(), SettingsActivity.class);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5975)) {</span>
<span class="nc" id="L249">            intent.addFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
        }
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5976)) {</span>
<span class="nc" id="L252">            requireActivity().startActivity(intent);</span>
        }
<span class="nc" id="L254">    }</span>

    protected void onProfileClicked() {
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5977)) {</span>
<span class="nc" id="L258">            ProfileActivity.startYourself(getActivity(), getUserName(), false);</span>
        }
<span class="nc" id="L260">    }</span>

    protected void onPeerReviewClicked() {
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5978)) {</span>
<span class="nc" id="L264">            ReviewActivity.startYourself(getActivity(), getString(R.string.title_activity_review));</span>
        }
<span class="nc" id="L266">    }</span>

<span class="nc" id="L268">    private class BaseLogoutListener implements CommonsApplication.LogoutListener {</span>

        @Override
        public void onLogoutComplete() {
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5979)) {</span>
<span class="nc" id="L273">                Timber.d(&quot;Logout complete callback received.&quot;);</span>
            }
<span class="nc" id="L275">            final Intent nearbyIntent = new Intent(getContext(), LoginActivity.class);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5980)) {</span>
<span class="nc" id="L277">                nearbyIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);</span>
            }
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5981)) {</span>
<span class="nc" id="L280">                nearbyIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
            }
<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5982)) {</span>
<span class="nc" id="L283">                startActivity(nearbyIntent);</span>
            }
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5983)) {</span>
<span class="nc" id="L286">                requireActivity().finish();</span>
            }
<span class="nc" id="L288">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>