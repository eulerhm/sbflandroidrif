<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermissionUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.utils</a> &gt; <span class="el_source">PermissionUtils.java</span></div><h1>PermissionUtils.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.utils;

import android.Manifest;
import android.app.Activity;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Build;
import android.provider.Settings;
import android.widget.Toast;
import androidx.annotation.StringRes;
import androidx.core.content.ContextCompat;
import com.karumi.dexter.Dexter;
import com.karumi.dexter.MultiplePermissionsReport;
import com.karumi.dexter.PermissionToken;
import com.karumi.dexter.listener.PermissionRequest;
import com.karumi.dexter.listener.multi.MultiplePermissionsListener;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.upload.UploadActivity;
import java.util.List;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L24">public class PermissionUtils {</span>

<span class="nc bnc" id="L26" title="All 6 branches missed.">    public static String[] PERMISSIONS_STORAGE = isSDKVersionScopedStorageCompatible() ? isSDKVersionTiramisu() ? new String[] { Manifest.permission.READ_MEDIA_IMAGES } : new String[] { Manifest.permission.READ_EXTERNAL_STORAGE } : isSDKVersionTiramisu() ? new String[] { Manifest.permission.WRITE_EXTERNAL_STORAGE, Manifest.permission.READ_MEDIA_IMAGES } : new String[] { Manifest.permission.WRITE_EXTERNAL_STORAGE, Manifest.permission.READ_EXTERNAL_STORAGE };</span>

    private static boolean isSDKVersionScopedStorageCompatible() {
<span class="nc bnc" id="L29" title="All 22 branches missed.">        return (ListenerUtil.mutListener.listen(2648) ? (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2647) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2646) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2645) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(2644) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.P) : (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.P))))));</span>
    }

    public static boolean isSDKVersionTiramisu() {
<span class="nc bnc" id="L33" title="All 22 branches missed.">        return (ListenerUtil.mutListener.listen(2653) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.TIRAMISU) : (ListenerUtil.mutListener.listen(2652) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.TIRAMISU) : (ListenerUtil.mutListener.listen(2651) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.TIRAMISU) : (ListenerUtil.mutListener.listen(2650) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.TIRAMISU) : (ListenerUtil.mutListener.listen(2649) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.TIRAMISU) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU))))));</span>
    }

    /**
     * This method can be used by any activity which requires a permission which has been
     * blocked(marked never ask again by the user) It open the app settings from where the user can
     * manually give us the required permission.
     *
     * @param activity
     */
    private static void askUserToManuallyEnablePermissionFromSettings(Activity activity) {
<span class="nc" id="L44">        Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span>
<span class="nc" id="L45">        Uri uri = Uri.fromParts(&quot;package&quot;, activity.getPackageName(), null);</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2654)) {</span>
<span class="nc" id="L47">            intent.setData(uri);</span>
        }
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2655)) {</span>
<span class="nc" id="L50">            activity.startActivityForResult(intent, CommonsApplication.OPEN_APPLICATION_DETAIL_SETTINGS);</span>
        }
<span class="nc" id="L52">    }</span>

    /**
     * Checks whether the app already has a particular permission
     *
     * @param activity
     * @param permissions permissions to be checked
     * @return
     */
    public static boolean hasPermission(Activity activity, String[] permissions) {
<span class="nc" id="L62">        boolean hasPermission = true;</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2658)) {</span>
            {
<span class="nc" id="L65">                long _loopCounter37 = 0;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                for (String permission : permissions) {</span>
<span class="nc" id="L67">                    ListenerUtil.loopListener.listen(&quot;_loopCounter37&quot;, ++_loopCounter37);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(2657)) {</span>
<span class="nc bnc" id="L69" title="All 10 branches missed.">                        hasPermission = (ListenerUtil.mutListener.listen(2656) ? (hasPermission || ContextCompat.checkSelfPermission(activity, permission) == PackageManager.PERMISSION_GRANTED) : (hasPermission &amp;&amp; ContextCompat.checkSelfPermission(activity, permission) == PackageManager.PERMISSION_GRANTED));</span>
                    }
                }
            }
        }
<span class="nc" id="L74">        return hasPermission;</span>
    }

    /**
     * Checks for a particular permission and runs the runnable to perform an action when the
     * permission is granted Also, it shows a rationale if needed
     * &lt;p&gt;
     * rationaleTitle and rationaleMessage can be invalid @StringRes. If the value is -1 then no
     * permission rationale will be displayed and permission would be requested
     * &lt;p&gt;
     * Sample usage:
     * &lt;p&gt;
     * PermissionUtils.checkPermissionsAndPerformAction(activity,
     * Manifest.permission.WRITE_EXTERNAL_STORAGE, () -&gt; initiateCameraUpload(activity),
     * R.string.storage_permission_title, R.string.write_storage_permission_rationale);
     * &lt;p&gt;
     * If you don't want the permission rationale to be shown then use:
     * &lt;p&gt;
     * PermissionUtils.checkPermissionsAndPerformAction(activity,
     * Manifest.permission.WRITE_EXTERNAL_STORAGE, () -&gt; initiateCameraUpload(activity), - 1, -1);
     *
     * @param activity            activity requesting permissions
     * @param permissions         the permissions array being requests
     * @param onPermissionGranted the runnable to be executed when the permission is granted
     * @param rationaleTitle      rationale title to be displayed when permission was denied. It can
     *                            be an invalid @StringRes
     * @param rationaleMessage    rationale message to be displayed when permission was denied. It
     *                            can be an invalid @StringRes
     */
    public static void checkPermissionsAndPerformAction(Activity activity, Runnable onPermissionGranted, @StringRes int rationaleTitle, @StringRes int rationaleMessage, String... permissions) {
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2659)) {</span>
<span class="nc" id="L105">            checkPermissionsAndPerformAction(activity, onPermissionGranted, null, rationaleTitle, rationaleMessage, permissions);</span>
        }
<span class="nc" id="L107">    }</span>

    /**
     * Checks for a particular permission and runs the corresponding runnables to perform an action
     * when the permission is granted/denied Also, it shows a rationale if needed
     * &lt;p&gt;
     * Sample usage:
     * &lt;p&gt;
     * PermissionUtils.checkPermissionsAndPerformAction(activity,
     * Manifest.permission.WRITE_EXTERNAL_STORAGE, () -&gt; initiateCameraUpload(activity), () -&gt;
     * showMessage(), R.string.storage_permission_title,
     * R.string.write_storage_permission_rationale);
     *
     * @param activity            activity requesting permissions
     * @param permissions         the permissions array being requested
     * @param onPermissionGranted the runnable to be executed when the permission is granted
     * @param onPermissionDenied  the runnable to be executed when the permission is denied(but not
     *                            permanently)
     * @param rationaleTitle      rationale title to be displayed when permission was denied
     * @param rationaleMessage    rationale message to be displayed when permission was denied
     */
    public static void checkPermissionsAndPerformAction(Activity activity, Runnable onPermissionGranted, Runnable onPermissionDenied, @StringRes int rationaleTitle, @StringRes int rationaleMessage, String... permissions) {
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2670)) {</span>
<span class="nc" id="L130">            Dexter.withActivity(activity).withPermissions(permissions).withListener(new MultiplePermissionsListener() {</span>

                @Override
                public void onPermissionsChecked(MultiplePermissionsReport report) {
<span class="nc bnc" id="L134" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(2661)) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                        if (report.areAllPermissionsGranted()) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2660)) {</span>
<span class="nc" id="L137">                                onPermissionGranted.run();</span>
                            }
<span class="nc" id="L139">                            return;</span>
                        }
                    }
<span class="nc bnc" id="L142" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(2665)) {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                        if (report.isAnyPermissionPermanentlyDenied()) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2664)) {</span>
                                // permission is denied permanently, we will show user a dialog message.
<span class="nc bnc" id="L146" title="All 2 branches missed.">                                DialogUtil.showAlertDialog(activity, activity.getString(rationaleTitle), activity.getString(rationaleMessage), activity.getString(R.string.navigation_item_settings), null, () -&gt; {</span>
<span class="nc" id="L147">                                    askUserToManuallyEnablePermissionFromSettings(activity);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                                    if (activity instanceof UploadActivity) {</span>
<span class="nc" id="L149">                                        ((UploadActivity) activity).setShowPermissionsDialog(true);</span>
                                    }
<span class="nc" id="L151">                                }, null, null, !(activity instanceof UploadActivity));</span>
                            }
                        } else {
<span class="nc bnc" id="L154" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2663)) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                                if (null != onPermissionDenied) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(2662)) {</span>
<span class="nc" id="L157">                                        onPermissionDenied.run();</span>
                                    }
                                }
                            }
                        }
                    }
<span class="nc" id="L163">                }</span>

                @Override
                public void onPermissionRationaleShouldBeShown(List&lt;PermissionRequest&gt; permissions, PermissionToken token) {
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(2668)) {</span>
<span class="nc bnc" id="L168" title="All 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(2666) ? (rationaleTitle == -1 || rationaleMessage == -1) : (rationaleTitle == -1 &amp;&amp; rationaleMessage == -1))) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2667)) {</span>
<span class="nc" id="L170">                                token.continuePermissionRequest();</span>
                            }
<span class="nc" id="L172">                            return;</span>
                        }
                    }
<span class="nc bnc" id="L175" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(2669)) {</span>
<span class="nc" id="L176">                        DialogUtil.showAlertDialog(activity, activity.getString(rationaleTitle), activity.getString(rationaleMessage), activity.getString(android.R.string.ok), activity.getString(android.R.string.cancel), () -&gt; {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                            if (activity instanceof UploadActivity) {</span>
<span class="nc" id="L178">                                ((UploadActivity) activity).setShowPermissionsDialog(true);</span>
                            }
<span class="nc" id="L180">                            token.continuePermissionRequest();</span>
<span class="nc" id="L181">                        }, () -&gt; {</span>
<span class="nc" id="L182">                            Toast.makeText(activity.getApplicationContext(), R.string.permissions_are_required_for_functionality, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L183">                            token.cancelPermissionRequest();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                            if (activity instanceof UploadActivity) {</span>
<span class="nc" id="L185">                                activity.finish();</span>
                            }
<span class="nc" id="L187">                        }, null, false);</span>
                    }
<span class="nc" id="L189">                }</span>
<span class="nc" id="L190">            }).onSameThread().check();</span>
        }
<span class="nc" id="L192">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>