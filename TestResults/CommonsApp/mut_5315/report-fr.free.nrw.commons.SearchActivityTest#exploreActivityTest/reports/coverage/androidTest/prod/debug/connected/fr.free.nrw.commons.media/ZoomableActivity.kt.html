<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ZoomableActivity.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.media</a> &gt; <span class="el_source">ZoomableActivity.kt</span></div><h1>ZoomableActivity.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.media

import android.app.Activity
import android.app.Dialog
import android.content.Intent
import android.content.SharedPreferences
import android.graphics.drawable.Animatable
import android.net.Uri
import android.os.Bundle
import android.view.View
import android.view.Window
import android.widget.Button
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.core.content.ContextCompat
import androidx.lifecycle.ViewModelProvider
import butterknife.BindView
import butterknife.ButterKnife
import com.facebook.drawee.backends.pipeline.Fresco
import com.facebook.drawee.controller.BaseControllerListener
import com.facebook.drawee.controller.ControllerListener
import com.facebook.drawee.drawable.ProgressBarDrawable
import com.facebook.drawee.drawable.ScalingUtils
import com.facebook.drawee.generic.GenericDraweeHierarchyBuilder
import com.facebook.drawee.interfaces.DraweeController
import com.facebook.imagepipeline.image.ImageInfo
import fr.free.nrw.commons.R
import fr.free.nrw.commons.customselector.database.NotForUploadStatus
import fr.free.nrw.commons.customselector.database.NotForUploadStatusDao
import fr.free.nrw.commons.customselector.database.UploadedStatusDao
import fr.free.nrw.commons.customselector.helper.CustomSelectorConstants
import fr.free.nrw.commons.customselector.helper.CustomSelectorConstants.SHOULD_REFRESH
import fr.free.nrw.commons.customselector.helper.ImageHelper
import fr.free.nrw.commons.customselector.helper.OnSwipeTouchListener
import fr.free.nrw.commons.customselector.model.CallbackStatus
import fr.free.nrw.commons.customselector.model.Image
import fr.free.nrw.commons.customselector.model.Result
import fr.free.nrw.commons.customselector.ui.selector.CustomSelectorViewModel
import fr.free.nrw.commons.customselector.ui.selector.CustomSelectorViewModelFactory
import fr.free.nrw.commons.media.zoomControllers.zoomable.DoubleTapGestureListener
import fr.free.nrw.commons.media.zoomControllers.zoomable.ZoomableDraweeView
import fr.free.nrw.commons.theme.BaseActivity
import fr.free.nrw.commons.upload.FileProcessor
import fr.free.nrw.commons.upload.FileUtilsWrapper
import fr.free.nrw.commons.utils.CustomSelectorUtils
import kotlinx.coroutines.*
import timber.log.Timber
import javax.inject.Inject
import kotlin.collections.ArrayList

/**
 * Activity for helping to view an image in full-screen mode with some other features
 * like zoom, and swap gestures
 */
<span class="nc" id="L56">class ZoomableActivity : BaseActivity() {</span>

    private lateinit var imageUri: Uri

    /**
     * View model.
     */
    private lateinit var viewModel: CustomSelectorViewModel

    /**
     * Pref for saving states.
     */
    private lateinit var prefs: SharedPreferences

    @JvmField
    @BindView(R.id.zoomable)
    var photo: ZoomableDraweeView? = null
    
<span class="nc" id="L74">    var photoBackgroundColor: Int? = null</span>

    @JvmField
    @BindView(R.id.zoom_progress_bar)
    var spinner: ProgressBar? = null

    @JvmField
    @BindView(R.id.selection_count)
    var selectedCount: TextView? = null

    /**
     * Total images present in folder
     */
    private var images: ArrayList&lt;Image&gt;? = null

    /**
     * Total selected images present in folder
     */
    private var selectedImages: ArrayList&lt;Image&gt;? = null

    /**
     * Present position of the image
     */
    private var position = 0

    /**
     * Present bucket ID
     */
    private var bucketId: Long = 0L

    /**
     * Determines whether the adapter should refresh
     */
    private var shouldRefresh = false

    /**
     * FileUtilsWrapper class to get imageSHA1 from uri
     */
    @Inject
<span class="nc bnc" id="L113" title="All 2 branches missed.">    lateinit var fileUtilsWrapper: FileUtilsWrapper</span>

    /**
     * FileProcessor to pre-process the file.
     */
    @Inject
<span class="nc bnc" id="L119" title="All 2 branches missed.">    lateinit var fileProcessor: FileProcessor</span>

    /**
     * NotForUploadStatus Dao class for database operations
     */
    @Inject
<span class="nc bnc" id="L125" title="All 2 branches missed.">    lateinit var notForUploadStatusDao: NotForUploadStatusDao</span>

    /**
     * UploadedStatus Dao class for database operations
     */
    @Inject
<span class="nc bnc" id="L131" title="All 2 branches missed.">    lateinit var uploadedStatusDao: UploadedStatusDao</span>

    /**
     * View Model Factory.
     */
    @Inject
<span class="nc bnc" id="L137" title="All 2 branches missed.">    lateinit var customSelectorViewModelFactory: CustomSelectorViewModelFactory</span>

    /**
    * Coroutine Dispatchers and Scope.
    */
<span class="nc" id="L142">    private var defaultDispatcher : CoroutineDispatcher = Dispatchers.Default</span>
<span class="nc" id="L143">    private var ioDispatcher : CoroutineDispatcher = Dispatchers.IO</span>
<span class="nc" id="L144">    private val scope : CoroutineScope = MainScope()</span>

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L147">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L148">        setContentView(R.layout.activity_zoomable)</span>
<span class="nc" id="L149">        ButterKnife.bind(this)</span>

<span class="nc" id="L151">        prefs =  applicationContext.getSharedPreferences(</span>
<span class="nc" id="L152">            ImageHelper.CUSTOM_SELECTOR_PREFERENCE_KEY,</span>
<span class="nc" id="L153">            MODE_PRIVATE</span>
        )

<span class="nc" id="L156">        selectedImages = intent.getParcelableArrayListExtra(</span>
<span class="nc" id="L157">            CustomSelectorConstants.TOTAL_SELECTED_IMAGES</span>
        )
<span class="nc" id="L159">        position = intent.getIntExtra(CustomSelectorConstants.PRESENT_POSITION, 0)</span>
<span class="nc" id="L160">        bucketId = intent.getLongExtra(CustomSelectorConstants.BUCKET_ID, 0L)</span>
<span class="nc" id="L161">        viewModel = ViewModelProvider(this, customSelectorViewModelFactory).get(</span>
            CustomSelectorViewModel::class.java
        )
<span class="nc bnc" id="L164" title="All 2 branches missed.">        viewModel.fetchImages()</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        viewModel.result.observe(this) {</span>
<span class="nc" id="L166">            handleResult(it)</span>
<span class="nc" id="L167">        }</span>

<span class="nc" id="L169">        val origin = intent.getStringExtra(ZoomableActivityConstants.ORIGIN);</span>

        /**
         * If origin is &quot;null&quot; it means that ZoomableActivity was created by the custom picker
         * (rather than by MediaDetailsFragment) so we need to show the first time popup in
         * full screen mode if needed.
         */
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (origin == null) {</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">            if (prefs.getBoolean(CustomSelectorConstants.FULL_SCREEN_MODE_FIRST_LUNCH, true)) {</span>
                // show welcome dialog on first launch
<span class="nc" id="L179">                showWelcomeDialog()</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                prefs.edit().putBoolean(</span>
<span class="nc" id="L181">                    CustomSelectorConstants.FULL_SCREEN_MODE_FIRST_LUNCH,</span>
<span class="nc" id="L182">                    false</span>
<span class="nc" id="L183">                ).apply()</span>
            }
        }
        
<span class="nc" id="L187">        val backgroundColor = intent.getIntExtra(ZoomableActivityConstants.PHOTO_BACKGROUND_COLOR,</span>
<span class="nc" id="L188">                MediaDetailFragment.DEFAULT_IMAGE_BACKGROUND_COLOR);</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (backgroundColor != MediaDetailFragment.DEFAULT_IMAGE_BACKGROUND_COLOR) {</span>
<span class="nc" id="L191">            photoBackgroundColor = backgroundColor</span>
        }
<span class="nc" id="L193">    }</span>

    /**
     * Show Full Screen Mode Welcome Dialog.
     */
    private fun showWelcomeDialog() {
<span class="nc" id="L199">        val dialog = Dialog(this)</span>
<span class="nc" id="L200">        dialog.requestWindowFeature(Window.FEATURE_NO_TITLE)</span>
<span class="nc" id="L201">        dialog.setContentView(R.layout.full_screen_mode_info_dialog)</span>
<span class="nc" id="L202">        (dialog.findViewById(R.id.btn_ok) as Button).setOnClickListener { dialog.dismiss() }</span>
<span class="nc" id="L203">        dialog.show()</span>
<span class="nc" id="L204">    }</span>

    /**
     * Handle view model result.
     */
    private fun handleResult(result: Result) {
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if(result.status is CallbackStatus.SUCCESS){</span>
<span class="nc" id="L211">            val images = result.images</span>
<span class="nc bnc" id="L212" title="All 4 branches missed.">            if(images.isNotEmpty()) {</span>
<span class="nc" id="L213">                this@ZoomableActivity.images = ImageHelper.filterImages(images, bucketId)</span>
<span class="nc bnc" id="L214" title="All 6 branches missed.">                imageUri = if (this@ZoomableActivity.images.isNullOrEmpty()) {</span>
<span class="nc" id="L215">                    intent.data as Uri</span>
                } else {
<span class="nc" id="L217">                    this@ZoomableActivity.images!![position].uri</span>
                }
<span class="nc bnc" id="L219" title="All 2 branches missed.">                Timber.d(&quot;URL = $imageUri&quot;)</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                init(imageUri)</span>
<span class="nc" id="L221">                onSwipe()</span>
            }
        }
<span class="nc bnc" id="L224" title="All 2 branches missed.">        spinner?.let {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            it.visibility = if (result.status is CallbackStatus.FETCHING) View.VISIBLE else View.GONE</span>
<span class="nc" id="L226">        }</span>
<span class="nc" id="L227">    }</span>

    /**
     * Handle swap gestures. Ex. onSwipeLeft, onSwipeRight, onSwipeUp, onSwipeDown
     */
    private fun onSwipe() {
<span class="nc" id="L233">        val sharedPreferences: SharedPreferences =</span>
<span class="nc" id="L234">            getSharedPreferences(ImageHelper.CUSTOM_SELECTOR_PREFERENCE_KEY, 0)</span>
<span class="nc" id="L235">        val showAlreadyActionedImages =</span>
<span class="nc" id="L236">            sharedPreferences.getBoolean(ImageHelper.SHOW_ALREADY_ACTIONED_IMAGES_PREFERENCE_KEY, true)</span>

<span class="nc bnc" id="L238" title="All 6 branches missed.">        if (!images.isNullOrEmpty()) {</span>
<span class="nc" id="L239">            photo!!.setOnTouchListener(object : OnSwipeTouchListener(this) {</span>
                // Swipe left to view next image in the folder. (if available)
                override fun onSwipeLeft() {
<span class="nc" id="L242">                    super.onSwipeLeft()</span>
<span class="nc" id="L243">                    onLeftSwiped(showAlreadyActionedImages)</span>
<span class="nc" id="L244">                }</span>

                // Swipe right to view previous image in the folder. (if available)
                override fun onSwipeRight() {
<span class="nc" id="L248">                    super.onSwipeRight()</span>
<span class="nc" id="L249">                    onRightSwiped(showAlreadyActionedImages)</span>
<span class="nc" id="L250">                }</span>

                // Swipe up to select the picture (the equivalent of tapping it in non-fullscreen mode)
                // and show the next picture skipping pictures that have either already been uploaded or
                // marked as not for upload
                override fun onSwipeUp() {
<span class="nc" id="L256">                    super.onSwipeUp()</span>
<span class="nc" id="L257">                    onUpSwiped()</span>
<span class="nc" id="L258">                }</span>

                // Swipe down to mark that picture as &quot;Not for upload&quot; (the equivalent of selecting it then
                // tapping &quot;Mark as not for upload&quot; in non-fullscreen mode), and show the next picture.
                override fun onSwipeDown() {
<span class="nc" id="L263">                    super.onSwipeDown()</span>
<span class="nc" id="L264">                    onDownSwiped()</span>
<span class="nc" id="L265">                }</span>
            })
        }
<span class="nc" id="L268">    }</span>

    /**
     * Handles down swipe action
     */
    private fun onDownSwiped() {
<span class="nc bnc" id="L274" title="All 8 branches missed.">        if (photo?.zoomableController?.isIdentity == false)</span>
<span class="nc" id="L275">            return</span>

<span class="nc" id="L277">        scope.launch {</span>
<span class="nc" id="L278">            val imageSHA1 = CustomSelectorUtils.getImageSHA1(</span>
<span class="nc" id="L279">                images!![position].uri,</span>
<span class="nc" id="L280">                ioDispatcher,</span>
<span class="nc" id="L281">                fileUtilsWrapper,</span>
<span class="nc" id="L282">                contentResolver</span>
            )
<span class="nc" id="L284">            var isUploaded = uploadedStatusDao.findByImageSHA1(imageSHA1, true)</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (isUploaded &gt; 0) {</span>
<span class="nc" id="L286">                Toast.makeText(</span>
<span class="nc" id="L287">                    this@ZoomableActivity,</span>
<span class="nc" id="L288">                    getString(R.string.this_image_is_already_uploaded),</span>
<span class="nc" id="L289">                    Toast.LENGTH_SHORT</span>
<span class="nc" id="L290">                ).show()</span>
            } else {
<span class="nc" id="L292">                val imageModifiedSHA1 = CustomSelectorUtils.generateModifiedSHA1(</span>
<span class="nc" id="L293">                    images!![position],</span>
<span class="nc" id="L294">                    defaultDispatcher,</span>
<span class="nc" id="L295">                    this@ZoomableActivity,</span>
<span class="nc" id="L296">                    fileProcessor,</span>
<span class="nc" id="L297">                    fileUtilsWrapper</span>
                )
<span class="nc" id="L299">                isUploaded = uploadedStatusDao.findByModifiedImageSHA1(</span>
<span class="nc" id="L300">                    imageModifiedSHA1,</span>
<span class="nc" id="L301">                    true</span>
                )
<span class="nc bnc" id="L303" title="All 2 branches missed.">                if (isUploaded &gt; 0) {</span>
<span class="nc" id="L304">                    Toast.makeText(</span>
<span class="nc" id="L305">                        this@ZoomableActivity,</span>
<span class="nc" id="L306">                        getString(R.string.this_image_is_already_uploaded),</span>
<span class="nc" id="L307">                        Toast.LENGTH_SHORT</span>
<span class="nc" id="L308">                    ).show()</span>
                } else {
<span class="nc" id="L310">                    insertInNotForUpload(images!![position])</span>
<span class="nc" id="L311">                    Toast.makeText(</span>
<span class="nc" id="L312">                        this@ZoomableActivity,</span>
<span class="nc" id="L313">                        getString(R.string.image_marked_as_not_for_upload),</span>
<span class="nc" id="L314">                        Toast.LENGTH_SHORT</span>
<span class="nc" id="L315">                    ).show()</span>
<span class="nc" id="L316">                    shouldRefresh = true</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                    if (position &lt; images!!.size - 1) {</span>
<span class="nc" id="L318">                        position++</span>
<span class="nc" id="L319">                        init(images!![position].uri)</span>
                    } else {
<span class="nc" id="L321">                        Toast.makeText(</span>
<span class="nc" id="L322">                            this@ZoomableActivity,</span>
<span class="nc" id="L323">                            getString(R.string.no_more_images_found),</span>
<span class="nc" id="L324">                            Toast.LENGTH_SHORT</span>
<span class="nc" id="L325">                        ).show()</span>
                    }
                }
            }
<span class="nc" id="L329">        }</span>
<span class="nc" id="L330">    }</span>

    /**
     * Handles up swipe action
     */
    private fun onUpSwiped() {
<span class="nc bnc" id="L336" title="All 8 branches missed.">        if (photo?.zoomableController?.isIdentity == false)</span>
<span class="nc" id="L337">            return</span>

<span class="nc" id="L339">        scope.launch {</span>
<span class="nc" id="L340">            val imageSHA1 = CustomSelectorUtils.getImageSHA1(</span>
<span class="nc" id="L341">                images!![position].uri,</span>
<span class="nc" id="L342">                ioDispatcher,</span>
<span class="nc" id="L343">                fileUtilsWrapper,</span>
<span class="nc" id="L344">                contentResolver</span>
            )
<span class="nc" id="L346">            var isNonActionable = notForUploadStatusDao.find(imageSHA1)</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (isNonActionable &gt; 0) {</span>
<span class="nc" id="L348">                Toast.makeText(</span>
<span class="nc" id="L349">                    this@ZoomableActivity,</span>
<span class="nc" id="L350">                    getString(R.string.can_not_select_this_image_for_upload),</span>
<span class="nc" id="L351">                    Toast.LENGTH_SHORT</span>
<span class="nc" id="L352">                ).show()</span>
            } else {
<span class="nc" id="L354">                isNonActionable =</span>
<span class="nc" id="L355">                    uploadedStatusDao.findByImageSHA1(imageSHA1, true)</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                if (isNonActionable &gt; 0) {</span>
<span class="nc" id="L357">                    Toast.makeText(</span>
<span class="nc" id="L358">                        this@ZoomableActivity,</span>
<span class="nc" id="L359">                        getString(R.string.this_image_is_already_uploaded),</span>
<span class="nc" id="L360">                        Toast.LENGTH_SHORT</span>
<span class="nc" id="L361">                    ).show()</span>
                } else {
<span class="nc" id="L363">                    val imageModifiedSHA1 = CustomSelectorUtils.generateModifiedSHA1(</span>
<span class="nc" id="L364">                        images!![position],</span>
<span class="nc" id="L365">                        defaultDispatcher,</span>
<span class="nc" id="L366">                        this@ZoomableActivity,</span>
<span class="nc" id="L367">                        fileProcessor,</span>
<span class="nc" id="L368">                        fileUtilsWrapper</span>
                    )
<span class="nc" id="L370">                    isNonActionable = uploadedStatusDao.findByModifiedImageSHA1(</span>
<span class="nc" id="L371">                        imageModifiedSHA1,</span>
<span class="nc" id="L372">                        true</span>
                    )
<span class="nc bnc" id="L374" title="All 2 branches missed.">                    if (isNonActionable &gt; 0) {</span>
<span class="nc" id="L375">                        Toast.makeText(</span>
<span class="nc" id="L376">                            this@ZoomableActivity,</span>
<span class="nc" id="L377">                            getString(R.string.this_image_is_already_uploaded),</span>
<span class="nc" id="L378">                            Toast.LENGTH_SHORT</span>
<span class="nc" id="L379">                        ).show()</span>
                    } else {
<span class="nc bnc" id="L381" title="All 2 branches missed.">                        if (!selectedImages!!.contains(images!![position])) {</span>
<span class="nc" id="L382">                            selectedImages!!.add(images!![position])</span>
<span class="nc" id="L383">                            Toast.makeText(</span>
<span class="nc" id="L384">                                this@ZoomableActivity,</span>
<span class="nc" id="L385">                                getString(R.string.image_selected),</span>
<span class="nc" id="L386">                                Toast.LENGTH_SHORT</span>
<span class="nc" id="L387">                            ).show()</span>
                        }
<span class="nc" id="L389">                        position = getNextActionableImage(position + 1)</span>
<span class="nc" id="L390">                        init(images!![position].uri)</span>
                    }
                }
            }
<span class="nc" id="L394">        }</span>
<span class="nc" id="L395">    }</span>

    /**
     * Handles right swipe action
     */
    private fun onRightSwiped(showAlreadyActionedImages: Boolean) {
<span class="nc bnc" id="L401" title="All 8 branches missed.">        if (photo?.zoomableController?.isIdentity == false)</span>
<span class="nc" id="L402">            return</span>

<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (showAlreadyActionedImages) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">            if (position &gt; 0) {</span>
<span class="nc" id="L406">                position--</span>
<span class="nc" id="L407">                init(images!![position].uri)</span>
            } else {
<span class="nc" id="L409">                Toast.makeText(</span>
<span class="nc" id="L410">                    this@ZoomableActivity,</span>
<span class="nc" id="L411">                    getString(R.string.no_more_images_found),</span>
<span class="nc" id="L412">                    Toast.LENGTH_SHORT</span>
<span class="nc" id="L413">                ).show()</span>
            }
        } else {
<span class="nc bnc" id="L416" title="All 2 branches missed.">            if (position &gt; 0) {</span>
<span class="nc" id="L417">                scope.launch {</span>
<span class="nc" id="L418">                    position = getPreviousActionableImage(position - 1)</span>
<span class="nc" id="L419">                    init(images!![position].uri)</span>
<span class="nc" id="L420">                }</span>
            } else {
<span class="nc" id="L422">                Toast.makeText(</span>
<span class="nc" id="L423">                    this@ZoomableActivity,</span>
<span class="nc" id="L424">                    getString(R.string.no_more_images_found),</span>
<span class="nc" id="L425">                    Toast.LENGTH_SHORT</span>
<span class="nc" id="L426">                ).show()</span>
            }
        }
<span class="nc" id="L429">    }</span>

    /**
     * Handles left swipe action
     */
    private fun onLeftSwiped(showAlreadyActionedImages: Boolean) {
<span class="nc bnc" id="L435" title="All 8 branches missed.">        if (photo?.zoomableController?.isIdentity == false)</span>
<span class="nc" id="L436">            return</span>

<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (showAlreadyActionedImages) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">            if (position &lt; images!!.size - 1) {</span>
<span class="nc" id="L440">                position++</span>
<span class="nc" id="L441">                init(images!![position].uri)</span>
            } else {
<span class="nc" id="L443">                Toast.makeText(</span>
<span class="nc" id="L444">                    this@ZoomableActivity,</span>
<span class="nc" id="L445">                    getString(R.string.no_more_images_found),</span>
<span class="nc" id="L446">                    Toast.LENGTH_SHORT</span>
<span class="nc" id="L447">                ).show()</span>
            }
        } else {
<span class="nc bnc" id="L450" title="All 2 branches missed.">            if (position &lt; images!!.size - 1) {</span>
<span class="nc" id="L451">                scope.launch {</span>
<span class="nc" id="L452">                    position = getNextActionableImage(position + 1)</span>
<span class="nc" id="L453">                    init(images!![position].uri)</span>
<span class="nc" id="L454">                }</span>
            } else {
<span class="nc" id="L456">                Toast.makeText(</span>
<span class="nc" id="L457">                    this@ZoomableActivity,</span>
<span class="nc" id="L458">                    getString(R.string.no_more_images_found),</span>
<span class="nc" id="L459">                    Toast.LENGTH_SHORT</span>
<span class="nc" id="L460">                ).show()</span>
            }
        }
<span class="nc" id="L463">    }</span>

    /**
     * Gets next actionable image.
     * Iterates from an index to the end of the folder and check whether the current image is
     * present in already uploaded table or in not for upload table,
     * and returns the first actionable image it can find.
     */
<span class="nc" id="L471">    private suspend fun getNextActionableImage(index: Int): Int {</span>
<span class="nc" id="L472">        var nextPosition = position</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">        for(i in index until images!!.size){</span>
<span class="nc" id="L474">            nextPosition = i</span>
<span class="nc" id="L475">            val imageSHA1 = CustomSelectorUtils.getImageSHA1(</span>
<span class="nc" id="L476">                images!![i].uri,</span>
<span class="nc" id="L477">                ioDispatcher,</span>
<span class="nc" id="L478">                fileUtilsWrapper,</span>
<span class="nc" id="L479">                contentResolver</span>
            )
<span class="nc" id="L481">            var isNonActionable = notForUploadStatusDao.find(imageSHA1)</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">            if (isNonActionable &lt;= 0) {</span>
<span class="nc" id="L483">                isNonActionable = uploadedStatusDao.findByImageSHA1(imageSHA1, true)</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">                if (isNonActionable &lt;= 0) {</span>
<span class="nc" id="L485">                    val imageModifiedSHA1 = CustomSelectorUtils.generateModifiedSHA1(</span>
<span class="nc" id="L486">                        images!![i],</span>
<span class="nc" id="L487">                        defaultDispatcher,</span>
<span class="nc" id="L488">                        this@ZoomableActivity,</span>
<span class="nc" id="L489">                        fileProcessor,</span>
<span class="nc" id="L490">                        fileUtilsWrapper</span>
                    )
<span class="nc" id="L492">                    isNonActionable = uploadedStatusDao.findByModifiedImageSHA1(</span>
<span class="nc" id="L493">                        imageModifiedSHA1,</span>
<span class="nc" id="L494">                        true</span>
                    )
<span class="nc bnc" id="L496" title="All 2 branches missed.">                    if (isNonActionable &lt;= 0) {</span>
<span class="nc" id="L497">                        return i</span>
                    } else {
<span class="nc" id="L499">                        continue</span>
                    }
                } else {
<span class="nc" id="L502">                    continue</span>
                }
            } else {
<span class="nc" id="L505">                continue</span>
            }
        }
<span class="nc" id="L508">        return nextPosition</span>
    }

    /**
     * Gets previous actionable image.
     * Iterates from an index to the first image of the folder and check whether the current image
     * is present in already uploaded table or in not for upload table,
     * and returns the first actionable image it can find
     */
<span class="nc" id="L517">    private suspend fun getPreviousActionableImage(index: Int): Int {</span>
<span class="nc" id="L518">        var previousPosition = position</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">        for(i in index downTo 0){</span>
<span class="nc" id="L520">            previousPosition = i</span>
<span class="nc" id="L521">            val imageSHA1 = CustomSelectorUtils.getImageSHA1(</span>
<span class="nc" id="L522">                images!![i].uri,</span>
<span class="nc" id="L523">                ioDispatcher,</span>
<span class="nc" id="L524">                fileUtilsWrapper,</span>
<span class="nc" id="L525">                contentResolver</span>
            )
<span class="nc" id="L527">            var isNonActionable = notForUploadStatusDao.find(imageSHA1)</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">            if (isNonActionable &lt;= 0) {</span>
<span class="nc" id="L529">                isNonActionable = uploadedStatusDao.findByImageSHA1(imageSHA1, true)</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">                if (isNonActionable &lt;= 0) {</span>
<span class="nc" id="L531">                    val imageModifiedSHA1 = CustomSelectorUtils.generateModifiedSHA1(</span>
<span class="nc" id="L532">                        images!![i],</span>
<span class="nc" id="L533">                        defaultDispatcher,</span>
<span class="nc" id="L534">                        this@ZoomableActivity,</span>
<span class="nc" id="L535">                        fileProcessor,</span>
<span class="nc" id="L536">                        fileUtilsWrapper</span>
                    )
<span class="nc" id="L538">                    isNonActionable = uploadedStatusDao.findByModifiedImageSHA1(</span>
<span class="nc" id="L539">                        imageModifiedSHA1,</span>
<span class="nc" id="L540">                        true</span>
                    )
<span class="nc bnc" id="L542" title="All 2 branches missed.">                    if (isNonActionable &lt;= 0) {</span>
<span class="nc" id="L543">                        return i</span>
                    } else {
<span class="nc" id="L545">                        continue</span>
                    }
                } else {
<span class="nc" id="L548">                    continue</span>
                }
            } else {
<span class="nc" id="L551">                continue</span>
            }
        }
<span class="nc" id="L554">        return previousPosition</span>
    }

    /**
     * Unselect item UI
     */
    private fun itemUnselected() {
<span class="nc" id="L561">        selectedCount!!.visibility = View.INVISIBLE</span>
<span class="nc" id="L562">    }</span>

    /**
     * Select item UI
     */
    private fun itemSelected(i: Int) {
<span class="nc" id="L568">        selectedCount!!.visibility = View.VISIBLE</span>
<span class="nc" id="L569">        selectedCount!!.text = i.toString()</span>
<span class="nc" id="L570">    }</span>

    /**
     * Get position of an image from list
     */
    private fun getImagePosition(list: ArrayList&lt;Image&gt;?, image: Image): Int {
<span class="nc" id="L576">        return list!!.indexOf(image)</span>
    }

    /**
     * Two types of loading indicators have been added to the zoom activity:
     * 1.  An Indeterminate spinner for showing the time lapsed between dispatch of the image request
     * and starting to receiving the image.
     * 2.  ProgressBarDrawable that reflects how much image has been downloaded
     */
    private val loadingListener: ControllerListener&lt;ImageInfo?&gt; =
<span class="nc" id="L586">        object : BaseControllerListener&lt;ImageInfo?&gt;() {</span>
            override fun onSubmit(id: String, callerContext: Any) {
                // Sometimes the spinner doesn't appear when rapidly switching between images, this fixes that
<span class="nc" id="L589">                spinner!!.visibility = View.VISIBLE</span>
<span class="nc" id="L590">            }</span>

            override fun onIntermediateImageSet(id: String, imageInfo: ImageInfo?) {
<span class="nc" id="L593">                spinner!!.visibility = View.GONE</span>
<span class="nc" id="L594">            }</span>

            override fun onFinalImageSet(
                id: String,
                imageInfo: ImageInfo?,
                animatable: Animatable?
            ) {
<span class="nc" id="L601">                spinner!!.visibility = View.GONE</span>
<span class="nc" id="L602">            }</span>
        }

    private fun init(imageUri: Uri?) {
<span class="nc bnc" id="L606" title="All 2 branches missed.">        if (imageUri != null) {</span>
<span class="nc" id="L607">            val hierarchy = GenericDraweeHierarchyBuilder.newInstance(resources)</span>
<span class="nc" id="L608">                .setActualImageScaleType(ScalingUtils.ScaleType.FIT_CENTER)</span>
<span class="nc" id="L609">                .setProgressBarImage(ProgressBarDrawable())</span>
<span class="nc" id="L610">                .setProgressBarImageScaleType(ScalingUtils.ScaleType.FIT_CENTER)</span>
<span class="nc" id="L611">                .build()</span>
<span class="nc" id="L612">            photo!!.hierarchy = hierarchy</span>
<span class="nc" id="L613">            photo!!.setAllowTouchInterceptionWhileZoomed(true)</span>
<span class="nc" id="L614">            photo!!.setIsLongpressEnabled(false)</span>
<span class="nc" id="L615">            photo!!.setTapListener(DoubleTapGestureListener(photo))</span>
<span class="nc" id="L616">            val controller: DraweeController = Fresco.newDraweeControllerBuilder()</span>
<span class="nc" id="L617">                .setUri(imageUri)</span>
<span class="nc" id="L618">                .setControllerListener(loadingListener)</span>
<span class="nc" id="L619">                .build()</span>
<span class="nc" id="L620">            photo!!.controller = controller</span>
            
<span class="nc bnc" id="L622" title="All 2 branches missed.">            if (photoBackgroundColor != null) {</span>
<span class="nc" id="L623">                photo!!.setBackgroundColor(photoBackgroundColor!!)</span>
            }

<span class="nc bnc" id="L626" title="All 6 branches missed.">            if (!images.isNullOrEmpty()) {</span>
<span class="nc" id="L627">                val selectedIndex = getImagePosition(selectedImages, images!![position])</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">                val isSelected = selectedIndex != -1</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">                if (isSelected) {</span>
<span class="nc" id="L630">                    itemSelected(selectedImages!!.size)</span>
                } else {
<span class="nc" id="L632">                    itemUnselected()</span>
                }
            }
        }
<span class="nc" id="L636">    }</span>

    /**
     * Inserts an image in Not For Upload table
     */
<span class="nc" id="L641">    private suspend fun insertInNotForUpload(it: Image) {</span>
<span class="nc" id="L642">        val imageSHA1 = CustomSelectorUtils.getImageSHA1(</span>
<span class="nc" id="L643">            it.uri,</span>
<span class="nc" id="L644">            ioDispatcher,</span>
<span class="nc" id="L645">            fileUtilsWrapper,</span>
<span class="nc" id="L646">            contentResolver</span>
        )
<span class="nc" id="L648">        notForUploadStatusDao.insert(</span>
<span class="nc" id="L649">            NotForUploadStatus(</span>
<span class="nc" id="L650">                imageSHA1</span>
            )
        )
<span class="nc" id="L653">    }</span>

    /**
     * Send selected images in fragment
     */
    override fun onBackPressed() {
<span class="nc bnc" id="L659" title="All 6 branches missed.">        if (!images.isNullOrEmpty()) {</span>
<span class="nc" id="L660">            val returnIntent = Intent()</span>
<span class="nc" id="L661">            returnIntent.putParcelableArrayListExtra(</span>
<span class="nc" id="L662">                CustomSelectorConstants.NEW_SELECTED_IMAGES,</span>
<span class="nc" id="L663">                selectedImages</span>
            )
<span class="nc" id="L665">            returnIntent.putExtra(SHOULD_REFRESH, shouldRefresh)</span>
<span class="nc" id="L666">            setResult(Activity.RESULT_OK, returnIntent)</span>
<span class="nc" id="L667">            finish()</span>
        }
<span class="nc" id="L669">        super.onBackPressed()</span>
<span class="nc" id="L670">    }</span>

    override fun onDestroy() {
<span class="nc" id="L673">        scope.cancel()</span>
<span class="nc" id="L674">        super.onDestroy()</span>
<span class="nc" id="L675">    }</span>

    object ZoomableActivityConstants  {
        /**
         * Key for Accessing Intent Data Named &quot;Origin&quot;, The value indicates what fragment
         * ZoomableActivity was created by. It is null if ZoomableActivity was created by
         * the custom picker.
         */
        const val ORIGIN = &quot;Origin&quot;;
        
        const val PHOTO_BACKGROUND_COLOR = &quot;photo_background_color&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>