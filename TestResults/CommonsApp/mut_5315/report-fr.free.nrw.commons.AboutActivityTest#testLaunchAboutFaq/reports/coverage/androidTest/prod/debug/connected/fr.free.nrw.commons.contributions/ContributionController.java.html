<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContributionController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.contributions</a> &gt; <span class="el_source">ContributionController.java</span></div><h1>ContributionController.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.contributions;

import static fr.free.nrw.commons.wikidata.WikidataConstants.PLACE_OBJECT;
import android.Manifest;
import android.Manifest.permission;
import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.widget.Toast;
import androidx.activity.result.ActivityResultLauncher;
import androidx.annotation.NonNull;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.filepicker.DefaultCallback;
import fr.free.nrw.commons.filepicker.FilePicker;
import fr.free.nrw.commons.filepicker.FilePicker.ImageSource;
import fr.free.nrw.commons.filepicker.UploadableFile;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LatLng;
import fr.free.nrw.commons.location.LocationPermissionsHelper;
import fr.free.nrw.commons.location.LocationPermissionsHelper.Dialog;
import fr.free.nrw.commons.location.LocationPermissionsHelper.LocationPermissionCallback;
import fr.free.nrw.commons.location.LocationServiceManager;
import fr.free.nrw.commons.nearby.Place;
import fr.free.nrw.commons.upload.UploadActivity;
import fr.free.nrw.commons.utils.DialogUtil;
import fr.free.nrw.commons.utils.PermissionUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import java.util.ArrayList;
import java.util.List;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

@Singleton
public class ContributionController {

    public static final String ACTION_INTERNAL_UPLOADS = &quot;internalImageUploads&quot;;

    private final JsonKvStore defaultKvStore;

    private LatLng locationBeforeImageCapture;

    private boolean isInAppCameraUpload;

    public LocationPermissionCallback locationPermissionCallback;

    private LocationPermissionsHelper locationPermissionsHelper;

    @Inject
    LocationServiceManager locationManager;

    @Inject
<span class="nc" id="L54">    public ContributionController(@Named(&quot;default_preferences&quot;) JsonKvStore defaultKvStore) {</span>
<span class="nc" id="L55">        this.defaultKvStore = defaultKvStore;</span>
<span class="nc" id="L56">    }</span>

    /**
     * Check for permissions and initiate camera click
     */
    public void initiateCameraPick(Activity activity, ActivityResultLauncher&lt;String[]&gt; inAppCameraLocationPermissionLauncher) {
<span class="nc" id="L62">        boolean useExtStorage = defaultKvStore.getBoolean(&quot;useExternalStorage&quot;, true);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(583)) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if (!useExtStorage) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(582)) {</span>
<span class="nc" id="L66">                    initiateCameraUpload(activity);</span>
                }
<span class="nc" id="L68">                return;</span>
            }
        }
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(584)) {</span>
<span class="nc" id="L72">            PermissionUtils.checkPermissionsAndPerformAction(activity, () -&gt; {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">                if (defaultKvStore.getBoolean(&quot;inAppCameraFirstRun&quot;)) {</span>
<span class="nc" id="L74">                    defaultKvStore.putBoolean(&quot;inAppCameraFirstRun&quot;, false);</span>
<span class="nc" id="L75">                    askUserToAllowLocationAccess(activity, inAppCameraLocationPermissionLauncher);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                } else if (defaultKvStore.getBoolean(&quot;inAppCameraLocationPref&quot;)) {</span>
<span class="nc" id="L77">                    createDialogsAndHandleLocationPermissions(activity, inAppCameraLocationPermissionLauncher);</span>
                } else {
<span class="nc" id="L79">                    initiateCameraUpload(activity);</span>
                }
<span class="nc" id="L81">            }, R.string.storage_permission_title, R.string.write_storage_permission_rationale, PermissionUtils.PERMISSIONS_STORAGE);</span>
        }
<span class="nc" id="L83">    }</span>

    /**
     * Asks users to provide location access
     *
     * @param activity
     */
    private void createDialogsAndHandleLocationPermissions(Activity activity, ActivityResultLauncher&lt;String[]&gt; inAppCameraLocationPermissionLauncher) {
<span class="nc" id="L91">        LocationPermissionsHelper.Dialog locationAccessDialog = new Dialog(R.string.location_permission_title, R.string.in_app_camera_location_permission_rationale);</span>
<span class="nc" id="L92">        LocationPermissionsHelper.Dialog locationOffDialog = new Dialog(R.string.ask_to_turn_location_on, R.string.in_app_camera_needs_location);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(588)) {</span>
<span class="nc" id="L94">            locationPermissionCallback = new LocationPermissionCallback() {</span>

                @Override
                public void onLocationPermissionDenied(String toastMessage) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(585)) {</span>
<span class="nc" id="L99">                        Toast.makeText(activity, toastMessage, Toast.LENGTH_LONG).show();</span>
                    }
<span class="nc bnc" id="L101" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(586)) {</span>
<span class="nc" id="L102">                        initiateCameraUpload(activity);</span>
                    }
<span class="nc" id="L104">                }</span>

                @Override
                public void onLocationPermissionGranted() {
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(587)) {</span>
<span class="nc" id="L109">                        initiateCameraUpload(activity);</span>
                    }
<span class="nc" id="L111">                }</span>
            };
        }
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(589)) {</span>
<span class="nc" id="L115">            locationPermissionsHelper = new LocationPermissionsHelper(activity, locationManager, locationPermissionCallback);</span>
        }
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(592)) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (inAppCameraLocationPermissionLauncher != null) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(591)) {</span>
<span class="nc" id="L120">                    inAppCameraLocationPermissionLauncher.launch(new String[] { permission.ACCESS_FINE_LOCATION });</span>
                }
            } else {
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(590)) {</span>
<span class="nc" id="L124">                    locationPermissionsHelper.handleLocationPermissions(locationAccessDialog, locationOffDialog);</span>
                }
            }
        }
<span class="nc" id="L128">    }</span>

    public void handleShowRationaleFlowCameraLocation(Activity activity) {
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(593)) {</span>
<span class="nc" id="L132">            DialogUtil.showAlertDialog(activity, activity.getString(R.string.location_permission_title), activity.getString(R.string.in_app_camera_location_permission_rationale), activity.getString(android.R.string.ok), activity.getString(android.R.string.cancel), () -&gt; {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (!locationPermissionsHelper.isLocationAccessToAppsTurnedOn()) {</span>
<span class="nc" id="L134">                    locationPermissionsHelper.showLocationOffDialog(activity);</span>
                }
<span class="nc" id="L136">            }, () -&gt; locationPermissionCallback.onLocationPermissionDenied(activity.getString(R.string.in_app_camera_location_permission_denied)), null, false);</span>
        }
<span class="nc" id="L138">    }</span>

    /**
     * Suggest user to attach location information with pictures. If the user selects &quot;Yes&quot;, then:
     * &lt;p&gt;
     * Location is taken from the EXIF if the default camera application does not redact location
     * tags.
     * &lt;p&gt;
     * Otherwise, if the EXIF metadata does not have location information, then location captured by
     * the app is used
     *
     * @param activity
     */
    private void askUserToAllowLocationAccess(Activity activity, ActivityResultLauncher&lt;String[]&gt; inAppCameraLocationPermissionLauncher) {
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(594)) {</span>
<span class="nc" id="L153">            DialogUtil.showAlertDialog(activity, activity.getString(R.string.in_app_camera_location_permission_title), activity.getString(R.string.in_app_camera_location_access_explanation), activity.getString(R.string.option_allow), activity.getString(R.string.option_dismiss), () -&gt; {</span>
<span class="nc" id="L154">                defaultKvStore.putBoolean(&quot;inAppCameraLocationPref&quot;, true);</span>
<span class="nc" id="L155">                createDialogsAndHandleLocationPermissions(activity, inAppCameraLocationPermissionLauncher);</span>
<span class="nc" id="L156">            }, () -&gt; {</span>
<span class="nc" id="L157">                defaultKvStore.putBoolean(&quot;inAppCameraLocationPref&quot;, false);</span>
<span class="nc" id="L158">                initiateCameraUpload(activity);</span>
<span class="nc" id="L159">            }, null, true);</span>
        }
<span class="nc" id="L161">    }</span>

    /**
     * Initiate gallery picker
     */
    public void initiateGalleryPick(final Activity activity, final boolean allowMultipleUploads) {
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(595)) {</span>
<span class="nc" id="L168">            initiateGalleryUpload(activity, allowMultipleUploads);</span>
        }
<span class="nc" id="L170">    }</span>

    /**
     * Initiate gallery picker with permission
     */
    public void initiateCustomGalleryPickWithPermission(final Activity activity) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(596)) {</span>
<span class="nc" id="L177">            setPickerConfiguration(activity, true);</span>
        }
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(597)) {</span>
<span class="nc" id="L180">            PermissionUtils.checkPermissionsAndPerformAction(activity, () -&gt; FilePicker.openCustomSelector(activity, 0), R.string.storage_permission_title, R.string.write_storage_permission_rationale, PermissionUtils.PERMISSIONS_STORAGE);</span>
        }
<span class="nc" id="L182">    }</span>

    /**
     * Open chooser for gallery uploads
     */
    private void initiateGalleryUpload(final Activity activity, final boolean allowMultipleUploads) {
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(598)) {</span>
<span class="nc" id="L189">            setPickerConfiguration(activity, allowMultipleUploads);</span>
        }
<span class="nc" id="L191">        boolean openDocumentIntentPreferred = defaultKvStore.getBoolean(&quot;openDocumentPhotoPickerPref&quot;, true);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(599)) {</span>
<span class="nc" id="L193">            FilePicker.openGallery(activity, 0, openDocumentIntentPreferred);</span>
        }
<span class="nc" id="L195">    }</span>

    /**
     * Sets configuration for file picker
     */
    private void setPickerConfiguration(Activity activity, boolean allowMultipleUploads) {
<span class="nc" id="L201">        boolean copyToExternalStorage = defaultKvStore.getBoolean(&quot;useExternalStorage&quot;, true);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(600)) {</span>
<span class="nc" id="L203">            FilePicker.configuration(activity).setCopyTakenPhotosToPublicGalleryAppFolder(copyToExternalStorage).setAllowMultiplePickInGallery(allowMultipleUploads);</span>
        }
<span class="nc" id="L205">    }</span>

    /**
     * Initiate camera upload by opening camera
     */
    private void initiateCameraUpload(Activity activity) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(601)) {</span>
<span class="nc" id="L212">            setPickerConfiguration(activity, false);</span>
        }
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(603)) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (defaultKvStore.getBoolean(&quot;inAppCameraLocationPref&quot;, false)) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(602)) {</span>
<span class="nc" id="L217">                    locationBeforeImageCapture = locationManager.getLastLocation();</span>
                }
            }
        }
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(604)) {</span>
<span class="nc" id="L222">            isInAppCameraUpload = true;</span>
        }
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(605)) {</span>
<span class="nc" id="L225">            FilePicker.openCameraForImage(activity, 0);</span>
        }
<span class="nc" id="L227">    }</span>

    /**
     * Attaches callback for file picker.
     */
    public void handleActivityResult(Activity activity, int requestCode, int resultCode, Intent data) {
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(610)) {</span>
<span class="nc" id="L234">            FilePicker.handleActivityResult(requestCode, resultCode, data, activity, new DefaultCallback() {</span>

                @Override
                public void onCanceled(final ImageSource source, final int type) {
<span class="nc bnc" id="L238" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(606)) {</span>
<span class="nc" id="L239">                        super.onCanceled(source, type);</span>
                    }
<span class="nc bnc" id="L241" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(607)) {</span>
<span class="nc" id="L242">                        defaultKvStore.remove(PLACE_OBJECT);</span>
                    }
<span class="nc" id="L244">                }</span>

                @Override
                public void onImagePickerError(Exception e, FilePicker.ImageSource source, int type) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(608)) {</span>
<span class="nc" id="L249">                        ViewUtil.showShortToast(activity, R.string.error_occurred_in_picking_images);</span>
                    }
<span class="nc" id="L251">                }</span>

                @Override
                public void onImagesPicked(@NonNull List&lt;UploadableFile&gt; imagesFiles, FilePicker.ImageSource source, int type) {
<span class="nc" id="L255">                    Intent intent = handleImagesPicked(activity, imagesFiles);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(609)) {</span>
<span class="nc" id="L257">                        activity.startActivity(intent);</span>
                    }
<span class="nc" id="L259">                }</span>
            });
        }
<span class="nc" id="L262">    }</span>

    public List&lt;UploadableFile&gt; handleExternalImagesPicked(Activity activity, Intent data) {
<span class="nc" id="L265">        return FilePicker.handleExternalImagesPicked(data, activity);</span>
    }

    /**
     * Returns intent to be passed to upload activity Attaches place object for nearby uploads and
     * location before image capture if in-app camera is used
     */
    private Intent handleImagesPicked(Context context, List&lt;UploadableFile&gt; imagesFiles) {
<span class="nc" id="L273">        Intent shareIntent = new Intent(context, UploadActivity.class);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(611)) {</span>
<span class="nc" id="L275">            shareIntent.setAction(ACTION_INTERNAL_UPLOADS);</span>
        }
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(612)) {</span>
<span class="nc" id="L278">            shareIntent.putParcelableArrayListExtra(UploadActivity.EXTRA_FILES, new ArrayList&lt;&gt;(imagesFiles));</span>
        }
<span class="nc" id="L280">        Place place = defaultKvStore.getJson(PLACE_OBJECT, Place.class);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(614)) {</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (place != null) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(613)) {</span>
<span class="nc" id="L284">                    shareIntent.putExtra(PLACE_OBJECT, place);</span>
                }
            }
        }
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(616)) {</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (locationBeforeImageCapture != null) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(615)) {</span>
<span class="nc" id="L291">                    shareIntent.putExtra(UploadActivity.LOCATION_BEFORE_IMAGE_CAPTURE, locationBeforeImageCapture);</span>
                }
            }
        }
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(617)) {</span>
<span class="nc" id="L296">            shareIntent.putExtra(UploadActivity.IN_APP_CAMERA_UPLOAD, isInAppCameraUpload);</span>
        }
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(618)) {</span>
            // reset the flag for next use
<span class="nc" id="L300">            isInAppCameraUpload = false;</span>
        }
<span class="nc" id="L302">        return shareIntent;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>