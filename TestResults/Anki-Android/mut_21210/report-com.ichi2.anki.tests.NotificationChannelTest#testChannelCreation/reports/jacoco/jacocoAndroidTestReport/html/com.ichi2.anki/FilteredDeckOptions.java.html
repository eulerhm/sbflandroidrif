<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FilteredDeckOptions.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki</a> &gt; <span class="el_source">FilteredDeckOptions.java</span></div><h1>FilteredDeckOptions.java</h1><pre class="source lang-java linenums">package com.ichi2.anki;

import android.content.BroadcastReceiver;
import android.content.ContentValues;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.content.SharedPreferences.OnSharedPreferenceChangeListener;
import android.os.Bundle;
import android.view.KeyEvent;
import android.view.MenuItem;
import com.ichi2.anim.ActivityTransitionAnimation;
import com.ichi2.anki.receiver.SdCardReceiver;
import com.ichi2.libanki.Collection;
import com.ichi2.libanki.Deck;
import com.ichi2.preferences.StepsPreference;
import com.ichi2.themes.Themes;
import com.ichi2.ui.AppCompatPreferenceActivity;
import com.ichi2.anki.analytics.UsageAnalytics;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONException;
import com.ichi2.utils.JSONObject;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import timber.log.Timber;
import static com.ichi2.anim.ActivityTransitionAnimation.Direction.FADE;
import static com.ichi2.libanki.Consts.DECK_STD;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Preferences for the current deck.
 */
<span class="nc" id="L38">public class FilteredDeckOptions extends AppCompatPreferenceActivity implements OnSharedPreferenceChangeListener {</span>

    private Deck mDeck;

    private Collection mCol;

<span class="nc" id="L44">    private boolean mAllowCommit = true;</span>

<span class="nc" id="L46">    private boolean mPrefChanged = false;</span>

<span class="nc" id="L48">    private BroadcastReceiver mUnmountReceiver = null;</span>

    // TODO: not anymore used in libanki?
<span class="nc" id="L51">    private final String[] dynExamples = new String[] { null, &quot;{'search'=\&quot;is:new\&quot;, 'resched'=False, 'steps'=\&quot;1\&quot;, 'order'=5}&quot;, &quot;{'search'=\&quot;added:1\&quot;, 'resched'=False, 'steps'=\&quot;1\&quot;, 'order'=5}&quot;, &quot;{'search'=\&quot;rated:1:1\&quot;, 'order'=4}&quot;, &quot;{'search'=\&quot;prop:due&lt;=2\&quot;, 'order'=6}&quot;, &quot;{'search'=\&quot;is:due tag:TAG\&quot;, 'order'=6}&quot;, &quot;{'search'=\&quot;is:due\&quot;, 'order'=3}&quot;, &quot;{'search'=\&quot;\&quot;, 'steps'=\&quot;1 10 20\&quot;, 'order'=0}&quot; };</span>

    public class DeckPreferenceHack implements SharedPreferences {

<span class="nc" id="L55">        private final Map&lt;String, String&gt; mValues = new HashMap&lt;&gt;();</span>

<span class="nc" id="L57">        private final Map&lt;String, String&gt; mSummaries = new HashMap&lt;&gt;();</span>

<span class="nc" id="L59">        public DeckPreferenceHack() {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8397)) {</span>
<span class="nc" id="L61">                this.cacheValues();</span>
            }
<span class="nc" id="L63">        }</span>

        protected void cacheValues() {
<span class="nc bnc" id="L66" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8398)) {</span>
<span class="nc" id="L67">                Timber.d(&quot;cacheValues()&quot;);</span>
            }
<span class="nc" id="L69">            JSONArray ar = mDeck.getJSONArray(&quot;terms&quot;).getJSONArray(0);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8399)) {</span>
<span class="nc" id="L71">                mValues.put(&quot;search&quot;, ar.getString(0));</span>
            }
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8400)) {</span>
<span class="nc" id="L74">                mValues.put(&quot;limit&quot;, ar.getString(1));</span>
            }
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8401)) {</span>
<span class="nc" id="L77">                mValues.put(&quot;order&quot;, ar.getString(2));</span>
            }
<span class="nc" id="L79">            JSONArray delays = mDeck.optJSONArray(&quot;delays&quot;);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8406)) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (delays != null) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8404)) {</span>
<span class="nc" id="L83">                        mValues.put(&quot;steps&quot;, StepsPreference.convertFromJSON(delays));</span>
                    }
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8405)) {</span>
<span class="nc" id="L86">                        mValues.put(&quot;stepsOn&quot;, Boolean.toString(true));</span>
                    }
                } else {
<span class="nc bnc" id="L89" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8402)) {</span>
<span class="nc" id="L90">                        mValues.put(&quot;steps&quot;, &quot;1 10&quot;);</span>
                    }
<span class="nc bnc" id="L92" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8403)) {</span>
<span class="nc" id="L93">                        mValues.put(&quot;stepsOn&quot;, Boolean.toString(false));</span>
                    }
                }
            }
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8407)) {</span>
<span class="nc" id="L98">                mValues.put(&quot;resched&quot;, Boolean.toString(mDeck.getBoolean(&quot;resched&quot;)));</span>
            }
<span class="nc" id="L100">        }</span>

<span class="nc" id="L102">        public class Editor implements SharedPreferences.Editor {</span>

<span class="nc" id="L104">            private ContentValues mUpdate = new ContentValues();</span>

            @Override
            public SharedPreferences.Editor clear() {
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8408)) {</span>
<span class="nc" id="L109">                    Timber.d(&quot;clear()&quot;);</span>
                }
<span class="nc bnc" id="L111" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8409)) {</span>
<span class="nc" id="L112">                    mUpdate = new ContentValues();</span>
                }
<span class="nc" id="L114">                return this;</span>
            }

            @Override
            public boolean commit() {
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8410)) {</span>
<span class="nc" id="L120">                    Timber.d(&quot;commit() changes back to database&quot;);</span>
                }
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8443)) {</span>
                    {
<span class="nc" id="L124">                        long _loopCounter137 = 0;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                        for (Entry&lt;String, Object&gt; entry : mUpdate.valueSet()) {</span>
<span class="nc" id="L126">                            ListenerUtil.loopListener.listen(&quot;_loopCounter137&quot;, ++_loopCounter137);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8411)) {</span>
<span class="nc" id="L128">                                Timber.i(&quot;Change value for key '%s': %s&quot;, entry.getKey(), entry.getValue());</span>
                            }
<span class="nc bnc" id="L130" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8442)) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                                if (&quot;search&quot;.equals(entry.getKey())) {</span>
<span class="nc" id="L132">                                    JSONArray ar = mDeck.getJSONArray(&quot;terms&quot;);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(8441)) {</span>
<span class="nc" id="L134">                                        ar.getJSONArray(0).put(0, entry.getValue());</span>
                                    }
<span class="nc bnc" id="L136" title="All 2 branches missed.">                                } else if (&quot;limit&quot;.equals(entry.getKey())) {</span>
<span class="nc" id="L137">                                    JSONArray ar = mDeck.getJSONArray(&quot;terms&quot;);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(8440)) {</span>
<span class="nc" id="L139">                                        ar.getJSONArray(0).put(1, entry.getValue());</span>
                                    }
<span class="nc bnc" id="L141" title="All 2 branches missed.">                                } else if (&quot;order&quot;.equals(entry.getKey())) {</span>
<span class="nc" id="L142">                                    JSONArray ar = mDeck.getJSONArray(&quot;terms&quot;);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(8439)) {</span>
<span class="nc" id="L144">                                        ar.getJSONArray(0).put(2, Integer.parseInt((String) entry.getValue()));</span>
                                    }
<span class="nc bnc" id="L146" title="All 2 branches missed.">                                } else if (&quot;resched&quot;.equals(entry.getKey())) {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(8438)) {</span>
<span class="nc" id="L148">                                        mDeck.put(&quot;resched&quot;, entry.getValue());</span>
                                    }
<span class="nc bnc" id="L150" title="All 2 branches missed.">                                } else if (&quot;stepsOn&quot;.equals(entry.getKey())) {</span>
<span class="nc" id="L151">                                    boolean on = (Boolean) entry.getValue();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(8437)) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                                        if (on) {</span>
<span class="nc" id="L154">                                            JSONArray steps = StepsPreference.convertToJSON(mValues.get(&quot;steps&quot;));</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(8436)) {</span>
<span class="nc bnc" id="L156" title="All 22 branches missed.">                                                if ((ListenerUtil.mutListener.listen(8434) ? (steps.length() &gt;= 0) : (ListenerUtil.mutListener.listen(8433) ? (steps.length() &lt;= 0) : (ListenerUtil.mutListener.listen(8432) ? (steps.length() &lt; 0) : (ListenerUtil.mutListener.listen(8431) ? (steps.length() != 0) : (ListenerUtil.mutListener.listen(8430) ? (steps.length() == 0) : (steps.length() &gt; 0))))))) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                                                    if (!ListenerUtil.mutListener.listen(8435)) {</span>
<span class="nc" id="L158">                                                        mDeck.put(&quot;delays&quot;, steps);</span>
                                                    }
                                                }
                                            }
<span class="nc" id="L162">                                        } else {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(8429)) {</span>
<span class="nc" id="L164">                                                mDeck.put(&quot;delays&quot;, JSONObject.NULL);</span>
                                            }
                                        }
                                    }
<span class="nc bnc" id="L168" title="All 2 branches missed.">                                } else if (&quot;steps&quot;.equals(entry.getKey())) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(8428)) {</span>
<span class="nc" id="L170">                                        mDeck.put(&quot;delays&quot;, StepsPreference.convertToJSON((String) entry.getValue()));</span>
                                    }
<span class="nc bnc" id="L172" title="All 2 branches missed.">                                } else if (&quot;preset&quot;.equals(entry.getKey())) {</span>
<span class="nc" id="L173">                                    int i = Integer.parseInt((String) entry.getValue());</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(8427)) {</span>
<span class="nc bnc" id="L175" title="All 22 branches missed.">                                        if ((ListenerUtil.mutListener.listen(8416) ? (i &gt;= 0) : (ListenerUtil.mutListener.listen(8415) ? (i &lt;= 0) : (ListenerUtil.mutListener.listen(8414) ? (i &lt; 0) : (ListenerUtil.mutListener.listen(8413) ? (i != 0) : (ListenerUtil.mutListener.listen(8412) ? (i == 0) : (i &gt; 0))))))) {</span>
<span class="nc" id="L176">                                            JSONObject presetValues = new JSONObject(dynExamples[i]);</span>
<span class="nc" id="L177">                                            JSONArray ar = presetValues.names();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(8424)) {</span>
                                                {
<span class="nc" id="L180">                                                    long _loopCounter136 = 0;</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                                                    for (String name : ar.stringIterable()) {</span>
<span class="nc" id="L182">                                                        ListenerUtil.loopListener.listen(&quot;_loopCounter136&quot;, ++_loopCounter136);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(8418)) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                                                            if (&quot;steps&quot;.equals(name)) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(8417)) {</span>
<span class="nc" id="L186">                                                                    mUpdate.put(&quot;stepsOn&quot;, true);</span>
                                                                }
                                                            }
                                                        }
<span class="nc bnc" id="L190" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(8423)) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                                                            if (&quot;resched&quot;.equals(name)) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(8421)) {</span>
<span class="nc" id="L193">                                                                    mUpdate.put(name, presetValues.getBoolean(name));</span>
                                                                }
<span class="nc bnc" id="L195" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(8422)) {</span>
<span class="nc" id="L196">                                                                    mValues.put(name, Boolean.toString(presetValues.getBoolean(name)));</span>
                                                                }
                                                            } else {
<span class="nc bnc" id="L199" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(8419)) {</span>
<span class="nc" id="L200">                                                                    mUpdate.put(name, presetValues.getString(name));</span>
                                                                }
<span class="nc bnc" id="L202" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(8420)) {</span>
<span class="nc" id="L203">                                                                    mValues.put(name, presetValues.getString(name));</span>
                                                                }
                                                            }
                                                        }
<span class="nc" id="L207">                                                    }</span>
                                                }
                                            }
<span class="nc bnc" id="L210" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(8425)) {</span>
<span class="nc" id="L211">                                                mUpdate.put(&quot;preset&quot;, &quot;0&quot;);</span>
                                            }
<span class="nc bnc" id="L213" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(8426)) {</span>
<span class="nc" id="L214">                                                commit();</span>
                                            }
                                        }
                                    }
                                }
                            }
<span class="nc" id="L220">                        }</span>
                    }
                }
                // save deck
                try {
<span class="nc bnc" id="L225" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8448)) {</span>
<span class="nc" id="L226">                        mCol.getDecks().save(mDeck);</span>
                    }
<span class="nc" id="L228">                } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8444)) {</span>
<span class="nc" id="L230">                        Timber.e(e, &quot;RuntimeException on saving deck&quot;);</span>
                    }
<span class="nc bnc" id="L232" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8445)) {</span>
<span class="nc" id="L233">                        AnkiDroidApp.sendExceptionReport(e, &quot;FilteredDeckOptionsSaveDeck&quot;);</span>
                    }
<span class="nc bnc" id="L235" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8446)) {</span>
<span class="nc" id="L236">                        setResult(DeckPicker.RESULT_DB_ERROR);</span>
                    }
<span class="nc bnc" id="L238" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8447)) {</span>
<span class="nc" id="L239">                        finish();</span>
                    }
<span class="nc" id="L241">                }</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8449)) {</span>
                    // make sure we refresh the parent cached values
<span class="nc" id="L244">                    cacheValues();</span>
                }
<span class="nc bnc" id="L246" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8450)) {</span>
<span class="nc" id="L247">                    updateSummaries();</span>
                }
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8452)) {</span>
                    {
<span class="nc" id="L251">                        long _loopCounter138 = 0;</span>
                        // and update any listeners
<span class="nc bnc" id="L253" title="All 2 branches missed.">                        for (OnSharedPreferenceChangeListener listener : listeners) {</span>
<span class="nc" id="L254">                            ListenerUtil.loopListener.listen(&quot;_loopCounter138&quot;, ++_loopCounter138);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8451)) {</span>
<span class="nc" id="L256">                                listener.onSharedPreferenceChanged(DeckPreferenceHack.this, null);</span>
                            }
<span class="nc" id="L258">                        }</span>
                    }
                }
<span class="nc" id="L261">                return true;</span>
            }

            @Override
            public SharedPreferences.Editor putBoolean(String key, boolean value) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8453)) {</span>
<span class="nc" id="L267">                    mUpdate.put(key, value);</span>
                }
<span class="nc" id="L269">                return this;</span>
            }

            @Override
            public SharedPreferences.Editor putFloat(String key, float value) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8454)) {</span>
<span class="nc" id="L275">                    mUpdate.put(key, value);</span>
                }
<span class="nc" id="L277">                return this;</span>
            }

            @Override
            public SharedPreferences.Editor putInt(String key, int value) {
<span class="nc bnc" id="L282" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8455)) {</span>
<span class="nc" id="L283">                    mUpdate.put(key, value);</span>
                }
<span class="nc" id="L285">                return this;</span>
            }

            @Override
            public SharedPreferences.Editor putLong(String key, long value) {
<span class="nc bnc" id="L290" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8456)) {</span>
<span class="nc" id="L291">                    mUpdate.put(key, value);</span>
                }
<span class="nc" id="L293">                return this;</span>
            }

            @Override
            public SharedPreferences.Editor putString(String key, String value) {
<span class="nc bnc" id="L298" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8457)) {</span>
<span class="nc" id="L299">                    mUpdate.put(key, value);</span>
                }
<span class="nc" id="L301">                return this;</span>
            }

            @Override
            public SharedPreferences.Editor remove(String key) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8458)) {</span>
<span class="nc" id="L307">                    Timber.d(&quot;Editor.remove(key=%s)&quot;, key);</span>
                }
<span class="nc bnc" id="L309" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8459)) {</span>
<span class="nc" id="L310">                    mUpdate.remove(key);</span>
                }
<span class="nc" id="L312">                return this;</span>
            }

            public void apply() {
<span class="nc bnc" id="L316" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8461)) {</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                    if (mAllowCommit) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8460)) {</span>
<span class="nc" id="L319">                            commit();</span>
                        }
                    }
                }
<span class="nc" id="L323">            }</span>

            // @Override On Android 1.5 this is not Override
            public android.content.SharedPreferences.Editor putStringSet(String arg0, Set&lt;String&gt; arg1) {
                // TODO Auto-generated method stub
<span class="nc" id="L328">                return null;</span>
            }
        }

        @Override
        public boolean contains(String key) {
<span class="nc" id="L334">            return mValues.containsKey(key);</span>
        }

        @Override
        public Editor edit() {
<span class="nc" id="L339">            return new Editor();</span>
        }

        @Override
        public Map&lt;String, ?&gt; getAll() {
<span class="nc" id="L344">            return mValues;</span>
        }

        @Override
        public boolean getBoolean(String key, boolean defValue) {
<span class="nc" id="L349">            return Boolean.parseBoolean(this.getString(key, Boolean.toString(defValue)));</span>
        }

        @Override
        public float getFloat(String key, float defValue) {
<span class="nc" id="L354">            return Float.parseFloat(this.getString(key, Float.toString(defValue)));</span>
        }

        @Override
        public int getInt(String key, int defValue) {
<span class="nc" id="L359">            return Integer.parseInt(this.getString(key, Integer.toString(defValue)));</span>
        }

        @Override
        public long getLong(String key, long defValue) {
<span class="nc" id="L364">            return Long.parseLong(this.getString(key, Long.toString(defValue)));</span>
        }

        @Override
        public String getString(String key, String defValue) {
<span class="nc bnc" id="L369" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8462)) {</span>
<span class="nc" id="L370">                Timber.d(&quot;getString(key=%s, defValue=%s)&quot;, key, defValue);</span>
            }
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8463)) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                if (!mValues.containsKey(key)) {</span>
<span class="nc" id="L374">                    return defValue;</span>
                }
            }
<span class="nc" id="L377">            return mValues.get(key);</span>
        }

<span class="nc" id="L380">        public final List&lt;OnSharedPreferenceChangeListener&gt; listeners = new LinkedList&lt;&gt;();</span>

        @Override
        public void registerOnSharedPreferenceChangeListener(OnSharedPreferenceChangeListener listener) {
<span class="nc bnc" id="L384" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8464)) {</span>
<span class="nc" id="L385">                listeners.add(listener);</span>
            }
<span class="nc" id="L387">        }</span>

        @Override
        public void unregisterOnSharedPreferenceChangeListener(OnSharedPreferenceChangeListener listener) {
<span class="nc bnc" id="L391" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8465)) {</span>
<span class="nc" id="L392">                listeners.remove(listener);</span>
            }
<span class="nc" id="L394">        }</span>

        // @Override On Android 1.5 this is not Override
        public Set&lt;String&gt; getStringSet(String arg0, Set&lt;String&gt; arg1) {
            // TODO Auto-generated method stub
<span class="nc" id="L399">            return null;</span>
        }
    }

    private DeckPreferenceHack mPref;

    @Override
    public SharedPreferences getSharedPreferences(String name, int mode) {
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8466)) {</span>
<span class="nc" id="L408">            Timber.d(&quot;getSharedPreferences(name=%s)&quot;, name);</span>
        }
<span class="nc" id="L410">        return mPref;</span>
    }

    @Override
    // Tracked as #5019 on github
    @SuppressWarnings(&quot;deprecation&quot;)
    protected void onCreate(Bundle icicle) {
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8467)) {</span>
<span class="nc" id="L418">            Themes.setThemeLegacy(this);</span>
        }
<span class="nc bnc" id="L420" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8468)) {</span>
<span class="nc" id="L421">            super.onCreate(icicle);</span>
        }
<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8469)) {</span>
<span class="nc" id="L424">            UsageAnalytics.sendAnalyticsScreenView(this);</span>
        }
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8470)) {</span>
<span class="nc" id="L427">            mCol = CollectionHelper.getInstance().getCol(this);</span>
        }
<span class="nc bnc" id="L429" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8472)) {</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (mCol == null) {</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8471)) {</span>
<span class="nc" id="L432">                    finish();</span>
                }
<span class="nc" id="L434">                return;</span>
            }
        }
<span class="nc" id="L437">        Bundle extras = getIntent().getExtras();</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8476)) {</span>
<span class="nc bnc" id="L439" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(8473) ? (extras != null || extras.containsKey(&quot;did&quot;)) : (extras != null &amp;&amp; extras.containsKey(&quot;did&quot;)))) {</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8475)) {</span>
<span class="nc" id="L441">                    mDeck = mCol.getDecks().get(extras.getLong(&quot;did&quot;));</span>
                }
            } else {
<span class="nc bnc" id="L444" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8474)) {</span>
<span class="nc" id="L445">                    mDeck = mCol.getDecks().current();</span>
                }
            }
        }
<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8477)) {</span>
<span class="nc" id="L450">            registerExternalStorageListener();</span>
        }
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8486)) {</span>
<span class="nc bnc" id="L453" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(8478) ? (mCol == null &amp;&amp; mDeck.getInt(&quot;dyn&quot;) == DECK_STD) : (mCol == null || mDeck.getInt(&quot;dyn&quot;) == DECK_STD))) {</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8484)) {</span>
<span class="nc" id="L455">                    Timber.w(&quot;No Collection loaded or deck is not a dyn deck&quot;);</span>
                }
<span class="nc bnc" id="L457" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8485)) {</span>
<span class="nc" id="L458">                    finish();</span>
                }
<span class="nc" id="L460">                return;</span>
            } else {
<span class="nc bnc" id="L462" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8479)) {</span>
<span class="nc" id="L463">                    mPref = new DeckPreferenceHack();</span>
                }
<span class="nc bnc" id="L465" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8480)) {</span>
<span class="nc" id="L466">                    mPref.registerOnSharedPreferenceChangeListener(this);</span>
                }
<span class="nc bnc" id="L468" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8481)) {</span>
<span class="nc" id="L469">                    this.addPreferencesFromResource(R.xml.cram_deck_options);</span>
                }
<span class="nc bnc" id="L471" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8482)) {</span>
<span class="nc" id="L472">                    this.buildLists();</span>
                }
<span class="nc bnc" id="L474" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8483)) {</span>
<span class="nc" id="L475">                    this.updateSummaries();</span>
                }
            }
        }
        // Set the activity title to include the name of the deck
<span class="nc" id="L480">        String title = getResources().getString(R.string.deckpreferences_title);</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8489)) {</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">            if (title.contains(&quot;XXX&quot;)) {</span>
                try {
<span class="nc bnc" id="L484" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8488)) {</span>
<span class="nc" id="L485">                        title = title.replace(&quot;XXX&quot;, mDeck.getString(&quot;name&quot;));</span>
                    }
<span class="nc" id="L487">                } catch (JSONException e) {</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8487)) {</span>
<span class="nc" id="L489">                        title = title.replace(&quot;XXX&quot;, &quot;???&quot;);</span>
                    }
<span class="nc" id="L491">                }</span>
            }
        }
<span class="nc bnc" id="L494" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8490)) {</span>
<span class="nc" id="L495">            this.setTitle(title);</span>
        }
<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8491)) {</span>
            // Add a home button to the actionbar
<span class="nc" id="L499">            getSupportActionBar().setHomeButtonEnabled(true);</span>
        }
<span class="nc bnc" id="L501" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8492)) {</span>
<span class="nc" id="L502">            getSupportActionBar().setDisplayHomeAsUpEnabled(true);</span>
        }
<span class="nc" id="L504">    }</span>

    @Override
    // TODO Tracked in https://github.com/ankidroid/Anki-Android/issues/5019
    @SuppressWarnings(&quot;deprecation&quot;)
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8494)) {</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">            if (item.getItemId() == android.R.id.home) {</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8493)) {</span>
<span class="nc" id="L513">                    closeDeckOptions();</span>
                }
<span class="nc" id="L515">                return true;</span>
            }
        }
<span class="nc" id="L518">        return false;</span>
    }

    @Override
    public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) {
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8495)) {</span>
            // update values on changed preference
<span class="nc" id="L525">            this.updateSummaries();</span>
        }
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8496)) {</span>
<span class="nc" id="L528">            mPrefChanged = true;</span>
        }
<span class="nc" id="L530">    }</span>

    @Override
    public boolean onKeyDown(int keyCode, KeyEvent event) {
<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8500)) {</span>
<span class="nc bnc" id="L535" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(8497) ? (keyCode == KeyEvent.KEYCODE_BACK || event.getRepeatCount() == 0) : (keyCode == KeyEvent.KEYCODE_BACK &amp;&amp; event.getRepeatCount() == 0))) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8498)) {</span>
<span class="nc" id="L537">                    Timber.i(&quot;DeckOptions - onBackPressed()&quot;);</span>
                }
<span class="nc bnc" id="L539" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8499)) {</span>
<span class="nc" id="L540">                    closeDeckOptions();</span>
                }
<span class="nc" id="L542">                return true;</span>
            }
        }
<span class="nc" id="L545">        return super.onKeyDown(keyCode, event);</span>
    }

    private void closeDeckOptions() {
<span class="nc bnc" id="L549" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8503)) {</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">            if (mPrefChanged) {</span>
                // Rebuild the filtered deck if a setting has changed
                try {
<span class="nc bnc" id="L553" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8502)) {</span>
<span class="nc" id="L554">                        mCol.getSched().rebuildDyn(mDeck.getLong(&quot;id&quot;));</span>
                    }
<span class="nc" id="L556">                } catch (JSONException e) {</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8501)) {</span>
<span class="nc" id="L558">                        Timber.e(e);</span>
                    }
<span class="nc" id="L560">                }</span>
            }
        }
<span class="nc bnc" id="L563" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8504)) {</span>
<span class="nc" id="L564">            finish();</span>
        }
<span class="nc bnc" id="L566" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8505)) {</span>
<span class="nc" id="L567">            ActivityTransitionAnimation.slide(this, FADE);</span>
        }
<span class="nc" id="L569">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8506)) {</span>
<span class="nc" id="L574">            super.onDestroy();</span>
        }
<span class="nc bnc" id="L576" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8508)) {</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">            if (mUnmountReceiver != null) {</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8507)) {</span>
<span class="nc" id="L579">                    unregisterReceiver(mUnmountReceiver);</span>
                }
            }
        }
<span class="nc" id="L583">    }</span>

    // conversion to fragments tracked in github as #5019
    @SuppressWarnings(&quot;deprecation&quot;)
    protected void updateSummaries() {
<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8509)) {</span>
<span class="nc" id="L589">            mAllowCommit = false;</span>
        }
<span class="nc" id="L591">        Set&lt;String&gt; keys = mPref.mValues.keySet();</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8518)) {</span>
            {
<span class="nc" id="L594">                long _loopCounter139 = 0;</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                for (String key : keys) {</span>
<span class="nc" id="L596">                    ListenerUtil.loopListener.listen(&quot;_loopCounter139&quot;, ++_loopCounter139);</span>
<span class="nc" id="L597">                    android.preference.Preference pref = this.findPreference(key);</span>
                    String value;
<span class="nc bnc" id="L599" title="All 2 branches missed.">                    if (pref == null) {</span>
<span class="nc" id="L600">                        continue;</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">                    } else if (pref instanceof android.preference.CheckBoxPreference) {</span>
<span class="nc" id="L602">                        continue;</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">                    } else if (pref instanceof android.preference.ListPreference) {</span>
<span class="nc" id="L604">                        android.preference.ListPreference lp = (android.preference.ListPreference) pref;</span>
<span class="nc" id="L605">                        CharSequence entry = lp.getEntry();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                        if (entry != null) {</span>
<span class="nc" id="L607">                            value = entry.toString();</span>
                        } else {
<span class="nc" id="L609">                            value = &quot;&quot;;</span>
                        }
<span class="nc" id="L611">                    } else {</span>
<span class="nc" id="L612">                        value = this.mPref.getString(key, &quot;&quot;);</span>
                    }
<span class="nc bnc" id="L614" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8511)) {</span>
                        // update value for EditTexts
<span class="nc bnc" id="L616" title="All 2 branches missed.">                        if (pref instanceof android.preference.EditTextPreference) {</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8510)) {</span>
<span class="nc" id="L618">                                ((android.preference.EditTextPreference) pref).setText(value);</span>
                            }
                        }
                    }
<span class="nc bnc" id="L622" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8513)) {</span>
                        // update summary
<span class="nc bnc" id="L624" title="All 2 branches missed.">                        if (!mPref.mSummaries.containsKey(key)) {</span>
<span class="nc" id="L625">                            CharSequence s = pref.getSummary();</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8512)) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                                mPref.mSummaries.put(key, s != null ? pref.getSummary().toString() : null);</span>
                            }
                        }
                    }
<span class="nc" id="L631">                    String summ = mPref.mSummaries.get(key);</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8517)) {</span>
<span class="nc bnc" id="L633" title="All 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(8514) ? (summ != null || summ.contains(&quot;XXX&quot;)) : (summ != null &amp;&amp; summ.contains(&quot;XXX&quot;)))) {</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8516)) {</span>
<span class="nc" id="L635">                                pref.setSummary(summ.replace(&quot;XXX&quot;, value));</span>
                            }
                        } else {
<span class="nc bnc" id="L638" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8515)) {</span>
<span class="nc" id="L639">                                pref.setSummary(value);</span>
                            }
                        }
                    }
<span class="nc" id="L643">                }</span>
            }
        }
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8519)) {</span>
<span class="nc" id="L647">            mAllowCommit = true;</span>
        }
<span class="nc" id="L649">    }</span>

    // Tracked as #5019 on github
    @SuppressWarnings(&quot;deprecation&quot;)
    protected void buildLists() {
<span class="nc" id="L654">        android.preference.ListPreference newOrderPref = (android.preference.ListPreference) findPreference(&quot;order&quot;);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8520)) {</span>
<span class="nc" id="L656">            newOrderPref.setEntries(R.array.cram_deck_conf_order_labels);</span>
        }
<span class="nc bnc" id="L658" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8521)) {</span>
<span class="nc" id="L659">            newOrderPref.setEntryValues(R.array.cram_deck_conf_order_values);</span>
        }
<span class="nc bnc" id="L661" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8522)) {</span>
<span class="nc" id="L662">            newOrderPref.setValue(mPref.getString(&quot;order&quot;, &quot;0&quot;));</span>
        }
<span class="nc" id="L664">    }</span>

    /**
     * finish when sd card is ejected
     */
    private void registerExternalStorageListener() {
<span class="nc bnc" id="L670" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8528)) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">            if (mUnmountReceiver == null) {</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8525)) {</span>
<span class="nc" id="L673">                    mUnmountReceiver = new BroadcastReceiver() {</span>

                        @Override
                        public void onReceive(Context context, Intent intent) {
<span class="nc bnc" id="L677" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8524)) {</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">                                if (intent.getAction().equals(SdCardReceiver.MEDIA_EJECT)) {</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(8523)) {</span>
<span class="nc" id="L680">                                        finish();</span>
                                    }
                                }
                            }
<span class="nc" id="L684">                        }</span>
                    };
                }
<span class="nc" id="L687">                IntentFilter iFilter = new IntentFilter();</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8526)) {</span>
<span class="nc" id="L689">                    iFilter.addAction(SdCardReceiver.MEDIA_EJECT);</span>
                }
<span class="nc bnc" id="L691" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8527)) {</span>
<span class="nc" id="L692">                    registerReceiver(mUnmountReceiver, iFilter);</span>
                }
            }
        }
<span class="nc" id="L696">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>