<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CollectionTask.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.async</a> &gt; <span class="el_source">CollectionTask.java</span></div><h1>CollectionTask.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2009 Daniel Sv√§rd &lt;daniel.svard@gmail.com&gt;                             *
 *  Copyright (c) 2009 Edu Zamora &lt;edu.zasu@gmail.com&gt;                                   *
 *  Copyright (c) 2011 Norbert Nagold &lt;norbert.nagold@gmail.com&gt;                         *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.async;

import android.content.Context;
import android.content.res.Resources;
import android.os.AsyncTask;
import android.util.Pair;
import com.google.gson.stream.JsonReader;
import com.ichi2.anki.AnkiDroidApp;
import com.ichi2.anki.BackupManager;
import com.ichi2.anki.CardBrowser;
import com.ichi2.anki.CardUtils;
import com.ichi2.anki.CollectionHelper;
import com.ichi2.anki.R;
import com.ichi2.anki.TemporaryModel;
import com.ichi2.anki.exception.ConfirmModSchemaException;
import com.ichi2.anki.exception.ImportExportException;
import com.ichi2.libanki.Media;
import com.ichi2.libanki.Model;
import com.ichi2.libanki.Undoable;
import com.ichi2.libanki.WrongId;
import com.ichi2.libanki.sched.AbstractSched;
import com.ichi2.libanki.AnkiPackageExporter;
import com.ichi2.libanki.Card;
import com.ichi2.libanki.Collection;
import com.ichi2.libanki.Consts;
import com.ichi2.libanki.DB;
import com.ichi2.libanki.Decks;
import com.ichi2.libanki.Note;
import com.ichi2.libanki.Storage;
import com.ichi2.libanki.Utils;
import com.ichi2.libanki.DeckConfig;
import com.ichi2.libanki.Deck;
import com.ichi2.libanki.importer.AnkiPackageImporter;
import com.ichi2.libanki.sched.Counts;
import com.ichi2.libanki.sched.DeckDueTreeNode;
import com.ichi2.libanki.sched.DeckTreeNode;
import com.ichi2.libanki.utils.Time;
import com.ichi2.utils.BooleanGetter;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONException;
import com.ichi2.utils.JSONObject;
import com.ichi2.utils.PairWithBoolean;
import com.ichi2.utils.PairWithCard;
import com.ichi2.utils.SyncStatus;
import com.ichi2.utils.ThreadUtil;
import com.ichi2.utils.Triple;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;
import java.util.concurrent.CancellationException;
import java.util.concurrent.ExecutionException;
import org.apache.commons.compress.archivers.zip.ZipFile;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.VisibleForTesting;
import timber.log.Timber;
import static com.ichi2.async.TaskManager.setLatestInstance;
import static com.ichi2.libanki.Card.deepCopyCardArray;
import static com.ichi2.libanki.Collection.DismissType.BURY_CARD;
import static com.ichi2.libanki.Collection.DismissType.BURY_NOTE;
import static com.ichi2.libanki.Collection.DismissType.REPOSITION_CARDS;
import static com.ichi2.libanki.Collection.DismissType.RESCHEDULE_CARDS;
import static com.ichi2.libanki.Collection.DismissType.RESET_CARDS;
import static com.ichi2.libanki.Collection.DismissType.SUSPEND_NOTE;
import static com.ichi2.libanki.Consts.DECK_DYN;
import static com.ichi2.libanki.Undoable.*;
import static com.ichi2.utils.BooleanGetter.False;
import static com.ichi2.utils.BooleanGetter.True;
import static com.ichi2.utils.BooleanGetter.fromBoolean;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Loading in the background, so that AnkiDroid does not look like frozen.
 */
public class CollectionTask&lt;ProgressListener, ProgressBackground extends ProgressListener, ResultListener, ResultBackground extends ResultListener&gt; extends BaseAsyncTask&lt;Void, ProgressBackground, ResultBackground&gt; {

<span class="nc" id="L106">    public abstract static class Task&lt;ProgressBackground, ResultBackground&gt; {</span>

        protected abstract ResultBackground task(Collection col, ProgressSenderAndCancelListener&lt;ProgressBackground&gt; collectionTask);
    }

    /**
     * A reference to the application context to use to fetch the current Collection object.
     */
    private Context mContext;

    /**
     * Block the current thread until all CollectionTasks have finished.
     * @param timeoutSeconds timeout in seconds
     * @return whether all tasks exited successfully
     */
    @SuppressWarnings(&quot;UnusedReturnValue&quot;)
    public static boolean waitForAllToFinish(Integer timeoutSeconds) {
        // This should work in all reasonable cases given how few tasks we have concurrently blocking.
        boolean result;
<span class="nc bnc" id="L125" title="All 8 branches missed.">        result = TaskManager.waitToFinish((ListenerUtil.mutListener.listen(12621) ? (timeoutSeconds % 4) : (ListenerUtil.mutListener.listen(12620) ? (timeoutSeconds * 4) : (ListenerUtil.mutListener.listen(12619) ? (timeoutSeconds - 4) : (ListenerUtil.mutListener.listen(12618) ? (timeoutSeconds + 4) : (timeoutSeconds / 4))))));</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12622)) {</span>
<span class="nc" id="L127">            ThreadUtil.sleep(10);</span>
        }
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12627)) {</span>
<span class="nc bnc" id="L130" title="All 8 branches missed.">            result &amp;= TaskManager.waitToFinish((ListenerUtil.mutListener.listen(12626) ? (timeoutSeconds % 4) : (ListenerUtil.mutListener.listen(12625) ? (timeoutSeconds * 4) : (ListenerUtil.mutListener.listen(12624) ? (timeoutSeconds - 4) : (ListenerUtil.mutListener.listen(12623) ? (timeoutSeconds + 4) : (timeoutSeconds / 4))))));</span>
        }
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12628)) {</span>
<span class="nc" id="L133">            ThreadUtil.sleep(10);</span>
        }
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12633)) {</span>
<span class="nc bnc" id="L136" title="All 8 branches missed.">            result &amp;= TaskManager.waitToFinish((ListenerUtil.mutListener.listen(12632) ? (timeoutSeconds % 4) : (ListenerUtil.mutListener.listen(12631) ? (timeoutSeconds * 4) : (ListenerUtil.mutListener.listen(12630) ? (timeoutSeconds - 4) : (ListenerUtil.mutListener.listen(12629) ? (timeoutSeconds + 4) : (timeoutSeconds / 4))))));</span>
        }
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12634)) {</span>
<span class="nc" id="L139">            ThreadUtil.sleep(10);</span>
        }
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12639)) {</span>
<span class="nc bnc" id="L142" title="All 8 branches missed.">            result &amp;= TaskManager.waitToFinish((ListenerUtil.mutListener.listen(12638) ? (timeoutSeconds % 4) : (ListenerUtil.mutListener.listen(12637) ? (timeoutSeconds * 4) : (ListenerUtil.mutListener.listen(12636) ? (timeoutSeconds - 4) : (ListenerUtil.mutListener.listen(12635) ? (timeoutSeconds + 4) : (timeoutSeconds / 4))))));</span>
        }
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12640)) {</span>
<span class="nc" id="L145">            ThreadUtil.sleep(10);</span>
        }
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12641)) {</span>
<span class="nc" id="L148">            Timber.i(&quot;Waited for all tasks to finish&quot;);</span>
        }
<span class="nc" id="L150">        return result;</span>
    }

    /**
     * Cancel the current task.
     * @return whether cancelling did occur.
     */
    public boolean safeCancel() {
        try {
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12644)) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                if (getStatus() != AsyncTask.Status.FINISHED) {</span>
<span class="nc" id="L161">                    return cancel(true);</span>
                }
            }
<span class="nc" id="L164">        } catch (Exception e) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12642)) {</span>
                // AsyncTask.cancel
<span class="nc" id="L167">                Timber.w(e, &quot;Exception cancelling task&quot;);</span>
            }
        } finally {
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12643)) {</span>
<span class="nc" id="L171">                TaskManager.removeTask(this);</span>
            }
        }
<span class="nc" id="L174">        return false;</span>
    }

    private Collection getCol() {
<span class="nc" id="L178">        return CollectionHelper.getInstance().getCol(mContext);</span>
    }

    protected Context getContext() {
<span class="nc" id="L182">        return mContext;</span>
    }

    private final Task&lt;ProgressBackground, ResultBackground&gt; mTask;

    public Task&lt;ProgressBackground, ResultBackground&gt; getTask() {
<span class="nc" id="L188">        return mTask;</span>
    }

    private final TaskListener&lt;ProgressListener, ResultListener&gt; mListener;

    private CollectionTask mPreviousTask;

<span class="nc" id="L195">    protected CollectionTask(Task&lt;ProgressBackground, ResultBackground&gt; task, TaskListener&lt;ProgressListener, ResultListener&gt; listener, CollectionTask previousTask) {</span>
<span class="nc" id="L196">        mTask = task;</span>
<span class="nc" id="L197">        mListener = listener;</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12645)) {</span>
<span class="nc" id="L199">            mPreviousTask = previousTask;</span>
        }
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12646)) {</span>
<span class="nc" id="L202">            TaskManager.addTasks(this);</span>
        }
<span class="nc" id="L204">    }</span>

    @Override
    protected ResultBackground doInBackground(Void... params) {
        try {
<span class="nc" id="L209">            return actualDoInBackground();</span>
        } finally {
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12647)) {</span>
<span class="nc" id="L212">                TaskManager.removeTask(this);</span>
            }
        }
    }

    // This method and those that are called here are executed in a new thread
    protected ResultBackground actualDoInBackground() {
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12648)) {</span>
<span class="nc" id="L220">            super.doInBackground();</span>
        }
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12657)) {</span>
            // Wait for previous thread (if any) to finish before continuing
<span class="nc bnc" id="L224" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(12649) ? (mPreviousTask != null || mPreviousTask.getStatus() != AsyncTask.Status.FINISHED) : (mPreviousTask != null &amp;&amp; mPreviousTask.getStatus() != AsyncTask.Status.FINISHED))) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12650)) {</span>
<span class="nc" id="L226">                    Timber.d(&quot;Waiting for %s to finish before starting %s&quot;, mPreviousTask.mTask, mTask.getClass());</span>
                }
                try {
<span class="nc bnc" id="L229" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12655)) {</span>
<span class="nc" id="L230">                        mPreviousTask.get();</span>
                    }
<span class="nc bnc" id="L232" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12656)) {</span>
<span class="nc" id="L233">                        Timber.d(&quot;Finished waiting for %s to finish. Status= %s&quot;, mPreviousTask.mTask, mPreviousTask.getStatus());</span>
                    }
<span class="nc" id="L235">                } catch (InterruptedException e) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12651)) {</span>
<span class="nc" id="L237">                        Thread.currentThread().interrupt();</span>
                    }
<span class="nc bnc" id="L239" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12652)) {</span>
                        // We have been interrupted, return immediately.
<span class="nc" id="L241">                        Timber.d(e, &quot;interrupted while waiting for previous task: %s&quot;, mPreviousTask.mTask.getClass());</span>
                    }
<span class="nc" id="L243">                    return null;</span>
<span class="nc" id="L244">                } catch (ExecutionException e) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12653)) {</span>
                        // Ignore failures in the previous task.
<span class="nc" id="L247">                        Timber.e(e, &quot;previously running task failed with exception: %s&quot;, mPreviousTask.mTask.getClass());</span>
                    }
<span class="nc" id="L249">                } catch (CancellationException e) {</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12654)) {</span>
                        // Ignore cancellation of previous task
<span class="nc" id="L252">                        Timber.d(e, &quot;previously running task was cancelled: %s&quot;, mPreviousTask.mTask.getClass());</span>
                    }
<span class="nc" id="L254">                }</span>
            }
        }
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12658)) {</span>
<span class="nc" id="L258">            setLatestInstance(this);</span>
        }
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12659)) {</span>
<span class="nc" id="L261">            mContext = AnkiDroidApp.getInstance().getApplicationContext();</span>
        }
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12663)) {</span>
            // Skip the task if the collection cannot be opened
<span class="nc bnc" id="L265" title="All 26 branches missed.">            if ((ListenerUtil.mutListener.listen(12661) ? ((ListenerUtil.mutListener.listen(12660) ? (mTask.getClass() != RepairCollectionn.class || mTask.getClass() != ImportReplace.class) : (mTask.getClass() != RepairCollectionn.class &amp;&amp; mTask.getClass() != ImportReplace.class)) || CollectionHelper.getInstance().getColSafe(mContext) == null) : ((ListenerUtil.mutListener.listen(12660) ? (mTask.getClass() != RepairCollectionn.class || mTask.getClass() != ImportReplace.class) : (mTask.getClass() != RepairCollectionn.class &amp;&amp; mTask.getClass() != ImportReplace.class)) &amp;&amp; CollectionHelper.getInstance().getColSafe(mContext) == null))) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12662)) {</span>
<span class="nc" id="L267">                    Timber.e(&quot;CollectionTask CollectionTask %s as Collection could not be opened&quot;, mTask.getClass());</span>
                }
<span class="nc" id="L269">                return null;</span>
            }
        }
        // Actually execute the task now that we are at the front of the queue.
<span class="nc" id="L273">        return mTask.task(getCol(), this);</span>
    }

    /**
     * Delegates to the {@link TaskListener} for this task.
     */
    @Override
    protected void onPreExecute() {
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12664)) {</span>
<span class="nc" id="L282">            super.onPreExecute();</span>
        }
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12666)) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (mListener != null) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12665)) {</span>
<span class="nc" id="L287">                    mListener.onPreExecute();</span>
                }
            }
        }
<span class="nc" id="L291">    }</span>

    /**
     * Delegates to the {@link TaskListener} for this task.
     */
    @Override
    protected void onProgressUpdate(ProgressBackground... values) {
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12667)) {</span>
<span class="nc" id="L299">            super.onProgressUpdate(values);</span>
        }
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12669)) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            if (mListener != null) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12668)) {</span>
<span class="nc" id="L304">                    mListener.onProgressUpdate(values[0]);</span>
                }
            }
        }
<span class="nc" id="L308">    }</span>

    /**
     * Delegates to the {@link TaskListener} for this task.
     */
    @Override
    protected void onPostExecute(ResultBackground result) {
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12670)) {</span>
<span class="nc" id="L316">            super.onPostExecute(result);</span>
        }
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12672)) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (mListener != null) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12671)) {</span>
<span class="nc" id="L321">                    mListener.onPostExecute(result);</span>
                }
            }
        }
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12673)) {</span>
<span class="nc" id="L326">            Timber.d(&quot;enabling garbage collection of mPreviousTask...&quot;);</span>
        }
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12674)) {</span>
<span class="nc" id="L329">            mPreviousTask = null;</span>
        }
<span class="nc" id="L331">    }</span>

    @Override
    protected void onCancelled() {
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12675)) {</span>
<span class="nc" id="L336">            TaskManager.removeTask(this);</span>
        }
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12677)) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (mListener != null) {</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12676)) {</span>
<span class="nc" id="L341">                    mListener.onCancelled();</span>
                }
            }
        }
<span class="nc" id="L345">    }</span>

    public static class AddNote extends Task&lt;Integer, Boolean&gt; {

        private final Note note;

<span class="nc" id="L351">        public AddNote(Note note) {</span>
<span class="nc" id="L352">            this.note = note;</span>
<span class="nc" id="L353">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Integer&gt; collectionTask) {
<span class="nc bnc" id="L356" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12678)) {</span>
<span class="nc" id="L357">                Timber.d(&quot;doInBackgroundAddNote&quot;);</span>
            }
            try {
<span class="nc" id="L360">                DB db = col.getDb();</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12681)) {</span>
<span class="nc" id="L362">                    db.executeInTransaction(() -&gt; {</span>
<span class="nc" id="L363">                        int value = col.addNote(note);</span>
<span class="nc" id="L364">                        collectionTask.doProgress(value);</span>
<span class="nc" id="L365">                    });</span>
                }
<span class="nc" id="L367">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12679)) {</span>
<span class="nc" id="L369">                    Timber.e(e, &quot;doInBackgroundAddNote - RuntimeException on adding note&quot;);</span>
                }
<span class="nc bnc" id="L371" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12680)) {</span>
<span class="nc" id="L372">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundAddNote&quot;);</span>
                }
<span class="nc" id="L374">                return false;</span>
<span class="nc" id="L375">            }</span>
<span class="nc" id="L376">            return true;</span>
        }
    }

    public static class UpdateNote extends Task&lt;PairWithCard&lt;String&gt;, BooleanGetter&gt; {

        private final Card editCard;

        private final boolean fromReviewer;

        private final boolean canAccessScheduler;

<span class="nc" id="L388">        public UpdateNote(Card editCard, boolean fromReviewer, boolean canAccessScheduler) {</span>
<span class="nc" id="L389">            this.editCard = editCard;</span>
<span class="nc" id="L390">            this.fromReviewer = fromReviewer;</span>
<span class="nc" id="L391">            this.canAccessScheduler = canAccessScheduler;</span>
<span class="nc" id="L392">        }</span>

        protected BooleanGetter task(Collection col, ProgressSenderAndCancelListener&lt;PairWithCard&lt;String&gt;&gt; collectionTask) {
<span class="nc bnc" id="L395" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12682)) {</span>
<span class="nc" id="L396">                Timber.d(&quot;doInBackgroundUpdateNote&quot;);</span>
            }
            // Save the note
<span class="nc" id="L399">            AbstractSched sched = col.getSched();</span>
<span class="nc" id="L400">            Note editNote = editCard.note();</span>
            try {
<span class="nc bnc" id="L402" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12685)) {</span>
<span class="nc" id="L403">                    col.getDb().executeInTransaction(() -&gt; {</span>
                        // TODO: undo integration
<span class="nc" id="L405">                        editNote.flush();</span>
                        // flush card too, in case, did has been changed
<span class="nc" id="L407">                        editCard.flush();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                        if (fromReviewer) {</span>
                            Card newCard;
<span class="nc bnc" id="L410" title="All 4 branches missed.">                            if (col.getDecks().active().contains(editCard.getDid()) || !canAccessScheduler) {</span>
<span class="nc" id="L411">                                newCard = editCard;</span>
<span class="nc" id="L412">                                newCard.load();</span>
                                // reload qa-cache
<span class="nc" id="L414">                                newCard.q(true);</span>
                            } else {
<span class="nc" id="L416">                                newCard = sched.getCard();</span>
                            }
                            // check: are there deleted too?
<span class="nc" id="L419">                            collectionTask.doProgress(new PairWithCard&lt;&gt;(newCard, null));</span>
<span class="nc" id="L420">                        } else {</span>
<span class="nc" id="L421">                            collectionTask.doProgress(new PairWithCard&lt;&gt;(editCard, editNote.stringTags()));</span>
                        }
<span class="nc" id="L423">                    });</span>
                }
<span class="nc" id="L425">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12683)) {</span>
<span class="nc" id="L427">                    Timber.e(e, &quot;doInBackgroundUpdateNote - RuntimeException on updating note&quot;);</span>
                }
<span class="nc bnc" id="L429" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12684)) {</span>
<span class="nc" id="L430">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundUpdateNote&quot;);</span>
                }
<span class="nc" id="L432">                return False;</span>
<span class="nc" id="L433">            }</span>
<span class="nc" id="L434">            return True;</span>
        }

        public boolean isFromReviewer() {
<span class="nc" id="L438">            return fromReviewer;</span>
        }
    }

<span class="nc" id="L442">    public static class GetCard extends Task&lt;Card, BooleanGetter&gt; {</span>

        protected BooleanGetter task(Collection col, ProgressSenderAndCancelListener&lt;Card&gt; collectionTask) {
<span class="nc" id="L445">            AbstractSched sched = col.getSched();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12686)) {</span>
<span class="nc" id="L447">                Timber.i(&quot;Obtaining card&quot;);</span>
            }
<span class="nc" id="L449">            Card newCard = sched.getCard();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12688)) {</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">                if (newCard != null) {</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12687)) {</span>
                        // render cards before locking database
<span class="nc" id="L454">                        newCard._getQA(true);</span>
                    }
                }
            }
<span class="nc bnc" id="L458" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12689)) {</span>
<span class="nc" id="L459">                collectionTask.doProgress(newCard);</span>
            }
<span class="nc" id="L461">            return True;</span>
        }
    }

    public static class AnswerAndGetCard extends GetCard {

        @NonNull
        private final Card oldCard;

        @Consts.BUTTON_TYPE
        private final int ease;

<span class="nc" id="L473">        public AnswerAndGetCard(@NonNull Card oldCard, @Consts.BUTTON_TYPE int ease) {</span>
<span class="nc" id="L474">            this.oldCard = oldCard;</span>
<span class="nc" id="L475">            this.ease = ease;</span>
<span class="nc" id="L476">        }</span>

        protected BooleanGetter task(Collection col, ProgressSenderAndCancelListener&lt;Card&gt; collectionTask) {
<span class="nc bnc" id="L479" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12690)) {</span>
<span class="nc" id="L480">                Timber.i(&quot;Answering card %d&quot;, oldCard.getId());</span>
            }
<span class="nc bnc" id="L482" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12691)) {</span>
<span class="nc" id="L483">                col.getSched().answerCard(oldCard, ease);</span>
            }
<span class="nc" id="L485">            return super.task(col, collectionTask);</span>
        }
    }

<span class="nc" id="L489">    public static class LoadDeck extends Task&lt;Void, List&lt;DeckTreeNode&gt;&gt; {</span>

        protected List&lt;DeckTreeNode&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L492" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12692)) {</span>
<span class="nc" id="L493">                Timber.d(&quot;doInBackgroundLoadDeckCounts&quot;);</span>
            }
            try {
                // Get due tree
<span class="nc" id="L497">                return col.getSched().quickDeckDueTree();</span>
<span class="nc" id="L498">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12693)) {</span>
<span class="nc" id="L500">                    Timber.w(e, &quot;doInBackgroundLoadDeckCounts - error&quot;);</span>
                }
<span class="nc" id="L502">                return null;</span>
            }
        }
    }

<span class="nc" id="L507">    public static class LoadDeckCounts extends Task&lt;Void, List&lt;DeckDueTreeNode&gt;&gt; {</span>

        protected List&lt;DeckDueTreeNode&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L510" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12694)) {</span>
<span class="nc" id="L511">                Timber.d(&quot;doInBackgroundLoadDeckCounts&quot;);</span>
            }
            try {
                // Get due tree
<span class="nc" id="L515">                return col.getSched().deckDueTree(collectionTask);</span>
<span class="nc" id="L516">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12695)) {</span>
<span class="nc" id="L518">                    Timber.e(e, &quot;doInBackgroundLoadDeckCounts - error&quot;);</span>
                }
<span class="nc" id="L520">                return null;</span>
            }
        }
    }

    public static class SaveCollection extends Task&lt;Void, Void&gt; {

        private final boolean syncIgnoresDatabaseModification;

<span class="nc" id="L529">        public SaveCollection(boolean syncIgnoresDatabaseModification) {</span>
<span class="nc" id="L530">            this.syncIgnoresDatabaseModification = syncIgnoresDatabaseModification;</span>
<span class="nc" id="L531">        }</span>

        protected Void task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12696)) {</span>
<span class="nc" id="L535">                Timber.d(&quot;doInBackgroundSaveCollection&quot;);</span>
            }
<span class="nc bnc" id="L537" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12701)) {</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                if (col != null) {</span>
                    try {
<span class="nc bnc" id="L540" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12700)) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                            if (syncIgnoresDatabaseModification) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12699)) {</span>
<span class="nc" id="L543">                                    SyncStatus.ignoreDatabaseModification(col::save);</span>
                                }
                            } else {
<span class="nc bnc" id="L546" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12698)) {</span>
<span class="nc" id="L547">                                    col.save();</span>
                                }
                            }
                        }
<span class="nc" id="L551">                    } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12697)) {</span>
<span class="nc" id="L553">                            Timber.e(e, &quot;Error on saving deck in background&quot;);</span>
                        }
<span class="nc" id="L555">                    }</span>
                }
            }
<span class="nc" id="L558">            return null;</span>
        }
    }

    private static class UndoSuspendCard extends Undoable {

        private final Card suspendedCard;

        public UndoSuspendCard(Card suspendedCard) {
<span class="nc" id="L567">            super(Collection.DismissType.SUSPEND_CARD);</span>
<span class="nc" id="L568">            this.suspendedCard = suspendedCard;</span>
<span class="nc" id="L569">        }</span>

        @Nullable
        public Card undo(@NonNull Collection col) {
<span class="nc bnc" id="L573" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12702)) {</span>
<span class="nc" id="L574">                Timber.i(&quot;UNDO: Suspend Card %d&quot;, suspendedCard.getId());</span>
            }
<span class="nc bnc" id="L576" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12703)) {</span>
<span class="nc" id="L577">                suspendedCard.flush(false);</span>
            }
<span class="nc" id="L579">            return suspendedCard;</span>
        }
    }

    private static class UndoDeleteNote extends Undoable {

        private final Note note;

        private final ArrayList&lt;Card&gt; allCs;

        @NonNull
        private final Card card;

        public UndoDeleteNote(Note note, ArrayList&lt;Card&gt; allCs, @NonNull Card card) {
<span class="nc" id="L593">            super(Collection.DismissType.DELETE_NOTE);</span>
<span class="nc" id="L594">            this.note = note;</span>
<span class="nc" id="L595">            this.allCs = allCs;</span>
<span class="nc" id="L596">            this.card = card;</span>
<span class="nc" id="L597">        }</span>

        @Nullable
        public Card undo(@NonNull Collection col) {
<span class="nc bnc" id="L601" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12704)) {</span>
<span class="nc" id="L602">                Timber.i(&quot;Undo: Delete note&quot;);</span>
            }
<span class="nc bnc" id="L604" title="All 8 branches missed.">            ArrayList&lt;Long&gt; ids = new ArrayList&lt;&gt;((ListenerUtil.mutListener.listen(12708) ? (allCs.size() % 1) : (ListenerUtil.mutListener.listen(12707) ? (allCs.size() / 1) : (ListenerUtil.mutListener.listen(12706) ? (allCs.size() * 1) : (ListenerUtil.mutListener.listen(12705) ? (allCs.size() - 1) : (allCs.size() + 1))))));</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12709)) {</span>
<span class="nc" id="L606">                note.flush(note.getMod(), false);</span>
            }
<span class="nc bnc" id="L608" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12710)) {</span>
<span class="nc" id="L609">                ids.add(note.getId());</span>
            }
<span class="nc bnc" id="L611" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12713)) {</span>
                {
<span class="nc" id="L613">                    long _loopCounter204 = 0;</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                    for (Card c : allCs) {</span>
<span class="nc" id="L615">                        ListenerUtil.loopListener.listen(&quot;_loopCounter204&quot;, ++_loopCounter204);</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12711)) {</span>
<span class="nc" id="L617">                            c.flush(false);</span>
                        }
<span class="nc bnc" id="L619" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12712)) {</span>
<span class="nc" id="L620">                            ids.add(c.getId());</span>
                        }
<span class="nc" id="L622">                    }</span>
                }
            }
<span class="nc bnc" id="L625" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12714)) {</span>
<span class="nc" id="L626">                col.getDb().execute(&quot;DELETE FROM graves WHERE oid IN &quot; + Utils.ids2str(ids));</span>
            }
<span class="nc" id="L628">            return card;</span>
        }
    }

    public static class DismissNote extends Task&lt;Card, BooleanGetter&gt; {

        private final Card card;

        private final Collection.DismissType type;

<span class="nc" id="L638">        public DismissNote(Card card, Collection.DismissType type) {</span>
<span class="nc" id="L639">            this.card = card;</span>
<span class="nc" id="L640">            this.type = type;</span>
<span class="nc" id="L641">        }</span>

        protected BooleanGetter task(Collection col, ProgressSenderAndCancelListener&lt;Card&gt; collectionTask) {
<span class="nc" id="L644">            AbstractSched sched = col.getSched();</span>
<span class="nc" id="L645">            Note note = card.note();</span>
            try {
<span class="nc bnc" id="L647" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12717)) {</span>
<span class="nc" id="L648">                    col.getDb().executeInTransaction(() -&gt; {</span>
<span class="nc" id="L649">                        sched.deferReset();</span>
<span class="nc bnc" id="L650" title="All 6 branches missed.">                        switch(type) {</span>
                            case BURY_CARD:
                                // collect undo information
<span class="nc" id="L653">                                col.markUndo(revertToProvidedState(BURY_CARD, card));</span>
                                // then bury
<span class="nc" id="L655">                                sched.buryCards(new long[] { card.getId() });</span>
<span class="nc" id="L656">                                break;</span>
                            case BURY_NOTE:
                                // collect undo information
<span class="nc" id="L659">                                col.markUndo(revertToProvidedState(BURY_NOTE, card));</span>
                                // then bury
<span class="nc" id="L661">                                sched.buryNote(note.getId());</span>
<span class="nc" id="L662">                                break;</span>
                            case SUSPEND_CARD:
                                // collect undo information
<span class="nc" id="L665">                                Card suspendedCard = card.clone();</span>
<span class="nc" id="L666">                                col.markUndo(new UndoSuspendCard(suspendedCard));</span>
                                // suspend card
<span class="nc bnc" id="L668" title="All 2 branches missed.">                                if (card.getQueue() == Consts.QUEUE_TYPE_SUSPENDED) {</span>
<span class="nc" id="L669">                                    sched.unsuspendCards(new long[] { card.getId() });</span>
                                } else {
<span class="nc" id="L671">                                    sched.suspendCards(new long[] { card.getId() });</span>
                                }
<span class="nc" id="L673">                                break;</span>
                            case SUSPEND_NOTE:
                                {
                                    // collect undo information
<span class="nc" id="L677">                                    ArrayList&lt;Card&gt; cards = note.cards();</span>
<span class="nc" id="L678">                                    long[] cids = new long[cards.size()];</span>
                                    {
<span class="nc" id="L680">                                        long _loopCounter205 = 0;</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                                        for (int i = 0; i &lt; cards.size(); i++) {</span>
<span class="nc" id="L682">                                            ListenerUtil.loopListener.listen(&quot;_loopCounter205&quot;, ++_loopCounter205);</span>
<span class="nc" id="L683">                                            cids[i] = cards.get(i).getId();</span>
                                        }
                                    }
<span class="nc" id="L686">                                    col.markUndo(revertToProvidedState(SUSPEND_NOTE, card));</span>
                                    // suspend note
<span class="nc" id="L688">                                    sched.suspendCards(cids);</span>
<span class="nc" id="L689">                                    break;</span>
                                }
                            case DELETE_NOTE:
                                {
                                    // collect undo information
<span class="nc" id="L694">                                    ArrayList&lt;Card&gt; allCs = note.cards();</span>
<span class="nc" id="L695">                                    col.markUndo(new UndoDeleteNote(note, allCs, card));</span>
                                    // delete note
<span class="nc" id="L697">                                    col.remNotes(new long[] { note.getId() });</span>
<span class="nc" id="L698">                                    break;</span>
                                }
                        }
                        // With sHadCardQueue set, getCard() resets the scheduler prior to getting the next card
<span class="nc" id="L702">                        collectionTask.doProgress(col.getSched().getCard());</span>
<span class="nc" id="L703">                    });</span>
                }
<span class="nc" id="L705">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12715)) {</span>
<span class="nc" id="L707">                    Timber.e(e, &quot;doInBackgroundDismissNote - RuntimeException on dismissing note, dismiss type %s&quot;, type);</span>
                }
<span class="nc bnc" id="L709" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12716)) {</span>
<span class="nc" id="L710">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundDismissNote&quot;);</span>
                }
<span class="nc" id="L712">                return False;</span>
<span class="nc" id="L713">            }</span>
<span class="nc" id="L714">            return True;</span>
        }
    }

    protected static class UndoSuspendCardMulti extends Undoable {

        private final Card[] cards;

        private final boolean[] originalSuspended;

        /**
         * @param hasUnsuspended  whether there were any unsuspended card (in which card the action was &quot;Suspend&quot;,
         *                          otherwise the action was &quot;Unsuspend&quot;)
         */
        public UndoSuspendCardMulti(Card[] cards, boolean[] originalSuspended, boolean hasUnsuspended) {
<span class="nc bnc" id="L729" title="All 2 branches missed.">            super((hasUnsuspended) ? Collection.DismissType.SUSPEND_CARD_MULTI : Collection.DismissType.UNSUSPEND_CARD_MULTI);</span>
<span class="nc" id="L730">            this.cards = cards;</span>
<span class="nc" id="L731">            this.originalSuspended = originalSuspended;</span>
<span class="nc" id="L732">        }</span>

        @Nullable
        public Card undo(@NonNull Collection col) {
<span class="nc bnc" id="L736" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12718)) {</span>
<span class="nc" id="L737">                Timber.i(&quot;Undo: Suspend multiple cards&quot;);</span>
            }
<span class="nc" id="L739">            int nbOfCards = cards.length;</span>
<span class="nc" id="L740">            List&lt;Long&gt; toSuspendIds = new ArrayList&lt;&gt;(nbOfCards);</span>
<span class="nc" id="L741">            List&lt;Long&gt; toUnsuspendIds = new ArrayList&lt;&gt;(nbOfCards);</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12727)) {</span>
                {
<span class="nc" id="L744">                    long _loopCounter206 = 0;</span>
<span class="nc bnc" id="L745" title="All 22 branches missed.">                    for (int i = 0; (ListenerUtil.mutListener.listen(12726) ? (i &gt;= nbOfCards) : (ListenerUtil.mutListener.listen(12725) ? (i &lt;= nbOfCards) : (ListenerUtil.mutListener.listen(12724) ? (i &gt; nbOfCards) : (ListenerUtil.mutListener.listen(12723) ? (i != nbOfCards) : (ListenerUtil.mutListener.listen(12722) ? (i == nbOfCards) : (i &lt; nbOfCards)))))); i++) {</span>
<span class="nc" id="L746">                        ListenerUtil.loopListener.listen(&quot;_loopCounter206&quot;, ++_loopCounter206);</span>
<span class="nc" id="L747">                        Card card = cards[i];</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12721)) {</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">                            if (originalSuspended[i]) {</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12720)) {</span>
<span class="nc" id="L751">                                    toSuspendIds.add(card.getId());</span>
                                }
                            } else {
<span class="nc bnc" id="L754" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12719)) {</span>
<span class="nc" id="L755">                                    toUnsuspendIds.add(card.getId());</span>
                                }
                            }
                        }
                    }
                }
            }
            // unboxing
<span class="nc" id="L763">            long[] toSuspendIdsArray = new long[toSuspendIds.size()];</span>
<span class="nc" id="L764">            long[] toUnsuspendIdsArray = new long[toUnsuspendIds.size()];</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12734)) {</span>
                {
<span class="nc" id="L767">                    long _loopCounter207 = 0;</span>
<span class="nc bnc" id="L768" title="All 22 branches missed.">                    for (int i = 0; (ListenerUtil.mutListener.listen(12733) ? (i &gt;= toSuspendIds.size()) : (ListenerUtil.mutListener.listen(12732) ? (i &lt;= toSuspendIds.size()) : (ListenerUtil.mutListener.listen(12731) ? (i &gt; toSuspendIds.size()) : (ListenerUtil.mutListener.listen(12730) ? (i != toSuspendIds.size()) : (ListenerUtil.mutListener.listen(12729) ? (i == toSuspendIds.size()) : (i &lt; toSuspendIds.size())))))); i++) {</span>
<span class="nc" id="L769">                        ListenerUtil.loopListener.listen(&quot;_loopCounter207&quot;, ++_loopCounter207);</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12728)) {</span>
<span class="nc" id="L771">                            toSuspendIdsArray[i] = toSuspendIds.get(i);</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L776" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12741)) {</span>
                {
<span class="nc" id="L778">                    long _loopCounter208 = 0;</span>
<span class="nc bnc" id="L779" title="All 22 branches missed.">                    for (int i = 0; (ListenerUtil.mutListener.listen(12740) ? (i &gt;= toUnsuspendIds.size()) : (ListenerUtil.mutListener.listen(12739) ? (i &lt;= toUnsuspendIds.size()) : (ListenerUtil.mutListener.listen(12738) ? (i &gt; toUnsuspendIds.size()) : (ListenerUtil.mutListener.listen(12737) ? (i != toUnsuspendIds.size()) : (ListenerUtil.mutListener.listen(12736) ? (i == toUnsuspendIds.size()) : (i &lt; toUnsuspendIds.size())))))); i++) {</span>
<span class="nc" id="L780">                        ListenerUtil.loopListener.listen(&quot;_loopCounter208&quot;, ++_loopCounter208);</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12735)) {</span>
<span class="nc" id="L782">                            toUnsuspendIdsArray[i] = toUnsuspendIds.get(i);</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L787" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12742)) {</span>
<span class="nc" id="L788">                col.getSched().suspendCards(toSuspendIdsArray);</span>
            }
<span class="nc bnc" id="L790" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12743)) {</span>
<span class="nc" id="L791">                col.getSched().unsuspendCards(toUnsuspendIdsArray);</span>
            }
            // don't fetch new card
<span class="nc" id="L794">            return null;</span>
        }
    }

    private static class UndoDeleteNoteMulti extends Undoable {

        private final Note[] notesArr;

        private final List&lt;Card&gt; allCards;

        public UndoDeleteNoteMulti(Note[] notesArr, List&lt;Card&gt; allCards) {
<span class="nc" id="L805">            super(Collection.DismissType.DELETE_NOTE_MULTI);</span>
<span class="nc" id="L806">            this.notesArr = notesArr;</span>
<span class="nc" id="L807">            this.allCards = allCards;</span>
<span class="nc" id="L808">        }</span>

        @Nullable
        public Card undo(@NonNull Collection col) {
<span class="nc bnc" id="L812" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12744)) {</span>
<span class="nc" id="L813">                Timber.i(&quot;Undo: Delete notes&quot;);</span>
            }
            // undo all of these at once instead of one-by-one
<span class="nc bnc" id="L816" title="All 8 branches missed.">            ArrayList&lt;Long&gt; ids = new ArrayList&lt;&gt;((ListenerUtil.mutListener.listen(12748) ? (notesArr.length % allCards.size()) : (ListenerUtil.mutListener.listen(12747) ? (notesArr.length / allCards.size()) : (ListenerUtil.mutListener.listen(12746) ? (notesArr.length * allCards.size()) : (ListenerUtil.mutListener.listen(12745) ? (notesArr.length - allCards.size()) : (notesArr.length + allCards.size()))))));</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12751)) {</span>
                {
<span class="nc" id="L819">                    long _loopCounter209 = 0;</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">                    for (Note n : notesArr) {</span>
<span class="nc" id="L821">                        ListenerUtil.loopListener.listen(&quot;_loopCounter209&quot;, ++_loopCounter209);</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12749)) {</span>
<span class="nc" id="L823">                            n.flush(n.getMod(), false);</span>
                        }
<span class="nc bnc" id="L825" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12750)) {</span>
<span class="nc" id="L826">                            ids.add(n.getId());</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L831" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12754)) {</span>
                {
<span class="nc" id="L833">                    long _loopCounter210 = 0;</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                    for (Card c : allCards) {</span>
<span class="nc" id="L835">                        ListenerUtil.loopListener.listen(&quot;_loopCounter210&quot;, ++_loopCounter210);</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12752)) {</span>
<span class="nc" id="L837">                            c.flush(false);</span>
                        }
<span class="nc bnc" id="L839" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12753)) {</span>
<span class="nc" id="L840">                            ids.add(c.getId());</span>
                        }
<span class="nc" id="L842">                    }</span>
                }
            }
<span class="nc bnc" id="L845" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12755)) {</span>
<span class="nc" id="L846">                col.getDb().execute(&quot;DELETE FROM graves WHERE oid IN &quot; + Utils.ids2str(ids));</span>
            }
            // don't fetch new card
<span class="nc" id="L849">            return null;</span>
        }
    }

    private static class UndoChangeDeckMulti extends Undoable {

        private final Card[] cards;

        private final long[] originalDids;

        public UndoChangeDeckMulti(Card[] cards, long[] originalDids) {
<span class="nc" id="L860">            super(Collection.DismissType.CHANGE_DECK_MULTI);</span>
<span class="nc" id="L861">            this.cards = cards;</span>
<span class="nc" id="L862">            this.originalDids = originalDids;</span>
<span class="nc" id="L863">        }</span>

        @Nullable
        public Card undo(@NonNull Collection col) {
<span class="nc bnc" id="L867" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12756)) {</span>
<span class="nc" id="L868">                Timber.i(&quot;Undo: Change Decks&quot;);</span>
            }
<span class="nc bnc" id="L870" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12766)) {</span>
                {
<span class="nc" id="L872">                    long _loopCounter211 = 0;</span>
                    // move cards to original deck
<span class="nc bnc" id="L874" title="All 22 branches missed.">                    for (int i = 0; (ListenerUtil.mutListener.listen(12765) ? (i &gt;= cards.length) : (ListenerUtil.mutListener.listen(12764) ? (i &lt;= cards.length) : (ListenerUtil.mutListener.listen(12763) ? (i &gt; cards.length) : (ListenerUtil.mutListener.listen(12762) ? (i != cards.length) : (ListenerUtil.mutListener.listen(12761) ? (i == cards.length) : (i &lt; cards.length)))))); i++) {</span>
<span class="nc" id="L875">                        ListenerUtil.loopListener.listen(&quot;_loopCounter211&quot;, ++_loopCounter211);</span>
<span class="nc" id="L876">                        Card card = cards[i];</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12757)) {</span>
<span class="nc" id="L878">                            card.load();</span>
                        }
<span class="nc bnc" id="L880" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12758)) {</span>
<span class="nc" id="L881">                            card.setDid(originalDids[i]);</span>
                        }
<span class="nc" id="L883">                        Note note = card.note();</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12759)) {</span>
<span class="nc" id="L885">                            note.flush();</span>
                        }
<span class="nc bnc" id="L887" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12760)) {</span>
<span class="nc" id="L888">                            card.flush();</span>
                        }
                    }
                }
            }
            // don't fetch new card
<span class="nc" id="L894">            return null;</span>
        }
    }

    private static class UndoMarkNoteMulti extends Undoable {

        private final List&lt;Note&gt; originalMarked;

        private final List&lt;Note&gt; originalUnmarked;

        /**
         * @param hasUnmarked whether there were any unmarked card (in which card the action was &quot;mark&quot;,
         *                      otherwise the action was &quot;Unmark&quot;)
         */
        public UndoMarkNoteMulti(List&lt;Note&gt; originalMarked, List&lt;Note&gt; originalUnmarked, boolean hasUnmarked) {
<span class="nc bnc" id="L909" title="All 2 branches missed.">            super((hasUnmarked) ? Collection.DismissType.MARK_NOTE_MULTI : Collection.DismissType.UNMARK_NOTE_MULTI);</span>
<span class="nc" id="L910">            this.originalMarked = originalMarked;</span>
<span class="nc" id="L911">            this.originalUnmarked = originalUnmarked;</span>
<span class="nc" id="L912">        }</span>

        @Nullable
        public Card undo(@NonNull Collection col) {
<span class="nc bnc" id="L916" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12767)) {</span>
<span class="nc" id="L917">                Timber.i(&quot;Undo: Mark notes&quot;);</span>
            }
<span class="nc bnc" id="L919" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12768)) {</span>
<span class="nc" id="L920">                CardUtils.markAll(originalMarked, true);</span>
            }
<span class="nc bnc" id="L922" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12769)) {</span>
<span class="nc" id="L923">                CardUtils.markAll(originalUnmarked, false);</span>
            }
            // don't fetch new card
<span class="nc" id="L926">            return null;</span>
        }
    }

    private static class UndoRepositionRescheduleResetCards extends Undoable {

        private final Card[] cards_copied;

        public UndoRepositionRescheduleResetCards(Collection.DismissType type, Card[] cards_copied) {
<span class="nc" id="L935">            super(type);</span>
<span class="nc" id="L936">            this.cards_copied = cards_copied;</span>
<span class="nc" id="L937">        }</span>

        @Nullable
        public Card undo(@NonNull Collection col) {
<span class="nc bnc" id="L941" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12770)) {</span>
<span class="nc" id="L942">                Timber.i(&quot;Undoing action of type %s on %d cards&quot;, getDismissType(), cards_copied.length);</span>
            }
<span class="nc bnc" id="L944" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12772)) {</span>
                {
<span class="nc" id="L946">                    long _loopCounter212 = 0;</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">                    for (Card card : cards_copied) {</span>
<span class="nc" id="L948">                        ListenerUtil.loopListener.listen(&quot;_loopCounter212&quot;, ++_loopCounter212);</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12771)) {</span>
<span class="nc" id="L950">                            card.flush(false);</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L955" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12773)) {</span>
                // new card */
<span class="nc" id="L957">                Timber.d(&quot;Single card non-review change undo succeeded&quot;);</span>
            }
<span class="nc bnc" id="L959" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12774)) {</span>
<span class="nc" id="L960">                col.reset();</span>
            }
<span class="nc" id="L962">            return col.getSched().getCard();</span>
        }
    }

    private abstract static class DismissNotes&lt;Progress&gt; extends Task&lt;Progress, PairWithBoolean&lt;Card[]&gt;&gt; {

        protected final List&lt;Long&gt; mCardIds;

<span class="nc" id="L970">        public DismissNotes(List&lt;Long&gt; cardIds) {</span>
<span class="nc" id="L971">            this.mCardIds = cardIds;</span>
<span class="nc" id="L972">        }</span>

        protected PairWithBoolean&lt;Card[]&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Progress&gt; collectionTask) {
            // query cards
<span class="nc" id="L976">            Card[] cards = new Card[mCardIds.size()];</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12781)) {</span>
                {
<span class="nc" id="L979">                    long _loopCounter213 = 0;</span>
<span class="nc bnc" id="L980" title="All 22 branches missed.">                    for (int i = 0; (ListenerUtil.mutListener.listen(12780) ? (i &gt;= mCardIds.size()) : (ListenerUtil.mutListener.listen(12779) ? (i &lt;= mCardIds.size()) : (ListenerUtil.mutListener.listen(12778) ? (i &gt; mCardIds.size()) : (ListenerUtil.mutListener.listen(12777) ? (i != mCardIds.size()) : (ListenerUtil.mutListener.listen(12776) ? (i == mCardIds.size()) : (i &lt; mCardIds.size())))))); i++) {</span>
<span class="nc" id="L981">                        ListenerUtil.loopListener.listen(&quot;_loopCounter213&quot;, ++_loopCounter213);</span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12775)) {</span>
<span class="nc" id="L983">                            cards[i] = col.getCard(mCardIds.get(i));</span>
                        }
                    }
                }
            }
            try {
<span class="nc bnc" id="L989" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12784)) {</span>
<span class="nc" id="L990">                    col.getDb().getDatabase().beginTransaction();</span>
                }
                try {
<span class="nc" id="L993">                    PairWithBoolean&lt;Card[]&gt; ret = actualTask(col, collectionTask, cards);</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12786)) {</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">                        if (ret != null) {</span>
<span class="nc" id="L996">                            return ret;</span>
                        }
                    }
<span class="nc bnc" id="L999" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12787)) {</span>
<span class="nc" id="L1000">                        col.getDb().getDatabase().setTransactionSuccessful();</span>
                    }
                } finally {
<span class="nc bnc" id="L1003" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12785)) {</span>
<span class="nc" id="L1004">                        DB.safeEndInTransaction(col.getDb());</span>
                    }
                }
<span class="nc" id="L1007">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12782)) {</span>
<span class="nc" id="L1009">                    Timber.e(e, &quot;doInBackgroundSuspendCard - RuntimeException on suspending card&quot;);</span>
                }
<span class="nc bnc" id="L1011" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12783)) {</span>
<span class="nc" id="L1012">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundSuspendCard&quot;);</span>
                }
<span class="nc" id="L1014">                return new PairWithBoolean&lt;&gt;(false, null);</span>
<span class="nc" id="L1015">            }</span>
            // (querying the cards again is unnecessarily expensive)
<span class="nc" id="L1017">            return new PairWithBoolean&lt;&gt;(true, cards);</span>
        }

        /**
         * @param col The collection
         * @param collectionTask, where to send progress and listen for cancellation
         * @param cards Cards to which the task should be applied
         * @return value to return, or null if `task` should deal with it directly.
         */
        protected abstract PairWithBoolean&lt;Card[]&gt; actualTask(Collection col, ProgressSenderAndCancelListener&lt;Progress&gt; collectionTask, Card[] cards);
    }

    public static class SuspendCardMulti extends DismissNotes&lt;Void&gt; {

        public SuspendCardMulti(List&lt;Long&gt; cardIds) {
<span class="nc" id="L1032">            super(cardIds);</span>
<span class="nc" id="L1033">        }</span>

        protected PairWithBoolean&lt;Card[]&gt; actualTask(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask, Card[] cards) {
<span class="nc" id="L1036">            AbstractSched sched = col.getSched();</span>
            // collect undo information
<span class="nc" id="L1038">            long[] cids = new long[cards.length];</span>
<span class="nc" id="L1039">            boolean[] originalSuspended = new boolean[cards.length];</span>
<span class="nc" id="L1040">            boolean hasUnsuspended = false;</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12803)) {</span>
                {
<span class="nc" id="L1043">                    long _loopCounter214 = 0;</span>
<span class="nc bnc" id="L1044" title="All 22 branches missed.">                    for (int i = 0; (ListenerUtil.mutListener.listen(12802) ? (i &gt;= cards.length) : (ListenerUtil.mutListener.listen(12801) ? (i &lt;= cards.length) : (ListenerUtil.mutListener.listen(12800) ? (i &gt; cards.length) : (ListenerUtil.mutListener.listen(12799) ? (i != cards.length) : (ListenerUtil.mutListener.listen(12798) ? (i == cards.length) : (i &lt; cards.length)))))); i++) {</span>
<span class="nc" id="L1045">                        ListenerUtil.loopListener.listen(&quot;_loopCounter214&quot;, ++_loopCounter214);</span>
<span class="nc" id="L1046">                        Card card = cards[i];</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12788)) {</span>
<span class="nc" id="L1048">                            cids[i] = card.getId();</span>
                        }
<span class="nc bnc" id="L1050" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12797)) {</span>
<span class="nc bnc" id="L1051" title="All 22 branches missed.">                            if ((ListenerUtil.mutListener.listen(12793) ? (card.getQueue() &gt;= Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(12792) ? (card.getQueue() &lt;= Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(12791) ? (card.getQueue() &gt; Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(12790) ? (card.getQueue() &lt; Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(12789) ? (card.getQueue() == Consts.QUEUE_TYPE_SUSPENDED) : (card.getQueue() != Consts.QUEUE_TYPE_SUSPENDED))))))) {</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12795)) {</span>
<span class="nc" id="L1053">                                    hasUnsuspended = true;</span>
                                }
<span class="nc bnc" id="L1055" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12796)) {</span>
<span class="nc" id="L1056">                                    originalSuspended[i] = false;</span>
                                }
                            } else {
<span class="nc bnc" id="L1059" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12794)) {</span>
<span class="nc" id="L1060">                                    originalSuspended[i] = true;</span>
                                }
                            }
                        }
                    }
                }
            }
<span class="nc bnc" id="L1067" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12806)) {</span>
                // otherwise unsuspend all
<span class="nc bnc" id="L1069" title="All 2 branches missed.">                if (hasUnsuspended) {</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12805)) {</span>
<span class="nc" id="L1071">                        sched.suspendCards(cids);</span>
                    }
                } else {
<span class="nc bnc" id="L1074" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12804)) {</span>
<span class="nc" id="L1075">                        sched.unsuspendCards(cids);</span>
                    }
                }
            }
<span class="nc bnc" id="L1079" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12807)) {</span>
                // mark undo for all at once
<span class="nc" id="L1081">                col.markUndo(new UndoSuspendCardMulti(cards, originalSuspended, hasUnsuspended));</span>
            }
<span class="nc bnc" id="L1083" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12809)) {</span>
                {
<span class="nc" id="L1085">                    long _loopCounter215 = 0;</span>
                    // reload cards because they'll be passed back to caller
<span class="nc bnc" id="L1087" title="All 2 branches missed.">                    for (Card c : cards) {</span>
<span class="nc" id="L1088">                        ListenerUtil.loopListener.listen(&quot;_loopCounter215&quot;, ++_loopCounter215);</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12808)) {</span>
<span class="nc" id="L1090">                            c.load();</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L1095" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12810)) {</span>
<span class="nc" id="L1096">                sched.deferReset();</span>
            }
<span class="nc" id="L1098">            return null;</span>
        }
    }

    public static class Flag extends DismissNotes&lt;Void&gt; {

        private final int mFlag;

        public Flag(List&lt;Long&gt; cardIds, int flag) {
<span class="nc" id="L1107">            super(cardIds);</span>
<span class="nc" id="L1108">            mFlag = flag;</span>
<span class="nc" id="L1109">        }</span>

        protected PairWithBoolean&lt;Card[]&gt; actualTask(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask, Card[] cards) {
<span class="nc bnc" id="L1112" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12811)) {</span>
<span class="nc" id="L1113">                col.setUserFlag(mFlag, mCardIds);</span>
            }
<span class="nc bnc" id="L1115" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12813)) {</span>
                {
<span class="nc" id="L1117">                    long _loopCounter216 = 0;</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">                    for (Card c : cards) {</span>
<span class="nc" id="L1119">                        ListenerUtil.loopListener.listen(&quot;_loopCounter216&quot;, ++_loopCounter216);</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12812)) {</span>
<span class="nc" id="L1121">                            c.load();</span>
                        }
                    }
                }
            }
<span class="nc" id="L1126">            return null;</span>
        }
    }

    public static class MarkNoteMulti extends DismissNotes&lt;Void&gt; {

        public MarkNoteMulti(List&lt;Long&gt; cardIds) {
<span class="nc" id="L1133">            super(cardIds);</span>
<span class="nc" id="L1134">        }</span>

        protected PairWithBoolean&lt;Card[]&gt; actualTask(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask, Card[] cards) {
<span class="nc" id="L1137">            Set&lt;Note&gt; notes = CardUtils.getNotes(Arrays.asList(cards));</span>
            // collect undo information
<span class="nc" id="L1139">            List&lt;Note&gt; originalMarked = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1140">            List&lt;Note&gt; originalUnmarked = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1141" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12817)) {</span>
                {
<span class="nc" id="L1143">                    long _loopCounter217 = 0;</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">                    for (Note n : notes) {</span>
<span class="nc" id="L1145">                        ListenerUtil.loopListener.listen(&quot;_loopCounter217&quot;, ++_loopCounter217);</span>
<span class="nc bnc" id="L1146" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12816)) {</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">                            if (n.hasTag(&quot;marked&quot;)) {</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12815)) {</span>
<span class="nc" id="L1149">                                    originalMarked.add(n);</span>
                                }
                            } else {
<span class="nc bnc" id="L1152" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12814)) {</span>
<span class="nc" id="L1153">                                    originalUnmarked.add(n);</span>
                                }
                            }
                        }
<span class="nc" id="L1157">                    }</span>
                }
            }
<span class="nc bnc" id="L1160" title="All 2 branches missed.">            boolean hasUnmarked = !originalUnmarked.isEmpty();</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12818)) {</span>
<span class="nc" id="L1162">                CardUtils.markAll(new ArrayList&lt;&gt;(notes), hasUnmarked);</span>
            }
<span class="nc" id="L1164">            Undoable markNoteMulti = new UndoMarkNoteMulti(originalMarked, originalUnmarked, hasUnmarked);</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12819)) {</span>
                // mark undo for all at once
<span class="nc" id="L1167">                col.markUndo(new UndoMarkNoteMulti(originalMarked, originalUnmarked, hasUnmarked));</span>
            }
<span class="nc bnc" id="L1169" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12821)) {</span>
                {
<span class="nc" id="L1171">                    long _loopCounter218 = 0;</span>
                    // reload cards because they'll be passed back to caller
<span class="nc bnc" id="L1173" title="All 2 branches missed.">                    for (Card c : cards) {</span>
<span class="nc" id="L1174">                        ListenerUtil.loopListener.listen(&quot;_loopCounter218&quot;, ++_loopCounter218);</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12820)) {</span>
<span class="nc" id="L1176">                            c.load();</span>
                        }
                    }
                }
            }
<span class="nc" id="L1181">            return null;</span>
        }
    }

    public static class DeleteNoteMulti extends DismissNotes&lt;Card[]&gt; {

        public DeleteNoteMulti(List&lt;Long&gt; cardIds) {
<span class="nc" id="L1188">            super(cardIds);</span>
<span class="nc" id="L1189">        }</span>

        protected PairWithBoolean&lt;Card[]&gt; actualTask(Collection col, ProgressSenderAndCancelListener&lt;Card[]&gt; collectionTask, Card[] cards) {
<span class="nc" id="L1192">            AbstractSched sched = col.getSched();</span>
            // Need Set (-&gt; unique) so we don't pass duplicates to col.remNotes()
<span class="nc" id="L1194">            Set&lt;Note&gt; notes = CardUtils.getNotes(Arrays.asList(cards));</span>
<span class="nc" id="L1195">            List&lt;Card&gt; allCards = CardUtils.getAllCards(notes);</span>
            // delete note
<span class="nc" id="L1197">            long[] uniqueNoteIds = new long[notes.size()];</span>
<span class="nc" id="L1198">            Note[] notesArr = notes.toArray(new Note[notes.size()]);</span>
<span class="nc" id="L1199">            int count = 0;</span>
<span class="nc bnc" id="L1200" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12824)) {</span>
                {
<span class="nc" id="L1202">                    long _loopCounter219 = 0;</span>
<span class="nc bnc" id="L1203" title="All 2 branches missed.">                    for (Note note : notes) {</span>
<span class="nc" id="L1204">                        ListenerUtil.loopListener.listen(&quot;_loopCounter219&quot;, ++_loopCounter219);</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12822)) {</span>
<span class="nc" id="L1206">                            uniqueNoteIds[count] = note.getId();</span>
                        }
<span class="nc bnc" id="L1208" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12823)) {</span>
<span class="nc" id="L1209">                            count++;</span>
                        }
<span class="nc" id="L1211">                    }</span>
                }
            }
<span class="nc bnc" id="L1214" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12825)) {</span>
<span class="nc" id="L1215">                col.markUndo(new UndoDeleteNoteMulti(notesArr, allCards));</span>
            }
<span class="nc bnc" id="L1217" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12826)) {</span>
<span class="nc" id="L1218">                col.remNotes(uniqueNoteIds);</span>
            }
<span class="nc bnc" id="L1220" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12827)) {</span>
<span class="nc" id="L1221">                sched.deferReset();</span>
            }
<span class="nc bnc" id="L1223" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12828)) {</span>
                // pass back all cards because they can't be retrieved anymore by the caller (since the note is deleted)
<span class="nc" id="L1225">                collectionTask.doProgress(allCards.toArray(new Card[allCards.size()]));</span>
            }
<span class="nc" id="L1227">            return null;</span>
        }
    }

    public static class ChangeDeckMulti extends DismissNotes&lt;Void&gt; {

        private final long mNewDid;

        public ChangeDeckMulti(List&lt;Long&gt; cardIds, long newDid) {
<span class="nc" id="L1236">            super(cardIds);</span>
<span class="nc" id="L1237">            mNewDid = newDid;</span>
<span class="nc" id="L1238">        }</span>

        protected PairWithBoolean&lt;Card[]&gt; actualTask(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask, Card[] cards) {
<span class="nc bnc" id="L1241" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12829)) {</span>
<span class="nc" id="L1242">                Timber.i(&quot;Changing %d cards to deck: '%d'&quot;, cards.length, mNewDid);</span>
            }
<span class="nc" id="L1244">            Deck deckData = col.getDecks().get(mNewDid);</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12831)) {</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">                if (Decks.isDynamic(deckData)) {</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12830)) {</span>
                        // #5932 - can't change to a dynamic deck. Use &quot;Rebuild&quot;
<span class="nc" id="L1249">                        Timber.w(&quot;Attempted to move to dynamic deck. Cancelling task.&quot;);</span>
                    }
<span class="nc" id="L1251">                    return new PairWithBoolean&lt;&gt;(false, null);</span>
                }
            }
            // Confirm that the deck exists (and is not the default)
            try {
<span class="nc" id="L1256">                long actualId = deckData.getLong(&quot;id&quot;);</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12839)) {</span>
<span class="nc bnc" id="L1258" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(12837) ? (actualId &gt;= mNewDid) : (ListenerUtil.mutListener.listen(12836) ? (actualId &lt;= mNewDid) : (ListenerUtil.mutListener.listen(12835) ? (actualId &gt; mNewDid) : (ListenerUtil.mutListener.listen(12834) ? (actualId &lt; mNewDid) : (ListenerUtil.mutListener.listen(12833) ? (actualId == mNewDid) : (actualId != mNewDid))))))) {</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12838)) {</span>
<span class="nc" id="L1260">                            Timber.w(&quot;Attempted to move to deck %d, but got %d&quot;, mNewDid, actualId);</span>
                        }
<span class="nc" id="L1262">                        return new PairWithBoolean&lt;&gt;(false, null);</span>
                    }
                }
<span class="nc" id="L1265">            } catch (Exception e) {</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12832)) {</span>
<span class="nc" id="L1267">                    Timber.e(e, &quot;failed to check deck&quot;);</span>
                }
<span class="nc" id="L1269">                return new PairWithBoolean&lt;&gt;(false, null);</span>
<span class="nc" id="L1270">            }</span>
<span class="nc" id="L1271">            long[] changedCardIds = new long[cards.length];</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12846)) {</span>
                {
<span class="nc" id="L1274">                    long _loopCounter220 = 0;</span>
<span class="nc bnc" id="L1275" title="All 22 branches missed.">                    for (int i = 0; (ListenerUtil.mutListener.listen(12845) ? (i &gt;= cards.length) : (ListenerUtil.mutListener.listen(12844) ? (i &lt;= cards.length) : (ListenerUtil.mutListener.listen(12843) ? (i &gt; cards.length) : (ListenerUtil.mutListener.listen(12842) ? (i != cards.length) : (ListenerUtil.mutListener.listen(12841) ? (i == cards.length) : (i &lt; cards.length)))))); i++) {</span>
<span class="nc" id="L1276">                        ListenerUtil.loopListener.listen(&quot;_loopCounter220&quot;, ++_loopCounter220);</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12840)) {</span>
<span class="nc" id="L1278">                            changedCardIds[i] = cards[i].getId();</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L1283" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12847)) {</span>
<span class="nc" id="L1284">                col.getSched().remFromDyn(changedCardIds);</span>
            }
<span class="nc" id="L1286">            long[] originalDids = new long[cards.length];</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12858)) {</span>
                {
<span class="nc" id="L1289">                    long _loopCounter221 = 0;</span>
<span class="nc bnc" id="L1290" title="All 22 branches missed.">                    for (int i = 0; (ListenerUtil.mutListener.listen(12857) ? (i &gt;= cards.length) : (ListenerUtil.mutListener.listen(12856) ? (i &lt;= cards.length) : (ListenerUtil.mutListener.listen(12855) ? (i &gt; cards.length) : (ListenerUtil.mutListener.listen(12854) ? (i != cards.length) : (ListenerUtil.mutListener.listen(12853) ? (i == cards.length) : (i &lt; cards.length)))))); i++) {</span>
<span class="nc" id="L1291">                        ListenerUtil.loopListener.listen(&quot;_loopCounter221&quot;, ++_loopCounter221);</span>
<span class="nc" id="L1292">                        Card card = cards[i];</span>
<span class="nc bnc" id="L1293" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12848)) {</span>
<span class="nc" id="L1294">                            card.load();</span>
                        }
<span class="nc bnc" id="L1296" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12849)) {</span>
                            // save original did for undo
<span class="nc" id="L1298">                            originalDids[i] = card.getDid();</span>
                        }
<span class="nc bnc" id="L1300" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12850)) {</span>
                            // then set the card ID to the new deck
<span class="nc" id="L1302">                            card.setDid(mNewDid);</span>
                        }
<span class="nc" id="L1304">                        Note note = card.note();</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12851)) {</span>
<span class="nc" id="L1306">                            note.flush();</span>
                        }
<span class="nc bnc" id="L1308" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12852)) {</span>
                            // flush card too, in case, did has been changed
<span class="nc" id="L1310">                            card.flush();</span>
                        }
                    }
                }
            }
<span class="nc" id="L1315">            Undoable changeDeckMulti = new UndoChangeDeckMulti(cards, originalDids);</span>
<span class="nc bnc" id="L1316" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12859)) {</span>
                // mark undo for all at once
<span class="nc" id="L1318">                col.markUndo(changeDeckMulti);</span>
            }
<span class="nc" id="L1320">            return null;</span>
        }
    }

    private abstract static class RescheduleRepositionReset extends DismissNotes&lt;Card&gt; {

        private final Collection.DismissType mType;

        public RescheduleRepositionReset(List&lt;Long&gt; cardIds, Collection.DismissType type) {
<span class="nc" id="L1329">            super(cardIds);</span>
<span class="nc" id="L1330">            mType = type;</span>
<span class="nc" id="L1331">        }</span>

        protected PairWithBoolean&lt;Card[]&gt; actualTask(Collection col, ProgressSenderAndCancelListener&lt;Card&gt; collectionTask, Card[] cards) {
<span class="nc" id="L1334">            AbstractSched sched = col.getSched();</span>
            // collect undo information, sensitive to memory pressure, same for all 3 cases
            try {
<span class="nc bnc" id="L1337" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12861)) {</span>
<span class="nc" id="L1338">                    Timber.d(&quot;Saving undo information of type %s on %d cards&quot;, mType, cards.length);</span>
                }
<span class="nc" id="L1340">                Card[] cards_copied = deepCopyCardArray(cards, collectionTask);</span>
<span class="nc" id="L1341">                Undoable repositionRescheduleResetCards = new UndoRepositionRescheduleResetCards(mType, cards_copied);</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12862)) {</span>
<span class="nc" id="L1343">                    col.markUndo(repositionRescheduleResetCards);</span>
                }
<span class="nc" id="L1345">            } catch (CancellationException ce) {</span>
<span class="nc bnc" id="L1346" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12860)) {</span>
<span class="nc" id="L1347">                    Timber.i(ce, &quot;Cancelled while handling type %s, skipping undo&quot;, mType);</span>
                }
<span class="nc" id="L1349">            }</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12863)) {</span>
<span class="nc" id="L1351">                actualActualTask(sched);</span>
            }
<span class="nc bnc" id="L1353" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12864)) {</span>
                // In all cases schedule a new card so Reviewer doesn't sit on the old one
<span class="nc" id="L1355">                col.reset();</span>
            }
<span class="nc bnc" id="L1357" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12865)) {</span>
<span class="nc" id="L1358">                collectionTask.doProgress(sched.getCard());</span>
            }
<span class="nc" id="L1360">            return null;</span>
        }

        protected abstract void actualActualTask(AbstractSched sched);
    }

    public static class RescheduleCards extends RescheduleRepositionReset {

        private final int mSchedule;

        public RescheduleCards(List&lt;Long&gt; cardIds, int schedule) {
<span class="nc" id="L1371">            super(cardIds, RESCHEDULE_CARDS);</span>
<span class="nc" id="L1372">            this.mSchedule = schedule;</span>
<span class="nc" id="L1373">        }</span>

        @Override
        protected void actualActualTask(AbstractSched sched) {
<span class="nc bnc" id="L1377" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12866)) {</span>
<span class="nc" id="L1378">                sched.reschedCards(mCardIds, mSchedule, mSchedule);</span>
            }
<span class="nc" id="L1380">        }</span>
    }

    public static class RepositionCards extends RescheduleRepositionReset {

        private final int mPosition;

        public RepositionCards(List&lt;Long&gt; cardIds, int position) {
<span class="nc" id="L1388">            super(cardIds, REPOSITION_CARDS);</span>
<span class="nc" id="L1389">            this.mPosition = position;</span>
<span class="nc" id="L1390">        }</span>

        @Override
        protected void actualActualTask(AbstractSched sched) {
<span class="nc bnc" id="L1394" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12867)) {</span>
<span class="nc" id="L1395">                sched.sortCards(mCardIds, mPosition, 1, false, true);</span>
            }
<span class="nc" id="L1397">        }</span>
    }

    public static class ResetCards extends RescheduleRepositionReset {

        public ResetCards(List&lt;Long&gt; cardIds) {
<span class="nc" id="L1403">            super(cardIds, RESET_CARDS);</span>
<span class="nc" id="L1404">        }</span>

        @Override
        protected void actualActualTask(AbstractSched sched) {
<span class="nc bnc" id="L1408" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12868)) {</span>
<span class="nc" id="L1409">                sched.forgetCards(mCardIds);</span>
            }
<span class="nc" id="L1411">        }</span>
    }

    @VisibleForTesting
    public static Card nonTaskUndo(Collection col) {
<span class="nc" id="L1416">        AbstractSched sched = col.getSched();</span>
<span class="nc" id="L1417">        Card card = col.undo();</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(12874)) {</span>
<span class="nc bnc" id="L1419" title="All 2 branches missed.">            if (card == null) {</span>
<span class="nc bnc" id="L1420" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12873)) {</span>
                    /* multi-card action undone, no action to take here */
<span class="nc" id="L1422">                    Timber.d(&quot;Multi-select undo succeeded&quot;);</span>
                }
            } else {
<span class="nc bnc" id="L1425" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12869)) {</span>
                    /* card review undone, set up to review that card again */
<span class="nc" id="L1427">                    Timber.d(&quot;Single card review undo succeeded&quot;);</span>
                }
<span class="nc bnc" id="L1429" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12870)) {</span>
<span class="nc" id="L1430">                    card.startTimer();</span>
                }
<span class="nc bnc" id="L1432" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12871)) {</span>
<span class="nc" id="L1433">                    col.reset();</span>
                }
<span class="nc bnc" id="L1435" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12872)) {</span>
<span class="nc" id="L1436">                    sched.deferReset(card);</span>
                }
            }
        }
<span class="nc" id="L1440">        return card;</span>
    }

<span class="nc" id="L1443">    public static class Undo extends Task&lt;Card, BooleanGetter&gt; {</span>

        protected BooleanGetter task(Collection col, ProgressSenderAndCancelListener&lt;Card&gt; collectionTask) {
            try {
<span class="nc bnc" id="L1447" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12877)) {</span>
<span class="nc" id="L1448">                    col.getDb().executeInTransaction(() -&gt; {</span>
<span class="nc" id="L1449">                        Card card = nonTaskUndo(col);</span>
<span class="nc" id="L1450">                        collectionTask.doProgress(card);</span>
<span class="nc" id="L1451">                    });</span>
                }
<span class="nc" id="L1453">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L1454" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12875)) {</span>
<span class="nc" id="L1455">                    Timber.e(e, &quot;doInBackgroundUndo - RuntimeException on undoing&quot;);</span>
                }
<span class="nc bnc" id="L1457" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12876)) {</span>
<span class="nc" id="L1458">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundUndo&quot;);</span>
                }
<span class="nc" id="L1460">                return False;</span>
<span class="nc" id="L1461">            }</span>
<span class="nc" id="L1462">            return True;</span>
        }
    }

    /**
     * A class allowing to send partial search result to the browser to display while the search ends
     */
    public static class PartialSearch implements ProgressSenderAndCancelListener&lt;List&lt;Long&gt;&gt; {

        private final List&lt;CardBrowser.CardCache&gt; mCards;

        private final int mColumn1Index, mColumn2Index;

        private final int mNumCardsToRender;

        private final ProgressSenderAndCancelListener&lt;List&lt;CardBrowser.CardCache&gt;&gt; mCollectionTask;

        private final Collection mCol;

<span class="nc" id="L1481">        public PartialSearch(List&lt;CardBrowser.CardCache&gt; cards, int columnIndex1, int columnIndex2, int numCardsToRender, ProgressSenderAndCancelListener&lt;List&lt;CardBrowser.CardCache&gt;&gt; collectionTask, Collection col) {</span>
<span class="nc" id="L1482">            mCards = cards;</span>
<span class="nc" id="L1483">            mColumn1Index = columnIndex1;</span>
<span class="nc" id="L1484">            mColumn2Index = columnIndex2;</span>
<span class="nc" id="L1485">            mNumCardsToRender = numCardsToRender;</span>
<span class="nc" id="L1486">            mCollectionTask = collectionTask;</span>
<span class="nc" id="L1487">            mCol = col;</span>
<span class="nc" id="L1488">        }</span>

        @Override
        public boolean isCancelled() {
<span class="nc" id="L1492">            return mCollectionTask.isCancelled();</span>
        }

        /**
         * @param cards Card ids to display in the browser. It is assumed that it is as least as long as mCards, and that
         *             mCards[i].cid = cards[i].  It add the cards in cards after `mPosition` to mCards
         */
        public void add(@NonNull List&lt;Long&gt; cards) {
<span class="nc bnc" id="L1500" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12884)) {</span>
                {
<span class="nc" id="L1502">                    long _loopCounter222 = 0;</span>
<span class="nc bnc" id="L1503" title="All 22 branches missed.">                    while ((ListenerUtil.mutListener.listen(12883) ? (mCards.size() &gt;= cards.size()) : (ListenerUtil.mutListener.listen(12882) ? (mCards.size() &lt;= cards.size()) : (ListenerUtil.mutListener.listen(12881) ? (mCards.size() &gt; cards.size()) : (ListenerUtil.mutListener.listen(12880) ? (mCards.size() != cards.size()) : (ListenerUtil.mutListener.listen(12879) ? (mCards.size() == cards.size()) : (mCards.size() &lt; cards.size()))))))) {</span>
<span class="nc" id="L1504">                        ListenerUtil.loopListener.listen(&quot;_loopCounter222&quot;, ++_loopCounter222);</span>
<span class="nc bnc" id="L1505" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12878)) {</span>
<span class="nc" id="L1506">                            mCards.add(new CardBrowser.CardCache(cards.get(mCards.size()), mCol, mCards.size()));</span>
                        }
                    }
                }
            }
<span class="nc" id="L1511">        }</span>

        @Override
        public void doProgress(@NonNull List&lt;Long&gt; value) {
<span class="nc bnc" id="L1515" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12885)) {</span>
<span class="nc" id="L1516">                add(value);</span>
            }
<span class="nc bnc" id="L1518" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12889)) {</span>
                {
<span class="nc" id="L1520">                    long _loopCounter223 = 0;</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">                    for (CardBrowser.CardCache card : mCards) {</span>
<span class="nc" id="L1522">                        ListenerUtil.loopListener.listen(&quot;_loopCounter223&quot;, ++_loopCounter223);</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12887)) {</span>
<span class="nc bnc" id="L1524" title="All 2 branches missed.">                            if (isCancelled()) {</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12886)) {</span>
<span class="nc" id="L1526">                                    Timber.d(&quot;doInBackgroundSearchCards was cancelled so return&quot;);</span>
                                }
<span class="nc" id="L1528">                                return;</span>
                            }
                        }
<span class="nc bnc" id="L1531" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12888)) {</span>
<span class="nc" id="L1532">                            card.load(false, mColumn1Index, mColumn2Index);</span>
                        }
<span class="nc" id="L1534">                    }</span>
                }
            }
<span class="nc bnc" id="L1537" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12890)) {</span>
<span class="nc" id="L1538">                mCollectionTask.doProgress(mCards);</span>
            }
<span class="nc" id="L1540">        }</span>

        public int getNumCardsToRender() {
<span class="nc" id="L1543">            return mNumCardsToRender;</span>
        }
    }

    public static class SearchCards extends Task&lt;List&lt;CardBrowser.CardCache&gt;, List&lt;CardBrowser.CardCache&gt;&gt; {

        private final String query;

        private final boolean order;

        private final int numCardsToRender;

        private final int column1Index;

        private final int column2Index;

<span class="nc" id="L1559">        public SearchCards(String query, boolean order, int numCardsToRender, int column1Index, int column2Index) {</span>
<span class="nc" id="L1560">            this.query = query;</span>
<span class="nc" id="L1561">            this.order = order;</span>
<span class="nc" id="L1562">            this.numCardsToRender = numCardsToRender;</span>
<span class="nc" id="L1563">            this.column1Index = column1Index;</span>
<span class="nc" id="L1564">            this.column2Index = column2Index;</span>
<span class="nc" id="L1565">        }</span>

        protected List&lt;CardBrowser.CardCache&gt; task(Collection col, ProgressSenderAndCancelListener&lt;List&lt;CardBrowser.CardCache&gt;&gt; collectionTask) {
<span class="nc bnc" id="L1568" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12891)) {</span>
<span class="nc" id="L1569">                Timber.d(&quot;doInBackgroundSearchCards&quot;);</span>
            }
<span class="nc bnc" id="L1571" title="All 2 branches missed.">            if (collectionTask.isCancelled()) {</span>
<span class="nc bnc" id="L1572" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12892)) {</span>
<span class="nc" id="L1573">                    Timber.d(&quot;doInBackgroundSearchCards was cancelled so return null&quot;);</span>
                }
<span class="nc" id="L1575">                return null;</span>
            }
<span class="nc" id="L1577">            List&lt;CardBrowser.CardCache&gt; searchResult = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1578">            List&lt;Long&gt; searchResult_ = col.findCards(query, order, new PartialSearch(searchResult, column1Index, column2Index, numCardsToRender, collectionTask, col));</span>
<span class="nc bnc" id="L1579" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12893)) {</span>
<span class="nc" id="L1580">                Timber.d(&quot;The search found %d cards&quot;, searchResult_.size());</span>
            }
<span class="nc" id="L1582">            int position = 0;</span>
<span class="nc bnc" id="L1583" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12895)) {</span>
                {
<span class="nc" id="L1585">                    long _loopCounter224 = 0;</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">                    for (Long cid : searchResult_) {</span>
<span class="nc" id="L1587">                        ListenerUtil.loopListener.listen(&quot;_loopCounter224&quot;, ++_loopCounter224);</span>
<span class="nc" id="L1588">                        CardBrowser.CardCache card = new CardBrowser.CardCache(cid, col, position++);</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12894)) {</span>
<span class="nc" id="L1590">                            searchResult.add(card);</span>
                        }
<span class="nc" id="L1592">                    }</span>
                }
            }
            {
<span class="nc" id="L1596">                long _loopCounter225 = 0;</span>
                // Render the first few items
<span class="nc bnc" id="L1598" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(12902) ? (i &gt;= Math.min(numCardsToRender, searchResult.size())) : (ListenerUtil.mutListener.listen(12901) ? (i &lt;= Math.min(numCardsToRender, searchResult.size())) : (ListenerUtil.mutListener.listen(12900) ? (i &gt; Math.min(numCardsToRender, searchResult.size())) : (ListenerUtil.mutListener.listen(12899) ? (i != Math.min(numCardsToRender, searchResult.size())) : (ListenerUtil.mutListener.listen(12898) ? (i == Math.min(numCardsToRender, searchResult.size())) : (i &lt; Math.min(numCardsToRender, searchResult.size()))))))); i++) {</span>
<span class="nc" id="L1599">                    ListenerUtil.loopListener.listen(&quot;_loopCounter225&quot;, ++_loopCounter225);</span>
<span class="nc bnc" id="L1600" title="All 2 branches missed.">                    if (collectionTask.isCancelled()) {</span>
<span class="nc bnc" id="L1601" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12896)) {</span>
<span class="nc" id="L1602">                            Timber.d(&quot;doInBackgroundSearchCards was cancelled so return null&quot;);</span>
                        }
<span class="nc" id="L1604">                        return null;</span>
                    }
<span class="nc bnc" id="L1606" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12897)) {</span>
<span class="nc" id="L1607">                        searchResult.get(i).load(false, column1Index, column2Index);</span>
                    }
                }
            }
            // Finish off the task
<span class="nc bnc" id="L1612" title="All 2 branches missed.">            if (collectionTask.isCancelled()) {</span>
<span class="nc bnc" id="L1613" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12903)) {</span>
<span class="nc" id="L1614">                    Timber.d(&quot;doInBackgroundSearchCards was cancelled so return null&quot;);</span>
                }
<span class="nc" id="L1616">                return null;</span>
            } else {
<span class="nc" id="L1618">                return searchResult;</span>
            }
        }
    }

    public static class RenderBrowserQA extends Task&lt;Integer, Pair&lt;CardBrowser.CardCollection&lt;CardBrowser.CardCache&gt;, List&lt;Long&gt;&gt;&gt; {

        private final CardBrowser.CardCollection&lt;CardBrowser.CardCache&gt; cards;

        private final Integer startPos;

        private final Integer n;

        private final int column1Index;

        private final int column2Index;

<span class="nc" id="L1635">        public RenderBrowserQA(CardBrowser.CardCollection&lt;CardBrowser.CardCache&gt; cards, Integer mStartPos, Integer n, int column1Index, int column2Index) {</span>
<span class="nc" id="L1636">            this.cards = cards;</span>
<span class="nc" id="L1637">            this.startPos = mStartPos;</span>
<span class="nc" id="L1638">            this.n = n;</span>
<span class="nc" id="L1639">            this.column1Index = column1Index;</span>
<span class="nc" id="L1640">            this.column2Index = column2Index;</span>
<span class="nc" id="L1641">        }</span>

        protected Pair&lt;CardBrowser.CardCollection&lt;CardBrowser.CardCache&gt;, List&lt;Long&gt;&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Integer&gt; collectionTask) {
<span class="nc bnc" id="L1644" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12904)) {</span>
<span class="nc" id="L1645">                Timber.d(&quot;doInBackgroundRenderBrowserQA&quot;);</span>
            }
<span class="nc" id="L1647">            List&lt;Long&gt; invalidCardIds = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1648" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12942)) {</span>
                {
<span class="nc" id="L1650">                    long _loopCounter226 = 0;</span>
                    // for each specified card in the browser list
<span class="nc bnc" id="L1652" title="All 70 branches missed.">                    for (int i = startPos; (ListenerUtil.mutListener.listen(12941) ? (i &gt;= (ListenerUtil.mutListener.listen(12936) ? (startPos % n) : (ListenerUtil.mutListener.listen(12935) ? (startPos / n) : (ListenerUtil.mutListener.listen(12934) ? (startPos * n) : (ListenerUtil.mutListener.listen(12933) ? (startPos - n) : (startPos + n)))))) : (ListenerUtil.mutListener.listen(12940) ? (i &lt;= (ListenerUtil.mutListener.listen(12936) ? (startPos % n) : (ListenerUtil.mutListener.listen(12935) ? (startPos / n) : (ListenerUtil.mutListener.listen(12934) ? (startPos * n) : (ListenerUtil.mutListener.listen(12933) ? (startPos - n) : (startPos + n)))))) : (ListenerUtil.mutListener.listen(12939) ? (i &gt; (ListenerUtil.mutListener.listen(12936) ? (startPos % n) : (ListenerUtil.mutListener.listen(12935) ? (startPos / n) : (ListenerUtil.mutListener.listen(12934) ? (startPos * n) : (ListenerUtil.mutListener.listen(12933) ? (startPos - n) : (startPos + n)))))) : (ListenerUtil.mutListener.listen(12938) ? (i != (ListenerUtil.mutListener.listen(12936) ? (startPos % n) : (ListenerUtil.mutListener.listen(12935) ? (startPos / n) : (ListenerUtil.mutListener.listen(12934) ? (startPos * n) : (ListenerUtil.mutListener.listen(12933) ? (startPos - n) : (startPos + n)))))) : (ListenerUtil.mutListener.listen(12937) ? (i == (ListenerUtil.mutListener.listen(12936) ? (startPos % n) : (ListenerUtil.mutListener.listen(12935) ? (startPos / n) : (ListenerUtil.mutListener.listen(12934) ? (startPos * n) : (ListenerUtil.mutListener.listen(12933) ? (startPos - n) : (startPos + n)))))) : (i &lt; (ListenerUtil.mutListener.listen(12936) ? (startPos % n) : (ListenerUtil.mutListener.listen(12935) ? (startPos / n) : (ListenerUtil.mutListener.listen(12934) ? (startPos * n) : (ListenerUtil.mutListener.listen(12933) ? (startPos - n) : (startPos + n))))))))))); i++) {</span>
<span class="nc" id="L1653">                        ListenerUtil.loopListener.listen(&quot;_loopCounter226&quot;, ++_loopCounter226);</span>
<span class="nc bnc" id="L1654" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12906)) {</span>
                            // Stop if cancelled
<span class="nc bnc" id="L1656" title="All 2 branches missed.">                            if (collectionTask.isCancelled()) {</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12905)) {</span>
<span class="nc" id="L1658">                                    Timber.d(&quot;doInBackgroundRenderBrowserQA was aborted&quot;);</span>
                                }
<span class="nc" id="L1660">                                return null;</span>
                            }
                        }
<span class="nc bnc" id="L1663" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12918)) {</span>
<span class="nc bnc" id="L1664" title="All 90 branches missed.">                            if ((ListenerUtil.mutListener.listen(12917) ? ((ListenerUtil.mutListener.listen(12911) ? (i &gt;= 0) : (ListenerUtil.mutListener.listen(12910) ? (i &lt;= 0) : (ListenerUtil.mutListener.listen(12909) ? (i &gt; 0) : (ListenerUtil.mutListener.listen(12908) ? (i != 0) : (ListenerUtil.mutListener.listen(12907) ? (i == 0) : (i &lt; 0)))))) &amp;&amp; (ListenerUtil.mutListener.listen(12916) ? (i &lt;= cards.size()) : (ListenerUtil.mutListener.listen(12915) ? (i &gt; cards.size()) : (ListenerUtil.mutListener.listen(12914) ? (i &lt; cards.size()) : (ListenerUtil.mutListener.listen(12913) ? (i != cards.size()) : (ListenerUtil.mutListener.listen(12912) ? (i == cards.size()) : (i &gt;= cards.size()))))))) : ((ListenerUtil.mutListener.listen(12911) ? (i &gt;= 0) : (ListenerUtil.mutListener.listen(12910) ? (i &lt;= 0) : (ListenerUtil.mutListener.listen(12909) ? (i &gt; 0) : (ListenerUtil.mutListener.listen(12908) ? (i != 0) : (ListenerUtil.mutListener.listen(12907) ? (i == 0) : (i &lt; 0)))))) || (ListenerUtil.mutListener.listen(12916) ? (i &lt;= cards.size()) : (ListenerUtil.mutListener.listen(12915) ? (i &gt; cards.size()) : (ListenerUtil.mutListener.listen(12914) ? (i &lt; cards.size()) : (ListenerUtil.mutListener.listen(12913) ? (i != cards.size()) : (ListenerUtil.mutListener.listen(12912) ? (i == cards.size()) : (i &gt;= cards.size()))))))))) {</span>
<span class="nc" id="L1665">                                continue;</span>
                            }
                        }
                        CardBrowser.CardCache card;
                        try {
<span class="nc" id="L1670">                            card = cards.get(i);</span>
<span class="nc" id="L1671">                        } catch (IndexOutOfBoundsException e) {</span>
                            // we won't reach any more cards.
<span class="nc" id="L1673">                            continue;</span>
<span class="nc" id="L1674">                        }</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12919)) {</span>
<span class="nc bnc" id="L1676" title="All 2 branches missed.">                            if (card.isLoaded()) {</span>
                                // We've already rendered the answer, we don't need to do it again.
<span class="nc" id="L1678">                                continue;</span>
                            }
                        }
                        // Extract card item
                        try {
<span class="nc bnc" id="L1683" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(12922)) {</span>
                                // Ensure that card still exists.
<span class="nc" id="L1685">                                card.getCard();</span>
                            }
<span class="nc" id="L1687">                        } catch (WrongId e) {</span>
                            // process
<span class="nc" id="L1689">                            long cardId = card.getId();</span>
<span class="nc bnc" id="L1690" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(12920)) {</span>
<span class="nc" id="L1691">                                Timber.e(e, &quot;Could not process card '%d' - skipping and removing from sight&quot;, cardId);</span>
                            }
<span class="nc bnc" id="L1693" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(12921)) {</span>
<span class="nc" id="L1694">                                invalidCardIds.add(cardId);</span>
                            }
<span class="nc" id="L1696">                            continue;</span>
<span class="nc" id="L1697">                        }</span>
<span class="nc bnc" id="L1698" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12923)) {</span>
                            // Update item
<span class="nc" id="L1700">                            card.load(false, column1Index, column2Index);</span>
                        }
<span class="nc bnc" id="L1702" title="All 48 branches missed.">                        float progress = (ListenerUtil.mutListener.listen(12931) ? ((ListenerUtil.mutListener.listen(12927) ? ((float) i % n) : (ListenerUtil.mutListener.listen(12926) ? ((float) i * n) : (ListenerUtil.mutListener.listen(12925) ? ((float) i - n) : (ListenerUtil.mutListener.listen(12924) ? ((float) i + n) : ((float) i / n))))) % 100) : (ListenerUtil.mutListener.listen(12930) ? ((ListenerUtil.mutListener.listen(12927) ? ((float) i % n) : (ListenerUtil.mutListener.listen(12926) ? ((float) i * n) : (ListenerUtil.mutListener.listen(12925) ? ((float) i - n) : (ListenerUtil.mutListener.listen(12924) ? ((float) i + n) : ((float) i / n))))) / 100) : (ListenerUtil.mutListener.listen(12929) ? ((ListenerUtil.mutListener.listen(12927) ? ((float) i % n) : (ListenerUtil.mutListener.listen(12926) ? ((float) i * n) : (ListenerUtil.mutListener.listen(12925) ? ((float) i - n) : (ListenerUtil.mutListener.listen(12924) ? ((float) i + n) : ((float) i / n))))) - 100) : (ListenerUtil.mutListener.listen(12928) ? ((ListenerUtil.mutListener.listen(12927) ? ((float) i % n) : (ListenerUtil.mutListener.listen(12926) ? ((float) i * n) : (ListenerUtil.mutListener.listen(12925) ? ((float) i - n) : (ListenerUtil.mutListener.listen(12924) ? ((float) i + n) : ((float) i / n))))) + 100) : ((ListenerUtil.mutListener.listen(12927) ? ((float) i % n) : (ListenerUtil.mutListener.listen(12926) ? ((float) i * n) : (ListenerUtil.mutListener.listen(12925) ? ((float) i - n) : (ListenerUtil.mutListener.listen(12924) ? ((float) i + n) : ((float) i / n))))) * 100)))));</span>
<span class="nc bnc" id="L1703" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12932)) {</span>
<span class="nc" id="L1704">                            collectionTask.doProgress((int) progress);</span>
                        }
                    }
                }
            }
<span class="nc" id="L1709">            return new Pair&lt;&gt;(cards, invalidCardIds);</span>
        }
    }

<span class="nc" id="L1713">    public static class CheckDatabase extends Task&lt;String, Pair&lt;Boolean, Collection.CheckDatabaseResult&gt;&gt; {</span>

        protected Pair&lt;Boolean, Collection.CheckDatabaseResult&gt; task(Collection col, ProgressSenderAndCancelListener&lt;String&gt; collectionTask) {
<span class="nc bnc" id="L1716" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12943)) {</span>
<span class="nc" id="L1717">                Timber.d(&quot;doInBackgroundCheckDatabase&quot;);</span>
            }
            // Don't proceed if collection closed
<span class="nc bnc" id="L1720" title="All 2 branches missed.">            if (col == null) {</span>
<span class="nc bnc" id="L1721" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12944)) {</span>
<span class="nc" id="L1722">                    Timber.e(&quot;doInBackgroundCheckDatabase :: supplied collection was null&quot;);</span>
                }
<span class="nc" id="L1724">                return new Pair&lt;&gt;(false, null);</span>
            }
<span class="nc" id="L1726">            Collection.CheckDatabaseResult result = col.fixIntegrity(new TaskManager.ProgressCallback(collectionTask, AnkiDroidApp.getAppResources()));</span>
<span class="nc bnc" id="L1727" title="All 2 branches missed.">            if (result.getFailed()) {</span>
                // we can fail due to a locked database, which requires knowledge of the failure.
<span class="nc" id="L1729">                return new Pair&lt;&gt;(false, result);</span>
            } else {
<span class="nc bnc" id="L1731" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12945)) {</span>
                    // Close the collection and we restart the app to reload
<span class="nc" id="L1733">                    CollectionHelper.getInstance().closeCollection(true, &quot;Check Database Completed&quot;);</span>
                }
<span class="nc" id="L1735">                return new Pair&lt;&gt;(true, result);</span>
            }
        }
    }

<span class="nc" id="L1740">    public static class RepairCollectionn extends Task&lt;Void, Boolean&gt; {</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L1743" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12946)) {</span>
<span class="nc" id="L1744">                Timber.d(&quot;doInBackgroundRepairCollection&quot;);</span>
            }
<span class="nc bnc" id="L1746" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12949)) {</span>
<span class="nc bnc" id="L1747" title="All 2 branches missed.">                if (col != null) {</span>
<span class="nc bnc" id="L1748" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12947)) {</span>
<span class="nc" id="L1749">                        Timber.i(&quot;RepairCollection: Closing collection&quot;);</span>
                    }
<span class="nc bnc" id="L1751" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12948)) {</span>
<span class="nc" id="L1752">                        col.close(false);</span>
                    }
                }
            }
<span class="nc" id="L1756">            return BackupManager.repairCollection(col);</span>
        }
    }

    public static class UpdateValuesFromDeck extends Task&lt;Void, int[]&gt; {

        private final boolean reset;

<span class="nc" id="L1764">        public UpdateValuesFromDeck(boolean reset) {</span>
<span class="nc" id="L1765">            this.reset = reset;</span>
<span class="nc" id="L1766">        }</span>

        public int[] task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L1769" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12950)) {</span>
<span class="nc" id="L1770">                Timber.d(&quot;doInBackgroundUpdateValuesFromDeck&quot;);</span>
            }
            try {
<span class="nc" id="L1773">                AbstractSched sched = col.getSched();</span>
<span class="nc bnc" id="L1774" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12953)) {</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">                    if (reset) {</span>
<span class="nc bnc" id="L1776" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12952)) {</span>
                            // reset actually required because of counts, which is used in getCollectionTaskListener
<span class="nc" id="L1778">                            sched.resetCounts();</span>
                        }
                    }
                }
<span class="nc" id="L1782">                Counts counts = sched.counts();</span>
<span class="nc" id="L1783">                int totalNewCount = sched.totalNewForCurrentDeck();</span>
<span class="nc" id="L1784">                int totalCount = sched.cardCount();</span>
<span class="nc" id="L1785">                return new int[] { counts.getNew(), counts.getLrn(), counts.getRev(), totalNewCount, totalCount, sched.eta(counts) };</span>
<span class="nc" id="L1786">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L1787" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12951)) {</span>
<span class="nc" id="L1788">                    Timber.e(e, &quot;doInBackgroundUpdateValuesFromDeck - an error occurred&quot;);</span>
                }
<span class="nc" id="L1790">                return null;</span>
            }
        }
    }

    public static class DeleteDeck extends Task&lt;Void, int[]&gt; {

        private final long did;

<span class="nc" id="L1799">        public DeleteDeck(long did) {</span>
<span class="nc" id="L1800">            this.did = did;</span>
<span class="nc" id="L1801">        }</span>

        protected int[] task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L1804" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12954)) {</span>
<span class="nc" id="L1805">                Timber.d(&quot;doInBackgroundDeleteDeck&quot;);</span>
            }
<span class="nc bnc" id="L1807" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12955)) {</span>
<span class="nc" id="L1808">                col.getDecks().rem(did, true);</span>
            }
<span class="nc bnc" id="L1810" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12956)) {</span>
                // TODO: if we had &quot;undo delete note&quot; like desktop client then we won't need this.
<span class="nc" id="L1812">                col.clearUndo();</span>
            }
<span class="nc" id="L1814">            return null;</span>
        }
    }

<span class="nc" id="L1818">    public static class RebuildCram extends Task&lt;Void, int[]&gt; {</span>

        protected int[] task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L1821" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12957)) {</span>
<span class="nc" id="L1822">                Timber.d(&quot;doInBackgroundRebuildCram&quot;);</span>
            }
<span class="nc bnc" id="L1824" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12958)) {</span>
<span class="nc" id="L1825">                col.getSched().rebuildDyn(col.getDecks().selected());</span>
            }
<span class="nc" id="L1827">            return new UpdateValuesFromDeck(true).task(col, collectionTask);</span>
        }
    }

<span class="nc" id="L1831">    public static class EmptyCram extends Task&lt;Void, int[]&gt; {</span>

        protected int[] task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L1834" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12959)) {</span>
<span class="nc" id="L1835">                Timber.d(&quot;doInBackgroundEmptyCram&quot;);</span>
            }
<span class="nc bnc" id="L1837" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12960)) {</span>
<span class="nc" id="L1838">                col.getSched().emptyDyn(col.getDecks().selected());</span>
            }
<span class="nc" id="L1840">            return new UpdateValuesFromDeck(true).task(col, collectionTask);</span>
        }
    }

    public static class ImportAdd extends Task&lt;String, Triple&lt;AnkiPackageImporter, Boolean, String&gt;&gt; {

        private final String path;

<span class="nc" id="L1848">        public ImportAdd(String path) {</span>
<span class="nc" id="L1849">            this.path = path;</span>
<span class="nc" id="L1850">        }</span>

        protected Triple&lt;AnkiPackageImporter, Boolean, String&gt; task(Collection col, ProgressSenderAndCancelListener&lt;String&gt; collectionTask) {
<span class="nc bnc" id="L1853" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12961)) {</span>
<span class="nc" id="L1854">                Timber.d(&quot;doInBackgroundImportAdd&quot;);</span>
            }
<span class="nc" id="L1856">            Resources res = AnkiDroidApp.getInstance().getBaseContext().getResources();</span>
<span class="nc" id="L1857">            AnkiPackageImporter imp = new AnkiPackageImporter(col, path);</span>
<span class="nc bnc" id="L1858" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12962)) {</span>
<span class="nc" id="L1859">                imp.setProgressCallback(new TaskManager.ProgressCallback(collectionTask, res));</span>
            }
            try {
<span class="nc bnc" id="L1862" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12963)) {</span>
<span class="nc" id="L1863">                    imp.run();</span>
                }
<span class="nc" id="L1865">            } catch (ImportExportException e) {</span>
<span class="nc" id="L1866">                return new Triple(null, true, e.getMessage());</span>
<span class="nc" id="L1867">            }</span>
<span class="nc" id="L1868">            return new Triple&lt;&gt;(imp, false, null);</span>
        }
    }

    public static class ImportReplace extends Task&lt;String, BooleanGetter&gt; {

        private final String path;

<span class="nc" id="L1876">        public ImportReplace(String path) {</span>
<span class="nc" id="L1877">            this.path = path;</span>
<span class="nc" id="L1878">        }</span>

        protected BooleanGetter task(Collection col, ProgressSenderAndCancelListener&lt;String&gt; collectionTask) {
<span class="nc bnc" id="L1881" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12964)) {</span>
<span class="nc" id="L1882">                Timber.d(&quot;doInBackgroundImportReplace&quot;);</span>
            }
<span class="nc" id="L1884">            Resources res = AnkiDroidApp.getInstance().getBaseContext().getResources();</span>
<span class="nc" id="L1885">            Context context = col.getContext();</span>
            // extract the deck from the zip file
<span class="nc" id="L1887">            String colPath = CollectionHelper.getCollectionPath(context);</span>
<span class="nc" id="L1888">            File dir = new File(new File(colPath).getParentFile(), &quot;tmpzip&quot;);</span>
<span class="nc bnc" id="L1889" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12966)) {</span>
<span class="nc bnc" id="L1890" title="All 2 branches missed.">                if (dir.exists()) {</span>
<span class="nc bnc" id="L1891" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12965)) {</span>
<span class="nc" id="L1892">                        BackupManager.removeDir(dir);</span>
                    }
                }
            }
            // from anki2.py
<span class="nc" id="L1897">            String colname = &quot;collection.anki21&quot;;</span>
            ZipFile zip;
            try {
<span class="nc" id="L1900">                zip = new ZipFile(new File(path));</span>
<span class="nc" id="L1901">            } catch (IOException e) {</span>
<span class="nc bnc" id="L1902" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12967)) {</span>
<span class="nc" id="L1903">                    Timber.e(e, &quot;doInBackgroundImportReplace - Error while unzipping&quot;);</span>
                }
<span class="nc bnc" id="L1905" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12968)) {</span>
<span class="nc" id="L1906">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundImportReplace0&quot;);</span>
                }
<span class="nc" id="L1908">                return False;</span>
<span class="nc" id="L1909">            }</span>
            try {
<span class="nc bnc" id="L1911" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12971)) {</span>
                    // v2 scheduler?
<span class="nc bnc" id="L1913" title="All 2 branches missed.">                    if (zip.getEntry(colname) == null) {</span>
<span class="nc bnc" id="L1914" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12970)) {</span>
<span class="nc" id="L1915">                            colname = CollectionHelper.COLLECTION_FILENAME;</span>
                        }
                    }
                }
<span class="nc bnc" id="L1919" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12972)) {</span>
<span class="nc" id="L1920">                    Utils.unzipFiles(zip, dir.getAbsolutePath(), new String[] { colname, &quot;media&quot; }, null);</span>
                }
<span class="nc" id="L1922">            } catch (IOException e) {</span>
<span class="nc bnc" id="L1923" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12969)) {</span>
<span class="nc" id="L1924">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundImportReplace - unzip&quot;);</span>
                }
<span class="nc" id="L1926">                return False;</span>
<span class="nc" id="L1927">            }</span>
<span class="nc" id="L1928">            String colFile = new File(dir, colname).getAbsolutePath();</span>
<span class="nc bnc" id="L1929" title="All 2 branches missed.">            if (!(new File(colFile)).exists()) {</span>
<span class="nc" id="L1930">                return False;</span>
            }
<span class="nc" id="L1932">            Collection tmpCol = null;</span>
            try {
<span class="nc bnc" id="L1934" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12978)) {</span>
<span class="nc" id="L1935">                    tmpCol = Storage.Collection(context, colFile);</span>
                }
<span class="nc bnc" id="L1937" title="All 2 branches missed.">                if (!tmpCol.validCollection()) {</span>
<span class="nc bnc" id="L1938" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12979)) {</span>
<span class="nc" id="L1939">                        tmpCol.close();</span>
                    }
<span class="nc" id="L1941">                    return False;</span>
                }
<span class="nc" id="L1943">            } catch (Exception e) {</span>
<span class="nc bnc" id="L1944" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12973)) {</span>
<span class="nc" id="L1945">                    Timber.e(&quot;Error opening new collection file... probably it's invalid&quot;);</span>
                }
                try {
<span class="nc bnc" id="L1948" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(12974)) {</span>
<span class="nc" id="L1949">                        tmpCol.close();</span>
                    }
<span class="nc" id="L1951">                } catch (Exception e2) {</span>
<span class="nc" id="L1952">                }</span>
<span class="nc bnc" id="L1953" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12975)) {</span>
<span class="nc" id="L1954">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundImportReplace - open col&quot;);</span>
                }
<span class="nc" id="L1956">                return False;</span>
            } finally {
<span class="nc bnc" id="L1958" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12977)) {</span>
<span class="nc bnc" id="L1959" title="All 2 branches missed.">                    if (tmpCol != null) {</span>
<span class="nc bnc" id="L1960" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12976)) {</span>
<span class="nc" id="L1961">                            tmpCol.close();</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L1966" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(12980)) {</span>
<span class="nc" id="L1967">                collectionTask.doProgress(res.getString(R.string.importing_collection));</span>
            }
            try {
<span class="nc bnc" id="L1970" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12981)) {</span>
<span class="nc" id="L1971">                    CollectionHelper.getInstance().getCol(context);</span>
                }
                // unload collection and trigger a backup
<span class="nc" id="L1974">                Time time = CollectionHelper.getInstance().getTimeSafe(context);</span>
<span class="nc bnc" id="L1975" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12982)) {</span>
<span class="nc" id="L1976">                    CollectionHelper.getInstance().closeCollection(true, &quot;Importing new collection&quot;);</span>
                }
<span class="nc bnc" id="L1978" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12983)) {</span>
<span class="nc" id="L1979">                    CollectionHelper.getInstance().lockCollection();</span>
                }
<span class="nc bnc" id="L1981" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12984)) {</span>
<span class="nc" id="L1982">                    BackupManager.performBackupInBackground(colPath, true, time);</span>
                }
<span class="nc" id="L1984">            } catch (Exception e) {</span>
<span class="nc" id="L1985">            }</span>
            // overwrite collection
<span class="nc" id="L1987">            File f = new File(colFile);</span>
<span class="nc bnc" id="L1988" title="All 2 branches missed.">            if (!f.renameTo(new File(colPath))) {</span>
                // Exit early if this didn't work
<span class="nc" id="L1990">                return False;</span>
            }
<span class="nc" id="L1992">            int addedCount = -1;</span>
            try {
<span class="nc bnc" id="L1994" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12991)) {</span>
<span class="nc" id="L1995">                    CollectionHelper.getInstance().unlockCollection();</span>
                }
                // import media
<span class="nc" id="L1998">                HashMap&lt;String, String&gt; nameToNum = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1999">                HashMap&lt;String, String&gt; numToName = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2000">                File mediaMapFile = new File(dir.getAbsolutePath(), &quot;media&quot;);</span>
<span class="nc bnc" id="L2001" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12997)) {</span>
<span class="nc bnc" id="L2002" title="All 2 branches missed.">                    if (mediaMapFile.exists()) {</span>
<span class="nc" id="L2003">                        JsonReader jr = new JsonReader(new FileReader(mediaMapFile));</span>
<span class="nc bnc" id="L2004" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12992)) {</span>
<span class="nc" id="L2005">                            jr.beginObject();</span>
                        }
                        String name;
                        String num;
                        {
<span class="nc" id="L2010">                            long _loopCounter227 = 0;</span>
<span class="nc bnc" id="L2011" title="All 2 branches missed.">                            while (jr.hasNext()) {</span>
<span class="nc" id="L2012">                                ListenerUtil.loopListener.listen(&quot;_loopCounter227&quot;, ++_loopCounter227);</span>
<span class="nc" id="L2013">                                num = jr.nextName();</span>
<span class="nc" id="L2014">                                name = jr.nextString();</span>
<span class="nc bnc" id="L2015" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12993)) {</span>
<span class="nc" id="L2016">                                    nameToNum.put(name, num);</span>
                                }
<span class="nc bnc" id="L2018" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(12994)) {</span>
<span class="nc" id="L2019">                                    numToName.put(num, name);</span>
                                }
                            }
                        }
<span class="nc bnc" id="L2023" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12995)) {</span>
<span class="nc" id="L2024">                            jr.endObject();</span>
                        }
<span class="nc bnc" id="L2026" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(12996)) {</span>
<span class="nc" id="L2027">                            jr.close();</span>
                        }
                    }
                }
<span class="nc" id="L2031">                String mediaDir = Media.getCollectionMediaPath(colPath);</span>
<span class="nc" id="L2032">                int total = nameToNum.size();</span>
<span class="nc" id="L2033">                int i = 0;</span>
<span class="nc bnc" id="L2034" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13014)) {</span>
                    {
<span class="nc" id="L2036">                        long _loopCounter228 = 0;</span>
<span class="nc bnc" id="L2037" title="All 2 branches missed.">                        for (Map.Entry&lt;String, String&gt; entry : nameToNum.entrySet()) {</span>
<span class="nc" id="L2038">                            ListenerUtil.loopListener.listen(&quot;_loopCounter228&quot;, ++_loopCounter228);</span>
<span class="nc" id="L2039">                            String file = entry.getKey();</span>
<span class="nc" id="L2040">                            String c = entry.getValue();</span>
<span class="nc" id="L2041">                            File of = new File(mediaDir, file);</span>
<span class="nc bnc" id="L2042" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(12999)) {</span>
<span class="nc bnc" id="L2043" title="All 2 branches missed.">                                if (!of.exists()) {</span>
<span class="nc bnc" id="L2044" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(12998)) {</span>
<span class="nc" id="L2045">                                        Utils.unzipFiles(zip, mediaDir, new String[] { c }, numToName);</span>
                                    }
                                }
                            }
<span class="nc bnc" id="L2049" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(13000)) {</span>
<span class="nc" id="L2050">                                ++i;</span>
                            }
<span class="nc bnc" id="L2052" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(13013)) {</span>
<span class="nc bnc" id="L2053" title="All 248 branches missed.">                                collectionTask.doProgress(res.getString(R.string.import_media_count, (ListenerUtil.mutListener.listen(13012) ? ((ListenerUtil.mutListener.listen(13008) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) % 100) : (ListenerUtil.mutListener.listen(13007) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) / 100) : (ListenerUtil.mutListener.listen(13006) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) - 100) : (ListenerUtil.mutListener.listen(13005) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) + 100) : (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) * 100))))) % total) : (ListenerUtil.mutListener.listen(13011) ? ((ListenerUtil.mutListener.listen(13008) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) % 100) : (ListenerUtil.mutListener.listen(13007) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) / 100) : (ListenerUtil.mutListener.listen(13006) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) - 100) : (ListenerUtil.mutListener.listen(13005) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) + 100) : (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) * 100))))) * total) : (ListenerUtil.mutListener.listen(13010) ? ((ListenerUtil.mutListener.listen(13008) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) % 100) : (ListenerUtil.mutListener.listen(13007) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) / 100) : (ListenerUtil.mutListener.listen(13006) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) - 100) : (ListenerUtil.mutListener.listen(13005) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) + 100) : (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) * 100))))) - total) : (ListenerUtil.mutListener.listen(13009) ? ((ListenerUtil.mutListener.listen(13008) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) % 100) : (ListenerUtil.mutListener.listen(13007) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) / 100) : (ListenerUtil.mutListener.listen(13006) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) - 100) : (ListenerUtil.mutListener.listen(13005) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) + 100) : (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) * 100))))) + total) : ((ListenerUtil.mutListener.listen(13008) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) % 100) : (ListenerUtil.mutListener.listen(13007) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) / 100) : (ListenerUtil.mutListener.listen(13006) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) - 100) : (ListenerUtil.mutListener.listen(13005) ? (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) + 100) : (((ListenerUtil.mutListener.listen(13004) ? (i % 1) : (ListenerUtil.mutListener.listen(13003) ? (i / 1) : (ListenerUtil.mutListener.listen(13002) ? (i * 1) : (ListenerUtil.mutListener.listen(13001) ? (i - 1) : (i + 1)))))) * 100))))) / total)))))));</span>
                            }
<span class="nc" id="L2055">                        }</span>
                    }
                }
<span class="nc bnc" id="L2058" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13015)) {</span>
<span class="nc" id="L2059">                    zip.close();</span>
                }
<span class="nc bnc" id="L2061" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13016)) {</span>
                    // delete tmp dir
<span class="nc" id="L2063">                    BackupManager.removeDir(dir);</span>
                }
<span class="nc" id="L2065">                return True;</span>
<span class="nc" id="L2066">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L2067" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12985)) {</span>
<span class="nc" id="L2068">                    Timber.e(e, &quot;doInBackgroundImportReplace - RuntimeException&quot;);</span>
                }
<span class="nc bnc" id="L2070" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12986)) {</span>
<span class="nc" id="L2071">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundImportReplace1&quot;);</span>
                }
<span class="nc" id="L2073">                return False;</span>
<span class="nc" id="L2074">            } catch (FileNotFoundException e) {</span>
<span class="nc bnc" id="L2075" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12987)) {</span>
<span class="nc" id="L2076">                    Timber.e(e, &quot;doInBackgroundImportReplace - FileNotFoundException&quot;);</span>
                }
<span class="nc bnc" id="L2078" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12988)) {</span>
<span class="nc" id="L2079">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundImportReplace2&quot;);</span>
                }
<span class="nc" id="L2081">                return False;</span>
<span class="nc" id="L2082">            } catch (IOException e) {</span>
<span class="nc bnc" id="L2083" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12989)) {</span>
<span class="nc" id="L2084">                    Timber.e(e, &quot;doInBackgroundImportReplace - IOException&quot;);</span>
                }
<span class="nc bnc" id="L2086" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(12990)) {</span>
<span class="nc" id="L2087">                    AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundImportReplace3&quot;);</span>
                }
<span class="nc" id="L2089">                return False;</span>
            }
        }
    }

    public static class ExportApkg extends Task&lt;Void, Pair&lt;Boolean, String&gt;&gt; {

        private final String apkgPath;

        private final Long did;

        private final Boolean includeSched;

        private final Boolean includeMedia;

<span class="nc" id="L2104">        public ExportApkg(String apkgPath, Long did, Boolean includeSched, Boolean includeMedia) {</span>
<span class="nc" id="L2105">            this.apkgPath = apkgPath;</span>
<span class="nc" id="L2106">            this.did = did;</span>
<span class="nc" id="L2107">            this.includeSched = includeSched;</span>
<span class="nc" id="L2108">            this.includeMedia = includeMedia;</span>
<span class="nc" id="L2109">        }</span>

        protected Pair&lt;Boolean, String&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2112" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13017)) {</span>
<span class="nc" id="L2113">                Timber.d(&quot;doInBackgroundExportApkg&quot;);</span>
            }
            try {
<span class="nc" id="L2116">                AnkiPackageExporter exporter = new AnkiPackageExporter(col);</span>
<span class="nc bnc" id="L2117" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13022)) {</span>
<span class="nc" id="L2118">                    exporter.setIncludeSched(includeSched);</span>
                }
<span class="nc bnc" id="L2120" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13023)) {</span>
<span class="nc" id="L2121">                    exporter.setIncludeMedia(includeMedia);</span>
                }
<span class="nc bnc" id="L2123" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13024)) {</span>
<span class="nc" id="L2124">                    exporter.setDid(did);</span>
                }
<span class="nc bnc" id="L2126" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13025)) {</span>
<span class="nc" id="L2127">                    exporter.exportInto(apkgPath, col.getContext());</span>
                }
<span class="nc" id="L2129">            } catch (FileNotFoundException e) {</span>
<span class="nc bnc" id="L2130" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13018)) {</span>
<span class="nc" id="L2131">                    Timber.e(e, &quot;FileNotFoundException in doInBackgroundExportApkg&quot;);</span>
                }
<span class="nc" id="L2133">                return new Pair&lt;&gt;(false, null);</span>
<span class="nc" id="L2134">            } catch (IOException e) {</span>
<span class="nc bnc" id="L2135" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13019)) {</span>
<span class="nc" id="L2136">                    Timber.e(e, &quot;IOException in doInBackgroundExportApkg&quot;);</span>
                }
<span class="nc" id="L2138">                return new Pair&lt;&gt;(false, null);</span>
<span class="nc" id="L2139">            } catch (JSONException e) {</span>
<span class="nc bnc" id="L2140" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13020)) {</span>
<span class="nc" id="L2141">                    Timber.e(e, &quot;JSOnException in doInBackgroundExportApkg&quot;);</span>
                }
<span class="nc" id="L2143">                return new Pair&lt;&gt;(false, null);</span>
<span class="nc" id="L2144">            } catch (ImportExportException e) {</span>
<span class="nc bnc" id="L2145" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13021)) {</span>
<span class="nc" id="L2146">                    Timber.e(e, &quot;ImportExportException in doInBackgroundExportApkg&quot;);</span>
                }
<span class="nc" id="L2148">                return new Pair&lt;&gt;(true, e.getMessage());</span>
<span class="nc" id="L2149">            }</span>
<span class="nc" id="L2150">            return new Pair&lt;&gt;(false, apkgPath);</span>
        }
    }

    public static class Reorder extends Task&lt;Void, Boolean&gt; {

        private final DeckConfig conf;

<span class="nc" id="L2158">        public Reorder(DeckConfig conf) {</span>
<span class="nc" id="L2159">            this.conf = conf;</span>
<span class="nc" id="L2160">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2163" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13026)) {</span>
<span class="nc" id="L2164">                Timber.d(&quot;doInBackgroundReorder&quot;);</span>
            }
<span class="nc bnc" id="L2166" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13027)) {</span>
<span class="nc" id="L2167">                col.getSched().resortConf(conf);</span>
            }
<span class="nc" id="L2169">            return true;</span>
        }
    }

    public static class ConfChange extends Task&lt;Void, Boolean&gt; {

        private final Deck deck;

        private final DeckConfig conf;

<span class="nc" id="L2179">        public ConfChange(Deck deck, DeckConfig conf) {</span>
<span class="nc" id="L2180">            this.deck = deck;</span>
<span class="nc" id="L2181">            this.conf = conf;</span>
<span class="nc" id="L2182">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2185" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13028)) {</span>
<span class="nc" id="L2186">                Timber.d(&quot;doInBackgroundConfChange&quot;);</span>
            }
            try {
<span class="nc" id="L2189">                long newConfId = conf.getLong(&quot;id&quot;);</span>
                // If new config has a different sorting order, reorder the cards
<span class="nc" id="L2191">                int oldOrder = col.getDecks().getConf(deck.getLong(&quot;conf&quot;)).getJSONObject(&quot;new&quot;).getInt(&quot;order&quot;);</span>
<span class="nc" id="L2192">                int newOrder = col.getDecks().getConf(newConfId).getJSONObject(&quot;new&quot;).getInt(&quot;order&quot;);</span>
<span class="nc bnc" id="L2193" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13037)) {</span>
<span class="nc bnc" id="L2194" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(13033) ? (oldOrder &gt;= newOrder) : (ListenerUtil.mutListener.listen(13032) ? (oldOrder &lt;= newOrder) : (ListenerUtil.mutListener.listen(13031) ? (oldOrder &gt; newOrder) : (ListenerUtil.mutListener.listen(13030) ? (oldOrder &lt; newOrder) : (ListenerUtil.mutListener.listen(13029) ? (oldOrder == newOrder) : (oldOrder != newOrder))))))) {</span>
<span class="nc bnc" id="L2195" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13036)) {</span>
<span class="nc bnc" id="L2196" title="All 3 branches missed.">                            switch(newOrder) {</span>
                                case 0:
<span class="nc bnc" id="L2198" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(13034)) {</span>
<span class="nc" id="L2199">                                        col.getSched().randomizeCards(deck.getLong(&quot;id&quot;));</span>
                                    }
                                    break;
                                case 1:
<span class="nc bnc" id="L2203" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(13035)) {</span>
<span class="nc" id="L2204">                                        col.getSched().orderCards(deck.getLong(&quot;id&quot;));</span>
                                    }
                                    break;
                            }
                        }
                    }
                }
<span class="nc bnc" id="L2211" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13038)) {</span>
<span class="nc" id="L2212">                    col.getDecks().setConf(deck, newConfId);</span>
                }
<span class="nc bnc" id="L2214" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13039)) {</span>
<span class="nc" id="L2215">                    col.save();</span>
                }
<span class="nc" id="L2217">                return true;</span>
<span class="nc" id="L2218">            } catch (JSONException e) {</span>
<span class="nc" id="L2219">                return false;</span>
            }
        }
    }

    public static class ConfReset extends Task&lt;Void, Boolean&gt; {

        private final DeckConfig conf;

<span class="nc" id="L2228">        public ConfReset(DeckConfig conf) {</span>
<span class="nc" id="L2229">            this.conf = conf;</span>
<span class="nc" id="L2230">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2233" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13040)) {</span>
<span class="nc" id="L2234">                Timber.d(&quot;doInBackgroundConfReset&quot;);</span>
            }
<span class="nc bnc" id="L2236" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13041)) {</span>
<span class="nc" id="L2237">                col.getDecks().restoreToDefault(conf);</span>
            }
<span class="nc bnc" id="L2239" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13042)) {</span>
<span class="nc" id="L2240">                col.save();</span>
            }
<span class="nc" id="L2242">            return null;</span>
        }
    }

    public static class ConfRemove extends Task&lt;Void, Boolean&gt; {

        private final DeckConfig conf;

<span class="nc" id="L2250">        public ConfRemove(DeckConfig conf) {</span>
<span class="nc" id="L2251">            this.conf = conf;</span>
<span class="nc" id="L2252">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2255" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13043)) {</span>
<span class="nc" id="L2256">                Timber.d(&quot;doInBackgroundConfRemove&quot;);</span>
            }
            try {
                // Cards must be reordered according to the default conf.
<span class="nc" id="L2260">                int order = conf.getJSONObject(&quot;new&quot;).getInt(&quot;order&quot;);</span>
<span class="nc" id="L2261">                int defaultOrder = col.getDecks().getConf(1).getJSONObject(&quot;new&quot;).getInt(&quot;order&quot;);</span>
<span class="nc bnc" id="L2262" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13051)) {</span>
<span class="nc bnc" id="L2263" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(13048) ? (order &gt;= defaultOrder) : (ListenerUtil.mutListener.listen(13047) ? (order &lt;= defaultOrder) : (ListenerUtil.mutListener.listen(13046) ? (order &gt; defaultOrder) : (ListenerUtil.mutListener.listen(13045) ? (order &lt; defaultOrder) : (ListenerUtil.mutListener.listen(13044) ? (order == defaultOrder) : (order != defaultOrder))))))) {</span>
<span class="nc bnc" id="L2264" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13049)) {</span>
<span class="nc" id="L2265">                            conf.getJSONObject(&quot;new&quot;).put(&quot;order&quot;, defaultOrder);</span>
                        }
<span class="nc bnc" id="L2267" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13050)) {</span>
<span class="nc" id="L2268">                            col.getSched().resortConf(conf);</span>
                        }
                    }
                }
<span class="nc bnc" id="L2272" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13052)) {</span>
<span class="nc" id="L2273">                    col.save();</span>
                }
<span class="nc" id="L2275">                return true;</span>
<span class="nc" id="L2276">            } catch (JSONException e) {</span>
<span class="nc" id="L2277">                return false;</span>
            }
        }
    }

    public static class ConfSetSubdecks extends Task&lt;Void, Boolean&gt; {

        private final Deck deck;

        private final DeckConfig conf;

<span class="nc" id="L2288">        public ConfSetSubdecks(Deck deck, DeckConfig conf) {</span>
<span class="nc" id="L2289">            this.deck = deck;</span>
<span class="nc" id="L2290">            this.conf = conf;</span>
<span class="nc" id="L2291">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2294" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13053)) {</span>
<span class="nc" id="L2295">                Timber.d(&quot;doInBackgroundConfSetSubdecks&quot;);</span>
            }
            try {
<span class="nc" id="L2298">                TreeMap&lt;String, Long&gt; children = col.getDecks().children(deck.getLong(&quot;id&quot;));</span>
                {
<span class="nc" id="L2300">                    long _loopCounter229 = 0;</span>
<span class="nc bnc" id="L2301" title="All 2 branches missed.">                    for (long childDid : children.values()) {</span>
<span class="nc" id="L2302">                        ListenerUtil.loopListener.listen(&quot;_loopCounter229&quot;, ++_loopCounter229);</span>
<span class="nc" id="L2303">                        Deck child = col.getDecks().get(childDid);</span>
<span class="nc bnc" id="L2304" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13054)) {</span>
<span class="nc bnc" id="L2305" title="All 2 branches missed.">                            if (child.getInt(&quot;dyn&quot;) == DECK_DYN) {</span>
<span class="nc" id="L2306">                                continue;</span>
                            }
                        }
<span class="nc" id="L2309">                        boolean changed = new ConfChange(child, conf).task(col, collectionTask);</span>
<span class="nc bnc" id="L2310" title="All 2 branches missed.">                        if (!changed) {</span>
<span class="nc" id="L2311">                            return false;</span>
                        }
<span class="nc" id="L2313">                    }</span>
                }
<span class="nc" id="L2315">                return true;</span>
<span class="nc" id="L2316">            } catch (JSONException e) {</span>
<span class="nc" id="L2317">                return false;</span>
            }
        }
    }

    /**
     * @return The results list from the check, or false if any errors.
     */
<span class="nc" id="L2325">    public static class CheckMedia extends Task&lt;Void, PairWithBoolean&lt;List&lt;List&lt;String&gt;&gt;&gt;&gt; {</span>

        @Override
        protected PairWithBoolean&lt;List&lt;List&lt;String&gt;&gt;&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2329" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13055)) {</span>
<span class="nc" id="L2330">                Timber.d(&quot;doInBackgroundCheckMedia&quot;);</span>
            }
            // Ensure that the DB is valid - unknown why, but some users were missing the meta table.
            try {
<span class="nc bnc" id="L2334" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13056)) {</span>
<span class="nc" id="L2335">                    col.getMedia().rebuildIfInvalid();</span>
                }
<span class="nc" id="L2337">            } catch (IOException e) {</span>
<span class="nc" id="L2338">                return new PairWithBoolean&lt;&gt;(false, null);</span>
<span class="nc" id="L2339">            }</span>
<span class="nc bnc" id="L2340" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13057)) {</span>
                // A media check on AnkiDroid will also update the media db
<span class="nc" id="L2342">                col.getMedia().findChanges(true);</span>
            }
            // Then do the actual check
<span class="nc" id="L2345">            return new PairWithBoolean&lt;&gt;(true, col.getMedia().check());</span>
        }
    }

    public static class DeleteMedia extends Task&lt;Void, Integer&gt; {

        private final List&lt;String&gt; unused;

<span class="nc" id="L2353">        public DeleteMedia(List&lt;String&gt; unused) {</span>
<span class="nc" id="L2354">            this.unused = unused;</span>
<span class="nc" id="L2355">        }</span>

        protected Integer task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc" id="L2358">            com.ichi2.libanki.Media m = col.getMedia();</span>
<span class="nc bnc" id="L2359" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13059)) {</span>
                {
<span class="nc" id="L2361">                    long _loopCounter230 = 0;</span>
<span class="nc bnc" id="L2362" title="All 2 branches missed.">                    for (String fname : unused) {</span>
<span class="nc" id="L2363">                        ListenerUtil.loopListener.listen(&quot;_loopCounter230&quot;, ++_loopCounter230);</span>
<span class="nc bnc" id="L2364" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13058)) {</span>
<span class="nc" id="L2365">                            m.removeFile(fname);</span>
                        }
<span class="nc" id="L2367">                    }</span>
                }
            }
<span class="nc" id="L2370">            return unused.size();</span>
        }
    }

    /**
     * Handles everything for a model change at once - template add / deletes as well as content updates
     */
    public static class SaveModel extends Task&lt;Void, Pair&lt;Boolean, String&gt;&gt; {

        private final Model model;

        private final ArrayList&lt;Object[]&gt; templateChanges;

<span class="nc" id="L2383">        public SaveModel(Model model, ArrayList&lt;Object[]&gt; templateChanges) {</span>
<span class="nc" id="L2384">            this.model = model;</span>
<span class="nc" id="L2385">            this.templateChanges = templateChanges;</span>
<span class="nc" id="L2386">        }</span>

        protected Pair&lt;Boolean, String&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2389" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13060)) {</span>
<span class="nc" id="L2390">                Timber.d(&quot;doInBackgroundSaveModel&quot;);</span>
            }
<span class="nc" id="L2392">            Model oldModel = col.getModels().get(model.getLong(&quot;id&quot;));</span>
            // - undo (except for cards) could just be Models.update(model) / Models.flush() / Collection.reset() (that was prior &quot;undo&quot;)
<span class="nc" id="L2394">            JSONArray newTemplates = model.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L2395" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13061)) {</span>
<span class="nc" id="L2396">                col.getDb().getDatabase().beginTransaction();</span>
            }
            try {
<span class="nc bnc" id="L2399" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13071)) {</span>
                    {
<span class="nc" id="L2401">                        long _loopCounter231 = 0;</span>
<span class="nc bnc" id="L2402" title="All 2 branches missed.">                        for (Object[] change : templateChanges) {</span>
<span class="nc" id="L2403">                            ListenerUtil.loopListener.listen(&quot;_loopCounter231&quot;, ++_loopCounter231);</span>
<span class="nc" id="L2404">                            JSONArray oldTemplates = oldModel.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L2405" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(13070)) {</span>
<span class="nc bnc" id="L2406" title="All 3 branches missed.">                                switch((TemporaryModel.ChangeType) change[1]) {</span>
                                    case ADD:
<span class="nc bnc" id="L2408" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(13063)) {</span>
<span class="nc" id="L2409">                                            Timber.d(&quot;doInBackgroundSaveModel() adding template %s&quot;, change[0]);</span>
                                        }
                                        try {
<span class="nc bnc" id="L2412" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(13065)) {</span>
<span class="nc" id="L2413">                                                col.getModels().addTemplate(oldModel, newTemplates.getJSONObject((int) change[0]));</span>
                                            }
<span class="nc" id="L2415">                                        } catch (Exception e) {</span>
<span class="nc bnc" id="L2416" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(13064)) {</span>
<span class="nc" id="L2417">                                                Timber.e(e, &quot;Unable to add template %s to model %s&quot;, change[0], model.getLong(&quot;id&quot;));</span>
                                            }
<span class="nc" id="L2419">                                            return new Pair&lt;&gt;(false, e.getLocalizedMessage());</span>
<span class="nc" id="L2420">                                        }</span>
                                        break;
                                    case DELETE:
<span class="nc bnc" id="L2423" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(13066)) {</span>
<span class="nc" id="L2424">                                            Timber.d(&quot;doInBackgroundSaveModel() deleting template currently at ordinal %s&quot;, change[0]);</span>
                                        }
                                        try {
<span class="nc bnc" id="L2427" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(13068)) {</span>
<span class="nc" id="L2428">                                                col.getModels().remTemplate(oldModel, oldTemplates.getJSONObject((int) change[0]));</span>
                                            }
<span class="nc" id="L2430">                                        } catch (Exception e) {</span>
<span class="nc bnc" id="L2431" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(13067)) {</span>
<span class="nc" id="L2432">                                                Timber.e(e, &quot;Unable to delete template %s from model %s&quot;, change[0], model.getLong(&quot;id&quot;));</span>
                                            }
<span class="nc" id="L2434">                                            return new Pair&lt;&gt;(false, e.getLocalizedMessage());</span>
<span class="nc" id="L2435">                                        }</span>
                                        break;
                                    default:
<span class="nc bnc" id="L2438" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(13069)) {</span>
<span class="nc" id="L2439">                                            Timber.w(&quot;Unknown change type? %s&quot;, change[1]);</span>
                                        }
                                        break;
                                }
                            }
<span class="nc" id="L2444">                        }</span>
                    }
                }
<span class="nc bnc" id="L2447" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13072)) {</span>
<span class="nc" id="L2448">                    col.getModels().save(model, true);</span>
                }
<span class="nc bnc" id="L2450" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13073)) {</span>
<span class="nc" id="L2451">                    col.getModels().update(model);</span>
                }
<span class="nc bnc" id="L2453" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13074)) {</span>
<span class="nc" id="L2454">                    col.reset();</span>
                }
<span class="nc bnc" id="L2456" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13075)) {</span>
<span class="nc" id="L2457">                    col.save();</span>
                }
<span class="nc bnc" id="L2459" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13078)) {</span>
<span class="nc bnc" id="L2460" title="All 2 branches missed.">                    if (col.getDb().getDatabase().inTransaction()) {</span>
<span class="nc bnc" id="L2461" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13077)) {</span>
<span class="nc" id="L2462">                            col.getDb().getDatabase().setTransactionSuccessful();</span>
                        }
                    } else {
<span class="nc bnc" id="L2465" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13076)) {</span>
<span class="nc" id="L2466">                            Timber.i(&quot;CollectionTask::SaveModel was not in a transaction? Cannot mark transaction successful.&quot;);</span>
                        }
                    }
                }
            } finally {
<span class="nc bnc" id="L2471" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13062)) {</span>
<span class="nc" id="L2472">                    DB.safeEndInTransaction(col.getDb());</span>
                }
            }
<span class="nc" id="L2475">            return new Pair&lt;&gt;(true, null);</span>
        }
    }

    /*
     * Async task for the ModelBrowser Class
     * Returns an ArrayList of all models alphabetically ordered and the number of notes
     * associated with each model.
     *
     * @return {ArrayList&lt;JSONObject&gt; models, ArrayList&lt;Integer&gt; cardCount}
     */
<span class="nc" id="L2486">    public static class CountModels extends Task&lt;Void, Pair&lt;ArrayList&lt;Model&gt;, ArrayList&lt;Integer&gt;&gt;&gt; {</span>

        protected Pair&lt;ArrayList&lt;Model&gt;, ArrayList&lt;Integer&gt;&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2489" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13079)) {</span>
<span class="nc" id="L2490">                Timber.d(&quot;doInBackgroundLoadModels&quot;);</span>
            }
<span class="nc" id="L2492">            ArrayList&lt;Model&gt; models = col.getModels().all();</span>
<span class="nc" id="L2493">            ArrayList&lt;Integer&gt; cardCount = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2494" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13080)) {</span>
<span class="nc" id="L2495">                Collections.sort(models, (Comparator&lt;JSONObject&gt;) (a, b) -&gt; a.getString(&quot;name&quot;).compareTo(b.getString(&quot;name&quot;)));</span>
            }
<span class="nc bnc" id="L2497" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13084)) {</span>
                {
<span class="nc" id="L2499">                    long _loopCounter232 = 0;</span>
<span class="nc bnc" id="L2500" title="All 2 branches missed.">                    for (Model n : models) {</span>
<span class="nc" id="L2501">                        ListenerUtil.loopListener.listen(&quot;_loopCounter232&quot;, ++_loopCounter232);</span>
<span class="nc bnc" id="L2502" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13082)) {</span>
<span class="nc bnc" id="L2503" title="All 2 branches missed.">                            if (collectionTask.isCancelled()) {</span>
<span class="nc bnc" id="L2504" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(13081)) {</span>
<span class="nc" id="L2505">                                    Timber.e(&quot;doInBackgroundLoadModels :: Cancelled&quot;);</span>
                                }
                                // onPostExecute not executed if cancelled. Return value not used.
<span class="nc" id="L2508">                                return null;</span>
                            }
                        }
<span class="nc bnc" id="L2511" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13083)) {</span>
<span class="nc" id="L2512">                            cardCount.add(col.getModels().useCount(n));</span>
                        }
<span class="nc" id="L2514">                    }</span>
                }
            }
<span class="nc" id="L2517">            return new Pair&lt;&gt;(models, cardCount);</span>
        }
    }

    /**
     * Deletes the given model
     * and all notes associated with it
     */
    public static class DeleteModel extends Task&lt;Void, Boolean&gt; {

        private final long modID;

<span class="nc" id="L2529">        public DeleteModel(long modID) {</span>
<span class="nc" id="L2530">            this.modID = modID;</span>
<span class="nc" id="L2531">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2534" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13085)) {</span>
<span class="nc" id="L2535">                Timber.d(&quot;doInBackGroundDeleteModel&quot;);</span>
            }
            try {
<span class="nc bnc" id="L2538" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13087)) {</span>
<span class="nc" id="L2539">                    col.getModels().rem(col.getModels().get(modID));</span>
                }
<span class="nc bnc" id="L2541" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13088)) {</span>
<span class="nc" id="L2542">                    col.save();</span>
                }
<span class="nc" id="L2544">            } catch (ConfirmModSchemaException e) {</span>
<span class="nc bnc" id="L2545" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13086)) {</span>
<span class="nc" id="L2546">                    Timber.e(&quot;doInBackGroundDeleteModel :: ConfirmModSchemaException&quot;);</span>
                }
<span class="nc" id="L2548">                return false;</span>
<span class="nc" id="L2549">            }</span>
<span class="nc" id="L2550">            return true;</span>
        }
    }

    /**
     * Deletes the given field in the given model
     */
    public static class DeleteField extends Task&lt;Void, Boolean&gt; {

        private final Model model;

        private final JSONObject field;

<span class="nc" id="L2563">        public DeleteField(Model model, JSONObject field) {</span>
<span class="nc" id="L2564">            this.model = model;</span>
<span class="nc" id="L2565">            this.field = field;</span>
<span class="nc" id="L2566">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2569" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13089)) {</span>
<span class="nc" id="L2570">                Timber.d(&quot;doInBackGroundDeleteField&quot;);</span>
            }
            try {
<span class="nc bnc" id="L2573" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13090)) {</span>
<span class="nc" id="L2574">                    col.getModels().remField(model, field);</span>
                }
<span class="nc bnc" id="L2576" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13091)) {</span>
<span class="nc" id="L2577">                    col.save();</span>
                }
<span class="nc" id="L2579">            } catch (ConfirmModSchemaException e) {</span>
                // Should never be reached
<span class="nc" id="L2581">                return false;</span>
<span class="nc" id="L2582">            }</span>
<span class="nc" id="L2583">            return true;</span>
        }
    }

    /**
     * Repositions the given field in the given model
     */
    public static class RepositionField extends Task&lt;Void, Boolean&gt; {

        private final Model model;

        private final JSONObject field;

        private final int index;

<span class="nc" id="L2598">        public RepositionField(Model model, JSONObject field, int index) {</span>
<span class="nc" id="L2599">            this.model = model;</span>
<span class="nc" id="L2600">            this.field = field;</span>
<span class="nc" id="L2601">            this.index = index;</span>
<span class="nc" id="L2602">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2605" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13092)) {</span>
<span class="nc" id="L2606">                Timber.d(&quot;doInBackgroundRepositionField&quot;);</span>
            }
            try {
<span class="nc bnc" id="L2609" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13093)) {</span>
<span class="nc" id="L2610">                    col.getModels().moveField(model, field, index);</span>
                }
<span class="nc bnc" id="L2612" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13094)) {</span>
<span class="nc" id="L2613">                    col.save();</span>
                }
<span class="nc" id="L2615">            } catch (ConfirmModSchemaException e) {</span>
                // Should never be reached
<span class="nc" id="L2617">                return false;</span>
<span class="nc" id="L2618">            }</span>
<span class="nc" id="L2619">            return true;</span>
        }
    }

    /**
     * Adds a field with name in given model
     */
    public static class AddField extends Task&lt;Void, Boolean&gt; {

        private final Model model;

        private final String fieldName;

<span class="nc" id="L2632">        public AddField(Model model, String fieldName) {</span>
<span class="nc" id="L2633">            this.model = model;</span>
<span class="nc" id="L2634">            this.fieldName = fieldName;</span>
<span class="nc" id="L2635">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2638" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13095)) {</span>
<span class="nc" id="L2639">                Timber.d(&quot;doInBackgroundRepositionField&quot;);</span>
            }
<span class="nc bnc" id="L2641" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13096)) {</span>
<span class="nc" id="L2642">                col.getModels().addFieldModChanged(model, col.getModels().newField(fieldName));</span>
            }
<span class="nc bnc" id="L2644" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13097)) {</span>
<span class="nc" id="L2645">                col.save();</span>
            }
<span class="nc" id="L2647">            return true;</span>
        }
    }

    /**
     * Adds a field of with name in given model
     */
    public static class ChangeSortField extends Task&lt;Void, Boolean&gt; {

        private final Model model;

        private final int idx;

<span class="nc" id="L2660">        public ChangeSortField(Model model, int idx) {</span>
<span class="nc" id="L2661">            this.model = model;</span>
<span class="nc" id="L2662">            this.idx = idx;</span>
<span class="nc" id="L2663">        }</span>

        protected Boolean task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
            try {
<span class="nc bnc" id="L2667" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13099)) {</span>
<span class="nc" id="L2668">                    Timber.d(&quot;doInBackgroundChangeSortField&quot;);</span>
                }
<span class="nc bnc" id="L2670" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13100)) {</span>
<span class="nc" id="L2671">                    col.getModels().setSortIdx(model, idx);</span>
                }
<span class="nc bnc" id="L2673" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13101)) {</span>
<span class="nc" id="L2674">                    col.save();</span>
                }
<span class="nc" id="L2676">            } catch (Exception e) {</span>
<span class="nc bnc" id="L2677" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13098)) {</span>
<span class="nc" id="L2678">                    Timber.e(e, &quot;Error changing sort field&quot;);</span>
                }
<span class="nc" id="L2680">                return false;</span>
<span class="nc" id="L2681">            }</span>
<span class="nc" id="L2682">            return true;</span>
        }
    }

<span class="nc" id="L2686">    public static class FindEmptyCards extends Task&lt;Integer, List&lt;Long&gt;&gt; {</span>

        protected List&lt;Long&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Integer&gt; collectionTask) {
<span class="nc" id="L2689">            return col.emptyCids(collectionTask);</span>
        }
    }

    /**
     * Goes through selected cards and checks selected and marked attribute
     * @return If there are unselected cards, if there are unmarked cards
     */
    public static class CheckCardSelection extends Task&lt;Void, Pair&lt;Boolean, Boolean&gt;&gt; {

        private final CardBrowser.CardCollection&lt;CardBrowser.CardCache&gt; checkedCards;

<span class="nc" id="L2701">        public CheckCardSelection(CardBrowser.CardCollection&lt;CardBrowser.CardCache&gt; checkedCards) {</span>
<span class="nc" id="L2702">            this.checkedCards = checkedCards;</span>
<span class="nc" id="L2703">        }</span>

        @Nullable
        protected Pair&lt;Boolean, Boolean&gt; task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc" id="L2707">            boolean hasUnsuspended = false;</span>
<span class="nc" id="L2708">            boolean hasUnmarked = false;</span>
<span class="nc bnc" id="L2709" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13115)) {</span>
                {
<span class="nc" id="L2711">                    long _loopCounter233 = 0;</span>
<span class="nc bnc" id="L2712" title="All 2 branches missed.">                    for (CardBrowser.CardCache c : checkedCards) {</span>
<span class="nc" id="L2713">                        ListenerUtil.loopListener.listen(&quot;_loopCounter233&quot;, ++_loopCounter233);</span>
<span class="nc bnc" id="L2714" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13103)) {</span>
<span class="nc bnc" id="L2715" title="All 2 branches missed.">                            if (collectionTask.isCancelled()) {</span>
<span class="nc bnc" id="L2716" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(13102)) {</span>
<span class="nc" id="L2717">                                    Timber.v(&quot;doInBackgroundCheckCardSelection: cancelled.&quot;);</span>
                                }
<span class="nc" id="L2719">                                return null;</span>
                            }
                        }
<span class="nc" id="L2722">                        Card card = c.getCard();</span>
<span class="nc bnc" id="L2723" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13110)) {</span>
<span class="nc bnc" id="L2724" title="All 50 branches missed.">                            hasUnsuspended = (ListenerUtil.mutListener.listen(13109) ? (hasUnsuspended &amp;&amp; (ListenerUtil.mutListener.listen(13108) ? (card.getQueue() &gt;= Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(13107) ? (card.getQueue() &lt;= Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(13106) ? (card.getQueue() &gt; Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(13105) ? (card.getQueue() &lt; Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(13104) ? (card.getQueue() == Consts.QUEUE_TYPE_SUSPENDED) : (card.getQueue() != Consts.QUEUE_TYPE_SUSPENDED))))))) : (hasUnsuspended || (ListenerUtil.mutListener.listen(13108) ? (card.getQueue() &gt;= Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(13107) ? (card.getQueue() &lt;= Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(13106) ? (card.getQueue() &gt; Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(13105) ? (card.getQueue() &lt; Consts.QUEUE_TYPE_SUSPENDED) : (ListenerUtil.mutListener.listen(13104) ? (card.getQueue() == Consts.QUEUE_TYPE_SUSPENDED) : (card.getQueue() != Consts.QUEUE_TYPE_SUSPENDED))))))));</span>
                        }
<span class="nc bnc" id="L2726" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13112)) {</span>
<span class="nc bnc" id="L2727" title="All 10 branches missed.">                            hasUnmarked = (ListenerUtil.mutListener.listen(13111) ? (hasUnmarked &amp;&amp; !card.note().hasTag(&quot;marked&quot;)) : (hasUnmarked || !card.note().hasTag(&quot;marked&quot;)));</span>
                        }
<span class="nc bnc" id="L2729" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(13114)) {</span>
<span class="nc bnc" id="L2730" title="All 10 branches missed.">                            if ((ListenerUtil.mutListener.listen(13113) ? (hasUnsuspended || hasUnmarked) : (hasUnsuspended &amp;&amp; hasUnmarked)))</span>
<span class="nc" id="L2731">                                break;</span>
                        }
<span class="nc" id="L2733">                    }</span>
                }
            }
<span class="nc" id="L2736">            return new Pair&lt;&gt;(hasUnsuspended, hasUnmarked);</span>
        }
    }

<span class="nc" id="L2740">    public static class PreloadNextCard extends Task&lt;Void, Void&gt; {</span>

        public Void task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
            try {
<span class="nc bnc" id="L2744" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13117)) {</span>
                    // Ensure counts are recomputed if necessary, to know queue to look for
<span class="nc" id="L2746">                    col.getSched().counts();</span>
                }
<span class="nc bnc" id="L2748" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13118)) {</span>
<span class="nc" id="L2749">                    col.getSched().preloadNextCard();</span>
                }
<span class="nc" id="L2751">            } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L2752" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(13116)) {</span>
<span class="nc" id="L2753">                    Timber.e(e, &quot;doInBackgroundPreloadNextCard - RuntimeException on preloading card&quot;);</span>
                }
<span class="nc" id="L2755">            }</span>
<span class="nc" id="L2756">            return null;</span>
        }
    }

<span class="nc" id="L2760">    public static class LoadCollectionComplete extends Task&lt;Void, Void&gt; {</span>

        protected Void task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2763" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13120)) {</span>
<span class="nc bnc" id="L2764" title="All 2 branches missed.">                if (col != null) {</span>
<span class="nc bnc" id="L2765" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(13119)) {</span>
<span class="nc" id="L2766">                        CollectionHelper.loadCollectionComplete(col);</span>
                    }
                }
            }
<span class="nc" id="L2770">            return null;</span>
        }
    }

<span class="nc" id="L2774">    public static class Reset extends Task&lt;Void, Void&gt; {</span>

        public Void task(Collection col, ProgressSenderAndCancelListener&lt;Void&gt; collectionTask) {
<span class="nc bnc" id="L2777" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(13121)) {</span>
<span class="nc" id="L2778">                col.getSched().reset();</span>
            }
<span class="nc" id="L2780">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>