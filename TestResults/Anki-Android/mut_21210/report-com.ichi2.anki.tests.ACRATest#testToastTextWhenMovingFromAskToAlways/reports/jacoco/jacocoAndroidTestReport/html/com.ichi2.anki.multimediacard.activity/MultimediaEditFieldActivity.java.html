<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MultimediaEditFieldActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki.multimediacard.activity</a> &gt; <span class="el_source">MultimediaEditFieldActivity.java</span></div><h1>MultimediaEditFieldActivity.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2013 Bibek Shrestha &lt;bibekshrestha@gmail.com&gt;                          *
 *  Copyright (c) 2013 Zaur Molotnikov &lt;qutorial@gmail.com&gt;                              *
 *  Copyright (c) 2013 Nicolas Raoul &lt;nicolas.raoul@gmail.com&gt;                           *
 *  Copyright (c) 2013 Flavio Lerda &lt;flerda@gmail.com&gt;                                   *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.anki.multimediacard.activity;

import android.Manifest;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.os.Bundle;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.VisibleForTesting;
import androidx.core.app.ActivityCompat;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.LinearLayout;
import com.ichi2.anki.AnkiActivity;
import com.ichi2.anki.R;
import com.ichi2.anki.UIUtils;
import com.ichi2.anki.multimediacard.IMultimediaEditableNote;
import com.ichi2.anki.multimediacard.fields.AudioClipField;
import com.ichi2.anki.multimediacard.fields.AudioRecordingField;
import com.ichi2.anki.multimediacard.fields.BasicControllerFactory;
import com.ichi2.anki.multimediacard.fields.BasicImageFieldController;
import com.ichi2.anki.multimediacard.fields.EFieldType;
import com.ichi2.anki.multimediacard.fields.IControllerFactory;
import com.ichi2.anki.multimediacard.fields.IField;
import com.ichi2.anki.multimediacard.fields.IFieldController;
import com.ichi2.anki.multimediacard.fields.ImageField;
import com.ichi2.anki.multimediacard.fields.TextField;
import com.ichi2.utils.Permissions;
import java.io.File;
import java.text.DecimalFormat;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L55">public class MultimediaEditFieldActivity extends AnkiActivity implements ActivityCompat.OnRequestPermissionsResultCallback {</span>

    public static final String EXTRA_RESULT_FIELD = &quot;edit.field.result.field&quot;;

    public static final String EXTRA_RESULT_FIELD_INDEX = &quot;edit.field.result.field.index&quot;;

    public static final String EXTRA_FIELD_INDEX = &quot;multim.card.ed.extra.field.index&quot;;

    public static final String EXTRA_FIELD = &quot;multim.card.ed.extra.field&quot;;

    public static final String EXTRA_WHOLE_NOTE = &quot;multim.card.ed.extra.whole.note&quot;;

    private static final String BUNDLE_KEY_SHUT_OFF = &quot;key.edit.field.shut.off&quot;;

    private static final int REQUEST_AUDIO_PERMISSION = 0;

    private static final int REQUEST_CAMERA_PERMISSION = 1;

    // 1MB in bytes
    public static final int sImageLimit = 1024 * 1024;

    private IField mField;

    private IMultimediaEditableNote mNote;

    private int mFieldIndex;

    private IFieldController mFieldController;

    /**
     * Cached copy of the current request to change a field
     * Used to access past state from OnRequestPermissionsResultCallback
     */
    private ChangeUIRequest mCurrentChangeRequest;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1195)) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">            if (showedActivityFailedScreen(savedInstanceState)) {</span>
<span class="nc" id="L94">                return;</span>
            }
        }
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1196)) {</span>
<span class="nc" id="L98">            super.onCreate(savedInstanceState);</span>
        }
<span class="nc" id="L100">        Bundle controllerBundle = null;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1203)) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (savedInstanceState != null) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1197)) {</span>
<span class="nc" id="L104">                    Timber.i(&quot;onCreate - saved bundle exists&quot;);</span>
                }
<span class="nc" id="L106">                boolean b = savedInstanceState.getBoolean(BUNDLE_KEY_SHUT_OFF, false);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1198)) {</span>
<span class="nc" id="L108">                    controllerBundle = savedInstanceState.getBundle(&quot;controllerBundle&quot;);</span>
                }
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1202)) {</span>
<span class="nc bnc" id="L111" title="All 10 branches missed.">                    if ((ListenerUtil.mutListener.listen(1199) ? (controllerBundle == null || b) : (controllerBundle == null &amp;&amp; b))) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1200)) {</span>
<span class="nc" id="L113">                            Timber.i(&quot;onCreate - saved bundle has BUNDLE_KEY_SHUT_OFF and no controller bundle, terminating&quot;);</span>
                        }
<span class="nc bnc" id="L115" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1201)) {</span>
<span class="nc" id="L116">                            finishCancel();</span>
                        }
<span class="nc" id="L118">                        return;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1204)) {</span>
<span class="nc" id="L124">            setContentView(R.layout.multimedia_edit_field_activity);</span>
        }
<span class="nc" id="L126">        View mainView = findViewById(android.R.id.content);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1205)) {</span>
<span class="nc" id="L128">            enableToolbar(mainView);</span>
        }
<span class="nc" id="L130">        Intent intent = this.getIntent();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1206)) {</span>
<span class="nc" id="L132">            mField = getFieldFromIntent(intent);</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1207)) {</span>
<span class="nc" id="L135">            mNote = (IMultimediaEditableNote) intent.getSerializableExtra(EXTRA_WHOLE_NOTE);</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1208)) {</span>
<span class="nc" id="L138">            mFieldIndex = intent.getIntExtra(EXTRA_FIELD_INDEX, 0);</span>
        }
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1211)) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (mField == null) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1209)) {</span>
<span class="nc" id="L143">                    UIUtils.showThemedToast(this, getString(R.string.multimedia_editor_failed), false);</span>
                }
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1210)) {</span>
<span class="nc" id="L146">                    finishCancel();</span>
                }
<span class="nc" id="L148">                return;</span>
            }
        }
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1212)) {</span>
<span class="nc" id="L152">            recreateEditingUi(ChangeUIRequest.init(mField), controllerBundle);</span>
        }
<span class="nc" id="L154">    }</span>

    @VisibleForTesting
    public static IField getFieldFromIntent(Intent intent) {
<span class="nc" id="L158">        return (IField) intent.getExtras().getSerializable(EXTRA_FIELD);</span>
    }

    private void finishCancel() {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1213)) {</span>
<span class="nc" id="L163">            Timber.d(&quot;Completing activity via finishCancel()&quot;);</span>
        }
<span class="nc" id="L165">        Intent resultData = new Intent();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1214)) {</span>
<span class="nc" id="L167">            setResult(RESULT_CANCELED, resultData);</span>
        }
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1215)) {</span>
<span class="nc" id="L170">            finishWithoutAnimation();</span>
        }
<span class="nc" id="L172">    }</span>

    private boolean performPermissionRequest(IField field) {
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1219)) {</span>
            // Request permission to record if audio field
<span class="nc bnc" id="L177" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1216) ? (field instanceof AudioRecordingField || !Permissions.canRecordAudio(this)) : (field instanceof AudioRecordingField &amp;&amp; !Permissions.canRecordAudio(this)))) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1217)) {</span>
<span class="nc" id="L179">                    Timber.d(&quot;Requesting Audio Permissions&quot;);</span>
                }
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1218)) {</span>
<span class="nc" id="L182">                    ActivityCompat.requestPermissions(this, new String[] { Manifest.permission.RECORD_AUDIO }, REQUEST_AUDIO_PERMISSION);</span>
                }
<span class="nc" id="L184">                return true;</span>
            }
        }
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1223)) {</span>
            // Request permission to use the camera if image field
<span class="nc bnc" id="L189" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1220) ? (field instanceof ImageField || !Permissions.canUseCamera(this)) : (field instanceof ImageField &amp;&amp; !Permissions.canUseCamera(this)))) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1221)) {</span>
<span class="nc" id="L191">                    Timber.d(&quot;Requesting Camera Permissions&quot;);</span>
                }
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1222)) {</span>
<span class="nc" id="L194">                    ActivityCompat.requestPermissions(this, new String[] { Manifest.permission.CAMERA }, REQUEST_CAMERA_PERMISSION);</span>
                }
<span class="nc" id="L196">                return true;</span>
            }
        }
<span class="nc" id="L199">        return false;</span>
    }

    /**
     * Sets various properties required for IFieldController to be in a valid state
     */
    private void setupUIController(IFieldController fieldController, @Nullable Bundle savedInstanceState) {
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1224)) {</span>
<span class="nc" id="L207">            fieldController.setField(mField);</span>
        }
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1225)) {</span>
<span class="nc" id="L210">            fieldController.setFieldIndex(mFieldIndex);</span>
        }
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1226)) {</span>
<span class="nc" id="L213">            fieldController.setNote(mNote);</span>
        }
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1227)) {</span>
<span class="nc" id="L216">            fieldController.setEditingActivity(this);</span>
        }
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1228)) {</span>
<span class="nc" id="L219">            fieldController.loadInstanceState(savedInstanceState);</span>
        }
<span class="nc" id="L221">    }</span>

    private void recreateEditingUi(ChangeUIRequest newUI) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1229)) {</span>
<span class="nc" id="L225">            this.recreateEditingUi(newUI, null);</span>
        }
<span class="nc" id="L227">    }</span>

    private void recreateEditingUi(ChangeUIRequest newUI, @Nullable Bundle savedInstanceState) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1230)) {</span>
<span class="nc" id="L231">            Timber.d(&quot;recreateEditingUi()&quot;);</span>
        }
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1231)) {</span>
            // Permissions are checked async, save our current state to allow continuation
<span class="nc" id="L235">            mCurrentChangeRequest = newUI;</span>
        }
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1234)) {</span>
            // As we only get here a second time if we have the required permissions
<span class="nc bnc" id="L239" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1232) ? (newUI.getRequiresPermissionCheck() || performPermissionRequest(newUI.getField())) : (newUI.getRequiresPermissionCheck() &amp;&amp; performPermissionRequest(newUI.getField())))) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1233)) {</span>
<span class="nc" id="L241">                    newUI.markAsPermissionRequested();</span>
                }
<span class="nc" id="L243">                return;</span>
            }
        }
<span class="nc" id="L246">        IControllerFactory controllerFactory = BasicControllerFactory.getInstance();</span>
<span class="nc" id="L247">        IFieldController fieldController = controllerFactory.createControllerForField(newUI.getField());</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1237)) {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (fieldController == null) {</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1235)) {</span>
<span class="nc" id="L251">                    Timber.w(&quot;Field controller creation failed&quot;);</span>
                }
<span class="nc bnc" id="L253" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1236)) {</span>
<span class="nc" id="L254">                    UIRecreationHandler.onControllerCreationFailed(newUI, this);</span>
                }
<span class="nc" id="L256">                return;</span>
            }
        }
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1238)) {</span>
<span class="nc" id="L260">            UIRecreationHandler.onPreFieldControllerReplacement(mFieldController);</span>
        }
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1239)) {</span>
<span class="nc" id="L263">            mFieldController = fieldController;</span>
        }
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1240)) {</span>
<span class="nc" id="L266">            mField = newUI.getField();</span>
        }
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1241)) {</span>
<span class="nc" id="L269">            setupUIController(mFieldController, savedInstanceState);</span>
        }
<span class="nc" id="L271">        LinearLayout linearLayout = findViewById(R.id.LinearLayoutInScrollViewFieldEdit);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1242)) {</span>
<span class="nc" id="L273">            linearLayout.removeAllViews();</span>
        }
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1243)) {</span>
<span class="nc" id="L276">            mFieldController.createUI(this, linearLayout);</span>
        }
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1244)) {</span>
<span class="nc" id="L279">            UIRecreationHandler.onPostUICreation(newUI, this);</span>
        }
<span class="nc" id="L281">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1245)) {</span>
<span class="nc" id="L286">            Timber.d(&quot;onCreateOptionsMenu() - mField.getType() = %s&quot;, mField.getType());</span>
        }
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1246)) {</span>
            // Inflate the menu; this adds items to the action bar if it is present.
<span class="nc" id="L290">            getMenuInflater().inflate(R.menu.activity_edit_text, menu);</span>
        }
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1247)) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            menu.findItem(R.id.multimedia_edit_field_to_text).setVisible(mField.getType() != EFieldType.TEXT);</span>
        }
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1248)) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">            menu.findItem(R.id.multimedia_edit_field_to_audio).setVisible(mField.getType() != EFieldType.AUDIO_RECORDING);</span>
        }
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1249)) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            menu.findItem(R.id.multimedia_edit_field_to_audio_clip).setVisible(mField.getType() != EFieldType.AUDIO_CLIP);</span>
        }
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1250)) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            menu.findItem(R.id.multimedia_edit_field_to_image).setVisible(mField.getType() != EFieldType.IMAGE);</span>
        }
<span class="nc" id="L304">        return true;</span>
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc" id="L309">        int itemId = item.getItemId();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1261)) {</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if (itemId == R.id.multimedia_edit_field_to_text) {</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1259)) {</span>
<span class="nc" id="L313">                    Timber.i(&quot;To text field button pressed&quot;);</span>
                }
<span class="nc bnc" id="L315" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1260)) {</span>
<span class="nc" id="L316">                    toTextField();</span>
                }
<span class="nc" id="L318">                return true;</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            } else if (itemId == R.id.multimedia_edit_field_to_image) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1257)) {</span>
<span class="nc" id="L321">                    Timber.i(&quot;To image button pressed&quot;);</span>
                }
<span class="nc bnc" id="L323" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1258)) {</span>
<span class="nc" id="L324">                    toImageField();</span>
                }
<span class="nc" id="L326">                return true;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">            } else if (itemId == R.id.multimedia_edit_field_to_audio) {</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1255)) {</span>
<span class="nc" id="L329">                    Timber.i(&quot;To audio recording button pressed&quot;);</span>
                }
<span class="nc bnc" id="L331" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1256)) {</span>
<span class="nc" id="L332">                    toAudioRecordingField();</span>
                }
<span class="nc" id="L334">                return true;</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            } else if (itemId == R.id.multimedia_edit_field_to_audio_clip) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1253)) {</span>
<span class="nc" id="L337">                    Timber.i(&quot;To audio clip button pressed&quot;);</span>
                }
<span class="nc bnc" id="L339" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1254)) {</span>
<span class="nc" id="L340">                    toAudioClipField();</span>
                }
<span class="nc" id="L342">                return true;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            } else if (itemId == R.id.multimedia_edit_field_done) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1251)) {</span>
<span class="nc" id="L345">                    Timber.i(&quot;Save button pressed&quot;);</span>
                }
<span class="nc bnc" id="L347" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1252)) {</span>
<span class="nc" id="L348">                    done();</span>
                }
<span class="nc" id="L350">                return true;</span>
            }
        }
<span class="nc" id="L353">        return super.onOptionsItemSelected(item);</span>
    }

    protected void done() {
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1262)) {</span>
<span class="nc" id="L358">            mFieldController.onDone();</span>
        }
<span class="nc" id="L360">        boolean bChangeToText = false;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1288)) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">            if (mField.getType() == EFieldType.IMAGE) {</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1269)) {</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">                    if (mField.getImagePath() == null) {</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1268)) {</span>
<span class="nc" id="L366">                            bChangeToText = true;</span>
                        }
                    }
                }
<span class="nc bnc" id="L370" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1287)) {</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                    if (!bChangeToText) {</span>
<span class="nc" id="L372">                        File f = new File(mField.getImagePath());</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1286)) {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                            if (!f.exists()) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1285)) {</span>
<span class="nc" id="L376">                                    bChangeToText = true;</span>
                                }
                            } else {
<span class="nc" id="L379">                                long length = f.length();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1284)) {</span>
<span class="nc bnc" id="L381" title="All 22 branches missed.">                                    if ((ListenerUtil.mutListener.listen(1274) ? (length &gt;= sImageLimit) : (ListenerUtil.mutListener.listen(1273) ? (length &lt;= sImageLimit) : (ListenerUtil.mutListener.listen(1272) ? (length &lt; sImageLimit) : (ListenerUtil.mutListener.listen(1271) ? (length != sImageLimit) : (ListenerUtil.mutListener.listen(1270) ? (length == sImageLimit) : (length &gt; sImageLimit))))))) {</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(1283)) {</span>
<span class="nc bnc" id="L383" title="All 48 branches missed.">                                            showLargeFileCropDialog((float) ((ListenerUtil.mutListener.listen(1282) ? ((ListenerUtil.mutListener.listen(1278) ? (1.0 % length) : (ListenerUtil.mutListener.listen(1277) ? (1.0 / length) : (ListenerUtil.mutListener.listen(1276) ? (1.0 - length) : (ListenerUtil.mutListener.listen(1275) ? (1.0 + length) : (1.0 * length))))) % sImageLimit) : (ListenerUtil.mutListener.listen(1281) ? ((ListenerUtil.mutListener.listen(1278) ? (1.0 % length) : (ListenerUtil.mutListener.listen(1277) ? (1.0 / length) : (ListenerUtil.mutListener.listen(1276) ? (1.0 - length) : (ListenerUtil.mutListener.listen(1275) ? (1.0 + length) : (1.0 * length))))) * sImageLimit) : (ListenerUtil.mutListener.listen(1280) ? ((ListenerUtil.mutListener.listen(1278) ? (1.0 % length) : (ListenerUtil.mutListener.listen(1277) ? (1.0 / length) : (ListenerUtil.mutListener.listen(1276) ? (1.0 - length) : (ListenerUtil.mutListener.listen(1275) ? (1.0 + length) : (1.0 * length))))) - sImageLimit) : (ListenerUtil.mutListener.listen(1279) ? ((ListenerUtil.mutListener.listen(1278) ? (1.0 % length) : (ListenerUtil.mutListener.listen(1277) ? (1.0 / length) : (ListenerUtil.mutListener.listen(1276) ? (1.0 - length) : (ListenerUtil.mutListener.listen(1275) ? (1.0 + length) : (1.0 * length))))) + sImageLimit) : ((ListenerUtil.mutListener.listen(1278) ? (1.0 % length) : (ListenerUtil.mutListener.listen(1277) ? (1.0 / length) : (ListenerUtil.mutListener.listen(1276) ? (1.0 - length) : (ListenerUtil.mutListener.listen(1275) ? (1.0 + length) : (1.0 * length))))) / sImageLimit)))))));</span>
                                        }
<span class="nc" id="L385">                                        return;</span>
                                    }
                                }
                            }
                        }
<span class="nc" id="L390">                    }</span>
                }
<span class="nc bnc" id="L392" title="All 2 branches missed.">            } else if (mField.getType() == EFieldType.AUDIO_RECORDING) {</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1264)) {</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">                    if (mField.getAudioPath() == null) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1263)) {</span>
<span class="nc" id="L396">                            bChangeToText = true;</span>
                        }
                    }
                }
<span class="nc bnc" id="L400" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1267)) {</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                    if (!bChangeToText) {</span>
<span class="nc" id="L402">                        File f = new File(mField.getAudioPath());</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1266)) {</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                            if (!f.exists()) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(1265)) {</span>
<span class="nc" id="L406">                                    bChangeToText = true;</span>
                                }
                            }
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L414" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1290)) {</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">            if (bChangeToText) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1289)) {</span>
<span class="nc" id="L417">                    mField = new TextField();</span>
                }
            }
        }
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1291)) {</span>
<span class="nc" id="L422">            saveAndExit();</span>
        }
<span class="nc" id="L424">    }</span>

    protected void toAudioRecordingField() {
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1293)) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            if (mField.getType() != EFieldType.AUDIO_RECORDING) {</span>
<span class="nc" id="L429">                ChangeUIRequest request = ChangeUIRequest.uiChange(new AudioRecordingField());</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1292)) {</span>
<span class="nc" id="L431">                    recreateEditingUi(request);</span>
                }
            }
        }
<span class="nc" id="L435">    }</span>

    protected void toAudioClipField() {
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1295)) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">            if (mField.getType() != EFieldType.AUDIO_CLIP) {</span>
<span class="nc" id="L440">                ChangeUIRequest request = ChangeUIRequest.uiChange(new AudioClipField());</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1294)) {</span>
<span class="nc" id="L442">                    recreateEditingUi(request);</span>
                }
            }
        }
<span class="nc" id="L446">    }</span>

    protected void toImageField() {
<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1297)) {</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">            if (mField.getType() != EFieldType.IMAGE) {</span>
<span class="nc" id="L451">                ChangeUIRequest request = ChangeUIRequest.uiChange(new ImageField());</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1296)) {</span>
<span class="nc" id="L453">                    recreateEditingUi(request);</span>
                }
            }
        }
<span class="nc" id="L457">    }</span>

    protected void toTextField() {
<span class="nc bnc" id="L460" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1299)) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if (mField.getType() != EFieldType.TEXT) {</span>
<span class="nc" id="L462">                ChangeUIRequest request = ChangeUIRequest.uiChange(new TextField());</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1298)) {</span>
<span class="nc" id="L464">                    recreateEditingUi(request);</span>
                }
            }
        }
<span class="nc" id="L468">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc bnc" id="L472" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1300)) {</span>
<span class="nc" id="L473">            Timber.d(&quot;onActivityResult()&quot;);</span>
        }
<span class="nc bnc" id="L475" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1302)) {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">            if (mFieldController != null) {</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1301)) {</span>
<span class="nc" id="L478">                    mFieldController.onActivityResult(requestCode, resultCode, data);</span>
                }
            }
        }
<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1303)) {</span>
<span class="nc" id="L483">            super.onActivityResult(requestCode, resultCode, data);</span>
        }
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1304)) {</span>
<span class="nc" id="L486">            supportInvalidateOptionsMenu();</span>
        }
<span class="nc" id="L488">    }</span>

    private void recreateEditingUIUsingCachedRequest() {
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1305)) {</span>
<span class="nc" id="L492">            Timber.d(&quot;recreateEditingUIUsingCachedRequest()&quot;);</span>
        }
<span class="nc bnc" id="L494" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1307)) {</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">            if (mCurrentChangeRequest == null) {</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1306)) {</span>
<span class="nc" id="L497">                    cancelActivityWithAssertionFailure(&quot;mCurrentChangeRequest should be set before using cached request&quot;);</span>
                }
<span class="nc" id="L499">                return;</span>
            }
        }
<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1308)) {</span>
<span class="nc" id="L503">            recreateEditingUi(mCurrentChangeRequest);</span>
        }
<span class="nc" id="L505">    }</span>

    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1310)) {</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">            if (mCurrentChangeRequest == null) {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1309)) {</span>
<span class="nc" id="L511">                    cancelActivityWithAssertionFailure(&quot;mCurrentChangeRequest should be set before requesting permissions&quot;);</span>
                }
<span class="nc" id="L513">                return;</span>
            }
        }
<span class="nc bnc" id="L516" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1311)) {</span>
<span class="nc" id="L517">            Timber.d(&quot;onRequestPermissionsResult. Code: %d&quot;, requestCode);</span>
        }
<span class="nc bnc" id="L519" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1327)) {</span>
<span class="nc bnc" id="L520" title="All 90 branches missed.">            if ((ListenerUtil.mutListener.listen(1322) ? ((ListenerUtil.mutListener.listen(1316) ? (requestCode &gt;= REQUEST_AUDIO_PERMISSION) : (ListenerUtil.mutListener.listen(1315) ? (requestCode &lt;= REQUEST_AUDIO_PERMISSION) : (ListenerUtil.mutListener.listen(1314) ? (requestCode &gt; REQUEST_AUDIO_PERMISSION) : (ListenerUtil.mutListener.listen(1313) ? (requestCode &lt; REQUEST_AUDIO_PERMISSION) : (ListenerUtil.mutListener.listen(1312) ? (requestCode != REQUEST_AUDIO_PERMISSION) : (requestCode == REQUEST_AUDIO_PERMISSION)))))) || (ListenerUtil.mutListener.listen(1321) ? (permissions.length &gt;= 1) : (ListenerUtil.mutListener.listen(1320) ? (permissions.length &lt;= 1) : (ListenerUtil.mutListener.listen(1319) ? (permissions.length &gt; 1) : (ListenerUtil.mutListener.listen(1318) ? (permissions.length &lt; 1) : (ListenerUtil.mutListener.listen(1317) ? (permissions.length != 1) : (permissions.length == 1))))))) : ((ListenerUtil.mutListener.listen(1316) ? (requestCode &gt;= REQUEST_AUDIO_PERMISSION) : (ListenerUtil.mutListener.listen(1315) ? (requestCode &lt;= REQUEST_AUDIO_PERMISSION) : (ListenerUtil.mutListener.listen(1314) ? (requestCode &gt; REQUEST_AUDIO_PERMISSION) : (ListenerUtil.mutListener.listen(1313) ? (requestCode &lt; REQUEST_AUDIO_PERMISSION) : (ListenerUtil.mutListener.listen(1312) ? (requestCode != REQUEST_AUDIO_PERMISSION) : (requestCode == REQUEST_AUDIO_PERMISSION)))))) &amp;&amp; (ListenerUtil.mutListener.listen(1321) ? (permissions.length &gt;= 1) : (ListenerUtil.mutListener.listen(1320) ? (permissions.length &lt;= 1) : (ListenerUtil.mutListener.listen(1319) ? (permissions.length &gt; 1) : (ListenerUtil.mutListener.listen(1318) ? (permissions.length &lt; 1) : (ListenerUtil.mutListener.listen(1317) ? (permissions.length != 1) : (permissions.length == 1))))))))) {</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1324)) {</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                    if (grantResults[0] == PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1323)) {</span>
<span class="nc" id="L524">                            recreateEditingUIUsingCachedRequest();</span>
                        }
<span class="nc" id="L526">                        return;</span>
                    }
                }
<span class="nc bnc" id="L529" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1325)) {</span>
<span class="nc" id="L530">                    UIUtils.showThemedToast(this, getResources().getString(R.string.multimedia_editor_audio_permission_refused), true);</span>
                }
<span class="nc bnc" id="L532" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1326)) {</span>
<span class="nc" id="L533">                    UIRecreationHandler.onRequiredPermissionDenied(mCurrentChangeRequest, this);</span>
                }
            }
        }
<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1342)) {</span>
<span class="nc bnc" id="L538" title="All 90 branches missed.">            if ((ListenerUtil.mutListener.listen(1338) ? ((ListenerUtil.mutListener.listen(1332) ? (requestCode &gt;= REQUEST_CAMERA_PERMISSION) : (ListenerUtil.mutListener.listen(1331) ? (requestCode &lt;= REQUEST_CAMERA_PERMISSION) : (ListenerUtil.mutListener.listen(1330) ? (requestCode &gt; REQUEST_CAMERA_PERMISSION) : (ListenerUtil.mutListener.listen(1329) ? (requestCode &lt; REQUEST_CAMERA_PERMISSION) : (ListenerUtil.mutListener.listen(1328) ? (requestCode != REQUEST_CAMERA_PERMISSION) : (requestCode == REQUEST_CAMERA_PERMISSION)))))) || (ListenerUtil.mutListener.listen(1337) ? (permissions.length &gt;= 1) : (ListenerUtil.mutListener.listen(1336) ? (permissions.length &lt;= 1) : (ListenerUtil.mutListener.listen(1335) ? (permissions.length &gt; 1) : (ListenerUtil.mutListener.listen(1334) ? (permissions.length &lt; 1) : (ListenerUtil.mutListener.listen(1333) ? (permissions.length != 1) : (permissions.length == 1))))))) : ((ListenerUtil.mutListener.listen(1332) ? (requestCode &gt;= REQUEST_CAMERA_PERMISSION) : (ListenerUtil.mutListener.listen(1331) ? (requestCode &lt;= REQUEST_CAMERA_PERMISSION) : (ListenerUtil.mutListener.listen(1330) ? (requestCode &gt; REQUEST_CAMERA_PERMISSION) : (ListenerUtil.mutListener.listen(1329) ? (requestCode &lt; REQUEST_CAMERA_PERMISSION) : (ListenerUtil.mutListener.listen(1328) ? (requestCode != REQUEST_CAMERA_PERMISSION) : (requestCode == REQUEST_CAMERA_PERMISSION)))))) &amp;&amp; (ListenerUtil.mutListener.listen(1337) ? (permissions.length &gt;= 1) : (ListenerUtil.mutListener.listen(1336) ? (permissions.length &lt;= 1) : (ListenerUtil.mutListener.listen(1335) ? (permissions.length &gt; 1) : (ListenerUtil.mutListener.listen(1334) ? (permissions.length &lt; 1) : (ListenerUtil.mutListener.listen(1333) ? (permissions.length != 1) : (permissions.length == 1))))))))) {</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1340)) {</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">                    if (grantResults[0] != PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1339)) {</span>
<span class="nc" id="L542">                            UIUtils.showThemedToast(this, getResources().getString(R.string.multimedia_editor_camera_permission_refused), true);</span>
                        }
                    }
                }
<span class="nc bnc" id="L546" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1341)) {</span>
                    // We check permissions to set visibility on the camera button, just recreate
<span class="nc" id="L548">                    recreateEditingUIUsingCachedRequest();</span>
                }
            }
        }
<span class="nc" id="L552">    }</span>

    private void cancelActivityWithAssertionFailure(String logMessage) {
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1343)) {</span>
<span class="nc" id="L556">            Timber.e(logMessage);</span>
        }
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1344)) {</span>
<span class="nc" id="L559">            UIUtils.showThemedToast(this, getString(R.string.mutimedia_editor_assertion_failed), false);</span>
        }
<span class="nc bnc" id="L561" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1345)) {</span>
<span class="nc" id="L562">            finishCancel();</span>
        }
<span class="nc" id="L564">    }</span>

    public void handleFieldChanged(IField newField) {
<span class="nc bnc" id="L567" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1346)) {</span>
<span class="nc" id="L568">            recreateEditingUi(ChangeUIRequest.fieldChange(newField));</span>
        }
<span class="nc" id="L570">    }</span>

    public void showLargeFileCropDialog(float length) {
<span class="nc" id="L573">        BasicImageFieldController imageFieldController = (BasicImageFieldController) mFieldController;</span>
<span class="nc" id="L574">        DecimalFormat decimalFormat = new DecimalFormat(&quot;.00&quot;);</span>
<span class="nc" id="L575">        String size = decimalFormat.format(length);</span>
<span class="nc" id="L576">        String content = getString(R.string.save_dialog_content, size);</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1347)) {</span>
<span class="nc" id="L578">            imageFieldController.showCropDialog(content, (dialog, which) -&gt; saveAndExit());</span>
        }
<span class="nc" id="L580">    }</span>

    private void saveAndExit() {
<span class="nc" id="L583">        Intent resultData = new Intent();</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1348)) {</span>
<span class="nc" id="L585">            resultData.putExtra(EXTRA_RESULT_FIELD, mField);</span>
        }
<span class="nc bnc" id="L587" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1349)) {</span>
<span class="nc" id="L588">            resultData.putExtra(EXTRA_RESULT_FIELD_INDEX, mFieldIndex);</span>
        }
<span class="nc bnc" id="L590" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1350)) {</span>
<span class="nc" id="L591">            setResult(RESULT_OK, resultData);</span>
        }
<span class="nc bnc" id="L593" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1351)) {</span>
<span class="nc" id="L594">            finishWithoutAnimation();</span>
        }
<span class="nc" id="L596">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1353)) {</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">            if (mFieldController != null) {</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1352)) {</span>
<span class="nc" id="L603">                    mFieldController.onDestroy();</span>
                }
            }
        }
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1354)) {</span>
<span class="nc" id="L608">            super.onDestroy();</span>
        }
<span class="nc" id="L610">    }</span>

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1355)) {</span>
<span class="nc" id="L615">            Timber.d(&quot;onSaveInstanceState - saving state&quot;);</span>
        }
<span class="nc bnc" id="L617" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1356)) {</span>
            // Why? I am not really sure. Perhaps to avoid terrible bugs due to not implementing things correctly?
<span class="nc" id="L619">            outState.putBoolean(BUNDLE_KEY_SHUT_OFF, true);</span>
        }
<span class="nc bnc" id="L621" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1359)) {</span>
            // If this bundle is not null, on restore, we should continue across Activity restart.
<span class="nc bnc" id="L623" title="All 2 branches missed.">            if (mFieldController != null) {</span>
<span class="nc" id="L624">                Bundle controllerBundle = mFieldController.saveInstanceState();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1358)) {</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                    if (controllerBundle != null) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1357)) {</span>
<span class="nc" id="L628">                            outState.putBundle(&quot;controllerBundle&quot;, mFieldController.saveInstanceState());</span>
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L634" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1360)) {</span>
<span class="nc" id="L635">            super.onSaveInstanceState(outState);</span>
        }
<span class="nc" id="L637">    }</span>

    /**
     * Intermediate class to hold state for the onRequestPermissionsResult callback
     */
    private static final class ChangeUIRequest {

        private final IField newField;

        private final int state;

<span class="nc" id="L648">        private boolean mRequiresPermissionCheck = true;</span>

        /**
         * Initial request when activity is created
         */
        public static final int ACTIVITY_LOAD = 0;

        /**
         * A change in UI via the menu options. Cancellable
         */
        public static final int UI_CHANGE = 1;

        /**
         * A change in UI via access to the activity. Not (yet) cancellable
         */
        public static final int EXTERNAL_FIELD_CHANGE = 2;

<span class="nc" id="L665">        private ChangeUIRequest(IField field, int state) {</span>
<span class="nc" id="L666">            this.newField = field;</span>
<span class="nc" id="L667">            this.state = state;</span>
<span class="nc" id="L668">        }</span>

        private IField getField() {
<span class="nc" id="L671">            return newField;</span>
        }

        private static ChangeUIRequest init(@NonNull IField field) {
<span class="nc" id="L675">            return new ChangeUIRequest(field, ACTIVITY_LOAD);</span>
        }

        private static ChangeUIRequest uiChange(IField field) {
<span class="nc" id="L679">            return new ChangeUIRequest(field, UI_CHANGE);</span>
        }

        private static ChangeUIRequest fieldChange(IField field) {
<span class="nc" id="L683">            return new ChangeUIRequest(field, EXTERNAL_FIELD_CHANGE);</span>
        }

        private boolean getRequiresPermissionCheck() {
<span class="nc" id="L687">            return mRequiresPermissionCheck;</span>
        }

        private void markAsPermissionRequested() {
<span class="nc bnc" id="L691" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1361)) {</span>
<span class="nc" id="L692">                mRequiresPermissionCheck = false;</span>
            }
<span class="nc" id="L694">        }</span>

        private int getState() {
<span class="nc" id="L697">            return state;</span>
        }
    }

    /**
     * Class to contain logic relating to decisions made when recreating a UI.
     * Can later be converted to a non-static class to allow testing of the logic.
     */
    private static final class UIRecreationHandler {

        /**
         * Raised just before the field controller is replaced
         */
        private static void onPreFieldControllerReplacement(IFieldController previousFieldController) {
<span class="nc bnc" id="L711" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1362)) {</span>
<span class="nc" id="L712">                Timber.d(&quot;onPreFieldControllerReplacement&quot;);</span>
            }
<span class="nc bnc" id="L714" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1363)) {</span>
                // on init, we don't need to do anything
<span class="nc bnc" id="L716" title="All 2 branches missed.">                if (previousFieldController == null) {</span>
<span class="nc" id="L717">                    return;</span>
                }
            }
<span class="nc bnc" id="L720" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1364)) {</span>
                // Otherwise, clean up the previous screen.
<span class="nc" id="L722">                previousFieldController.onFocusLost();</span>
            }
<span class="nc" id="L724">        }</span>

        /**
         * Raised when we were supplied with a field that could not generate a UI controller
         * Currently: We used a field for which we didn't know how to generate the UI
         */
        private static void onControllerCreationFailed(ChangeUIRequest request, MultimediaEditFieldActivity activity) {
<span class="nc bnc" id="L731" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1365)) {</span>
<span class="nc" id="L732">                Timber.d(&quot;onControllerCreationFailed. State: %d&quot;, request.getState());</span>
            }
<span class="nc bnc" id="L734" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1368)) {</span>
<span class="nc bnc" id="L735" title="All 3 branches missed.">                switch(request.getState()) {</span>
                    case ChangeUIRequest.ACTIVITY_LOAD:
                    case ChangeUIRequest.EXTERNAL_FIELD_CHANGE:
<span class="nc bnc" id="L738" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1366)) {</span>
                            // TODO: (Optional) change in functionality. Previously we'd be left with a menu, but no UI.
<span class="nc" id="L740">                            activity.finishCancel();</span>
                        }
                        break;
                    case ChangeUIRequest.UI_CHANGE:
<span class="nc" id="L744">                        break;</span>
                    default:
<span class="nc bnc" id="L746" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1367)) {</span>
<span class="nc" id="L747">                            Timber.e(&quot;onControllerCreationFailed: Unhandled state: %s&quot;, request.getState());</span>
                        }
                        break;
                }
            }
<span class="nc" id="L752">        }</span>

        private static void onPostUICreation(ChangeUIRequest request, MultimediaEditFieldActivity activity) {
<span class="nc bnc" id="L755" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1369)) {</span>
<span class="nc" id="L756">                Timber.d(&quot;onPostUICreation. State: %d&quot;, request.getState());</span>
            }
<span class="nc bnc" id="L758" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1372)) {</span>
<span class="nc bnc" id="L759" title="All 3 branches missed.">                switch(request.getState()) {</span>
                    case ChangeUIRequest.UI_CHANGE:
                    case ChangeUIRequest.EXTERNAL_FIELD_CHANGE:
<span class="nc bnc" id="L762" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1370)) {</span>
<span class="nc" id="L763">                            activity.supportInvalidateOptionsMenu();</span>
                        }
                        break;
                    case ChangeUIRequest.ACTIVITY_LOAD:
<span class="nc" id="L767">                        break;</span>
                    default:
<span class="nc bnc" id="L769" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1371)) {</span>
<span class="nc" id="L770">                            Timber.e(&quot;onPostUICreation: Unhandled state: %s&quot;, request.getState());</span>
                        }
                        break;
                }
            }
<span class="nc" id="L775">        }</span>

        private static void onRequiredPermissionDenied(ChangeUIRequest request, MultimediaEditFieldActivity activity) {
<span class="nc bnc" id="L778" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1373)) {</span>
<span class="nc" id="L779">                Timber.d(&quot;onRequiredPermissionDenied. State: %d&quot;, request.getState());</span>
            }
<span class="nc bnc" id="L781" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1378)) {</span>
<span class="nc bnc" id="L782" title="All 4 branches missed.">                switch(request.state) {</span>
                    case ChangeUIRequest.ACTIVITY_LOAD:
<span class="nc bnc" id="L784" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1374)) {</span>
<span class="nc" id="L785">                            activity.finishCancel();</span>
                        }
                        break;
                    case ChangeUIRequest.UI_CHANGE:
<span class="nc" id="L789">                        return;</span>
                    case ChangeUIRequest.EXTERNAL_FIELD_CHANGE:
<span class="nc bnc" id="L791" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1375)) {</span>
<span class="nc" id="L792">                            activity.recreateEditingUIUsingCachedRequest();</span>
                        }
                        break;
                    default:
<span class="nc bnc" id="L796" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1376)) {</span>
<span class="nc" id="L797">                            Timber.e(&quot;onRequiredPermissionDenied: Unhandled state: %s&quot;, request.getState());</span>
                        }
<span class="nc bnc" id="L799" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1377)) {</span>
<span class="nc" id="L800">                            activity.finishCancel();</span>
                        }
                        break;
                }
            }
<span class="nc" id="L805">        }</span>
    }

    @VisibleForTesting
    IFieldController getFieldController() {
<span class="nc" id="L810">        return mFieldController;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>