<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Finder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.libanki</a> &gt; <span class="el_source">Finder.java</span></div><h1>Finder.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2012 Norbert Nagold &lt;norbert.nagold@gmail.com&gt;                         *
 *  Copyright (c) 2012 Kostas Spyropoulos &lt;inigo.aldana@gmail.com&gt;                       *
 *  Copyright (c) 2014 Houssam Salem &lt;houssam.salem.au@gmail.com&gt;                        *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.libanki;

import android.database.Cursor;
import android.database.SQLException;
import android.text.TextUtils;
import android.util.Pair;
import com.ichi2.async.CancelListener;
import com.ichi2.async.CollectionTask;
import com.ichi2.async.ProgressSender;
import com.ichi2.libanki.Deck;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONObject;
import java.text.Normalizer;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import androidx.annotation.CheckResult;
import timber.log.Timber;
import static com.ichi2.async.CancelListener.isCancelled;
import static com.ichi2.libanki.stats.Stats.SECONDS_PER_DAY;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

@SuppressWarnings({ &quot;PMD.ExcessiveClassLength&quot;, &quot;PMD.AvoidThrowingRawExceptionTypes&quot;, &quot;PMD.AvoidReassigningParameters&quot;, &quot;PMD.NPathComplexity&quot;, &quot;PMD.MethodNamingConventions&quot; })
public class Finder {

<span class="fc" id="L55">    private static final Pattern fPropPattern = Pattern.compile(&quot;(^.+?)(&lt;=|&gt;=|!=|=|&lt;|&gt;)(.+?$)&quot;);</span>

<span class="fc" id="L57">    private static final Pattern fNidsPattern = Pattern.compile(&quot;[^0-9,]&quot;);</span>

<span class="fc" id="L59">    private static final Pattern fMidPattern = Pattern.compile(&quot;[^0-9]&quot;);</span>

    private final Collection mCol;

<span class="fc" id="L63">    public Finder(Collection col) {</span>
<span class="fc" id="L64">        mCol = col;</span>
<span class="fc" id="L65">    }</span>

    /**
     * Return a list of card ids for QUERY
     */
    @CheckResult
    public List&lt;Long&gt; findCards(String query, String _order) {
<span class="nc" id="L72">        return _findCards(query, _order);</span>
    }

    @CheckResult
    public List&lt;Long&gt; findCards(String query, boolean _order) {
<span class="nc" id="L77">        return findCards(query, _order, null);</span>
    }

    @CheckResult
    public List&lt;Long&gt; findCards(String query, boolean _order, CollectionTask.PartialSearch task) {
<span class="nc" id="L82">        return _findCards(query, _order, task);</span>
    }

    @CheckResult
    private List&lt;Long&gt; _findCards(String query, Object _order) {
<span class="nc" id="L87">        return _findCards(query, _order, null);</span>
    }

    @CheckResult
    private List&lt;Long&gt; _findCards(String query, Object _order, CollectionTask.PartialSearch task) {
<span class="nc" id="L92">        String[] tokens = _tokenize(query);</span>
<span class="nc" id="L93">        Pair&lt;String, String[]&gt; res1 = _where(tokens);</span>
<span class="nc" id="L94">        String preds = res1.first;</span>
<span class="nc" id="L95">        String[] args = res1.second;</span>
<span class="nc" id="L96">        List&lt;Long&gt; res = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22482)) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            if (preds == null) {</span>
<span class="nc" id="L99">                return res;</span>
            }
        }
<span class="nc bnc" id="L102" title="All 2 branches missed.">        Pair&lt;String, Boolean&gt; res2 = _order instanceof Boolean ? _order((Boolean) _order) : _order((String) _order);</span>
<span class="nc" id="L103">        String order = res2.first;</span>
<span class="nc" id="L104">        boolean rev = res2.second;</span>
<span class="nc" id="L105">        String sql = _query(preds, order);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22483)) {</span>
<span class="nc" id="L107">            Timber.v(&quot;Search query '%s' is compiled as '%s'.&quot;, query, sql);</span>
        }
<span class="nc bnc" id="L109" title="All 2 branches missed.">        boolean sendProgress = task != null;</span>
<span class="nc" id="L110">        try (Cursor cur = mCol.getDb().getDatabase().query(sql, args)) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22495)) {</span>
                {
<span class="nc" id="L113">                    long _loopCounter521 = 0;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L115">                        ListenerUtil.loopListener.listen(&quot;_loopCounter521&quot;, ++_loopCounter521);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22484)) {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                            if (isCancelled(task)) {</span>
<span class="nc" id="L118">                                return new ArrayList&lt;&gt;(0);</span>
                            }
                        }
<span class="nc bnc" id="L121" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22485)) {</span>
<span class="nc" id="L122">                            res.add(cur.getLong(0));</span>
                        }
<span class="nc bnc" id="L124" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22494)) {</span>
<span class="nc bnc" id="L125" title="All 50 branches missed.">                            if ((ListenerUtil.mutListener.listen(22491) ? (sendProgress || (ListenerUtil.mutListener.listen(22490) ? (res.size() &gt;= task.getNumCardsToRender()) : (ListenerUtil.mutListener.listen(22489) ? (res.size() &lt;= task.getNumCardsToRender()) : (ListenerUtil.mutListener.listen(22488) ? (res.size() &lt; task.getNumCardsToRender()) : (ListenerUtil.mutListener.listen(22487) ? (res.size() != task.getNumCardsToRender()) : (ListenerUtil.mutListener.listen(22486) ? (res.size() == task.getNumCardsToRender()) : (res.size() &gt; task.getNumCardsToRender()))))))) : (sendProgress &amp;&amp; (ListenerUtil.mutListener.listen(22490) ? (res.size() &gt;= task.getNumCardsToRender()) : (ListenerUtil.mutListener.listen(22489) ? (res.size() &lt;= task.getNumCardsToRender()) : (ListenerUtil.mutListener.listen(22488) ? (res.size() &lt; task.getNumCardsToRender()) : (ListenerUtil.mutListener.listen(22487) ? (res.size() != task.getNumCardsToRender()) : (ListenerUtil.mutListener.listen(22486) ? (res.size() == task.getNumCardsToRender()) : (res.size() &gt; task.getNumCardsToRender()))))))))) {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22492)) {</span>
<span class="nc" id="L127">                                    task.doProgress(res);</span>
                                }
<span class="nc bnc" id="L129" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22493)) {</span>
<span class="nc" id="L130">                                    sendProgress = false;</span>
                                }
                            }
                        }
                    }
                }
            }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        } catch (SQLException e) {</span>
            // invalid grouping
<span class="nc" id="L139">            return new ArrayList&lt;&gt;(0);</span>
<span class="nc" id="L140">        }</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22497)) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (rev) {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22496)) {</span>
<span class="nc" id="L144">                    Collections.reverse(res);</span>
                }
            }
        }
<span class="nc" id="L148">        return res;</span>
    }

    public List&lt;Long&gt; findNotes(String query) {
<span class="fc" id="L152">        String[] tokens = _tokenize(query);</span>
<span class="fc" id="L153">        Pair&lt;String, String[]&gt; res1 = _where(tokens);</span>
<span class="fc" id="L154">        String preds = res1.first;</span>
<span class="fc" id="L155">        String[] args = res1.second;</span>
<span class="fc" id="L156">        List&lt;Long&gt; res = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22498)) {</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">            if (preds == null) {</span>
<span class="nc" id="L159">                return res;</span>
            }
        }
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22501)) {</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (&quot;&quot;.equals(preds)) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22500)) {</span>
<span class="nc" id="L165">                    preds = &quot;1&quot;;</span>
                }
            } else {
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22499)) {</span>
<span class="fc" id="L169">                    preds = &quot;(&quot; + preds + &quot;)&quot;;</span>
                }
            }
        }
<span class="fc" id="L173">        String sql = &quot;select distinct(n.id) from cards c, notes n where c.nid=n.id and &quot; + preds;</span>
<span class="fc" id="L174">        try (Cursor cur = mCol.getDb().getDatabase().query(sql, args)) {</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22503)) {</span>
                {
<span class="fc" id="L177">                    long _loopCounter522 = 0;</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L179">                        ListenerUtil.loopListener.listen(&quot;_loopCounter522&quot;, ++_loopCounter522);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22502)) {</span>
<span class="nc" id="L181">                            res.add(cur.getLong(0));</span>
                        }
                    }
                }
            }
<span class="nc" id="L186">        } catch (SQLException e) {</span>
            // invalid grouping
<span class="nc" id="L188">            return new ArrayList&lt;&gt;(0);</span>
<span class="fc" id="L189">        }</span>
<span class="fc" id="L190">        return res;</span>
    }

    public String[] _tokenize(String query) {
<span class="fc" id="L194">        char inQuote = 0;</span>
<span class="fc" id="L195">        List&lt;String&gt; tokens = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L196">        String token = &quot;&quot;;</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22565)) {</span>
            {
<span class="fc" id="L199">                long _loopCounter523 = 0;</span>
<span class="pc bpc" id="L200" title="15 of 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(22564) ? (i &gt;= query.length()) : (ListenerUtil.mutListener.listen(22563) ? (i &lt;= query.length()) : (ListenerUtil.mutListener.listen(22562) ? (i &gt; query.length()) : (ListenerUtil.mutListener.listen(22561) ? (i != query.length()) : (ListenerUtil.mutListener.listen(22560) ? (i == query.length()) : (i &lt; query.length())))))); ++i) {</span>
<span class="fc" id="L201">                    ListenerUtil.loopListener.listen(&quot;_loopCounter523&quot;, ++_loopCounter523);</span>
                    // quoted text
<span class="fc" id="L203">                    char c = query.charAt(i);</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22559)) {</span>
<span class="pc bpc" id="L205" title="7 of 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(22504) ? (c == '\'' &amp;&amp; c == '&quot;') : (c == '\'' || c == '&quot;'))) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22558)) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                                if (inQuote != 0) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22557)) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                                        if (c == inQuote) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(22556)) {</span>
<span class="nc" id="L211">                                                inQuote = 0;</span>
                                            }
                                        } else {
<span class="nc bnc" id="L214" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(22555)) {</span>
<span class="nc" id="L215">                                                token += c;</span>
                                            }
                                        }
                                    }
<span class="nc bnc" id="L219" title="All 22 branches missed.">                                } else if ((ListenerUtil.mutListener.listen(22550) ? (token.length() &gt;= 0) : (ListenerUtil.mutListener.listen(22549) ? (token.length() &lt;= 0) : (ListenerUtil.mutListener.listen(22548) ? (token.length() &gt; 0) : (ListenerUtil.mutListener.listen(22547) ? (token.length() &lt; 0) : (ListenerUtil.mutListener.listen(22546) ? (token.length() == 0) : (token.length() != 0))))))) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22554)) {</span>
                                        // quotes are allowed to start directly after a :
<span class="nc bnc" id="L222" title="All 2 branches missed.">                                        if (token.endsWith(&quot;:&quot;)) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(22553)) {</span>
<span class="nc" id="L224">                                                inQuote = c;</span>
                                            }
                                        } else {
<span class="nc bnc" id="L227" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(22552)) {</span>
<span class="nc" id="L228">                                                token += c;</span>
                                            }
                                        }
                                    }
                                } else {
<span class="nc bnc" id="L233" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22551)) {</span>
<span class="nc" id="L234">                                        inQuote = c;</span>
                                    }
                                }
                            }
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">                        } else if (c == ' ') {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22545)) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">                                if (inQuote != 0) {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22544)) {</span>
<span class="nc" id="L242">                                        token += c;</span>
                                    }
<span class="nc bnc" id="L244" title="All 22 branches missed.">                                } else if ((ListenerUtil.mutListener.listen(22541) ? (token.length() &gt;= 0) : (ListenerUtil.mutListener.listen(22540) ? (token.length() &lt;= 0) : (ListenerUtil.mutListener.listen(22539) ? (token.length() &gt; 0) : (ListenerUtil.mutListener.listen(22538) ? (token.length() &lt; 0) : (ListenerUtil.mutListener.listen(22537) ? (token.length() == 0) : (token.length() != 0))))))) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22542)) {</span>
                                        // space marks token finished
<span class="nc" id="L247">                                        tokens.add(token);</span>
                                    }
<span class="nc bnc" id="L249" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22543)) {</span>
<span class="nc" id="L250">                                        token = &quot;&quot;;</span>
                                    }
                                }
                            }
<span class="pc bpc" id="L254" title="7 of 10 branches missed.">                        } else if ((ListenerUtil.mutListener.listen(22505) ? (c == '(' &amp;&amp; c == ')') : (c == '(' || c == ')'))) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22536)) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                                if (inQuote != 0) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22535)) {</span>
<span class="nc" id="L258">                                        token += c;</span>
                                    }
                                } else {
<span class="nc bnc" id="L261" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22533)) {</span>
<span class="nc bnc" id="L262" title="All 50 branches missed.">                                        if ((ListenerUtil.mutListener.listen(22530) ? (c == ')' || (ListenerUtil.mutListener.listen(22529) ? (token.length() &gt;= 0) : (ListenerUtil.mutListener.listen(22528) ? (token.length() &lt;= 0) : (ListenerUtil.mutListener.listen(22527) ? (token.length() &gt; 0) : (ListenerUtil.mutListener.listen(22526) ? (token.length() &lt; 0) : (ListenerUtil.mutListener.listen(22525) ? (token.length() == 0) : (token.length() != 0))))))) : (c == ')' &amp;&amp; (ListenerUtil.mutListener.listen(22529) ? (token.length() &gt;= 0) : (ListenerUtil.mutListener.listen(22528) ? (token.length() &lt;= 0) : (ListenerUtil.mutListener.listen(22527) ? (token.length() &gt; 0) : (ListenerUtil.mutListener.listen(22526) ? (token.length() &lt; 0) : (ListenerUtil.mutListener.listen(22525) ? (token.length() == 0) : (token.length() != 0))))))))) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(22531)) {</span>
<span class="nc" id="L264">                                                tokens.add(token);</span>
                                            }
<span class="nc bnc" id="L266" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(22532)) {</span>
<span class="nc" id="L267">                                                token = &quot;&quot;;</span>
                                            }
                                        }
                                    }
<span class="nc bnc" id="L271" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22534)) {</span>
<span class="nc" id="L272">                                        tokens.add(String.valueOf(c));</span>
                                    }
                                }
                            }
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">                        } else if (c == '-') {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22524)) {</span>
<span class="nc bnc" id="L278" title="All 22 branches missed.">                                if ((ListenerUtil.mutListener.listen(22511) ? (token.length() &gt;= 0) : (ListenerUtil.mutListener.listen(22510) ? (token.length() &lt;= 0) : (ListenerUtil.mutListener.listen(22509) ? (token.length() &gt; 0) : (ListenerUtil.mutListener.listen(22508) ? (token.length() &lt; 0) : (ListenerUtil.mutListener.listen(22507) ? (token.length() == 0) : (token.length() != 0))))))) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22523)) {</span>
<span class="nc" id="L280">                                        token += c;</span>
                                    }
<span class="nc bnc" id="L282" title="All 66 branches missed.">                                } else if ((ListenerUtil.mutListener.listen(22521) ? ((ListenerUtil.mutListener.listen(22516) ? (tokens.size() &gt;= 0) : (ListenerUtil.mutListener.listen(22515) ? (tokens.size() &lt;= 0) : (ListenerUtil.mutListener.listen(22514) ? (tokens.size() &gt; 0) : (ListenerUtil.mutListener.listen(22513) ? (tokens.size() &lt; 0) : (ListenerUtil.mutListener.listen(22512) ? (tokens.size() != 0) : (tokens.size() == 0)))))) &amp;&amp; !&quot;-&quot;.equals(tokens.get((ListenerUtil.mutListener.listen(22520) ? (tokens.size() % 1) : (ListenerUtil.mutListener.listen(22519) ? (tokens.size() / 1) : (ListenerUtil.mutListener.listen(22518) ? (tokens.size() * 1) : (ListenerUtil.mutListener.listen(22517) ? (tokens.size() + 1) : (tokens.size() - 1)))))))) : ((ListenerUtil.mutListener.listen(22516) ? (tokens.size() &gt;= 0) : (ListenerUtil.mutListener.listen(22515) ? (tokens.size() &lt;= 0) : (ListenerUtil.mutListener.listen(22514) ? (tokens.size() &gt; 0) : (ListenerUtil.mutListener.listen(22513) ? (tokens.size() &lt; 0) : (ListenerUtil.mutListener.listen(22512) ? (tokens.size() != 0) : (tokens.size() == 0)))))) || !&quot;-&quot;.equals(tokens.get((ListenerUtil.mutListener.listen(22520) ? (tokens.size() % 1) : (ListenerUtil.mutListener.listen(22519) ? (tokens.size() / 1) : (ListenerUtil.mutListener.listen(22518) ? (tokens.size() * 1) : (ListenerUtil.mutListener.listen(22517) ? (tokens.size() + 1) : (tokens.size() - 1)))))))))) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22522)) {</span>
<span class="nc" id="L284">                                        tokens.add(&quot;-&quot;);</span>
                                    }
                                }
                            }
                        } else {
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22506)) {</span>
<span class="fc" id="L290">                                token += c;</span>
                            }
                        }
                    }
                }
            }
        }
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22572)) {</span>
            // if we finished in a token, add it
<span class="pc bpc" id="L299" title="16 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(22570) ? (token.length() &gt;= 0) : (ListenerUtil.mutListener.listen(22569) ? (token.length() &lt;= 0) : (ListenerUtil.mutListener.listen(22568) ? (token.length() &gt; 0) : (ListenerUtil.mutListener.listen(22567) ? (token.length() &lt; 0) : (ListenerUtil.mutListener.listen(22566) ? (token.length() == 0) : (token.length() != 0))))))) {</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22571)) {</span>
<span class="fc" id="L301">                    tokens.add(token);</span>
                }
            }
        }
<span class="fc" id="L305">        return tokens.toArray(new String[tokens.size()]);</span>
    }

    /**
     * LibAnki creates a dictionary and operates on it with an inner function inside _where().
     * AnkiDroid combines the two in this class instead.
     */
<span class="fc" id="L312">    public static class SearchState {</span>

        public boolean isnot;

        public boolean isor;

        public boolean join;

<span class="fc" id="L320">        public String q = &quot;&quot;;</span>

        public boolean bad;

        public void add(String txt) {
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22573)) {</span>
<span class="fc" id="L326">                add(txt, true);</span>
            }
<span class="fc" id="L328">        }</span>

        public void add(String txt, boolean wrap) {
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22577)) {</span>
                // failed command?
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">                if (TextUtils.isEmpty(txt)) {</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22576)) {</span>
                        // if it was to be negated then we can just ignore it
<span class="nc bnc" id="L336" title="All 2 branches missed.">                        if (isnot) {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22575)) {</span>
<span class="nc" id="L338">                                isnot = false;</span>
                            }
                        } else {
<span class="nc bnc" id="L341" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22574)) {</span>
<span class="nc" id="L342">                                bad = true;</span>
                            }
                        }
                    }
<span class="nc" id="L346">                    return;</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">                } else if (&quot;skip&quot;.equals(txt)) {</span>
<span class="nc" id="L348">                    return;</span>
                }
            }
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22582)) {</span>
                // do we need a conjunction?
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">                if (join) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22581)) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                        if (isor) {</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22579)) {</span>
<span class="nc" id="L357">                                q += &quot; or &quot;;</span>
                            }
<span class="nc bnc" id="L359" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22580)) {</span>
<span class="nc" id="L360">                                isor = false;</span>
                            }
                        } else {
<span class="nc bnc" id="L363" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22578)) {</span>
<span class="nc" id="L364">                                q += &quot; and &quot;;</span>
                            }
                        }
                    }
                }
            }
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22585)) {</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">                if (isnot) {</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22583)) {</span>
<span class="nc" id="L373">                        q += &quot; not &quot;;</span>
                    }
<span class="nc bnc" id="L375" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22584)) {</span>
<span class="nc" id="L376">                        isnot = false;</span>
                    }
                }
            }
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22587)) {</span>
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">                if (wrap) {</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22586)) {</span>
<span class="fc" id="L383">                        txt = &quot;(&quot; + txt + &quot;)&quot;;</span>
                    }
                }
            }
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22588)) {</span>
<span class="fc" id="L388">                q += txt;</span>
            }
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22589)) {</span>
<span class="fc" id="L391">                join = true;</span>
            }
<span class="fc" id="L393">        }</span>
    }

    private Pair&lt;String, String[]&gt; _where(String[] tokens) {
        // state and query
<span class="fc" id="L398">        SearchState s = new SearchState();</span>
<span class="fc" id="L399">        List&lt;String&gt; args = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22613)) {</span>
            {
<span class="fc" id="L402">                long _loopCounter524 = 0;</span>
<span class="fc bfc" id="L403" title="All 2 branches covered.">                for (String token : tokens) {</span>
<span class="fc" id="L404">                    ListenerUtil.loopListener.listen(&quot;_loopCounter524&quot;, ++_loopCounter524);</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22590)) {</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">                        if (s.bad) {</span>
<span class="nc" id="L407">                            return new Pair&lt;&gt;(null, null);</span>
                        }
                    }
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22612)) {</span>
                        // special tokens
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">                        if (&quot;-&quot;.equals(token)) {</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22611)) {</span>
<span class="nc" id="L414">                                s.isnot = true;</span>
                            }
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">                        } else if (&quot;or&quot;.equalsIgnoreCase(token)) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22610)) {</span>
<span class="nc" id="L418">                                s.isor = true;</span>
                            }
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">                        } else if (&quot;(&quot;.equals(token)) {</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22608)) {</span>
<span class="nc" id="L422">                                s.add(token, false);</span>
                            }
<span class="nc bnc" id="L424" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22609)) {</span>
<span class="nc" id="L425">                                s.join = false;</span>
                            }
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">                        } else if (&quot;)&quot;.equals(token)) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22607)) {</span>
<span class="nc" id="L429">                                s.q += &quot;)&quot;;</span>
                            }
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">                        } else if (token.contains(&quot;:&quot;)) {</span>
<span class="fc" id="L432">                            String[] spl = token.split(&quot;:&quot;, 2);</span>
<span class="fc" id="L433">                            String cmd = spl[0].toLowerCase(Locale.ROOT);</span>
<span class="fc" id="L434">                            String val = spl[1];</span>
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22606)) {</span>
<span class="pc bpc" id="L436" title="13 of 14 branches missed.">                                switch(cmd) {</span>
                                    case &quot;added&quot;:
<span class="nc bnc" id="L438" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22592)) {</span>
<span class="nc" id="L439">                                            s.add(_findAdded(val));</span>
                                        }
                                        break;
                                    case &quot;card&quot;:
<span class="nc bnc" id="L443" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22593)) {</span>
<span class="nc" id="L444">                                            s.add(_findTemplate(val));</span>
                                        }
                                        break;
                                    case &quot;deck&quot;:
<span class="nc bnc" id="L448" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22594)) {</span>
<span class="nc" id="L449">                                            s.add(_findDeck(val));</span>
                                        }
                                        break;
                                    case &quot;flag&quot;:
<span class="nc bnc" id="L453" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22595)) {</span>
<span class="nc" id="L454">                                            s.add(_findFlag(val));</span>
                                        }
                                        break;
                                    case &quot;mid&quot;:
<span class="nc bnc" id="L458" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22596)) {</span>
<span class="nc" id="L459">                                            s.add(_findMid(val));</span>
                                        }
                                        break;
                                    case &quot;nid&quot;:
<span class="nc bnc" id="L463" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22597)) {</span>
<span class="nc" id="L464">                                            s.add(_findNids(val));</span>
                                        }
                                        break;
                                    case &quot;cid&quot;:
<span class="nc bnc" id="L468" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22598)) {</span>
<span class="nc" id="L469">                                            s.add(_findCids(val));</span>
                                        }
                                        break;
                                    case &quot;note&quot;:
<span class="nc bnc" id="L473" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22599)) {</span>
<span class="nc" id="L474">                                            s.add(_findModel(val));</span>
                                        }
                                        break;
                                    case &quot;prop&quot;:
<span class="nc bnc" id="L478" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22600)) {</span>
<span class="nc" id="L479">                                            s.add(_findProp(val));</span>
                                        }
                                        break;
                                    case &quot;rated&quot;:
<span class="nc bnc" id="L483" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22601)) {</span>
<span class="nc" id="L484">                                            s.add(_findRated(val));</span>
                                        }
                                        break;
                                    case &quot;tag&quot;:
<span class="pc bpc" id="L488" title="1 of 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22602)) {</span>
<span class="fc" id="L489">                                            s.add(_findTag(val, args));</span>
                                        }
                                        break;
                                    case &quot;dupe&quot;:
<span class="nc bnc" id="L493" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22603)) {</span>
<span class="nc" id="L494">                                            s.add(_findDupes(val));</span>
                                        }
                                        break;
                                    case &quot;is&quot;:
<span class="nc bnc" id="L498" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22604)) {</span>
<span class="nc" id="L499">                                            s.add(_findCardState(val));</span>
                                        }
                                        break;
                                    default:
<span class="nc bnc" id="L503" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22605)) {</span>
<span class="nc" id="L504">                                            s.add(_findField(cmd, val));</span>
                                        }
                                        break;
                                }
                            }
<span class="fc" id="L509">                        } else {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22591)) {</span>
<span class="nc" id="L511">                                s.add(_findText(token, args));</span>
                            }
                        }
                    }
                }
            }
        }
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22614)) {</span>
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">            if (s.bad) {</span>
<span class="nc" id="L520">                return new Pair&lt;&gt;(null, null);</span>
            }
        }
<span class="fc" id="L523">        return new Pair&lt;&gt;(s.q, args.toArray(new String[args.size()]));</span>
    }

    /**
     * @param preds A sql predicate, or empty string, with c a card, n its note
     * @param order A part of a query, ordering element of table Card, with c a card, n its note
     * @return A query to return all card ids satifying the predicate and in the given order
     */
    private static String _query(String preds, String order) {
        // can we skip the note table?
        String sql;
<span class="nc bnc" id="L534" title="All 10 branches missed.">        if ((ListenerUtil.mutListener.listen(22615) ? (!preds.contains(&quot;n.&quot;) || !order.contains(&quot;n.&quot;)) : (!preds.contains(&quot;n.&quot;) &amp;&amp; !order.contains(&quot;n.&quot;)))) {</span>
<span class="nc" id="L535">            sql = &quot;select c.id from cards c where &quot;;</span>
        } else {
<span class="nc" id="L537">            sql = &quot;select c.id from cards c, notes n where c.nid=n.id and &quot;;</span>
        }
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22618)) {</span>
            // combine with preds
<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (!TextUtils.isEmpty(preds)) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22617)) {</span>
<span class="nc" id="L543">                    sql += &quot;(&quot; + preds + &quot;)&quot;;</span>
                }
            } else {
<span class="nc bnc" id="L546" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22616)) {</span>
<span class="nc" id="L547">                    sql += &quot;1&quot;;</span>
                }
            }
        }
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22620)) {</span>
            // order
<span class="nc bnc" id="L553" title="All 2 branches missed.">            if (!TextUtils.isEmpty(order)) {</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22619)) {</span>
<span class="nc" id="L555">                    sql += &quot; &quot; + order;</span>
                }
            }
        }
<span class="nc" id="L559">        return sql;</span>
    }

    private Pair&lt;String, Boolean&gt; _order(String order) {
<span class="nc bnc" id="L563" title="All 2 branches missed.">        if (TextUtils.isEmpty(order)) {</span>
<span class="nc" id="L564">            return _order(false);</span>
        } else {
            // custom order string provided
<span class="nc" id="L567">            return new Pair&lt;&gt;(&quot; order by &quot; + order, false);</span>
        }
    }

    private Pair&lt;String, Boolean&gt; _order(Boolean order) {
<span class="nc bnc" id="L572" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22621)) {</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">            if (!order) {</span>
<span class="nc" id="L574">                return new Pair&lt;&gt;(&quot;&quot;, false);</span>
            }
        }
        // use deck default
<span class="nc" id="L578">        String type = mCol.getConf().getString(&quot;sortType&quot;);</span>
<span class="nc" id="L579">        String sort = null;</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22633)) {</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">            if (type.startsWith(&quot;note&quot;)) {</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22632)) {</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                    if (type.startsWith(&quot;noteCrt&quot;)) {</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22631)) {</span>
<span class="nc" id="L585">                            sort = &quot;n.id, c.ord&quot;;</span>
                        }
<span class="nc bnc" id="L587" title="All 2 branches missed.">                    } else if (type.startsWith(&quot;noteMod&quot;)) {</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22630)) {</span>
<span class="nc" id="L589">                            sort = &quot;n.mod, c.ord&quot;;</span>
                        }
<span class="nc bnc" id="L591" title="All 2 branches missed.">                    } else if (type.startsWith(&quot;noteFld&quot;)) {</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22629)) {</span>
<span class="nc" id="L593">                            sort = &quot;n.sfld COLLATE NOCASE, c.ord&quot;;</span>
                        }
                    }
                }
<span class="nc bnc" id="L597" title="All 2 branches missed.">            } else if (type.startsWith(&quot;card&quot;)) {</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22628)) {</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                    if (type.startsWith(&quot;cardMod&quot;)) {</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22627)) {</span>
<span class="nc" id="L601">                            sort = &quot;c.mod&quot;;</span>
                        }
<span class="nc bnc" id="L603" title="All 2 branches missed.">                    } else if (type.startsWith(&quot;cardReps&quot;)) {</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22626)) {</span>
<span class="nc" id="L605">                            sort = &quot;c.reps&quot;;</span>
                        }
<span class="nc bnc" id="L607" title="All 2 branches missed.">                    } else if (type.startsWith(&quot;cardDue&quot;)) {</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22625)) {</span>
<span class="nc" id="L609">                            sort = &quot;c.type, c.due&quot;;</span>
                        }
<span class="nc bnc" id="L611" title="All 2 branches missed.">                    } else if (type.startsWith(&quot;cardEase&quot;)) {</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22624)) {</span>
<span class="nc" id="L613">                            sort = &quot;c.type == &quot; + Consts.CARD_TYPE_NEW + &quot;, c.factor&quot;;</span>
                        }
<span class="nc bnc" id="L615" title="All 2 branches missed.">                    } else if (type.startsWith(&quot;cardLapses&quot;)) {</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22623)) {</span>
<span class="nc" id="L617">                            sort = &quot;c.lapses&quot;;</span>
                        }
<span class="nc bnc" id="L619" title="All 2 branches missed.">                    } else if (type.startsWith(&quot;cardIvl&quot;)) {</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22622)) {</span>
<span class="nc" id="L621">                            sort = &quot;c.ivl&quot;;</span>
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L627" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22635)) {</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">            if (sort == null) {</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22634)) {</span>
                    // deck has invalid sort order; revert to noteCrt
<span class="nc" id="L631">                    sort = &quot;n.id, c.ord&quot;;</span>
                }
            }
        }
<span class="nc" id="L635">        boolean sortBackwards = mCol.getConf().getBoolean(&quot;sortBackwards&quot;);</span>
<span class="nc" id="L636">        return new Pair&lt;&gt;(&quot; ORDER BY &quot; + sort, sortBackwards);</span>
    }

    private String _findTag(String val, List&lt;String&gt; args) {
<span class="pc bpc" id="L640" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22636)) {</span>
<span class="pc bpc" id="L641" title="1 of 2 branches missed.">            if (&quot;none&quot;.equals(val)) {</span>
<span class="nc" id="L642">                return &quot;n.tags = \&quot;\&quot;&quot;;</span>
            }
        }
<span class="pc bpc" id="L645" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22637)) {</span>
<span class="fc" id="L646">            val = val.replace(&quot;*&quot;, &quot;%&quot;);</span>
        }
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22639)) {</span>
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">            if (!val.startsWith(&quot;%&quot;)) {</span>
<span class="pc bpc" id="L650" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22638)) {</span>
<span class="fc" id="L651">                    val = &quot;% &quot; + val;</span>
                }
            }
        }
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22642)) {</span>
<span class="pc bpc" id="L656" title="8 of 10 branches missed.">            if ((ListenerUtil.mutListener.listen(22640) ? (!val.endsWith(&quot;%&quot;) &amp;&amp; val.endsWith(&quot;\\%&quot;)) : (!val.endsWith(&quot;%&quot;) || val.endsWith(&quot;\\%&quot;)))) {</span>
<span class="pc bpc" id="L657" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22641)) {</span>
<span class="fc" id="L658">                    val += &quot; %&quot;;</span>
                }
            }
        }
<span class="pc bpc" id="L662" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22643)) {</span>
<span class="fc" id="L663">            args.add(val);</span>
        }
<span class="fc" id="L665">        return &quot;n.tags like ? escape '\\'&quot;;</span>
    }

    private String _findCardState(String val) {
        int n;
<span class="nc bnc" id="L670" title="All 26 branches missed.">        if ((ListenerUtil.mutListener.listen(22645) ? ((ListenerUtil.mutListener.listen(22644) ? (&quot;review&quot;.equals(val) &amp;&amp; &quot;new&quot;.equals(val)) : (&quot;review&quot;.equals(val) || &quot;new&quot;.equals(val))) &amp;&amp; &quot;learn&quot;.equals(val)) : ((ListenerUtil.mutListener.listen(22644) ? (&quot;review&quot;.equals(val) &amp;&amp; &quot;new&quot;.equals(val)) : (&quot;review&quot;.equals(val) || &quot;new&quot;.equals(val))) || &quot;learn&quot;.equals(val)))) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">            if (&quot;review&quot;.equals(val)) {</span>
<span class="nc" id="L672">                n = 2;</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">            } else if (&quot;new&quot;.equals(val)) {</span>
<span class="nc" id="L674">                n = 0;</span>
            } else {
<span class="nc" id="L676">                return &quot;queue IN (1, &quot; + Consts.QUEUE_TYPE_DAY_LEARN_RELEARN + &quot;)&quot;;</span>
            }
<span class="nc" id="L678">            return &quot;type = &quot; + n;</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">        } else if (&quot;suspended&quot;.equals(val)) {</span>
<span class="nc" id="L680">            return &quot;c.queue = &quot; + Consts.QUEUE_TYPE_SUSPENDED;</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        } else if (&quot;buried&quot;.equals(val)) {</span>
<span class="nc" id="L682">            return &quot;c.queue in (&quot; + Consts.QUEUE_TYPE_SIBLING_BURIED + &quot;, &quot; + Consts.QUEUE_TYPE_MANUALLY_BURIED + &quot;)&quot;;</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">        } else if (&quot;due&quot;.equals(val)) {</span>
<span class="nc" id="L684">            return &quot;(c.queue in (&quot; + Consts.QUEUE_TYPE_REV + &quot;,&quot; + Consts.QUEUE_TYPE_DAY_LEARN_RELEARN + &quot;) and c.due &lt;= &quot; + mCol.getSched().getToday() + &quot;) or (c.queue = &quot; + Consts.QUEUE_TYPE_LRN + &quot; and c.due &lt;= &quot; + mCol.getSched().getDayCutoff() + &quot;)&quot;;</span>
        } else {
<span class="nc" id="L686">            return null;</span>
        }
    }

    private String _findFlag(String val) {
        int flag;
<span class="nc bnc" id="L692" title="All 6 branches missed.">        switch(val) {</span>
            case &quot;0&quot;:
<span class="nc" id="L694">                flag = 0;</span>
<span class="nc" id="L695">                break;</span>
            case &quot;1&quot;:
<span class="nc" id="L697">                flag = 1;</span>
<span class="nc" id="L698">                break;</span>
            case &quot;2&quot;:
<span class="nc" id="L700">                flag = 2;</span>
<span class="nc" id="L701">                break;</span>
            case &quot;3&quot;:
<span class="nc" id="L703">                flag = 3;</span>
<span class="nc" id="L704">                break;</span>
            case &quot;4&quot;:
<span class="nc" id="L706">                flag = 4;</span>
<span class="nc" id="L707">                break;</span>
            default:
<span class="nc" id="L709">                return null;</span>
        }
        // 2**3 -1 in Anki
<span class="nc" id="L712">        int mask = 0b111;</span>
<span class="nc" id="L713">        return &quot;(c.flags &amp; &quot; + mask + &quot;) == &quot; + flag;</span>
    }

    private String _findRated(String val) {
        // days(:optional_ease)
<span class="nc" id="L718">        String[] r = val.split(&quot;:&quot;);</span>
        int days;
        try {
<span class="nc" id="L721">            days = Integer.parseInt(r[0]);</span>
<span class="nc" id="L722">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L723">            return null;</span>
<span class="nc" id="L724">        }</span>
<span class="nc" id="L725">        days = Math.min(days, 31);</span>
        // ease
<span class="nc" id="L727">        String ease = &quot;&quot;;</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22653)) {</span>
<span class="nc bnc" id="L729" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(22650) ? (r.length &gt;= 1) : (ListenerUtil.mutListener.listen(22649) ? (r.length &lt;= 1) : (ListenerUtil.mutListener.listen(22648) ? (r.length &lt; 1) : (ListenerUtil.mutListener.listen(22647) ? (r.length != 1) : (ListenerUtil.mutListener.listen(22646) ? (r.length == 1) : (r.length &gt; 1))))))) {</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22651)) {</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">                    if (!Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;).contains(r[1])) {</span>
<span class="nc" id="L732">                        return null;</span>
                    }
                }
<span class="nc bnc" id="L735" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22652)) {</span>
<span class="nc" id="L736">                    ease = &quot;and ease=&quot; + r[1];</span>
                }
            }
        }
<span class="nc bnc" id="L740" title="All 248 branches missed.">        long cutoff = (ListenerUtil.mutListener.listen(22665) ? (((ListenerUtil.mutListener.listen(22661) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22660) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22659) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22658) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) % 1000) : (ListenerUtil.mutListener.listen(22664) ? (((ListenerUtil.mutListener.listen(22661) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22660) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22659) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22658) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) / 1000) : (ListenerUtil.mutListener.listen(22663) ? (((ListenerUtil.mutListener.listen(22661) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22660) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22659) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22658) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) - 1000) : (ListenerUtil.mutListener.listen(22662) ? (((ListenerUtil.mutListener.listen(22661) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22660) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22659) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22658) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) + 1000) : (((ListenerUtil.mutListener.listen(22661) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22660) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22659) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22658) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22657) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22656) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22655) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22654) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) * 1000)))));</span>
<span class="nc" id="L741">        return &quot;c.id in (select cid from revlog where id&gt;&quot; + cutoff + &quot; &quot; + ease + &quot;)&quot;;</span>
    }

    private String _findAdded(String val) {
        int days;
        try {
<span class="nc" id="L747">            days = Integer.parseInt(val);</span>
<span class="nc" id="L748">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L749">            return null;</span>
<span class="nc" id="L750">        }</span>
<span class="nc bnc" id="L751" title="All 248 branches missed.">        long cutoff = (ListenerUtil.mutListener.listen(22677) ? (((ListenerUtil.mutListener.listen(22673) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22672) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22671) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22670) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) % 1000) : (ListenerUtil.mutListener.listen(22676) ? (((ListenerUtil.mutListener.listen(22673) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22672) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22671) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22670) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) / 1000) : (ListenerUtil.mutListener.listen(22675) ? (((ListenerUtil.mutListener.listen(22673) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22672) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22671) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22670) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) - 1000) : (ListenerUtil.mutListener.listen(22674) ? (((ListenerUtil.mutListener.listen(22673) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22672) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22671) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22670) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) + 1000) : (((ListenerUtil.mutListener.listen(22673) ? (mCol.getSched().getDayCutoff() % (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22672) ? (mCol.getSched().getDayCutoff() / (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22671) ? (mCol.getSched().getDayCutoff() * (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (ListenerUtil.mutListener.listen(22670) ? (mCol.getSched().getDayCutoff() + (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days)))))) : (mCol.getSched().getDayCutoff() - (ListenerUtil.mutListener.listen(22669) ? (SECONDS_PER_DAY % days) : (ListenerUtil.mutListener.listen(22668) ? (SECONDS_PER_DAY / days) : (ListenerUtil.mutListener.listen(22667) ? (SECONDS_PER_DAY - days) : (ListenerUtil.mutListener.listen(22666) ? (SECONDS_PER_DAY + days) : (SECONDS_PER_DAY * days))))))))))) * 1000)))));</span>
<span class="nc" id="L752">        return &quot;c.id &gt; &quot; + cutoff;</span>
    }

    private String _findProp(String _val) {
        // extract
<span class="nc" id="L757">        Matcher m = fPropPattern.matcher(_val);</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22678)) {</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">            if (!m.matches()) {</span>
<span class="nc" id="L760">                return null;</span>
            }
        }
<span class="nc" id="L763">        String prop = m.group(1).toLowerCase(Locale.ROOT);</span>
<span class="nc" id="L764">        String cmp = m.group(2);</span>
<span class="nc" id="L765">        String sval = m.group(3);</span>
        int val;
        // is val valid?
        try {
<span class="nc bnc" id="L769" title="All 2 branches missed.">            if (&quot;ease&quot;.equals(prop)) {</span>
                // LibAnki does this below, but we do it here to avoid keeping a separate float value.
<span class="nc bnc" id="L771" title="All 8 branches missed.">                val = (int) ((ListenerUtil.mutListener.listen(22682) ? (Double.parseDouble(sval) % 1000) : (ListenerUtil.mutListener.listen(22681) ? (Double.parseDouble(sval) / 1000) : (ListenerUtil.mutListener.listen(22680) ? (Double.parseDouble(sval) - 1000) : (ListenerUtil.mutListener.listen(22679) ? (Double.parseDouble(sval) + 1000) : (Double.parseDouble(sval) * 1000))))));</span>
            } else {
<span class="nc" id="L773">                val = Integer.parseInt(sval);</span>
            }
<span class="nc" id="L775">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L776">            return null;</span>
<span class="nc" id="L777">        }</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22683)) {</span>
            // is prop valid?
<span class="nc bnc" id="L780" title="All 2 branches missed.">            if (!Arrays.asList(&quot;due&quot;, &quot;ivl&quot;, &quot;reps&quot;, &quot;lapses&quot;, &quot;ease&quot;).contains(prop)) {</span>
<span class="nc" id="L781">                return null;</span>
            }
        }
        // query
<span class="nc" id="L785">        String q = &quot;&quot;;</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22687)) {</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">            if (&quot;due&quot;.equals(prop)) {</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22685)) {</span>
<span class="nc" id="L789">                    val += mCol.getSched().getToday();</span>
                }
<span class="nc bnc" id="L791" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22686)) {</span>
                    // only valid for review/daily learning
<span class="nc" id="L793">                    q = &quot;(c.queue in (&quot; + Consts.QUEUE_TYPE_REV + &quot;,&quot; + Consts.QUEUE_TYPE_DAY_LEARN_RELEARN + &quot;)) and &quot;;</span>
                }
<span class="nc bnc" id="L795" title="All 2 branches missed.">            } else if (&quot;ease&quot;.equals(prop)) {</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22684)) {</span>
<span class="nc" id="L797">                    prop = &quot;factor&quot;;</span>
                }
            }
        }
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22688)) {</span>
<span class="nc" id="L802">            q += &quot;(&quot; + prop + &quot; &quot; + cmp + &quot; &quot; + val + &quot;)&quot;;</span>
        }
<span class="nc" id="L804">        return q;</span>
    }

    private String _findText(String val, List&lt;String&gt; args) {
<span class="nc bnc" id="L808" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22689)) {</span>
<span class="nc" id="L809">            val = val.replace(&quot;*&quot;, &quot;%&quot;);</span>
        }
<span class="nc bnc" id="L811" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22690)) {</span>
<span class="nc" id="L812">            args.add(&quot;%&quot; + val + &quot;%&quot;);</span>
        }
<span class="nc bnc" id="L814" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22691)) {</span>
<span class="nc" id="L815">            args.add(&quot;%&quot; + val + &quot;%&quot;);</span>
        }
<span class="nc" id="L817">        return &quot;(n.sfld like ? escape '\\' or n.flds like ? escape '\\')&quot;;</span>
    }

    private String _findNids(String val) {
<span class="nc bnc" id="L821" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22692)) {</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">            if (fNidsPattern.matcher(val).find()) {</span>
<span class="nc" id="L823">                return null;</span>
            }
        }
<span class="nc" id="L826">        return &quot;n.id in (&quot; + val + &quot;)&quot;;</span>
    }

    private String _findCids(String val) {
<span class="nc bnc" id="L830" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22693)) {</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">            if (fNidsPattern.matcher(val).find()) {</span>
<span class="nc" id="L832">                return null;</span>
            }
        }
<span class="nc" id="L835">        return &quot;c.id in (&quot; + val + &quot;)&quot;;</span>
    }

    private String _findMid(String val) {
<span class="nc bnc" id="L839" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22694)) {</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">            if (fMidPattern.matcher(val).find()) {</span>
<span class="nc" id="L841">                return null;</span>
            }
        }
<span class="nc" id="L844">        return &quot;n.mid = &quot; + val;</span>
    }

    private String _findModel(String val) {
<span class="nc" id="L848">        LinkedList&lt;Long&gt; ids = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22698)) {</span>
            {
<span class="nc" id="L851">                long _loopCounter525 = 0;</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">                for (JSONObject m : mCol.getModels().all()) {</span>
<span class="nc" id="L853">                    ListenerUtil.loopListener.listen(&quot;_loopCounter525&quot;, ++_loopCounter525);</span>
<span class="nc" id="L854">                    String modelName = m.getString(&quot;name&quot;);</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22695)) {</span>
<span class="nc" id="L856">                        modelName = Normalizer.normalize(modelName, Normalizer.Form.NFC);</span>
                    }
<span class="nc bnc" id="L858" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22697)) {</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">                        if (modelName.equalsIgnoreCase(val)) {</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22696)) {</span>
<span class="nc" id="L861">                                ids.add(m.getLong(&quot;id&quot;));</span>
                            }
                        }
                    }
<span class="nc" id="L865">                }</span>
            }
        }
<span class="nc" id="L868">        return &quot;n.mid in &quot; + Utils.ids2str(ids);</span>
    }

    private List&lt;Long&gt; dids(Long did) {
<span class="nc bnc" id="L872" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22699)) {</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">            if (did == null) {</span>
<span class="nc" id="L874">                return null;</span>
            }
        }
<span class="nc" id="L877">        java.util.Collection&lt;Long&gt; children = mCol.getDecks().children(did).values();</span>
<span class="nc bnc" id="L878" title="All 8 branches missed.">        List&lt;Long&gt; res = new ArrayList&lt;&gt;((ListenerUtil.mutListener.listen(22703) ? (children.size() % 1) : (ListenerUtil.mutListener.listen(22702) ? (children.size() / 1) : (ListenerUtil.mutListener.listen(22701) ? (children.size() * 1) : (ListenerUtil.mutListener.listen(22700) ? (children.size() - 1) : (children.size() + 1))))));</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22704)) {</span>
<span class="nc" id="L880">            res.add(did);</span>
        }
<span class="nc bnc" id="L882" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22705)) {</span>
<span class="nc" id="L883">            res.addAll(children);</span>
        }
<span class="nc" id="L885">        return res;</span>
    }

    public String _findDeck(String val) {
<span class="nc bnc" id="L889" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22706)) {</span>
            // if searching for all decks, skip
<span class="nc bnc" id="L891" title="All 2 branches missed.">            if (&quot;*&quot;.equals(val)) {</span>
<span class="nc" id="L892">                return &quot;skip&quot;;</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">            } else if (&quot;filtered&quot;.equals(val)) {</span>
<span class="nc" id="L894">                return &quot;c.odid&quot;;</span>
            }
        }
<span class="nc" id="L897">        List&lt;Long&gt; ids = null;</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22720)) {</span>
            // current deck?
<span class="nc bnc" id="L900" title="All 2 branches missed.">            if (&quot;current&quot;.equalsIgnoreCase(val)) {</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22719)) {</span>
<span class="nc" id="L902">                    ids = dids(mCol.getDecks().selected());</span>
                }
<span class="nc bnc" id="L904" title="All 2 branches missed.">            } else if (!val.contains(&quot;*&quot;)) {</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22718)) {</span>
                    // single deck
<span class="nc" id="L907">                    ids = dids(mCol.getDecks().id(val, false));</span>
                }
            } else {
<span class="nc bnc" id="L910" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22707)) {</span>
                    // wildcard
<span class="nc" id="L912">                    ids = dids(mCol.getDecks().id(val, false));</span>
                }
<span class="nc bnc" id="L914" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22717)) {</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">                    if (ids == null) {</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22708)) {</span>
<span class="nc" id="L917">                            ids = new ArrayList&lt;&gt;();</span>
                        }
<span class="nc bnc" id="L919" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22709)) {</span>
<span class="nc" id="L920">                            val = val.replace(&quot;*&quot;, &quot;.*&quot;);</span>
                        }
<span class="nc bnc" id="L922" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22710)) {</span>
<span class="nc" id="L923">                            val = val.replace(&quot;+&quot;, &quot;\\+&quot;);</span>
                        }
<span class="nc bnc" id="L925" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22716)) {</span>
                            {
<span class="nc" id="L927">                                long _loopCounter527 = 0;</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">                                for (Deck d : mCol.getDecks().all()) {</span>
<span class="nc" id="L929">                                    ListenerUtil.loopListener.listen(&quot;_loopCounter527&quot;, ++_loopCounter527);</span>
<span class="nc" id="L930">                                    String deckName = d.getString(&quot;name&quot;);</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22711)) {</span>
<span class="nc" id="L932">                                        deckName = Normalizer.normalize(deckName, Normalizer.Form.NFC);</span>
                                    }
<span class="nc bnc" id="L934" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22715)) {</span>
<span class="nc bnc" id="L935" title="All 2 branches missed.">                                        if (deckName.matches(&quot;(?i)&quot; + val)) {</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(22714)) {</span>
                                                {
<span class="nc" id="L938">                                                    long _loopCounter526 = 0;</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">                                                    for (long id : dids(d.getLong(&quot;id&quot;))) {</span>
<span class="nc" id="L940">                                                        ListenerUtil.loopListener.listen(&quot;_loopCounter526&quot;, ++_loopCounter526);</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(22713)) {</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">                                                            if (!ids.contains(id)) {</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(22712)) {</span>
<span class="nc" id="L944">                                                                    ids.add(id);</span>
                                                                }
                                                            }
                                                        }
<span class="nc" id="L948">                                                    }</span>
                                                }
                                            }
                                        }
                                    }
<span class="nc" id="L953">                                }</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L960" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22727)) {</span>
<span class="nc bnc" id="L961" title="All 50 branches missed.">            if ((ListenerUtil.mutListener.listen(22726) ? (ids == null &amp;&amp; (ListenerUtil.mutListener.listen(22725) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(22724) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(22723) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(22722) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(22721) ? (ids.size() != 0) : (ids.size() == 0))))))) : (ids == null || (ListenerUtil.mutListener.listen(22725) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(22724) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(22723) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(22722) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(22721) ? (ids.size() != 0) : (ids.size() == 0))))))))) {</span>
<span class="nc" id="L962">                return null;</span>
            }
        }
<span class="nc" id="L965">        String sids = Utils.ids2str(ids);</span>
<span class="nc" id="L966">        return &quot;c.did in &quot; + sids + &quot; or c.odid in &quot; + sids;</span>
    }

    private String _findTemplate(String val) {
        // were we given an ordinal number?
<span class="nc" id="L971">        Integer num = null;</span>
        try {
<span class="nc bnc" id="L973" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22733)) {</span>
<span class="nc bnc" id="L974" title="All 8 branches missed.">                num = (ListenerUtil.mutListener.listen(22732) ? (Integer.parseInt(val) % 1) : (ListenerUtil.mutListener.listen(22731) ? (Integer.parseInt(val) / 1) : (ListenerUtil.mutListener.listen(22730) ? (Integer.parseInt(val) * 1) : (ListenerUtil.mutListener.listen(22729) ? (Integer.parseInt(val) + 1) : (Integer.parseInt(val) - 1)))));</span>
            }
<span class="nc" id="L976">        } catch (NumberFormatException e) {</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22728)) {</span>
<span class="nc" id="L978">                num = null;</span>
            }
<span class="nc" id="L980">        }</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22734)) {</span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">            if (num != null) {</span>
<span class="nc" id="L983">                return &quot;c.ord = &quot; + num;</span>
            }
        }
        // search for template names
<span class="nc" id="L987">        List&lt;String&gt; lims = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22741)) {</span>
            {
<span class="nc" id="L990">                long _loopCounter529 = 0;</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">                for (Model m : mCol.getModels().all()) {</span>
<span class="nc" id="L992">                    ListenerUtil.loopListener.listen(&quot;_loopCounter529&quot;, ++_loopCounter529);</span>
<span class="nc" id="L993">                    JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22740)) {</span>
                        {
<span class="nc" id="L996">                            long _loopCounter528 = 0;</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">                            for (JSONObject t : tmpls.jsonObjectIterable()) {</span>
<span class="nc" id="L998">                                ListenerUtil.loopListener.listen(&quot;_loopCounter528&quot;, ++_loopCounter528);</span>
<span class="nc" id="L999">                                String templateName = t.getString(&quot;name&quot;);</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22735)) {</span>
<span class="nc" id="L1001">                                    Normalizer.normalize(templateName, Normalizer.Form.NFC);</span>
                                }
<span class="nc bnc" id="L1003" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22739)) {</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">                                    if (templateName.equalsIgnoreCase(val)) {</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22738)) {</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">                                            if (m.isCloze()) {</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(22737)) {</span>
                                                    // model instead
<span class="nc" id="L1009">                                                    lims.add(&quot;(n.mid = &quot; + m.getLong(&quot;id&quot;) + &quot;)&quot;);</span>
                                                }
                                            } else {
<span class="nc bnc" id="L1012" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(22736)) {</span>
<span class="nc" id="L1013">                                                    lims.add(&quot;(n.mid = &quot; + m.getLong(&quot;id&quot;) + &quot; and c.ord = &quot; + t.getInt(&quot;ord&quot;) + &quot;)&quot;);</span>
                                                }
                                            }
                                        }
                                    }
                                }
<span class="nc" id="L1019">                            }</span>
                        }
                    }
<span class="nc" id="L1022">                }</span>
            }
        }
<span class="nc" id="L1025">        return TextUtils.join(&quot; or &quot;, lims.toArray(new String[lims.size()]));</span>
    }

    private String _findField(String field, String val) {
        /*
         * We need two expressions to query the cards: One that will use JAVA REGEX syntax and another
         * that should use SQLITE LIKE clause syntax.
         */
<span class="nc" id="L1033">        String sqlVal = val.replace(&quot;%&quot;, // For SQLITE, we escape all % signs</span>
<span class="nc" id="L1034">        &quot;\\%&quot;).replace(&quot;*&quot;, // And then convert the * into non-escaped % signs</span>
        &quot;%&quot;);
        /*
         * The following three lines make sure that only _ and * are valid wildcards.
         * Any other characters are enclosed inside the \Q \E markers, which force
         * all meta-characters in between them to lose their special meaning
         */
<span class="nc" id="L1041">        String javaVal = val.replace(&quot;_&quot;, &quot;\\E.\\Q&quot;).replace(&quot;*&quot;, &quot;\\E.*\\Q&quot;);</span>
        /*
         * For the pattern, we use the javaVal expression that uses JAVA REGEX syntax
         */
<span class="nc" id="L1045">        Pattern pattern = Pattern.compile(&quot;\\Q&quot; + javaVal + &quot;\\E&quot;, Pattern.CASE_INSENSITIVE | Pattern.DOTALL);</span>
        // find models that have that field
<span class="nc" id="L1047">        Map&lt;Long, Object[]&gt; mods = new HashMap&lt;&gt;(mCol.getModels().count());</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22746)) {</span>
            {
<span class="nc" id="L1050">                long _loopCounter531 = 0;</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">                for (JSONObject m : mCol.getModels().all()) {</span>
<span class="nc" id="L1052">                    ListenerUtil.loopListener.listen(&quot;_loopCounter531&quot;, ++_loopCounter531);</span>
<span class="nc" id="L1053">                    JSONArray flds = m.getJSONArray(&quot;flds&quot;);</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22745)) {</span>
                        {
<span class="nc" id="L1056">                            long _loopCounter530 = 0;</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                            for (JSONObject f : flds.jsonObjectIterable()) {</span>
<span class="nc" id="L1058">                                ListenerUtil.loopListener.listen(&quot;_loopCounter530&quot;, ++_loopCounter530);</span>
<span class="nc" id="L1059">                                String fieldName = f.getString(&quot;name&quot;);</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22742)) {</span>
<span class="nc" id="L1061">                                    fieldName = Normalizer.normalize(fieldName, Normalizer.Form.NFC);</span>
                                }
<span class="nc bnc" id="L1063" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22744)) {</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">                                    if (fieldName.equalsIgnoreCase(field)) {</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22743)) {</span>
<span class="nc" id="L1066">                                            mods.put(m.getLong(&quot;id&quot;), new Object[] { m, f.getInt(&quot;ord&quot;) });</span>
                                        }
                                    }
                                }
<span class="nc" id="L1070">                            }</span>
                        }
                    }
<span class="nc" id="L1073">                }</span>
            }
        }
<span class="nc bnc" id="L1076" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22747)) {</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">            if (mods.isEmpty()) {</span>
                // nothing has that field
<span class="nc" id="L1079">                return null;</span>
            }
        }
<span class="nc" id="L1082">        LinkedList&lt;Long&gt; nids = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1083">        try (Cursor cur = mCol.getDb().query(&quot;select id, mid, flds from notes where mid in &quot; + Utils.ids2str(new LinkedList&lt;&gt;(mods.keySet())) + &quot; and flds like ? escape '\\'&quot;, &quot;%&quot; + sqlVal + &quot;%&quot;)) {</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22750)) {</span>
                {
<span class="nc" id="L1086">                    long _loopCounter532 = 0;</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1088">                        ListenerUtil.loopListener.listen(&quot;_loopCounter532&quot;, ++_loopCounter532);</span>
<span class="nc" id="L1089">                        String[] flds = Utils.splitFields(cur.getString(2));</span>
<span class="nc" id="L1090">                        int ord = (Integer) mods.get(cur.getLong(1))[1];</span>
<span class="nc" id="L1091">                        String strg = flds[ord];</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22749)) {</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">                            if (pattern.matcher(strg).matches()) {</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22748)) {</span>
<span class="nc" id="L1095">                                    nids.add(cur.getLong(0));</span>
                                }
                            }
                        }
<span class="nc" id="L1099">                    }</span>
                }
            }
        }
<span class="nc bnc" id="L1103" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22751)) {</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">            if (nids.isEmpty()) {</span>
<span class="nc" id="L1105">                return &quot;0&quot;;</span>
            }
        }
<span class="nc" id="L1108">        return &quot;n.id in &quot; + Utils.ids2str(nids);</span>
    }

    private String _findDupes(String val) {
        // caller must call stripHTMLMedia on passed val
<span class="nc" id="L1113">        String[] split = val.split(&quot;,&quot;, 1);</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22757)) {</span>
<span class="nc bnc" id="L1115" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(22756) ? (split.length &gt;= 2) : (ListenerUtil.mutListener.listen(22755) ? (split.length &lt;= 2) : (ListenerUtil.mutListener.listen(22754) ? (split.length &gt; 2) : (ListenerUtil.mutListener.listen(22753) ? (split.length &lt; 2) : (ListenerUtil.mutListener.listen(22752) ? (split.length == 2) : (split.length != 2))))))) {</span>
<span class="nc" id="L1116">                return null;</span>
            }
        }
<span class="nc" id="L1119">        String mid = split[0];</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22758)) {</span>
<span class="nc" id="L1121">            val = split[1];</span>
        }
<span class="nc" id="L1123">        String csum = Long.toString(Utils.fieldChecksumWithoutHtmlMedia(val));</span>
<span class="nc" id="L1124">        List&lt;Long&gt; nids = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1125">        try (Cursor cur = mCol.getDb().query(&quot;select id, flds from notes where mid=? and csum=?&quot;, mid, csum)) {</span>
<span class="nc" id="L1126">            long nid = cur.getLong(0);</span>
<span class="nc" id="L1127">            String flds = cur.getString(1);</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22760)) {</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">                if (Utils.stripHTMLMedia(Utils.splitFields(flds)[0]).equals(val)) {</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22759)) {</span>
<span class="nc" id="L1131">                        nids.add(nid);</span>
                    }
                }
            }
        }
<span class="nc" id="L1136">        return &quot;n.id in &quot; + Utils.ids2str(nids);</span>
    }

    /**
     * Find and replace fields in a note
     *
     * @param col The collection to search into.
     * @param nids The cards to be searched for.
     * @param src The original text to find.
     * @param dst The text to change to.
     * @return Number of notes with fields that were updated.
     */
    public static int findReplace(Collection col, List&lt;Long&gt; nids, String src, String dst) {
<span class="nc" id="L1149">        return findReplace(col, nids, src, dst, false, null, true);</span>
    }

    /**
     * Find and replace fields in a note
     *
     * @param col The collection to search into.
     * @param nids The cards to be searched for.
     * @param src The original text to find.
     * @param dst The text to change to.
     * @param regex If true, the src is treated as a regex. Default = false.
     * @return Number of notes with fields that were updated.
     */
    public static int findReplace(Collection col, List&lt;Long&gt; nids, String src, String dst, boolean regex) {
<span class="nc" id="L1163">        return findReplace(col, nids, src, dst, regex, null, true);</span>
    }

    /**
     * Find and replace fields in a note
     *
     * @param col The collection to search into.
     * @param nids The cards to be searched for.
     * @param src The original text to find.
     * @param dst The text to change to.
     * @param field Limit the search to specific field. If null, it searches all fields.
     * @return Number of notes with fields that were updated.
     */
    public static int findReplace(Collection col, List&lt;Long&gt; nids, String src, String dst, String field) {
<span class="nc" id="L1177">        return findReplace(col, nids, src, dst, false, field, true);</span>
    }

    /**
     * Find and replace fields in a note
     *
     * @param col The collection to search into.
     * @param nids The cards to be searched for.
     * @param src The original text to find.
     * @param dst The text to change to.
     * @param isRegex If true, the src is treated as a regex. Default = false.
     * @param field Limit the search to specific field. If null, it searches all fields.
     * @param fold If true the search is case-insensitive. Default = true.
     * @return Number of notes with fields that were updated.
     */
    public static int findReplace(Collection col, List&lt;Long&gt; nids, String src, String dst, boolean isRegex, String field, boolean fold) {
<span class="nc" id="L1193">        Map&lt;Long, Integer&gt; mmap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22766)) {</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">            if (field != null) {</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22764)) {</span>
                    {
<span class="nc" id="L1198">                        long _loopCounter534 = 0;</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">                        for (JSONObject m : col.getModels().all()) {</span>
<span class="nc" id="L1200">                            ListenerUtil.loopListener.listen(&quot;_loopCounter534&quot;, ++_loopCounter534);</span>
<span class="nc" id="L1201">                            JSONArray flds = m.getJSONArray(&quot;flds&quot;);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22763)) {</span>
                                {
<span class="nc" id="L1204">                                    long _loopCounter533 = 0;</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">                                    for (JSONObject f : flds.jsonObjectIterable()) {</span>
<span class="nc" id="L1206">                                        ListenerUtil.loopListener.listen(&quot;_loopCounter533&quot;, ++_loopCounter533);</span>
<span class="nc bnc" id="L1207" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22762)) {</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">                                            if (f.getString(&quot;name&quot;).equalsIgnoreCase(field)) {</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(22761)) {</span>
<span class="nc" id="L1210">                                                    mmap.put(m.getLong(&quot;id&quot;), f.getInt(&quot;ord&quot;));</span>
                                                }
                                            }
                                        }
<span class="nc" id="L1214">                                    }</span>
                                }
                            }
<span class="nc" id="L1217">                        }</span>
                    }
                }
<span class="nc bnc" id="L1220" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22765)) {</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">                    if (mmap.isEmpty()) {</span>
<span class="nc" id="L1222">                        return 0;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L1227" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22769)) {</span>
            // find and gather replacements
<span class="nc bnc" id="L1229" title="All 2 branches missed.">            if (!isRegex) {</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22767)) {</span>
<span class="nc" id="L1231">                    src = Pattern.quote(src);</span>
                }
<span class="nc bnc" id="L1233" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22768)) {</span>
<span class="nc" id="L1234">                    dst = dst.replace(&quot;\\&quot;, &quot;\\\\&quot;);</span>
                }
            }
        }
<span class="nc bnc" id="L1238" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22771)) {</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">            if (fold) {</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22770)) {</span>
<span class="nc" id="L1241">                    src = &quot;(?i)&quot; + src;</span>
                }
            }
        }
<span class="nc" id="L1245">        Pattern regex = Pattern.compile(src);</span>
<span class="nc" id="L1246">        ArrayList&lt;Object[]&gt; d = new ArrayList&lt;&gt;(nids.size());</span>
<span class="nc" id="L1247">        String snids = Utils.ids2str(nids);</span>
<span class="nc" id="L1248">        Map&lt;Long, java.util.Collection&lt;Long&gt;&gt; midToNid = new HashMap&lt;&gt;(col.getModels().count());</span>
<span class="nc" id="L1249">        try (Cursor cur = col.getDb().query(&quot;select id, mid, flds from notes where id in &quot; + snids)) {</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22788)) {</span>
                {
<span class="nc" id="L1252">                    long _loopCounter536 = 0;</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1254">                        ListenerUtil.loopListener.listen(&quot;_loopCounter536&quot;, ++_loopCounter536);</span>
<span class="nc" id="L1255">                        long mid = cur.getLong(1);</span>
<span class="nc" id="L1256">                        String flds = cur.getString(2);</span>
<span class="nc" id="L1257">                        String origFlds = flds;</span>
                        // does it match?
<span class="nc" id="L1259">                        String[] sflds = Utils.splitFields(flds);</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22781)) {</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">                            if (field != null) {</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22779)) {</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">                                    if (!mmap.containsKey(mid)) {</span>
                                        // note doesn't have that field
<span class="nc" id="L1265">                                        continue;</span>
                                    }
                                }
<span class="nc" id="L1268">                                int ord = mmap.get(mid);</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22780)) {</span>
<span class="nc" id="L1270">                                    sflds[ord] = regex.matcher(sflds[ord]).replaceAll(dst);</span>
                                }
<span class="nc" id="L1272">                            } else {</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22778)) {</span>
                                    {
<span class="nc" id="L1275">                                        long _loopCounter535 = 0;</span>
<span class="nc bnc" id="L1276" title="All 22 branches missed.">                                        for (int i = 0; (ListenerUtil.mutListener.listen(22777) ? (i &gt;= sflds.length) : (ListenerUtil.mutListener.listen(22776) ? (i &lt;= sflds.length) : (ListenerUtil.mutListener.listen(22775) ? (i &gt; sflds.length) : (ListenerUtil.mutListener.listen(22774) ? (i != sflds.length) : (ListenerUtil.mutListener.listen(22773) ? (i == sflds.length) : (i &lt; sflds.length)))))); ++i) {</span>
<span class="nc" id="L1277">                                            ListenerUtil.loopListener.listen(&quot;_loopCounter535&quot;, ++_loopCounter535);</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(22772)) {</span>
<span class="nc" id="L1279">                                                sflds[i] = regex.matcher(sflds[i]).replaceAll(dst);</span>
                                            }
                                        }
                                    }
                                }
                            }
                        }
<span class="nc bnc" id="L1286" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22782)) {</span>
<span class="nc" id="L1287">                            flds = Utils.joinFields(sflds);</span>
                        }
<span class="nc bnc" id="L1289" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22787)) {</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">                            if (!flds.equals(origFlds)) {</span>
<span class="nc" id="L1291">                                long nid = cur.getLong(0);</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22784)) {</span>
<span class="nc bnc" id="L1293" title="All 2 branches missed.">                                    if (!midToNid.containsKey(mid)) {</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(22783)) {</span>
<span class="nc" id="L1295">                                            midToNid.put(mid, new ArrayList&lt;&gt;());</span>
                                        }
                                    }
                                }
<span class="nc bnc" id="L1299" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22785)) {</span>
<span class="nc" id="L1300">                                    midToNid.get(mid).add(nid);</span>
                                }
<span class="nc bnc" id="L1302" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22786)) {</span>
                                    // order based on query below
<span class="nc" id="L1304">                                    d.add(new Object[] { flds, col.getTime().intTime(), col.usn(), nid });</span>
                                }
                            }
                        }
<span class="nc" id="L1308">                    }</span>
                }
            }
        }
<span class="nc bnc" id="L1312" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22789)) {</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">            if (d.isEmpty()) {</span>
<span class="nc" id="L1314">                return 0;</span>
            }
        }
<span class="nc bnc" id="L1317" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22790)) {</span>
            // replace
<span class="nc" id="L1319">            col.getDb().executeMany(&quot;update notes set flds=?,mod=?,usn=? where id=?&quot;, d);</span>
        }
<span class="nc bnc" id="L1321" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22793)) {</span>
            {
<span class="nc" id="L1323">                long _loopCounter537 = 0;</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">                for (Map.Entry&lt;Long, java.util.Collection&lt;Long&gt;&gt; entry : midToNid.entrySet()) {</span>
<span class="nc" id="L1325">                    ListenerUtil.loopListener.listen(&quot;_loopCounter537&quot;, ++_loopCounter537);</span>
<span class="nc" id="L1326">                    long mid = entry.getKey();</span>
<span class="nc" id="L1327">                    java.util.Collection&lt;Long&gt; nids_ = entry.getValue();</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22791)) {</span>
<span class="nc" id="L1329">                        col.updateFieldCache(nids_);</span>
                    }
<span class="nc bnc" id="L1331" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(22792)) {</span>
<span class="nc" id="L1332">                        col.genCards(nids_, mid);</span>
                    }
<span class="nc" id="L1334">                }</span>
            }
        }
<span class="nc" id="L1337">        return d.size();</span>
    }

    public static Integer ordForMid(Collection col, Map&lt;Long, Integer&gt; fields, long mid, String fieldName) {
<span class="nc bnc" id="L1341" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22803)) {</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">            if (!fields.containsKey(mid)) {</span>
<span class="nc" id="L1343">                JSONObject model = col.getModels().get(mid);</span>
<span class="nc" id="L1344">                JSONArray flds = model.getJSONArray(&quot;flds&quot;);</span>
<span class="nc bnc" id="L1345" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22801)) {</span>
                    {
<span class="nc" id="L1347">                        long _loopCounter538 = 0;</span>
<span class="nc bnc" id="L1348" title="All 22 branches missed.">                        for (int c = 0; (ListenerUtil.mutListener.listen(22800) ? (c &gt;= flds.length()) : (ListenerUtil.mutListener.listen(22799) ? (c &lt;= flds.length()) : (ListenerUtil.mutListener.listen(22798) ? (c &gt; flds.length()) : (ListenerUtil.mutListener.listen(22797) ? (c != flds.length()) : (ListenerUtil.mutListener.listen(22796) ? (c == flds.length()) : (c &lt; flds.length())))))); c++) {</span>
<span class="nc" id="L1349">                            ListenerUtil.loopListener.listen(&quot;_loopCounter538&quot;, ++_loopCounter538);</span>
<span class="nc" id="L1350">                            JSONObject f = flds.getJSONObject(c);</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(22795)) {</span>
<span class="nc bnc" id="L1352" title="All 2 branches missed.">                                if (f.getString(&quot;name&quot;).equalsIgnoreCase(fieldName)) {</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(22794)) {</span>
<span class="nc" id="L1354">                                        fields.put(mid, c);</span>
                                    }
<span class="nc" id="L1356">                                    return c;</span>
                                }
                            }
                        }
                    }
                }
<span class="nc bnc" id="L1362" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22802)) {</span>
<span class="nc" id="L1363">                    fields.put(mid, null);</span>
                }
            }
        }
<span class="nc" id="L1367">        return fields.get(mid);</span>
    }

    public static List&lt;Pair&lt;String, List&lt;Long&gt;&gt;&gt; findDupes(Collection col, String fieldName) {
<span class="nc" id="L1371">        return findDupes(col, fieldName, &quot;&quot;);</span>
    }

    /**
     * @param col       the collection
     * @param fieldName a name of a field of some note type(s)
     * @param search A search query, as in the browser
     * @return List of Pair(&quot;dupestr&quot;, List[nids]), with nids note satisfying the search query, and having a field fieldName with value duepstr. Each list has at least two elements.
     */
    public static List&lt;Pair&lt;String, List&lt;Long&gt;&gt;&gt; findDupes(Collection col, String fieldName, String search) {
<span class="nc bnc" id="L1381" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22805)) {</span>
            // limit search to notes with applicable field name
<span class="nc bnc" id="L1383" title="All 2 branches missed.">            if (!TextUtils.isEmpty(search)) {</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22804)) {</span>
<span class="nc" id="L1385">                    search = &quot;(&quot; + search + &quot;) &quot;;</span>
                }
            }
        }
<span class="nc bnc" id="L1389" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22806)) {</span>
<span class="nc" id="L1390">            search += &quot;'&quot; + fieldName + &quot;:*'&quot;;</span>
        }
        // go through notes
<span class="nc" id="L1393">        List&lt;Long&gt; nids = col.findNotes(search);</span>
<span class="nc" id="L1394">        Map&lt;String, List&lt;Long&gt;&gt; vals = new HashMap&lt;&gt;(nids.size());</span>
<span class="nc" id="L1395">        List&lt;Pair&lt;String, List&lt;Long&gt;&gt;&gt; dupes = new ArrayList&lt;&gt;(nids.size());</span>
<span class="nc" id="L1396">        Map&lt;Long, Integer&gt; fields = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1397">        try (Cursor cur = col.getDb().query(&quot;select id, mid, flds from notes where id in &quot; + Utils.ids2str(col.findNotes(search)))) {</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22820)) {</span>
                {
<span class="nc" id="L1400">                    long _loopCounter539 = 0;</span>
<span class="nc bnc" id="L1401" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1402">                        ListenerUtil.loopListener.listen(&quot;_loopCounter539&quot;, ++_loopCounter539);</span>
<span class="nc" id="L1403">                        long nid = cur.getLong(0);</span>
<span class="nc" id="L1404">                        long mid = cur.getLong(1);</span>
<span class="nc" id="L1405">                        String[] flds = Utils.splitFields(cur.getString(2));</span>
<span class="nc" id="L1406">                        Integer ord = ordForMid(col, fields, mid, fieldName);</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22807)) {</span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">                            if (ord == null) {</span>
<span class="nc" id="L1409">                                continue;</span>
                            }
                        }
<span class="nc" id="L1412">                        String val = flds[ord];</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22808)) {</span>
<span class="nc" id="L1414">                            val = Utils.stripHTMLMedia(val);</span>
                        }
<span class="nc bnc" id="L1416" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22809)) {</span>
                            // empty does not count as duplicate
<span class="nc bnc" id="L1418" title="All 2 branches missed.">                            if (TextUtils.isEmpty(val)) {</span>
<span class="nc" id="L1419">                                continue;</span>
                            }
                        }
<span class="nc bnc" id="L1422" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22811)) {</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">                            if (!vals.containsKey(val)) {</span>
<span class="nc bnc" id="L1424" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22810)) {</span>
<span class="nc" id="L1425">                                    vals.put(val, new ArrayList&lt;&gt;());</span>
                                }
                            }
                        }
<span class="nc bnc" id="L1429" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22812)) {</span>
<span class="nc" id="L1430">                            vals.get(val).add(nid);</span>
                        }
<span class="nc bnc" id="L1432" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(22819)) {</span>
<span class="nc bnc" id="L1433" title="All 22 branches missed.">                            if ((ListenerUtil.mutListener.listen(22817) ? (vals.get(val).size() &gt;= 2) : (ListenerUtil.mutListener.listen(22816) ? (vals.get(val).size() &lt;= 2) : (ListenerUtil.mutListener.listen(22815) ? (vals.get(val).size() &gt; 2) : (ListenerUtil.mutListener.listen(22814) ? (vals.get(val).size() &lt; 2) : (ListenerUtil.mutListener.listen(22813) ? (vals.get(val).size() != 2) : (vals.get(val).size() == 2))))))) {</span>
<span class="nc bnc" id="L1434" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(22818)) {</span>
<span class="nc" id="L1435">                                    dupes.add(new Pair&lt;&gt;(val, vals.get(val)));</span>
                                }
                            }
                        }
<span class="nc" id="L1439">                    }</span>
                }
            }
        }
<span class="nc" id="L1443">        return dupes;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>