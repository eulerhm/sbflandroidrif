<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Collection.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.libanki</a> &gt; <span class="el_source">Collection.java</span></div><h1>Collection.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2011 Norbert Nagold &lt;norbert.nagold@gmail.com&gt;                         *
 *  Copyright (c) 2012 Kostas Spyropoulos &lt;inigo.aldana@gmail.com&gt;                       *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General private License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General private License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General private License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.libanki;

import android.annotation.SuppressLint;
import android.content.ContentValues;
import android.content.Context;
import android.content.res.Resources;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabaseLockedException;
import android.os.Build;
import android.text.TextUtils;
import android.util.Pair;
import com.ichi2.anki.AnkiDroidApp;
import com.ichi2.anki.R;
import com.ichi2.anki.UIUtils;
import com.ichi2.anki.analytics.UsageAnalytics;
import com.ichi2.anki.exception.ConfirmModSchemaException;
import com.ichi2.async.CancelListener;
import com.ichi2.async.CollectionTask;
import com.ichi2.async.ProgressSender;
import com.ichi2.async.TaskManager;
import com.ichi2.libanki.exception.NoSuchDeckException;
import com.ichi2.libanki.exception.UnknownDatabaseVersionException;
import com.ichi2.libanki.hooks.ChessFilter;
import com.ichi2.libanki.sched.AbstractSched;
import com.ichi2.libanki.sched.Sched;
import com.ichi2.libanki.sched.SchedV2;
import com.ichi2.libanki.template.ParsedNode;
import com.ichi2.libanki.template.TemplateError;
import com.ichi2.libanki.utils.Time;
import com.ichi2.upgrade.Upgrade;
import com.ichi2.utils.DatabaseChangeDecorator;
import com.ichi2.utils.FunctionalInterfaces;
import com.ichi2.utils.LanguageUtil;
import com.ichi2.utils.VersionUtils;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONException;
import com.ichi2.utils.JSONObject;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Random;
import java.util.concurrent.LinkedBlockingDeque;
import java.util.Set;
import java.util.regex.Pattern;
import androidx.annotation.CheckResult;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.VisibleForTesting;
import androidx.sqlite.db.SupportSQLiteDatabase;
import androidx.sqlite.db.SupportSQLiteStatement;
import timber.log.Timber;
import static com.ichi2.async.CancelListener.isCancelled;
import static com.ichi2.libanki.Collection.DismissType.REVIEW;
import static com.ichi2.libanki.Consts.DECK_DYN;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="pc bpc" id="L88" title="1 of 2 branches missed.">@SuppressWarnings({ &quot;PMD.ExcessiveClassLength&quot;, &quot;PMD.AvoidThrowingRawExceptionTypes&quot;, &quot;PMD.AvoidReassigningParameters&quot;, &quot;PMD.NPathComplexity&quot;, &quot;PMD.MethodNamingConventions&quot;, &quot;PMD.AvoidBranchingStatementAsLastInLoop&quot;, &quot;PMD.SwitchStmtsShouldHaveDefault&quot;, &quot;PMD.CollapsibleIfStatements&quot;, &quot;PMD.EmptyIfStmt&quot;, &quot;PMD.ExcessiveMethodLength&quot; })</span>
public class Collection {

    private final Context mContext;

    private DB mDb;

    private boolean mServer;

    // private double mLastSave;
    private final Media mMedia;

    private final Decks mDecks;

    private Models mModels;

    private final Tags mTags;

    private AbstractSched mSched;

    private long mStartTime;

    private int mStartReps;

    // BEGIN: SQL table columns
    private long mCrt;

    private long mMod;

    private long mScm;

    private boolean mDty;

    private int mUsn;

    private long mLs;

    private JSONObject mConf;

    // API 21: Use a ConcurrentLinkedDeque
    private LinkedBlockingDeque&lt;Undoable&gt; mUndo;

    private final String mPath;

    private boolean mDebugLog;

    private PrintWriter mLogHnd;

<span class="fc" id="L136">    private static final Pattern fClozePatternQ = Pattern.compile(&quot;\\{\\{(?!type:)(.*?)cloze:&quot;);</span>

<span class="fc" id="L138">    private static final Pattern fClozePatternA = Pattern.compile(&quot;\\{\\{(.*?)cloze:&quot;);</span>

<span class="fc" id="L140">    private static final Pattern fClozeTagStart = Pattern.compile(&quot;&lt;%cloze:&quot;);</span>

    private static final int fDefaultSchedulerVersion = 1;

<span class="fc" id="L144">    private static final List&lt;Integer&gt; fSupportedSchedulerVersions = Arrays.asList(1, 2);</span>

    // Not in libAnki.
    private final Time mTime;

    // other options
    public static final String defaultConf = &quot;{&quot; + // review options
    &quot;'activeDecks': [1], &quot; + &quot;'curDeck': 1, &quot; + &quot;'newSpread': &quot; + Consts.NEW_CARDS_DISTRIBUTE + &quot;, &quot; + &quot;'collapseTime': 1200, &quot; + &quot;'timeLim': 0, &quot; + &quot;'estTimes': True, &quot; + &quot;'dueCounts': True, &quot; + // other config
    &quot;'curModel': null, &quot; + &quot;'nextPos': 1, &quot; + &quot;'sortType': \&quot;noteFld\&quot;, &quot; + // add new to currently selected deck?
    &quot;'sortBackwards': False, 'addToCur': True }&quot;;

<span class="nc" id="L155">    public enum DismissType {</span>

<span class="nc" id="L157">        REVIEW(R.string.undo_action_review),</span>
<span class="nc" id="L158">        BURY_CARD(R.string.menu_bury_card),</span>
<span class="nc" id="L159">        BURY_NOTE(R.string.menu_bury_note),</span>
<span class="nc" id="L160">        SUSPEND_CARD(R.string.menu_suspend_card),</span>
<span class="nc" id="L161">        SUSPEND_CARD_MULTI(R.string.menu_suspend_card),</span>
<span class="nc" id="L162">        UNSUSPEND_CARD_MULTI(R.string.card_browser_unsuspend_card),</span>
<span class="nc" id="L163">        SUSPEND_NOTE(R.string.menu_suspend_note),</span>
<span class="nc" id="L164">        DELETE_NOTE(R.string.menu_delete_note),</span>
<span class="nc" id="L165">        DELETE_NOTE_MULTI(R.string.card_browser_delete_card),</span>
<span class="nc" id="L166">        CHANGE_DECK_MULTI(R.string.undo_action_change_deck_multi),</span>
<span class="nc" id="L167">        MARK_NOTE_MULTI(R.string.card_browser_mark_card),</span>
<span class="nc" id="L168">        UNMARK_NOTE_MULTI(R.string.card_browser_unmark_card),</span>
<span class="nc" id="L169">        FLAG(R.string.menu_flag),</span>
<span class="nc" id="L170">        REPOSITION_CARDS(R.string.card_editor_reposition_card),</span>
<span class="nc" id="L171">        RESCHEDULE_CARDS(R.string.card_editor_reschedule_card),</span>
<span class="nc" id="L172">        RESET_CARDS(R.string.card_editor_reset_card);</span>

        private final int mUndoNameId;

<span class="nc" id="L176">        DismissType(int undoNameId) {</span>
<span class="nc" id="L177">            this.mUndoNameId = undoNameId;</span>
<span class="nc" id="L178">        }</span>

        private Locale getLocale(Resources resources) {
<span class="nc" id="L181">            return LanguageUtil.getLocaleCompat(resources);</span>
        }

        public String getString(Resources res) {
<span class="nc" id="L185">            return res.getString(mUndoNameId).toLowerCase(getLocale(res));</span>
        }
    }

    private static final int UNDO_SIZE_MAX = 20;

    @VisibleForTesting
<span class="fc" id="L192">    public Collection(Context context, DB db, String path, boolean server, boolean log, @NonNull Time time) {</span>
<span class="fc" id="L193">        mContext = context;</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21201)) {</span>
<span class="fc" id="L195">            mDebugLog = log;</span>
        }
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21202)) {</span>
<span class="fc" id="L198">            mDb = db;</span>
        }
<span class="fc" id="L200">        mPath = path;</span>
<span class="fc" id="L201">        mTime = time;</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21203)) {</span>
<span class="fc" id="L203">            _openLog();</span>
        }
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21204)) {</span>
<span class="fc" id="L206">            log(path, VersionUtils.getPkgVersionName());</span>
        }
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21205)) {</span>
<span class="fc" id="L209">            mServer = server;</span>
        }
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21206)) {</span>
            // mLastSave = getTime().now(); // assigned but never accessed - only leaving in for upstream comparison
<span class="fc" id="L213">            clearUndo();</span>
        }
<span class="fc" id="L215">        mMedia = new Media(this, server);</span>
<span class="fc" id="L216">        mDecks = new Decks(this);</span>
<span class="fc" id="L217">        mTags = new Tags(this);</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21207)) {</span>
<span class="fc" id="L219">            load();</span>
        }
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21218)) {</span>
<span class="pc bpc" id="L222" title="15 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21212) ? (mCrt &gt;= 0) : (ListenerUtil.mutListener.listen(21211) ? (mCrt &lt;= 0) : (ListenerUtil.mutListener.listen(21210) ? (mCrt &gt; 0) : (ListenerUtil.mutListener.listen(21209) ? (mCrt &lt; 0) : (ListenerUtil.mutListener.listen(21208) ? (mCrt != 0) : (mCrt == 0))))))) {</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21217)) {</span>
<span class="pc bpc" id="L224" title="4 of 8 branches missed.">                    mCrt = (ListenerUtil.mutListener.listen(21216) ? (UIUtils.getDayStart(getTime()) % 1000) : (ListenerUtil.mutListener.listen(21215) ? (UIUtils.getDayStart(getTime()) * 1000) : (ListenerUtil.mutListener.listen(21214) ? (UIUtils.getDayStart(getTime()) - 1000) : (ListenerUtil.mutListener.listen(21213) ? (UIUtils.getDayStart(getTime()) + 1000) : (UIUtils.getDayStart(getTime()) / 1000)))));</span>
                }
            }
        }
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21219)) {</span>
<span class="fc" id="L229">            mStartReps = 0;</span>
        }
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21220)) {</span>
<span class="fc" id="L232">            mStartTime = 0;</span>
        }
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21221)) {</span>
<span class="fc" id="L235">            _loadScheduler();</span>
        }
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21224)) {</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">            if (!mConf.optBoolean(&quot;newBury&quot;, false)) {</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21222)) {</span>
<span class="fc" id="L240">                    mConf.put(&quot;newBury&quot;, true);</span>
                }
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21223)) {</span>
<span class="fc" id="L243">                    setMod();</span>
                }
            }
        }
<span class="fc" id="L247">    }</span>

    public String name() {
        // TODO:
<span class="nc" id="L251">        return (new File(mPath)).getName().replace(&quot;.anki2&quot;, &quot;&quot;);</span>
    }

    public int schedVer() {
<span class="fc" id="L255">        int ver = mConf.optInt(&quot;schedVer&quot;, fDefaultSchedulerVersion);</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">        if (fSupportedSchedulerVersions.contains(ver)) {</span>
<span class="fc" id="L257">            return ver;</span>
        } else {
<span class="nc" id="L259">            throw new RuntimeException(&quot;Unsupported scheduler version&quot;);</span>
        }
    }

    // Note: Additional members in the class duplicate this
    private void _loadScheduler() {
<span class="fc" id="L265">        int ver = schedVer();</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21237)) {</span>
<span class="pc bpc" id="L267" title="15 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21229) ? (ver &gt;= 1) : (ListenerUtil.mutListener.listen(21228) ? (ver &lt;= 1) : (ListenerUtil.mutListener.listen(21227) ? (ver &gt; 1) : (ListenerUtil.mutListener.listen(21226) ? (ver &lt; 1) : (ListenerUtil.mutListener.listen(21225) ? (ver != 1) : (ver == 1))))))) {</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21236)) {</span>
<span class="fc" id="L269">                    mSched = new Sched(this);</span>
                }
<span class="pc bpc" id="L271" title="16 of 22 branches missed.">            } else if ((ListenerUtil.mutListener.listen(21234) ? (ver &gt;= 2) : (ListenerUtil.mutListener.listen(21233) ? (ver &lt;= 2) : (ListenerUtil.mutListener.listen(21232) ? (ver &gt; 2) : (ListenerUtil.mutListener.listen(21231) ? (ver &lt; 2) : (ListenerUtil.mutListener.listen(21230) ? (ver != 2) : (ver == 2))))))) {</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21235)) {</span>
<span class="fc" id="L273">                    mSched = new SchedV2(this);</span>
                }
            }
        }
<span class="fc" id="L277">    }</span>

    public void changeSchedulerVer(Integer ver) throws ConfirmModSchemaException {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21243)) {</span>
<span class="nc bnc" id="L281" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21242) ? (ver &gt;= schedVer()) : (ListenerUtil.mutListener.listen(21241) ? (ver &lt;= schedVer()) : (ListenerUtil.mutListener.listen(21240) ? (ver &gt; schedVer()) : (ListenerUtil.mutListener.listen(21239) ? (ver &lt; schedVer()) : (ListenerUtil.mutListener.listen(21238) ? (ver != schedVer()) : (ver == schedVer()))))))) {</span>
<span class="nc" id="L282">                return;</span>
            }
        }
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21244)) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (!fSupportedSchedulerVersions.contains(ver)) {</span>
<span class="nc" id="L287">                throw new RuntimeException(&quot;Unsupported scheduler version&quot;);</span>
            }
        }
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21245)) {</span>
<span class="nc" id="L291">            modSchema();</span>
        }
        @SuppressLint(&quot;VisibleForTests&quot;)
<span class="nc" id="L294">        SchedV2 v2Sched = new SchedV2(this);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21246)) {</span>
<span class="nc" id="L296">            clearUndo();</span>
        }
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21254)) {</span>
<span class="nc bnc" id="L299" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21251) ? (ver &gt;= 1) : (ListenerUtil.mutListener.listen(21250) ? (ver &lt;= 1) : (ListenerUtil.mutListener.listen(21249) ? (ver &gt; 1) : (ListenerUtil.mutListener.listen(21248) ? (ver &lt; 1) : (ListenerUtil.mutListener.listen(21247) ? (ver != 1) : (ver == 1))))))) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21253)) {</span>
<span class="nc" id="L301">                    v2Sched.moveToV1();</span>
                }
            } else {
<span class="nc bnc" id="L304" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21252)) {</span>
<span class="nc" id="L305">                    v2Sched.moveToV2();</span>
                }
            }
        }
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21255)) {</span>
<span class="nc" id="L310">            mConf.put(&quot;schedVer&quot;, ver);</span>
        }
<span class="nc bnc" id="L312" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21256)) {</span>
<span class="nc" id="L313">            setMod();</span>
        }
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21257)) {</span>
<span class="nc" id="L316">            _loadScheduler();</span>
        }
<span class="nc" id="L318">    }</span>

    public void load() {
<span class="fc" id="L321">        Cursor cursor = null;</span>
<span class="fc" id="L322">        String deckConf = &quot;&quot;;</span>
        try {
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21260)) {</span>
                // Read in deck table columns
<span class="fc" id="L326">                cursor = mDb.query(&quot;SELECT crt, mod, scm, dty, usn, ls, &quot; + &quot;conf, dconf, tags FROM col&quot;);</span>
            }
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21261)) {</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">                if (!cursor.moveToFirst()) {</span>
<span class="nc" id="L330">                    return;</span>
                }
            }
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21262)) {</span>
<span class="fc" id="L334">                mCrt = cursor.getLong(0);</span>
            }
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21263)) {</span>
<span class="fc" id="L337">                mMod = cursor.getLong(1);</span>
            }
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21264)) {</span>
<span class="fc" id="L340">                mScm = cursor.getLong(2);</span>
            }
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21265)) {</span>
                // No longer used
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">                mDty = cursor.getInt(3) == 1;</span>
            }
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21266)) {</span>
<span class="fc" id="L347">                mUsn = cursor.getInt(4);</span>
            }
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21267)) {</span>
<span class="fc" id="L350">                mLs = cursor.getLong(5);</span>
            }
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21268)) {</span>
<span class="fc" id="L353">                mConf = new JSONObject(cursor.getString(6));</span>
            }
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21269)) {</span>
<span class="fc" id="L356">                deckConf = cursor.getString(7);</span>
            }
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21270)) {</span>
<span class="fc" id="L359">                mTags.load(cursor.getString(8));</span>
            }
        } finally {
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21259)) {</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">                if (cursor != null) {</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21258)) {</span>
<span class="fc" id="L365">                        cursor.close();</span>
                    }
                }
            }
        }
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21271)) {</span>
            // otherwise they get loaded when required.
<span class="fc" id="L372">            mDecks.load(loadColumn(&quot;decks&quot;), deckConf);</span>
        }
<span class="fc" id="L374">    }</span>

<span class="fc" id="L376">    private static int sChunk = 0;</span>

    private int getChunk() {
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21277)) {</span>
<span class="pc bpc" id="L380" title="15 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21276) ? (sChunk &gt;= 0) : (ListenerUtil.mutListener.listen(21275) ? (sChunk &lt;= 0) : (ListenerUtil.mutListener.listen(21274) ? (sChunk &gt; 0) : (ListenerUtil.mutListener.listen(21273) ? (sChunk &lt; 0) : (ListenerUtil.mutListener.listen(21272) ? (sChunk == 0) : (sChunk != 0))))))) {</span>
<span class="fc" id="L381">                return sChunk;</span>
            }
        }
        // Values are copied here. Ideally, a getter would allow to access it.
<span class="fc" id="L385">        final int WINDOW_SIZE_KB = 2048;</span>
<span class="pc bpc" id="L386" title="4 of 8 branches missed.">        int sCursorWindowSize = (ListenerUtil.mutListener.listen(21281) ? (WINDOW_SIZE_KB % 1024) : (ListenerUtil.mutListener.listen(21280) ? (WINDOW_SIZE_KB / 1024) : (ListenerUtil.mutListener.listen(21279) ? (WINDOW_SIZE_KB - 1024) : (ListenerUtil.mutListener.listen(21278) ? (WINDOW_SIZE_KB + 1024) : (WINDOW_SIZE_KB * 1024)))));</span>
        // as a ceiling. Try it, with a reasonable fallback in case of failure
<span class="fc" id="L388">        SupportSQLiteDatabase db = mDb.getDatabase();</span>
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21282)) {</span>
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">            if (!(db instanceof DatabaseChangeDecorator)) {</span>
<span class="nc" id="L391">                return sChunk;</span>
            }
        }
<span class="fc" id="L394">        String db_name = ((DatabaseChangeDecorator) db).getWrapped().getClass().getName();</span>
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21294)) {</span>
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">            if (&quot;io.requery.android.database.sqlite.SQLiteDatabase&quot;.equals(db_name)) {</span>
                try {
<span class="fc" id="L398">                    Field cursorWindowSize = io.requery.android.database.CursorWindow.class.getDeclaredField(&quot;sDefaultCursorWindowSize&quot;);</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21284)) {</span>
<span class="fc" id="L400">                        cursorWindowSize.setAccessible(true);</span>
                    }
<span class="fc" id="L402">                    int possibleCursorWindowSize = cursorWindowSize.getInt(null);</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21285)) {</span>
<span class="fc" id="L404">                        Timber.d(&quot;Reflectively discovered database default cursor window size %d&quot;, possibleCursorWindowSize);</span>
                    }
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21293)) {</span>
<span class="pc bpc" id="L407" title="16 of 22 branches missed.">                        if ((ListenerUtil.mutListener.listen(21290) ? (possibleCursorWindowSize &gt;= 0) : (ListenerUtil.mutListener.listen(21289) ? (possibleCursorWindowSize &lt;= 0) : (ListenerUtil.mutListener.listen(21288) ? (possibleCursorWindowSize &lt; 0) : (ListenerUtil.mutListener.listen(21287) ? (possibleCursorWindowSize != 0) : (ListenerUtil.mutListener.listen(21286) ? (possibleCursorWindowSize == 0) : (possibleCursorWindowSize &gt; 0))))))) {</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21292)) {</span>
<span class="fc" id="L409">                                sCursorWindowSize = possibleCursorWindowSize;</span>
                            }
                        } else {
<span class="nc bnc" id="L412" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21291)) {</span>
<span class="nc" id="L413">                                Timber.w(&quot;Obtained unusable cursor window size: %d. Using default %d&quot;, possibleCursorWindowSize, sCursorWindowSize);</span>
                            }
                        }
                    }
<span class="nc" id="L417">                } catch (Exception e) {</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21283)) {</span>
<span class="nc" id="L419">                        Timber.w(e, &quot;Unable to get window size from requery cursor.&quot;);</span>
                    }
<span class="fc" id="L421">                }</span>
            }
        }
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21303)) {</span>
            // reduce the actual size a little bit.
<span class="pc bpc" id="L426" title="40 of 48 branches missed.">            sChunk = (int) ((ListenerUtil.mutListener.listen(21302) ? ((ListenerUtil.mutListener.listen(21298) ? (sCursorWindowSize % 15.) : (ListenerUtil.mutListener.listen(21297) ? (sCursorWindowSize / 15.) : (ListenerUtil.mutListener.listen(21296) ? (sCursorWindowSize - 15.) : (ListenerUtil.mutListener.listen(21295) ? (sCursorWindowSize + 15.) : (sCursorWindowSize * 15.))))) % 16.) : (ListenerUtil.mutListener.listen(21301) ? ((ListenerUtil.mutListener.listen(21298) ? (sCursorWindowSize % 15.) : (ListenerUtil.mutListener.listen(21297) ? (sCursorWindowSize / 15.) : (ListenerUtil.mutListener.listen(21296) ? (sCursorWindowSize - 15.) : (ListenerUtil.mutListener.listen(21295) ? (sCursorWindowSize + 15.) : (sCursorWindowSize * 15.))))) * 16.) : (ListenerUtil.mutListener.listen(21300) ? ((ListenerUtil.mutListener.listen(21298) ? (sCursorWindowSize % 15.) : (ListenerUtil.mutListener.listen(21297) ? (sCursorWindowSize / 15.) : (ListenerUtil.mutListener.listen(21296) ? (sCursorWindowSize - 15.) : (ListenerUtil.mutListener.listen(21295) ? (sCursorWindowSize + 15.) : (sCursorWindowSize * 15.))))) - 16.) : (ListenerUtil.mutListener.listen(21299) ? ((ListenerUtil.mutListener.listen(21298) ? (sCursorWindowSize % 15.) : (ListenerUtil.mutListener.listen(21297) ? (sCursorWindowSize / 15.) : (ListenerUtil.mutListener.listen(21296) ? (sCursorWindowSize - 15.) : (ListenerUtil.mutListener.listen(21295) ? (sCursorWindowSize + 15.) : (sCursorWindowSize * 15.))))) + 16.) : ((ListenerUtil.mutListener.listen(21298) ? (sCursorWindowSize % 15.) : (ListenerUtil.mutListener.listen(21297) ? (sCursorWindowSize / 15.) : (ListenerUtil.mutListener.listen(21296) ? (sCursorWindowSize - 15.) : (ListenerUtil.mutListener.listen(21295) ? (sCursorWindowSize + 15.) : (sCursorWindowSize * 15.))))) / 16.))))));</span>
        }
<span class="fc" id="L428">        return sChunk;</span>
    }

    public String loadColumn(String columnName) {
<span class="fc" id="L432">        int pos = 1;</span>
<span class="fc" id="L433">        StringBuilder buf = new StringBuilder();</span>
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21319)) {</span>
            {
<span class="fc" id="L436">                long _loopCounter457 = 0;</span>
                while (true) {
<span class="fc" id="L438">                    ListenerUtil.loopListener.listen(&quot;_loopCounter457&quot;, ++_loopCounter457);</span>
<span class="pc" id="L439">                    try (Cursor cursor = mDb.query(&quot;SELECT substr(&quot; + columnName + &quot;, ?, ?) FROM col&quot;, Integer.toString(pos), Integer.toString(getChunk()))) {</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21304)) {</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">                            if (!cursor.moveToFirst()) {</span>
<span class="nc" id="L442">                                return buf.toString();</span>
                            }
                        }
<span class="fc" id="L445">                        String res = cursor.getString(0);</span>
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21310)) {</span>
<span class="pc bpc" id="L447" title="16 of 22 branches missed.">                            if ((ListenerUtil.mutListener.listen(21309) ? (res.length() &gt;= 0) : (ListenerUtil.mutListener.listen(21308) ? (res.length() &lt;= 0) : (ListenerUtil.mutListener.listen(21307) ? (res.length() &gt; 0) : (ListenerUtil.mutListener.listen(21306) ? (res.length() &lt; 0) : (ListenerUtil.mutListener.listen(21305) ? (res.length() != 0) : (res.length() == 0))))))) {</span>
                                break;
                            }
                        }
<span class="pc bpc" id="L451" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21311)) {</span>
<span class="fc" id="L452">                            buf.append(res);</span>
                        }
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21317)) {</span>
<span class="pc bpc" id="L455" title="16 of 22 branches missed.">                            if ((ListenerUtil.mutListener.listen(21316) ? (res.length() &gt;= getChunk()) : (ListenerUtil.mutListener.listen(21315) ? (res.length() &lt;= getChunk()) : (ListenerUtil.mutListener.listen(21314) ? (res.length() &gt; getChunk()) : (ListenerUtil.mutListener.listen(21313) ? (res.length() != getChunk()) : (ListenerUtil.mutListener.listen(21312) ? (res.length() == getChunk()) : (res.length() &lt; getChunk()))))))) {</span>
                                break;
                            }
                        }
<span class="nc bnc" id="L459" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21318)) {</span>
<span class="nc" id="L460">                            pos += getChunk();</span>
                        }
<span class="pc bpc" id="L462" title="5 of 6 branches missed.">                    }</span>
                }
            }
        }
<span class="fc" id="L466">        return buf.toString();</span>
    }

    /**
     * Mark DB modified. DB operations and the deck/tag/model managers do this automatically, so this is only necessary
     * if you modify properties of this object or the conf dict.
     */
    public void setMod() {
<span class="pc bpc" id="L474" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21320)) {</span>
<span class="fc" id="L475">            mDb.setMod(true);</span>
        }
<span class="fc" id="L477">    }</span>

    public void flush() {
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21321)) {</span>
<span class="nc" id="L481">            flush(0);</span>
        }
<span class="nc" id="L483">    }</span>

    /**
     * Flush state to DB, updating mod time.
     */
    public void flush(long mod) {
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21322)) {</span>
<span class="fc" id="L490">            Timber.i(&quot;flush - Saving information to DB...&quot;);</span>
        }
<span class="pc bpc" id="L492" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21328)) {</span>
<span class="pc bpc" id="L493" title="16 of 22 branches missed.">            mMod = ((ListenerUtil.mutListener.listen(21327) ? (mod &gt;= 0) : (ListenerUtil.mutListener.listen(21326) ? (mod &lt;= 0) : (ListenerUtil.mutListener.listen(21325) ? (mod &gt; 0) : (ListenerUtil.mutListener.listen(21324) ? (mod &lt; 0) : (ListenerUtil.mutListener.listen(21323) ? (mod != 0) : (mod == 0)))))) ? getTime().intTimeMS() : mod);</span>
        }
<span class="fc" id="L495">        ContentValues values = new ContentValues();</span>
<span class="pc bpc" id="L496" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21329)) {</span>
<span class="fc" id="L497">            values.put(&quot;crt&quot;, mCrt);</span>
        }
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21330)) {</span>
<span class="fc" id="L500">            values.put(&quot;mod&quot;, mMod);</span>
        }
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21331)) {</span>
<span class="fc" id="L503">            values.put(&quot;scm&quot;, mScm);</span>
        }
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21332)) {</span>
<span class="pc bpc" id="L506" title="1 of 2 branches missed.">            values.put(&quot;dty&quot;, mDty ? 1 : 0);</span>
        }
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21333)) {</span>
<span class="fc" id="L509">            values.put(&quot;usn&quot;, mUsn);</span>
        }
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21334)) {</span>
<span class="fc" id="L512">            values.put(&quot;ls&quot;, mLs);</span>
        }
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21335)) {</span>
<span class="fc" id="L515">            values.put(&quot;conf&quot;, Utils.jsonToString(mConf));</span>
        }
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21336)) {</span>
<span class="fc" id="L518">            mDb.update(&quot;col&quot;, values);</span>
        }
<span class="fc" id="L520">    }</span>

    /**
     * Flush, commit DB, and take out another write lock.
     */
    public synchronized void save() {
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21337)) {</span>
<span class="fc" id="L527">            save(null, 0);</span>
        }
<span class="fc" id="L529">    }</span>

    public synchronized void save(long mod) {
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21338)) {</span>
<span class="nc" id="L533">            save(null, mod);</span>
        }
<span class="nc" id="L535">    }</span>

    public synchronized void save(String name) {
<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21339)) {</span>
<span class="nc" id="L539">            save(name, 0);</span>
        }
<span class="nc" id="L541">    }</span>

    public synchronized void save(String name, long mod) {
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21340)) {</span>
            // let the managers conditionally flush
<span class="fc" id="L546">            getModels().flush();</span>
        }
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21341)) {</span>
<span class="fc" id="L549">            mDecks.flush();</span>
        }
<span class="pc bpc" id="L551" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21342)) {</span>
<span class="fc" id="L552">            mTags.flush();</span>
        }
<span class="pc bpc" id="L554" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21346)) {</span>
            // and flush deck + bump mod if db has been changed
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">            if (mDb.getMod()) {</span>
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21343)) {</span>
<span class="fc" id="L558">                    flush(mod);</span>
                }
<span class="pc bpc" id="L560" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21344)) {</span>
<span class="fc" id="L561">                    mDb.commit();</span>
                }
<span class="pc bpc" id="L563" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21345)) {</span>
<span class="fc" id="L564">                    mDb.setMod(false);</span>
                }
            }
        }
<span class="fc" id="L568">    }</span>

    /**
     * Disconnect from DB.
     */
    public synchronized void close() {
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21347)) {</span>
<span class="fc" id="L575">            close(true);</span>
        }
<span class="fc" id="L577">    }</span>

    public synchronized void close(boolean save) {
<span class="pc bpc" id="L580" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21359)) {</span>
<span class="pc bpc" id="L581" title="1 of 2 branches missed.">            if (mDb != null) {</span>
                try {
<span class="fc" id="L583">                    SupportSQLiteDatabase db = mDb.getDatabase();</span>
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21351)) {</span>
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">                        if (save) {</span>
<span class="pc bpc" id="L586" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21350)) {</span>
<span class="fc" id="L587">                                mDb.executeInTransaction(this::save);</span>
                            }
                        } else {
<span class="nc bnc" id="L590" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21349)) {</span>
<span class="nc" id="L591">                                DB.safeEndInTransaction(db);</span>
                            }
                        }
                    }
<span class="nc" id="L595">                } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21348)) {</span>
<span class="nc" id="L597">                        AnkiDroidApp.sendExceptionReport(e, &quot;closeDB&quot;);</span>
                    }
<span class="fc" id="L599">                }</span>
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21353)) {</span>
<span class="pc bpc" id="L601" title="1 of 2 branches missed.">                    if (!mServer) {</span>
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21352)) {</span>
<span class="fc" id="L603">                            mDb.getDatabase().disableWriteAheadLogging();</span>
                        }
                    }
                }
<span class="pc bpc" id="L607" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21354)) {</span>
<span class="fc" id="L608">                    mDb.close();</span>
                }
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21355)) {</span>
<span class="fc" id="L611">                    mDb = null;</span>
                }
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21356)) {</span>
<span class="fc" id="L614">                    mMedia.close();</span>
                }
<span class="pc bpc" id="L616" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21357)) {</span>
<span class="fc" id="L617">                    _closeLog();</span>
                }
<span class="pc bpc" id="L619" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21358)) {</span>
<span class="fc" id="L620">                    Timber.i(&quot;Collection closed&quot;);</span>
                }
            }
        }
<span class="fc" id="L624">    }</span>

    public void reopen() {
<span class="nc bnc" id="L627" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21360)) {</span>
<span class="nc" id="L628">            Timber.i(&quot;Reopening Database&quot;);</span>
        }
<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21364)) {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">            if (mDb == null) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21361)) {</span>
<span class="nc" id="L633">                    mDb = new DB(mPath);</span>
                }
<span class="nc bnc" id="L635" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21362)) {</span>
<span class="nc" id="L636">                    mMedia.connect();</span>
                }
<span class="nc bnc" id="L638" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21363)) {</span>
<span class="nc" id="L639">                    _openLog();</span>
                }
            }
        }
<span class="nc" id="L643">    }</span>

    /**
     * Note: not in libanki.  Mark schema modified to force a full
     * sync, but with the confirmation checking function disabled This
     * is equivalent to `modSchema(False)` in Anki. A distinct method
     * is used so that the type does not states that an exception is
     * thrown when in fact it is never thrown.
     */
    public void modSchemaNoCheck() {
<span class="pc bpc" id="L653" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21365)) {</span>
<span class="fc" id="L654">            mScm = getTime().intTimeMS();</span>
        }
<span class="pc bpc" id="L656" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21366)) {</span>
<span class="fc" id="L657">            setMod();</span>
        }
<span class="fc" id="L659">    }</span>

    /**
     * Mark schema modified to force a full sync.
     * ConfirmModSchemaException will be thrown if the user needs to be prompted to confirm the action.
     * If the user chooses to confirm then modSchemaNoCheck should be called, after which the exception can
     * be safely ignored, and the outer code called again.
     *
     * @throws ConfirmModSchemaException
     */
    public void modSchema() throws ConfirmModSchemaException {
<span class="pc bpc" id="L670" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21367)) {</span>
<span class="pc bpc" id="L671" title="1 of 2 branches missed.">            if (!schemaChanged()) {</span>
                /* In Android we can't show a dialog which blocks the main UI thread
             Therefore we can't wait for the user to confirm if they want to do
             a full sync here, and we instead throw an exception asking the outer
             code to handle the user's choice */
<span class="nc" id="L676">                throw new ConfirmModSchemaException();</span>
            }
        }
<span class="pc bpc" id="L679" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21368)) {</span>
<span class="fc" id="L680">            modSchemaNoCheck();</span>
        }
<span class="fc" id="L682">    }</span>

    /**
     * True if schema changed since last sync.
     */
    public boolean schemaChanged() {
<span class="pc bpc" id="L688" title="16 of 22 branches missed.">        return (ListenerUtil.mutListener.listen(21373) ? (mScm &gt;= mLs) : (ListenerUtil.mutListener.listen(21372) ? (mScm &lt;= mLs) : (ListenerUtil.mutListener.listen(21371) ? (mScm &lt; mLs) : (ListenerUtil.mutListener.listen(21370) ? (mScm != mLs) : (ListenerUtil.mutListener.listen(21369) ? (mScm == mLs) : (mScm &gt; mLs))))));</span>
    }

    public int usn() {
<span class="pc bpc" id="L692" title="1 of 2 branches missed.">        if (mServer) {</span>
<span class="nc" id="L693">            return mUsn;</span>
        } else {
<span class="fc" id="L695">            return -1;</span>
        }
    }

    /**
     * called before a full upload
     */
    public void beforeUpload() {
<span class="nc" id="L703">        String[] tables = new String[] { &quot;notes&quot;, &quot;cards&quot;, &quot;revlog&quot; };</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21375)) {</span>
            {
<span class="nc" id="L706">                long _loopCounter458 = 0;</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">                for (String t : tables) {</span>
<span class="nc" id="L708">                    ListenerUtil.loopListener.listen(&quot;_loopCounter458&quot;, ++_loopCounter458);</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21374)) {</span>
<span class="nc" id="L710">                        mDb.execute(&quot;UPDATE &quot; + t + &quot; SET usn=0 WHERE usn=-1&quot;);</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21376)) {</span>
            // we can save space by removing the log of deletions
<span class="nc" id="L717">            mDb.execute(&quot;delete from graves&quot;);</span>
        }
<span class="nc bnc" id="L719" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21377)) {</span>
<span class="nc" id="L720">            mUsn += 1;</span>
        }
<span class="nc bnc" id="L722" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21378)) {</span>
<span class="nc" id="L723">            getModels().beforeUpload();</span>
        }
<span class="nc bnc" id="L725" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21379)) {</span>
<span class="nc" id="L726">            mTags.beforeUpload();</span>
        }
<span class="nc bnc" id="L728" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21380)) {</span>
<span class="nc" id="L729">            mDecks.beforeUpload();</span>
        }
<span class="nc bnc" id="L731" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21381)) {</span>
<span class="nc" id="L732">            modSchemaNoCheck();</span>
        }
<span class="nc bnc" id="L734" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21382)) {</span>
<span class="nc" id="L735">            mLs = mScm;</span>
        }
<span class="nc bnc" id="L737" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21383)) {</span>
<span class="nc" id="L738">            Timber.i(&quot;Compacting database before full upload&quot;);</span>
        }
<span class="nc bnc" id="L740" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21384)) {</span>
            // ensure db is compacted before upload
<span class="nc" id="L742">            mDb.execute(&quot;vacuum&quot;);</span>
        }
<span class="nc bnc" id="L744" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21385)) {</span>
<span class="nc" id="L745">            mDb.execute(&quot;analyze&quot;);</span>
        }
<span class="nc bnc" id="L747" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21386)) {</span>
<span class="nc" id="L748">            close();</span>
        }
<span class="nc" id="L750">    }</span>

    public Card getCard(long id) {
<span class="nc" id="L753">        return new Card(this, id);</span>
    }

    public Card.Cache getCardCache(long id) {
<span class="nc" id="L757">        return new Card.Cache(this, id);</span>
    }

    public Note getNote(long id) {
<span class="nc" id="L761">        return new Note(this, id);</span>
    }

    public int nextID(String type) {
<span class="nc bnc" id="L765" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21387)) {</span>
<span class="nc" id="L766">            type = &quot;next&quot; + Character.toUpperCase(type.charAt(0)) + type.substring(1);</span>
        }
        int id;
        try {
<span class="nc" id="L770">            id = mConf.getInt(type);</span>
<span class="nc" id="L771">        } catch (JSONException e) {</span>
<span class="nc" id="L772">            id = 1;</span>
<span class="nc" id="L773">        }</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21392)) {</span>
<span class="nc bnc" id="L775" title="All 8 branches missed.">            mConf.put(type, (ListenerUtil.mutListener.listen(21391) ? (id % 1) : (ListenerUtil.mutListener.listen(21390) ? (id / 1) : (ListenerUtil.mutListener.listen(21389) ? (id * 1) : (ListenerUtil.mutListener.listen(21388) ? (id - 1) : (id + 1))))));</span>
        }
<span class="nc" id="L777">        return id;</span>
    }

    /**
     * Rebuild the queue and reload data after DB modified.
     */
    public void reset() {
<span class="nc bnc" id="L784" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21393)) {</span>
<span class="nc" id="L785">            mSched.deferReset();</span>
        }
<span class="nc" id="L787">    }</span>

    public void _logRem(long[] ids, int type) {
<span class="nc bnc" id="L790" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21398)) {</span>
            {
<span class="nc" id="L792">                long _loopCounter459 = 0;</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                for (long id : ids) {</span>
<span class="nc" id="L794">                    ListenerUtil.loopListener.listen(&quot;_loopCounter459&quot;, ++_loopCounter459);</span>
<span class="nc" id="L795">                    ContentValues values = new ContentValues();</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21394)) {</span>
<span class="nc" id="L797">                        values.put(&quot;usn&quot;, usn());</span>
                    }
<span class="nc bnc" id="L799" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21395)) {</span>
<span class="nc" id="L800">                        values.put(&quot;oid&quot;, id);</span>
                    }
<span class="nc bnc" id="L802" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21396)) {</span>
<span class="nc" id="L803">                        values.put(&quot;type&quot;, type);</span>
                    }
<span class="nc bnc" id="L805" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21397)) {</span>
<span class="nc" id="L806">                        mDb.insert(&quot;graves&quot;, values);</span>
                    }
                }
            }
        }
<span class="nc" id="L811">    }</span>

    public void _logRem(java.util.Collection&lt;Long&gt; ids, @Consts.REM_TYPE int type) {
<span class="nc bnc" id="L814" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21403)) {</span>
            {
<span class="nc" id="L816">                long _loopCounter460 = 0;</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">                for (long id : ids) {</span>
<span class="nc" id="L818">                    ListenerUtil.loopListener.listen(&quot;_loopCounter460&quot;, ++_loopCounter460);</span>
<span class="nc" id="L819">                    ContentValues values = new ContentValues();</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21399)) {</span>
<span class="nc" id="L821">                        values.put(&quot;usn&quot;, usn());</span>
                    }
<span class="nc bnc" id="L823" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21400)) {</span>
<span class="nc" id="L824">                        values.put(&quot;oid&quot;, id);</span>
                    }
<span class="nc bnc" id="L826" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21401)) {</span>
<span class="nc" id="L827">                        values.put(&quot;type&quot;, type);</span>
                    }
<span class="nc bnc" id="L829" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21402)) {</span>
<span class="nc" id="L830">                        mDb.insert(&quot;graves&quot;, values);</span>
                    }
<span class="nc" id="L832">                }</span>
            }
        }
<span class="nc" id="L835">    }</span>

    public int noteCount() {
<span class="nc" id="L838">        return mDb.queryScalar(&quot;SELECT count() FROM notes&quot;);</span>
    }

    /**
     * Return a new note with the default model from the deck
     * @return The new note
     */
    public Note newNote() {
<span class="fc" id="L846">        return newNote(true);</span>
    }

    /**
     * Return a new note with the model derived from the deck or the configuration
     * @param forDeck When true it uses the model specified in the deck (mid), otherwise it uses the model specified in
     *                the configuration (curModel)
     * @return The new note
     */
    public Note newNote(boolean forDeck) {
<span class="fc" id="L856">        return newNote(getModels().current(forDeck));</span>
    }

    /**
     * Return a new note with a specific model
     * @param m The model to use for the new note
     * @return The new note
     */
    public Note newNote(Model m) {
<span class="fc" id="L865">        return new Note(this, m);</span>
    }

    /**
     * Add a note to the collection. Return number of new cards.
     */
    public int addNote(Note note) {
        // check we have card models available, then save
<span class="fc" id="L873">        ArrayList&lt;JSONObject&gt; cms = findTemplates(note);</span>
<span class="pc bpc" id="L874" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21409)) {</span>
            // Todo: upstream, we accept to add a not even if it generates no card. Should be ported to ankidroid
<span class="pc bpc" id="L876" title="16 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21408) ? (cms.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21407) ? (cms.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21406) ? (cms.size() &gt; 0) : (ListenerUtil.mutListener.listen(21405) ? (cms.size() &lt; 0) : (ListenerUtil.mutListener.listen(21404) ? (cms.size() != 0) : (cms.size() == 0))))))) {</span>
<span class="nc" id="L877">                return 0;</span>
            }
        }
<span class="pc bpc" id="L880" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21410)) {</span>
<span class="nc" id="L881">            note.flush();</span>
        }
        // deck conf governs which of these are used
<span class="nc" id="L884">        int due = nextID(&quot;pos&quot;);</span>
        // add cards
<span class="nc" id="L886">        int ncards = 0;</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21413)) {</span>
            {
<span class="nc" id="L889">                long _loopCounter461 = 0;</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">                for (JSONObject template : cms) {</span>
<span class="nc" id="L891">                    ListenerUtil.loopListener.listen(&quot;_loopCounter461&quot;, ++_loopCounter461);</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21411)) {</span>
<span class="nc" id="L893">                        _newCard(note, template, due);</span>
                    }
<span class="nc bnc" id="L895" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21412)) {</span>
<span class="nc" id="L896">                        ncards += 1;</span>
                    }
<span class="nc" id="L898">                }</span>
            }
        }
<span class="nc" id="L901">        return ncards;</span>
    }

    public void remNotes(long[] ids) {
<span class="nc" id="L905">        ArrayList&lt;Long&gt; list = mDb.queryLongList(&quot;SELECT id FROM cards WHERE nid IN &quot; + Utils.ids2str(ids));</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21414)) {</span>
<span class="nc" id="L907">            remCards(list);</span>
        }
<span class="nc" id="L909">    }</span>

    /**
     * Bulk delete notes by ID. Don't call this directly.
     */
    public void _remNotes(java.util.Collection&lt;Long&gt; ids) {
<span class="nc bnc" id="L915" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21420)) {</span>
<span class="nc bnc" id="L916" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21419) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21418) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21417) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(21416) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21415) ? (ids.size() != 0) : (ids.size() == 0))))))) {</span>
<span class="nc" id="L917">                return;</span>
            }
        }
<span class="nc" id="L920">        String strids = Utils.ids2str(ids);</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21421)) {</span>
            // more card templates
<span class="nc" id="L923">            _logRem(ids, Consts.REM_NOTE);</span>
        }
<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21422)) {</span>
<span class="nc" id="L926">            mDb.execute(&quot;DELETE FROM notes WHERE id IN &quot; + strids);</span>
        }
<span class="nc" id="L928">    }</span>

    /**
     * @param note A note
     * @return (active), non-empty templates.
     */
    public ArrayList&lt;JSONObject&gt; findTemplates(Note note) {
<span class="fc" id="L935">        Model model = note.model();</span>
<span class="fc" id="L936">        ArrayList&lt;Integer&gt; avail = Models.availOrds(model, note.getFields());</span>
<span class="fc" id="L937">        return _tmplsFromOrds(model, avail);</span>
    }

    /**
     * @param model A note type
     * @param avail Ords of cards from this note type.
     * @return One template by element i of avail, for the i-th card. For standard template, avail should contains only existing ords.
     * for cloze, avail should contains only non-negative numbers, and the i-th card is a copy of the first card, with a different ord.
     */
    private ArrayList&lt;JSONObject&gt; _tmplsFromOrds(Model model, ArrayList&lt;Integer&gt; avail) {
        JSONArray tmpls;
<span class="pc bpc" id="L948" title="1 of 2 branches missed.">        if (model.isStd()) {</span>
<span class="fc" id="L949">            tmpls = model.getJSONArray(&quot;tmpls&quot;);</span>
<span class="fc" id="L950">            ArrayList&lt;JSONObject&gt; ok = new ArrayList&lt;&gt;(avail.size());</span>
<span class="pc bpc" id="L951" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21427)) {</span>
                {
<span class="fc" id="L953">                    long _loopCounter463 = 0;</span>
<span class="fc bfc" id="L954" title="All 2 branches covered.">                    for (Integer ord : avail) {</span>
<span class="fc" id="L955">                        ListenerUtil.loopListener.listen(&quot;_loopCounter463&quot;, ++_loopCounter463);</span>
<span class="pc bpc" id="L956" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21426)) {</span>
<span class="fc" id="L957">                            ok.add(tmpls.getJSONObject(ord));</span>
                        }
<span class="fc" id="L959">                    }</span>
                }
            }
<span class="fc" id="L962">            return ok;</span>
        } else {
            // cloze - generate temporary templates from first
<span class="nc" id="L965">            JSONObject template0 = model.getJSONArray(&quot;tmpls&quot;).getJSONObject(0);</span>
<span class="nc" id="L966">            ArrayList&lt;JSONObject&gt; ok = new ArrayList&lt;&gt;(avail.size());</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21425)) {</span>
                {
<span class="nc" id="L969">                    long _loopCounter462 = 0;</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">                    for (int ord : avail) {</span>
<span class="nc" id="L971">                        ListenerUtil.loopListener.listen(&quot;_loopCounter462&quot;, ++_loopCounter462);</span>
<span class="nc" id="L972">                        JSONObject t = template0.deepClone();</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21423)) {</span>
<span class="nc" id="L974">                            t.put(&quot;ord&quot;, ord);</span>
                        }
<span class="nc bnc" id="L976" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21424)) {</span>
<span class="nc" id="L977">                            ok.add(t);</span>
                        }
<span class="nc" id="L979">                    }</span>
                }
            }
<span class="nc" id="L982">            return ok;</span>
        }
    }

    /**
     * Generate cards for non-empty templates, return ids to remove.
     */
    public ArrayList&lt;Long&gt; genCards(java.util.Collection&lt;Long&gt; nids, @NonNull Model model) {
<span class="nc" id="L990">        return genCards(Utils.collection2Array(nids), model);</span>
    }

    public &lt;T extends ProgressSender&lt;Integer&gt; &amp; CancelListener&gt; ArrayList&lt;Long&gt; genCards(java.util.Collection&lt;Long&gt; nids, @NonNull Model model, @Nullable T task) {
<span class="nc" id="L994">        return genCards(Utils.collection2Array(nids), model, task);</span>
    }

    public ArrayList&lt;Long&gt; genCards(java.util.Collection&lt;Long&gt; nids, long mid) {
<span class="nc" id="L998">        return genCards(nids, getModels().get(mid));</span>
    }

    public ArrayList&lt;Long&gt; genCards(long[] nids, @NonNull Model model) {
<span class="nc" id="L1002">        return genCards(nids, model, null);</span>
    }

    public ArrayList&lt;Long&gt; genCards(long nid, @NonNull Model model) {
<span class="nc" id="L1006">        return genCards(nid, model, null);</span>
    }

    public &lt;T extends ProgressSender&lt;Integer&gt; &amp; CancelListener&gt; ArrayList&lt;Long&gt; genCards(long nid, @NonNull Model model, @Nullable T task) {
<span class="nc" id="L1010">        return genCards(&quot;(&quot; + nid + &quot;)&quot;, model, task);</span>
    }

    /**
     * @param nids All ids of nodes of a note type
     * @param task Task to check for cancellation and update number of card processed
     * @return Cards that should be removed because they should not be generated
     */
    public &lt;T extends ProgressSender&lt;Integer&gt; &amp; CancelListener&gt; ArrayList&lt;Long&gt; genCards(long[] nids, @NonNull Model model, @Nullable T task) {
        // build map of (nid,ord) so we don't create dupes
<span class="nc" id="L1020">        String snids = Utils.ids2str(nids);</span>
<span class="nc" id="L1021">        return genCards(snids, model, task);</span>
    }

    /**
     * @param snids All ids of nodes of a note type, separated by comma
     * @param model
     * @param task Task to check for cancellation and update number of card processed
     * @return Cards that should be removed because they should not be generated
     * @param &lt;T&gt;
     */
    public &lt;T extends ProgressSender&lt;Integer&gt; &amp; CancelListener&gt; ArrayList&lt;Long&gt; genCards(String snids, @NonNull Model model, @Nullable T task) {
<span class="nc" id="L1032">        int nbCount = noteCount();</span>
        // For each note, indicates ords of cards it contains
<span class="nc" id="L1034">        HashMap&lt;Long, HashMap&lt;Integer, Long&gt;&gt; have = new HashMap&lt;&gt;(nbCount);</span>
        // For each note, the deck containing all of its cards, or 0 if siblings in multiple deck
<span class="nc" id="L1036">        HashMap&lt;Long, Long&gt; dids = new HashMap&lt;&gt;(nbCount);</span>
        // For each note, an arbitrary due of one of its due card processed, if any exists
<span class="nc" id="L1038">        HashMap&lt;Long, Long&gt; dues = new HashMap&lt;&gt;(nbCount);</span>
<span class="nc" id="L1039">        List&lt;ParsedNode&gt; nodes = null;</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21429)) {</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">            if (model.getInt(&quot;type&quot;) != Consts.MODEL_CLOZE) {</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21428)) {</span>
<span class="nc" id="L1043">                    nodes = model.parsedNodes();</span>
                }
            }
        }
<span class="nc" id="L1047">        try (Cursor cur = mDb.query(&quot;select id, nid, ord, (CASE WHEN odid != 0 THEN odid ELSE did END), (CASE WHEN odid != 0 THEN odue ELSE due END), type from cards where nid in &quot; + snids)) {</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21453)) {</span>
                {
<span class="nc" id="L1050">                    long _loopCounter464 = 0;</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1052">                        ListenerUtil.loopListener.listen(&quot;_loopCounter464&quot;, ++_loopCounter464);</span>
<span class="nc bnc" id="L1053" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21431)) {</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">                            if (isCancelled(task)) {</span>
<span class="nc bnc" id="L1055" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21430)) {</span>
<span class="nc" id="L1056">                                    Timber.v(&quot;Empty card cancelled&quot;);</span>
                                }
<span class="nc" id="L1058">                                return null;</span>
                            }
                        }
                        @NonNull
<span class="nc" id="L1062">                        Long id = cur.getLong(0);</span>
                        @NonNull
<span class="nc" id="L1064">                        Long nid = cur.getLong(1);</span>
                        @NonNull
<span class="nc" id="L1066">                        Integer ord = cur.getInt(2);</span>
                        @NonNull
<span class="nc" id="L1068">                        Long did = cur.getLong(3);</span>
                        @NonNull
<span class="nc" id="L1070">                        Long due = cur.getLong(4);</span>
                        @Consts.CARD_TYPE
<span class="nc" id="L1072">                        int type = cur.getInt(5);</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21433)) {</span>
                            // existing cards
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                            if (!have.containsKey(nid)) {</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21432)) {</span>
<span class="nc" id="L1077">                                    have.put(nid, new HashMap&lt;&gt;());</span>
                                }
                            }
                        }
<span class="nc bnc" id="L1081" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21434)) {</span>
<span class="nc" id="L1082">                            have.get(nid).put(ord, id);</span>
                        }
<span class="nc bnc" id="L1084" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21444)) {</span>
                            // and their dids
<span class="nc bnc" id="L1086" title="All 2 branches missed.">                            if (dids.containsKey(nid)) {</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21443)) {</span>
<span class="nc bnc" id="L1088" title="All 50 branches missed.">                                    if ((ListenerUtil.mutListener.listen(21441) ? ((ListenerUtil.mutListener.listen(21440) ? (dids.get(nid) &gt;= 0) : (ListenerUtil.mutListener.listen(21439) ? (dids.get(nid) &lt;= 0) : (ListenerUtil.mutListener.listen(21438) ? (dids.get(nid) &gt; 0) : (ListenerUtil.mutListener.listen(21437) ? (dids.get(nid) &lt; 0) : (ListenerUtil.mutListener.listen(21436) ? (dids.get(nid) == 0) : (dids.get(nid) != 0)))))) || !Utils.equals(dids.get(nid), did)) : ((ListenerUtil.mutListener.listen(21440) ? (dids.get(nid) &gt;= 0) : (ListenerUtil.mutListener.listen(21439) ? (dids.get(nid) &lt;= 0) : (ListenerUtil.mutListener.listen(21438) ? (dids.get(nid) &gt; 0) : (ListenerUtil.mutListener.listen(21437) ? (dids.get(nid) &lt; 0) : (ListenerUtil.mutListener.listen(21436) ? (dids.get(nid) == 0) : (dids.get(nid) != 0)))))) &amp;&amp; !Utils.equals(dids.get(nid), did)))) {</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(21442)) {</span>
                                            // cards are in two or more different decks; revert to model default
<span class="nc" id="L1091">                                            dids.put(nid, 0L);</span>
                                        }
                                    }
                                }
                            } else {
<span class="nc bnc" id="L1096" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21435)) {</span>
                                    // first card or multiple cards in same deck
<span class="nc" id="L1098">                                    dids.put(nid, did);</span>
                                }
                            }
                        }
<span class="nc bnc" id="L1102" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21452)) {</span>
<span class="nc bnc" id="L1103" title="All 50 branches missed.">                            if ((ListenerUtil.mutListener.listen(21450) ? (!dues.containsKey(nid) || (ListenerUtil.mutListener.listen(21449) ? (type &gt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21448) ? (type &lt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21447) ? (type &gt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21446) ? (type &lt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21445) ? (type != Consts.CARD_TYPE_NEW) : (type == Consts.CARD_TYPE_NEW))))))) : (!dues.containsKey(nid) &amp;&amp; (ListenerUtil.mutListener.listen(21449) ? (type &gt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21448) ? (type &lt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21447) ? (type &gt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21446) ? (type &lt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21445) ? (type != Consts.CARD_TYPE_NEW) : (type == Consts.CARD_TYPE_NEW))))))))) {</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21451)) {</span>
<span class="nc" id="L1105">                                    dues.put(nid, due);</span>
                                }
                            }
                        }
<span class="nc" id="L1109">                    }</span>
                }
            }
<span class="nc bnc" id="L1112" title="All 2 branches missed.">        }</span>
        // build cards for each note
<span class="nc" id="L1114">        ArrayList&lt;Object[]&gt; data = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1115">        long ts = getTime().maxID(mDb);</span>
<span class="nc" id="L1116">        long now = getTime().intTime();</span>
<span class="nc" id="L1117">        ArrayList&lt;Long&gt; rem = new ArrayList&lt;&gt;(mDb.queryScalar(&quot;SELECT count() FROM notes where id in &quot; + snids));</span>
<span class="nc" id="L1118">        int usn = usn();</span>
<span class="nc" id="L1119">        try (Cursor cur = mDb.query(&quot;SELECT id, flds FROM notes WHERE id IN &quot; + snids)) {</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21485)) {</span>
                {
<span class="nc" id="L1122">                    long _loopCounter467 = 0;</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1124">                        ListenerUtil.loopListener.listen(&quot;_loopCounter467&quot;, ++_loopCounter467);</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21455)) {</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">                            if (isCancelled(task)) {</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21454)) {</span>
<span class="nc" id="L1128">                                    Timber.v(&quot;Empty card cancelled&quot;);</span>
                                }
<span class="nc" id="L1130">                                return null;</span>
                            }
                        }
                        @NonNull
<span class="nc" id="L1134">                        Long nid = cur.getLong(0);</span>
<span class="nc" id="L1135">                        String flds = cur.getString(1);</span>
<span class="nc" id="L1136">                        ArrayList&lt;Integer&gt; avail = Models.availOrds(model, Utils.splitFields(flds), nodes);</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21457)) {</span>
<span class="nc bnc" id="L1138" title="All 2 branches missed.">                            if (task != null) {</span>
<span class="nc bnc" id="L1139" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21456)) {</span>
<span class="nc" id="L1140">                                    task.doProgress(avail.size());</span>
                                }
                            }
                        }
<span class="nc" id="L1144">                        Long did = dids.get(nid);</span>
                        // use sibling due if there is one, else use a new id
                        @NonNull
                        Long due;
<span class="nc bnc" id="L1148" title="All 2 branches missed.">                        if (dues.containsKey(nid)) {</span>
<span class="nc" id="L1149">                            due = dues.get(nid);</span>
                        } else {
<span class="nc" id="L1151">                            due = (long) nextID(&quot;pos&quot;);</span>
                        }
<span class="nc bnc" id="L1153" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21465)) {</span>
<span class="nc bnc" id="L1154" title="All 50 branches missed.">                            if ((ListenerUtil.mutListener.listen(21463) ? (did == null &amp;&amp; (ListenerUtil.mutListener.listen(21462) ? (did &gt;= 0L) : (ListenerUtil.mutListener.listen(21461) ? (did &lt;= 0L) : (ListenerUtil.mutListener.listen(21460) ? (did &gt; 0L) : (ListenerUtil.mutListener.listen(21459) ? (did &lt; 0L) : (ListenerUtil.mutListener.listen(21458) ? (did != 0L) : (did == 0L))))))) : (did == null || (ListenerUtil.mutListener.listen(21462) ? (did &gt;= 0L) : (ListenerUtil.mutListener.listen(21461) ? (did &lt;= 0L) : (ListenerUtil.mutListener.listen(21460) ? (did &gt; 0L) : (ListenerUtil.mutListener.listen(21459) ? (did &lt; 0L) : (ListenerUtil.mutListener.listen(21458) ? (did != 0L) : (did == 0L))))))))) {</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21464)) {</span>
<span class="nc" id="L1156">                                    did = model.getLong(&quot;did&quot;);</span>
                                }
                            }
                        }
                        // add any missing cards
<span class="nc" id="L1161">                        ArrayList&lt;JSONObject&gt; tmpls = _tmplsFromOrds(model, avail);</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21480)) {</span>
                            {
<span class="nc" id="L1164">                                long _loopCounter465 = 0;</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">                                for (JSONObject t : tmpls) {</span>
<span class="nc" id="L1166">                                    ListenerUtil.loopListener.listen(&quot;_loopCounter465&quot;, ++_loopCounter465);</span>
<span class="nc" id="L1167">                                    int tord = t.getInt(&quot;ord&quot;);</span>
<span class="nc bnc" id="L1168" title="All 10 branches missed.">                                    boolean doHave = (ListenerUtil.mutListener.listen(21466) ? (have.containsKey(nid) || have.get(nid).containsKey(tord)) : (have.containsKey(nid) &amp;&amp; have.get(nid).containsKey(tord)));</span>
<span class="nc bnc" id="L1169" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(21479)) {</span>
<span class="nc bnc" id="L1170" title="All 2 branches missed.">                                        if (!doHave) {</span>
                                            // check deck is not a cram deck
                                            long ndid;
                                            try {
<span class="nc" id="L1174">                                                ndid = t.getLong(&quot;did&quot;);</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(21473)) {</span>
<span class="nc bnc" id="L1176" title="All 22 branches missed.">                                                    if ((ListenerUtil.mutListener.listen(21471) ? (ndid &gt;= 0) : (ListenerUtil.mutListener.listen(21470) ? (ndid &lt;= 0) : (ListenerUtil.mutListener.listen(21469) ? (ndid &gt; 0) : (ListenerUtil.mutListener.listen(21468) ? (ndid &lt; 0) : (ListenerUtil.mutListener.listen(21467) ? (ndid == 0) : (ndid != 0))))))) {</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(21472)) {</span>
<span class="nc" id="L1178">                                                            did = ndid;</span>
                                                        }
                                                    }
                                                }
<span class="nc" id="L1182">                                            } catch (JSONException e) {</span>
<span class="nc" id="L1183">                                            }</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(21475)) {</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">                                                if (getDecks().isDyn(did)) {</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">                                                    if (!ListenerUtil.mutListener.listen(21474)) {</span>
<span class="nc" id="L1187">                                                        did = 1L;</span>
                                                    }
                                                }
                                            }
<span class="nc bnc" id="L1191" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(21476)) {</span>
                                                // if the deck doesn't exist, use default instead
<span class="nc" id="L1193">                                                did = mDecks.get(did).getLong(&quot;id&quot;);</span>
                                            }
<span class="nc bnc" id="L1195" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(21477)) {</span>
                                                // give it a new id instead
<span class="nc" id="L1197">                                                data.add(new Object[] { ts, nid, did, tord, now, usn, due });</span>
                                            }
<span class="nc bnc" id="L1199" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(21478)) {</span>
<span class="nc" id="L1200">                                                ts += 1;</span>
                                            }
                                        }
                                    }
<span class="nc" id="L1204">                                }</span>
                            }
                        }
<span class="nc bnc" id="L1207" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21484)) {</span>
                            // note any cards that need removing
<span class="nc bnc" id="L1209" title="All 2 branches missed.">                            if (have.containsKey(nid)) {</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21483)) {</span>
                                    {
<span class="nc" id="L1212">                                        long _loopCounter466 = 0;</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">                                        for (Map.Entry&lt;Integer, Long&gt; n : have.get(nid).entrySet()) {</span>
<span class="nc" id="L1214">                                            ListenerUtil.loopListener.listen(&quot;_loopCounter466&quot;, ++_loopCounter466);</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(21482)) {</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                                                if (!avail.contains(n.getKey())) {</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">                                                    if (!ListenerUtil.mutListener.listen(21481)) {</span>
<span class="nc" id="L1218">                                                        rem.add(n.getValue());</span>
                                                    }
                                                }
                                            }
<span class="nc" id="L1222">                                        }</span>
                                    }
                                }
                            }
                        }
<span class="nc" id="L1227">                    }</span>
                }
            }
<span class="nc bnc" id="L1230" title="All 2 branches missed.">        }</span>
<span class="nc bnc" id="L1231" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21486)) {</span>
            // bulk update
<span class="nc" id="L1233">            mDb.executeMany(&quot;INSERT INTO cards VALUES (?,?,?,?,?,?,0,0,?,0,0,0,0,0,0,0,0,\&quot;\&quot;)&quot;, data);</span>
        }
<span class="nc" id="L1235">        return rem;</span>
    }

    /**
     * Create a new card.
     */
    private Card _newCard(Note note, JSONObject template, int due) {
<span class="nc" id="L1242">        boolean flush = true;</span>
<span class="nc" id="L1243">        return _newCard(note, template, due, flush);</span>
    }

    private Card _newCard(Note note, JSONObject template, int due, long did) {
<span class="nc" id="L1247">        boolean flush = true;</span>
<span class="nc" id="L1248">        return _newCard(note, template, due, did, flush);</span>
    }

    private Card _newCard(Note note, JSONObject template, int due, boolean flush) {
<span class="nc" id="L1252">        long did = 0L;</span>
<span class="nc" id="L1253">        return _newCard(note, template, due, did, flush);</span>
    }

    private Card _newCard(Note note, JSONObject template, int due, long parameterDid, boolean flush) {
<span class="nc" id="L1257">        Card card = new Card(this);</span>
<span class="nc" id="L1258">        return getNewLinkedCard(card, note, template, due, parameterDid, flush);</span>
    }

    // TODO: use an interface that we implement for card viewing, vs subclassing an active model to workaround libAnki
    public Card getNewLinkedCard(Card card, Note note, JSONObject template, int due, long parameterDid, boolean flush) {
<span class="nc" id="L1263">        long nid = note.getId();</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21487)) {</span>
<span class="nc" id="L1265">            card.setNid(nid);</span>
        }
<span class="nc" id="L1267">        int ord = template.getInt(&quot;ord&quot;);</span>
<span class="nc bnc" id="L1268" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21488)) {</span>
<span class="nc" id="L1269">            card.setOrd(ord);</span>
        }
<span class="nc" id="L1271">        long did = mDb.queryLongScalar(&quot;select did from cards where nid = ? and ord = ?&quot;, nid, ord);</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21509)) {</span>
            // Use template did (deck override) if valid, otherwise did in argument, otherwise model did
<span class="nc bnc" id="L1274" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21493) ? (did &gt;= 0) : (ListenerUtil.mutListener.listen(21492) ? (did &lt;= 0) : (ListenerUtil.mutListener.listen(21491) ? (did &gt; 0) : (ListenerUtil.mutListener.listen(21490) ? (did &lt; 0) : (ListenerUtil.mutListener.listen(21489) ? (did != 0) : (did == 0))))))) {</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21494)) {</span>
<span class="nc" id="L1276">                    did = template.optLong(&quot;did&quot;, 0);</span>
                }
<span class="nc bnc" id="L1278" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21508)) {</span>
<span class="nc bnc" id="L1279" title="All 50 branches missed.">                    if ((ListenerUtil.mutListener.listen(21500) ? ((ListenerUtil.mutListener.listen(21499) ? (did &gt;= 0) : (ListenerUtil.mutListener.listen(21498) ? (did &lt;= 0) : (ListenerUtil.mutListener.listen(21497) ? (did &lt; 0) : (ListenerUtil.mutListener.listen(21496) ? (did != 0) : (ListenerUtil.mutListener.listen(21495) ? (did == 0) : (did &gt; 0)))))) || mDecks.getDecks().containsKey(did)) : ((ListenerUtil.mutListener.listen(21499) ? (did &gt;= 0) : (ListenerUtil.mutListener.listen(21498) ? (did &lt;= 0) : (ListenerUtil.mutListener.listen(21497) ? (did &lt; 0) : (ListenerUtil.mutListener.listen(21496) ? (did != 0) : (ListenerUtil.mutListener.listen(21495) ? (did == 0) : (did &gt; 0)))))) &amp;&amp; mDecks.getDecks().containsKey(did)))) {</span>
<span class="nc bnc" id="L1280" title="All 22 branches missed.">                    } else if ((ListenerUtil.mutListener.listen(21505) ? (parameterDid &gt;= 0) : (ListenerUtil.mutListener.listen(21504) ? (parameterDid &lt;= 0) : (ListenerUtil.mutListener.listen(21503) ? (parameterDid &gt; 0) : (ListenerUtil.mutListener.listen(21502) ? (parameterDid &lt; 0) : (ListenerUtil.mutListener.listen(21501) ? (parameterDid == 0) : (parameterDid != 0))))))) {</span>
<span class="nc bnc" id="L1281" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21507)) {</span>
<span class="nc" id="L1282">                            did = parameterDid;</span>
                        }
                    } else {
<span class="nc bnc" id="L1285" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21506)) {</span>
<span class="nc" id="L1286">                            did = note.model().optLong(&quot;did&quot;, 0);</span>
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L1292" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21510)) {</span>
<span class="nc" id="L1293">            card.setDid(did);</span>
        }
        // if invalid did, use default instead
<span class="nc" id="L1296">        Deck deck = mDecks.get(card.getDid());</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21513)) {</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">            if (deck.getInt(&quot;dyn&quot;) == DECK_DYN) {</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21512)) {</span>
                    // must not be a filtered deck
<span class="nc" id="L1301">                    card.setDid(1);</span>
                }
            } else {
<span class="nc bnc" id="L1304" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21511)) {</span>
<span class="nc" id="L1305">                    card.setDid(deck.getLong(&quot;id&quot;));</span>
                }
            }
        }
<span class="nc bnc" id="L1309" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21514)) {</span>
<span class="nc" id="L1310">            card.setDue(_dueForDid(card.getDid(), due));</span>
        }
<span class="nc bnc" id="L1312" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21516)) {</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">            if (flush) {</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21515)) {</span>
<span class="nc" id="L1315">                    card.flush();</span>
                }
            }
        }
<span class="nc" id="L1319">        return card;</span>
    }

    public int _dueForDid(long did, int due) {
<span class="nc" id="L1323">        DeckConfig conf = mDecks.confForDid(did);</span>
        // in order due?
<span class="nc bnc" id="L1325" title="All 2 branches missed.">        if (conf.getJSONObject(&quot;new&quot;).getInt(&quot;order&quot;) == Consts.NEW_CARDS_DUE) {</span>
<span class="nc" id="L1326">            return due;</span>
        } else {
            // the same random number
<span class="nc" id="L1329">            Random r = new Random();</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21517)) {</span>
<span class="nc" id="L1331">                r.setSeed(due);</span>
            }
<span class="nc bnc" id="L1333" title="All 48 branches missed.">            return (ListenerUtil.mutListener.listen(21525) ? (r.nextInt((ListenerUtil.mutListener.listen(21521) ? (Math.max(due, 1000) % 1) : (ListenerUtil.mutListener.listen(21520) ? (Math.max(due, 1000) / 1) : (ListenerUtil.mutListener.listen(21519) ? (Math.max(due, 1000) * 1) : (ListenerUtil.mutListener.listen(21518) ? (Math.max(due, 1000) + 1) : (Math.max(due, 1000) - 1)))))) % 1) : (ListenerUtil.mutListener.listen(21524) ? (r.nextInt((ListenerUtil.mutListener.listen(21521) ? (Math.max(due, 1000) % 1) : (ListenerUtil.mutListener.listen(21520) ? (Math.max(due, 1000) / 1) : (ListenerUtil.mutListener.listen(21519) ? (Math.max(due, 1000) * 1) : (ListenerUtil.mutListener.listen(21518) ? (Math.max(due, 1000) + 1) : (Math.max(due, 1000) - 1)))))) / 1) : (ListenerUtil.mutListener.listen(21523) ? (r.nextInt((ListenerUtil.mutListener.listen(21521) ? (Math.max(due, 1000) % 1) : (ListenerUtil.mutListener.listen(21520) ? (Math.max(due, 1000) / 1) : (ListenerUtil.mutListener.listen(21519) ? (Math.max(due, 1000) * 1) : (ListenerUtil.mutListener.listen(21518) ? (Math.max(due, 1000) + 1) : (Math.max(due, 1000) - 1)))))) * 1) : (ListenerUtil.mutListener.listen(21522) ? (r.nextInt((ListenerUtil.mutListener.listen(21521) ? (Math.max(due, 1000) % 1) : (ListenerUtil.mutListener.listen(21520) ? (Math.max(due, 1000) / 1) : (ListenerUtil.mutListener.listen(21519) ? (Math.max(due, 1000) * 1) : (ListenerUtil.mutListener.listen(21518) ? (Math.max(due, 1000) + 1) : (Math.max(due, 1000) - 1)))))) - 1) : (r.nextInt((ListenerUtil.mutListener.listen(21521) ? (Math.max(due, 1000) % 1) : (ListenerUtil.mutListener.listen(21520) ? (Math.max(due, 1000) / 1) : (ListenerUtil.mutListener.listen(21519) ? (Math.max(due, 1000) * 1) : (ListenerUtil.mutListener.listen(21518) ? (Math.max(due, 1000) + 1) : (Math.max(due, 1000) - 1)))))) + 1)))));</span>
        }
    }

    public boolean isEmpty() {
<span class="nc bnc" id="L1338" title="All 2 branches missed.">        return mDb.queryScalar(&quot;SELECT 1 FROM cards LIMIT 1&quot;) == 0;</span>
    }

    public int cardCount() {
<span class="nc" id="L1342">        return mDb.queryScalar(&quot;SELECT count() FROM cards&quot;);</span>
    }

    // NOT IN LIBANKI //
    public int cardCount(Long... dids) {
<span class="nc" id="L1347">        return mDb.queryScalar(&quot;SELECT count() FROM cards WHERE did IN &quot; + Utils.ids2str(dids));</span>
    }

    public boolean isEmptyDeck(Long... dids) {
<span class="nc bnc" id="L1351" title="All 22 branches missed.">        return (ListenerUtil.mutListener.listen(21530) ? (cardCount(dids) &gt;= 0) : (ListenerUtil.mutListener.listen(21529) ? (cardCount(dids) &lt;= 0) : (ListenerUtil.mutListener.listen(21528) ? (cardCount(dids) &gt; 0) : (ListenerUtil.mutListener.listen(21527) ? (cardCount(dids) &lt; 0) : (ListenerUtil.mutListener.listen(21526) ? (cardCount(dids) != 0) : (cardCount(dids) == 0))))));</span>
    }

    /**
     * Bulk delete cards by ID.
     */
    public void remCards(List&lt;Long&gt; ids) {
<span class="nc bnc" id="L1358" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21531)) {</span>
<span class="nc" id="L1359">            remCards(ids, true);</span>
        }
<span class="nc" id="L1361">    }</span>

    public void remCards(java.util.Collection&lt;Long&gt; ids, boolean notes) {
<span class="nc bnc" id="L1364" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21537)) {</span>
<span class="nc bnc" id="L1365" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21536) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21535) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21534) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(21533) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21532) ? (ids.size() != 0) : (ids.size() == 0))))))) {</span>
<span class="nc" id="L1366">                return;</span>
            }
        }
<span class="nc" id="L1369">        String sids = Utils.ids2str(ids);</span>
<span class="nc" id="L1370">        List&lt;Long&gt; nids = mDb.queryLongList(&quot;SELECT nid FROM cards WHERE id IN &quot; + sids);</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21538)) {</span>
            // remove cards
<span class="nc" id="L1373">            _logRem(ids, Consts.REM_CARD);</span>
        }
<span class="nc bnc" id="L1375" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21539)) {</span>
<span class="nc" id="L1376">            mDb.execute(&quot;DELETE FROM cards WHERE id IN &quot; + sids);</span>
        }
<span class="nc bnc" id="L1378" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21540)) {</span>
            // then notes
<span class="nc bnc" id="L1380" title="All 2 branches missed.">            if (!notes) {</span>
<span class="nc" id="L1381">                return;</span>
            }
        }
<span class="nc bnc" id="L1384" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21541)) {</span>
<span class="nc" id="L1385">            nids = mDb.queryLongList(&quot;SELECT id FROM notes WHERE id IN &quot; + Utils.ids2str(nids) + &quot; AND id NOT IN (SELECT nid FROM cards)&quot;);</span>
        }
<span class="nc bnc" id="L1387" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21542)) {</span>
<span class="nc" id="L1388">            _remNotes(nids);</span>
        }
<span class="nc" id="L1390">    }</span>

    public &lt;T extends ProgressSender&lt;Integer&gt; &amp; CancelListener&gt; List&lt;Long&gt; emptyCids(@Nullable T task) {
<span class="nc" id="L1393">        List&lt;Long&gt; rem = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1394" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21544)) {</span>
            {
<span class="nc" id="L1396">                long _loopCounter468 = 0;</span>
<span class="nc bnc" id="L1397" title="All 2 branches missed.">                for (Model m : getModels().all()) {</span>
<span class="nc" id="L1398">                    ListenerUtil.loopListener.listen(&quot;_loopCounter468&quot;, ++_loopCounter468);</span>
<span class="nc bnc" id="L1399" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21543)) {</span>
<span class="nc" id="L1400">                        rem.addAll(genCards(getModels().nids(m), m, task));</span>
                    }
<span class="nc" id="L1402">                }</span>
            }
        }
<span class="nc" id="L1405">        return rem;</span>
    }

    public String emptyCardReport(List&lt;Long&gt; cids) {
<span class="nc" id="L1409">        StringBuilder rep = new StringBuilder();</span>
<span class="nc" id="L1410">        try (Cursor cur = mDb.query(&quot;select group_concat(ord+1), count(), flds from cards c, notes n &quot; + &quot;where c.nid = n.id and c.id in &quot; + Utils.ids2str(cids) + &quot; group by nid&quot;)) {</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21546)) {</span>
                {
<span class="nc" id="L1413">                    long _loopCounter469 = 0;</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1415">                        ListenerUtil.loopListener.listen(&quot;_loopCounter469&quot;, ++_loopCounter469);</span>
<span class="nc" id="L1416">                        String ords = cur.getString(0);</span>
                        // int cnt = cur.getInt(1);  // present but unused upstream as well
<span class="nc" id="L1418">                        String flds = cur.getString(2);</span>
<span class="nc bnc" id="L1419" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21545)) {</span>
<span class="nc" id="L1420">                            rep.append(String.format(&quot;Empty card numbers: %s\nFields: %s\n\n&quot;, ords, flds.replace(&quot;\u001F&quot;, &quot; / &quot;)));</span>
                        }
<span class="nc" id="L1422">                    }</span>
                }
            }
        }
<span class="nc" id="L1426">        return rep.toString();</span>
    }

    private ArrayList&lt;Object[]&gt; _fieldData(String snids) {
<span class="nc" id="L1430">        ArrayList&lt;Object[]&gt; result = new ArrayList&lt;&gt;(mDb.queryScalar(&quot;SELECT count() FROM notes WHERE id IN&quot; + snids));</span>
<span class="nc" id="L1431">        try (Cursor cur = mDb.query(&quot;SELECT id, mid, flds FROM notes WHERE id IN &quot; + snids)) {</span>
<span class="nc bnc" id="L1432" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21548)) {</span>
                {
<span class="nc" id="L1434">                    long _loopCounter470 = 0;</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1436">                        ListenerUtil.loopListener.listen(&quot;_loopCounter470&quot;, ++_loopCounter470);</span>
<span class="nc bnc" id="L1437" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21547)) {</span>
<span class="nc" id="L1438">                            result.add(new Object[] { cur.getLong(0), cur.getLong(1), cur.getString(2) });</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L1444">        return result;</span>
    }

    /**
     * Update field checksums and sort cache, after find&amp;replace, etc.
     * @param nids
     */
    public void updateFieldCache(java.util.Collection&lt;Long&gt; nids) {
<span class="nc" id="L1452">        String snids = Utils.ids2str(nids);</span>
<span class="nc bnc" id="L1453" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21549)) {</span>
<span class="nc" id="L1454">            updateFieldCache(snids);</span>
        }
<span class="nc" id="L1456">    }</span>

    /**
     * Update field checksums and sort cache, after find&amp;replace, etc.
     * @param nids
     */
    public void updateFieldCache(long[] nids) {
<span class="nc" id="L1463">        String snids = Utils.ids2str(nids);</span>
<span class="nc bnc" id="L1464" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21550)) {</span>
<span class="nc" id="L1465">            updateFieldCache(snids);</span>
        }
<span class="nc" id="L1467">    }</span>

    /**
     * Update field checksums and sort cache, after find&amp;replace, etc.
     * @param snids comma separated nids
     */
    public void updateFieldCache(String snids) {
<span class="nc" id="L1474">        ArrayList&lt;Object[]&gt; data = _fieldData(snids);</span>
<span class="nc" id="L1475">        ArrayList&lt;Object[]&gt; r = new ArrayList&lt;&gt;(data.size());</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21553)) {</span>
            {
<span class="nc" id="L1478">                long _loopCounter471 = 0;</span>
<span class="nc bnc" id="L1479" title="All 2 branches missed.">                for (Object[] o : data) {</span>
<span class="nc" id="L1480">                    ListenerUtil.loopListener.listen(&quot;_loopCounter471&quot;, ++_loopCounter471);</span>
<span class="nc" id="L1481">                    String[] fields = Utils.splitFields((String) o[2]);</span>
<span class="nc" id="L1482">                    Model model = getModels().get((Long) o[1]);</span>
<span class="nc bnc" id="L1483" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21551)) {</span>
<span class="nc bnc" id="L1484" title="All 2 branches missed.">                        if (model == null) {</span>
                            // note point to invalid model
<span class="nc" id="L1486">                            continue;</span>
                        }
                    }
<span class="nc" id="L1489">                    Pair&lt;String, Long&gt; csumAndStrippedFieldField = Utils.sfieldAndCsum(fields, getModels().sortIdx(model));</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21552)) {</span>
<span class="nc" id="L1491">                        r.add(new Object[] { csumAndStrippedFieldField.first, csumAndStrippedFieldField.second, o[0] });</span>
                    }
<span class="nc" id="L1493">                }</span>
            }
        }
<span class="nc bnc" id="L1496" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21554)) {</span>
            // apply, relying on calling code to bump usn+mod
<span class="nc" id="L1498">            mDb.executeMany(&quot;UPDATE notes SET sfld=?, csum=? WHERE id=?&quot;, r);</span>
        }
<span class="nc" id="L1500">    }</span>

    /**
     * Returns hash of id, question, answer.
     */
    public HashMap&lt;String, String&gt; _renderQA(long cid, Model model, long did, int ord, String tags, String[] flist, int flags) {
<span class="nc" id="L1506">        return _renderQA(cid, model, did, ord, tags, flist, flags, false, null, null);</span>
    }

    public HashMap&lt;String, String&gt; _renderQA(long cid, Model model, long did, int ord, String tags, String[] flist, int flags, boolean browser, String qfmt, String afmt) {
        // unpack fields and create dict
<span class="nc" id="L1511">        Map&lt;String, Pair&lt;Integer, JSONObject&gt;&gt; fmap = Models.fieldMap(model);</span>
<span class="nc" id="L1512">        Set&lt;Map.Entry&lt;String, Pair&lt;Integer, JSONObject&gt;&gt;&gt; maps = fmap.entrySet();</span>
<span class="nc" id="L1513">        Map&lt;String, String&gt; fields = new HashMap&lt;&gt;(maps.size() + 8);</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21556)) {</span>
            {
<span class="nc" id="L1516">                long _loopCounter472 = 0;</span>
<span class="nc bnc" id="L1517" title="All 2 branches missed.">                for (Map.Entry&lt;String, Pair&lt;Integer, JSONObject&gt;&gt; entry : maps) {</span>
<span class="nc" id="L1518">                    ListenerUtil.loopListener.listen(&quot;_loopCounter472&quot;, ++_loopCounter472);</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21555)) {</span>
<span class="nc" id="L1520">                        fields.put(entry.getKey(), flist[entry.getValue().first]);</span>
                    }
<span class="nc" id="L1522">                }</span>
            }
        }
<span class="nc bnc" id="L1525" title="All 8 branches missed.">        int cardNum = (ListenerUtil.mutListener.listen(21560) ? (ord % 1) : (ListenerUtil.mutListener.listen(21559) ? (ord / 1) : (ListenerUtil.mutListener.listen(21558) ? (ord * 1) : (ListenerUtil.mutListener.listen(21557) ? (ord - 1) : (ord + 1)))));</span>
<span class="nc bnc" id="L1526" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21561)) {</span>
<span class="nc" id="L1527">            fields.put(&quot;Tags&quot;, tags.trim());</span>
        }
<span class="nc bnc" id="L1529" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21562)) {</span>
<span class="nc" id="L1530">            fields.put(&quot;Type&quot;, model.getString(&quot;name&quot;));</span>
        }
<span class="nc bnc" id="L1532" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21563)) {</span>
<span class="nc" id="L1533">            fields.put(&quot;Deck&quot;, mDecks.name(did));</span>
        }
<span class="nc" id="L1535">        String baseName = Decks.basename(fields.get(&quot;Deck&quot;));</span>
<span class="nc bnc" id="L1536" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21564)) {</span>
<span class="nc" id="L1537">            fields.put(&quot;Subdeck&quot;, baseName);</span>
        }
<span class="nc bnc" id="L1539" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21565)) {</span>
<span class="nc" id="L1540">            fields.put(&quot;CardFlag&quot;, _flagNameFromCardFlags(flags));</span>
        }
        JSONObject template;
<span class="nc bnc" id="L1543" title="All 2 branches missed.">        if (model.isStd()) {</span>
<span class="nc" id="L1544">            template = model.getJSONArray(&quot;tmpls&quot;).getJSONObject(ord);</span>
        } else {
<span class="nc" id="L1546">            template = model.getJSONArray(&quot;tmpls&quot;).getJSONObject(0);</span>
        }
<span class="nc bnc" id="L1548" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21566)) {</span>
<span class="nc" id="L1549">            fields.put(&quot;Card&quot;, template.getString(&quot;name&quot;));</span>
        }
<span class="nc bnc" id="L1551" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21567)) {</span>
<span class="nc" id="L1552">            fields.put(String.format(Locale.US, &quot;c%d&quot;, cardNum), &quot;1&quot;);</span>
        }
        // render q &amp; a
<span class="nc" id="L1555">        HashMap&lt;String, String&gt; d = new HashMap&lt;&gt;(2);</span>
<span class="nc bnc" id="L1556" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21568)) {</span>
<span class="nc" id="L1557">            d.put(&quot;id&quot;, Long.toString(cid));</span>
        }
<span class="nc bnc" id="L1559" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21569)) {</span>
<span class="nc bnc" id="L1560" title="All 2 branches missed.">            qfmt = TextUtils.isEmpty(qfmt) ? template.getString(&quot;qfmt&quot;) : qfmt;</span>
        }
<span class="nc bnc" id="L1562" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21570)) {</span>
<span class="nc bnc" id="L1563" title="All 2 branches missed.">            afmt = TextUtils.isEmpty(afmt) ? template.getString(&quot;afmt&quot;) : afmt;</span>
        }
<span class="nc bnc" id="L1565" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21587)) {</span>
            {
<span class="nc" id="L1567">                long _loopCounter473 = 0;</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">                for (Pair&lt;String, String&gt; p : new Pair[] { new Pair&lt;&gt;(&quot;q&quot;, qfmt), new Pair&lt;&gt;(&quot;a&quot;, afmt) }) {</span>
<span class="nc" id="L1569">                    ListenerUtil.loopListener.listen(&quot;_loopCounter473&quot;, ++_loopCounter473);</span>
<span class="nc" id="L1570">                    String type = p.first;</span>
<span class="nc" id="L1571">                    String format = p.second;</span>
<span class="nc bnc" id="L1572" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21576)) {</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">                        if (&quot;q&quot;.equals(type)) {</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21574)) {</span>
<span class="nc" id="L1575">                                format = fClozePatternQ.matcher(format).replaceAll(String.format(Locale.US, &quot;{{$1cq-%d:&quot;, cardNum));</span>
                            }
<span class="nc bnc" id="L1577" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21575)) {</span>
<span class="nc" id="L1578">                                format = fClozeTagStart.matcher(format).replaceAll(String.format(Locale.US, &quot;&lt;%%cq:%d:&quot;, cardNum));</span>
                            }
                        } else {
<span class="nc bnc" id="L1581" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21571)) {</span>
<span class="nc" id="L1582">                                format = fClozePatternA.matcher(format).replaceAll(String.format(Locale.US, &quot;{{$1ca-%d:&quot;, cardNum));</span>
                            }
<span class="nc bnc" id="L1584" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21572)) {</span>
<span class="nc" id="L1585">                                format = fClozeTagStart.matcher(format).replaceAll(String.format(Locale.US, &quot;&lt;%%ca:%d:&quot;, cardNum));</span>
                            }
<span class="nc bnc" id="L1587" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21573)) {</span>
                                // fields.put(&quot;FrontSide&quot;, mMedia.stripAudio(d.get(&quot;q&quot;)));
<span class="nc" id="L1589">                                fields.put(&quot;FrontSide&quot;, d.get(&quot;q&quot;));</span>
                            }
                        }
                    }
                    String html;
                    try {
<span class="nc" id="L1595">                        html = ParsedNode.parse_inner(format).render(fields, &quot;q&quot;.equals(type), getContext());</span>
<span class="nc" id="L1596">                    } catch (TemplateError er) {</span>
<span class="nc" id="L1597">                        html = er.message(getContext());</span>
<span class="nc" id="L1598">                    }</span>
<span class="nc" id="L1599">                    html = ChessFilter.fenToChessboard(html, getContext());</span>
<span class="nc bnc" id="L1600" title="All 2 branches missed.">                    if (!browser) {</span>
                        // browser don't show image. So compiling LaTeX actually remove information.
<span class="nc" id="L1602">                        html = LaTeX.mungeQA(html, this, model);</span>
                    }
<span class="nc bnc" id="L1604" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21577)) {</span>
<span class="nc" id="L1605">                        d.put(type, html);</span>
                    }
<span class="nc bnc" id="L1607" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21586)) {</span>
                        // empty cloze?
<span class="nc bnc" id="L1609" title="All 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(21578) ? (&quot;q&quot;.equals(type) || model.isCloze()) : (&quot;q&quot;.equals(type) &amp;&amp; model.isCloze()))) {</span>
<span class="nc bnc" id="L1610" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21585)) {</span>
<span class="nc bnc" id="L1611" title="All 22 branches missed.">                                if ((ListenerUtil.mutListener.listen(21583) ? (Models._availClozeOrds(model, flist, false).size() &gt;= 0) : (ListenerUtil.mutListener.listen(21582) ? (Models._availClozeOrds(model, flist, false).size() &lt;= 0) : (ListenerUtil.mutListener.listen(21581) ? (Models._availClozeOrds(model, flist, false).size() &gt; 0) : (ListenerUtil.mutListener.listen(21580) ? (Models._availClozeOrds(model, flist, false).size() &lt; 0) : (ListenerUtil.mutListener.listen(21579) ? (Models._availClozeOrds(model, flist, false).size() != 0) : (Models._availClozeOrds(model, flist, false).size() == 0))))))) {</span>
<span class="nc" id="L1612">                                    String link = String.format(&quot;&lt;a href=%s#cloze&gt;%s&lt;/a&gt;&quot;, Consts.HELP_SITE, &quot;help&quot;);</span>
<span class="nc bnc" id="L1613" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(21584)) {</span>
<span class="nc" id="L1614">                                        d.put(&quot;q&quot;, mContext.getString(R.string.empty_cloze_warning, link));</span>
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L1623">        return d;</span>
    }

    /**
     * Return [cid, nid, mid, did, ord, tags, flds, flags] db query
     */
    public ArrayList&lt;Object[]&gt; _qaData() {
<span class="nc" id="L1630">        return _qaData(&quot;&quot;);</span>
    }

    public ArrayList&lt;Object[]&gt; _qaData(String where) {
<span class="nc" id="L1634">        ArrayList&lt;Object[]&gt; data = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1635">        try (Cursor cur = mDb.query(&quot;SELECT c.id, n.id, n.mid, c.did, c.ord, &quot; + &quot;n.tags, n.flds, c.flags FROM cards c, notes n WHERE c.nid == n.id &quot; + where)) {</span>
<span class="nc bnc" id="L1636" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21589)) {</span>
                {
<span class="nc" id="L1638">                    long _loopCounter474 = 0;</span>
<span class="nc bnc" id="L1639" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1640">                        ListenerUtil.loopListener.listen(&quot;_loopCounter474&quot;, ++_loopCounter474);</span>
<span class="nc bnc" id="L1641" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21588)) {</span>
<span class="nc" id="L1642">                            data.add(new Object[] { cur.getLong(0), cur.getLong(1), getModels().get(cur.getLong(2)), cur.getLong(3), cur.getInt(4), cur.getString(5), cur.getString(6), cur.getInt(7) });</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L1648">        return data;</span>
    }

    public String _flagNameFromCardFlags(int flags) {
<span class="nc" id="L1652">        int flag = flags &amp; 0b111;</span>
<span class="nc bnc" id="L1653" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21595)) {</span>
<span class="nc bnc" id="L1654" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21594) ? (flag &gt;= 0) : (ListenerUtil.mutListener.listen(21593) ? (flag &lt;= 0) : (ListenerUtil.mutListener.listen(21592) ? (flag &gt; 0) : (ListenerUtil.mutListener.listen(21591) ? (flag &lt; 0) : (ListenerUtil.mutListener.listen(21590) ? (flag != 0) : (flag == 0))))))) {</span>
<span class="nc" id="L1655">                return &quot;&quot;;</span>
            }
        }
<span class="nc" id="L1658">        return &quot;flag&quot; + flag;</span>
    }

    /**
     * Return a list of card ids
     */
    public List&lt;Long&gt; findCards(String search) {
<span class="nc" id="L1665">        return new Finder(this).findCards(search, null);</span>
    }

    /**
     * Return a list of card ids
     */
    public List&lt;Long&gt; findCards(String search, String order) {
<span class="nc" id="L1672">        return new Finder(this).findCards(search, order);</span>
    }

    public List&lt;Long&gt; findCards(String search, boolean order) {
<span class="nc" id="L1676">        return findCards(search, order, null);</span>
    }

    public List&lt;Long&gt; findCards(String search, boolean order, CollectionTask.PartialSearch task) {
<span class="nc" id="L1680">        return new Finder(this).findCards(search, order, task);</span>
    }

    /**
     * Return a list of note ids
     */
    public List&lt;Long&gt; findNotes(String query) {
<span class="nc" id="L1687">        return new Finder(this).findNotes(query);</span>
    }

    public int findReplace(List&lt;Long&gt; nids, String src, String dst) {
<span class="nc" id="L1691">        return Finder.findReplace(this, nids, src, dst);</span>
    }

    public int findReplace(List&lt;Long&gt; nids, String src, String dst, boolean regex) {
<span class="nc" id="L1695">        return Finder.findReplace(this, nids, src, dst, regex);</span>
    }

    public int findReplace(List&lt;Long&gt; nids, String src, String dst, String field) {
<span class="nc" id="L1699">        return Finder.findReplace(this, nids, src, dst, field);</span>
    }

    public int findReplace(List&lt;Long&gt; nids, String src, String dst, boolean regex, String field, boolean fold) {
<span class="nc" id="L1703">        return Finder.findReplace(this, nids, src, dst, regex, field, fold);</span>
    }

    public List&lt;Pair&lt;String, List&lt;Long&gt;&gt;&gt; findDupes(String fieldName) {
<span class="nc" id="L1707">        return Finder.findDupes(this, fieldName, &quot;&quot;);</span>
    }

    public List&lt;Pair&lt;String, List&lt;Long&gt;&gt;&gt; findDupes(String fieldName, String search) {
<span class="nc" id="L1711">        return Finder.findDupes(this, fieldName, search);</span>
    }

    public void setTimeLimit(long seconds) {
<span class="nc bnc" id="L1715" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21596)) {</span>
<span class="nc" id="L1716">            mConf.put(&quot;timeLim&quot;, seconds);</span>
        }
<span class="nc" id="L1718">    }</span>

    public long getTimeLimit() {
<span class="nc" id="L1721">        return mConf.getLong(&quot;timeLim&quot;);</span>
    }

    public void startTimebox() {
<span class="nc bnc" id="L1725" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21597)) {</span>
<span class="nc" id="L1726">            mStartTime = getTime().intTime();</span>
        }
<span class="nc bnc" id="L1728" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21598)) {</span>
<span class="nc" id="L1729">            mStartReps = mSched.getReps();</span>
        }
<span class="nc" id="L1731">    }</span>

    /* Return (elapsedTime, reps) if timebox reached, or null. */
    public Pair&lt;Integer, Integer&gt; timeboxReached() {
<span class="nc bnc" id="L1735" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21604)) {</span>
<span class="nc bnc" id="L1736" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21603) ? (mConf.getLong(&quot;timeLim&quot;) &gt;= 0) : (ListenerUtil.mutListener.listen(21602) ? (mConf.getLong(&quot;timeLim&quot;) &lt;= 0) : (ListenerUtil.mutListener.listen(21601) ? (mConf.getLong(&quot;timeLim&quot;) &gt; 0) : (ListenerUtil.mutListener.listen(21600) ? (mConf.getLong(&quot;timeLim&quot;) &lt; 0) : (ListenerUtil.mutListener.listen(21599) ? (mConf.getLong(&quot;timeLim&quot;) != 0) : (mConf.getLong(&quot;timeLim&quot;) == 0))))))) {</span>
                // timeboxing disabled
<span class="nc" id="L1738">                return null;</span>
            }
        }
<span class="nc bnc" id="L1741" title="All 8 branches missed.">        long elapsed = (ListenerUtil.mutListener.listen(21608) ? (getTime().intTime() % mStartTime) : (ListenerUtil.mutListener.listen(21607) ? (getTime().intTime() / mStartTime) : (ListenerUtil.mutListener.listen(21606) ? (getTime().intTime() * mStartTime) : (ListenerUtil.mutListener.listen(21605) ? (getTime().intTime() + mStartTime) : (getTime().intTime() - mStartTime)))));</span>
<span class="nc bnc" id="L1742" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21618)) {</span>
<span class="nc bnc" id="L1743" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21613) ? (elapsed &gt;= mConf.getLong(&quot;timeLim&quot;)) : (ListenerUtil.mutListener.listen(21612) ? (elapsed &lt;= mConf.getLong(&quot;timeLim&quot;)) : (ListenerUtil.mutListener.listen(21611) ? (elapsed &lt; mConf.getLong(&quot;timeLim&quot;)) : (ListenerUtil.mutListener.listen(21610) ? (elapsed != mConf.getLong(&quot;timeLim&quot;)) : (ListenerUtil.mutListener.listen(21609) ? (elapsed == mConf.getLong(&quot;timeLim&quot;)) : (elapsed &gt; mConf.getLong(&quot;timeLim&quot;)))))))) {</span>
<span class="nc bnc" id="L1744" title="All 8 branches missed.">                return new Pair&lt;&gt;(mConf.getInt(&quot;timeLim&quot;), (ListenerUtil.mutListener.listen(21617) ? (mSched.getReps() % mStartReps) : (ListenerUtil.mutListener.listen(21616) ? (mSched.getReps() / mStartReps) : (ListenerUtil.mutListener.listen(21615) ? (mSched.getReps() * mStartReps) : (ListenerUtil.mutListener.listen(21614) ? (mSched.getReps() + mStartReps) : (mSched.getReps() - mStartReps))))));</span>
            }
        }
<span class="nc" id="L1747">        return null;</span>
    }

    /* Note from upstream:
     * this data structure is a mess, and will be updated soon
     * in the review case, [1, &quot;Review&quot;, [firstReviewedCard, secondReviewedCard, ...], wasLeech]
     * in the checkpoint case, [2, &quot;action name&quot;]
     * wasLeech should have been recorded for each card, not globally
     */
    public void clearUndo() {
<span class="pc bpc" id="L1757" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21619)) {</span>
<span class="fc" id="L1758">            mUndo = new LinkedBlockingDeque&lt;&gt;();</span>
        }
<span class="fc" id="L1760">    }</span>

    /**
     * Undo menu item name, or &quot;&quot; if undo unavailable.
     */
    @VisibleForTesting
    @Nullable
    public DismissType undoType() {
<span class="nc bnc" id="L1768" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21625)) {</span>
<span class="nc bnc" id="L1769" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21624) ? (mUndo.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21623) ? (mUndo.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21622) ? (mUndo.size() &lt; 0) : (ListenerUtil.mutListener.listen(21621) ? (mUndo.size() != 0) : (ListenerUtil.mutListener.listen(21620) ? (mUndo.size() == 0) : (mUndo.size() &gt; 0))))))) {</span>
<span class="nc" id="L1770">                return mUndo.getLast().getDismissType();</span>
            }
        }
<span class="nc" id="L1773">        return null;</span>
    }

    public String undoName(Resources res) {
<span class="nc" id="L1777">        DismissType type = undoType();</span>
<span class="nc bnc" id="L1778" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21626)) {</span>
<span class="nc bnc" id="L1779" title="All 2 branches missed.">            if (type != null) {</span>
<span class="nc" id="L1780">                return type.getString(res);</span>
            }
        }
<span class="nc" id="L1783">        return &quot;&quot;;</span>
    }

    public boolean undoAvailable() {
<span class="nc bnc" id="L1787" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21627)) {</span>
<span class="nc" id="L1788">            Timber.d(&quot;undoAvailable() undo size: %s&quot;, mUndo.size());</span>
        }
<span class="nc bnc" id="L1790" title="All 22 branches missed.">        return (ListenerUtil.mutListener.listen(21632) ? (mUndo.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21631) ? (mUndo.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21630) ? (mUndo.size() &lt; 0) : (ListenerUtil.mutListener.listen(21629) ? (mUndo.size() != 0) : (ListenerUtil.mutListener.listen(21628) ? (mUndo.size() == 0) : (mUndo.size() &gt; 0))))));</span>
    }

    @Nullable
    public Card undo() {
<span class="nc" id="L1795">        Undoable lastUndo = mUndo.removeLast();</span>
<span class="nc bnc" id="L1796" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21633)) {</span>
<span class="nc" id="L1797">            Timber.d(&quot;undo() of type %s&quot;, lastUndo.getDismissType());</span>
        }
<span class="nc" id="L1799">        return lastUndo.undo(this);</span>
    }

    public void markUndo(@NonNull Undoable undo) {
<span class="nc bnc" id="L1803" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21634)) {</span>
<span class="nc" id="L1804">            Timber.d(&quot;markUndo() of type %s&quot;, undo.getDismissType());</span>
        }
<span class="nc bnc" id="L1806" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21635)) {</span>
<span class="nc" id="L1807">            mUndo.add(undo);</span>
        }
<span class="nc bnc" id="L1809" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21642)) {</span>
            {
<span class="nc" id="L1811">                long _loopCounter475 = 0;</span>
<span class="nc bnc" id="L1812" title="All 22 branches missed.">                while ((ListenerUtil.mutListener.listen(21641) ? (mUndo.size() &gt;= UNDO_SIZE_MAX) : (ListenerUtil.mutListener.listen(21640) ? (mUndo.size() &lt;= UNDO_SIZE_MAX) : (ListenerUtil.mutListener.listen(21639) ? (mUndo.size() &lt; UNDO_SIZE_MAX) : (ListenerUtil.mutListener.listen(21638) ? (mUndo.size() != UNDO_SIZE_MAX) : (ListenerUtil.mutListener.listen(21637) ? (mUndo.size() == UNDO_SIZE_MAX) : (mUndo.size() &gt; UNDO_SIZE_MAX))))))) {</span>
<span class="nc" id="L1813">                    ListenerUtil.loopListener.listen(&quot;_loopCounter475&quot;, ++_loopCounter475);</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21636)) {</span>
<span class="nc" id="L1815">                        mUndo.removeFirst();</span>
                    }
                }
            }
        }
<span class="nc" id="L1820">    }</span>

    public void markReview(Card card) {
<span class="nc" id="L1823">        boolean wasLeech = card.note().hasTag(&quot;leech&quot;);</span>
<span class="nc" id="L1824">        Card clonedCard = card.clone();</span>
<span class="nc" id="L1825">        Undoable undoableReview = new Undoable(REVIEW) {</span>

            @Nullable
            public Card undo(@NonNull Collection col) {
<span class="nc bnc" id="L1829" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21643)) {</span>
<span class="nc" id="L1830">                    col.getSched().undoReview(clonedCard, wasLeech);</span>
                }
<span class="nc" id="L1832">                return clonedCard;</span>
            }
        };
<span class="nc bnc" id="L1835" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21644)) {</span>
<span class="nc" id="L1836">            markUndo(undoableReview);</span>
        }
<span class="nc" id="L1838">    }</span>

    /*
     * Basic integrity check for syncing. True if ok.
     */
    @SuppressWarnings(&quot;BooleanMethodIsAlwaysInverted&quot;)
    public boolean basicCheck() {
<span class="nc bnc" id="L1845" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21650)) {</span>
            // cards without notes
<span class="nc bnc" id="L1847" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21649) ? (mDb.queryScalar(&quot;select 1 from cards where nid not in (select id from notes) limit 1&quot;) &gt;= 0) : (ListenerUtil.mutListener.listen(21648) ? (mDb.queryScalar(&quot;select 1 from cards where nid not in (select id from notes) limit 1&quot;) &lt;= 0) : (ListenerUtil.mutListener.listen(21647) ? (mDb.queryScalar(&quot;select 1 from cards where nid not in (select id from notes) limit 1&quot;) &lt; 0) : (ListenerUtil.mutListener.listen(21646) ? (mDb.queryScalar(&quot;select 1 from cards where nid not in (select id from notes) limit 1&quot;) != 0) : (ListenerUtil.mutListener.listen(21645) ? (mDb.queryScalar(&quot;select 1 from cards where nid not in (select id from notes) limit 1&quot;) == 0) : (mDb.queryScalar(&quot;select 1 from cards where nid not in (select id from notes) limit 1&quot;) &gt; 0))))))) {</span>
<span class="nc" id="L1848">                return false;</span>
            }
        }
<span class="nc bnc" id="L1851" title="All 22 branches missed.">        boolean badNotes = (ListenerUtil.mutListener.listen(21655) ? (mDb.queryScalar(&quot;select 1 from notes where id not in (select distinct nid from cards) &quot; + &quot;or mid not in &quot; + Utils.ids2str(getModels().ids()) + &quot; limit 1&quot;) &gt;= 0) : (ListenerUtil.mutListener.listen(21654) ? (mDb.queryScalar(&quot;select 1 from notes where id not in (select distinct nid from cards) &quot; + &quot;or mid not in &quot; + Utils.ids2str(getModels().ids()) + &quot; limit 1&quot;) &lt;= 0) : (ListenerUtil.mutListener.listen(21653) ? (mDb.queryScalar(&quot;select 1 from notes where id not in (select distinct nid from cards) &quot; + &quot;or mid not in &quot; + Utils.ids2str(getModels().ids()) + &quot; limit 1&quot;) &lt; 0) : (ListenerUtil.mutListener.listen(21652) ? (mDb.queryScalar(&quot;select 1 from notes where id not in (select distinct nid from cards) &quot; + &quot;or mid not in &quot; + Utils.ids2str(getModels().ids()) + &quot; limit 1&quot;) != 0) : (ListenerUtil.mutListener.listen(21651) ? (mDb.queryScalar(&quot;select 1 from notes where id not in (select distinct nid from cards) &quot; + &quot;or mid not in &quot; + Utils.ids2str(getModels().ids()) + &quot; limit 1&quot;) == 0) : (mDb.queryScalar(&quot;select 1 from notes where id not in (select distinct nid from cards) &quot; + &quot;or mid not in &quot; + Utils.ids2str(getModels().ids()) + &quot; limit 1&quot;) &gt; 0))))));</span>
<span class="nc bnc" id="L1852" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21656)) {</span>
            // notes without cards or models
<span class="nc bnc" id="L1854" title="All 2 branches missed.">            if (badNotes) {</span>
<span class="nc" id="L1855">                return false;</span>
            }
        }
<span class="nc bnc" id="L1858" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21669)) {</span>
            {
<span class="nc" id="L1860">                long _loopCounter476 = 0;</span>
                // invalid ords
<span class="nc bnc" id="L1862" title="All 2 branches missed.">                for (JSONObject m : getModels().all()) {</span>
<span class="nc" id="L1863">                    ListenerUtil.loopListener.listen(&quot;_loopCounter476&quot;, ++_loopCounter476);</span>
<span class="nc bnc" id="L1864" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21662)) {</span>
                        // ignore clozes
<span class="nc bnc" id="L1866" title="All 22 branches missed.">                        if ((ListenerUtil.mutListener.listen(21661) ? (m.getInt(&quot;type&quot;) &gt;= Consts.MODEL_STD) : (ListenerUtil.mutListener.listen(21660) ? (m.getInt(&quot;type&quot;) &lt;= Consts.MODEL_STD) : (ListenerUtil.mutListener.listen(21659) ? (m.getInt(&quot;type&quot;) &gt; Consts.MODEL_STD) : (ListenerUtil.mutListener.listen(21658) ? (m.getInt(&quot;type&quot;) &lt; Consts.MODEL_STD) : (ListenerUtil.mutListener.listen(21657) ? (m.getInt(&quot;type&quot;) == Consts.MODEL_STD) : (m.getInt(&quot;type&quot;) != Consts.MODEL_STD))))))) {</span>
<span class="nc" id="L1867">                            continue;</span>
                        }
                    }
                    // Make a list of valid ords for this model
<span class="nc" id="L1871">                    JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L1872" title="All 22 branches missed.">                    boolean badOrd = (ListenerUtil.mutListener.listen(21667) ? (mDb.queryScalar(&quot;select 1 from cards where (ord &lt; 0 or ord &gt;= ?) and nid in ( &quot; + &quot;select id from notes where mid = ?) limit 1&quot;, tmpls.length(), m.getLong(&quot;id&quot;)) &gt;= 0) : (ListenerUtil.mutListener.listen(21666) ? (mDb.queryScalar(&quot;select 1 from cards where (ord &lt; 0 or ord &gt;= ?) and nid in ( &quot; + &quot;select id from notes where mid = ?) limit 1&quot;, tmpls.length(), m.getLong(&quot;id&quot;)) &lt;= 0) : (ListenerUtil.mutListener.listen(21665) ? (mDb.queryScalar(&quot;select 1 from cards where (ord &lt; 0 or ord &gt;= ?) and nid in ( &quot; + &quot;select id from notes where mid = ?) limit 1&quot;, tmpls.length(), m.getLong(&quot;id&quot;)) &lt; 0) : (ListenerUtil.mutListener.listen(21664) ? (mDb.queryScalar(&quot;select 1 from cards where (ord &lt; 0 or ord &gt;= ?) and nid in ( &quot; + &quot;select id from notes where mid = ?) limit 1&quot;, tmpls.length(), m.getLong(&quot;id&quot;)) != 0) : (ListenerUtil.mutListener.listen(21663) ? (mDb.queryScalar(&quot;select 1 from cards where (ord &lt; 0 or ord &gt;= ?) and nid in ( &quot; + &quot;select id from notes where mid = ?) limit 1&quot;, tmpls.length(), m.getLong(&quot;id&quot;)) == 0) : (mDb.queryScalar(&quot;select 1 from cards where (ord &lt; 0 or ord &gt;= ?) and nid in ( &quot; + &quot;select id from notes where mid = ?) limit 1&quot;, tmpls.length(), m.getLong(&quot;id&quot;)) &gt; 0))))));</span>
<span class="nc bnc" id="L1873" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21668)) {</span>
<span class="nc bnc" id="L1874" title="All 2 branches missed.">                        if (badOrd) {</span>
<span class="nc" id="L1875">                            return false;</span>
                        }
                    }
<span class="nc" id="L1878">                }</span>
            }
        }
<span class="nc" id="L1881">        return true;</span>
    }

    /**
     * Fix possible problems and rebuild caches.
     */
    public CheckDatabaseResult fixIntegrity(TaskManager.ProgressCallback&lt;String&gt; progressCallback) {
<span class="nc" id="L1888">        File file = new File(mPath);</span>
<span class="nc" id="L1889">        CheckDatabaseResult result = new CheckDatabaseResult(file.length());</span>
<span class="nc" id="L1890">        final int[] currentTask = { 1 };</span>
        // a few fixes are in all-models loops, the rest are one-offs
<span class="nc bnc" id="L1892" title="All 48 branches missed.">        int totalTasks = (ListenerUtil.mutListener.listen(21677) ? (((ListenerUtil.mutListener.listen(21673) ? (getModels().all().size() % 4) : (ListenerUtil.mutListener.listen(21672) ? (getModels().all().size() / 4) : (ListenerUtil.mutListener.listen(21671) ? (getModels().all().size() - 4) : (ListenerUtil.mutListener.listen(21670) ? (getModels().all().size() + 4) : (getModels().all().size() * 4)))))) % 27) : (ListenerUtil.mutListener.listen(21676) ? (((ListenerUtil.mutListener.listen(21673) ? (getModels().all().size() % 4) : (ListenerUtil.mutListener.listen(21672) ? (getModels().all().size() / 4) : (ListenerUtil.mutListener.listen(21671) ? (getModels().all().size() - 4) : (ListenerUtil.mutListener.listen(21670) ? (getModels().all().size() + 4) : (getModels().all().size() * 4)))))) / 27) : (ListenerUtil.mutListener.listen(21675) ? (((ListenerUtil.mutListener.listen(21673) ? (getModels().all().size() % 4) : (ListenerUtil.mutListener.listen(21672) ? (getModels().all().size() / 4) : (ListenerUtil.mutListener.listen(21671) ? (getModels().all().size() - 4) : (ListenerUtil.mutListener.listen(21670) ? (getModels().all().size() + 4) : (getModels().all().size() * 4)))))) * 27) : (ListenerUtil.mutListener.listen(21674) ? (((ListenerUtil.mutListener.listen(21673) ? (getModels().all().size() % 4) : (ListenerUtil.mutListener.listen(21672) ? (getModels().all().size() / 4) : (ListenerUtil.mutListener.listen(21671) ? (getModels().all().size() - 4) : (ListenerUtil.mutListener.listen(21670) ? (getModels().all().size() + 4) : (getModels().all().size() * 4)))))) - 27) : (((ListenerUtil.mutListener.listen(21673) ? (getModels().all().size() % 4) : (ListenerUtil.mutListener.listen(21672) ? (getModels().all().size() / 4) : (ListenerUtil.mutListener.listen(21671) ? (getModels().all().size() - 4) : (ListenerUtil.mutListener.listen(21670) ? (getModels().all().size() + 4) : (getModels().all().size() * 4)))))) + 27)))));</span>
<span class="nc" id="L1893">        Runnable notifyProgress = () -&gt; fixIntegrityProgress(progressCallback, currentTask[0]++, totalTasks);</span>
<span class="nc" id="L1894">        FunctionalInterfaces.Consumer&lt;FunctionalInterfaces.FunctionThrowable&lt;Runnable, List&lt;String&gt;, JSONException&gt;&gt; executeIntegrityTask = function -&gt; {</span>
            // DEFECT: notifyProgress will lag if an exception is thrown.
            try {
<span class="nc" id="L1897">                mDb.getDatabase().beginTransaction();</span>
<span class="nc" id="L1898">                result.addAll(function.apply(notifyProgress));</span>
<span class="nc" id="L1899">                mDb.getDatabase().setTransactionSuccessful();</span>
<span class="nc" id="L1900">            } catch (Exception e) {</span>
<span class="nc" id="L1901">                Timber.e(e, &quot;Failed to execute integrity check&quot;);</span>
<span class="nc" id="L1902">                AnkiDroidApp.sendExceptionReport(e, &quot;fixIntegrity&quot;);</span>
            } finally {
                try {
<span class="nc" id="L1905">                    mDb.getDatabase().endTransaction();</span>
<span class="nc" id="L1906">                } catch (Exception e) {</span>
<span class="nc" id="L1907">                    Timber.e(e, &quot;Failed to end integrity check transaction&quot;);</span>
<span class="nc" id="L1908">                    AnkiDroidApp.sendExceptionReport(e, &quot;fixIntegrity - endTransaction&quot;);</span>
<span class="nc" id="L1909">                }</span>
            }
<span class="nc" id="L1911">        };</span>
        try {
<span class="nc bnc" id="L1913" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21683)) {</span>
<span class="nc" id="L1914">                mDb.getDatabase().beginTransaction();</span>
            }
<span class="nc bnc" id="L1916" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21684)) {</span>
<span class="nc" id="L1917">                save();</span>
            }
<span class="nc bnc" id="L1919" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21685)) {</span>
<span class="nc" id="L1920">                notifyProgress.run();</span>
            }
<span class="nc bnc" id="L1922" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21686)) {</span>
<span class="nc bnc" id="L1923" title="All 2 branches missed.">                if (!mDb.getDatabase().isDatabaseIntegrityOk()) {</span>
<span class="nc" id="L1924">                    return result.markAsFailed();</span>
                }
            }
<span class="nc bnc" id="L1927" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21687)) {</span>
<span class="nc" id="L1928">                mDb.getDatabase().setTransactionSuccessful();</span>
            }
<span class="nc" id="L1930">        } catch (SQLiteDatabaseLockedException ex) {</span>
<span class="nc bnc" id="L1931" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21678)) {</span>
<span class="nc" id="L1932">                Timber.e(&quot;doInBackgroundCheckDatabase - Database locked&quot;);</span>
            }
<span class="nc" id="L1934">            return result.markAsLocked();</span>
<span class="nc" id="L1935">        } catch (RuntimeException e) {</span>
<span class="nc bnc" id="L1936" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21679)) {</span>
<span class="nc" id="L1937">                Timber.e(e, &quot;doInBackgroundCheckDatabase - RuntimeException on marking card&quot;);</span>
            }
<span class="nc bnc" id="L1939" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21680)) {</span>
<span class="nc" id="L1940">                AnkiDroidApp.sendExceptionReport(e, &quot;doInBackgroundCheckDatabase&quot;);</span>
            }
<span class="nc" id="L1942">            return result.markAsFailed();</span>
        } finally {
<span class="nc bnc" id="L1944" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21682)) {</span>
                // if the database was locked, we never got the transaction.
<span class="nc bnc" id="L1946" title="All 2 branches missed.">                if (mDb.getDatabase().inTransaction()) {</span>
<span class="nc bnc" id="L1947" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21681)) {</span>
<span class="nc" id="L1948">                        mDb.getDatabase().endTransaction();</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L1953" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21688)) {</span>
<span class="nc" id="L1954">            executeIntegrityTask.consume(this::deleteNotesWithMissingModel);</span>
        }
<span class="nc bnc" id="L1956" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21691)) {</span>
            {
<span class="nc" id="L1958">                long _loopCounter477 = 0;</span>
                // for each model
<span class="nc bnc" id="L1960" title="All 2 branches missed.">                for (Model m : getModels().all()) {</span>
<span class="nc" id="L1961">                    ListenerUtil.loopListener.listen(&quot;_loopCounter477&quot;, ++_loopCounter477);</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21689)) {</span>
<span class="nc" id="L1963">                        executeIntegrityTask.consume((callback) -&gt; deleteCardsWithInvalidModelOrdinals(callback, m));</span>
                    }
<span class="nc bnc" id="L1965" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21690)) {</span>
<span class="nc" id="L1966">                        executeIntegrityTask.consume((callback) -&gt; deleteNotesWithWrongFieldCounts(callback, m));</span>
                    }
<span class="nc" id="L1968">                }</span>
            }
        }
<span class="nc bnc" id="L1971" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21692)) {</span>
<span class="nc" id="L1972">            executeIntegrityTask.consume(this::deleteNotesWithMissingCards);</span>
        }
<span class="nc bnc" id="L1974" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21693)) {</span>
<span class="nc" id="L1975">            executeIntegrityTask.consume(this::deleteCardsWithMissingNotes);</span>
        }
<span class="nc bnc" id="L1977" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21694)) {</span>
<span class="nc" id="L1978">            executeIntegrityTask.consume(this::removeOriginalDuePropertyWhereInvalid);</span>
        }
<span class="nc bnc" id="L1980" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21695)) {</span>
<span class="nc" id="L1981">            executeIntegrityTask.consume(this::removeDynamicPropertyFromNonDynamicDecks);</span>
        }
<span class="nc bnc" id="L1983" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21696)) {</span>
<span class="nc" id="L1984">            executeIntegrityTask.consume(this::removeDeckOptionsFromDynamicDecks);</span>
        }
<span class="nc bnc" id="L1986" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21697)) {</span>
<span class="nc" id="L1987">            executeIntegrityTask.consume(this::resetInvalidDeckOptions);</span>
        }
<span class="nc bnc" id="L1989" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21698)) {</span>
<span class="nc" id="L1990">            executeIntegrityTask.consume(this::rebuildTags);</span>
        }
<span class="nc bnc" id="L1992" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21699)) {</span>
<span class="nc" id="L1993">            executeIntegrityTask.consume(this::updateFieldCache);</span>
        }
<span class="nc bnc" id="L1995" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21700)) {</span>
<span class="nc" id="L1996">            executeIntegrityTask.consume(this::fixNewCardDuePositionOverflow);</span>
        }
<span class="nc bnc" id="L1998" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21701)) {</span>
<span class="nc" id="L1999">            executeIntegrityTask.consume(this::resetNewCardInsertionPosition);</span>
        }
<span class="nc bnc" id="L2001" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21702)) {</span>
<span class="nc" id="L2002">            executeIntegrityTask.consume(this::fixExcessiveReviewDueDates);</span>
        }
<span class="nc bnc" id="L2004" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21703)) {</span>
            // v2 sched had a bug that could create decimal intervals
<span class="nc" id="L2006">            executeIntegrityTask.consume(this::fixDecimalCardsData);</span>
        }
<span class="nc bnc" id="L2008" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21704)) {</span>
<span class="nc" id="L2009">            executeIntegrityTask.consume(this::fixDecimalRevLogData);</span>
        }
<span class="nc bnc" id="L2011" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21705)) {</span>
<span class="nc" id="L2012">            executeIntegrityTask.consume(this::restoreMissingDatabaseIndices);</span>
        }
<span class="nc bnc" id="L2014" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21706)) {</span>
<span class="nc" id="L2015">            executeIntegrityTask.consume(this::ensureModelsAreNotEmpty);</span>
        }
<span class="nc bnc" id="L2017" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21707)) {</span>
<span class="nc" id="L2018">            executeIntegrityTask.consume((progressNotifier) -&gt; this.ensureCardsHaveHomeDeck(progressNotifier, result));</span>
        }
        // and finally, optimize (unable to be done inside transaction).
        try {
<span class="nc bnc" id="L2022" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21710)) {</span>
<span class="nc" id="L2023">                optimize(notifyProgress);</span>
            }
<span class="nc" id="L2025">        } catch (Exception e) {</span>
<span class="nc bnc" id="L2026" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21708)) {</span>
<span class="nc" id="L2027">                Timber.e(e, &quot;optimize&quot;);</span>
            }
<span class="nc bnc" id="L2029" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21709)) {</span>
<span class="nc" id="L2030">                AnkiDroidApp.sendExceptionReport(e, &quot;fixIntegrity - optimize&quot;);</span>
            }
<span class="nc" id="L2032">        }</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21711)) {</span>
<span class="nc" id="L2034">            file = new File(mPath);</span>
        }
<span class="nc" id="L2036">        long newSize = file.length();</span>
<span class="nc bnc" id="L2037" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21712)) {</span>
<span class="nc" id="L2038">            result.setNewSize(newSize);</span>
        }
<span class="nc bnc" id="L2040" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21714)) {</span>
            // if any problems were found, force a full sync
<span class="nc bnc" id="L2042" title="All 2 branches missed.">            if (result.hasProblems()) {</span>
<span class="nc bnc" id="L2043" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21713)) {</span>
<span class="nc" id="L2044">                    modSchemaNoCheck();</span>
                }
            }
        }
<span class="nc bnc" id="L2048" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21715)) {</span>
<span class="nc" id="L2049">            logProblems(result.getProblems());</span>
        }
<span class="nc" id="L2051">        return result;</span>
    }

    private List&lt;String&gt; resetInvalidDeckOptions(Runnable notifyProgress) {
<span class="nc bnc" id="L2055" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21716)) {</span>
<span class="nc" id="L2056">            Timber.d(&quot;resetInvalidDeckOptions&quot;);</span>
        }
<span class="nc bnc" id="L2058" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21717)) {</span>
            // 6454
<span class="nc" id="L2060">            notifyProgress.run();</span>
        }
        // obtain a list of all valid dconf IDs
<span class="nc" id="L2063">        List&lt;DeckConfig&gt; allConf = getDecks().allConf();</span>
<span class="nc" id="L2064">        HashSet&lt;Long&gt; configIds = new HashSet&lt;&gt;(allConf.size());</span>
<span class="nc bnc" id="L2065" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21719)) {</span>
            {
<span class="nc" id="L2067">                long _loopCounter478 = 0;</span>
<span class="nc bnc" id="L2068" title="All 2 branches missed.">                for (DeckConfig conf : allConf) {</span>
<span class="nc" id="L2069">                    ListenerUtil.loopListener.listen(&quot;_loopCounter478&quot;, ++_loopCounter478);</span>
<span class="nc bnc" id="L2070" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21718)) {</span>
<span class="nc" id="L2071">                        configIds.add(conf.getLong(&quot;id&quot;));</span>
                    }
<span class="nc" id="L2073">                }</span>
            }
        }
<span class="nc bnc" id="L2076" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21720)) {</span>
<span class="nc" id="L2077">            notifyProgress.run();</span>
        }
<span class="nc" id="L2079">        int changed = 0;</span>
<span class="nc bnc" id="L2080" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21726)) {</span>
            {
<span class="nc" id="L2082">                long _loopCounter479 = 0;</span>
<span class="nc bnc" id="L2083" title="All 2 branches missed.">                for (Deck d : getDecks().all()) {</span>
<span class="nc" id="L2084">                    ListenerUtil.loopListener.listen(&quot;_loopCounter479&quot;, ++_loopCounter479);</span>
<span class="nc bnc" id="L2085" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21721)) {</span>
                        // dynamic decks do not have dconf
<span class="nc bnc" id="L2087" title="All 2 branches missed.">                        if (Decks.isDynamic(d)) {</span>
<span class="nc" id="L2088">                            continue;</span>
                        }
                    }
<span class="nc bnc" id="L2091" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21725)) {</span>
<span class="nc bnc" id="L2092" title="All 2 branches missed.">                        if (!configIds.contains(d.getLong(&quot;conf&quot;))) {</span>
<span class="nc bnc" id="L2093" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21722)) {</span>
<span class="nc" id="L2094">                                Timber.d(&quot;Reset %s's config to default&quot;, d.optString(&quot;name&quot;, &quot;unknown deck&quot;));</span>
                            }
<span class="nc bnc" id="L2096" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21723)) {</span>
<span class="nc" id="L2097">                                d.put(&quot;conf&quot;, Consts.DEFAULT_DECK_CONFIG_ID);</span>
                            }
<span class="nc bnc" id="L2099" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21724)) {</span>
<span class="nc" id="L2100">                                changed++;</span>
                            }
                        }
                    }
<span class="nc" id="L2104">                }</span>
            }
        }
<span class="nc" id="L2107">        List&lt;String&gt; ret = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2108" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21734)) {</span>
<span class="nc bnc" id="L2109" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21731) ? (changed &gt;= 0) : (ListenerUtil.mutListener.listen(21730) ? (changed &lt;= 0) : (ListenerUtil.mutListener.listen(21729) ? (changed &lt; 0) : (ListenerUtil.mutListener.listen(21728) ? (changed != 0) : (ListenerUtil.mutListener.listen(21727) ? (changed == 0) : (changed &gt; 0))))))) {</span>
<span class="nc bnc" id="L2110" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21732)) {</span>
<span class="nc" id="L2111">                    ret.add(&quot;Fixed &quot; + changed + &quot; decks with invalid config&quot;);</span>
                }
<span class="nc bnc" id="L2113" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21733)) {</span>
<span class="nc" id="L2114">                    getDecks().save();</span>
                }
            }
        }
<span class="nc" id="L2118">        return ret;</span>
    }

    /**
     * #5932 - a card may not have a home deck if:
     * &lt;ul&gt;&gt;
     * &lt;li&gt;It is in a dynamic deck, and has odid = 0.&lt;/li&gt;
     * &lt;li&gt;It is in a dynamic deck, and the odid refers to a dynamic deck.&lt;/li&gt;
     * &lt;/ul&gt;
     * Both of these cases can be fixed by moving the decks to a known-good deck
     */
    private List&lt;String&gt; ensureCardsHaveHomeDeck(Runnable notifyProgress, CheckDatabaseResult result) {
<span class="nc bnc" id="L2130" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21735)) {</span>
<span class="nc" id="L2131">            Timber.d(&quot;ensureCardsHaveHomeDeck()&quot;);</span>
        }
<span class="nc bnc" id="L2133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21736)) {</span>
<span class="nc" id="L2134">            notifyProgress.run();</span>
        }
        // get the deck Ids to query
<span class="nc" id="L2137">        Long[] dynDeckIds = getDecks().allDynamicDeckIds();</span>
        // make it mutable
<span class="nc" id="L2139">        List&lt;Long&gt; dynIdsAndZero = new ArrayList&lt;&gt;(Arrays.asList(dynDeckIds));</span>
<span class="nc bnc" id="L2140" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21737)) {</span>
<span class="nc" id="L2141">            dynIdsAndZero.add(0L);</span>
        }
<span class="nc" id="L2143">        ArrayList&lt;Long&gt; cardIds = mDb.queryLongList(&quot;select id from cards where did in &quot; + Utils.ids2str(dynDeckIds) + &quot;and odid in &quot; + Utils.ids2str(dynIdsAndZero));</span>
<span class="nc bnc" id="L2144" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21738)) {</span>
<span class="nc" id="L2145">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21739)) {</span>
<span class="nc bnc" id="L2148" title="All 2 branches missed.">            if (cardIds.isEmpty()) {</span>
<span class="nc" id="L2149">                return Collections.emptyList();</span>
            }
        }
        // we use a ! prefix to keep it at the top of the deck list
<span class="nc" id="L2153">        String recoveredDeckName = &quot;! &quot; + mContext.getString(R.string.check_integrity_recovered_deck_name);</span>
<span class="nc" id="L2154">        Long nextDeckId = getDecks().id(recoveredDeckName, true);</span>
<span class="nc bnc" id="L2155" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21740)) {</span>
<span class="nc bnc" id="L2156" title="All 2 branches missed.">            if (nextDeckId == null) {</span>
<span class="nc" id="L2157">                throw new IllegalStateException(&quot;Unable to create deck&quot;);</span>
            }
        }
<span class="nc bnc" id="L2160" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21741)) {</span>
<span class="nc" id="L2161">            getDecks().flush();</span>
        }
<span class="nc bnc" id="L2163" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21742)) {</span>
<span class="nc" id="L2164">            mDb.execute(&quot;update cards &quot; + &quot;set did = ?, &quot; + &quot;odid = 0,&quot; + &quot;mod = ?, &quot; + &quot;usn = ? &quot; + &quot;where did in &quot; + Utils.ids2str(dynDeckIds) + &quot;and odid in &quot; + Utils.ids2str(dynIdsAndZero), nextDeckId, getTime().intTime(), usn());</span>
        }
<span class="nc bnc" id="L2166" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21743)) {</span>
<span class="nc" id="L2167">            result.setCardsWithFixedHomeDeckCount(cardIds.size());</span>
        }
<span class="nc" id="L2169">        String message = String.format(Locale.US, &quot;Fixed %d cards with no home deck&quot;, cardIds.size());</span>
<span class="nc" id="L2170">        return Collections.singletonList(message);</span>
    }

    private ArrayList&lt;String&gt; ensureModelsAreNotEmpty(Runnable notifyProgress) {
<span class="nc bnc" id="L2174" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21744)) {</span>
<span class="nc" id="L2175">            Timber.d(&quot;ensureModelsAreNotEmpty()&quot;);</span>
        }
<span class="nc" id="L2177">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2178" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21745)) {</span>
<span class="nc" id="L2179">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2181" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21747)) {</span>
<span class="nc bnc" id="L2182" title="All 2 branches missed.">            if (getModels().ensureNotEmpty()) {</span>
<span class="nc bnc" id="L2183" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21746)) {</span>
<span class="nc" id="L2184">                    problems.add(&quot;Added missing note type.&quot;);</span>
                }
            }
        }
<span class="nc" id="L2188">        return problems;</span>
    }

    private ArrayList&lt;String&gt; restoreMissingDatabaseIndices(Runnable notifyProgress) {
<span class="nc bnc" id="L2192" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21748)) {</span>
<span class="nc" id="L2193">            Timber.d(&quot;restoreMissingDatabaseIndices&quot;);</span>
        }
<span class="nc" id="L2195">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2196" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21749)) {</span>
            // DB must have indices. Older versions of AnkiDroid didn't create them for new collections.
<span class="nc" id="L2198">            notifyProgress.run();</span>
        }
<span class="nc" id="L2200">        int ixs = mDb.queryScalar(&quot;select count(name) from sqlite_master where type = 'index'&quot;);</span>
<span class="nc bnc" id="L2201" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21757)) {</span>
<span class="nc bnc" id="L2202" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21754) ? (ixs &gt;= 7) : (ListenerUtil.mutListener.listen(21753) ? (ixs &lt;= 7) : (ListenerUtil.mutListener.listen(21752) ? (ixs &gt; 7) : (ListenerUtil.mutListener.listen(21751) ? (ixs != 7) : (ListenerUtil.mutListener.listen(21750) ? (ixs == 7) : (ixs &lt; 7))))))) {</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21755)) {</span>
<span class="nc" id="L2204">                    problems.add(&quot;Indices were missing.&quot;);</span>
                }
<span class="nc bnc" id="L2206" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21756)) {</span>
<span class="nc" id="L2207">                    Storage.addIndices(mDb);</span>
                }
            }
        }
<span class="nc" id="L2211">        return problems;</span>
    }

    private ArrayList&lt;String&gt; fixDecimalCardsData(Runnable notifyProgress) {
<span class="nc bnc" id="L2215" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21758)) {</span>
<span class="nc" id="L2216">            Timber.d(&quot;fixDecimalCardsData&quot;);</span>
        }
<span class="nc" id="L2218">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2219" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21759)) {</span>
<span class="nc" id="L2220">            notifyProgress.run();</span>
        }
<span class="nc" id="L2222">        SupportSQLiteStatement s = mDb.getDatabase().compileStatement(&quot;update cards set ivl=round(ivl),due=round(due) where ivl!=round(ivl) or due!=round(due)&quot;);</span>
<span class="nc" id="L2223">        int rowCount = s.executeUpdateDelete();</span>
<span class="nc bnc" id="L2224" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21766)) {</span>
<span class="nc bnc" id="L2225" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21764) ? (rowCount &gt;= 0) : (ListenerUtil.mutListener.listen(21763) ? (rowCount &lt;= 0) : (ListenerUtil.mutListener.listen(21762) ? (rowCount &lt; 0) : (ListenerUtil.mutListener.listen(21761) ? (rowCount != 0) : (ListenerUtil.mutListener.listen(21760) ? (rowCount == 0) : (rowCount &gt; 0))))))) {</span>
<span class="nc bnc" id="L2226" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21765)) {</span>
<span class="nc" id="L2227">                    problems.add(&quot;Fixed &quot; + rowCount + &quot; cards with v2 scheduler bug.&quot;);</span>
                }
            }
        }
<span class="nc" id="L2231">        return problems;</span>
    }

    private ArrayList&lt;String&gt; fixDecimalRevLogData(Runnable notifyProgress) {
<span class="nc bnc" id="L2235" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21767)) {</span>
<span class="nc" id="L2236">            Timber.d(&quot;fixDecimalRevLogData()&quot;);</span>
        }
<span class="nc" id="L2238">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21768)) {</span>
<span class="nc" id="L2240">            notifyProgress.run();</span>
        }
<span class="nc" id="L2242">        SupportSQLiteStatement s = mDb.getDatabase().compileStatement(&quot;update revlog set ivl=round(ivl),lastIvl=round(lastIvl) where ivl!=round(ivl) or lastIvl!=round(lastIvl)&quot;);</span>
<span class="nc" id="L2243">        int rowCount = s.executeUpdateDelete();</span>
<span class="nc bnc" id="L2244" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21775)) {</span>
<span class="nc bnc" id="L2245" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21773) ? (rowCount &gt;= 0) : (ListenerUtil.mutListener.listen(21772) ? (rowCount &lt;= 0) : (ListenerUtil.mutListener.listen(21771) ? (rowCount &lt; 0) : (ListenerUtil.mutListener.listen(21770) ? (rowCount != 0) : (ListenerUtil.mutListener.listen(21769) ? (rowCount == 0) : (rowCount &gt; 0))))))) {</span>
<span class="nc bnc" id="L2246" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21774)) {</span>
<span class="nc" id="L2247">                    problems.add(&quot;Fixed &quot; + rowCount + &quot; review history entries with v2 scheduler bug.&quot;);</span>
                }
            }
        }
<span class="nc" id="L2251">        return problems;</span>
    }

    private ArrayList&lt;String&gt; fixExcessiveReviewDueDates(Runnable notifyProgress) {
<span class="nc bnc" id="L2255" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21776)) {</span>
<span class="nc" id="L2256">            Timber.d(&quot;fixExcessiveReviewDueDates()&quot;);</span>
        }
<span class="nc" id="L2258">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2259" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21777)) {</span>
<span class="nc" id="L2260">            notifyProgress.run();</span>
        }
        // reviews should have a reasonable due #
<span class="nc" id="L2263">        ArrayList&lt;Long&gt; ids = mDb.queryLongList(&quot;SELECT id FROM cards WHERE queue = &quot; + Consts.QUEUE_TYPE_REV + &quot; AND due &gt; 100000&quot;);</span>
<span class="nc bnc" id="L2264" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21778)) {</span>
<span class="nc" id="L2265">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2267" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21786)) {</span>
<span class="nc bnc" id="L2268" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21783) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21782) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21781) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21780) ? (ids.size() != 0) : (ListenerUtil.mutListener.listen(21779) ? (ids.size() == 0) : (ids.size() &gt; 0))))))) {</span>
<span class="nc bnc" id="L2269" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21784)) {</span>
<span class="nc" id="L2270">                    problems.add(&quot;Reviews had incorrect due date.&quot;);</span>
                }
<span class="nc bnc" id="L2272" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21785)) {</span>
<span class="nc" id="L2273">                    mDb.execute(&quot;UPDATE cards SET due = ?, ivl = 1, mod = ?, usn = ? WHERE id IN &quot; + Utils.ids2str(ids), mSched.getToday(), getTime().intTime(), usn());</span>
                }
            }
        }
<span class="nc" id="L2277">        return problems;</span>
    }

    private List&lt;String&gt; resetNewCardInsertionPosition(Runnable notifyProgress) throws JSONException {
<span class="nc bnc" id="L2281" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21787)) {</span>
<span class="nc" id="L2282">            Timber.d(&quot;resetNewCardInsertionPosition&quot;);</span>
        }
<span class="nc bnc" id="L2284" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21788)) {</span>
<span class="nc" id="L2285">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2287" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21789)) {</span>
            // new card position
<span class="nc" id="L2289">            mConf.put(&quot;nextPos&quot;, mDb.queryScalar(&quot;SELECT max(due) + 1 FROM cards WHERE type = &quot; + Consts.CARD_TYPE_NEW));</span>
        }
<span class="nc" id="L2291">        return Collections.emptyList();</span>
    }

    private List&lt;String&gt; fixNewCardDuePositionOverflow(Runnable notifyProgress) {
<span class="nc bnc" id="L2295" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21790)) {</span>
<span class="nc" id="L2296">            Timber.d(&quot;fixNewCardDuePositionOverflow&quot;);</span>
        }
<span class="nc bnc" id="L2298" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21791)) {</span>
            // new cards can't have a due position &gt; 32 bits
<span class="nc" id="L2300">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2302" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21792)) {</span>
<span class="nc" id="L2303">            mDb.execute(&quot;UPDATE cards SET due = 1000000, mod = ?, usn = ? WHERE due &gt; 1000000 AND type = &quot; + Consts.CARD_TYPE_NEW, getTime().intTime(), usn());</span>
        }
<span class="nc" id="L2305">        return Collections.emptyList();</span>
    }

    private List&lt;String&gt; updateFieldCache(Runnable notifyProgress) {
<span class="nc bnc" id="L2309" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21793)) {</span>
<span class="nc" id="L2310">            Timber.d(&quot;updateFieldCache&quot;);</span>
        }
<span class="nc bnc" id="L2312" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21796)) {</span>
            {
<span class="nc" id="L2314">                long _loopCounter480 = 0;</span>
                // field cache
<span class="nc bnc" id="L2316" title="All 2 branches missed.">                for (Model m : getModels().all()) {</span>
<span class="nc" id="L2317">                    ListenerUtil.loopListener.listen(&quot;_loopCounter480&quot;, ++_loopCounter480);</span>
<span class="nc bnc" id="L2318" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21794)) {</span>
<span class="nc" id="L2319">                        notifyProgress.run();</span>
                    }
<span class="nc bnc" id="L2321" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21795)) {</span>
<span class="nc" id="L2322">                        updateFieldCache(getModels().nids(m));</span>
                    }
<span class="nc" id="L2324">                }</span>
            }
        }
<span class="nc" id="L2327">        return Collections.emptyList();</span>
    }

    private List&lt;String&gt; rebuildTags(Runnable notifyProgress) {
<span class="nc bnc" id="L2331" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21797)) {</span>
<span class="nc" id="L2332">            Timber.d(&quot;rebuildTags&quot;);</span>
        }
<span class="nc bnc" id="L2334" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21798)) {</span>
            // tags
<span class="nc" id="L2336">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2338" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21799)) {</span>
<span class="nc" id="L2339">            mTags.registerNotes();</span>
        }
<span class="nc" id="L2341">        return Collections.emptyList();</span>
    }

    private ArrayList&lt;String&gt; removeDeckOptionsFromDynamicDecks(Runnable notifyProgress) {
<span class="nc bnc" id="L2345" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21800)) {</span>
<span class="nc" id="L2346">            Timber.d(&quot;removeDeckOptionsFromDynamicDecks()&quot;);</span>
        }
<span class="nc" id="L2348">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2349" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21801)) {</span>
            // #5708 - a dynamic deck should not have &quot;Deck Options&quot;
<span class="nc" id="L2351">            notifyProgress.run();</span>
        }
<span class="nc" id="L2353">        int fixCount = 0;</span>
<span class="nc bnc" id="L2354" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21806)) {</span>
            {
<span class="nc" id="L2356">                long _loopCounter481 = 0;</span>
<span class="nc bnc" id="L2357" title="All 2 branches missed.">                for (long id : mDecks.allDynamicDeckIds()) {</span>
<span class="nc" id="L2358">                    ListenerUtil.loopListener.listen(&quot;_loopCounter481&quot;, ++_loopCounter481);</span>
                    try {
<span class="nc bnc" id="L2360" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21805)) {</span>
<span class="nc bnc" id="L2361" title="All 2 branches missed.">                            if (mDecks.hasDeckOptions(id)) {</span>
<span class="nc bnc" id="L2362" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21803)) {</span>
<span class="nc" id="L2363">                                    mDecks.removeDeckOptions(id);</span>
                                }
<span class="nc bnc" id="L2365" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(21804)) {</span>
<span class="nc" id="L2366">                                    fixCount++;</span>
                                }
                            }
                        }
<span class="nc" id="L2370">                    } catch (NoSuchDeckException e) {</span>
<span class="nc bnc" id="L2371" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21802)) {</span>
<span class="nc" id="L2372">                            Timber.e(&quot;Unable to find dynamic deck %d&quot;, id);</span>
                        }
<span class="nc" id="L2374">                    }</span>
                }
            }
        }
<span class="nc bnc" id="L2378" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21814)) {</span>
<span class="nc bnc" id="L2379" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21811) ? (fixCount &gt;= 0) : (ListenerUtil.mutListener.listen(21810) ? (fixCount &lt;= 0) : (ListenerUtil.mutListener.listen(21809) ? (fixCount &lt; 0) : (ListenerUtil.mutListener.listen(21808) ? (fixCount != 0) : (ListenerUtil.mutListener.listen(21807) ? (fixCount == 0) : (fixCount &gt; 0))))))) {</span>
<span class="nc bnc" id="L2380" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21812)) {</span>
<span class="nc" id="L2381">                    mDecks.save();</span>
                }
<span class="nc bnc" id="L2383" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21813)) {</span>
<span class="nc" id="L2384">                    problems.add(String.format(Locale.US, &quot;%d dynamic deck(s) had deck options.&quot;, fixCount));</span>
                }
            }
        }
<span class="nc" id="L2388">        return problems;</span>
    }

    private ArrayList&lt;String&gt; removeDynamicPropertyFromNonDynamicDecks(Runnable notifyProgress) {
<span class="nc bnc" id="L2392" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21815)) {</span>
<span class="nc" id="L2393">            Timber.d(&quot;removeDynamicPropertyFromNonDynamicDecks()&quot;);</span>
        }
<span class="nc" id="L2395">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L2396">        ArrayList&lt;Long&gt; dids = new ArrayList&lt;&gt;(mDecks.count());</span>
<span class="nc bnc" id="L2397" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21818)) {</span>
            {
<span class="nc" id="L2399">                long _loopCounter482 = 0;</span>
<span class="nc bnc" id="L2400" title="All 2 branches missed.">                for (long id : mDecks.allIds()) {</span>
<span class="nc" id="L2401">                    ListenerUtil.loopListener.listen(&quot;_loopCounter482&quot;, ++_loopCounter482);</span>
<span class="nc bnc" id="L2402" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21817)) {</span>
<span class="nc bnc" id="L2403" title="All 2 branches missed.">                        if (!mDecks.isDyn(id)) {</span>
<span class="nc bnc" id="L2404" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21816)) {</span>
<span class="nc" id="L2405">                                dids.add(id);</span>
                            }
                        }
                    }
<span class="nc" id="L2409">                }</span>
            }
        }
<span class="nc bnc" id="L2412" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21819)) {</span>
<span class="nc" id="L2413">            notifyProgress.run();</span>
        }
        // cards with odid set when not in a dyn deck
<span class="nc" id="L2416">        ArrayList&lt;Long&gt; ids = mDb.queryLongList(&quot;select id from cards where odid &gt; 0 and did in &quot; + Utils.ids2str(dids));</span>
<span class="nc bnc" id="L2417" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21820)) {</span>
<span class="nc" id="L2418">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2420" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21828)) {</span>
<span class="nc bnc" id="L2421" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21825) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21824) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21823) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(21822) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21821) ? (ids.size() == 0) : (ids.size() != 0))))))) {</span>
<span class="nc bnc" id="L2422" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21826)) {</span>
<span class="nc" id="L2423">                    problems.add(&quot;Fixed &quot; + ids.size() + &quot; card(s) with invalid properties.&quot;);</span>
                }
<span class="nc bnc" id="L2425" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21827)) {</span>
<span class="nc" id="L2426">                    mDb.execute(&quot;update cards set odid=0, odue=0 where id in &quot; + Utils.ids2str(ids));</span>
                }
            }
        }
<span class="nc" id="L2430">        return problems;</span>
    }

    private ArrayList&lt;String&gt; removeOriginalDuePropertyWhereInvalid(Runnable notifyProgress) {
<span class="nc bnc" id="L2434" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21829)) {</span>
<span class="nc" id="L2435">            Timber.d(&quot;removeOriginalDuePropertyWhereInvalid()&quot;);</span>
        }
<span class="nc" id="L2437">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2438" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21830)) {</span>
<span class="nc" id="L2439">            notifyProgress.run();</span>
        }
        // cards with odue set when it shouldn't be
<span class="nc" id="L2442">        ArrayList&lt;Long&gt; ids = mDb.queryLongList(&quot;select id from cards where odue &gt; 0 and (type= &quot; + Consts.CARD_TYPE_LRN + &quot; or queue=&quot; + Consts.QUEUE_TYPE_REV + &quot;) and not odid&quot;);</span>
<span class="nc bnc" id="L2443" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21831)) {</span>
<span class="nc" id="L2444">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2446" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21839)) {</span>
<span class="nc bnc" id="L2447" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21836) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21835) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21834) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(21833) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21832) ? (ids.size() == 0) : (ids.size() != 0))))))) {</span>
<span class="nc bnc" id="L2448" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21837)) {</span>
<span class="nc" id="L2449">                    problems.add(&quot;Fixed &quot; + ids.size() + &quot; card(s) with invalid properties.&quot;);</span>
                }
<span class="nc bnc" id="L2451" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21838)) {</span>
<span class="nc" id="L2452">                    mDb.execute(&quot;update cards set odue=0 where id in &quot; + Utils.ids2str(ids));</span>
                }
            }
        }
<span class="nc" id="L2456">        return problems;</span>
    }

    private ArrayList&lt;String&gt; deleteCardsWithMissingNotes(Runnable notifyProgress) {
<span class="nc bnc" id="L2460" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21840)) {</span>
<span class="nc" id="L2461">            Timber.d(&quot;deleteCardsWithMissingNotes()&quot;);</span>
        }
<span class="nc" id="L2463">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2464" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21841)) {</span>
<span class="nc" id="L2465">            notifyProgress.run();</span>
        }
        // cards with missing notes
<span class="nc" id="L2468">        ArrayList&lt;Long&gt; ids = mDb.queryLongList(&quot;SELECT id FROM cards WHERE nid NOT IN (SELECT id FROM notes)&quot;);</span>
<span class="nc bnc" id="L2469" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21842)) {</span>
<span class="nc" id="L2470">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2472" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21850)) {</span>
<span class="nc bnc" id="L2473" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21847) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21846) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21845) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(21844) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21843) ? (ids.size() == 0) : (ids.size() != 0))))))) {</span>
<span class="nc bnc" id="L2474" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21848)) {</span>
<span class="nc" id="L2475">                    problems.add(&quot;Deleted &quot; + ids.size() + &quot; card(s) with missing note.&quot;);</span>
                }
<span class="nc bnc" id="L2477" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21849)) {</span>
<span class="nc" id="L2478">                    remCards(ids);</span>
                }
            }
        }
<span class="nc" id="L2482">        return problems;</span>
    }

    private ArrayList&lt;String&gt; deleteNotesWithMissingCards(Runnable notifyProgress) {
<span class="nc bnc" id="L2486" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21851)) {</span>
<span class="nc" id="L2487">            Timber.d(&quot;deleteNotesWithMissingCards()&quot;);</span>
        }
<span class="nc" id="L2489">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2490" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21852)) {</span>
<span class="nc" id="L2491">            notifyProgress.run();</span>
        }
        // delete any notes with missing cards
<span class="nc" id="L2494">        ArrayList&lt;Long&gt; ids = mDb.queryLongList(&quot;SELECT id FROM notes WHERE id NOT IN (SELECT DISTINCT nid FROM cards)&quot;);</span>
<span class="nc bnc" id="L2495" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21853)) {</span>
<span class="nc" id="L2496">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2498" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21861)) {</span>
<span class="nc bnc" id="L2499" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21858) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21857) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21856) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(21855) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21854) ? (ids.size() == 0) : (ids.size() != 0))))))) {</span>
<span class="nc bnc" id="L2500" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21859)) {</span>
<span class="nc" id="L2501">                    problems.add(&quot;Deleted &quot; + ids.size() + &quot; note(s) with missing no cards.&quot;);</span>
                }
<span class="nc bnc" id="L2503" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21860)) {</span>
<span class="nc" id="L2504">                    _remNotes(ids);</span>
                }
            }
        }
<span class="nc" id="L2508">        return problems;</span>
    }

    private ArrayList&lt;String&gt; deleteNotesWithWrongFieldCounts(Runnable notifyProgress, JSONObject m) throws JSONException {
<span class="nc bnc" id="L2512" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21862)) {</span>
<span class="nc" id="L2513">            Timber.d(&quot;deleteNotesWithWrongFieldCounts&quot;);</span>
        }
<span class="nc" id="L2515">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
        // notes with invalid field counts
<span class="nc" id="L2517">        ArrayList&lt;Long&gt; ids = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2518" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21863)) {</span>
<span class="nc" id="L2519">            notifyProgress.run();</span>
        }
<span class="nc" id="L2521">        try (Cursor cur = mDb.query(&quot;select id, flds from notes where mid = ?&quot;, m.getLong(&quot;id&quot;))) {</span>
<span class="nc bnc" id="L2522" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21864)) {</span>
<span class="nc" id="L2523">                Timber.i(&quot;cursor size: %d&quot;, cur.getCount());</span>
            }
<span class="nc" id="L2525">            int currentRow = 0;</span>
            // Since we loop through all rows, we only want one exception
            @Nullable
<span class="nc" id="L2528">            Exception firstException = null;</span>
<span class="nc bnc" id="L2529" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21884)) {</span>
                {
<span class="nc" id="L2531">                    long _loopCounter484 = 0;</span>
<span class="nc bnc" id="L2532" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L2533">                        ListenerUtil.loopListener.listen(&quot;_loopCounter484&quot;, ++_loopCounter484);</span>
                        try {
<span class="nc" id="L2535">                            String flds = cur.getString(1);</span>
<span class="nc" id="L2536">                            long id = cur.getLong(0);</span>
<span class="nc" id="L2537">                            int fldsCount = 0;</span>
<span class="nc bnc" id="L2538" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21876)) {</span>
                                {
<span class="nc" id="L2540">                                    long _loopCounter483 = 0;</span>
<span class="nc bnc" id="L2541" title="All 22 branches missed.">                                    for (int i = 0; (ListenerUtil.mutListener.listen(21875) ? (i &gt;= flds.length()) : (ListenerUtil.mutListener.listen(21874) ? (i &lt;= flds.length()) : (ListenerUtil.mutListener.listen(21873) ? (i &gt; flds.length()) : (ListenerUtil.mutListener.listen(21872) ? (i != flds.length()) : (ListenerUtil.mutListener.listen(21871) ? (i == flds.length()) : (i &lt; flds.length())))))); i++) {</span>
<span class="nc" id="L2542">                                        ListenerUtil.loopListener.listen(&quot;_loopCounter483&quot;, ++_loopCounter483);</span>
<span class="nc bnc" id="L2543" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(21870)) {</span>
<span class="nc bnc" id="L2544" title="All 2 branches missed.">                                            if (flds.charAt(i) == 0x1f) {</span>
<span class="nc bnc" id="L2545" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(21869)) {</span>
<span class="nc" id="L2546">                                                    fldsCount++;</span>
                                                }
                                            }
                                        }
                                    }
                                }
                            }
<span class="nc bnc" id="L2553" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21882)) {</span>
<span class="nc bnc" id="L2554" title="All 10 branches missed.">                                if ((ListenerUtil.mutListener.listen(21880) ? (fldsCount % 1) : (ListenerUtil.mutListener.listen(21879) ? (fldsCount / 1) : (ListenerUtil.mutListener.listen(21878) ? (fldsCount * 1) : (ListenerUtil.mutListener.listen(21877) ? (fldsCount - 1) : (fldsCount + 1))))) != m.getJSONArray(&quot;flds&quot;).length()) {</span>
<span class="nc bnc" id="L2555" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(21881)) {</span>
<span class="nc" id="L2556">                                        ids.add(id);</span>
                                    }
                                }
                            }
<span class="nc" id="L2560">                        } catch (IllegalStateException ex) {</span>
<span class="nc bnc" id="L2561" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21865)) {</span>
                                // We store one exception to stop excessive logging
<span class="nc" id="L2563">                                Timber.i(ex, &quot;deleteNotesWithWrongFieldCounts - Exception on row %d. Columns: %d&quot;, currentRow, cur.getColumnCount());</span>
                            }
<span class="nc bnc" id="L2565" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21868)) {</span>
<span class="nc bnc" id="L2566" title="All 2 branches missed.">                                if (firstException == null) {</span>
<span class="nc" id="L2567">                                    String details = String.format(Locale.ROOT, &quot;deleteNotesWithWrongFieldCounts row: %d col: %d&quot;, currentRow, cur.getColumnCount());</span>
<span class="nc bnc" id="L2568" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(21866)) {</span>
<span class="nc" id="L2569">                                        AnkiDroidApp.sendExceptionReport(ex, details);</span>
                                    }
<span class="nc bnc" id="L2571" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(21867)) {</span>
<span class="nc" id="L2572">                                        firstException = ex;</span>
                                    }
                                }
                            }
<span class="nc" id="L2576">                        }</span>
<span class="nc bnc" id="L2577" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21883)) {</span>
<span class="nc" id="L2578">                            currentRow++;</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L2583" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21885)) {</span>
<span class="nc" id="L2584">                Timber.i(&quot;deleteNotesWithWrongFieldCounts - completed successfully&quot;);</span>
            }
<span class="nc bnc" id="L2586" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21886)) {</span>
<span class="nc" id="L2587">                notifyProgress.run();</span>
            }
<span class="nc bnc" id="L2589" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21894)) {</span>
<span class="nc bnc" id="L2590" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(21891) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21890) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21889) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21888) ? (ids.size() != 0) : (ListenerUtil.mutListener.listen(21887) ? (ids.size() == 0) : (ids.size() &gt; 0))))))) {</span>
<span class="nc bnc" id="L2591" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21892)) {</span>
<span class="nc" id="L2592">                        problems.add(&quot;Deleted &quot; + ids.size() + &quot; note(s) with wrong field count.&quot;);</span>
                    }
<span class="nc bnc" id="L2594" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21893)) {</span>
<span class="nc" id="L2595">                        _remNotes(ids);</span>
                    }
                }
            }
        }
<span class="nc" id="L2600">        return problems;</span>
    }

    private ArrayList&lt;String&gt; deleteCardsWithInvalidModelOrdinals(Runnable notifyProgress, Model m) throws JSONException {
<span class="nc bnc" id="L2604" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21895)) {</span>
<span class="nc" id="L2605">            Timber.d(&quot;deleteCardsWithInvalidModelOrdinals()&quot;);</span>
        }
<span class="nc" id="L2607">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2608" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21896)) {</span>
<span class="nc" id="L2609">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2611" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21907)) {</span>
<span class="nc bnc" id="L2612" title="All 2 branches missed.">            if (m.isStd()) {</span>
<span class="nc" id="L2613">                JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc" id="L2614">                ArrayList&lt;Integer&gt; ords = new ArrayList&lt;&gt;(tmpls.length());</span>
<span class="nc bnc" id="L2615" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21898)) {</span>
                    {
<span class="nc" id="L2617">                        long _loopCounter485 = 0;</span>
<span class="nc bnc" id="L2618" title="All 2 branches missed.">                        for (JSONObject tmpl : tmpls.jsonObjectIterable()) {</span>
<span class="nc" id="L2619">                            ListenerUtil.loopListener.listen(&quot;_loopCounter485&quot;, ++_loopCounter485);</span>
<span class="nc bnc" id="L2620" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21897)) {</span>
<span class="nc" id="L2621">                                ords.add(tmpl.getInt(&quot;ord&quot;));</span>
                            }
<span class="nc" id="L2623">                        }</span>
                    }
                }
                // cards with invalid ordinal
<span class="nc" id="L2627">                ArrayList&lt;Long&gt; ids = mDb.queryLongList(&quot;SELECT id FROM cards WHERE ord NOT IN &quot; + Utils.ids2str(ords) + &quot; AND nid IN ( &quot; + &quot;SELECT id FROM notes WHERE mid = ?)&quot;, m.getLong(&quot;id&quot;));</span>
<span class="nc bnc" id="L2628" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21906)) {</span>
<span class="nc bnc" id="L2629" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(21903) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21902) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21901) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21900) ? (ids.size() != 0) : (ListenerUtil.mutListener.listen(21899) ? (ids.size() == 0) : (ids.size() &gt; 0))))))) {</span>
<span class="nc bnc" id="L2630" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21904)) {</span>
<span class="nc" id="L2631">                            problems.add(&quot;Deleted &quot; + ids.size() + &quot; card(s) with missing template.&quot;);</span>
                        }
<span class="nc bnc" id="L2633" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21905)) {</span>
<span class="nc" id="L2634">                            remCards(ids);</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L2640">        return problems;</span>
    }

    private ArrayList&lt;String&gt; deleteNotesWithMissingModel(Runnable notifyProgress) {
<span class="nc bnc" id="L2644" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21908)) {</span>
<span class="nc" id="L2645">            Timber.d(&quot;deleteNotesWithMissingModel()&quot;);</span>
        }
<span class="nc" id="L2647">        ArrayList&lt;String&gt; problems = new ArrayList&lt;&gt;(1);</span>
<span class="nc bnc" id="L2648" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21909)) {</span>
            // note types with a missing model
<span class="nc" id="L2650">            notifyProgress.run();</span>
        }
<span class="nc" id="L2652">        ArrayList&lt;Long&gt; ids = mDb.queryLongList(&quot;SELECT id FROM notes WHERE mid NOT IN &quot; + Utils.ids2str(getModels().ids()));</span>
<span class="nc bnc" id="L2653" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21910)) {</span>
<span class="nc" id="L2654">            notifyProgress.run();</span>
        }
<span class="nc bnc" id="L2656" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21918)) {</span>
<span class="nc bnc" id="L2657" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21915) ? (ids.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21914) ? (ids.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21913) ? (ids.size() &gt; 0) : (ListenerUtil.mutListener.listen(21912) ? (ids.size() &lt; 0) : (ListenerUtil.mutListener.listen(21911) ? (ids.size() == 0) : (ids.size() != 0))))))) {</span>
<span class="nc bnc" id="L2658" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21916)) {</span>
<span class="nc" id="L2659">                    problems.add(&quot;Deleted &quot; + ids.size() + &quot; note(s) with missing note type.&quot;);</span>
                }
<span class="nc bnc" id="L2661" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21917)) {</span>
<span class="nc" id="L2662">                    _remNotes(ids);</span>
                }
            }
        }
<span class="nc" id="L2666">        return problems;</span>
    }

    public void optimize(Runnable progressCallback) {
<span class="nc bnc" id="L2670" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21919)) {</span>
<span class="nc" id="L2671">            Timber.i(&quot;executing VACUUM statement&quot;);</span>
        }
<span class="nc bnc" id="L2673" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21920)) {</span>
<span class="nc" id="L2674">            progressCallback.run();</span>
        }
<span class="nc bnc" id="L2676" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21921)) {</span>
<span class="nc" id="L2677">            mDb.execute(&quot;VACUUM&quot;);</span>
        }
<span class="nc bnc" id="L2679" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21922)) {</span>
<span class="nc" id="L2680">            Timber.i(&quot;executing ANALYZE statement&quot;);</span>
        }
<span class="nc bnc" id="L2682" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21923)) {</span>
<span class="nc" id="L2683">            progressCallback.run();</span>
        }
<span class="nc bnc" id="L2685" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21924)) {</span>
<span class="nc" id="L2686">            mDb.execute(&quot;ANALYZE&quot;);</span>
        }
<span class="nc" id="L2688">    }</span>

    private void fixIntegrityProgress(TaskManager.ProgressCallback&lt;String&gt; progressCallback, int current, int total) {
<span class="nc bnc" id="L2691" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21925)) {</span>
<span class="nc" id="L2692">            progressCallback.publishProgress(progressCallback.getResources().getString(R.string.check_db_message) + &quot; &quot; + current + &quot; / &quot; + total);</span>
        }
<span class="nc" id="L2694">    }</span>

    /**
     * Track database corruption problems and post analytics events for tracking
     *
     * @param integrityCheckProblems list of problems, the first 10 will be used
     */
    private void logProblems(List&lt;String&gt; integrityCheckProblems) {
<span class="nc bnc" id="L2702" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21947)) {</span>
<span class="nc bnc" id="L2703" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21930) ? (integrityCheckProblems.size() &gt;= 0) : (ListenerUtil.mutListener.listen(21929) ? (integrityCheckProblems.size() &lt;= 0) : (ListenerUtil.mutListener.listen(21928) ? (integrityCheckProblems.size() &lt; 0) : (ListenerUtil.mutListener.listen(21927) ? (integrityCheckProblems.size() != 0) : (ListenerUtil.mutListener.listen(21926) ? (integrityCheckProblems.size() == 0) : (integrityCheckProblems.size() &gt; 0))))))) {</span>
<span class="nc" id="L2704">                StringBuffer additionalInfo = new StringBuffer();</span>
<span class="nc bnc" id="L2705" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21945)) {</span>
                    {
<span class="nc" id="L2707">                        long _loopCounter486 = 0;</span>
<span class="nc bnc" id="L2708" title="All 90 branches missed.">                        for (int i = 0; ((ListenerUtil.mutListener.listen(21944) ? (((ListenerUtil.mutListener.listen(21938) ? (i &gt;= 10) : (ListenerUtil.mutListener.listen(21937) ? (i &lt;= 10) : (ListenerUtil.mutListener.listen(21936) ? (i &gt; 10) : (ListenerUtil.mutListener.listen(21935) ? (i != 10) : (ListenerUtil.mutListener.listen(21934) ? (i == 10) : (i &lt; 10))))))) || ((ListenerUtil.mutListener.listen(21943) ? (integrityCheckProblems.size() &gt;= i) : (ListenerUtil.mutListener.listen(21942) ? (integrityCheckProblems.size() &lt;= i) : (ListenerUtil.mutListener.listen(21941) ? (integrityCheckProblems.size() &lt; i) : (ListenerUtil.mutListener.listen(21940) ? (integrityCheckProblems.size() != i) : (ListenerUtil.mutListener.listen(21939) ? (integrityCheckProblems.size() == i) : (integrityCheckProblems.size() &gt; i)))))))) : (((ListenerUtil.mutListener.listen(21938) ? (i &gt;= 10) : (ListenerUtil.mutListener.listen(21937) ? (i &lt;= 10) : (ListenerUtil.mutListener.listen(21936) ? (i &gt; 10) : (ListenerUtil.mutListener.listen(21935) ? (i != 10) : (ListenerUtil.mutListener.listen(21934) ? (i == 10) : (i &lt; 10))))))) &amp;&amp; ((ListenerUtil.mutListener.listen(21943) ? (integrityCheckProblems.size() &gt;= i) : (ListenerUtil.mutListener.listen(21942) ? (integrityCheckProblems.size() &lt;= i) : (ListenerUtil.mutListener.listen(21941) ? (integrityCheckProblems.size() &lt; i) : (ListenerUtil.mutListener.listen(21940) ? (integrityCheckProblems.size() != i) : (ListenerUtil.mutListener.listen(21939) ? (integrityCheckProblems.size() == i) : (integrityCheckProblems.size() &gt; i)))))))))); i++) {</span>
<span class="nc" id="L2709">                            ListenerUtil.loopListener.listen(&quot;_loopCounter486&quot;, ++_loopCounter486);</span>
<span class="nc bnc" id="L2710" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21932)) {</span>
<span class="nc" id="L2711">                                additionalInfo.append(integrityCheckProblems.get(i)).append(&quot;\n&quot;);</span>
                            }
<span class="nc bnc" id="L2713" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21933)) {</span>
                                // log analytics event so we can see trends if user allows it
<span class="nc" id="L2715">                                UsageAnalytics.sendAnalyticsEvent(&quot;DatabaseCorruption&quot;, integrityCheckProblems.get(i));</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L2720" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21946)) {</span>
<span class="nc" id="L2721">                    Timber.i(&quot;fixIntegrity() Problem list (limited to first 10):\n%s&quot;, additionalInfo);</span>
                }
<span class="nc" id="L2723">            } else {</span>
<span class="nc bnc" id="L2724" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21931)) {</span>
<span class="nc" id="L2725">                    Timber.i(&quot;fixIntegrity() no problems found&quot;);</span>
                }
            }
        }
<span class="nc" id="L2729">    }</span>

    public void log(Object... args) {
<span class="pc bpc" id="L2732" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21948)) {</span>
<span class="fc bfc" id="L2733" title="All 2 branches covered.">            if (!mDebugLog) {</span>
<span class="fc" id="L2734">                return;</span>
            }
        }
<span class="fc" id="L2737">        StackTraceElement trace = Thread.currentThread().getStackTrace()[3];</span>
<span class="pc bpc" id="L2738" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21956)) {</span>
            {
<span class="fc" id="L2740">                long _loopCounter487 = 0;</span>
                // Overwrite any args that need special handling for an appropriate string representation
<span class="pc bpc" id="L2742" title="15 of 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(21955) ? (i &gt;= args.length) : (ListenerUtil.mutListener.listen(21954) ? (i &lt;= args.length) : (ListenerUtil.mutListener.listen(21953) ? (i &gt; args.length) : (ListenerUtil.mutListener.listen(21952) ? (i != args.length) : (ListenerUtil.mutListener.listen(21951) ? (i == args.length) : (i &lt; args.length)))))); i++) {</span>
<span class="fc" id="L2743">                    ListenerUtil.loopListener.listen(&quot;_loopCounter487&quot;, ++_loopCounter487);</span>
<span class="pc bpc" id="L2744" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21950)) {</span>
<span class="pc bpc" id="L2745" title="1 of 2 branches missed.">                        if (args[i] instanceof long[]) {</span>
<span class="nc bnc" id="L2746" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21949)) {</span>
<span class="nc" id="L2747">                                args[i] = Arrays.toString((long[]) args[i]);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L2754">        String s = String.format(&quot;[%s] %s:%s(): %s&quot;, getTime().intTime(), trace.getFileName(), trace.getMethodName(), TextUtils.join(&quot;,  &quot;, args));</span>
<span class="pc bpc" id="L2755" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21957)) {</span>
<span class="fc" id="L2756">            writeLog(s);</span>
        }
<span class="fc" id="L2758">    }</span>

    private void writeLog(String s) {
<span class="pc bpc" id="L2761" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21960)) {</span>
<span class="pc bpc" id="L2762" title="1 of 2 branches missed.">            if (mLogHnd != null) {</span>
                try {
<span class="pc bpc" id="L2764" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21959)) {</span>
<span class="fc" id="L2765">                        mLogHnd.println(s);</span>
                    }
<span class="nc" id="L2767">                } catch (Exception e) {</span>
<span class="nc bnc" id="L2768" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21958)) {</span>
<span class="nc" id="L2769">                        Timber.w(e, &quot;Failed to write to collection log&quot;);</span>
                    }
<span class="fc" id="L2771">                }</span>
            }
        }
<span class="pc bpc" id="L2774" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21961)) {</span>
<span class="fc" id="L2775">            Timber.d(s);</span>
        }
<span class="fc" id="L2777">    }</span>

    private void _openLog() {
<span class="pc bpc" id="L2780" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21962)) {</span>
<span class="fc" id="L2781">            Timber.i(&quot;Opening Collection Log&quot;);</span>
        }
<span class="pc bpc" id="L2783" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21963)) {</span>
<span class="fc bfc" id="L2784" title="All 2 branches covered.">            if (!mDebugLog) {</span>
<span class="fc" id="L2785">                return;</span>
            }
        }
        try {
<span class="fc" id="L2789">            File lpath = new File(mPath.replaceFirst(&quot;\\.anki2$&quot;, &quot;.log&quot;));</span>
<span class="pc bpc" id="L2790" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21983)) {</span>
<span class="pc bpc" id="L2791" title="610 of 626 branches missed.">                if ((ListenerUtil.mutListener.listen(21979) ? (lpath.exists() || (ListenerUtil.mutListener.listen(21978) ? (lpath.length() &gt;= (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (ListenerUtil.mutListener.listen(21977) ? (lpath.length() &lt;= (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (ListenerUtil.mutListener.listen(21976) ? (lpath.length() &lt; (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (ListenerUtil.mutListener.listen(21975) ? (lpath.length() != (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (ListenerUtil.mutListener.listen(21974) ? (lpath.length() == (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (lpath.length() &gt; (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))))))))) : (lpath.exists() &amp;&amp; (ListenerUtil.mutListener.listen(21978) ? (lpath.length() &gt;= (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (ListenerUtil.mutListener.listen(21977) ? (lpath.length() &lt;= (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (ListenerUtil.mutListener.listen(21976) ? (lpath.length() &lt; (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (ListenerUtil.mutListener.listen(21975) ? (lpath.length() != (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (ListenerUtil.mutListener.listen(21974) ? (lpath.length() == (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))) : (lpath.length() &gt; (ListenerUtil.mutListener.listen(21973) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) % 1024) : (ListenerUtil.mutListener.listen(21972) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) / 1024) : (ListenerUtil.mutListener.listen(21971) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) - 1024) : (ListenerUtil.mutListener.listen(21970) ? ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) + 1024) : ((ListenerUtil.mutListener.listen(21969) ? (10 % 1024) : (ListenerUtil.mutListener.listen(21968) ? (10 / 1024) : (ListenerUtil.mutListener.listen(21967) ? (10 - 1024) : (ListenerUtil.mutListener.listen(21966) ? (10 + 1024) : (10 * 1024))))) * 1024)))))))))))))) {</span>
<span class="nc" id="L2792">                    File lpath2 = new File(lpath + &quot;.old&quot;);</span>
<span class="nc bnc" id="L2793" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21981)) {</span>
<span class="nc bnc" id="L2794" title="All 2 branches missed.">                        if (lpath2.exists()) {</span>
<span class="nc bnc" id="L2795" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21980)) {</span>
<span class="nc" id="L2796">                                lpath2.delete();</span>
                            }
                        }
                    }
<span class="nc bnc" id="L2800" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21982)) {</span>
<span class="nc" id="L2801">                        lpath.renameTo(lpath2);</span>
                    }
                }
            }
<span class="pc bpc" id="L2805" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21984)) {</span>
<span class="fc" id="L2806">                mLogHnd = new PrintWriter(new BufferedWriter(new FileWriter(lpath, true)), true);</span>
            }
<span class="nc" id="L2808">        } catch (IOException e) {</span>
<span class="nc bnc" id="L2809" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21964)) {</span>
                // turn off logging if we can't open the log file
<span class="nc" id="L2811">                Timber.e(&quot;Failed to open collection.log file - disabling logging&quot;);</span>
            }
<span class="nc bnc" id="L2813" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21965)) {</span>
<span class="nc" id="L2814">                mDebugLog = false;</span>
            }
<span class="fc" id="L2816">        }</span>
<span class="fc" id="L2817">    }</span>

    private void _closeLog() {
<span class="pc bpc" id="L2820" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21985)) {</span>
<span class="fc" id="L2821">            Timber.i(&quot;Closing Collection Log&quot;);</span>
        }
<span class="pc bpc" id="L2823" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21988)) {</span>
<span class="pc bpc" id="L2824" title="1 of 2 branches missed.">            if (mLogHnd != null) {</span>
<span class="nc bnc" id="L2825" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21986)) {</span>
<span class="nc" id="L2826">                    mLogHnd.close();</span>
                }
<span class="nc bnc" id="L2828" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21987)) {</span>
<span class="nc" id="L2829">                    mLogHnd = null;</span>
                }
            }
        }
<span class="fc" id="L2833">    }</span>

    /**
     * Card Flags *****************************************************************************************************
     */
    public void setUserFlag(int flag, List&lt;Long&gt; cids) {
<span class="nc bnc" id="L2839" title="All 92 branches missed.">        assert ((ListenerUtil.mutListener.listen(21999) ? ((ListenerUtil.mutListener.listen(21993) ? (0 &gt;= flag) : (ListenerUtil.mutListener.listen(21992) ? (0 &gt; flag) : (ListenerUtil.mutListener.listen(21991) ? (0 &lt; flag) : (ListenerUtil.mutListener.listen(21990) ? (0 != flag) : (ListenerUtil.mutListener.listen(21989) ? (0 == flag) : (0 &lt;= flag)))))) || (ListenerUtil.mutListener.listen(21998) ? (flag &gt;= 7) : (ListenerUtil.mutListener.listen(21997) ? (flag &gt; 7) : (ListenerUtil.mutListener.listen(21996) ? (flag &lt; 7) : (ListenerUtil.mutListener.listen(21995) ? (flag != 7) : (ListenerUtil.mutListener.listen(21994) ? (flag == 7) : (flag &lt;= 7))))))) : ((ListenerUtil.mutListener.listen(21993) ? (0 &gt;= flag) : (ListenerUtil.mutListener.listen(21992) ? (0 &gt; flag) : (ListenerUtil.mutListener.listen(21991) ? (0 &lt; flag) : (ListenerUtil.mutListener.listen(21990) ? (0 != flag) : (ListenerUtil.mutListener.listen(21989) ? (0 == flag) : (0 &lt;= flag)))))) &amp;&amp; (ListenerUtil.mutListener.listen(21998) ? (flag &gt;= 7) : (ListenerUtil.mutListener.listen(21997) ? (flag &gt; 7) : (ListenerUtil.mutListener.listen(21996) ? (flag &lt; 7) : (ListenerUtil.mutListener.listen(21995) ? (flag != 7) : (ListenerUtil.mutListener.listen(21994) ? (flag == 7) : (flag &lt;= 7)))))))));</span>
<span class="nc bnc" id="L2840" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22000)) {</span>
<span class="nc" id="L2841">            mDb.execute(&quot;update cards set flags = (flags &amp; ~?) | ?, usn=?, mod=? where id in &quot; + Utils.ids2str(cids), 0b111, flag, usn(), getTime().intTime());</span>
        }
<span class="nc" id="L2843">    }</span>

    public DB getDb() {
<span class="fc" id="L2846">        return mDb;</span>
    }

    public Decks getDecks() {
<span class="fc" id="L2850">        return mDecks;</span>
    }

    public Media getMedia() {
<span class="nc" id="L2854">        return mMedia;</span>
    }

    /**
     * On first call, load the model if it was not loaded.
     *
     * Synchronized to ensure that loading does not occur twice.
     * Normally the first call occurs in the background when
     * collection is loaded.  The only exception being if the user
     * perform an action (e.g. review) so quickly that
     * loadModelsInBackground had no time to be called. In this case
     * it will instantly finish. Note that loading model is a
     * bottleneck anyway, so background call lose all interest.
     *
     * @return The model manager
     */
    public synchronized Models getModels() {
<span class="pc bpc" id="L2871" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22003)) {</span>
<span class="fc bfc" id="L2872" title="All 2 branches covered.">            if (mModels == null) {</span>
<span class="pc bpc" id="L2873" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22001)) {</span>
<span class="fc" id="L2874">                    mModels = new Models(this);</span>
                }
<span class="pc bpc" id="L2876" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22002)) {</span>
<span class="fc" id="L2877">                    mModels.load(loadColumn(&quot;models&quot;));</span>
                }
            }
        }
<span class="fc" id="L2881">        return mModels;</span>
    }

    /**
     * Check if this collection is valid.
     */
    @SuppressWarnings(&quot;BooleanMethodIsAlwaysInverted&quot;)
    public boolean validCollection() {
        // TODO: more validation code
<span class="nc" id="L2890">        return getModels().validateModel();</span>
    }

    public JSONObject getConf() {
<span class="fc" id="L2894">        return mConf;</span>
    }

    public void setConf(JSONObject conf) {
<span class="nc bnc" id="L2898" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22004)) {</span>
            // dae/anki#347
<span class="nc" id="L2900">            Upgrade.upgradeJSONIfNecessary(this, conf, &quot;sortBackwards&quot;, false);</span>
        }
<span class="nc bnc" id="L2902" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22005)) {</span>
<span class="nc" id="L2903">            mConf = conf;</span>
        }
<span class="nc" id="L2905">    }</span>

    public long getScm() {
<span class="fc" id="L2908">        return mScm;</span>
    }

    public boolean getServer() {
<span class="fc" id="L2912">        return mServer;</span>
    }

    public void setLs(long ls) {
<span class="nc bnc" id="L2916" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22006)) {</span>
<span class="nc" id="L2917">            mLs = ls;</span>
        }
<span class="nc" id="L2919">    }</span>

    public void setUsnAfterSync(int usn) {
<span class="nc bnc" id="L2922" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22007)) {</span>
<span class="nc" id="L2923">            mUsn = usn;</span>
        }
<span class="nc" id="L2925">    }</span>

    public long getMod() {
<span class="nc" id="L2928">        return mMod;</span>
    }

    /* this getter is only for syncing routines, use usn() instead elsewhere */
    public int getUsnForSync() {
<span class="nc" id="L2933">        return mUsn;</span>
    }

    public Tags getTags() {
<span class="fc" id="L2937">        return mTags;</span>
    }

    public long getCrt() {
<span class="fc" id="L2941">        return mCrt;</span>
    }

    public Calendar crtCalendar() {
<span class="pc bpc" id="L2945" title="4 of 8 branches missed.">        return Time.calendar((ListenerUtil.mutListener.listen(22011) ? (getCrt() % 1000) : (ListenerUtil.mutListener.listen(22010) ? (getCrt() / 1000) : (ListenerUtil.mutListener.listen(22009) ? (getCrt() - 1000) : (ListenerUtil.mutListener.listen(22008) ? (getCrt() + 1000) : (getCrt() * 1000))))));</span>
    }

    public GregorianCalendar crtGregorianCalendar() {
<span class="nc bnc" id="L2949" title="All 8 branches missed.">        return Time.gregorianCalendar((ListenerUtil.mutListener.listen(22015) ? (getCrt() % 1000) : (ListenerUtil.mutListener.listen(22014) ? (getCrt() / 1000) : (ListenerUtil.mutListener.listen(22013) ? (getCrt() - 1000) : (ListenerUtil.mutListener.listen(22012) ? (getCrt() + 1000) : (getCrt() * 1000))))));</span>
    }

    public void setCrt(long crt) {
<span class="nc bnc" id="L2953" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22016)) {</span>
<span class="nc" id="L2954">            mCrt = crt;</span>
        }
<span class="nc" id="L2956">    }</span>

    public AbstractSched getSched() {
<span class="nc" id="L2959">        return mSched;</span>
    }

    public String getPath() {
<span class="fc" id="L2963">        return mPath;</span>
    }

    public void setServer(boolean server) {
<span class="nc bnc" id="L2967" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22017)) {</span>
<span class="nc" id="L2968">            mServer = server;</span>
        }
<span class="nc" id="L2970">    }</span>

    public boolean getDirty() {
<span class="nc" id="L2973">        return mDty;</span>
    }

    /**
     * @return The context that created this Collection.
     */
    public Context getContext() {
<span class="nc" id="L2980">        return mContext;</span>
    }

    /**
     * Not in libAnki
     */
    @CheckResult
    public List&lt;Long&gt; filterToValidCards(long[] cards) {
<span class="nc" id="L2988">        return getDb().queryLongList(&quot;select id from cards where id in &quot; + Utils.ids2str(cards));</span>
    }

    public int queryVer() throws UnknownDatabaseVersionException {
        try {
<span class="nc" id="L2993">            return getDb().queryScalar(&quot;select ver from col&quot;);</span>
<span class="nc" id="L2994">        } catch (Exception e) {</span>
<span class="nc" id="L2995">            throw new UnknownDatabaseVersionException(e);</span>
        }
    }

    // This duplicates _loadScheduler (but returns the value and sets the report limit).
    public AbstractSched createScheduler(int reportLimit) {
<span class="nc" id="L3001">        int ver = schedVer();</span>
<span class="nc bnc" id="L3002" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22030)) {</span>
<span class="nc bnc" id="L3003" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(22022) ? (ver &gt;= 1) : (ListenerUtil.mutListener.listen(22021) ? (ver &lt;= 1) : (ListenerUtil.mutListener.listen(22020) ? (ver &gt; 1) : (ListenerUtil.mutListener.listen(22019) ? (ver &lt; 1) : (ListenerUtil.mutListener.listen(22018) ? (ver != 1) : (ver == 1))))))) {</span>
<span class="nc bnc" id="L3004" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22029)) {</span>
<span class="nc" id="L3005">                    mSched = new Sched(this);</span>
                }
<span class="nc bnc" id="L3007" title="All 22 branches missed.">            } else if ((ListenerUtil.mutListener.listen(22027) ? (ver &gt;= 2) : (ListenerUtil.mutListener.listen(22026) ? (ver &lt;= 2) : (ListenerUtil.mutListener.listen(22025) ? (ver &gt; 2) : (ListenerUtil.mutListener.listen(22024) ? (ver &lt; 2) : (ListenerUtil.mutListener.listen(22023) ? (ver != 2) : (ver == 2))))))) {</span>
<span class="nc bnc" id="L3008" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(22028)) {</span>
<span class="nc" id="L3009">                    mSched = new SchedV2(this);</span>
                }
            }
        }
<span class="nc bnc" id="L3013" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22031)) {</span>
<span class="nc" id="L3014">            mSched.setReportLimit(reportLimit);</span>
        }
<span class="nc" id="L3016">        return mSched;</span>
    }

    /**
     * Allows a mock db to be inserted for testing
     */
    @VisibleForTesting
    public void setDb(DB database) {
<span class="nc bnc" id="L3024" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(22032)) {</span>
<span class="nc" id="L3025">            this.mDb = database;</span>
        }
<span class="nc" id="L3027">    }</span>

    public static class CheckDatabaseResult {

<span class="nc" id="L3031">        private final List&lt;String&gt; mProblems = new ArrayList&lt;&gt;();</span>

        private final long mOldSize;

        private int mFixedCardsWithNoHomeDeckCount;

        private long mNewSize;

        /**
         * When the database was locked
         */
<span class="nc" id="L3042">        private boolean mLocked = false;</span>

        /**
         * When the check failed with an error (or was locked)
         */
<span class="nc" id="L3047">        private boolean mFailed = false;</span>

<span class="nc" id="L3049">        public CheckDatabaseResult(long oldSize) {</span>
<span class="nc" id="L3050">            mOldSize = oldSize;</span>
<span class="nc" id="L3051">        }</span>

        public void addAll(List&lt;String&gt; strings) {
<span class="nc bnc" id="L3054" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22033)) {</span>
<span class="nc" id="L3055">                mProblems.addAll(strings);</span>
            }
<span class="nc" id="L3057">        }</span>

        public void setCardsWithFixedHomeDeckCount(int count) {
<span class="nc bnc" id="L3060" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22034)) {</span>
<span class="nc" id="L3061">                this.mFixedCardsWithNoHomeDeckCount = count;</span>
            }
<span class="nc" id="L3063">        }</span>

        public boolean hasProblems() {
<span class="nc bnc" id="L3066" title="All 22 branches missed.">            return (ListenerUtil.mutListener.listen(22039) ? (mProblems.size() &gt;= 0) : (ListenerUtil.mutListener.listen(22038) ? (mProblems.size() &lt;= 0) : (ListenerUtil.mutListener.listen(22037) ? (mProblems.size() &lt; 0) : (ListenerUtil.mutListener.listen(22036) ? (mProblems.size() != 0) : (ListenerUtil.mutListener.listen(22035) ? (mProblems.size() == 0) : (mProblems.size() &gt; 0))))));</span>
        }

        public List&lt;String&gt; getProblems() {
<span class="nc" id="L3070">            return mProblems;</span>
        }

        public int getCardsWithFixedHomeDeckCount() {
<span class="nc" id="L3074">            return mFixedCardsWithNoHomeDeckCount;</span>
        }

        public void setNewSize(long size) {
<span class="nc bnc" id="L3078" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22040)) {</span>
<span class="nc" id="L3079">                this.mNewSize = size;</span>
            }
<span class="nc" id="L3081">        }</span>

        public double getSizeChangeInKb() {
<span class="nc bnc" id="L3084" title="All 48 branches missed.">            return (ListenerUtil.mutListener.listen(22048) ? (((ListenerUtil.mutListener.listen(22044) ? (mOldSize % mNewSize) : (ListenerUtil.mutListener.listen(22043) ? (mOldSize / mNewSize) : (ListenerUtil.mutListener.listen(22042) ? (mOldSize * mNewSize) : (ListenerUtil.mutListener.listen(22041) ? (mOldSize + mNewSize) : (mOldSize - mNewSize)))))) % 1024.0) : (ListenerUtil.mutListener.listen(22047) ? (((ListenerUtil.mutListener.listen(22044) ? (mOldSize % mNewSize) : (ListenerUtil.mutListener.listen(22043) ? (mOldSize / mNewSize) : (ListenerUtil.mutListener.listen(22042) ? (mOldSize * mNewSize) : (ListenerUtil.mutListener.listen(22041) ? (mOldSize + mNewSize) : (mOldSize - mNewSize)))))) * 1024.0) : (ListenerUtil.mutListener.listen(22046) ? (((ListenerUtil.mutListener.listen(22044) ? (mOldSize % mNewSize) : (ListenerUtil.mutListener.listen(22043) ? (mOldSize / mNewSize) : (ListenerUtil.mutListener.listen(22042) ? (mOldSize * mNewSize) : (ListenerUtil.mutListener.listen(22041) ? (mOldSize + mNewSize) : (mOldSize - mNewSize)))))) - 1024.0) : (ListenerUtil.mutListener.listen(22045) ? (((ListenerUtil.mutListener.listen(22044) ? (mOldSize % mNewSize) : (ListenerUtil.mutListener.listen(22043) ? (mOldSize / mNewSize) : (ListenerUtil.mutListener.listen(22042) ? (mOldSize * mNewSize) : (ListenerUtil.mutListener.listen(22041) ? (mOldSize + mNewSize) : (mOldSize - mNewSize)))))) + 1024.0) : (((ListenerUtil.mutListener.listen(22044) ? (mOldSize % mNewSize) : (ListenerUtil.mutListener.listen(22043) ? (mOldSize / mNewSize) : (ListenerUtil.mutListener.listen(22042) ? (mOldSize * mNewSize) : (ListenerUtil.mutListener.listen(22041) ? (mOldSize + mNewSize) : (mOldSize - mNewSize)))))) / 1024.0)))));</span>
        }

        public void setFailed(boolean failedIntegrity) {
<span class="nc bnc" id="L3088" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22049)) {</span>
<span class="nc" id="L3089">                this.mFailed = failedIntegrity;</span>
            }
<span class="nc" id="L3091">        }</span>

        public CheckDatabaseResult markAsFailed() {
<span class="nc bnc" id="L3094" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22050)) {</span>
<span class="nc" id="L3095">                this.setFailed(true);</span>
            }
<span class="nc" id="L3097">            return this;</span>
        }

        public CheckDatabaseResult markAsLocked() {
<span class="nc bnc" id="L3101" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22051)) {</span>
<span class="nc" id="L3102">                this.setLocked(true);</span>
            }
<span class="nc" id="L3104">            return markAsFailed();</span>
        }

        private void setLocked(boolean value) {
<span class="nc bnc" id="L3108" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(22052)) {</span>
<span class="nc" id="L3109">                mLocked = value;</span>
            }
<span class="nc" id="L3111">        }</span>

        public boolean getDatabaseLocked() {
<span class="nc" id="L3114">            return mLocked;</span>
        }

        public boolean getFailed() {
<span class="nc" id="L3118">            return mFailed;</span>
        }
    }

    @NonNull
    public Time getTime() {
<span class="fc" id="L3124">        return mTime;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>