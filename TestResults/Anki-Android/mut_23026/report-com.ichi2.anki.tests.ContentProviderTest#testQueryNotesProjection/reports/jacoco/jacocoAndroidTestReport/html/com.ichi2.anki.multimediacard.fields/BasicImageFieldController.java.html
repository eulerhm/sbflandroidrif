<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BasicImageFieldController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki.multimediacard.fields</a> &gt; <span class="el_source">BasicImageFieldController.java</span></div><h1>BasicImageFieldController.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2013 Bibek Shrestha &lt;bibekshrestha@gmail.com&gt;                          *
 *  Copyright (c) 2013 Zaur Molotnikov &lt;qutorial@gmail.com&gt;                              *
 *  Copyright (c) 2013 Nicolas Raoul &lt;nicolas.raoul@gmail.com&gt;                           *
 *  Copyright (c) 2013 Flavio Lerda &lt;flerda@gmail.com&gt;                                   *
 *  Copyright (c) 2020 Mike Hardy &lt;github@mikehardy.net&gt;                                 *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.anki.multimediacard.fields;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.content.ClipData;
import android.content.ContentUris;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.Color;
import android.hardware.camera2.CameraAccessException;
import android.hardware.camera2.CameraManager;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.provider.MediaStore;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.VisibleForTesting;
import androidx.core.content.ContentResolverCompat;
import androidx.core.content.FileProvider;
import android.text.TextUtils;
import android.text.format.Formatter;
import android.provider.DocumentsContract;
import android.util.DisplayMetrics;
import android.view.Gravity;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.LinearLayout.LayoutParams;
import android.widget.TextView;
import com.ichi2.anki.AnkiDroidApp;
import com.ichi2.anki.R;
import com.ichi2.anki.UIUtils;
import com.ichi2.compat.CompatHelper;
import com.ichi2.ui.FixedEditText;
import com.ichi2.utils.BitmapUtil;
import com.ichi2.utils.ExifUtil;
import com.ichi2.utils.FileUtil;
import com.ichi2.utils.Permissions;
import com.afollestad.materialdialogs.MaterialDialog;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import androidx.core.util.Pair;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L76">public class BasicImageFieldController extends FieldControllerBase implements IFieldController {</span>

    @VisibleForTesting
    static final int ACTIVITY_SELECT_IMAGE = 1;

    private static final int ACTIVITY_TAKE_PICTURE = 2;

    private static final int ACTIVITY_CROP_PICTURE = 3;

    private static final int IMAGE_SAVE_MAX_WIDTH = 1920;

    private ImageView mImagePreview;

    private TextView mImageFileSize;

    private TextView mImageFileSizeWarning;

<span class="nc" id="L93">    private ImageViewModel mViewModel = new ImageViewModel(null, null);</span>

    // save the latest path to prevent from cropping or taking photo action canceled
    @Nullable
    private String mPreviousImagePath;

    @Nullable
    private Uri mPreviousImageUri;

    // system provided 'External Cache Dir' with &quot;temp-photos&quot; on it
    @Nullable
    private String mAnkiCacheDirectory;

    // e.g.  '/self/primary/Android/data/com.ichi2.anki.AnkiDroid/cache/temp-photos'
<span class="nc" id="L107">    private DisplayMetrics mMetrics = null;</span>

<span class="nc" id="L109">    private Button mCropButton = null;</span>

    private int getMaxImageSize() {
<span class="nc" id="L112">        DisplayMetrics metrics = getDisplayMetrics();</span>
<span class="nc" id="L113">        int height = metrics.heightPixels;</span>
<span class="nc" id="L114">        int width = metrics.widthPixels;</span>
<span class="nc bnc" id="L115" title="All 16 branches missed.">        return (int) Math.min((ListenerUtil.mutListener.listen(1573) ? (height % 0.4) : (ListenerUtil.mutListener.listen(1572) ? (height / 0.4) : (ListenerUtil.mutListener.listen(1571) ? (height - 0.4) : (ListenerUtil.mutListener.listen(1570) ? (height + 0.4) : (height * 0.4))))), (ListenerUtil.mutListener.listen(1577) ? (width % 0.6) : (ListenerUtil.mutListener.listen(1576) ? (width / 0.6) : (ListenerUtil.mutListener.listen(1575) ? (width - 0.6) : (ListenerUtil.mutListener.listen(1574) ? (width + 0.6) : (width * 0.6))))));</span>
    }

    public void loadInstanceState(Bundle savedInstanceState) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1579)) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (savedInstanceState == null) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1578)) {</span>
<span class="nc" id="L122">                    Timber.i(&quot;loadInstanceState but null so nothing to load&quot;);</span>
                }
<span class="nc" id="L124">                return;</span>
            }
        }
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1580)) {</span>
<span class="nc" id="L128">            Timber.i(&quot;loadInstanceState loading saved state...&quot;);</span>
        }
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1581)) {</span>
<span class="nc" id="L131">            mViewModel = ImageViewModel.fromBundle(savedInstanceState);</span>
        }
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1582)) {</span>
<span class="nc" id="L134">            mPreviousImagePath = savedInstanceState.getString(&quot;mPreviousImagePath&quot;);</span>
        }
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1583)) {</span>
<span class="nc" id="L137">            mPreviousImageUri = savedInstanceState.getParcelable(&quot;mPreviousImageUri&quot;);</span>
        }
<span class="nc" id="L139">    }</span>

    @Override
    public Bundle saveInstanceState() {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1584)) {</span>
<span class="nc" id="L144">            Timber.d(&quot;saveInstanceState&quot;);</span>
        }
<span class="nc" id="L146">        Bundle savedInstanceState = new Bundle();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1585)) {</span>
<span class="nc" id="L148">            mViewModel.enrich(savedInstanceState);</span>
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1586)) {</span>
<span class="nc" id="L151">            savedInstanceState.putString(&quot;mPreviousImagePath&quot;, mPreviousImagePath);</span>
        }
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1587)) {</span>
<span class="nc" id="L154">            savedInstanceState.putParcelable(&quot;mPreviousImageUri&quot;, mPreviousImageUri);</span>
        }
<span class="nc" id="L156">        return savedInstanceState;</span>
    }

    @Override
    public void createUI(Context context, LinearLayout layout) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1588)) {</span>
<span class="nc" id="L162">            Timber.d(&quot;createUI()&quot;);</span>
        }
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1589)) {</span>
<span class="nc" id="L165">            mViewModel = mViewModel.replaceNullValues(mField, mActivity);</span>
        }
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1590)) {</span>
<span class="nc" id="L168">            mImagePreview = new ImageView(mActivity);</span>
        }
<span class="nc" id="L170">        File externalCacheDirRoot = context.getExternalCacheDir();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1593)) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (externalCacheDirRoot == null) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1591)) {</span>
<span class="nc" id="L174">                    Timber.e(&quot;createUI() unable to get external cache directory&quot;);</span>
                }
<span class="nc bnc" id="L176" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1592)) {</span>
<span class="nc" id="L177">                    showSomethingWentWrong();</span>
                }
<span class="nc" id="L179">                return;</span>
            }
        }
<span class="nc" id="L182">        File externalCacheDir = new File(externalCacheDirRoot.getAbsolutePath() + &quot;/temp-photos&quot;);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1597)) {</span>
<span class="nc bnc" id="L184" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1594) ? (!externalCacheDir.exists() || !externalCacheDir.mkdir()) : (!externalCacheDir.exists() &amp;&amp; !externalCacheDir.mkdir()))) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1595)) {</span>
<span class="nc" id="L186">                    Timber.e(&quot;createUI() externalCacheDir did not exist and could not be created&quot;);</span>
                }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1596)) {</span>
<span class="nc" id="L189">                    showSomethingWentWrong();</span>
                }
<span class="nc" id="L191">                return;</span>
            }
        }
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1598)) {</span>
<span class="nc" id="L195">            mAnkiCacheDirectory = externalCacheDir.getAbsolutePath();</span>
        }
<span class="nc" id="L197">        LinearLayout.LayoutParams p = new LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, android.view.ViewGroup.LayoutParams.WRAP_CONTENT);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1599)) {</span>
<span class="nc" id="L199">            drawUIComponents(context);</span>
        }
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1600)) {</span>
<span class="nc" id="L202">            mCropButton = new Button(mActivity);</span>
        }
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1601)) {</span>
<span class="nc" id="L205">            mCropButton.setText(gtxt(R.string.crop_button));</span>
        }
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1602)) {</span>
<span class="nc" id="L208">            mCropButton.setOnClickListener(v -&gt; mViewModel = requestCrop(mViewModel));</span>
        }
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1603)) {</span>
<span class="nc" id="L211">            mCropButton.setVisibility(View.INVISIBLE);</span>
        }
<span class="nc" id="L213">        Button mBtnGallery = new Button(mActivity);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1604)) {</span>
<span class="nc" id="L215">            mBtnGallery.setText(gtxt(R.string.multimedia_editor_image_field_editing_galery));</span>
        }
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1605)) {</span>
<span class="nc" id="L218">            mBtnGallery.setOnClickListener(v -&gt; {</span>
<span class="nc" id="L219">                Intent i = new Intent(Intent.ACTION_PICK);</span>
<span class="nc" id="L220">                i.setDataAndType(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, &quot;image/*&quot;);</span>
<span class="nc" id="L221">                mActivity.startActivityForResultWithoutAnimation(i, ACTIVITY_SELECT_IMAGE);</span>
<span class="nc" id="L222">            });</span>
        }
<span class="nc" id="L224">        Button mBtnCamera = new Button(mActivity);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1606)) {</span>
<span class="nc" id="L226">            mBtnCamera.setText(gtxt(R.string.multimedia_editor_image_field_editing_photo));</span>
        }
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1607)) {</span>
<span class="nc" id="L229">            mBtnCamera.setOnClickListener(v -&gt; mViewModel = captureImage(context));</span>
        }
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1609)) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (!canUseCamera(context)) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1608)) {</span>
<span class="nc" id="L234">                    mBtnCamera.setVisibility(View.INVISIBLE);</span>
                }
            }
        }
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1610)) {</span>
<span class="nc" id="L239">            setPreviewImage(mViewModel.mImagePath, getMaxImageSize());</span>
        }
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1611)) {</span>
<span class="nc" id="L242">            layout.addView(mImagePreview, ViewGroup.LayoutParams.MATCH_PARENT, p);</span>
        }
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1612)) {</span>
<span class="nc" id="L245">            layout.addView(mImageFileSize, ViewGroup.LayoutParams.MATCH_PARENT);</span>
        }
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1613)) {</span>
<span class="nc" id="L248">            layout.addView(mImageFileSizeWarning, ViewGroup.LayoutParams.MATCH_PARENT);</span>
        }
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1614)) {</span>
<span class="nc" id="L251">            layout.addView(mBtnGallery, ViewGroup.LayoutParams.MATCH_PARENT);</span>
        }
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1615)) {</span>
<span class="nc" id="L254">            layout.addView(mBtnCamera, ViewGroup.LayoutParams.MATCH_PARENT);</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1616)) {</span>
<span class="nc" id="L257">            layout.addView(mCropButton, ViewGroup.LayoutParams.MATCH_PARENT);</span>
        }
<span class="nc" id="L259">    }</span>

    @SuppressLint(&quot;UnsupportedChromeOsCameraSystemFeature&quot;)
    private boolean canUseCamera(Context context) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1617)) {</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (!Permissions.canUseCamera(context)) {</span>
<span class="nc" id="L265">                return false;</span>
            }
        }
<span class="nc" id="L268">        PackageManager pm = context.getPackageManager();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1619)) {</span>
<span class="nc bnc" id="L270" title="All 10 branches missed.">            if (((ListenerUtil.mutListener.listen(1618) ? (!pm.hasSystemFeature(PackageManager.FEATURE_CAMERA) || !pm.hasSystemFeature(PackageManager.FEATURE_CAMERA_FRONT)) : (!pm.hasSystemFeature(PackageManager.FEATURE_CAMERA) &amp;&amp; !pm.hasSystemFeature(PackageManager.FEATURE_CAMERA_FRONT))))) {</span>
<span class="nc" id="L271">                return false;</span>
            }
        }
        // Some hardware has no camera or reports yes but has zero (e.g., cheap devices, and Chromebook emulator)
<span class="nc" id="L275">        CameraManager cameraManager = (CameraManager) AnkiDroidApp.getInstance().getApplicationContext().getSystemService(Context.CAMERA_SERVICE);</span>
        try {
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1626)) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                if (cameraManager != null) {</span>
<span class="nc bnc" id="L279" title="All 22 branches missed.">                    return (ListenerUtil.mutListener.listen(1625) ? (cameraManager.getCameraIdList().length &gt;= 0) : (ListenerUtil.mutListener.listen(1624) ? (cameraManager.getCameraIdList().length &lt;= 0) : (ListenerUtil.mutListener.listen(1623) ? (cameraManager.getCameraIdList().length &lt; 0) : (ListenerUtil.mutListener.listen(1622) ? (cameraManager.getCameraIdList().length != 0) : (ListenerUtil.mutListener.listen(1621) ? (cameraManager.getCameraIdList().length == 0) : (cameraManager.getCameraIdList().length &gt; 0))))));</span>
                }
            }
<span class="nc" id="L282">        } catch (CameraAccessException e) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1620)) {</span>
<span class="nc" id="L284">                Timber.e(e, &quot;Unable to enumerate cameras&quot;);</span>
            }
<span class="nc" id="L286">        }</span>
<span class="nc" id="L287">        return false;</span>
    }

    private ImageViewModel captureImage(Context context) {
<span class="nc" id="L291">        Intent cameraIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span>
        File image;
<span class="nc" id="L293">        ImageViewModel toReturn = mViewModel;</span>
        try {
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1628)) {</span>
<span class="nc" id="L296">                saveImageForRevert();</span>
            }
            // Create a new image for the camera result to land in, clear the URI
<span class="nc" id="L299">            image = createNewCacheImageFile();</span>
<span class="nc" id="L300">            Uri imageUri = getUriForFile(image);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1629)) {</span>
<span class="nc" id="L302">                toReturn = new ImageViewModel(image.getPath(), imageUri);</span>
            }
<span class="nc bnc" id="L304" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1630)) {</span>
<span class="nc" id="L305">                cameraIntent.putExtra(MediaStore.EXTRA_OUTPUT, imageUri);</span>
            }
<span class="nc bnc" id="L307" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1638)) {</span>
                // https://medium.com/@quiro91/sharing-files-through-intents-part-2-fixing-the-permissions-before-lollipop-ceb9bb0eec3a
<span class="nc bnc" id="L309" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(1635) ? (CompatHelper.getSdkVersion() &gt;= Build.VERSION_CODES.LOLLIPOP_MR1) : (ListenerUtil.mutListener.listen(1634) ? (CompatHelper.getSdkVersion() &lt;= Build.VERSION_CODES.LOLLIPOP_MR1) : (ListenerUtil.mutListener.listen(1633) ? (CompatHelper.getSdkVersion() &gt; Build.VERSION_CODES.LOLLIPOP_MR1) : (ListenerUtil.mutListener.listen(1632) ? (CompatHelper.getSdkVersion() != Build.VERSION_CODES.LOLLIPOP_MR1) : (ListenerUtil.mutListener.listen(1631) ? (CompatHelper.getSdkVersion() == Build.VERSION_CODES.LOLLIPOP_MR1) : (CompatHelper.getSdkVersion() &lt; Build.VERSION_CODES.LOLLIPOP_MR1))))))) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1636)) {</span>
<span class="nc" id="L311">                        cameraIntent.setClipData(ClipData.newRawUri(&quot;&quot;, imageUri));</span>
                    }
<span class="nc bnc" id="L313" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1637)) {</span>
<span class="nc" id="L314">                        cameraIntent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
                    }
                }
            }
<span class="nc bnc" id="L318" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1642)) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                if (cameraIntent.resolveActivity(context.getPackageManager()) == null) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1639)) {</span>
<span class="nc" id="L321">                        Timber.w(&quot;Device has a camera, but no app to handle ACTION_IMAGE_CAPTURE Intent&quot;);</span>
                    }
<span class="nc bnc" id="L323" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1640)) {</span>
<span class="nc" id="L324">                        showSomethingWentWrong();</span>
                    }
<span class="nc bnc" id="L326" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1641)) {</span>
<span class="nc" id="L327">                        onActivityResult(ACTIVITY_TAKE_PICTURE, Activity.RESULT_CANCELED, null);</span>
                    }
<span class="nc" id="L329">                    return toReturn;</span>
                }
            }
            try {
<span class="nc bnc" id="L333" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1646)) {</span>
<span class="nc" id="L334">                    mActivity.startActivityForResultWithoutAnimation(cameraIntent, ACTIVITY_TAKE_PICTURE);</span>
                }
<span class="nc" id="L336">            } catch (Exception e) {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1643)) {</span>
<span class="nc" id="L338">                    Timber.w(e, &quot;Unable to take picture&quot;);</span>
                }
<span class="nc bnc" id="L340" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1644)) {</span>
<span class="nc" id="L341">                    showSomethingWentWrong();</span>
                }
<span class="nc bnc" id="L343" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1645)) {</span>
<span class="nc" id="L344">                    onActivityResult(ACTIVITY_TAKE_PICTURE, Activity.RESULT_CANCELED, null);</span>
                }
<span class="nc" id="L346">            }</span>
<span class="nc" id="L347">        } catch (IOException e) {</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1627)) {</span>
<span class="nc" id="L349">                Timber.w(e, &quot;mBtnCamera::onClickListener() unable to prepare file and launch camera&quot;);</span>
            }
<span class="nc" id="L351">        }</span>
<span class="nc" id="L352">        return toReturn;</span>
    }

    private void saveImageForRevert() {
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1650)) {</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            if (!mViewModel.isPreExistingImage) {</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1647)) {</span>
<span class="nc" id="L359">                    deletePreviousImage();</span>
                }
<span class="nc bnc" id="L361" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1648)) {</span>
<span class="nc" id="L362">                    mPreviousImagePath = mViewModel.mImagePath;</span>
                }
<span class="nc bnc" id="L364" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1649)) {</span>
<span class="nc" id="L365">                    mPreviousImageUri = mViewModel.mImageUri;</span>
                }
            }
        }
<span class="nc" id="L369">    }</span>

    private void deletePreviousImage() {
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1653)) {</span>
            // Store the old image path for deletion / error handling if the user cancels
<span class="nc bnc" id="L374" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1651) ? (mPreviousImagePath != null || !(new File(mPreviousImagePath).delete())) : (mPreviousImagePath != null &amp;&amp; !(new File(mPreviousImagePath).delete())))) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1652)) {</span>
<span class="nc" id="L376">                    Timber.i(&quot;deletePreviousImage() unable to delete previous image file&quot;);</span>
                }
            }
        }
<span class="nc" id="L380">    }</span>

    private File createNewCacheImageFile() throws IOException {
<span class="nc" id="L383">        return createNewCacheImageFile(&quot;jpg&quot;);</span>
    }

    private File createNewCacheImageFile(@NonNull String extension) throws IOException {
<span class="nc" id="L387">        File storageDir = new File(mAnkiCacheDirectory);</span>
<span class="nc" id="L388">        return File.createTempFile(&quot;img&quot;, &quot;.&quot; + extension, storageDir);</span>
    }

    private void drawUIComponents(Context context) {
<span class="nc" id="L392">        DisplayMetrics metrics = getDisplayMetrics();</span>
<span class="nc" id="L393">        int height = metrics.heightPixels;</span>
<span class="nc" id="L394">        int width = metrics.widthPixels;</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1654)) {</span>
<span class="nc" id="L396">            mImagePreview = new ImageView(mActivity);</span>
        }
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1655)) {</span>
<span class="nc" id="L399">            mImagePreview.setScaleType(ImageView.ScaleType.CENTER_INSIDE);</span>
        }
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1656)) {</span>
<span class="nc" id="L402">            mImagePreview.setAdjustViewBounds(true);</span>
        }
<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1661)) {</span>
<span class="nc bnc" id="L405" title="All 8 branches missed.">            mImagePreview.setMaxHeight((int) Math.round((ListenerUtil.mutListener.listen(1660) ? (height % 0.4) : (ListenerUtil.mutListener.listen(1659) ? (height / 0.4) : (ListenerUtil.mutListener.listen(1658) ? (height - 0.4) : (ListenerUtil.mutListener.listen(1657) ? (height + 0.4) : (height * 0.4)))))));</span>
        }
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1666)) {</span>
<span class="nc bnc" id="L408" title="All 8 branches missed.">            mImagePreview.setMaxWidth((int) Math.round((ListenerUtil.mutListener.listen(1665) ? (width % 0.6) : (ListenerUtil.mutListener.listen(1664) ? (width / 0.6) : (ListenerUtil.mutListener.listen(1663) ? (width - 0.6) : (ListenerUtil.mutListener.listen(1662) ? (width + 0.6) : (width * 0.6)))))));</span>
        }
<span class="nc bnc" id="L410" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1667)) {</span>
<span class="nc" id="L411">            mImageFileSize = new FixedEditText(context);</span>
        }
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1672)) {</span>
<span class="nc bnc" id="L414" title="All 8 branches missed.">            mImageFileSize.setMaxWidth((int) Math.round((ListenerUtil.mutListener.listen(1671) ? (width % 0.6) : (ListenerUtil.mutListener.listen(1670) ? (width / 0.6) : (ListenerUtil.mutListener.listen(1669) ? (width - 0.6) : (ListenerUtil.mutListener.listen(1668) ? (width + 0.6) : (width * 0.6)))))));</span>
        }
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1673)) {</span>
<span class="nc" id="L417">            mImageFileSize.setEnabled(false);</span>
        }
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1674)) {</span>
<span class="nc" id="L420">            mImageFileSize.setGravity(Gravity.CENTER_HORIZONTAL);</span>
        }
<span class="nc bnc" id="L422" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1675)) {</span>
<span class="nc" id="L423">            mImageFileSize.setBackground(null);</span>
        }
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1676)) {</span>
<span class="nc" id="L426">            mImageFileSize.setVisibility(View.GONE);</span>
        }
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1677)) {</span>
            // there's an action that they can take.
<span class="nc" id="L430">            mImageFileSizeWarning = new FixedEditText(context);</span>
        }
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1682)) {</span>
<span class="nc bnc" id="L433" title="All 8 branches missed.">            mImageFileSizeWarning.setMaxWidth((int) Math.round((ListenerUtil.mutListener.listen(1681) ? (width % 0.6) : (ListenerUtil.mutListener.listen(1680) ? (width / 0.6) : (ListenerUtil.mutListener.listen(1679) ? (width - 0.6) : (ListenerUtil.mutListener.listen(1678) ? (width + 0.6) : (width * 0.6)))))));</span>
        }
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1683)) {</span>
<span class="nc" id="L436">            mImageFileSizeWarning.setEnabled(false);</span>
        }
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1684)) {</span>
            // Orange-Red
<span class="nc" id="L440">            mImageFileSizeWarning.setTextColor(Color.parseColor(&quot;#FF4500&quot;));</span>
        }
<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1685)) {</span>
<span class="nc" id="L443">            mImageFileSizeWarning.setGravity(Gravity.CENTER_HORIZONTAL);</span>
        }
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1686)) {</span>
<span class="nc" id="L446">            mImageFileSizeWarning.setVisibility(View.GONE);</span>
        }
<span class="nc bnc" id="L448" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1687)) {</span>
<span class="nc" id="L449">            mImageFileSize.setBackground(null);</span>
        }
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1688)) {</span>
<span class="nc" id="L452">            mImageFileSizeWarning.setText(R.string.multimedia_editor_image_compression_failed);</span>
        }
<span class="nc" id="L454">    }</span>

    private String gtxt(int id) {
<span class="nc" id="L457">        return mActivity.getText(id).toString();</span>
    }

    private DisplayMetrics getDisplayMetrics() {
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1691)) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (mMetrics == null) {</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1689)) {</span>
<span class="nc" id="L464">                    mMetrics = new DisplayMetrics();</span>
                }
<span class="nc bnc" id="L466" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1690)) {</span>
<span class="nc" id="L467">                    mActivity.getWindowManager().getDefaultDisplay().getMetrics(mMetrics);</span>
                }
            }
        }
<span class="nc" id="L471">        return mMetrics;</span>
    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1692)) {</span>
<span class="nc" id="L477">            Timber.d(&quot;onActivityResult()&quot;);</span>
        }
<span class="nc bnc" id="L479" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1704)) {</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">            if (resultCode != Activity.RESULT_OK) {</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1693)) {</span>
<span class="nc" id="L482">                    Timber.d(&quot;Activity was not successful&quot;);</span>
                }
<span class="nc bnc" id="L484" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1696)) {</span>
                    // Restore the old version of the image if the user cancelled
<span class="nc bnc" id="L486" title="All 2 branches missed.">                    switch(requestCode) {</span>
                        case ACTIVITY_TAKE_PICTURE:
                        case ACTIVITY_CROP_PICTURE:
<span class="nc bnc" id="L489" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(1695)) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">                                if (!TextUtils.isEmpty(mPreviousImagePath)) {</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(1694)) {</span>
<span class="nc" id="L492">                                        revertToPreviousImage();</span>
                                    }
                                }
                            }
                            break;
                        default:
                            break;
                    }
                }
<span class="nc bnc" id="L501" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1703)) {</span>
                    // Some apps send this back with app-specific data, direct the user to another app
<span class="nc bnc" id="L503" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(1701) ? (resultCode &lt;= Activity.RESULT_FIRST_USER) : (ListenerUtil.mutListener.listen(1700) ? (resultCode &gt; Activity.RESULT_FIRST_USER) : (ListenerUtil.mutListener.listen(1699) ? (resultCode &lt; Activity.RESULT_FIRST_USER) : (ListenerUtil.mutListener.listen(1698) ? (resultCode != Activity.RESULT_FIRST_USER) : (ListenerUtil.mutListener.listen(1697) ? (resultCode == Activity.RESULT_FIRST_USER) : (resultCode &gt;= Activity.RESULT_FIRST_USER))))))) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1702)) {</span>
<span class="nc" id="L505">                            UIUtils.showThemedToast(mActivity, mActivity.getString(R.string.activity_result_unexpected), true);</span>
                        }
                    }
                }
<span class="nc" id="L509">                return;</span>
            }
        }
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1705)) {</span>
<span class="nc" id="L513">            mImageFileSizeWarning.setVisibility(View.GONE);</span>
        }
<span class="nc bnc" id="L515" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1729)) {</span>
<span class="nc bnc" id="L516" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(1710) ? (requestCode &gt;= ACTIVITY_SELECT_IMAGE) : (ListenerUtil.mutListener.listen(1709) ? (requestCode &lt;= ACTIVITY_SELECT_IMAGE) : (ListenerUtil.mutListener.listen(1708) ? (requestCode &gt; ACTIVITY_SELECT_IMAGE) : (ListenerUtil.mutListener.listen(1707) ? (requestCode &lt; ACTIVITY_SELECT_IMAGE) : (ListenerUtil.mutListener.listen(1706) ? (requestCode != ACTIVITY_SELECT_IMAGE) : (requestCode == ACTIVITY_SELECT_IMAGE))))))) {</span>
                try {
<span class="nc bnc" id="L518" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1727)) {</span>
<span class="nc" id="L519">                        handleSelectImageIntent(data);</span>
                    }
<span class="nc bnc" id="L521" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1728)) {</span>
<span class="nc" id="L522">                        mImageFileSizeWarning.setVisibility(View.GONE);</span>
                    }
<span class="nc" id="L524">                } catch (Exception e) {</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1724)) {</span>
<span class="nc" id="L526">                        AnkiDroidApp.sendExceptionReport(e, &quot;BasicImageFieldController - handleSelectImageIntent&quot;);</span>
                    }
<span class="nc bnc" id="L528" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1725)) {</span>
<span class="nc" id="L529">                        Timber.e(e, &quot;Failed to select image&quot;);</span>
                    }
<span class="nc bnc" id="L531" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1726)) {</span>
<span class="nc" id="L532">                        showSomethingWentWrong();</span>
                    }
<span class="nc" id="L534">                    return;</span>
<span class="nc" id="L535">                }</span>
<span class="nc bnc" id="L536" title="All 22 branches missed.">            } else if ((ListenerUtil.mutListener.listen(1715) ? (requestCode &gt;= ACTIVITY_TAKE_PICTURE) : (ListenerUtil.mutListener.listen(1714) ? (requestCode &lt;= ACTIVITY_TAKE_PICTURE) : (ListenerUtil.mutListener.listen(1713) ? (requestCode &gt; ACTIVITY_TAKE_PICTURE) : (ListenerUtil.mutListener.listen(1712) ? (requestCode &lt; ACTIVITY_TAKE_PICTURE) : (ListenerUtil.mutListener.listen(1711) ? (requestCode != ACTIVITY_TAKE_PICTURE) : (requestCode == ACTIVITY_TAKE_PICTURE))))))) {</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1723)) {</span>
<span class="nc" id="L538">                    handleTakePictureResult();</span>
                }
<span class="nc bnc" id="L540" title="All 22 branches missed.">            } else if ((ListenerUtil.mutListener.listen(1720) ? (requestCode &gt;= ACTIVITY_CROP_PICTURE) : (ListenerUtil.mutListener.listen(1719) ? (requestCode &lt;= ACTIVITY_CROP_PICTURE) : (ListenerUtil.mutListener.listen(1718) ? (requestCode &gt; ACTIVITY_CROP_PICTURE) : (ListenerUtil.mutListener.listen(1717) ? (requestCode &lt; ACTIVITY_CROP_PICTURE) : (ListenerUtil.mutListener.listen(1716) ? (requestCode != ACTIVITY_CROP_PICTURE) : (requestCode == ACTIVITY_CROP_PICTURE))))))) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1722)) {</span>
<span class="nc" id="L542">                    handleCropResult();</span>
                }
            } else {
<span class="nc bnc" id="L545" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1721)) {</span>
<span class="nc" id="L546">                    Timber.w(&quot;Unhandled request code: %d&quot;, requestCode);</span>
                }
<span class="nc" id="L548">                return;</span>
            }
        }
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1730)) {</span>
<span class="nc" id="L552">            setPreviewImage(mViewModel.mImagePath, getMaxImageSize());</span>
        }
<span class="nc" id="L554">    }</span>

    private void revertToPreviousImage() {
<span class="nc bnc" id="L557" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1731)) {</span>
<span class="nc" id="L558">            mViewModel.deleteImagePath();</span>
        }
<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1732)) {</span>
<span class="nc" id="L561">            mViewModel = new ImageViewModel(mPreviousImagePath, mPreviousImageUri);</span>
        }
<span class="nc bnc" id="L563" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1733)) {</span>
<span class="nc" id="L564">            mField.setImagePath(mPreviousImagePath);</span>
        }
<span class="nc bnc" id="L566" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1734)) {</span>
<span class="nc" id="L567">            mPreviousImagePath = null;</span>
        }
<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1735)) {</span>
<span class="nc" id="L570">            mPreviousImageUri = null;</span>
        }
<span class="nc" id="L572">    }</span>

    private void showSomethingWentWrong() {
<span class="nc bnc" id="L575" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1736)) {</span>
<span class="nc" id="L576">            UIUtils.showThemedToast(mActivity, mActivity.getResources().getString(R.string.multimedia_editor_something_wrong), false);</span>
        }
<span class="nc" id="L578">    }</span>

    private void handleSelectImageIntent(Intent data) {
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1739)) {</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1737)) {</span>
<span class="nc" id="L584">                    Timber.e(&quot;handleSelectImageIntent() no intent provided&quot;);</span>
                }
<span class="nc bnc" id="L586" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1738)) {</span>
<span class="nc" id="L587">                    showSomethingWentWrong();</span>
                }
<span class="nc" id="L589">                return;</span>
            }
        }
<span class="nc bnc" id="L592" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1740)) {</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">            Timber.i(&quot;handleSelectImageIntent() Intent: %s. extras: %s&quot;, data, data.getExtras() == null ? &quot;null&quot; : TextUtils.join(&quot;, &quot;, data.getExtras().keySet()));</span>
        }
<span class="nc" id="L595">        Uri selectedImage = getImageUri(mActivity, data);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1743)) {</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">            if (selectedImage == null) {</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1741)) {</span>
<span class="nc" id="L599">                    Timber.w(&quot;handleSelectImageIntent() selectedImage was null&quot;);</span>
                }
<span class="nc bnc" id="L601" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1742)) {</span>
<span class="nc" id="L602">                    showSomethingWentWrong();</span>
                }
<span class="nc" id="L604">                return;</span>
            }
        }
<span class="nc" id="L607">        File internalizedPick = internalizeUri(selectedImage);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1749)) {</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">            if (internalizedPick == null) {</span>
<span class="nc" id="L610">                String urlImagePath = getImageInfoFromUri(mActivity, selectedImage).first;</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1744)) {</span>
<span class="nc" id="L612">                    mViewModel = new ImageViewModel(urlImagePath, selectedImage);</span>
                }
<span class="nc bnc" id="L614" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1745)) {</span>
<span class="nc" id="L615">                    mField.setImagePath(urlImagePath);</span>
                }
<span class="nc bnc" id="L617" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1746)) {</span>
<span class="nc" id="L618">                    mField.setHasTemporaryMedia(false);</span>
                }
<span class="nc bnc" id="L620" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1747)) {</span>
<span class="nc" id="L621">                    Timber.w(&quot;handleSelectImageIntent() unable to internalize image from Uri %s&quot;, selectedImage);</span>
                }
<span class="nc bnc" id="L623" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1748)) {</span>
<span class="nc" id="L624">                    showSomethingWentWrong();</span>
                }
<span class="nc" id="L626">                return;</span>
            }
        }
<span class="nc" id="L629">        String imagePath = internalizedPick.getAbsolutePath();</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1750)) {</span>
<span class="nc" id="L631">            mViewModel = new ImageViewModel(imagePath, getUriForFile(internalizedPick));</span>
        }
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1751)) {</span>
<span class="nc" id="L634">            setTemporaryMedia(imagePath);</span>
        }
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1752)) {</span>
<span class="nc" id="L637">            Timber.i(&quot;handleSelectImageIntent() Decoded image: '%s'&quot;, imagePath);</span>
        }
<span class="nc" id="L639">    }</span>

    @Nullable
    private File internalizeUri(Uri uri) {
        File internalFile;
<span class="nc" id="L644">        Pair&lt;String, String&gt; uriFileInfo = getImageInfoFromUri(mActivity, uri);</span>
<span class="nc" id="L645">        String filePath = uriFileInfo.first;</span>
<span class="nc" id="L646">        String displayName = uriFileInfo.second;</span>
        // Use the display name from the image info to create a new file with correct extension
<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (uriFileInfo.second == null) {</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1753)) {</span>
<span class="nc" id="L650">                Timber.w(&quot;internalizeUri() unable to get file name&quot;);</span>
            }
<span class="nc bnc" id="L652" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1754)) {</span>
<span class="nc" id="L653">                showSomethingWentWrong();</span>
            }
<span class="nc" id="L655">            return null;</span>
        }
<span class="nc" id="L657">        String uriFileExtension = uriFileInfo.second.substring(uriFileInfo.second.lastIndexOf('.') + 1);</span>
        try {
<span class="nc" id="L659">            internalFile = createNewCacheImageFile(uriFileExtension);</span>
<span class="nc" id="L660">        } catch (IOException e) {</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1755)) {</span>
<span class="nc" id="L662">                Timber.w(e, &quot;internalizeUri() failed to create new file with extension %s&quot;, uriFileExtension);</span>
            }
<span class="nc bnc" id="L664" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1756)) {</span>
<span class="nc" id="L665">                showSomethingWentWrong();</span>
            }
<span class="nc" id="L667">            return null;</span>
<span class="nc" id="L668">        }</span>
        try {
<span class="nc" id="L670">            File returnFile = FileUtil.internalizeUri(uri, filePath, internalFile, mActivity.getContentResolver());</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1758)) {</span>
<span class="nc" id="L672">                Timber.d(&quot;internalizeUri successful. Returning internalFile.&quot;);</span>
            }
<span class="nc" id="L674">            return returnFile;</span>
<span class="nc" id="L675">        } catch (Exception e) {</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1757)) {</span>
<span class="nc" id="L677">                showSomethingWentWrong();</span>
            }
<span class="nc" id="L679">            return null;</span>
        }
    }

    @Override
    public void onFocusLost() {
<span class="nc" id="L685">    }</span>

    @Override
    public void onDone() {
<span class="nc bnc" id="L689" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1759)) {</span>
<span class="nc" id="L690">            deletePreviousImage();</span>
        }
<span class="nc" id="L692">    }</span>

    /**
     * Rotate and compress the image, with the side effect of current image being backed by a new file
     *
     * @return true if successful, false indicates the current image is likely not usable, revert if possible
     */
    @SuppressWarnings(&quot;BooleanMethodIsAlwaysInverted&quot;)
    private boolean rotateAndCompress(String imagePath, ImageViewModel imageViewModel) {
<span class="nc bnc" id="L701" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1760)) {</span>
<span class="nc" id="L702">            Timber.d(&quot;rotateAndCompress() on %s&quot;, imagePath);</span>
        }
        // Set the rotation of the camera image and save as png
<span class="nc" id="L705">        File f = new File(imagePath);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1761)) {</span>
<span class="nc" id="L707">            Timber.d(&quot;rotateAndCompress in path %s has size %d&quot;, f.getAbsolutePath(), f.length());</span>
        }
        // Load into a bitmap with max size of 1920 pixels and rotate if necessary
<span class="nc" id="L710">        Bitmap b = BitmapUtil.decodeFile(f, IMAGE_SAVE_MAX_WIDTH);</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1763)) {</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">            if (b == null) {</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1762)) {</span>
                    // And display a warning to push users to compress manually.
<span class="nc" id="L715">                    Timber.w(&quot;rotateAndCompress() unable to decode file %s&quot;, imagePath);</span>
                }
<span class="nc" id="L717">                return false;</span>
            }
        }
<span class="nc" id="L720">        FileOutputStream out = null;</span>
        try {
<span class="nc" id="L722">            File outFile = createNewCacheImageFile();</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1769)) {</span>
<span class="nc" id="L724">                out = new FileOutputStream(outFile);</span>
            }
<span class="nc bnc" id="L726" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1770)) {</span>
<span class="nc" id="L727">                b = ExifUtil.rotateFromCamera(f, b);</span>
            }
<span class="nc bnc" id="L729" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1771)) {</span>
<span class="nc" id="L730">                b.compress(Bitmap.CompressFormat.JPEG, 90, out);</span>
            }
<span class="nc bnc" id="L732" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1773)) {</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">                if (!f.delete()) {</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1772)) {</span>
<span class="nc" id="L735">                        Timber.w(&quot;rotateAndCompress() delete of pre-compressed image failed %s&quot;, imagePath);</span>
                    }
                }
            }
<span class="nc bnc" id="L739" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1774)) {</span>
<span class="nc" id="L740">                imagePath = outFile.getAbsolutePath();</span>
            }
<span class="nc bnc" id="L742" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1775)) {</span>
<span class="nc" id="L743">                mViewModel = imageViewModel.rotateAndCompressTo(imagePath, getUriForFile(outFile));</span>
            }
<span class="nc bnc" id="L745" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1776)) {</span>
<span class="nc" id="L746">                mField.setImagePath(imagePath);</span>
            }
<span class="nc bnc" id="L748" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1777)) {</span>
<span class="nc" id="L749">                Timber.d(&quot;rotateAndCompress out path %s has size %d&quot;, imagePath, outFile.length());</span>
            }
<span class="nc" id="L751">        } catch (FileNotFoundException e) {</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1764)) {</span>
<span class="nc" id="L753">                Timber.w(e, &quot;rotateAndCompress() File not found for image compression %s&quot;, imagePath);</span>
            }
<span class="nc" id="L755">        } catch (IOException e) {</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1765)) {</span>
<span class="nc" id="L757">                Timber.w(e, &quot;rotateAndCompress() create file failed for file %s&quot;, imagePath);</span>
            }
        } finally {
            try {
<span class="nc bnc" id="L761" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1768)) {</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">                    if (out != null) {</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1767)) {</span>
<span class="nc" id="L764">                            out.close();</span>
                        }
                    }
                }
<span class="nc" id="L768">            } catch (IOException e) {</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1766)) {</span>
<span class="nc" id="L770">                    Timber.w(e, &quot;rotateAndCompress() Unable to clean up image compression output stream&quot;);</span>
                }
<span class="nc" id="L772">            }</span>
        }
<span class="nc" id="L774">        return true;</span>
    }

    private void setPreviewImage(@Nullable String imagePath, int maxsize) {
<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1780)) {</span>
<span class="nc bnc" id="L779" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(1778) ? (imagePath != null || !&quot;&quot;.equals(imagePath)) : (imagePath != null &amp;&amp; !&quot;&quot;.equals(imagePath)))) {</span>
<span class="nc" id="L780">                File f = new File(imagePath);</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1779)) {</span>
<span class="nc" id="L782">                    setImagePreview(f, maxsize);</span>
                }
            }
        }
<span class="nc" id="L786">    }</span>

    @VisibleForTesting
    void setImagePreview(File f, int maxsize) {
<span class="nc" id="L790">        Bitmap b = BitmapUtil.decodeFile(f, maxsize);</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1782)) {</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">            if (b == null) {</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1781)) {</span>
<span class="nc" id="L794">                    Timber.i(&quot;setImagePreview() could not process image %s&quot;, f.getPath());</span>
                }
<span class="nc" id="L796">                return;</span>
            }
        }
<span class="nc bnc" id="L799" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1783)) {</span>
<span class="nc" id="L800">            Timber.d(&quot;setPreviewImage path %s has size %d&quot;, f.getAbsolutePath(), f.length());</span>
        }
<span class="nc bnc" id="L802" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1784)) {</span>
<span class="nc" id="L803">            b = ExifUtil.rotateFromCamera(f, b);</span>
        }
<span class="nc bnc" id="L805" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1785)) {</span>
<span class="nc" id="L806">            onValidImage(b, Formatter.formatFileSize(mActivity, f.length()));</span>
        }
<span class="nc" id="L808">    }</span>

    private void onValidImage(Bitmap b, String fileSize) {
<span class="nc bnc" id="L811" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1786)) {</span>
<span class="nc" id="L812">            mImagePreview.setImageBitmap(b);</span>
        }
<span class="nc bnc" id="L814" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1787)) {</span>
<span class="nc" id="L815">            mImageFileSize.setVisibility(View.VISIBLE);</span>
        }
<span class="nc bnc" id="L817" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1788)) {</span>
<span class="nc" id="L818">            mImageFileSize.setText(fileSize);</span>
        }
<span class="nc bnc" id="L820" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1789)) {</span>
<span class="nc" id="L821">            mCropButton.setVisibility(View.VISIBLE);</span>
        }
<span class="nc" id="L823">    }</span>

    @Override
    public void onDestroy() {
<span class="nc" id="L827">        ImageView imageView = mImagePreview;</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1790)) {</span>
<span class="nc" id="L829">            BitmapUtil.freeImageView(imageView);</span>
        }
<span class="nc bnc" id="L831" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1791)) {</span>
<span class="nc" id="L832">            mCropButton.setVisibility(View.INVISIBLE);</span>
        }
<span class="nc" id="L834">    }</span>

    private void handleTakePictureResult() {
<span class="nc bnc" id="L837" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1792)) {</span>
<span class="nc" id="L838">            Timber.d(&quot;handleTakePictureResult&quot;);</span>
        }
<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1794)) {</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">            if (!rotateAndCompress()) {</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1793)) {</span>
<span class="nc" id="L843">                    Timber.i(&quot;handleTakePictureResult appears to have an invalid picture&quot;);</span>
                }
<span class="nc" id="L845">                return;</span>
            }
        }
<span class="nc bnc" id="L848" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1795)) {</span>
<span class="nc" id="L849">            showCropDialog(mActivity.getString(R.string.crop_image), null);</span>
        }
<span class="nc" id="L851">    }</span>

    /**
     * Invoke system crop function
     */
    private ImageViewModel requestCrop(ImageViewModel viewModel) {
<span class="nc" id="L857">        ImageViewModel ret = viewModel;</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1797)) {</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">            if (!ret.isValid()) {</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1796)) {</span>
<span class="nc" id="L861">                    Timber.w(&quot;requestCrop() but mImagePath or mImageUri is null&quot;);</span>
                }
<span class="nc" id="L863">                return ret;</span>
            }
        }
<span class="nc bnc" id="L866" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1798)) {</span>
<span class="nc" id="L867">            Timber.d(&quot;photoCrop() with path/uri %s/%s&quot;, ret.mImagePath, ret.mImageUri);</span>
        }
        // Pre-create a file in our cache for the cropping application to put results in
        File image;
        try {
<span class="nc" id="L872">            image = createNewCacheImageFile();</span>
<span class="nc" id="L873">        } catch (IOException e) {</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1799)) {</span>
<span class="nc" id="L875">                Timber.w(e, &quot;requestCrop() unable to create new file to drop crop results into&quot;);</span>
            }
<span class="nc bnc" id="L877" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1800)) {</span>
<span class="nc" id="L878">                showSomethingWentWrong();</span>
            }
<span class="nc" id="L880">            return ret;</span>
<span class="nc" id="L881">        }</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1801)) {</span>
<span class="nc" id="L883">            saveImageForRevert();</span>
        }
        // This must be the file URL it will not work with a content URI
<span class="nc" id="L886">        String imagePath = image.getPath();</span>
<span class="nc" id="L887">        Uri imageUri = Uri.fromFile(image);</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1802)) {</span>
<span class="nc" id="L889">            ret = viewModel.beforeCrop(imagePath, imageUri);</span>
        }
<span class="nc bnc" id="L891" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1803)) {</span>
<span class="nc" id="L892">            setTemporaryMedia(imagePath);</span>
        }
<span class="nc bnc" id="L894" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1804)) {</span>
<span class="nc" id="L895">            Timber.d(&quot;requestCrop()  destination image has path/uri %s/%s&quot;, ret.mImagePath, ret.mImageUri);</span>
        }
        // Intent intent = new Intent(Intent.ACTION_EDIT);  // edit (vs crop) would be even better, but it fails differently and needs lots of testing
<span class="nc" id="L898">        Intent intent = new Intent(&quot;com.android.camera.action.CROP&quot;);</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1805)) {</span>
<span class="nc" id="L900">            intent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span>
        }
<span class="nc bnc" id="L902" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1806)) {</span>
<span class="nc" id="L903">            intent.setDataAndType(mPreviousImageUri, &quot;image/*&quot;);</span>
        }
<span class="nc bnc" id="L905" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1807)) {</span>
<span class="nc" id="L906">            intent.putExtra(&quot;return-data&quot;, false);</span>
        }
<span class="nc bnc" id="L908" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1808)) {</span>
<span class="nc" id="L909">            intent.putExtra(MediaStore.EXTRA_OUTPUT, imageUri);</span>
        }
<span class="nc bnc" id="L911" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1809)) {</span>
            // worked w/crop but not edit
<span class="nc" id="L913">            intent.putExtra(&quot;outputFormat&quot;, Bitmap.CompressFormat.JPEG.toString());</span>
        }
<span class="nc bnc" id="L915" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1810)) {</span>
            // no face detection
<span class="nc" id="L917">            intent.putExtra(&quot;noFaceDetection&quot;, true);</span>
        }
        try {
<span class="nc bnc" id="L920" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1814)) {</span>
<span class="nc" id="L921">                mActivity.startActivityForResultWithoutAnimation(Intent.createChooser(intent, null), ACTIVITY_CROP_PICTURE);</span>
            }
<span class="nc" id="L923">        } catch (Exception e) {</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1811)) {</span>
<span class="nc" id="L925">                Timber.w(e, &quot;requestCrop unable to start cropping activity for Uri %s&quot;, mPreviousImageUri);</span>
            }
<span class="nc bnc" id="L927" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1812)) {</span>
<span class="nc" id="L928">                showSomethingWentWrong();</span>
            }
<span class="nc bnc" id="L930" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1813)) {</span>
<span class="nc" id="L931">                onActivityResult(ACTIVITY_CROP_PICTURE, Activity.RESULT_CANCELED, null);</span>
            }
<span class="nc" id="L933">        }</span>
<span class="nc" id="L934">        return ret;</span>
    }

    private void setTemporaryMedia(String imagePath) {
<span class="nc bnc" id="L938" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1815)) {</span>
<span class="nc" id="L939">            mField.setImagePath(imagePath);</span>
        }
<span class="nc bnc" id="L941" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1816)) {</span>
<span class="nc" id="L942">            mField.setHasTemporaryMedia(true);</span>
        }
<span class="nc" id="L944">    }</span>

    public void showCropDialog(String content, @Nullable MaterialDialog.SingleButtonCallback negativeCallBack) {
<span class="nc bnc" id="L947" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1818)) {</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">            if (!mViewModel.isValid()) {</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1817)) {</span>
<span class="nc" id="L950">                    Timber.w(&quot;showCropDialog called with null URI or Path&quot;);</span>
                }
<span class="nc" id="L952">                return;</span>
            }
        }
<span class="nc" id="L955">        MaterialDialog.Builder builder = new MaterialDialog.Builder(mActivity).content(content).positiveText(R.string.dialog_ok).negativeText(R.string.dialog_no).onPositive((dialog, which) -&gt; mViewModel = requestCrop(mViewModel));</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1820)) {</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">            if (negativeCallBack != null) {</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1819)) {</span>
<span class="nc" id="L959">                    builder.onNegative(negativeCallBack);</span>
                }
            }
        }
<span class="nc bnc" id="L963" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1821)) {</span>
<span class="nc" id="L964">            builder.build().show();</span>
        }
<span class="nc" id="L966">    }</span>

    private void handleCropResult() {
<span class="nc bnc" id="L969" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1822)) {</span>
<span class="nc" id="L970">            Timber.d(&quot;handleCropResult&quot;);</span>
        }
<span class="nc bnc" id="L972" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1824)) {</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">            if (!rotateAndCompress()) {</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1823)) {</span>
<span class="nc" id="L975">                    Timber.i(&quot;handleCropResult() appears to have an invalid file, reverting&quot;);</span>
                }
<span class="nc" id="L977">                return;</span>
            }
        }
<span class="nc bnc" id="L980" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1825)) {</span>
<span class="nc" id="L981">            Timber.d(&quot;handleCropResult() = image path now %s&quot;, mField.getImagePath());</span>
        }
<span class="nc" id="L983">    }</span>

    @SuppressWarnings(&quot;BooleanMethodIsAlwaysInverted&quot;)
    private boolean rotateAndCompress() {
<span class="nc bnc" id="L987" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1829)) {</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">            if (!rotateAndCompress(mViewModel.mImagePath, mViewModel)) {</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1826)) {</span>
<span class="nc" id="L990">                    mImageFileSizeWarning.setVisibility(View.VISIBLE);</span>
                }
<span class="nc bnc" id="L992" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1827)) {</span>
<span class="nc" id="L993">                    revertToPreviousImage();</span>
                }
<span class="nc bnc" id="L995" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1828)) {</span>
<span class="nc" id="L996">                    showSomethingWentWrong();</span>
                }
<span class="nc" id="L998">                return false;</span>
            }
        }
<span class="nc bnc" id="L1001" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1830)) {</span>
<span class="nc" id="L1002">            mField.setHasTemporaryMedia(true);</span>
        }
<span class="nc" id="L1004">        return true;</span>
    }

    private Uri getUriForFile(File file) {
<span class="nc" id="L1008">        return getUriForFile(file, mActivity);</span>
    }

    /**
     * Get Uri based on current image path
     *
     * @param file the file to get URI for
     * @return current image path's uri
     */
    private static Uri getUriForFile(File file, Context mActivity) {
<span class="nc bnc" id="L1018" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1831)) {</span>
<span class="nc" id="L1019">            Timber.d(&quot;getUriForFile() %s&quot;, file);</span>
        }
        try {
<span class="nc bnc" id="L1022" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1839)) {</span>
<span class="nc bnc" id="L1023" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(1838) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(1837) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(1836) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(1835) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(1834) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.N) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N))))))) {</span>
<span class="nc" id="L1024">                    return FileProvider.getUriForFile(mActivity, mActivity.getApplicationContext().getPackageName() + &quot;.apkgfileprovider&quot;, file);</span>
                }
            }
<span class="nc" id="L1027">        } catch (Exception e) {</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1832)) {</span>
                // #6628 - What would cause this? Is the fallback is effective? Telemetry to diagnose more:
<span class="nc" id="L1030">                Timber.w(e, &quot;getUriForFile failed on %s - attempting fallback&quot;, file);</span>
            }
<span class="nc bnc" id="L1032" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1833)) {</span>
<span class="nc" id="L1033">                AnkiDroidApp.sendExceptionReport(e, &quot;BasicImageFieldController&quot;, &quot;Unexpected getUriForFile failure on &quot; + file, true);</span>
            }
<span class="nc" id="L1035">        }</span>
<span class="nc" id="L1036">        return Uri.fromFile(file);</span>
    }

    /**
     * Get image uri that adapts various model
     *
     * @return image uri
     */
    @Nullable
    private Uri getImageUri(Context context, Intent data) {
<span class="nc bnc" id="L1046" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1840)) {</span>
<span class="nc" id="L1047">            Timber.d(&quot;getImageUri for data %s&quot;, data);</span>
        }
<span class="nc" id="L1049">        Uri uri = data.getData();</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1842)) {</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">            if (uri == null) {</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1841)) {</span>
<span class="nc" id="L1053">                    UIUtils.showThemedToast(context, context.getString(R.string.select_image_failed), false);</span>
                }
            }
        }
<span class="nc" id="L1057">        return uri;</span>
    }

    /**
     * Get image information based on uri and selection args
     *
     * @return Pair&lt;String, String&gt;: first file path (null if does not exist), second display name (null if does not exist)
     */
    @NonNull
    private Pair&lt;String, String&gt; getImageInfoFromUri(Context context, Uri uri) {
<span class="nc bnc" id="L1067" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1843)) {</span>
<span class="nc" id="L1068">            Timber.d(&quot;getImagePathFromUri() URI: %s&quot;, uri);</span>
        }
<span class="nc" id="L1070">        Pair&lt;String, String&gt; imageInfo = new Pair&lt;&gt;(null, null);</span>
<span class="nc bnc" id="L1071" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1854)) {</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">            if (DocumentsContract.isDocumentUri(context, uri)) {</span>
<span class="nc" id="L1073">                String docId = DocumentsContract.getDocumentId(uri);</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1853)) {</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                    if (&quot;com.android.providers.media.documents&quot;.equals(uri.getAuthority())) {</span>
<span class="nc" id="L1076">                        String id = docId.split(&quot;:&quot;)[1];</span>
<span class="nc" id="L1077">                        String selection = MediaStore.Images.Media._ID + &quot;=&quot; + id;</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1852)) {</span>
<span class="nc" id="L1079">                            imageInfo = getImageInfoFromContentResolver(context, MediaStore.Images.Media.EXTERNAL_CONTENT_URI, selection);</span>
                        }
<span class="nc bnc" id="L1081" title="All 2 branches missed.">                    } else if (&quot;com.android.providers.downloads.documents&quot;.equals(uri.getAuthority())) {</span>
<span class="nc" id="L1082">                        Uri contentUri = ContentUris.withAppendedId(Uri.parse(&quot;content://downloads/public_downloads&quot;), Long.parseLong(docId));</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1851)) {</span>
<span class="nc" id="L1084">                            imageInfo = getImageInfoFromContentResolver(context, contentUri, null);</span>
                        }
                    }
                }
<span class="nc bnc" id="L1088" title="All 2 branches missed.">            } else if (&quot;content&quot;.equalsIgnoreCase(uri.getScheme())) {</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1850)) {</span>
<span class="nc" id="L1090">                    imageInfo = getImageInfoFromContentResolver(context, uri, null);</span>
                }
<span class="nc bnc" id="L1092" title="All 2 branches missed.">            } else if (&quot;file&quot;.equalsIgnoreCase(uri.getScheme())) {</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1849)) {</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">                    if (uri.getPath() != null) {</span>
<span class="nc" id="L1095">                        String[] pathParts = uri.getPath().split(&quot;/&quot;);</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(1848)) {</span>
<span class="nc bnc" id="L1097" title="All 8 branches missed.">                            imageInfo = new Pair&lt;&gt;(uri.getPath(), pathParts[(ListenerUtil.mutListener.listen(1847) ? (pathParts.length % 1) : (ListenerUtil.mutListener.listen(1846) ? (pathParts.length / 1) : (ListenerUtil.mutListener.listen(1845) ? (pathParts.length * 1) : (ListenerUtil.mutListener.listen(1844) ? (pathParts.length + 1) : (pathParts.length - 1)))))]);</span>
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L1103" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1855)) {</span>
<span class="nc" id="L1104">            Timber.d(&quot;getImagePathFromUri() returning path/name %s/%s&quot;, imageInfo.first, imageInfo.second);</span>
        }
<span class="nc" id="L1106">        return imageInfo;</span>
    }

    /**
     * Get image information based on uri and selection args
     *
     * @return string[] 0: file path (null if does not exist), 1: display name (null if does not exist)
     */
    // TODO Tracked in https://github.com/ankidroid/Anki-Android/issues/7014
    @SuppressWarnings(&quot;deprecation&quot;)
    @NonNull
    private Pair&lt;String, String&gt; getImageInfoFromContentResolver(Context context, Uri uri, String selection) {
<span class="nc bnc" id="L1118" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1856)) {</span>
<span class="nc" id="L1119">            Timber.d(&quot;getImagePathFromContentResolver() %s&quot;, uri);</span>
        }
<span class="nc" id="L1121">        String[] filePathColumns = { MediaStore.MediaColumns.DATA, MediaStore.MediaColumns.DISPLAY_NAME };</span>
<span class="nc" id="L1122">        Cursor cursor = ContentResolverCompat.query(context.getContentResolver(), uri, filePathColumns, selection, null, null, null);</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1859)) {</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">            if (cursor == null) {</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1857)) {</span>
<span class="nc" id="L1126">                    Timber.w(&quot;getImageInfoFromContentResolver() cursor was null&quot;);</span>
                }
<span class="nc bnc" id="L1128" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1858)) {</span>
<span class="nc" id="L1129">                    showSomethingWentWrong();</span>
                }
<span class="nc" id="L1131">                return new Pair&lt;&gt;(null, null);</span>
            }
        }
<span class="nc bnc" id="L1134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1862)) {</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">            if (!cursor.moveToFirst()) {</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1860)) {</span>
                    // TODO: #5909, it would be best to instrument this to see if we can fix the failure
<span class="nc" id="L1138">                    Timber.w(&quot;getImageInfoFromContentResolver() cursor had no data&quot;);</span>
                }
<span class="nc bnc" id="L1140" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(1861)) {</span>
<span class="nc" id="L1141">                    showSomethingWentWrong();</span>
                }
<span class="nc" id="L1143">                return new Pair&lt;&gt;(null, null);</span>
            }
        }
<span class="nc" id="L1146">        Pair&lt;String, String&gt; imageInfo = new Pair&lt;&gt;(cursor.getString(cursor.getColumnIndex(filePathColumns[0])), cursor.getString(cursor.getColumnIndex(filePathColumns[1])));</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1863)) {</span>
<span class="nc" id="L1148">            cursor.close();</span>
        }
<span class="nc bnc" id="L1150" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(1864)) {</span>
<span class="nc" id="L1151">            Timber.d(&quot;getImageInfoFromContentResolver() decoded image info path/name %s/%s&quot;, imageInfo.first, imageInfo.second);</span>
        }
<span class="nc" id="L1153">        return imageInfo;</span>
    }

    public boolean isShowingPreview() {
<span class="nc bnc" id="L1157" title="All 2 branches missed.">        return mImageFileSize.getVisibility() == View.VISIBLE;</span>
    }

    private static class ImageViewModel {

        @Nullable
        public final String mImagePath;

        @Nullable
        public final Uri mImageUri;

<span class="nc" id="L1168">        public boolean isPreExistingImage = false;</span>

<span class="nc" id="L1170">        private ImageViewModel(@Nullable String mImagePath, @Nullable Uri mImageUri) {</span>
<span class="nc" id="L1171">            this.mImagePath = mImagePath;</span>
<span class="nc" id="L1172">            this.mImageUri = mImageUri;</span>
<span class="nc" id="L1173">        }</span>

        public static ImageViewModel fromBundle(Bundle savedInstanceState) {
<span class="nc" id="L1176">            String mImagePath = savedInstanceState.getString(&quot;mImagePath&quot;);</span>
<span class="nc" id="L1177">            Uri mImageUri = savedInstanceState.getParcelable(&quot;mImageUri&quot;);</span>
<span class="nc" id="L1178">            return new ImageViewModel(mImagePath, mImageUri);</span>
        }

        public void enrich(Bundle savedInstanceState) {
<span class="nc bnc" id="L1182" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1865)) {</span>
<span class="nc" id="L1183">                savedInstanceState.putString(&quot;mImagePath&quot;, mImagePath);</span>
            }
<span class="nc bnc" id="L1185" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1866)) {</span>
<span class="nc" id="L1186">                savedInstanceState.putParcelable(&quot;mImageUri&quot;, mImageUri);</span>
            }
<span class="nc" id="L1188">        }</span>

        @SuppressWarnings(&quot;BooleanMethodIsAlwaysInverted&quot;)
        public boolean isValid() {
<span class="nc bnc" id="L1192" title="All 10 branches missed.">            return (ListenerUtil.mutListener.listen(1867) ? (mImagePath != null || mImageUri != null) : (mImagePath != null &amp;&amp; mImageUri != null));</span>
        }

        public ImageViewModel replaceNullValues(IField mField, Context context) {
<span class="nc" id="L1196">            String newImagePath = mImagePath;</span>
<span class="nc" id="L1197">            Uri newImageUri = mImageUri;</span>
<span class="nc bnc" id="L1198" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1869)) {</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">                if (newImagePath == null) {</span>
<span class="nc bnc" id="L1200" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1868)) {</span>
<span class="nc" id="L1201">                        newImagePath = mField.getImagePath();</span>
                    }
                }
            }
<span class="nc bnc" id="L1205" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1872)) {</span>
<span class="nc bnc" id="L1206" title="All 10 branches missed.">                if ((ListenerUtil.mutListener.listen(1870) ? (newImageUri == null || newImagePath != null) : (newImageUri == null &amp;&amp; newImagePath != null))) {</span>
<span class="nc bnc" id="L1207" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1871)) {</span>
<span class="nc" id="L1208">                        newImageUri = getUriForFile(new File(newImagePath), context);</span>
                    }
                }
            }
<span class="nc" id="L1212">            ImageViewModel ivm = new ImageViewModel(newImagePath, newImageUri);</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1873)) {</span>
<span class="nc" id="L1214">                ivm.isPreExistingImage = true;</span>
            }
<span class="nc" id="L1216">            return ivm;</span>
        }

        public void deleteImagePath() {
<span class="nc bnc" id="L1220" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(1877)) {</span>
<span class="nc bnc" id="L1221" title="All 10 branches missed.">                if ((ListenerUtil.mutListener.listen(1874) ? (mImagePath != null || new File(mImagePath).exists()) : (mImagePath != null &amp;&amp; new File(mImagePath).exists()))) {</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(1876)) {</span>
<span class="nc bnc" id="L1223" title="All 2 branches missed.">                        if (!new File(mImagePath).delete()) {</span>
<span class="nc bnc" id="L1224" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(1875)) {</span>
<span class="nc" id="L1225">                                Timber.i(&quot;revertToPreviousImage() had existing image, but delete failed&quot;);</span>
                            }
                        }
                    }
                }
            }
<span class="nc" id="L1231">        }</span>

        public ImageViewModel beforeCrop(String imagePath, Uri imageUri) {
<span class="nc" id="L1234">            return new ImageViewModel(imagePath, imageUri);</span>
        }

        public ImageViewModel rotateAndCompressTo(String imagePath, Uri uri) {
<span class="nc" id="L1238">            return new ImageViewModel(imagePath, uri);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>