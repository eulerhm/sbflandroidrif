<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnkiPackageExporter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.libanki</a> &gt; <span class="el_source">AnkiPackageExporter.java</span></div><h1>AnkiPackageExporter.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2014 Timothy Rae   &lt;perceptualchaos2@gmail.com&gt;                        *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.libanki;

import android.content.Context;
import android.database.sqlite.SQLiteDatabase;
import com.ichi2.anki.CollectionHelper;
import com.ichi2.anki.R;
import com.ichi2.anki.exception.ImportExportException;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONException;
import com.ichi2.utils.JSONObject;
import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
import org.apache.commons.compress.archivers.zip.ZipArchiveOutputStream;
import timber.log.Timber;
import static com.ichi2.utils.CollectionUtils.addAll;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

class Exporter {

    protected final Collection mCol;

    protected Long mDid;

    protected int mCount;

<span class="nc" id="L55">    public Exporter(Collection col) {</span>
<span class="nc" id="L56">        mCol = col;</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20792)) {</span>
<span class="nc" id="L58">            mDid = null;</span>
        }
<span class="nc" id="L60">    }</span>

<span class="nc" id="L62">    public Exporter(Collection col, Long did) {</span>
<span class="nc" id="L63">        mCol = col;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20793)) {</span>
<span class="nc" id="L65">            mDid = did;</span>
        }
<span class="nc" id="L67">    }</span>

    /**
     * card ids of cards in deck self.did if it is set, all ids otherwise.
     */
    public Long[] cardIds() {
        Long[] cids;
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (mDid == null) {</span>
<span class="nc" id="L75">            cids = Utils.list2ObjectArray(mCol.getDb().queryLongList(&quot;select id from cards&quot;));</span>
        } else {
<span class="nc" id="L77">            cids = mCol.getDecks().cids(mDid, true);</span>
        }
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20794)) {</span>
<span class="nc" id="L80">            mCount = cids.length;</span>
        }
<span class="nc" id="L82">        return cids;</span>
    }
}

@SuppressWarnings({ &quot;PMD.AvoidReassigningParameters&quot;, &quot;PMD.DefaultPackage&quot;, &quot;PMD.NPathComplexity&quot;, &quot;PMD.MethodNamingConventions&quot;, &quot;PMD.ExcessiveMethodLength&quot;, &quot;PMD.EmptyIfStmt&quot;, &quot;PMD.CollapsibleIfStatements&quot; })
class AnkiExporter extends Exporter {

    protected boolean mIncludeSched;

    protected boolean mIncludeMedia;

    private Collection mSrc;

    String mMediaDir;

    // Actual capacity will be set when known, if media are imported.
<span class="nc" id="L98">    final ArrayList&lt;String&gt; mMediaFiles = new ArrayList&lt;&gt;(0);</span>

    boolean _v2sched;

    public AnkiExporter(Collection col) {
<span class="nc" id="L103">        super(col);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20795)) {</span>
<span class="nc" id="L105">            mIncludeSched = false;</span>
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20796)) {</span>
<span class="nc" id="L108">            mIncludeMedia = true;</span>
        }
<span class="nc" id="L110">    }</span>

    public void exportInto(String path, Context context) throws JSONException, IOException, ImportExportException {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20797)) {</span>
            // create a new collection at the target
<span class="nc" id="L115">            new File(path).delete();</span>
        }
<span class="nc" id="L117">        Collection dst = Storage.Collection(context, path);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20798)) {</span>
<span class="nc" id="L119">            mSrc = mCol;</span>
        }
        // find cards
<span class="nc" id="L122">        Long[] cids = cardIds();</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20799)) {</span>
            // flexible
<span class="nc" id="L125">            dst.close();</span>
        }
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20800)) {</span>
<span class="nc" id="L128">            Timber.d(&quot;Attach DB&quot;);</span>
        }
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20801)) {</span>
<span class="nc" id="L131">            mSrc.getDb().getDatabase().execSQL(&quot;ATTACH '&quot; + path + &quot;' AS DST_DB&quot;);</span>
        }
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20802)) {</span>
            // copy cards, noting used nids (as unique set)
<span class="nc" id="L135">            Timber.d(&quot;Copy cards&quot;);</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20803)) {</span>
<span class="nc" id="L138">            mSrc.getDb().getDatabase().execSQL(&quot;INSERT INTO DST_DB.cards select * from cards where id in &quot; + Utils.ids2str(cids));</span>
        }
<span class="nc" id="L140">        List&lt;Long&gt; uniqueNids = mSrc.getDb().queryLongList(&quot;select distinct nid from cards where id in &quot; + Utils.ids2str(cids));</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20804)) {</span>
            // notes
<span class="nc" id="L143">            Timber.d(&quot;Copy notes&quot;);</span>
        }
<span class="nc" id="L145">        String strnids = Utils.ids2str(uniqueNids);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20805)) {</span>
<span class="nc" id="L147">            mSrc.getDb().getDatabase().execSQL(&quot;INSERT INTO DST_DB.notes select * from notes where id in &quot; + strnids);</span>
        }
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20817)) {</span>
            // remove system tags if not exporting scheduling info
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (!mIncludeSched) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20806)) {</span>
<span class="nc" id="L153">                    Timber.d(&quot;Stripping system tags from list&quot;);</span>
                }
<span class="nc" id="L155">                ArrayList&lt;String&gt; srcTags = mSrc.getDb().queryStringList(&quot;select tags from notes where id in &quot; + strnids);</span>
<span class="nc" id="L156">                ArrayList&lt;Object[]&gt; args = new ArrayList&lt;&gt;(srcTags.size());</span>
<span class="nc" id="L157">                Object[] arg = new Object[2];</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20815)) {</span>
                    {
<span class="nc" id="L160">                        long _loopCounter443 = 0;</span>
<span class="nc bnc" id="L161" title="All 22 branches missed.">                        for (int row = 0; (ListenerUtil.mutListener.listen(20814) ? (row &gt;= srcTags.size()) : (ListenerUtil.mutListener.listen(20813) ? (row &lt;= srcTags.size()) : (ListenerUtil.mutListener.listen(20812) ? (row &gt; srcTags.size()) : (ListenerUtil.mutListener.listen(20811) ? (row != srcTags.size()) : (ListenerUtil.mutListener.listen(20810) ? (row == srcTags.size()) : (row &lt; srcTags.size())))))); row++) {</span>
<span class="nc" id="L162">                            ListenerUtil.loopListener.listen(&quot;_loopCounter443&quot;, ++_loopCounter443);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20807)) {</span>
<span class="nc" id="L164">                                arg[0] = removeSystemTags(srcTags.get(row));</span>
                            }
<span class="nc bnc" id="L166" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20808)) {</span>
<span class="nc" id="L167">                                arg[1] = uniqueNids.get(row);</span>
                            }
<span class="nc bnc" id="L169" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20809)) {</span>
<span class="nc" id="L170">                                args.add(row, arg);</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L175" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20816)) {</span>
<span class="nc" id="L176">                    mSrc.getDb().executeMany(&quot;UPDATE DST_DB.notes set tags=? where id=?&quot;, args);</span>
                }
            }
        }
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20818)) {</span>
            // models used by the notes
<span class="nc" id="L182">            Timber.d(&quot;Finding models used by notes&quot;);</span>
        }
<span class="nc" id="L184">        ArrayList&lt;Long&gt; mids = mSrc.getDb().queryLongList(&quot;select distinct mid from DST_DB.notes where id in &quot; + strnids);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20828)) {</span>
            // card history and revlog
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (mIncludeSched) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20824)) {</span>
<span class="nc" id="L189">                    Timber.d(&quot;Copy history and revlog&quot;);</span>
                }
<span class="nc bnc" id="L191" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20825)) {</span>
<span class="nc" id="L192">                    mSrc.getDb().getDatabase().execSQL(&quot;insert into DST_DB.revlog select * from revlog where cid in &quot; + Utils.ids2str(cids));</span>
                }
<span class="nc bnc" id="L194" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20826)) {</span>
                    // reopen collection to destination database (different from original python code)
<span class="nc" id="L196">                    mSrc.getDb().getDatabase().execSQL(&quot;DETACH DST_DB&quot;);</span>
                }
<span class="nc bnc" id="L198" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20827)) {</span>
<span class="nc" id="L199">                    dst.reopen();</span>
                }
            } else {
<span class="nc bnc" id="L202" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20819)) {</span>
<span class="nc" id="L203">                    Timber.d(&quot;Detaching destination db and reopening&quot;);</span>
                }
<span class="nc bnc" id="L205" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20820)) {</span>
                    // first reopen collection to destination database (different from original python code)
<span class="nc" id="L207">                    mSrc.getDb().getDatabase().execSQL(&quot;DETACH DST_DB&quot;);</span>
                }
<span class="nc bnc" id="L209" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20821)) {</span>
<span class="nc" id="L210">                    dst.reopen();</span>
                }
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20822)) {</span>
                    // then need to reset card state
<span class="nc" id="L214">                    Timber.d(&quot;Resetting cards&quot;);</span>
                }
<span class="nc bnc" id="L216" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20823)) {</span>
<span class="nc" id="L217">                    dst.getSched().resetCards(cids);</span>
                }
            }
        }
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20829)) {</span>
            // models - start with zero
<span class="nc" id="L223">            Timber.d(&quot;Copy models&quot;);</span>
        }
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20832)) {</span>
            {
<span class="nc" id="L227">                long _loopCounter444 = 0;</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                for (Model m : mSrc.getModels().all()) {</span>
<span class="nc" id="L229">                    ListenerUtil.loopListener.listen(&quot;_loopCounter444&quot;, ++_loopCounter444);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20831)) {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                        if (mids.contains(m.getLong(&quot;id&quot;))) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20830)) {</span>
<span class="nc" id="L233">                                dst.getModels().update(m);</span>
                            }
                        }
                    }
<span class="nc" id="L237">                }</span>
            }
        }
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20833)) {</span>
            // decks
<span class="nc" id="L242">            Timber.d(&quot;Copy decks&quot;);</span>
        }
<span class="nc" id="L244">        java.util.Collection&lt;Long&gt; dids = null;</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20836)) {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (mDid != null) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20834)) {</span>
<span class="nc" id="L248">                    dids = new HashSet&lt;&gt;(mSrc.getDecks().children(mDid).values());</span>
                }
<span class="nc bnc" id="L250" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20835)) {</span>
<span class="nc" id="L251">                    dids.add(mDid);</span>
                }
            }
        }
<span class="nc" id="L255">        JSONObject dconfs = new JSONObject();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20847)) {</span>
            {
<span class="nc" id="L258">                long _loopCounter445 = 0;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                for (Deck d : mSrc.getDecks().all()) {</span>
<span class="nc" id="L260">                    ListenerUtil.loopListener.listen(&quot;_loopCounter445&quot;, ++_loopCounter445);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20837)) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                        if (&quot;1&quot;.equals(d.getString(&quot;id&quot;))) {</span>
<span class="nc" id="L263">                            continue;</span>
                        }
                    }
<span class="nc bnc" id="L266" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20839)) {</span>
<span class="nc bnc" id="L267" title="All 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(20838) ? (dids != null || !dids.contains(d.getLong(&quot;id&quot;))) : (dids != null &amp;&amp; !dids.contains(d.getLong(&quot;id&quot;))))) {</span>
<span class="nc" id="L268">                            continue;</span>
                        }
                    }
<span class="nc bnc" id="L271" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20843)) {</span>
<span class="nc bnc" id="L272" title="All 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(20840) ? (d.isStd() || d.getLong(&quot;conf&quot;) != 1L) : (d.isStd() &amp;&amp; d.getLong(&quot;conf&quot;) != 1L))) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20842)) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                                if (mIncludeSched) {</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(20841)) {</span>
<span class="nc" id="L276">                                        dconfs.put(Long.toString(d.getLong(&quot;conf&quot;)), true);</span>
                                    }
                                }
                            }
                        }
                    }
<span class="nc" id="L282">                    Deck destinationDeck = d.deepClone();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20845)) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                        if (!mIncludeSched) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20844)) {</span>
                                // scheduling not included, so reset deck settings to default
<span class="nc" id="L287">                                destinationDeck.put(&quot;conf&quot;, 1);</span>
                            }
                        }
                    }
<span class="nc bnc" id="L291" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20846)) {</span>
<span class="nc" id="L292">                        dst.getDecks().update(destinationDeck);</span>
                    }
<span class="nc" id="L294">                }</span>
            }
        }
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20848)) {</span>
            // copy used deck confs
<span class="nc" id="L299">            Timber.d(&quot;Copy deck options&quot;);</span>
        }
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20851)) {</span>
            {
<span class="nc" id="L303">                long _loopCounter446 = 0;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                for (DeckConfig dc : mSrc.getDecks().allConf()) {</span>
<span class="nc" id="L305">                    ListenerUtil.loopListener.listen(&quot;_loopCounter446&quot;, ++_loopCounter446);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20850)) {</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                        if (dconfs.has(dc.getString(&quot;id&quot;))) {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20849)) {</span>
<span class="nc" id="L309">                                dst.getDecks().updateConf(dc);</span>
                            }
                        }
                    }
<span class="nc" id="L313">                }</span>
            }
        }
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20852)) {</span>
            // find used media
<span class="nc" id="L318">            Timber.d(&quot;Find used media&quot;);</span>
        }
<span class="nc" id="L320">        JSONObject media = new JSONObject();</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20853)) {</span>
<span class="nc" id="L322">            mMediaDir = mSrc.getMedia().dir();</span>
        }
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20870)) {</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            if (mIncludeMedia) {</span>
<span class="nc" id="L326">                ArrayList&lt;Long&gt; mid = mSrc.getDb().queryLongList(&quot;select mid from notes where id in &quot; + strnids);</span>
<span class="nc" id="L327">                ArrayList&lt;String&gt; flds = mSrc.getDb().queryStringList(&quot;select flds from notes where id in &quot; + strnids);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20862)) {</span>
                    {
<span class="nc" id="L330">                        long _loopCounter448 = 0;</span>
<span class="nc bnc" id="L331" title="All 22 branches missed.">                        for (int idx = 0; (ListenerUtil.mutListener.listen(20861) ? (idx &gt;= mid.size()) : (ListenerUtil.mutListener.listen(20860) ? (idx &lt;= mid.size()) : (ListenerUtil.mutListener.listen(20859) ? (idx &gt; mid.size()) : (ListenerUtil.mutListener.listen(20858) ? (idx != mid.size()) : (ListenerUtil.mutListener.listen(20857) ? (idx == mid.size()) : (idx &lt; mid.size())))))); idx++) {</span>
<span class="nc" id="L332">                            ListenerUtil.loopListener.listen(&quot;_loopCounter448&quot;, ++_loopCounter448);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20856)) {</span>
                                {
<span class="nc" id="L335">                                    long _loopCounter447 = 0;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                                    for (String file : mSrc.getMedia().filesInStr(mid.get(idx), flds.get(idx))) {</span>
<span class="nc" id="L337">                                        ListenerUtil.loopListener.listen(&quot;_loopCounter447&quot;, ++_loopCounter447);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(20854)) {</span>
                                            // skip files in subdirs
<span class="nc bnc" id="L340" title="All 2 branches missed.">                                            if (file.contains(File.separator)) {</span>
<span class="nc" id="L341">                                                continue;</span>
                                            }
                                        }
<span class="nc bnc" id="L344" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(20855)) {</span>
<span class="nc" id="L345">                                            media.put(file, true);</span>
                                        }
<span class="nc" id="L347">                                    }</span>
                                }
                            }
                        }
                    }
                }
<span class="nc bnc" id="L353" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20869)) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                    if (mMediaDir != null) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(20868)) {</span>
                            {
<span class="nc" id="L357">                                long _loopCounter450 = 0;</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                                for (File f : new File(mMediaDir).listFiles()) {</span>
<span class="nc" id="L359">                                    ListenerUtil.loopListener.listen(&quot;_loopCounter450&quot;, ++_loopCounter450);</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(20863)) {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                                        if (f.isDirectory()) {</span>
<span class="nc" id="L362">                                            continue;</span>
                                        }
                                    }
<span class="nc" id="L365">                                    String fname = f.getName();</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(20867)) {</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                                        if (fname.startsWith(&quot;_&quot;)) {</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(20866)) {</span>
                                                {
<span class="nc" id="L370">                                                    long _loopCounter449 = 0;</span>
                                                    // Loop through every model that will be exported, and check if it contains a reference to f
<span class="nc bnc" id="L372" title="All 2 branches missed.">                                                    for (JSONObject model : mSrc.getModels().all()) {</span>
<span class="nc" id="L373">                                                        ListenerUtil.loopListener.listen(&quot;_loopCounter449&quot;, ++_loopCounter449);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(20865)) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                                                            if (_modelHasMedia(model, fname)) {</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(20864)) {</span>
<span class="nc" id="L377">                                                                    media.put(fname, true);</span>
                                                                }
                                                                break;
                                                            }
                                                        }
<span class="nc" id="L382">                                                    }</span>
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L394">        JSONArray keys = media.names();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20873)) {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">            if (keys != null) {</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20871)) {</span>
<span class="nc" id="L398">                    mMediaFiles.ensureCapacity(keys.length());</span>
                }
<span class="nc bnc" id="L400" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20872)) {</span>
<span class="nc" id="L401">                    addAll(mMediaFiles, keys.stringIterable());</span>
                }
            }
        }
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20874)) {</span>
<span class="nc" id="L406">            Timber.d(&quot;Cleanup&quot;);</span>
        }
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20875)) {</span>
<span class="nc" id="L409">            dst.setCrt(mSrc.getCrt());</span>
        }
<span class="nc bnc" id="L411" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20876)) {</span>
            // todo: tags?
<span class="nc" id="L413">            mCount = dst.cardCount();</span>
        }
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20877)) {</span>
<span class="nc" id="L416">            dst.setMod();</span>
        }
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20878)) {</span>
<span class="nc" id="L419">            postExport();</span>
        }
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20879)) {</span>
<span class="nc" id="L422">            dst.close();</span>
        }
<span class="nc" id="L424">    }</span>

    /**
     * Returns whether or not the specified model contains a reference to the given media file.
     * In order to ensure relatively fast operation we only check if the styling, front, back templates *contain* fname,
     * and thus must allow for occasional false positives.
     * @param model the model to scan
     * @param fname the name of the media file to check for
     * @return
     * @throws JSONException
     */
    private boolean _modelHasMedia(JSONObject model, String fname) throws JSONException {
<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20881)) {</span>
            // Don't crash if the model is null
<span class="nc bnc" id="L438" title="All 2 branches missed.">            if (model == null) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20880)) {</span>
<span class="nc" id="L440">                    Timber.w(&quot;_modelHasMedia given null model&quot;);</span>
                }
<span class="nc" id="L442">                return true;</span>
            }
        }
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20882)) {</span>
            // First check the styling
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (model.getString(&quot;css&quot;).contains(fname)) {</span>
<span class="nc" id="L448">                return true;</span>
            }
        }
        // If not there then check the templates
<span class="nc" id="L452">        JSONArray tmpls = model.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20885)) {</span>
            {
<span class="nc" id="L455">                long _loopCounter451 = 0;</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                for (JSONObject tmpl : tmpls.jsonObjectIterable()) {</span>
<span class="nc" id="L457">                    ListenerUtil.loopListener.listen(&quot;_loopCounter451&quot;, ++_loopCounter451);</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20884)) {</span>
<span class="nc bnc" id="L459" title="All 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(20883) ? (tmpl.getString(&quot;qfmt&quot;).contains(fname) &amp;&amp; tmpl.getString(&quot;afmt&quot;).contains(fname)) : (tmpl.getString(&quot;qfmt&quot;).contains(fname) || tmpl.getString(&quot;afmt&quot;).contains(fname)))) {</span>
<span class="nc" id="L460">                            return true;</span>
                        }
                    }
<span class="nc" id="L463">                }</span>
            }
        }
<span class="nc" id="L466">        return false;</span>
    }

    /**
     * override to apply customizations to the deck before it's closed, such as update the deck description
     */
    protected void postExport() {
<span class="nc" id="L473">    }</span>

    private String removeSystemTags(String tags) {
<span class="nc" id="L476">        return mSrc.getTags().remFromStr(&quot;marked leech&quot;, tags);</span>
    }

    public void setIncludeSched(boolean includeSched) {
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20886)) {</span>
<span class="nc" id="L481">            mIncludeSched = includeSched;</span>
        }
<span class="nc" id="L483">    }</span>

    public void setIncludeMedia(boolean includeMedia) {
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20887)) {</span>
<span class="nc" id="L487">            mIncludeMedia = includeMedia;</span>
        }
<span class="nc" id="L489">    }</span>

    public void setDid(Long did) {
<span class="nc bnc" id="L492" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20888)) {</span>
<span class="nc" id="L493">            mDid = did;</span>
        }
<span class="nc" id="L495">    }</span>
}

public final class AnkiPackageExporter extends AnkiExporter {

    public AnkiPackageExporter(Collection col) {
<span class="nc" id="L501">        super(col);</span>
<span class="nc" id="L502">    }</span>

    @Override
    public void exportInto(String path, Context context) throws IOException, JSONException, ImportExportException {
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20889)) {</span>
            // sched info+v2 scheduler not compatible w/ older clients
<span class="nc" id="L508">            Timber.i(&quot;Starting export into %s&quot;, path);</span>
        }
<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20896)) {</span>
<span class="nc bnc" id="L511" title="All 50 branches missed.">            _v2sched = (ListenerUtil.mutListener.listen(20895) ? ((ListenerUtil.mutListener.listen(20894) ? (mCol.schedVer() &gt;= 1) : (ListenerUtil.mutListener.listen(20893) ? (mCol.schedVer() &lt;= 1) : (ListenerUtil.mutListener.listen(20892) ? (mCol.schedVer() &gt; 1) : (ListenerUtil.mutListener.listen(20891) ? (mCol.schedVer() &lt; 1) : (ListenerUtil.mutListener.listen(20890) ? (mCol.schedVer() == 1) : (mCol.schedVer() != 1)))))) || mIncludeSched) : ((ListenerUtil.mutListener.listen(20894) ? (mCol.schedVer() &gt;= 1) : (ListenerUtil.mutListener.listen(20893) ? (mCol.schedVer() &lt;= 1) : (ListenerUtil.mutListener.listen(20892) ? (mCol.schedVer() &gt; 1) : (ListenerUtil.mutListener.listen(20891) ? (mCol.schedVer() &lt; 1) : (ListenerUtil.mutListener.listen(20890) ? (mCol.schedVer() == 1) : (mCol.schedVer() != 1)))))) &amp;&amp; mIncludeSched));</span>
        }
        // open a zip file
<span class="nc" id="L514">        ZipFile z = new ZipFile(path);</span>
        // if all decks and scheduling included, full export
        JSONObject media;
<span class="nc bnc" id="L517" title="All 10 branches missed.">        if ((ListenerUtil.mutListener.listen(20897) ? (mIncludeSched || mDid == null) : (mIncludeSched &amp;&amp; mDid == null))) {</span>
<span class="nc" id="L518">            media = exportVerbatim(z, context);</span>
        } else {
            // otherwise, filter
<span class="nc" id="L521">            media = exportFiltered(z, path, context);</span>
        }
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20898)) {</span>
            // media map
<span class="nc" id="L525">            z.writeStr(&quot;media&quot;, Utils.jsonToString(media));</span>
        }
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20899)) {</span>
<span class="nc" id="L528">            z.close();</span>
        }
<span class="nc" id="L530">    }</span>

    private JSONObject exportVerbatim(ZipFile z, Context context) throws IOException {
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20900)) {</span>
            // close our deck &amp; write it into the zip file, and reopen
<span class="nc" id="L535">            mCount = mCol.cardCount();</span>
        }
<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20901)) {</span>
<span class="nc" id="L538">            mCol.close();</span>
        }
<span class="nc bnc" id="L540" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20905)) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (!_v2sched) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20904)) {</span>
<span class="nc" id="L543">                    z.write(mCol.getPath(), CollectionHelper.COLLECTION_FILENAME);</span>
                }
            } else {
<span class="nc bnc" id="L546" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20902)) {</span>
<span class="nc" id="L547">                    _addDummyCollection(z, context);</span>
                }
<span class="nc bnc" id="L549" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20903)) {</span>
<span class="nc" id="L550">                    z.write(mCol.getPath(), &quot;collection.anki21&quot;);</span>
                }
            }
        }
<span class="nc bnc" id="L554" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20906)) {</span>
<span class="nc" id="L555">            mCol.reopen();</span>
        }
        // copy all media
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (!mIncludeMedia) {</span>
<span class="nc" id="L559">            return new JSONObject();</span>
        }
<span class="nc" id="L561">        File mdir = new File(mCol.getMedia().dir());</span>
<span class="nc bnc" id="L562" title="All 10 branches missed.">        if ((ListenerUtil.mutListener.listen(20907) ? (mdir.exists() || mdir.isDirectory()) : (mdir.exists() &amp;&amp; mdir.isDirectory()))) {</span>
<span class="nc" id="L563">            File[] mediaFiles = mdir.listFiles();</span>
<span class="nc" id="L564">            return _exportMedia(z, mediaFiles, ValidateFiles.SKIP_VALIDATION);</span>
        } else {
<span class="nc" id="L566">            return new JSONObject();</span>
        }
    }

    private JSONObject _exportMedia(ZipFile z, ArrayList&lt;String&gt; fileNames, String mdir) throws IOException {
<span class="nc" id="L571">        int size = fileNames.size();</span>
<span class="nc" id="L572">        int i = 0;</span>
<span class="nc" id="L573">        File[] files = new File[size];</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20909)) {</span>
            {
<span class="nc" id="L576">                long _loopCounter452 = 0;</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                for (String fileName : fileNames) {</span>
<span class="nc" id="L578">                    ListenerUtil.loopListener.listen(&quot;_loopCounter452&quot;, ++_loopCounter452);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20908)) {</span>
<span class="nc" id="L580">                        files[i++] = new File(mdir, fileName);</span>
                    }
<span class="nc" id="L582">                }</span>
            }
        }
<span class="nc" id="L585">        return _exportMedia(z, files, ValidateFiles.VALIDATE);</span>
    }

    private JSONObject _exportMedia(ZipFile z, File[] files, ValidateFiles validateFiles) throws IOException {
<span class="nc" id="L589">        int c = 0;</span>
<span class="nc" id="L590">        JSONObject media = new JSONObject();</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20917)) {</span>
            {
<span class="nc" id="L593">                long _loopCounter453 = 0;</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">                for (File file : files) {</span>
<span class="nc" id="L595">                    ListenerUtil.loopListener.listen(&quot;_loopCounter453&quot;, ++_loopCounter453);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20912)) {</span>
                        // todo: deflate SVG files, as in dae/anki@a5b0852360b132c0d04094f5ca8f1933f64d7c7e
<span class="nc bnc" id="L598" title="All 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(20910) ? (validateFiles == ValidateFiles.VALIDATE || !file.exists()) : (validateFiles == ValidateFiles.VALIDATE &amp;&amp; !file.exists()))) {</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(20911)) {</span>
                                // Anki 2.1.30 does the same
<span class="nc" id="L601">                                Timber.d(&quot;Skipping missing file %s&quot;, file);</span>
                            }
                            continue;
                        }
                    }
<span class="nc bnc" id="L606" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20913)) {</span>
<span class="nc" id="L607">                        z.write(file.getPath(), Integer.toString(c));</span>
                    }
                    try {
<span class="nc bnc" id="L610" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(20915)) {</span>
<span class="nc" id="L611">                            media.put(Integer.toString(c), file.getName());</span>
                        }
<span class="nc bnc" id="L613" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(20916)) {</span>
<span class="nc" id="L614">                            c++;</span>
                        }
<span class="nc" id="L616">                    } catch (JSONException e) {</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(20914)) {</span>
<span class="nc" id="L618">                            e.printStackTrace();</span>
                        }
<span class="nc" id="L620">                    }</span>
                }
            }
        }
<span class="nc" id="L624">        return media;</span>
    }

    private JSONObject exportFiltered(ZipFile z, String path, Context context) throws IOException, JSONException, ImportExportException {
        // export into the anki2 file
<span class="nc" id="L629">        String colfile = path.replace(&quot;.apkg&quot;, &quot;.anki2&quot;);</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20918)) {</span>
<span class="nc" id="L631">            super.exportInto(colfile, context);</span>
        }
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20919)) {</span>
<span class="nc" id="L634">            z.write(colfile, CollectionHelper.COLLECTION_FILENAME);</span>
        }
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20920)) {</span>
            // and media
<span class="nc" id="L638">            prepareMedia();</span>
        }
<span class="nc" id="L640">        JSONObject media = _exportMedia(z, mMediaFiles, mCol.getMedia().dir());</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20921)) {</span>
            // tidy up intermediate files
<span class="nc" id="L643">            SQLiteDatabase.deleteDatabase(new File(colfile));</span>
        }
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20922)) {</span>
<span class="nc" id="L646">            SQLiteDatabase.deleteDatabase(new File(path.replace(&quot;.apkg&quot;, &quot;.media.ad.db2&quot;)));</span>
        }
<span class="nc" id="L648">        String tempPath = path.replace(&quot;.apkg&quot;, &quot;.media&quot;);</span>
<span class="nc" id="L649">        File file = new File(tempPath);</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20924)) {</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            if (file.exists()) {</span>
<span class="nc" id="L652">                String deleteCmd = &quot;rm -r &quot; + tempPath;</span>
<span class="nc" id="L653">                Runtime runtime = Runtime.getRuntime();</span>
                try {
<span class="nc bnc" id="L655" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20923)) {</span>
<span class="nc" id="L656">                        runtime.exec(deleteCmd);</span>
                    }
<span class="nc" id="L658">                } catch (IOException ignored) {</span>
<span class="nc" id="L659">                }</span>
            }
        }
<span class="nc" id="L662">        return media;</span>
    }

    protected void prepareMedia() {
<span class="nc" id="L666">    }</span>

    // data they don't understand
    private void _addDummyCollection(ZipFile zip, Context context) throws IOException {
<span class="nc" id="L670">        File f = File.createTempFile(&quot;dummy&quot;, &quot;.anki2&quot;);</span>
<span class="nc" id="L671">        String path = f.getAbsolutePath();</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20925)) {</span>
<span class="nc" id="L673">            f.delete();</span>
        }
<span class="nc" id="L675">        Collection c = Storage.Collection(context, path);</span>
<span class="nc" id="L676">        Note n = c.newNote();</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20926)) {</span>
            // The field names for those are localised during creation, so we need to consider that when creating dummy note
<span class="nc" id="L679">            n.setItem(context.getString(R.string.front_field_name), context.getString(R.string.export_v2_dummy_note));</span>
        }
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20927)) {</span>
<span class="nc" id="L682">            c.addNote(n);</span>
        }
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20928)) {</span>
<span class="nc" id="L685">            c.save();</span>
        }
<span class="nc bnc" id="L687" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20929)) {</span>
<span class="nc" id="L688">            c.close();</span>
        }
<span class="nc bnc" id="L690" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20930)) {</span>
<span class="nc" id="L691">            zip.write(f.getAbsolutePath(), CollectionHelper.COLLECTION_FILENAME);</span>
        }
<span class="nc" id="L693">    }</span>

    /**
     * Whether media files should be validated before being added to the zip
     */
<span class="nc" id="L698">    private enum ValidateFiles {</span>

<span class="nc" id="L700">        VALIDATE, SKIP_VALIDATION</span>
    }
}

/**
 * Wrapper around standard Python zip class used in this module for exporting to APKG
 *
 * @author Tim
 */
class ZipFile {

<span class="nc" id="L711">    private final int BUFFER_SIZE = 1024;</span>

    private ZipArchiveOutputStream mZos;

<span class="nc" id="L715">    public ZipFile(String path) throws FileNotFoundException {</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20931)) {</span>
<span class="nc" id="L717">            mZos = new ZipArchiveOutputStream(new BufferedOutputStream(new FileOutputStream(path)));</span>
        }
<span class="nc" id="L719">    }</span>

    public void write(String path, String entry) throws IOException {
<span class="nc" id="L722">        BufferedInputStream bis = new BufferedInputStream(new FileInputStream(path), BUFFER_SIZE);</span>
<span class="nc" id="L723">        ZipArchiveEntry ze = new ZipArchiveEntry(entry);</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20932)) {</span>
<span class="nc" id="L725">            writeEntry(bis, ze);</span>
        }
<span class="nc" id="L727">    }</span>

    public void writeStr(String entry, String value) throws IOException {
        // TODO: Does this work with abnormal characters?
<span class="nc" id="L731">        InputStream is = new ByteArrayInputStream(value.getBytes());</span>
<span class="nc" id="L732">        BufferedInputStream bis = new BufferedInputStream(is, BUFFER_SIZE);</span>
<span class="nc" id="L733">        ZipArchiveEntry ze = new ZipArchiveEntry(entry);</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20933)) {</span>
<span class="nc" id="L735">            writeEntry(bis, ze);</span>
        }
<span class="nc" id="L737">    }</span>

    private void writeEntry(BufferedInputStream bis, ZipArchiveEntry ze) throws IOException {
<span class="nc" id="L740">        byte[] buf = new byte[BUFFER_SIZE];</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20934)) {</span>
<span class="nc" id="L742">            mZos.putArchiveEntry(ze);</span>
        }
        int len;
<span class="nc bnc" id="L745" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20941)) {</span>
            {
<span class="nc" id="L747">                long _loopCounter454 = 0;</span>
<span class="nc bnc" id="L748" title="All 22 branches missed.">                while ((ListenerUtil.mutListener.listen(20940) ? ((len = bis.read(buf, 0, BUFFER_SIZE)) &gt;= -1) : (ListenerUtil.mutListener.listen(20939) ? ((len = bis.read(buf, 0, BUFFER_SIZE)) &lt;= -1) : (ListenerUtil.mutListener.listen(20938) ? ((len = bis.read(buf, 0, BUFFER_SIZE)) &gt; -1) : (ListenerUtil.mutListener.listen(20937) ? ((len = bis.read(buf, 0, BUFFER_SIZE)) &lt; -1) : (ListenerUtil.mutListener.listen(20936) ? ((len = bis.read(buf, 0, BUFFER_SIZE)) == -1) : ((len = bis.read(buf, 0, BUFFER_SIZE)) != -1))))))) {</span>
<span class="nc" id="L749">                    ListenerUtil.loopListener.listen(&quot;_loopCounter454&quot;, ++_loopCounter454);</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(20935)) {</span>
<span class="nc" id="L751">                        mZos.write(buf, 0, len);</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L756" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20942)) {</span>
<span class="nc" id="L757">            mZos.closeArchiveEntry();</span>
        }
<span class="nc bnc" id="L759" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20943)) {</span>
<span class="nc" id="L760">            bis.close();</span>
        }
<span class="nc" id="L762">    }</span>

    public void close() {
        try {
<span class="nc bnc" id="L766" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20945)) {</span>
<span class="nc" id="L767">                mZos.close();</span>
            }
<span class="nc" id="L769">        } catch (IOException e) {</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20944)) {</span>
<span class="nc" id="L771">                e.printStackTrace();</span>
            }
<span class="nc" id="L773">        }</span>
<span class="nc" id="L774">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>