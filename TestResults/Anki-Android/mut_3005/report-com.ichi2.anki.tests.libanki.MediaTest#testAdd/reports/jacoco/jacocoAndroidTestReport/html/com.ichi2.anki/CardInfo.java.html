<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CardInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki</a> &gt; <span class="el_source">CardInfo.java</span></div><h1>CardInfo.java</h1><pre class="source lang-java linenums">/*
 *  Copyright (c) 2020 David Allison &lt;davidallisongithub@gmail.com&gt;
 *
 *  This program is free software; you can redistribute it and/or modify it under
 *  the terms of the GNU General Public License as published by the Free Software
 *  Foundation; either version 3 of the License, or (at your option) any later
 *  version.
 *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package com.ichi2.anki;

import android.annotation.SuppressLint;
import android.content.Context;
import android.content.res.TypedArray;
import android.database.Cursor;
import android.os.Build;
import android.os.Bundle;
import android.text.Spannable;
import android.text.SpannableString;
import android.view.Gravity;
import android.view.View;
import android.widget.TableLayout;
import android.widget.TableRow;
import android.widget.TextView;
import com.ichi2.libanki.Card;
import com.ichi2.libanki.Collection;
import com.ichi2.libanki.Consts;
import com.ichi2.libanki.Model;
import com.ichi2.libanki.Models;
import com.ichi2.libanki.Utils;
import com.ichi2.ui.FixedTextView;
import com.ichi2.utils.FunctionalInterfaces;
import com.ichi2.utils.LanguageUtil;
import com.ichi2.utils.UiUtil;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import androidx.annotation.CheckResult;
import androidx.annotation.IdRes;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.VisibleForTesting;
import androidx.core.content.ContextCompat;
import timber.log.Timber;
import static com.ichi2.libanki.stats.Stats.SECONDS_PER_DAY;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L56">public class CardInfo extends AnkiActivity {</span>

    private static final long INVALID_CARD_ID = -1;

<span class="nc" id="L60">    private static final DateFormat sDateFormat = DateFormat.getDateInstance();</span>

<span class="nc" id="L62">    private static final DateFormat sDateTimeFormat = DateFormat.getDateTimeInstance();</span>

    private CardInfoModel mModel;

    private long mCardId;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6092)) {</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (showedActivityFailedScreen(savedInstanceState)) {</span>
<span class="nc" id="L72">                return;</span>
            }
        }
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6093)) {</span>
<span class="nc" id="L76">            super.onCreate(savedInstanceState);</span>
        }
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6094)) {</span>
<span class="nc" id="L79">            setContentView(R.layout.card_info);</span>
        }
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6095)) {</span>
<span class="nc" id="L82">            mCardId = getCardId(savedInstanceState);</span>
        }
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6098)) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (!hasValidCardId()) {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6096)) {</span>
<span class="nc" id="L87">                    UIUtils.showThemedToast(this, getString(R.string.multimedia_editor_something_wrong), false);</span>
                }
<span class="nc bnc" id="L89" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6097)) {</span>
<span class="nc" id="L90">                    finishWithoutAnimation();</span>
                }
<span class="nc" id="L92">                return;</span>
            }
        }
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6099)) {</span>
<span class="nc" id="L96">            enableToolbar();</span>
        }
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6100)) {</span>
<span class="nc" id="L99">            startLoadingCollection();</span>
        }
<span class="nc" id="L101">    }</span>

    @Override
    protected void onCollectionLoaded(Collection col) {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6101)) {</span>
<span class="nc" id="L106">            super.onCollectionLoaded(col);</span>
        }
<span class="nc" id="L108">        Card c = getCard(col);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6104)) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (c == null) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6102)) {</span>
<span class="nc" id="L112">                    UIUtils.showThemedToast(this, getString(R.string.multimedia_editor_something_wrong), false);</span>
                }
<span class="nc bnc" id="L114" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6103)) {</span>
<span class="nc" id="L115">                    finishWithoutAnimation();</span>
                }
<span class="nc" id="L117">                return;</span>
            }
        }
        // Candidate to move to background thread - can get hundreds of rows for bad cards.
<span class="nc" id="L121">        CardInfoModel model = CardInfoModel.create(c, col);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6105)) {</span>
<span class="nc" id="L123">            setText(R.id.card_info_added, formatDate(model.getAddedDate()));</span>
        }
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6106)) {</span>
<span class="nc" id="L126">            setIfNotNull(model.getFirstReviewDate(), R.id.card_info_first_review, R.id.card_info_first_review_label, this::formatDate);</span>
        }
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6107)) {</span>
<span class="nc" id="L129">            setIfNotNull(model.getLatestReviewDate(), R.id.card_info_latest_review, R.id.card_info_latest_review_label, this::formatDate);</span>
        }
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6108)) {</span>
<span class="nc" id="L132">            setIfNotNull(model.getDue(), R.id.card_info_due, R.id.card_info_due_label, s -&gt; s);</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6109)) {</span>
<span class="nc" id="L135">            setIfNotNull(model.getInterval(), R.id.card_info_interval, R.id.card_info_interval_label, s -&gt; getResources().getQuantityString(R.plurals.time_span_days, model.getInterval(), model.getInterval()));</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6110)) {</span>
<span class="nc" id="L138">            setIfNotNull(model.getEaseInPercent(), R.id.card_info_ease, R.id.card_info_ease_label, easePercent -&gt; formatDouble(&quot;%.0f%%&quot;, easePercent * 100));</span>
        }
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6111)) {</span>
<span class="nc" id="L141">            setFormattedText(R.id.card_info_review_count, &quot;%d&quot;, model.getReviews());</span>
        }
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6112)) {</span>
<span class="nc" id="L144">            setFormattedText(R.id.card_info_lapse_count, &quot;%d&quot;, model.getLapses());</span>
        }
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6113)) {</span>
<span class="nc" id="L147">            setIfNotNull(model.getAverageTimeMs(), R.id.card_info_average_time, R.id.card_info_average_time_label, this::formatAsTimeSpan);</span>
        }
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6114)) {</span>
<span class="nc" id="L150">            setIfNotNull(model.getTotalTimeMs(), R.id.card_info_total_time, R.id.card_info_total_time_label, this::formatAsTimeSpan);</span>
        }
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6115)) {</span>
<span class="nc" id="L153">            setText(R.id.card_info_card_type, model.getCardType());</span>
        }
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6116)) {</span>
<span class="nc" id="L156">            setText(R.id.card_info_note_type, model.getNoteType());</span>
        }
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6117)) {</span>
<span class="nc" id="L159">            setText(R.id.card_info_deck_name, model.getDeckName());</span>
        }
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6118)) {</span>
<span class="nc" id="L162">            setFormattedText(R.id.card_info_card_id, &quot;%d&quot;, model.getCardId());</span>
        }
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6119)) {</span>
<span class="nc" id="L165">            setFormattedText(R.id.card_info_note_id, &quot;%d&quot;, model.getNoteId());</span>
        }
<span class="nc" id="L167">        TableLayout tl = findViewById(R.id.card_info_revlog_entries);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6127)) {</span>
            {
<span class="nc" id="L170">                long _loopCounter113 = 0;</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                for (CardInfoModel.RevLogEntry entry : model.getEntries()) {</span>
<span class="nc" id="L172">                    ListenerUtil.loopListener.listen(&quot;_loopCounter113&quot;, ++_loopCounter113);</span>
<span class="nc" id="L173">                    TableRow row = new TableRow(this);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6120)) {</span>
<span class="nc" id="L175">                        addWithText(row, formatDateTime(entry.dateTime)).setGravity(Gravity.START);</span>
                    }
<span class="nc bnc" id="L177" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6121)) {</span>
<span class="nc" id="L178">                        addWithText(row, entry.spannableType(this)).setGravity(Gravity.CENTER_HORIZONTAL);</span>
                    }
<span class="nc bnc" id="L180" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6122)) {</span>
<span class="nc" id="L181">                        addWithText(row, entry.getRating(this)).setGravity(Gravity.CENTER_HORIZONTAL);</span>
                    }
<span class="nc bnc" id="L183" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6123)) {</span>
<span class="nc" id="L184">                        addWithText(row, Utils.timeQuantityNextIvl(this, entry.intervalAsTimeSeconds())).setGravity(Gravity.START);</span>
                    }
<span class="nc bnc" id="L186" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6124)) {</span>
<span class="nc" id="L187">                        addWithText(row, entry.getEase(this)).setGravity(Gravity.CENTER_HORIZONTAL);</span>
                    }
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6125)) {</span>
<span class="nc" id="L190">                        addWithText(row, entry.getTimeTaken()).setGravity(Gravity.END);</span>
                    }
<span class="nc bnc" id="L192" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6126)) {</span>
<span class="nc" id="L193">                        tl.addView(row);</span>
                    }
<span class="nc" id="L195">                }</span>
            }
        }
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6128)) {</span>
<span class="nc" id="L199">            this.mModel = model;</span>
        }
<span class="nc" id="L201">    }</span>

    private FixedTextView addWithText(TableRow row, String value) {
<span class="nc" id="L204">        return addWithText(row, new SpannableString(value));</span>
    }

    private FixedTextView addWithText(TableRow row, Spannable value) {
<span class="nc" id="L208">        FixedTextView text = new FixedTextView(this);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6129)) {</span>
<span class="nc" id="L210">            text.setText(value);</span>
        }
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6130)) {</span>
<span class="nc" id="L213">            text.setTextSize(12f);</span>
        }
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6131)) {</span>
<span class="nc" id="L216">            row.addView(text);</span>
        }
<span class="nc" id="L218">        return text;</span>
    }

    @NonNull
    private String formatAsTimeSpan(Long timeInMs) {
        // So, we use seconds
<span class="nc bnc" id="L224" title="All 8 branches missed.">        return getString(R.string.time_span_decimal_seconds, String.format(getLocale(), &quot;%.2f&quot;, (ListenerUtil.mutListener.listen(6135) ? (timeInMs % 1000d) : (ListenerUtil.mutListener.listen(6134) ? (timeInMs * 1000d) : (ListenerUtil.mutListener.listen(6133) ? (timeInMs - 1000d) : (ListenerUtil.mutListener.listen(6132) ? (timeInMs + 1000d) : (timeInMs / 1000d)))))));</span>
    }

    private &lt;T&gt; void setIfNotNull(T nullableData, @IdRes int dataRes, @IdRes int labelRes, FunctionalInterfaces.Function&lt;T, String&gt; asString) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6139)) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (nullableData == null) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6137)) {</span>
<span class="nc" id="L231">                    findViewById(dataRes).setVisibility(View.GONE);</span>
                }
<span class="nc bnc" id="L233" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6138)) {</span>
<span class="nc" id="L234">                    findViewById(labelRes).setVisibility(View.GONE);</span>
                }
            } else {
<span class="nc bnc" id="L237" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6136)) {</span>
<span class="nc" id="L238">                    setText(dataRes, asString.apply(nullableData));</span>
                }
            }
        }
<span class="nc" id="L242">    }</span>

    private void setFormattedText(@IdRes int resource, String formatSpecifier, long number) {
<span class="nc" id="L245">        String text = formatLong(formatSpecifier, number);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6140)) {</span>
<span class="nc" id="L247">            setText(resource, text);</span>
        }
<span class="nc" id="L249">    }</span>

    @NonNull
    private String formatLong(String formatSpecifier, long number) {
<span class="nc" id="L253">        return String.format(getLocale(), formatSpecifier, number);</span>
    }

    @NonNull
    private String formatDouble(String formatSpecifier, double number) {
<span class="nc" id="L258">        return String.format(getLocale(), formatSpecifier, number);</span>
    }

    private Locale getLocale() {
<span class="nc" id="L262">        return LanguageUtil.getLocaleCompat(getResources());</span>
    }

    private void setText(@IdRes int id, String text) {
<span class="nc" id="L266">        TextView view = findViewById(id);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6141)) {</span>
<span class="nc" id="L268">            view.setText(text);</span>
        }
<span class="nc" id="L270">    }</span>

    @Override
    protected void onSaveInstanceState(@NonNull Bundle outState) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6142)) {</span>
<span class="nc" id="L275">            super.onSaveInstanceState(outState);</span>
        }
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6143)) {</span>
<span class="nc" id="L278">            outState.putLong(&quot;cardId&quot;, mCardId);</span>
        }
<span class="nc" id="L280">    }</span>

    @SuppressLint(&quot;DirectDateInstantiation&quot;)
    private String formatDate(Long date) {
<span class="nc" id="L284">        return sDateFormat.format(new Date(date));</span>
    }

    @SuppressLint(&quot;DirectDateInstantiation&quot;)
    private String formatDateTime(long dateTime) {
<span class="nc" id="L289">        return sDateTimeFormat.format(new Date(dateTime));</span>
    }

    @Nullable
    private Card getCard(Collection col) {
<span class="nc" id="L294">        return col.getCard(mCardId);</span>
    }

    private boolean hasValidCardId() {
<span class="nc bnc" id="L298" title="All 22 branches missed.">        return (ListenerUtil.mutListener.listen(6148) ? (mCardId &gt;= 0) : (ListenerUtil.mutListener.listen(6147) ? (mCardId &lt;= 0) : (ListenerUtil.mutListener.listen(6146) ? (mCardId &lt; 0) : (ListenerUtil.mutListener.listen(6145) ? (mCardId != 0) : (ListenerUtil.mutListener.listen(6144) ? (mCardId == 0) : (mCardId &gt; 0))))));</span>
    }

    private long getCardId(Bundle savedInstanceState) {
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L303">            return savedInstanceState.getLong(&quot;cardId&quot;);</span>
        }
        try {
<span class="nc" id="L306">            return getIntent().getLongExtra(&quot;cardId&quot;, INVALID_CARD_ID);</span>
<span class="nc" id="L307">        } catch (Exception e) {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6149)) {</span>
<span class="nc" id="L309">                Timber.w(e, &quot;Failed to get Card Id&quot;);</span>
            }
<span class="nc" id="L311">            return INVALID_CARD_ID;</span>
        }
    }

    @VisibleForTesting(otherwise = VisibleForTesting.NONE)
    public CardInfoModel getModel() {
<span class="nc" id="L317">        return mModel;</span>
    }

    public static class CardInfoModel {

        private final long mAddedDate;

        @Nullable
        private final Long mFirstReviewDate;

        @Nullable
        private final Long mLatestReviewDate;

        private final String mDue;

        @Nullable
        private final Integer mInterval;

        @Nullable
        private final Double mEaseInPercent;

        private final int mLapses;

        private final int mReviews;

        @Nullable
        private final Long mAverageTimeMs;

        @Nullable
        private final Long mTotalTimeMs;

        private final String mCardType;

        private final String mNoteType;

        private final String mDeckName;

        private final long mNoteId;

        private final List&lt;RevLogEntry&gt; mEntries;

<span class="nc" id="L358">        public CardInfoModel(long createdDate, @Nullable Long firstReview, @Nullable Long latestReview, String due, @Nullable Integer interval, @Nullable Double easeInPercent, int reviews, int lapses, @Nullable Long averageTime, @Nullable Long totalTime, String cardType, String noteType, String deckName, long noteId, List&lt;RevLogEntry&gt; entries) {</span>
<span class="nc" id="L359">            this.mAddedDate = createdDate;</span>
<span class="nc" id="L360">            this.mFirstReviewDate = firstReview;</span>
<span class="nc" id="L361">            mLatestReviewDate = latestReview;</span>
<span class="nc" id="L362">            mDue = due;</span>
<span class="nc" id="L363">            mInterval = interval;</span>
<span class="nc" id="L364">            mEaseInPercent = easeInPercent;</span>
<span class="nc" id="L365">            mReviews = reviews;</span>
<span class="nc" id="L366">            mLapses = lapses;</span>
<span class="nc" id="L367">            mAverageTimeMs = averageTime;</span>
<span class="nc" id="L368">            mTotalTimeMs = totalTime;</span>
<span class="nc" id="L369">            mCardType = cardType;</span>
<span class="nc" id="L370">            mNoteType = noteType;</span>
<span class="nc" id="L371">            mDeckName = deckName;</span>
<span class="nc" id="L372">            mNoteId = noteId;</span>
<span class="nc" id="L373">            mEntries = entries;</span>
<span class="nc" id="L374">        }</span>

        @CheckResult
        public static CardInfoModel create(Card c, Collection collection) {
<span class="nc" id="L378">            long addedDate = c.getId();</span>
<span class="nc" id="L379">            Long firstReview = collection.getDb().queryLongScalar(&quot;select min(id) from revlog where cid = ?&quot;, c.getId());</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6156)) {</span>
<span class="nc bnc" id="L381" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6154) ? (firstReview &gt;= 0) : (ListenerUtil.mutListener.listen(6153) ? (firstReview &lt;= 0) : (ListenerUtil.mutListener.listen(6152) ? (firstReview &gt; 0) : (ListenerUtil.mutListener.listen(6151) ? (firstReview &lt; 0) : (ListenerUtil.mutListener.listen(6150) ? (firstReview != 0) : (firstReview == 0))))))) {</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6155)) {</span>
<span class="nc" id="L383">                        firstReview = null;</span>
                    }
                }
            }
<span class="nc" id="L387">            Long latestReview = collection.getDb().queryLongScalar(&quot;select max(id) from revlog where cid = ?&quot;, c.getId());</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6163)) {</span>
<span class="nc bnc" id="L389" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6161) ? (latestReview &gt;= 0) : (ListenerUtil.mutListener.listen(6160) ? (latestReview &lt;= 0) : (ListenerUtil.mutListener.listen(6159) ? (latestReview &gt; 0) : (ListenerUtil.mutListener.listen(6158) ? (latestReview &lt; 0) : (ListenerUtil.mutListener.listen(6157) ? (latestReview != 0) : (latestReview == 0))))))) {</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6162)) {</span>
<span class="nc" id="L391">                        latestReview = null;</span>
                    }
                }
            }
<span class="nc" id="L395">            Long averageTime = collection.getDb().queryLongScalar(&quot;select avg(time) from revlog where cid = ?&quot;, c.getId());</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6170)) {</span>
<span class="nc bnc" id="L397" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6168) ? (averageTime &gt;= 0) : (ListenerUtil.mutListener.listen(6167) ? (averageTime &lt;= 0) : (ListenerUtil.mutListener.listen(6166) ? (averageTime &gt; 0) : (ListenerUtil.mutListener.listen(6165) ? (averageTime &lt; 0) : (ListenerUtil.mutListener.listen(6164) ? (averageTime != 0) : (averageTime == 0))))))) {</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6169)) {</span>
<span class="nc" id="L399">                        averageTime = null;</span>
                    }
                }
            }
<span class="nc" id="L403">            Long totalTime = collection.getDb().queryLongScalar(&quot;select sum(time) from revlog where cid = ?&quot;, c.getId());</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6177)) {</span>
<span class="nc bnc" id="L405" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6175) ? (totalTime &gt;= 0) : (ListenerUtil.mutListener.listen(6174) ? (totalTime &lt;= 0) : (ListenerUtil.mutListener.listen(6173) ? (totalTime &gt; 0) : (ListenerUtil.mutListener.listen(6172) ? (totalTime &lt; 0) : (ListenerUtil.mutListener.listen(6171) ? (totalTime != 0) : (totalTime == 0))))))) {</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6176)) {</span>
<span class="nc" id="L407">                        totalTime = null;</span>
                    }
                }
            }
<span class="nc bnc" id="L411" title="All 8 branches missed.">            Double easeInPercent = (ListenerUtil.mutListener.listen(6181) ? (c.getFactor() % 1000.0d) : (ListenerUtil.mutListener.listen(6180) ? (c.getFactor() * 1000.0d) : (ListenerUtil.mutListener.listen(6179) ? (c.getFactor() - 1000.0d) : (ListenerUtil.mutListener.listen(6178) ? (c.getFactor() + 1000.0d) : (c.getFactor() / 1000.0d)))));</span>
<span class="nc" id="L412">            int lapses = c.getLapses();</span>
<span class="nc" id="L413">            int reviews = c.getReps();</span>
<span class="nc" id="L414">            Model model = collection.getModels().get(c.note().getMid());</span>
<span class="nc" id="L415">            String cardType = getCardType(c, model);</span>
<span class="nc" id="L416">            String noteType = model.getString(&quot;name&quot;);</span>
<span class="nc" id="L417">            String deckName = collection.getDecks().get(c.getDid()).getString(&quot;name&quot;);</span>
<span class="nc" id="L418">            long noteId = c.getNid();</span>
<span class="nc" id="L419">            Integer interval = c.getIvl();</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6188)) {</span>
<span class="nc bnc" id="L421" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6186) ? (interval &gt;= 0) : (ListenerUtil.mutListener.listen(6185) ? (interval &gt; 0) : (ListenerUtil.mutListener.listen(6184) ? (interval &lt; 0) : (ListenerUtil.mutListener.listen(6183) ? (interval != 0) : (ListenerUtil.mutListener.listen(6182) ? (interval == 0) : (interval &lt;= 0))))))) {</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6187)) {</span>
<span class="nc" id="L423">                        interval = null;</span>
                    }
                }
            }
<span class="nc bnc" id="L427" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6195)) {</span>
<span class="nc bnc" id="L428" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6193) ? (c.getType() &gt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(6192) ? (c.getType() &lt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(6191) ? (c.getType() &gt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(6190) ? (c.getType() != Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(6189) ? (c.getType() == Consts.CARD_TYPE_REV) : (c.getType() &lt; Consts.CARD_TYPE_REV))))))) {</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6194)) {</span>
<span class="nc" id="L430">                        easeInPercent = null;</span>
                    }
                }
            }
<span class="nc" id="L434">            String due = c.getDueString();</span>
<span class="nc" id="L435">            List&lt;RevLogEntry&gt; entries = new ArrayList&lt;&gt;(collection.getDb().queryScalar(&quot;select count() from revlog where cid = ?&quot;, c.getId()));</span>
<span class="nc" id="L436">            try (Cursor cur = collection.getDb().query(&quot;select &quot; + &quot;id as dateTime, &quot; + &quot;ease as rating, &quot; + &quot;ivl, &quot; + &quot;factor as ease, &quot; + &quot;time, &quot; + &quot;type &quot; + &quot;from revlog where cid = ?&quot; + &quot;order by id desc&quot;, c.getId())) {</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6203)) {</span>
                    {
<span class="nc" id="L439">                        long _loopCounter114 = 0;</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                        while (cur.moveToNext()) {</span>
<span class="nc" id="L441">                            ListenerUtil.loopListener.listen(&quot;_loopCounter114&quot;, ++_loopCounter114);</span>
<span class="nc" id="L442">                            RevLogEntry e = new RevLogEntry();</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6196)) {</span>
<span class="nc" id="L444">                                e.dateTime = cur.getLong(0);</span>
                            }
<span class="nc bnc" id="L446" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6197)) {</span>
<span class="nc" id="L447">                                e.rating = cur.getInt(1);</span>
                            }
<span class="nc bnc" id="L449" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6198)) {</span>
<span class="nc" id="L450">                                e.ivl = cur.getLong(2);</span>
                            }
<span class="nc bnc" id="L452" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6199)) {</span>
<span class="nc" id="L453">                                e.factor = cur.getLong(3);</span>
                            }
<span class="nc bnc" id="L455" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6200)) {</span>
<span class="nc" id="L456">                                e.timeTakenMs = cur.getLong(4);</span>
                            }
<span class="nc bnc" id="L458" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6201)) {</span>
<span class="nc" id="L459">                                e.type = cur.getInt(5);</span>
                            }
<span class="nc bnc" id="L461" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6202)) {</span>
<span class="nc" id="L462">                                entries.add(e);</span>
                            }
<span class="nc" id="L464">                        }</span>
                    }
                }
            }
<span class="nc" id="L468">            return new CardInfoModel(addedDate, firstReview, latestReview, due, interval, easeInPercent, reviews, lapses, averageTime, totalTime, cardType, noteType, deckName, noteId, entries);</span>
        }

        @NonNull
        protected static String getCardType(Card c, Model model) {
            try {
<span class="nc" id="L474">                int ord = c.getOrd();</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6206)) {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                    if (c.model().isCloze()) {</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6205)) {</span>
<span class="nc" id="L478">                            ord = 0;</span>
                        }
                    }
                }
<span class="nc" id="L482">                return model.getJSONArray(&quot;tmpls&quot;).getJSONObject(ord).getString(&quot;name&quot;);</span>
<span class="nc" id="L483">            } catch (Exception e) {</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6204)) {</span>
<span class="nc" id="L485">                    Timber.w(e);</span>
                }
<span class="nc" id="L487">                return null;</span>
            }
        }

        public long getAddedDate() {
<span class="nc" id="L492">            return mAddedDate;</span>
        }

        @Nullable
        public Long getFirstReviewDate() {
<span class="nc" id="L497">            return mFirstReviewDate;</span>
        }

        @Nullable
        public Long getLatestReviewDate() {
<span class="nc" id="L502">            return mLatestReviewDate;</span>
        }

        @Nullable
        public String getDue() {
<span class="nc" id="L507">            return mDue;</span>
        }

        @Nullable
        public Integer getInterval() {
<span class="nc" id="L512">            return mInterval;</span>
        }

        @Nullable
        public Double getEaseInPercent() {
<span class="nc" id="L517">            return mEaseInPercent;</span>
        }

        public int getReviews() {
<span class="nc" id="L521">            return mReviews;</span>
        }

        public int getLapses() {
<span class="nc" id="L525">            return mLapses;</span>
        }

        @Nullable
        public Long getAverageTimeMs() {
<span class="nc" id="L530">            return mAverageTimeMs;</span>
        }

        @Nullable
        public Long getTotalTimeMs() {
<span class="nc" id="L535">            return mTotalTimeMs;</span>
        }

        public String getCardType() {
<span class="nc" id="L539">            return mCardType;</span>
        }

        public String getNoteType() {
<span class="nc" id="L543">            return mNoteType;</span>
        }

        public String getDeckName() {
<span class="nc" id="L547">            return mDeckName;</span>
        }

        public long getCardId() {
<span class="nc" id="L551">            return mAddedDate;</span>
        }

        public long getNoteId() {
<span class="nc" id="L555">            return mNoteId;</span>
        }

        public List&lt;RevLogEntry&gt; getEntries() {
<span class="nc" id="L559">            return mEntries;</span>
        }

        // date type rating interval ease time
<span class="nc" id="L563">        public static class RevLogEntry {</span>

            public long dateTime;

            public int type;

            public int rating;

            public long ivl;

            public long factor;

            public long timeTakenMs;

            public Spannable spannableType(Context context) {
<span class="nc" id="L578">                int[] attrs = new int[] { R.attr.newCountColor, R.attr.learnCountColor, R.attr.reviewCountColor };</span>
<span class="nc" id="L579">                TypedArray ta = context.obtainStyledAttributes(attrs);</span>
<span class="nc" id="L580">                int newCountColor = ta.getColor(0, ContextCompat.getColor(context, R.color.black));</span>
<span class="nc" id="L581">                int learnCountColor = ta.getColor(1, ContextCompat.getColor(context, R.color.black));</span>
<span class="nc" id="L582">                int reviewCountColor = ta.getColor(2, ContextCompat.getColor(context, R.color.black));</span>
<span class="nc" id="L583">                int filteredColor = ContextCompat.getColor(context, R.color.material_orange_A700);</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6207)) {</span>
<span class="nc" id="L585">                    ta.recycle();</span>
                }
<span class="nc bnc" id="L587" title="All 5 branches missed.">                switch(type) {</span>
                    case Consts.REVLOG_LRN:
<span class="nc" id="L589">                        return UiUtil.makeColored(context.getString(R.string.card_info_revlog_learn), newCountColor);</span>
                    case Consts.REVLOG_REV:
<span class="nc" id="L591">                        return UiUtil.makeColored(context.getString(R.string.card_info_revlog_review), reviewCountColor);</span>
                    case Consts.REVLOG_RELRN:
<span class="nc" id="L593">                        return UiUtil.makeColored(context.getString(R.string.card_info_revlog_relearn), learnCountColor);</span>
                    case Consts.REVLOG_CRAM:
<span class="nc" id="L595">                        return UiUtil.makeColored(context.getString(R.string.card_info_revlog_filtered), filteredColor);</span>
                    default:
<span class="nc" id="L597">                        return new SpannableString(Integer.toString(type));</span>
                }
            }

            public Spannable getEase(Context context) {
<span class="nc bnc" id="L602" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6212) ? (factor &gt;= 0) : (ListenerUtil.mutListener.listen(6211) ? (factor &lt;= 0) : (ListenerUtil.mutListener.listen(6210) ? (factor &gt; 0) : (ListenerUtil.mutListener.listen(6209) ? (factor &lt; 0) : (ListenerUtil.mutListener.listen(6208) ? (factor != 0) : (factor == 0))))))) {</span>
<span class="nc" id="L603">                    return new SpannableString(context.getString(R.string.card_info_ease_not_applicable));</span>
                } else {
<span class="nc bnc" id="L605" title="All 8 branches missed.">                    return new SpannableString(Long.toString((ListenerUtil.mutListener.listen(6216) ? (factor % 10) : (ListenerUtil.mutListener.listen(6215) ? (factor * 10) : (ListenerUtil.mutListener.listen(6214) ? (factor - 10) : (ListenerUtil.mutListener.listen(6213) ? (factor + 10) : (factor / 10)))))));</span>
                }
            }

            public long intervalAsTimeSeconds() {
<span class="nc bnc" id="L610" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6222)) {</span>
<span class="nc bnc" id="L611" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(6221) ? (ivl &gt;= 0) : (ListenerUtil.mutListener.listen(6220) ? (ivl &lt;= 0) : (ListenerUtil.mutListener.listen(6219) ? (ivl &gt; 0) : (ListenerUtil.mutListener.listen(6218) ? (ivl != 0) : (ListenerUtil.mutListener.listen(6217) ? (ivl == 0) : (ivl &lt; 0))))))) {</span>
<span class="nc" id="L612">                        return -ivl;</span>
                    }
                }
<span class="nc bnc" id="L615" title="All 8 branches missed.">                return (ListenerUtil.mutListener.listen(6226) ? (ivl % SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(6225) ? (ivl / SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(6224) ? (ivl - SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(6223) ? (ivl + SECONDS_PER_DAY) : (ivl * SECONDS_PER_DAY)))));</span>
            }

            public String getTimeTaken() {
                // return Utils.timeQuantityNextIvl(context, timeTakenMs / 1000);
<span class="nc bnc" id="L620" title="All 8 branches missed.">                return Long.toString((ListenerUtil.mutListener.listen(6230) ? (timeTakenMs % 1000) : (ListenerUtil.mutListener.listen(6229) ? (timeTakenMs * 1000) : (ListenerUtil.mutListener.listen(6228) ? (timeTakenMs - 1000) : (ListenerUtil.mutListener.listen(6227) ? (timeTakenMs + 1000) : (timeTakenMs / 1000))))));</span>
            }

            public Spannable getRating(Context context) {
<span class="nc" id="L624">                String source = Long.toString(rating);</span>
<span class="nc bnc" id="L625" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6235) ? (rating &gt;= 1) : (ListenerUtil.mutListener.listen(6234) ? (rating &lt;= 1) : (ListenerUtil.mutListener.listen(6233) ? (rating &gt; 1) : (ListenerUtil.mutListener.listen(6232) ? (rating &lt; 1) : (ListenerUtil.mutListener.listen(6231) ? (rating != 1) : (rating == 1))))))) {</span>
<span class="nc" id="L626">                    int[] attrs = new int[] { R.attr.learnCountColor };</span>
<span class="nc" id="L627">                    TypedArray ta = context.obtainStyledAttributes(attrs);</span>
<span class="nc" id="L628">                    int failColor = ta.getColor(0, ContextCompat.getColor(context, R.color.black));</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6236)) {</span>
<span class="nc" id="L630">                        ta.recycle();</span>
                    }
<span class="nc" id="L632">                    return UiUtil.makeColored(source, failColor);</span>
                } else {
<span class="nc" id="L634">                    return new SpannableString(source);</span>
                }
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>