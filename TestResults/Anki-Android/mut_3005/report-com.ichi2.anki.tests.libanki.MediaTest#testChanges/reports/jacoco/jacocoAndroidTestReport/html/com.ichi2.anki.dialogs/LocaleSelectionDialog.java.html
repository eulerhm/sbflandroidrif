<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocaleSelectionDialog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki.dialogs</a> &gt; <span class="el_source">LocaleSelectionDialog.java</span></div><h1>LocaleSelectionDialog.java</h1><pre class="source lang-java linenums">/*
 Copyright (c) 2020 David Allison &lt;davidallisongithub@gmail.com&gt;

 This program is free software; you can redistribute it and/or modify it under
 the terms of the GNU General Public License as published by the Free Software
 Foundation; either version 3 of the License, or (at your option) any later
 version.

 This program is distributed in the hope that it will be useful, but WITHOUT ANY
 WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
 PARTICULAR PURPOSE. See the GNU General Public License for more details.

 You should have received a copy of the GNU General Public License along with
 this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package com.ichi2.anki.dialogs;

import android.app.Activity;
import android.app.Dialog;
import android.content.Context;
import android.os.Bundle;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.Window;
import android.view.WindowManager;
import android.view.inputmethod.EditorInfo;
import android.widget.Filter;
import android.widget.Filterable;
import android.widget.TextView;
import com.afollestad.materialdialogs.MaterialDialog;
import com.ichi2.anki.R;
import com.ichi2.anki.analytics.AnalyticsDialogFragment;
import com.ichi2.ui.RecyclerSingleTouchAdapter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.List;
import java.util.Locale;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.widget.SearchView;
import androidx.appcompat.widget.Toolbar;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import java8.util.Lists;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Locale selection dialog. Note: this must be dismissed onDestroy if not called from an activity implementing LocaleSelectionDialogHandler
 */
<span class="nc" id="L54">public class LocaleSelectionDialog extends AnalyticsDialogFragment {</span>

    private LocaleSelectionDialogHandler dialogHandler;

    public interface LocaleSelectionDialogHandler {

        void onSelectedLocale(@NonNull Locale selectedLocale);

        void onLocaleSelectionCancelled();
    }

    /**
     * @param handler Marker interface to enforce the convention the caller implementing LocaleSelectionDialogHandler
     */
    @SuppressWarnings(&quot;unused&quot;)
    @NonNull
    public static LocaleSelectionDialog newInstance(@NonNull LocaleSelectionDialogHandler handler) {
<span class="nc" id="L71">        LocaleSelectionDialog t = new LocaleSelectionDialog();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(803)) {</span>
<span class="nc" id="L73">            t.dialogHandler = handler;</span>
        }
<span class="nc" id="L75">        Bundle args = new Bundle();</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(804)) {</span>
<span class="nc" id="L77">            t.setArguments(args);</span>
        }
<span class="nc" id="L79">        return t;</span>
    }

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(805)) {</span>
<span class="nc" id="L85">            super.onCreate(savedInstanceState);</span>
        }
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(806)) {</span>
<span class="nc" id="L88">            setCancelable(true);</span>
        }
<span class="nc" id="L90">    }</span>

    @Override
    public void onAttach(@NonNull Context context) {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(807)) {</span>
<span class="nc" id="L95">            super.onAttach(context);</span>
        }
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(812)) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            if (context instanceof Activity) {</span>
<span class="nc" id="L99">                Activity activity = (Activity) context;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(810)) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                    if (dialogHandler == null) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(808)) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                            if (!(context instanceof LocaleSelectionDialogHandler)) {</span>
<span class="nc" id="L104">                                throw new IllegalArgumentException(&quot;Calling activity must implement LocaleSelectionDialogHandler&quot;);</span>
                            }
                        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(809)) {</span>
<span class="nc" id="L108">                            this.dialogHandler = (LocaleSelectionDialogHandler) context;</span>
                        }
                    }
                }
<span class="nc bnc" id="L112" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(811)) {</span>
<span class="nc" id="L113">                    activity.getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE);</span>
                }
            }
        }
<span class="nc" id="L117">    }</span>

    @NonNull
    @Override
    public Dialog onCreateDialog(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L122">        Activity activity = requireActivity();</span>
<span class="nc" id="L123">        View tagsDialogView = LayoutInflater.from(activity).inflate(R.layout.locale_selection_dialog, activity.findViewById(R.id.root_layout), false);</span>
<span class="nc" id="L124">        LocaleListAdapter mAdapter = new LocaleListAdapter(Locale.getAvailableLocales());</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(813)) {</span>
<span class="nc" id="L126">            setupRecyclerView(activity, tagsDialogView, mAdapter);</span>
        }
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(814)) {</span>
<span class="nc" id="L129">            inflateMenu(tagsDialogView, mAdapter);</span>
        }
        // Only show a negative button, use the RecyclerView for positive actions
<span class="nc" id="L132">        MaterialDialog.Builder builder = new MaterialDialog.Builder(activity).negativeText(getString(R.string.dialog_cancel)).customView(tagsDialogView, false).onNegative((dialog, which) -&gt; dialogHandler.onLocaleSelectionCancelled());</span>
<span class="nc" id="L133">        Dialog mDialog = builder.build();</span>
<span class="nc" id="L134">        Window window = mDialog.getWindow();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(816)) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (window != null) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(815)) {</span>
<span class="nc" id="L138">                    window.setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE);</span>
                }
            }
        }
<span class="nc" id="L142">        return mDialog;</span>
    }

    private void setupRecyclerView(@NonNull Activity activity, @NonNull View tagsDialogView, LocaleListAdapter adapter) {
<span class="nc" id="L146">        RecyclerView recyclerView = tagsDialogView.findViewById(R.id.locale_dialog_selection_list);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(817)) {</span>
<span class="nc" id="L148">            recyclerView.requestFocus();</span>
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(818)) {</span>
<span class="nc" id="L151">            recyclerView.setHasFixedSize(true);</span>
        }
<span class="nc" id="L153">        RecyclerView.LayoutManager layoutManager = new LinearLayoutManager(activity);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(819)) {</span>
<span class="nc" id="L155">            recyclerView.setLayoutManager(layoutManager);</span>
        }
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(820)) {</span>
<span class="nc" id="L158">            recyclerView.setAdapter(adapter);</span>
        }
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(821)) {</span>
<span class="nc" id="L161">            recyclerView.addOnItemTouchListener(new RecyclerSingleTouchAdapter(activity, (view, position) -&gt; {</span>
<span class="nc" id="L162">                Locale l = adapter.getLocaleAtPosition(position);</span>
<span class="nc" id="L163">                LocaleSelectionDialog.this.dialogHandler.onSelectedLocale(l);</span>
<span class="nc" id="L164">            }));</span>
        }
<span class="nc" id="L166">    }</span>

    private void inflateMenu(@NonNull View tagsDialogView, @NonNull final LocaleListAdapter adapter) {
<span class="nc" id="L169">        Toolbar mToolbar = tagsDialogView.findViewById(R.id.locale_dialog_selection_toolbar);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(822)) {</span>
<span class="nc" id="L171">            mToolbar.setTitle(R.string.locale_selection_dialog_title);</span>
        }
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(823)) {</span>
<span class="nc" id="L174">            mToolbar.inflateMenu(R.menu.locale_dialog_search_bar);</span>
        }
<span class="nc" id="L176">        MenuItem searchItem = mToolbar.getMenu().findItem(R.id.locale_dialog_action_search);</span>
<span class="nc" id="L177">        SearchView searchView = (SearchView) searchItem.getActionView();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(824)) {</span>
<span class="nc" id="L179">            searchView.setImeOptions(EditorInfo.IME_ACTION_DONE);</span>
        }
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(826)) {</span>
<span class="nc" id="L182">            searchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {</span>

                @Override
                public boolean onQueryTextSubmit(String query) {
<span class="nc" id="L186">                    return false;</span>
                }

                @Override
                public boolean onQueryTextChange(String newText) {
<span class="nc bnc" id="L191" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(825)) {</span>
<span class="nc" id="L192">                        adapter.getFilter().filter(newText);</span>
                    }
<span class="nc" id="L194">                    return false;</span>
                }
            });
        }
<span class="nc" id="L198">    }</span>

    public static class LocaleListAdapter extends RecyclerView.Adapter&lt;LocaleListAdapter.TextViewHolder&gt; implements Filterable {

        private final List&lt;Locale&gt; mCurrentlyVisibleLocales;

        private final List&lt;Locale&gt; mSelectableLocales;

        public static class TextViewHolder extends RecyclerView.ViewHolder {

            @NonNull
            private final TextView mTextView;

            public TextViewHolder(@NonNull TextView textView) {
<span class="nc" id="L212">                super(textView);</span>
<span class="nc" id="L213">                mTextView = textView;</span>
<span class="nc" id="L214">            }</span>

            public void setText(@NonNull String text) {
<span class="nc bnc" id="L217" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(827)) {</span>
<span class="nc" id="L218">                    mTextView.setText(text);</span>
                }
<span class="nc" id="L220">            }</span>

            public void setLocale(@NonNull Locale locale) {
<span class="nc" id="L223">                String displayValue = locale.getDisplayName();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(828)) {</span>
<span class="nc" id="L225">                    mTextView.setText(displayValue);</span>
                }
<span class="nc" id="L227">            }</span>
        }

<span class="nc" id="L230">        public LocaleListAdapter(@NonNull Locale[] locales) {</span>
<span class="nc" id="L231">            mSelectableLocales = Lists.of(locales);</span>
<span class="nc" id="L232">            mCurrentlyVisibleLocales = new ArrayList&lt;&gt;(Arrays.asList(locales));</span>
<span class="nc" id="L233">        }</span>

        @NonNull
        @Override
        public TextViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
<span class="nc" id="L238">            TextView v = (TextView) LayoutInflater.from(parent.getContext()).inflate(R.layout.locale_dialog_fragment_textview, parent, false);</span>
<span class="nc" id="L239">            return new TextViewHolder(v);</span>
        }

        @Override
        public void onBindViewHolder(@NonNull TextViewHolder holder, int position) {
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(829)) {</span>
<span class="nc" id="L245">                holder.setLocale(mCurrentlyVisibleLocales.get(position));</span>
            }
<span class="nc" id="L247">        }</span>

        @Override
        public int getItemCount() {
<span class="nc" id="L251">            return mCurrentlyVisibleLocales.size();</span>
        }

        @NonNull
        public Locale getLocaleAtPosition(int position) {
<span class="nc" id="L256">            return mCurrentlyVisibleLocales.get(position);</span>
        }

        @NonNull
        @Override
        public Filter getFilter() {
<span class="nc" id="L262">            final List&lt;Locale&gt; selectableLocales = mSelectableLocales;</span>
<span class="nc" id="L263">            final List&lt;Locale&gt; visibleLocales = mCurrentlyVisibleLocales;</span>
<span class="nc" id="L264">            return new Filter() {</span>

                @Override
                protected FilterResults performFiltering(CharSequence constraint) {
<span class="nc bnc" id="L268" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(831)) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                        if (TextUtils.isEmpty(constraint)) {</span>
<span class="nc" id="L270">                            FilterResults filterResults = new FilterResults();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(830)) {</span>
<span class="nc" id="L272">                                filterResults.values = selectableLocales;</span>
                            }
<span class="nc" id="L274">                            return filterResults;</span>
                        }
                    }
<span class="nc" id="L277">                    String normalisedConstraint = constraint.toString().toLowerCase(Locale.getDefault());</span>
<span class="nc" id="L278">                    ArrayList&lt;Locale&gt; locales = new ArrayList&lt;&gt;(selectableLocales.size());</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(834)) {</span>
                        {
<span class="nc" id="L281">                            long _loopCounter13 = 0;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                            for (Locale l : selectableLocales) {</span>
<span class="nc" id="L283">                                ListenerUtil.loopListener.listen(&quot;_loopCounter13&quot;, ++_loopCounter13);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(833)) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                                    if (l.getDisplayName().toLowerCase(Locale.getDefault()).contains(normalisedConstraint)) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(832)) {</span>
<span class="nc" id="L287">                                            locales.add(l);</span>
                                        }
                                    }
                                }
<span class="nc" id="L291">                            }</span>
                        }
                    }
<span class="nc" id="L294">                    FilterResults filterResults = new FilterResults();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(835)) {</span>
<span class="nc" id="L296">                        filterResults.values = locales;</span>
                    }
<span class="nc" id="L298">                    return filterResults;</span>
                }

                @Override
                protected void publishResults(CharSequence constraint, FilterResults results) {
<span class="nc bnc" id="L303" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(836)) {</span>
<span class="nc" id="L304">                        visibleLocales.clear();</span>
                    }
                    // noinspection unchecked
<span class="nc" id="L307">                    Collection&lt;? extends Locale&gt; values = (Collection&lt;? extends Locale&gt;) results.values;</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(837)) {</span>
<span class="nc" id="L309">                        visibleLocales.addAll(values);</span>
                    }
<span class="nc bnc" id="L311" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(838)) {</span>
<span class="nc" id="L312">                        notifyDataSetChanged();</span>
                    }
<span class="nc" id="L314">                }</span>
            };
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>