<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ActionButtonStatus.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki.reviewer</a> &gt; <span class="el_source">ActionButtonStatus.java</span></div><h1>ActionButtonStatus.java</h1><pre class="source lang-java linenums">package com.ichi2.anki.reviewer;

import android.content.SharedPreferences;
import android.graphics.drawable.Drawable;
import android.view.Menu;
import android.view.MenuItem;
import com.ichi2.anki.R;
import com.ichi2.themes.Themes;
import java.util.HashMap;
import java.util.Map;
import androidx.annotation.IdRes;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

// loads of unboxing issues, which are safe
@SuppressWarnings(&quot;ConstantConditions&quot;)
public class ActionButtonStatus {

    /**
     * Custom button allocation
     */
<span class="nc" id="L24">    @NonNull</span>
    protected final Map&lt;Integer, Integer&gt; // setup's size
    mCustomButtons = new HashMap&lt;&gt;(25);

    private final ReviewerUi mReviewerUi;

    public static final int SHOW_AS_ACTION_NEVER = MenuItem.SHOW_AS_ACTION_NEVER;

    public static final int SHOW_AS_ACTION_IF_ROOM = MenuItem.SHOW_AS_ACTION_IF_ROOM;

    public static final int SHOW_AS_ACTION_ALWAYS = MenuItem.SHOW_AS_ACTION_ALWAYS;

    public static final int MENU_DISABLED = 3;

    @Nullable
    public Integer getByMenuResourceId(int resourceId) {
<span class="nc bnc" id="L40" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2902)) {</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">            if (!mCustomButtons.containsKey(resourceId)) {</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(2901)) {</span>
<span class="nc" id="L43">                    Timber.w(&quot;Invalid resource lookup: %d&quot;, resourceId);</span>
                }
<span class="nc" id="L45">                return SHOW_AS_ACTION_NEVER;</span>
            }
        }
<span class="nc" id="L48">        return mCustomButtons.get(resourceId);</span>
    }

<span class="nc" id="L51">    public ActionButtonStatus(ReviewerUi reviewerUi) {</span>
<span class="nc" id="L52">        this.mReviewerUi = reviewerUi;</span>
<span class="nc" id="L53">    }</span>

    public void setup(SharedPreferences preferences) {
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2903)) {</span>
            // NOTE: the default values below should be in sync with preferences_custom_buttons.xml and reviewer.xml
<span class="nc" id="L58">            setupButton(preferences, R.id.action_undo, &quot;customButtonUndo&quot;, SHOW_AS_ACTION_ALWAYS);</span>
        }
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2904)) {</span>
<span class="nc" id="L61">            setupButton(preferences, R.id.action_schedule, &quot;customButtonScheduleCard&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2905)) {</span>
<span class="nc" id="L64">            setupButton(preferences, R.id.action_flag, &quot;customButtonFlag&quot;, SHOW_AS_ACTION_ALWAYS);</span>
        }
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2906)) {</span>
<span class="nc" id="L67">            setupButton(preferences, R.id.action_tag, &quot;customButtonTags&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2907)) {</span>
<span class="nc" id="L70">            setupButton(preferences, R.id.action_edit, &quot;customButtonEditCard&quot;, SHOW_AS_ACTION_IF_ROOM);</span>
        }
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2908)) {</span>
<span class="nc" id="L73">            setupButton(preferences, R.id.action_add_note_reviewer, &quot;customButtonAddCard&quot;, MENU_DISABLED);</span>
        }
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2909)) {</span>
<span class="nc" id="L76">            setupButton(preferences, R.id.action_replay, &quot;customButtonReplay&quot;, SHOW_AS_ACTION_IF_ROOM);</span>
        }
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2910)) {</span>
<span class="nc" id="L79">            setupButton(preferences, R.id.action_card_info, &quot;customButtonCardInfo&quot;, MENU_DISABLED);</span>
        }
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2911)) {</span>
<span class="nc" id="L82">            setupButton(preferences, R.id.action_clear_whiteboard, &quot;customButtonClearWhiteboard&quot;, SHOW_AS_ACTION_IF_ROOM);</span>
        }
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2912)) {</span>
<span class="nc" id="L85">            setupButton(preferences, R.id.action_hide_whiteboard, &quot;customButtonShowHideWhiteboard&quot;, SHOW_AS_ACTION_ALWAYS);</span>
        }
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2913)) {</span>
<span class="nc" id="L88">            setupButton(preferences, R.id.action_select_tts, &quot;customButtonSelectTts&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2914)) {</span>
<span class="nc" id="L91">            setupButton(preferences, R.id.action_open_deck_options, &quot;customButtonDeckOptions&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2915)) {</span>
<span class="nc" id="L94">            setupButton(preferences, R.id.action_bury, &quot;customButtonBury&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2916)) {</span>
<span class="nc" id="L97">            setupButton(preferences, R.id.action_suspend, &quot;customButtonSuspend&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2917)) {</span>
<span class="nc" id="L100">            setupButton(preferences, R.id.action_mark_card, &quot;customButtonMarkCard&quot;, SHOW_AS_ACTION_IF_ROOM);</span>
        }
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2918)) {</span>
<span class="nc" id="L103">            setupButton(preferences, R.id.action_delete, &quot;customButtonDelete&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2919)) {</span>
<span class="nc" id="L106">            setupButton(preferences, R.id.action_toggle_mic_tool_bar, &quot;customButtonToggleMicToolBar&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2920)) {</span>
<span class="nc" id="L109">            setupButton(preferences, R.id.action_toggle_whiteboard, &quot;customButtonEnableWhiteboard&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2921)) {</span>
<span class="nc" id="L112">            setupButton(preferences, R.id.action_save_whiteboard, &quot;customButtonSaveWhiteboard&quot;, SHOW_AS_ACTION_NEVER);</span>
        }
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2922)) {</span>
<span class="nc" id="L115">            setupButton(preferences, R.id.action_change_whiteboard_pen_color, &quot;customButtonWhiteboardPenColor&quot;, SHOW_AS_ACTION_IF_ROOM);</span>
        }
<span class="nc" id="L117">    }</span>

    private void setupButton(SharedPreferences preferences, @IdRes int resourceId, String preferenceName, int showAsActionType) {
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2923)) {</span>
<span class="nc" id="L121">            mCustomButtons.put(resourceId, Integer.parseInt(preferences.getString(preferenceName, Integer.toString(showAsActionType))));</span>
        }
<span class="nc" id="L123">    }</span>

    public void setCustomButtons(Menu menu) {
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(2939)) {</span>
            {
<span class="nc" id="L128">                long _loopCounter72 = 0;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                for (Map.Entry&lt;Integer, Integer&gt; entry : mCustomButtons.entrySet()) {</span>
<span class="nc" id="L130">                    ListenerUtil.loopListener.listen(&quot;_loopCounter72&quot;, ++_loopCounter72);</span>
<span class="nc" id="L131">                    int itemId = entry.getKey();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(2938)) {</span>
<span class="nc bnc" id="L133" title="All 22 branches missed.">                        if ((ListenerUtil.mutListener.listen(2928) ? (entry.getValue() &gt;= MENU_DISABLED) : (ListenerUtil.mutListener.listen(2927) ? (entry.getValue() &lt;= MENU_DISABLED) : (ListenerUtil.mutListener.listen(2926) ? (entry.getValue() &gt; MENU_DISABLED) : (ListenerUtil.mutListener.listen(2925) ? (entry.getValue() &lt; MENU_DISABLED) : (ListenerUtil.mutListener.listen(2924) ? (entry.getValue() == MENU_DISABLED) : (entry.getValue() != MENU_DISABLED))))))) {</span>
<span class="nc" id="L134">                            MenuItem item = menu.findItem(itemId);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2931)) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                                if (item == null) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(2930)) {</span>
                                        // Happens with TV - removing flag icon
<span class="nc" id="L139">                                        Timber.w(&quot;Could not find Menu Item %d&quot;, itemId);</span>
                                    }
                                    continue;
                                }
                            }
<span class="nc bnc" id="L144" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2932)) {</span>
<span class="nc" id="L145">                                item.setShowAsAction(entry.getValue());</span>
                            }
<span class="nc" id="L147">                            Drawable icon = item.getIcon();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2933)) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                                item.setEnabled(!mReviewerUi.isControlBlocked());</span>
                            }
<span class="nc bnc" id="L151" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2937)) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                                if (icon != null) {</span>
                                    /* Ideally, we want to give feedback to users that
                    buttons are disabled.  However, some actions are
                    expected to be so quick that the visual feedback
                    is useless and is only seen as a flickering.

                    We use a heuristic to decide whether the next card
                    will appear quickly or slowly.  We change the
                    color only if the buttons are blocked and we
                    expect the next card to take time to arrive.
                    */
<span class="nc" id="L163">                                    Drawable mutableIcon = icon.mutate();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(2936)) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                                        if (mReviewerUi.getControlBlocked() == ReviewerUi.ControlBlock.SLOW) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(2935)) {</span>
<span class="nc" id="L167">                                                mutableIcon.setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);</span>
                                            }
                                        } else {
<span class="nc bnc" id="L170" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(2934)) {</span>
<span class="nc" id="L171">                                                mutableIcon.setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);</span>
                                            }
                                        }
                                    }
                                }
                            }
<span class="nc" id="L177">                        } else {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(2929)) {</span>
<span class="nc" id="L179">                                menu.findItem(itemId).setVisible(false);</span>
                            }
                        }
                    }
<span class="nc" id="L183">                }</span>
            }
        }
<span class="nc" id="L186">    }</span>

    public boolean hideWhiteboardIsDisabled() {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        return mCustomButtons.get(R.id.action_hide_whiteboard) == MENU_DISABLED;</span>
    }

    public boolean clearWhiteboardIsDisabled() {
<span class="nc bnc" id="L193" title="All 2 branches missed.">        return mCustomButtons.get(R.id.action_clear_whiteboard) == MENU_DISABLED;</span>
    }

    public boolean selectTtsIsDisabled() {
<span class="nc bnc" id="L197" title="All 2 branches missed.">        return mCustomButtons.get(R.id.action_select_tts) == MENU_DISABLED;</span>
    }

    public boolean saveWhiteboardIsDisabled() {
<span class="nc bnc" id="L201" title="All 2 branches missed.">        return mCustomButtons.get(R.id.action_save_whiteboard) == MENU_DISABLED;</span>
    }

    public boolean whiteboardPenColorIsDisabled() {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        return mCustomButtons.get(R.id.action_change_whiteboard_pen_color) == MENU_DISABLED;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>