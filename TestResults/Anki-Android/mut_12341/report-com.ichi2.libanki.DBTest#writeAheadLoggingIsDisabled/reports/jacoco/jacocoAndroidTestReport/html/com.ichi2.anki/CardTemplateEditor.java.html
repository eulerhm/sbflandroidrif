<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CardTemplateEditor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki</a> &gt; <span class="el_source">CardTemplateEditor.java</span></div><h1>CardTemplateEditor.java</h1><pre class="source lang-java linenums">/**
 * ************************************************************************************
 *                                                                                       *
 *  Copyright (c) 2014 Timothy Rae &lt;perceptualchaos2@gmail.com&gt;                          *
 *  Copyright (c) 2018 Mike Hardy &lt;mike@mikehardy.net&gt;                                   *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.anki;

import android.content.Context;
import android.content.Intent;
import android.content.res.Resources;
import android.os.Bundle;
import androidx.annotation.CheckResult;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.StringRes;
import androidx.annotation.VisibleForTesting;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentActivity;
import androidx.viewpager2.widget.ViewPager2;
import android.text.Editable;
import android.text.TextWatcher;
import android.util.Pair;
import android.view.KeyEvent;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.EditText;
import com.afollestad.materialdialogs.MaterialDialog;
import com.google.android.material.tabs.TabLayout;
import com.google.android.material.tabs.TabLayoutMediator;
import com.ichi2.anki.dialogs.ConfirmationDialog;
import com.ichi2.anki.dialogs.DeckSelectionDialog;
import com.ichi2.anki.dialogs.DeckSelectionDialog.SelectableDeck;
import com.ichi2.anki.dialogs.DiscardChangesDialog;
import com.ichi2.anki.exception.ConfirmModSchemaException;
import com.ichi2.async.TaskListenerWithContext;
import com.ichi2.libanki.Collection;
import com.ichi2.libanki.Consts;
import com.ichi2.libanki.Deck;
import com.ichi2.libanki.Decks;
import com.ichi2.libanki.Model;
import com.ichi2.libanki.Models;
import com.ichi2.themes.StyledProgressDialog;
import com.ichi2.utils.FunctionalInterfaces;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONException;
import com.ichi2.utils.JSONObject;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import androidx.viewpager2.adapter.FragmentStateAdapter;
import timber.log.Timber;
import static com.ichi2.anim.ActivityTransitionAnimation.Direction.*;
import static com.ichi2.libanki.Models.NOT_FOUND_NOTE_TYPE;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Allows the user to view the template for the current note type
 */
@SuppressWarnings({ &quot;PMD.AvoidThrowingRawExceptionTypes&quot; })
<span class="nc" id="L78">public class CardTemplateEditor extends AnkiActivity implements DeckSelectionDialog.DeckSelectionListener {</span>

    @VisibleForTesting
    protected ViewPager2 mViewPager;

    private TabLayout mSlidingTabLayout;

    private TemporaryModel mTempModel;

    private long mModelId;

    private long mNoteId;

    private int mStartingOrdId;

    private static final int REQUEST_PREVIEWER = 0;

    private static final int REQUEST_CARD_BROWSER_APPEARANCE = 1;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6289)) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (showedActivityFailedScreen(savedInstanceState)) {</span>
<span class="nc" id="L101">                return;</span>
            }
        }
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6290)) {</span>
<span class="nc" id="L105">            Timber.d(&quot;onCreate()&quot;);</span>
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6291)) {</span>
<span class="nc" id="L108">            super.onCreate(savedInstanceState);</span>
        }
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6292)) {</span>
<span class="nc" id="L111">            setContentView(R.layout.card_template_editor_activity);</span>
        }
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6308)) {</span>
            // Load the args either from the intent or savedInstanceState bundle
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (savedInstanceState == null) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6297)) {</span>
                    // get model id
<span class="nc" id="L118">                    mModelId = getIntent().getLongExtra(&quot;modelId&quot;, NOT_FOUND_NOTE_TYPE);</span>
                }
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6305)) {</span>
<span class="nc bnc" id="L121" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(6302) ? (mModelId &gt;= NOT_FOUND_NOTE_TYPE) : (ListenerUtil.mutListener.listen(6301) ? (mModelId &lt;= NOT_FOUND_NOTE_TYPE) : (ListenerUtil.mutListener.listen(6300) ? (mModelId &gt; NOT_FOUND_NOTE_TYPE) : (ListenerUtil.mutListener.listen(6299) ? (mModelId &lt; NOT_FOUND_NOTE_TYPE) : (ListenerUtil.mutListener.listen(6298) ? (mModelId != NOT_FOUND_NOTE_TYPE) : (mModelId == NOT_FOUND_NOTE_TYPE))))))) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6303)) {</span>
<span class="nc" id="L123">                            Timber.e(&quot;CardTemplateEditor :: no model ID was provided&quot;);</span>
                        }
<span class="nc bnc" id="L125" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6304)) {</span>
<span class="nc" id="L126">                            finishWithoutAnimation();</span>
                        }
<span class="nc" id="L128">                        return;</span>
                    }
                }
<span class="nc bnc" id="L131" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6306)) {</span>
                    // get id for currently edited note (optional)
<span class="nc" id="L133">                    mNoteId = getIntent().getLongExtra(&quot;noteId&quot;, -1L);</span>
                }
<span class="nc bnc" id="L135" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6307)) {</span>
                    // get id for currently edited template (optional)
<span class="nc" id="L137">                    mStartingOrdId = getIntent().getIntExtra(&quot;ordId&quot;, -1);</span>
                }
            } else {
<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6293)) {</span>
<span class="nc" id="L141">                    mModelId = savedInstanceState.getLong(&quot;modelId&quot;);</span>
                }
<span class="nc bnc" id="L143" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6294)) {</span>
<span class="nc" id="L144">                    mNoteId = savedInstanceState.getLong(&quot;noteId&quot;);</span>
                }
<span class="nc bnc" id="L146" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6295)) {</span>
<span class="nc" id="L147">                    mStartingOrdId = savedInstanceState.getInt(&quot;ordId&quot;);</span>
                }
<span class="nc bnc" id="L149" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6296)) {</span>
<span class="nc" id="L150">                    mTempModel = TemporaryModel.fromBundle(savedInstanceState);</span>
                }
            }
        }
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6309)) {</span>
            // Disable the home icon
<span class="nc" id="L156">            enableToolbar();</span>
        }
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6310)) {</span>
<span class="nc" id="L159">            startLoadingCollection();</span>
        }
<span class="nc" id="L161">    }</span>

    @Override
    public void onSaveInstanceState(Bundle outState) {
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6311)) {</span>
<span class="nc" id="L166">            outState.putAll(getTempModel().toBundle());</span>
        }
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6312)) {</span>
<span class="nc" id="L169">            outState.putLong(&quot;modelId&quot;, mModelId);</span>
        }
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6313)) {</span>
<span class="nc" id="L172">            outState.putLong(&quot;noteId&quot;, mNoteId);</span>
        }
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6314)) {</span>
<span class="nc" id="L175">            outState.putInt(&quot;ordId&quot;, mStartingOrdId);</span>
        }
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6315)) {</span>
<span class="nc" id="L178">            super.onSaveInstanceState(outState);</span>
        }
<span class="nc" id="L180">    }</span>

    @Override
    public void onBackPressed() {
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6318)) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (modelHasChanged()) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6317)) {</span>
<span class="nc" id="L187">                    showDiscardChangesDialog();</span>
                }
            } else {
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6316)) {</span>
<span class="nc" id="L191">                    super.onBackPressed();</span>
                }
            }
        }
<span class="nc" id="L195">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6320)) {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (item.getItemId() == android.R.id.home) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6319)) {</span>
<span class="nc" id="L202">                    onBackPressed();</span>
                }
<span class="nc" id="L204">                return true;</span>
            }
        }
<span class="nc" id="L207">        return super.onOptionsItemSelected(item);</span>
    }

    /**
     * Callback used to finish initializing the activity after the collection has been correctly loaded
     * @param col Collection which has been loaded
     */
    @Override
    protected void onCollectionLoaded(Collection col) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6321)) {</span>
<span class="nc" id="L217">            super.onCollectionLoaded(col);</span>
        }
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6323)) {</span>
            // take the passed model id load it up for editing
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (getTempModel() == null) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6322)) {</span>
<span class="nc" id="L223">                    mTempModel = new TemporaryModel(new Model(col.getModels().get(mModelId).toString()));</span>
                }
            }
        }
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6324)) {</span>
            // Set up the ViewPager with the sections adapter.
<span class="nc" id="L229">            mViewPager = findViewById(R.id.pager);</span>
        }
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6325)) {</span>
<span class="nc" id="L232">            mViewPager.setAdapter(new TemplatePagerAdapter((this)));</span>
        }
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6326)) {</span>
<span class="nc" id="L235">            mSlidingTabLayout = findViewById(R.id.sliding_tabs);</span>
        }
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6329)) {</span>
            // Set activity title
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if (getSupportActionBar() != null) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6327)) {</span>
<span class="nc" id="L241">                    getSupportActionBar().setTitle(R.string.title_activity_template_editor);</span>
                }
<span class="nc bnc" id="L243" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6328)) {</span>
<span class="nc" id="L244">                    getSupportActionBar().setSubtitle(mTempModel.getModel().optString(&quot;name&quot;));</span>
                }
            }
        }
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6330)) {</span>
            // Close collection opening dialog if needed
<span class="nc" id="L250">            Timber.i(&quot;CardTemplateEditor:: Card template editor successfully started for model id %d&quot;, mModelId);</span>
        }
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6331)) {</span>
            // Set the tab to the current template if an ord id was provided
<span class="nc" id="L254">            Timber.d(&quot;Setting starting tab to %d&quot;, mStartingOrdId);</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6338)) {</span>
<span class="nc bnc" id="L257" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(6336) ? (mStartingOrdId &gt;= -1) : (ListenerUtil.mutListener.listen(6335) ? (mStartingOrdId &lt;= -1) : (ListenerUtil.mutListener.listen(6334) ? (mStartingOrdId &gt; -1) : (ListenerUtil.mutListener.listen(6333) ? (mStartingOrdId &lt; -1) : (ListenerUtil.mutListener.listen(6332) ? (mStartingOrdId == -1) : (mStartingOrdId != -1))))))) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6337)) {</span>
<span class="nc" id="L259">                    mViewPager.setCurrentItem(mStartingOrdId, animationDisabled());</span>
                }
            }
        }
<span class="nc" id="L263">    }</span>

    public boolean modelHasChanged() {
<span class="nc" id="L266">        JSONObject oldModel = getCol().getModels().get(mModelId);</span>
<span class="nc bnc" id="L267" title="All 10 branches missed.">        return (ListenerUtil.mutListener.listen(6339) ? (getTempModel() != null || !getTempModel().getModel().toString().equals(oldModel.toString())) : (getTempModel() != null &amp;&amp; !getTempModel().getModel().toString().equals(oldModel.toString())));</span>
    }

    public TemporaryModel getTempModel() {
<span class="nc" id="L271">        return mTempModel;</span>
    }

    @VisibleForTesting
    public MaterialDialog showDiscardChangesDialog() {
<span class="nc" id="L276">        MaterialDialog discardDialog = DiscardChangesDialog.getDefault(this).onPositive((dialog, which) -&gt; {</span>
<span class="nc" id="L277">            Timber.i(&quot;TemplateEditor:: OK button pressed to confirm discard changes&quot;);</span>
            // Clear the edited model from any cache files, and clear it from this objects memory to discard changes
<span class="nc" id="L279">            TemporaryModel.clearTempModelFiles();</span>
<span class="nc" id="L280">            mTempModel = null;</span>
<span class="nc" id="L281">            finishWithAnimation(RIGHT);</span>
<span class="nc" id="L282">        }).build();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6340)) {</span>
<span class="nc" id="L284">            discardDialog.show();</span>
        }
<span class="nc" id="L286">        return discardDialog;</span>
    }

    /**
     * When a deck is selected via Deck Override
     */
    @Override
    public void onDeckSelected(@Nullable SelectableDeck deck) {
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6343)) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (getTempModel().getModel().isCloze()) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6341)) {</span>
<span class="nc" id="L297">                    Timber.w(&quot;Attempted to set deck for cloze model&quot;);</span>
                }
<span class="nc bnc" id="L299" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6342)) {</span>
<span class="nc" id="L300">                    UIUtils.showThemedToast(this, getString(R.string.multimedia_editor_something_wrong), true);</span>
                }
<span class="nc" id="L302">                return;</span>
            }
        }
<span class="nc" id="L305">        int ordinal = mViewPager.getCurrentItem();</span>
<span class="nc" id="L306">        JSONObject template = getTempModel().getTemplate(ordinal);</span>
<span class="nc" id="L307">        String templateName = template.getString(&quot;name&quot;);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6347)) {</span>
<span class="nc bnc" id="L309" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(6344) ? (deck != null || Decks.isDynamic(getCol(), deck.getDeckId())) : (deck != null &amp;&amp; Decks.isDynamic(getCol(), deck.getDeckId())))) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6345)) {</span>
<span class="nc" id="L311">                    Timber.w(&quot;Attempted to set default deck of %s to dynamic deck %s&quot;, templateName, deck.getName());</span>
                }
<span class="nc bnc" id="L313" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6346)) {</span>
<span class="nc" id="L314">                    UIUtils.showThemedToast(this, getString(R.string.multimedia_editor_something_wrong), true);</span>
                }
<span class="nc" id="L316">                return;</span>
            }
        }
        String message;
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (deck == null) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6350)) {</span>
<span class="nc" id="L322">                Timber.i(&quot;Removing default template from template '%s'&quot;, templateName);</span>
            }
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6351)) {</span>
<span class="nc" id="L325">                template.put(&quot;did&quot;, JSONObject.NULL);</span>
            }
<span class="nc" id="L327">            message = getString(R.string.model_manager_deck_override_removed_message, templateName);</span>
        } else {
<span class="nc bnc" id="L329" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6348)) {</span>
<span class="nc" id="L330">                Timber.i(&quot;Setting template '%s' to '%s'&quot;, templateName, deck.getName());</span>
            }
<span class="nc bnc" id="L332" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6349)) {</span>
<span class="nc" id="L333">                template.put(&quot;did&quot;, deck.getDeckId());</span>
            }
<span class="nc" id="L335">            message = getString(R.string.model_manager_deck_override_added_message, templateName, deck.getName());</span>
        }
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6352)) {</span>
<span class="nc" id="L338">            UIUtils.showThemedToast(this, message, true);</span>
        }
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6353)) {</span>
            // Deck Override can change from &quot;on&quot; &lt;-&gt; &quot;off&quot;
<span class="nc" id="L342">            supportInvalidateOptionsMenu();</span>
        }
<span class="nc" id="L344">    }</span>

    @Override
    public boolean onKeyUp(int keyCode, KeyEvent event) {
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(6357)) {</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">            if (keyCode == KeyEvent.KEYCODE_P) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6356)) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                    if (event.isCtrlPressed()) {</span>
<span class="nc" id="L352">                        CardTemplateFragment currentFragment = getCurrentFragment();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6355)) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                            if (currentFragment != null) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6354)) {</span>
<span class="nc" id="L356">                                    currentFragment.performPreview();</span>
                                }
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L364">        return super.onKeyUp(keyCode, event);</span>
    }

    @Nullable
    private CardTemplateFragment getCurrentFragment() {
        try {
<span class="nc" id="L370">            return (CardTemplateFragment) getSupportFragmentManager().findFragmentByTag(&quot;f&quot; + mViewPager.getCurrentItem());</span>
<span class="nc" id="L371">        } catch (Exception e) {</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6358)) {</span>
<span class="nc" id="L373">                Timber.w(&quot;Failed to get current fragment&quot;);</span>
            }
<span class="nc" id="L375">            return null;</span>
        }
    }

    /**
     * A {@link androidx.viewpager2.adapter.FragmentStateAdapter} that returns a fragment corresponding to
     * one of the tabs.
     */
    public class TemplatePagerAdapter extends FragmentStateAdapter {

<span class="nc" id="L385">        private long baseId = 0;</span>

<span class="nc" id="L387">        public TemplatePagerAdapter(@NonNull FragmentActivity fragmentActivity) {</span>
<span class="nc" id="L388">            super(fragmentActivity);</span>
<span class="nc" id="L389">        }</span>

        @NonNull
        @Override
        public Fragment createFragment(int position) {
<span class="nc" id="L394">            return CardTemplateFragment.newInstance(position, mNoteId);</span>
        }

        @Override
        public int getItemCount() {
<span class="nc bnc" id="L399" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6359)) {</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">                if (getTempModel() != null) {</span>
<span class="nc" id="L401">                    return getTempModel().getTemplateCount();</span>
                }
            }
<span class="nc" id="L404">            return 0;</span>
        }

        @Override
        public long getItemId(int position) {
<span class="nc bnc" id="L409" title="All 8 branches missed.">            return (ListenerUtil.mutListener.listen(6363) ? (baseId % position) : (ListenerUtil.mutListener.listen(6362) ? (baseId / position) : (ListenerUtil.mutListener.listen(6361) ? (baseId * position) : (ListenerUtil.mutListener.listen(6360) ? (baseId - position) : (baseId + position)))));</span>
        }

        @Override
        public boolean containsItem(long id) {
<span class="nc bnc" id="L414" title="All 282 branches missed.">            return ((ListenerUtil.mutListener.listen(6382) ? ((ListenerUtil.mutListener.listen(6372) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) &gt;= getItemCount()) : (ListenerUtil.mutListener.listen(6371) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) &lt;= getItemCount()) : (ListenerUtil.mutListener.listen(6370) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) &gt; getItemCount()) : (ListenerUtil.mutListener.listen(6369) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) != getItemCount()) : (ListenerUtil.mutListener.listen(6368) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) == getItemCount()) : ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) &lt; getItemCount())))))) || (ListenerUtil.mutListener.listen(6381) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) &lt;= 0) : (ListenerUtil.mutListener.listen(6380) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) &gt; 0) : (ListenerUtil.mutListener.listen(6379) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) &lt; 0) : (ListenerUtil.mutListener.listen(6378) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) != 0) : (ListenerUtil.mutListener.listen(6377) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) == 0) : ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) &gt;= 0))))))) : ((ListenerUtil.mutListener.listen(6372) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) &gt;= getItemCount()) : (ListenerUtil.mutListener.listen(6371) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) &lt;= getItemCount()) : (ListenerUtil.mutListener.listen(6370) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) &gt; getItemCount()) : (ListenerUtil.mutListener.listen(6369) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) != getItemCount()) : (ListenerUtil.mutListener.listen(6368) ? ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) == getItemCount()) : ((ListenerUtil.mutListener.listen(6367) ? (id % baseId) : (ListenerUtil.mutListener.listen(6366) ? (id / baseId) : (ListenerUtil.mutListener.listen(6365) ? (id * baseId) : (ListenerUtil.mutListener.listen(6364) ? (id + baseId) : (id - baseId))))) &lt; getItemCount())))))) &amp;&amp; (ListenerUtil.mutListener.listen(6381) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) &lt;= 0) : (ListenerUtil.mutListener.listen(6380) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) &gt; 0) : (ListenerUtil.mutListener.listen(6379) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) &lt; 0) : (ListenerUtil.mutListener.listen(6378) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) != 0) : (ListenerUtil.mutListener.listen(6377) ? ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) == 0) : ((ListenerUtil.mutListener.listen(6376) ? (id % baseId) : (ListenerUtil.mutListener.listen(6375) ? (id / baseId) : (ListenerUtil.mutListener.listen(6374) ? (id * baseId) : (ListenerUtil.mutListener.listen(6373) ? (id + baseId) : (id - baseId))))) &gt;= 0)))))))));</span>
        }

        /**
         * Force fragments to reinitialize contents by invalidating previous set of ordinal-based ids
         */
        public void ordinalShift() {
<span class="nc bnc" id="L421" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6387)) {</span>
<span class="nc bnc" id="L422" title="All 8 branches missed.">                baseId += (ListenerUtil.mutListener.listen(6386) ? (getItemCount() % 1) : (ListenerUtil.mutListener.listen(6385) ? (getItemCount() / 1) : (ListenerUtil.mutListener.listen(6384) ? (getItemCount() * 1) : (ListenerUtil.mutListener.listen(6383) ? (getItemCount() - 1) : (getItemCount() + 1)))));</span>
            }
<span class="nc" id="L424">        }</span>
    }

<span class="nc" id="L427">    public static class CardTemplateFragment extends Fragment {</span>

        private EditText mFront;

        private EditText mCss;

        private EditText mBack;

        private CardTemplateEditor mTemplateEditor;

        private TabLayoutMediator mTabLayoutMediator;

        public static CardTemplateFragment newInstance(int position, long noteId) {
<span class="nc" id="L440">            CardTemplateFragment f = new CardTemplateFragment();</span>
<span class="nc" id="L441">            Bundle args = new Bundle();</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6388)) {</span>
<span class="nc" id="L443">                args.putInt(&quot;position&quot;, position);</span>
            }
<span class="nc bnc" id="L445" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6389)) {</span>
<span class="nc" id="L446">                args.putLong(&quot;noteId&quot;, noteId);</span>
            }
<span class="nc bnc" id="L448" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6390)) {</span>
<span class="nc" id="L449">                f.setArguments(args);</span>
            }
<span class="nc" id="L451">            return f;</span>
        }

        @Override
        public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc bnc" id="L456" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6391)) {</span>
                // Storing a reference to the templateEditor allows us to use member variables
<span class="nc" id="L458">                mTemplateEditor = (CardTemplateEditor) getActivity();</span>
            }
<span class="nc" id="L460">            View mainView = inflater.inflate(R.layout.card_template_editor_item, container, false);</span>
<span class="nc" id="L461">            final int position = getArguments().getInt(&quot;position&quot;);</span>
<span class="nc" id="L462">            TemporaryModel tempModel = mTemplateEditor.getTempModel();</span>
            // Load template
            final JSONObject template;
            try {
<span class="nc" id="L466">                template = tempModel.getTemplate(position);</span>
<span class="nc" id="L467">            } catch (JSONException e) {</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6392)) {</span>
<span class="nc" id="L469">                    Timber.d(e, &quot;Exception loading template in CardTemplateFragment. Probably stale fragment.&quot;);</span>
                }
<span class="nc" id="L471">                return mainView;</span>
<span class="nc" id="L472">            }</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6393)) {</span>
                // Load EditText Views
<span class="nc" id="L475">                mFront = mainView.findViewById(R.id.front_edit);</span>
            }
<span class="nc bnc" id="L477" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6394)) {</span>
<span class="nc" id="L478">                mCss = mainView.findViewById(R.id.styling_edit);</span>
            }
<span class="nc bnc" id="L480" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6395)) {</span>
<span class="nc" id="L481">                mBack = mainView.findViewById(R.id.back_edit);</span>
            }
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6396)) {</span>
                // Set EditText content
<span class="nc" id="L485">                mFront.setText(template.getString(&quot;qfmt&quot;));</span>
            }
<span class="nc bnc" id="L487" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6397)) {</span>
<span class="nc" id="L488">                mCss.setText(tempModel.getCss());</span>
            }
<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6398)) {</span>
<span class="nc" id="L491">                mBack.setText(template.getString(&quot;afmt&quot;));</span>
            }
            // Set text change listeners
<span class="nc" id="L494">            TextWatcher templateEditorWatcher = new TextWatcher() {</span>

                @Override
                public void afterTextChanged(Editable arg0) {
<span class="nc bnc" id="L498" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6399)) {</span>
<span class="nc" id="L499">                        template.put(&quot;qfmt&quot;, mFront.getText());</span>
                    }
<span class="nc bnc" id="L501" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6400)) {</span>
<span class="nc" id="L502">                        template.put(&quot;afmt&quot;, mBack.getText());</span>
                    }
<span class="nc bnc" id="L504" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6401)) {</span>
<span class="nc" id="L505">                        mTemplateEditor.getTempModel().updateCss(mCss.getText().toString());</span>
                    }
<span class="nc bnc" id="L507" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6402)) {</span>
<span class="nc" id="L508">                        mTemplateEditor.getTempModel().updateTemplate(position, template);</span>
                    }
<span class="nc" id="L510">                }</span>

                @Override
                public void beforeTextChanged(CharSequence arg0, int arg1, int arg2, int arg3) {
<span class="nc" id="L514">                }</span>

                @Override
                public void onTextChanged(CharSequence arg0, int arg1, int arg2, int arg3) {
<span class="nc" id="L518">                }</span>
            };
<span class="nc bnc" id="L520" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6403)) {</span>
<span class="nc" id="L521">                mFront.addTextChangedListener(templateEditorWatcher);</span>
            }
<span class="nc bnc" id="L523" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6404)) {</span>
<span class="nc" id="L524">                mCss.addTextChangedListener(templateEditorWatcher);</span>
            }
<span class="nc bnc" id="L526" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6405)) {</span>
<span class="nc" id="L527">                mBack.addTextChangedListener(templateEditorWatcher);</span>
            }
<span class="nc bnc" id="L529" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6406)) {</span>
                // Enable menu
<span class="nc" id="L531">                setHasOptionsMenu(true);</span>
            }
<span class="nc" id="L533">            return mainView;</span>
        }

        @Override
        public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
<span class="nc bnc" id="L538" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6407)) {</span>
<span class="nc" id="L539">                initTabLayoutMediator();</span>
            }
<span class="nc" id="L541">        }</span>

        private void initTabLayoutMediator() {
<span class="nc bnc" id="L544" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6409)) {</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">                if (mTabLayoutMediator != null) {</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6408)) {</span>
<span class="nc" id="L547">                        mTabLayoutMediator.detach();</span>
                    }
                }
            }
<span class="nc bnc" id="L551" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6410)) {</span>
<span class="nc" id="L552">                mTabLayoutMediator = new TabLayoutMediator(mTemplateEditor.mSlidingTabLayout, mTemplateEditor.mViewPager, (tab, position) -&gt; tab.setText(mTemplateEditor.getTempModel().getTemplate(position).getString(&quot;name&quot;)));</span>
            }
<span class="nc bnc" id="L554" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6411)) {</span>
<span class="nc" id="L555">                mTabLayoutMediator.attach();</span>
            }
<span class="nc" id="L557">        }</span>

        @Override
        public void onResume() {
<span class="nc bnc" id="L561" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6412)) {</span>
                // initTabLayoutMediator();
<span class="nc" id="L563">                super.onResume();</span>
            }
<span class="nc" id="L565">        }</span>

        @Override
        public void onCreateOptionsMenu(@NonNull Menu menu, MenuInflater inflater) {
<span class="nc bnc" id="L569" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6413)) {</span>
<span class="nc" id="L570">                menu.clear();</span>
            }
<span class="nc bnc" id="L572" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6414)) {</span>
<span class="nc" id="L573">                inflater.inflate(R.menu.card_template_editor, menu);</span>
            }
<span class="nc bnc" id="L575" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6420)) {</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                if (mTemplateEditor.getTempModel().getModel().isCloze()) {</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6417)) {</span>
<span class="nc" id="L578">                        Timber.d(&quot;Editing cloze model, disabling add/delete card template and deck override functionality&quot;);</span>
                    }
<span class="nc bnc" id="L580" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6418)) {</span>
<span class="nc" id="L581">                        menu.findItem(R.id.action_add).setVisible(false);</span>
                    }
<span class="nc bnc" id="L583" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6419)) {</span>
<span class="nc" id="L584">                        menu.findItem(R.id.action_add_deck_override).setVisible(false);</span>
                    }
                } else {
<span class="nc" id="L587">                    JSONObject template = getCurrentTemplate();</span>
                    @StringRes
<span class="nc bnc" id="L589" title="All 10 branches missed.">                    int overrideStringRes = (ListenerUtil.mutListener.listen(6415) ? (template.has(&quot;did&quot;) || !template.isNull(&quot;did&quot;)) : (template.has(&quot;did&quot;) &amp;&amp; !template.isNull(&quot;did&quot;))) ? R.string.card_template_editor_deck_override_on : R.string.card_template_editor_deck_override_off;</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6416)) {</span>
<span class="nc" id="L591">                        menu.findItem(R.id.action_add_deck_override).setTitle(overrideStringRes);</span>
                    }
                }
            }
<span class="nc bnc" id="L595" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6427)) {</span>
                // It is invalid to delete if there is only one card template, remove the option from UI
<span class="nc bnc" id="L597" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6425) ? (mTemplateEditor.getTempModel().getTemplateCount() &gt;= 2) : (ListenerUtil.mutListener.listen(6424) ? (mTemplateEditor.getTempModel().getTemplateCount() &lt;= 2) : (ListenerUtil.mutListener.listen(6423) ? (mTemplateEditor.getTempModel().getTemplateCount() &gt; 2) : (ListenerUtil.mutListener.listen(6422) ? (mTemplateEditor.getTempModel().getTemplateCount() != 2) : (ListenerUtil.mutListener.listen(6421) ? (mTemplateEditor.getTempModel().getTemplateCount() == 2) : (mTemplateEditor.getTempModel().getTemplateCount() &lt; 2))))))) {</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6426)) {</span>
<span class="nc" id="L599">                        menu.findItem(R.id.action_delete).setVisible(false);</span>
                    }
                }
            }
<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6428)) {</span>
<span class="nc" id="L604">                super.onCreateOptionsMenu(menu, inflater);</span>
            }
<span class="nc" id="L606">        }</span>

        @Override
        public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc" id="L610">            final Collection col = mTemplateEditor.getCol();</span>
<span class="nc" id="L611">            TemporaryModel tempModel = mTemplateEditor.getTempModel();</span>
<span class="nc" id="L612">            int itemId = item.getItemId();</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6457)) {</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                if (itemId == R.id.action_add) {</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6455)) {</span>
<span class="nc" id="L616">                        Timber.i(&quot;CardTemplateEditor:: Add template button pressed&quot;);</span>
                    }
<span class="nc bnc" id="L618" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6456)) {</span>
                        // AnkiDroid never had this so it isn't a regression but it is a miss for AnkiDesktop parity
<span class="nc" id="L620">                        addNewTemplateWithCheck(tempModel.getModel());</span>
                    }
<span class="nc" id="L622">                    return true;</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                } else if (itemId == R.id.action_delete) {</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6442)) {</span>
<span class="nc" id="L625">                        Timber.i(&quot;CardTemplateEditor:: Delete template button pressed&quot;);</span>
                    }
<span class="nc" id="L627">                    Resources res = getResources();</span>
<span class="nc" id="L628">                    int ordinal = mTemplateEditor.mViewPager.getCurrentItem();</span>
<span class="nc" id="L629">                    final JSONObject template = tempModel.getTemplate(ordinal);</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6449)) {</span>
                        // Don't do anything if only one template
<span class="nc bnc" id="L632" title="All 22 branches missed.">                        if ((ListenerUtil.mutListener.listen(6447) ? (tempModel.getTemplateCount() &gt;= 2) : (ListenerUtil.mutListener.listen(6446) ? (tempModel.getTemplateCount() &lt;= 2) : (ListenerUtil.mutListener.listen(6445) ? (tempModel.getTemplateCount() &gt; 2) : (ListenerUtil.mutListener.listen(6444) ? (tempModel.getTemplateCount() != 2) : (ListenerUtil.mutListener.listen(6443) ? (tempModel.getTemplateCount() == 2) : (tempModel.getTemplateCount() &lt; 2))))))) {</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6448)) {</span>
<span class="nc" id="L634">                                mTemplateEditor.showSimpleMessageDialog(res.getString(R.string.card_template_editor_cant_delete));</span>
                            }
<span class="nc" id="L636">                            return true;</span>
                        }
                    }
<span class="nc bnc" id="L639" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6450)) {</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">                        if (deletionWouldOrphanNote(col, tempModel, ordinal)) {</span>
<span class="nc" id="L641">                            return true;</span>
                        }
                    }
                    // Show confirmation dialog
<span class="nc" id="L645">                    int numAffectedCards = 0;</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6453)) {</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">                        if (!TemporaryModel.isOrdinalPendingAdd(tempModel, ordinal)) {</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6451)) {</span>
<span class="nc" id="L649">                                Timber.d(&quot;Ordinal is not a pending add, so we'll get the current card count for confirmation&quot;);</span>
                            }
<span class="nc bnc" id="L651" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6452)) {</span>
<span class="nc" id="L652">                                numAffectedCards = col.getModels().tmplUseCount(tempModel.getModel(), ordinal);</span>
                            }
                        }
                    }
<span class="nc bnc" id="L656" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6454)) {</span>
<span class="nc" id="L657">                        confirmDeleteCards(template, tempModel.getModel(), numAffectedCards);</span>
                    }
<span class="nc" id="L659">                    return true;</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">                } else if (itemId == R.id.action_add_deck_override) {</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6441)) {</span>
<span class="nc" id="L662">                        displayDeckOverrideDialog(col, tempModel);</span>
                    }
<span class="nc" id="L664">                    return true;</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">                } else if (itemId == R.id.action_preview) {</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6440)) {</span>
<span class="nc" id="L667">                        performPreview();</span>
                    }
<span class="nc" id="L669">                    return true;</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                } else if (itemId == R.id.action_confirm) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6431)) {</span>
<span class="nc" id="L672">                        Timber.i(&quot;CardTemplateEditor:: Save model button pressed&quot;);</span>
                    }
<span class="nc bnc" id="L674" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6439)) {</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">                        if (modelHasChanged()) {</span>
<span class="nc" id="L676">                            View confirmButton = mTemplateEditor.findViewById(R.id.action_confirm);</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6437)) {</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">                                if (confirmButton != null) {</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(6435)) {</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                                        if (!confirmButton.isEnabled()) {</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(6434)) {</span>
<span class="nc" id="L682">                                                Timber.d(&quot;CardTemplateEditor::discarding extra click after button disabled&quot;);</span>
                                            }
<span class="nc" id="L684">                                            return true;</span>
                                        }
                                    }
<span class="nc bnc" id="L687" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(6436)) {</span>
<span class="nc" id="L688">                                        confirmButton.setEnabled(false);</span>
                                    }
                                }
                            }
<span class="nc bnc" id="L692" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6438)) {</span>
<span class="nc" id="L693">                                tempModel.saveToDatabase(saveModelAndExitHandler());</span>
                            }
<span class="nc" id="L695">                        } else {</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6432)) {</span>
<span class="nc" id="L697">                                Timber.d(&quot;CardTemplateEditor:: model has not changed, exiting&quot;);</span>
                            }
<span class="nc bnc" id="L699" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6433)) {</span>
<span class="nc" id="L700">                                mTemplateEditor.finishWithAnimation(RIGHT);</span>
                            }
                        }
                    }
<span class="nc" id="L704">                    return true;</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">                } else if (itemId == R.id.action_card_browser_appearance) {</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6429)) {</span>
<span class="nc" id="L707">                        Timber.i(&quot;CardTemplateEditor::Card Browser Template button pressed&quot;);</span>
                    }
<span class="nc bnc" id="L709" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6430)) {</span>
<span class="nc" id="L710">                        launchCardBrowserAppearance(getCurrentTemplate());</span>
                    }
<span class="nc" id="L712">                    return super.onOptionsItemSelected(item);</span>
                }
            }
<span class="nc" id="L715">            return super.onOptionsItemSelected(item);</span>
        }

        private void performPreview() {
<span class="nc" id="L719">            Collection col = mTemplateEditor.getCol();</span>
<span class="nc" id="L720">            TemporaryModel tempModel = mTemplateEditor.getTempModel();</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6458)) {</span>
<span class="nc" id="L722">                Timber.i(&quot;CardTemplateEditor:: Preview on tab %s&quot;, mTemplateEditor.mViewPager.getCurrentItem());</span>
            }
            // Create intent for the previewer and add some arguments
<span class="nc" id="L725">            Intent i = new Intent(mTemplateEditor, CardTemplatePreviewer.class);</span>
<span class="nc" id="L726">            int ordinal = mTemplateEditor.mViewPager.getCurrentItem();</span>
<span class="nc" id="L727">            long noteId = getArguments().getLong(&quot;noteId&quot;);</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6459)) {</span>
<span class="nc" id="L729">                i.putExtra(&quot;ordinal&quot;, ordinal);</span>
            }
<span class="nc bnc" id="L731" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6472)) {</span>
                // If we have a card for this position, send it, otherwise an empty cardlist signals to show a blank
<span class="nc bnc" id="L733" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6464) ? (noteId &gt;= -1L) : (ListenerUtil.mutListener.listen(6463) ? (noteId &lt;= -1L) : (ListenerUtil.mutListener.listen(6462) ? (noteId &gt; -1L) : (ListenerUtil.mutListener.listen(6461) ? (noteId &lt; -1L) : (ListenerUtil.mutListener.listen(6460) ? (noteId == -1L) : (noteId != -1L))))))) {</span>
<span class="nc" id="L734">                    List&lt;Long&gt; cids = col.getNote(noteId).cids();</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6471)) {</span>
<span class="nc bnc" id="L736" title="All 22 branches missed.">                        if ((ListenerUtil.mutListener.listen(6469) ? (ordinal &gt;= cids.size()) : (ListenerUtil.mutListener.listen(6468) ? (ordinal &lt;= cids.size()) : (ListenerUtil.mutListener.listen(6467) ? (ordinal &gt; cids.size()) : (ListenerUtil.mutListener.listen(6466) ? (ordinal != cids.size()) : (ListenerUtil.mutListener.listen(6465) ? (ordinal == cids.size()) : (ordinal &lt; cids.size()))))))) {</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6470)) {</span>
<span class="nc" id="L738">                                i.putExtra(&quot;cardList&quot;, new long[] { cids.get(ordinal) });</span>
                            }
                        }
                    }
                }
            }
<span class="nc bnc" id="L744" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6473)) {</span>
                // Save the model and pass the filename if updated
<span class="nc" id="L746">                tempModel.setEditedModelFileName(TemporaryModel.saveTempModel(mTemplateEditor, tempModel.getModel()));</span>
            }
<span class="nc bnc" id="L748" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6474)) {</span>
<span class="nc" id="L749">                i.putExtra(TemporaryModel.INTENT_MODEL_FILENAME, tempModel.getEditedModelFileName());</span>
            }
<span class="nc bnc" id="L751" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6475)) {</span>
<span class="nc" id="L752">                startActivityForResult(i, REQUEST_PREVIEWER);</span>
            }
<span class="nc" id="L754">        }</span>

        private void displayDeckOverrideDialog(Collection col, TemporaryModel tempModel) {
<span class="nc" id="L757">            AnkiActivity activity = (AnkiActivity) requireActivity();</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6477)) {</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">                if (tempModel.getModel().isCloze()) {</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6476)) {</span>
<span class="nc" id="L761">                        UIUtils.showThemedToast(activity, getString(R.string.multimedia_editor_something_wrong), true);</span>
                    }
<span class="nc" id="L763">                    return;</span>
                }
            }
<span class="nc" id="L766">            String name = getCurrentTemplateName(tempModel);</span>
<span class="nc" id="L767">            String explanation = getString(R.string.deck_override_explanation, name);</span>
            // https://forums.ankiweb.net/t/minor-bug-deck-override-to-filtered-deck/1493
<span class="nc bnc" id="L769" title="All 2 branches missed.">            FunctionalInterfaces.Filter&lt;Deck&gt; nonDynamic = (d) -&gt; !Decks.isDynamic(d);</span>
<span class="nc" id="L770">            List&lt;SelectableDeck&gt; decks = SelectableDeck.fromCollection(col, nonDynamic);</span>
<span class="nc" id="L771">            String title = getString(R.string.card_template_editor_deck_override);</span>
<span class="nc" id="L772">            DeckSelectionDialog dialog = DeckSelectionDialog.newInstance(title, explanation, decks);</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6478)) {</span>
<span class="nc" id="L774">                AnkiActivity.showDialogFragment(activity, dialog);</span>
            }
<span class="nc" id="L776">        }</span>

        private String getCurrentTemplateName(TemporaryModel tempModel) {
            try {
<span class="nc" id="L780">                int ordinal = mTemplateEditor.mViewPager.getCurrentItem();</span>
<span class="nc" id="L781">                final JSONObject template = tempModel.getTemplate(ordinal);</span>
<span class="nc" id="L782">                return template.getString(&quot;name&quot;);</span>
<span class="nc" id="L783">            } catch (Exception e) {</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6479)) {</span>
<span class="nc" id="L785">                    Timber.w(e, &quot;Failed to get name for template&quot;);</span>
                }
<span class="nc" id="L787">                return &quot;&quot;;</span>
            }
        }

        private void launchCardBrowserAppearance(JSONObject currentTemplate) {
<span class="nc" id="L792">            Context context = AnkiDroidApp.getInstance().getBaseContext();</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6481)) {</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">                if (context == null) {</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6480)) {</span>
                        // Catch-22, we can't notify failure as there's no context. Shouldn't happen anyway
<span class="nc" id="L797">                        Timber.w(&quot;Context was null - couldn't launch Card Browser Appearance window&quot;);</span>
                    }
<span class="nc" id="L799">                    return;</span>
                }
            }
<span class="nc" id="L802">            Intent browserAppearanceIntent = CardTemplateBrowserAppearanceEditor.getIntentFromTemplate(context, currentTemplate);</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6482)) {</span>
<span class="nc" id="L804">                startActivityForResult(browserAppearanceIntent, REQUEST_CARD_BROWSER_APPEARANCE);</span>
            }
<span class="nc" id="L806">        }</span>

        @CheckResult
        @NonNull
        private JSONObject getCurrentTemplate() {
<span class="nc" id="L811">            int currentCardTemplateIndex = getCurrentCardTemplateIndex();</span>
<span class="nc" id="L812">            return mTemplateEditor.getTempModel().getModel().getJSONArray(&quot;tmpls&quot;).getJSONObject(currentCardTemplateIndex);</span>
        }

        /**
         * @return The index of the card template which is currently referred to by the fragment
         */
        @CheckResult
        private int getCurrentCardTemplateIndex() {
            // COULD_BE_BETTER: Lots of duplicate code could call this. Hold off on the refactor until #5151 goes in.
<span class="nc" id="L821">            return getArguments().getInt(&quot;position&quot;);</span>
        }

        private boolean deletionWouldOrphanNote(Collection col, TemporaryModel tempModel, int position) {
<span class="nc bnc" id="L825" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6485)) {</span>
                // pending deletes could orphan cards
<span class="nc bnc" id="L827" title="All 2 branches missed.">                if (!TemporaryModel.isOrdinalPendingAdd(tempModel, position)) {</span>
<span class="nc" id="L828">                    int[] currentDeletes = tempModel.getDeleteDbOrds(position);</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6484)) {</span>
                        // TODO - this is a SQL query on GUI thread - should see a DeckTask conversion ideally
<span class="nc bnc" id="L831" title="All 2 branches missed.">                        if (col.getModels().getCardIdsForModel(tempModel.getModelId(), currentDeletes) == null) {</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(6483)) {</span>
                                // not already have cards generated making it safe will see this error message:
<span class="nc" id="L834">                                mTemplateEditor.showSimpleMessageDialog(getResources().getString(R.string.card_template_editor_would_delete_note));</span>
                            }
<span class="nc" id="L836">                            return true;</span>
                        }
                    }
                }
            }
<span class="nc" id="L841">            return false;</span>
        }

        @Override
        public void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
<span class="nc bnc" id="L846" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6486)) {</span>
<span class="nc" id="L847">                super.onActivityResult(requestCode, resultCode, data);</span>
            }
<span class="nc bnc" id="L849" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6493)) {</span>
<span class="nc bnc" id="L850" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6491) ? (requestCode &gt;= REQUEST_CARD_BROWSER_APPEARANCE) : (ListenerUtil.mutListener.listen(6490) ? (requestCode &lt;= REQUEST_CARD_BROWSER_APPEARANCE) : (ListenerUtil.mutListener.listen(6489) ? (requestCode &gt; REQUEST_CARD_BROWSER_APPEARANCE) : (ListenerUtil.mutListener.listen(6488) ? (requestCode &lt; REQUEST_CARD_BROWSER_APPEARANCE) : (ListenerUtil.mutListener.listen(6487) ? (requestCode != REQUEST_CARD_BROWSER_APPEARANCE) : (requestCode == REQUEST_CARD_BROWSER_APPEARANCE))))))) {</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6492)) {</span>
<span class="nc" id="L852">                        onCardBrowserAppearanceResult(resultCode, data);</span>
                    }
<span class="nc" id="L854">                    return;</span>
                }
            }
<span class="nc bnc" id="L857" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6502)) {</span>
<span class="nc bnc" id="L858" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(6498) ? (requestCode &gt;= REQUEST_PREVIEWER) : (ListenerUtil.mutListener.listen(6497) ? (requestCode &lt;= REQUEST_PREVIEWER) : (ListenerUtil.mutListener.listen(6496) ? (requestCode &gt; REQUEST_PREVIEWER) : (ListenerUtil.mutListener.listen(6495) ? (requestCode &lt; REQUEST_PREVIEWER) : (ListenerUtil.mutListener.listen(6494) ? (requestCode != REQUEST_PREVIEWER) : (requestCode == REQUEST_PREVIEWER))))))) {</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6499)) {</span>
<span class="nc" id="L860">                        TemporaryModel.clearTempModelFiles();</span>
                    }
<span class="nc bnc" id="L862" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6500)) {</span>
                        // Make sure the fragments reinitialize, otherwise there is staleness on return
<span class="nc" id="L864">                        ((TemplatePagerAdapter) mTemplateEditor.mViewPager.getAdapter()).ordinalShift();</span>
                    }
<span class="nc bnc" id="L866" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6501)) {</span>
<span class="nc" id="L867">                        mTemplateEditor.mViewPager.getAdapter().notifyDataSetChanged();</span>
                    }
                }
            }
<span class="nc" id="L871">        }</span>

        private void onCardBrowserAppearanceResult(int resultCode, @Nullable Intent data) {
<span class="nc bnc" id="L874" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6504)) {</span>
<span class="nc bnc" id="L875" title="All 2 branches missed.">                if (resultCode != RESULT_OK) {</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6503)) {</span>
<span class="nc" id="L877">                        Timber.i(&quot;Activity Cancelled: Card Template Browser Appearance&quot;);</span>
                    }
<span class="nc" id="L879">                    return;</span>
                }
            }
<span class="nc" id="L882">            CardTemplateBrowserAppearanceEditor.Result result = CardTemplateBrowserAppearanceEditor.Result.fromIntent(data);</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6506)) {</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">                if (result == null) {</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6505)) {</span>
<span class="nc" id="L886">                        Timber.w(&quot;Error processing Card Template Browser Appearance result&quot;);</span>
                    }
<span class="nc" id="L888">                    return;</span>
                }
            }
<span class="nc bnc" id="L891" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6507)) {</span>
<span class="nc" id="L892">                Timber.i(&quot;Applying Card Template Browser Appearance result&quot;);</span>
            }
<span class="nc" id="L894">            JSONObject currentTemplate = getCurrentTemplate();</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6508)) {</span>
<span class="nc" id="L896">                result.applyTo(currentTemplate);</span>
            }
<span class="nc" id="L898">        }</span>

        /* Used for updating the collection when a model has been edited */
        private SaveModelAndExitHandler saveModelAndExitHandler() {
<span class="nc" id="L902">            return new SaveModelAndExitHandler(this);</span>
        }

        static class SaveModelAndExitHandler extends TaskListenerWithContext&lt;CardTemplateFragment, Void, Pair&lt;Boolean, String&gt;&gt; {

            public SaveModelAndExitHandler(CardTemplateFragment templateFragment) {
<span class="nc" id="L908">                super(templateFragment);</span>
<span class="nc" id="L909">            }</span>

<span class="nc" id="L911">            private MaterialDialog mProgressDialog = null;</span>

            @Override
            public void actualOnPreExecute(@NonNull CardTemplateFragment templateFragment) {
<span class="nc bnc" id="L915" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6509)) {</span>
<span class="nc" id="L916">                    Timber.d(&quot;saveModelAndExitHandler::preExecute called&quot;);</span>
                }
<span class="nc bnc" id="L918" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6510)) {</span>
<span class="nc" id="L919">                    mProgressDialog = StyledProgressDialog.show(templateFragment.mTemplateEditor, AnkiDroidApp.getAppResources().getString(R.string.saving_model), templateFragment.getResources().getString(R.string.saving_changes), false);</span>
                }
<span class="nc" id="L921">            }</span>

            @Override
            public void actualOnPostExecute(@NonNull CardTemplateFragment templateFragment, Pair&lt;Boolean, String&gt; result) {
<span class="nc bnc" id="L925" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6511)) {</span>
<span class="nc" id="L926">                    Timber.d(&quot;saveModelAndExitHandler::postExecute called&quot;);</span>
                }
<span class="nc" id="L928">                View button = templateFragment.mTemplateEditor.findViewById(R.id.action_confirm);</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6513)) {</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">                    if (button != null) {</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6512)) {</span>
<span class="nc" id="L932">                            button.setEnabled(true);</span>
                        }
                    }
                }
<span class="nc bnc" id="L936" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6516)) {</span>
<span class="nc bnc" id="L937" title="All 10 branches missed.">                    if ((ListenerUtil.mutListener.listen(6514) ? (mProgressDialog != null || mProgressDialog.isShowing()) : (mProgressDialog != null &amp;&amp; mProgressDialog.isShowing()))) {</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6515)) {</span>
<span class="nc" id="L939">                            mProgressDialog.dismiss();</span>
                        }
                    }
                }
<span class="nc bnc" id="L943" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6517)) {</span>
<span class="nc" id="L944">                    templateFragment.mTemplateEditor.mTempModel = null;</span>
                }
<span class="nc bnc" id="L946" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6522)) {</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">                    if (result.first) {</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6521)) {</span>
<span class="nc" id="L949">                            templateFragment.mTemplateEditor.finishWithAnimation(RIGHT);</span>
                        }
                    } else {
<span class="nc bnc" id="L952" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6518)) {</span>
<span class="nc" id="L953">                            Timber.w(&quot;CardTemplateFragment:: save model task failed: %s&quot;, result.second);</span>
                        }
<span class="nc bnc" id="L955" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6519)) {</span>
<span class="nc" id="L956">                            UIUtils.showThemedToast(templateFragment.mTemplateEditor, templateFragment.getString(R.string.card_template_editor_save_error, result.second), false);</span>
                        }
<span class="nc bnc" id="L958" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6520)) {</span>
<span class="nc" id="L959">                            templateFragment.mTemplateEditor.finishWithoutAnimation();</span>
                        }
                    }
                }
<span class="nc" id="L963">            }</span>
        }

        private boolean modelHasChanged() {
<span class="nc" id="L967">            return mTemplateEditor.modelHasChanged();</span>
        }

        /**
         * Confirm if the user wants to delete all the cards associated with current template
         *
         * @param tmpl template to remove
         * @param model model to remove template from, modified in place by reference
         * @param numAffectedCards number of cards which will be affected
         */
        private void confirmDeleteCards(final JSONObject tmpl, final Model model, int numAffectedCards) {
<span class="nc" id="L978">            ConfirmationDialog d = new ConfirmationDialog();</span>
<span class="nc" id="L979">            Resources res = getResources();</span>
<span class="nc" id="L980">            String msg = String.format(res.getQuantityString(R.plurals.card_template_editor_confirm_delete, numAffectedCards), numAffectedCards, tmpl.optString(&quot;name&quot;));</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6523)) {</span>
<span class="nc" id="L982">                d.setArgs(msg);</span>
            }
<span class="nc" id="L984">            Runnable confirm = () -&gt; deleteTemplateWithCheck(tmpl, model);</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6524)) {</span>
<span class="nc" id="L986">                d.setConfirm(confirm);</span>
            }
<span class="nc bnc" id="L988" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6525)) {</span>
<span class="nc" id="L989">                mTemplateEditor.showDialogFragment(d);</span>
            }
<span class="nc" id="L991">        }</span>

        /**
         * Delete tmpl from model, asking user to confirm again if it's going to require a full sync
         *
         * @param tmpl template to remove
         * @param model model to remove template from, modified in place by reference
         */
        private void deleteTemplateWithCheck(final JSONObject tmpl, final Model model) {
            try {
<span class="nc bnc" id="L1001" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6530)) {</span>
<span class="nc" id="L1002">                    mTemplateEditor.getCol().modSchema();</span>
                }
<span class="nc bnc" id="L1004" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6531)) {</span>
<span class="nc" id="L1005">                    deleteTemplate(tmpl, model);</span>
                }
<span class="nc" id="L1007">            } catch (ConfirmModSchemaException e) {</span>
<span class="nc" id="L1008">                ConfirmationDialog d = new ConfirmationDialog();</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6526)) {</span>
<span class="nc" id="L1010">                    d.setArgs(getResources().getString(R.string.full_sync_confirmation));</span>
                }
<span class="nc" id="L1012">                Runnable confirm = () -&gt; {</span>
<span class="nc" id="L1013">                    mTemplateEditor.getCol().modSchemaNoCheck();</span>
<span class="nc" id="L1014">                    deleteTemplate(tmpl, model);</span>
<span class="nc" id="L1015">                };</span>
<span class="nc" id="L1016">                Runnable cancel = () -&gt; mTemplateEditor.dismissAllDialogFragments();</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6527)) {</span>
<span class="nc" id="L1018">                    d.setConfirm(confirm);</span>
                }
<span class="nc bnc" id="L1020" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6528)) {</span>
<span class="nc" id="L1021">                    d.setCancel(cancel);</span>
                }
<span class="nc bnc" id="L1023" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6529)) {</span>
<span class="nc" id="L1024">                    mTemplateEditor.showDialogFragment(d);</span>
                }
<span class="nc" id="L1026">            }</span>
<span class="nc" id="L1027">        }</span>

        /**
         * @param tmpl template to remove
         * @param model model to remove from, updated in place by reference
         */
        private void deleteTemplate(JSONObject tmpl, Model model) {
<span class="nc" id="L1034">            JSONArray oldTemplates = model.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc" id="L1035">            JSONArray newTemplates = new JSONArray();</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6541)) {</span>
                {
<span class="nc" id="L1038">                    long _loopCounter115 = 0;</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">                    for (JSONObject possibleMatch : oldTemplates.jsonObjectIterable()) {</span>
<span class="nc" id="L1040">                        ListenerUtil.loopListener.listen(&quot;_loopCounter115&quot;, ++_loopCounter115);</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(6540)) {</span>
<span class="nc bnc" id="L1042" title="All 22 branches missed.">                            if ((ListenerUtil.mutListener.listen(6536) ? (possibleMatch.getInt(&quot;ord&quot;) &gt;= tmpl.getInt(&quot;ord&quot;)) : (ListenerUtil.mutListener.listen(6535) ? (possibleMatch.getInt(&quot;ord&quot;) &lt;= tmpl.getInt(&quot;ord&quot;)) : (ListenerUtil.mutListener.listen(6534) ? (possibleMatch.getInt(&quot;ord&quot;) &gt; tmpl.getInt(&quot;ord&quot;)) : (ListenerUtil.mutListener.listen(6533) ? (possibleMatch.getInt(&quot;ord&quot;) &lt; tmpl.getInt(&quot;ord&quot;)) : (ListenerUtil.mutListener.listen(6532) ? (possibleMatch.getInt(&quot;ord&quot;) == tmpl.getInt(&quot;ord&quot;)) : (possibleMatch.getInt(&quot;ord&quot;) != tmpl.getInt(&quot;ord&quot;)))))))) {</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6539)) {</span>
<span class="nc" id="L1044">                                    newTemplates.put(possibleMatch);</span>
                                }
                            } else {
<span class="nc bnc" id="L1047" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6537)) {</span>
<span class="nc" id="L1048">                                    Timber.d(&quot;deleteTemplate() found match - removing template with ord %s&quot;, possibleMatch.getInt(&quot;ord&quot;));</span>
                                }
<span class="nc bnc" id="L1050" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6538)) {</span>
<span class="nc" id="L1051">                                    mTemplateEditor.getTempModel().removeTemplate(possibleMatch.getInt(&quot;ord&quot;));</span>
                                }
                            }
                        }
<span class="nc" id="L1055">                    }</span>
                }
            }
<span class="nc bnc" id="L1058" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6542)) {</span>
<span class="nc" id="L1059">                model.put(&quot;tmpls&quot;, newTemplates);</span>
            }
<span class="nc bnc" id="L1061" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6543)) {</span>
<span class="nc" id="L1062">                Models._updateTemplOrds(model);</span>
            }
<span class="nc bnc" id="L1064" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6544)) {</span>
                // Make sure the fragments reinitialize, otherwise the reused ordinal causes staleness
<span class="nc" id="L1066">                ((TemplatePagerAdapter) mTemplateEditor.mViewPager.getAdapter()).ordinalShift();</span>
            }
<span class="nc bnc" id="L1068" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6545)) {</span>
<span class="nc" id="L1069">                mTemplateEditor.mViewPager.getAdapter().notifyDataSetChanged();</span>
            }
<span class="nc bnc" id="L1071" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6550)) {</span>
<span class="nc bnc" id="L1072" title="All 8 branches missed.">                mTemplateEditor.mViewPager.setCurrentItem((ListenerUtil.mutListener.listen(6549) ? (newTemplates.length() % 1) : (ListenerUtil.mutListener.listen(6548) ? (newTemplates.length() / 1) : (ListenerUtil.mutListener.listen(6547) ? (newTemplates.length() * 1) : (ListenerUtil.mutListener.listen(6546) ? (newTemplates.length() + 1) : (newTemplates.length() - 1))))), mTemplateEditor.animationDisabled());</span>
            }
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6552)) {</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                if (getActivity() != null) {</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6551)) {</span>
<span class="nc" id="L1077">                        ((CardTemplateEditor) getActivity()).dismissAllDialogFragments();</span>
                    }
                }
            }
<span class="nc" id="L1081">        }</span>

        /**
         * Add new template to model, asking user to confirm if it's going to require a full sync
         *
         * @param model model to add new template to
         */
        private void addNewTemplateWithCheck(final JSONObject model) {
            try {
<span class="nc bnc" id="L1090" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6556)) {</span>
<span class="nc" id="L1091">                    mTemplateEditor.getCol().modSchema();</span>
                }
<span class="nc bnc" id="L1093" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6557)) {</span>
<span class="nc" id="L1094">                    Timber.d(&quot;addNewTemplateWithCheck() called and no CMSE?&quot;);</span>
                }
<span class="nc bnc" id="L1096" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6558)) {</span>
<span class="nc" id="L1097">                    addNewTemplate(model);</span>
                }
<span class="nc" id="L1099">            } catch (ConfirmModSchemaException e) {</span>
<span class="nc" id="L1100">                ConfirmationDialog d = new ConfirmationDialog();</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6553)) {</span>
<span class="nc" id="L1102">                    d.setArgs(getResources().getString(R.string.full_sync_confirmation));</span>
                }
<span class="nc" id="L1104">                Runnable confirm = () -&gt; {</span>
<span class="nc" id="L1105">                    mTemplateEditor.getCol().modSchemaNoCheck();</span>
<span class="nc" id="L1106">                    addNewTemplate(model);</span>
<span class="nc" id="L1107">                };</span>
<span class="nc bnc" id="L1108" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6554)) {</span>
<span class="nc" id="L1109">                    d.setConfirm(confirm);</span>
                }
<span class="nc bnc" id="L1111" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(6555)) {</span>
<span class="nc" id="L1112">                    mTemplateEditor.showDialogFragment(d);</span>
                }
<span class="nc" id="L1114">            }</span>
<span class="nc" id="L1115">        }</span>

        /**
         * Add new template to a given model
         * @param model model to add new template to
         */
        private void addNewTemplate(JSONObject model) {
            // Build new template
<span class="nc" id="L1123">            int oldPosition = getArguments().getInt(&quot;position&quot;);</span>
<span class="nc" id="L1124">            JSONArray templates = model.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc" id="L1125">            JSONObject oldTemplate = templates.getJSONObject(oldPosition);</span>
<span class="nc" id="L1126">            JSONObject newTemplate = Models.newTemplate(newCardName(templates));</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6559)) {</span>
                // Set up question &amp; answer formats
<span class="nc" id="L1129">                newTemplate.put(&quot;qfmt&quot;, oldTemplate.getString(&quot;qfmt&quot;));</span>
            }
<span class="nc bnc" id="L1131" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6560)) {</span>
<span class="nc" id="L1132">                newTemplate.put(&quot;afmt&quot;, oldTemplate.getString(&quot;afmt&quot;));</span>
            }
<span class="nc bnc" id="L1134" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6562)) {</span>
                // Reverse the front and back if only one template
<span class="nc bnc" id="L1136" title="All 2 branches missed.">                if (templates.length() == 1) {</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6561)) {</span>
<span class="nc" id="L1138">                        flipQA(newTemplate);</span>
                    }
                }
            }
<span class="nc bnc" id="L1142" title="All 8 branches missed.">            int lastExistingOrd = templates.getJSONObject((ListenerUtil.mutListener.listen(6566) ? (templates.length() % 1) : (ListenerUtil.mutListener.listen(6565) ? (templates.length() / 1) : (ListenerUtil.mutListener.listen(6564) ? (templates.length() * 1) : (ListenerUtil.mutListener.listen(6563) ? (templates.length() + 1) : (templates.length() - 1)))))).getInt(&quot;ord&quot;);</span>
<span class="nc bnc" id="L1143" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6567)) {</span>
<span class="nc" id="L1144">                Timber.d(&quot;addNewTemplate() lastExistingOrd was %s&quot;, lastExistingOrd);</span>
            }
<span class="nc bnc" id="L1146" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6572)) {</span>
<span class="nc bnc" id="L1147" title="All 8 branches missed.">                newTemplate.put(&quot;ord&quot;, (ListenerUtil.mutListener.listen(6571) ? (lastExistingOrd % 1) : (ListenerUtil.mutListener.listen(6570) ? (lastExistingOrd / 1) : (ListenerUtil.mutListener.listen(6569) ? (lastExistingOrd * 1) : (ListenerUtil.mutListener.listen(6568) ? (lastExistingOrd - 1) : (lastExistingOrd + 1))))));</span>
            }
<span class="nc bnc" id="L1149" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6573)) {</span>
<span class="nc" id="L1150">                templates.put(newTemplate);</span>
            }
<span class="nc bnc" id="L1152" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6574)) {</span>
<span class="nc" id="L1153">                mTemplateEditor.getTempModel().addNewTemplate(newTemplate);</span>
            }
<span class="nc bnc" id="L1155" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6575)) {</span>
<span class="nc" id="L1156">                mTemplateEditor.mViewPager.getAdapter().notifyDataSetChanged();</span>
            }
<span class="nc bnc" id="L1158" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6580)) {</span>
<span class="nc bnc" id="L1159" title="All 8 branches missed.">                mTemplateEditor.mViewPager.setCurrentItem((ListenerUtil.mutListener.listen(6579) ? (templates.length() % 1) : (ListenerUtil.mutListener.listen(6578) ? (templates.length() / 1) : (ListenerUtil.mutListener.listen(6577) ? (templates.length() * 1) : (ListenerUtil.mutListener.listen(6576) ? (templates.length() + 1) : (templates.length() - 1))))), mTemplateEditor.animationDisabled());</span>
            }
<span class="nc" id="L1161">        }</span>

        /**
         * Flip the question and answer side of the template
         * @param template template to flip
         */
        private void flipQA(JSONObject template) {
<span class="nc" id="L1168">            String qfmt = template.getString(&quot;qfmt&quot;);</span>
<span class="nc" id="L1169">            String afmt = template.getString(&quot;afmt&quot;);</span>
<span class="nc" id="L1170">            Matcher m = Pattern.compile(&quot;(?s)(.+)&lt;hr id=answer&gt;(.+)&quot;).matcher(afmt);</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6583)) {</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">                if (!m.find()) {</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6582)) {</span>
<span class="nc" id="L1174">                        template.put(&quot;qfmt&quot;, afmt.replace(&quot;{{FrontSide}}&quot;, &quot;&quot;));</span>
                    }
                } else {
<span class="nc bnc" id="L1177" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6581)) {</span>
<span class="nc" id="L1178">                        template.put(&quot;qfmt&quot;, m.group(2).trim());</span>
                    }
                }
            }
<span class="nc bnc" id="L1182" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(6584)) {</span>
<span class="nc" id="L1183">                template.put(&quot;afmt&quot;, &quot;{{FrontSide}}\n\n&lt;hr id=answer&gt;\n\n&quot; + qfmt);</span>
            }
<span class="nc" id="L1185">        }</span>

        /**
         * Get name for new template
         * @param templates array of templates which is being added to
         * @return name for new template
         */
        private String newCardName(JSONArray templates) {
            String name;
            // Start by trying to set the name to &quot;Card n&quot; where n is the new num of templates
<span class="nc" id="L1195">            int n = templates.length() + 1;</span>
            {
<span class="nc" id="L1197">                long _loopCounter117 = 0;</span>
                // If the starting point for name already exists, iteratively increase n until we find a unique name
                while (true) {
<span class="nc" id="L1200">                    ListenerUtil.loopListener.listen(&quot;_loopCounter117&quot;, ++_loopCounter117);</span>
                    // Get new name
<span class="nc" id="L1202">                    name = getResources().getString(R.string.card_n_name, n);</span>
                    // Cycle through all templates checking if new name exists
<span class="nc" id="L1204">                    boolean exists = false;</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6587)) {</span>
                        {
<span class="nc" id="L1207">                            long _loopCounter116 = 0;</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">                            for (JSONObject template : templates.jsonObjectIterable()) {</span>
<span class="nc" id="L1209">                                ListenerUtil.loopListener.listen(&quot;_loopCounter116&quot;, ++_loopCounter116);</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(6586)) {</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">                                    if (name.equals(template.getString(&quot;name&quot;))) {</span>
<span class="nc bnc" id="L1212" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(6585)) {</span>
<span class="nc" id="L1213">                                            exists = true;</span>
                                        }
                                        break;
                                    }
                                }
<span class="nc" id="L1218">                            }</span>
                        }
                    }
<span class="nc bnc" id="L1221" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6588)) {</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">                        if (!exists) {</span>
<span class="nc" id="L1223">                            break;</span>
                        }
                    }
<span class="nc bnc" id="L1226" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(6589)) {</span>
<span class="nc" id="L1227">                        n += 1;</span>
                    }
<span class="nc" id="L1229">                }</span>
            }
<span class="nc" id="L1231">            return name;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>