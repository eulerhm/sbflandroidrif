<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Info.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki</a> &gt; <span class="el_source">Info.java</span></div><h1>Info.java</h1><pre class="source lang-java linenums">/**
 * ************************************************************************************
 *  Copyright (c) 2009 Nicolas Raoul &lt;nicolas.raoul@gmail.com&gt;                           *
 *  Copyright (c) 2009 Edu Zamora &lt;edu.zasu@gmail.com&gt;                                   *
 *  Copyright (c) 2015 Tim Rae &lt;perceptualchaos2@gmail.com&gt;                              *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.anki;

import android.content.ClipData;
import android.content.Context;
import android.content.res.Resources;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.util.TypedValue;
import android.view.KeyEvent;
import android.view.View;
import android.webkit.WebChromeClient;
import android.webkit.WebView;
import android.widget.Button;
import com.ichi2.utils.IntentUtil;
import com.ichi2.utils.VersionUtils;
import org.acra.util.Installation;
import timber.log.Timber;
import static com.ichi2.anim.ActivityTransitionAnimation.Direction.LEFT;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L41">public class Info extends AnkiActivity {</span>

    public static final String TYPE_EXTRA = &quot;infoType&quot;;

    public static final int TYPE_ABOUT = 0;

    public static final int TYPE_NEW_VERSION = 2;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8529)) {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if (showedActivityFailedScreen(savedInstanceState)) {</span>
<span class="nc" id="L53">                return;</span>
            }
        }
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8530)) {</span>
<span class="nc" id="L57">            Timber.d(&quot;onCreate()&quot;);</span>
        }
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8531)) {</span>
<span class="nc" id="L60">            super.onCreate(savedInstanceState);</span>
        }
<span class="nc" id="L62">        Resources res = getResources();</span>
<span class="nc" id="L63">        int mType = getIntent().getIntExtra(TYPE_EXTRA, TYPE_ABOUT);</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8538)) {</span>
            // If the page crashes, we do not want to display it again (#7135 maybe)
<span class="nc bnc" id="L66" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(8536) ? (mType &gt;= TYPE_NEW_VERSION) : (ListenerUtil.mutListener.listen(8535) ? (mType &lt;= TYPE_NEW_VERSION) : (ListenerUtil.mutListener.listen(8534) ? (mType &gt; TYPE_NEW_VERSION) : (ListenerUtil.mutListener.listen(8533) ? (mType &lt; TYPE_NEW_VERSION) : (ListenerUtil.mutListener.listen(8532) ? (mType != TYPE_NEW_VERSION) : (mType == TYPE_NEW_VERSION))))))) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8537)) {</span>
<span class="nc" id="L68">                    AnkiDroidApp.getSharedPrefs(Info.this.getBaseContext()).edit().putString(&quot;lastVersion&quot;, VersionUtils.getPkgVersionName()).apply();</span>
                }
            }
        }
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8539)) {</span>
<span class="nc" id="L73">            setContentView(R.layout.info);</span>
        }
<span class="nc" id="L75">        final View mainView = findViewById(android.R.id.content);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8540)) {</span>
<span class="nc" id="L77">            enableToolbar(mainView);</span>
        }
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8541)) {</span>
<span class="nc" id="L80">            findViewById(R.id.info_donate).setOnClickListener((v) -&gt; openUrl(Uri.parse(getString(R.string.link_opencollective_donate))));</span>
        }
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8542)) {</span>
<span class="nc" id="L83">            setTitle(String.format(&quot;%s v%s&quot;, VersionUtils.getAppName(), VersionUtils.getPkgVersionName()));</span>
        }
<span class="nc" id="L85">        WebView webView = findViewById(R.id.info);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8550)) {</span>
<span class="nc" id="L87">            webView.setWebChromeClient(new WebChromeClient() {</span>

                public void onProgressChanged(WebView view, int progress) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8549)) {</span>
                        // Hide the progress indicator when the page has finished loaded
<span class="nc bnc" id="L92" title="All 22 branches missed.">                        if ((ListenerUtil.mutListener.listen(8547) ? (progress &gt;= 100) : (ListenerUtil.mutListener.listen(8546) ? (progress &lt;= 100) : (ListenerUtil.mutListener.listen(8545) ? (progress &gt; 100) : (ListenerUtil.mutListener.listen(8544) ? (progress &lt; 100) : (ListenerUtil.mutListener.listen(8543) ? (progress != 100) : (progress == 100))))))) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(8548)) {</span>
<span class="nc" id="L94">                                mainView.findViewById(R.id.progress_bar).setVisibility(View.GONE);</span>
                            }
                        }
                    }
<span class="nc" id="L98">                }</span>
            });
        }
<span class="nc" id="L101">        Button marketButton = findViewById(R.id.left_button);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8554)) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (canOpenMarketUri()) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8552)) {</span>
<span class="nc" id="L105">                    marketButton.setText(R.string.info_rate);</span>
                }
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8553)) {</span>
<span class="nc" id="L108">                    marketButton.setOnClickListener(arg0 -&gt; IntentUtil.tryOpenIntent(this, AnkiDroidApp.getMarketIntent(this)));</span>
                }
            } else {
<span class="nc bnc" id="L111" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8551)) {</span>
<span class="nc" id="L112">                    marketButton.setVisibility(View.GONE);</span>
                }
            }
        }
<span class="nc" id="L116">        StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8573)) {</span>
<span class="nc bnc" id="L118" title="All 3 branches missed.">            switch(mType) {</span>
                case TYPE_ABOUT:
                    {
<span class="nc" id="L121">                        String[] content = res.getStringArray(R.array.about_content);</span>
                        // Apply theme colours.
<span class="nc" id="L123">                        TypedValue typedValue = new TypedValue();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8555)) {</span>
<span class="nc" id="L125">                            getTheme().resolveAttribute(android.R.attr.colorBackground, typedValue, true);</span>
                        }
<span class="nc bnc" id="L127" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8556)) {</span>
<span class="nc" id="L128">                            webView.setBackgroundColor(typedValue.data);</span>
                        }
<span class="nc bnc" id="L130" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8557)) {</span>
<span class="nc" id="L131">                            getTheme().resolveAttribute(android.R.attr.textColor, typedValue, true);</span>
                        }
                        // Color to hex string
<span class="nc" id="L134">                        String textColor = String.format(&quot;#%06X&quot;, (0xFFFFFF &amp; typedValue.data));</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8558)) {</span>
<span class="nc" id="L136">                            sb.append(&quot;&lt;html&gt;&lt;style&gt;body {color:&quot;).append(textColor).append(&quot;;}&lt;/style&gt;&quot;);</span>
                        }
<span class="nc bnc" id="L138" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8559)) {</span>
<span class="nc" id="L139">                            sb.append(&quot;&lt;body text=\&quot;#000000\&quot; link=\&quot;#E37068\&quot; alink=\&quot;#E37068\&quot; vlink=\&quot;#E37068\&quot;&gt;&quot;);</span>
                        }
<span class="nc bnc" id="L141" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8560)) {</span>
<span class="nc" id="L142">                            sb.append(String.format(content[0], res.getString(R.string.app_name), res.getString(R.string.link_anki))).append(&quot;&lt;br/&gt;&lt;br/&gt;&quot;);</span>
                        }
<span class="nc bnc" id="L144" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8561)) {</span>
<span class="nc" id="L145">                            sb.append(String.format(content[1], res.getString(R.string.link_issue_tracker), res.getString(R.string.link_wiki), res.getString(R.string.link_forum))).append(&quot;&lt;br/&gt;&lt;br/&gt;&quot;);</span>
                        }
<span class="nc bnc" id="L147" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8562)) {</span>
<span class="nc" id="L148">                            sb.append(String.format(content[2], res.getString(R.string.link_wikipedia_open_source), res.getString(R.string.link_contribution))).append(&quot; &quot;);</span>
                        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8563)) {</span>
<span class="nc" id="L151">                            sb.append(String.format(content[3], res.getString(R.string.link_translation), res.getString(R.string.link_donation))).append(&quot;&lt;br/&gt;&lt;br/&gt;&quot;);</span>
                        }
<span class="nc bnc" id="L153" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8564)) {</span>
<span class="nc" id="L154">                            sb.append(String.format(content[4], res.getString(R.string.licence_wiki), res.getString(R.string.link_source))).append(&quot;&lt;br/&gt;&lt;br/&gt;&quot;);</span>
                        }
<span class="nc bnc" id="L156" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8565)) {</span>
<span class="nc" id="L157">                            sb.append(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
                        }
<span class="nc bnc" id="L159" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8566)) {</span>
<span class="nc" id="L160">                            webView.loadDataWithBaseURL(&quot;&quot;, sb.toString(), &quot;text/html&quot;, &quot;utf-8&quot;, null);</span>
                        }
<span class="nc" id="L162">                        Button debugCopy = (findViewById(R.id.right_button));</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8567)) {</span>
<span class="nc" id="L164">                            debugCopy.setText(res.getString(R.string.feedback_copy_debug));</span>
                        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8568)) {</span>
<span class="nc" id="L167">                            debugCopy.setOnClickListener(v -&gt; copyDebugInfo());</span>
                        }
                        break;
                    }
                case TYPE_NEW_VERSION:
                    {
<span class="nc" id="L173">                        Button continueButton = (findViewById(R.id.right_button));</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8569)) {</span>
<span class="nc" id="L175">                            continueButton.setText(res.getString(R.string.dialog_continue));</span>
                        }
<span class="nc bnc" id="L177" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8570)) {</span>
<span class="nc" id="L178">                            continueButton.setOnClickListener((arg) -&gt; close());</span>
                        }
<span class="nc bnc" id="L180" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8571)) {</span>
<span class="nc" id="L181">                            webView.loadUrl(&quot;file:///android_asset/changelog.html&quot;);</span>
                        }
                        break;
                    }
                default:
<span class="nc bnc" id="L186" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8572)) {</span>
<span class="nc" id="L187">                        finishWithoutAnimation();</span>
                    }
                    break;
            }
        }
<span class="nc" id="L192">    }</span>

    private void close() {
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8574)) {</span>
<span class="nc" id="L196">            setResult(RESULT_OK);</span>
        }
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8575)) {</span>
<span class="nc" id="L199">            finishWithAnimation();</span>
        }
<span class="nc" id="L201">    }</span>

    private boolean canOpenMarketUri() {
        try {
<span class="nc" id="L205">            return IntentUtil.canOpenIntent(this, AnkiDroidApp.getMarketIntent(this));</span>
<span class="nc" id="L206">        } catch (Exception e) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8576)) {</span>
<span class="nc" id="L208">                Timber.w(e);</span>
            }
<span class="nc" id="L210">            return false;</span>
        }
    }

    @Override
    public boolean onKeyDown(int keyCode, KeyEvent event) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8581)) {</span>
<span class="nc bnc" id="L217" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(8577) ? (keyCode == KeyEvent.KEYCODE_BACK || event.getRepeatCount() == 0) : (keyCode == KeyEvent.KEYCODE_BACK &amp;&amp; event.getRepeatCount() == 0))) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8578)) {</span>
<span class="nc" id="L219">                    Timber.i(&quot;onBackPressed()&quot;);</span>
                }
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8579)) {</span>
<span class="nc" id="L222">                    setResult(RESULT_CANCELED);</span>
                }
<span class="nc bnc" id="L224" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8580)) {</span>
<span class="nc" id="L225">                    finishWithAnimation();</span>
                }
<span class="nc" id="L227">                return true;</span>
            }
        }
<span class="nc" id="L230">        return super.onKeyDown(keyCode, event);</span>
    }

    private void finishWithAnimation() {
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8582)) {</span>
<span class="nc" id="L235">            finishWithAnimation(LEFT);</span>
        }
<span class="nc" id="L237">    }</span>

    /**
     * Copy debug information about the device to the clipboard
     * @return debugInfo
     */
    public String copyDebugInfo() {
<span class="nc" id="L244">        String schedName = &quot;Not found&quot;;</span>
        try {
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8584)) {</span>
<span class="nc" id="L247">                schedName = getCol().getSched().getName();</span>
            }
<span class="nc" id="L249">        } catch (Throwable e) {</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8583)) {</span>
<span class="nc" id="L251">                Timber.e(e, &quot;Sched name not found&quot;);</span>
            }
<span class="nc" id="L253">        }</span>
<span class="nc" id="L254">        String debugInfo = &quot;AnkiDroid Version = &quot; + VersionUtils.getPkgVersionName() + &quot;\n\n&quot; + &quot;Android Version = &quot; + Build.VERSION.RELEASE + &quot;\n\n&quot; + &quot;ACRA UUID = &quot; + Installation.id(this) + &quot;\n\n&quot; + &quot;Scheduler = &quot; + schedName + &quot;\n\n&quot; + &quot;Crash Reports Enabled = &quot; + isSendingCrashReports() + &quot;\n&quot;;</span>
<span class="nc" id="L255">        android.content.ClipboardManager clipboardManager = (android.content.ClipboardManager) getSystemService(Context.CLIPBOARD_SERVICE);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8588)) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if (clipboardManager != null) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8586)) {</span>
<span class="nc" id="L259">                    clipboardManager.setPrimaryClip(ClipData.newPlainText(this.getTitle(), debugInfo));</span>
                }
<span class="nc bnc" id="L261" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8587)) {</span>
<span class="nc" id="L262">                    UIUtils.showThemedToast(this, getString(R.string.about_ankidroid_successfully_copied_debug), true);</span>
                }
            } else {
<span class="nc bnc" id="L265" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8585)) {</span>
<span class="nc" id="L266">                    UIUtils.showThemedToast(this, getString(R.string.about_ankidroid_error_copy_debug_info), false);</span>
                }
            }
        }
<span class="nc" id="L270">        return debugInfo;</span>
    }

    private boolean isSendingCrashReports() {
<span class="nc" id="L274">        return AnkiDroidApp.isAcraEnbled(this, false);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>