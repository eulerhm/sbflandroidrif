<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Card.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.libanki</a> &gt; <span class="el_source">Card.java</span></div><h1>Card.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2009 Daniel Sv√§rd &lt;daniel.svard@gmail.com&gt;                             *
 *  Copyright (c) 2011 Norbert Nagold &lt;norbert.nagold@gmail.com&gt;                         *
 *  Copyright (c) 2014 Houssam Salem &lt;houssam.salem.au@gmail.com&gt;                        *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.libanki;

import android.content.ContentValues;
import android.database.Cursor;
import android.text.TextUtils;
import com.ichi2.anki.CollectionHelper;
import com.ichi2.async.CancelListener;
import com.ichi2.libanki.template.TemplateError;
import com.ichi2.utils.Assert;
import com.ichi2.anki.AnkiDroidApp;
import com.ichi2.anki.R;
import com.ichi2.utils.LanguageUtil;
import com.ichi2.utils.JSONObject;
import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Set;
import java.util.concurrent.CancellationException;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.VisibleForTesting;
import timber.log.Timber;
import static com.ichi2.libanki.stats.Stats.SECONDS_PER_DAY;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * A Card is the ultimate entity subject to review; it encapsulates the scheduling parameters (from which to derive
 * the next interval), the note it is derived from (from which field data is retrieved), its own ownership (which deck it
 * currently belongs to), and the retrieval of presentation elements (filled-in templates).
 *
 * Card presentation has two components: the question (front) side and the answer (back) side. The presentation of the
 * card is derived from the template of the card's Card Type. The Card Type is a component of the Note Type (see Models)
 * that this card is derived from.
 *
 * This class is responsible for:
 * - Storing and retrieving database entries that map to Cards in the Collection
 * - Providing the HTML representation of the Card's question and answer
 * - Recording the results of review (answer chosen, time taken, etc)
 *
 * It does not:
 * - Generate new cards (see Collection)
 * - Store the templates or the style sheet (see Models)
 *
 * Type: 0=new, 1=learning, 2=due
 * Queue: same as above, and:
 *        -1=suspended, -2=user buried, -3=sched buried
 * Due is used differently for different queues.
 * - new queue: note id or random int
 * - rev queue: integer day
 * - lrn queue: integer timestamp
 */
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">@SuppressWarnings({ &quot;PMD.AvoidThrowingRawExceptionTypes&quot;, &quot;PMD.ExcessiveMethodLength&quot;, &quot;PMD.FieldDeclarationsShouldBeAtStartOfClass&quot;, &quot;PMD.MethodNamingConventions&quot; })</span>
public class Card implements Cloneable {

    public static final int TYPE_REV = 2;

    private Collection mCol;

    // When timer was started, in MS
    private long mTimerStarted;

    // Not in LibAnki. Record time spent reviewing in MS in order to restore when resuming.
    private long mElapsedTime;

    // BEGIN SQL table entries
    private long mId;

    private long mNid;

    private long mDid;

    private int mOrd;

    private long mMod;

    private int mUsn;

    @Consts.CARD_TYPE
    private int mType;

    @Consts.CARD_QUEUE
    private int mQueue;

    private long mDue;

    private int mIvl;

    private int mFactor;

    private int mReps;

    private int mLapses;

    private int mLeft;

    private long mODue;

    private long mODid;

    private int mFlags;

    private String mData;

    private HashMap&lt;String, String&gt; mQA;

    private Note mNote;

    // Used by Sched to determine which queue to move the card to after answering.
    private boolean mWasNew;

    // Used by Sched to record the original interval in the revlog after answering.
    private int mLastIvl;

    public Card(Collection col) {
<span class="fc" id="L138">        this(col, null);</span>
<span class="fc" id="L139">    }</span>

<span class="fc" id="L141">    public Card(Collection col, Long id) {</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20946)) {</span>
<span class="fc" id="L143">            mCol = col;</span>
        }
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20947)) {</span>
<span class="fc" id="L146">            mTimerStarted = 0L;</span>
        }
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20948)) {</span>
<span class="fc" id="L149">            mQA = null;</span>
        }
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20949)) {</span>
<span class="fc" id="L152">            mNote = null;</span>
        }
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20965)) {</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            if (id != null) {</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20963)) {</span>
<span class="fc" id="L157">                    mId = id;</span>
                }
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20964)) {</span>
<span class="fc" id="L160">                    load();</span>
                }
            } else {
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20950)) {</span>
                    // to flush, set nid, ord, and due
<span class="fc" id="L165">                    mId = mCol.getTime().timestampID(mCol.getDb(), &quot;cards&quot;);</span>
                }
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20951)) {</span>
<span class="fc" id="L168">                    mDid = 1;</span>
                }
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20952)) {</span>
<span class="fc" id="L171">                    mType = Consts.CARD_TYPE_NEW;</span>
                }
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20953)) {</span>
<span class="fc" id="L174">                    mQueue = Consts.QUEUE_TYPE_NEW;</span>
                }
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20954)) {</span>
<span class="fc" id="L177">                    mIvl = 0;</span>
                }
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20955)) {</span>
<span class="fc" id="L180">                    mFactor = 0;</span>
                }
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20956)) {</span>
<span class="fc" id="L183">                    mReps = 0;</span>
                }
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20957)) {</span>
<span class="fc" id="L186">                    mLapses = 0;</span>
                }
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20958)) {</span>
<span class="fc" id="L189">                    mLeft = 0;</span>
                }
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20959)) {</span>
<span class="fc" id="L192">                    mODue = 0;</span>
                }
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20960)) {</span>
<span class="fc" id="L195">                    mODid = 0;</span>
                }
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20961)) {</span>
<span class="fc" id="L198">                    mFlags = 0;</span>
                }
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20962)) {</span>
<span class="fc" id="L201">                    mData = &quot;&quot;;</span>
                }
            }
        }
<span class="fc" id="L205">    }</span>

    public void load() {
<span class="fc" id="L208">        try (Cursor cursor = mCol.getDb().query(&quot;SELECT * FROM cards WHERE id = ?&quot;, mId)) {</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20966)) {</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">                if (!cursor.moveToFirst()) {</span>
<span class="nc" id="L211">                    throw new WrongId(mId, &quot;card&quot;);</span>
                }
            }
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20967)) {</span>
<span class="fc" id="L215">                mId = cursor.getLong(0);</span>
            }
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20968)) {</span>
<span class="fc" id="L218">                mNid = cursor.getLong(1);</span>
            }
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20969)) {</span>
<span class="fc" id="L221">                mDid = cursor.getLong(2);</span>
            }
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20970)) {</span>
<span class="fc" id="L224">                mOrd = cursor.getInt(3);</span>
            }
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20971)) {</span>
<span class="fc" id="L227">                mMod = cursor.getLong(4);</span>
            }
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20972)) {</span>
<span class="fc" id="L230">                mUsn = cursor.getInt(5);</span>
            }
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20973)) {</span>
<span class="fc" id="L233">                mType = cursor.getInt(6);</span>
            }
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20974)) {</span>
<span class="fc" id="L236">                mQueue = cursor.getInt(7);</span>
            }
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20975)) {</span>
<span class="fc" id="L239">                mDue = cursor.getInt(8);</span>
            }
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20976)) {</span>
<span class="fc" id="L242">                mIvl = cursor.getInt(9);</span>
            }
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20977)) {</span>
<span class="fc" id="L245">                mFactor = cursor.getInt(10);</span>
            }
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20978)) {</span>
<span class="fc" id="L248">                mReps = cursor.getInt(11);</span>
            }
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20979)) {</span>
<span class="fc" id="L251">                mLapses = cursor.getInt(12);</span>
            }
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20980)) {</span>
<span class="fc" id="L254">                mLeft = cursor.getInt(13);</span>
            }
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20981)) {</span>
<span class="fc" id="L257">                mODue = cursor.getLong(14);</span>
            }
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20982)) {</span>
<span class="fc" id="L260">                mODid = cursor.getLong(15);</span>
            }
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20983)) {</span>
<span class="fc" id="L263">                mFlags = cursor.getInt(16);</span>
            }
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(20984)) {</span>
<span class="fc" id="L266">                mData = cursor.getString(17);</span>
            }
        }
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20985)) {</span>
<span class="fc" id="L270">            mQA = null;</span>
        }
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20986)) {</span>
<span class="fc" id="L273">            mNote = null;</span>
        }
<span class="fc" id="L275">    }</span>

    public void flush() {
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20987)) {</span>
<span class="fc" id="L279">            flush(true);</span>
        }
<span class="fc" id="L281">    }</span>

    public void flush(boolean changeModUsn) {
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20990)) {</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">            if (changeModUsn) {</span>
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20988)) {</span>
<span class="fc" id="L287">                    mMod = getCol().getTime().intTime();</span>
                }
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(20989)) {</span>
<span class="fc" id="L290">                    mUsn = mCol.usn();</span>
                }
            }
        }
        // }
<span class="pc bpc" id="L295" title="23 of 24 branches missed.">        assert ((ListenerUtil.mutListener.listen(20995) ? (mDue &gt;= Long.parseLong(&quot;4294967296&quot;)) : (ListenerUtil.mutListener.listen(20994) ? (mDue &lt;= Long.parseLong(&quot;4294967296&quot;)) : (ListenerUtil.mutListener.listen(20993) ? (mDue &gt; Long.parseLong(&quot;4294967296&quot;)) : (ListenerUtil.mutListener.listen(20992) ? (mDue != Long.parseLong(&quot;4294967296&quot;)) : (ListenerUtil.mutListener.listen(20991) ? (mDue == Long.parseLong(&quot;4294967296&quot;)) : (mDue &lt; Long.parseLong(&quot;4294967296&quot;))))))));</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20996)) {</span>
<span class="fc" id="L297">            mCol.getDb().execute(&quot;insert or replace into cards values &quot; + &quot;(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;, mId, mNid, mDid, mOrd, mMod, mUsn, mType, mQueue, mDue, mIvl, mFactor, mReps, mLapses, mLeft, mODue, mODid, mFlags, mData);</span>
        }
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20997)) {</span>
<span class="fc" id="L300">            mCol.log(this);</span>
        }
<span class="fc" id="L302">    }</span>

    public void flushSched() {
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20998)) {</span>
<span class="nc" id="L306">            mMod = getCol().getTime().intTime();</span>
        }
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(20999)) {</span>
<span class="nc" id="L309">            mUsn = mCol.usn();</span>
        }
        // }
<span class="nc bnc" id="L312" title="All 24 branches missed.">        assert ((ListenerUtil.mutListener.listen(21004) ? (mDue &gt;= Long.parseLong(&quot;4294967296&quot;)) : (ListenerUtil.mutListener.listen(21003) ? (mDue &lt;= Long.parseLong(&quot;4294967296&quot;)) : (ListenerUtil.mutListener.listen(21002) ? (mDue &gt; Long.parseLong(&quot;4294967296&quot;)) : (ListenerUtil.mutListener.listen(21001) ? (mDue != Long.parseLong(&quot;4294967296&quot;)) : (ListenerUtil.mutListener.listen(21000) ? (mDue == Long.parseLong(&quot;4294967296&quot;)) : (mDue &lt; Long.parseLong(&quot;4294967296&quot;))))))));</span>
<span class="nc" id="L313">        ContentValues values = new ContentValues();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21005)) {</span>
<span class="nc" id="L315">            values.put(&quot;mod&quot;, mMod);</span>
        }
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21006)) {</span>
<span class="nc" id="L318">            values.put(&quot;usn&quot;, mUsn);</span>
        }
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21007)) {</span>
<span class="nc" id="L321">            values.put(&quot;type&quot;, mType);</span>
        }
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21008)) {</span>
<span class="nc" id="L324">            values.put(&quot;queue&quot;, mQueue);</span>
        }
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21009)) {</span>
<span class="nc" id="L327">            values.put(&quot;due&quot;, mDue);</span>
        }
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21010)) {</span>
<span class="nc" id="L330">            values.put(&quot;ivl&quot;, mIvl);</span>
        }
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21011)) {</span>
<span class="nc" id="L333">            values.put(&quot;factor&quot;, mFactor);</span>
        }
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21012)) {</span>
<span class="nc" id="L336">            values.put(&quot;reps&quot;, mReps);</span>
        }
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21013)) {</span>
<span class="nc" id="L339">            values.put(&quot;lapses&quot;, mLapses);</span>
        }
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21014)) {</span>
<span class="nc" id="L342">            values.put(&quot;left&quot;, mLeft);</span>
        }
<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21015)) {</span>
<span class="nc" id="L345">            values.put(&quot;odue&quot;, mODue);</span>
        }
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21016)) {</span>
<span class="nc" id="L348">            values.put(&quot;odid&quot;, mODid);</span>
        }
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21017)) {</span>
<span class="nc" id="L351">            values.put(&quot;did&quot;, mDid);</span>
        }
<span class="nc bnc" id="L353" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21018)) {</span>
            // TODO: The update DB call sets mod=true. Verify if this is intended.
<span class="nc" id="L355">            mCol.getDb().update(&quot;cards&quot;, values, &quot;id = ?&quot;, new String[] { Long.toString(mId) });</span>
        }
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21019)) {</span>
<span class="nc" id="L358">            mCol.log(this);</span>
        }
<span class="nc" id="L360">    }</span>

    public String q() {
<span class="fc" id="L363">        return q(false);</span>
    }

    public String q(boolean reload) {
<span class="fc" id="L367">        return q(reload, false);</span>
    }

    public String q(boolean reload, boolean browser) {
<span class="fc" id="L371">        return css() + _getQA(reload, browser).get(&quot;q&quot;);</span>
    }

    public String a() {
<span class="fc" id="L375">        return css() + _getQA().get(&quot;a&quot;);</span>
    }

    public String css() {
<span class="fc" id="L379">        return String.format(Locale.US, &quot;&lt;style&gt;%s&lt;/style&gt;&quot;, model().getString(&quot;css&quot;));</span>
    }

    public HashMap&lt;String, String&gt; _getQA() {
<span class="fc" id="L383">        return _getQA(false);</span>
    }

    public HashMap&lt;String, String&gt; _getQA(boolean reload) {
<span class="fc" id="L387">        return _getQA(reload, false);</span>
    }

    public HashMap&lt;String, String&gt; _getQA(boolean reload, boolean browser) {
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21024)) {</span>
<span class="pc bpc" id="L392" title="6 of 10 branches missed.">            if ((ListenerUtil.mutListener.listen(21020) ? (mQA == null &amp;&amp; reload) : (mQA == null || reload))) {</span>
<span class="fc" id="L393">                Note f = note(reload);</span>
<span class="fc" id="L394">                Model m = model();</span>
<span class="fc" id="L395">                JSONObject t = template();</span>
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">                long did = isInDynamicDeck() ? mODid : mDid;</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21023)) {</span>
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">                    if (browser) {</span>
<span class="nc" id="L399">                        String bqfmt = t.getString(&quot;bqfmt&quot;);</span>
<span class="nc" id="L400">                        String bafmt = t.getString(&quot;bafmt&quot;);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21022)) {</span>
<span class="nc" id="L402">                            mQA = mCol._renderQA(mId, m, did, mOrd, f.stringTags(), f.getFields(), mFlags, browser, bqfmt, bafmt);</span>
                        }
<span class="nc" id="L404">                    } else {</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21021)) {</span>
<span class="fc" id="L406">                            mQA = mCol._renderQA(mId, m, did, mOrd, f.stringTags(), f.getFields(), mFlags);</span>
                        }
                    }
                }
            }
        }
<span class="fc" id="L412">        return mQA;</span>
    }

    public Note note() {
<span class="fc" id="L416">        return note(false);</span>
    }

    public Note note(boolean reload) {
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21027)) {</span>
<span class="pc bpc" id="L421" title="6 of 10 branches missed.">            if ((ListenerUtil.mutListener.listen(21025) ? (mNote == null &amp;&amp; reload) : (mNote == null || reload))) {</span>
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21026)) {</span>
<span class="fc" id="L423">                    mNote = mCol.getNote(mNid);</span>
                }
            }
        }
<span class="fc" id="L427">        return mNote;</span>
    }

    // not in upstream
    public Model model() {
<span class="fc" id="L432">        return note().model();</span>
    }

    public JSONObject template() {
<span class="fc" id="L436">        Model m = model();</span>
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">        if (m.isStd()) {</span>
<span class="fc" id="L438">            return m.getJSONArray(&quot;tmpls&quot;).getJSONObject(mOrd);</span>
        } else {
<span class="nc" id="L440">            return model().getJSONArray(&quot;tmpls&quot;).getJSONObject(0);</span>
        }
    }

    public void startTimer() {
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21028)) {</span>
<span class="fc" id="L446">            mTimerStarted = getCol().getTime().intTimeMS();</span>
        }
<span class="fc" id="L448">    }</span>

    /**
     * Time limit for answering in milliseconds.
     */
    public int timeLimit() {
<span class="nc bnc" id="L454" title="All 2 branches missed.">        DeckConfig conf = mCol.getDecks().confForDid(!isInDynamicDeck() ? mDid : mODid);</span>
<span class="nc bnc" id="L455" title="All 8 branches missed.">        return (ListenerUtil.mutListener.listen(21032) ? (conf.getInt(&quot;maxTaken&quot;) % 1000) : (ListenerUtil.mutListener.listen(21031) ? (conf.getInt(&quot;maxTaken&quot;) / 1000) : (ListenerUtil.mutListener.listen(21030) ? (conf.getInt(&quot;maxTaken&quot;) - 1000) : (ListenerUtil.mutListener.listen(21029) ? (conf.getInt(&quot;maxTaken&quot;) + 1000) : (conf.getInt(&quot;maxTaken&quot;) * 1000)))));</span>
    }

    /*
     * Time taken to answer card, in integer MS.
     */
    public int timeTaken() {
        // Indeed an int. Difference between two big numbers is still small.
<span class="nc bnc" id="L463" title="All 8 branches missed.">        int total = (int) ((ListenerUtil.mutListener.listen(21036) ? (getCol().getTime().intTimeMS() % mTimerStarted) : (ListenerUtil.mutListener.listen(21035) ? (getCol().getTime().intTimeMS() / mTimerStarted) : (ListenerUtil.mutListener.listen(21034) ? (getCol().getTime().intTimeMS() * mTimerStarted) : (ListenerUtil.mutListener.listen(21033) ? (getCol().getTime().intTimeMS() + mTimerStarted) : (getCol().getTime().intTimeMS() - mTimerStarted))))));</span>
<span class="nc" id="L464">        return Math.min(total, timeLimit());</span>
    }

    public boolean isEmpty() {
        try {
<span class="nc" id="L469">            return Models.emptyCard(model(), mOrd, note().getFields());</span>
<span class="nc" id="L470">        } catch (TemplateError er) {</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21037)) {</span>
<span class="nc" id="L472">                Timber.w(&quot;Card is empty because the card's template has an error: %s.&quot;, er.message(getCol().getContext()));</span>
            }
<span class="nc" id="L474">            return true;</span>
        }
    }

    public String qSimple() {
<span class="nc" id="L479">        return _getQA(false).get(&quot;q&quot;);</span>
    }

    /*
     * Returns the answer with anything before the &lt;hr id=answer&gt; tag removed
     */
    public String getPureAnswer() {
<span class="nc" id="L486">        String s = _getQA(false).get(&quot;a&quot;);</span>
<span class="nc" id="L487">        String target = &quot;&lt;hr id=answer&gt;&quot;;</span>
<span class="nc" id="L488">        int pos = s.indexOf(target);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21043)) {</span>
<span class="nc bnc" id="L490" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21042) ? (pos &gt;= -1) : (ListenerUtil.mutListener.listen(21041) ? (pos &lt;= -1) : (ListenerUtil.mutListener.listen(21040) ? (pos &gt; -1) : (ListenerUtil.mutListener.listen(21039) ? (pos &lt; -1) : (ListenerUtil.mutListener.listen(21038) ? (pos != -1) : (pos == -1))))))) {</span>
<span class="nc" id="L491">                return s;</span>
            }
        }
<span class="nc bnc" id="L494" title="All 8 branches missed.">        return s.substring((ListenerUtil.mutListener.listen(21047) ? (pos % target.length()) : (ListenerUtil.mutListener.listen(21046) ? (pos / target.length()) : (ListenerUtil.mutListener.listen(21045) ? (pos * target.length()) : (ListenerUtil.mutListener.listen(21044) ? (pos - target.length()) : (pos + target.length())))))).trim();</span>
    }

    /**
     * Save the currently elapsed reviewing time so it can be restored on resume.
     *
     * Use this method whenever a review session (activity) has been paused. Use the resumeTimer()
     * method when the session resumes to start counting review time again.
     */
    public void stopTimer() {
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21052)) {</span>
<span class="nc bnc" id="L505" title="All 8 branches missed.">            mElapsedTime = (ListenerUtil.mutListener.listen(21051) ? (getCol().getTime().intTimeMS() % mTimerStarted) : (ListenerUtil.mutListener.listen(21050) ? (getCol().getTime().intTimeMS() / mTimerStarted) : (ListenerUtil.mutListener.listen(21049) ? (getCol().getTime().intTimeMS() * mTimerStarted) : (ListenerUtil.mutListener.listen(21048) ? (getCol().getTime().intTimeMS() + mTimerStarted) : (getCol().getTime().intTimeMS() - mTimerStarted)))));</span>
        }
<span class="nc" id="L507">    }</span>

    /**
     * Resume the timer that counts the time spent reviewing this card.
     *
     * Unlike the desktop client, AnkiDroid must pause and resume the process in the middle of
     * reviewing. This method is required to keep track of the actual amount of time spent in
     * the reviewer and *must* be called on resume before any calls to timeTaken() take place
     * or the result of timeTaken() will be wrong.
     */
    public void resumeTimer() {
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21057)) {</span>
<span class="nc bnc" id="L519" title="All 8 branches missed.">            mTimerStarted = (ListenerUtil.mutListener.listen(21056) ? (getCol().getTime().intTimeMS() % mElapsedTime) : (ListenerUtil.mutListener.listen(21055) ? (getCol().getTime().intTimeMS() / mElapsedTime) : (ListenerUtil.mutListener.listen(21054) ? (getCol().getTime().intTimeMS() * mElapsedTime) : (ListenerUtil.mutListener.listen(21053) ? (getCol().getTime().intTimeMS() + mElapsedTime) : (getCol().getTime().intTimeMS() - mElapsedTime)))));</span>
        }
<span class="nc" id="L521">    }</span>

    /**
     * @param timeStarted Time in MS when timer was started
     */
    public void setTimerStarted(long timeStarted) {
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21058)) {</span>
<span class="nc" id="L528">            mTimerStarted = timeStarted;</span>
        }
<span class="nc" id="L530">    }</span>

    public long getId() {
<span class="fc" id="L533">        return mId;</span>
    }

    @VisibleForTesting
    public void setId(long id) {
<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21059)) {</span>
<span class="nc" id="L539">            mId = id;</span>
        }
<span class="nc" id="L541">    }</span>

    public void setMod(long mod) {
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21060)) {</span>
<span class="nc" id="L545">            mMod = mod;</span>
        }
<span class="nc" id="L547">    }</span>

    public long getMod() {
<span class="nc" id="L550">        return mMod;</span>
    }

    public void setUsn(int usn) {
<span class="nc bnc" id="L554" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21061)) {</span>
<span class="nc" id="L555">            mUsn = usn;</span>
        }
<span class="nc" id="L557">    }</span>

    public long getNid() {
<span class="fc" id="L560">        return mNid;</span>
    }

    @Consts.CARD_TYPE
    public int getType() {
<span class="fc" id="L565">        return mType;</span>
    }

    public void setType(@Consts.CARD_TYPE int type) {
<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21062)) {</span>
<span class="nc" id="L570">            mType = type;</span>
        }
<span class="nc" id="L572">    }</span>

    public void setLeft(int left) {
<span class="pc bpc" id="L575" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21063)) {</span>
<span class="fc" id="L576">            mLeft = left;</span>
        }
<span class="fc" id="L578">    }</span>

    public int getLeft() {
<span class="fc" id="L581">        return mLeft;</span>
    }

    @Consts.CARD_QUEUE
    public int getQueue() {
<span class="fc" id="L586">        return mQueue;</span>
    }

    public void setQueue(@Consts.CARD_QUEUE int queue) {
<span class="nc bnc" id="L590" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21064)) {</span>
<span class="nc" id="L591">            mQueue = queue;</span>
        }
<span class="nc" id="L593">    }</span>

    public long getODue() {
<span class="nc" id="L596">        return mODue;</span>
    }

    public void setODid(long odid) {
<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21065)) {</span>
<span class="nc" id="L601">            mODid = odid;</span>
        }
<span class="nc" id="L603">    }</span>

    public long getODid() {
<span class="fc" id="L606">        return mODid;</span>
    }

    public void setODue(long odue) {
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21066)) {</span>
<span class="nc" id="L611">            mODue = odue;</span>
        }
<span class="nc" id="L613">    }</span>

    public long getDue() {
<span class="nc" id="L616">        return mDue;</span>
    }

    public void setDue(long due) {
<span class="pc bpc" id="L620" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21067)) {</span>
<span class="fc" id="L621">            mDue = due;</span>
        }
<span class="fc" id="L623">    }</span>

    public int getIvl() {
<span class="nc" id="L626">        return mIvl;</span>
    }

    public void setIvl(int ivl) {
<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21068)) {</span>
<span class="nc" id="L631">            mIvl = ivl;</span>
        }
<span class="nc" id="L633">    }</span>

    public int getFactor() {
<span class="nc" id="L636">        return mFactor;</span>
    }

    public void setFactor(int factor) {
<span class="nc bnc" id="L640" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21069)) {</span>
<span class="nc" id="L641">            mFactor = factor;</span>
        }
<span class="nc" id="L643">    }</span>

    public int getReps() {
<span class="nc" id="L646">        return mReps;</span>
    }

    @VisibleForTesting
    public int setReps(int reps) {
<span class="nc" id="L651">        return mReps = reps;</span>
    }

    public int incrReps() {
<span class="nc" id="L655">        return ++mReps;</span>
    }

    public int getLapses() {
<span class="nc" id="L659">        return mLapses;</span>
    }

    public void setLapses(int lapses) {
<span class="nc bnc" id="L663" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21070)) {</span>
<span class="nc" id="L664">            mLapses = lapses;</span>
        }
<span class="nc" id="L666">    }</span>

    public void setNid(long nid) {
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21071)) {</span>
<span class="fc" id="L670">            mNid = nid;</span>
        }
<span class="fc" id="L672">    }</span>

    public void setOrd(int ord) {
<span class="pc bpc" id="L675" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21072)) {</span>
<span class="fc" id="L676">            mOrd = ord;</span>
        }
<span class="fc" id="L678">    }</span>

    public int getOrd() {
<span class="fc" id="L681">        return mOrd;</span>
    }

    public void setDid(long did) {
<span class="pc bpc" id="L685" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21073)) {</span>
<span class="fc" id="L686">            mDid = did;</span>
        }
<span class="fc" id="L688">    }</span>

    public long getDid() {
<span class="fc" id="L691">        return mDid;</span>
    }

    public boolean getWasNew() {
<span class="nc" id="L695">        return mWasNew;</span>
    }

    public void setWasNew(boolean wasNew) {
<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21074)) {</span>
<span class="nc" id="L700">            mWasNew = wasNew;</span>
        }
<span class="nc" id="L702">    }</span>

    public int getLastIvl() {
<span class="nc" id="L705">        return mLastIvl;</span>
    }

    public void setLastIvl(int ivl) {
<span class="nc bnc" id="L709" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21075)) {</span>
<span class="nc" id="L710">            mLastIvl = ivl;</span>
        }
<span class="nc" id="L712">    }</span>

    // Needed for tests
    public Collection getCol() {
<span class="fc" id="L716">        return mCol;</span>
    }

    // Needed for tests
    public void setCol(Collection col) {
<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21076)) {</span>
<span class="nc" id="L722">            mCol = col;</span>
        }
<span class="nc" id="L724">    }</span>

    public boolean showTimer() {
<span class="nc bnc" id="L727" title="All 2 branches missed.">        DeckConfig options = mCol.getDecks().confForDid(!isInDynamicDeck() ? mDid : mODid);</span>
<span class="nc" id="L728">        return DeckConfig.parseTimerOpt(options, true);</span>
    }

    public Card clone() {
        try {
<span class="nc" id="L733">            return (Card) super.clone();</span>
<span class="nc" id="L734">        } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L735">            throw new RuntimeException(e);</span>
        }
    }

    // A list of class members to skip in the toString() representation
<span class="fc" id="L740">    public static final Set&lt;String&gt; SKIP_PRINT = new HashSet&lt;&gt;(Arrays.asList(&quot;SKIP_PRINT&quot;, &quot;$assertionsDisabled&quot;, &quot;TYPE_LRN&quot;, &quot;TYPE_NEW&quot;, &quot;TYPE_REV&quot;, &quot;mNote&quot;, &quot;mQA&quot;, &quot;mCol&quot;, &quot;mTimerStarted&quot;, &quot;mTimerStopped&quot;));</span>

    @NonNull
    public String toString() {
<span class="fc" id="L744">        Field[] declaredFields = this.getClass().getDeclaredFields();</span>
<span class="fc" id="L745">        List&lt;String&gt; members = new ArrayList&lt;&gt;(declaredFields.length);</span>
<span class="pc bpc" id="L746" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21080)) {</span>
            {
<span class="fc" id="L748">                long _loopCounter455 = 0;</span>
<span class="fc bfc" id="L749" title="All 2 branches covered.">                for (Field f : declaredFields) {</span>
<span class="fc" id="L750">                    ListenerUtil.loopListener.listen(&quot;_loopCounter455&quot;, ++_loopCounter455);</span>
                    try {
<span class="pc bpc" id="L752" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21078)) {</span>
                            // skip non-useful elements
<span class="fc bfc" id="L754" title="All 2 branches covered.">                            if (SKIP_PRINT.contains(f.getName())) {</span>
<span class="fc" id="L755">                                continue;</span>
                            }
                        }
<span class="pc bpc" id="L758" title="1 of 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21079)) {</span>
<span class="fc" id="L759">                            members.add(String.format(&quot;'%s': %s&quot;, f.getName(), f.get(this)));</span>
                        }
<span class="nc" id="L761">                    } catch (IllegalAccessException | IllegalArgumentException e) {</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(21077)) {</span>
<span class="nc" id="L763">                            members.add(String.format(&quot;'%s': %s&quot;, f.getName(), &quot;N/A&quot;));</span>
                        }
<span class="fc" id="L765">                    }</span>
                }
            }
        }
<span class="fc" id="L769">        return TextUtils.join(&quot;,  &quot;, members);</span>
    }

    @Override
    public boolean equals(Object obj) {
<span class="nc bnc" id="L774" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21086)) {</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">            if (obj instanceof Card) {</span>
<span class="nc bnc" id="L776" title="All 22 branches missed.">                return (ListenerUtil.mutListener.listen(21085) ? (this.getId() &gt;= ((Card) obj).getId()) : (ListenerUtil.mutListener.listen(21084) ? (this.getId() &lt;= ((Card) obj).getId()) : (ListenerUtil.mutListener.listen(21083) ? (this.getId() &gt; ((Card) obj).getId()) : (ListenerUtil.mutListener.listen(21082) ? (this.getId() &lt; ((Card) obj).getId()) : (ListenerUtil.mutListener.listen(21081) ? (this.getId() != ((Card) obj).getId()) : (this.getId() == ((Card) obj).getId()))))));</span>
            }
        }
<span class="nc" id="L779">        return super.equals(obj);</span>
    }

    @Override
    public int hashCode() {
        // Map a long to an int. For API&gt;=24 you would just do `Long.hashCode(this.getId())`
<span class="nc" id="L785">        return (int) (this.getId() ^ (this.getId() &gt;&gt;&gt; 32));</span>
    }

    public static int intToFlag(int flags) {
        // equivalent to `mFlags % 8`. Used this way to copy Anki.
<span class="nc" id="L790">        return flags &amp; 0b111;</span>
    }

    public int userFlag() {
<span class="nc" id="L794">        return Card.intToFlag(mFlags);</span>
    }

    public static int setFlagInInt(int mFlags, int flag) {
<span class="nc bnc" id="L798" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21092)) {</span>
<span class="nc bnc" id="L799" title="All 22 branches missed.">            Assert.that((ListenerUtil.mutListener.listen(21091) ? (0 &gt;= flag) : (ListenerUtil.mutListener.listen(21090) ? (0 &gt; flag) : (ListenerUtil.mutListener.listen(21089) ? (0 &lt; flag) : (ListenerUtil.mutListener.listen(21088) ? (0 != flag) : (ListenerUtil.mutListener.listen(21087) ? (0 == flag) : (0 &lt;= flag)))))), &quot;flag to set is negative&quot;);</span>
        }
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21098)) {</span>
<span class="nc bnc" id="L802" title="All 22 branches missed.">            Assert.that((ListenerUtil.mutListener.listen(21097) ? (flag &gt;= 7) : (ListenerUtil.mutListener.listen(21096) ? (flag &gt; 7) : (ListenerUtil.mutListener.listen(21095) ? (flag &lt; 7) : (ListenerUtil.mutListener.listen(21094) ? (flag != 7) : (ListenerUtil.mutListener.listen(21093) ? (flag == 7) : (flag &lt;= 7)))))), &quot;flag to set is greater than 7.&quot;);</span>
        }
        // Setting the 3 firsts bits to 0, keeping the remaining.
<span class="nc" id="L805">        int extraData = (mFlags &amp; ~0b111);</span>
        // flag in 3 fist bits, same data as in mFlags everywhere else
<span class="nc" id="L807">        return extraData | flag;</span>
    }

    @VisibleForTesting
    public void setFlag(int flag) {
<span class="nc bnc" id="L812" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21099)) {</span>
<span class="nc" id="L813">            mFlags = flag;</span>
        }
<span class="nc" id="L815">    }</span>

    public void setUserFlag(int flag) {
<span class="nc bnc" id="L818" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21100)) {</span>
<span class="nc" id="L819">            mFlags = setFlagInInt(mFlags, flag);</span>
        }
<span class="nc" id="L821">    }</span>

    // not in Anki.
    public String getDueString() {
<span class="nc" id="L825">        String t = nextDue();</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21107)) {</span>
<span class="nc bnc" id="L827" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(21105) ? (getQueue() &gt;= 0) : (ListenerUtil.mutListener.listen(21104) ? (getQueue() &lt;= 0) : (ListenerUtil.mutListener.listen(21103) ? (getQueue() &gt; 0) : (ListenerUtil.mutListener.listen(21102) ? (getQueue() != 0) : (ListenerUtil.mutListener.listen(21101) ? (getQueue() == 0) : (getQueue() &lt; 0))))))) {</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(21106)) {</span>
<span class="nc" id="L829">                    t = &quot;(&quot; + t + &quot;)&quot;;</span>
                }
            }
        }
<span class="nc" id="L833">        return t;</span>
    }

    // as in Anki aqt/browser.py
    private String nextDue() {
        long date;
<span class="nc" id="L839">        long due = getDue();</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (isInDynamicDeck()) {</span>
<span class="nc" id="L841">            return AnkiDroidApp.getAppResources().getString(R.string.card_browser_due_filtered_card);</span>
<span class="nc bnc" id="L842" title="All 22 branches missed.">        } else if ((ListenerUtil.mutListener.listen(21112) ? (getQueue() &gt;= Consts.QUEUE_TYPE_LRN) : (ListenerUtil.mutListener.listen(21111) ? (getQueue() &lt;= Consts.QUEUE_TYPE_LRN) : (ListenerUtil.mutListener.listen(21110) ? (getQueue() &gt; Consts.QUEUE_TYPE_LRN) : (ListenerUtil.mutListener.listen(21109) ? (getQueue() &lt; Consts.QUEUE_TYPE_LRN) : (ListenerUtil.mutListener.listen(21108) ? (getQueue() != Consts.QUEUE_TYPE_LRN) : (getQueue() == Consts.QUEUE_TYPE_LRN))))))) {</span>
<span class="nc" id="L843">            date = due;</span>
<span class="nc bnc" id="L844" title="All 90 branches missed.">        } else if ((ListenerUtil.mutListener.listen(21123) ? ((ListenerUtil.mutListener.listen(21117) ? (getQueue() &gt;= Consts.QUEUE_TYPE_NEW) : (ListenerUtil.mutListener.listen(21116) ? (getQueue() &lt;= Consts.QUEUE_TYPE_NEW) : (ListenerUtil.mutListener.listen(21115) ? (getQueue() &gt; Consts.QUEUE_TYPE_NEW) : (ListenerUtil.mutListener.listen(21114) ? (getQueue() &lt; Consts.QUEUE_TYPE_NEW) : (ListenerUtil.mutListener.listen(21113) ? (getQueue() != Consts.QUEUE_TYPE_NEW) : (getQueue() == Consts.QUEUE_TYPE_NEW)))))) &amp;&amp; (ListenerUtil.mutListener.listen(21122) ? (getType() &gt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21121) ? (getType() &lt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21120) ? (getType() &gt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21119) ? (getType() &lt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21118) ? (getType() != Consts.CARD_TYPE_NEW) : (getType() == Consts.CARD_TYPE_NEW))))))) : ((ListenerUtil.mutListener.listen(21117) ? (getQueue() &gt;= Consts.QUEUE_TYPE_NEW) : (ListenerUtil.mutListener.listen(21116) ? (getQueue() &lt;= Consts.QUEUE_TYPE_NEW) : (ListenerUtil.mutListener.listen(21115) ? (getQueue() &gt; Consts.QUEUE_TYPE_NEW) : (ListenerUtil.mutListener.listen(21114) ? (getQueue() &lt; Consts.QUEUE_TYPE_NEW) : (ListenerUtil.mutListener.listen(21113) ? (getQueue() != Consts.QUEUE_TYPE_NEW) : (getQueue() == Consts.QUEUE_TYPE_NEW)))))) || (ListenerUtil.mutListener.listen(21122) ? (getType() &gt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21121) ? (getType() &lt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21120) ? (getType() &gt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21119) ? (getType() &lt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21118) ? (getType() != Consts.CARD_TYPE_NEW) : (getType() == Consts.CARD_TYPE_NEW))))))))) {</span>
<span class="nc" id="L845">            return (Long.valueOf(due)).toString();</span>
<span class="nc bnc" id="L846" title="All 362 branches missed.">        } else if ((ListenerUtil.mutListener.listen(21146) ? ((ListenerUtil.mutListener.listen(21134) ? ((ListenerUtil.mutListener.listen(21128) ? (getQueue() &gt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21127) ? (getQueue() &lt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21126) ? (getQueue() &gt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21125) ? (getQueue() &lt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21124) ? (getQueue() != Consts.QUEUE_TYPE_REV) : (getQueue() == Consts.QUEUE_TYPE_REV)))))) &amp;&amp; (ListenerUtil.mutListener.listen(21133) ? (getQueue() &gt;= Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21132) ? (getQueue() &lt;= Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21131) ? (getQueue() &gt; Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21130) ? (getQueue() &lt; Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21129) ? (getQueue() != Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (getQueue() == Consts.QUEUE_TYPE_DAY_LEARN_RELEARN))))))) : ((ListenerUtil.mutListener.listen(21128) ? (getQueue() &gt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21127) ? (getQueue() &lt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21126) ? (getQueue() &gt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21125) ? (getQueue() &lt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21124) ? (getQueue() != Consts.QUEUE_TYPE_REV) : (getQueue() == Consts.QUEUE_TYPE_REV)))))) || (ListenerUtil.mutListener.listen(21133) ? (getQueue() &gt;= Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21132) ? (getQueue() &lt;= Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21131) ? (getQueue() &gt; Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21130) ? (getQueue() &lt; Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21129) ? (getQueue() != Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (getQueue() == Consts.QUEUE_TYPE_DAY_LEARN_RELEARN)))))))) &amp;&amp; ((ListenerUtil.mutListener.listen(21145) ? ((ListenerUtil.mutListener.listen(21139) ? (getType() &gt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21138) ? (getType() &lt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21137) ? (getType() &gt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21136) ? (getType() &lt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21135) ? (getType() != Consts.CARD_TYPE_REV) : (getType() == Consts.CARD_TYPE_REV)))))) || (ListenerUtil.mutListener.listen(21144) ? (getQueue() &gt;= 0) : (ListenerUtil.mutListener.listen(21143) ? (getQueue() &lt;= 0) : (ListenerUtil.mutListener.listen(21142) ? (getQueue() &gt; 0) : (ListenerUtil.mutListener.listen(21141) ? (getQueue() != 0) : (ListenerUtil.mutListener.listen(21140) ? (getQueue() == 0) : (getQueue() &lt; 0))))))) : ((ListenerUtil.mutListener.listen(21139) ? (getType() &gt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21138) ? (getType() &lt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21137) ? (getType() &gt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21136) ? (getType() &lt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21135) ? (getType() != Consts.CARD_TYPE_REV) : (getType() == Consts.CARD_TYPE_REV)))))) &amp;&amp; (ListenerUtil.mutListener.listen(21144) ? (getQueue() &gt;= 0) : (ListenerUtil.mutListener.listen(21143) ? (getQueue() &lt;= 0) : (ListenerUtil.mutListener.listen(21142) ? (getQueue() &gt; 0) : (ListenerUtil.mutListener.listen(21141) ? (getQueue() != 0) : (ListenerUtil.mutListener.listen(21140) ? (getQueue() == 0) : (getQueue() &lt; 0)))))))))) : ((ListenerUtil.mutListener.listen(21134) ? ((ListenerUtil.mutListener.listen(21128) ? (getQueue() &gt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21127) ? (getQueue() &lt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21126) ? (getQueue() &gt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21125) ? (getQueue() &lt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21124) ? (getQueue() != Consts.QUEUE_TYPE_REV) : (getQueue() == Consts.QUEUE_TYPE_REV)))))) &amp;&amp; (ListenerUtil.mutListener.listen(21133) ? (getQueue() &gt;= Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21132) ? (getQueue() &lt;= Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21131) ? (getQueue() &gt; Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21130) ? (getQueue() &lt; Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21129) ? (getQueue() != Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (getQueue() == Consts.QUEUE_TYPE_DAY_LEARN_RELEARN))))))) : ((ListenerUtil.mutListener.listen(21128) ? (getQueue() &gt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21127) ? (getQueue() &lt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21126) ? (getQueue() &gt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21125) ? (getQueue() &lt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21124) ? (getQueue() != Consts.QUEUE_TYPE_REV) : (getQueue() == Consts.QUEUE_TYPE_REV)))))) || (ListenerUtil.mutListener.listen(21133) ? (getQueue() &gt;= Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21132) ? (getQueue() &lt;= Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21131) ? (getQueue() &gt; Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21130) ? (getQueue() &lt; Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (ListenerUtil.mutListener.listen(21129) ? (getQueue() != Consts.QUEUE_TYPE_DAY_LEARN_RELEARN) : (getQueue() == Consts.QUEUE_TYPE_DAY_LEARN_RELEARN)))))))) || ((ListenerUtil.mutListener.listen(21145) ? ((ListenerUtil.mutListener.listen(21139) ? (getType() &gt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21138) ? (getType() &lt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21137) ? (getType() &gt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21136) ? (getType() &lt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21135) ? (getType() != Consts.CARD_TYPE_REV) : (getType() == Consts.CARD_TYPE_REV)))))) || (ListenerUtil.mutListener.listen(21144) ? (getQueue() &gt;= 0) : (ListenerUtil.mutListener.listen(21143) ? (getQueue() &lt;= 0) : (ListenerUtil.mutListener.listen(21142) ? (getQueue() &gt; 0) : (ListenerUtil.mutListener.listen(21141) ? (getQueue() != 0) : (ListenerUtil.mutListener.listen(21140) ? (getQueue() == 0) : (getQueue() &lt; 0))))))) : ((ListenerUtil.mutListener.listen(21139) ? (getType() &gt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21138) ? (getType() &lt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21137) ? (getType() &gt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21136) ? (getType() &lt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21135) ? (getType() != Consts.CARD_TYPE_REV) : (getType() == Consts.CARD_TYPE_REV)))))) &amp;&amp; (ListenerUtil.mutListener.listen(21144) ? (getQueue() &gt;= 0) : (ListenerUtil.mutListener.listen(21143) ? (getQueue() &lt;= 0) : (ListenerUtil.mutListener.listen(21142) ? (getQueue() &gt; 0) : (ListenerUtil.mutListener.listen(21141) ? (getQueue() != 0) : (ListenerUtil.mutListener.listen(21140) ? (getQueue() == 0) : (getQueue() &lt; 0)))))))))))) {</span>
<span class="nc" id="L847">            long time = mCol.getTime().intTime();</span>
<span class="nc bnc" id="L848" title="All 8 branches missed.">            long nbDaySinceCreation = ((ListenerUtil.mutListener.listen(21150) ? (due % getCol().getSched().getToday()) : (ListenerUtil.mutListener.listen(21149) ? (due / getCol().getSched().getToday()) : (ListenerUtil.mutListener.listen(21148) ? (due * getCol().getSched().getToday()) : (ListenerUtil.mutListener.listen(21147) ? (due + getCol().getSched().getToday()) : (due - getCol().getSched().getToday()))))));</span>
<span class="nc bnc" id="L849" title="All 48 branches missed.">            date = (ListenerUtil.mutListener.listen(21158) ? (time % ((ListenerUtil.mutListener.listen(21154) ? (nbDaySinceCreation % SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21153) ? (nbDaySinceCreation / SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21152) ? (nbDaySinceCreation - SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21151) ? (nbDaySinceCreation + SECONDS_PER_DAY) : (nbDaySinceCreation * SECONDS_PER_DAY))))))) : (ListenerUtil.mutListener.listen(21157) ? (time / ((ListenerUtil.mutListener.listen(21154) ? (nbDaySinceCreation % SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21153) ? (nbDaySinceCreation / SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21152) ? (nbDaySinceCreation - SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21151) ? (nbDaySinceCreation + SECONDS_PER_DAY) : (nbDaySinceCreation * SECONDS_PER_DAY))))))) : (ListenerUtil.mutListener.listen(21156) ? (time * ((ListenerUtil.mutListener.listen(21154) ? (nbDaySinceCreation % SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21153) ? (nbDaySinceCreation / SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21152) ? (nbDaySinceCreation - SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21151) ? (nbDaySinceCreation + SECONDS_PER_DAY) : (nbDaySinceCreation * SECONDS_PER_DAY))))))) : (ListenerUtil.mutListener.listen(21155) ? (time - ((ListenerUtil.mutListener.listen(21154) ? (nbDaySinceCreation % SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21153) ? (nbDaySinceCreation / SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21152) ? (nbDaySinceCreation - SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21151) ? (nbDaySinceCreation + SECONDS_PER_DAY) : (nbDaySinceCreation * SECONDS_PER_DAY))))))) : (time + ((ListenerUtil.mutListener.listen(21154) ? (nbDaySinceCreation % SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21153) ? (nbDaySinceCreation / SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21152) ? (nbDaySinceCreation - SECONDS_PER_DAY) : (ListenerUtil.mutListener.listen(21151) ? (nbDaySinceCreation + SECONDS_PER_DAY) : (nbDaySinceCreation * SECONDS_PER_DAY)))))))))));</span>
<span class="nc" id="L850">        } else {</span>
<span class="nc" id="L851">            return &quot;&quot;;</span>
        }
<span class="nc" id="L853">        return LanguageUtil.getShortDateFormatFromS(date);</span>
    }

    /**
     * Non libAnki
     */
    public boolean isInDynamicDeck() {
        // In Anki Desktop, a card with oDue &lt;&gt; 0 &amp;&amp; oDid == 0 is not marked as dynamic.
<span class="pc bpc" id="L861" title="16 of 22 branches missed.">        return (ListenerUtil.mutListener.listen(21163) ? (this.getODid() &gt;= 0) : (ListenerUtil.mutListener.listen(21162) ? (this.getODid() &lt;= 0) : (ListenerUtil.mutListener.listen(21161) ? (this.getODid() &gt; 0) : (ListenerUtil.mutListener.listen(21160) ? (this.getODid() &lt; 0) : (ListenerUtil.mutListener.listen(21159) ? (this.getODid() == 0) : (this.getODid() != 0))))));</span>
    }

    public boolean isReview() {
<span class="nc bnc" id="L865" title="All 90 branches missed.">        return (ListenerUtil.mutListener.listen(21174) ? ((ListenerUtil.mutListener.listen(21168) ? (this.getType() &gt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21167) ? (this.getType() &lt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21166) ? (this.getType() &gt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21165) ? (this.getType() &lt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21164) ? (this.getType() != Consts.CARD_TYPE_REV) : (this.getType() == Consts.CARD_TYPE_REV)))))) || (ListenerUtil.mutListener.listen(21173) ? (this.getQueue() &gt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21172) ? (this.getQueue() &lt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21171) ? (this.getQueue() &gt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21170) ? (this.getQueue() &lt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21169) ? (this.getQueue() != Consts.QUEUE_TYPE_REV) : (this.getQueue() == Consts.QUEUE_TYPE_REV))))))) : ((ListenerUtil.mutListener.listen(21168) ? (this.getType() &gt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21167) ? (this.getType() &lt;= Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21166) ? (this.getType() &gt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21165) ? (this.getType() &lt; Consts.CARD_TYPE_REV) : (ListenerUtil.mutListener.listen(21164) ? (this.getType() != Consts.CARD_TYPE_REV) : (this.getType() == Consts.CARD_TYPE_REV)))))) &amp;&amp; (ListenerUtil.mutListener.listen(21173) ? (this.getQueue() &gt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21172) ? (this.getQueue() &lt;= Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21171) ? (this.getQueue() &gt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21170) ? (this.getQueue() &lt; Consts.QUEUE_TYPE_REV) : (ListenerUtil.mutListener.listen(21169) ? (this.getQueue() != Consts.QUEUE_TYPE_REV) : (this.getQueue() == Consts.QUEUE_TYPE_REV))))))));</span>
    }

    public boolean isNew() {
<span class="nc bnc" id="L869" title="All 22 branches missed.">        return (ListenerUtil.mutListener.listen(21179) ? (this.getType() &gt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21178) ? (this.getType() &lt;= Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21177) ? (this.getType() &gt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21176) ? (this.getType() &lt; Consts.CARD_TYPE_NEW) : (ListenerUtil.mutListener.listen(21175) ? (this.getType() != Consts.CARD_TYPE_NEW) : (this.getType() == Consts.CARD_TYPE_NEW))))));</span>
    }

    /**
     * A cache represents an intermediary step between a card id and a card object. Creating a Card has some fixed cost
     * in term of database access. Using an id has an unknown cost: none if the card is never accessed, heavy if the
     * card is accessed a lot of time. CardCache ensure that the cost is paid at most once, by waiting for first access
     * to load the data, and then saving them. Since CPU and RAM is usually less of a bottleneck than database access,
     * it may often be worth using this cache.
     *
     * Beware that the card is loaded only once. Change in the database are not reflected, so use it only if you can
     * safely assume that the card has not changed. That is
     * long id;
     * Card card = col.getCard(id);
     * ....
     * Card card2 = col.getCard(id);
     * is not equivalent to
     * long id;
     * Card.Cache cache = new Cache(col, id);
     * Card card = cache.getCard();
     * ....
     * Card card2 = cache.getCard();
     *
     * It is equivalent to:
     * long id;
     * Card.Cache cache = new Cache(col, id);
     * Card card = cache.getCard();
     * ....
     * cache.reload();
     * Card card2 = cache.getCard();
     */
    public static class Cache implements Cloneable {

        @NonNull
        private final Collection mCol;

        private final long mId;

        @Nullable
        private Card mCard;

<span class="fc" id="L910">        public Cache(@NonNull Collection col, long id) {</span>
<span class="fc" id="L911">            mCol = col;</span>
<span class="fc" id="L912">            mId = id;</span>
<span class="fc" id="L913">        }</span>

        /**
         * Copy of cache. Useful to create a copy of a subclass without loosing card if it is loaded.
         */
<span class="nc" id="L918">        protected Cache(Cache cache) {</span>
<span class="nc" id="L919">            mCol = cache.mCol;</span>
<span class="nc" id="L920">            mId = cache.mId;</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21180)) {</span>
<span class="nc" id="L922">                mCard = cache.mCard;</span>
            }
<span class="nc" id="L924">        }</span>

        /**
         * Copy of cache. Useful to create a copy of a subclass without loosing card if it is loaded.
         */
<span class="nc" id="L929">        public Cache(Card card) {</span>
<span class="nc" id="L930">            mCol = card.mCol;</span>
<span class="nc" id="L931">            mId = card.getId();</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21181)) {</span>
<span class="nc" id="L933">                mCard = card;</span>
            }
<span class="nc" id="L935">        }</span>

        /**
         * The card with id given at creation. Note that it has content of the time at which the card was loaded, which
         * may have changed in database. So it is not equivalent to getCol().getCard(getId()). If you need fresh data, reload
         * first.
         */
        @NonNull
        public synchronized Card getCard() {
<span class="pc bpc" id="L944" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21183)) {</span>
<span class="pc bpc" id="L945" title="1 of 2 branches missed.">                if (mCard == null) {</span>
<span class="pc bpc" id="L946" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21182)) {</span>
<span class="fc" id="L947">                        mCard = mCol.getCard(mId);</span>
                    }
                }
            }
<span class="fc" id="L951">            return mCard;</span>
        }

        /**
         * Next access to card will reload the card from the database.
         */
        public synchronized void reload() {
<span class="nc bnc" id="L958" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21184)) {</span>
<span class="nc" id="L959">                mCard = null;</span>
            }
<span class="nc" id="L961">        }</span>

        public long getId() {
<span class="nc" id="L964">            return mId;</span>
        }

        @NonNull
        public Collection getCol() {
<span class="nc" id="L969">            return mCol;</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L974">            return Long.valueOf(mId).hashCode();</span>
        }

        /**
         * The cloned version represents the same card but data are not loaded.
         */
        @NonNull
        public Cache clone() {
<span class="nc" id="L982">            return new Cache(mCol, mId);</span>
        }

        public boolean equals(Object cache) {
<span class="pc bpc" id="L986" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21185)) {</span>
<span class="pc bpc" id="L987" title="1 of 2 branches missed.">                if (!(cache instanceof Cache)) {</span>
<span class="nc" id="L988">                    return false;</span>
                }
            }
<span class="pc bpc" id="L991" title="16 of 22 branches missed.">            return (ListenerUtil.mutListener.listen(21190) ? (mId &gt;= ((Cache) cache).mId) : (ListenerUtil.mutListener.listen(21189) ? (mId &lt;= ((Cache) cache).mId) : (ListenerUtil.mutListener.listen(21188) ? (mId &gt; ((Cache) cache).mId) : (ListenerUtil.mutListener.listen(21187) ? (mId &lt; ((Cache) cache).mId) : (ListenerUtil.mutListener.listen(21186) ? (mId != ((Cache) cache).mId) : (mId == ((Cache) cache).mId))))));</span>
        }

        public void loadQA(boolean reload, boolean browser) {
<span class="nc bnc" id="L995" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(21191)) {</span>
<span class="nc" id="L996">                getCard()._getQA(reload, browser);</span>
            }
<span class="nc" id="L998">        }</span>
    }

    @NonNull
    public static Card[] deepCopyCardArray(@NonNull Card[] originals, @NonNull CancelListener cancelListener) throws CancellationException {
<span class="nc" id="L1003">        Collection col = CollectionHelper.getInstance().getCol(AnkiDroidApp.getInstance());</span>
<span class="nc" id="L1004">        Card[] copies = new Card[originals.length];</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(21200)) {</span>
            {
<span class="nc" id="L1007">                long _loopCounter456 = 0;</span>
<span class="nc bnc" id="L1008" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(21199) ? (i &gt;= originals.length) : (ListenerUtil.mutListener.listen(21198) ? (i &lt;= originals.length) : (ListenerUtil.mutListener.listen(21197) ? (i &gt; originals.length) : (ListenerUtil.mutListener.listen(21196) ? (i != originals.length) : (ListenerUtil.mutListener.listen(21195) ? (i == originals.length) : (i &lt; originals.length)))))); i++) {</span>
<span class="nc" id="L1009">                    ListenerUtil.loopListener.listen(&quot;_loopCounter456&quot;, ++_loopCounter456);</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21193)) {</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">                        if (cancelListener.isCancelled()) {</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(21192)) {</span>
<span class="nc" id="L1013">                                Timber.i(&quot;Cancelled during deep copy, probably memory pressure?&quot;);</span>
                            }
<span class="nc" id="L1015">                            throw new CancellationException(&quot;Cancelled during deep copy&quot;);</span>
                        }
                    }
<span class="nc bnc" id="L1018" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(21194)) {</span>
                        // the high performance version would implement .clone() on Card and test it well
<span class="nc" id="L1020">                        copies[i] = new Card(col, originals[i].getId());</span>
                    }
                }
            }
        }
<span class="nc" id="L1025">        return copies;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>