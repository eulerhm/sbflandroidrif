<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnkiDroidApp.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki</a> &gt; <span class="el_source">AnkiDroidApp.java</span></div><h1>AnkiDroidApp.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2009 Edu Zamora &lt;edu.zasu@gmail.com&gt;                                   *
 *  Copyright (c) 2009 Casey Link &lt;unnamedrambler@gmail.com&gt;                             *
 *  Copyright (c) 2014 Timothy Rae &lt;perceptualchaos2@gmail.com&gt;                          *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.anki;

import android.annotation.SuppressLint;
import android.app.Application;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.content.res.Configuration;
import android.content.res.Resources;
import android.net.Uri;
import android.os.Build;
import android.os.Environment;
import android.os.LocaleList;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.VisibleForTesting;
import androidx.localbroadcastmanager.content.LocalBroadcastManager;
import android.util.Log;
import android.view.ViewConfiguration;
import android.webkit.CookieManager;
import com.ichi2.anki.analytics.AnkiDroidCrashReportDialog;
import com.ichi2.anki.contextmenu.AnkiCardContextMenu;
import com.ichi2.anki.contextmenu.CardBrowserContextMenu;
import com.ichi2.anki.exception.ManuallyReportedException;
import com.ichi2.anki.exception.StorageAccessException;
import com.ichi2.anki.services.BootService;
import com.ichi2.anki.services.NotificationService;
import com.ichi2.compat.CompatHelper;
import com.ichi2.utils.AdaptionUtil;
import com.ichi2.utils.ExceptionUtil;
import com.ichi2.utils.LanguageUtil;
import com.ichi2.anki.analytics.UsageAnalytics;
import com.ichi2.utils.Permissions;
import com.ichi2.utils.WebViewDebugging;
import org.acra.ACRA;
import org.acra.ReportField;
import org.acra.annotation.AcraCore;
import org.acra.annotation.AcraDialog;
import org.acra.annotation.AcraHttpSender;
import org.acra.annotation.AcraLimiter;
import org.acra.annotation.AcraToast;
import org.acra.config.CoreConfigurationBuilder;
import org.acra.config.DialogConfigurationBuilder;
import org.acra.config.LimiterData;
import org.acra.config.ToastConfigurationBuilder;
import org.acra.sender.HttpSender;
import java.io.InputStream;
import java.util.Locale;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import timber.log.Timber;
import static timber.log.Timber.DebugTree;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Application class.
 */
// https://github.com/ACRA/acra/issues/810
@SuppressLint(&quot;NonConstantResourceId&quot;)
@AcraCore(buildConfigClass = org.acra.dialog.BuildConfig.class, excludeMatchingSharedPreferencesKeys = { &quot;username&quot;, &quot;hkey&quot; }, reportContent = { ReportField.REPORT_ID, ReportField.APP_VERSION_CODE, ReportField.APP_VERSION_NAME, ReportField.PACKAGE_NAME, ReportField.FILE_PATH, ReportField.PHONE_MODEL, ReportField.ANDROID_VERSION, ReportField.BUILD, ReportField.BRAND, ReportField.PRODUCT, ReportField.TOTAL_MEM_SIZE, ReportField.AVAILABLE_MEM_SIZE, ReportField.BUILD_CONFIG, ReportField.CUSTOM_DATA, ReportField.STACK_TRACE, ReportField.STACK_TRACE_HASH, // ReportField.INITIAL_CONFIGURATION,
ReportField.CRASH_CONFIGURATION, // ReportField.DISPLAY,
ReportField.USER_COMMENT, ReportField.USER_APP_START_DATE, ReportField.USER_CRASH_DATE, // ReportField.DROPBOX,
ReportField.LOGCAT, // ReportField.IS_SILENT,
ReportField.INSTALLATION_ID, // ReportField.DEVICE_FEATURES,
ReportField.ENVIRONMENT, // ReportField.SETTINGS_GLOBAL,
ReportField.SHARED_PREFERENCES, // ReportField.APPLICATION_LOG,
ReportField.MEDIA_CODEC_LIST, ReportField.THREAD_DETAILS }, logcatArguments = { &quot;-t&quot;, &quot;100&quot;, &quot;-v&quot;, &quot;time&quot;, &quot;ActivityManager:I&quot;, &quot;SQLiteLog:W&quot;, AnkiDroidApp.TAG + &quot;:D&quot;, &quot;*:S&quot; })
@AcraDialog(reportDialogClass = AnkiDroidCrashReportDialog.class, resCommentPrompt = R.string.empty_string, resTitle = R.string.feedback_title, resText = R.string.feedback_default_text, resPositiveButtonText = R.string.feedback_report, resIcon = R.drawable.logo_star_144dp)
@AcraHttpSender(httpMethod = HttpSender.Method.PUT, uri = BuildConfig.ACRA_URL)
@AcraToast(resText = R.string.feedback_auto_toast_text)
@AcraLimiter(exceptionClassLimit = 1000, stacktraceLimit = 1)
<span class="fc" id="L92">public class AnkiDroidApp extends Application {</span>

    public static final String XML_CUSTOM_NAMESPACE = &quot;http://arbitrary.app.namespace/com.ichi2.anki&quot;;

    // ACRA constants used for stored preferences
    public static final String FEEDBACK_REPORT_KEY = &quot;reportErrorMode&quot;;

    public static final String FEEDBACK_REPORT_ASK = &quot;2&quot;;

    public static final String FEEDBACK_REPORT_NEVER = &quot;1&quot;;

    public static final String FEEDBACK_REPORT_ALWAYS = &quot;0&quot;;

    // Tag for logging messages.
    public static final String TAG = &quot;AnkiDroid&quot;;

    // Singleton instance of this class.
    private static AnkiDroidApp sInstance;

    // Constants for gestures
<span class="fc" id="L112">    public static int sSwipeMinDistance = -1;</span>

<span class="fc" id="L114">    public static int sSwipeThresholdVelocity = -1;</span>

    private static int DEFAULT_SWIPE_MIN_DISTANCE;

    private static int DEFAULT_SWIPE_THRESHOLD_VELOCITY;

    /**
     * The latest package version number that included important changes to the database integrity check routine. All
     * collections being upgraded to (or after) this version must run an integrity check as it will contain fixes that
     * all collections should have.
     */
    public static final int CHECK_DB_AT_VERSION = 21000172;

    /**
     * The latest package version number that included changes to the preferences that requires handling. All
     * collections being upgraded to (or after) this version must update preferences.
     */
    public static final int CHECK_PREFERENCES_AT_VERSION = 20500225;

    /**
     * Our ACRA configurations, initialized during onCreate()
     */
    private CoreConfigurationBuilder acraCoreConfigBuilder;

    /**
     * An exception if the WebView subsystem fails to load
     */
    @Nullable
    private Throwable mWebViewError;

    @NonNull
    public static InputStream getResourceAsStream(@NonNull String name) {
<span class="nc" id="L146">        return sInstance.getApplicationContext().getClassLoader().getResourceAsStream(name);</span>
    }

    public static boolean isInitialized() {
<span class="nc bnc" id="L150" title="All 2 branches missed.">        return sInstance == null;</span>
    }

    @VisibleForTesting(otherwise = VisibleForTesting.NONE)
    public static void simulateRestoreFromBackup() {
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5731)) {</span>
<span class="nc" id="L156">            sInstance = null;</span>
        }
<span class="nc" id="L158">    }</span>

    public static boolean isAcraEnbled(Context context, boolean defaultValue) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5732)) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (!getSharedPrefs(context).contains(ACRA.PREF_DISABLE_ACRA)) {</span>
                // we shouldn't use defaultValue below, as it would be inverted which complicated understanding.
<span class="nc" id="L164">                return defaultValue;</span>
            }
        }
<span class="nc bnc" id="L167" title="All 2 branches missed.">        return !getSharedPrefs(context).getBoolean(ACRA.PREF_DISABLE_ACRA, true);</span>
    }

    /**
     * Get the ACRA ConfigurationBuilder - use this followed by setting it to modify the config
     * @return ConfigurationBuilder for the current ACRA config
     */
    public CoreConfigurationBuilder getAcraCoreConfigBuilder() {
<span class="fc" id="L175">        return acraCoreConfigBuilder;</span>
    }

    /**
     * Set the ACRA ConfigurationBuilder and &lt;b&gt;re-initialize the ACRA system&lt;/b&gt; with the contents
     * @param acraCoreConfigBuilder the full ACRA config to initialize ACRA with
     */
    private void setAcraConfigBuilder(CoreConfigurationBuilder acraCoreConfigBuilder) {
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5733)) {</span>
<span class="fc" id="L184">            this.acraCoreConfigBuilder = acraCoreConfigBuilder;</span>
        }
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5734)) {</span>
<span class="fc" id="L187">            ACRA.init(this, acraCoreConfigBuilder);</span>
        }
<span class="fc" id="L189">    }</span>

    @Override
    protected void attachBaseContext(Context base) {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5735)) {</span>
            // for API &lt; 17 we update the configuration directly
<span class="fc" id="L195">            super.attachBaseContext(updateContextWithLanguage(base));</span>
        }
<span class="fc" id="L197">    }</span>

    /**
     * On application creation.
     */
    @Override
    public void onCreate() {
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5736)) {</span>
<span class="fc" id="L205">            super.onCreate();</span>
        }
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5740)) {</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">            if (sInstance != null) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5737)) {</span>
<span class="nc" id="L210">                    Timber.i(&quot;onCreate() called multiple times&quot;);</span>
                }
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5739)) {</span>
                    // 5887 - fix crash.
<span class="nc bnc" id="L214" title="All 2 branches missed.">                    if (sInstance.getResources() == null) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5738)) {</span>
<span class="nc" id="L216">                            Timber.w(&quot;Skipping re-initialisation - no resources. Maybe uninstalling app?&quot;);</span>
                        }
<span class="nc" id="L218">                        return;</span>
                    }
                }
            }
        }
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5741)) {</span>
<span class="fc" id="L224">            sInstance = this;</span>
        }
        // Get preferences
<span class="fc" id="L227">        SharedPreferences preferences = getSharedPrefs(this);</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5742)) {</span>
            // Setup logging and crash reporting
<span class="fc" id="L230">            acraCoreConfigBuilder = new CoreConfigurationBuilder(this);</span>
        }
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5747)) {</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">            if (BuildConfig.DEBUG) {</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5745)) {</span>
                    // Enable verbose error logging and do method tracing to put the Class name as log tag
<span class="fc" id="L236">                    Timber.plant(new DebugTree());</span>
                }
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5746)) {</span>
<span class="fc" id="L239">                    setDebugACRAConfig(preferences);</span>
                }
            } else {
<span class="nc bnc" id="L242" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5743)) {</span>
<span class="nc" id="L243">                    Timber.plant(new ProductionCrashReportingTree());</span>
                }
<span class="nc bnc" id="L245" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5744)) {</span>
<span class="nc" id="L246">                    setProductionACRAConfig(preferences);</span>
                }
            }
        }
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5748)) {</span>
<span class="fc" id="L251">            Timber.tag(TAG);</span>
        }
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5749)) {</span>
<span class="fc" id="L254">            Timber.d(&quot;Startup - Application Start&quot;);</span>
        }
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5758)) {</span>
            // Analytics falls back to a sensible default if this is not set.
<span class="pc bpc" id="L258" title="48 of 50 branches missed.">            if ((ListenerUtil.mutListener.listen(5755) ? (ACRA.isACRASenderServiceProcess() || (ListenerUtil.mutListener.listen(5754) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(5753) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(5752) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(5751) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(5750) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.P) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P))))))) : (ACRA.isACRASenderServiceProcess() &amp;&amp; (ListenerUtil.mutListener.listen(5754) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(5753) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(5752) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(5751) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.P) : (ListenerUtil.mutListener.listen(5750) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.P) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P))))))))) {</span>
                try {
<span class="nc bnc" id="L260" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5757)) {</span>
<span class="nc" id="L261">                        WebViewDebugging.setDataDirectorySuffix(&quot;acra&quot;);</span>
                    }
<span class="nc" id="L263">                } catch (Exception e) {</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5756)) {</span>
<span class="nc" id="L265">                        Timber.w(e, &quot;Failed to set WebView data directory&quot;);</span>
                    }
<span class="nc" id="L267">                }</span>
            }
        }
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5759)) {</span>
            // analytics after ACRA, they both install UncaughtExceptionHandlers but Analytics chains while ACRA does not
<span class="fc" id="L272">            UsageAnalytics.initialize(this);</span>
        }
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5761)) {</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">            if (BuildConfig.DEBUG) {</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5760)) {</span>
<span class="fc" id="L277">                    UsageAnalytics.setDryRun(true);</span>
                }
            }
        }
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5763)) {</span>
            // Stop after analytics and logging are initialised.
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">            if (ACRA.isACRASenderServiceProcess()) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5762)) {</span>
<span class="nc" id="L285">                    Timber.d(&quot;Skipping AnkiDroidApp.onCreate from ACRA sender process&quot;);</span>
                }
<span class="nc" id="L287">                return;</span>
            }
        }
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5765)) {</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">            if (AdaptionUtil.isUserATestClient()) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5764)) {</span>
<span class="nc" id="L293">                    UIUtils.showThemedToast(this.getApplicationContext(), getString(R.string.user_is_a_robot), false);</span>
                }
            }
        }
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5766)) {</span>
<span class="fc" id="L298">            CardBrowserContextMenu.ensureConsistentStateWithSharedPreferences(this);</span>
        }
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5767)) {</span>
<span class="fc" id="L301">            AnkiCardContextMenu.ensureConsistentStateWithSharedPreferences(this);</span>
        }
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5768)) {</span>
<span class="fc" id="L304">            NotificationChannels.setup(getApplicationContext());</span>
        }
        // Configure WebView to allow file scheme pages to access cookies.
        try {
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5772)) {</span>
<span class="fc" id="L309">                CookieManager.setAcceptFileSchemeCookies(true);</span>
            }
<span class="nc" id="L311">        } catch (Throwable e) {</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5769)) {</span>
                // Error may be excessive, but I expect a UnsatisfiedLinkError to be possible here.
<span class="nc" id="L314">                this.mWebViewError = e;</span>
            }
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5770)) {</span>
<span class="nc" id="L317">                sendExceptionReport(e, &quot;setAcceptFileSchemeCookies&quot;);</span>
            }
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5771)) {</span>
<span class="nc" id="L320">                Timber.e(e, &quot;setAcceptFileSchemeCookies&quot;);</span>
            }
<span class="nc" id="L322">            return;</span>
<span class="fc" id="L323">        }</span>
        // Set good default values for swipe detection
<span class="fc" id="L325">        final ViewConfiguration vc = ViewConfiguration.get(this);</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5773)) {</span>
<span class="fc" id="L327">            DEFAULT_SWIPE_MIN_DISTANCE = vc.getScaledPagingTouchSlop();</span>
        }
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5774)) {</span>
<span class="fc" id="L330">            DEFAULT_SWIPE_THRESHOLD_VELOCITY = vc.getScaledMinimumFlingVelocity();</span>
        }
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5775)) {</span>
            // Forget the last deck that was used in the CardBrowser
<span class="fc" id="L334">            CardBrowser.clearLastDeckId();</span>
        }
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5781)) {</span>
            // Create the AnkiDroid directory if missing. Send exception report if inaccessible.
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">            if (Permissions.hasStorageAccessPermission(this)) {</span>
                try {
<span class="fc" id="L340">                    String dir = CollectionHelper.getCurrentAnkiDroidDirectory(this);</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5780)) {</span>
<span class="fc" id="L342">                        CollectionHelper.initializeAnkiDroidDirectory(dir);</span>
                    }
<span class="nc" id="L344">                } catch (StorageAccessException e) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5776)) {</span>
<span class="nc" id="L346">                        Timber.e(e, &quot;Could not initialize AnkiDroid directory&quot;);</span>
                    }
<span class="nc" id="L348">                    String defaultDir = CollectionHelper.getDefaultAnkiDroidDirectory();</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5779)) {</span>
<span class="nc bnc" id="L350" title="All 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(5777) ? (isSdCardMounted() || CollectionHelper.getCurrentAnkiDroidDirectory(this).equals(defaultDir)) : (isSdCardMounted() &amp;&amp; CollectionHelper.getCurrentAnkiDroidDirectory(this).equals(defaultDir)))) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(5778)) {</span>
                                // Don't send report if the user is using a custom directory as SD cards trip up here a lot
<span class="nc" id="L353">                                sendExceptionReport(e, &quot;AnkiDroidApp.onCreate&quot;);</span>
                            }
                        }
                    }
<span class="fc" id="L357">                }</span>
            }
        }
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5782)) {</span>
<span class="fc" id="L361">            Timber.i(&quot;AnkiDroidApp: Starting Services&quot;);</span>
        }
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5783)) {</span>
<span class="fc" id="L364">            new BootService().onReceive(this, new Intent(this, BootService.class));</span>
        }
        // Register BroadcastReceiver NotificationService
<span class="fc" id="L367">        NotificationService ns = new NotificationService();</span>
<span class="fc" id="L368">        LocalBroadcastManager lbm = LocalBroadcastManager.getInstance(this);</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5784)) {</span>
<span class="fc" id="L370">            lbm.registerReceiver(ns, new IntentFilter(NotificationService.INTENT_ACTION));</span>
        }
<span class="fc" id="L372">    }</span>

    /**
     * Convenience method for accessing Shared preferences
     *
     * @param context Context to get preferences for.
     * @return A SharedPreferences object for this instance of the app.
     */
    // TODO Tracked in https://github.com/ankidroid/Anki-Android/issues/5019
    @SuppressWarnings(&quot;deprecation&quot;)
    public static SharedPreferences getSharedPrefs(Context context) {
<span class="fc" id="L383">        return android.preference.PreferenceManager.getDefaultSharedPreferences(context);</span>
    }

    public static AnkiDroidApp getInstance() {
<span class="fc" id="L387">        return sInstance;</span>
    }

    public static String getCacheStorageDirectory() {
<span class="nc" id="L391">        return sInstance.getCacheDir().getAbsolutePath();</span>
    }

    public static Resources getAppResources() {
<span class="nc" id="L395">        return sInstance.getResources();</span>
    }

    public static boolean isSdCardMounted() {
<span class="nc" id="L399">        return Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState());</span>
    }

    /**
     * Used when we don't have an exception to throw, but we know something is wrong and want to diagnose it
     */
    public static void sendExceptionReport(@NonNull String message, String origin) {
<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5785)) {</span>
<span class="nc" id="L407">            sendExceptionReport(new ManuallyReportedException(message), origin, null);</span>
        }
<span class="nc" id="L409">    }</span>

    public static void sendExceptionReport(Throwable e, String origin) {
<span class="nc bnc" id="L412" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5786)) {</span>
<span class="nc" id="L413">            sendExceptionReport(e, origin, null);</span>
        }
<span class="nc" id="L415">    }</span>

    public static void sendExceptionReport(Throwable e, String origin, @Nullable String additionalInfo) {
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5787)) {</span>
<span class="nc" id="L419">            sendExceptionReport(e, origin, additionalInfo, false);</span>
        }
<span class="nc" id="L421">    }</span>

    public static void sendExceptionReport(Throwable e, String origin, @Nullable String additionalInfo, boolean onlyIfSilent) {
<span class="nc bnc" id="L424" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5788)) {</span>
<span class="nc" id="L425">            UsageAnalytics.sendAnalyticsException(e, false);</span>
        }
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5791)) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            if (onlyIfSilent) {</span>
<span class="nc" id="L429">                String reportMode = getSharedPrefs(getInstance().getApplicationContext()).getString(AnkiDroidApp.FEEDBACK_REPORT_KEY, FEEDBACK_REPORT_ASK);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5790)) {</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                    if (!FEEDBACK_REPORT_ALWAYS.equals(reportMode)) {</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5789)) {</span>
<span class="nc" id="L433">                            Timber.i(&quot;sendExceptionReport - onlyIfSilent true, but ACRA is not 'always accept'. Skipping report send.&quot;);</span>
                        }
<span class="nc" id="L435">                        return;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L440" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5792)) {</span>
<span class="nc" id="L441">            ACRA.getErrorReporter().putCustomData(&quot;origin&quot;, origin);</span>
        }
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5793)) {</span>
<span class="nc" id="L444">            ACRA.getErrorReporter().putCustomData(&quot;additionalInfo&quot;, additionalInfo);</span>
        }
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5794)) {</span>
<span class="nc" id="L447">            ACRA.getErrorReporter().handleException(e);</span>
        }
<span class="nc" id="L449">    }</span>

    /**
     * If you want to make sure that the next exception of any time is posted, you need to clear limiter data
     *
     * @param context the context leading to the directory with ACRA limiter data
     */
    public static void deleteACRALimiterData(Context context) {
        try {
<span class="nc bnc" id="L458" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5796)) {</span>
<span class="nc" id="L459">                new LimiterData().store(context);</span>
            }
<span class="nc" id="L461">        } catch (Exception e) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5795)) {</span>
<span class="nc" id="L463">                Timber.w(e, &quot;Unable to clear ACRA limiter data&quot;);</span>
            }
<span class="nc" id="L465">        }</span>
<span class="nc" id="L466">    }</span>

    /**
     *  Returns a Context with the correct, saved language, to be attached using attachBase().
     *  For old APIs directly sets language using deprecated functions
     *
     * @param remoteContext The base context offered by attachBase() to be passed to super.attachBase().
     *                      Can be modified here to set correct GUI language.
     */
    @SuppressWarnings(&quot;deprecation&quot;)
    @NonNull
    public static Context updateContextWithLanguage(@NonNull Context remoteContext) {
        try {
            SharedPreferences preferences;
            // and preferences need mBase directly (is provided by remoteContext during attachBaseContext())
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">            if (getInstance() != null) {</span>
<span class="nc" id="L482">                preferences = getSharedPrefs(getInstance().getBaseContext());</span>
            } else {
<span class="fc" id="L484">                preferences = getSharedPrefs(remoteContext);</span>
            }
<span class="fc" id="L486">            Configuration langConfig = getLanguageConfig(remoteContext.getResources().getConfiguration(), preferences);</span>
<span class="fc" id="L487">            return remoteContext.createConfigurationContext(langConfig);</span>
<span class="nc" id="L488">        } catch (Exception e) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5797)) {</span>
<span class="nc" id="L490">                Timber.e(e, &quot;failed to update context with new language&quot;);</span>
            }
<span class="nc bnc" id="L492" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5798)) {</span>
                // during AnkiDroidApp.attachBaseContext() ACRA is not initialized, so the exception report will not be sent
<span class="nc" id="L494">                sendExceptionReport(e, &quot;AnkiDroidApp.updateContextWithLanguage&quot;);</span>
            }
<span class="nc" id="L496">            return remoteContext;</span>
        }
    }

    /**
     *  Creates and returns a new configuration with the chosen GUI language that is saved in the preferences
     *
     * @param remoteConfig The configuration of the remote context to set the language for
     * @param prefs
     */
    @SuppressWarnings(&quot;deprecation&quot;)
    @NonNull
    private static Configuration getLanguageConfig(@NonNull Configuration remoteConfig, @NonNull SharedPreferences prefs) {
<span class="fc" id="L509">        Configuration newConfig = new Configuration(remoteConfig);</span>
<span class="fc" id="L510">        Locale newLocale = LanguageUtil.getLocale(prefs.getString(Preferences.LANGUAGE, &quot;&quot;), prefs);</span>
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5799)) {</span>
<span class="fc" id="L512">            Timber.d(&quot;AnkiDroidApp::getLanguageConfig - setting locale to %s&quot;, newLocale);</span>
        }
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5809)) {</span>
            // API level &gt;=24
<span class="pc bpc" id="L516" title="16 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(5804) ? (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(5803) ? (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(5802) ? (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(5801) ? (Build.VERSION.SDK_INT != Build.VERSION_CODES.N) : (ListenerUtil.mutListener.listen(5800) ? (Build.VERSION.SDK_INT == Build.VERSION_CODES.N) : (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N))))))) {</span>
                // Build list of locale strings, separated by commas: newLocale as first element
<span class="fc" id="L518">                String strLocaleList = newLocale.toLanguageTag();</span>
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5807)) {</span>
                    // LocaleList must not contain language tags twice, will crash otherwise!
<span class="pc bpc" id="L521" title="1 of 2 branches missed.">                    if (!strLocaleList.contains(Locale.getDefault().toLanguageTag())) {</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5806)) {</span>
<span class="nc" id="L523">                            strLocaleList = strLocaleList + &quot;,&quot; + Locale.getDefault().toLanguageTag();</span>
                        }
                    }
                }
<span class="fc" id="L527">                LocaleList newLocaleList = LocaleList.forLanguageTags(strLocaleList);</span>
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5808)) {</span>
                    // first element of setLocales() is automatically setLocal()
<span class="fc" id="L530">                    newConfig.setLocales(newLocaleList);</span>
                }
<span class="fc" id="L532">            } else {</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5805)) {</span>
                    // API level &gt;=17 but &lt;24
<span class="nc" id="L535">                    newConfig.setLocale(newLocale);</span>
                }
            }
        }
<span class="fc" id="L539">        return newConfig;</span>
    }

    public static boolean initiateGestures(SharedPreferences preferences) {
<span class="nc" id="L543">        boolean enabled = preferences.getBoolean(&quot;gestures&quot;, false);</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5840)) {</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">            if (enabled) {</span>
<span class="nc" id="L546">                int sensitivity = preferences.getInt(&quot;swipeSensitivity&quot;, 100);</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5839)) {</span>
<span class="nc bnc" id="L548" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(5814) ? (sensitivity &gt;= 100) : (ListenerUtil.mutListener.listen(5813) ? (sensitivity &lt;= 100) : (ListenerUtil.mutListener.listen(5812) ? (sensitivity &gt; 100) : (ListenerUtil.mutListener.listen(5811) ? (sensitivity &lt; 100) : (ListenerUtil.mutListener.listen(5810) ? (sensitivity == 100) : (sensitivity != 100))))))) {</span>
<span class="nc bnc" id="L549" title="All 8 branches missed.">                        float sens = (ListenerUtil.mutListener.listen(5820) ? (100.0f % sensitivity) : (ListenerUtil.mutListener.listen(5819) ? (100.0f * sensitivity) : (ListenerUtil.mutListener.listen(5818) ? (100.0f - sensitivity) : (ListenerUtil.mutListener.listen(5817) ? (100.0f + sensitivity) : (100.0f / sensitivity)))));</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5829)) {</span>
<span class="nc bnc" id="L551" title="All 48 branches missed.">                            sSwipeMinDistance = (int) ((ListenerUtil.mutListener.listen(5828) ? ((ListenerUtil.mutListener.listen(5824) ? (DEFAULT_SWIPE_MIN_DISTANCE % sens) : (ListenerUtil.mutListener.listen(5823) ? (DEFAULT_SWIPE_MIN_DISTANCE / sens) : (ListenerUtil.mutListener.listen(5822) ? (DEFAULT_SWIPE_MIN_DISTANCE - sens) : (ListenerUtil.mutListener.listen(5821) ? (DEFAULT_SWIPE_MIN_DISTANCE + sens) : (DEFAULT_SWIPE_MIN_DISTANCE * sens))))) % 0.5f) : (ListenerUtil.mutListener.listen(5827) ? ((ListenerUtil.mutListener.listen(5824) ? (DEFAULT_SWIPE_MIN_DISTANCE % sens) : (ListenerUtil.mutListener.listen(5823) ? (DEFAULT_SWIPE_MIN_DISTANCE / sens) : (ListenerUtil.mutListener.listen(5822) ? (DEFAULT_SWIPE_MIN_DISTANCE - sens) : (ListenerUtil.mutListener.listen(5821) ? (DEFAULT_SWIPE_MIN_DISTANCE + sens) : (DEFAULT_SWIPE_MIN_DISTANCE * sens))))) / 0.5f) : (ListenerUtil.mutListener.listen(5826) ? ((ListenerUtil.mutListener.listen(5824) ? (DEFAULT_SWIPE_MIN_DISTANCE % sens) : (ListenerUtil.mutListener.listen(5823) ? (DEFAULT_SWIPE_MIN_DISTANCE / sens) : (ListenerUtil.mutListener.listen(5822) ? (DEFAULT_SWIPE_MIN_DISTANCE - sens) : (ListenerUtil.mutListener.listen(5821) ? (DEFAULT_SWIPE_MIN_DISTANCE + sens) : (DEFAULT_SWIPE_MIN_DISTANCE * sens))))) * 0.5f) : (ListenerUtil.mutListener.listen(5825) ? ((ListenerUtil.mutListener.listen(5824) ? (DEFAULT_SWIPE_MIN_DISTANCE % sens) : (ListenerUtil.mutListener.listen(5823) ? (DEFAULT_SWIPE_MIN_DISTANCE / sens) : (ListenerUtil.mutListener.listen(5822) ? (DEFAULT_SWIPE_MIN_DISTANCE - sens) : (ListenerUtil.mutListener.listen(5821) ? (DEFAULT_SWIPE_MIN_DISTANCE + sens) : (DEFAULT_SWIPE_MIN_DISTANCE * sens))))) - 0.5f) : ((ListenerUtil.mutListener.listen(5824) ? (DEFAULT_SWIPE_MIN_DISTANCE % sens) : (ListenerUtil.mutListener.listen(5823) ? (DEFAULT_SWIPE_MIN_DISTANCE / sens) : (ListenerUtil.mutListener.listen(5822) ? (DEFAULT_SWIPE_MIN_DISTANCE - sens) : (ListenerUtil.mutListener.listen(5821) ? (DEFAULT_SWIPE_MIN_DISTANCE + sens) : (DEFAULT_SWIPE_MIN_DISTANCE * sens))))) + 0.5f))))));</span>
                        }
<span class="nc bnc" id="L553" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5838)) {</span>
<span class="nc bnc" id="L554" title="All 48 branches missed.">                            sSwipeThresholdVelocity = (int) ((ListenerUtil.mutListener.listen(5837) ? ((ListenerUtil.mutListener.listen(5833) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY % sens) : (ListenerUtil.mutListener.listen(5832) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY / sens) : (ListenerUtil.mutListener.listen(5831) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY - sens) : (ListenerUtil.mutListener.listen(5830) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY + sens) : (DEFAULT_SWIPE_THRESHOLD_VELOCITY * sens))))) % 0.5f) : (ListenerUtil.mutListener.listen(5836) ? ((ListenerUtil.mutListener.listen(5833) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY % sens) : (ListenerUtil.mutListener.listen(5832) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY / sens) : (ListenerUtil.mutListener.listen(5831) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY - sens) : (ListenerUtil.mutListener.listen(5830) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY + sens) : (DEFAULT_SWIPE_THRESHOLD_VELOCITY * sens))))) / 0.5f) : (ListenerUtil.mutListener.listen(5835) ? ((ListenerUtil.mutListener.listen(5833) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY % sens) : (ListenerUtil.mutListener.listen(5832) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY / sens) : (ListenerUtil.mutListener.listen(5831) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY - sens) : (ListenerUtil.mutListener.listen(5830) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY + sens) : (DEFAULT_SWIPE_THRESHOLD_VELOCITY * sens))))) * 0.5f) : (ListenerUtil.mutListener.listen(5834) ? ((ListenerUtil.mutListener.listen(5833) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY % sens) : (ListenerUtil.mutListener.listen(5832) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY / sens) : (ListenerUtil.mutListener.listen(5831) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY - sens) : (ListenerUtil.mutListener.listen(5830) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY + sens) : (DEFAULT_SWIPE_THRESHOLD_VELOCITY * sens))))) - 0.5f) : ((ListenerUtil.mutListener.listen(5833) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY % sens) : (ListenerUtil.mutListener.listen(5832) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY / sens) : (ListenerUtil.mutListener.listen(5831) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY - sens) : (ListenerUtil.mutListener.listen(5830) ? (DEFAULT_SWIPE_THRESHOLD_VELOCITY + sens) : (DEFAULT_SWIPE_THRESHOLD_VELOCITY * sens))))) + 0.5f))))));</span>
                        }
<span class="nc" id="L556">                    } else {</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5815)) {</span>
<span class="nc" id="L558">                            sSwipeMinDistance = DEFAULT_SWIPE_MIN_DISTANCE;</span>
                        }
<span class="nc bnc" id="L560" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5816)) {</span>
<span class="nc" id="L561">                            sSwipeThresholdVelocity = DEFAULT_SWIPE_THRESHOLD_VELOCITY;</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L567">        return enabled;</span>
    }

    /**
     * Turns ACRA reporting off completely and persists it to shared prefs
     * But expands logcat search in case developer manually re-enables it
     *
     * @param prefs SharedPreferences object the reporting state is persisted in
     */
    private void setDebugACRAConfig(SharedPreferences prefs) {
<span class="pc bpc" id="L577" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5841)) {</span>
            // Disable crash reporting
<span class="fc" id="L579">            setAcraReportingMode(FEEDBACK_REPORT_NEVER);</span>
        }
<span class="pc bpc" id="L581" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5842)) {</span>
<span class="fc" id="L582">            prefs.edit().putString(FEEDBACK_REPORT_KEY, FEEDBACK_REPORT_NEVER).apply();</span>
        }
        // Use a wider logcat filter in case crash reporting manually re-enabled
<span class="fc" id="L585">        String[] logcatArgs = { &quot;-t&quot;, &quot;300&quot;, &quot;-v&quot;, &quot;long&quot;, &quot;ACRA:S&quot; };</span>
<span class="pc bpc" id="L586" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5843)) {</span>
<span class="fc" id="L587">            setAcraConfigBuilder(getAcraCoreConfigBuilder().setLogcatArguments(logcatArgs));</span>
        }
<span class="fc" id="L589">    }</span>

    /**
     * Puts ACRA Reporting mode into user-specified mode, with default of &quot;ask first&quot;
     *
     * @param prefs SharedPreferences object the reporting state is persisted in
     */
    private void setProductionACRAConfig(SharedPreferences prefs) {
<span class="nc bnc" id="L597" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5844)) {</span>
            // Enable or disable crash reporting based on user setting
<span class="nc" id="L599">            setAcraReportingMode(prefs.getString(FEEDBACK_REPORT_KEY, FEEDBACK_REPORT_ASK));</span>
        }
<span class="nc" id="L601">    }</span>

    /**
     * Set the reporting mode for ACRA based on the value of the FEEDBACK_REPORT_KEY preference
     * @param value value of FEEDBACK_REPORT_KEY preference
     */
    public void setAcraReportingMode(String value) {
<span class="fc" id="L608">        SharedPreferences.Editor editor = getSharedPrefs(this).edit();</span>
<span class="pc bpc" id="L609" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5853)) {</span>
            // Set the ACRA disable value
<span class="pc bpc" id="L611" title="1 of 2 branches missed.">            if (value.equals(FEEDBACK_REPORT_NEVER)) {</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5852)) {</span>
<span class="fc" id="L613">                    editor.putBoolean(ACRA.PREF_DISABLE_ACRA, true);</span>
                }
            } else {
<span class="nc bnc" id="L616" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5845)) {</span>
<span class="nc" id="L617">                    editor.putBoolean(ACRA.PREF_DISABLE_ACRA, false);</span>
                }
                // Switch between auto-report via toast and manual report via dialog
<span class="nc" id="L620">                CoreConfigurationBuilder builder = getAcraCoreConfigBuilder();</span>
<span class="nc" id="L621">                DialogConfigurationBuilder dialogBuilder = builder.getPluginConfigurationBuilder(DialogConfigurationBuilder.class);</span>
<span class="nc" id="L622">                ToastConfigurationBuilder toastBuilder = builder.getPluginConfigurationBuilder(ToastConfigurationBuilder.class);</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5850)) {</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                    if (value.equals(FEEDBACK_REPORT_ALWAYS)) {</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5848)) {</span>
<span class="nc" id="L626">                            dialogBuilder.setEnabled(false);</span>
                        }
<span class="nc bnc" id="L628" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5849)) {</span>
<span class="nc" id="L629">                            toastBuilder.setResText(R.string.feedback_auto_toast_text);</span>
                        }
<span class="nc bnc" id="L631" title="All 2 branches missed.">                    } else if (value.equals(FEEDBACK_REPORT_ASK)) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5846)) {</span>
<span class="nc" id="L633">                            dialogBuilder.setEnabled(true);</span>
                        }
<span class="nc bnc" id="L635" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5847)) {</span>
<span class="nc" id="L636">                            toastBuilder.setResText(R.string.feedback_manual_toast_text);</span>
                        }
                    }
                }
<span class="nc bnc" id="L640" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5851)) {</span>
<span class="nc" id="L641">                    setAcraConfigBuilder(builder);</span>
                }
            }
        }
<span class="pc bpc" id="L645" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5854)) {</span>
<span class="fc" id="L646">            editor.apply();</span>
        }
<span class="fc" id="L648">    }</span>

    public static Intent getMarketIntent(Context context) {
<span class="nc bnc" id="L651" title="All 2 branches missed.">        final String uri = context.getString(CompatHelper.isKindle() ? R.string.link_market_kindle : R.string.link_market);</span>
<span class="nc" id="L652">        Uri parsed = Uri.parse(uri);</span>
<span class="nc" id="L653">        return new Intent(Intent.ACTION_VIEW, parsed);</span>
    }

    /**
     * Get the url for the feedback page
     * @return
     */
    public static String getFeedbackUrl() {
        // properly translated
<span class="nc bnc" id="L662" title="All 2 branches missed.">        if (isCurrentLanguage(&quot;ja&quot;)) {</span>
<span class="nc" id="L663">            return getAppResources().getString(R.string.link_help_ja);</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">        } else if (isCurrentLanguage(&quot;zh&quot;)) {</span>
<span class="nc" id="L665">            return getAppResources().getString(R.string.link_help_zh);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">        } else if (isCurrentLanguage(&quot;ar&quot;)) {</span>
<span class="nc" id="L667">            return getAppResources().getString(R.string.link_help_ar);</span>
        } else {
<span class="nc" id="L669">            return getAppResources().getString(R.string.link_help);</span>
        }
    }

    /**
     * Get the url for the manual
     * @return
     */
    public static String getManualUrl() {
        // properly translated
<span class="nc bnc" id="L679" title="All 2 branches missed.">        if (isCurrentLanguage(&quot;ja&quot;)) {</span>
<span class="nc" id="L680">            return getAppResources().getString(R.string.link_manual_ja);</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        } else if (isCurrentLanguage(&quot;zh&quot;)) {</span>
<span class="nc" id="L682">            return getAppResources().getString(R.string.link_manual_zh);</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">        } else if (isCurrentLanguage(&quot;ar&quot;)) {</span>
<span class="nc" id="L684">            return getAppResources().getString(R.string.link_manual_ar);</span>
        } else {
<span class="nc" id="L686">            return getAppResources().getString(R.string.link_manual);</span>
        }
    }

    /**
     * Check whether l is the currently set language code
     * @param l ISO2 language code
     * @return
     */
    private static boolean isCurrentLanguage(String l) {
<span class="nc" id="L696">        String pref = getSharedPrefs(sInstance).getString(Preferences.LANGUAGE, &quot;&quot;);</span>
<span class="nc bnc" id="L697" title="All 26 branches missed.">        return (ListenerUtil.mutListener.listen(5856) ? (pref.equals(l) &amp;&amp; (ListenerUtil.mutListener.listen(5855) ? (&quot;&quot;.equals(pref) || Locale.getDefault().getLanguage().equals(l)) : (&quot;&quot;.equals(pref) &amp;&amp; Locale.getDefault().getLanguage().equals(l)))) : (pref.equals(l) || (ListenerUtil.mutListener.listen(5855) ? (&quot;&quot;.equals(pref) || Locale.getDefault().getLanguage().equals(l)) : (&quot;&quot;.equals(pref) &amp;&amp; Locale.getDefault().getLanguage().equals(l)))));</span>
    }

    public static boolean webViewFailedToLoad() {
<span class="nc bnc" id="L701" title="All 2 branches missed.">        return getInstance().mWebViewError != null;</span>
    }

    @Nullable
    public static String getWebViewErrorMessage() {
<span class="nc" id="L706">        Throwable error = getInstance().mWebViewError;</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(5858)) {</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">            if (error == null) {</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(5857)) {</span>
<span class="nc" id="L710">                    Timber.w(&quot;getWebViewExceptionMessage called without webViewFailedToLoad check&quot;);</span>
                }
<span class="nc" id="L712">                return null;</span>
            }
        }
<span class="nc" id="L715">        return ExceptionUtil.getExceptionMessage(error);</span>
    }

    /**
     * A tree which logs necessary data for crash reporting.
     *
     * Requirements:
     * 1) ignore verbose and debug log levels
     * 2) use the fixed AnkiDroidApp.TAG log tag (ACRA filters logcat for it when reporting errors)
     * 3) dynamically discover the class name and prepend it to the message for warn and error
     */
    @SuppressLint(&quot;LogNotTimber&quot;)
<span class="nc" id="L727">    public static class ProductionCrashReportingTree extends Timber.Tree {</span>

        private static final int CALL_STACK_INDEX = 6;

<span class="nc" id="L731">        private static final Pattern ANONYMOUS_CLASS = Pattern.compile(&quot;(\\$\\d+)+$&quot;);</span>

        /**
         * Extract the tag which should be used for the message from the {@code element}. By default
         * this will use the class name without any anonymous class suffixes (e.g., {@code Foo$1}
         * becomes {@code Foo}).
         * &lt;p&gt;
         * Note: This will not be called if an API with a manual tag was called with a non-null tag
         */
        @Nullable
        String createStackElementTag(@NonNull StackTraceElement element) {
<span class="nc" id="L742">            String tag = element.getClassName();</span>
<span class="nc" id="L743">            Matcher m = ANONYMOUS_CLASS.matcher(tag);</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5860)) {</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">                if (m.find()) {</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(5859)) {</span>
<span class="nc" id="L747">                        tag = m.replaceAll(&quot;&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L751" title="All 8 branches missed.">            return tag.substring((ListenerUtil.mutListener.listen(5864) ? (tag.lastIndexOf('.') % 1) : (ListenerUtil.mutListener.listen(5863) ? (tag.lastIndexOf('.') / 1) : (ListenerUtil.mutListener.listen(5862) ? (tag.lastIndexOf('.') * 1) : (ListenerUtil.mutListener.listen(5861) ? (tag.lastIndexOf('.') - 1) : (tag.lastIndexOf('.') + 1))))));</span>
        }

        final String getTag() {
            // because Robolectric runs them on the JVM but on Android the elements are different.
<span class="nc" id="L756">            StackTraceElement[] stackTrace = new Throwable().getStackTrace();</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5870)) {</span>
<span class="nc bnc" id="L758" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(5869) ? (stackTrace.length &gt;= CALL_STACK_INDEX) : (ListenerUtil.mutListener.listen(5868) ? (stackTrace.length &gt; CALL_STACK_INDEX) : (ListenerUtil.mutListener.listen(5867) ? (stackTrace.length &lt; CALL_STACK_INDEX) : (ListenerUtil.mutListener.listen(5866) ? (stackTrace.length != CALL_STACK_INDEX) : (ListenerUtil.mutListener.listen(5865) ? (stackTrace.length == CALL_STACK_INDEX) : (stackTrace.length &lt;= CALL_STACK_INDEX))))))) {</span>
                    // We are in production and should not crash the app for a logging failure
<span class="nc" id="L760">                    return TAG + &quot; unknown class&quot;;</span>
                }
            }
<span class="nc" id="L763">            return createStackElementTag(stackTrace[CALL_STACK_INDEX]);</span>
        }

        @Override
        protected void log(int priority, String tag, @NonNull String message, Throwable t) {
<span class="nc bnc" id="L768" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(5874)) {</span>
<span class="nc bnc" id="L769" title="All 5 branches missed.">                switch(priority) {</span>
                    case Log.VERBOSE:
                    case Log.DEBUG:
<span class="nc" id="L772">                        break;</span>
                    case Log.INFO:
<span class="nc bnc" id="L774" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5871)) {</span>
<span class="nc" id="L775">                            Log.i(AnkiDroidApp.TAG, message, t);</span>
                        }
                        break;
                    case Log.WARN:
<span class="nc bnc" id="L779" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5872)) {</span>
<span class="nc" id="L780">                            Log.w(AnkiDroidApp.TAG, getTag() + &quot;/ &quot; + message, t);</span>
                        }
                        break;
                    case Log.ERROR:
                    case Log.ASSERT:
<span class="nc bnc" id="L785" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(5873)) {</span>
<span class="nc" id="L786">                            Log.e(AnkiDroidApp.TAG, getTag() + &quot;/ &quot; + message, t);</span>
                        }
                        break;
                }
            }
<span class="nc" id="L791">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>