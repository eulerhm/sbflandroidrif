<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Storage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.libanki</a> &gt; <span class="el_source">Storage.java</span></div><h1>Storage.java</h1><pre class="source lang-java linenums">/**
 * ************************************************************************************
 *  Copyright (c) 2011 Norbert Nagold &lt;norbert.nagold@gmail.com&gt;                         *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.libanki;

import android.content.ContentValues;
import android.content.Context;
import com.ichi2.anki.exception.ConfirmModSchemaException;
import com.ichi2.libanki.exception.UnknownDatabaseVersionException;
import com.ichi2.libanki.utils.SystemTime;
import com.ichi2.libanki.utils.Time;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONException;
import com.ichi2.utils.JSONObject;
import java.io.File;
import java.util.ArrayList;
import java.util.Arrays;
import androidx.annotation.NonNull;
import timber.log.Timber;
import static com.ichi2.libanki.Consts.DECK_STD;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="pc bpc" id="L37" title="1 of 2 branches missed.">@SuppressWarnings({ &quot;PMD.AvoidThrowingRawExceptionTypes&quot;, &quot;PMD.AvoidReassigningParameters&quot;, &quot;PMD.NPathComplexity&quot;, &quot;PMD.MethodNamingConventions&quot;, &quot;PMD.ExcessiveMethodLength&quot;, &quot;PMD.OneDeclarationPerLine&quot;, &quot;PMD.SwitchStmtsShouldHaveDefault&quot;, &quot;PMD.EmptyIfStmt&quot;, &quot;PMD.SimplifyBooleanReturns&quot;, &quot;PMD.CollapsibleIfStatements&quot; })</span>
<span class="nc" id="L38">public class Storage {</span>

    /* Open a new or existing collection. Path must be unicode */
    public static Collection Collection(Context context, String path) {
<span class="nc" id="L42">        return Collection(context, path, false, false);</span>
    }

    /**
     * Helper method for when the collection can't be opened
     */
    public static int getDatabaseVersion(String path) throws UnknownDatabaseVersionException {
        try {
<span class="nc" id="L50">            DB db = new DB(path);</span>
<span class="nc" id="L51">            return db.queryScalar(&quot;SELECT ver FROM col&quot;);</span>
<span class="nc" id="L52">        } catch (Exception e) {</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23840)) {</span>
<span class="nc" id="L54">                Timber.w(e, &quot;Can't open database&quot;);</span>
            }
<span class="nc" id="L56">            throw new UnknownDatabaseVersionException(e);</span>
        }
    }

    public static Collection Collection(Context context, String path, boolean server, boolean log) {
<span class="nc" id="L61">        return Collection(context, path, server, log, new SystemTime());</span>
    }

    public static Collection Collection(Context context, String path, boolean server, boolean log, @NonNull Time time) {
<span class="pc bpc" id="L65" title="3 of 4 branches missed.">        assert path.endsWith(&quot;.anki2&quot;);</span>
<span class="fc" id="L66">        File dbFile = new File(path);</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        boolean create = !dbFile.exists();</span>
        // connect
<span class="fc" id="L69">        DB db = new DB(path);</span>
        try {
            // initialize
            int ver;
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">            if (create) {</span>
<span class="nc" id="L74">                ver = _createDB(db, time);</span>
            } else {
<span class="fc" id="L76">                ver = _upgradeSchema(db, time);</span>
            }
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23843)) {</span>
<span class="fc" id="L79">                db.execute(&quot;PRAGMA temp_store = memory&quot;);</span>
            }
            // add db to col and do any remaining upgrades
<span class="fc" id="L82">            Collection col = new Collection(context, db, path, server, log, time);</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23867)) {</span>
<span class="pc bpc" id="L84" title="16 of 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23848) ? (ver &gt;= Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23847) ? (ver &lt;= Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23846) ? (ver &gt; Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23845) ? (ver != Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23844) ? (ver == Consts.SCHEMA_VERSION) : (ver &lt; Consts.SCHEMA_VERSION))))))) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23866)) {</span>
<span class="nc" id="L86">                        _upgrade(col, ver);</span>
                    }
<span class="pc bpc" id="L88" title="16 of 22 branches missed.">                } else if ((ListenerUtil.mutListener.listen(23853) ? (ver &gt;= Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23852) ? (ver &lt;= Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23851) ? (ver &lt; Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23850) ? (ver != Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23849) ? (ver == Consts.SCHEMA_VERSION) : (ver &gt; Consts.SCHEMA_VERSION))))))) {</span>
<span class="nc" id="L89">                    throw new RuntimeException(&quot;This file requires a newer version of Anki.&quot;);</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">                } else if (create) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23864)) {</span>
                        {
<span class="nc" id="L93">                            long _loopCounter612 = 0;</span>
                            // add in reverse order so basic is default
<span class="nc bnc" id="L95" title="All 30 branches missed.">                            for (int i = (ListenerUtil.mutListener.listen(23863) ? (StdModels.stdModels.length % 1) : (ListenerUtil.mutListener.listen(23862) ? (StdModels.stdModels.length / 1) : (ListenerUtil.mutListener.listen(23861) ? (StdModels.stdModels.length * 1) : (ListenerUtil.mutListener.listen(23860) ? (StdModels.stdModels.length + 1) : (StdModels.stdModels.length - 1))))); (ListenerUtil.mutListener.listen(23859) ? (i &lt;= 0) : (ListenerUtil.mutListener.listen(23858) ? (i &gt; 0) : (ListenerUtil.mutListener.listen(23857) ? (i &lt; 0) : (ListenerUtil.mutListener.listen(23856) ? (i != 0) : (ListenerUtil.mutListener.listen(23855) ? (i == 0) : (i &gt;= 0)))))); i--) {</span>
<span class="nc" id="L96">                                ListenerUtil.loopListener.listen(&quot;_loopCounter612&quot;, ++_loopCounter612);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23854)) {</span>
<span class="nc" id="L98">                                    StdModels.stdModels[i].add(col);</span>
                                }
                            }
                        }
                    }
<span class="nc bnc" id="L103" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23865)) {</span>
<span class="nc" id="L104">                        col.save();</span>
                    }
                }
            }
<span class="fc" id="L108">            return col;</span>
<span class="nc" id="L109">        } catch (Exception e) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23841)) {</span>
<span class="nc" id="L111">                Timber.e(e, &quot;Error opening collection; closing database&quot;);</span>
            }
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23842)) {</span>
<span class="nc" id="L114">                db.close();</span>
            }
<span class="nc" id="L116">            throw e;</span>
        }
    }

    private static int _upgradeSchema(DB db, @NonNull Time time) {
<span class="fc" id="L121">        int ver = db.queryScalar(&quot;SELECT ver FROM col&quot;);</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23873)) {</span>
<span class="pc bpc" id="L123" title="16 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(23872) ? (ver &gt;= Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23871) ? (ver &lt;= Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23870) ? (ver &gt; Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23869) ? (ver &lt; Consts.SCHEMA_VERSION) : (ListenerUtil.mutListener.listen(23868) ? (ver != Consts.SCHEMA_VERSION) : (ver == Consts.SCHEMA_VERSION))))))) {</span>
<span class="fc" id="L124">                return ver;</span>
            }
        }
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23880)) {</span>
            // add odid to cards, edue-&gt;odue
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (db.queryScalar(&quot;SELECT ver FROM col&quot;) == 1) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23874)) {</span>
<span class="nc" id="L131">                    db.execute(&quot;ALTER TABLE cards RENAME TO cards2&quot;);</span>
                }
<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23875)) {</span>
<span class="nc" id="L134">                    _addSchema(db, false, time);</span>
                }
<span class="nc bnc" id="L136" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23876)) {</span>
<span class="nc" id="L137">                    db.execute(&quot;insert into cards select id, nid, did, ord, mod, usn, type, queue, due, ivl, factor, reps, lapses, left, edue, 0, flags, data from cards2&quot;);</span>
                }
<span class="nc bnc" id="L139" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23877)) {</span>
<span class="nc" id="L140">                    db.execute(&quot;DROP TABLE cards2&quot;);</span>
                }
<span class="nc bnc" id="L142" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23878)) {</span>
<span class="nc" id="L143">                    db.execute(&quot;UPDATE col SET ver = 2&quot;);</span>
                }
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23879)) {</span>
<span class="nc" id="L146">                    _updateIndices(db);</span>
                }
            }
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23887)) {</span>
            // remove did from notes
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (db.queryScalar(&quot;SELECT ver FROM col&quot;) == 2) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23881)) {</span>
<span class="nc" id="L154">                    db.execute(&quot;ALTER TABLE notes RENAME TO notes2&quot;);</span>
                }
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23882)) {</span>
<span class="nc" id="L157">                    _addSchema(db, time);</span>
                }
<span class="nc bnc" id="L159" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23883)) {</span>
<span class="nc" id="L160">                    db.execute(&quot;insert into notes select id, guid, mid, mod, usn, tags, flds, sfld, csum, flags, data from notes2&quot;);</span>
                }
<span class="nc bnc" id="L162" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23884)) {</span>
<span class="nc" id="L163">                    db.execute(&quot;DROP TABLE notes2&quot;);</span>
                }
<span class="nc bnc" id="L165" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23885)) {</span>
<span class="nc" id="L166">                    db.execute(&quot;UPDATE col SET ver = 3&quot;);</span>
                }
<span class="nc bnc" id="L168" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23886)) {</span>
<span class="nc" id="L169">                    _updateIndices(db);</span>
                }
            }
        }
<span class="nc" id="L173">        return ver;</span>
    }

    private static void _upgrade(Collection col, int ver) {
        try {
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23897)) {</span>
<span class="nc bnc" id="L179" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23892) ? (ver &gt;= 3) : (ListenerUtil.mutListener.listen(23891) ? (ver &lt;= 3) : (ListenerUtil.mutListener.listen(23890) ? (ver &gt; 3) : (ListenerUtil.mutListener.listen(23889) ? (ver != 3) : (ListenerUtil.mutListener.listen(23888) ? (ver == 3) : (ver &lt; 3))))))) {</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23896)) {</span>
                        {
<span class="nc" id="L182">                            long _loopCounter613 = 0;</span>
                            // new deck properties
<span class="nc bnc" id="L184" title="All 2 branches missed.">                            for (Deck d : col.getDecks().all()) {</span>
<span class="nc" id="L185">                                ListenerUtil.loopListener.listen(&quot;_loopCounter613&quot;, ++_loopCounter613);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23893)) {</span>
<span class="nc" id="L187">                                    d.put(&quot;dyn&quot;, DECK_STD);</span>
                                }
<span class="nc bnc" id="L189" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23894)) {</span>
<span class="nc" id="L190">                                    d.put(&quot;collapsed&quot;, false);</span>
                                }
<span class="nc bnc" id="L192" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23895)) {</span>
<span class="nc" id="L193">                                    col.getDecks().save(d);</span>
                                }
<span class="nc" id="L195">                            }</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23911)) {</span>
<span class="nc bnc" id="L201" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23902) ? (ver &gt;= 4) : (ListenerUtil.mutListener.listen(23901) ? (ver &lt;= 4) : (ListenerUtil.mutListener.listen(23900) ? (ver &gt; 4) : (ListenerUtil.mutListener.listen(23899) ? (ver != 4) : (ListenerUtil.mutListener.listen(23898) ? (ver == 4) : (ver &lt; 4))))))) {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23903)) {</span>
<span class="nc" id="L203">                        col.modSchemaNoCheck();</span>
                    }
<span class="nc" id="L205">                    ArrayList&lt;Model&gt; models = col.getModels().all();</span>
<span class="nc" id="L206">                    ArrayList&lt;Model&gt; clozes = new ArrayList&lt;&gt;(models);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23907)) {</span>
                        {
<span class="nc" id="L209">                            long _loopCounter614 = 0;</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                            for (Model m : models) {</span>
<span class="nc" id="L211">                                ListenerUtil.loopListener.listen(&quot;_loopCounter614&quot;, ++_loopCounter614);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23906)) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                                    if (!m.getJSONArray(&quot;tmpls&quot;).getJSONObject(0).getString(&quot;qfmt&quot;).contains(&quot;{{cloze:&quot;)) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23905)) {</span>
<span class="nc" id="L215">                                            m.put(&quot;type&quot;, Consts.MODEL_STD);</span>
                                        }
                                    } else {
<span class="nc bnc" id="L218" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23904)) {</span>
<span class="nc" id="L219">                                            clozes.add(m);</span>
                                        }
                                    }
                                }
<span class="nc" id="L223">                            }</span>
                        }
                    }
<span class="nc bnc" id="L226" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23909)) {</span>
                        {
<span class="nc" id="L228">                            long _loopCounter615 = 0;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                            for (Model m : clozes) {</span>
<span class="nc" id="L230">                                ListenerUtil.loopListener.listen(&quot;_loopCounter615&quot;, ++_loopCounter615);</span>
                                try {
<span class="nc bnc" id="L232" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(23908)) {</span>
<span class="nc" id="L233">                                        _upgradeClozeModel(col, m);</span>
                                    }
<span class="nc" id="L235">                                } catch (ConfirmModSchemaException e) {</span>
                                    // Will never be reached as we already set modSchemaNoCheck()
<span class="nc" id="L237">                                    throw new RuntimeException(e);</span>
<span class="nc" id="L238">                                }</span>
<span class="nc" id="L239">                            }</span>
                        }
                    }
<span class="nc bnc" id="L242" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23910)) {</span>
<span class="nc" id="L243">                        col.getDb().execute(&quot;UPDATE col SET ver = 4&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L247" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23919)) {</span>
<span class="nc bnc" id="L248" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23916) ? (ver &gt;= 5) : (ListenerUtil.mutListener.listen(23915) ? (ver &lt;= 5) : (ListenerUtil.mutListener.listen(23914) ? (ver &gt; 5) : (ListenerUtil.mutListener.listen(23913) ? (ver != 5) : (ListenerUtil.mutListener.listen(23912) ? (ver == 5) : (ver &lt; 5))))))) {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23917)) {</span>
<span class="nc" id="L250">                        col.getDb().execute(&quot;UPDATE cards SET odue = 0 WHERE queue = 2&quot;);</span>
                    }
<span class="nc bnc" id="L252" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23918)) {</span>
<span class="nc" id="L253">                        col.getDb().execute(&quot;UPDATE col SET ver = 5&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23934)) {</span>
<span class="nc bnc" id="L258" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23924) ? (ver &gt;= 6) : (ListenerUtil.mutListener.listen(23923) ? (ver &lt;= 6) : (ListenerUtil.mutListener.listen(23922) ? (ver &gt; 6) : (ListenerUtil.mutListener.listen(23921) ? (ver != 6) : (ListenerUtil.mutListener.listen(23920) ? (ver == 6) : (ver &lt; 6))))))) {</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23925)) {</span>
<span class="nc" id="L260">                        col.modSchemaNoCheck();</span>
                    }
<span class="nc bnc" id="L262" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23932)) {</span>
                        {
<span class="nc" id="L264">                            long _loopCounter617 = 0;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                            for (Model m : col.getModels().all()) {</span>
<span class="nc" id="L266">                                ListenerUtil.loopListener.listen(&quot;_loopCounter617&quot;, ++_loopCounter617);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23926)) {</span>
<span class="nc" id="L268">                                    m.put(&quot;css&quot;, new JSONObject(Models.defaultModel).getString(&quot;css&quot;));</span>
                                }
<span class="nc" id="L270">                                JSONArray ar = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23930)) {</span>
                                    {
<span class="nc" id="L273">                                        long _loopCounter616 = 0;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                                        for (JSONObject t : ar.jsonObjectIterable()) {</span>
<span class="nc" id="L275">                                            ListenerUtil.loopListener.listen(&quot;_loopCounter616&quot;, ++_loopCounter616);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(23927)) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                                                if (!t.has(&quot;css&quot;)) {</span>
<span class="nc" id="L278">                                                    continue;</span>
                                                }
                                            }
<span class="nc bnc" id="L281" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(23928)) {</span>
<span class="nc" id="L282">                                                m.put(&quot;css&quot;, m.getString(&quot;css&quot;) + &quot;\n&quot; + t.getString(&quot;css&quot;).replace(&quot;.card &quot;, &quot;.card&quot; + t.getInt(&quot;ord&quot;) + 1));</span>
                                            }
<span class="nc bnc" id="L284" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(23929)) {</span>
<span class="nc" id="L285">                                                t.remove(&quot;css&quot;);</span>
                                            }
<span class="nc" id="L287">                                        }</span>
                                    }
                                }
<span class="nc bnc" id="L290" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23931)) {</span>
<span class="nc" id="L291">                                    col.getModels().save(m);</span>
                                }
<span class="nc" id="L293">                            }</span>
                        }
                    }
<span class="nc bnc" id="L296" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23933)) {</span>
<span class="nc" id="L297">                        col.getDb().execute(&quot;UPDATE col SET ver = 6&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23943)) {</span>
<span class="nc bnc" id="L302" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23939) ? (ver &gt;= 7) : (ListenerUtil.mutListener.listen(23938) ? (ver &lt;= 7) : (ListenerUtil.mutListener.listen(23937) ? (ver &gt; 7) : (ListenerUtil.mutListener.listen(23936) ? (ver != 7) : (ListenerUtil.mutListener.listen(23935) ? (ver == 7) : (ver &lt; 7))))))) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23940)) {</span>
<span class="nc" id="L304">                        col.modSchemaNoCheck();</span>
                    }
<span class="nc bnc" id="L306" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23941)) {</span>
<span class="nc" id="L307">                        col.getDb().execute(&quot;UPDATE cards SET odue = 0 WHERE (type = &quot; + Consts.CARD_TYPE_LRN + &quot; OR queue = 2) AND NOT odid&quot;);</span>
                    }
<span class="nc bnc" id="L309" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23942)) {</span>
<span class="nc" id="L310">                        col.getDb().execute(&quot;UPDATE col SET ver = 7&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L314" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23952)) {</span>
<span class="nc bnc" id="L315" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23948) ? (ver &gt;= 8) : (ListenerUtil.mutListener.listen(23947) ? (ver &lt;= 8) : (ListenerUtil.mutListener.listen(23946) ? (ver &gt; 8) : (ListenerUtil.mutListener.listen(23945) ? (ver != 8) : (ListenerUtil.mutListener.listen(23944) ? (ver == 8) : (ver &lt; 8))))))) {</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23949)) {</span>
<span class="nc" id="L317">                        col.modSchemaNoCheck();</span>
                    }
<span class="nc bnc" id="L319" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23950)) {</span>
<span class="nc" id="L320">                        col.getDb().execute(&quot;UPDATE cards SET due = due / 1000 WHERE due &gt; 4294967296&quot;);</span>
                    }
<span class="nc bnc" id="L322" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23951)) {</span>
<span class="nc" id="L323">                        col.getDb().execute(&quot;UPDATE col SET ver = 8&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23959)) {</span>
<span class="nc bnc" id="L328" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23957) ? (ver &gt;= 9) : (ListenerUtil.mutListener.listen(23956) ? (ver &lt;= 9) : (ListenerUtil.mutListener.listen(23955) ? (ver &gt; 9) : (ListenerUtil.mutListener.listen(23954) ? (ver != 9) : (ListenerUtil.mutListener.listen(23953) ? (ver == 9) : (ver &lt; 9))))))) {</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23958)) {</span>
<span class="nc" id="L330">                        col.getDb().execute(&quot;UPDATE col SET ver = 9&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L334" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23967)) {</span>
<span class="nc bnc" id="L335" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23964) ? (ver &gt;= 10) : (ListenerUtil.mutListener.listen(23963) ? (ver &lt;= 10) : (ListenerUtil.mutListener.listen(23962) ? (ver &gt; 10) : (ListenerUtil.mutListener.listen(23961) ? (ver != 10) : (ListenerUtil.mutListener.listen(23960) ? (ver == 10) : (ver &lt; 10))))))) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23965)) {</span>
<span class="nc" id="L337">                        col.getDb().execute(&quot;UPDATE cards SET left = left + left * 1000 WHERE queue = &quot; + Consts.QUEUE_TYPE_LRN);</span>
                    }
<span class="nc bnc" id="L339" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23966)) {</span>
<span class="nc" id="L340">                        col.getDb().execute(&quot;UPDATE col SET ver = 10&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(24006)) {</span>
<span class="nc bnc" id="L345" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(23972) ? (ver &gt;= 11) : (ListenerUtil.mutListener.listen(23971) ? (ver &lt;= 11) : (ListenerUtil.mutListener.listen(23970) ? (ver &gt; 11) : (ListenerUtil.mutListener.listen(23969) ? (ver != 11) : (ListenerUtil.mutListener.listen(23968) ? (ver == 11) : (ver &lt; 11))))))) {</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23973)) {</span>
<span class="nc" id="L347">                        col.modSchemaNoCheck();</span>
                    }
<span class="nc bnc" id="L349" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23993)) {</span>
                        {
<span class="nc" id="L351">                            long _loopCounter618 = 0;</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                            for (Deck d : col.getDecks().all()) {</span>
<span class="nc" id="L353">                                ListenerUtil.loopListener.listen(&quot;_loopCounter618&quot;, ++_loopCounter618);</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23991)) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                                    if (d.isDyn()) {</span>
<span class="nc" id="L356">                                        int order = d.getInt(&quot;order&quot;);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23983)) {</span>
                                            // failed order was removed
<span class="nc bnc" id="L359" title="All 22 branches missed.">                                            if ((ListenerUtil.mutListener.listen(23981) ? (order &lt;= 5) : (ListenerUtil.mutListener.listen(23980) ? (order &gt; 5) : (ListenerUtil.mutListener.listen(23979) ? (order &lt; 5) : (ListenerUtil.mutListener.listen(23978) ? (order != 5) : (ListenerUtil.mutListener.listen(23977) ? (order == 5) : (order &gt;= 5))))))) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(23982)) {</span>
<span class="nc" id="L361">                                                    order -= 1;</span>
                                                }
                                            }
                                        }
<span class="nc" id="L365">                                        JSONArray terms = new JSONArray(Arrays.asList(d.getString(&quot;search&quot;), d.getInt(&quot;limit&quot;), order));</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23984)) {</span>
<span class="nc" id="L367">                                            d.put(&quot;terms&quot;, new JSONArray());</span>
                                        }
<span class="nc bnc" id="L369" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23985)) {</span>
<span class="nc" id="L370">                                            d.getJSONArray(&quot;terms&quot;).put(0, terms);</span>
                                        }
<span class="nc bnc" id="L372" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23986)) {</span>
<span class="nc" id="L373">                                            d.remove(&quot;search&quot;);</span>
                                        }
<span class="nc bnc" id="L375" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23987)) {</span>
<span class="nc" id="L376">                                            d.remove(&quot;limit&quot;);</span>
                                        }
<span class="nc bnc" id="L378" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23988)) {</span>
<span class="nc" id="L379">                                            d.remove(&quot;order&quot;);</span>
                                        }
<span class="nc bnc" id="L381" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23989)) {</span>
<span class="nc" id="L382">                                            d.put(&quot;resched&quot;, true);</span>
                                        }
<span class="nc bnc" id="L384" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23990)) {</span>
<span class="nc" id="L385">                                            d.put(&quot;return&quot;, true);</span>
                                        }
<span class="nc" id="L387">                                    } else {</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23976)) {</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">                                            if (!d.has(&quot;extendNew&quot;)) {</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(23974)) {</span>
<span class="nc" id="L391">                                                    d.put(&quot;extendNew&quot;, 10);</span>
                                                }
<span class="nc bnc" id="L393" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(23975)) {</span>
<span class="nc" id="L394">                                                    d.put(&quot;extendRev&quot;, 50);</span>
                                                }
                                            }
                                        }
                                    }
                                }
<span class="nc bnc" id="L400" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23992)) {</span>
<span class="nc" id="L401">                                    col.getDecks().save(d);</span>
                                }
<span class="nc" id="L403">                            }</span>
                        }
                    }
<span class="nc bnc" id="L406" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23999)) {</span>
                        {
<span class="nc" id="L408">                            long _loopCounter619 = 0;</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                            for (DeckConfig c : col.getDecks().allConf()) {</span>
<span class="nc" id="L410">                                ListenerUtil.loopListener.listen(&quot;_loopCounter619&quot;, ++_loopCounter619);</span>
<span class="nc" id="L411">                                JSONObject r = c.getJSONObject(&quot;rev&quot;);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23994)) {</span>
<span class="nc" id="L413">                                    r.put(&quot;ivlFct&quot;, r.optDouble(&quot;ivlFct&quot;, 1));</span>
                                }
<span class="nc bnc" id="L415" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23996)) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                                    if (r.has(&quot;ivlfct&quot;)) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23995)) {</span>
<span class="nc" id="L418">                                            r.remove(&quot;ivlfct&quot;);</span>
                                        }
                                    }
                                }
<span class="nc bnc" id="L422" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23997)) {</span>
<span class="nc" id="L423">                                    r.put(&quot;maxIvl&quot;, 36500);</span>
                                }
<span class="nc bnc" id="L425" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23998)) {</span>
<span class="nc" id="L426">                                    col.getDecks().save(c);</span>
                                }
<span class="nc" id="L428">                            }</span>
                        }
                    }
<span class="nc bnc" id="L431" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(24004)) {</span>
                        {
<span class="nc" id="L433">                            long _loopCounter621 = 0;</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">                            for (Model m : col.getModels().all()) {</span>
<span class="nc" id="L435">                                ListenerUtil.loopListener.listen(&quot;_loopCounter621&quot;, ++_loopCounter621);</span>
<span class="nc" id="L436">                                JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(24002)) {</span>
                                    {
<span class="nc" id="L439">                                        long _loopCounter620 = 0;</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                                        for (JSONObject t : tmpls.jsonObjectIterable()) {</span>
<span class="nc" id="L441">                                            ListenerUtil.loopListener.listen(&quot;_loopCounter620&quot;, ++_loopCounter620);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(24000)) {</span>
<span class="nc" id="L443">                                                t.put(&quot;bqfmt&quot;, &quot;&quot;);</span>
                                            }
<span class="nc bnc" id="L445" title="All 2 branches missed.">                                            if (!ListenerUtil.mutListener.listen(24001)) {</span>
<span class="nc" id="L446">                                                t.put(&quot;bafmt&quot;, &quot;&quot;);</span>
                                            }
<span class="nc" id="L448">                                        }</span>
                                    }
                                }
<span class="nc bnc" id="L451" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(24003)) {</span>
<span class="nc" id="L452">                                    col.getModels().save(m);</span>
                                }
<span class="nc" id="L454">                            }</span>
                        }
                    }
<span class="nc bnc" id="L457" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(24005)) {</span>
<span class="nc" id="L458">                        col.getDb().execute(&quot;update col set ver = 11&quot;);</span>
                    }
                }
            }
<span class="nc" id="L462">        } catch (JSONException e) {</span>
<span class="nc" id="L463">            throw new RuntimeException(e);</span>
<span class="nc" id="L464">        }</span>
<span class="nc" id="L465">    }</span>

    private static void _upgradeClozeModel(Collection col, Model m) throws ConfirmModSchemaException {
<span class="nc bnc" id="L468" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24007)) {</span>
<span class="nc" id="L469">            m.put(&quot;type&quot;, Consts.MODEL_CLOZE);</span>
        }
        // convert first template
<span class="nc" id="L472">        JSONObject t = m.getJSONArray(&quot;tmpls&quot;).getJSONObject(0);</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24009)) {</span>
            {
<span class="nc" id="L475">                long _loopCounter622 = 0;</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                for (String type : new String[] { &quot;qfmt&quot;, &quot;afmt&quot; }) {</span>
<span class="nc" id="L477">                    ListenerUtil.loopListener.listen(&quot;_loopCounter622&quot;, ++_loopCounter622);</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(24008)) {</span>
                        // noinspection RegExpRedundantEscape            // In Android, } should be escaped
<span class="nc" id="L480">                        t.put(type, t.getString(type).replaceAll(&quot;\\{\\{cloze:1:(.+?)\\}\\}&quot;, &quot;{{cloze:$1}}&quot;));</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24010)) {</span>
<span class="nc" id="L486">            t.put(&quot;name&quot;, &quot;Cloze&quot;);</span>
        }
        // delete non-cloze cards for the model
<span class="nc" id="L489">        JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc" id="L490">        ArrayList&lt;JSONObject&gt; rem = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24013)) {</span>
            {
<span class="nc" id="L493">                long _loopCounter623 = 0;</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">                for (JSONObject ta : tmpls.jsonObjectIterable()) {</span>
<span class="nc" id="L495">                    ListenerUtil.loopListener.listen(&quot;_loopCounter623&quot;, ++_loopCounter623);</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(24012)) {</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                        if (!ta.getString(&quot;afmt&quot;).contains(&quot;{{cloze:&quot;)) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(24011)) {</span>
<span class="nc" id="L499">                                rem.add(ta);</span>
                            }
                        }
                    }
<span class="nc" id="L503">                }</span>
            }
        }
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24015)) {</span>
            {
<span class="nc" id="L508">                long _loopCounter624 = 0;</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                for (JSONObject r : rem) {</span>
<span class="nc" id="L510">                    ListenerUtil.loopListener.listen(&quot;_loopCounter624&quot;, ++_loopCounter624);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(24014)) {</span>
<span class="nc" id="L512">                        col.getModels().remTemplate(m, r);</span>
                    }
<span class="nc" id="L514">                }</span>
            }
        }
<span class="nc" id="L517">        JSONArray newTmpls = new JSONArray();</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24016)) {</span>
<span class="nc" id="L519">            newTmpls.put(tmpls.getJSONObject(0));</span>
        }
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24017)) {</span>
<span class="nc" id="L522">            m.put(&quot;tmpls&quot;, newTmpls);</span>
        }
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24018)) {</span>
<span class="nc" id="L525">            Models._updateTemplOrds(m);</span>
        }
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24019)) {</span>
<span class="nc" id="L528">            col.getModels().save(m);</span>
        }
<span class="nc" id="L530">    }</span>

    private static int _createDB(DB db, @NonNull Time time) {
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24020)) {</span>
<span class="nc" id="L534">            db.execute(&quot;PRAGMA page_size = 4096&quot;);</span>
        }
<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24021)) {</span>
<span class="nc" id="L537">            db.execute(&quot;PRAGMA legacy_file_format = 0&quot;);</span>
        }
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24022)) {</span>
<span class="nc" id="L540">            db.execute(&quot;VACUUM&quot;);</span>
        }
<span class="nc bnc" id="L542" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24023)) {</span>
<span class="nc" id="L543">            _addSchema(db, time);</span>
        }
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24024)) {</span>
<span class="nc" id="L546">            _updateIndices(db);</span>
        }
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24025)) {</span>
<span class="nc" id="L549">            db.execute(&quot;ANALYZE&quot;);</span>
        }
<span class="nc" id="L551">        return Consts.SCHEMA_VERSION;</span>
    }

    private static void _addSchema(DB db, @NonNull Time time) {
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24026)) {</span>
<span class="nc" id="L556">            _addSchema(db, true, time);</span>
        }
<span class="nc" id="L558">    }</span>

    private static void _addSchema(DB db, boolean setColConf, @NonNull Time time) {
<span class="nc bnc" id="L561" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24027)) {</span>
<span class="nc" id="L562">            db.execute(&quot;create table if not exists col ( &quot; + &quot;id              integer primary key, &quot; + &quot;crt             integer not null,&quot; + &quot;mod             integer not null,&quot; + &quot;scm             integer not null,&quot; + &quot;ver             integer not null,&quot; + &quot;dty             integer not null,&quot; + &quot;usn             integer not null,&quot; + &quot;ls              integer not null,&quot; + &quot;conf            text not null,&quot; + &quot;models          text not null,&quot; + &quot;decks           text not null,&quot; + &quot;dconf           text not null,&quot; + &quot;tags            text not null&quot; + &quot;);&quot;);</span>
        }
<span class="nc bnc" id="L564" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24028)) {</span>
<span class="nc" id="L565">            db.execute(&quot;create table if not exists notes (&quot; + &quot;   id              integer primary key,   /* 0 */&quot; + &quot;  guid            text not null,   /* 1 */&quot; + &quot; mid             integer not null,   /* 2 */&quot; + &quot; mod             integer not null,   /* 3 */&quot; + &quot; usn             integer not null,   /* 4 */&quot; + &quot; tags            text not null,   /* 5 */&quot; + &quot; flds            text not null,   /* 6 */&quot; + &quot; sfld            integer not null,   /* 7 */&quot; + &quot; csum            integer not null,   /* 8 */&quot; + &quot; flags           integer not null,   /* 9 */&quot; + &quot; data            text not null   /* 10 */&quot; + &quot;);&quot;);</span>
        }
<span class="nc bnc" id="L567" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24029)) {</span>
<span class="nc" id="L568">            db.execute(&quot;create table if not exists cards (&quot; + &quot;   id              integer primary key,   /* 0 */&quot; + &quot;  nid             integer not null,   /* 1 */&quot; + &quot;  did             integer not null,   /* 2 */&quot; + &quot;  ord             integer not null,   /* 3 */&quot; + &quot;  mod             integer not null,   /* 4 */&quot; + &quot; usn             integer not null,   /* 5 */&quot; + &quot; type            integer not null,   /* 6 */&quot; + &quot; queue           integer not null,   /* 7 */&quot; + &quot;    due             integer not null,   /* 8 */&quot; + &quot;   ivl             integer not null,   /* 9 */&quot; + &quot;  factor          integer not null,   /* 10 */&quot; + &quot; reps            integer not null,   /* 11 */&quot; + &quot;   lapses          integer not null,   /* 12 */&quot; + &quot;   left            integer not null,   /* 13 */&quot; + &quot;   odue            integer not null,   /* 14 */&quot; + &quot;   odid            integer not null,   /* 15 */&quot; + &quot;   flags           integer not null,   /* 16 */&quot; + &quot;   data            text not null   /* 17 */&quot; + &quot;);&quot;);</span>
        }
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24030)) {</span>
<span class="nc" id="L571">            db.execute(&quot;create table if not exists revlog (&quot; + &quot;   id              integer primary key,&quot; + &quot;   cid             integer not null,&quot; + &quot;   usn             integer not null,&quot; + &quot;   ease            integer not null,&quot; + &quot;   ivl             integer not null,&quot; + &quot;   lastIvl         integer not null,&quot; + &quot;   factor          integer not null,&quot; + &quot;   time            integer not null,&quot; + &quot;   type            integer not null&quot; + &quot;);&quot;);</span>
        }
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24031)) {</span>
<span class="nc" id="L574">            db.execute(&quot;create table if not exists graves (&quot; + &quot;    usn             integer not null,&quot; + &quot;    oid             integer not null,&quot; + &quot;    type            integer not null&quot; + &quot;)&quot;);</span>
        }
<span class="nc bnc" id="L576" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24032)) {</span>
<span class="nc" id="L577">            db.execute(&quot;INSERT OR IGNORE INTO col VALUES(1,0,0,&quot; + time.intTimeMS() + &quot;,&quot; + Consts.SCHEMA_VERSION + &quot;,0,0,0,'','{}','','','{}')&quot;);</span>
        }
<span class="nc bnc" id="L579" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24034)) {</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">            if (setColConf) {</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(24033)) {</span>
<span class="nc" id="L582">                    _setColVars(db, time);</span>
                }
            }
        }
<span class="nc" id="L586">    }</span>

    private static void _setColVars(DB db, @NonNull Time time) {
<span class="nc" id="L589">        JSONObject g = new JSONObject(Decks.defaultDeck);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24035)) {</span>
<span class="nc" id="L591">            g.put(&quot;id&quot;, 1);</span>
        }
<span class="nc bnc" id="L593" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24036)) {</span>
<span class="nc" id="L594">            g.put(&quot;name&quot;, &quot;Default&quot;);</span>
        }
<span class="nc bnc" id="L596" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24037)) {</span>
<span class="nc" id="L597">            g.put(&quot;conf&quot;, 1);</span>
        }
<span class="nc bnc" id="L599" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24038)) {</span>
<span class="nc" id="L600">            g.put(&quot;mod&quot;, time.intTime());</span>
        }
<span class="nc" id="L602">        JSONObject gc = new JSONObject(Decks.defaultConf);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24039)) {</span>
<span class="nc" id="L604">            gc.put(&quot;id&quot;, 1);</span>
        }
<span class="nc" id="L606">        JSONObject ag = new JSONObject();</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24040)) {</span>
<span class="nc" id="L608">            ag.put(&quot;1&quot;, g);</span>
        }
<span class="nc" id="L610">        JSONObject agc = new JSONObject();</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24041)) {</span>
<span class="nc" id="L612">            agc.put(&quot;1&quot;, gc);</span>
        }
<span class="nc" id="L614">        ContentValues values = new ContentValues();</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24042)) {</span>
<span class="nc" id="L616">            values.put(&quot;conf&quot;, Collection.defaultConf);</span>
        }
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24043)) {</span>
<span class="nc" id="L619">            values.put(&quot;decks&quot;, Utils.jsonToString(ag));</span>
        }
<span class="nc bnc" id="L621" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24044)) {</span>
<span class="nc" id="L622">            values.put(&quot;dconf&quot;, Utils.jsonToString(agc));</span>
        }
<span class="nc bnc" id="L624" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24045)) {</span>
<span class="nc" id="L625">            db.update(&quot;col&quot;, values);</span>
        }
<span class="nc" id="L627">    }</span>

    private static void _updateIndices(DB db) {
<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24046)) {</span>
<span class="nc" id="L631">            db.execute(&quot;create index if not exists ix_notes_usn on notes (usn);&quot;);</span>
        }
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24047)) {</span>
<span class="nc" id="L634">            db.execute(&quot;create index if not exists ix_cards_usn on cards (usn);&quot;);</span>
        }
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24048)) {</span>
<span class="nc" id="L637">            db.execute(&quot;create index if not exists ix_revlog_usn on revlog (usn);&quot;);</span>
        }
<span class="nc bnc" id="L639" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24049)) {</span>
<span class="nc" id="L640">            db.execute(&quot;create index if not exists ix_cards_nid on cards (nid);&quot;);</span>
        }
<span class="nc bnc" id="L642" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24050)) {</span>
<span class="nc" id="L643">            db.execute(&quot;create index if not exists ix_cards_sched on cards (did, queue, due);&quot;);</span>
        }
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24051)) {</span>
<span class="nc" id="L646">            db.execute(&quot;create index if not exists ix_revlog_cid on revlog (cid);&quot;);</span>
        }
<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24052)) {</span>
<span class="nc" id="L649">            db.execute(&quot;create index if not exists ix_notes_csum on notes (csum);)&quot;);</span>
        }
<span class="nc" id="L651">    }</span>

    public static void addIndices(DB db) {
<span class="nc bnc" id="L654" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(24053)) {</span>
<span class="nc" id="L655">            _updateIndices(db);</span>
        }
<span class="nc" id="L657">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>