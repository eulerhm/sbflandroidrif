<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Models.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.libanki</a> &gt; <span class="el_source">Models.java</span></div><h1>Models.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2009 Daniel Sv√§rd &lt;daniel.svard@gmail.com&gt;                             *
 *  Copyright (c) 2010 Rick Gruber-Riemer &lt;rick@vanosten.net&gt;                            *
 *  Copyright (c) 2011 Norbert Nagold &lt;norbert.nagold@gmail.com&gt;                         *
 *  Copyright (c) 2011 Kostas Spyropoulos &lt;inigo.aldana@gmail.com&gt;                       *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.libanki;

import android.content.ContentValues;
import android.database.Cursor;
import android.util.Pair;
import androidx.annotation.Nullable;
import androidx.annotation.VisibleForTesting;
import timber.log.Timber;
import com.ichi2.anki.exception.ConfirmModSchemaException;
import com.ichi2.libanki.template.ParsedNode;
import com.ichi2.libanki.template.TemplateError;
import com.ichi2.utils.Assert;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONObject;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.WeakHashMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import androidx.annotation.NonNull;
import static com.ichi2.libanki.Utils.trimArray;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="pc bpc" id="L51" title="1 of 2 branches missed.">@SuppressWarnings({ &quot;PMD.ExcessiveClassLength&quot;, &quot;PMD.AvoidThrowingRawExceptionTypes&quot;, &quot;PMD.AvoidReassigningParameters&quot;, &quot;PMD.NPathComplexity&quot;, &quot;PMD.MethodNamingConventions&quot;, &quot;PMD.SwitchStmtsShouldHaveDefault&quot;, &quot;PMD.CollapsibleIfStatements&quot;, &quot;PMD.EmptyIfStmt&quot; })</span>
public class Models {

    public static final long NOT_FOUND_NOTE_TYPE = -1L;

    @VisibleForTesting
    public static final String REQ_NONE = &quot;none&quot;;

    @VisibleForTesting
    public static final String REQ_ANY = &quot;any&quot;;

    @VisibleForTesting
    public static final String REQ_ALL = &quot;all&quot;;

    // In Android, } should be escaped
    @SuppressWarnings(&quot;RegExpRedundantEscape&quot;)
<span class="fc" id="L67">    private static final Pattern fClozePattern1 = Pattern.compile(&quot;\\{\\{[^}]*?cloze:(?:[^}]?:)*(.+?)\\}\\}&quot;);</span>

<span class="fc" id="L69">    private static final Pattern fClozePattern2 = Pattern.compile(&quot;&lt;%cloze:(.+?)%&gt;&quot;);</span>

    @SuppressWarnings(&quot;RegExpRedundantEscape&quot;)
<span class="fc" id="L72">    private static final Pattern fClozeOrdPattern = Pattern.compile(&quot;(?si)\\{\\{c(\\d+)::.*?\\}\\}&quot;);</span>

    public static final String defaultModel = &quot;{'sortf': 0, &quot; + &quot;'did': 1, &quot; + &quot;'latexPre': \&quot;&quot; + &quot;\\\\documentclass[12pt]{article}\\n&quot; + &quot;\\\\special{papersize=3in,5in}\\n&quot; + &quot;\\\\usepackage[utf8]{inputenc}\\n&quot; + &quot;\\\\usepackage{amssymb,amsmath}\\n&quot; + &quot;\\\\pagestyle{empty}\\n&quot; + &quot;\\\\setlength{\\\\parindent}{0in}\\n&quot; + &quot;\\\\begin{document}\\n&quot; + &quot;\&quot;, &quot; + &quot;'latexPost': \&quot;\\\\end{document}\&quot;, &quot; + &quot;'mod': 0, &quot; + &quot;'usn': 0, &quot; + // FIXME: remove when other clients have caught up
    &quot;'vers': [], &quot; + &quot;'type': &quot; + Consts.MODEL_STD + &quot;, &quot; + &quot;'css': \&quot;.card {\\n&quot; + &quot; font-family: arial;\\n&quot; + &quot; font-size: 20px;\\n&quot; + &quot; text-align: center;\\n&quot; + &quot; color: black;\\n&quot; + &quot; background-color: white;\\n&quot; + &quot;}\&quot;&quot; + &quot;}&quot;;

    private static final String defaultField = &quot;{'name': \&quot;\&quot;, &quot; + &quot;'ord': null, &quot; + &quot;'sticky': False, &quot; + // the following alter editing, and are used as defaults for the template wizard
    &quot;'rtl': False, &quot; + &quot;'font': \&quot;Arial\&quot;, &quot; + &quot;'size': 20, &quot; + // reserved for future use
    &quot;'media': [] }&quot;;

    private static final String defaultTemplate = &quot;{'name': \&quot;\&quot;, &quot; + &quot;'ord': null, &quot; + &quot;'qfmt': \&quot;\&quot;, &quot; + &quot;'afmt': \&quot;\&quot;, &quot; + &quot;'did': null, &quot; + &quot;'bqfmt': \&quot;\&quot;,&quot; + &quot;'bafmt': \&quot;\&quot;,&quot; + &quot;'bfont': \&quot;Arial\&quot;,&quot; + &quot;'bsize': 12 }&quot;;

    private final Collection mCol;

    private boolean mChanged;

    private HashMap&lt;Long, Model&gt; mModels;

    // BEGIN SQL table entries
    private int mId;

<span class="fc" id="L92">    public Models(Collection col) {</span>
<span class="fc" id="L93">        mCol = col;</span>
<span class="fc" id="L94">    }</span>

    /**
     * Load registry from JSON.
     */
    public void load(String json) {
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23171)) {</span>
<span class="fc" id="L101">            mChanged = false;</span>
        }
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23172)) {</span>
<span class="fc" id="L104">            mModels = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L106">        JSONObject modelarray = new JSONObject(json);</span>
<span class="fc" id="L107">        JSONArray ids = modelarray.names();</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23175)) {</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">            if (ids != null) {</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23174)) {</span>
                    {
<span class="fc" id="L112">                        long _loopCounter569 = 0;</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">                        for (String id : ids.stringIterable()) {</span>
<span class="fc" id="L114">                            ListenerUtil.loopListener.listen(&quot;_loopCounter569&quot;, ++_loopCounter569);</span>
<span class="fc" id="L115">                            Model o = new Model(modelarray.getJSONObject(id));</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23173)) {</span>
<span class="fc" id="L117">                                mModels.put(o.getLong(&quot;id&quot;), o);</span>
                            }
<span class="fc" id="L119">                        }</span>
                    }
                }
            }
        }
<span class="fc" id="L124">    }</span>

    /**
     * Mark M modified if provided, and schedule registry flush.
     */
    public void save() {
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23176)) {</span>
<span class="fc" id="L131">            save(null, false);</span>
        }
<span class="fc" id="L133">    }</span>

    public void save(Model m) {
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23177)) {</span>
<span class="fc" id="L137">            save(m, false);</span>
        }
<span class="fc" id="L139">    }</span>

    /**
     * Save a model
     * @param m model to save
     * @param templates flag which (when true) re-generates the cards for each note which uses the model
     */
    public void save(Model m, boolean templates) {
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23183)) {</span>
<span class="pc bpc" id="L148" title="6 of 10 branches missed.">            if ((ListenerUtil.mutListener.listen(23178) ? (m != null || m.has(&quot;id&quot;)) : (m != null &amp;&amp; m.has(&quot;id&quot;)))) {</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23179)) {</span>
<span class="fc" id="L150">                    m.put(&quot;mod&quot;, mCol.getTime().intTime());</span>
                }
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23180)) {</span>
<span class="fc" id="L153">                    m.put(&quot;usn&quot;, mCol.usn());</span>
                }
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23182)) {</span>
                    // TODO: fix empty id problem on _updaterequired (needed for model adding)
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">                    if (templates) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(23181)) {</span>
<span class="nc" id="L159">                            _syncTemplates(m);</span>
                        }
                    }
                }
            }
        }
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23184)) {</span>
<span class="fc" id="L166">            mChanged = true;</span>
        }
<span class="fc" id="L168">    }</span>

    /**
     * Flush the registry if any models were changed.
     */
    public void flush() {
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23191)) {</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">            if (mChanged) {</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23185)) {</span>
<span class="fc" id="L177">                    ensureNotEmpty();</span>
                }
<span class="fc" id="L179">                JSONObject array = new JSONObject();</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23187)) {</span>
                    {
<span class="fc" id="L182">                        long _loopCounter570 = 0;</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">                        for (Map.Entry&lt;Long, Model&gt; o : mModels.entrySet()) {</span>
<span class="fc" id="L184">                            ListenerUtil.loopListener.listen(&quot;_loopCounter570&quot;, ++_loopCounter570);</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23186)) {</span>
<span class="fc" id="L186">                                array.put(Long.toString(o.getKey()), o.getValue());</span>
                            }
<span class="fc" id="L188">                        }</span>
                    }
                }
<span class="fc" id="L191">                ContentValues val = new ContentValues();</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23188)) {</span>
<span class="fc" id="L193">                    val.put(&quot;models&quot;, Utils.jsonToString(array));</span>
                }
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23189)) {</span>
<span class="fc" id="L196">                    mCol.getDb().update(&quot;col&quot;, val);</span>
                }
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23190)) {</span>
<span class="fc" id="L199">                    mChanged = false;</span>
                }
            }
        }
<span class="fc" id="L203">    }</span>

    public boolean ensureNotEmpty() {
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">        if (mModels.isEmpty()) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23192)) {</span>
                // TODO: Maybe we want to restore all models if we don't have any
<span class="nc" id="L209">                StdModels.basicModel.add(mCol);</span>
            }
<span class="nc" id="L211">            return true;</span>
        } else {
<span class="fc" id="L213">            return false;</span>
        }
    }

    /**
     * Get current model.
     * @return The model, or null if not found in the deck and in the configuration.
     */
    public Model current() {
<span class="fc" id="L222">        return current(true);</span>
    }

    /**
     * Get current model.
     * @param forDeck If true, it tries to get the deck specified in deck by mid, otherwise or if the former is not
     *                found, it uses the configuration`s field curModel.
     * @return The model, or null if not found in the deck and in the configuration.
     */
    public Model current(boolean forDeck) {
<span class="fc" id="L232">        Model m = null;</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23194)) {</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">            if (forDeck) {</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23193)) {</span>
<span class="fc" id="L236">                    m = get(mCol.getDecks().current().optLong(&quot;mid&quot;, -1));</span>
                }
            }
        }
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23196)) {</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">            if (m == null) {</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23195)) {</span>
<span class="fc" id="L243">                    m = get(mCol.getConf().optLong(&quot;curModel&quot;, -1));</span>
                }
            }
        }
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23199)) {</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">            if (m == null) {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23198)) {</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">                    if (!mModels.isEmpty()) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(23197)) {</span>
<span class="nc" id="L252">                            m = mModels.values().iterator().next();</span>
                        }
                    }
                }
            }
        }
<span class="fc" id="L258">        return m;</span>
    }

    public void setCurrent(Model m) {
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23200)) {</span>
<span class="fc" id="L263">            mCol.getConf().put(&quot;curModel&quot;, m.getLong(&quot;id&quot;));</span>
        }
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23201)) {</span>
<span class="fc" id="L266">            mCol.setMod();</span>
        }
<span class="fc" id="L268">    }</span>

    /**
     * get model with ID, or null.
     */
    @Nullable
    public Model get(@NonNull Long id) {
<span class="fc bfc" id="L275" title="All 2 branches covered.">        if (mModels.containsKey(id)) {</span>
<span class="fc" id="L276">            return mModels.get(id);</span>
        } else {
<span class="fc" id="L278">            return null;</span>
        }
    }

    /**
     * get all models
     */
    public ArrayList&lt;Model&gt; all() {
<span class="nc" id="L286">        return new ArrayList&lt;&gt;(mModels.values());</span>
    }

    /**
     * get model with NAME.
     */
    public Model byName(String name) {
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23203)) {</span>
            {
<span class="fc" id="L295">                long _loopCounter571 = 0;</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">                for (Model m : mModels.values()) {</span>
<span class="fc" id="L297">                    ListenerUtil.loopListener.listen(&quot;_loopCounter571&quot;, ++_loopCounter571);</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23202)) {</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">                        if (m.getString(&quot;name&quot;).equals(name)) {</span>
<span class="fc" id="L300">                            return m;</span>
                        }
                    }
<span class="fc" id="L303">                }</span>
            }
        }
<span class="fc" id="L306">        return null;</span>
    }

    // not in python. Thus the method has to be renamed.
    public Model newModel(String name) {
        // caller should call save() after modifying
<span class="fc" id="L312">        Model m = new Model(defaultModel);</span>
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23204)) {</span>
<span class="fc" id="L314">            m.put(&quot;name&quot;, name);</span>
        }
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23205)) {</span>
<span class="fc" id="L317">            m.put(&quot;mod&quot;, mCol.getTime().intTime());</span>
        }
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23206)) {</span>
<span class="fc" id="L320">            m.put(&quot;flds&quot;, new JSONArray());</span>
        }
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23207)) {</span>
<span class="fc" id="L323">            m.put(&quot;tmpls&quot;, new JSONArray());</span>
        }
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23208)) {</span>
<span class="fc" id="L326">            m.put(&quot;tags&quot;, new JSONArray());</span>
        }
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23209)) {</span>
<span class="fc" id="L329">            m.put(&quot;id&quot;, 0);</span>
        }
<span class="fc" id="L331">        return m;</span>
    }

    // not in anki
    public static boolean isModelNew(Model m) {
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        return m.getLong(&quot;id&quot;) == 0;</span>
    }

    /**
     * Delete model, and all its cards/notes.
     * @throws ConfirmModSchemaException
     */
    public void rem(Model m) throws ConfirmModSchemaException {
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23210)) {</span>
<span class="fc" id="L345">            mCol.modSchema();</span>
        }
<span class="fc" id="L347">        long id = m.getLong(&quot;id&quot;);</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">        boolean current = current().getLong(&quot;id&quot;) == id;</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23211)) {</span>
            // delete notes/cards
<span class="fc" id="L351">            mCol.remCards(mCol.getDb().queryLongList(&quot;SELECT id FROM cards WHERE nid IN (SELECT id FROM notes WHERE mid = ?)&quot;, id));</span>
        }
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23212)) {</span>
            // then the model
<span class="fc" id="L355">            mModels.remove(id);</span>
        }
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23213)) {</span>
<span class="fc" id="L358">            save();</span>
        }
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23215)) {</span>
            // GUI should ensure last model is not deleted
<span class="fc bfc" id="L362" title="All 2 branches covered.">            if (current) {</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23214)) {</span>
<span class="fc" id="L364">                    setCurrent(mModels.values().iterator().next());</span>
                }
            }
        }
<span class="fc" id="L368">    }</span>

    public void add(Model m) {
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23216)) {</span>
<span class="fc" id="L372">            _setID(m);</span>
        }
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23217)) {</span>
<span class="fc" id="L375">            update(m);</span>
        }
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23218)) {</span>
<span class="fc" id="L378">            setCurrent(m);</span>
        }
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23219)) {</span>
<span class="fc" id="L381">            save(m);</span>
        }
<span class="fc" id="L383">    }</span>

    /**
     * Add or update an existing model. Used for syncing and merging.
     */
    public void update(Model m) {
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23220)) {</span>
<span class="fc" id="L390">            mModels.put(m.getLong(&quot;id&quot;), m);</span>
        }
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23221)) {</span>
            // mark registry changed, but don't bump mod time
<span class="fc" id="L394">            save();</span>
        }
<span class="fc" id="L396">    }</span>

    private void _setID(Model m) {
<span class="fc" id="L399">        long id = mCol.getTime().intTimeMS();</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23223)) {</span>
            {
<span class="fc" id="L402">                long _loopCounter572 = 0;</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">                while (mModels.containsKey(id)) {</span>
<span class="nc" id="L404">                    ListenerUtil.loopListener.listen(&quot;_loopCounter572&quot;, ++_loopCounter572);</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23222)) {</span>
<span class="nc" id="L406">                        id = mCol.getTime().intTimeMS();</span>
                    }
                }
            }
        }
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23224)) {</span>
<span class="fc" id="L412">            m.put(&quot;id&quot;, id);</span>
        }
<span class="fc" id="L414">    }</span>

    public boolean have(@NonNull Long id) {
<span class="nc" id="L417">        return mModels.containsKey(id);</span>
    }

    public Set&lt;Long&gt; ids() {
<span class="nc" id="L421">        return mModels.keySet();</span>
    }

    /**
     * Note ids for M
     */
    public ArrayList&lt;Long&gt; nids(Model m) {
<span class="nc" id="L428">        return mCol.getDb().queryLongList(&quot;SELECT id FROM notes WHERE mid = ?&quot;, m.getLong(&quot;id&quot;));</span>
    }

    /**
     * Number of notes using m
     * @param m The model to the count the notes of.
     * @return The number of notes with that model.
     */
    public int useCount(Model m) {
<span class="nc" id="L437">        return mCol.getDb().queryScalar(&quot;select count() from notes where mid = ?&quot;, m.getLong(&quot;id&quot;));</span>
    }

    /**
     * Number of notes using m
     * @param m The model to the count the notes of.
     * @param ord The index of the card template
     * @return The number of notes with that model.
     */
    public int tmplUseCount(Model m, int ord) {
<span class="nc" id="L447">        return mCol.getDb().queryScalar(&quot;select count() from cards, notes where cards.nid = notes.id and notes.mid = ? and cards.ord = ?&quot;, m.getLong(&quot;id&quot;), ord);</span>
    }

    /**
     * Copy, save and return.
     */
    public Model copy(Model m) {
<span class="nc" id="L454">        Model m2 = m.deepClone();</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23225)) {</span>
<span class="nc" id="L456">            m2.put(&quot;name&quot;, m2.getString(&quot;name&quot;) + &quot; copy&quot;);</span>
        }
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23226)) {</span>
<span class="nc" id="L459">            add(m2);</span>
        }
<span class="nc" id="L461">        return m2;</span>
    }

    public JSONObject newField(String name) {
<span class="fc" id="L465">        JSONObject f = new JSONObject(defaultField);</span>
<span class="pc bpc" id="L466" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23227)) {</span>
<span class="fc" id="L467">            f.put(&quot;name&quot;, name);</span>
        }
<span class="fc" id="L469">        return f;</span>
    }

    /**
     * &quot;Mapping of field name -&gt; (ord, field).
     */
    @NonNull
    public static Map&lt;String, Pair&lt;Integer, JSONObject&gt;&gt; fieldMap(@NonNull Model m) {
<span class="fc" id="L477">        JSONArray flds = m.getJSONArray(&quot;flds&quot;);</span>
        // TreeMap&lt;Integer, String&gt; map = new TreeMap&lt;Integer, String&gt;();
<span class="fc" id="L479">        Map&lt;String, Pair&lt;Integer, JSONObject&gt;&gt; result = new HashMap&lt;&gt;(flds.length());</span>
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23229)) {</span>
            {
<span class="fc" id="L482">                long _loopCounter573 = 0;</span>
<span class="fc bfc" id="L483" title="All 2 branches covered.">                for (JSONObject f : flds.jsonObjectIterable()) {</span>
<span class="fc" id="L484">                    ListenerUtil.loopListener.listen(&quot;_loopCounter573&quot;, ++_loopCounter573);</span>
<span class="pc bpc" id="L485" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23228)) {</span>
<span class="fc" id="L486">                        result.put(f.getString(&quot;name&quot;), new Pair&lt;&gt;(f.getInt(&quot;ord&quot;), f));</span>
                    }
<span class="fc" id="L488">                }</span>
            }
        }
<span class="fc" id="L491">        return result;</span>
    }

    public int sortIdx(Model m) {
<span class="fc" id="L495">        return m.getInt(&quot;sortf&quot;);</span>
    }

    public void setSortIdx(Model m, int idx) throws ConfirmModSchemaException {
<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23230)) {</span>
<span class="nc" id="L500">            mCol.modSchema();</span>
        }
<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23231)) {</span>
<span class="nc" id="L503">            m.put(&quot;sortf&quot;, idx);</span>
        }
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23232)) {</span>
<span class="nc" id="L506">            mCol.updateFieldCache(nids(m));</span>
        }
<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23233)) {</span>
<span class="nc" id="L509">            save(m);</span>
        }
<span class="nc" id="L511">    }</span>

    private void _addField(Model m, JSONObject field) {
        // is not new.
<span class="fc" id="L515">        JSONArray flds = m.getJSONArray(&quot;flds&quot;);</span>
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23234)) {</span>
<span class="fc" id="L517">            flds.put(field);</span>
        }
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23235)) {</span>
<span class="fc" id="L520">            m.put(&quot;flds&quot;, flds);</span>
        }
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23236)) {</span>
<span class="fc" id="L523">            _updateFieldOrds(m);</span>
        }
<span class="pc bpc" id="L525" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23237)) {</span>
<span class="fc" id="L526">            save(m);</span>
        }
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23238)) {</span>
<span class="fc" id="L529">            _transformFields(m, new TransformFieldAdd());</span>
        }
<span class="fc" id="L531">    }</span>

    public void addField(Model m, JSONObject field) throws ConfirmModSchemaException {
<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23240)) {</span>
            // this is Anki's addField.
<span class="nc bnc" id="L536" title="All 2 branches missed.">            if (!isModelNew(m)) {</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23239)) {</span>
<span class="nc" id="L538">                    mCol.modSchema();</span>
                }
            }
        }
<span class="nc bnc" id="L542" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23241)) {</span>
<span class="nc" id="L543">            _addField(m, field);</span>
        }
<span class="nc" id="L545">    }</span>

    public void addFieldInNewModel(Model m, JSONObject field) {
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23242)) {</span>
            // ConfirmModSchemaException.
<span class="fc" id="L550">            Assert.that(isModelNew(m), &quot;Model was assumed to be new, but is not&quot;);</span>
        }
<span class="pc bpc" id="L552" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23243)) {</span>
<span class="fc" id="L553">            _addField(m, field);</span>
        }
<span class="fc" id="L555">    }</span>

    public void addFieldModChanged(Model m, JSONObject field) {
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23244)) {</span>
            // ConfirmModSchemaException.
<span class="nc" id="L560">            Assert.that(mCol.schemaChanged(), &quot;Mod was assumed to be already changed, but is not&quot;);</span>
        }
<span class="nc bnc" id="L562" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23245)) {</span>
<span class="nc" id="L563">            _addField(m, field);</span>
        }
<span class="nc" id="L565">    }</span>

<span class="fc" id="L567">    static class TransformFieldAdd implements TransformFieldVisitor {</span>

        @Override
        public String[] transform(String[] fields) {
<span class="nc bnc" id="L571" title="All 8 branches missed.">            String[] f = new String[(ListenerUtil.mutListener.listen(23249) ? (fields.length % 1) : (ListenerUtil.mutListener.listen(23248) ? (fields.length / 1) : (ListenerUtil.mutListener.listen(23247) ? (fields.length * 1) : (ListenerUtil.mutListener.listen(23246) ? (fields.length - 1) : (fields.length + 1)))))];</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23250)) {</span>
<span class="nc" id="L573">                System.arraycopy(fields, 0, f, 0, fields.length);</span>
            }
<span class="nc bnc" id="L575" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23251)) {</span>
<span class="nc" id="L576">                f[fields.length] = &quot;&quot;;</span>
            }
<span class="nc" id="L578">            return f;</span>
        }
    }

    public void remField(Model m, JSONObject field) throws ConfirmModSchemaException {
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23252)) {</span>
<span class="nc" id="L584">            mCol.modSchema();</span>
        }
<span class="nc" id="L586">        JSONArray flds = m.getJSONArray(&quot;flds&quot;);</span>
<span class="nc" id="L587">        JSONArray flds2 = new JSONArray();</span>
<span class="nc" id="L588">        int idx = -1;</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23261)) {</span>
            {
<span class="nc" id="L591">                long _loopCounter574 = 0;</span>
<span class="nc bnc" id="L592" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23260) ? (i &gt;= flds.length()) : (ListenerUtil.mutListener.listen(23259) ? (i &lt;= flds.length()) : (ListenerUtil.mutListener.listen(23258) ? (i &gt; flds.length()) : (ListenerUtil.mutListener.listen(23257) ? (i != flds.length()) : (ListenerUtil.mutListener.listen(23256) ? (i == flds.length()) : (i &lt; flds.length())))))); ++i) {</span>
<span class="nc" id="L593">                    ListenerUtil.loopListener.listen(&quot;_loopCounter574&quot;, ++_loopCounter574);</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23254)) {</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                        if (field.equals(flds.getJSONObject(i))) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23253)) {</span>
<span class="nc" id="L597">                                idx = i;</span>
                            }
                            continue;
                        }
                    }
<span class="nc bnc" id="L602" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23255)) {</span>
<span class="nc" id="L603">                        flds2.put(flds.getJSONObject(i));</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23262)) {</span>
<span class="nc" id="L609">            m.put(&quot;flds&quot;, flds2);</span>
        }
<span class="nc" id="L611">        int sortf = m.getInt(&quot;sortf&quot;);</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23273)) {</span>
<span class="nc bnc" id="L613" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(23267) ? (sortf &lt;= m.getJSONArray(&quot;flds&quot;).length()) : (ListenerUtil.mutListener.listen(23266) ? (sortf &gt; m.getJSONArray(&quot;flds&quot;).length()) : (ListenerUtil.mutListener.listen(23265) ? (sortf &lt; m.getJSONArray(&quot;flds&quot;).length()) : (ListenerUtil.mutListener.listen(23264) ? (sortf != m.getJSONArray(&quot;flds&quot;).length()) : (ListenerUtil.mutListener.listen(23263) ? (sortf == m.getJSONArray(&quot;flds&quot;).length()) : (sortf &gt;= m.getJSONArray(&quot;flds&quot;).length()))))))) {</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23272)) {</span>
<span class="nc bnc" id="L615" title="All 8 branches missed.">                    m.put(&quot;sortf&quot;, (ListenerUtil.mutListener.listen(23271) ? (sortf % 1) : (ListenerUtil.mutListener.listen(23270) ? (sortf / 1) : (ListenerUtil.mutListener.listen(23269) ? (sortf * 1) : (ListenerUtil.mutListener.listen(23268) ? (sortf + 1) : (sortf - 1))))));</span>
                }
            }
        }
<span class="nc bnc" id="L619" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23274)) {</span>
<span class="nc" id="L620">            _updateFieldOrds(m);</span>
        }
<span class="nc bnc" id="L622" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23275)) {</span>
<span class="nc" id="L623">            _transformFields(m, new TransformFieldDelete(idx));</span>
        }
<span class="nc bnc" id="L625" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23282)) {</span>
<span class="nc bnc" id="L626" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(23280) ? (idx &gt;= sortIdx(m)) : (ListenerUtil.mutListener.listen(23279) ? (idx &lt;= sortIdx(m)) : (ListenerUtil.mutListener.listen(23278) ? (idx &gt; sortIdx(m)) : (ListenerUtil.mutListener.listen(23277) ? (idx &lt; sortIdx(m)) : (ListenerUtil.mutListener.listen(23276) ? (idx != sortIdx(m)) : (idx == sortIdx(m)))))))) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23281)) {</span>
                    // need to rebuild
<span class="nc" id="L629">                    mCol.updateFieldCache(nids(m));</span>
                }
            }
        }
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23283)) {</span>
<span class="nc" id="L634">            renameField(m, field, null);</span>
        }
<span class="nc" id="L636">    }</span>

    static class TransformFieldDelete implements TransformFieldVisitor {

        private final int idx;

<span class="nc" id="L642">        public TransformFieldDelete(int _idx) {</span>
<span class="nc" id="L643">            idx = _idx;</span>
<span class="nc" id="L644">        }</span>

        @Override
        public String[] transform(String[] fields) {
<span class="nc" id="L648">            ArrayList&lt;String&gt; fl = new ArrayList&lt;&gt;(Arrays.asList(fields));</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23284)) {</span>
<span class="nc" id="L650">                fl.remove(idx);</span>
            }
<span class="nc" id="L652">            return fl.toArray(new String[fl.size()]);</span>
        }
    }

    public void moveField(Model m, JSONObject field, int idx) throws ConfirmModSchemaException {
<span class="nc bnc" id="L657" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23285)) {</span>
<span class="nc" id="L658">            mCol.modSchema();</span>
        }
<span class="nc" id="L660">        JSONArray flds = m.getJSONArray(&quot;flds&quot;);</span>
<span class="nc" id="L661">        ArrayList&lt;JSONObject&gt; l = new ArrayList&lt;&gt;(flds.length());</span>
<span class="nc" id="L662">        int oldidx = -1;</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23300)) {</span>
            {
<span class="nc" id="L665">                long _loopCounter575 = 0;</span>
<span class="nc bnc" id="L666" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23299) ? (i &gt;= flds.length()) : (ListenerUtil.mutListener.listen(23298) ? (i &lt;= flds.length()) : (ListenerUtil.mutListener.listen(23297) ? (i &gt; flds.length()) : (ListenerUtil.mutListener.listen(23296) ? (i != flds.length()) : (ListenerUtil.mutListener.listen(23295) ? (i == flds.length()) : (i &lt; flds.length())))))); ++i) {</span>
<span class="nc" id="L667">                    ListenerUtil.loopListener.listen(&quot;_loopCounter575&quot;, ++_loopCounter575);</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23286)) {</span>
<span class="nc" id="L669">                        l.add(flds.getJSONObject(i));</span>
                    }
<span class="nc bnc" id="L671" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23294)) {</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">                        if (field.equals(flds.getJSONObject(i))) {</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23287)) {</span>
<span class="nc" id="L674">                                oldidx = i;</span>
                            }
<span class="nc bnc" id="L676" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23293)) {</span>
<span class="nc bnc" id="L677" title="All 22 branches missed.">                                if ((ListenerUtil.mutListener.listen(23292) ? (idx &gt;= oldidx) : (ListenerUtil.mutListener.listen(23291) ? (idx &lt;= oldidx) : (ListenerUtil.mutListener.listen(23290) ? (idx &gt; oldidx) : (ListenerUtil.mutListener.listen(23289) ? (idx &lt; oldidx) : (ListenerUtil.mutListener.listen(23288) ? (idx != oldidx) : (idx == oldidx))))))) {</span>
<span class="nc" id="L678">                                    return;</span>
                                }
                            }
                        }
                    }
                }
            }
        }
        // remember old sort field
<span class="nc" id="L687">        String sortf = Utils.jsonToString(m.getJSONArray(&quot;flds&quot;).getJSONObject(m.getInt(&quot;sortf&quot;)));</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23301)) {</span>
            // move
<span class="nc" id="L690">            l.remove(oldidx);</span>
        }
<span class="nc bnc" id="L692" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23302)) {</span>
<span class="nc" id="L693">            l.add(idx, field);</span>
        }
<span class="nc bnc" id="L695" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23303)) {</span>
<span class="nc" id="L696">            m.put(&quot;flds&quot;, new JSONArray(l));</span>
        }
<span class="nc bnc" id="L698" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23304)) {</span>
            // restore sort field
<span class="nc" id="L700">            flds = m.getJSONArray(&quot;flds&quot;);</span>
        }
<span class="nc bnc" id="L702" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23312)) {</span>
            {
<span class="nc" id="L704">                long _loopCounter576 = 0;</span>
<span class="nc bnc" id="L705" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23311) ? (i &gt;= flds.length()) : (ListenerUtil.mutListener.listen(23310) ? (i &lt;= flds.length()) : (ListenerUtil.mutListener.listen(23309) ? (i &gt; flds.length()) : (ListenerUtil.mutListener.listen(23308) ? (i != flds.length()) : (ListenerUtil.mutListener.listen(23307) ? (i == flds.length()) : (i &lt; flds.length())))))); ++i) {</span>
<span class="nc" id="L706">                    ListenerUtil.loopListener.listen(&quot;_loopCounter576&quot;, ++_loopCounter576);</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23306)) {</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                        if (Utils.jsonToString(flds.getJSONObject(i)).equals(sortf)) {</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23305)) {</span>
<span class="nc" id="L710">                                m.put(&quot;sortf&quot;, i);</span>
                            }
                            break;
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L718" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23313)) {</span>
<span class="nc" id="L719">            _updateFieldOrds(m);</span>
        }
<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23314)) {</span>
<span class="nc" id="L722">            save(m);</span>
        }
<span class="nc bnc" id="L724" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23315)) {</span>
<span class="nc" id="L725">            _transformFields(m, new TransformFieldMove(idx, oldidx));</span>
        }
<span class="nc" id="L727">    }</span>

    static class TransformFieldMove implements TransformFieldVisitor {

        private final int idx;

        private final int oldidx;

<span class="nc" id="L735">        public TransformFieldMove(int _idx, int _oldidx) {</span>
<span class="nc" id="L736">            idx = _idx;</span>
<span class="nc" id="L737">            oldidx = _oldidx;</span>
<span class="nc" id="L738">        }</span>

        @Override
        public String[] transform(String[] fields) {
<span class="nc" id="L742">            String val = fields[oldidx];</span>
<span class="nc" id="L743">            ArrayList&lt;String&gt; fl = new ArrayList&lt;&gt;(Arrays.asList(fields));</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23316)) {</span>
<span class="nc" id="L745">                fl.remove(oldidx);</span>
            }
<span class="nc bnc" id="L747" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23317)) {</span>
<span class="nc" id="L748">                fl.add(idx, val);</span>
            }
<span class="nc" id="L750">            return fl.toArray(new String[fl.size()]);</span>
        }
    }

    public void renameField(Model m, JSONObject field, String newName) throws ConfirmModSchemaException {
<span class="nc bnc" id="L755" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23318)) {</span>
<span class="nc" id="L756">            mCol.modSchema();</span>
        }
<span class="nc" id="L758">        String pat = String.format(&quot;\\{\\{([^{}]*)([:#^/]|[^:#/^}][^:}]*?:|)%s\\}\\}&quot;, Pattern.quote(field.getString(&quot;name&quot;)));</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23320)) {</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">            if (newName == null) {</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23319)) {</span>
<span class="nc" id="L762">                    newName = &quot;&quot;;</span>
                }
            }
        }
<span class="nc" id="L766">        String repl = &quot;{{$1$2&quot; + newName + &quot;}}&quot;;</span>
<span class="nc" id="L767">        JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23325)) {</span>
            {
<span class="nc" id="L770">                long _loopCounter578 = 0;</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">                for (JSONObject t : tmpls.jsonObjectIterable()) {</span>
<span class="nc" id="L772">                    ListenerUtil.loopListener.listen(&quot;_loopCounter578&quot;, ++_loopCounter578);</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23324)) {</span>
                        {
<span class="nc" id="L775">                            long _loopCounter577 = 0;</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">                            for (String fmt : new String[] { &quot;qfmt&quot;, &quot;afmt&quot; }) {</span>
<span class="nc" id="L777">                                ListenerUtil.loopListener.listen(&quot;_loopCounter577&quot;, ++_loopCounter577);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23323)) {</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">                                    if (!&quot;&quot;.equals(newName)) {</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23322)) {</span>
<span class="nc" id="L781">                                            t.put(fmt, t.getString(fmt).replaceAll(pat, repl));</span>
                                        }
                                    } else {
<span class="nc bnc" id="L784" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23321)) {</span>
<span class="nc" id="L785">                                            t.put(fmt, t.getString(fmt).replaceAll(pat, &quot;&quot;));</span>
                                        }
                                    }
                                }
                            }
                        }
                    }
<span class="nc" id="L792">                }</span>
            }
        }
<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23326)) {</span>
<span class="nc" id="L796">            field.put(&quot;name&quot;, newName);</span>
        }
<span class="nc bnc" id="L798" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23327)) {</span>
<span class="nc" id="L799">            save(m);</span>
        }
<span class="nc" id="L801">    }</span>

    public void _updateFieldOrds(JSONObject m) {
<span class="fc" id="L804">        JSONArray flds = m.getJSONArray(&quot;flds&quot;);</span>
<span class="pc bpc" id="L805" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23334)) {</span>
            {
<span class="fc" id="L807">                long _loopCounter579 = 0;</span>
<span class="pc bpc" id="L808" title="15 of 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23333) ? (i &gt;= flds.length()) : (ListenerUtil.mutListener.listen(23332) ? (i &lt;= flds.length()) : (ListenerUtil.mutListener.listen(23331) ? (i &gt; flds.length()) : (ListenerUtil.mutListener.listen(23330) ? (i != flds.length()) : (ListenerUtil.mutListener.listen(23329) ? (i == flds.length()) : (i &lt; flds.length())))))); i++) {</span>
<span class="fc" id="L809">                    ListenerUtil.loopListener.listen(&quot;_loopCounter579&quot;, ++_loopCounter579);</span>
<span class="fc" id="L810">                    JSONObject f = flds.getJSONObject(i);</span>
<span class="pc bpc" id="L811" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23328)) {</span>
<span class="fc" id="L812">                        f.put(&quot;ord&quot;, i);</span>
                    }
                }
            }
        }
<span class="fc" id="L817">    }</span>

    interface TransformFieldVisitor {

        String[] transform(String[] fields);
    }

    public void _transformFields(Model m, TransformFieldVisitor fn) {
<span class="pc bpc" id="L825" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23335)) {</span>
            // model hasn't been added yet?
<span class="pc bpc" id="L827" title="1 of 2 branches missed.">            if (isModelNew(m)) {</span>
<span class="fc" id="L828">                return;</span>
            }
        }
<span class="nc" id="L831">        ArrayList&lt;Object[]&gt; r = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L832">        try (Cursor cur = mCol.getDb().query(&quot;select id, flds from notes where mid = ?&quot;, m.getLong(&quot;id&quot;))) {</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23337)) {</span>
                {
<span class="nc" id="L835">                    long _loopCounter580 = 0;</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L837">                        ListenerUtil.loopListener.listen(&quot;_loopCounter580&quot;, ++_loopCounter580);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(23336)) {</span>
<span class="nc" id="L839">                            r.add(new Object[] { Utils.joinFields(fn.transform(Utils.splitFields(cur.getString(1)))), mCol.getTime().intTime(), mCol.usn(), cur.getLong(0) });</span>
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L845" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23338)) {</span>
<span class="nc" id="L846">            mCol.getDb().executeMany(&quot;update notes set flds=?,mod=?,usn=? where id = ?&quot;, r);</span>
        }
<span class="nc" id="L848">    }</span>

    public static JSONObject newTemplate(String name) {
<span class="fc" id="L851">        JSONObject t = new JSONObject(defaultTemplate);</span>
<span class="pc bpc" id="L852" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23339)) {</span>
<span class="fc" id="L853">            t.put(&quot;name&quot;, name);</span>
        }
<span class="fc" id="L855">        return t;</span>
    }

    /**
     * Note: should col.genCards() afterwards.
     */
    private void _addTemplate(Model m, JSONObject template) {
        // model is new or not.
<span class="fc" id="L863">        JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="pc bpc" id="L864" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23340)) {</span>
<span class="fc" id="L865">            tmpls.put(template);</span>
        }
<span class="pc bpc" id="L867" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23341)) {</span>
<span class="fc" id="L868">            m.put(&quot;tmpls&quot;, tmpls);</span>
        }
<span class="pc bpc" id="L870" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23342)) {</span>
<span class="fc" id="L871">            _updateTemplOrds(m);</span>
        }
<span class="pc bpc" id="L873" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23343)) {</span>
<span class="fc" id="L874">            save(m);</span>
        }
<span class="fc" id="L876">    }</span>

    /**
     * @throws ConfirmModSchemaException
     */
    public void addTemplate(Model m, JSONObject template) throws ConfirmModSchemaException {
<span class="nc bnc" id="L882" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23345)) {</span>
            // That is Anki's addTemplate method
<span class="nc bnc" id="L884" title="All 2 branches missed.">            if (!isModelNew(m)) {</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23344)) {</span>
<span class="nc" id="L886">                    mCol.modSchema();</span>
                }
            }
        }
<span class="nc bnc" id="L890" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23346)) {</span>
<span class="nc" id="L891">            _addTemplate(m, template);</span>
        }
<span class="nc" id="L893">    }</span>

    public void addTemplateInNewModel(Model m, JSONObject template) {
<span class="pc bpc" id="L896" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23347)) {</span>
            // asserting the model is new.
<span class="fc" id="L898">            Assert.that(isModelNew(m), &quot;Model was assumed to be new, but is not&quot;);</span>
        }
<span class="pc bpc" id="L900" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23348)) {</span>
<span class="fc" id="L901">            _addTemplate(m, template);</span>
        }
<span class="fc" id="L903">    }</span>

    public void addTemplateModChanged(Model m, JSONObject template) {
<span class="nc bnc" id="L906" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23349)) {</span>
            // asserting the model is new.
<span class="nc" id="L908">            Assert.that(mCol.schemaChanged(), &quot;Mod was assumed to be already changed, but is not&quot;);</span>
        }
<span class="nc bnc" id="L910" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23350)) {</span>
<span class="nc" id="L911">            _addTemplate(m, template);</span>
        }
<span class="nc" id="L913">    }</span>

    /**
     * Removing a template
     *
     * @return False if removing template would leave orphan notes.
     * @throws ConfirmModSchemaException
     */
    public boolean remTemplate(Model m, JSONObject template) throws ConfirmModSchemaException {
<span class="nc bnc" id="L922" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23356)) {</span>
<span class="nc bnc" id="L923" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(23355) ? (m.getJSONArray(&quot;tmpls&quot;).length() &gt;= 1) : (ListenerUtil.mutListener.listen(23354) ? (m.getJSONArray(&quot;tmpls&quot;).length() &gt; 1) : (ListenerUtil.mutListener.listen(23353) ? (m.getJSONArray(&quot;tmpls&quot;).length() &lt; 1) : (ListenerUtil.mutListener.listen(23352) ? (m.getJSONArray(&quot;tmpls&quot;).length() != 1) : (ListenerUtil.mutListener.listen(23351) ? (m.getJSONArray(&quot;tmpls&quot;).length() == 1) : (m.getJSONArray(&quot;tmpls&quot;).length() &lt;= 1))))))) {</span>
<span class="nc" id="L924">                return false;</span>
            }
        }
        // find cards using this template
<span class="nc" id="L928">        JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc" id="L929">        int ord = -1;</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23364)) {</span>
            {
<span class="nc" id="L932">                long _loopCounter581 = 0;</span>
<span class="nc bnc" id="L933" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23363) ? (i &gt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23362) ? (i &lt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23361) ? (i &gt; tmpls.length()) : (ListenerUtil.mutListener.listen(23360) ? (i != tmpls.length()) : (ListenerUtil.mutListener.listen(23359) ? (i == tmpls.length()) : (i &lt; tmpls.length())))))); ++i) {</span>
<span class="nc" id="L934">                    ListenerUtil.loopListener.listen(&quot;_loopCounter581&quot;, ++_loopCounter581);</span>
<span class="nc bnc" id="L935" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23358)) {</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">                        if (tmpls.getJSONObject(i).equals(template)) {</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23357)) {</span>
<span class="nc" id="L938">                                ord = i;</span>
                            }
                            break;
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L946" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23370)) {</span>
<span class="nc bnc" id="L947" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(23369) ? (ord &gt;= -1) : (ListenerUtil.mutListener.listen(23368) ? (ord &lt;= -1) : (ListenerUtil.mutListener.listen(23367) ? (ord &gt; -1) : (ListenerUtil.mutListener.listen(23366) ? (ord &lt; -1) : (ListenerUtil.mutListener.listen(23365) ? (ord != -1) : (ord == -1))))))) {</span>
<span class="nc" id="L948">                throw new IllegalArgumentException(&quot;Invalid template proposed for delete&quot;);</span>
            }
        }
        // the code in &quot;isRemTemplateSafe&quot; was in place here in libanki. It is extracted to a method for reuse
<span class="nc" id="L952">        List&lt;Long&gt; cids = getCardIdsForModel(m.getLong(&quot;id&quot;), new int[] { ord });</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23372)) {</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">            if (cids == null) {</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23371)) {</span>
<span class="nc" id="L956">                    Timber.d(&quot;remTemplate getCardIdsForModel determined it was unsafe to delete the template&quot;);</span>
                }
<span class="nc" id="L958">                return false;</span>
            }
        }
<span class="nc bnc" id="L961" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23373)) {</span>
            // ok to proceed; remove cards
<span class="nc" id="L963">            Timber.d(&quot;remTemplate proceeding to delete the template and %d cards&quot;, cids.size());</span>
        }
<span class="nc bnc" id="L965" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23374)) {</span>
<span class="nc" id="L966">            mCol.modSchema();</span>
        }
<span class="nc bnc" id="L968" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23375)) {</span>
<span class="nc" id="L969">            mCol.remCards(cids);</span>
        }
<span class="nc bnc" id="L971" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23376)) {</span>
            // shift ordinals
<span class="nc" id="L973">            mCol.getDb().execute(&quot;update cards set ord = ord - 1, usn = ?, mod = ? where nid in (select id from notes where mid = ?) and ord &gt; ?&quot;, mCol.usn(), mCol.getTime().intTime(), m.getLong(&quot;id&quot;), ord);</span>
        }
<span class="nc bnc" id="L975" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23377)) {</span>
<span class="nc" id="L976">            tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
        }
<span class="nc" id="L978">        JSONArray tmpls2 = new JSONArray();</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23385)) {</span>
            {
<span class="nc" id="L981">                long _loopCounter582 = 0;</span>
<span class="nc bnc" id="L982" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23384) ? (i &gt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23383) ? (i &lt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23382) ? (i &gt; tmpls.length()) : (ListenerUtil.mutListener.listen(23381) ? (i != tmpls.length()) : (ListenerUtil.mutListener.listen(23380) ? (i == tmpls.length()) : (i &lt; tmpls.length())))))); ++i) {</span>
<span class="nc" id="L983">                    ListenerUtil.loopListener.listen(&quot;_loopCounter582&quot;, ++_loopCounter582);</span>
<span class="nc bnc" id="L984" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23378)) {</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">                        if (template.equals(tmpls.getJSONObject(i))) {</span>
<span class="nc" id="L986">                            continue;</span>
                        }
                    }
<span class="nc bnc" id="L989" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23379)) {</span>
<span class="nc" id="L990">                        tmpls2.put(tmpls.getJSONObject(i));</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L995" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23386)) {</span>
<span class="nc" id="L996">            m.put(&quot;tmpls&quot;, tmpls2);</span>
        }
<span class="nc bnc" id="L998" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23387)) {</span>
<span class="nc" id="L999">            _updateTemplOrds(m);</span>
        }
<span class="nc bnc" id="L1001" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23388)) {</span>
<span class="nc" id="L1002">            save(m);</span>
        }
<span class="nc bnc" id="L1004" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23389)) {</span>
<span class="nc" id="L1005">            Timber.d(&quot;remTemplate done working&quot;);</span>
        }
<span class="nc" id="L1007">        return true;</span>
    }

    /**
     * Extracted from remTemplate so we can test if removing templates is safe without actually removing them
     * This method will either give you all the card ids for the ordinals sent in related to the model sent in *or*
     * it will return null if the result of deleting the ordinals is unsafe because it would leave notes with no cards
     *
     * @param modelId long id of the JSON model
     * @param ords array of ints, each one is the ordinal a the card template in the given model
     * @return null if deleting ords would orphan notes, long[] of related card ids to delete if it is safe
     */
    @Nullable
    public List&lt;Long&gt; getCardIdsForModel(long modelId, int[] ords) {
<span class="nc" id="L1021">        String cardIdsToDeleteSql = &quot;select c2.id from cards c2, notes n2 where c2.nid=n2.id and n2.mid = ? and c2.ord  in &quot; + Utils.ids2str(ords);</span>
<span class="nc" id="L1022">        List&lt;Long&gt; cids = mCol.getDb().queryLongList(cardIdsToDeleteSql, modelId);</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23390)) {</span>
            // Timber.d(&quot;cardIdsToDeleteSql was ' %s' and got %s&quot;, cardIdsToDeleteSql, Utils.ids2str(cids));
<span class="nc" id="L1025">            Timber.d(&quot;getCardIdsForModel found %s cards to delete for model %s and ords %s&quot;, cids.size(), modelId, Utils.ids2str(ords));</span>
        }
        // all notes with this template must have at least two cards, or we could end up creating orphaned notes
<span class="nc" id="L1028">        String noteCountPreDeleteSql = &quot;select count(distinct(nid)) from cards where nid in (select id from notes where mid = ?)&quot;;</span>
<span class="nc" id="L1029">        int preDeleteNoteCount = mCol.getDb().queryScalar(noteCountPreDeleteSql, modelId);</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23391)) {</span>
<span class="nc" id="L1031">            Timber.d(&quot;noteCountPreDeleteSql was '%s'&quot;, noteCountPreDeleteSql);</span>
        }
<span class="nc bnc" id="L1033" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23392)) {</span>
<span class="nc" id="L1034">            Timber.d(&quot;preDeleteNoteCount is %s&quot;, preDeleteNoteCount);</span>
        }
<span class="nc" id="L1036">        String noteCountPostDeleteSql = &quot;select count(distinct(nid)) from cards where nid in (select id from notes where mid = ?) and ord not in &quot; + Utils.ids2str(ords);</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23393)) {</span>
<span class="nc" id="L1038">            Timber.d(&quot;noteCountPostDeleteSql was '%s'&quot;, noteCountPostDeleteSql);</span>
        }
<span class="nc" id="L1040">        int postDeleteNoteCount = mCol.getDb().queryScalar(noteCountPostDeleteSql, modelId);</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23394)) {</span>
<span class="nc" id="L1042">            Timber.d(&quot;postDeleteNoteCount would be %s&quot;, postDeleteNoteCount);</span>
        }
<span class="nc bnc" id="L1044" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23401)) {</span>
<span class="nc bnc" id="L1045" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(23399) ? (preDeleteNoteCount &gt;= postDeleteNoteCount) : (ListenerUtil.mutListener.listen(23398) ? (preDeleteNoteCount &lt;= postDeleteNoteCount) : (ListenerUtil.mutListener.listen(23397) ? (preDeleteNoteCount &gt; postDeleteNoteCount) : (ListenerUtil.mutListener.listen(23396) ? (preDeleteNoteCount &lt; postDeleteNoteCount) : (ListenerUtil.mutListener.listen(23395) ? (preDeleteNoteCount == postDeleteNoteCount) : (preDeleteNoteCount != postDeleteNoteCount))))))) {</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23400)) {</span>
<span class="nc" id="L1047">                    Timber.d(&quot;There will be orphan notes if these cards are deleted.&quot;);</span>
                }
<span class="nc" id="L1049">                return null;</span>
            }
        }
<span class="nc bnc" id="L1052" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23402)) {</span>
<span class="nc" id="L1053">            Timber.d(&quot;Deleting these cards will not orphan notes.&quot;);</span>
        }
<span class="nc" id="L1055">        return cids;</span>
    }

    public static void _updateTemplOrds(Model m) {
<span class="fc" id="L1059">        JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="pc bpc" id="L1060" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23409)) {</span>
            {
<span class="fc" id="L1062">                long _loopCounter583 = 0;</span>
<span class="pc bpc" id="L1063" title="15 of 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23408) ? (i &gt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23407) ? (i &lt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23406) ? (i &gt; tmpls.length()) : (ListenerUtil.mutListener.listen(23405) ? (i != tmpls.length()) : (ListenerUtil.mutListener.listen(23404) ? (i == tmpls.length()) : (i &lt; tmpls.length())))))); i++) {</span>
<span class="fc" id="L1064">                    ListenerUtil.loopListener.listen(&quot;_loopCounter583&quot;, ++_loopCounter583);</span>
<span class="fc" id="L1065">                    JSONObject f = tmpls.getJSONObject(i);</span>
<span class="pc bpc" id="L1066" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23403)) {</span>
<span class="fc" id="L1067">                        f.put(&quot;ord&quot;, i);</span>
                    }
                }
            }
        }
<span class="fc" id="L1072">    }</span>

    public void moveTemplate(Model m, JSONObject template, int idx) {
<span class="nc" id="L1075">        JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc" id="L1076">        int oldidx = -1;</span>
<span class="nc" id="L1077">        ArrayList&lt;JSONObject&gt; l = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1078">        HashMap&lt;Integer, Integer&gt; oldidxs = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23425)) {</span>
            {
<span class="nc" id="L1081">                long _loopCounter584 = 0;</span>
<span class="nc bnc" id="L1082" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23424) ? (i &gt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23423) ? (i &lt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23422) ? (i &gt; tmpls.length()) : (ListenerUtil.mutListener.listen(23421) ? (i != tmpls.length()) : (ListenerUtil.mutListener.listen(23420) ? (i == tmpls.length()) : (i &lt; tmpls.length())))))); ++i) {</span>
<span class="nc" id="L1083">                    ListenerUtil.loopListener.listen(&quot;_loopCounter584&quot;, ++_loopCounter584);</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23417)) {</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">                        if (tmpls.getJSONObject(i).equals(template)) {</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23410)) {</span>
<span class="nc" id="L1087">                                oldidx = i;</span>
                            }
<span class="nc bnc" id="L1089" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23416)) {</span>
<span class="nc bnc" id="L1090" title="All 22 branches missed.">                                if ((ListenerUtil.mutListener.listen(23415) ? (idx &gt;= oldidx) : (ListenerUtil.mutListener.listen(23414) ? (idx &lt;= oldidx) : (ListenerUtil.mutListener.listen(23413) ? (idx &gt; oldidx) : (ListenerUtil.mutListener.listen(23412) ? (idx &lt; oldidx) : (ListenerUtil.mutListener.listen(23411) ? (idx != oldidx) : (idx == oldidx))))))) {</span>
<span class="nc" id="L1091">                                    return;</span>
                                }
                            }
                        }
                    }
<span class="nc" id="L1096">                    JSONObject t = tmpls.getJSONObject(i);</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23418)) {</span>
<span class="nc" id="L1098">                        oldidxs.put(t.hashCode(), t.getInt(&quot;ord&quot;));</span>
                    }
<span class="nc bnc" id="L1100" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23419)) {</span>
<span class="nc" id="L1101">                        l.add(t);</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L1106" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23426)) {</span>
<span class="nc" id="L1107">            l.remove(oldidx);</span>
        }
<span class="nc bnc" id="L1109" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23427)) {</span>
<span class="nc" id="L1110">            l.add(idx, template);</span>
        }
<span class="nc bnc" id="L1112" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23428)) {</span>
<span class="nc" id="L1113">            m.put(&quot;tmpls&quot;, new JSONArray(l));</span>
        }
<span class="nc bnc" id="L1115" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23429)) {</span>
<span class="nc" id="L1116">            _updateTemplOrds(m);</span>
        }
        // generate change map - We use StringBuilder
<span class="nc" id="L1119">        StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23430)) {</span>
<span class="nc" id="L1121">            tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
        }
<span class="nc bnc" id="L1123" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23443)) {</span>
            {
<span class="nc" id="L1125">                long _loopCounter585 = 0;</span>
<span class="nc bnc" id="L1126" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23442) ? (i &gt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23441) ? (i &lt;= tmpls.length()) : (ListenerUtil.mutListener.listen(23440) ? (i &gt; tmpls.length()) : (ListenerUtil.mutListener.listen(23439) ? (i != tmpls.length()) : (ListenerUtil.mutListener.listen(23438) ? (i == tmpls.length()) : (i &lt; tmpls.length())))))); ++i) {</span>
<span class="nc" id="L1127">                    ListenerUtil.loopListener.listen(&quot;_loopCounter585&quot;, ++_loopCounter585);</span>
<span class="nc" id="L1128">                    JSONObject t = tmpls.getJSONObject(i);</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23431)) {</span>
<span class="nc" id="L1130">                        sb.append(&quot;when ord = &quot;).append(oldidxs.get(t.hashCode())).append(&quot; then &quot;).append(t.getInt(&quot;ord&quot;));</span>
                    }
<span class="nc bnc" id="L1132" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23437)) {</span>
<span class="nc bnc" id="L1133" title="All 10 branches missed.">                        if (i != (ListenerUtil.mutListener.listen(23435) ? (tmpls.length() % 1) : (ListenerUtil.mutListener.listen(23434) ? (tmpls.length() / 1) : (ListenerUtil.mutListener.listen(23433) ? (tmpls.length() * 1) : (ListenerUtil.mutListener.listen(23432) ? (tmpls.length() + 1) : (tmpls.length() - 1)))))) {</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23436)) {</span>
<span class="nc" id="L1135">                                sb.append(&quot; &quot;);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L1142" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23444)) {</span>
            // apply
<span class="nc" id="L1144">            save(m);</span>
        }
<span class="nc bnc" id="L1146" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23445)) {</span>
<span class="nc" id="L1147">            mCol.getDb().execute(&quot;update cards set ord = (case &quot; + sb + &quot; end),usn=?,mod=? where nid in (select id from notes where mid = ?)&quot;, mCol.usn(), mCol.getTime().intTime(), m.getLong(&quot;id&quot;));</span>
        }
<span class="nc" id="L1149">    }</span>

    // unused upstream as well
    @SuppressWarnings(&quot;PMD.UnusedLocalVariable&quot;)
    private void _syncTemplates(Model m) {
<span class="nc" id="L1154">        ArrayList&lt;Long&gt; rem = mCol.genCards(nids(m), m);</span>
<span class="nc" id="L1155">    }</span>

    /**
     * Change a model
     * @param m The model to change.
     * @param nid The notes that the change applies to.
     * @param newModel For replacing the old model with another one. Should be self if the model is not changing
     * @param fmap Map for switching fields. This is ord-&gt;ord and there should not be duplicate targets
     * @param cmap Map for switching cards. This is ord-&gt;ord and there should not be duplicate targets
     * @throws ConfirmModSchemaException
     */
    public void change(Model m, long nid, Model newModel, Map&lt;Integer, Integer&gt; fmap, Map&lt;Integer, Integer&gt; cmap) throws ConfirmModSchemaException {
<span class="nc bnc" id="L1167" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23446)) {</span>
<span class="nc" id="L1168">            mCol.modSchema();</span>
        }
<span class="nc bnc" id="L1170" title="All 28 branches missed.">        assert (ListenerUtil.mutListener.listen(23448) ? ((newModel.getLong(&quot;id&quot;) == m.getLong(&quot;id&quot;)) &amp;&amp; ((ListenerUtil.mutListener.listen(23447) ? (fmap != null || cmap != null) : (fmap != null &amp;&amp; cmap != null)))) : ((newModel.getLong(&quot;id&quot;) == m.getLong(&quot;id&quot;)) || ((ListenerUtil.mutListener.listen(23447) ? (fmap != null || cmap != null) : (fmap != null &amp;&amp; cmap != null)))));</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23450)) {</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">            if (fmap != null) {</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23449)) {</span>
<span class="nc" id="L1174">                    _changeNote(nid, newModel, fmap);</span>
                }
            }
        }
<span class="nc bnc" id="L1178" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23452)) {</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">            if (cmap != null) {</span>
<span class="nc bnc" id="L1180" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23451)) {</span>
<span class="nc" id="L1181">                    _changeCards(nid, m, newModel, cmap);</span>
                }
            }
        }
<span class="nc bnc" id="L1185" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23453)) {</span>
<span class="nc" id="L1186">            mCol.genCards(nid, newModel);</span>
        }
<span class="nc" id="L1188">    }</span>

    private void _changeNote(long nid, Model newModel, Map&lt;Integer, Integer&gt; map) {
<span class="nc" id="L1191">        int nfields = newModel.getJSONArray(&quot;flds&quot;).length();</span>
<span class="nc" id="L1192">        long mid = newModel.getLong(&quot;id&quot;);</span>
<span class="nc" id="L1193">        String sflds = mCol.getDb().queryString(&quot;select flds from notes where id = ?&quot;, nid);</span>
<span class="nc" id="L1194">        String[] flds = Utils.splitFields(sflds);</span>
<span class="nc" id="L1195">        Map&lt;Integer, String&gt; newflds = new HashMap&lt;&gt;(map.size());</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23455)) {</span>
            {
<span class="nc" id="L1198">                long _loopCounter586 = 0;</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">                for (Entry&lt;Integer, Integer&gt; entry : map.entrySet()) {</span>
<span class="nc" id="L1200">                    ListenerUtil.loopListener.listen(&quot;_loopCounter586&quot;, ++_loopCounter586);</span>
<span class="nc bnc" id="L1201" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23454)) {</span>
<span class="nc" id="L1202">                        newflds.put(entry.getValue(), flds[entry.getKey()]);</span>
                    }
<span class="nc" id="L1204">                }</span>
            }
        }
<span class="nc" id="L1207">        List&lt;String&gt; flds2 = new ArrayList&lt;&gt;(nfields);</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23464)) {</span>
            {
<span class="nc" id="L1210">                long _loopCounter587 = 0;</span>
<span class="nc bnc" id="L1211" title="All 22 branches missed.">                for (int c = 0; (ListenerUtil.mutListener.listen(23463) ? (c &gt;= nfields) : (ListenerUtil.mutListener.listen(23462) ? (c &lt;= nfields) : (ListenerUtil.mutListener.listen(23461) ? (c &gt; nfields) : (ListenerUtil.mutListener.listen(23460) ? (c != nfields) : (ListenerUtil.mutListener.listen(23459) ? (c == nfields) : (c &lt; nfields)))))); ++c) {</span>
<span class="nc" id="L1212">                    ListenerUtil.loopListener.listen(&quot;_loopCounter587&quot;, ++_loopCounter587);</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23458)) {</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">                        if (newflds.containsKey(c)) {</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23457)) {</span>
<span class="nc" id="L1216">                                flds2.add(newflds.get(c));</span>
                            }
                        } else {
<span class="nc bnc" id="L1219" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23456)) {</span>
<span class="nc" id="L1220">                                flds2.add(&quot;&quot;);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L1227">        String joinedFlds = Utils.joinFields(flds2.toArray(new String[flds2.size()]));</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23465)) {</span>
<span class="nc" id="L1229">            mCol.getDb().execute(&quot;update notes set flds=?,mid=?,mod=?,usn=? where id = ?&quot;, joinedFlds, mid, mCol.getTime().intTime(), mCol.usn(), nid);</span>
        }
<span class="nc bnc" id="L1231" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23466)) {</span>
<span class="nc" id="L1232">            mCol.updateFieldCache(new long[] { nid });</span>
        }
<span class="nc" id="L1234">    }</span>

    private void _changeCards(long nid, Model oldModel, Model newModel, Map&lt;Integer, Integer&gt; map) {
<span class="nc" id="L1237">        List&lt;Object[]&gt; d = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1238">        List&lt;Long&gt; deleted = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1239">        int omType = oldModel.getInt(&quot;type&quot;);</span>
<span class="nc" id="L1240">        int nmType = newModel.getInt(&quot;type&quot;);</span>
<span class="nc" id="L1241">        int nflds = newModel.getJSONArray(&quot;tmpls&quot;).length();</span>
<span class="nc" id="L1242">        try (Cursor cur = mCol.getDb().query(&quot;select id, ord from cards where nid = ?&quot;, nid)) {</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(23485)) {</span>
                {
<span class="nc" id="L1245">                    long _loopCounter588 = 0;</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">                    while (cur.moveToNext()) {</span>
<span class="nc" id="L1247">                        ListenerUtil.loopListener.listen(&quot;_loopCounter588&quot;, ++_loopCounter588);</span>
                        // support mapping them
                        Integer newOrd;
<span class="nc" id="L1250">                        long cid = cur.getLong(0);</span>
<span class="nc" id="L1251">                        int ord = cur.getInt(1);</span>
<span class="nc bnc" id="L1252" title="All 22 branches missed.">                        if ((ListenerUtil.mutListener.listen(23471) ? (omType &gt;= Consts.MODEL_CLOZE) : (ListenerUtil.mutListener.listen(23470) ? (omType &lt;= Consts.MODEL_CLOZE) : (ListenerUtil.mutListener.listen(23469) ? (omType &gt; Consts.MODEL_CLOZE) : (ListenerUtil.mutListener.listen(23468) ? (omType &lt; Consts.MODEL_CLOZE) : (ListenerUtil.mutListener.listen(23467) ? (omType != Consts.MODEL_CLOZE) : (omType == Consts.MODEL_CLOZE))))))) {</span>
<span class="nc" id="L1253">                            newOrd = cur.getInt(1);</span>
<span class="nc bnc" id="L1254" title="All 22 branches missed.">                            if ((ListenerUtil.mutListener.listen(23476) ? (nmType &gt;= Consts.MODEL_CLOZE) : (ListenerUtil.mutListener.listen(23475) ? (nmType &lt;= Consts.MODEL_CLOZE) : (ListenerUtil.mutListener.listen(23474) ? (nmType &gt; Consts.MODEL_CLOZE) : (ListenerUtil.mutListener.listen(23473) ? (nmType &lt; Consts.MODEL_CLOZE) : (ListenerUtil.mutListener.listen(23472) ? (nmType == Consts.MODEL_CLOZE) : (nmType != Consts.MODEL_CLOZE))))))) {</span>
                                // the destination ord is valid
<span class="nc bnc" id="L1256" title="All 22 branches missed.">                                if ((ListenerUtil.mutListener.listen(23481) ? (nflds &gt;= ord) : (ListenerUtil.mutListener.listen(23480) ? (nflds &gt; ord) : (ListenerUtil.mutListener.listen(23479) ? (nflds &lt; ord) : (ListenerUtil.mutListener.listen(23478) ? (nflds != ord) : (ListenerUtil.mutListener.listen(23477) ? (nflds == ord) : (nflds &lt;= ord))))))) {</span>
<span class="nc" id="L1257">                                    newOrd = null;</span>
                                }
                            }
                        } else {
                            // mapping from a regular note, so the map should be valid
<span class="nc" id="L1262">                            newOrd = map.get(ord);</span>
                        }
<span class="nc bnc" id="L1264" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(23484)) {</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">                            if (newOrd != null) {</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23483)) {</span>
<span class="nc" id="L1267">                                    d.add(new Object[] { newOrd, mCol.usn(), mCol.getTime().intTime(), cid });</span>
                                }
                            } else {
<span class="nc bnc" id="L1270" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23482)) {</span>
<span class="nc" id="L1271">                                    deleted.add(cid);</span>
                                }
                            }
                        }
<span class="nc" id="L1275">                    }</span>
                }
            }
        }
<span class="nc bnc" id="L1279" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23486)) {</span>
<span class="nc" id="L1280">            mCol.getDb().executeMany(&quot;update cards set ord=?,usn=?,mod=? where id=?&quot;, d);</span>
        }
<span class="nc bnc" id="L1282" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23487)) {</span>
<span class="nc" id="L1283">            mCol.remCards(deleted);</span>
        }
<span class="nc" id="L1285">    }</span>

    /**
     * Return a hash of the schema, to see if models are compatible.
     */
    public String scmhash(Model m) {
<span class="nc" id="L1291">        StringBuilder s = new StringBuilder();</span>
<span class="nc" id="L1292">        JSONArray flds = m.getJSONArray(&quot;flds&quot;);</span>
<span class="nc bnc" id="L1293" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23489)) {</span>
            {
<span class="nc" id="L1295">                long _loopCounter589 = 0;</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">                for (JSONObject fld : flds.jsonObjectIterable()) {</span>
<span class="nc" id="L1297">                    ListenerUtil.loopListener.listen(&quot;_loopCounter589&quot;, ++_loopCounter589);</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23488)) {</span>
<span class="nc" id="L1299">                        s.append(fld.getString(&quot;name&quot;));</span>
                    }
<span class="nc" id="L1301">                }</span>
            }
        }
<span class="nc" id="L1304">        JSONArray tmpls = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23491)) {</span>
            {
<span class="nc" id="L1307">                long _loopCounter590 = 0;</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">                for (JSONObject t : tmpls.jsonObjectIterable()) {</span>
<span class="nc" id="L1309">                    ListenerUtil.loopListener.listen(&quot;_loopCounter590&quot;, ++_loopCounter590);</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23490)) {</span>
<span class="nc" id="L1311">                        s.append(t.getString(&quot;name&quot;));</span>
                    }
<span class="nc" id="L1313">                }</span>
            }
        }
<span class="nc" id="L1316">        return Utils.checksum(s.toString());</span>
    }

    // 'String f' is unused upstream as well
    @SuppressWarnings(&quot;PMD.UnusedLocalVariable&quot;)
    private Object[] _reqForTemplate(Model m, List&lt;String&gt; flds, JSONObject t) {
<span class="nc" id="L1322">        int nbFields = flds.size();</span>
<span class="nc" id="L1323">        String[] a = new String[nbFields];</span>
<span class="nc" id="L1324">        String[] b = new String[nbFields];</span>
<span class="nc bnc" id="L1325" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23492)) {</span>
<span class="nc" id="L1326">            Arrays.fill(a, &quot;ankiflag&quot;);</span>
        }
<span class="nc bnc" id="L1328" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23493)) {</span>
<span class="nc" id="L1329">            Arrays.fill(b, &quot;&quot;);</span>
        }
<span class="nc" id="L1331">        int ord = t.getInt(&quot;ord&quot;);</span>
<span class="nc" id="L1332">        String full = mCol._renderQA(1L, m, 1L, ord, &quot;&quot;, a, 0).get(&quot;q&quot;);</span>
<span class="nc" id="L1333">        String empty = mCol._renderQA(1L, m, 1L, ord, &quot;&quot;, b, 0).get(&quot;q&quot;);</span>
<span class="nc bnc" id="L1334" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23494)) {</span>
            // if full and empty are the same, the template is invalid and there is no way to satisfy it
<span class="nc bnc" id="L1336" title="All 2 branches missed.">            if (full.equals(empty)) {</span>
<span class="nc" id="L1337">                return new Object[] { REQ_NONE, new JSONArray(), new JSONArray() };</span>
            }
        }
<span class="nc" id="L1340">        String type = REQ_ALL;</span>
<span class="nc" id="L1341">        JSONArray req = new JSONArray();</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23504)) {</span>
            {
<span class="nc" id="L1344">                long _loopCounter591 = 0;</span>
<span class="nc bnc" id="L1345" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23503) ? (i &gt;= flds.size()) : (ListenerUtil.mutListener.listen(23502) ? (i &lt;= flds.size()) : (ListenerUtil.mutListener.listen(23501) ? (i &gt; flds.size()) : (ListenerUtil.mutListener.listen(23500) ? (i != flds.size()) : (ListenerUtil.mutListener.listen(23499) ? (i == flds.size()) : (i &lt; flds.size())))))); i++) {</span>
<span class="nc" id="L1346">                    ListenerUtil.loopListener.listen(&quot;_loopCounter591&quot;, ++_loopCounter591);</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23495)) {</span>
<span class="nc" id="L1348">                        a[i] = &quot;&quot;;</span>
                    }
<span class="nc bnc" id="L1350" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23497)) {</span>
                        // if no field content appeared, field is required
<span class="nc bnc" id="L1352" title="All 2 branches missed.">                        if (!mCol._renderQA(1L, m, 1L, ord, &quot;&quot;, a, 0).get(&quot;q&quot;).contains(&quot;ankiflag&quot;)) {</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23496)) {</span>
<span class="nc" id="L1354">                                req.put(i);</span>
                            }
                        }
                    }
<span class="nc bnc" id="L1358" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23498)) {</span>
<span class="nc" id="L1359">                        a[i] = &quot;ankiflag&quot;;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L1364" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23510)) {</span>
<span class="nc bnc" id="L1365" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(23509) ? (req.length() &gt;= 0) : (ListenerUtil.mutListener.listen(23508) ? (req.length() &lt;= 0) : (ListenerUtil.mutListener.listen(23507) ? (req.length() &lt; 0) : (ListenerUtil.mutListener.listen(23506) ? (req.length() != 0) : (ListenerUtil.mutListener.listen(23505) ? (req.length() == 0) : (req.length() &gt; 0))))))) {</span>
<span class="nc" id="L1366">                return new Object[] { type, req };</span>
            }
        }
<span class="nc bnc" id="L1369" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23511)) {</span>
            // if there are no required fields, switch to any mode
<span class="nc" id="L1371">            type = REQ_ANY;</span>
        }
<span class="nc bnc" id="L1373" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23512)) {</span>
<span class="nc" id="L1374">            req = new JSONArray();</span>
        }
<span class="nc bnc" id="L1376" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23522)) {</span>
            {
<span class="nc" id="L1378">                long _loopCounter592 = 0;</span>
<span class="nc bnc" id="L1379" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23521) ? (i &gt;= flds.size()) : (ListenerUtil.mutListener.listen(23520) ? (i &lt;= flds.size()) : (ListenerUtil.mutListener.listen(23519) ? (i &gt; flds.size()) : (ListenerUtil.mutListener.listen(23518) ? (i != flds.size()) : (ListenerUtil.mutListener.listen(23517) ? (i == flds.size()) : (i &lt; flds.size())))))); i++) {</span>
<span class="nc" id="L1380">                    ListenerUtil.loopListener.listen(&quot;_loopCounter592&quot;, ++_loopCounter592);</span>
<span class="nc bnc" id="L1381" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23513)) {</span>
<span class="nc" id="L1382">                        b[i] = &quot;1&quot;;</span>
                    }
<span class="nc bnc" id="L1384" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23515)) {</span>
                        // if not the same as empty, this field can make the card non-blank
<span class="nc bnc" id="L1386" title="All 2 branches missed.">                        if (!mCol._renderQA(1L, m, 1L, ord, &quot;&quot;, b, 0).get(&quot;q&quot;).equals(empty)) {</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23514)) {</span>
<span class="nc" id="L1388">                                req.put(i);</span>
                            }
                        }
                    }
<span class="nc bnc" id="L1392" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23516)) {</span>
<span class="nc" id="L1393">                        b[i] = &quot;&quot;;</span>
                    }
                }
            }
        }
<span class="nc" id="L1398">        return new Object[] { type, req };</span>
    }

    /**
     * @param m A model
     * @param ord a card type number of this model
     * @param sfld Fields of a note of this model. (Not trimmed)
     * @return Whether this card is empty
     */
    public static boolean emptyCard(Model m, int ord, String[] sfld) throws TemplateError {
<span class="nc bnc" id="L1408" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23523)) {</span>
<span class="nc bnc" id="L1409" title="All 2 branches missed.">            if (m.isCloze()) {</span>
                // So computing the full list is almost as efficient as checking for a particular number
<span class="nc bnc" id="L1411" title="All 2 branches missed.">                return !_availClozeOrds(m, sfld, false).contains(ord);</span>
            }
        }
<span class="nc" id="L1414">        return emptyStandardCard(m.getJSONArray(&quot;tmpls&quot;).getJSONObject(ord), m.nonEmptyFields(sfld));</span>
    }

    /**
     * @return Whether the standard card is empty
     */
    public static boolean emptyStandardCard(JSONObject tmpl, Set&lt;String&gt; nonEmptyFields) throws TemplateError {
<span class="nc" id="L1421">        return ParsedNode.parse_inner(tmpl.getString(&quot;qfmt&quot;)).template_is_empty(nonEmptyFields);</span>
    }

    /**
     * @param m A model
     * @param sfld Fields of a note
     * @param nodes Nodes used for parsing the variaous templates. Null for cloze
     * @return The index of the cards that are generated. For cloze cards, if no card is generated, then {0}
     */
    public static ArrayList&lt;Integer&gt; availOrds(Model m, String[] sfld, List&lt;ParsedNode&gt; nodes) {
<span class="nc bnc" id="L1431" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23524)) {</span>
<span class="nc bnc" id="L1432" title="All 2 branches missed.">            if (m.getInt(&quot;type&quot;) == Consts.MODEL_CLOZE) {</span>
<span class="nc" id="L1433">                return _availClozeOrds(m, sfld);</span>
            }
        }
<span class="nc" id="L1436">        return _availStandardOrds(m, sfld, nodes);</span>
    }

    public static ArrayList&lt;Integer&gt; availOrds(Model m, String[] sfld) {
<span class="pc bpc" id="L1440" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23525)) {</span>
<span class="pc bpc" id="L1441" title="1 of 2 branches missed.">            if (m.isCloze()) {</span>
<span class="nc" id="L1442">                return _availClozeOrds(m, sfld);</span>
            }
        }
<span class="fc" id="L1445">        return _availStandardOrds(m, sfld);</span>
    }

    public static ArrayList&lt;Integer&gt; _availStandardOrds(Model m, String[] sfld) {
<span class="fc" id="L1449">        return _availStandardOrds(m, sfld, m.parsedNodes());</span>
    }

    /**
     * Given a joined field string and a standard note type, return available template ordinals
     */
    public static ArrayList&lt;Integer&gt; _availStandardOrds(Model m, String[] sfld, List&lt;ParsedNode&gt; nodes) {
<span class="fc" id="L1456">        Set&lt;String&gt; nonEmptyFields = m.nonEmptyFields(sfld);</span>
<span class="fc" id="L1457">        ArrayList&lt;Integer&gt; avail = new ArrayList&lt;&gt;(nodes.size());</span>
<span class="pc bpc" id="L1458" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23534)) {</span>
            {
<span class="fc" id="L1460">                long _loopCounter593 = 0;</span>
<span class="pc bpc" id="L1461" title="15 of 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23533) ? (i &gt;= nodes.size()) : (ListenerUtil.mutListener.listen(23532) ? (i &lt;= nodes.size()) : (ListenerUtil.mutListener.listen(23531) ? (i &gt; nodes.size()) : (ListenerUtil.mutListener.listen(23530) ? (i != nodes.size()) : (ListenerUtil.mutListener.listen(23529) ? (i == nodes.size()) : (i &lt; nodes.size())))))); i++) {</span>
<span class="fc" id="L1462">                    ListenerUtil.loopListener.listen(&quot;_loopCounter593&quot;, ++_loopCounter593);</span>
<span class="fc" id="L1463">                    ParsedNode node = nodes.get(i);</span>
<span class="pc bpc" id="L1464" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23528)) {</span>
<span class="pc bpc" id="L1465" title="7 of 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(23526) ? (node != null || !node.template_is_empty(nonEmptyFields)) : (node != null &amp;&amp; !node.template_is_empty(nonEmptyFields)))) {</span>
<span class="pc bpc" id="L1466" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23527)) {</span>
<span class="fc" id="L1467">                                avail.add(i);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L1474">        return avail;</span>
    }

    /**
     * @param m A note type with cloze
     * @param sflds The fields of a note of type m. (Assume the size of the array is the number of fields)
     * @return The indexes (in increasing order) of cards that should be generated according to req rules.
     */
    public static ArrayList&lt;Integer&gt; _availClozeOrds(Model m, String[] sflds) {
<span class="nc" id="L1483">        return _availClozeOrds(m, sflds, true);</span>
    }

    /**
     * Cache of getNamesOfFieldsContainingCloze
     * Computing hash of string is costly. However, hash is cashed in the string object, so this virtually ensure that
     * given a card type, we don't need to recompute the hash.
     */
<span class="fc" id="L1491">    private static final WeakHashMap&lt;String, List&lt;String&gt;&gt; namesOfFieldsContainingClozeCache = new WeakHashMap&lt;&gt;();</span>

    /**
     * The name of all fields that are used as cloze in the question.
     * It is not guaranteed that the field found are actually the name of any field of the note type.
     */
    @VisibleForTesting
    protected static List&lt;String&gt; getNamesOfFieldsContainingCloze(String question) {
<span class="nc bnc" id="L1499" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23539)) {</span>
<span class="nc bnc" id="L1500" title="All 2 branches missed.">            if (!namesOfFieldsContainingClozeCache.containsKey(question)) {</span>
<span class="nc" id="L1501">                List&lt;String&gt; matches = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1502" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23537)) {</span>
                    {
<span class="nc" id="L1504">                        long _loopCounter595 = 0;</span>
<span class="nc bnc" id="L1505" title="All 2 branches missed.">                        for (Pattern pattern : new Pattern[] { fClozePattern1, fClozePattern2 }) {</span>
<span class="nc" id="L1506">                            ListenerUtil.loopListener.listen(&quot;_loopCounter595&quot;, ++_loopCounter595);</span>
<span class="nc" id="L1507">                            Matcher mm = pattern.matcher(question);</span>
<span class="nc bnc" id="L1508" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23536)) {</span>
                                {
<span class="nc" id="L1510">                                    long _loopCounter594 = 0;</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">                                    while (mm.find()) {</span>
<span class="nc" id="L1512">                                        ListenerUtil.loopListener.listen(&quot;_loopCounter594&quot;, ++_loopCounter594);</span>
<span class="nc bnc" id="L1513" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(23535)) {</span>
<span class="nc" id="L1514">                                            matches.add(mm.group(1));</span>
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
<span class="nc bnc" id="L1522" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23538)) {</span>
<span class="nc" id="L1523">                    namesOfFieldsContainingClozeCache.put(question, matches);</span>
                }
            }
        }
<span class="nc" id="L1527">        return namesOfFieldsContainingClozeCache.get(question);</span>
    }

    /**
     * @param m A note type with cloze
     * @param sflds The fields of a note of type m. (Assume the size of the array is the number of fields)
     * @param allowEmpty Whether we allow to generate at least one card even if they are all empty
     * @return The indexes (in increasing order) of cards that should be generated according to req rules.
     * If empty is not allowed, it will contains ord 1.
     */
    public static ArrayList&lt;Integer&gt; _availClozeOrds(Model m, String[] sflds, boolean allowEmpty) {
<span class="nc" id="L1538">        Map&lt;String, Pair&lt;Integer, JSONObject&gt;&gt; map = fieldMap(m);</span>
<span class="nc" id="L1539">        String question = m.getJSONArray(&quot;tmpls&quot;).getJSONObject(0).getString(&quot;qfmt&quot;);</span>
<span class="nc" id="L1540">        Set&lt;Integer&gt; ords = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1541">        List&lt;String&gt; matches = getNamesOfFieldsContainingCloze(question);</span>
<span class="nc bnc" id="L1542" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23547)) {</span>
            {
<span class="nc" id="L1544">                long _loopCounter597 = 0;</span>
<span class="nc bnc" id="L1545" title="All 2 branches missed.">                for (String fname : matches) {</span>
<span class="nc" id="L1546">                    ListenerUtil.loopListener.listen(&quot;_loopCounter597&quot;, ++_loopCounter597);</span>
<span class="nc bnc" id="L1547" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23540)) {</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">                        if (!map.containsKey(fname)) {</span>
<span class="nc" id="L1549">                            continue;</span>
                        }
                    }
<span class="nc" id="L1552">                    int ord = map.get(fname).first;</span>
<span class="nc" id="L1553">                    Matcher mm = fClozeOrdPattern.matcher(sflds[ord]);</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23546)) {</span>
                        {
<span class="nc" id="L1556">                            long _loopCounter596 = 0;</span>
<span class="nc bnc" id="L1557" title="All 2 branches missed.">                            while (mm.find()) {</span>
<span class="nc" id="L1558">                                ListenerUtil.loopListener.listen(&quot;_loopCounter596&quot;, ++_loopCounter596);</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23545)) {</span>
<span class="nc bnc" id="L1560" title="All 8 branches missed.">                                    ords.add((ListenerUtil.mutListener.listen(23544) ? (Integer.parseInt(mm.group(1)) % 1) : (ListenerUtil.mutListener.listen(23543) ? (Integer.parseInt(mm.group(1)) / 1) : (ListenerUtil.mutListener.listen(23542) ? (Integer.parseInt(mm.group(1)) * 1) : (ListenerUtil.mutListener.listen(23541) ? (Integer.parseInt(mm.group(1)) + 1) : (Integer.parseInt(mm.group(1)) - 1))))));</span>
                                }
                            }
                        }
                    }
<span class="nc" id="L1565">                }</span>
            }
        }
<span class="nc bnc" id="L1568" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23548)) {</span>
<span class="nc" id="L1569">            ords.remove(-1);</span>
        }
<span class="nc bnc" id="L1571" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23550)) {</span>
<span class="nc bnc" id="L1572" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(23549) ? (ords.isEmpty() || allowEmpty) : (ords.isEmpty() &amp;&amp; allowEmpty))) {</span>
                // empty clozes use first ord
<span class="nc" id="L1574">                return new ArrayList&lt;&gt;(Collections.singletonList(0));</span>
            }
        }
<span class="nc" id="L1577">        return new ArrayList&lt;&gt;(ords);</span>
    }

    public void beforeUpload() {
<span class="nc" id="L1581">        boolean changed = Utils.markAsUploaded(all());</span>
<span class="nc bnc" id="L1582" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23552)) {</span>
<span class="nc bnc" id="L1583" title="All 2 branches missed.">            if (changed) {</span>
<span class="nc bnc" id="L1584" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(23551)) {</span>
<span class="nc" id="L1585">                    save();</span>
                }
            }
        }
<span class="nc" id="L1589">    }</span>

    public void setChanged() {
<span class="nc bnc" id="L1592" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23553)) {</span>
<span class="nc" id="L1593">            mChanged = true;</span>
        }
<span class="nc" id="L1595">    }</span>

    public HashMap&lt;Long, HashMap&lt;Integer, String&gt;&gt; getTemplateNames() {
<span class="nc" id="L1598">        HashMap&lt;Long, HashMap&lt;Integer, String&gt;&gt; result = new HashMap&lt;&gt;(mModels.size());</span>
<span class="nc bnc" id="L1599" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23557)) {</span>
            {
<span class="nc" id="L1601">                long _loopCounter599 = 0;</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">                for (Model m : mModels.values()) {</span>
<span class="nc" id="L1603">                    ListenerUtil.loopListener.listen(&quot;_loopCounter599&quot;, ++_loopCounter599);</span>
<span class="nc" id="L1604">                    JSONArray templates = m.getJSONArray(&quot;tmpls&quot;);</span>
<span class="nc" id="L1605">                    HashMap&lt;Integer, String&gt; names = new HashMap&lt;&gt;(templates.length());</span>
<span class="nc bnc" id="L1606" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23555)) {</span>
                        {
<span class="nc" id="L1608">                            long _loopCounter598 = 0;</span>
<span class="nc bnc" id="L1609" title="All 2 branches missed.">                            for (JSONObject t : templates.jsonObjectIterable()) {</span>
<span class="nc" id="L1610">                                ListenerUtil.loopListener.listen(&quot;_loopCounter598&quot;, ++_loopCounter598);</span>
<span class="nc bnc" id="L1611" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23554)) {</span>
<span class="nc" id="L1612">                                    names.put(t.getInt(&quot;ord&quot;), t.getString(&quot;name&quot;));</span>
                                }
<span class="nc" id="L1614">                            }</span>
                        }
                    }
<span class="nc bnc" id="L1617" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23556)) {</span>
<span class="nc" id="L1618">                        result.put(m.getLong(&quot;id&quot;), names);</span>
                    }
<span class="nc" id="L1620">                }</span>
            }
        }
<span class="nc" id="L1623">        return result;</span>
    }

    /**
     * @return the ID
     */
    public int getId() {
<span class="nc" id="L1630">        return mId;</span>
    }

    public HashMap&lt;Long, Model&gt; getModels() {
<span class="nc" id="L1634">        return mModels;</span>
    }

    /**
     * @return Number of models
     */
    public int count() {
<span class="nc" id="L1641">        return mModels.size();</span>
    }

    /**
     * Validate model entries.
     */
    public boolean validateModel() {
<span class="nc bnc" id="L1648" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23559)) {</span>
            {
<span class="nc" id="L1650">                long _loopCounter600 = 0;</span>
<span class="nc bnc" id="L1651" title="All 2 branches missed.">                for (Model model : mModels.values()) {</span>
<span class="nc" id="L1652">                    ListenerUtil.loopListener.listen(&quot;_loopCounter600&quot;, ++_loopCounter600);</span>
<span class="nc bnc" id="L1653" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23558)) {</span>
<span class="nc bnc" id="L1654" title="All 2 branches missed.">                        if (!validateBrackets(model)) {</span>
<span class="nc" id="L1655">                            return false;</span>
                        }
                    }
<span class="nc" id="L1658">                }</span>
            }
        }
<span class="nc" id="L1661">        return true;</span>
    }

    /**
     * Check if there is a right bracket for every left bracket.
     */
    private boolean validateBrackets(JSONObject value) {
<span class="nc" id="L1668">        String s = value.toString();</span>
<span class="nc" id="L1669">        int count = 0;</span>
<span class="nc" id="L1670">        boolean inQuotes = false;</span>
<span class="nc" id="L1671">        char[] ar = s.toCharArray();</span>
<span class="nc bnc" id="L1672" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(23588)) {</span>
            {
<span class="nc" id="L1674">                long _loopCounter601 = 0;</span>
<span class="nc bnc" id="L1675" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(23587) ? (i &gt;= ar.length) : (ListenerUtil.mutListener.listen(23586) ? (i &lt;= ar.length) : (ListenerUtil.mutListener.listen(23585) ? (i &gt; ar.length) : (ListenerUtil.mutListener.listen(23584) ? (i != ar.length) : (ListenerUtil.mutListener.listen(23583) ? (i == ar.length) : (i &lt; ar.length)))))); i++) {</span>
<span class="nc" id="L1676">                    ListenerUtil.loopListener.listen(&quot;_loopCounter601&quot;, ++_loopCounter601);</span>
<span class="nc" id="L1677">                    char c = ar[i];</span>
<span class="nc bnc" id="L1678" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23572)) {</span>
                        // if in quotes, do not count
<span class="nc bnc" id="L1680" title="All 138 branches missed.">                        if ((ListenerUtil.mutListener.listen(23570) ? (c == '&quot;' || ((ListenerUtil.mutListener.listen(23569) ? ((ListenerUtil.mutListener.listen(23564) ? (i &gt;= 0) : (ListenerUtil.mutListener.listen(23563) ? (i &lt;= 0) : (ListenerUtil.mutListener.listen(23562) ? (i &gt; 0) : (ListenerUtil.mutListener.listen(23561) ? (i &lt; 0) : (ListenerUtil.mutListener.listen(23560) ? (i != 0) : (i == 0)))))) &amp;&amp; (ar[(ListenerUtil.mutListener.listen(23568) ? (i % 1) : (ListenerUtil.mutListener.listen(23567) ? (i / 1) : (ListenerUtil.mutListener.listen(23566) ? (i * 1) : (ListenerUtil.mutListener.listen(23565) ? (i + 1) : (i - 1)))))] != '\\')) : ((ListenerUtil.mutListener.listen(23564) ? (i &gt;= 0) : (ListenerUtil.mutListener.listen(23563) ? (i &lt;= 0) : (ListenerUtil.mutListener.listen(23562) ? (i &gt; 0) : (ListenerUtil.mutListener.listen(23561) ? (i &lt; 0) : (ListenerUtil.mutListener.listen(23560) ? (i != 0) : (i == 0)))))) || (ar[(ListenerUtil.mutListener.listen(23568) ? (i % 1) : (ListenerUtil.mutListener.listen(23567) ? (i / 1) : (ListenerUtil.mutListener.listen(23566) ? (i * 1) : (ListenerUtil.mutListener.listen(23565) ? (i + 1) : (i - 1)))))] != '\\'))))) : (c == '&quot;' &amp;&amp; ((ListenerUtil.mutListener.listen(23569) ? ((ListenerUtil.mutListener.listen(23564) ? (i &gt;= 0) : (ListenerUtil.mutListener.listen(23563) ? (i &lt;= 0) : (ListenerUtil.mutListener.listen(23562) ? (i &gt; 0) : (ListenerUtil.mutListener.listen(23561) ? (i &lt; 0) : (ListenerUtil.mutListener.listen(23560) ? (i != 0) : (i == 0)))))) &amp;&amp; (ar[(ListenerUtil.mutListener.listen(23568) ? (i % 1) : (ListenerUtil.mutListener.listen(23567) ? (i / 1) : (ListenerUtil.mutListener.listen(23566) ? (i * 1) : (ListenerUtil.mutListener.listen(23565) ? (i + 1) : (i - 1)))))] != '\\')) : ((ListenerUtil.mutListener.listen(23564) ? (i &gt;= 0) : (ListenerUtil.mutListener.listen(23563) ? (i &lt;= 0) : (ListenerUtil.mutListener.listen(23562) ? (i &gt; 0) : (ListenerUtil.mutListener.listen(23561) ? (i &lt; 0) : (ListenerUtil.mutListener.listen(23560) ? (i != 0) : (i == 0)))))) || (ar[(ListenerUtil.mutListener.listen(23568) ? (i % 1) : (ListenerUtil.mutListener.listen(23567) ? (i / 1) : (ListenerUtil.mutListener.listen(23566) ? (i * 1) : (ListenerUtil.mutListener.listen(23565) ? (i + 1) : (i - 1)))))] != '\\'))))))) {</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(23571)) {</span>
<span class="nc bnc" id="L1682" title="All 2 branches missed.">                                inQuotes = !inQuotes;</span>
                            }
                            continue;
                        }
                    }
<span class="nc bnc" id="L1687" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23573)) {</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">                        if (inQuotes) {</span>
<span class="nc" id="L1689">                            continue;</span>
                        }
                    }
<span class="nc bnc" id="L1692" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(23582)) {</span>
<span class="nc bnc" id="L1693" title="All 3 branches missed.">                        switch(c) {</span>
                            case '{':
<span class="nc bnc" id="L1695" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23574)) {</span>
<span class="nc" id="L1696">                                    count++;</span>
                                }
                                break;
                            case '}':
<span class="nc bnc" id="L1700" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23575)) {</span>
<span class="nc" id="L1701">                                    count--;</span>
                                }
<span class="nc bnc" id="L1703" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(23581)) {</span>
<span class="nc bnc" id="L1704" title="All 22 branches missed.">                                    if ((ListenerUtil.mutListener.listen(23580) ? (count &gt;= 0) : (ListenerUtil.mutListener.listen(23579) ? (count &lt;= 0) : (ListenerUtil.mutListener.listen(23578) ? (count &gt; 0) : (ListenerUtil.mutListener.listen(23577) ? (count != 0) : (ListenerUtil.mutListener.listen(23576) ? (count == 0) : (count &lt; 0))))))) {</span>
<span class="nc" id="L1705">                                        return false;</span>
                                    }
                                }
                                break;
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L1714" title="All 22 branches missed.">        return ((ListenerUtil.mutListener.listen(23593) ? (count &gt;= 0) : (ListenerUtil.mutListener.listen(23592) ? (count &lt;= 0) : (ListenerUtil.mutListener.listen(23591) ? (count &gt; 0) : (ListenerUtil.mutListener.listen(23590) ? (count &lt; 0) : (ListenerUtil.mutListener.listen(23589) ? (count != 0) : (count == 0)))))));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>