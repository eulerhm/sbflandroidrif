<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetaDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki</a> &gt; <span class="el_source">MetaDB.java</span></div><h1>MetaDB.java</h1><pre class="source lang-java linenums">package com.ichi2.anki;

import android.content.Context;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteException;
import android.util.Pair;
import com.ichi2.anki.model.WhiteboardPenColor;
import com.ichi2.libanki.Sound;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

/**
 * Used to store additional information besides what is stored in the deck itself.
 * &lt;p&gt;
 * Currently it used to store:
 * &lt;ul&gt;
 * &lt;li&gt;The languages associated with questions and answers.&lt;/li&gt;
 * &lt;li&gt;The state of the whiteboard.&lt;/li&gt;
 * &lt;li&gt;The cached state of the widget.&lt;/li&gt;
 * &lt;/ul&gt;
 */
<span class="nc" id="L27">public class MetaDB {</span>

    /**
     * The name of the file storing the meta-db.
     */
    private static final String DATABASE_NAME = &quot;ankidroid.db&quot;;

    /**
     * The Database Version, increase if you want updates to happen on next upgrade.
     */
    private static final int DATABASE_VERSION = 6;

    /**
     * The language refers to the question.
     */
    public static final int LANGUAGES_QA_QUESTION = 0;

    /**
     * The language refers to the answer.
     */
    public static final int LANGUAGES_QA_ANSWER = 1;

    /**
     * The language does not refer to either the question or answer.
     */
    public static final int LANGUAGES_QA_UNDEFINED = 2;

    /**
     * The pattern used to remove quotes from file names.
     */
<span class="nc" id="L57">    private static final Pattern quotePattern = Pattern.compile(&quot;[\&quot;']&quot;);</span>

    /**
     * The database object used by the meta-db.
     */
<span class="nc" id="L62">    private static SQLiteDatabase mMetaDb = null;</span>

    /**
     * Remove any pairs of quotes from the given text.
     */
    private static String stripQuotes(String text) {
<span class="nc" id="L68">        Matcher matcher = quotePattern.matcher(text);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8680)) {</span>
<span class="nc" id="L70">            text = matcher.replaceAll(&quot;&quot;);</span>
        }
<span class="nc" id="L72">        return text;</span>
    }

    /**
     * Open the meta-db
     */
    private static void openDB(Context context) {
        try {
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8682)) {</span>
<span class="nc" id="L81">                mMetaDb = context.openOrCreateDatabase(DATABASE_NAME, 0, null);</span>
            }
<span class="nc bnc" id="L83" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8684)) {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                if (mMetaDb.needUpgrade(DATABASE_VERSION)) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8683)) {</span>
<span class="nc" id="L86">                        mMetaDb = upgradeDB(mMetaDb, DATABASE_VERSION);</span>
                    }
                }
            }
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8685)) {</span>
<span class="nc" id="L91">                Timber.v(&quot;Opening MetaDB&quot;);</span>
            }
<span class="nc" id="L93">        } catch (Exception e) {</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8681)) {</span>
<span class="nc" id="L95">                Timber.e(e, &quot;Error opening MetaDB &quot;);</span>
            }
<span class="nc" id="L97">        }</span>
<span class="nc" id="L98">    }</span>

    /**
     * Creating any table that missing and upgrading necessary tables.
     */
    private static SQLiteDatabase upgradeDB(SQLiteDatabase mMetaDb, int databaseVersion) {
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8686)) {</span>
<span class="nc" id="L105">            Timber.i(&quot;MetaDB:: Upgrading Internal Database..&quot;);</span>
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8687)) {</span>
            // if (mMetaDb.getVersion() == 0) {
<span class="nc" id="L109">            Timber.i(&quot;MetaDB:: Applying changes for version: 0&quot;);</span>
        }
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8696)) {</span>
<span class="nc bnc" id="L112" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(8692) ? (mMetaDb.getVersion() &gt;= 4) : (ListenerUtil.mutListener.listen(8691) ? (mMetaDb.getVersion() &lt;= 4) : (ListenerUtil.mutListener.listen(8690) ? (mMetaDb.getVersion() &gt; 4) : (ListenerUtil.mutListener.listen(8689) ? (mMetaDb.getVersion() != 4) : (ListenerUtil.mutListener.listen(8688) ? (mMetaDb.getVersion() == 4) : (mMetaDb.getVersion() &lt; 4))))))) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8693)) {</span>
<span class="nc" id="L114">                    mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS languages;&quot;);</span>
                }
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8694)) {</span>
<span class="nc" id="L117">                    mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS customDictionary;&quot;);</span>
                }
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8695)) {</span>
<span class="nc" id="L120">                    mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS whiteboardState;&quot;);</span>
                }
            }
        }
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8697)) {</span>
            // Create tables if not exist
<span class="nc" id="L126">            mMetaDb.execSQL(&quot;CREATE TABLE IF NOT EXISTS languages (&quot; + &quot; _id INTEGER PRIMARY KEY AUTOINCREMENT, &quot; + &quot;did INTEGER NOT NULL, ord INTEGER, &quot; + &quot;qa INTEGER, &quot; + &quot;language TEXT)&quot;);</span>
        }
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8698)) {</span>
<span class="nc" id="L129">            mMetaDb.execSQL(&quot;CREATE TABLE IF NOT EXISTS customDictionary (&quot; + &quot;_id INTEGER PRIMARY KEY AUTOINCREMENT, &quot; + &quot;did INTEGER NOT NULL, &quot; + &quot;dictionary INTEGER)&quot;);</span>
        }
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8699)) {</span>
<span class="nc" id="L132">            mMetaDb.execSQL(&quot;CREATE TABLE IF NOT EXISTS smallWidgetStatus (&quot; + &quot;id INTEGER PRIMARY KEY AUTOINCREMENT, &quot; + &quot;due INTEGER NOT NULL, eta INTEGER NOT NULL)&quot;);</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8700)) {</span>
<span class="nc" id="L135">            updateWidgetStatus(mMetaDb);</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8701)) {</span>
<span class="nc" id="L138">            updateWhiteboardState(mMetaDb);</span>
        }
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8702)) {</span>
<span class="nc" id="L141">            mMetaDb.setVersion(databaseVersion);</span>
        }
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8703)) {</span>
<span class="nc" id="L144">            Timber.i(&quot;MetaDB:: Upgrading Internal Database finished. New version: %d&quot;, databaseVersion);</span>
        }
<span class="nc" id="L146">        return mMetaDb;</span>
    }

    private static void updateWhiteboardState(SQLiteDatabase mMetaDb) {
<span class="nc" id="L150">        int columnCount = DatabaseUtil.getTableColumnCount(mMetaDb, &quot;whiteboardState&quot;);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8710)) {</span>
<span class="nc bnc" id="L152" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(8708) ? (columnCount &gt;= 0) : (ListenerUtil.mutListener.listen(8707) ? (columnCount &gt; 0) : (ListenerUtil.mutListener.listen(8706) ? (columnCount &lt; 0) : (ListenerUtil.mutListener.listen(8705) ? (columnCount != 0) : (ListenerUtil.mutListener.listen(8704) ? (columnCount == 0) : (columnCount &lt;= 0))))))) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8709)) {</span>
<span class="nc" id="L154">                    mMetaDb.execSQL(&quot;CREATE TABLE IF NOT EXISTS whiteboardState (_id INTEGER PRIMARY KEY AUTOINCREMENT, &quot; + &quot;did INTEGER NOT NULL, state INTEGER, visible INTEGER, lightpencolor INTEGER, darkpencolor INTEGER)&quot;);</span>
                }
<span class="nc" id="L156">                return;</span>
            }
        }
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8718)) {</span>
<span class="nc bnc" id="L160" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(8715) ? (columnCount &gt;= 4) : (ListenerUtil.mutListener.listen(8714) ? (columnCount &lt;= 4) : (ListenerUtil.mutListener.listen(8713) ? (columnCount &gt; 4) : (ListenerUtil.mutListener.listen(8712) ? (columnCount != 4) : (ListenerUtil.mutListener.listen(8711) ? (columnCount == 4) : (columnCount &lt; 4))))))) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8716)) {</span>
                    // Default to 1
<span class="nc" id="L163">                    mMetaDb.execSQL(&quot;ALTER TABLE whiteboardState ADD COLUMN visible INTEGER NOT NULL DEFAULT '1'&quot;);</span>
                }
<span class="nc bnc" id="L165" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8717)) {</span>
<span class="nc" id="L166">                    Timber.i(&quot;Added 'visible' column to whiteboardState&quot;);</span>
                }
            }
        }
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8728)) {</span>
<span class="nc bnc" id="L171" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(8723) ? (columnCount &gt;= 5) : (ListenerUtil.mutListener.listen(8722) ? (columnCount &lt;= 5) : (ListenerUtil.mutListener.listen(8721) ? (columnCount &gt; 5) : (ListenerUtil.mutListener.listen(8720) ? (columnCount != 5) : (ListenerUtil.mutListener.listen(8719) ? (columnCount == 5) : (columnCount &lt; 5))))))) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8724)) {</span>
<span class="nc" id="L173">                    mMetaDb.execSQL(&quot;ALTER TABLE whiteboardState ADD COLUMN lightpencolor INTEGER DEFAULT NULL&quot;);</span>
                }
<span class="nc bnc" id="L175" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8725)) {</span>
<span class="nc" id="L176">                    Timber.i(&quot;Added 'lightpencolor' column to whiteboardState&quot;);</span>
                }
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8726)) {</span>
<span class="nc" id="L179">                    mMetaDb.execSQL(&quot;ALTER TABLE whiteboardState ADD COLUMN darkpencolor INTEGER DEFAULT NULL&quot;);</span>
                }
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8727)) {</span>
<span class="nc" id="L182">                    Timber.i(&quot;Added 'darkpencolor' column to whiteboardState&quot;);</span>
                }
            }
        }
<span class="nc" id="L186">    }</span>

    private static void updateWidgetStatus(SQLiteDatabase mMetaDb) {
<span class="nc" id="L189">        int columnCount = DatabaseUtil.getTableColumnCount(mMetaDb, &quot;widgetStatus&quot;);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8743)) {</span>
<span class="nc bnc" id="L191" title="All 22 branches missed.">            if ((ListenerUtil.mutListener.listen(8733) ? (columnCount &gt;= 0) : (ListenerUtil.mutListener.listen(8732) ? (columnCount &lt;= 0) : (ListenerUtil.mutListener.listen(8731) ? (columnCount &lt; 0) : (ListenerUtil.mutListener.listen(8730) ? (columnCount != 0) : (ListenerUtil.mutListener.listen(8729) ? (columnCount == 0) : (columnCount &gt; 0))))))) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8742)) {</span>
<span class="nc bnc" id="L193" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(8739) ? (columnCount &gt;= 7) : (ListenerUtil.mutListener.listen(8738) ? (columnCount &lt;= 7) : (ListenerUtil.mutListener.listen(8737) ? (columnCount &gt; 7) : (ListenerUtil.mutListener.listen(8736) ? (columnCount != 7) : (ListenerUtil.mutListener.listen(8735) ? (columnCount == 7) : (columnCount &lt; 7))))))) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8740)) {</span>
<span class="nc" id="L195">                            mMetaDb.execSQL(&quot;ALTER TABLE widgetStatus &quot; + &quot;ADD COLUMN eta INTEGER NOT NULL DEFAULT '0'&quot;);</span>
                        }
<span class="nc bnc" id="L197" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8741)) {</span>
<span class="nc" id="L198">                            mMetaDb.execSQL(&quot;ALTER TABLE widgetStatus &quot; + &quot;ADD COLUMN time INTEGER NOT NULL DEFAULT '0'&quot;);</span>
                        }
                    }
                }
            } else {
<span class="nc bnc" id="L203" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8734)) {</span>
<span class="nc" id="L204">                    mMetaDb.execSQL(&quot;CREATE TABLE IF NOT EXISTS widgetStatus (&quot; + &quot;deckId INTEGER NOT NULL PRIMARY KEY, &quot; + &quot;deckName TEXT NOT NULL, &quot; + &quot;newCards INTEGER NOT NULL, &quot; + &quot;lrnCards INTEGER NOT NULL, &quot; + &quot;dueCards INTEGER NOT NULL, &quot; + &quot;progress INTEGER NOT NULL, &quot; + &quot;eta INTEGER NOT NULL)&quot;);</span>
                }
            }
        }
<span class="nc" id="L208">    }</span>

    /**
     * Open the meta-db but only if it currently closed.
     */
    private static void openDBIfClosed(Context context) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8746)) {</span>
<span class="nc bnc" id="L215" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(8744) ? (mMetaDb == null &amp;&amp; !mMetaDb.isOpen()) : (mMetaDb == null || !mMetaDb.isOpen()))) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8745)) {</span>
<span class="nc" id="L217">                    openDB(context);</span>
                }
            }
        }
<span class="nc" id="L221">    }</span>

    /**
     * Close the meta-db.
     */
    public static void closeDB() {
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8751)) {</span>
<span class="nc bnc" id="L228" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(8747) ? (mMetaDb != null || mMetaDb.isOpen()) : (mMetaDb != null &amp;&amp; mMetaDb.isOpen()))) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8748)) {</span>
<span class="nc" id="L230">                    mMetaDb.close();</span>
                }
<span class="nc bnc" id="L232" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8749)) {</span>
<span class="nc" id="L233">                    mMetaDb = null;</span>
                }
<span class="nc bnc" id="L235" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8750)) {</span>
<span class="nc" id="L236">                    Timber.d(&quot;Closing MetaDB&quot;);</span>
                }
            }
        }
<span class="nc" id="L240">    }</span>

    /**
     * Reset the content of the meta-db, erasing all its content.
     */
    public static boolean resetDB(Context context) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8752)) {</span>
<span class="nc" id="L247">            openDBIfClosed(context);</span>
        }
        try {
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8754)) {</span>
<span class="nc" id="L251">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS languages;&quot;);</span>
            }
<span class="nc bnc" id="L253" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8755)) {</span>
<span class="nc" id="L254">                Timber.i(&quot;MetaDB:: Resetting all language assignment&quot;);</span>
            }
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8756)) {</span>
<span class="nc" id="L257">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS whiteboardState;&quot;);</span>
            }
<span class="nc bnc" id="L259" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8757)) {</span>
<span class="nc" id="L260">                Timber.i(&quot;MetaDB:: Resetting whiteboard state&quot;);</span>
            }
<span class="nc bnc" id="L262" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8758)) {</span>
<span class="nc" id="L263">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS customDictionary;&quot;);</span>
            }
<span class="nc bnc" id="L265" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8759)) {</span>
<span class="nc" id="L266">                Timber.i(&quot;MetaDB:: Resetting custom Dictionary&quot;);</span>
            }
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8760)) {</span>
<span class="nc" id="L269">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS widgetStatus;&quot;);</span>
            }
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8761)) {</span>
<span class="nc" id="L272">                Timber.i(&quot;MetaDB:: Resetting widget status&quot;);</span>
            }
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8762)) {</span>
<span class="nc" id="L275">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS smallWidgetStatus;&quot;);</span>
            }
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8763)) {</span>
<span class="nc" id="L278">                Timber.i(&quot;MetaDB:: Resetting small widget status&quot;);</span>
            }
<span class="nc bnc" id="L280" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8764)) {</span>
<span class="nc" id="L281">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS intentInformation;&quot;);</span>
            }
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8765)) {</span>
<span class="nc" id="L284">                Timber.i(&quot;MetaDB:: Resetting intentInformation&quot;);</span>
            }
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8766)) {</span>
<span class="nc" id="L287">                upgradeDB(mMetaDb, DATABASE_VERSION);</span>
            }
<span class="nc" id="L289">            return true;</span>
<span class="nc" id="L290">        } catch (Exception e) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8753)) {</span>
<span class="nc" id="L292">                Timber.e(e, &quot;Error resetting MetaDB &quot;);</span>
            }
        }
<span class="nc" id="L295">        return false;</span>
    }

    /**
     * Reset the language associations for all the decks and card models.
     */
    public static boolean resetLanguages(Context context) {
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8769)) {</span>
<span class="nc bnc" id="L303" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(8767) ? (mMetaDb == null &amp;&amp; !mMetaDb.isOpen()) : (mMetaDb == null || !mMetaDb.isOpen()))) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8768)) {</span>
<span class="nc" id="L305">                    openDB(context);</span>
                }
            }
        }
        try {
<span class="nc bnc" id="L310" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8771)) {</span>
<span class="nc" id="L311">                Timber.i(&quot;MetaDB:: Resetting all language assignments&quot;);</span>
            }
<span class="nc bnc" id="L313" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8772)) {</span>
<span class="nc" id="L314">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS languages;&quot;);</span>
            }
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8773)) {</span>
<span class="nc" id="L317">                upgradeDB(mMetaDb, DATABASE_VERSION);</span>
            }
<span class="nc" id="L319">            return true;</span>
<span class="nc" id="L320">        } catch (Exception e) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8770)) {</span>
<span class="nc" id="L322">                Timber.e(e, &quot;Error resetting MetaDB &quot;);</span>
            }
        }
<span class="nc" id="L325">        return false;</span>
    }

    /**
     * Reset the widget status.
     */
    public static boolean resetWidget(Context context) {
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8776)) {</span>
<span class="nc bnc" id="L333" title="All 10 branches missed.">            if ((ListenerUtil.mutListener.listen(8774) ? (mMetaDb == null &amp;&amp; !mMetaDb.isOpen()) : (mMetaDb == null || !mMetaDb.isOpen()))) {</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8775)) {</span>
<span class="nc" id="L335">                    openDB(context);</span>
                }
            }
        }
        try {
<span class="nc bnc" id="L340" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8778)) {</span>
<span class="nc" id="L341">                Timber.i(&quot;MetaDB:: Resetting widget status&quot;);</span>
            }
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8779)) {</span>
<span class="nc" id="L344">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS widgetStatus;&quot;);</span>
            }
<span class="nc bnc" id="L346" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8780)) {</span>
<span class="nc" id="L347">                mMetaDb.execSQL(&quot;DROP TABLE IF EXISTS smallWidgetStatus;&quot;);</span>
            }
<span class="nc bnc" id="L349" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8781)) {</span>
<span class="nc" id="L350">                upgradeDB(mMetaDb, DATABASE_VERSION);</span>
            }
<span class="nc" id="L352">            return true;</span>
<span class="nc" id="L353">        } catch (Exception e) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8777)) {</span>
<span class="nc" id="L355">                Timber.e(e, &quot;Error resetting widgetStatus and smallWidgetStatus&quot;);</span>
            }
        }
<span class="nc" id="L358">        return false;</span>
    }

    /**
     * Associates a language to a deck, model, and card model for a given type.
     *
     * @param qa the part of the card for which to store the association, {@link #LANGUAGES_QA_QUESTION},
     *            {@link #LANGUAGES_QA_ANSWER}, or {@link #LANGUAGES_QA_UNDEFINED}
     * @param language the language to associate, as a two-characters, lowercase string
     */
    public static void storeLanguage(Context context, long did, int ord, Sound.SoundSide qa, String language) {
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8782)) {</span>
<span class="nc" id="L370">            openDBIfClosed(context);</span>
        }
        try {
<span class="nc bnc" id="L373" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8788)) {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if (&quot;&quot;.equals(getLanguage(context, did, ord, qa))) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8786)) {</span>
<span class="nc" id="L376">                        mMetaDb.execSQL(&quot;INSERT INTO languages (did, ord, qa, language) &quot; + &quot; VALUES (?, ?, ?, ?);&quot;, new Object[] { did, ord, qa.getInt(), language });</span>
                    }
<span class="nc bnc" id="L378" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8787)) {</span>
<span class="nc" id="L379">                        Timber.v(&quot;Store language for deck %d&quot;, did);</span>
                    }
                } else {
<span class="nc bnc" id="L382" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8784)) {</span>
<span class="nc" id="L383">                        mMetaDb.execSQL(&quot;UPDATE languages SET language = ? WHERE did = ? AND ord = ? AND qa = ?;&quot;, new Object[] { language, did, ord, qa.getInt() });</span>
                    }
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8785)) {</span>
<span class="nc" id="L386">                        Timber.v(&quot;Update language for deck %d&quot;, did);</span>
                    }
                }
            }
<span class="nc" id="L390">        } catch (Exception e) {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8783)) {</span>
<span class="nc" id="L392">                Timber.e(e, &quot;Error storing language in MetaDB &quot;);</span>
            }
<span class="nc" id="L394">        }</span>
<span class="nc" id="L395">    }</span>

    /**
     * Returns the language associated with the given deck, model and card model, for the given type.
     *
     * @param qa the part of the card for which to store the association, {@link #LANGUAGES_QA_QUESTION},
     *            {@link #LANGUAGES_QA_ANSWER}, or {@link #LANGUAGES_QA_UNDEFINED} return the language associate with
     *            the type, as a two-characters, lowercase string, or the empty string if no association is defined
     */
    public static String getLanguage(Context context, long did, int ord, Sound.SoundSide qa) {
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8789)) {</span>
<span class="nc" id="L406">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L408">        String language = &quot;&quot;;</span>
<span class="nc" id="L409">        String query = &quot;SELECT language FROM languages WHERE did = ? AND ord = ? AND qa = ? LIMIT 1&quot;;</span>
<span class="nc" id="L410">        try (Cursor cur = mMetaDb.rawQuery(query, new String[] { Long.toString(did), Integer.toString(ord), Integer.toString(qa.getInt()) })) {</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8791)) {</span>
<span class="nc" id="L412">                Timber.v(&quot;getLanguage: %s&quot;, query);</span>
            }
<span class="nc bnc" id="L414" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8793)) {</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                if (cur.moveToNext()) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8792)) {</span>
<span class="nc" id="L417">                        language = cur.getString(0);</span>
                    }
                }
            }
<span class="nc" id="L421">        } catch (Exception e) {</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8790)) {</span>
<span class="nc" id="L423">                Timber.e(e, &quot;Error fetching language &quot;);</span>
            }
<span class="nc" id="L425">        }</span>
<span class="nc" id="L426">        return language;</span>
    }

    /**
     * Resets all the language associates for a given deck.
     *
     * @return whether an error occurred while resetting the language for the deck
     */
    public static boolean resetDeckLanguages(Context context, long did) {
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8794)) {</span>
<span class="nc" id="L436">            openDBIfClosed(context);</span>
        }
        try {
<span class="nc bnc" id="L439" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8796)) {</span>
<span class="nc" id="L440">                mMetaDb.execSQL(&quot;DELETE FROM languages WHERE did = ?;&quot;, new Long[] { did });</span>
            }
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8797)) {</span>
<span class="nc" id="L443">                Timber.i(&quot;MetaDB:: Resetting language assignment for deck %d&quot;, did);</span>
            }
<span class="nc" id="L445">            return true;</span>
<span class="nc" id="L446">        } catch (Exception e) {</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8795)) {</span>
<span class="nc" id="L448">                Timber.e(e, &quot;Error resetting deck language&quot;);</span>
            }
        }
<span class="nc" id="L451">        return false;</span>
    }

    /**
     * Returns the state of the whiteboard for the given deck.
     *
     * @return 1 if the whiteboard should be shown, 0 otherwise
     */
    public static boolean getWhiteboardState(Context context, long did) {
<span class="nc bnc" id="L460" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8798)) {</span>
<span class="nc" id="L461">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L463">        try (Cursor cur = mMetaDb.rawQuery(&quot;SELECT state FROM whiteboardState  WHERE did = ?&quot;, new String[] { Long.toString(did) })) {</span>
<span class="nc" id="L464">            return DatabaseUtil.getScalarBoolean(cur);</span>
<span class="nc" id="L465">        } catch (Exception e) {</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8799)) {</span>
<span class="nc" id="L467">                Timber.e(e, &quot;Error retrieving whiteboard state from MetaDB &quot;);</span>
            }
<span class="nc" id="L469">            return false;</span>
        }
    }

    /**
     * Stores the state of the whiteboard for a given deck.
     *
     * @param did deck id to store whiteboard state for
     * @param whiteboardState 1 if the whiteboard should be shown, 0 otherwise
     */
    public static void storeWhiteboardState(Context context, long did, boolean whiteboardState) {
<span class="nc bnc" id="L480" title="All 2 branches missed.">        int state = (whiteboardState) ? 1 : 0;</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8800)) {</span>
<span class="nc" id="L482">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L484">        try (Cursor cur = mMetaDb.rawQuery(&quot;SELECT _id FROM whiteboardState WHERE did = ?&quot;, new String[] { Long.toString(did) })) {</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8806)) {</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                if (cur.moveToNext()) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8804)) {</span>
<span class="nc" id="L488">                        mMetaDb.execSQL(&quot;UPDATE whiteboardState SET did = ?, state=? WHERE _id=?;&quot;, new Object[] { did, state, cur.getString(0) });</span>
                    }
<span class="nc bnc" id="L490" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8805)) {</span>
<span class="nc" id="L491">                        Timber.d(&quot;Store whiteboard state (%d) for deck %d&quot;, state, did);</span>
                    }
                } else {
<span class="nc bnc" id="L494" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8802)) {</span>
<span class="nc" id="L495">                        mMetaDb.execSQL(&quot;INSERT INTO whiteboardState (did, state) VALUES (?, ?)&quot;, new Object[] { did, state });</span>
                    }
<span class="nc bnc" id="L497" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8803)) {</span>
<span class="nc" id="L498">                        Timber.d(&quot;Store whiteboard state (%d) for deck %d&quot;, state, did);</span>
                    }
                }
            }
<span class="nc" id="L502">        } catch (Exception e) {</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8801)) {</span>
<span class="nc" id="L504">                Timber.e(e, &quot;Error storing whiteboard state in MetaDB &quot;);</span>
            }
<span class="nc" id="L506">        }</span>
<span class="nc" id="L507">    }</span>

    /**
     * Returns the state of the whiteboard for the given deck.
     *
     * @return 1 if the whiteboard should be shown, 0 otherwise
     */
    public static boolean getWhiteboardVisibility(Context context, long did) {
<span class="nc bnc" id="L515" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8807)) {</span>
<span class="nc" id="L516">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L518">        try (Cursor cur = mMetaDb.rawQuery(&quot;SELECT visible FROM whiteboardState WHERE did = ?&quot;, new String[] { Long.toString(did) })) {</span>
<span class="nc" id="L519">            return DatabaseUtil.getScalarBoolean(cur);</span>
<span class="nc" id="L520">        } catch (Exception e) {</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8808)) {</span>
<span class="nc" id="L522">                Timber.e(e, &quot;Error retrieving whiteboard state from MetaDB &quot;);</span>
            }
<span class="nc" id="L524">            return false;</span>
        }
    }

    /**
     * Stores the state of the whiteboard for a given deck.
     *
     * @param did deck id to store whiteboard state for
     * @param isVisible 1 if the whiteboard should be shown, 0 otherwise
     */
    public static void storeWhiteboardVisibility(Context context, long did, boolean isVisible) {
<span class="nc bnc" id="L535" title="All 2 branches missed.">        int isVisibleState = (isVisible) ? 1 : 0;</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8809)) {</span>
<span class="nc" id="L537">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L539">        try (Cursor cur = mMetaDb.rawQuery(&quot;SELECT _id FROM whiteboardState WHERE did  = ?&quot;, new String[] { Long.toString(did) })) {</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8815)) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                if (cur.moveToNext()) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8813)) {</span>
<span class="nc" id="L543">                        mMetaDb.execSQL(&quot;UPDATE whiteboardState SET did = ?, visible= ?  WHERE _id=?;&quot;, new Object[] { did, isVisibleState, cur.getString(0) });</span>
                    }
<span class="nc bnc" id="L545" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8814)) {</span>
<span class="nc" id="L546">                        Timber.d(&quot;Store whiteboard visibility (%d) for deck %d&quot;, isVisibleState, did);</span>
                    }
                } else {
<span class="nc bnc" id="L549" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8811)) {</span>
<span class="nc" id="L550">                        mMetaDb.execSQL(&quot;INSERT INTO whiteboardState (did, visible) VALUES (?, ?)&quot;, new Object[] { did, isVisibleState });</span>
                    }
<span class="nc bnc" id="L552" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8812)) {</span>
<span class="nc" id="L553">                        Timber.d(&quot;Store whiteboard visibility (%d) for deck %d&quot;, isVisibleState, did);</span>
                    }
                }
            }
<span class="nc" id="L557">        } catch (Exception e) {</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8810)) {</span>
<span class="nc" id="L559">                Timber.e(e, &quot;Error storing whiteboard visibility in MetaDB &quot;);</span>
            }
<span class="nc" id="L561">        }</span>
<span class="nc" id="L562">    }</span>

    /**
     * Returns the pen color of the whiteboard for the given deck.
     */
    public static WhiteboardPenColor getWhiteboardPenColor(Context context, long did) {
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8816)) {</span>
<span class="nc" id="L569">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L571">        try (Cursor cur = mMetaDb.rawQuery(&quot;SELECT lightpencolor, darkpencolor FROM whiteboardState WHERE did = ?&quot;, new String[] { Long.toString(did) })) {</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8818)) {</span>
<span class="nc" id="L573">                cur.moveToFirst();</span>
            }
<span class="nc" id="L575">            Integer light = DatabaseUtil.getInteger(cur, 0);</span>
<span class="nc" id="L576">            Integer dark = DatabaseUtil.getInteger(cur, 1);</span>
<span class="nc" id="L577">            return new WhiteboardPenColor(light, dark);</span>
<span class="nc" id="L578">        } catch (Exception e) {</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8817)) {</span>
<span class="nc" id="L580">                Timber.e(e, &quot;Error retrieving whiteboard pen color from MetaDB &quot;);</span>
            }
<span class="nc" id="L582">            return WhiteboardPenColor.getDefault();</span>
        }
    }

    /**
     * Stores the pen color of the whiteboard for a given deck.
     *
     * @param did deck id to store whiteboard state for
     * @param isLight if dark mode is disabled
     * @param value The new color code to store
     */
    public static void storeWhiteboardPenColor(Context context, long did, boolean isLight, Integer value) {
<span class="nc bnc" id="L594" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8819)) {</span>
<span class="nc" id="L595">            openDBIfClosed(context);</span>
        }
<span class="nc bnc" id="L597" title="All 2 branches missed.">        String columnName = isLight ? &quot;lightpencolor&quot; : &quot;darkpencolor&quot;;</span>
<span class="nc" id="L598">        try (Cursor cur = mMetaDb.rawQuery(&quot;SELECT _id FROM whiteboardState WHERE did  = ?&quot;, new String[] { Long.toString(did) })) {</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8823)) {</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">                if (cur.moveToNext()) {</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8822)) {</span>
<span class="nc" id="L602">                        mMetaDb.execSQL(&quot;UPDATE whiteboardState SET did = ?, &quot; + columnName + &quot;= ? &quot; + &quot; WHERE _id=?;&quot;, new Object[] { did, value, cur.getString(0) });</span>
                    }
                } else {
<span class="nc" id="L605">                    String sql = &quot;INSERT INTO whiteboardState (did, &quot; + columnName + &quot;) VALUES (?, ?)&quot;;</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8821)) {</span>
<span class="nc" id="L607">                        mMetaDb.execSQL(sql, new Object[] { did, value });</span>
                    }
                }
            }
<span class="nc bnc" id="L611" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8824)) {</span>
<span class="nc" id="L612">                Timber.d(&quot;Store whiteboard %s (%d) for deck %d&quot;, columnName, value, did);</span>
            }
<span class="nc" id="L614">        } catch (Exception e) {</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8820)) {</span>
<span class="nc" id="L616">                Timber.w(e, &quot;Error storing whiteboard color in MetaDB&quot;);</span>
            }
<span class="nc" id="L618">        }</span>
<span class="nc" id="L619">    }</span>

    /**
     * Returns a custom dictionary associated to a deck
     *
     * @return integer number of dictionary, -1 if not set (standard dictionary will be used)
     */
    public static int getLookupDictionary(Context context, long did) {
<span class="nc bnc" id="L627" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8825)) {</span>
<span class="nc" id="L628">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L630">        try (Cursor cur = mMetaDb.rawQuery(&quot;SELECT dictionary FROM customDictionary WHERE did = ?&quot;, new String[] { Long.toString(did) })) {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">            if (cur.moveToNext()) {</span>
<span class="nc" id="L632">                return cur.getInt(0);</span>
            } else {
<span class="nc" id="L634">                return -1;</span>
            }
<span class="nc bnc" id="L636" title="All 2 branches missed.">        } catch (Exception e) {</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8826)) {</span>
<span class="nc" id="L638">                Timber.e(e, &quot;Error retrieving custom dictionary from MetaDB &quot;);</span>
            }
<span class="nc" id="L640">            return -1;</span>
        }
    }

    /**
     * Stores a custom dictionary for a given deck.
     *
     * @param dictionary integer number of dictionary, -1 if not set (standard dictionary will be used)
     */
    public static void storeLookupDictionary(Context context, long did, int dictionary) {
<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8827)) {</span>
<span class="nc" id="L651">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L653">        try (Cursor cur = mMetaDb.rawQuery(&quot;SELECT _id FROM customDictionary WHERE did = ?&quot;, new String[] { Long.toString(did) })) {</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8833)) {</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                if (cur.moveToNext()) {</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8831)) {</span>
<span class="nc" id="L657">                        mMetaDb.execSQL(&quot;UPDATE customDictionary SET did = ?, dictionary=? WHERE _id=?;&quot;, new Object[] { did, dictionary, cur.getString(0) });</span>
                    }
<span class="nc bnc" id="L659" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8832)) {</span>
<span class="nc" id="L660">                        Timber.i(&quot;MetaDB:: Store custom dictionary (%d) for deck %d&quot;, dictionary, did);</span>
                    }
                } else {
<span class="nc bnc" id="L663" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8829)) {</span>
<span class="nc" id="L664">                        mMetaDb.execSQL(&quot;INSERT INTO customDictionary (did, dictionary) VALUES (?, ?)&quot;, new Object[] { did, dictionary });</span>
                    }
<span class="nc bnc" id="L666" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8830)) {</span>
<span class="nc" id="L667">                        Timber.i(&quot;MetaDB:: Store custom dictionary (%d) for deck %d&quot;, dictionary, did);</span>
                    }
                }
            }
<span class="nc" id="L671">        } catch (Exception e) {</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8828)) {</span>
<span class="nc" id="L673">                Timber.e(e, &quot;Error storing custom dictionary to MetaDB &quot;);</span>
            }
<span class="nc" id="L675">        }</span>
<span class="nc" id="L676">    }</span>

    /**
     * Return the current status of the widget.
     *
     * @return [due, eta]
     */
    public static int[] getWidgetSmallStatus(Context context) {
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8834)) {</span>
<span class="nc" id="L685">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L687">        Cursor cursor = null;</span>
        try {
<span class="nc bnc" id="L689" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8839)) {</span>
<span class="nc" id="L690">                cursor = mMetaDb.query(&quot;smallWidgetStatus&quot;, new String[] { &quot;due&quot;, &quot;eta&quot; }, null, null, null, null, null);</span>
            }
<span class="nc bnc" id="L692" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8840)) {</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                if (cursor.moveToNext()) {</span>
<span class="nc" id="L694">                    return new int[] { cursor.getInt(0), cursor.getInt(1) };</span>
                }
            }
<span class="nc" id="L697">        } catch (SQLiteException e) {</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8835)) {</span>
<span class="nc" id="L699">                Timber.e(e, &quot;Error while querying widgetStatus&quot;);</span>
            }
        } finally {
<span class="nc bnc" id="L702" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8838)) {</span>
<span class="nc bnc" id="L703" title="All 10 branches missed.">                if ((ListenerUtil.mutListener.listen(8836) ? (cursor != null || !cursor.isClosed()) : (cursor != null &amp;&amp; !cursor.isClosed()))) {</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8837)) {</span>
<span class="nc" id="L705">                        cursor.close();</span>
                    }
                }
            }
        }
<span class="nc" id="L710">        return new int[] { 0, 0 };</span>
    }

    public static int getNotificationStatus(Context context) {
<span class="nc bnc" id="L714" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8841)) {</span>
<span class="nc" id="L715">            openDBIfClosed(context);</span>
        }
<span class="nc" id="L717">        Cursor cursor = null;</span>
<span class="nc" id="L718">        int due = 0;</span>
        try {
<span class="nc bnc" id="L720" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8846)) {</span>
<span class="nc" id="L721">                cursor = mMetaDb.query(&quot;smallWidgetStatus&quot;, new String[] { &quot;due&quot; }, null, null, null, null, null);</span>
            }
<span class="nc bnc" id="L723" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8847)) {</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">                if (cursor.moveToFirst()) {</span>
<span class="nc" id="L725">                    return cursor.getInt(0);</span>
                }
            }
<span class="nc" id="L728">        } catch (SQLiteException e) {</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8842)) {</span>
<span class="nc" id="L730">                Timber.e(e, &quot;Error while querying widgetStatus&quot;);</span>
            }
        } finally {
<span class="nc bnc" id="L733" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8845)) {</span>
<span class="nc bnc" id="L734" title="All 10 branches missed.">                if ((ListenerUtil.mutListener.listen(8843) ? (cursor != null || !cursor.isClosed()) : (cursor != null &amp;&amp; !cursor.isClosed()))) {</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8844)) {</span>
<span class="nc" id="L736">                        cursor.close();</span>
                    }
                }
            }
        }
<span class="nc" id="L741">        return due;</span>
    }

    public static void storeSmallWidgetStatus(Context context, Pair&lt;Integer, Integer&gt; status) {
<span class="nc bnc" id="L745" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8848)) {</span>
<span class="nc" id="L746">            openDBIfClosed(context);</span>
        }
        try {
<span class="nc bnc" id="L749" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8853)) {</span>
<span class="nc" id="L750">                mMetaDb.beginTransaction();</span>
            }
            try {
<span class="nc bnc" id="L753" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8855)) {</span>
                    // First clear all the existing content.
<span class="nc" id="L755">                    mMetaDb.execSQL(&quot;DELETE FROM smallWidgetStatus&quot;);</span>
                }
<span class="nc bnc" id="L757" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8856)) {</span>
<span class="nc" id="L758">                    mMetaDb.execSQL(&quot;INSERT INTO smallWidgetStatus(due, eta) VALUES (?, ?)&quot;, new Object[] { status.first, status.second });</span>
                }
<span class="nc bnc" id="L760" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8857)) {</span>
<span class="nc" id="L761">                    mMetaDb.setTransactionSuccessful();</span>
                }
            } finally {
<span class="nc bnc" id="L764" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8854)) {</span>
<span class="nc" id="L765">                    mMetaDb.endTransaction();</span>
                }
            }
<span class="nc" id="L768">        } catch (IllegalStateException e) {</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8849)) {</span>
<span class="nc" id="L770">                Timber.e(e, &quot;MetaDB.storeSmallWidgetStatus: failed&quot;);</span>
            }
<span class="nc" id="L772">        } catch (SQLiteException e) {</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8850)) {</span>
<span class="nc" id="L774">                Timber.e(e, &quot;MetaDB.storeSmallWidgetStatus: failed&quot;);</span>
            }
<span class="nc bnc" id="L776" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8851)) {</span>
<span class="nc" id="L777">                closeDB();</span>
            }
<span class="nc bnc" id="L779" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(8852)) {</span>
<span class="nc" id="L780">                Timber.i(&quot;MetaDB:: Trying to reset Widget: %b&quot;, resetWidget(context));</span>
            }
<span class="nc" id="L782">        }</span>
<span class="nc" id="L783">    }</span>

    public static void close() {
<span class="nc bnc" id="L786" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(8860)) {</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">            if (mMetaDb != null) {</span>
                try {
<span class="nc bnc" id="L789" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8859)) {</span>
<span class="nc" id="L790">                        mMetaDb.close();</span>
                    }
<span class="nc" id="L792">                } catch (Exception e) {</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(8858)) {</span>
<span class="nc" id="L794">                        Timber.w(e, &quot;Failed to close MetaDB&quot;);</span>
                    }
<span class="nc" id="L796">                }</span>
            }
        }
<span class="nc" id="L799">    }</span>

    private static class DatabaseUtil {

        private static boolean getScalarBoolean(Cursor cur) {
<span class="nc bnc" id="L804" title="All 2 branches missed.">            if (cur.moveToNext()) {</span>
<span class="nc bnc" id="L805" title="All 22 branches missed.">                return (ListenerUtil.mutListener.listen(8865) ? (cur.getInt(0) &gt;= 0) : (ListenerUtil.mutListener.listen(8864) ? (cur.getInt(0) &lt;= 0) : (ListenerUtil.mutListener.listen(8863) ? (cur.getInt(0) &lt; 0) : (ListenerUtil.mutListener.listen(8862) ? (cur.getInt(0) != 0) : (ListenerUtil.mutListener.listen(8861) ? (cur.getInt(0) == 0) : (cur.getInt(0) &gt; 0))))));</span>
            } else {
<span class="nc" id="L807">                return false;</span>
            }
        }

        // API LEVEL
        @SuppressWarnings(&quot;TryFinallyCanBeTryWithResources&quot;)
        private static int getTableColumnCount(SQLiteDatabase mMetaDb, String tableName) {
<span class="nc" id="L814">            Cursor c = null;</span>
            try {
<span class="nc bnc" id="L816" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8868)) {</span>
<span class="nc" id="L817">                    c = mMetaDb.rawQuery(&quot;PRAGMA table_info(&quot; + tableName + &quot;)&quot;, null);</span>
                }
<span class="nc" id="L819">                return c.getCount();</span>
            } finally {
<span class="nc bnc" id="L821" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(8867)) {</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">                    if (c != null) {</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(8866)) {</span>
<span class="nc" id="L824">                            c.close();</span>
                        }
                    }
                }
            }
        }

        @Nullable
        public static Integer getInteger(@NonNull Cursor cur, int columnIndex) {
<span class="nc bnc" id="L833" title="All 2 branches missed.">            return cur.isNull(columnIndex) ? null : cur.getInt(columnIndex);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>