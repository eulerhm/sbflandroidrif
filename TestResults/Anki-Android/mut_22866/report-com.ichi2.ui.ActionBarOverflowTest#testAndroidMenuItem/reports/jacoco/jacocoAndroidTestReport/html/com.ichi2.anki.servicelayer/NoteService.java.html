<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NoteService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.anki.servicelayer</a> &gt; <span class="el_source">NoteService.java</span></div><h1>NoteService.java</h1><pre class="source lang-java linenums">/**
 * *************************************************************************************
 *  Copyright (c) 2013 Bibek Shrestha &lt;bibekshrestha@gmail.com&gt;                          *
 *  Copyright (c) 2013 Zaur Molotnikov &lt;qutorial@gmail.com&gt;                              *
 *  Copyright (c) 2013 Nicolas Raoul &lt;nicolas.raoul@gmail.com&gt;                           *
 *  Copyright (c) 2013 Flavio Lerda &lt;flerda@gmail.com&gt;                                   *
 *                                                                                       *
 *  This program is free software; you can redistribute it and/or modify it under        *
 *  the terms of the GNU General Public License as published by the Free Software        *
 *  Foundation; either version 3 of the License, or (at your option) any later           *
 *  version.                                                                             *
 *                                                                                       *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY      *
 *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A      *
 *  PARTICULAR PURPOSE. See the GNU General Public License for more details.             *
 *                                                                                       *
 *  You should have received a copy of the GNU General Public License along with         *
 *  this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                           *
 * **************************************************************************************
 */
package com.ichi2.anki.servicelayer;

import com.ichi2.anki.AnkiDroidApp;
import com.ichi2.anki.multimediacard.IMultimediaEditableNote;
import com.ichi2.anki.multimediacard.fields.AudioClipField;
import com.ichi2.anki.multimediacard.fields.AudioRecordingField;
import com.ichi2.anki.multimediacard.fields.IField;
import com.ichi2.anki.multimediacard.fields.ImageField;
import com.ichi2.anki.multimediacard.fields.TextField;
import com.ichi2.anki.multimediacard.impl.MultimediaEditableNote;
import com.ichi2.libanki.Collection;
import com.ichi2.libanki.Note;
import com.ichi2.libanki.exception.EmptyMediaException;
import com.ichi2.utils.JSONArray;
import com.ichi2.utils.JSONException;
import com.ichi2.utils.JSONObject;
import java.io.File;
import java.io.IOException;
import timber.log.Timber;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

<span class="nc" id="L42">public class NoteService {</span>

    /**
     * Creates an empty Note from given Model
     *
     * @param model the model in JSOBObject format
     * @return a new note instance
     */
    public static MultimediaEditableNote createEmptyNote(JSONObject model) {
        try {
<span class="nc" id="L52">            JSONArray fieldsArray = model.getJSONArray(&quot;flds&quot;);</span>
<span class="nc" id="L53">            int numOfFields = fieldsArray.length();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(3074)) {</span>
<span class="nc bnc" id="L55" title="All 22 branches missed.">                if ((ListenerUtil.mutListener.listen(3062) ? (numOfFields &gt;= 0) : (ListenerUtil.mutListener.listen(3061) ? (numOfFields &lt;= 0) : (ListenerUtil.mutListener.listen(3060) ? (numOfFields &lt; 0) : (ListenerUtil.mutListener.listen(3059) ? (numOfFields != 0) : (ListenerUtil.mutListener.listen(3058) ? (numOfFields == 0) : (numOfFields &gt; 0))))))) {</span>
<span class="nc" id="L56">                    MultimediaEditableNote note = new MultimediaEditableNote();</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3063)) {</span>
<span class="nc" id="L58">                        note.setNumFields(numOfFields);</span>
                    }
<span class="nc bnc" id="L60" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3072)) {</span>
                        {
<span class="nc" id="L62">                            long _loopCounter78 = 0;</span>
<span class="nc bnc" id="L63" title="All 22 branches missed.">                            for (int i = 0; (ListenerUtil.mutListener.listen(3071) ? (i &gt;= numOfFields) : (ListenerUtil.mutListener.listen(3070) ? (i &lt;= numOfFields) : (ListenerUtil.mutListener.listen(3069) ? (i &gt; numOfFields) : (ListenerUtil.mutListener.listen(3068) ? (i != numOfFields) : (ListenerUtil.mutListener.listen(3067) ? (i == numOfFields) : (i &lt; numOfFields)))))); i++) {</span>
<span class="nc" id="L64">                                ListenerUtil.loopListener.listen(&quot;_loopCounter78&quot;, ++_loopCounter78);</span>
<span class="nc" id="L65">                                JSONObject fieldObject = fieldsArray.getJSONObject(i);</span>
<span class="nc" id="L66">                                TextField uiTextField = new TextField();</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(3064)) {</span>
<span class="nc" id="L68">                                    uiTextField.setName(fieldObject.getString(&quot;name&quot;));</span>
                                }
<span class="nc bnc" id="L70" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(3065)) {</span>
<span class="nc" id="L71">                                    uiTextField.setText(fieldObject.getString(&quot;name&quot;));</span>
                                }
<span class="nc bnc" id="L73" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(3066)) {</span>
<span class="nc" id="L74">                                    note.setField(i, uiTextField);</span>
                                }
                            }
                        }
                    }
<span class="nc bnc" id="L79" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3073)) {</span>
<span class="nc" id="L80">                        note.setModelId(model.getLong(&quot;id&quot;));</span>
                    }
<span class="nc" id="L82">                    return note;</span>
                }
            }
<span class="nc" id="L85">        } catch (JSONException e) {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(3057)) {</span>
                // TODO Auto-generated catch block
<span class="nc" id="L88">                e.printStackTrace();</span>
            }
<span class="nc" id="L90">        }</span>
<span class="nc" id="L91">        return null;</span>
    }

    public static void updateMultimediaNoteFromJsonNote(Collection col, final Note editorNoteSrc, final IMultimediaEditableNote noteDst) {
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3076)) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (noteDst instanceof MultimediaEditableNote) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3075)) {</span>
<span class="nc" id="L98">                    updateMultimediaNoteFromFields(col, editorNoteSrc.getFields(), editorNoteSrc.getMid(), (MultimediaEditableNote) noteDst);</span>
                }
            }
        }
<span class="nc" id="L102">    }</span>

    public static void updateMultimediaNoteFromFields(Collection col, String[] fields, long modelId, MultimediaEditableNote mmNote) {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3090)) {</span>
            {
<span class="nc" id="L107">                long _loopCounter79 = 0;</span>
<span class="nc bnc" id="L108" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(3089) ? (i &gt;= fields.length) : (ListenerUtil.mutListener.listen(3088) ? (i &lt;= fields.length) : (ListenerUtil.mutListener.listen(3087) ? (i &gt; fields.length) : (ListenerUtil.mutListener.listen(3086) ? (i != fields.length) : (ListenerUtil.mutListener.listen(3085) ? (i == fields.length) : (i &lt; fields.length)))))); i++) {</span>
<span class="nc" id="L109">                    ListenerUtil.loopListener.listen(&quot;_loopCounter79&quot;, ++_loopCounter79);</span>
<span class="nc" id="L110">                    String value = fields[i];</span>
<span class="nc" id="L111">                    IField field = null;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3082)) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                        if (value.startsWith(&quot;&lt;img&quot;)) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3081)) {</span>
<span class="nc" id="L115">                                field = new ImageField();</span>
                            }
<span class="nc bnc" id="L117" title="All 10 branches missed.">                        } else if ((ListenerUtil.mutListener.listen(3077) ? (value.startsWith(&quot;[sound:&quot;) || value.contains(&quot;rec&quot;)) : (value.startsWith(&quot;[sound:&quot;) &amp;&amp; value.contains(&quot;rec&quot;)))) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3080)) {</span>
<span class="nc" id="L119">                                field = new AudioRecordingField();</span>
                            }
<span class="nc bnc" id="L121" title="All 2 branches missed.">                        } else if (value.startsWith(&quot;[sound:&quot;)) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3079)) {</span>
<span class="nc" id="L123">                                field = new AudioClipField();</span>
                            }
                        } else {
<span class="nc bnc" id="L126" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3078)) {</span>
<span class="nc" id="L127">                                field = new TextField();</span>
                            }
                        }
                    }
<span class="nc bnc" id="L131" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3083)) {</span>
<span class="nc" id="L132">                        field.setFormattedString(col, value);</span>
                    }
<span class="nc bnc" id="L134" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3084)) {</span>
<span class="nc" id="L135">                        mmNote.setField(i, field);</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3091)) {</span>
<span class="nc" id="L141">            mmNote.setModelId(modelId);</span>
        }
<span class="nc" id="L143">    }</span>

    /**
     * Updates the JsonNote field values from MultimediaEditableNote When both notes are using the same Model, it updaes
     * the destination field values with source values. If models are different it throws an Exception
     *
     * @param noteSrc
     * @param editorNoteDst
     */
    public static void updateJsonNoteFromMultimediaNote(final IMultimediaEditableNote noteSrc, final Note editorNoteDst) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3105)) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (noteSrc instanceof MultimediaEditableNote) {</span>
<span class="nc" id="L155">                MultimediaEditableNote mmNote = (MultimediaEditableNote) noteSrc;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3097)) {</span>
<span class="nc bnc" id="L157" title="All 22 branches missed.">                    if ((ListenerUtil.mutListener.listen(3096) ? (mmNote.getModelId() &gt;= editorNoteDst.getMid()) : (ListenerUtil.mutListener.listen(3095) ? (mmNote.getModelId() &lt;= editorNoteDst.getMid()) : (ListenerUtil.mutListener.listen(3094) ? (mmNote.getModelId() &gt; editorNoteDst.getMid()) : (ListenerUtil.mutListener.listen(3093) ? (mmNote.getModelId() &lt; editorNoteDst.getMid()) : (ListenerUtil.mutListener.listen(3092) ? (mmNote.getModelId() == editorNoteDst.getMid()) : (mmNote.getModelId() != editorNoteDst.getMid()))))))) {</span>
<span class="nc" id="L158">                        throw new RuntimeException(&quot;Source and Destination Note ID do not match.&quot;);</span>
                    }
                }
<span class="nc" id="L161">                int totalFields = mmNote.getNumberOfFields();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(3104)) {</span>
                    {
<span class="nc" id="L164">                        long _loopCounter80 = 0;</span>
<span class="nc bnc" id="L165" title="All 22 branches missed.">                        for (int i = 0; (ListenerUtil.mutListener.listen(3103) ? (i &gt;= totalFields) : (ListenerUtil.mutListener.listen(3102) ? (i &lt;= totalFields) : (ListenerUtil.mutListener.listen(3101) ? (i &gt; totalFields) : (ListenerUtil.mutListener.listen(3100) ? (i != totalFields) : (ListenerUtil.mutListener.listen(3099) ? (i == totalFields) : (i &lt; totalFields)))))); i++) {</span>
<span class="nc" id="L166">                            ListenerUtil.loopListener.listen(&quot;_loopCounter80&quot;, ++_loopCounter80);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3098)) {</span>
<span class="nc" id="L168">                                editorNoteDst.values()[i] = mmNote.getField(i).getFormattedValue();</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L175">    }</span>

    /**
     * Saves the multimedia associated with this card to proper path inside anki folder. For each field associated with
     * the note it checks for the following condition a. The field content should have changed b. The field content does
     * not already point to a media inside anki media path If both condition satisfies then it copies the file inside
     * the media path and deletes the file referenced by the note
     *
     * @param noteNew
     */
    public static void saveMedia(Collection col, final MultimediaEditableNote noteNew) {
        // {
<span class="nc" id="L187">        int fieldCount = noteNew.getNumberOfFields();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3112)) {</span>
            {
<span class="nc" id="L190">                long _loopCounter81 = 0;</span>
<span class="nc bnc" id="L191" title="All 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(3111) ? (i &gt;= fieldCount) : (ListenerUtil.mutListener.listen(3110) ? (i &lt;= fieldCount) : (ListenerUtil.mutListener.listen(3109) ? (i &gt; fieldCount) : (ListenerUtil.mutListener.listen(3108) ? (i != fieldCount) : (ListenerUtil.mutListener.listen(3107) ? (i == fieldCount) : (i &lt; fieldCount)))))); i++) {</span>
<span class="nc" id="L192">                    ListenerUtil.loopListener.listen(&quot;_loopCounter81&quot;, ++_loopCounter81);</span>
<span class="nc" id="L193">                    IField newField = noteNew.getField(i);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3106)) {</span>
<span class="nc" id="L195">                        importMediaToDirectory(col, newField);</span>
                    }
                }
            }
        }
<span class="nc" id="L200">    }</span>

    /**
     * Considering the field is new, if it has media handle it
     *
     * @param field
     */
    private static void importMediaToDirectory(Collection col, IField field) {
<span class="nc" id="L208">        String tmpMediaPath = null;</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3115)) {</span>
<span class="nc bnc" id="L210" title="All 3 branches missed.">            switch(field.getType()) {</span>
                case AUDIO_RECORDING:
                case AUDIO_CLIP:
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3113)) {</span>
<span class="nc" id="L214">                        tmpMediaPath = field.getAudioPath();</span>
                    }
                    break;
                case IMAGE:
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3114)) {</span>
<span class="nc" id="L219">                        tmpMediaPath = field.getImagePath();</span>
                    }
                    break;
                case TEXT:
                default:
                    break;
            }
        }
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(3131)) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (tmpMediaPath != null) {</span>
                try {
<span class="nc" id="L230">                    File inFile = new File(tmpMediaPath);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3130)) {</span>
<span class="nc bnc" id="L232" title="All 50 branches missed.">                        if ((ListenerUtil.mutListener.listen(3123) ? (inFile.exists() || (ListenerUtil.mutListener.listen(3122) ? (inFile.length() &gt;= 0) : (ListenerUtil.mutListener.listen(3121) ? (inFile.length() &lt;= 0) : (ListenerUtil.mutListener.listen(3120) ? (inFile.length() &lt; 0) : (ListenerUtil.mutListener.listen(3119) ? (inFile.length() != 0) : (ListenerUtil.mutListener.listen(3118) ? (inFile.length() == 0) : (inFile.length() &gt; 0))))))) : (inFile.exists() &amp;&amp; (ListenerUtil.mutListener.listen(3122) ? (inFile.length() &gt;= 0) : (ListenerUtil.mutListener.listen(3121) ? (inFile.length() &lt;= 0) : (ListenerUtil.mutListener.listen(3120) ? (inFile.length() &lt; 0) : (ListenerUtil.mutListener.listen(3119) ? (inFile.length() != 0) : (ListenerUtil.mutListener.listen(3118) ? (inFile.length() == 0) : (inFile.length() &gt; 0))))))))) {</span>
<span class="nc" id="L233">                            String fname = col.getMedia().addFile(inFile);</span>
<span class="nc" id="L234">                            File outFile = new File(col.getMedia().dir(), fname);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3126)) {</span>
<span class="nc bnc" id="L236" title="All 10 branches missed.">                                if ((ListenerUtil.mutListener.listen(3124) ? (field.hasTemporaryMedia() || !outFile.getAbsolutePath().equals(tmpMediaPath)) : (field.hasTemporaryMedia() &amp;&amp; !outFile.getAbsolutePath().equals(tmpMediaPath)))) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(3125)) {</span>
                                        // Delete original
<span class="nc" id="L239">                                        inFile.delete();</span>
                                    }
                                }
                            }
<span class="nc bnc" id="L243" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(3129)) {</span>
<span class="nc bnc" id="L244" title="All 3 branches missed.">                                switch(field.getType()) {</span>
                                    case AUDIO_RECORDING:
                                    case AUDIO_CLIP:
<span class="nc bnc" id="L247" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(3127)) {</span>
<span class="nc" id="L248">                                            field.setAudioPath(outFile.getAbsolutePath());</span>
                                        }
                                        break;
                                    case IMAGE:
<span class="nc bnc" id="L252" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(3128)) {</span>
<span class="nc" id="L253">                                            field.setImagePath(outFile.getAbsolutePath());</span>
                                        }
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                    }
<span class="nc" id="L262">                } catch (IOException e) {</span>
<span class="nc" id="L263">                    throw new RuntimeException(e);</span>
<span class="nc" id="L264">                } catch (EmptyMediaException mediaException) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3116)) {</span>
                        // This shouldn't happen, but we're fine to ignore it if it does.
<span class="nc" id="L267">                        Timber.w(mediaException);</span>
                    }
<span class="nc bnc" id="L269" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(3117)) {</span>
<span class="nc" id="L270">                        AnkiDroidApp.sendExceptionReport(mediaException, &quot;noteService::importMediaToDirectory&quot;);</span>
                    }
<span class="nc" id="L272">                }</span>
            }
        }
<span class="nc" id="L275">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>