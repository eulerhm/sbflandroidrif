<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NoteImporter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AnkiDroid</a> &gt; <a href="index.source.html" class="el_package">com.ichi2.libanki.importer</a> &gt; <span class="el_source">NoteImporter.java</span></div><h1>NoteImporter.java</h1><pre class="source lang-java linenums">package com.ichi2.libanki.importer;

import android.database.Cursor;
import android.text.TextUtils;
import android.util.Pair;
import com.ichi2.anki.AnkiDroidApp;
import com.ichi2.anki.R;
import com.ichi2.libanki.Collection;
import com.ichi2.libanki.Consts;
import com.ichi2.libanki.DeckConfig;
import com.ichi2.libanki.Model;
import com.ichi2.libanki.Models;
import com.ichi2.libanki.template.ParsedNode;
import com.ichi2.libanki.utils.StringUtils;
import com.ichi2.utils.Assert;
import com.ichi2.utils.HtmlUtils;
import com.ichi2.utils.JSONObject;
import java.util.AbstractMap;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.PluralsRes;
import androidx.annotation.StringRes;
import static com.ichi2.libanki.Consts.NEW_CARDS_RANDOM;
import static com.ichi2.libanki.Utils.fieldChecksum;
import static com.ichi2.libanki.Utils.guid64;
import static com.ichi2.libanki.Utils.joinFields;
import static com.ichi2.libanki.Utils.splitFields;
import static com.ichi2.libanki.importer.NoteImporter.ImportMode.ADD_MODE;
import static com.ichi2.libanki.importer.NoteImporter.ImportMode.IGNORE_MODE;
import static com.ichi2.libanki.importer.NoteImporter.ImportMode.UPDATE_MODE;
import br.ufmg.labsoft.mutvariants.listeners.ListenerUtil;

// Aside from 9f676dbe0b2ad9b87a3bf89d7735b4253abd440e, which allows empty notes.
public class NoteImporter extends Importer {

<span class="fc" id="L42">    private boolean mNeedMapper = true;</span>

<span class="fc" id="L44">    private boolean mNeedDelimiter = false;</span>

<span class="fc" id="L46">    private boolean mAllowHTML = false;</span>

<span class="fc" id="L48">    private ImportMode mImportMode = UPDATE_MODE;</span>

    /**
     * Note: elements can be null
     */
    @Nullable
    private List&lt;String&gt; mMapping;

    @Nullable
    private final String mTagModified;

    private final Model mModel;

    /**
     * _tagsMapped in python
     */
    private boolean mTagsMapped;

    /**
     * _fmap in Python
     */
    private Map&lt;String, Pair&lt;Integer, JSONObject&gt;&gt; mFMap;

    /**
     * _nextID in python
     */
    private long mNextId;

    private ArrayList&lt;Long&gt; _ids;

    private boolean mEmptyNotes;

    private int mUpdateCount;

    private List&lt;ParsedNode&gt; mTemplateParsed;

    public NoteImporter(Collection col, String file) {
<span class="fc" id="L85">        super(col, file);</span>
<span class="fc" id="L86">        this.mModel = col.getModels().current();</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14244)) {</span>
<span class="fc" id="L88">            this.mTemplateParsed = mModel.parsedNodes();</span>
        }
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14245)) {</span>
<span class="fc" id="L91">            this.mMapping = null;</span>
        }
<span class="fc" id="L93">        this.mTagModified = null;</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14246)) {</span>
<span class="fc" id="L95">            this.mTagsMapped = false;</span>
        }
<span class="fc" id="L97">    }</span>

    @Override
    public void run() {
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14247)) {</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">            Assert.that(mMapping != null);</span>
        }
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14248)) {</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">            Assert.that(!mMapping.isEmpty());</span>
        }
<span class="fc" id="L107">        List&lt;ForeignNote&gt; c = foreignNotes();</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14249)) {</span>
<span class="fc" id="L109">            importNotes(c);</span>
        }
<span class="fc" id="L111">    }</span>

    /**
     * The number of fields.
     */
    protected int fields() {
<span class="nc" id="L117">        return 0;</span>
    }

    public void initMapping() {
<span class="fc" id="L121">        List&lt;String&gt; flds = mModel.getFieldsNames();</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14250)) {</span>
            // truncate to provided count
<span class="fc" id="L124">            flds = flds.subList(0, Math.min(flds.size(), fields()));</span>
        }
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14257)) {</span>
            // if there's room left, add tags
<span class="pc bpc" id="L128" title="16 of 22 branches missed.">            if ((ListenerUtil.mutListener.listen(14255) ? (fields() &gt;= flds.size()) : (ListenerUtil.mutListener.listen(14254) ? (fields() &lt;= flds.size()) : (ListenerUtil.mutListener.listen(14253) ? (fields() &lt; flds.size()) : (ListenerUtil.mutListener.listen(14252) ? (fields() != flds.size()) : (ListenerUtil.mutListener.listen(14251) ? (fields() == flds.size()) : (fields() &gt; flds.size()))))))) {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14256)) {</span>
<span class="nc" id="L130">                    flds.add(&quot;_tags&quot;);</span>
                }
            }
        }
        // and if there's still room left, pad
<span class="pc bpc" id="L135" title="4 of 8 branches missed.">        int iterations = (ListenerUtil.mutListener.listen(14261) ? (fields() % flds.size()) : (ListenerUtil.mutListener.listen(14260) ? (fields() / flds.size()) : (ListenerUtil.mutListener.listen(14259) ? (fields() * flds.size()) : (ListenerUtil.mutListener.listen(14258) ? (fields() + flds.size()) : (fields() - flds.size())))));</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14268)) {</span>
            {
<span class="fc" id="L138">                long _loopCounter277 = 0;</span>
<span class="pc bpc" id="L139" title="16 of 22 branches missed.">                for (int i = 0; (ListenerUtil.mutListener.listen(14267) ? (i &gt;= iterations) : (ListenerUtil.mutListener.listen(14266) ? (i &lt;= iterations) : (ListenerUtil.mutListener.listen(14265) ? (i &gt; iterations) : (ListenerUtil.mutListener.listen(14264) ? (i != iterations) : (ListenerUtil.mutListener.listen(14263) ? (i == iterations) : (i &lt; iterations)))))); i++) {</span>
<span class="nc" id="L140">                    ListenerUtil.loopListener.listen(&quot;_loopCounter277&quot;, ++_loopCounter277);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14262)) {</span>
<span class="nc" id="L142">                        flds.add(null);</span>
                    }
                }
            }
        }
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14269)) {</span>
<span class="fc" id="L148">            mMapping = flds;</span>
        }
<span class="fc" id="L150">    }</span>

    boolean mappingOk() {
<span class="fc" id="L153">        return mMapping.contains(mModel.getJSONArray(&quot;flds&quot;).getJSONObject(0).getString(&quot;name&quot;));</span>
    }

    @NonNull
    protected List&lt;ForeignNote&gt; foreignNotes() {
<span class="nc" id="L158">        return new ArrayList&lt;&gt;();</span>
    }

    /**
     * Open file and ensure it's in the right format.
     */
    protected void open() {
<span class="nc" id="L165">    }</span>

    /**
     * Closes the open file.
     */
    protected void close() {
<span class="nc" id="L171">    }</span>

    /**
     * Convert each card into a note, apply attributes and add to col.
     */
    public void importNotes(List&lt;ForeignNote&gt; notes) {
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14270)) {</span>
<span class="fc" id="L178">            Assert.that(mappingOk());</span>
        }
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14271)) {</span>
            // note whether tags are mapped
<span class="fc" id="L182">            mTagsMapped = false;</span>
        }
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14274)) {</span>
            {
<span class="fc" id="L186">                long _loopCounter278 = 0;</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">                for (String f : mMapping) {</span>
<span class="fc" id="L188">                    ListenerUtil.loopListener.listen(&quot;_loopCounter278&quot;, ++_loopCounter278);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14273)) {</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">                        if (&quot;_tags&quot;.equals(f)) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(14272)) {</span>
<span class="nc" id="L192">                                mTagsMapped = true;</span>
                            }
                            break;
                        }
                    }
<span class="fc" id="L197">                }</span>
            }
        }
        // gather checks for duplicate comparison
<span class="fc" id="L201">        HashMap&lt;Long, List&lt;Long&gt;&gt; csums = new HashMap&lt;&gt;();</span>
<span class="fc" id="L202">        try (Cursor c = mCol.getDb().query(&quot;select csum, id from notes where mid = ?&quot;, mModel.getLong(&quot;id&quot;))) {</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">            if (!ListenerUtil.mutListener.listen(14278)) {</span>
                {
<span class="fc" id="L205">                    long _loopCounter279 = 0;</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">                    while (c.moveToNext()) {</span>
<span class="nc" id="L207">                        ListenerUtil.loopListener.listen(&quot;_loopCounter279&quot;, ++_loopCounter279);</span>
<span class="nc" id="L208">                        long csum = c.getLong(0);</span>
<span class="nc" id="L209">                        long id = c.getLong(1);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                        if (!ListenerUtil.mutListener.listen(14277)) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                            if (csums.containsKey(csum)) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(14276)) {</span>
<span class="nc" id="L213">                                    csums.get(csum).add(id);</span>
                                }
                            } else {
<span class="nc bnc" id="L216" title="All 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(14275)) {</span>
<span class="nc" id="L217">                                    csums.put(csum, new ArrayList&lt;&gt;(Collections.singletonList(id)));</span>
                                }
                            }
                        }
<span class="nc" id="L221">                    }</span>
                }
            }
        }
<span class="fc" id="L225">        HashSet&lt;String&gt; firsts = new HashSet&lt;&gt;(notes.size());</span>
<span class="fc" id="L226">        int fld0index = mMapping.indexOf(mModel.getJSONArray(&quot;flds&quot;).getJSONObject(0).getString(&quot;name&quot;));</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14279)) {</span>
<span class="fc" id="L228">            mFMap = Models.fieldMap(mModel);</span>
        }
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14280)) {</span>
<span class="fc" id="L231">            mNextId = mCol.getTime().timestampID(mCol.getDb(), &quot;notes&quot;);</span>
        }
        // loop through the notes
<span class="fc" id="L234">        List&lt;Object[]&gt; updates = new ArrayList&lt;&gt;(notes.size());</span>
<span class="fc" id="L235">        List&lt;String&gt; updateLog = new ArrayList&lt;&gt;(notes.size());</span>
        // PORT: Translations moved closer to their sources
<span class="fc" id="L237">        List&lt;Object[]&gt; _new = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14281)) {</span>
<span class="fc" id="L239">            _ids = new ArrayList&lt;&gt;();</span>
        }
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14282)) {</span>
<span class="fc" id="L242">            mEmptyNotes = false;</span>
        }
<span class="fc" id="L244">        int dupeCount = 0;</span>
<span class="fc" id="L245">        List&lt;String&gt; dupes = new ArrayList&lt;&gt;(notes.size());</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14337)) {</span>
            {
<span class="fc" id="L248">                long _loopCounter282 = 0;</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">                for (ForeignNote n : notes) {</span>
<span class="fc" id="L250">                    ListenerUtil.loopListener.listen(&quot;_loopCounter282&quot;, ++_loopCounter282);</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14293)) {</span>
                        {
<span class="fc" id="L253">                            long _loopCounter280 = 0;</span>
<span class="pc bpc" id="L254" title="15 of 22 branches missed.">                            for (int c = 0; (ListenerUtil.mutListener.listen(14292) ? (c &gt;= n.mFields.size()) : (ListenerUtil.mutListener.listen(14291) ? (c &lt;= n.mFields.size()) : (ListenerUtil.mutListener.listen(14290) ? (c &gt; n.mFields.size()) : (ListenerUtil.mutListener.listen(14289) ? (c != n.mFields.size()) : (ListenerUtil.mutListener.listen(14288) ? (c == n.mFields.size()) : (c &lt; n.mFields.size())))))); c++) {</span>
<span class="fc" id="L255">                                ListenerUtil.loopListener.listen(&quot;_loopCounter280&quot;, ++_loopCounter280);</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(14284)) {</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">                                    if (!this.mAllowHTML) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(14283)) {</span>
<span class="nc" id="L259">                                            n.mFields.set(c, HtmlUtils.escape(n.mFields.get(c)));</span>
                                        }
                                    }
                                }
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(14285)) {</span>
<span class="fc" id="L264">                                    n.mFields.set(c, n.mFields.get(c).trim());</span>
                                }
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">                                if (!ListenerUtil.mutListener.listen(14287)) {</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">                                    if (!this.mAllowHTML) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(14286)) {</span>
<span class="nc" id="L269">                                            n.mFields.set(c, n.mFields.get(c).replace(&quot;\n&quot;, &quot;&lt;br&gt;&quot;));</span>
                                        }
                                    }
                                }
                            }
                        }
                    }
<span class="fc" id="L276">                    String fld0 = n.mFields.get(fld0index);</span>
<span class="fc" id="L277">                    long csum = fieldChecksum(fld0);</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14301)) {</span>
                        // first field must exist
<span class="pc bpc" id="L280" title="42 of 50 branches missed.">                        if ((ListenerUtil.mutListener.listen(14299) ? (fld0 == null &amp;&amp; (ListenerUtil.mutListener.listen(14298) ? (fld0.length() &gt;= 0) : (ListenerUtil.mutListener.listen(14297) ? (fld0.length() &lt;= 0) : (ListenerUtil.mutListener.listen(14296) ? (fld0.length() &gt; 0) : (ListenerUtil.mutListener.listen(14295) ? (fld0.length() &lt; 0) : (ListenerUtil.mutListener.listen(14294) ? (fld0.length() != 0) : (fld0.length() == 0))))))) : (fld0 == null || (ListenerUtil.mutListener.listen(14298) ? (fld0.length() &gt;= 0) : (ListenerUtil.mutListener.listen(14297) ? (fld0.length() &lt;= 0) : (ListenerUtil.mutListener.listen(14296) ? (fld0.length() &gt; 0) : (ListenerUtil.mutListener.listen(14295) ? (fld0.length() &lt; 0) : (ListenerUtil.mutListener.listen(14294) ? (fld0.length() != 0) : (fld0.length() == 0))))))))) {</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(14300)) {</span>
<span class="nc" id="L282">                                getLog().add(getString(R.string.note_importer_error_empty_first_field, TextUtils.join(&quot; &quot;, n.mFields)));</span>
                            }
                            continue;
                        }
                    }
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14304)) {</span>
                        // earlier in import?
<span class="pc bpc" id="L289" title="8 of 10 branches missed.">                        if ((ListenerUtil.mutListener.listen(14302) ? (firsts.contains(fld0) || mImportMode != ADD_MODE) : (firsts.contains(fld0) &amp;&amp; mImportMode != ADD_MODE))) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(14303)) {</span>
                                // duplicates in source file; log and ignore
<span class="nc" id="L292">                                getLog().add(getString(R.string.note_importer_error_appeared_twice, fld0));</span>
                            }
                            continue;
                        }
                    }
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14305)) {</span>
<span class="fc" id="L298">                        firsts.add(fld0);</span>
                    }
                    // already exists?
<span class="fc" id="L301">                    boolean found = false;</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14326)) {</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">                        if (csums.containsKey(csum)) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(14325)) {</span>
                                {
<span class="nc" id="L306">                                    long _loopCounter281 = 0;</span>
                                    // csum is not a guarantee; have to check
<span class="nc bnc" id="L308" title="All 2 branches missed.">                                    for (Long id : csums.get(csum)) {</span>
<span class="nc" id="L309">                                        ListenerUtil.loopListener.listen(&quot;_loopCounter281&quot;, ++_loopCounter281);</span>
<span class="nc" id="L310">                                        String flds = mCol.getDb().queryString(&quot;select flds from notes where id = ?&quot;, id);</span>
<span class="nc" id="L311">                                        String[] sflds = splitFields(flds);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">                                        if (!ListenerUtil.mutListener.listen(14324)) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                                            if (fld0.equals(sflds[0])) {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(14306)) {</span>
                                                    // duplicate
<span class="nc" id="L316">                                                    found = true;</span>
                                                }
<span class="nc bnc" id="L318" title="All 2 branches missed.">                                                if (!ListenerUtil.mutListener.listen(14323)) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                                                    if (mImportMode == UPDATE_MODE) {</span>
<span class="nc" id="L320">                                                        Object[] data = updateData(n, id, sflds);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(14322)) {</span>
<span class="nc bnc" id="L322" title="All 50 branches missed.">                                                            if ((ListenerUtil.mutListener.listen(14317) ? (data != null || (ListenerUtil.mutListener.listen(14316) ? (data.length &gt;= 0) : (ListenerUtil.mutListener.listen(14315) ? (data.length &lt;= 0) : (ListenerUtil.mutListener.listen(14314) ? (data.length &lt; 0) : (ListenerUtil.mutListener.listen(14313) ? (data.length != 0) : (ListenerUtil.mutListener.listen(14312) ? (data.length == 0) : (data.length &gt; 0))))))) : (data != null &amp;&amp; (ListenerUtil.mutListener.listen(14316) ? (data.length &gt;= 0) : (ListenerUtil.mutListener.listen(14315) ? (data.length &lt;= 0) : (ListenerUtil.mutListener.listen(14314) ? (data.length &lt; 0) : (ListenerUtil.mutListener.listen(14313) ? (data.length != 0) : (ListenerUtil.mutListener.listen(14312) ? (data.length == 0) : (data.length &gt; 0))))))))) {</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(14318)) {</span>
<span class="nc" id="L324">                                                                    updates.add(data);</span>
                                                                }
<span class="nc bnc" id="L326" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(14319)) {</span>
<span class="nc" id="L327">                                                                    updateLog.add(getString(R.string.note_importer_error_first_field_matched, fld0));</span>
                                                                }
<span class="nc bnc" id="L329" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(14320)) {</span>
<span class="nc" id="L330">                                                                    dupeCount += 1;</span>
                                                                }
<span class="nc bnc" id="L332" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(14321)) {</span>
<span class="nc" id="L333">                                                                    found = true;</span>
                                                                }
                                                            }
                                                        }
<span class="nc bnc" id="L337" title="All 2 branches missed.">                                                    } else if (mImportMode == IGNORE_MODE) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(14311)) {</span>
<span class="nc" id="L339">                                                            dupeCount += 1;</span>
                                                        }
<span class="nc bnc" id="L341" title="All 2 branches missed.">                                                    } else if (mImportMode == ADD_MODE) {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(14309)) {</span>
                                                            // allow duplicates in this case
<span class="nc bnc" id="L344" title="All 2 branches missed.">                                                            if (!dupes.contains(fld0)) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(14307)) {</span>
                                                                    // duplicates are in the collection already
<span class="nc" id="L347">                                                                    updateLog.add(getString(R.string.note_importer_error_added_duplicate_first_field, fld0));</span>
                                                                }
<span class="nc bnc" id="L349" title="All 2 branches missed.">                                                                if (!ListenerUtil.mutListener.listen(14308)) {</span>
<span class="nc" id="L350">                                                                    dupes.add(fld0);</span>
                                                                }
                                                            }
                                                        }
<span class="nc bnc" id="L354" title="All 2 branches missed.">                                                        if (!ListenerUtil.mutListener.listen(14310)) {</span>
<span class="nc" id="L355">                                                            found = false;</span>
                                                        }
                                                    }
                                                }
                                            }
                                        }
<span class="nc" id="L361">                                    }</span>
                                }
                            }
                        }
                    }
<span class="pc bpc" id="L366" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14336)) {</span>
                        // newly add
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">                        if (!found) {</span>
<span class="fc" id="L369">                            Object[] data = newData(n);</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(14335)) {</span>
<span class="pc bpc" id="L371" title="42 of 50 branches missed.">                                if ((ListenerUtil.mutListener.listen(14332) ? (data != null || (ListenerUtil.mutListener.listen(14331) ? (data.length &gt;= 0) : (ListenerUtil.mutListener.listen(14330) ? (data.length &lt;= 0) : (ListenerUtil.mutListener.listen(14329) ? (data.length &lt; 0) : (ListenerUtil.mutListener.listen(14328) ? (data.length != 0) : (ListenerUtil.mutListener.listen(14327) ? (data.length == 0) : (data.length &gt; 0))))))) : (data != null &amp;&amp; (ListenerUtil.mutListener.listen(14331) ? (data.length &gt;= 0) : (ListenerUtil.mutListener.listen(14330) ? (data.length &lt;= 0) : (ListenerUtil.mutListener.listen(14329) ? (data.length &lt; 0) : (ListenerUtil.mutListener.listen(14328) ? (data.length != 0) : (ListenerUtil.mutListener.listen(14327) ? (data.length == 0) : (data.length &gt; 0))))))))) {</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(14333)) {</span>
<span class="fc" id="L373">                                        _new.add(data);</span>
                                    }
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">                                    if (!ListenerUtil.mutListener.listen(14334)) {</span>
                                        // note that we've seen this note once already
<span class="fc" id="L377">                                        firsts.add(fld0);</span>
                                    }
                                }
                            }
                        }
                    }
<span class="fc" id="L383">                }</span>
            }
        }
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14338)) {</span>
<span class="fc" id="L387">            addNew(_new);</span>
        }
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14339)) {</span>
<span class="fc" id="L390">            addUpdates(updates);</span>
        }
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14340)) {</span>
            // make sure to update sflds, etc
<span class="fc" id="L394">            mCol.updateFieldCache(_ids);</span>
        }
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14342)) {</span>
            // generate cards
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">            if (!mCol.genCards(_ids, mModel).isEmpty()) {</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14341)) {</span>
<span class="nc" id="L400">                    this.getLog().add(0, getString(R.string.note_importer_empty_cards_found));</span>
                }
            }
        }
        // have the same due#
<span class="fc" id="L405">        long did = mCol.getDecks().selected();</span>
<span class="fc" id="L406">        DeckConfig conf = mCol.getDecks().confForDid(did);</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14344)) {</span>
            // in order due?
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">            if (conf.getJSONObject(&quot;new&quot;).getInt(&quot;order&quot;) == NEW_CARDS_RANDOM) {</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14343)) {</span>
<span class="nc" id="L411">                    mCol.getSched().randomizeCards(did);</span>
                }
            }
        }
<span class="fc" id="L415">        String part1 = getQuantityString(R.plurals.note_importer_notes_added, _new.size());</span>
<span class="fc" id="L416">        String part2 = getQuantityString(R.plurals.note_importer_notes_updated, mUpdateCount);</span>
        int unchanged;
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">        if (mImportMode == UPDATE_MODE) {</span>
<span class="pc bpc" id="L419" title="4 of 8 branches missed.">            unchanged = (ListenerUtil.mutListener.listen(14348) ? (dupeCount % mUpdateCount) : (ListenerUtil.mutListener.listen(14347) ? (dupeCount / mUpdateCount) : (ListenerUtil.mutListener.listen(14346) ? (dupeCount * mUpdateCount) : (ListenerUtil.mutListener.listen(14345) ? (dupeCount + mUpdateCount) : (dupeCount - mUpdateCount)))));</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">        } else if (mImportMode == IGNORE_MODE) {</span>
<span class="nc" id="L421">            unchanged = dupeCount;</span>
        } else {
<span class="nc" id="L423">            unchanged = 0;</span>
        }
<span class="fc" id="L425">        String part3 = getQuantityString(R.plurals.note_importer_notes_unchanged, unchanged);</span>
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14349)) {</span>
<span class="fc" id="L427">            mLog.add(String.format(&quot;%s, %s, %s.&quot;, part1, part2, part3));</span>
        }
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14350)) {</span>
<span class="fc" id="L430">            mLog.addAll(updateLog);</span>
        }
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14352)) {</span>
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">            if (mEmptyNotes) {</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14351)) {</span>
<span class="nc" id="L435">                    mLog.add(getString(R.string.note_importer_error_empty_notes));</span>
                }
            }
        }
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14353)) {</span>
<span class="fc" id="L440">            mTotal = _ids.size();</span>
        }
<span class="fc" id="L442">    }</span>

    @Nullable
    private Object[] newData(ForeignNote n) {
<span class="fc" id="L446">        long id = mNextId;</span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14354)) {</span>
<span class="fc" id="L448">            mNextId++;</span>
        }
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14355)) {</span>
<span class="fc" id="L451">            _ids.add(id);</span>
        }
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14356)) {</span>
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">            if (!processFields(n)) {</span>
<span class="nc" id="L455">                return null;</span>
            }
        }
<span class="fc" id="L458">        return new Object[] { id, guid64(), mModel.getLong(&quot;id&quot;), mCol.getTime().intTime(), mCol.usn(), mCol.getTags().join(n.mTags), n.fieldsStr, &quot;&quot;, &quot;&quot;, 0, &quot;&quot; };</span>
    }

    private void addNew(List&lt;Object[]&gt; rows) {
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14357)) {</span>
<span class="fc" id="L463">            mCol.getDb().executeMany(&quot;insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)&quot;, rows);</span>
        }
<span class="fc" id="L465">    }</span>

    private Object[] updateData(ForeignNote n, long id, String[] sflds) {
<span class="nc bnc" id="L468" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14358)) {</span>
<span class="nc" id="L469">            _ids.add(id);</span>
        }
<span class="nc bnc" id="L471" title="All 2 branches missed.">        if (!processFields(n, sflds)) {</span>
<span class="nc" id="L472">            return null;</span>
        }
        String tags;
<span class="nc bnc" id="L475" title="All 2 branches missed.">        if (mTagsMapped) {</span>
<span class="nc" id="L476">            tags = mCol.getTags().join(n.mTags);</span>
<span class="nc" id="L477">            return new Object[] { mCol.getTime().intTime(), mCol.usn(), n.fieldsStr, tags, id, n.fieldsStr, tags };</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">        } else if (mTagModified != null) {</span>
<span class="nc" id="L479">            tags = mCol.getDb().queryString(&quot;select tags from notes where id = ?&quot;, id);</span>
<span class="nc" id="L480">            List&lt;String&gt; tagList = mCol.getTags().split(tags);</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">            if (!ListenerUtil.mutListener.listen(14359)) {</span>
<span class="nc" id="L482">                tagList.addAll(StringUtils.splitOnWhitespace(mTagModified));</span>
            }
<span class="nc" id="L484">            tags = mCol.getTags().join(tagList);</span>
<span class="nc" id="L485">            return new Object[] { mCol.getTime().intTime(), mCol.usn(), n.fieldsStr, tags, id, n.fieldsStr };</span>
        } else {
            // This looks inconsistent but is fine, see: addUpdates
<span class="nc" id="L488">            return new Object[] { mCol.getTime().intTime(), mCol.usn(), n.fieldsStr, id, n.fieldsStr };</span>
        }
    }

    private void addUpdates(List&lt;Object[]&gt; rows) {
<span class="fc" id="L493">        int changes = mCol.getDb().queryScalar(&quot;select total_changes()&quot;);</span>
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14363)) {</span>
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">            if (mTagsMapped) {</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14362)) {</span>
<span class="nc" id="L497">                    mCol.getDb().executeMany(&quot;update notes set mod = ?, usn = ?, flds = ?, tags = ? &quot; + &quot;where id = ? and (flds != ? or tags != ?)&quot;, rows);</span>
                }
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">            } else if (mTagModified != null) {</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14361)) {</span>
<span class="nc" id="L501">                    mCol.getDb().executeMany(&quot;update notes set mod = ?, usn = ?, flds = ?, tags = ? &quot; + &quot;where id = ? and flds != ?&quot;, rows);</span>
                }
            } else {
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14360)) {</span>
<span class="fc" id="L505">                    mCol.getDb().executeMany(&quot;update notes set mod = ?, usn = ?, flds = ? &quot; + &quot;where id = ? and flds != ?&quot;, rows);</span>
                }
            }
        }
<span class="fc" id="L509">        int changes2 = mCol.getDb().queryScalar(&quot;select total_changes()&quot;);</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14368)) {</span>
<span class="pc bpc" id="L511" title="4 of 8 branches missed.">            mUpdateCount = (ListenerUtil.mutListener.listen(14367) ? (changes2 % changes) : (ListenerUtil.mutListener.listen(14366) ? (changes2 / changes) : (ListenerUtil.mutListener.listen(14365) ? (changes2 * changes) : (ListenerUtil.mutListener.listen(14364) ? (changes2 + changes) : (changes2 - changes)))));</span>
        }
<span class="fc" id="L513">    }</span>

    private boolean processFields(ForeignNote note) {
<span class="fc" id="L516">        return processFields(note, null);</span>
    }

    private boolean processFields(ForeignNote note, @Nullable String[] fields) {
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14377)) {</span>
<span class="pc bpc" id="L521" title="1 of 2 branches missed.">            if (fields == null) {</span>
<span class="fc" id="L522">                int length = mModel.getJSONArray(&quot;flds&quot;).length();</span>
<span class="pc bpc" id="L523" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14369)) {</span>
<span class="fc" id="L524">                    fields = new String[length];</span>
                }
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14376)) {</span>
                    {
<span class="fc" id="L528">                        long _loopCounter283 = 0;</span>
<span class="pc bpc" id="L529" title="15 of 22 branches missed.">                        for (int i = 0; (ListenerUtil.mutListener.listen(14375) ? (i &gt;= length) : (ListenerUtil.mutListener.listen(14374) ? (i &lt;= length) : (ListenerUtil.mutListener.listen(14373) ? (i &gt; length) : (ListenerUtil.mutListener.listen(14372) ? (i != length) : (ListenerUtil.mutListener.listen(14371) ? (i == length) : (i &lt; length)))))); i++) {</span>
<span class="fc" id="L530">                            ListenerUtil.loopListener.listen(&quot;_loopCounter283&quot;, ++_loopCounter283);</span>
<span class="pc bpc" id="L531" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(14370)) {</span>
<span class="fc" id="L532">                                fields[i] = &quot;&quot;;</span>
                            }
                        }
                    }
                }
            }
        }
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14382)) {</span>
            {
<span class="fc" id="L541">                long _loopCounter284 = 0;</span>
<span class="fc bfc" id="L542" title="All 2 branches covered.">                for (Map.Entry&lt;Integer, String&gt; entry : enumerate(mMapping)) {</span>
<span class="fc" id="L543">                    ListenerUtil.loopListener.listen(&quot;_loopCounter284&quot;, ++_loopCounter284);</span>
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14378)) {</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">                        if (entry.getValue() == null) {</span>
<span class="nc" id="L546">                            continue;</span>
                        }
                    }
<span class="fc" id="L549">                    int c = entry.getKey();</span>
<span class="pc bpc" id="L550" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14381)) {</span>
<span class="pc bpc" id="L551" title="1 of 2 branches missed.">                        if (entry.getValue().equals(&quot;_tags&quot;)) {</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(14380)) {</span>
<span class="nc" id="L553">                                note.mTags.addAll(mCol.getTags().split(note.mFields.get(c)));</span>
                            }
                        } else {
<span class="fc" id="L556">                            Integer sidx = mFMap.get(entry.getValue()).first;</span>
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">                            if (!ListenerUtil.mutListener.listen(14379)) {</span>
<span class="fc" id="L558">                                fields[sidx] = note.mFields.get(c);</span>
                            }
                        }
                    }
<span class="fc" id="L562">                }</span>
            }
        }
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14383)) {</span>
<span class="fc" id="L566">            note.fieldsStr = joinFields(fields);</span>
        }
<span class="fc" id="L568">        ArrayList&lt;Integer&gt; ords = Models.availOrds(mModel, fields, mTemplateParsed);</span>
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14385)) {</span>
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">            if (ords.isEmpty()) {</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                if (!ListenerUtil.mutListener.listen(14384)) {</span>
<span class="nc" id="L572">                    mEmptyNotes = true;</span>
                }
<span class="nc" id="L574">                return false;</span>
            }
        }
<span class="fc" id="L577">        return true;</span>
    }

    private &lt;T&gt; List&lt;Map.Entry&lt;Integer, T&gt;&gt; enumerate(List&lt;T&gt; list) {
<span class="fc" id="L581">        List&lt;Map.Entry&lt;Integer, T&gt;&gt; ret = new ArrayList&lt;&gt;(list.size());</span>
<span class="fc" id="L582">        int index = 0;</span>
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14388)) {</span>
            {
<span class="fc" id="L585">                long _loopCounter285 = 0;</span>
<span class="fc bfc" id="L586" title="All 2 branches covered.">                for (T el : list) {</span>
<span class="fc" id="L587">                    ListenerUtil.loopListener.listen(&quot;_loopCounter285&quot;, ++_loopCounter285);</span>
<span class="pc bpc" id="L588" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14386)) {</span>
<span class="fc" id="L589">                        ret.add(new AbstractMap.SimpleEntry&lt;&gt;(index, el));</span>
                    }
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">                    if (!ListenerUtil.mutListener.listen(14387)) {</span>
<span class="fc" id="L592">                        index++;</span>
                    }
<span class="fc" id="L594">                }</span>
            }
        }
<span class="fc" id="L597">        return ret;</span>
    }

    public int getTotal() {
<span class="nc" id="L601">        return mTotal;</span>
    }

    public void setImportMode(ImportMode mode) {
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14389)) {</span>
<span class="nc" id="L606">            this.mImportMode = mode;</span>
        }
<span class="nc" id="L608">    }</span>

    private String getQuantityString(@PluralsRes int res, int quantity) {
<span class="fc" id="L611">        return AnkiDroidApp.getAppResources().getQuantityString(res, quantity, quantity);</span>
    }

    @NonNull
    protected String getString(@StringRes int res) {
<span class="nc" id="L616">        return AnkiDroidApp.getAppResources().getString(res);</span>
    }

    @NonNull
    protected String getString(int res, @NonNull Object... formatArgs) {
<span class="nc" id="L621">        return AnkiDroidApp.getAppResources().getString(res, formatArgs);</span>
    }

    public void setAllowHtml(boolean allowHtml) {
<span class="pc bpc" id="L625" title="1 of 2 branches missed.">        if (!ListenerUtil.mutListener.listen(14390)) {</span>
<span class="fc" id="L626">            this.mAllowHTML = allowHtml;</span>
        }
<span class="fc" id="L628">    }</span>

<span class="fc" id="L630">    public enum ImportMode {</span>

        // 0
<span class="fc" id="L633">        UPDATE_MODE,</span>
        // 1
<span class="fc" id="L635">        IGNORE_MODE,</span>
        // 2
<span class="fc" id="L637">        ADD_MODE</span>
    }

    /**
     * A temporary object storing fields and attributes.
     */
<span class="fc" id="L643">    public static class ForeignNote {</span>

<span class="fc" id="L645">        public final List&lt;String&gt; mFields = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L647">        public final List&lt;String&gt; mTags = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L649">        public Object deck = new Object();</span>

<span class="fc" id="L651">        public String fieldsStr = &quot;&quot;;</span>
    }

<span class="nc" id="L654">    public static class ForeignCard {</span>

<span class="nc" id="L656">        public final long mDue = 0;</span>

<span class="nc" id="L658">        public final int mIvl = 1;</span>

<span class="nc" id="L660">        public final int mFactor = Consts.STARTING_FACTOR;</span>

<span class="nc" id="L662">        public final int mReps = 0;</span>

<span class="nc" id="L664">        public final int mLapses = 0;</span>
    }

    private static class Triple {

        public final long mNid;

        public final Integer mOrd;

        public final ForeignCard mCard;

<span class="nc" id="L675">        public Triple(long nid, Integer ord, ForeignCard card) {</span>
<span class="nc" id="L676">            this.mNid = nid;</span>
<span class="nc" id="L677">            this.mOrd = ord;</span>
<span class="nc" id="L678">            this.mCard = card;</span>
<span class="nc" id="L679">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>