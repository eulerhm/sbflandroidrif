<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SourceEditor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">com.github.pockethub.android.util</a> &gt; <span class="el_source">SourceEditor.java</span></div><h1>SourceEditor.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2015 PocketHub
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.github.pockethub.android.util;

import android.net.Uri;
import android.os.Build;
import android.text.TextUtils;
import android.util.Base64;
import android.webkit.JavascriptInterface;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;

import com.github.pockethub.android.ui.user.UriLauncherActivity;
import com.meisolsson.githubsdk.model.git.GitBlob;

import java.io.UnsupportedEncodingException;

/**
 * Utilities for displaying source code in a {@link WebView}
 */
public class SourceEditor {

    private static final String URL_PAGE = &quot;file:///android_asset/source-editor.html&quot;;
    private static final String ENCODING_BASE64 = &quot;base64&quot;;

    private final WebView view;

    private boolean wrap;

    private String name;

    private String content;

    private boolean encoded;

    private boolean markdown;

    /**
     * Create source editor using given web view
     *
     * @param view
     */
<span class="nc" id="L57">    public SourceEditor(final WebView view) {</span>
<span class="nc" id="L58">        WebViewClient client = new WebViewClient() {</span>

            @Override
            public boolean shouldOverrideUrlLoading(WebView view, String url) {
<span class="nc bnc" id="L62" title="All 2 branches missed.">                if (URL_PAGE.equals(url)) {</span>
<span class="nc" id="L63">                    view.loadUrl(url);</span>
<span class="nc" id="L64">                    return false;</span>
                } else {
<span class="nc" id="L66">                    UriLauncherActivity.launchUri(view.getContext(), Uri.parse(url));</span>
<span class="nc" id="L67">                    return true;</span>
                }
            }
        };
<span class="nc" id="L71">        view.setWebViewClient(client);</span>

<span class="nc" id="L73">        WebSettings settings = view.getSettings();</span>
<span class="nc" id="L74">        settings.setJavaScriptEnabled(true);</span>
<span class="nc" id="L75">        view.addJavascriptInterface(this, &quot;SourceEditor&quot;);</span>

<span class="nc" id="L77">        this.view = view;</span>
<span class="nc" id="L78">    }</span>

    /**
     * @return name
     */
    @JavascriptInterface
    public String getName() {
<span class="nc" id="L85">        return name;</span>
    }

    /**
     * @return content
     */
    @JavascriptInterface
    public String getRawContent() {
<span class="nc" id="L93">        return content;</span>
    }

    /**
     * @return content
     */
    @JavascriptInterface
    public String getContent() {
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (encoded) {</span>
            try {
<span class="nc" id="L103">                return new String(Base64.decode(content, Base64.DEFAULT), &quot;UTF-8&quot;);</span>
<span class="nc" id="L104">            } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L105">                return getRawContent();</span>
            }
        } else {
<span class="nc" id="L108">            return getRawContent();</span>
        }
    }

    /**
     * @return wrap
     */
    @JavascriptInterface
    public boolean getWrap() {
<span class="nc" id="L117">        return wrap;</span>
    }

    /**
     * @return markdown
     */
    public boolean isMarkdown() {
<span class="nc" id="L124">        return markdown;</span>
    }

    /**
     * Set whether lines should wrap
     *
     * @param wrap
     * @return this editor
     */
    public SourceEditor setWrap(final boolean wrap) {
<span class="nc" id="L134">        this.wrap = wrap;</span>
<span class="nc" id="L135">        loadSource();</span>
<span class="nc" id="L136">        return this;</span>
    }

    /**
     * Sets whether the content is a markdown file
     *
     * @param markdown
     * @return this editor
     */
    public SourceEditor setMarkdown(final boolean markdown) {
<span class="nc" id="L146">        this.markdown = markdown;</span>
<span class="nc" id="L147">        return this;</span>
    }

    /**
     * Bind content to current {@link WebView}
     *
     * @param name
     * @param content
     * @param encoded
     * @return this editor
     */
    public SourceEditor setSource(final String name, final String content, final boolean encoded) {
<span class="nc" id="L159">        this.name = name;</span>
<span class="nc" id="L160">        this.content = content;</span>
<span class="nc" id="L161">        this.encoded = encoded;</span>
<span class="nc" id="L162">        loadSource();</span>

<span class="nc" id="L164">        return this;</span>
    }

    private void loadSource() {
<span class="nc bnc" id="L168" title="All 4 branches missed.">        if (name != null &amp;&amp; content != null) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (markdown) {</span>
<span class="nc" id="L170">                view.loadDataWithBaseURL(null, content, &quot;text/html&quot;, &quot;UTF-8&quot;, null);</span>
            } else {
<span class="nc" id="L172">                view.loadUrl(URL_PAGE);</span>
            }
        }
<span class="nc" id="L175">    }</span>

    /**
     * Bind blob content to current {@link WebView}
     *
     * @param name
     * @param blob
     * @return this editor
     */
    public SourceEditor setSource(final String name, final GitBlob blob) {
<span class="nc" id="L185">        String content = blob.content();</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (content == null) {</span>
<span class="nc" id="L187">            content = &quot;&quot;;</span>
        }
<span class="nc bnc" id="L189" title="All 4 branches missed.">        boolean encoded = !TextUtils.isEmpty(content) &amp;&amp; ENCODING_BASE64.equals(blob.encoding());</span>
<span class="nc" id="L190">        return setSource(name, content, encoded);</span>
    }

    /**
     * Toggle line wrap
     *
     * @return this editor
     */
    public SourceEditor toggleWrap() {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        return setWrap(!wrap);</span>
    }

    /**
     * Toggle markdown file rendering
     *
     * @return this editor
     */
    public SourceEditor toggleMarkdown() {
<span class="nc bnc" id="L208" title="All 2 branches missed.">        return setMarkdown(!markdown);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Generated by the Android Gradle plugin 3.6.1</div></body></html>