<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecentRepositories.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">com.github.pockethub.android.ui.repo</a> &gt; <span class="el_source">RecentRepositories.java</span></div><h1>RecentRepositories.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2015 PocketHub
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.github.pockethub.android.ui.repo;

import android.content.Context;
import android.os.AsyncTask;

import com.github.pockethub.android.RequestReader;
import com.github.pockethub.android.RequestWriter;
import com.meisolsson.githubsdk.model.Repository;
import com.meisolsson.githubsdk.model.User;

import java.io.File;
import java.io.Serializable;
import java.util.Comparator;
import java.util.Iterator;
import java.util.LinkedHashSet;

import static java.lang.String.CASE_INSENSITIVE_ORDER;

/**
 * Model class for the repositories recently selected under an organization
 */
public class RecentRepositories implements Comparator&lt;Repository&gt;, Serializable {

    /**
     * Number of repositories retained per organization
     */
    public static final int MAX_SIZE = 5;

    private static final long serialVersionUID = 580345177644233739L;

    private static final int VERSION = 2;

    private static File getFile(final Context context, final User organization) {
<span class="nc" id="L49">        return new File(context.getFilesDir(), &quot;recent-repos-&quot;</span>
<span class="nc" id="L50">                + organization.id() + &quot;.ser&quot;);</span>
    }

    private LinkedHashSet&lt;Long&gt; ids;

    private final File file;

    private int id;

    /**
     * Create a recent repositories cache for the given organization
     *
     * @param context
     * @param organization
     */
<span class="nc" id="L65">    public RecentRepositories(final Context context, final User organization) {</span>
<span class="nc" id="L66">        file = getFile(context, organization);</span>
<span class="nc" id="L67">        id = organization.id().intValue();</span>
<span class="nc" id="L68">    }</span>

    private void load() {
<span class="nc" id="L71">        LinkedHashSet&lt;Long&gt; loaded = new RequestReader(file, VERSION).read();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (loaded == null) {</span>
<span class="nc" id="L73">            loaded = new LinkedHashSet&lt;&gt;();</span>
        }
<span class="nc" id="L75">        ids = loaded;</span>
<span class="nc" id="L76">        trim();</span>
<span class="nc" id="L77">    }</span>

    private void trim() {
<span class="nc" id="L80">        Iterator&lt;Long&gt; iterator = ids.iterator();</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">        while (iterator.hasNext() &amp;&amp; ids.size() &gt; MAX_SIZE) {</span>
<span class="nc" id="L82">            iterator.next();</span>
<span class="nc" id="L83">            iterator.remove();</span>
        }
<span class="nc" id="L85">    }</span>

    /**
     * Add repository to recent list
     *
     * @param repo
     * @return this recent list
     */
    public RecentRepositories add(final Repository repo) {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        return repo != null ? add(repo.id()) : this;</span>
    }

    /**
     * Add id to recent list
     *
     * @param id
     * @return this recent list
     */
    public RecentRepositories add(final long id) {
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (ids == null) {</span>
<span class="nc" id="L105">            load();</span>
        }
<span class="nc" id="L107">        ids.remove(id);</span>
<span class="nc" id="L108">        ids.add(id);</span>
<span class="nc" id="L109">        trim();</span>
<span class="nc" id="L110">        return this;</span>
    }

    /**
     * Remove repository from recent list
     *
     * @param repo
     * @return this recent list
     */
    public RecentRepositories remove(final Repository repo) {
<span class="nc bnc" id="L120" title="All 2 branches missed.">        return repo != null ? remove(repo.id()) : this;</span>
    }

    /**
     * Remove id from recent list
     *
     * @param id
     * @return this recent list
     */
    public RecentRepositories remove(final long id) {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (ids == null) {</span>
<span class="nc" id="L131">            load();</span>
        }
<span class="nc" id="L133">        ids.remove(id);</span>
<span class="nc" id="L134">        return this;</span>
    }

    /**
     * Persist recent list asynchronously on a background thread
     *
     * @return this recent list
     */
    public RecentRepositories saveAsync() {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (ids != null) {</span>
<span class="nc" id="L144">            new AsyncTask&lt;Void, Void, Void&gt;() {</span>

                @Override
                protected Void doInBackground(Void... params) {
<span class="nc" id="L148">                    save();</span>
<span class="nc" id="L149">                    return null;</span>
                }
<span class="nc" id="L151">            }.execute();</span>
        }
<span class="nc" id="L153">        return this;</span>
    }

    /**
     * Persist recent list
     *
     * @return this recent list
     */
    public RecentRepositories save() {
<span class="nc" id="L162">        final LinkedHashSet&lt;Long&gt; save = ids;</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (save != null) {</span>
<span class="nc" id="L164">            new RequestWriter(file, VERSION).write(save);</span>
        }
<span class="nc" id="L166">        return this;</span>
    }

    /**
     * Is the given repository in the recent list?
     *
     * @param repository
     * @return true if in recent list, false otherwise
     */
    public boolean contains(Repository repository) {
<span class="nc bnc" id="L176" title="All 4 branches missed.">        return repository != null &amp;&amp; contains(repository.id());</span>
    }

    /**
     * Is the given repository id in the recent list
     *
     * @param id
     * @return true if in recent list, false otherwise
     */
    public boolean contains(long id) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (ids == null) {</span>
<span class="nc" id="L187">            load();</span>
        }
<span class="nc" id="L189">        return ids.contains(id);</span>
    }

    @Override
    public int compare(final Repository lhs, final Repository rhs) {
<span class="nc" id="L194">        final boolean lRecent = contains(lhs);</span>
<span class="nc" id="L195">        final boolean rRecent = contains(rhs);</span>
<span class="nc bnc" id="L196" title="All 4 branches missed.">        if (lRecent &amp;&amp; !rRecent) {</span>
<span class="nc" id="L197">            return -1;</span>
        }
<span class="nc bnc" id="L199" title="All 4 branches missed.">        if (!lRecent &amp;&amp; rRecent) {</span>
<span class="nc" id="L200">            return 1;</span>
        }

<span class="nc" id="L203">        final int order = CASE_INSENSITIVE_ORDER.compare(lhs.name(),</span>
<span class="nc" id="L204">                rhs.name());</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (order == 0) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (id == lhs.owner().id()) {</span>
<span class="nc" id="L207">                return -1;</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            } else if (id == rhs.owner().id()) {</span>
<span class="nc" id="L209">                return 1;</span>
            } else {
<span class="nc" id="L211">                return CASE_INSENSITIVE_ORDER.compare(</span>
<span class="nc" id="L212">                        lhs.owner().login(), rhs.owner().login());</span>
            }
        } else {
<span class="nc" id="L215">            return order;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Generated by the Android Gradle plugin 3.6.1</div></body></html>