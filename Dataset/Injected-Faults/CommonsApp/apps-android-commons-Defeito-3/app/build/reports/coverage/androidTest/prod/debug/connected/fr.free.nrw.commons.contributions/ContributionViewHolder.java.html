<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContributionViewHolder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.contributions</a> &gt; <span class="el_source">ContributionViewHolder.java</span></div><h1>ContributionViewHolder.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.contributions;

import android.net.Uri;
import android.text.TextUtils;
import android.view.View;
import android.webkit.URLUtil;
import android.widget.ImageButton;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TextView;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AlertDialog.Builder;
import androidx.recyclerview.widget.RecyclerView;
import butterknife.BindView;
import butterknife.ButterKnife;
import butterknife.OnClick;
import com.facebook.drawee.view.SimpleDraweeView;
import com.facebook.imagepipeline.request.ImageRequest;
import com.facebook.imagepipeline.request.ImageRequestBuilder;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.contributions.ContributionsListAdapter.Callback;
import fr.free.nrw.commons.media.MediaClient;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.schedulers.Schedulers;
import java.io.File;

public class ContributionViewHolder extends RecyclerView.ViewHolder {

    private final Callback callback;
    @BindView(R.id.contributionImage)
    SimpleDraweeView imageView;
    @BindView(R.id.contributionTitle)
    TextView titleView;
    @BindView(R.id.authorView)
    TextView authorView;
    @BindView(R.id.contributionState)
    TextView stateView;
    @BindView(R.id.contributionSequenceNumber)
    TextView seqNumView;
    @BindView(R.id.contributionProgress)
    ProgressBar progressView;
    @BindView(R.id.image_options)
    RelativeLayout imageOptions;
    @BindView(R.id.wikipediaButton)
    ImageButton addToWikipediaButton;
    @BindView(R.id.retryButton)
    ImageButton retryButton;
    @BindView(R.id.cancelButton)
    ImageButton cancelButton;
    @BindView(R.id.pauseResumeButton)
    ImageButton pauseResumeButton;


    private int position;
    private Contribution contribution;
<span class="nc" id="L58">    private final CompositeDisposable compositeDisposable = new CompositeDisposable();</span>
    private final MediaClient mediaClient;
    private boolean isWikipediaButtonDisplayed;
    private AlertDialog pausingPopUp;
    private View parent;
    private ImageRequest imageRequest;

    ContributionViewHolder(final View parent, final Callback callback,
        final MediaClient mediaClient) {
<span class="nc" id="L67">        super(parent);</span>
<span class="nc" id="L68">        this.parent = parent;</span>
<span class="nc" id="L69">        this.mediaClient = mediaClient;</span>
<span class="nc" id="L70">        ButterKnife.bind(this, parent);</span>
<span class="nc" id="L71">        this.callback = callback;</span>

        /* Set a dialog indicating that the upload is being paused. This is needed because pausing
        an upload might take a dozen seconds. */
<span class="nc" id="L75">        AlertDialog.Builder builder = new Builder(parent.getContext());</span>
<span class="nc" id="L76">        builder.setCancelable(false);</span>
<span class="nc" id="L77">        builder.setView(R.layout.progress_dialog);</span>
<span class="nc" id="L78">        pausingPopUp = builder.create();</span>
<span class="nc" id="L79">    }</span>

    public void init(final int position, final Contribution contribution) {

        //handling crashes when the contribution is null.
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (null == contribution) {</span>
<span class="nc" id="L85">            return;</span>
        }

<span class="nc" id="L88">        this.contribution = contribution;</span>
<span class="nc" id="L89">        this.position = position;</span>
<span class="nc" id="L90">        titleView.setText(contribution.getMedia().getMostRelevantCaption());</span>
<span class="nc" id="L91">        authorView.setText(contribution.getMedia().getAuthor());</span>

        //Removes flicker of loading image.
<span class="nc" id="L94">        imageView.getHierarchy().setFadeDuration(0);</span>

<span class="nc" id="L96">        imageView.getHierarchy().setPlaceholderImage(R.drawable.image_placeholder);</span>
<span class="nc" id="L97">        imageView.getHierarchy().setFailureImage(R.drawable.image_placeholder);</span>

<span class="nc" id="L99">        final String imageSource = chooseImageSource(contribution.getMedia().getThumbUrl(),</span>
<span class="nc" id="L100">            contribution.getLocalUri());</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!TextUtils.isEmpty(imageSource)) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (URLUtil.isHttpsUrl(imageSource)) {</span>
<span class="nc" id="L103">                imageRequest = ImageRequestBuilder.newBuilderWithSource(Uri.parse(imageSource))</span>
<span class="nc" id="L104">                    .setProgressiveRenderingEnabled(true)</span>
<span class="nc" id="L105">                    .build();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            } else if(imageSource != null) {</span>
<span class="nc" id="L107">                final File file = new File(imageSource);</span>
<span class="nc" id="L108">                imageRequest = ImageRequest.fromFile(file);</span>
            }

<span class="nc bnc" id="L111" title="All 2 branches missed.">            if(imageRequest != null){</span>
<span class="nc" id="L112">                imageView.setImageRequest(imageRequest);</span>
            }
        }

<span class="nc" id="L116">        seqNumView.setText(String.valueOf(position + 1));</span>
<span class="nc" id="L117">        seqNumView.setVisibility(View.VISIBLE);</span>

<span class="nc" id="L119">        addToWikipediaButton.setVisibility(View.GONE);</span>
<span class="nc bnc" id="L120" title="All 6 branches missed.">        switch (contribution.getState()) {</span>
            case Contribution.STATE_COMPLETED:
<span class="nc" id="L122">                stateView.setVisibility(View.GONE);</span>
<span class="nc" id="L123">                progressView.setVisibility(View.GONE);</span>
<span class="nc" id="L124">                imageOptions.setVisibility(View.GONE);</span>
<span class="nc" id="L125">                stateView.setText(&quot;&quot;);</span>
<span class="nc" id="L126">                checkIfMediaExistsOnWikipediaPage(contribution);</span>
<span class="nc" id="L127">                break;</span>
            case Contribution.STATE_QUEUED:
            case Contribution.STATE_QUEUED_LIMITED_CONNECTION_MODE:
<span class="nc" id="L130">                progressView.setVisibility(View.GONE);</span>
<span class="nc" id="L131">                stateView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L132">                stateView.setText(R.string.contribution_state_queued);</span>
<span class="nc" id="L133">                imageOptions.setVisibility(View.GONE);</span>
<span class="nc" id="L134">                break;</span>
            case Contribution.STATE_IN_PROGRESS:
<span class="nc" id="L136">                stateView.setVisibility(View.GONE);</span>
<span class="nc" id="L137">                progressView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L138">                addToWikipediaButton.setVisibility(View.GONE);</span>
<span class="nc" id="L139">                pauseResumeButton.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L140">                cancelButton.setVisibility(View.GONE);</span>
<span class="nc" id="L141">                retryButton.setVisibility(View.GONE);</span>
<span class="nc" id="L142">                imageOptions.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L143">                final long total = contribution.getDataLength();</span>
<span class="nc" id="L144">                final long transferred = contribution.getTransferred();</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">                if (transferred == 0 || transferred &gt;= total) {</span>
<span class="nc" id="L146">                    progressView.setIndeterminate(true);</span>
                } else {
<span class="nc" id="L148">                    progressView.setIndeterminate(false);</span>
<span class="nc" id="L149">                    progressView.setProgress((int) (((double) transferred / (double) total) * 100));</span>
                }
<span class="nc" id="L151">                break;</span>
            case Contribution.STATE_PAUSED:
<span class="nc" id="L153">                progressView.setVisibility(View.GONE);</span>
<span class="nc" id="L154">                stateView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L155">                stateView.setText(R.string.paused);</span>
<span class="nc" id="L156">                cancelButton.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L157">                retryButton.setVisibility(View.GONE);</span>
<span class="nc" id="L158">                pauseResumeButton.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L159">                imageOptions.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L160">                setResume();</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                if(pausingPopUp.isShowing()){</span>
<span class="nc" id="L162">                    pausingPopUp.hide();</span>
                }
                break;
            case Contribution.STATE_FAILED:
<span class="nc" id="L166">                stateView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L167">                stateView.setText(R.string.contribution_state_failed);</span>
<span class="nc" id="L168">                progressView.setVisibility(View.GONE);</span>
<span class="nc" id="L169">                cancelButton.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L170">                retryButton.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L171">                pauseResumeButton.setVisibility(View.GONE);</span>
<span class="nc" id="L172">                imageOptions.setVisibility(View.VISIBLE);</span>
                break;
        }
<span class="nc" id="L175">    }</span>

    /**
     * Checks if a media exists on the corresponding Wikipedia article Currently the check is made
     * for the device's current language Wikipedia
     *
     * @param contribution
     */
    private void checkIfMediaExistsOnWikipediaPage(final Contribution contribution) {
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (contribution.getWikidataPlace() == null</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            || contribution.getWikidataPlace().getWikipediaArticle() == null) {</span>
<span class="nc" id="L186">            return;</span>
        }
<span class="nc" id="L188">        final String wikipediaArticle = contribution.getWikidataPlace().getWikipediaPageTitle();</span>
<span class="nc" id="L189">        compositeDisposable.add(mediaClient.doesPageContainMedia(wikipediaArticle)</span>
<span class="nc" id="L190">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L191">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L192">            .subscribe(mediaExists -&gt; {</span>
<span class="nc" id="L193">                displayWikipediaButton(mediaExists);</span>
<span class="nc" id="L194">            }));</span>
<span class="nc" id="L195">    }</span>

    /**
     * Handle action buttons visibility if the corresponding wikipedia page doesn't contain any
     * media. This method needs to control the state of just the scenario where media does not
     * exists as other scenarios are already handled in the init method.
     *
     * @param mediaExists
     */
    private void displayWikipediaButton(Boolean mediaExists) {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!mediaExists) {</span>
<span class="nc" id="L206">            addToWikipediaButton.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L207">            isWikipediaButtonDisplayed = true;</span>
<span class="nc" id="L208">            cancelButton.setVisibility(View.GONE);</span>
<span class="nc" id="L209">            retryButton.setVisibility(View.GONE);</span>
<span class="nc" id="L210">            imageOptions.setVisibility(View.VISIBLE);</span>
        }
<span class="nc" id="L212">    }</span>

    /**
     * Returns the image source for the image view, first preference is given to thumbUrl if that is
     * null, moves to local uri and if both are null return null
     *
     * @param thumbUrl
     * @param localUri
     * @return
     */
    @Nullable
    private String chooseImageSource(final String thumbUrl, final Uri localUri) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        return !TextUtils.isEmpty(thumbUrl) ? thumbUrl :</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            localUri != null ? localUri.toString() :</span>
<span class="nc" id="L226">                null;</span>
    }

    /**
     * Retry upload when it is failed
     */
    @OnClick(R.id.retryButton)
    public void retryUpload() {
<span class="nc" id="L234">        callback.retryUpload(contribution);</span>
<span class="nc" id="L235">    }</span>

    /**
     * Delete a failed upload attempt
     */
    @OnClick(R.id.cancelButton)
    public void deleteUpload() {
<span class="nc" id="L242">        callback.deleteUpload(contribution);</span>
<span class="nc" id="L243">    }</span>

    @OnClick(R.id.contributionImage)
    public void imageClicked() {
<span class="nc" id="L247">        callback.openMediaDetail(position, isWikipediaButtonDisplayed);</span>
<span class="nc" id="L248">    }</span>

    @OnClick(R.id.wikipediaButton)
    public void wikipediaButtonClicked() {
<span class="nc" id="L252">        callback.addImageToWikipedia(contribution);</span>
<span class="nc" id="L253">    }</span>

    /**
     * Triggers a callback for pause/resume
     */
    @OnClick(R.id.pauseResumeButton)
    public void onPauseResumeButtonClicked() {
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (pauseResumeButton.getTag().toString().equals(&quot;pause&quot;)) {</span>
<span class="nc" id="L261">            pause();</span>
        } else {
<span class="nc" id="L263">            resume();</span>
        }
<span class="nc" id="L265">    }</span>

    private void resume() {
<span class="nc" id="L268">        callback.resumeUpload(contribution);</span>
<span class="nc" id="L269">        setPaused();</span>
<span class="nc" id="L270">    }</span>

    private void pause() {
<span class="nc" id="L273">        pausingPopUp.show();</span>
<span class="nc" id="L274">        callback.pauseUpload(contribution);</span>
<span class="nc" id="L275">        setResume();</span>
<span class="nc" id="L276">    }</span>

    /**
     * Update pause/resume button to show pause state
     */
    private void setPaused() {
<span class="nc" id="L282">        pauseResumeButton.setImageResource(R.drawable.pause_icon);</span>
<span class="nc" id="L283">        pauseResumeButton.setTag(parent.getContext().getString(R.string.pause));</span>
<span class="nc" id="L284">    }</span>

    /**
     * Update pause/resume button to show resume state
     */
    private void setResume() {
<span class="nc" id="L290">        pauseResumeButton.setImageResource(R.drawable.play_icon);</span>
<span class="nc" id="L291">        pauseResumeButton.setTag(parent.getContext().getString(R.string.resume));</span>
<span class="nc" id="L292">    }</span>

    public ImageRequest getImageRequest() {
<span class="nc" id="L295">        return imageRequest;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>