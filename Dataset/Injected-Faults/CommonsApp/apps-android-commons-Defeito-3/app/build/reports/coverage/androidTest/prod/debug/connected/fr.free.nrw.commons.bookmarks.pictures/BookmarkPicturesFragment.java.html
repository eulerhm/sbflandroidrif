<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookmarkPicturesFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.bookmarks.pictures</a> &gt; <span class="el_source">BookmarkPicturesFragment.java</span></div><h1>BookmarkPicturesFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.bookmarks.pictures;

import static android.view.View.GONE;
import static android.view.View.VISIBLE;

import android.annotation.SuppressLint;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.GridView;
import android.widget.ListAdapter;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TextView;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import butterknife.BindView;
import butterknife.ButterKnife;
import dagger.android.support.DaggerFragment;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.bookmarks.BookmarkListRootFragment;
import fr.free.nrw.commons.category.GridViewAdapter;
import fr.free.nrw.commons.utils.NetworkUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.schedulers.Schedulers;
import java.util.List;
import javax.inject.Inject;
import timber.log.Timber;

<span class="nc" id="L35">public class BookmarkPicturesFragment extends DaggerFragment {</span>

    private GridViewAdapter gridAdapter;
<span class="nc" id="L38">    private CompositeDisposable compositeDisposable = new CompositeDisposable();</span>

    @BindView(R.id.statusMessage) TextView statusTextView;
    @BindView(R.id.loadingImagesProgressBar) ProgressBar progressBar;
    @BindView(R.id.bookmarkedPicturesList) GridView gridView;
    @BindView(R.id.parentLayout) RelativeLayout parentLayout;

    @Inject
    BookmarkPicturesController controller;

    /**
     * Create an instance of the fragment with the right bundle parameters
     * @return an instance of the fragment
     */
    public static BookmarkPicturesFragment newInstance() {
<span class="nc" id="L53">        return new BookmarkPicturesFragment();</span>
    }

    @Override
    public View onCreateView(
            @NonNull LayoutInflater inflater,
            ViewGroup container,
            Bundle savedInstanceState
    ) {
<span class="nc" id="L62">        View v = inflater.inflate(R.layout.fragment_bookmarks_pictures, container, false);</span>
<span class="nc" id="L63">        ButterKnife.bind(this, v);</span>
<span class="nc" id="L64">        return v;</span>
    }

    @Override
    public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
<span class="nc" id="L69">        super.onViewCreated(view, savedInstanceState);</span>
<span class="nc" id="L70">        gridView.setOnItemClickListener((AdapterView.OnItemClickListener) getParentFragment());</span>
<span class="nc" id="L71">        initList();</span>
<span class="nc" id="L72">    }</span>

    @Override
    public void onStop() {
<span class="nc" id="L76">        super.onStop();</span>
<span class="nc" id="L77">        controller.stop();</span>
<span class="nc" id="L78">    }</span>

    @Override
    public void onDestroy() {
<span class="nc" id="L82">        super.onDestroy();</span>
<span class="nc" id="L83">        compositeDisposable.clear();</span>
<span class="nc" id="L84">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L88">        super.onResume();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (controller.needRefreshBookmarkedPictures()) {</span>
<span class="nc" id="L90">            gridView.setVisibility(GONE);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if (gridAdapter != null) {</span>
<span class="nc" id="L92">                gridAdapter.clear();</span>
<span class="nc" id="L93">                ((BookmarkListRootFragment)getParentFragment()).viewPagerNotifyDataSetChanged();</span>
            }
<span class="nc" id="L95">            initList();</span>
        }
<span class="nc" id="L97">    }</span>

    /**
     * Checks for internet connection and then initializes
     * the recycler view with bookmarked pictures
     */
    @SuppressLint(&quot;CheckResult&quot;)
    private void initList() {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (!NetworkUtils.isInternetConnectionEstablished(getContext())) {</span>
<span class="nc" id="L106">            handleNoInternet();</span>
<span class="nc" id="L107">            return;</span>
        }

<span class="nc" id="L110">        progressBar.setVisibility(VISIBLE);</span>
<span class="nc" id="L111">        statusTextView.setVisibility(GONE);</span>

<span class="nc" id="L113">        compositeDisposable.add(controller.loadBookmarkedPictures()</span>
<span class="nc" id="L114">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L115">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L116">                .subscribe(this::handleSuccess, this::handleError));</span>
<span class="nc" id="L117">    }</span>

    /**
     * Handles the UI updates for no internet scenario
     */
    private void handleNoInternet() {
<span class="nc" id="L123">        progressBar.setVisibility(GONE);</span>
<span class="nc bnc" id="L124" title="All 4 branches missed.">        if (gridAdapter == null || gridAdapter.isEmpty()) {</span>
<span class="nc" id="L125">            statusTextView.setVisibility(VISIBLE);</span>
<span class="nc" id="L126">            statusTextView.setText(getString(R.string.no_internet));</span>
        } else {
<span class="nc" id="L128">            ViewUtil.showShortSnackbar(parentLayout, R.string.no_internet);</span>
        }
<span class="nc" id="L130">    }</span>

    /**
     * Logs and handles API error scenario
     * @param throwable
     */
    private void handleError(Throwable throwable) {
<span class="nc" id="L137">        Timber.e(throwable, &quot;Error occurred while loading images inside a category&quot;);</span>
        try{
<span class="nc" id="L139">            ViewUtil.showShortSnackbar(parentLayout, R.string.error_loading_images);</span>
<span class="nc" id="L140">            initErrorView();</span>
<span class="nc" id="L141">        }catch (Exception e){</span>
<span class="nc" id="L142">            e.printStackTrace();</span>
<span class="nc" id="L143">        }</span>
<span class="nc" id="L144">    }</span>

    /**
     * Handles the UI updates for a error scenario
     */
    private void initErrorView() {
<span class="nc" id="L150">        progressBar.setVisibility(GONE);</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">        if (gridAdapter == null || gridAdapter.isEmpty()) {</span>
<span class="nc" id="L152">            statusTextView.setVisibility(VISIBLE);</span>
<span class="nc" id="L153">            statusTextView.setText(getString(R.string.no_images_found));</span>
        } else {
<span class="nc" id="L155">            statusTextView.setVisibility(GONE);</span>
        }
<span class="nc" id="L157">    }</span>

    /**
     * Handles the UI updates when there is no bookmarks
     */
    private void initEmptyBookmarkListView() {
<span class="nc" id="L163">        progressBar.setVisibility(GONE);</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">        if (gridAdapter == null || gridAdapter.isEmpty()) {</span>
<span class="nc" id="L165">            statusTextView.setVisibility(VISIBLE);</span>
<span class="nc" id="L166">            statusTextView.setText(getString(R.string.bookmark_empty));</span>
        } else {
<span class="nc" id="L168">            statusTextView.setVisibility(GONE);</span>
        }
<span class="nc" id="L170">    }</span>

    /**
     * Handles the success scenario
     * On first load, it initializes the grid view. On subsequent loads, it adds items to the adapter
     * @param collection List of new Media to be displayed
     */
    private void handleSuccess(List&lt;Media&gt; collection) {
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (collection == null) {</span>
<span class="nc" id="L179">            initErrorView();</span>
<span class="nc" id="L180">            return;</span>
        }
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (collection.isEmpty()) {</span>
<span class="nc" id="L183">            initEmptyBookmarkListView();</span>
<span class="nc" id="L184">            return;</span>
        }

<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (gridAdapter == null) {</span>
<span class="nc" id="L188">            setAdapter(collection);</span>
        } else {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (gridAdapter.containsAll(collection)) {</span>
<span class="nc" id="L191">                progressBar.setVisibility(GONE);</span>
<span class="nc" id="L192">                statusTextView.setVisibility(GONE);</span>
<span class="nc" id="L193">                gridView.setVisibility(VISIBLE);</span>
<span class="nc" id="L194">                gridView.setAdapter(gridAdapter);</span>
<span class="nc" id="L195">                return;</span>
            }
<span class="nc" id="L197">            gridAdapter.addItems(collection);</span>
<span class="nc" id="L198">            ((BookmarkListRootFragment) getParentFragment()).viewPagerNotifyDataSetChanged();</span>
        }
<span class="nc" id="L200">        progressBar.setVisibility(GONE);</span>
<span class="nc" id="L201">        statusTextView.setVisibility(GONE);</span>
<span class="nc" id="L202">        gridView.setVisibility(VISIBLE);</span>
<span class="nc" id="L203">    }</span>

    /**
     * Initializes the adapter with a list of Media objects
     * @param mediaList List of new Media to be displayed
     */
    private void setAdapter(List&lt;Media&gt; mediaList) {
<span class="nc" id="L210">        gridAdapter = new GridViewAdapter(</span>
<span class="nc" id="L211">                this.getContext(),</span>
                R.layout.layout_category_images,
                mediaList
        );
<span class="nc" id="L215">        gridView.setAdapter(gridAdapter);</span>
<span class="nc" id="L216">    }</span>

    /**
     * It return an instance of gridView adapter which helps in extracting media details
     * used by the gridView
     * @return  GridView Adapter
     */
    public ListAdapter getAdapter() {
<span class="nc" id="L224">        return gridView.getAdapter();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>