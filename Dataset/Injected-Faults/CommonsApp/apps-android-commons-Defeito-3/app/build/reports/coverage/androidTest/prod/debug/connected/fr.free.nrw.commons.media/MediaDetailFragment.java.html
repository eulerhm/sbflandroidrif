<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaDetailFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.media</a> &gt; <span class="el_source">MediaDetailFragment.java</span></div><h1>MediaDetailFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.media;

import static android.app.Activity.RESULT_CANCELED;
import static android.app.Activity.RESULT_OK;
import static android.view.View.GONE;
import static android.view.View.VISIBLE;
import static fr.free.nrw.commons.category.CategoryClientKt.CATEGORY_NEEDING_CATEGORIES;
import static fr.free.nrw.commons.category.CategoryClientKt.CATEGORY_UNCATEGORISED;
import static fr.free.nrw.commons.description.EditDescriptionConstants.LIST_OF_DESCRIPTION_AND_CAPTION;
import static fr.free.nrw.commons.description.EditDescriptionConstants.UPDATED_WIKITEXT;
import static fr.free.nrw.commons.description.EditDescriptionConstants.WIKITEXT;
import static fr.free.nrw.commons.upload.mediaDetails.UploadMediaDetailFragment.LAST_LOCATION;
import static fr.free.nrw.commons.utils.LangCodeUtils.getLocalizedResources;

import android.annotation.SuppressLint;
import android.app.AlertDialog;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.res.Configuration;
import android.graphics.drawable.Animatable;
import android.net.Uri;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextUtils;
import android.text.TextWatcher;
import android.view.KeyEvent;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnKeyListener;
import android.view.ViewGroup;
import android.view.ViewTreeObserver;
import android.view.ViewTreeObserver.OnGlobalLayoutListener;
import android.webkit.WebView;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.FrameLayout;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.ScrollView;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentTransaction;
import butterknife.BindView;
import butterknife.ButterKnife;
import butterknife.OnClick;
import com.facebook.drawee.backends.pipeline.Fresco;
import com.facebook.drawee.controller.BaseControllerListener;
import com.facebook.drawee.controller.ControllerListener;
import com.facebook.drawee.interfaces.DraweeController;
import com.facebook.drawee.view.SimpleDraweeView;
import com.facebook.imagepipeline.image.ImageInfo;
import com.facebook.imagepipeline.request.ImageRequest;
import com.mapbox.mapboxsdk.camera.CameraPosition;
import com.mapbox.mapboxsdk.geometry.LatLng;
import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.LocationPicker.LocationPicker;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.MediaDataExtractor;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.Utils;
import fr.free.nrw.commons.actions.ThanksClient;
import fr.free.nrw.commons.auth.AccountUtil;
import fr.free.nrw.commons.auth.SessionManager;
import fr.free.nrw.commons.category.CategoryClient;
import fr.free.nrw.commons.category.CategoryDetailsActivity;
import fr.free.nrw.commons.category.CategoryEditHelper;
import fr.free.nrw.commons.contributions.ContributionsFragment;
import fr.free.nrw.commons.coordinates.CoordinateEditHelper;
import fr.free.nrw.commons.delete.DeleteHelper;
import fr.free.nrw.commons.delete.ReasonBuilder;
import fr.free.nrw.commons.description.DescriptionEditActivity;
import fr.free.nrw.commons.description.DescriptionEditHelper;
import fr.free.nrw.commons.di.ApplicationlessInjection;
import fr.free.nrw.commons.di.CommonsDaggerSupportFragment;
import fr.free.nrw.commons.explore.depictions.WikidataItemDetailsActivity;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LocationServiceManager;
import fr.free.nrw.commons.media.ZoomableActivity.ZoomableActivityConstants;
import fr.free.nrw.commons.profile.ProfileActivity;
import fr.free.nrw.commons.review.ReviewController;
import fr.free.nrw.commons.review.ReviewHelper;
import fr.free.nrw.commons.settings.Prefs;
import fr.free.nrw.commons.ui.widget.HtmlTextView;
import fr.free.nrw.commons.upload.categories.UploadCategoriesFragment;
import fr.free.nrw.commons.upload.depicts.DepictsFragment;
import fr.free.nrw.commons.upload.UploadMediaDetail;
import fr.free.nrw.commons.utils.DialogUtil;
import fr.free.nrw.commons.utils.PermissionUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import fr.free.nrw.commons.utils.ViewUtilWrapper;
import io.reactivex.Observable;
import io.reactivex.ObservableSource;
import io.reactivex.Single;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.schedulers.Schedulers;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.concurrent.Callable;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.inject.Inject;
import javax.inject.Named;
import org.apache.commons.lang3.StringUtils;
import org.wikipedia.dataclient.mwapi.MwQueryPage;
import org.wikipedia.language.AppLanguageLookUpTable;
import org.wikipedia.util.DateUtil;
import timber.log.Timber;

<span class="nc" id="L123">public class MediaDetailFragment extends CommonsDaggerSupportFragment implements</span>
    CategoryEditHelper.Callback {

    private static final int REQUEST_CODE = 1001;
    private static final int REQUEST_CODE_EDIT_DESCRIPTION = 1002;
    private static final String IMAGE_BACKGROUND_COLOR = &quot;image_background_color&quot;;
    static final int DEFAULT_IMAGE_BACKGROUND_COLOR = 0;
    
    private boolean editable;
    private boolean isCategoryImage;
    private MediaDetailPagerFragment.MediaDetailProvider detailProvider;
    private int index;
<span class="nc" id="L135">    private boolean isDeleted = false;</span>
    private boolean isWikipediaButtonDisplayed;
    private Callback callback;

    @Inject
    LocationServiceManager locationManager;


    public static MediaDetailFragment forMedia(int index, boolean editable, boolean isCategoryImage, boolean isWikipediaButtonDisplayed) {
<span class="nc" id="L144">        MediaDetailFragment mf = new MediaDetailFragment();</span>
<span class="nc" id="L145">        Bundle state = new Bundle();</span>
<span class="nc" id="L146">        state.putBoolean(&quot;editable&quot;, editable);</span>
<span class="nc" id="L147">        state.putBoolean(&quot;isCategoryImage&quot;, isCategoryImage);</span>
<span class="nc" id="L148">        state.putInt(&quot;index&quot;, index);</span>
<span class="nc" id="L149">        state.putInt(&quot;listIndex&quot;, 0);</span>
<span class="nc" id="L150">        state.putInt(&quot;listTop&quot;, 0);</span>
<span class="nc" id="L151">        state.putBoolean(&quot;isWikipediaButtonDisplayed&quot;, isWikipediaButtonDisplayed);</span>
<span class="nc" id="L152">        mf.setArguments(state);</span>

<span class="nc" id="L154">        return mf;</span>
    }

    @Inject
    SessionManager sessionManager;

    @Inject
    MediaDataExtractor mediaDataExtractor;
    @Inject
    ReasonBuilder reasonBuilder;
    @Inject
    DeleteHelper deleteHelper;
    @Inject
    ReviewHelper reviewHelper;
    @Inject
    CategoryEditHelper categoryEditHelper;
    @Inject
    CoordinateEditHelper coordinateEditHelper;
    @Inject
    DescriptionEditHelper descriptionEditHelper;
    @Inject
    ViewUtilWrapper viewUtil;
    @Inject
    CategoryClient categoryClient;
    @Inject
    ThanksClient thanksClient;
    @Inject
    @Named(&quot;default_preferences&quot;)
    JsonKvStore applicationKvStore;

<span class="nc" id="L184">    private int initialListTop = 0;</span>
    @BindView(R.id.description_webview)
    WebView descriptionWebView;
    @BindView(R.id.mediaDetailFrameLayout)
    FrameLayout frameLayout;
    @BindView(R.id.mediaDetailImageView)
    SimpleDraweeView image;
    @BindView(R.id.mediaDetailImageViewSpacer)
    LinearLayout imageSpacer;
    @BindView(R.id.mediaDetailTitle)
    TextView title;
    @BindView(R.id.caption_layout)
    LinearLayout captionLayout;
    @BindView(R.id.depicts_layout)
    LinearLayout depictsLayout;
    @BindView(R.id.depictionsEditButton)
    Button depictEditButton;
    @BindView(R.id.media_detail_caption)
    TextView mediaCaption;
    @BindView(R.id.mediaDetailDesc)
    HtmlTextView desc;
    @BindView(R.id.mediaDetailAuthor)
    TextView author;
    @BindView(R.id.mediaDetailLicense)
    TextView license;
    @BindView(R.id.mediaDetailCoordinates)
    TextView coordinates;
    @BindView(R.id.mediaDetailuploadeddate)
    TextView uploadedDate;
    @BindView(R.id.mediaDetailDisc)
    TextView mediaDiscussion;
    @BindView(R.id.seeMore)
    TextView seeMore;
    @BindView(R.id.nominatedDeletionBanner)
    LinearLayout nominatedForDeletion;
    @BindView(R.id.mediaDetailCategoryContainer)
    LinearLayout categoryContainer;
    @BindView(R.id.categoryEditButton)
    Button categoryEditButton;
    @BindView(R.id.media_detail_depiction_container)
    LinearLayout depictionContainer;
    @BindView(R.id.authorLinearLayout)
    LinearLayout authorLayout;
    @BindView(R.id.nominateDeletion)
    Button delete;
    @BindView(R.id.mediaDetailScrollView)
    ScrollView scrollView;
    @BindView(R.id.toDoLayout)
    LinearLayout toDoLayout;
    @BindView(R.id.toDoReason)
    TextView toDoReason;
    @BindView(R.id.coordinate_edit)
    Button coordinateEditButton;
    @BindView(R.id.dummy_caption_description_container)
    LinearLayout showCaptionAndDescriptionContainer;
    @BindView(R.id.show_caption_description_textview)
    TextView showCaptionDescriptionTextView;
    @BindView(R.id.caption_listview)
    ListView captionsListView;
    @BindView(R.id.caption_label)
    TextView captionLabel;
    @BindView(R.id.description_label)
    TextView descriptionLabel;
    @BindView(R.id.pb_circular)
    ProgressBar progressBar;
    String descriptionHtmlCode;
    @BindView(R.id.progressBarDeletion)
    ProgressBar progressBarDeletion;
    @BindView(R.id.progressBarEdit)
    ProgressBar progressBarEditDescription;
    @BindView(R.id.progressBarEditCategory)
    ProgressBar progressBarEditCategory;
    @BindView(R.id.description_edit)
    Button editDescription;
    @BindView(R.id.sendThanks)
    Button sendThanksButton;

<span class="nc" id="L261">    private ArrayList&lt;String&gt; categoryNames = new ArrayList&lt;&gt;();</span>
    private String categorySearchQuery;

    /**
     * Depicts is a feature part of Structured data. Multiple Depictions can be added for an image just like categories.
     * However unlike categories depictions is multi-lingual
     * Ex: key: en value: monument
     */
    private ImageInfo imageInfoCache;
    private int oldWidthOfImageView;
    private int newWidthOfImageView;
<span class="nc" id="L272">    private boolean heightVerifyingBoolean = true; // helps in maintaining aspect ratio</span>
    private ViewTreeObserver.OnGlobalLayoutListener layoutListener; // for layout stuff, only used once!

    //Had to make this class variable, to implement various onClicks, which access the media, also I fell why make separate variables when one can serve the purpose
    private Media media;
    private ArrayList&lt;String&gt; reasonList;
    private ArrayList&lt;String&gt; reasonListEnglishMappings;

    /**
     * Height stores the height of the frame layout as soon as it is initialised and updates itself on
     * configuration changes.
     * Used to adjust aspect ratio of image when length of the image is too large.
     */
    private int frameLayoutHeight;

    /**
     * Minimum height of the metadata, in pixels.
     * Images with a very narrow aspect ratio will be reduced so that the metadata information panel always has at least this height.
     */
<span class="nc" id="L291">    private int minimumHeightOfMetadata = 200;</span>

    final static String NOMINATING_FOR_DELETION_MEDIA = &quot;Nominating for deletion %s&quot;;

    @Override
    public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L297">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L298">        outState.putInt(&quot;index&quot;, index);</span>
<span class="nc" id="L299">        outState.putBoolean(&quot;editable&quot;, editable);</span>
<span class="nc" id="L300">        outState.putBoolean(&quot;isCategoryImage&quot;, isCategoryImage);</span>
<span class="nc" id="L301">        outState.putBoolean(&quot;isWikipediaButtonDisplayed&quot;, isWikipediaButtonDisplayed);</span>

<span class="nc" id="L303">        getScrollPosition();</span>
<span class="nc" id="L304">        outState.putInt(&quot;listTop&quot;, initialListTop);</span>
<span class="nc" id="L305">    }</span>

    private void getScrollPosition() {
<span class="nc" id="L308">        initialListTop = scrollView.getScrollY();</span>
<span class="nc" id="L309">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (getParentFragment() != null</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">            &amp;&amp; getParentFragment() instanceof MediaDetailPagerFragment) {</span>
<span class="nc" id="L315">            detailProvider =</span>
<span class="nc" id="L316">                ((MediaDetailPagerFragment) getParentFragment()).getMediaDetailProvider();</span>
        }
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L319">            editable = savedInstanceState.getBoolean(&quot;editable&quot;);</span>
<span class="nc" id="L320">            isCategoryImage = savedInstanceState.getBoolean(&quot;isCategoryImage&quot;);</span>
<span class="nc" id="L321">            isWikipediaButtonDisplayed = savedInstanceState.getBoolean(&quot;isWikipediaButtonDisplayed&quot;);</span>
<span class="nc" id="L322">            index = savedInstanceState.getInt(&quot;index&quot;);</span>
<span class="nc" id="L323">            initialListTop = savedInstanceState.getInt(&quot;listTop&quot;);</span>
        } else {
<span class="nc" id="L325">            editable = getArguments().getBoolean(&quot;editable&quot;);</span>
<span class="nc" id="L326">            isCategoryImage = getArguments().getBoolean(&quot;isCategoryImage&quot;);</span>
<span class="nc" id="L327">            isWikipediaButtonDisplayed = getArguments().getBoolean(&quot;isWikipediaButtonDisplayed&quot;);</span>
<span class="nc" id="L328">            index = getArguments().getInt(&quot;index&quot;);</span>
<span class="nc" id="L329">            initialListTop = 0;</span>
        }

<span class="nc" id="L332">        reasonList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L333">        reasonList.add(getString(R.string.deletion_reason_uploaded_by_mistake));</span>
<span class="nc" id="L334">        reasonList.add(getString(R.string.deletion_reason_publicly_visible));</span>
<span class="nc" id="L335">        reasonList.add(getString(R.string.deletion_reason_not_interesting));</span>
<span class="nc" id="L336">        reasonList.add(getString(R.string.deletion_reason_no_longer_want_public));</span>
<span class="nc" id="L337">        reasonList.add(getString(R.string.deletion_reason_bad_for_my_privacy));</span>

        // Add corresponding mappings in english locale so that we can upload it in deletion request
<span class="nc" id="L340">        reasonListEnglishMappings = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L341">        reasonListEnglishMappings.add(getLocalizedResources(getContext(), Locale.ENGLISH).getString(R.string.deletion_reason_uploaded_by_mistake));</span>
<span class="nc" id="L342">        reasonListEnglishMappings.add(getLocalizedResources(getContext(), Locale.ENGLISH).getString(R.string.deletion_reason_publicly_visible));</span>
<span class="nc" id="L343">        reasonListEnglishMappings.add(getLocalizedResources(getContext(), Locale.ENGLISH).getString(R.string.deletion_reason_not_interesting));</span>
<span class="nc" id="L344">        reasonListEnglishMappings.add(getLocalizedResources(getContext(), Locale.ENGLISH).getString(R.string.deletion_reason_no_longer_want_public));</span>
<span class="nc" id="L345">        reasonListEnglishMappings.add(getLocalizedResources(getContext(), Locale.ENGLISH).getString(R.string.deletion_reason_bad_for_my_privacy));</span>

<span class="nc" id="L347">        final View view = inflater.inflate(R.layout.fragment_media_detail, container, false);</span>

<span class="nc" id="L349">        ButterKnife.bind(this,view);</span>
<span class="nc" id="L350">        Utils.setUnderlinedText(seeMore, R.string.nominated_see_more, requireContext());</span>

<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (isCategoryImage){</span>
<span class="nc" id="L353">            authorLayout.setVisibility(VISIBLE);</span>
        } else {
<span class="nc" id="L355">            authorLayout.setVisibility(GONE);</span>
        }

<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (!sessionManager.isUserLoggedIn()) {</span>
<span class="nc" id="L359">            categoryEditButton.setVisibility(GONE);</span>
        }

<span class="nc bnc" id="L362" title="All 2 branches missed.">        if(applicationKvStore.getBoolean(&quot;login_skipped&quot;)){</span>
<span class="nc" id="L363">            delete.setVisibility(GONE);</span>
<span class="nc" id="L364">            coordinateEditButton.setVisibility(GONE);</span>
        }

<span class="nc" id="L367">        handleBackEvent(view);</span>

        /**
         * Gets the height of the frame layout as soon as the view is ready and updates aspect ratio
         * of the picture.
         */
<span class="nc" id="L373">        view.post(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L376">                frameLayoutHeight = frameLayout.getMeasuredHeight();</span>
<span class="nc" id="L377">                updateAspectRatio(scrollView.getWidth());</span>
<span class="nc" id="L378">            }</span>
        });

<span class="nc" id="L381">        return view;</span>
    }

    @OnClick(R.id.mediaDetailImageViewSpacer)
    public void launchZoomActivity(final View view) {
<span class="nc" id="L386">        final boolean hasPermission = PermissionUtils.hasPermission(getActivity(), PermissionUtils.PERMISSIONS_STORAGE);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (hasPermission) {</span>
<span class="nc" id="L388">            launchZoomActivityAfterPermissionCheck(view);</span>
        } else {
<span class="nc" id="L390">            PermissionUtils.checkPermissionsAndPerformAction(getActivity(),</span>
                () -&gt; {
<span class="nc" id="L392">                    launchZoomActivityAfterPermissionCheck(view);</span>
<span class="nc" id="L393">                },</span>
                R.string.storage_permission_title,
                R.string.read_storage_permission_rationale,
                PermissionUtils.PERMISSIONS_STORAGE
                );
        }
<span class="nc" id="L399">    }</span>

    /**
     * launch zoom acitivity after permission check
     * @param view as ImageView
     */
    private void launchZoomActivityAfterPermissionCheck(final View view) {
<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (media.getImageUrl() != null) {</span>
<span class="nc" id="L407">            final Context ctx = view.getContext();</span>
<span class="nc" id="L408">            final Intent zoomableIntent = new Intent(ctx, ZoomableActivity.class);</span>
<span class="nc" id="L409">            zoomableIntent.setData(Uri.parse(media.getImageUrl()));</span>
<span class="nc" id="L410">            zoomableIntent.putExtra(</span>
                ZoomableActivity.ZoomableActivityConstants.ORIGIN, &quot;MediaDetails&quot;);
            
<span class="nc" id="L413">            int backgroundColor = getImageBackgroundColor();</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">            if (backgroundColor != DEFAULT_IMAGE_BACKGROUND_COLOR) {</span>
<span class="nc" id="L415">                zoomableIntent.putExtra(</span>
                    ZoomableActivity.ZoomableActivityConstants.PHOTO_BACKGROUND_COLOR,
                    backgroundColor
                );
            }
            
<span class="nc" id="L421">            ctx.startActivity(</span>
                zoomableIntent
            );
        }
<span class="nc" id="L425">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L429">        super.onResume();</span>
<span class="nc bnc" id="L430" title="All 4 branches missed.">        if (getParentFragment() != null &amp;&amp; getParentFragment().getParentFragment() != null) {</span>
            //Added a check because, not necessarily, the parent fragment will have a parent fragment, say
            // in the case when MediaDetailPagerFragment is directly started by the CategoryImagesActivity
<span class="nc bnc" id="L433" title="All 2 branches missed.">            if (getParentFragment() instanceof ContributionsFragment) {</span>
<span class="nc" id="L434">                ((ContributionsFragment) (getParentFragment()</span>
<span class="nc" id="L435">                    .getParentFragment())).nearbyNotificationCardView</span>
<span class="nc" id="L436">                    .setVisibility(View.GONE);</span>
            }
        }
        // detail provider is null when fragment is shown in review activity
<span class="nc bnc" id="L440" title="All 2 branches missed.">        if (detailProvider != null) {</span>
<span class="nc" id="L441">            media = detailProvider.getMediaAtPosition(index);</span>
        } else {
<span class="nc" id="L443">            media = getArguments().getParcelable(&quot;media&quot;);</span>
        }

<span class="nc bnc" id="L446" title="All 4 branches missed.">        if(media != null &amp;&amp; applicationKvStore.getBoolean(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()), false)) {</span>
<span class="nc" id="L447">            enableProgressBar();</span>
        }

<span class="nc bnc" id="L450" title="All 4 branches missed.">        if (AccountUtil.getUserName(getContext()) != null &amp;&amp; media != null</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">            &amp;&amp; AccountUtil.getUserName(getContext()).equals(media.getAuthor())) {</span>
<span class="nc" id="L452">            sendThanksButton.setVisibility(GONE);</span>
        } else {
<span class="nc" id="L454">            sendThanksButton.setVisibility(VISIBLE);</span>
        }

<span class="nc" id="L457">        scrollView.getViewTreeObserver().addOnGlobalLayoutListener(</span>
<span class="nc" id="L458">            new OnGlobalLayoutListener() {</span>
                @Override
                public void onGlobalLayout() {
<span class="nc bnc" id="L461" title="All 2 branches missed.">                    if (getContext() == null) {</span>
<span class="nc" id="L462">                        return;</span>
                    }
<span class="nc" id="L464">                    scrollView.getViewTreeObserver().removeOnGlobalLayoutListener(this);</span>
<span class="nc" id="L465">                    oldWidthOfImageView = scrollView.getWidth();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">                    if(media != null) {</span>
<span class="nc" id="L467">                        displayMediaDetails();</span>
                    }
<span class="nc" id="L469">                }</span>
            }
        );
<span class="nc" id="L472">    }</span>

    @Override
    public void onConfigurationChanged(Configuration newConfig) {
<span class="nc" id="L476">        super.onConfigurationChanged(newConfig);</span>
<span class="nc" id="L477">        scrollView.getViewTreeObserver().addOnGlobalLayoutListener(</span>
<span class="nc" id="L478">            new OnGlobalLayoutListener() {</span>
                @Override
                public void onGlobalLayout() {
                    /**
                     * We update the height of the frame layout as the configuration changes.
                     */
<span class="nc" id="L484">                    frameLayout.post(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L487">                            frameLayoutHeight = frameLayout.getMeasuredHeight();</span>
<span class="nc" id="L488">                            updateAspectRatio(scrollView.getWidth());</span>
<span class="nc" id="L489">                        }</span>
                    });
<span class="nc bnc" id="L491" title="All 2 branches missed.">                    if (scrollView.getWidth() != oldWidthOfImageView) {</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">                        if (newWidthOfImageView == 0) {</span>
<span class="nc" id="L493">                            newWidthOfImageView = scrollView.getWidth();</span>
<span class="nc" id="L494">                            updateAspectRatio(newWidthOfImageView);</span>
                        }
<span class="nc" id="L496">                        scrollView.getViewTreeObserver().removeOnGlobalLayoutListener(this);</span>
                    }
<span class="nc" id="L498">                }</span>
            }
        );
        // Ensuring correct aspect ratio for landscape mode
<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (heightVerifyingBoolean) {</span>
<span class="nc" id="L503">            updateAspectRatio(newWidthOfImageView);</span>
<span class="nc" id="L504">            heightVerifyingBoolean = false;</span>
        } else {
<span class="nc" id="L506">            updateAspectRatio(oldWidthOfImageView);</span>
<span class="nc" id="L507">            heightVerifyingBoolean = true;</span>
        }
<span class="nc" id="L509">    }</span>

    private void displayMediaDetails() {
<span class="nc" id="L512">        setTextFields(media);</span>
<span class="nc" id="L513">        compositeDisposable.addAll(</span>
<span class="nc" id="L514">            mediaDataExtractor.refresh(media)</span>
<span class="nc" id="L515">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L516">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L517">                .subscribe(this::onMediaRefreshed, Timber::e),</span>
<span class="nc" id="L518">            mediaDataExtractor.getCurrentWikiText(</span>
<span class="nc" id="L519">                Objects.requireNonNull(media.getFilename()))</span>
<span class="nc" id="L520">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L521">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L522">                .subscribe(this::updateCategoryList, Timber::e),</span>
<span class="nc" id="L523">            mediaDataExtractor.checkDeletionRequestExists(media)</span>
<span class="nc" id="L524">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L525">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L526">                .subscribe(this::onDeletionPageExists, Timber::e),</span>
<span class="nc" id="L527">            mediaDataExtractor.fetchDiscussion(media)</span>
<span class="nc" id="L528">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L529">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L530">                .subscribe(this::onDiscussionLoaded, Timber::e)</span>
        );
<span class="nc" id="L532">    }</span>

    private void onMediaRefreshed(Media media) {
<span class="nc" id="L535">        media.setCategories(this.media.getCategories());</span>
<span class="nc" id="L536">        this.media = media;</span>
<span class="nc" id="L537">        setTextFields(media);</span>
<span class="nc" id="L538">        compositeDisposable.addAll(</span>
<span class="nc" id="L539">            mediaDataExtractor.fetchDepictionIdsAndLabels(media)</span>
<span class="nc" id="L540">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L541">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L542">                .subscribe(this::onDepictionsLoaded, Timber::e)</span>
        );
        // compositeDisposable.add(disposable);
<span class="nc" id="L545">    }</span>

    private void onDiscussionLoaded(String discussion) {
<span class="nc" id="L548">        mediaDiscussion.setText(prettyDiscussion(discussion.trim()));</span>
<span class="nc" id="L549">    }</span>

    private void onDeletionPageExists(Boolean deletionPageExists) {
<span class="nc bnc" id="L552" title="All 2 branches missed.">        if (deletionPageExists){</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">            if(applicationKvStore.getBoolean(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()), false)) {</span>
<span class="nc" id="L554">                applicationKvStore.remove(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()));</span>
<span class="nc" id="L555">                progressBarDeletion.setVisibility(GONE);</span>
            }
<span class="nc" id="L557">            delete.setVisibility(GONE);</span>
<span class="nc" id="L558">            nominatedForDeletion.setVisibility(VISIBLE);</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">        } else if (!isCategoryImage) {</span>
<span class="nc" id="L560">            delete.setVisibility(VISIBLE);</span>
<span class="nc" id="L561">            nominatedForDeletion.setVisibility(GONE);</span>
        }
<span class="nc" id="L563">    }</span>

    private void onDepictionsLoaded(List&lt;IdAndCaptions&gt; idAndCaptions){
<span class="nc bnc" id="L566" title="All 2 branches missed.">        depictsLayout.setVisibility(idAndCaptions.isEmpty() ? GONE : VISIBLE);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">        depictEditButton.setVisibility(idAndCaptions.isEmpty() ? GONE : VISIBLE);</span>
<span class="nc" id="L568">        buildDepictionList(idAndCaptions);</span>
<span class="nc" id="L569">    }</span>

    /**
     * By clicking on the edit depictions button, it will send user to depict fragment
     */
    @OnClick(R.id.depictionsEditButton)
    public void onDepictionsEditButtonClicked() {
<span class="nc" id="L576">        depictionContainer.removeAllViews();</span>
<span class="nc" id="L577">        depictEditButton.setVisibility(GONE);</span>
<span class="nc" id="L578">        final Fragment depictsFragment = new DepictsFragment();</span>
<span class="nc" id="L579">        final Bundle bundle = new Bundle();</span>
<span class="nc" id="L580">        bundle.putParcelable(&quot;Existing_Depicts&quot;, media);</span>
<span class="nc" id="L581">        depictsFragment.setArguments(bundle);</span>
<span class="nc" id="L582">        final FragmentTransaction transaction = getChildFragmentManager().beginTransaction();</span>
<span class="nc" id="L583">        transaction.replace(R.id.mediaDetailFrameLayout, depictsFragment);</span>
<span class="nc" id="L584">        transaction.addToBackStack(null);</span>
<span class="nc" id="L585">        transaction.commit();</span>
<span class="nc" id="L586">    }</span>
    /**
     * The imageSpacer is Basically a transparent overlay for the SimpleDraweeView
     * which holds the image to be displayed( moreover this image is out of
     * the scroll view )
     *
     *
     * If the image is sufficiently large i.e. the image height extends the view height, we reduce
     * the height and change the width to maintain the aspect ratio, otherwise image takes up the
     * total possible width and height is adjusted accordingly.
     *
     * @param scrollWidth the current width of the scrollView
     */
    private void updateAspectRatio(int scrollWidth) {
<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (imageInfoCache != null) {</span>
<span class="nc" id="L601">            int finalHeight = (scrollWidth*imageInfoCache.getHeight()) / imageInfoCache.getWidth();</span>
<span class="nc" id="L602">            ViewGroup.LayoutParams params = image.getLayoutParams();</span>
<span class="nc" id="L603">            ViewGroup.LayoutParams spacerParams = imageSpacer.getLayoutParams();</span>
<span class="nc" id="L604">            params.width = scrollWidth;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">            if(finalHeight &gt; frameLayoutHeight - minimumHeightOfMetadata) {</span>

                // Adjust the height and width of image.
<span class="nc" id="L608">                int temp = frameLayoutHeight - minimumHeightOfMetadata;</span>
<span class="nc" id="L609">                params.width = (scrollWidth*temp) / finalHeight;</span>
<span class="nc" id="L610">                finalHeight = temp;</span>

            }
<span class="nc" id="L613">            params.height = finalHeight;</span>
<span class="nc" id="L614">            spacerParams.height = finalHeight;</span>
<span class="nc" id="L615">            image.setLayoutParams(params);</span>
<span class="nc" id="L616">            imageSpacer.setLayoutParams(spacerParams);</span>
        }
<span class="nc" id="L618">    }</span>

<span class="nc" id="L620">    private final ControllerListener aspectRatioListener = new BaseControllerListener&lt;ImageInfo&gt;() {</span>
        @Override
        public void onIntermediateImageSet(String id, @Nullable ImageInfo imageInfo) {
<span class="nc" id="L623">            imageInfoCache = imageInfo;</span>
<span class="nc" id="L624">            updateAspectRatio(scrollView.getWidth());</span>
<span class="nc" id="L625">        }</span>
        @Override
        public void onFinalImageSet(String id, @Nullable ImageInfo imageInfo, @Nullable Animatable animatable) {
<span class="nc" id="L628">            imageInfoCache = imageInfo;</span>
<span class="nc" id="L629">            updateAspectRatio(scrollView.getWidth());</span>
<span class="nc" id="L630">        }</span>
    };

    /**
     * Uses two image sources.
     * - low resolution thumbnail is shown initially
     * - when the high resolution image is available, it replaces the low resolution image
     */
    private void setupImageView() {
<span class="nc" id="L639">        int imageBackgroundColor = getImageBackgroundColor();</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">        if (imageBackgroundColor != DEFAULT_IMAGE_BACKGROUND_COLOR) {</span>
<span class="nc" id="L641">            image.setBackgroundColor(imageBackgroundColor);</span>
        }

<span class="nc" id="L644">        image.getHierarchy().setPlaceholderImage(R.drawable.image_placeholder);</span>
<span class="nc" id="L645">        image.getHierarchy().setFailureImage(R.drawable.image_placeholder);</span>

<span class="nc" id="L647">        DraweeController controller = Fresco.newDraweeControllerBuilder()</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">            .setLowResImageRequest(ImageRequest.fromUri(media != null ? media.getThumbUrl() : null))</span>
<span class="nc" id="L649">            .setRetainImageOnFailure(true)</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">            .setImageRequest(ImageRequest.fromUri(media != null ? media.getImageUrl() : null))</span>
<span class="nc" id="L651">            .setControllerListener(aspectRatioListener)</span>
<span class="nc" id="L652">            .setOldController(image.getController())</span>
<span class="nc" id="L653">            .build();</span>
<span class="nc" id="L654">        image.setController(controller);</span>
<span class="nc" id="L655">    }</span>

    private void updateToDoWarning() {
<span class="nc" id="L658">        String toDoMessage = &quot;&quot;;</span>
<span class="nc" id="L659">        boolean toDoNeeded = false;</span>
<span class="nc bnc" id="L660" title="All 4 branches missed.">        boolean categoriesPresent = media.getCategories() == null ? false : (media.getCategories().size() == 0 ? false : true);</span>

        // Check if the presented category is about need of category
<span class="nc bnc" id="L663" title="All 2 branches missed.">        if (categoriesPresent) {</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">            for (String category : media.getCategories()) {</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">                if (category.toLowerCase().contains(CATEGORY_NEEDING_CATEGORIES) ||</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">                    category.toLowerCase().contains(CATEGORY_UNCATEGORISED)) {</span>
<span class="nc" id="L667">                    categoriesPresent = false;</span>
                }
                break;
            }
        }
<span class="nc bnc" id="L672" title="All 2 branches missed.">        if (!categoriesPresent) {</span>
<span class="nc" id="L673">            toDoNeeded = true;</span>
<span class="nc" id="L674">            toDoMessage += getString(R.string.missing_category);</span>
        }
<span class="nc bnc" id="L676" title="All 2 branches missed.">        if (isWikipediaButtonDisplayed) {</span>
<span class="nc" id="L677">            toDoNeeded = true;</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">            toDoMessage += (toDoMessage.isEmpty()) ? &quot;&quot; : &quot;\n&quot; + getString(R.string.missing_article);</span>
        }

<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (toDoNeeded) {</span>
<span class="nc" id="L682">            toDoMessage = getString(R.string.todo_improve) + &quot;\n&quot; + toDoMessage;</span>
<span class="nc" id="L683">            toDoLayout.setVisibility(VISIBLE);</span>
<span class="nc" id="L684">            toDoReason.setText(toDoMessage);</span>
        } else {
<span class="nc" id="L686">            toDoLayout.setVisibility(GONE);</span>
        }
<span class="nc" id="L688">    }</span>

    @Override
    public void onDestroyView() {
<span class="nc bnc" id="L692" title="All 4 branches missed.">        if (layoutListener != null &amp;&amp; getView() != null) {</span>
<span class="nc" id="L693">            getView().getViewTreeObserver().removeGlobalOnLayoutListener(layoutListener); // old Android was on crack. CRACK IS WHACK</span>
<span class="nc" id="L694">            layoutListener = null;</span>
        }

<span class="nc" id="L697">        compositeDisposable.clear();</span>
<span class="nc" id="L698">        super.onDestroyView();</span>
<span class="nc" id="L699">    }</span>

    private void setTextFields(Media media) {
<span class="nc" id="L702">        setupImageView();</span>
<span class="nc" id="L703">        title.setText(media.getDisplayTitle());</span>
<span class="nc" id="L704">        desc.setHtmlText(prettyDescription(media));</span>
<span class="nc" id="L705">        license.setText(prettyLicense(media));</span>
<span class="nc" id="L706">        coordinates.setText(prettyCoordinates(media));</span>
<span class="nc" id="L707">        uploadedDate.setText(prettyUploadedDate(media));</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">        if (prettyCaption(media).equals(getContext().getString(R.string.detail_caption_empty))) {</span>
<span class="nc" id="L709">            captionLayout.setVisibility(GONE);</span>
        } else {
<span class="nc" id="L711">            mediaCaption.setText(prettyCaption(media));</span>
        }

<span class="nc" id="L714">        categoryNames.clear();</span>
<span class="nc" id="L715">        categoryNames.addAll(media.getCategories());</span>

<span class="nc bnc" id="L717" title="All 4 branches missed.">        if (media.getAuthor() == null || media.getAuthor().equals(&quot;&quot;)) {</span>
<span class="nc" id="L718">            authorLayout.setVisibility(GONE);</span>
        } else {
<span class="nc" id="L720">            author.setText(media.getAuthor());</span>
        }
<span class="nc" id="L722">    }</span>

    /**
     * Gets new categories from the WikiText and updates it on the UI
     *
     * @param s WikiText
     */
    private void updateCategoryList(final String s) {
<span class="nc" id="L730">        final List&lt;String&gt; allCategories = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L731">        int i = s.indexOf(&quot;[[Category:&quot;);</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">        while(i != -1){</span>
<span class="nc" id="L733">            final String category = s.substring(i+11, s.indexOf(&quot;]]&quot;, i));</span>
<span class="nc" id="L734">            allCategories.add(category);</span>
<span class="nc" id="L735">            i = s.indexOf(&quot;]]&quot;, i);</span>
<span class="nc" id="L736">            i = s.indexOf(&quot;[[Category:&quot;, i);</span>
<span class="nc" id="L737">        }</span>
<span class="nc" id="L738">        media.setCategories(allCategories);</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">        if (allCategories.isEmpty()) {</span>
            // Stick in a filler element.
<span class="nc" id="L741">            allCategories.add(getString(R.string.detail_panel_cats_none));</span>
        }
<span class="nc" id="L743">        categoryEditButton.setVisibility(VISIBLE);</span>
<span class="nc" id="L744">        rebuildCatList(allCategories);</span>
<span class="nc" id="L745">    }</span>

    /**
     * Updates the categories
     */
    public void updateCategories() {
<span class="nc" id="L751">        List&lt;String&gt; allCategories = new ArrayList&lt;String&gt;(media.getAddedCategories());</span>
<span class="nc" id="L752">        media.setCategories(allCategories);</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">        if (allCategories.isEmpty()) {</span>
            // Stick in a filler element.
<span class="nc" id="L755">            allCategories.add(getString(R.string.detail_panel_cats_none));</span>
        }

<span class="nc" id="L758">        rebuildCatList(allCategories);</span>
<span class="nc" id="L759">    }</span>

    /**
     * Populates media details fragment with depiction list
     * @param idAndCaptions
     */
    private void buildDepictionList(List&lt;IdAndCaptions&gt; idAndCaptions) {
<span class="nc" id="L766">        depictionContainer.removeAllViews();</span>
<span class="nc" id="L767">        String locale = Locale.getDefault().getLanguage();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        for (IdAndCaptions idAndCaption : idAndCaptions) {</span>
<span class="nc" id="L769">                depictionContainer.addView(buildDepictLabel(</span>
<span class="nc" id="L770">                    getDepictionCaption(idAndCaption, locale),</span>
<span class="nc" id="L771">                    idAndCaption.getId(),</span>
                    depictionContainer
                ));
<span class="nc" id="L774">        }</span>
<span class="nc" id="L775">    }</span>

    private String getDepictionCaption(IdAndCaptions idAndCaption, String locale) {
        //Check if the Depiction Caption is available in user's locale if not then check for english, else show any available.
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if(idAndCaption.getCaptions().get(locale) != null) {</span>
<span class="nc" id="L780">            return idAndCaption.getCaptions().get(locale);</span>
        }
<span class="nc bnc" id="L782" title="All 2 branches missed.">        if(idAndCaption.getCaptions().get(&quot;en&quot;) != null) {</span>
<span class="nc" id="L783">            return idAndCaption.getCaptions().get(&quot;en&quot;);</span>
        }
<span class="nc" id="L785">        return idAndCaption.getCaptions().values().iterator().next();</span>
    }

    @OnClick(R.id.mediaDetailLicense)
    public void onMediaDetailLicenceClicked(){
<span class="nc" id="L790">        String url = media.getLicenseUrl();</span>
<span class="nc bnc" id="L791" title="All 4 branches missed.">        if (!StringUtils.isBlank(url) &amp;&amp; getActivity() != null) {</span>
<span class="nc" id="L792">            Utils.handleWebUrl(getActivity(), Uri.parse(url));</span>
        } else {
<span class="nc" id="L794">            viewUtil.showShortToast(getActivity(), getString(R.string.null_url));</span>
        }
<span class="nc" id="L796">    }</span>

    @OnClick(R.id.mediaDetailCoordinates)
    public void onMediaDetailCoordinatesClicked(){
<span class="nc bnc" id="L800" title="All 4 branches missed.">        if (media.getCoordinates() != null &amp;&amp; getActivity() != null) {</span>
<span class="nc" id="L801">            Utils.handleGeoCoordinates(getActivity(), media.getCoordinates());</span>
        }
<span class="nc" id="L803">    }</span>

    @OnClick(R.id.copyWikicode)
    public void onCopyWikicodeClicked() {
<span class="nc" id="L807">        String data =</span>
<span class="nc" id="L808">            &quot;[[&quot; + media.getFilename() + &quot;|thumb|&quot; + media.getFallbackDescription() + &quot;]]&quot;;</span>
<span class="nc" id="L809">        Utils.copy(&quot;wikiCode&quot;, data, getContext());</span>
<span class="nc" id="L810">        Timber.d(&quot;Generated wikidata copy code: %s&quot;, data);</span>

<span class="nc" id="L812">        Toast.makeText(getContext(), getString(R.string.wikicode_copied), Toast.LENGTH_SHORT)</span>
<span class="nc" id="L813">            .show();</span>
<span class="nc" id="L814">    }</span>

    /**
     * Sends thanks to author if the author is not the user
     */
    @OnClick(R.id.sendThanks)
    public void sendThanksToAuthor() {
<span class="nc" id="L821">        String fileName = media.getFilename();</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">        if (TextUtils.isEmpty(fileName)) {</span>
<span class="nc" id="L823">            Toast.makeText(getContext(), getString(R.string.error_sending_thanks),</span>
<span class="nc" id="L824">                Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L825">            return;</span>
        }
<span class="nc" id="L827">        compositeDisposable.add(reviewHelper.getFirstRevisionOfFile(fileName)</span>
<span class="nc" id="L828">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L829">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L830">            .subscribe(revision -&gt; sendThanks(getContext(), revision)));</span>
<span class="nc" id="L831">    }</span>

    /**
     * Api call for sending thanks to the author when the author is not the user
     * and display toast depending on the result
     * @param context context
     * @param firstRevision the revision id of the image
     */
    @SuppressLint({&quot;CheckResult&quot;, &quot;StringFormatInvalid&quot;})
    void sendThanks(Context context, MwQueryPage.Revision firstRevision) {
<span class="nc" id="L841">        ViewUtil.showShortToast(context,</span>
<span class="nc" id="L842">            context.getString(R.string.send_thank_toast, media.getDisplayTitle()));</span>

<span class="nc bnc" id="L844" title="All 2 branches missed.">        if (firstRevision == null) {</span>
<span class="nc" id="L845">            return;</span>
        }

<span class="nc" id="L848">        Observable.defer((Callable&lt;ObservableSource&lt;Boolean&gt;&gt;) () -&gt; thanksClient.thank(</span>
<span class="nc" id="L849">                firstRevision.getRevisionId()))</span>
<span class="nc" id="L850">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L851">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L852">            .subscribe((result) -&gt; {</span>
<span class="nc" id="L853">                displayThanksToast(context, result);</span>
<span class="nc" id="L854">            }, Timber::e);</span>
<span class="nc" id="L855">    }</span>

    /**
     * Method to display toast when api call to thank the author is completed
     * @param context context
     * @param result true if success, false otherwise
     */
    @SuppressLint(&quot;StringFormatInvalid&quot;)
    private void displayThanksToast(final Context context, final boolean result) {
        final String message;
        final String title;
<span class="nc bnc" id="L866" title="All 2 branches missed.">        if (result) {</span>
<span class="nc" id="L867">            title = context.getString(R.string.send_thank_success_title);</span>
<span class="nc" id="L868">            message = context.getString(R.string.send_thank_success_message,</span>
<span class="nc" id="L869">                media.getDisplayTitle());</span>
        } else {
<span class="nc" id="L871">            title = context.getString(R.string.send_thank_failure_title);</span>
<span class="nc" id="L872">            message = context.getString(R.string.send_thank_failure_message,</span>
<span class="nc" id="L873">                media.getDisplayTitle());</span>
        }

<span class="nc" id="L876">        ViewUtil.showShortToast(context, message);</span>
<span class="nc" id="L877">    }</span>

    @OnClick(R.id.categoryEditButton)
    public void onCategoryEditButtonClicked(){
<span class="nc" id="L881">        progressBarEditCategory.setVisibility(VISIBLE);</span>
<span class="nc" id="L882">        categoryEditButton.setVisibility(GONE);</span>
<span class="nc" id="L883">        getWikiText();</span>
<span class="nc" id="L884">    }</span>

    /**
     * Gets WikiText from the server and send it to catgory editor
     */
    private void getWikiText() {
<span class="nc" id="L890">        compositeDisposable.add(mediaDataExtractor.getCurrentWikiText(</span>
<span class="nc" id="L891">            Objects.requireNonNull(media.getFilename()))</span>
<span class="nc" id="L892">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L893">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L894">            .subscribe(this::gotoCategoryEditor, Timber::e));</span>
<span class="nc" id="L895">    }</span>

    /**
     * Opens the category editor
     *
     * @param s WikiText
     */
    private void gotoCategoryEditor(final String s) {
<span class="nc" id="L903">        categoryEditButton.setVisibility(VISIBLE);</span>
<span class="nc" id="L904">        progressBarEditCategory.setVisibility(GONE);</span>
<span class="nc" id="L905">        final Fragment categoriesFragment = new UploadCategoriesFragment();</span>
<span class="nc" id="L906">        final Bundle bundle = new Bundle();</span>
<span class="nc" id="L907">        bundle.putParcelable(&quot;Existing_Categories&quot;, media);</span>
<span class="nc" id="L908">        bundle.putString(&quot;WikiText&quot;, s);</span>
<span class="nc" id="L909">        categoriesFragment.setArguments(bundle);</span>
<span class="nc" id="L910">        final FragmentTransaction transaction = getChildFragmentManager().beginTransaction();</span>
<span class="nc" id="L911">        transaction.replace(R.id.mediaDetailFrameLayout, categoriesFragment);</span>
<span class="nc" id="L912">        transaction.addToBackStack(null);</span>
<span class="nc" id="L913">        transaction.commit();</span>
<span class="nc" id="L914">    }</span>

    @OnClick(R.id.coordinate_edit)
    public void onUpdateCoordinatesClicked(){
<span class="nc" id="L918">        goToLocationPickerActivity();</span>
<span class="nc" id="L919">    }</span>

    /**
     * Start location picker activity with a request code and get the coordinates from the activity.
     */
    private void goToLocationPickerActivity() {
        /*
        If location is not provided in media this coordinates will act as a placeholder in
        location picker activity
         */
<span class="nc" id="L929">        double defaultLatitude = 37.773972;</span>
<span class="nc" id="L930">        double defaultLongitude = -122.431297;</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">        if (media.getCoordinates() != null) {</span>
<span class="nc" id="L932">            defaultLatitude = media.getCoordinates().getLatitude();</span>
<span class="nc" id="L933">            defaultLongitude = media.getCoordinates().getLongitude();</span>
        } else {
<span class="nc bnc" id="L935" title="All 2 branches missed.">            if(locationManager.getLastLocation()!=null) {</span>
<span class="nc" id="L936">                defaultLatitude = locationManager.getLastLocation().getLatitude();</span>
<span class="nc" id="L937">                defaultLongitude = locationManager.getLastLocation().getLongitude();</span>
            } else {
<span class="nc" id="L939">                String[] lastLocation = applicationKvStore.getString(LAST_LOCATION,(defaultLatitude + &quot;,&quot; + defaultLongitude)).split(&quot;,&quot;);</span>
<span class="nc" id="L940">                defaultLatitude = Double.parseDouble(lastLocation[0]);</span>
<span class="nc" id="L941">                defaultLongitude = Double.parseDouble(lastLocation[1]);</span>
            }
        }

<span class="nc" id="L945">        startActivityForResult(new LocationPicker.IntentBuilder()</span>
<span class="nc" id="L946">            .defaultLocation(new CameraPosition.Builder()</span>
<span class="nc" id="L947">                .target(new LatLng(defaultLatitude, defaultLongitude))</span>
<span class="nc" id="L948">                .zoom(16).build())</span>
<span class="nc" id="L949">            .activityKey(&quot;MediaActivity&quot;)</span>
<span class="nc" id="L950">            .build(getActivity()), REQUEST_CODE);</span>
<span class="nc" id="L951">    }</span>

    @OnClick(R.id.description_edit)
    public void onDescriptionEditClicked() {
<span class="nc" id="L955">        progressBarEditDescription.setVisibility(VISIBLE);</span>
<span class="nc" id="L956">        editDescription.setVisibility(GONE);</span>
<span class="nc" id="L957">        getDescriptionList();</span>
<span class="nc" id="L958">    }</span>

    /**
     * Gets descriptions from wikitext
     */
    private void getDescriptionList() {
<span class="nc" id="L964">        compositeDisposable.add(mediaDataExtractor.getCurrentWikiText(</span>
<span class="nc" id="L965">            Objects.requireNonNull(media.getFilename()))</span>
<span class="nc" id="L966">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L967">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L968">            .subscribe(this::extractCaptionDescription, Timber::e));</span>
<span class="nc" id="L969">    }</span>

    /**
     * Gets captions and descriptions and merge them according to language code and arranges it in a
     * single list.
     * Send the list to DescriptionEditActivity
     * @param s wikitext
     */
    private void extractCaptionDescription(final String s) {
<span class="nc" id="L978">        final LinkedHashMap&lt;String,String&gt; descriptions = getDescriptions(s);</span>
<span class="nc" id="L979">        final LinkedHashMap&lt;String,String&gt; captions = getCaptionsList();</span>

<span class="nc" id="L981">        final ArrayList&lt;UploadMediaDetail&gt; descriptionAndCaptions = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L983" title="All 2 branches missed.">        if(captions.size() &gt;= descriptions.size()) {</span>
<span class="nc bnc" id="L984" title="All 2 branches missed.">            for (final Map.Entry mapElement : captions.entrySet()) {</span>

<span class="nc" id="L986">                final String language = (String) mapElement.getKey();</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">                if (descriptions.containsKey(language)) {</span>
<span class="nc" id="L988">                    descriptionAndCaptions.add(</span>
                        new UploadMediaDetail(language,
<span class="nc" id="L990">                            Objects.requireNonNull(descriptions.get(language)),</span>
<span class="nc" id="L991">                            (String) mapElement.getValue())</span>
                    );
                } else {
<span class="nc" id="L994">                    descriptionAndCaptions.add(</span>
                        new UploadMediaDetail(language, &quot;&quot;,
<span class="nc" id="L996">                            (String) mapElement.getValue())</span>
                    );
                }
<span class="nc" id="L999">            }</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">            for (final Map.Entry mapElement : descriptions.entrySet()) {</span>

<span class="nc" id="L1002">                final String language = (String) mapElement.getKey();</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">                if (!captions.containsKey(language)) {</span>
<span class="nc" id="L1004">                    descriptionAndCaptions.add(</span>
                        new UploadMediaDetail(language,
<span class="nc" id="L1006">                            Objects.requireNonNull(descriptions.get(language)),</span>
                            &quot;&quot;)
                    );
                }
<span class="nc" id="L1010">            }</span>
        } else {
<span class="nc bnc" id="L1012" title="All 2 branches missed.">            for (final Map.Entry mapElement : descriptions.entrySet()) {</span>

<span class="nc" id="L1014">                final String language = (String) mapElement.getKey();</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">                if (captions.containsKey(language)) {</span>
<span class="nc" id="L1016">                    descriptionAndCaptions.add(</span>
<span class="nc" id="L1017">                        new UploadMediaDetail(language, (String) mapElement.getValue(),</span>
<span class="nc" id="L1018">                            Objects.requireNonNull(captions.get(language)))</span>
                    );
                } else {
<span class="nc" id="L1021">                    descriptionAndCaptions.add(</span>
<span class="nc" id="L1022">                        new UploadMediaDetail(language, (String) mapElement.getValue(),</span>
                            &quot;&quot;)
                    );
                }
<span class="nc" id="L1026">            }</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">            for (final Map.Entry mapElement : captions.entrySet()) {</span>

<span class="nc" id="L1029">                final String language = (String) mapElement.getKey();</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">                if (!descriptions.containsKey(language)) {</span>
<span class="nc" id="L1031">                    descriptionAndCaptions.add(</span>
                        new UploadMediaDetail(language,
                            &quot;&quot;,
<span class="nc" id="L1034">                            Objects.requireNonNull(descriptions.get(language)))</span>
                    );
                }
<span class="nc" id="L1037">            }</span>
        }
<span class="nc" id="L1039">        final Intent intent = new Intent(requireContext(), DescriptionEditActivity.class);</span>
<span class="nc" id="L1040">        final Bundle bundle = new Bundle();</span>
<span class="nc" id="L1041">        bundle.putParcelableArrayList(LIST_OF_DESCRIPTION_AND_CAPTION, descriptionAndCaptions);</span>
<span class="nc" id="L1042">        bundle.putString(WIKITEXT, s);</span>
<span class="nc" id="L1043">        bundle.putString(Prefs.DESCRIPTION_LANGUAGE, applicationKvStore.getString(Prefs.DESCRIPTION_LANGUAGE, &quot;&quot;));</span>
<span class="nc" id="L1044">        intent.putExtras(bundle);</span>
<span class="nc" id="L1045">        startActivityForResult(intent, REQUEST_CODE_EDIT_DESCRIPTION);</span>
<span class="nc" id="L1046">    }</span>

    /**
     * Filters descriptions from current wikiText and arranges it in LinkedHashmap according to the
     * language code
     * @param s wikitext
     * @return LinkedHashMap&lt;LanguageCode,Description&gt;
     */
    private LinkedHashMap&lt;String,String&gt; getDescriptions(String s) {
<span class="nc" id="L1055">        final Pattern pattern = Pattern.compile(&quot;[dD]escription *=(.*?)\n *\\|&quot;, Pattern.DOTALL);</span>
<span class="nc" id="L1056">        final Matcher matcher = pattern.matcher(s);</span>
<span class="nc" id="L1057">        String description = null;</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">        if (matcher.find()) {</span>
<span class="nc" id="L1059">            description = matcher.group();</span>
        }
<span class="nc bnc" id="L1061" title="All 2 branches missed.">        if(description == null){</span>
<span class="nc" id="L1062">            return new LinkedHashMap&lt;&gt;();</span>
        }

<span class="nc" id="L1065">        final LinkedHashMap&lt;String,String&gt; descriptionList = new LinkedHashMap&lt;&gt;();</span>

<span class="nc" id="L1067">        int count = 0; // number of &quot;{{&quot;</span>
<span class="nc" id="L1068">        int startCode = 0;</span>
<span class="nc" id="L1069">        int endCode = 0;</span>
<span class="nc" id="L1070">        int startDescription = 0;</span>
<span class="nc" id="L1071">        int endDescription = 0;</span>
<span class="nc" id="L1072">        final HashSet&lt;String&gt; allLanguageCodes = new HashSet&lt;&gt;(Arrays.asList(&quot;en&quot;,&quot;es&quot;,&quot;de&quot;,&quot;ja&quot;,&quot;fr&quot;,&quot;ru&quot;,&quot;pt&quot;,&quot;it&quot;,&quot;zh-hans&quot;,&quot;zh-hant&quot;,&quot;ar&quot;,&quot;ko&quot;,&quot;id&quot;,&quot;pl&quot;,&quot;nl&quot;,&quot;fa&quot;,&quot;hi&quot;,&quot;th&quot;,&quot;vi&quot;,&quot;sv&quot;,&quot;uk&quot;,&quot;cs&quot;,&quot;simple&quot;,&quot;hu&quot;,&quot;ro&quot;,&quot;fi&quot;,&quot;el&quot;,&quot;he&quot;,&quot;nb&quot;,&quot;da&quot;,&quot;sr&quot;,&quot;hr&quot;,&quot;ms&quot;,&quot;bg&quot;,&quot;ca&quot;,&quot;tr&quot;,&quot;sk&quot;,&quot;sh&quot;,&quot;bn&quot;,&quot;tl&quot;,&quot;mr&quot;,&quot;ta&quot;,&quot;kk&quot;,&quot;lt&quot;,&quot;az&quot;,&quot;bs&quot;,&quot;sl&quot;,&quot;sq&quot;,&quot;arz&quot;,&quot;zh-yue&quot;,&quot;ka&quot;,&quot;te&quot;,&quot;et&quot;,&quot;lv&quot;,&quot;ml&quot;,&quot;hy&quot;,&quot;uz&quot;,&quot;kn&quot;,&quot;af&quot;,&quot;nn&quot;,&quot;mk&quot;,&quot;gl&quot;,&quot;sw&quot;,&quot;eu&quot;,&quot;ur&quot;,&quot;ky&quot;,&quot;gu&quot;,&quot;bh&quot;,&quot;sco&quot;,&quot;ast&quot;,&quot;is&quot;,&quot;mn&quot;,&quot;be&quot;,&quot;an&quot;,&quot;km&quot;,&quot;si&quot;,&quot;ceb&quot;,&quot;jv&quot;,&quot;eo&quot;,&quot;als&quot;,&quot;ig&quot;,&quot;su&quot;,&quot;be-x-old&quot;,&quot;la&quot;,&quot;my&quot;,&quot;cy&quot;,&quot;ne&quot;,&quot;bar&quot;,&quot;azb&quot;,&quot;mzn&quot;,&quot;as&quot;,&quot;am&quot;,&quot;so&quot;,&quot;pa&quot;,&quot;map-bms&quot;,&quot;scn&quot;,&quot;tg&quot;,&quot;ckb&quot;,&quot;ga&quot;,&quot;lb&quot;,&quot;war&quot;,&quot;zh-min-nan&quot;,&quot;nds&quot;,&quot;fy&quot;,&quot;vec&quot;,&quot;pnb&quot;,&quot;zh-classical&quot;,&quot;lmo&quot;,&quot;tt&quot;,&quot;io&quot;,&quot;ia&quot;,&quot;br&quot;,&quot;hif&quot;,&quot;mg&quot;,&quot;wuu&quot;,&quot;gan&quot;,&quot;ang&quot;,&quot;or&quot;,&quot;oc&quot;,&quot;yi&quot;,&quot;ps&quot;,&quot;tk&quot;,&quot;ba&quot;,&quot;sah&quot;,&quot;fo&quot;,&quot;nap&quot;,&quot;vls&quot;,&quot;sa&quot;,&quot;ce&quot;,&quot;qu&quot;,&quot;ku&quot;,&quot;min&quot;,&quot;bcl&quot;,&quot;ilo&quot;,&quot;ht&quot;,&quot;li&quot;,&quot;wa&quot;,&quot;vo&quot;,&quot;nds-nl&quot;,&quot;pam&quot;,&quot;new&quot;,&quot;mai&quot;,&quot;sn&quot;,&quot;pms&quot;,&quot;eml&quot;,&quot;yo&quot;,&quot;ha&quot;,&quot;gn&quot;,&quot;frr&quot;,&quot;gd&quot;,&quot;hsb&quot;,&quot;cv&quot;,&quot;lo&quot;,&quot;os&quot;,&quot;se&quot;,&quot;cdo&quot;,&quot;sd&quot;,&quot;ksh&quot;,&quot;bat-smg&quot;,&quot;bo&quot;,&quot;nah&quot;,&quot;xmf&quot;,&quot;ace&quot;,&quot;roa-tara&quot;,&quot;hak&quot;,&quot;bjn&quot;,&quot;gv&quot;,&quot;mt&quot;,&quot;pfl&quot;,&quot;szl&quot;,&quot;bpy&quot;,&quot;rue&quot;,&quot;co&quot;,&quot;diq&quot;,&quot;sc&quot;,&quot;rw&quot;,&quot;vep&quot;,&quot;lij&quot;,&quot;kw&quot;,&quot;fur&quot;,&quot;pcd&quot;,&quot;lad&quot;,&quot;tpi&quot;,&quot;ext&quot;,&quot;csb&quot;,&quot;rm&quot;,&quot;kab&quot;,&quot;gom&quot;,&quot;udm&quot;,&quot;mhr&quot;,&quot;glk&quot;,&quot;za&quot;,&quot;pdc&quot;,&quot;om&quot;,&quot;iu&quot;,&quot;nv&quot;,&quot;mi&quot;,&quot;nrm&quot;,&quot;tcy&quot;,&quot;frp&quot;,&quot;myv&quot;,&quot;kbp&quot;,&quot;dsb&quot;,&quot;zu&quot;,&quot;ln&quot;,&quot;mwl&quot;,&quot;fiu-vro&quot;,&quot;tum&quot;,&quot;tet&quot;,&quot;tn&quot;,&quot;pnt&quot;,&quot;stq&quot;,&quot;nov&quot;,&quot;ny&quot;,&quot;xh&quot;,&quot;crh&quot;,&quot;lfn&quot;,&quot;st&quot;,&quot;pap&quot;,&quot;ay&quot;,&quot;zea&quot;,&quot;bxr&quot;,&quot;kl&quot;,&quot;sm&quot;,&quot;ak&quot;,&quot;ve&quot;,&quot;pag&quot;,&quot;nso&quot;,&quot;kaa&quot;,&quot;lez&quot;,&quot;gag&quot;,&quot;kv&quot;,&quot;bm&quot;,&quot;to&quot;,&quot;lbe&quot;,&quot;krc&quot;,&quot;jam&quot;,&quot;ss&quot;,&quot;roa-rup&quot;,&quot;dv&quot;,&quot;ie&quot;,&quot;av&quot;,&quot;cbk-zam&quot;,&quot;chy&quot;,&quot;inh&quot;,&quot;ug&quot;,&quot;ch&quot;,&quot;arc&quot;,&quot;pih&quot;,&quot;mrj&quot;,&quot;kg&quot;,&quot;rmy&quot;,&quot;dty&quot;,&quot;na&quot;,&quot;ts&quot;,&quot;xal&quot;,&quot;wo&quot;,&quot;fj&quot;,&quot;tyv&quot;,&quot;olo&quot;,&quot;ltg&quot;,&quot;ff&quot;,&quot;jbo&quot;,&quot;haw&quot;,&quot;ki&quot;,&quot;chr&quot;,&quot;sg&quot;,&quot;atj&quot;,&quot;sat&quot;,&quot;ady&quot;,&quot;ty&quot;,&quot;lrc&quot;,&quot;ti&quot;,&quot;din&quot;,&quot;gor&quot;,&quot;lg&quot;,&quot;rn&quot;,&quot;bi&quot;,&quot;cu&quot;,&quot;kbd&quot;,&quot;pi&quot;,&quot;cr&quot;,&quot;koi&quot;,&quot;ik&quot;,&quot;mdf&quot;,&quot;bug&quot;,&quot;ee&quot;,&quot;shn&quot;,&quot;tw&quot;,&quot;dz&quot;,&quot;srn&quot;,&quot;ks&quot;,&quot;test&quot;,&quot;en-x-piglatin&quot;,&quot;ab&quot;));</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">        for (int i = 0; i &lt; description.length() - 1; i++) {</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            if (description.startsWith(&quot;{{&quot;, i)) {</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                if (count == 0) {</span>
<span class="nc" id="L1076">                    startCode = i;</span>
<span class="nc" id="L1077">                    endCode = description.indexOf(&quot;|&quot;, i);</span>
<span class="nc" id="L1078">                    startDescription = endCode + 1;</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">                    if (description.startsWith(&quot;1=&quot;, endCode + 1)) {</span>
<span class="nc" id="L1080">                        startDescription += 2;</span>
<span class="nc" id="L1081">                        i += 2;</span>
                    }
                }
<span class="nc" id="L1084">                i++;</span>
<span class="nc" id="L1085">                count++;</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">            } else if (description.startsWith(&quot;}}&quot;, i)) {</span>
<span class="nc" id="L1087">                count--;</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">                if (count == 0) {</span>
<span class="nc" id="L1089">                    endDescription = i;</span>
<span class="nc" id="L1090">                    final String languageCode = description.substring(startCode + 2, endCode);</span>
<span class="nc" id="L1091">                    final String languageDescription = description.substring(startDescription, endDescription);</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">                    if (allLanguageCodes.contains(languageCode)) {</span>
<span class="nc" id="L1093">                        descriptionList.put(languageCode, languageDescription);</span>
                    }
                }
<span class="nc" id="L1096">                i++;</span>
            }
        }
<span class="nc" id="L1099">        return descriptionList;</span>
    }

    /**
     * Gets list of caption and arranges it in a LinkedHashmap according to the language code
     * @return LinkedHashMap&lt;LanguageCode,Caption&gt;
     */
    private LinkedHashMap&lt;String,String&gt; getCaptionsList() {
<span class="nc" id="L1107">        final LinkedHashMap&lt;String, String&gt; captionList = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L1108">        final Map&lt;String, String&gt; captions = media.getCaptions();</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">        for (final Map.Entry&lt;String, String&gt; map : captions.entrySet()) {</span>
<span class="nc" id="L1110">            final String language = map.getKey();</span>
<span class="nc" id="L1111">            final String languageCaption = map.getValue();</span>
<span class="nc" id="L1112">            captionList.put(language, languageCaption);</span>
<span class="nc" id="L1113">        }</span>
<span class="nc" id="L1114">        return captionList;</span>
    }

    /**
     * Get the result from another activity and act accordingly.
     * @param requestCode
     * @param resultCode
     * @param data
     */
    @Override
    public void onActivityResult(final int requestCode, final int resultCode,
        @Nullable final Intent data) {
<span class="nc" id="L1126">        super.onActivityResult(requestCode, resultCode, data);</span>

<span class="nc bnc" id="L1128" title="All 4 branches missed.">        if (requestCode == REQUEST_CODE &amp;&amp; resultCode == RESULT_OK) {</span>

<span class="nc bnc" id="L1130" title="All 2 branches missed.">            assert data != null;</span>
<span class="nc" id="L1131">            final CameraPosition cameraPosition = LocationPicker.getCameraPosition(data);</span>

<span class="nc bnc" id="L1133" title="All 2 branches missed.">            if (cameraPosition != null) {</span>

<span class="nc" id="L1135">                final String latitude = String.valueOf(cameraPosition.target.getLatitude());</span>
<span class="nc" id="L1136">                final String longitude = String.valueOf(cameraPosition.target.getLongitude());</span>
<span class="nc" id="L1137">                final String accuracy = String.valueOf(cameraPosition.target.getAltitude());</span>
<span class="nc" id="L1138">                String currentLatitude = null;</span>
<span class="nc" id="L1139">                String currentLongitude = null;</span>

<span class="nc bnc" id="L1141" title="All 2 branches missed.">                if (media.getCoordinates() != null) {</span>
<span class="nc" id="L1142">                    currentLatitude = String.valueOf(media.getCoordinates().getLatitude());</span>
<span class="nc" id="L1143">                    currentLongitude = String.valueOf(media.getCoordinates().getLongitude());</span>
                }

<span class="nc bnc" id="L1146" title="All 4 branches missed.">                if (!latitude.equals(currentLatitude) || !longitude.equals(currentLongitude)) {</span>
<span class="nc" id="L1147">                    updateCoordinates(latitude, longitude, accuracy);</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">                } else if (media.getCoordinates() == null) {</span>
<span class="nc" id="L1149">                    updateCoordinates(latitude, longitude, accuracy);</span>
                }
            }

<span class="nc bnc" id="L1153" title="All 4 branches missed.">        } else if (requestCode == REQUEST_CODE_EDIT_DESCRIPTION &amp;&amp; resultCode == RESULT_OK) {</span>
<span class="nc" id="L1154">            final String updatedWikiText = data.getStringExtra(UPDATED_WIKITEXT);</span>
<span class="nc" id="L1155">            compositeDisposable.add(descriptionEditHelper.addDescription(getContext(), media,</span>
                updatedWikiText)
<span class="nc" id="L1157">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L1158">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1159">                .subscribe(s -&gt; {</span>
<span class="nc" id="L1160">                    Timber.d(&quot;Descriptions are added.&quot;);</span>
<span class="nc" id="L1161">                }));</span>

<span class="nc" id="L1163">            final ArrayList&lt;UploadMediaDetail&gt; uploadMediaDetails</span>
<span class="nc" id="L1164">                = data.getParcelableArrayListExtra(LIST_OF_DESCRIPTION_AND_CAPTION);</span>

<span class="nc" id="L1166">            LinkedHashMap&lt;String, String&gt; updatedCaptions = new LinkedHashMap&lt;&gt;();</span>
            for (UploadMediaDetail mediaDetail:
<span class="nc bnc" id="L1168" title="All 2 branches missed.">            uploadMediaDetails) {</span>
<span class="nc" id="L1169">                compositeDisposable.add(descriptionEditHelper.addCaption(getContext(), media,</span>
<span class="nc" id="L1170">                    mediaDetail.getLanguageCode(), mediaDetail.getCaptionText())</span>
<span class="nc" id="L1171">                    .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L1172">                    .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1173">                    .subscribe(s -&gt; {</span>
<span class="nc" id="L1174">                        updateCaptions(mediaDetail, updatedCaptions);</span>
<span class="nc" id="L1175">                        Timber.d(&quot;Caption is added.&quot;);</span>
<span class="nc" id="L1176">                    }));</span>
<span class="nc" id="L1177">            }</span>
<span class="nc" id="L1178">            progressBarEditDescription.setVisibility(GONE);</span>
<span class="nc" id="L1179">            editDescription.setVisibility(VISIBLE);</span>

<span class="nc bnc" id="L1181" title="All 4 branches missed.">        } else if (requestCode == REQUEST_CODE &amp;&amp; resultCode == RESULT_CANCELED) {</span>
<span class="nc" id="L1182">            viewUtil.showShortToast(getContext(),</span>
<span class="nc" id="L1183">                requireContext()</span>
<span class="nc" id="L1184">                    .getString(R.string.coordinates_picking_unsuccessful));</span>

<span class="nc bnc" id="L1186" title="All 4 branches missed.">        } else if (requestCode == REQUEST_CODE_EDIT_DESCRIPTION &amp;&amp; resultCode == RESULT_CANCELED) {</span>
<span class="nc" id="L1187">            progressBarEditDescription.setVisibility(GONE);</span>
<span class="nc" id="L1188">            editDescription.setVisibility(VISIBLE);</span>
        }
<span class="nc" id="L1190">    }</span>

    /**
     * Adds caption to the map and updates captions
     * @param mediaDetail UploadMediaDetail
     * @param updatedCaptions updated captionds
     */
    private void updateCaptions(UploadMediaDetail mediaDetail,
        LinkedHashMap&lt;String, String&gt; updatedCaptions) {
<span class="nc" id="L1199">        updatedCaptions.put(mediaDetail.getLanguageCode(), mediaDetail.getCaptionText());</span>
<span class="nc" id="L1200">        media.setCaptions(updatedCaptions);</span>
<span class="nc" id="L1201">    }</span>

    /**
     * Fetched coordinates are replaced with existing coordinates by a POST API call.
     * @param Latitude to be added
     * @param Longitude to be added
     * @param Accuracy to be added
     */
    public void updateCoordinates(final String Latitude, final String Longitude,
        final String Accuracy) {
<span class="nc" id="L1211">        compositeDisposable.add(coordinateEditHelper.makeCoordinatesEdit(getContext(), media,</span>
            Latitude, Longitude, Accuracy)
<span class="nc" id="L1213">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L1214">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1215">            .subscribe(s -&gt; {</span>
<span class="nc" id="L1216">                Timber.d(&quot;Coordinates are added.&quot;);</span>
<span class="nc" id="L1217">                coordinates.setText(prettyCoordinates(media));</span>
<span class="nc" id="L1218">            }));</span>
<span class="nc" id="L1219">    }</span>

    @SuppressLint(&quot;StringFormatInvalid&quot;)
    @OnClick(R.id.nominateDeletion)
    public void onDeleteButtonClicked(){
<span class="nc bnc" id="L1224" title="All 4 branches missed.">            if (AccountUtil.getUserName(getContext()) != null &amp;&amp; AccountUtil.getUserName(getContext()).equals(media.getAuthor())) {</span>
<span class="nc" id="L1225">                final ArrayAdapter&lt;String&gt; languageAdapter = new ArrayAdapter&lt;&gt;(getActivity(),</span>
                    R.layout.simple_spinner_dropdown_list, reasonList);
<span class="nc" id="L1227">                final Spinner spinner = new Spinner(getActivity());</span>
<span class="nc" id="L1228">                spinner.setLayoutParams(</span>
                    new LinearLayout.LayoutParams(LinearLayout.LayoutParams.WRAP_CONTENT,
                        LinearLayout.LayoutParams.WRAP_CONTENT));
<span class="nc" id="L1231">                spinner.setAdapter(languageAdapter);</span>
<span class="nc" id="L1232">                spinner.setGravity(17);</span>

<span class="nc" id="L1234">                AlertDialog dialog = DialogUtil.showAlertDialog(getActivity(),</span>
<span class="nc" id="L1235">                    getString(R.string.nominate_delete),</span>
                    null,
<span class="nc" id="L1237">                    getString(R.string.about_translate_proceed),</span>
<span class="nc" id="L1238">                    getString(R.string.about_translate_cancel),</span>
<span class="nc" id="L1239">                    () -&gt; onDeleteClicked(spinner),</span>
<span class="nc" id="L1240">                    () -&gt; {},</span>
                    spinner,
                    true);
<span class="nc bnc" id="L1243" title="All 2 branches missed.">                if (isDeleted) {</span>
<span class="nc" id="L1244">                    dialog.getButton(AlertDialog.BUTTON_POSITIVE).setEnabled(false);</span>
                }
<span class="nc" id="L1246">            }</span>
            //Reviewer correct me if i have misunderstood something over here
            //But how does this  if (delete.getVisibility() == View.VISIBLE) {
            //            enableDeleteButton(true);   makes sense ?
            else {
<span class="nc" id="L1251">                final EditText input = new EditText(getActivity());</span>
<span class="nc" id="L1252">                input.requestFocus();</span>
<span class="nc" id="L1253">                AlertDialog d = DialogUtil.showAlertDialog(getActivity(),</span>
                    null,
<span class="nc" id="L1255">                    getString(R.string.dialog_box_text_nomination, media.getDisplayTitle()),</span>
<span class="nc" id="L1256">                    getString(R.string.ok),</span>
<span class="nc" id="L1257">                    getString(R.string.cancel),</span>
                    () -&gt; {
<span class="nc" id="L1259">                        String reason = input.getText().toString();</span>
<span class="nc" id="L1260">                        onDeleteClickeddialogtext(reason);</span>
<span class="nc" id="L1261">                    },</span>
<span class="nc" id="L1262">                    () -&gt; {},</span>
                    input,
                    true);
<span class="nc" id="L1265">                input.addTextChangedListener(new TextWatcher() {</span>
                    private void handleText() {
<span class="nc" id="L1267">                        final Button okButton = d.getButton(AlertDialog.BUTTON_POSITIVE);</span>
<span class="nc bnc" id="L1268" title="All 4 branches missed.">                        if (input.getText().length() == 0 || isDeleted) {</span>
<span class="nc" id="L1269">                            okButton.setEnabled(false);</span>
                        } else {
<span class="nc" id="L1271">                            okButton.setEnabled(true);</span>
                        }
<span class="nc" id="L1273">                    }</span>

                    @Override
                    public void afterTextChanged(Editable arg0) {
<span class="nc" id="L1277">                        handleText();</span>
<span class="nc" id="L1278">                    }</span>

                    @Override
                    public void beforeTextChanged(CharSequence s, int start, int count, int after) {
<span class="nc" id="L1282">                    }</span>

                    @Override
                    public void onTextChanged(CharSequence s, int start, int before, int count) {
<span class="nc" id="L1286">                    }</span>
                });
<span class="nc" id="L1288">                d.getButton(AlertDialog.BUTTON_POSITIVE).setEnabled(false);</span>
            }
<span class="nc" id="L1290">        }</span>

    @SuppressLint(&quot;CheckResult&quot;)
    private void onDeleteClicked(Spinner spinner) {
<span class="nc" id="L1294">        applicationKvStore.putBoolean(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()), true);</span>
<span class="nc" id="L1295">        enableProgressBar();</span>
<span class="nc" id="L1296">        String reason = reasonListEnglishMappings.get(spinner.getSelectedItemPosition());</span>
<span class="nc" id="L1297">        String finalReason = reason;</span>
<span class="nc" id="L1298">        Single&lt;Boolean&gt; resultSingle = reasonBuilder.getReason(media, reason)</span>
<span class="nc" id="L1299">                .flatMap(reasonString -&gt; deleteHelper.makeDeletion(getContext(), media, finalReason));</span>
<span class="nc" id="L1300">        resultSingle</span>
<span class="nc" id="L1301">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L1302">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1303">            .subscribe(s -&gt; {</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">                if(applicationKvStore.getBoolean(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()), false)) {</span>
<span class="nc" id="L1305">                    applicationKvStore.remove(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()));</span>
<span class="nc" id="L1306">                    callback.nominatingForDeletion(index);</span>
                }
<span class="nc" id="L1308">            });</span>
<span class="nc" id="L1309">    }</span>

    @SuppressLint(&quot;CheckResult&quot;)
    private void onDeleteClickeddialogtext(String reason) {
<span class="nc" id="L1313">        applicationKvStore.putBoolean(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()), true);</span>
<span class="nc" id="L1314">        enableProgressBar();</span>
<span class="nc" id="L1315">        Single&lt;Boolean&gt; resultSingletext = reasonBuilder.getReason(media, reason)</span>
<span class="nc" id="L1316">                .flatMap(reasonString -&gt; deleteHelper.makeDeletion(getContext(), media, reason));</span>
<span class="nc" id="L1317">        resultSingletext</span>
<span class="nc" id="L1318">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L1319">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1320">            .subscribe(s -&gt; {</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">                if(applicationKvStore.getBoolean(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()), false)) {</span>
<span class="nc" id="L1322">                    applicationKvStore.remove(String.format(NOMINATING_FOR_DELETION_MEDIA, media.getImageUrl()));</span>
<span class="nc" id="L1323">                    callback.nominatingForDeletion(index);</span>
                }
<span class="nc" id="L1325">            });</span>
<span class="nc" id="L1326">    }</span>

    @OnClick(R.id.seeMore)
    public void onSeeMoreClicked(){
<span class="nc bnc" id="L1330" title="All 4 branches missed.">        if (nominatedForDeletion.getVisibility() == VISIBLE &amp;&amp; getActivity() != null) {</span>
<span class="nc" id="L1331">            Utils.handleWebUrl(getActivity(), Uri.parse(media.getPageTitle().getMobileUri()));</span>
        }
<span class="nc" id="L1333">    }</span>

    @OnClick(R.id.mediaDetailAuthor)
    public void onAuthorViewClicked() {
<span class="nc bnc" id="L1337" title="All 4 branches missed.">        if (media == null || media.getUser() == null) {</span>
<span class="nc" id="L1338">            return;</span>
        }
<span class="nc bnc" id="L1340" title="All 2 branches missed.">        if (sessionManager.getUserName() == null) {</span>
<span class="nc" id="L1341">            String userProfileLink = BuildConfig.COMMONS_URL + &quot;/wiki/User:&quot; + media.getUser();</span>
<span class="nc" id="L1342">            Intent browserIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(userProfileLink));</span>
<span class="nc" id="L1343">            startActivity(browserIntent);</span>
<span class="nc" id="L1344">            return;</span>
        }
<span class="nc" id="L1346">        ProfileActivity.startYourself(getActivity(), media.getUser(), !Objects</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">            .equals(sessionManager.getUserName(), media.getUser()));</span>
<span class="nc" id="L1348">    }</span>

    /**
     * Enable Progress Bar and Update delete button text.
     */
    private void enableProgressBar() {
<span class="nc" id="L1354">        progressBarDeletion.setVisibility(VISIBLE);</span>
<span class="nc" id="L1355">        delete.setText(&quot;Nominating for Deletion&quot;);</span>
<span class="nc" id="L1356">        isDeleted = true;</span>
<span class="nc" id="L1357">    }</span>

    private void rebuildCatList(List&lt;String&gt; categories) {
<span class="nc" id="L1360">        categoryContainer.removeAllViews();</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">        for (String category : categories) {</span>
<span class="nc" id="L1362">            categoryContainer.addView(buildCatLabel(sanitise(category), categoryContainer));</span>
<span class="nc" id="L1363">        }</span>
<span class="nc" id="L1364">    }</span>

    //As per issue #1826(see https://github.com/commons-app/apps-android-commons/issues/1826), some categories come suffixed with strings prefixed with |. As per the discussion
    //that was meant for alphabetical sorting of the categories and can be safely removed.
    private String sanitise(String category) {
<span class="nc" id="L1369">        int indexOfPipe = category.indexOf('|');</span>
<span class="nc bnc" id="L1370" title="All 2 branches missed.">        if (indexOfPipe != -1) {</span>
            //Removed everything after '|'
<span class="nc" id="L1372">            return category.substring(0, indexOfPipe);</span>
        }
<span class="nc" id="L1374">        return category;</span>
    }

    /**
     * Add view to depictions obtained also tapping on depictions should open the url
     */
    private View buildDepictLabel(String depictionName, String entityId, LinearLayout depictionContainer) {
<span class="nc" id="L1381">        final View item = LayoutInflater.from(getContext()).inflate(R.layout.detail_category_item, depictionContainer,false);</span>
<span class="nc" id="L1382">        final TextView textView = item.findViewById(R.id.mediaDetailCategoryItemText);</span>
<span class="nc" id="L1383">        textView.setText(depictionName);</span>
<span class="nc" id="L1384">        item.setOnClickListener(view -&gt; {</span>
<span class="nc" id="L1385">            Intent intent = new Intent(getContext(), WikidataItemDetailsActivity.class);</span>
<span class="nc" id="L1386">            intent.putExtra(&quot;wikidataItemName&quot;, depictionName);</span>
<span class="nc" id="L1387">            intent.putExtra(&quot;entityId&quot;, entityId);</span>
<span class="nc" id="L1388">            intent.putExtra(&quot;fragment&quot;, &quot;MediaDetailFragment&quot;);</span>
<span class="nc" id="L1389">            getContext().startActivity(intent);</span>
<span class="nc" id="L1390">        });</span>
<span class="nc" id="L1391">        return item;</span>
    }

    private View buildCatLabel(final String catName, ViewGroup categoryContainer) {
<span class="nc" id="L1395">        final View item = LayoutInflater.from(getContext()).inflate(R.layout.detail_category_item, categoryContainer, false);</span>
<span class="nc" id="L1396">        final TextView textView = item.findViewById(R.id.mediaDetailCategoryItemText);</span>

<span class="nc" id="L1398">        textView.setText(catName);</span>
<span class="nc bnc" id="L1399" title="All 2 branches missed.">        if(!getString(R.string.detail_panel_cats_none).equals(catName)) {</span>
<span class="nc" id="L1400">            textView.setOnClickListener(view -&gt; {</span>
                // Open Category Details page
<span class="nc" id="L1402">                Intent intent = new Intent(getContext(), CategoryDetailsActivity.class);</span>
<span class="nc" id="L1403">                intent.putExtra(&quot;categoryName&quot;, catName);</span>
<span class="nc" id="L1404">                getContext().startActivity(intent);</span>
<span class="nc" id="L1405">            });</span>
        }
<span class="nc" id="L1407">        return item;</span>
    }

    /**
    * Returns captions for media details
     *
     * @param media object of class media
     * @return caption as string
     */
    private String prettyCaption(Media media) {
<span class="nc bnc" id="L1417" title="All 2 branches missed.">        for (String caption : media.getCaptions().values()) {</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">            if (caption.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1419">                return getString(R.string.detail_caption_empty);</span>
            } else {
<span class="nc" id="L1421">                return caption;</span>
            }
        }
<span class="nc" id="L1424">        return getString(R.string.detail_caption_empty);</span>
    }

    private String prettyDescription(Media media) {
<span class="nc" id="L1428">        final String description = chooseDescription(media);</span>
<span class="nc bnc" id="L1429" title="All 2 branches missed.">        return description.isEmpty() ? getString(R.string.detail_description_empty)</span>
<span class="nc" id="L1430">            : description;</span>
    }

    private String chooseDescription(Media media) {
<span class="nc" id="L1434">        final Map&lt;String, String&gt; descriptions = media.getDescriptions();</span>
<span class="nc" id="L1435">        final String multilingualDesc = descriptions.get(Locale.getDefault().getLanguage());</span>
<span class="nc bnc" id="L1436" title="All 2 branches missed.">        if (multilingualDesc != null) {</span>
<span class="nc" id="L1437">            return multilingualDesc;</span>
        }
<span class="nc bnc" id="L1439" title="All 2 branches missed.">        for (String description : descriptions.values()) {</span>
<span class="nc" id="L1440">            return description;</span>
        }
<span class="nc" id="L1442">        return media.getFallbackDescription();</span>
    }

    private String prettyDiscussion(String discussion) {
<span class="nc bnc" id="L1446" title="All 2 branches missed.">        return discussion.isEmpty() ? getString(R.string.detail_discussion_empty) : discussion;</span>
    }

    private String prettyLicense(Media media) {
<span class="nc" id="L1450">        String licenseKey = media.getLicense();</span>
<span class="nc" id="L1451">        Timber.d(&quot;Media license is: %s&quot;, licenseKey);</span>
<span class="nc bnc" id="L1452" title="All 4 branches missed.">        if (licenseKey == null || licenseKey.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1453">            return getString(R.string.detail_license_empty);</span>
        }
<span class="nc" id="L1455">        return licenseKey;</span>
    }

    private String prettyUploadedDate(Media media) {
<span class="nc" id="L1459">        Date date = media.getDateUploaded();</span>
<span class="nc bnc" id="L1460" title="All 6 branches missed.">        if (date == null || date.toString() == null || date.toString().isEmpty()) {</span>
<span class="nc" id="L1461">            return &quot;Uploaded date not available&quot;;</span>
        }
<span class="nc" id="L1463">        return DateUtil.getDateStringWithSkeletonPattern(date, &quot;dd MMM yyyy&quot;);</span>
    }

    /**
     * Returns the coordinates nicely formatted.
     *
     * @return Coordinates as text.
     */
    private String prettyCoordinates(Media media) {
<span class="nc bnc" id="L1472" title="All 2 branches missed.">        if (media.getCoordinates() == null) {</span>
<span class="nc" id="L1473">            return getString(R.string.media_detail_coordinates_empty);</span>
        }
<span class="nc" id="L1475">        return media.getCoordinates().getPrettyCoordinateString();</span>
    }

    @Override
    public boolean updateCategoryDisplay(List&lt;String&gt; categories) {
<span class="nc bnc" id="L1480" title="All 2 branches missed.">        if (categories == null) {</span>
<span class="nc" id="L1481">            return false;</span>
        } else {
<span class="nc" id="L1483">            rebuildCatList(categories);</span>
<span class="nc" id="L1484">            return true;</span>
        }
    }

    @OnClick(R.id.show_caption_description_textview)
    void showCaptionAndDescription() {
<span class="nc bnc" id="L1490" title="All 2 branches missed.">        if (showCaptionAndDescriptionContainer.getVisibility() == GONE) {</span>
<span class="nc" id="L1491">            showCaptionAndDescriptionContainer.setVisibility(VISIBLE);</span>
<span class="nc" id="L1492">            setUpCaptionAndDescriptionLayout();</span>
        } else {
<span class="nc" id="L1494">            showCaptionAndDescriptionContainer.setVisibility(GONE);</span>
        }
<span class="nc" id="L1496">    }</span>

    /**
     * setUp Caption And Description Layout
     */
    private void setUpCaptionAndDescriptionLayout() {
<span class="nc" id="L1502">        List&lt;Caption&gt; captions = getCaptions();</span>

<span class="nc bnc" id="L1504" title="All 2 branches missed.">        if (descriptionHtmlCode == null) {</span>
<span class="nc" id="L1505">            progressBar.setVisibility(VISIBLE);</span>
        }

<span class="nc" id="L1508">        getDescription();</span>
<span class="nc" id="L1509">        CaptionListViewAdapter adapter = new CaptionListViewAdapter(captions);</span>
<span class="nc" id="L1510">        captionsListView.setAdapter(adapter);</span>
<span class="nc" id="L1511">    }</span>

    /**
     * Generate the caption with language
     */
    private List&lt;Caption&gt; getCaptions() {
<span class="nc" id="L1517">        List&lt;Caption&gt; captionList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1518">        Map&lt;String, String&gt; captions = media.getCaptions();</span>
<span class="nc" id="L1519">        AppLanguageLookUpTable appLanguageLookUpTable = new AppLanguageLookUpTable(getContext());</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">        for (Map.Entry&lt;String, String&gt; map : captions.entrySet()) {</span>
<span class="nc" id="L1521">            String language = appLanguageLookUpTable.getLocalizedName(map.getKey());</span>
<span class="nc" id="L1522">            String languageCaption = map.getValue();</span>
<span class="nc" id="L1523">            captionList.add(new Caption(language, languageCaption));</span>
<span class="nc" id="L1524">        }</span>

<span class="nc bnc" id="L1526" title="All 2 branches missed.">        if (captionList.size() == 0) {</span>
<span class="nc" id="L1527">            captionList.add(new Caption(&quot;&quot;, &quot;No Caption&quot;));</span>
        }
<span class="nc" id="L1529">        return captionList;</span>
    }

    private void getDescription() {
<span class="nc" id="L1533">        compositeDisposable.add(mediaDataExtractor.getHtmlOfPage(media.getFilename())</span>
<span class="nc" id="L1534">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L1535">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1536">            .subscribe(this::extractDescription, Timber::e));</span>
<span class="nc" id="L1537">    }</span>

    /**
     * extract the description from html of imagepage
     */
    private void extractDescription(String s) {
<span class="nc" id="L1543">        String descriptionClassName = &quot;&lt;td class=\&quot;description\&quot;&gt;&quot;;</span>
<span class="nc" id="L1544">        int start = s.indexOf(descriptionClassName) + descriptionClassName.length();</span>
<span class="nc" id="L1545">        int end = s.indexOf(&quot;&lt;/td&gt;&quot;, start);</span>
<span class="nc" id="L1546">        descriptionHtmlCode = &quot;&quot;;</span>
<span class="nc bnc" id="L1547" title="All 2 branches missed.">        for (int i = start; i &lt; end; i++) {</span>
<span class="nc" id="L1548">            descriptionHtmlCode = descriptionHtmlCode + s.toCharArray()[i];</span>
        }

<span class="nc" id="L1551">        descriptionWebView</span>
<span class="nc" id="L1552">            .loadDataWithBaseURL(null, descriptionHtmlCode, &quot;text/html&quot;, &quot;utf-8&quot;, null);</span>
<span class="nc" id="L1553">        progressBar.setVisibility(GONE);</span>
<span class="nc" id="L1554">    }</span>

    /**
     * Handle back event when fragment when showCaptionAndDescriptionContainer is visible
     */
    private void handleBackEvent(View view) {
<span class="nc" id="L1560">        view.setFocusableInTouchMode(true);</span>
<span class="nc" id="L1561">        view.requestFocus();</span>
<span class="nc" id="L1562">        view.setOnKeyListener(new OnKeyListener() {</span>
            @Override
            public boolean onKey(View view, int keycode, KeyEvent keyEvent) {
<span class="nc bnc" id="L1565" title="All 2 branches missed.">                if (keycode == KeyEvent.KEYCODE_BACK) {</span>
<span class="nc bnc" id="L1566" title="All 2 branches missed.">                    if (showCaptionAndDescriptionContainer.getVisibility() == VISIBLE) {</span>
<span class="nc" id="L1567">                        showCaptionAndDescriptionContainer.setVisibility(GONE);</span>
<span class="nc" id="L1568">                        return true;</span>
                    }
                }
<span class="nc" id="L1571">                return false;</span>
            }
        });

<span class="nc" id="L1575">    }</span>


    public interface Callback {
        void nominatingForDeletion(int index);
    }
    
    /**
     * Called when the image background color is changed.
     * You should pass a useable color, not a resource id.
     * @param color
     */
    public void onImageBackgroundChanged(int color) {
<span class="nc" id="L1588">        int currentColor = getImageBackgroundColor();</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">        if (currentColor == color) {</span>
<span class="nc" id="L1590">            return;</span>
        }

<span class="nc" id="L1593">        image.setBackgroundColor(color);</span>
<span class="nc" id="L1594">        getImageBackgroundColorPref().edit().putInt(IMAGE_BACKGROUND_COLOR, color).apply();</span>
<span class="nc" id="L1595">    }</span>

    private SharedPreferences getImageBackgroundColorPref() {
<span class="nc" id="L1598">        return getContext().getSharedPreferences(IMAGE_BACKGROUND_COLOR + media.getPageId(), Context.MODE_PRIVATE);</span>
    }

    private int getImageBackgroundColor() {
<span class="nc" id="L1602">        SharedPreferences imageBackgroundColorPref = this.getImageBackgroundColorPref();</span>
<span class="nc" id="L1603">        return imageBackgroundColorPref.getInt(IMAGE_BACKGROUND_COLOR, DEFAULT_IMAGE_BACKGROUND_COLOR);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>