<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaClient.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.media</a> &gt; <span class="el_source">MediaClient.kt</span></div><h1>MediaClient.kt</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.media

import fr.free.nrw.commons.BuildConfig
import fr.free.nrw.commons.Media
import fr.free.nrw.commons.category.ContinuationClient
import fr.free.nrw.commons.explore.media.MediaConverter
import fr.free.nrw.commons.utils.CommonsDateUtil
import io.reactivex.Single
import org.wikipedia.dataclient.mwapi.MwQueryPage
import org.wikipedia.dataclient.mwapi.MwQueryResponse
import org.wikipedia.wikidata.Entities
import java.util.*
import javax.inject.Inject
import javax.inject.Singleton

const val PAGE_ID_PREFIX = &quot;M&quot;
const val CATEGORY_CONTINUATION_PREFIX = &quot;category_&quot;
const val LIMIT = 30
const val RADIUS = 10000

/**
 * Media Client to handle custom calls to Commons MediaWiki APIs
 */
@Singleton
<span class="nc" id="L25">class MediaClient @Inject constructor(</span>
<span class="nc" id="L26">    private val mediaInterface: MediaInterface,</span>
<span class="nc" id="L27">    private val pageMediaInterface: PageMediaInterface,</span>
<span class="nc" id="L28">    private val mediaDetailInterface: MediaDetailInterface,</span>
<span class="nc" id="L29">    private val mediaConverter: MediaConverter</span>
<span class="nc" id="L30">) : ContinuationClient&lt;MwQueryResponse, Media&gt;() {</span>

    fun getMediaById(id: String) =
<span class="nc" id="L33">        responseMapper(mediaInterface.getMediaById(id)).map { it.first() }</span>

    /**
     * Checks if a page exists on Commons
     * The same method can be used to check for file or talk page
     *
     * @param title File:Test.jpg or Commons:Deletion_requests/File:Test1.jpeg
     */
    fun checkPageExistsUsingTitle(title: String?): Single&lt;Boolean&gt; {
<span class="nc" id="L42">        return mediaInterface.checkPageExistsUsingTitle(title)</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">            .map { it.query()!!.firstPage()!!.pageId() &gt; 0 }</span>
    }

    /**
     * Take the fileSha and returns whether a file with a matching SHA exists or not
     *
     * @param fileSha SHA of the file to be checked
     */
    fun checkFileExistsUsingSha(fileSha: String?): Single&lt;Boolean&gt; {
<span class="nc" id="L52">        return mediaInterface.checkFileExistsUsingSha(fileSha)</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">            .map { it.query()!!.allImages().size &gt; 0 }</span>
    }

    /**
     * This method takes the category as input and returns a list of  Media objects filtered using image generator query
     * It uses the generator query API to get the images searched using a query, 10 at a time.
     *
     * @param category the search category. Must start with &quot;Category:&quot;
     * @return
     */
    fun getMediaListFromCategory(category: String): Single&lt;List&lt;Media&gt;&gt; {
<span class="nc" id="L64">        return continuationRequest(CATEGORY_CONTINUATION_PREFIX, category) {</span>
<span class="nc" id="L65">            mediaInterface.getMediaListFromCategory(category, 10, it)</span>
        }
    }

    /**
     * This method takes the userName as input and returns a list of  Media objects filtered using
     * allimages query It uses the allimages query API to get the images contributed by the userName,
     * 10 at a time.
     *
     * @param userName the username
     * @return
     */
    fun getMediaListForUser(userName: String): Single&lt;List&lt;Media&gt;&gt; {
<span class="nc" id="L78">        return continuationRequest(&quot;user_&quot;, userName) {</span>
<span class="nc" id="L79">            mediaInterface.getMediaListForUser(userName, 10, it)</span>
        }
    }

    /**
     * This method takes a keyword as input and returns a list of  Media objects filtered using image generator query
     * It uses the generator query API to get the images searched using a query, 10 at a time.
     *
     * @param keyword the search keyword
     * @param limit
     * @param offset
     * @return
     */
    fun getMediaListFromSearch(keyword: String?, limit: Int, offset: Int) =
<span class="nc" id="L93">        responseMapper(mediaInterface.getMediaListFromSearch(keyword, limit, offset))</span>

    /**
     * This method takes coordinate as input and returns a list of  Media objects.
     * It uses the generator query API to get the images searched using a query.
     *
     * @param coordinate coordinate
     * @return
     */
    fun getMediaListFromGeoSearch(coordinate: String?) =
<span class="nc" id="L103">        responseMapper(mediaInterface.getMediaListFromGeoSearch(coordinate, LIMIT, RADIUS))</span>

    /**
     * @return list of images for a particular depict entity
     */
    fun fetchImagesForDepictedItem(
        query: String,
        srlimit: Int,
        sroffset: Int
    ): Single&lt;List&lt;Media&gt;&gt; {
<span class="nc" id="L113">        return responseMapper(</span>
<span class="nc" id="L114">            mediaInterface.fetchImagesForDepictedItem(</span>
<span class="nc" id="L115">                &quot;haswbstatement:&quot; + BuildConfig.DEPICTS_PROPERTY + &quot;=&quot; + query,</span>
<span class="nc" id="L116">                srlimit.toString(),</span>
<span class="nc" id="L117">                sroffset.toString()</span>
            )
        )
    }

    /**
     * Fetches Media object from the imageInfo API
     *
     * @param titles the tiles to be searched for. Can be filename or template name
     * @return
     */
    fun getMedia(titles: String?): Single&lt;Media&gt; {
<span class="nc" id="L129">        return responseMapper(mediaInterface.getMedia(titles))</span>
<span class="nc" id="L130">            .map { it.first() }</span>
    }

    /**
     * The method returns the picture of the day
     *
     * @return Media object corresponding to the picture of the day
     */
    fun getPictureOfTheDay(): Single&lt;Media&gt; {
<span class="nc" id="L139">        val date = CommonsDateUtil.getIso8601DateFormatShort().format(Date())</span>
<span class="nc" id="L140">        return responseMapper(mediaInterface.getMediaWithGenerator(&quot;Template:Potd/$date&quot;)).map { it.first() }</span>
    }

    fun getPageHtml(title: String?): Single&lt;String&gt; {
<span class="nc" id="L144">        return mediaInterface.getPageHtml(title)</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">            .map { obj: MwParseResponse -&gt; obj.parse()?.text() ?: &quot;&quot; }</span>
    }

    fun getEntities(entityIds: List&lt;String&gt;): Single&lt;Entities&gt; {
<span class="nc bnc" id="L149" title="All 2 branches missed.">        return if (entityIds.isEmpty())</span>
<span class="nc" id="L150">            Single.error(Exception(&quot;empty list passed for ids&quot;))</span>
        else
<span class="nc" id="L152">            mediaDetailInterface.getEntity(entityIds.joinToString(&quot;|&quot;))</span>
    }

    fun doesPageContainMedia(title: String?): Single&lt;Boolean&gt; {
<span class="nc" id="L156">        return pageMediaInterface.getMediaList(title)</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            .map { it.items.isNotEmpty() }</span>
    }

    fun resetCategoryContinuation(category: String) {
<span class="nc" id="L161">        resetContinuation(CATEGORY_CONTINUATION_PREFIX, category)</span>
<span class="nc" id="L162">    }</span>

    /**
     * Call the resetUserContinuation method
     *
     * @param userName the username
     */
    fun resetUserNameContinuation(userName: String) =
<span class="nc" id="L170">        resetUserContinuation(&quot;user_&quot;, userName)</span>

    /**
     * Get whole WikiText of required file
     * @param title : Name of the file
     * @return Observable&lt;MwQueryResult&gt;
     */
    fun getCurrentWikiText(title: String): Single&lt;String?&gt; {
<span class="nc" id="L178">        return mediaDetailInterface.getWikiText(title).map {</span>
<span class="nc bnc" id="L179" title="All 10 branches missed.">            it.query()?.pages()?.get(0)?.revisions()?.get(0)?.content()</span>
        }
    }

    override fun responseMapper(
        networkResult: Single&lt;MwQueryResponse&gt;,
        key: String?
    ): Single&lt;List&lt;Media&gt;&gt; {
<span class="nc" id="L187">        return networkResult.map {</span>
<span class="nc" id="L188">            handleContinuationResponse(it.continuation(), key)</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">            it.query()?.pages() ?: emptyList()</span>
<span class="nc" id="L190">        }.flatMap(::mediaFromPageAndEntity)</span>
    }

    private fun mediaFromPageAndEntity(pages: List&lt;MwQueryPage&gt;): Single&lt;List&lt;Media&gt;&gt; {
<span class="nc bnc" id="L194" title="All 2 branches missed.">        return if (pages.isEmpty()) {</span>
<span class="nc" id="L195">            Single.just(emptyList())</span>
<span class="nc" id="L196">        } else {</span>
<span class="nc" id="L197">            getEntities(pages.map { &quot;$PAGE_ID_PREFIX${it.pageId()}&quot; })</span>
<span class="nc" id="L198">                .map {</span>
<span class="nc" id="L199">                    pages.zip(it.entities().values)</span>
<span class="nc" id="L200">                        .mapNotNull { (page, entity) -&gt;</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                            page.imageInfo()?.let {</span>
<span class="nc" id="L202">                                mediaConverter.convert(page, entity, it)</span>
                            }
                        }
                }
        }

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>