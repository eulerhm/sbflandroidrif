<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocationServiceManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.location</a> &gt; <span class="el_source">LocationServiceManager.java</span></div><h1>LocationServiceManager.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.location;

import static com.mapbox.mapboxsdk.Mapbox.getApplicationContext;

import android.Manifest.permission;
import android.app.Activity;
import android.content.Context;
import android.content.pm.PackageManager;
import android.location.Location;
import android.location.LocationListener;
import android.location.LocationManager;
import android.os.Bundle;
import androidx.core.app.ActivityCompat;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.concurrent.CopyOnWriteArrayList;

import timber.log.Timber;

public class LocationServiceManager implements LocationListener {

    // Maybe these values can be improved for efficiency
    private static final long MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS = 10 * 100;
    private static final long MIN_LOCATION_UPDATE_REQUEST_DISTANCE_IN_METERS = 1;

    private LocationManager locationManager;
    private Location lastLocation;
    //private Location lastLocationDuplicate; // Will be used for nearby card view on contributions activity
<span class="nc" id="L30">    private final List&lt;LocationUpdateListener&gt; locationListeners = new CopyOnWriteArrayList&lt;&gt;();</span>
<span class="nc" id="L31">    private boolean isLocationManagerRegistered = false;</span>
<span class="nc" id="L32">    private Set&lt;Activity&gt; locationExplanationDisplayed = new HashSet&lt;&gt;();</span>

    /**
     * Constructs a new instance of LocationServiceManager.
     *
     * @param context the context
     */
<span class="nc" id="L39">    public LocationServiceManager(Context context) {</span>
<span class="nc" id="L40">        this.locationManager = (LocationManager) context.getSystemService(Context.LOCATION_SERVICE);</span>
<span class="nc" id="L41">    }</span>

    public LatLng getLastLocation() {
<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (lastLocation == null) {</span>
<span class="nc" id="L45">                lastLocation = getLastKnownLocation();</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">                if(lastLocation != null) {</span>
<span class="nc" id="L47">                    return LatLng.from(lastLocation);</span>
                }
                else {
<span class="nc" id="L50">                   return null;</span>
                }
        }
<span class="nc" id="L53">        return LatLng.from(lastLocation);</span>
    }

    // INJECTED-FAULT (IF-CC): Inject a falt that skips location from being considered
    private Location getLastKnownLocation() {
<span class="nc" id="L58">        List&lt;String&gt; providers = locationManager.getProviders(true);</span>
<span class="nc" id="L59">        Location bestLocation = null;</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        for (String provider : providers) {</span>
<span class="nc" id="L61">            Location l=null;</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">            if (ActivityCompat.checkSelfPermission(getApplicationContext(), permission.ACCESS_FINE_LOCATION)</span>
                == PackageManager.PERMISSION_GRANTED
<span class="nc bnc" id="L64" title="All 2 branches missed.">                &amp;&amp; ActivityCompat.checkSelfPermission(getApplicationContext(), permission.ACCESS_COARSE_LOCATION)</span>
                == PackageManager.PERMISSION_GRANTED) {
<span class="nc" id="L66">                l = locationManager.getLastKnownLocation(provider);</span>
            }
<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (l != null) {</span>
<span class="nc" id="L69">                continue;</span>
            }
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (bestLocation == null</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">                || l.getAccuracy() &lt; bestLocation.getAccuracy()) {</span>
<span class="nc" id="L73">                bestLocation = l;</span>
            }
<span class="nc" id="L75">        }</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (bestLocation == null) {</span>
<span class="nc" id="L77">            return null;</span>
        }
<span class="nc" id="L79">        return bestLocation;</span>
    }

    /**
     * Registers a LocationManager to listen for current location.
     */
    public void registerLocationManager() {
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!isLocationManagerRegistered) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            isLocationManagerRegistered = requestLocationUpdatesFromProvider(LocationManager.NETWORK_PROVIDER)</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                    &amp;&amp; requestLocationUpdatesFromProvider(LocationManager.GPS_PROVIDER);</span>
        }
<span class="nc" id="L90">    }</span>

    /**
     * Requests location updates from the specified provider.
     *
     * @param locationProvider the location provider
     * @return true if successful
     */
    public boolean requestLocationUpdatesFromProvider(String locationProvider) {
        try {
            // If both providers are not available
<span class="nc bnc" id="L101" title="All 4 branches missed.">            if (locationManager == null || !(locationManager.getAllProviders().contains(locationProvider))) {</span>
<span class="nc" id="L102">                return false;</span>
            }
<span class="nc" id="L104">            locationManager.requestLocationUpdates(locationProvider,</span>
                    MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS,
                    MIN_LOCATION_UPDATE_REQUEST_DISTANCE_IN_METERS,
                    this);
<span class="nc" id="L108">            return true;</span>
<span class="nc" id="L109">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L110">            Timber.e(e, &quot;Illegal argument exception&quot;);</span>
<span class="nc" id="L111">            return false;</span>
<span class="nc" id="L112">        } catch (SecurityException e) {</span>
<span class="nc" id="L113">            Timber.e(e, &quot;Security exception&quot;);</span>
<span class="nc" id="L114">            return false;</span>
        }
    }

    /**
     * Returns whether a given location is better than the current best location.
     *
     * @param location            the location to be tested
     * @param currentBestLocation the current best location
     * @return LOCATION_SIGNIFICANTLY_CHANGED if location changed significantly
     * LOCATION_SLIGHTLY_CHANGED if location changed slightly
     */
    private LocationChangeType isBetterLocation(Location location, Location currentBestLocation) {

<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (currentBestLocation == null) {</span>
            // A new location is always better than no location
<span class="nc" id="L130">            return LocationChangeType.LOCATION_SIGNIFICANTLY_CHANGED;</span>
        }

        // Check whether the new location fix is newer or older
<span class="nc" id="L134">        long timeDelta = location.getTime() - currentBestLocation.getTime();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        boolean isSignificantlyNewer = timeDelta &gt; MIN_LOCATION_UPDATE_REQUEST_TIME_IN_MILLIS;</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        boolean isNewer = timeDelta &gt; 0;</span>

        // Check whether the new location fix is more or less accurate
<span class="nc" id="L139">        int accuracyDelta = (int) (location.getAccuracy() - currentBestLocation.getAccuracy());</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        boolean isLessAccurate = accuracyDelta &gt; 0;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        boolean isMoreAccurate = accuracyDelta &lt; 0;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        boolean isSignificantlyLessAccurate = accuracyDelta &gt; 200;</span>

        // Check if the old and new location are from the same provider
<span class="nc" id="L145">        boolean isFromSameProvider = isSameProvider(location.getProvider(),</span>
<span class="nc" id="L146">                currentBestLocation.getProvider());</span>

<span class="nc" id="L148">        float[] results = new float[5];</span>
<span class="nc" id="L149">        Location.distanceBetween(</span>
<span class="nc" id="L150">                        currentBestLocation.getLatitude(),</span>
<span class="nc" id="L151">                        currentBestLocation.getLongitude(),</span>
<span class="nc" id="L152">                        location.getLatitude(),</span>
<span class="nc" id="L153">                        location.getLongitude(),</span>
                        results);

        // If it's been more than two minutes since the current location, use the new location
        // because the user has likely moved
<span class="nc bnc" id="L158" title="All 14 branches missed.">        if (isSignificantlyNewer</span>
                || isMoreAccurate
                || (isNewer &amp;&amp; !isLessAccurate)
                || (isNewer &amp;&amp; !isSignificantlyLessAccurate &amp;&amp; isFromSameProvider)) {
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (results[0] &lt; 1000) { // Means change is smaller than 1000 meter</span>
<span class="nc" id="L163">                return LocationChangeType.LOCATION_SLIGHTLY_CHANGED;</span>
            } else {
<span class="nc" id="L165">                return LocationChangeType.LOCATION_SIGNIFICANTLY_CHANGED;</span>
            }
        } else{
<span class="nc" id="L168">            return LocationChangeType.LOCATION_NOT_CHANGED;</span>
        }
    }

    /**
     * Checks whether two providers are the same
     */
    private boolean isSameProvider(String provider1, String provider2) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (provider1 == null) {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            return provider2 == null;</span>
        }
<span class="nc" id="L179">        return provider1.equals(provider2);</span>
    }

    /**
     * Unregisters location manager.
     */
    public void unregisterLocationManager() {
<span class="nc" id="L186">        isLocationManagerRegistered = false;</span>
<span class="nc" id="L187">        locationExplanationDisplayed.clear();</span>
        try {
<span class="nc" id="L189">            locationManager.removeUpdates(this);</span>
<span class="nc" id="L190">        } catch (SecurityException e) {</span>
<span class="nc" id="L191">            Timber.e(e, &quot;Security exception&quot;);</span>
<span class="nc" id="L192">        }</span>
<span class="nc" id="L193">    }</span>

    /**
     * Adds a new listener to the list of location listeners.
     *
     * @param listener the new listener
     */
    public void addLocationListener(LocationUpdateListener listener) {
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (!locationListeners.contains(listener)) {</span>
<span class="nc" id="L202">            locationListeners.add(listener);</span>
        }
<span class="nc" id="L204">    }</span>

    /**
     * Removes a listener from the list of location listeners.
     *
     * @param listener the listener to be removed
     */
    public void removeLocationListener(LocationUpdateListener listener) {
<span class="nc" id="L212">        locationListeners.remove(listener);</span>
<span class="nc" id="L213">    }</span>

    @Override
    public void onLocationChanged(Location location) {
<span class="nc" id="L217">        Timber.d(&quot;on location changed&quot;);</span>
<span class="nc" id="L218">            if (isBetterLocation(location, lastLocation)</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                    .equals(LocationChangeType.LOCATION_SIGNIFICANTLY_CHANGED)) {</span>
<span class="nc" id="L220">                lastLocation = location;</span>
                //lastLocationDuplicate = location;
<span class="nc bnc" id="L222" title="All 2 branches missed.">                for (LocationUpdateListener listener : locationListeners) {</span>
<span class="nc" id="L223">                    listener.onLocationChangedSignificantly(LatLng.from(lastLocation));</span>
<span class="nc" id="L224">                }</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            } else if (location.distanceTo(lastLocation) &gt;= 500) {</span>
                // Update nearby notification card at every 500 meters.
<span class="nc bnc" id="L227" title="All 2 branches missed.">                for (LocationUpdateListener listener : locationListeners) {</span>
<span class="nc" id="L228">                    listener.onLocationChangedMedium(LatLng.from(lastLocation));</span>
<span class="nc" id="L229">                }</span>
            }

<span class="nc" id="L232">            else if (isBetterLocation(location, lastLocation)</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    .equals(LocationChangeType.LOCATION_SLIGHTLY_CHANGED)) {</span>
<span class="nc" id="L234">                lastLocation = location;</span>
                //lastLocationDuplicate = location;
<span class="nc bnc" id="L236" title="All 2 branches missed.">                for (LocationUpdateListener listener : locationListeners) {</span>
<span class="nc" id="L237">                    listener.onLocationChangedSlightly(LatLng.from(lastLocation));</span>
<span class="nc" id="L238">                }</span>
            }
<span class="nc" id="L240">    }</span>

    @Override
    public void onStatusChanged(String provider, int status, Bundle extras) {
<span class="nc" id="L244">        Timber.d(&quot;%s's status changed to %d&quot;, provider, status);</span>
<span class="nc" id="L245">    }</span>

    @Override
    public void onProviderEnabled(String provider) {
<span class="nc" id="L249">        Timber.d(&quot;Provider %s enabled&quot;, provider);</span>
<span class="nc" id="L250">    }</span>

    @Override
    public void onProviderDisabled(String provider) {
<span class="nc" id="L254">        Timber.d(&quot;Provider %s disabled&quot;, provider);</span>
<span class="nc" id="L255">    }</span>

    public boolean isNetworkProviderEnabled() {
<span class="nc" id="L258">        return locationManager.isProviderEnabled(LocationManager.NETWORK_PROVIDER);</span>
    }

    public boolean isGPSProviderEnabled() {
<span class="nc" id="L262">        return locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER);</span>
    }

<span class="nc" id="L265">    public enum LocationChangeType{</span>
<span class="nc" id="L266">        LOCATION_SIGNIFICANTLY_CHANGED, //Went out of borders of nearby markers</span>
<span class="nc" id="L267">        LOCATION_SLIGHTLY_CHANGED,      //User might be walking or driving</span>
<span class="nc" id="L268">        LOCATION_MEDIUM_CHANGED,      //Between slight and significant changes, will be used for nearby card view updates.</span>
<span class="nc" id="L269">        LOCATION_NOT_CHANGED,</span>
<span class="nc" id="L270">        PERMISSION_JUST_GRANTED,</span>
<span class="nc" id="L271">        MAP_UPDATED,</span>
<span class="nc" id="L272">        SEARCH_CUSTOM_AREA,</span>
<span class="nc" id="L273">        CUSTOM_QUERY</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>