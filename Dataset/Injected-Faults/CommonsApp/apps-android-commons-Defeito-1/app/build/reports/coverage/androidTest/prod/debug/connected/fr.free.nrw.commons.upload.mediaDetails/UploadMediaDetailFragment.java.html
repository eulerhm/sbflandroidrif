<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadMediaDetailFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.upload.mediaDetails</a> &gt; <span class="el_source">UploadMediaDetailFragment.java</span></div><h1>UploadMediaDetailFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.upload.mediaDetails;

import static android.app.Activity.RESULT_OK;
import static fr.free.nrw.commons.utils.ActivityUtils.startActivityWithFlags;
import static fr.free.nrw.commons.utils.ImageUtils.FILE_NAME_EXISTS;
import static fr.free.nrw.commons.utils.ImageUtils.getErrorMessageForResult;

import android.annotation.SuppressLint;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.speech.RecognizerIntent;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.CheckBox;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Toast;
import android.graphics.drawable.Drawable;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.widget.AppCompatButton;
import androidx.appcompat.widget.AppCompatImageButton;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import butterknife.BindView;
import butterknife.ButterKnife;
import butterknife.OnClick;
import com.github.chrisbanes.photoview.PhotoView;
import com.mapbox.mapboxsdk.camera.CameraPosition;
import fr.free.nrw.commons.LocationPicker.LocationPicker;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.edit.EditActivity;
import fr.free.nrw.commons.contributions.MainActivity;
import fr.free.nrw.commons.filepicker.UploadableFile;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LatLng;
import fr.free.nrw.commons.nearby.Place;
import fr.free.nrw.commons.recentlanguages.RecentLanguagesDao;
import fr.free.nrw.commons.settings.Prefs;
import fr.free.nrw.commons.upload.ImageCoordinates;
import fr.free.nrw.commons.upload.SimilarImageDialogFragment;
import fr.free.nrw.commons.upload.UploadActivity;
import fr.free.nrw.commons.upload.UploadBaseFragment;
import fr.free.nrw.commons.upload.UploadItem;
import fr.free.nrw.commons.upload.UploadMediaDetail;
import fr.free.nrw.commons.upload.UploadMediaDetailAdapter;
import fr.free.nrw.commons.utils.DialogUtil;
import fr.free.nrw.commons.utils.ImageUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Objects;
import javax.inject.Inject;
import javax.inject.Named;
import org.apache.commons.lang3.StringUtils;
import timber.log.Timber;
import android.os.Parcelable;

<span class="nc" id="L65">public class UploadMediaDetailFragment extends UploadBaseFragment implements</span>
    UploadMediaDetailsContract.View, UploadMediaDetailAdapter.EventListener {

    private static final int REQUEST_CODE = 1211;
    private static final int REQUEST_CODE_FOR_EDIT_ACTIVITY = 1212;
    private static final int REQUEST_CODE_FOR_VOICE_INPUT = 1213;

    /**
     * A key for applicationKvStore. By this key we can retrieve the location of last UploadItem ex.
     * 12.3433,54.78897 from applicationKvStore.
     */
    public static final String LAST_LOCATION = &quot;last_location_while_uploading&quot;;
    public static final String LAST_ZOOM = &quot;last_zoom_level_while_uploading&quot;;


    public static final String UPLOADABLE_FILE = &quot;uploadable_file&quot;;

    public static final String UPLOAD_MEDIA_DETAILS = &quot;upload_media_detail_adapter&quot;;
    @BindView(R.id.tv_title)
    TextView tvTitle;
    @BindView(R.id.location_image_view)
    ImageView locationImageView;
    @BindView(R.id.location_text_view)
    TextView locationTextView;
    @BindView(R.id.ll_location_status)
    LinearLayout llLocationStatus;
    @BindView(R.id.ib_expand_collapse)
    AppCompatImageButton ibExpandCollapse;
    @BindView(R.id.ll_container_media_detail)
    LinearLayout llContainerMediaDetail;
    @BindView(R.id.rv_descriptions)
    RecyclerView rvDescriptions;
    @BindView(R.id.backgroundImage)
    PhotoView photoViewBackgroundImage;
    @BindView(R.id.btn_next)
    AppCompatButton btnNext;
    @BindView(R.id.btn_previous)
    AppCompatButton btnPrevious;
    @BindView(R.id.ll_edit_image)
    LinearLayout llEditImage;
    @BindView(R.id.tooltip)
    ImageView tooltip;

    private UploadMediaDetailAdapter uploadMediaDetailAdapter;
    @BindView(R.id.btn_copy_subsequent_media)
    AppCompatButton btnCopyToSubsequentMedia;

    @Inject
    UploadMediaDetailsContract.UserActionListener presenter;

    @Inject
    @Named(&quot;default_preferences&quot;)
    JsonKvStore defaultKvStore;

    @Inject
    RecentLanguagesDao recentLanguagesDao;

    private UploadableFile uploadableFile;
    private Place place;

<span class="nc" id="L125">    private boolean isExpanded = true;</span>

    /**
     * True if location is added via the &quot;missing location&quot; popup dialog (which appears after
     * tapping &quot;Next&quot; if the picture has no geographical coordinates).
     */
    private boolean isMissingLocationDialog;

    /**
     * showNearbyFound will be true, if any nearby location found that needs pictures and the nearby
     * popup is yet to be shown Used to show and check if the nearby found popup is already shown
     */
    private boolean showNearbyFound;

    /**
     * nearbyPlace holds the detail of nearby place that need pictures, if any found
     */
    private Place nearbyPlace;
    private UploadItem uploadItem;
    /**
     * inAppPictureLocation: use location recorded while using the in-app camera if device camera
     * does not record it in the EXIF
     */
    private LatLng inAppPictureLocation;
    /**
     * editableUploadItem : Storing the upload item before going to update the coordinates
     */
    private UploadItem editableUploadItem;

    private UploadMediaDetailFragmentCallback callback;

    public void setCallback(UploadMediaDetailFragmentCallback callback) {
<span class="nc" id="L157">        this.callback = callback;</span>
<span class="nc" id="L158">    }</span>

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L162">        super.onCreate(savedInstanceState);</span>


<span class="nc bnc" id="L165" title="All 4 branches missed.">        if(savedInstanceState!=null &amp;&amp; uploadableFile==null) {</span>
<span class="nc" id="L166">            uploadableFile = savedInstanceState.getParcelable(UPLOADABLE_FILE);</span>
        }

<span class="nc" id="L169">    }</span>



    public void setImageTobeUploaded(UploadableFile uploadableFile, Place place,
        LatLng inAppPictureLocation) {
<span class="nc" id="L175">        this.uploadableFile = uploadableFile;</span>
<span class="nc" id="L176">        this.place = place;</span>
<span class="nc" id="L177">        this.inAppPictureLocation = inAppPictureLocation;</span>
<span class="nc" id="L178">    }</span>

    @Nullable
    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container,
        @Nullable Bundle savedInstanceState) {
<span class="nc" id="L184">        return inflater.inflate(R.layout.fragment_upload_media_detail_fragment, container, false);</span>

    }

    @Override
    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
<span class="nc" id="L190">        super.onViewCreated(view, savedInstanceState);</span>
<span class="nc" id="L191">        ButterKnife.bind(this, view);</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (callback != null) {</span>
<span class="nc" id="L194">            init();</span>
        }

<span class="nc bnc" id="L197" title="All 2 branches missed.">        if(savedInstanceState!=null){</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">                if(uploadMediaDetailAdapter.getItems().size()==0){</span>
<span class="nc" id="L199">                    uploadMediaDetailAdapter.setItems(savedInstanceState.getParcelableArrayList(UPLOAD_MEDIA_DETAILS));</span>
<span class="nc" id="L200">                    presenter.setUploadMediaDetails(uploadMediaDetailAdapter.getItems(), callback.getIndexInViewFlipper(this));</span>
                }
        }

<span class="nc" id="L204">    }</span>

    private void init() {
<span class="nc" id="L207">        tvTitle.setText(getString(R.string.step_count, callback.getIndexInViewFlipper(this) + 1,</span>
<span class="nc" id="L208">            callback.getTotalNumberOfSteps(), getString(R.string.media_detail_step_title)));</span>
<span class="nc" id="L209">        tooltip.setOnClickListener(</span>
<span class="nc" id="L210">            v -&gt; showInfoAlert(R.string.media_detail_step_title, R.string.media_details_tooltip));</span>
<span class="nc" id="L211">        initPresenter();</span>
<span class="nc" id="L212">        presenter.receiveImage(uploadableFile, place, inAppPictureLocation);</span>
<span class="nc" id="L213">        initRecyclerView();</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (callback.getIndexInViewFlipper(this) == 0) {</span>
<span class="nc" id="L216">            btnPrevious.setEnabled(false);</span>
<span class="nc" id="L217">            btnPrevious.setAlpha(0.5f);</span>
        } else {
<span class="nc" id="L219">            btnPrevious.setEnabled(true);</span>
<span class="nc" id="L220">            btnPrevious.setAlpha(1.0f);</span>
        }

        // If the image EXIF data contains the location, show the map icon with a green tick
<span class="nc bnc" id="L224" title="All 4 branches missed.">        if (inAppPictureLocation != null ||</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                (uploadableFile != null &amp;&amp; uploadableFile.hasLocation())) {</span>
<span class="nc" id="L226">            Drawable mapTick = getResources().getDrawable(R.drawable.ic_map_available_20dp);</span>
<span class="nc" id="L227">            locationImageView.setImageDrawable(mapTick);</span>
<span class="nc" id="L228">            locationTextView.setText(R.string.edit_location);</span>
<span class="nc" id="L229">        } else {</span>
            // Otherwise, show the map icon with a red question mark
<span class="nc" id="L231">            Drawable mapQuestionMark =</span>
<span class="nc" id="L232">                getResources().getDrawable(R.drawable.ic_map_not_available_20dp);</span>
<span class="nc" id="L233">            locationImageView.setImageDrawable(mapQuestionMark);</span>
<span class="nc" id="L234">            locationTextView.setText(R.string.add_location);</span>
        }

        //If this is the last media, we have nothing to copy, lets not show the button
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (callback.getIndexInViewFlipper(this) == callback.getTotalNumberOfSteps() - 4) {</span>
<span class="nc" id="L239">            btnCopyToSubsequentMedia.setVisibility(View.GONE);</span>
        } else {
<span class="nc" id="L241">            btnCopyToSubsequentMedia.setVisibility(View.VISIBLE);</span>
        }

<span class="nc" id="L244">        attachImageViewScaleChangeListener();</span>
<span class="nc" id="L245">    }</span>

    /**
     * Attaches the scale change listener to the image view
     */
    private void attachImageViewScaleChangeListener() {
<span class="nc" id="L251">        photoViewBackgroundImage.setOnScaleChangeListener(</span>
            (scaleFactor, focusX, focusY) -&gt; {
                //Whenever the uses plays with the image, lets collapse the media detail container
<span class="nc" id="L254">                expandCollapseLlMediaDetail(false);</span>
<span class="nc" id="L255">            });</span>
<span class="nc" id="L256">    }</span>

    /**
     * attach the presenter with the view
     */
    private void initPresenter() {
<span class="nc" id="L262">        presenter.onAttachView(this);</span>
<span class="nc" id="L263">    }</span>

    /**
     * init the description recycler veiw and caption recyclerview
     */
    private void initRecyclerView() {
<span class="nc" id="L269">        uploadMediaDetailAdapter = new UploadMediaDetailAdapter(this,</span>
<span class="nc" id="L270">            defaultKvStore.getString(Prefs.DESCRIPTION_LANGUAGE, &quot;&quot;), recentLanguagesDao);</span>
<span class="nc" id="L271">        uploadMediaDetailAdapter.setCallback(this::showInfoAlert);</span>
<span class="nc" id="L272">        uploadMediaDetailAdapter.setEventListener(this);</span>
<span class="nc" id="L273">        rvDescriptions.setLayoutManager(new LinearLayoutManager(getContext()));</span>
<span class="nc" id="L274">        rvDescriptions.setAdapter(uploadMediaDetailAdapter);</span>
<span class="nc" id="L275">    }</span>

    /**
     * show dialog with info
     * @param titleStringID
     * @param messageStringId
     */
    private void showInfoAlert(int titleStringID, int messageStringId) {
<span class="nc" id="L283">        DialogUtil.showAlertDialog(getActivity(), getString(titleStringID),</span>
<span class="nc" id="L284">            getString(messageStringId), getString(android.R.string.ok), null, true);</span>
<span class="nc" id="L285">    }</span>

    @OnClick(R.id.btn_next)
    public void onNextButtonClicked() {
<span class="nc" id="L289">        boolean isValidUploads = presenter.verifyImageQuality(callback.getIndexInViewFlipper(this), inAppPictureLocation);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (!isValidUploads) {</span>
<span class="nc" id="L291">            startActivityWithFlags(</span>
<span class="nc" id="L292">                getActivity(), MainActivity.class, Intent.FLAG_ACTIVITY_CLEAR_TOP,</span>
                Intent.FLAG_ACTIVITY_SINGLE_TOP);
        }
<span class="nc" id="L295">    }</span>

    @OnClick(R.id.btn_previous)
    public void onPreviousButtonClicked() {
<span class="nc" id="L299">        callback.onPreviousButtonClicked(callback.getIndexInViewFlipper(this));</span>
<span class="nc" id="L300">    }</span>

    @OnClick(R.id.ll_edit_image)
    public void onEditButtonClicked() {
<span class="nc" id="L304">        presenter.onEditButtonClicked(callback.getIndexInViewFlipper(this));</span>
<span class="nc" id="L305">    }</span>
    @Override
    public void showSimilarImageFragment(String originalFilePath, String possibleFilePath,
        ImageCoordinates similarImageCoordinates) {
<span class="nc" id="L309">        SimilarImageDialogFragment newFragment = new SimilarImageDialogFragment();</span>
<span class="nc" id="L310">        newFragment.setCallback(new SimilarImageDialogFragment.Callback() {</span>
            @Override
            public void onPositiveResponse() {
<span class="nc" id="L313">                Timber.d(&quot;positive response from similar image fragment&quot;);</span>
<span class="nc" id="L314">                presenter.useSimilarPictureCoordinates(similarImageCoordinates, callback.getIndexInViewFlipper(UploadMediaDetailFragment.this));</span>

                // set the description text when user selects to use coordinate from the other image
                // which was taken within 20s
                // fixing: https://github.com/commons-app/apps-android-commons/issues/4700
<span class="nc" id="L319">                uploadMediaDetailAdapter.getItems().get(0).setDescriptionText(</span>
<span class="nc" id="L320">                    getString(R.string.similar_coordinate_description_auto_set));</span>
<span class="nc" id="L321">                updateMediaDetails(uploadMediaDetailAdapter.getItems());</span>
<span class="nc" id="L322">            }</span>

            @Override
            public void onNegativeResponse() {
<span class="nc" id="L326">                Timber.d(&quot;negative response from similar image fragment&quot;);</span>
<span class="nc" id="L327">            }</span>
        });
<span class="nc" id="L329">        Bundle args = new Bundle();</span>
<span class="nc" id="L330">        args.putString(&quot;originalImagePath&quot;, originalFilePath);</span>
<span class="nc" id="L331">        args.putString(&quot;possibleImagePath&quot;, possibleFilePath);</span>
<span class="nc" id="L332">        newFragment.setArguments(args);</span>
<span class="nc" id="L333">        newFragment.show(getChildFragmentManager(), &quot;dialog&quot;);</span>
<span class="nc" id="L334">    }</span>

    @Override
    public void onImageProcessed(UploadItem uploadItem, Place place) {
<span class="nc" id="L338">        photoViewBackgroundImage.setImageURI(uploadItem.getMediaUri());</span>
<span class="nc" id="L339">    }</span>

    /**
     * Sets variables to Show popup if any nearby location needing pictures matches uploadable picture's GPS location
     * @param uploadItem
     * @param place
     */
    @Override
    public void onNearbyPlaceFound(UploadItem uploadItem, Place place) {
<span class="nc" id="L348">        nearbyPlace = place;</span>
<span class="nc" id="L349">        this.uploadItem = uploadItem;</span>
<span class="nc" id="L350">        showNearbyFound = true;</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (callback.getIndexInViewFlipper(this) == 0) {</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (UploadActivity.nearbyPopupAnswers.containsKey(nearbyPlace)) {</span>
<span class="nc" id="L353">                final boolean response = UploadActivity.nearbyPopupAnswers.get(nearbyPlace);</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                if (response) {</span>
<span class="nc" id="L355">                    presenter.onUserConfirmedUploadIsOfPlace(nearbyPlace,</span>
<span class="nc" id="L356">                        callback.getIndexInViewFlipper(this));</span>
                }
<span class="nc" id="L358">            } else {</span>
<span class="nc" id="L359">                showNearbyPlaceFound(nearbyPlace);</span>
            }
<span class="nc" id="L361">            showNearbyFound = false;</span>
        }
<span class="nc" id="L363">    }</span>

    /**
     * Shows nearby place found popup
     * @param place
     */
    @SuppressLint(&quot;StringFormatInvalid&quot;)
    // To avoid the unwanted lint warning that string 'upload_nearby_place_found_description' is not of a valid format
    private void showNearbyPlaceFound(Place place) {
<span class="nc" id="L372">        final View customLayout = getLayoutInflater().inflate(R.layout.custom_nearby_found, null);</span>
<span class="nc" id="L373">        ImageView nearbyFoundImage = customLayout.findViewById(R.id.nearbyItemImage);</span>
<span class="nc" id="L374">        nearbyFoundImage.setImageURI(uploadItem.getMediaUri());</span>
<span class="nc" id="L375">        DialogUtil.showAlertDialog(getActivity(),</span>
<span class="nc" id="L376">            getString(R.string.upload_nearby_place_found_title),</span>
<span class="nc" id="L377">            String.format(Locale.getDefault(),</span>
<span class="nc" id="L378">                getString(R.string.upload_nearby_place_found_description),</span>
<span class="nc" id="L379">                place.getName()),</span>
            () -&gt; {
<span class="nc" id="L381">                UploadActivity.nearbyPopupAnswers.put(place, true);</span>
<span class="nc" id="L382">                presenter.onUserConfirmedUploadIsOfPlace(place, callback.getIndexInViewFlipper(this));</span>
<span class="nc" id="L383">            },</span>
            () -&gt; {
<span class="nc" id="L385">                UploadActivity.nearbyPopupAnswers.put(place, false);</span>
<span class="nc" id="L386">            },</span>
            customLayout, true);
<span class="nc" id="L388">    }</span>

    @Override
    public void showProgress(boolean shouldShow) {
<span class="nc" id="L392">        callback.showProgress(shouldShow);</span>
<span class="nc" id="L393">    }</span>

    @Override
    public void onImageValidationSuccess() {
<span class="nc" id="L397">        callback.onNextButtonClicked(callback.getIndexInViewFlipper(this));</span>
<span class="nc" id="L398">    }</span>

    /**
     * This method gets called whenever the next/previous button is pressed
     */
    @Override
    protected void onBecameVisible() {
<span class="nc" id="L405">        super.onBecameVisible();</span>
<span class="nc" id="L406">        presenter.fetchTitleAndDescription(callback.getIndexInViewFlipper(this));</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (showNearbyFound) {</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">            if (UploadActivity.nearbyPopupAnswers.containsKey(nearbyPlace)) {</span>
<span class="nc" id="L409">                final boolean response = UploadActivity.nearbyPopupAnswers.get(nearbyPlace);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                if (response) {</span>
<span class="nc" id="L411">                    presenter.onUserConfirmedUploadIsOfPlace(nearbyPlace,</span>
<span class="nc" id="L412">                        callback.getIndexInViewFlipper(this));</span>
                }
<span class="nc" id="L414">            } else {</span>
<span class="nc" id="L415">                showNearbyPlaceFound(nearbyPlace);</span>
            }
<span class="nc" id="L417">            showNearbyFound = false;</span>
        }
<span class="nc" id="L419">    }</span>

    @Override
    public void showMessage(int stringResourceId, int colorResourceId) {
<span class="nc" id="L423">        ViewUtil.showLongToast(getContext(), stringResourceId);</span>
<span class="nc" id="L424">    }</span>

    @Override
    public void showMessage(String message, int colorResourceId) {
<span class="nc" id="L428">        ViewUtil.showLongToast(getContext(), message);</span>
<span class="nc" id="L429">    }</span>

    @Override
    public void showDuplicatePicturePopup(UploadItem uploadItem) {
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (defaultKvStore.getBoolean(&quot;showDuplicatePicturePopup&quot;, true)) {</span>
<span class="nc" id="L434">            String uploadTitleFormat = getString(R.string.upload_title_duplicate);</span>
<span class="nc" id="L435">            View checkBoxView = View</span>
<span class="nc" id="L436">                .inflate(getActivity(), R.layout.nearby_permission_dialog, null);</span>
<span class="nc" id="L437">            CheckBox checkBox = (CheckBox) checkBoxView.findViewById(R.id.never_ask_again);</span>
<span class="nc" id="L438">            checkBox.setOnCheckedChangeListener((buttonView, isChecked) -&gt; {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                if (isChecked) {</span>
<span class="nc" id="L440">                    defaultKvStore.putBoolean(&quot;showDuplicatePicturePopup&quot;, false);</span>
                }
<span class="nc" id="L442">            });</span>
<span class="nc" id="L443">            DialogUtil.showAlertDialog(getActivity(),</span>
<span class="nc" id="L444">                getString(R.string.duplicate_file_name),</span>
<span class="nc" id="L445">                String.format(Locale.getDefault(),</span>
                    uploadTitleFormat,
<span class="nc" id="L447">                    uploadItem.getFileName()),</span>
<span class="nc" id="L448">                getString(R.string.upload),</span>
<span class="nc" id="L449">                getString(R.string.cancel),</span>
                () -&gt; {
<span class="nc" id="L451">                    uploadItem.setImageQuality(ImageUtils.IMAGE_KEEP);</span>
<span class="nc" id="L452">                    onImageValidationSuccess();</span>
<span class="nc" id="L453">                }, null,</span>
                checkBoxView,
                false);
<span class="nc" id="L456">        } else {</span>
<span class="nc" id="L457">            uploadItem.setImageQuality(ImageUtils.IMAGE_KEEP);</span>
<span class="nc" id="L458">            onNextButtonClicked();</span>
        }
<span class="nc" id="L460">    }</span>

    @Override
    public void showBadImagePopup(Integer errorCode,
        UploadItem uploadItem) {
<span class="nc" id="L465">        String errorMessageForResult = getErrorMessageForResult(getContext(), errorCode);</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (!StringUtils.isBlank(errorMessageForResult)) {</span>
<span class="nc" id="L467">            DialogUtil.showAlertDialog(getActivity(),</span>
<span class="nc" id="L468">                getString(R.string.upload_problem_image),</span>
                errorMessageForResult,
<span class="nc" id="L470">                getString(R.string.upload),</span>
<span class="nc" id="L471">                getString(R.string.cancel),</span>
                () -&gt; {
                    /*
                        User skipped the warning of low quality image, so we call
                        onImageValidationSuccess rather than onNextButtonClicked to avoid showing
                        other warning popups again.
                    */

                    // validate image only when same file name error does not occur
                    // show the same file name error if exists.
<span class="nc bnc" id="L481" title="All 2 branches missed.">                    if ((errorCode &amp; FILE_NAME_EXISTS) == 0) {</span>
<span class="nc" id="L482">                        uploadItem.setImageQuality(ImageUtils.IMAGE_KEEP);</span>
<span class="nc" id="L483">                        onImageValidationSuccess();</span>
                    }
<span class="nc" id="L485">                },</span>
<span class="nc" id="L486">                () -&gt; deleteThisPicture()</span>
            );
        }
        //If the error message is null, we will probably not show anything
<span class="nc" id="L490">    }</span>

    @Override
    public void showConnectionErrorPopup() {
<span class="nc" id="L494">        DialogUtil.showAlertDialog(getActivity(),</span>
<span class="nc" id="L495">            getString(R.string.upload_connection_error_alert_title),</span>
<span class="nc" id="L496">            getString(R.string.upload_connection_error_alert_detail), getString(R.string.ok),</span>
<span class="nc" id="L497">            () -&gt; {}, true);</span>
<span class="nc" id="L498">    }</span>

    @Override
    public void showExternalMap(final UploadItem uploadItem) {
<span class="nc" id="L502">        goToLocationPickerActivity(uploadItem);</span>
<span class="nc" id="L503">    }</span>

    /**
     * Launches the image editing activity to edit the specified UploadItem.
     *
     * @param uploadItem The UploadItem to be edited.
     *
     * This method is called to start the image editing activity for a specific UploadItem.
     * It sets the UploadItem as the currently editable item, creates an intent to launch the
     * EditActivity, and passes the image file path as an extra in the intent. The activity
     * is started with a request code, allowing the result to be handled in onActivityResult.
     */
    @Override
    public void showEditActivity(UploadItem uploadItem) {
<span class="nc" id="L517">        editableUploadItem = uploadItem;</span>
<span class="nc" id="L518">        Intent intent = new Intent(getContext(), EditActivity.class);</span>
<span class="nc" id="L519">        intent.putExtra(&quot;image&quot;, uploadableFile.getFilePath().toString());</span>
<span class="nc" id="L520">        startActivityForResult(intent, REQUEST_CODE_FOR_EDIT_ACTIVITY);</span>
<span class="nc" id="L521">    }</span>

    /**
     * Start Location picker activity. Show the location first then user can modify it by clicking
     * modify location button.
     * @param uploadItem current upload item
     */
    private void goToLocationPickerActivity(final UploadItem uploadItem) {

<span class="nc" id="L530">        editableUploadItem = uploadItem;</span>
<span class="nc" id="L531">        double defaultLatitude = 37.773972;</span>
<span class="nc" id="L532">        double defaultLongitude = -122.431297;</span>
<span class="nc" id="L533">        double defaultZoom = 16.0;</span>

        /* Retrieve image location from EXIF if present or
           check if user has provided location while using the in-app camera.
           Use location of last UploadItem if none of them is available */
<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (uploadItem.getGpsCoords() != null &amp;&amp; uploadItem.getGpsCoords()</span>
<span class="nc bnc" id="L539" title="All 4 branches missed.">            .getDecLatitude() != 0.0 &amp;&amp; uploadItem.getGpsCoords().getDecLongitude() != 0.0) {</span>
<span class="nc" id="L540">            defaultLatitude = uploadItem.getGpsCoords()</span>
<span class="nc" id="L541">                .getDecLatitude();</span>
<span class="nc" id="L542">            defaultLongitude = uploadItem.getGpsCoords().getDecLongitude();</span>
<span class="nc" id="L543">            defaultZoom = uploadItem.getGpsCoords().getZoomLevel();</span>
<span class="nc" id="L544">            startActivityForResult(new LocationPicker.IntentBuilder()</span>
<span class="nc" id="L545">                .defaultLocation(new CameraPosition.Builder()</span>
<span class="nc" id="L546">                    .target(</span>
                        new com.mapbox.mapboxsdk.geometry.LatLng(defaultLatitude, defaultLongitude))
<span class="nc" id="L548">                    .zoom(defaultZoom).build())</span>
<span class="nc" id="L549">                .activityKey(&quot;UploadActivity&quot;)</span>
<span class="nc" id="L550">                .build(getActivity()), REQUEST_CODE);</span>
        } else {
<span class="nc bnc" id="L552" title="All 2 branches missed.">            if (defaultKvStore.getString(LAST_LOCATION) != null) {</span>
<span class="nc" id="L553">                final String[] locationLatLng</span>
<span class="nc" id="L554">                    = defaultKvStore.getString(LAST_LOCATION).split(&quot;,&quot;);</span>
<span class="nc" id="L555">                defaultLatitude = Double.parseDouble(locationLatLng[0]);</span>
<span class="nc" id="L556">                defaultLongitude = Double.parseDouble(locationLatLng[1]);</span>
            }
<span class="nc bnc" id="L558" title="All 2 branches missed.">            if (defaultKvStore.getString(LAST_ZOOM) != null) {</span>
<span class="nc" id="L559">                defaultZoom = Double.parseDouble(defaultKvStore.getString(LAST_ZOOM));</span>
            }
<span class="nc" id="L561">            startActivityForResult(new LocationPicker.IntentBuilder()</span>
<span class="nc" id="L562">                .defaultLocation(new CameraPosition.Builder()</span>
<span class="nc" id="L563">                    .target(</span>
                        new com.mapbox.mapboxsdk.geometry.LatLng(defaultLatitude, defaultLongitude))
<span class="nc" id="L565">                    .zoom(defaultZoom).build())</span>
<span class="nc" id="L566">                .activityKey(&quot;NoLocationUploadActivity&quot;)</span>
<span class="nc" id="L567">                .build(getActivity()), REQUEST_CODE);</span>
        }
<span class="nc" id="L569">    }</span>

    /**
     * Get the coordinates and update the existing coordinates.
     * @param requestCode code of request
     * @param resultCode code of result
     * @param data intent
     */
    @Override
    public void onActivityResult(final int requestCode, final int resultCode,
        @Nullable final Intent data) {
<span class="nc" id="L580">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L581" title="All 4 branches missed.">        if (requestCode == REQUEST_CODE &amp;&amp; resultCode == RESULT_OK) {</span>

<span class="nc bnc" id="L583" title="All 2 branches missed.">            assert data != null;</span>
<span class="nc" id="L584">            final CameraPosition cameraPosition = LocationPicker.getCameraPosition(data);</span>

<span class="nc bnc" id="L586" title="All 2 branches missed.">            if (cameraPosition != null) {</span>

<span class="nc" id="L588">                final String latitude = String.valueOf(cameraPosition.target.getLatitude());</span>
<span class="nc" id="L589">                final String longitude = String.valueOf(cameraPosition.target.getLongitude());</span>
<span class="nc" id="L590">                final double zoom = cameraPosition.zoom;</span>

<span class="nc" id="L592">                editLocation(latitude, longitude, zoom);</span>
                /*
                       If isMissingLocationDialog is true, it means that the user has already tapped the
                       &quot;Next&quot; button, so go directly to the next step.
                 */
<span class="nc bnc" id="L597" title="All 2 branches missed.">                if (isMissingLocationDialog) {</span>
<span class="nc" id="L598">                    isMissingLocationDialog = false;</span>
<span class="nc" id="L599">                    onNextButtonClicked();</span>
                }
            }
        }
<span class="nc bnc" id="L603" title="All 4 branches missed.">        if (requestCode == REQUEST_CODE_FOR_EDIT_ACTIVITY &amp;&amp; resultCode == RESULT_OK) {</span>
<span class="nc" id="L604">            String result = data.getStringExtra(&quot;editedImageFilePath&quot;);</span>

<span class="nc bnc" id="L606" title="All 2 branches missed.">            if (Objects.equals(result, &quot;Error&quot;)) {</span>
<span class="nc" id="L607">                Timber.e(&quot;Error in rotating image&quot;);</span>
<span class="nc" id="L608">                return;</span>
            }
            try {
<span class="nc" id="L611">                photoViewBackgroundImage.setImageURI(Uri.fromFile(new File(result)));</span>
<span class="nc" id="L612">                editableUploadItem.setContentUri(Uri.fromFile(new File(result)));</span>
<span class="nc" id="L613">                callback.changeThumbnail(callback.getIndexInViewFlipper(this),</span>
                    result);
<span class="nc" id="L615">            } catch (Exception e) {</span>
<span class="nc" id="L616">                Timber.e(e);</span>
<span class="nc" id="L617">            }</span>
<span class="nc" id="L618">        }</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">        else if (requestCode == REQUEST_CODE_FOR_VOICE_INPUT) {</span>
<span class="nc bnc" id="L620" title="All 4 branches missed.">            if (resultCode == RESULT_OK &amp;&amp; data != null) {</span>
<span class="nc" id="L621">                ArrayList&lt;String&gt; result = data.getStringArrayListExtra(</span>
                    RecognizerIntent.EXTRA_RESULTS);
<span class="nc" id="L623">                uploadMediaDetailAdapter.handleSpeechResult(result.get(0));</span>
<span class="nc" id="L624">            }else {</span>
<span class="nc" id="L625">                Timber.e(&quot;Error %s&quot;, resultCode);</span>
            }
        }
<span class="nc" id="L628">    }</span>

    /**
     * Update the old coordinates with new one
     * @param latitude new latitude
     * @param longitude new longitude
     */
    public void editLocation(final String latitude, final String longitude, final double zoom) {

<span class="nc" id="L637">        editableUploadItem.getGpsCoords().setDecLatitude(Double.parseDouble(latitude));</span>
<span class="nc" id="L638">        editableUploadItem.getGpsCoords().setDecLongitude(Double.parseDouble(longitude));</span>
<span class="nc" id="L639">        editableUploadItem.getGpsCoords().setDecimalCoords(latitude + &quot;|&quot; + longitude);</span>
<span class="nc" id="L640">        editableUploadItem.getGpsCoords().setImageCoordsExists(true);</span>
<span class="nc" id="L641">        editableUploadItem.getGpsCoords().setZoomLevel(zoom);</span>

        // Replace the map icon using the one with a green tick
<span class="nc" id="L644">        Drawable mapTick = getResources().getDrawable(R.drawable.ic_map_available_20dp);</span>
<span class="nc" id="L645">        locationImageView.setImageDrawable(mapTick);</span>
<span class="nc" id="L646">        locationTextView.setText(R.string.edit_location);</span>

<span class="nc" id="L648">        Toast.makeText(getContext(), &quot;Location Updated&quot;, Toast.LENGTH_LONG).show();</span>

<span class="nc" id="L650">    }</span>

    @Override
    public void updateMediaDetails(List&lt;UploadMediaDetail&gt; uploadMediaDetails) {
<span class="nc" id="L654">        uploadMediaDetailAdapter.setItems(uploadMediaDetails);</span>
<span class="nc bnc" id="L655" title="All 4 branches missed.">        showNearbyFound =</span>
            showNearbyFound &amp;&amp; (
<span class="nc bnc" id="L657" title="All 2 branches missed.">                uploadMediaDetails == null || uploadMediaDetails.isEmpty()</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                    || listContainsEmptyDetails(</span>
                    uploadMediaDetails));
<span class="nc" id="L660">    }</span>

    /**
     * if the media details that come in here are empty
     * (empty caption AND empty description, with caption being the decider here)
     * this method allows usage of nearby place caption and description if any
     * else it takes the media details saved in prior for this picture
     * @param uploadMediaDetails saved media details,
     *                           ex: in case when &quot;copy to subsequent media&quot; button is clicked
     *                           for a previous image
     * @return boolean whether the details are empty or not
     */
    private boolean listContainsEmptyDetails(List&lt;UploadMediaDetail&gt; uploadMediaDetails) {
<span class="nc bnc" id="L673" title="All 2 branches missed.">        for (UploadMediaDetail uploadDetail: uploadMediaDetails) {</span>
<span class="nc bnc" id="L674" title="All 4 branches missed.">            if (!TextUtils.isEmpty(uploadDetail.getCaptionText()) &amp;&amp; !TextUtils.isEmpty(uploadDetail.getDescriptionText())) {</span>
<span class="nc" id="L675">                return false;</span>
            }
<span class="nc" id="L677">        }</span>
<span class="nc" id="L678">        return true;</span>
    }

    /**
     * Showing dialog for adding location
     *
     * @param onSkipClicked proceed for verifying image quality
     */
    @Override
    public void displayAddLocationDialog(final Runnable onSkipClicked) {
<span class="nc" id="L688">        isMissingLocationDialog = true;</span>
<span class="nc" id="L689">        DialogUtil.showAlertDialog(Objects.requireNonNull(getActivity()),</span>
<span class="nc" id="L690">            getString(R.string.no_location_found_title),</span>
<span class="nc" id="L691">            getString(R.string.no_location_found_message),</span>
<span class="nc" id="L692">            getString(R.string.add_location),</span>
<span class="nc" id="L693">            getString(R.string.skip_login),</span>
            this::onIbMapClicked,
            onSkipClicked);
<span class="nc" id="L696">    }</span>

    private void deleteThisPicture() {
<span class="nc" id="L699">        callback.deletePictureAtIndex(callback.getIndexInViewFlipper(this));</span>
<span class="nc" id="L700">    }</span>

    @Override
    public void onDestroyView() {
<span class="nc" id="L704">        super.onDestroyView();</span>
<span class="nc" id="L705">        presenter.onDetachView();</span>
<span class="nc" id="L706">    }</span>

    @OnClick(R.id.ll_container_title)
    public void onLlContainerTitleClicked() {
<span class="nc bnc" id="L710" title="All 2 branches missed.">        expandCollapseLlMediaDetail(!isExpanded);</span>
<span class="nc" id="L711">    }</span>

    /**
     * show hide media detail based on
     * @param shouldExpand
     */
    private void expandCollapseLlMediaDetail(boolean shouldExpand){
<span class="nc bnc" id="L718" title="All 2 branches missed.">        llContainerMediaDetail.setVisibility(shouldExpand ? View.VISIBLE : View.GONE);</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">        isExpanded = !isExpanded;</span>
<span class="nc" id="L720">        ibExpandCollapse.setRotation(ibExpandCollapse.getRotation() + 180);</span>
<span class="nc" id="L721">    }</span>

    @OnClick(R.id.ll_location_status) public void onIbMapClicked() {
<span class="nc" id="L724">        presenter.onMapIconClicked(callback.getIndexInViewFlipper(this));</span>
<span class="nc" id="L725">    }</span>

    @Override
    public void onPrimaryCaptionTextChange(boolean isNotEmpty) {
<span class="nc" id="L729">        btnCopyToSubsequentMedia.setEnabled(isNotEmpty);</span>
<span class="nc" id="L730">        btnCopyToSubsequentMedia.setClickable(isNotEmpty);</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">        btnCopyToSubsequentMedia.setAlpha(isNotEmpty ? 1.0f : 0.5f);</span>
<span class="nc" id="L732">        btnNext.setEnabled(isNotEmpty);</span>
<span class="nc" id="L733">        btnNext.setClickable(isNotEmpty);</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">        btnNext.setAlpha(isNotEmpty ? 1.0f : 0.5f);</span>
<span class="nc" id="L735">    }</span>

    /**
     * Adds new language item to RecyclerView
     */
    @Override
    public void addLanguage() {
<span class="nc" id="L742">        UploadMediaDetail uploadMediaDetail = new UploadMediaDetail();</span>
<span class="nc" id="L743">        uploadMediaDetail.setManuallyAdded(true);//This was manually added by the user</span>
<span class="nc" id="L744">        uploadMediaDetailAdapter.addDescription(uploadMediaDetail);</span>
<span class="nc" id="L745">        rvDescriptions.smoothScrollToPosition(uploadMediaDetailAdapter.getItemCount()-1);</span>
<span class="nc" id="L746">    }</span>

    public interface UploadMediaDetailFragmentCallback extends Callback {

        void deletePictureAtIndex(int index);

        void changeThumbnail(int index, String uri);
    }


    @OnClick(R.id.btn_copy_subsequent_media)
    public void onButtonCopyTitleDescToSubsequentMedia(){
<span class="nc" id="L758">        presenter.copyTitleAndDescriptionToSubsequentMedia(callback.getIndexInViewFlipper(this));</span>
<span class="nc" id="L759">        Toast.makeText(getContext(), getResources().getString(R.string.copied_successfully), Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L760">    }</span>

    @Override
    public void onSaveInstanceState(final Bundle outState) {
<span class="nc" id="L764">        super.onSaveInstanceState(outState);</span>

<span class="nc bnc" id="L766" title="All 2 branches missed.">        if(uploadableFile!=null){</span>
<span class="nc" id="L767">            outState.putParcelable(UPLOADABLE_FILE,uploadableFile);</span>
        }
<span class="nc bnc" id="L769" title="All 2 branches missed.">        if(uploadMediaDetailAdapter!=null){</span>
<span class="nc" id="L770">            outState.putParcelableArrayList(UPLOAD_MEDIA_DETAILS,</span>
<span class="nc" id="L771">                (ArrayList&lt;? extends Parcelable&gt;) uploadMediaDetailAdapter.getItems());</span>
        }
<span class="nc" id="L773">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>