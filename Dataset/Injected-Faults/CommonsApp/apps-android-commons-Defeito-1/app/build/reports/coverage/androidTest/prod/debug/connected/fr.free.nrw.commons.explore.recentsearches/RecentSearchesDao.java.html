<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecentSearchesDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.explore.recentsearches</a> &gt; <span class="el_source">RecentSearchesDao.java</span></div><h1>RecentSearchesDao.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.explore.recentsearches;

import android.content.ContentProviderClient;
import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.os.RemoteException;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;

import fr.free.nrw.commons.explore.models.RecentSearch;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Provider;

import timber.log.Timber;

/**
 * This class doesn't execute queries in database directly instead it contains the logic behind
 * inserting, deleting, searching data from recent searches database.
 **/
public class RecentSearchesDao {

    private final Provider&lt;ContentProviderClient&gt; clientProvider;

    @Inject
<span class="nc" id="L32">    public RecentSearchesDao(@Named(&quot;recentsearch&quot;) Provider&lt;ContentProviderClient&gt; clientProvider) {</span>
<span class="nc" id="L33">        this.clientProvider = clientProvider;</span>
<span class="nc" id="L34">    }</span>

    /**
     * This method is called on click of media/ categories for storing them in recent searches
     * @param recentSearch a recent searches object that is to be added in SqLite DB
     */
    public void save(RecentSearch recentSearch) {
<span class="nc" id="L41">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L43" title="All 2 branches missed.">            if (recentSearch.getContentUri() == null) {</span>
<span class="nc" id="L44">                recentSearch.setContentUri(db.insert(RecentSearchesContentProvider.BASE_URI, toContentValues(recentSearch)));</span>
            } else {
<span class="nc" id="L46">                db.update(recentSearch.getContentUri(), toContentValues(recentSearch), null, null);</span>
            }
<span class="nc" id="L48">        } catch (RemoteException e) {</span>
<span class="nc" id="L49">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc" id="L51">            db.release();</span>
        }
<span class="nc" id="L53">    }</span>

    /**
     * This method is called on confirmation of delete recent searches.
     * It deletes all recent searches from the database
     */
    public void deleteAll() {
<span class="nc" id="L60">        Cursor cursor = null;</span>
<span class="nc" id="L61">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc" id="L63">            cursor = db.query(</span>
                    RecentSearchesContentProvider.BASE_URI,
                    Table.ALL_FIELDS,
                    null,
                    new String[]{},
                    Table.COLUMN_LAST_USED + &quot; DESC&quot;
            );
<span class="nc bnc" id="L70" title="All 4 branches missed.">            while (cursor != null &amp;&amp; cursor.moveToNext()) {</span>
                try {
<span class="nc" id="L72">                    RecentSearch recentSearch = find(fromCursor(cursor).getQuery());</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">                    if (recentSearch.getContentUri() == null) {</span>
<span class="nc" id="L74">                        throw new RuntimeException(&quot;tried to delete item with no content URI&quot;);</span>
                    } else {
<span class="nc" id="L76">                        Timber.d(&quot;QUERY_NAME %s - delete tried&quot;, recentSearch.getContentUri());</span>
<span class="nc" id="L77">                        db.delete(recentSearch.getContentUri(), null, null);</span>
<span class="nc" id="L78">                        Timber.d(&quot;QUERY_NAME %s - query deleted&quot;, recentSearch.getQuery());</span>
                    }
<span class="nc" id="L80">                } catch (RemoteException e) {</span>
<span class="nc" id="L81">                    Timber.e(e, &quot;query deleted&quot;);</span>
<span class="nc" id="L82">                    throw new RuntimeException(e);</span>
                } finally {
<span class="nc" id="L84">                    db.release();</span>
<span class="nc" id="L85">                }</span>
            }
<span class="nc" id="L87">        } catch (RemoteException e) {</span>
<span class="nc" id="L88">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (cursor != null) {</span>
<span class="nc" id="L91">                cursor.close();</span>
            }
        }
<span class="nc" id="L94">    }</span>

    /**
     * Deletes a recent search from the database
     */
    public void delete(RecentSearch recentSearch) {

<span class="nc" id="L101">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (recentSearch.getContentUri() == null) {</span>
<span class="nc" id="L104">                throw new RuntimeException(&quot;tried to delete item with no content URI&quot;);</span>
            } else {
<span class="nc" id="L106">                db.delete(recentSearch.getContentUri(), null, null);</span>
            }
<span class="nc" id="L108">        } catch (RemoteException e) {</span>
<span class="nc" id="L109">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc" id="L111">            db.release();</span>
        }
<span class="nc" id="L113">    }</span>


    /**
     * Find persisted search query in database, based on its name.
     * @param name Search query  Ex- &quot;butterfly&quot;
     * @return recently searched query from database, or null if not found
     */
    @Nullable
    public RecentSearch find(String name) {
<span class="nc" id="L123">        Cursor cursor = null;</span>
<span class="nc" id="L124">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc" id="L126">            cursor = db.query(</span>
                    RecentSearchesContentProvider.BASE_URI,
                    Table.ALL_FIELDS,
                    Table.COLUMN_NAME + &quot;=?&quot;,
                    new String[]{name},
                    null);
<span class="nc bnc" id="L132" title="All 4 branches missed.">            if (cursor != null &amp;&amp; cursor.moveToFirst()) {</span>
<span class="nc" id="L133">                return fromCursor(cursor);</span>
            }
<span class="nc" id="L135">        } catch (RemoteException e) {</span>
            // This feels lazy, but to hell with checked exceptions. :)
<span class="nc" id="L137">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (cursor != null) {</span>
<span class="nc" id="L140">                cursor.close();</span>
            }
<span class="nc" id="L142">            db.release();</span>
        }
<span class="nc" id="L144">        return null;</span>
    }

    /**
     * Retrieve recently-searched queries, ordered by descending date.
     * @return a list containing recent searches
     */
    @NonNull
    public List&lt;String&gt; recentSearches(int limit) {
<span class="nc" id="L153">        List&lt;String&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L154">        Cursor cursor = null;</span>
<span class="nc" id="L155">        ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc" id="L157">            cursor = db.query( RecentSearchesContentProvider.BASE_URI, Table.ALL_FIELDS,</span>
                    null, new String[]{}, Table.COLUMN_LAST_USED + &quot; DESC&quot;);
            // fixme add a limit on the original query instead of falling out of the loop?
<span class="nc bnc" id="L160" title="All 6 branches missed.">            while (cursor != null &amp;&amp; cursor.moveToNext() &amp;&amp; cursor.getPosition() &lt; limit) {</span>
<span class="nc" id="L161">                items.add(fromCursor(cursor).getQuery());</span>
            }
<span class="nc" id="L163">        } catch (RemoteException e) {</span>
<span class="nc" id="L164">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (cursor != null) {</span>
<span class="nc" id="L167">                cursor.close();</span>
            }
<span class="nc" id="L169">            db.release();</span>
        }
<span class="nc" id="L171">        return items;</span>
    }


    /**
     * It creates an Recent Searches object from data stored in the SQLite DB by using cursor
     * @param cursor
     * @return RecentSearch object
     */
    @NonNull
    RecentSearch fromCursor(Cursor cursor) {
        // Hardcoding column positions!
<span class="nc" id="L183">        return new RecentSearch(</span>
<span class="nc" id="L184">                RecentSearchesContentProvider.uriForId(cursor.getInt(cursor.getColumnIndex(Table.COLUMN_ID))),</span>
<span class="nc" id="L185">                cursor.getString(cursor.getColumnIndex(Table.COLUMN_NAME)),</span>
<span class="nc" id="L186">                new Date(cursor.getLong(cursor.getColumnIndex(Table.COLUMN_LAST_USED)))</span>
        );
    }

    /**
     * This class contains the database table architechture for recent searches,
     * It also contains queries and logic necessary to the create, update, delete this table.
     */
    private ContentValues toContentValues(RecentSearch recentSearch) {
<span class="nc" id="L195">        ContentValues cv = new ContentValues();</span>
<span class="nc" id="L196">        cv.put(RecentSearchesDao.Table.COLUMN_NAME, recentSearch.getQuery());</span>
<span class="nc" id="L197">        cv.put(RecentSearchesDao.Table.COLUMN_LAST_USED, recentSearch.getLastSearched().getTime());</span>
<span class="nc" id="L198">        return cv;</span>
    }

    /**
     * This class contains the database table architechture for recent searches,
     * It also contains queries and logic necessary to the create, update, delete this table.
     */
<span class="nc" id="L205">    public static class Table {</span>
        public static final String TABLE_NAME = &quot;recent_searches&quot;;
        public static final String COLUMN_ID = &quot;_id&quot;;
        static final String COLUMN_NAME = &quot;name&quot;;
        static final String COLUMN_LAST_USED = &quot;last_used&quot;;

        // NOTE! KEEP IN SAME ORDER AS THEY ARE DEFINED UP THERE. HELPS HARD CODE COLUMN INDICES.
<span class="nc" id="L212">        public static final String[] ALL_FIELDS = {</span>
                COLUMN_ID,
                COLUMN_NAME,
                COLUMN_LAST_USED,
        };

        static final String DROP_TABLE_STATEMENT = &quot;DROP TABLE IF EXISTS &quot; + TABLE_NAME;

        static final String CREATE_TABLE_STATEMENT = &quot;CREATE TABLE &quot; + TABLE_NAME + &quot; (&quot;
                + COLUMN_ID + &quot; INTEGER PRIMARY KEY,&quot;
                + COLUMN_NAME + &quot; STRING,&quot;
                + COLUMN_LAST_USED + &quot; INTEGER&quot;
                + &quot;);&quot;;

        /**
         * This method creates a RecentSearchesTable in SQLiteDatabase
         * @param db SQLiteDatabase
         */
        public static void onCreate(SQLiteDatabase db) {
<span class="nc" id="L231">            db.execSQL(CREATE_TABLE_STATEMENT);</span>
<span class="nc" id="L232">        }</span>

        /**
         * This method deletes RecentSearchesTable from SQLiteDatabase
         * @param db SQLiteDatabase
         */
        public static void onDelete(SQLiteDatabase db) {
<span class="nc" id="L239">            db.execSQL(DROP_TABLE_STATEMENT);</span>
<span class="nc" id="L240">            onCreate(db);</span>
<span class="nc" id="L241">        }</span>

        /**
         * This method is called on migrating from a older version to a newer version
         * @param db SQLiteDatabase
         * @param from Version from which we are migrating
         * @param to Version to which we are migrating
         */
        public static void onUpdate(SQLiteDatabase db, int from, int to) {
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (from == to) {</span>
<span class="nc" id="L251">                return;</span>
            }
<span class="nc bnc" id="L253" title="All 2 branches missed.">            if (from &lt; 6) {</span>
                // doesn't exist yet
<span class="nc" id="L255">                from++;</span>
<span class="nc" id="L256">                onUpdate(db, from, to);</span>
<span class="nc" id="L257">                return;</span>
            }
<span class="nc bnc" id="L259" title="All 2 branches missed.">            if (from == 6) {</span>
                // table added in version 7
<span class="nc" id="L261">                onCreate(db);</span>
<span class="nc" id="L262">                from++;</span>
<span class="nc" id="L263">                onUpdate(db, from, to);</span>
<span class="nc" id="L264">                return;</span>
            }
<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (from == 7) {</span>
<span class="nc" id="L267">                from++;</span>
<span class="nc" id="L268">                onUpdate(db, from, to);</span>
<span class="nc" id="L269">                return;</span>
            }
<span class="nc" id="L271">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>