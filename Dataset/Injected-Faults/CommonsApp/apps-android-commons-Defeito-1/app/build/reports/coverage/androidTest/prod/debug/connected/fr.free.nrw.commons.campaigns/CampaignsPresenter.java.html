<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CampaignsPresenter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.campaigns</a> &gt; <span class="el_source">CampaignsPresenter.java</span></div><h1>CampaignsPresenter.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.campaigns;

import android.annotation.SuppressLint;

import fr.free.nrw.commons.campaigns.models.Campaign;
import java.text.ParseException;
import java.util.Collections;
import java.util.Date;
import java.util.List;

import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;

import fr.free.nrw.commons.BasePresenter;
import fr.free.nrw.commons.mwapi.OkHttpJsonApiClient;
import fr.free.nrw.commons.utils.CommonsDateUtil;
import io.reactivex.Scheduler;
import io.reactivex.Single;
import io.reactivex.SingleObserver;
import io.reactivex.disposables.Disposable;
import timber.log.Timber;

import static fr.free.nrw.commons.di.CommonsApplicationModule.IO_THREAD;
import static fr.free.nrw.commons.di.CommonsApplicationModule.MAIN_THREAD;

/**
 * The presenter for the campaigns view, fetches the campaigns from the api and informs the view on
 * success and error
 */
@Singleton
public class CampaignsPresenter implements BasePresenter&lt;ICampaignsView&gt; {
    private final OkHttpJsonApiClient okHttpJsonApiClient;
    private final Scheduler mainThreadScheduler;
    private final Scheduler ioScheduler;

    private ICampaignsView view;
    private Disposable disposable;
    private Campaign campaign;

    @Inject
<span class="nc" id="L42">    public CampaignsPresenter(OkHttpJsonApiClient okHttpJsonApiClient, @Named(IO_THREAD)Scheduler ioScheduler, @Named(MAIN_THREAD)Scheduler mainThreadScheduler) {</span>
<span class="nc" id="L43">        this.okHttpJsonApiClient = okHttpJsonApiClient;</span>
<span class="nc" id="L44">        this.mainThreadScheduler=mainThreadScheduler;</span>
<span class="nc" id="L45">        this.ioScheduler=ioScheduler;</span>
<span class="nc" id="L46">    }</span>

    @Override
    public void onAttachView(ICampaignsView view) {
<span class="nc" id="L50">        this.view = view;</span>
<span class="nc" id="L51">    }</span>

    @Override public void onDetachView() {
<span class="nc" id="L54">        this.view = null;</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (disposable != null) {</span>
<span class="nc" id="L56">            disposable.dispose();</span>
        }
<span class="nc" id="L58">    }</span>

    /**
     * make the api call to fetch the campaigns
     */
    @SuppressLint(&quot;CheckResult&quot;)
    public void getCampaigns() {
<span class="nc bnc" id="L65" title="All 4 branches missed.">        if (view != null &amp;&amp; okHttpJsonApiClient != null) {</span>
            //If we already have a campaign, lets not make another call
<span class="nc bnc" id="L67" title="All 2 branches missed.">            if (this.campaign != null) {</span>
<span class="nc" id="L68">                view.showCampaigns(campaign);</span>
<span class="nc" id="L69">                return;</span>
            }
<span class="nc" id="L71">            Single&lt;CampaignResponseDTO&gt; campaigns = okHttpJsonApiClient.getCampaigns();</span>
<span class="nc" id="L72">            campaigns.observeOn(mainThreadScheduler)</span>
<span class="nc" id="L73">                .subscribeOn(ioScheduler)</span>
<span class="nc" id="L74">                .subscribeWith(new SingleObserver&lt;CampaignResponseDTO&gt;() {</span>

                    @Override public void onSubscribe(Disposable d) {
<span class="nc" id="L77">                        disposable = d;</span>
<span class="nc" id="L78">                    }</span>

                    @Override public void onSuccess(CampaignResponseDTO campaignResponseDTO) {
<span class="nc" id="L81">                        List&lt;Campaign&gt; campaigns = campaignResponseDTO.getCampaigns();</span>
<span class="nc bnc" id="L82" title="All 4 branches missed.">                        if (campaigns == null || campaigns.isEmpty()) {</span>
<span class="nc" id="L83">                            Timber.e(&quot;The campaigns list is empty&quot;);</span>
<span class="nc" id="L84">                            view.showCampaigns(null);</span>
<span class="nc" id="L85">                            return;</span>
                        }
<span class="nc" id="L87">                        Collections.sort(campaigns, (campaign, t1) -&gt; {</span>
                            Date date1, date2;
                            try {

<span class="nc" id="L91">                                date1 = CommonsDateUtil.getIso8601DateFormatShort().parse(campaign.getStartDate());</span>
<span class="nc" id="L92">                                date2 = CommonsDateUtil.getIso8601DateFormatShort().parse(t1.getStartDate());</span>
<span class="nc" id="L93">                            } catch (ParseException e) {</span>
<span class="nc" id="L94">                                e.printStackTrace();</span>
<span class="nc" id="L95">                                return -1;</span>
<span class="nc" id="L96">                            }</span>
<span class="nc" id="L97">                            return date1.compareTo(date2);</span>
                        });
                        Date campaignEndDate, campaignStartDate;
<span class="nc" id="L100">                        Date currentDate = new Date();</span>
                        try {
<span class="nc bnc" id="L102" title="All 2 branches missed.">                            for (Campaign aCampaign : campaigns) {</span>
<span class="nc" id="L103">                                campaignEndDate = CommonsDateUtil.getIso8601DateFormatShort().parse(aCampaign.getEndDate());</span>
<span class="nc" id="L104">                                campaignStartDate = CommonsDateUtil.getIso8601DateFormatShort().parse(aCampaign.getStartDate());</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                                if (campaignEndDate.compareTo(currentDate) &gt;= 0</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                                    &amp;&amp; campaignStartDate.compareTo(currentDate) &lt;= 0) {</span>
<span class="nc" id="L107">                                    campaign = aCampaign;</span>
<span class="nc" id="L108">                                    break;</span>
                                }
<span class="nc" id="L110">                            }</span>
<span class="nc" id="L111">                        } catch (ParseException e) {</span>
<span class="nc" id="L112">                            e.printStackTrace();</span>
<span class="nc" id="L113">                        }</span>
<span class="nc" id="L114">                        view.showCampaigns(campaign);</span>
<span class="nc" id="L115">                    }</span>

                    @Override public void onError(Throwable e) {
<span class="nc" id="L118">                        Timber.e(e, &quot;could not fetch campaigns&quot;);</span>
<span class="nc" id="L119">                    }</span>
                });
        }
<span class="nc" id="L122">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>