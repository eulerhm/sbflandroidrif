<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FilePicker.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.filepicker</a> &gt; <span class="el_source">FilePicker.java</span></div><h1>FilePicker.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.filepicker;

import static fr.free.nrw.commons.filepicker.PickedFiles.singleFileList;

import android.app.Activity;
import android.content.ClipData;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.content.pm.ResolveInfo;
import android.net.Uri;
import android.provider.MediaStore;
import android.text.TextUtils;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.preference.PreferenceManager;
import fr.free.nrw.commons.customselector.model.Image;
import fr.free.nrw.commons.customselector.ui.selector.CustomSelectorActivity;
import java.io.File;
import java.io.IOException;
import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.List;

<span class="nc" id="L26">public class FilePicker implements Constants {</span>

    private static final String KEY_PHOTO_URI = &quot;photo_uri&quot;;
    private static final String KEY_VIDEO_URI = &quot;video_uri&quot;;
    private static final String KEY_LAST_CAMERA_PHOTO = &quot;last_photo&quot;;
    private static final String KEY_LAST_CAMERA_VIDEO = &quot;last_video&quot;;
    private static final String KEY_TYPE = &quot;type&quot;;

    /**
     * Returns the uri of the clicked image so that it can be put in MediaStore
     */
    private static Uri createCameraPictureFile(@NonNull Context context) throws IOException {
<span class="nc" id="L38">        File imagePath = PickedFiles.getCameraPicturesLocation(context);</span>
<span class="nc" id="L39">        Uri uri = PickedFiles.getUriToFile(context, imagePath);</span>
<span class="nc" id="L40">        SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(context).edit();</span>
<span class="nc" id="L41">        editor.putString(KEY_PHOTO_URI, uri.toString());</span>
<span class="nc" id="L42">        editor.putString(KEY_LAST_CAMERA_PHOTO, imagePath.toString());</span>
<span class="nc" id="L43">        editor.apply();</span>
<span class="nc" id="L44">        return uri;</span>
    }

    private static Intent createGalleryIntent(@NonNull Context context, int type,
                                              boolean openDocumentIntentPreferred) {
        // storing picked image type to shared preferences
<span class="nc" id="L50">        storeType(context, type);</span>
<span class="nc" id="L51">        return plainGalleryPickerIntent(openDocumentIntentPreferred)</span>
<span class="nc" id="L52">                .putExtra(Intent.EXTRA_ALLOW_MULTIPLE, configuration(context).allowsMultiplePickingInGallery());</span>
    }

    /**
     * CreateCustomSectorIntent, creates intent for custom selector activity.
     * @param context
     * @param type
     * @return Custom selector intent
     */
    private static Intent createCustomSelectorIntent(@NonNull Context context, int type) {
<span class="nc" id="L62">        storeType(context, type);</span>
<span class="nc" id="L63">        return new Intent(context, CustomSelectorActivity.class);</span>
    }

    private static Intent createCameraForImageIntent(@NonNull Context context, int type) {
<span class="nc" id="L67">        storeType(context, type);</span>

<span class="nc" id="L69">        Intent intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span>
        try {
<span class="nc" id="L71">            Uri capturedImageUri = createCameraPictureFile(context);</span>
            //We have to explicitly grant the write permission since Intent.setFlag works only on API Level &gt;=20
<span class="nc" id="L73">            grantWritePermission(context, intent, capturedImageUri);</span>
<span class="nc" id="L74">            intent.putExtra(MediaStore.EXTRA_OUTPUT, capturedImageUri);</span>
<span class="nc" id="L75">        } catch (Exception e) {</span>
<span class="nc" id="L76">            e.printStackTrace();</span>
<span class="nc" id="L77">        }</span>

<span class="nc" id="L79">        return intent;</span>
    }

    private static void revokeWritePermission(@NonNull Context context, Uri uri) {
<span class="nc" id="L83">        context.revokeUriPermission(uri, Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc" id="L84">    }</span>

    private static void grantWritePermission(@NonNull Context context, Intent intent, Uri uri) {
<span class="nc" id="L87">        List&lt;ResolveInfo&gt; resInfoList = context.getPackageManager().queryIntentActivities(intent, PackageManager.MATCH_DEFAULT_ONLY);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        for (ResolveInfo resolveInfo : resInfoList) {</span>
<span class="nc" id="L89">            String packageName = resolveInfo.activityInfo.packageName;</span>
<span class="nc" id="L90">            context.grantUriPermission(packageName, uri, Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc" id="L91">        }</span>
<span class="nc" id="L92">    }</span>

    private static void storeType(@NonNull Context context, int type) {
<span class="nc" id="L95">        PreferenceManager.getDefaultSharedPreferences(context).edit().putInt(KEY_TYPE, type).apply();</span>
<span class="nc" id="L96">    }</span>

    private static int restoreType(@NonNull Context context) {
<span class="nc" id="L99">        return PreferenceManager.getDefaultSharedPreferences(context).getInt(KEY_TYPE, 0);</span>
    }

    /**
     * Opens default galery or a available galleries picker if there is no default
     *
     * @param type Custom type of your choice, which will be returned with the images
     */
    public static void openGallery(Activity activity, int type, boolean openDocumentIntentPreferred) {
<span class="nc" id="L108">        Intent intent = createGalleryIntent(activity, type, openDocumentIntentPreferred);</span>
<span class="nc" id="L109">        activity.startActivityForResult(intent, RequestCodes.PICK_PICTURE_FROM_GALLERY);</span>
<span class="nc" id="L110">    }</span>

    /**
     * Opens Custom Selector
     */
    public static void openCustomSelector(Activity activity, int type) {
<span class="nc" id="L116">        Intent intent = createCustomSelectorIntent(activity, type);</span>
<span class="nc" id="L117">        activity.startActivityForResult(intent, RequestCodes.PICK_PICTURE_FROM_CUSTOM_SELECTOR);</span>
<span class="nc" id="L118">    }</span>

    /**
     * Opens the camera app to pick image clicked by user 
     */
    public static void openCameraForImage(Activity activity, int type) {
<span class="nc" id="L124">        Intent intent = createCameraForImageIntent(activity, type);</span>
<span class="nc" id="L125">        activity.startActivityForResult(intent, RequestCodes.TAKE_PICTURE);</span>
<span class="nc" id="L126">    }</span>

    @Nullable
    private static UploadableFile takenCameraPicture(Context context) throws URISyntaxException {
<span class="nc" id="L130">        String lastCameraPhoto = PreferenceManager.getDefaultSharedPreferences(context).getString(KEY_LAST_CAMERA_PHOTO, null);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (lastCameraPhoto != null) {</span>
<span class="nc" id="L132">            return new UploadableFile(new File(lastCameraPhoto));</span>
        } else {
<span class="nc" id="L134">            return null;</span>
        }
    }

    @Nullable
    private static UploadableFile takenCameraVideo(Context context) throws URISyntaxException {
<span class="nc" id="L140">        String lastCameraPhoto = PreferenceManager.getDefaultSharedPreferences(context).getString(KEY_LAST_CAMERA_VIDEO, null);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (lastCameraPhoto != null) {</span>
<span class="nc" id="L142">            return new UploadableFile(new File(lastCameraPhoto));</span>
        } else {
<span class="nc" id="L144">            return null;</span>
        }
    }

    /**
     * Any activity can use this method to attach their callback to the file picker
     */
    public static void handleActivityResult(int requestCode, int resultCode, Intent data, Activity activity, @NonNull FilePicker.Callbacks callbacks) {
<span class="nc bnc" id="L152" title="All 2 branches missed.">        boolean isHandledPickedFile = (requestCode &amp; RequestCodes.FILE_PICKER_IMAGE_IDENTIFICATOR) &gt; 0;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (isHandledPickedFile) {</span>
<span class="nc" id="L154">            requestCode &amp;= ~RequestCodes.SOURCE_CHOOSER;</span>
<span class="nc bnc" id="L155" title="All 10 branches missed.">            if (requestCode == RequestCodes.PICK_PICTURE_FROM_GALLERY ||</span>
                    requestCode == RequestCodes.TAKE_PICTURE ||
                    requestCode == RequestCodes.CAPTURE_VIDEO ||
                    requestCode == RequestCodes.PICK_PICTURE_FROM_DOCUMENTS ||
                    requestCode == RequestCodes.PICK_PICTURE_FROM_CUSTOM_SELECTOR) {
<span class="nc bnc" id="L160" title="All 2 branches missed.">                if (resultCode == Activity.RESULT_OK) {</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">                    if (requestCode == RequestCodes.PICK_PICTURE_FROM_DOCUMENTS &amp;&amp; !isPhoto(data)) {</span>
<span class="nc" id="L162">                        onPictureReturnedFromDocuments(data, activity, callbacks);</span>
<span class="nc bnc" id="L163" title="All 4 branches missed.">                    } else if (requestCode == RequestCodes.PICK_PICTURE_FROM_GALLERY &amp;&amp; !isPhoto(data)) {</span>
<span class="nc" id="L164">                        onPictureReturnedFromGallery(data, activity, callbacks);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                    } else if (requestCode == RequestCodes.PICK_PICTURE_FROM_CUSTOM_SELECTOR) {</span>
<span class="nc" id="L166">                        onPictureReturnedFromCustomSelector(data, activity, callbacks);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    } else if (requestCode == RequestCodes.TAKE_PICTURE) {</span>
<span class="nc" id="L168">                        onPictureReturnedFromCamera(activity, callbacks);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                    } else if (requestCode == RequestCodes.CAPTURE_VIDEO) {</span>
<span class="nc" id="L170">                        onVideoReturnedFromCamera(activity, callbacks);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                    } else if (isPhoto(data)) {</span>
<span class="nc" id="L172">                        onPictureReturnedFromCamera(activity, callbacks);</span>
                    } else {
<span class="nc" id="L174">                        onPictureReturnedFromDocuments(data, activity, callbacks);</span>
                    }
                } else {
<span class="nc bnc" id="L177" title="All 2 branches missed.">                    if (requestCode == RequestCodes.PICK_PICTURE_FROM_DOCUMENTS) {</span>
<span class="nc" id="L178">                        callbacks.onCanceled(FilePicker.ImageSource.DOCUMENTS, restoreType(activity));</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                    } else if (requestCode == RequestCodes.PICK_PICTURE_FROM_GALLERY) {</span>
<span class="nc" id="L180">                        callbacks.onCanceled(FilePicker.ImageSource.GALLERY, restoreType(activity));</span>
                    } else {
<span class="nc" id="L182">                        callbacks.onCanceled(FilePicker.ImageSource.CAMERA_IMAGE, restoreType(activity));</span>
                    }
                }
            }
        }
<span class="nc" id="L187">    }</span>

    public static List&lt;UploadableFile&gt; handleExternalImagesPicked(Intent data, Activity activity) {
        try {
<span class="nc" id="L191">            return getFilesFromGalleryPictures(data, activity);</span>
<span class="nc" id="L192">        } catch (IOException | SecurityException e) {</span>
<span class="nc" id="L193">            e.printStackTrace();</span>
        }
<span class="nc" id="L195">        return new ArrayList&lt;&gt;();</span>
    }

    private static boolean isPhoto(Intent data) {
<span class="nc bnc" id="L199" title="All 6 branches missed.">        return data == null || (data.getData() == null &amp;&amp; data.getClipData() == null);</span>
    }

    private static Intent plainGalleryPickerIntent(boolean openDocumentIntentPreferred) {
        /*
         * Asking for ACCESS_MEDIA_LOCATION at runtime solved the location-loss issue
         * in the custom selector in Contributions fragment.
         * Detailed discussion: https://github.com/commons-app/apps-android-commons/issues/5015
         *
         * This permission check, however, was insufficient to fix location-loss in
         * the regular selector in Contributions fragment and Nearby fragment,
         * especially on some devices running Android 13 that use the new Photo Picker by default.
         *
         * New Photo Picker: https://developer.android.com/training/data-storage/shared/photopicker
         *
         * The new Photo Picker introduced by Android redacts location tags from EXIF metadata.
         * Reported on the Google Issue Tracker: https://issuetracker.google.com/issues/243294058
         * Status: Won't fix (Intended behaviour)
         *
         * Switched intent from ACTION_GET_CONTENT to ACTION_OPEN_DOCUMENT (by default; can
         * be changed through the Setting page) as:
         *
         * ACTION_GET_CONTENT opens the 'best application' for choosing that kind of data
         * The best application is the new Photo Picker that redacts the location tags
         *
         * ACTION_OPEN_DOCUMENT, however,  displays the various DocumentsProvider instances
         * installed on the device, letting the user interactively navigate through them.
         *
         * So, this allows us to use the traditional file picker that does not redact location tags
         * from EXIF.
         *
         */
        Intent intent;
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (openDocumentIntentPreferred) {</span>
<span class="nc" id="L233">            intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);</span>
        } else {
<span class="nc" id="L235">            intent = new Intent(Intent.ACTION_GET_CONTENT);</span>
        }
<span class="nc" id="L237">        intent.setType(&quot;image/*&quot;);</span>
<span class="nc" id="L238">        return intent;</span>
    }

    private static void onPictureReturnedFromDocuments(Intent data, Activity activity, @NonNull FilePicker.Callbacks callbacks) {
        try {
<span class="nc" id="L243">            Uri photoPath = data.getData();</span>
<span class="nc" id="L244">            UploadableFile photoFile = PickedFiles.pickedExistingPicture(activity, photoPath);</span>
<span class="nc" id="L245">            callbacks.onImagesPicked(singleFileList(photoFile), FilePicker.ImageSource.DOCUMENTS, restoreType(activity));</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">            if (configuration(activity).shouldCopyPickedImagesToPublicGalleryAppFolder()) {</span>
<span class="nc" id="L248">                PickedFiles.copyFilesInSeparateThread(activity, singleFileList(photoFile));</span>
            }
<span class="nc" id="L250">        } catch (Exception e) {</span>
<span class="nc" id="L251">            e.printStackTrace();</span>
<span class="nc" id="L252">            callbacks.onImagePickerError(e, FilePicker.ImageSource.DOCUMENTS, restoreType(activity));</span>
<span class="nc" id="L253">        }</span>
<span class="nc" id="L254">    }</span>

    /**
     * onPictureReturnedFromCustomSelector.
     * Retrieve and forward the images to upload wizard through callback.
     */
    private static void onPictureReturnedFromCustomSelector(Intent data, Activity activity, @NonNull FilePicker.Callbacks callbacks) {
        try {
<span class="nc" id="L262">            List&lt;UploadableFile&gt; files = getFilesFromCustomSelector(data, activity);</span>
<span class="nc" id="L263">            callbacks.onImagesPicked(files, ImageSource.CUSTOM_SELECTOR, restoreType(activity));</span>
<span class="nc" id="L264">        } catch (Exception e) {</span>
<span class="nc" id="L265">            e.printStackTrace();</span>
<span class="nc" id="L266">            callbacks.onImagePickerError(e, ImageSource.CUSTOM_SELECTOR, restoreType(activity));</span>
<span class="nc" id="L267">        }</span>
<span class="nc" id="L268">    }</span>

    /**
     * Get files from custom selector
     * Retrieve and process the selected images from the custom selector.
     */
    private static List&lt;UploadableFile&gt; getFilesFromCustomSelector(Intent data, Activity activity) throws  IOException, SecurityException {
<span class="nc" id="L275">        List&lt;UploadableFile&gt; files = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L276">        ArrayList&lt;Image&gt; images = data.getParcelableArrayListExtra(&quot;Images&quot;);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">        for(Image image : images) {</span>
<span class="nc" id="L278">            Uri uri = image.getUri();</span>
<span class="nc" id="L279">            UploadableFile file = PickedFiles.pickedExistingPicture(activity, uri);</span>
<span class="nc" id="L280">            files.add(file);</span>
<span class="nc" id="L281">        }</span>

<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (configuration(activity).shouldCopyPickedImagesToPublicGalleryAppFolder()) {</span>
<span class="nc" id="L284">            PickedFiles.copyFilesInSeparateThread(activity, files);</span>
        }

<span class="nc" id="L287">        return files;</span>
    }

    private static void onPictureReturnedFromGallery(Intent data, Activity activity, @NonNull FilePicker.Callbacks callbacks) {
        try {
<span class="nc" id="L292">            List&lt;UploadableFile&gt; files = getFilesFromGalleryPictures(data, activity);</span>
<span class="nc" id="L293">            callbacks.onImagesPicked(files, FilePicker.ImageSource.GALLERY, restoreType(activity));</span>
<span class="nc" id="L294">        } catch (Exception e) {</span>
<span class="nc" id="L295">            e.printStackTrace();</span>
<span class="nc" id="L296">            callbacks.onImagePickerError(e, FilePicker.ImageSource.GALLERY, restoreType(activity));</span>
<span class="nc" id="L297">        }</span>
<span class="nc" id="L298">    }</span>

    private static List&lt;UploadableFile&gt; getFilesFromGalleryPictures(Intent data, Activity activity) throws IOException, SecurityException {
<span class="nc" id="L301">        List&lt;UploadableFile&gt; files = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L302">        ClipData clipData = data.getClipData();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (clipData == null) {</span>
<span class="nc" id="L304">            Uri uri = data.getData();</span>
<span class="nc" id="L305">            UploadableFile file = PickedFiles.pickedExistingPicture(activity, uri);</span>
<span class="nc" id="L306">            files.add(file);</span>
<span class="nc" id="L307">        } else {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            for (int i = 0; i &lt; clipData.getItemCount(); i++) {</span>
<span class="nc" id="L309">                Uri uri = clipData.getItemAt(i).getUri();</span>
<span class="nc" id="L310">                UploadableFile file = PickedFiles.pickedExistingPicture(activity, uri);</span>
<span class="nc" id="L311">                files.add(file);</span>
            }
        }

<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (configuration(activity).shouldCopyPickedImagesToPublicGalleryAppFolder()) {</span>
<span class="nc" id="L316">            PickedFiles.copyFilesInSeparateThread(activity, files);</span>
        }

<span class="nc" id="L319">        return files;</span>
    }

    private static void onPictureReturnedFromCamera(Activity activity, @NonNull FilePicker.Callbacks callbacks) {
        try {
<span class="nc" id="L324">            String lastImageUri = PreferenceManager.getDefaultSharedPreferences(activity).getString(KEY_PHOTO_URI, null);</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            if (!TextUtils.isEmpty(lastImageUri)) {</span>
<span class="nc" id="L326">                revokeWritePermission(activity, Uri.parse(lastImageUri));</span>
            }

<span class="nc" id="L329">            UploadableFile photoFile = FilePicker.takenCameraPicture(activity);</span>
<span class="nc" id="L330">            List&lt;UploadableFile&gt; files = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L331">            files.add(photoFile);</span>

<span class="nc bnc" id="L333" title="All 2 branches missed.">            if (photoFile == null) {</span>
<span class="nc" id="L334">                Exception e = new IllegalStateException(&quot;Unable to get the picture returned from camera&quot;);</span>
<span class="nc" id="L335">                callbacks.onImagePickerError(e, FilePicker.ImageSource.CAMERA_IMAGE, restoreType(activity));</span>
<span class="nc" id="L336">            } else {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                if (configuration(activity).shouldCopyTakenPhotosToPublicGalleryAppFolder()) {</span>
<span class="nc" id="L338">                    PickedFiles.copyFilesInSeparateThread(activity, singleFileList(photoFile));</span>
                }

<span class="nc" id="L341">                callbacks.onImagesPicked(files, FilePicker.ImageSource.CAMERA_IMAGE, restoreType(activity));</span>
            }

<span class="nc" id="L344">            PreferenceManager.getDefaultSharedPreferences(activity)</span>
<span class="nc" id="L345">                    .edit()</span>
<span class="nc" id="L346">                    .remove(KEY_LAST_CAMERA_PHOTO)</span>
<span class="nc" id="L347">                    .remove(KEY_PHOTO_URI)</span>
<span class="nc" id="L348">                    .apply();</span>
<span class="nc" id="L349">        } catch (Exception e) {</span>
<span class="nc" id="L350">            e.printStackTrace();</span>
<span class="nc" id="L351">            callbacks.onImagePickerError(e, FilePicker.ImageSource.CAMERA_IMAGE, restoreType(activity));</span>
<span class="nc" id="L352">        }</span>
<span class="nc" id="L353">    }</span>

    private static void onVideoReturnedFromCamera(Activity activity, @NonNull FilePicker.Callbacks callbacks) {
        try {
<span class="nc" id="L357">            String lastVideoUri = PreferenceManager.getDefaultSharedPreferences(activity).getString(KEY_VIDEO_URI, null);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (!TextUtils.isEmpty(lastVideoUri)) {</span>
<span class="nc" id="L359">                revokeWritePermission(activity, Uri.parse(lastVideoUri));</span>
            }

<span class="nc" id="L362">            UploadableFile photoFile = FilePicker.takenCameraVideo(activity);</span>
<span class="nc" id="L363">            List&lt;UploadableFile&gt; files = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L364">            files.add(photoFile);</span>

<span class="nc bnc" id="L366" title="All 2 branches missed.">            if (photoFile == null) {</span>
<span class="nc" id="L367">                Exception e = new IllegalStateException(&quot;Unable to get the video returned from camera&quot;);</span>
<span class="nc" id="L368">                callbacks.onImagePickerError(e, FilePicker.ImageSource.CAMERA_VIDEO, restoreType(activity));</span>
<span class="nc" id="L369">            } else {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                if (configuration(activity).shouldCopyTakenPhotosToPublicGalleryAppFolder()) {</span>
<span class="nc" id="L371">                    PickedFiles.copyFilesInSeparateThread(activity, singleFileList(photoFile));</span>
                }

<span class="nc" id="L374">                callbacks.onImagesPicked(files, FilePicker.ImageSource.CAMERA_VIDEO, restoreType(activity));</span>
            }

<span class="nc" id="L377">            PreferenceManager.getDefaultSharedPreferences(activity)</span>
<span class="nc" id="L378">                    .edit()</span>
<span class="nc" id="L379">                    .remove(KEY_LAST_CAMERA_VIDEO)</span>
<span class="nc" id="L380">                    .remove(KEY_VIDEO_URI)</span>
<span class="nc" id="L381">                    .apply();</span>
<span class="nc" id="L382">        } catch (Exception e) {</span>
<span class="nc" id="L383">            e.printStackTrace();</span>
<span class="nc" id="L384">            callbacks.onImagePickerError(e, FilePicker.ImageSource.CAMERA_VIDEO, restoreType(activity));</span>
<span class="nc" id="L385">        }</span>
<span class="nc" id="L386">    }</span>

    public static FilePickerConfiguration configuration(@NonNull Context context) {
<span class="nc" id="L389">        return new FilePickerConfiguration(context);</span>
    }


<span class="nc" id="L393">    public enum ImageSource {</span>
<span class="nc" id="L394">        GALLERY, DOCUMENTS, CAMERA_IMAGE, CAMERA_VIDEO, CUSTOM_SELECTOR</span>
    }

    public interface Callbacks {
        void onImagePickerError(Exception e, FilePicker.ImageSource source, int type);

        void onImagesPicked(@NonNull List&lt;UploadableFile&gt; imageFiles, FilePicker.ImageSource source, int type);

        void onCanceled(FilePicker.ImageSource source, int type);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>