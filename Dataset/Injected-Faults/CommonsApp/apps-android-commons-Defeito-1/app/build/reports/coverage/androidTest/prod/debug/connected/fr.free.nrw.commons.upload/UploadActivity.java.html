<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.upload</a> &gt; <span class="el_source">UploadActivity.java</span></div><h1>UploadActivity.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.upload;

import static fr.free.nrw.commons.contributions.ContributionController.ACTION_INTERNAL_UPLOADS;
import static fr.free.nrw.commons.utils.PermissionUtils.PERMISSIONS_STORAGE;
import static fr.free.nrw.commons.utils.PermissionUtils.checkPermissionsAndPerformAction;
import static fr.free.nrw.commons.wikidata.WikidataConstants.PLACE_OBJECT;
import static fr.free.nrw.commons.wikidata.WikidataConstants.SELECTED_NEARBY_PLACE;
import static fr.free.nrw.commons.wikidata.WikidataConstants.SELECTED_NEARBY_PLACE_CATEGORY;

import android.Manifest;
import android.annotation.SuppressLint;
import android.app.ProgressDialog;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.location.Location;
import android.location.LocationManager;
import android.os.Build;
import android.os.Build.VERSION;
import android.os.Build.VERSION_CODES;
import android.os.Bundle;
import android.os.Parcel;
import android.os.Parcelable;
import android.provider.Settings;
import android.util.DisplayMetrics;
import android.view.View;
import android.widget.ImageButton;
import android.widget.LinearLayout;
import android.widget.RelativeLayout;
import android.widget.TextView;
import androidx.annotation.NonNull;
import androidx.cardview.widget.CardView;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentStatePagerAdapter;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import androidx.viewpager.widget.PagerAdapter;
import androidx.viewpager.widget.ViewPager;
import androidx.work.ExistingWorkPolicy;
import butterknife.BindView;
import butterknife.ButterKnife;
import butterknife.OnClick;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.auth.LoginActivity;
import fr.free.nrw.commons.auth.SessionManager;
import fr.free.nrw.commons.contributions.ContributionController;
import fr.free.nrw.commons.contributions.MainActivity;
import fr.free.nrw.commons.filepicker.Constants.RequestCodes;
import fr.free.nrw.commons.filepicker.UploadableFile;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LatLng;
import fr.free.nrw.commons.location.LocationPermissionsHelper;
import fr.free.nrw.commons.location.LocationServiceManager;
import fr.free.nrw.commons.mwapi.UserClient;
import fr.free.nrw.commons.nearby.Place;
import fr.free.nrw.commons.settings.Prefs;
import fr.free.nrw.commons.theme.BaseActivity;
import fr.free.nrw.commons.upload.UploadBaseFragment.Callback;
import fr.free.nrw.commons.upload.categories.UploadCategoriesFragment;
import fr.free.nrw.commons.upload.depicts.DepictsFragment;
import fr.free.nrw.commons.upload.license.MediaLicenseFragment;
import fr.free.nrw.commons.upload.mediaDetails.UploadMediaDetailFragment;
import fr.free.nrw.commons.upload.mediaDetails.UploadMediaDetailFragment.UploadMediaDetailFragmentCallback;
import fr.free.nrw.commons.upload.worker.WorkRequestHelper;
import fr.free.nrw.commons.utils.DialogUtil;
import fr.free.nrw.commons.utils.PermissionUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.schedulers.Schedulers;
import java.io.File;
import java.security.Permission;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Set;
import javax.inject.Inject;
import javax.inject.Named;
import timber.log.Timber;

<span class="nc" id="L83">public class UploadActivity extends BaseActivity implements UploadContract.View, UploadBaseFragment.Callback {</span>

    @Inject
    ContributionController contributionController;
    @Inject
    @Named(&quot;default_preferences&quot;)
    JsonKvStore directKvStore;
    @Inject
    UploadContract.UserActionListener presenter;
    @Inject
    SessionManager sessionManager;
    @Inject
    UserClient userClient;
    @Inject
    LocationServiceManager locationManager;


    @BindView(R.id.cv_container_top_card)
    CardView cvContainerTopCard;

    @BindView(R.id.ll_container_top_card)
    LinearLayout llContainerTopCard;

    @BindView(R.id.rl_container_title)
    RelativeLayout rlContainerTitle;

    @BindView(R.id.tv_top_card_title)
    TextView tvTopCardTitle;

    @BindView(R.id.ib_toggle_top_card)
    ImageButton ibToggleTopCard;

    @BindView(R.id.rv_thumbnails)
    RecyclerView rvThumbnails;

    @BindView(R.id.vp_upload)
    ViewPager vpUpload;

<span class="nc" id="L121">    private boolean isTitleExpanded = true;</span>

    private CompositeDisposable compositeDisposable;
    private ProgressDialog progressDialog;
    private UploadImageAdapter uploadImagesAdapter;
    private List&lt;UploadBaseFragment&gt; fragments;
    private UploadCategoriesFragment uploadCategoriesFragment;
    private DepictsFragment depictsFragment;
    private MediaLicenseFragment mediaLicenseFragment;
    private ThumbnailsAdapter thumbnailsAdapter;

    private Place place;
    private LatLng prevLocation;
    private LatLng currLocation;
    private boolean isInAppCameraUpload;
<span class="nc" id="L136">    private List&lt;UploadableFile&gt; uploadableFiles = Collections.emptyList();</span>
<span class="nc" id="L137">    private int currentSelectedPosition = 0;</span>
    /*
     Checks for if multiple files selected
     */
<span class="nc" id="L141">    private boolean isMultipleFilesSelected = false;</span>

    public static final String EXTRA_FILES = &quot;commons_image_exta&quot;;
    public static final String LOCATION_BEFORE_IMAGE_CAPTURE = &quot;user_location_before_image_capture&quot;;
    public static final String IN_APP_CAMERA_UPLOAD = &quot;in_app_camera_upload&quot;;

    /**
     * Stores all nearby places found and related users response for
     * each place while uploading media
     */
    public static HashMap&lt;Place,Boolean&gt; nearbyPopupAnswers;

    /**
     * A private boolean variable to control whether a permissions dialog should be shown
     * when necessary. Initially, it is set to `true`, indicating that the permissions dialog
     * should be displayed if permissions are missing and it is first time calling
     * `checkStoragePermissions` method.
     *
     * This variable is used in the `checkStoragePermissions` method to determine whether to
     * show a permissions dialog to the user if the required permissions are not granted.
     *
     * If `showPermissionsDialog` is set to `true` and the necessary permissions are missing,
     * a permissions dialog will be displayed to request the required permissions. If set
     * to `false`, the dialog won't be shown.
     *
     * @see UploadActivity#checkStoragePermissions()
     */
<span class="nc" id="L168">    private boolean showPermissionsDialog = true;</span>

    /**
     * Whether fragments have been saved.
     */
<span class="nc" id="L173">    private boolean isFragmentsSaved = false;</span>

    @SuppressLint(&quot;CheckResult&quot;)
    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L178">        super.onCreate(savedInstanceState);</span>

<span class="nc" id="L180">        setContentView(R.layout.activity_upload);</span>

        /*
         If Configuration of device is changed then get the new fragments
         created by the system and populate the fragments ArrayList
         */
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L187">            isFragmentsSaved = true;</span>
<span class="nc" id="L188">            List&lt;Fragment&gt; fragmentList = getSupportFragmentManager().getFragments();</span>
<span class="nc" id="L189">            fragments = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            for (Fragment fragment : fragmentList) {</span>
<span class="nc" id="L191">                fragments.add((UploadBaseFragment) fragment);</span>
<span class="nc" id="L192">            }</span>
        }


<span class="nc" id="L196">        ButterKnife.bind(this);</span>
<span class="nc" id="L197">        compositeDisposable = new CompositeDisposable();</span>
<span class="nc" id="L198">        init();</span>
<span class="nc" id="L199">        nearbyPopupAnswers = new HashMap&lt;&gt;();</span>
        //getting the current dpi of the device and if it is less than 320dp i.e. overlapping
        //threshold, thumbnails automatically minimizes
<span class="nc" id="L202">        DisplayMetrics metrics = getResources().getDisplayMetrics();</span>
<span class="nc" id="L203">        float dpi = (metrics.widthPixels)/(metrics.density);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (dpi&lt;=321) {</span>
<span class="nc" id="L205">            onRlContainerTitleClicked();</span>
        }
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (PermissionUtils.hasPermission(this, new String[]{Manifest.permission.ACCESS_FINE_LOCATION})) {</span>
<span class="nc" id="L208">            locationManager.registerLocationManager();</span>
        }
<span class="nc" id="L210">        locationManager.requestLocationUpdatesFromProvider(LocationManager.GPS_PROVIDER);</span>
<span class="nc" id="L211">        locationManager.requestLocationUpdatesFromProvider(LocationManager.NETWORK_PROVIDER);</span>
<span class="nc" id="L212">        checkStoragePermissions();</span>
<span class="nc" id="L213">    }</span>

    private void init() {
<span class="nc" id="L216">        initProgressDialog();</span>
<span class="nc" id="L217">        initViewPager();</span>
<span class="nc" id="L218">        initThumbnailsRecyclerView();</span>
        //And init other things you need to
<span class="nc" id="L220">    }</span>

    private void initProgressDialog() {
<span class="nc" id="L223">        progressDialog = new ProgressDialog(this);</span>
<span class="nc" id="L224">        progressDialog.setMessage(getString(R.string.please_wait));</span>
<span class="nc" id="L225">        progressDialog.setCancelable(false);</span>
<span class="nc" id="L226">    }</span>

    private void initThumbnailsRecyclerView() {
<span class="nc" id="L229">        rvThumbnails.setLayoutManager(new LinearLayoutManager(this,</span>
            LinearLayoutManager.HORIZONTAL, false));
<span class="nc" id="L231">        thumbnailsAdapter = new ThumbnailsAdapter(() -&gt; currentSelectedPosition);</span>
<span class="nc" id="L232">        rvThumbnails.setAdapter(thumbnailsAdapter);</span>

<span class="nc" id="L234">    }</span>

    private void initViewPager() {
<span class="nc" id="L237">        uploadImagesAdapter = new UploadImageAdapter(getSupportFragmentManager());</span>
<span class="nc" id="L238">        vpUpload.setAdapter(uploadImagesAdapter);</span>
<span class="nc" id="L239">        vpUpload.addOnPageChangeListener(new ViewPager.OnPageChangeListener() {</span>
            @Override
            public void onPageScrolled(int position, float positionOffset,
                int positionOffsetPixels) {

<span class="nc" id="L244">            }</span>

            @Override
            public void onPageSelected(int position) {
<span class="nc" id="L248">                currentSelectedPosition = position;</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (position &gt;= uploadableFiles.size()) {</span>
<span class="nc" id="L250">                    cvContainerTopCard.setVisibility(View.GONE);</span>
                } else {
<span class="nc" id="L252">                    thumbnailsAdapter.notifyDataSetChanged();</span>
<span class="nc" id="L253">                    cvContainerTopCard.setVisibility(View.VISIBLE);</span>
                }

<span class="nc" id="L256">            }</span>

            @Override
            public void onPageScrollStateChanged(int state) {

<span class="nc" id="L261">            }</span>
        });
<span class="nc" id="L263">    }</span>

    @Override
    public boolean isLoggedIn() {
<span class="nc" id="L267">        return sessionManager.isUserLoggedIn();</span>
    }

    @Override
    protected void onResume() {
<span class="nc" id="L272">        super.onResume();</span>
<span class="nc" id="L273">        presenter.onAttachView(this);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (!isLoggedIn()) {</span>
<span class="nc" id="L275">            askUserToLogIn();</span>
        }
<span class="nc" id="L277">        checkBlockStatus();</span>
<span class="nc" id="L278">    }</span>

    /**
     * Makes API call to check if user is blocked from Commons. If the user is blocked, a snackbar
     * is created to notify the user
     */
    protected void checkBlockStatus() {
<span class="nc" id="L285">        compositeDisposable.add(userClient.isUserBlockedFromCommons()</span>
<span class="nc" id="L286">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L287">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L288">            .filter(result -&gt; result)</span>
<span class="nc" id="L289">            .subscribe(result -&gt; DialogUtil.showAlertDialog(</span>
                this,
<span class="nc" id="L291">                getString(R.string.block_notification_title),</span>
<span class="nc" id="L292">                getString(R.string.block_notification),</span>
<span class="nc" id="L293">                getString(R.string.ok),</span>
                this::finish,
                true)));
<span class="nc" id="L296">    }</span>

    public void checkStoragePermissions() {
        // Check if all required permissions are granted
<span class="nc" id="L300">        final boolean hasAllPermissions = PermissionUtils.hasPermission(this, PERMISSIONS_STORAGE);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (hasAllPermissions) {</span>
            // All required permissions are granted, so enable UI elements and perform actions
<span class="nc" id="L303">            receiveSharedItems();</span>
<span class="nc" id="L304">            cvContainerTopCard.setVisibility(View.VISIBLE);</span>
        } else {
            // Permissions are missing
<span class="nc" id="L307">            cvContainerTopCard.setVisibility(View.INVISIBLE);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if(showPermissionsDialog){</span>
<span class="nc" id="L309">                checkPermissionsAndPerformAction(this,</span>
                    () -&gt; {
<span class="nc" id="L311">                        cvContainerTopCard.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L312">                        this.receiveSharedItems();</span>
<span class="nc" id="L313">                    },() -&gt; {</span>
<span class="nc" id="L314">                        this.showPermissionsDialog = true;</span>
<span class="nc" id="L315">                        this.checkStoragePermissions();</span>
<span class="nc" id="L316">                        },</span>
                    R.string.storage_permission_title,
                    R.string.write_storage_permission_rationale_for_image_share,
                    PERMISSIONS_STORAGE);
            }
        }
        /* If all permissions are not granted and a dialog is already showing on screen
         showPermissionsDialog will set to false making it not show dialog again onResume,
         but if user Denies any permission showPermissionsDialog will be to true
         and permissions dialog will be shown again.
         */
<span class="nc" id="L327">        this.showPermissionsDialog = hasAllPermissions ;</span>
<span class="nc" id="L328">    }</span>

    @Override
    protected void onStop() {
<span class="nc" id="L332">        super.onStop();</span>
<span class="nc" id="L333">    }</span>

    @Override
    public void returnToMainActivity() {
<span class="nc" id="L337">        finish();</span>
<span class="nc" id="L338">    }</span>

    /**
     * Show/Hide the progress dialog
     */
    @Override
    public void showProgress(boolean shouldShow) {
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (shouldShow) {</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">            if (!progressDialog.isShowing()) {</span>
<span class="nc" id="L347">                progressDialog.show();</span>
            }
        } else {
<span class="nc bnc" id="L350" title="All 4 branches missed.">            if (progressDialog != null &amp;&amp; !isFinishing()) {</span>
<span class="nc" id="L351">                progressDialog.dismiss();</span>
            }
        }
<span class="nc" id="L354">    }</span>

    @Override
    public int getIndexInViewFlipper(UploadBaseFragment fragment) {
<span class="nc" id="L358">        return fragments.indexOf(fragment);</span>
    }

    @Override
    public int getTotalNumberOfSteps() {
<span class="nc" id="L363">        return fragments.size();</span>
    }

    @Override
    public boolean isWLMUpload() {
<span class="nc bnc" id="L368" title="All 4 branches missed.">        return place!=null &amp;&amp; place.isMonument();</span>
    }

    @Override
    public void showMessage(int messageResourceId) {
<span class="nc" id="L373">        ViewUtil.showLongToast(this, messageResourceId);</span>
<span class="nc" id="L374">    }</span>

    @Override
    public List&lt;UploadableFile&gt; getUploadableFiles() {
<span class="nc" id="L378">        return uploadableFiles;</span>
    }

    @Override
    public void showHideTopCard(boolean shouldShow) {
<span class="nc bnc" id="L383" title="All 2 branches missed.">        llContainerTopCard.setVisibility(shouldShow ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L384">    }</span>

    @Override
    public void onUploadMediaDeleted(int index) {
<span class="nc" id="L388">        fragments.remove(index);//Remove the corresponding fragment</span>
<span class="nc" id="L389">        uploadableFiles.remove(index);//Remove the files from the list</span>
<span class="nc" id="L390">        thumbnailsAdapter.notifyItemRemoved(index); //Notify the thumbnails adapter</span>
<span class="nc" id="L391">        uploadImagesAdapter.notifyDataSetChanged(); //Notify the ViewPager</span>
<span class="nc" id="L392">    }</span>

    @Override
    public void updateTopCardTitle() {
<span class="nc" id="L396">        tvTopCardTitle.setText(getResources()</span>
<span class="nc" id="L397">            .getQuantityString(R.plurals.upload_count_title, uploadableFiles.size(), uploadableFiles.size()));</span>
<span class="nc" id="L398">    }</span>

    @Override
    public void makeUploadRequest() {
<span class="nc" id="L402">        WorkRequestHelper.Companion.makeOneTimeWorkRequest(getApplicationContext(),</span>
            ExistingWorkPolicy.APPEND_OR_REPLACE);
<span class="nc" id="L404">    }</span>

    @Override
    public void askUserToLogIn() {
<span class="nc" id="L408">        Timber.d(&quot;current session is null, asking user to login&quot;);</span>
<span class="nc" id="L409">        ViewUtil.showLongToast(this, getString(R.string.user_not_logged_in));</span>
<span class="nc" id="L410">        Intent loginIntent = new Intent(UploadActivity.this, LoginActivity.class);</span>
<span class="nc" id="L411">        startActivity(loginIntent);</span>
<span class="nc" id="L412">    }</span>

    @Override
    public void onRequestPermissionsResult(final int requestCode,
        @NonNull final String[] permissions,
        @NonNull final int[] grantResults) {
<span class="nc" id="L418">        boolean areAllGranted = false;</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (requestCode == RequestCodes.STORAGE) {</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">            if (VERSION.SDK_INT &gt;= VERSION_CODES.M) {</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                for (int i = 0; i &lt; grantResults.length; i++) {</span>
<span class="nc" id="L422">                    String permission = permissions[i];</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">                    areAllGranted = grantResults[i] == PackageManager.PERMISSION_GRANTED;</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">                    if (grantResults[i] == PackageManager.PERMISSION_DENIED) {</span>
<span class="nc" id="L425">                        boolean showRationale = shouldShowRequestPermissionRationale(permission);</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">                        if (!showRationale) {</span>
<span class="nc" id="L427">                            DialogUtil.showAlertDialog(this,</span>
<span class="nc" id="L428">                                getString(R.string.storage_permissions_denied),</span>
<span class="nc" id="L429">                                getString(R.string.unable_to_share_upload_item),</span>
<span class="nc" id="L430">                                getString(android.R.string.ok),</span>
                                this::finish,
                                false);
                        } else {
<span class="nc" id="L434">                            DialogUtil.showAlertDialog(this,</span>
<span class="nc" id="L435">                                getString(R.string.storage_permission_title),</span>
<span class="nc" id="L436">                                getString(</span>
                                    R.string.write_storage_permission_rationale_for_image_share),
<span class="nc" id="L438">                                getString(android.R.string.ok),</span>
                                this::checkStoragePermissions,
                                false);
                        }
                    }
                }

<span class="nc bnc" id="L445" title="All 2 branches missed.">                if (areAllGranted) {</span>
<span class="nc" id="L446">                    receiveSharedItems();</span>
                }
            }
        }
<span class="nc" id="L450">        super.onRequestPermissionsResult(requestCode, permissions, grantResults);</span>
<span class="nc" id="L451">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L455">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (requestCode == CommonsApplication.OPEN_APPLICATION_DETAIL_SETTINGS) {</span>
            //TODO: Confirm if handling manual permission enabled is required
        }
<span class="nc" id="L459">    }</span>

    private void receiveSharedItems() {
<span class="nc" id="L462">        thumbnailsAdapter.context=this;</span>
<span class="nc" id="L463">        Intent intent = getIntent();</span>
<span class="nc" id="L464">        String action = intent.getAction();</span>
<span class="nc bnc" id="L465" title="All 4 branches missed.">        if (Intent.ACTION_SEND.equals(action) || Intent.ACTION_SEND_MULTIPLE.equals(action)) {</span>
<span class="nc" id="L466">            receiveExternalSharedItems();</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">        } else if (ACTION_INTERNAL_UPLOADS.equals(action)) {</span>
<span class="nc" id="L468">            receiveInternalSharedItems();</span>
        }

<span class="nc bnc" id="L471" title="All 4 branches missed.">        if (uploadableFiles == null || uploadableFiles.isEmpty()) {</span>
<span class="nc" id="L472">            handleNullMedia();</span>
        } else {
            //Show thumbnails
<span class="nc bnc" id="L475" title="All 2 branches missed.">            if (uploadableFiles.size()</span>
                &gt; 1) {//If there is only file, no need to show the image thumbnails
<span class="nc" id="L477">                thumbnailsAdapter.setUploadableFiles(uploadableFiles);</span>
            } else {
<span class="nc" id="L479">                llContainerTopCard.setVisibility(View.GONE);</span>
            }
<span class="nc" id="L481">            tvTopCardTitle.setText(getResources()</span>
<span class="nc" id="L482">                .getQuantityString(R.plurals.upload_count_title, uploadableFiles.size(), uploadableFiles.size()));</span>


<span class="nc bnc" id="L485" title="All 2 branches missed.">            if(fragments==null){</span>
<span class="nc" id="L486">                fragments = new ArrayList&lt;&gt;();</span>
            }


            /* Suggest users to turn battery optimisation off when uploading more than a few files.
               That's because we have noticed that many-files uploads have
               a much higher probability of failing than uploads with less files.

               Show the dialog for Android 6 and above as
               the ACTION_IGNORE_BATTERY_OPTIMIZATION_SETTINGS intent was added in API level 23
             */
<span class="nc bnc" id="L497" title="All 2 branches missed.">            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">                if (uploadableFiles.size() &gt; 3</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                    &amp;&amp; !defaultKvStore.getBoolean(&quot;hasAlreadyLaunchedBigMultiupload&quot;)) {</span>
<span class="nc" id="L500">                    DialogUtil.showAlertDialog(</span>
                        this,
<span class="nc" id="L502">                        getString(R.string.unrestricted_battery_mode),</span>
<span class="nc" id="L503">                        getString(R.string.suggest_unrestricted_mode),</span>
<span class="nc" id="L504">                        getString(R.string.title_activity_settings),</span>
<span class="nc" id="L505">                        getString(R.string.cancel),</span>
                        () -&gt; {
                        /* Since opening the right settings page might be device dependent, using
                           https://github.com/WaseemSabir/BatteryPermissionHelper
                           directly appeared like a promising idea.
                           However, this simply closed the popup and did not make
                           the settings page appear on a Pixel as well as a Xiaomi device.

                           Used the standard intent instead of using this library as
                           it shows a list of all the apps on the device and allows users to
                           turn battery optimisation off.
                         */
<span class="nc" id="L517">                            Intent batteryOptimisationSettingsIntent = new Intent(</span>
                                Settings.ACTION_IGNORE_BATTERY_OPTIMIZATION_SETTINGS);
<span class="nc" id="L519">                            startActivity(batteryOptimisationSettingsIntent);</span>
<span class="nc" id="L520">                        },</span>
<span class="nc" id="L521">                        () -&gt; {}</span>
                    );
<span class="nc" id="L523">                    defaultKvStore.putBoolean(&quot;hasAlreadyLaunchedBigMultiupload&quot;, true);</span>
                }
            }
<span class="nc bnc" id="L526" title="All 2 branches missed.">            for (UploadableFile uploadableFile : uploadableFiles) {</span>
<span class="nc" id="L527">                UploadMediaDetailFragment uploadMediaDetailFragment = new UploadMediaDetailFragment();</span>

<span class="nc" id="L529">                LocationPermissionsHelper locationPermissionsHelper = new LocationPermissionsHelper(</span>
                    this, locationManager, null);
<span class="nc bnc" id="L531" title="All 2 branches missed.">                if (locationPermissionsHelper.isLocationAccessToAppsTurnedOn()) {</span>
<span class="nc" id="L532">                    currLocation = locationManager.getLastLocation();</span>
                }

<span class="nc bnc" id="L535" title="All 2 branches missed.">                if (currLocation != null) {</span>
<span class="nc" id="L536">                    float locationDifference = getLocationDifference(currLocation, prevLocation);</span>
<span class="nc" id="L537">                    boolean isLocationTagUnchecked = isLocationTagUncheckedInTheSettings();</span>
                    /* Remove location if the user has unchecked the Location EXIF tag in the
                       Manage EXIF Tags setting or turned &quot;Record location for in-app shots&quot; off.
                       Also, location information is discarded if the difference between
                       current location and location recorded just before capturing the image
                       is greater than 100 meters */
<span class="nc bnc" id="L543" title="All 4 branches missed.">                    if (isLocationTagUnchecked || locationDifference &gt; 100</span>
<span class="nc bnc" id="L544" title="All 4 branches missed.">                        || !defaultKvStore.getBoolean(&quot;inAppCameraLocationPref&quot;)</span>
                        || !isInAppCameraUpload) {
<span class="nc" id="L546">                        currLocation = null;</span>
                    }
                }
<span class="nc" id="L549">                uploadMediaDetailFragment.setImageTobeUploaded(uploadableFile, place, currLocation);</span>
<span class="nc" id="L550">                locationManager.unregisterLocationManager();</span>

<span class="nc" id="L552">                UploadMediaDetailFragmentCallback uploadMediaDetailFragmentCallback = new UploadMediaDetailFragmentCallback() {</span>
                    @Override
                    public void deletePictureAtIndex(int index) {
<span class="nc" id="L555">                        presenter.deletePictureAtIndex(index);</span>
<span class="nc" id="L556">                    }</span>

                    /**
                     * Changes the thumbnail of an UploadableFile at the specified index.
                     * This method updates the list of uploadableFiles by replacing the UploadableFile
                     * at the given index with a new UploadableFile created from the provided file path.
                     * After updating the list, it notifies the RecyclerView's adapter to refresh its data,
                     * ensuring that the thumbnail change is reflected in the UI.
                     *
                     * @param index The index of the UploadableFile to be updated.
                     * @param filepath The file path of the new thumbnail image.
                     */
                    @Override
                    public void changeThumbnail(int index, String filepath) {
<span class="nc" id="L570">                        uploadableFiles.remove(index);</span>
<span class="nc" id="L571">                        uploadableFiles.add(index, new UploadableFile(new File(filepath)));</span>
<span class="nc" id="L572">                        rvThumbnails.getAdapter().notifyDataSetChanged();</span>
<span class="nc" id="L573">                    }</span>

                    @Override
                    public void onNextButtonClicked(int index) {
<span class="nc" id="L577">                        UploadActivity.this.onNextButtonClicked(index);</span>
<span class="nc" id="L578">                    }</span>

                    @Override
                    public void onPreviousButtonClicked(int index) {
<span class="nc" id="L582">                        UploadActivity.this.onPreviousButtonClicked(index);</span>
<span class="nc" id="L583">                    }</span>

                    @Override
                    public void showProgress(boolean shouldShow) {
<span class="nc" id="L587">                        UploadActivity.this.showProgress(shouldShow);</span>
<span class="nc" id="L588">                    }</span>

                    @Override
                    public int getIndexInViewFlipper(UploadBaseFragment fragment) {
<span class="nc" id="L592">                        return fragments.indexOf(fragment);</span>
                    }

                    @Override
                    public int getTotalNumberOfSteps() {
<span class="nc" id="L597">                        return fragments.size();</span>
                    }

                    @Override
                    public boolean isWLMUpload() {
<span class="nc bnc" id="L602" title="All 4 branches missed.">                        return place!=null &amp;&amp; place.isMonument();</span>
                    }
                };

<span class="nc bnc" id="L606" title="All 2 branches missed.">                if(isFragmentsSaved){</span>
<span class="nc" id="L607">                    UploadMediaDetailFragment fragment = (UploadMediaDetailFragment) fragments.get(0);</span>
<span class="nc" id="L608">                    fragment.setCallback(uploadMediaDetailFragmentCallback);</span>
<span class="nc" id="L609">                }else{</span>
<span class="nc" id="L610">                    uploadMediaDetailFragment.setCallback(uploadMediaDetailFragmentCallback);</span>
<span class="nc" id="L611">                    fragments.add(uploadMediaDetailFragment);</span>
                }

<span class="nc" id="L614">            }</span>

            //If fragments are not created, create them and add them to the fragments ArrayList
<span class="nc bnc" id="L617" title="All 2 branches missed.">            if(!isFragmentsSaved){</span>
<span class="nc" id="L618">                uploadCategoriesFragment = new UploadCategoriesFragment();</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">                if (place != null) {</span>
<span class="nc" id="L620">                    Bundle categoryBundle = new Bundle();</span>
<span class="nc" id="L621">                    categoryBundle.putString(SELECTED_NEARBY_PLACE_CATEGORY, place.getCategory());</span>
<span class="nc" id="L622">                    uploadCategoriesFragment.setArguments(categoryBundle);</span>
                }

<span class="nc" id="L625">                uploadCategoriesFragment.setCallback(this);</span>

<span class="nc" id="L627">                depictsFragment = new DepictsFragment();</span>
<span class="nc" id="L628">                Bundle placeBundle = new Bundle();</span>
<span class="nc" id="L629">                placeBundle.putParcelable(SELECTED_NEARBY_PLACE, place);</span>
<span class="nc" id="L630">                depictsFragment.setArguments(placeBundle);</span>
<span class="nc" id="L631">                depictsFragment.setCallback(this);</span>

<span class="nc" id="L633">                mediaLicenseFragment = new MediaLicenseFragment();</span>
<span class="nc" id="L634">                mediaLicenseFragment.setCallback(this);</span>

<span class="nc" id="L636">                fragments.add(depictsFragment);</span>
<span class="nc" id="L637">                fragments.add(uploadCategoriesFragment);</span>
<span class="nc" id="L638">                fragments.add(mediaLicenseFragment);</span>

<span class="nc" id="L640">            }else{</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                for(int i=1;i&lt;fragments.size();i++){</span>
<span class="nc" id="L642">                    fragments.get(i).setCallback(new Callback() {</span>
                        @Override
                        public void onNextButtonClicked(int index) {
<span class="nc bnc" id="L645" title="All 2 branches missed.">                            if (index &lt; fragments.size() - 1) {</span>
<span class="nc" id="L646">                                vpUpload.setCurrentItem(index + 1, false);</span>
<span class="nc" id="L647">                                fragments.get(index + 1).onBecameVisible();</span>
<span class="nc" id="L648">                                ((LinearLayoutManager) rvThumbnails.getLayoutManager())</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">                                    .scrollToPositionWithOffset((index &gt; 0) ? index-1 : 0, 0);</span>
                            } else {
<span class="nc" id="L651">                                presenter.handleSubmit();</span>
                            }

<span class="nc" id="L654">                        }</span>
                        @Override
                        public void onPreviousButtonClicked(int index) {
<span class="nc bnc" id="L657" title="All 2 branches missed.">                            if (index != 0) {</span>
<span class="nc" id="L658">                                vpUpload.setCurrentItem(index - 1, true);</span>
<span class="nc" id="L659">                                fragments.get(index - 1).onBecameVisible();</span>
<span class="nc" id="L660">                                ((LinearLayoutManager) rvThumbnails.getLayoutManager())</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">                                    .scrollToPositionWithOffset((index &gt; 3) ? index-2 : 0, 0);</span>
                            }
<span class="nc" id="L663">                        }</span>
                        @Override
                        public void showProgress(boolean shouldShow) {
<span class="nc bnc" id="L666" title="All 2 branches missed.">                            if (shouldShow) {</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">                                if (!progressDialog.isShowing()) {</span>
<span class="nc" id="L668">                                    progressDialog.show();</span>
                                }
                            } else {
<span class="nc bnc" id="L671" title="All 4 branches missed.">                                if (progressDialog != null &amp;&amp; !isFinishing()) {</span>
<span class="nc" id="L672">                                    progressDialog.dismiss();</span>
                                }
                            }
<span class="nc" id="L675">                        }</span>
                        @Override
                        public int getIndexInViewFlipper(UploadBaseFragment fragment) {
<span class="nc" id="L678">                            return fragments.indexOf(fragment);</span>
                        }

                        @Override
                        public int getTotalNumberOfSteps() {
<span class="nc" id="L683">                            return fragments.size();</span>
                        }

                        @Override
                        public boolean isWLMUpload() {
<span class="nc bnc" id="L688" title="All 4 branches missed.">                            return place!=null &amp;&amp; place.isMonument();</span>
                        }
                    });
                }
            }

<span class="nc" id="L694">            uploadImagesAdapter.setFragments(fragments);</span>
<span class="nc" id="L695">            vpUpload.setOffscreenPageLimit(fragments.size());</span>

        }
<span class="nc" id="L698">    }</span>

    /**
     * Users may uncheck Location tag from the Manage EXIF tags setting any time.
     * So, their location must not be shared in this case.
     *
     * @return
     */
    private boolean isLocationTagUncheckedInTheSettings() {
<span class="nc" id="L707">        Set&lt;String&gt; prefExifTags = defaultKvStore.getStringSet(Prefs.MANAGED_EXIF_TAGS);</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">        if (prefExifTags.contains(getString(R.string.exif_tag_location))) {</span>
<span class="nc" id="L709">            return false;</span>
        }
<span class="nc" id="L711">        return true;</span>
    }

    /**
     * Calculate the difference between current location and
     * location recorded before capturing the image
     *
     * @param currLocation
     * @param prevLocation
     * @return
     */
    private float getLocationDifference(LatLng currLocation, LatLng prevLocation) {
<span class="nc bnc" id="L723" title="All 2 branches missed.">        if (prevLocation == null) {</span>
<span class="nc" id="L724">            return 0.0f;</span>
        }
<span class="nc" id="L726">        float[] distance = new float[2];</span>
<span class="nc" id="L727">        Location.distanceBetween(</span>
<span class="nc" id="L728">            currLocation.getLatitude(), currLocation.getLongitude(),</span>
<span class="nc" id="L729">            prevLocation.getLatitude(), prevLocation.getLongitude(), distance);</span>
<span class="nc" id="L730">        return distance[0];</span>
    }

    private void receiveExternalSharedItems() {
<span class="nc" id="L734">        uploadableFiles = contributionController.handleExternalImagesPicked(this, getIntent());</span>
<span class="nc" id="L735">    }</span>

    private void receiveInternalSharedItems() {
<span class="nc" id="L738">        Intent intent = getIntent();</span>

<span class="nc" id="L740">        Timber.d(&quot;Received intent %s with action %s&quot;, intent.toString(), intent.getAction());</span>

<span class="nc" id="L742">        uploadableFiles = intent.getParcelableArrayListExtra(EXTRA_FILES);</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">        isMultipleFilesSelected = uploadableFiles.size() &gt; 1;</span>
<span class="nc" id="L744">        Timber.i(&quot;Received multiple upload %s&quot;, uploadableFiles.size());</span>

<span class="nc" id="L746">        place = intent.getParcelableExtra(PLACE_OBJECT);</span>
<span class="nc" id="L747">        prevLocation = intent.getParcelableExtra(LOCATION_BEFORE_IMAGE_CAPTURE);</span>
<span class="nc" id="L748">        isInAppCameraUpload = intent.getBooleanExtra(IN_APP_CAMERA_UPLOAD, false);</span>
<span class="nc" id="L749">        resetDirectPrefs();</span>
<span class="nc" id="L750">    }</span>

    /**
     * Returns if multiple files selected or not.
     */
    public boolean getIsMultipleFilesSelected() {
<span class="nc" id="L756">        return isMultipleFilesSelected;</span>
    }

    public void resetDirectPrefs() {
<span class="nc" id="L760">        directKvStore.remove(PLACE_OBJECT);</span>
<span class="nc" id="L761">    }</span>

    /**
     * Handle null URI from the received intent.
     * Current implementation will simply show a toast and finish the upload activity.
     */
    private void handleNullMedia() {
<span class="nc" id="L768">        ViewUtil.showLongToast(this, R.string.error_processing_image);</span>
<span class="nc" id="L769">        finish();</span>
<span class="nc" id="L770">    }</span>


    @Override
    public void showAlertDialog(int messageResourceId, Runnable onPositiveClick) {
<span class="nc" id="L775">        DialogUtil.showAlertDialog(this,</span>
            &quot;&quot;,
<span class="nc" id="L777">            getString(messageResourceId),</span>
<span class="nc" id="L778">            getString(R.string.ok),</span>
            onPositiveClick,
            false);
<span class="nc" id="L781">    }</span>

    @Override
    public void onNextButtonClicked(int index) {
<span class="nc bnc" id="L785" title="All 2 branches missed.">        if (index &lt; fragments.size() - 1) {</span>
<span class="nc" id="L786">            vpUpload.setCurrentItem(index + 1, false);</span>
<span class="nc" id="L787">            fragments.get(index + 1).onBecameVisible();</span>
<span class="nc" id="L788">            ((LinearLayoutManager) rvThumbnails.getLayoutManager())</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">                .scrollToPositionWithOffset((index &gt; 0) ? index-1 : 0, 0);</span>
        } else {
<span class="nc" id="L791">            presenter.handleSubmit();</span>
        }
<span class="nc" id="L793">    }</span>

    @Override
    public void onPreviousButtonClicked(int index) {
<span class="nc bnc" id="L797" title="All 2 branches missed.">        if (index != 0) {</span>
<span class="nc" id="L798">            vpUpload.setCurrentItem(index - 1, true);</span>
<span class="nc" id="L799">            fragments.get(index - 1).onBecameVisible();</span>
<span class="nc" id="L800">            ((LinearLayoutManager) rvThumbnails.getLayoutManager())</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">                .scrollToPositionWithOffset((index &gt; 3) ? index-2 : 0, 0);</span>
        }
<span class="nc" id="L803">    }</span>

    /**
     * The adapter used to show image upload intermediate fragments
     */


    private class UploadImageAdapter extends FragmentStatePagerAdapter {
        List&lt;UploadBaseFragment&gt; fragments;

<span class="nc" id="L813">        public UploadImageAdapter(FragmentManager fragmentManager) {</span>
<span class="nc" id="L814">            super(fragmentManager);</span>
<span class="nc" id="L815">            this.fragments = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L816">        }</span>

        public void setFragments(List&lt;UploadBaseFragment&gt; fragments) {
<span class="nc" id="L819">            this.fragments = fragments;</span>
<span class="nc" id="L820">            notifyDataSetChanged();</span>
<span class="nc" id="L821">        }</span>

        @Override
        public Fragment getItem(int position) {
<span class="nc" id="L825">            return fragments.get(position);</span>
        }

        @Override
        public int getCount() {
<span class="nc" id="L830">            return fragments.size();</span>
        }

        @Override
        public int getItemPosition(Object object) {
<span class="nc" id="L835">            return PagerAdapter.POSITION_NONE;</span>
        }
    }


    @OnClick(R.id.rl_container_title)
    public void onRlContainerTitleClicked() {
<span class="nc bnc" id="L842" title="All 2 branches missed.">        rvThumbnails.setVisibility(isTitleExpanded ? View.GONE : View.VISIBLE);</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">        isTitleExpanded = !isTitleExpanded;</span>
<span class="nc" id="L844">        ibToggleTopCard.setRotation(ibToggleTopCard.getRotation() + 180);</span>
<span class="nc" id="L845">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc" id="L849">        super.onDestroy();</span>
<span class="nc" id="L850">        presenter.onDetachView();</span>
<span class="nc" id="L851">        compositeDisposable.clear();</span>
<span class="nc" id="L852">        fragments = null;</span>
<span class="nc" id="L853">        uploadImagesAdapter = null;</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">        if (mediaLicenseFragment != null) {</span>
<span class="nc" id="L855">            mediaLicenseFragment.setCallback(null);</span>
        }
<span class="nc bnc" id="L857" title="All 2 branches missed.">        if (uploadCategoriesFragment != null) {</span>
<span class="nc" id="L858">            uploadCategoriesFragment.setCallback(null);</span>
        }

<span class="nc" id="L861">    }</span>

    /**
     * Get the value of the showPermissionDialog variable.
     *
     * @return {@code true} if Permission Dialog should be shown, {@code false} otherwise.
     */
    public boolean isShowPermissionsDialog() {
<span class="nc" id="L869">        return showPermissionsDialog;</span>
    }

    /**
     * Set the value of the showPermissionDialog variable.
     *
     * @param showPermissionsDialog {@code true} to indicate to show
     * Permissions Dialog if permissions are missing, {@code false} otherwise.
     */
    public void setShowPermissionsDialog(final boolean showPermissionsDialog) {
<span class="nc" id="L879">        this.showPermissionsDialog = showPermissionsDialog;</span>
<span class="nc" id="L880">    }</span>

    /**
     * Overrides the back button to make sure the user is prepared to lose their progress
     */
    @Override
    public void onBackPressed() {
<span class="nc" id="L887">        DialogUtil.showAlertDialog(this,</span>
<span class="nc" id="L888">            getString(R.string.back_button_warning),</span>
<span class="nc" id="L889">            getString(R.string.back_button_warning_desc),</span>
<span class="nc" id="L890">            getString(R.string.back_button_continue),</span>
<span class="nc" id="L891">            getString(R.string.back_button_warning),</span>
            null,
            this::finish
        );
<span class="nc" id="L895">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>