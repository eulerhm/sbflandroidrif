<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PicOfDayAppWidget.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.widget</a> &gt; <span class="el_source">PicOfDayAppWidget.java</span></div><h1>PicOfDayAppWidget.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.widget;

import android.app.PendingIntent;
import android.appwidget.AppWidgetManager;
import android.appwidget.AppWidgetProvider;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.Canvas;
import android.graphics.Paint;
import android.net.Uri;
import android.widget.RemoteViews;

import androidx.annotation.Nullable;

import com.facebook.common.executors.CallerThreadExecutor;
import com.facebook.common.references.CloseableReference;
import com.facebook.datasource.DataSource;
import com.facebook.drawee.backends.pipeline.Fresco;
import com.facebook.imagepipeline.core.ImagePipeline;
import com.facebook.imagepipeline.datasource.BaseBitmapDataSubscriber;
import com.facebook.imagepipeline.image.CloseableImage;
import com.facebook.imagepipeline.request.ImageRequest;
import com.facebook.imagepipeline.request.ImageRequestBuilder;

import fr.free.nrw.commons.media.MediaClient;
import javax.inject.Inject;

import fr.free.nrw.commons.R;
import fr.free.nrw.commons.contributions.MainActivity;
import fr.free.nrw.commons.di.ApplicationlessInjection;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.schedulers.Schedulers;
import timber.log.Timber;

import static android.content.Intent.ACTION_VIEW;

/**
 * Implementation of App Widget functionality.
 */
<span class="nc" id="L42">public class PicOfDayAppWidget extends AppWidgetProvider {</span>

<span class="nc" id="L44">    private CompositeDisposable compositeDisposable = new CompositeDisposable();</span>

    @Inject
    MediaClient mediaClient;

    void updateAppWidget(Context context, AppWidgetManager appWidgetManager, int appWidgetId) {
<span class="nc" id="L50">        RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.pic_of_day_app_widget);</span>

        // Launch App on Button Click
<span class="nc" id="L53">        Intent viewIntent = new Intent(context, MainActivity.class);</span>
<span class="nc" id="L54">        PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, viewIntent, PendingIntent.FLAG_IMMUTABLE);</span>
<span class="nc" id="L55">        views.setOnClickPendingIntent(R.id.camera_button, pendingIntent);</span>
<span class="nc" id="L56">        appWidgetManager.updateAppWidget(appWidgetId, views);</span>

<span class="nc" id="L58">        loadPictureOfTheDay(context, views, appWidgetManager, appWidgetId);</span>
<span class="nc" id="L59">    }</span>

    /**
     * Loads the picture of the day using media wiki API
     * @param context
     * @param views
     * @param appWidgetManager
     * @param appWidgetId
     */
    private void loadPictureOfTheDay(Context context,
                                     RemoteViews views,
                                     AppWidgetManager appWidgetManager,
                                     int appWidgetId) {
<span class="nc" id="L72">        compositeDisposable.add(mediaClient.getPictureOfTheDay()</span>
<span class="nc" id="L73">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L74">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L75">                .subscribe(</span>
                        response -&gt; {
<span class="nc bnc" id="L77" title="All 2 branches missed.">                            if (response != null) {</span>
<span class="nc" id="L78">                                views.setTextViewText(R.id.appwidget_title, response.getDisplayTitle());</span>

                                // View in browser
<span class="nc" id="L81">                                Intent viewIntent = new Intent();</span>
<span class="nc" id="L82">                                viewIntent.setAction(ACTION_VIEW);</span>
<span class="nc" id="L83">                                viewIntent.setData(Uri.parse(response.getPageTitle().getMobileUri()));</span>
<span class="nc" id="L84">                                PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, viewIntent, PendingIntent.FLAG_IMMUTABLE);</span>
<span class="nc" id="L85">                                views.setOnClickPendingIntent(R.id.appwidget_image, pendingIntent);</span>

<span class="nc" id="L87">                                loadImageFromUrl(response.getThumbUrl(), context, views, appWidgetManager, appWidgetId);</span>
                            }
<span class="nc" id="L89">                        },</span>
<span class="nc" id="L90">                        t -&gt; Timber.e(t, &quot;Fetching picture of the day failed&quot;)</span>
                ));
<span class="nc" id="L92">    }</span>

    /**
     * Uses Fresco to load an image from Url
     * @param imageUrl
     * @param context
     * @param views
     * @param appWidgetManager
     * @param appWidgetId
     */
    private void loadImageFromUrl(String imageUrl,
                                  Context context,
                                  RemoteViews views,
                                  AppWidgetManager appWidgetManager,
                                  int appWidgetId) {
<span class="nc" id="L107">        ImageRequest request = ImageRequestBuilder.newBuilderWithSource(Uri.parse(imageUrl)).build();</span>
<span class="nc" id="L108">        ImagePipeline imagePipeline = Fresco.getImagePipeline();</span>
<span class="nc" id="L109">        DataSource&lt;CloseableReference&lt;CloseableImage&gt;&gt; dataSource</span>
<span class="nc" id="L110">                = imagePipeline.fetchDecodedImage(request, context);</span>
<span class="nc" id="L111">        dataSource.subscribe(new BaseBitmapDataSubscriber() {</span>
            @Override
            protected void onNewResultImpl(@Nullable Bitmap tempBitmap) {
<span class="nc" id="L114">                Bitmap bitmap = null;</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (tempBitmap != null) {</span>
<span class="nc" id="L116">                    bitmap = Bitmap.createBitmap(tempBitmap.getWidth(), tempBitmap.getHeight(), Bitmap.Config.ARGB_8888);</span>
<span class="nc" id="L117">                    Canvas canvas = new Canvas(bitmap);</span>
<span class="nc" id="L118">                    canvas.drawBitmap(tempBitmap, 0f, 0f, new Paint());</span>
                }
<span class="nc" id="L120">                views.setImageViewBitmap(R.id.appwidget_image, bitmap);</span>
<span class="nc" id="L121">                appWidgetManager.updateAppWidget(appWidgetId, views);</span>
<span class="nc" id="L122">            }</span>

            @Override
            protected void onFailureImpl(DataSource&lt;CloseableReference&lt;CloseableImage&gt;&gt; dataSource) {
                // Ignore failure for now.
<span class="nc" id="L127">            }</span>
<span class="nc" id="L128">        }, CallerThreadExecutor.getInstance());</span>
<span class="nc" id="L129">    }</span>

    @Override
    public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] appWidgetIds) {
<span class="nc" id="L133">        ApplicationlessInjection</span>
<span class="nc" id="L134">                .getInstance(context</span>
<span class="nc" id="L135">                        .getApplicationContext())</span>
<span class="nc" id="L136">                .getCommonsApplicationComponent()</span>
<span class="nc" id="L137">                .inject(this);</span>
        // There may be multiple widgets active, so update all of them
<span class="nc bnc" id="L139" title="All 2 branches missed.">        for (int appWidgetId : appWidgetIds) {</span>
<span class="nc" id="L140">            updateAppWidget(context, appWidgetManager, appWidgetId);</span>
        }
<span class="nc" id="L142">    }</span>

    @Override
    public void onEnabled(Context context) {
        // Enter relevant functionality for when the first widget is created
<span class="nc" id="L147">    }</span>

    @Override
    public void onDisabled(Context context) {
        // Enter relevant functionality for when the last widget is disabled
<span class="nc" id="L152">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>