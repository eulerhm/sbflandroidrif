<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractAnimatedZoomableController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.media.zoomControllers.zoomable</a> &gt; <span class="el_source">AbstractAnimatedZoomableController.java</span></div><h1>AbstractAnimatedZoomableController.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.media.zoomControllers.zoomable;

import android.graphics.Matrix;
import android.graphics.PointF;
import com.facebook.common.logging.FLog;
import androidx.annotation.Nullable;
import fr.free.nrw.commons.media.zoomControllers.gestures.TransformGestureDetector;

/**
 * Abstract class for ZoomableController that adds animation capabilities to
 * DefaultZoomableController.
 */
public abstract class AbstractAnimatedZoomableController extends DefaultZoomableController {

    private boolean mIsAnimating;
<span class="nc" id="L16">    private final float[] mStartValues = new float[9];</span>
<span class="nc" id="L17">    private final float[] mStopValues = new float[9];</span>
<span class="nc" id="L18">    private final float[] mCurrentValues = new float[9];</span>
<span class="nc" id="L19">    private final Matrix mNewTransform = new Matrix();</span>
<span class="nc" id="L20">    private final Matrix mWorkingTransform = new Matrix();</span>

    public AbstractAnimatedZoomableController(TransformGestureDetector transformGestureDetector) {
<span class="nc" id="L23">        super(transformGestureDetector);</span>
<span class="nc" id="L24">    }</span>

    @Override
    public void reset() {
<span class="nc" id="L28">        FLog.v(getLogTag(), &quot;reset&quot;);</span>
<span class="nc" id="L29">        stopAnimation();</span>
<span class="nc" id="L30">        mWorkingTransform.reset();</span>
<span class="nc" id="L31">        mNewTransform.reset();</span>
<span class="nc" id="L32">        super.reset();</span>
<span class="nc" id="L33">    }</span>

    /** Returns true if the zoomable transform is identity matrix, and the controller is idle. */
    @Override
    public boolean isIdentity() {
<span class="nc bnc" id="L38" title="All 4 branches missed.">        return !isAnimating() &amp;&amp; super.isIdentity();</span>
    }

    /**
     * Zooms to the desired scale and positions the image so that the given image point corresponds to
     * the given view point.
     *
     * &lt;p&gt;If this method is called while an animation or gesture is already in progress, the current
     * animation or gesture will be stopped first.
     *
     * @param scale desired scale, will be limited to {min, max} scale factor
     * @param imagePoint 2D point in image's relative coordinate system (i.e. 0 &lt;= x, y &lt;= 1)
     * @param viewPoint 2D point in view's absolute coordinate system
     */
    @Override
    public void zoomToPoint(float scale, PointF imagePoint, PointF viewPoint) {
<span class="nc" id="L54">        zoomToPoint(scale, imagePoint, viewPoint, LIMIT_ALL, 0, null);</span>
<span class="nc" id="L55">    }</span>

    /**
     * Zooms to the desired scale and positions the image so that the given image point corresponds to
     * the given view point.
     *
     * &lt;p&gt;If this method is called while an animation or gesture is already in progress, the current
     * animation or gesture will be stopped first.
     *
     * @param scale desired scale, will be limited to {min, max} scale factor
     * @param imagePoint 2D point in image's relative coordinate system (i.e. 0 &lt;= x, y &lt;= 1)
     * @param viewPoint 2D point in view's absolute coordinate system
     * @param limitFlags whether to limit translation and/or scale.
     * @param durationMs length of animation of the zoom, or 0 if no animation desired
     * @param onAnimationComplete code to run when the animation completes. Ignored if durationMs=0
     */
    public void zoomToPoint(
            float scale,
            PointF imagePoint,
            PointF viewPoint,
            @LimitFlag int limitFlags,
            long durationMs,
            @Nullable Runnable onAnimationComplete) {
<span class="nc" id="L78">        FLog.v(getLogTag(), &quot;zoomToPoint: duration %d ms&quot;, durationMs);</span>
<span class="nc" id="L79">        calculateZoomToPointTransform(mNewTransform, scale, imagePoint, viewPoint, limitFlags);</span>
<span class="nc" id="L80">        setTransform(mNewTransform, durationMs, onAnimationComplete);</span>
<span class="nc" id="L81">    }</span>

    /**
     * Sets a new zoomable transformation and animates to it if desired.
     *
     * &lt;p&gt;If this method is called while an animation or gesture is already in progress, the current
     * animation or gesture will be stopped first.
     *
     * @param newTransform new transform to make active
     * @param durationMs duration of the animation, or 0 to not animate
     * @param onAnimationComplete code to run when the animation completes. Ignored if durationMs=0
     */
    public void setTransform(
            Matrix newTransform, long durationMs, @Nullable Runnable onAnimationComplete) {
<span class="nc" id="L95">        FLog.v(getLogTag(), &quot;setTransform: duration %d ms&quot;, durationMs);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (durationMs &lt;= 0) {</span>
<span class="nc" id="L97">            setTransformImmediate(newTransform);</span>
        } else {
<span class="nc" id="L99">            setTransformAnimated(newTransform, durationMs, onAnimationComplete);</span>
        }
<span class="nc" id="L101">    }</span>

    private void setTransformImmediate(final Matrix newTransform) {
<span class="nc" id="L104">        FLog.v(getLogTag(), &quot;setTransformImmediate&quot;);</span>
<span class="nc" id="L105">        stopAnimation();</span>
<span class="nc" id="L106">        mWorkingTransform.set(newTransform);</span>
<span class="nc" id="L107">        super.setTransform(newTransform);</span>
<span class="nc" id="L108">        getDetector().restartGesture();</span>
<span class="nc" id="L109">    }</span>

    protected boolean isAnimating() {
<span class="nc" id="L112">        return mIsAnimating;</span>
    }

    protected void setAnimating(boolean isAnimating) {
<span class="nc" id="L116">        mIsAnimating = isAnimating;</span>
<span class="nc" id="L117">    }</span>

    protected float[] getStartValues() {
<span class="nc" id="L120">        return mStartValues;</span>
    }

    protected float[] getStopValues() {
<span class="nc" id="L124">        return mStopValues;</span>
    }

    protected Matrix getWorkingTransform() {
<span class="nc" id="L128">        return mWorkingTransform;</span>
    }

    @Override
    public void onGestureBegin(TransformGestureDetector detector) {
<span class="nc" id="L133">        FLog.v(getLogTag(), &quot;onGestureBegin&quot;);</span>
<span class="nc" id="L134">        stopAnimation();</span>
<span class="nc" id="L135">        super.onGestureBegin(detector);</span>
<span class="nc" id="L136">    }</span>

    @Override
    public void onGestureUpdate(TransformGestureDetector detector) {
<span class="nc bnc" id="L140" title="All 2 branches missed.">        FLog.v(getLogTag(), &quot;onGestureUpdate %s&quot;, isAnimating() ? &quot;(ignored)&quot; : &quot;&quot;);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (isAnimating()) {</span>
<span class="nc" id="L142">            return;</span>
        }
<span class="nc" id="L144">        super.onGestureUpdate(detector);</span>
<span class="nc" id="L145">    }</span>

    protected void calculateInterpolation(Matrix outMatrix, float fraction) {
<span class="nc bnc" id="L148" title="All 2 branches missed.">        for (int i = 0; i &lt; 9; i++) {</span>
<span class="nc" id="L149">            mCurrentValues[i] = (1 - fraction) * mStartValues[i] + fraction * mStopValues[i];</span>
        }
<span class="nc" id="L151">        outMatrix.setValues(mCurrentValues);</span>
<span class="nc" id="L152">    }</span>

    public abstract void setTransformAnimated(
            final Matrix newTransform, long durationMs, @Nullable final Runnable onAnimationComplete);

    protected abstract void stopAnimation();

    protected abstract Class&lt;?&gt; getLogTag();
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>