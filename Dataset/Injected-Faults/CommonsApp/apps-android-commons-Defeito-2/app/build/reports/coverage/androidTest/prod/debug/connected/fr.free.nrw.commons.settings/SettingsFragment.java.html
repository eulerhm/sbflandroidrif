<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SettingsFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.settings</a> &gt; <span class="el_source">SettingsFragment.java</span></div><h1>SettingsFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.settings;

import static android.content.Context.MODE_PRIVATE;

import android.Manifest.permission;
import android.app.Activity;
import android.app.Dialog;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.res.Configuration;
import android.net.Uri;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextWatcher;
import android.view.View;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.EditText;
import android.widget.ListView;
import android.widget.TextView;
import androidx.activity.result.ActivityResultCallback;
import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.preference.ListPreference;
import androidx.preference.MultiSelectListPreference;
import androidx.preference.Preference;
import androidx.preference.Preference.OnPreferenceClickListener;
import androidx.preference.PreferenceFragmentCompat;
import androidx.preference.PreferenceGroupAdapter;
import androidx.preference.PreferenceScreen;
import androidx.preference.PreferenceViewHolder;
import androidx.recyclerview.widget.RecyclerView.Adapter;
import com.karumi.dexter.Dexter;
import com.karumi.dexter.MultiplePermissionsReport;
import com.karumi.dexter.PermissionToken;
import com.karumi.dexter.listener.PermissionRequest;
import com.karumi.dexter.listener.multi.MultiplePermissionsListener;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.Utils;
import fr.free.nrw.commons.campaigns.CampaignView;
import fr.free.nrw.commons.contributions.ContributionController;
import fr.free.nrw.commons.contributions.MainActivity;
import fr.free.nrw.commons.di.ApplicationlessInjection;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LocationServiceManager;
import fr.free.nrw.commons.logging.CommonsLogSender;
import fr.free.nrw.commons.recentlanguages.Language;
import fr.free.nrw.commons.recentlanguages.RecentLanguagesAdapter;
import fr.free.nrw.commons.recentlanguages.RecentLanguagesDao;
import fr.free.nrw.commons.upload.LanguagesAdapter;
import fr.free.nrw.commons.utils.DialogUtil;
import fr.free.nrw.commons.utils.PermissionUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import javax.inject.Inject;
import javax.inject.Named;

<span class="nc" id="L62">public class SettingsFragment extends PreferenceFragmentCompat {</span>

    @Inject
    @Named(&quot;default_preferences&quot;)
    JsonKvStore defaultKvStore;

    @Inject
    CommonsLogSender commonsLogSender;

    @Inject
    RecentLanguagesDao recentLanguagesDao;

    @Inject
    ContributionController contributionController;

    @Inject
    LocationServiceManager locationManager;

    private ListPreference themeListPreference;
    private Preference descriptionLanguageListPreference;
    private Preference appUiLanguageListPreference;
    private String keyLanguageListPreference;
    private TextView recentLanguagesTextView;
    private View separator;
    private ListView languageHistoryListView;
    private static final String GET_CONTENT_PICKER_HELP_URL = &quot;https://commons-app.github.io/docs.html#get-content&quot;;
<span class="nc" id="L88">    private ActivityResultLauncher&lt;String[]&gt; inAppCameraLocationPermissionLauncher = registerForActivityResult(new ActivityResultContracts.RequestMultiplePermissions(), new ActivityResultCallback&lt;Map&lt;String, Boolean&gt;&gt;() {</span>
        @Override
        public void onActivityResult(Map&lt;String, Boolean&gt; result) {
<span class="nc" id="L91">            boolean areAllGranted = true;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            for (final boolean b : result.values()) {</span>
<span class="nc bnc" id="L93" title="All 4 branches missed.">                areAllGranted = areAllGranted &amp;&amp; b;</span>
<span class="nc" id="L94">            }</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">            if (!areAllGranted &amp;&amp; shouldShowRequestPermissionRationale(permission.ACCESS_FINE_LOCATION)) {</span>
<span class="nc" id="L96">                contributionController.handleShowRationaleFlowCameraLocation(getActivity());</span>
            }
<span class="nc" id="L98">        }</span>
    });

    @Override
    public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
<span class="nc" id="L103">        ApplicationlessInjection</span>
<span class="nc" id="L104">            .getInstance(getActivity().getApplicationContext())</span>
<span class="nc" id="L105">            .getCommonsApplicationComponent()</span>
<span class="nc" id="L106">            .inject(this);</span>

        // Set the preferences from an XML resource
<span class="nc" id="L109">        setPreferencesFromResource(R.xml.preferences, rootKey);</span>

<span class="nc" id="L111">        themeListPreference = findPreference(Prefs.KEY_THEME_VALUE);</span>
<span class="nc" id="L112">        prepareTheme();</span>

<span class="nc" id="L114">        MultiSelectListPreference multiSelectListPref = findPreference(Prefs.MANAGED_EXIF_TAGS);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (multiSelectListPref != null) {</span>
<span class="nc" id="L116">            multiSelectListPref.setOnPreferenceChangeListener((preference, newValue) -&gt; {</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">                if (newValue instanceof HashSet &amp;&amp; !((HashSet) newValue).contains(getString(R.string.exif_tag_location))) {</span>
<span class="nc" id="L118">                    defaultKvStore.putBoolean(&quot;has_user_manually_removed_location&quot;, true);</span>
                }
<span class="nc" id="L120">                return true;</span>
            });
        }

<span class="nc" id="L124">        Preference inAppCameraLocationPref = findPreference(&quot;inAppCameraLocationPref&quot;);</span>

<span class="nc" id="L126">        inAppCameraLocationPref.setOnPreferenceChangeListener(</span>
            (preference, newValue) -&gt; {
<span class="nc" id="L128">                boolean isInAppCameraLocationTurnedOn = (boolean) newValue;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (isInAppCameraLocationTurnedOn) {</span>
<span class="nc" id="L130">                    createDialogsAndHandleLocationPermissions(getActivity());</span>
                }
<span class="nc" id="L132">                return true;</span>
            }
        );

        // Gets current language code from shared preferences
        String languageCode;

<span class="nc" id="L139">        appUiLanguageListPreference = findPreference(&quot;appUiDefaultLanguagePref&quot;);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        assert appUiLanguageListPreference != null;</span>
<span class="nc" id="L141">        keyLanguageListPreference = appUiLanguageListPreference.getKey();</span>
<span class="nc" id="L142">        languageCode = getCurrentLanguageCode(keyLanguageListPreference);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        assert languageCode != null;</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (languageCode.equals(&quot;&quot;)) {</span>
            // If current language code is empty, means none selected by user yet so use phone local
<span class="nc" id="L146">            appUiLanguageListPreference.setSummary(Locale.getDefault().getDisplayLanguage());</span>
        } else {
            // If any language is selected by user previously, use it
<span class="nc" id="L149">            Locale defLocale = new Locale(languageCode);</span>
<span class="nc" id="L150">            appUiLanguageListPreference.setSummary((defLocale).getDisplayLanguage(defLocale));</span>
        }
<span class="nc" id="L152">        appUiLanguageListPreference.setOnPreferenceClickListener(new OnPreferenceClickListener() {</span>
            @Override
            public boolean onPreferenceClick(Preference preference) {
<span class="nc" id="L155">                prepareAppLanguages(appUiLanguageListPreference.getKey());</span>
<span class="nc" id="L156">                return true;</span>
            }
        });

<span class="nc" id="L160">        descriptionLanguageListPreference = findPreference(&quot;descriptionDefaultLanguagePref&quot;);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        assert descriptionLanguageListPreference != null;</span>
<span class="nc" id="L162">        keyLanguageListPreference = descriptionLanguageListPreference.getKey();</span>
<span class="nc" id="L163">        languageCode = getCurrentLanguageCode(keyLanguageListPreference);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        assert languageCode != null;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (languageCode.equals(&quot;&quot;)) {</span>
            // If current language code is empty, means none selected by user yet so use phone local
<span class="nc" id="L167">            descriptionLanguageListPreference.setSummary(Locale.getDefault().getDisplayLanguage());</span>
        } else {
            // If any language is selected by user previously, use it
<span class="nc" id="L170">            Locale defLocale = new Locale(languageCode);</span>
<span class="nc" id="L171">            descriptionLanguageListPreference.setSummary(defLocale.getDisplayLanguage(defLocale));</span>
        }
<span class="nc" id="L173">        descriptionLanguageListPreference.setOnPreferenceClickListener(new OnPreferenceClickListener() {</span>
            @Override
            public boolean onPreferenceClick(Preference preference) {
<span class="nc" id="L176">                prepareAppLanguages(descriptionLanguageListPreference.getKey());</span>
<span class="nc" id="L177">                return true;</span>
            }
        });

<span class="nc" id="L181">        Preference betaTesterPreference = findPreference(&quot;becomeBetaTester&quot;);</span>
<span class="nc" id="L182">        betaTesterPreference.setOnPreferenceClickListener(preference -&gt; {</span>
<span class="nc" id="L183">            Utils.handleWebUrl(getActivity(), Uri.parse(getResources().getString(R.string.beta_opt_in_link)));</span>
<span class="nc" id="L184">            return true;</span>
        });
<span class="nc" id="L186">        Preference sendLogsPreference = findPreference(&quot;sendLogFile&quot;);</span>
<span class="nc" id="L187">        sendLogsPreference.setOnPreferenceClickListener(preference -&gt; {</span>
<span class="nc" id="L188">            checkPermissionsAndSendLogs();</span>
<span class="nc" id="L189">            return true;</span>
        });

<span class="nc" id="L192">        Preference documentBasedPickerPreference = findPreference(&quot;openDocumentPhotoPickerPref&quot;);</span>
<span class="nc" id="L193">        documentBasedPickerPreference.setOnPreferenceChangeListener(</span>
            (preference, newValue) -&gt; {
<span class="nc bnc" id="L195" title="All 2 branches missed.">                boolean isGetContentPickerTurnedOn = !(boolean) newValue;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                if (isGetContentPickerTurnedOn) {</span>
<span class="nc" id="L197">                    showLocationLossWarning();</span>
                }
<span class="nc" id="L199">                return true;</span>
            }
        );
        // Disable some settings when not logged in.
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (defaultKvStore.getBoolean(&quot;login_skipped&quot;, false)) {</span>
<span class="nc" id="L204">            findPreference(&quot;useExternalStorage&quot;).setEnabled(false);</span>
<span class="nc" id="L205">            findPreference(&quot;useAuthorName&quot;).setEnabled(false);</span>
<span class="nc" id="L206">            findPreference(&quot;displayNearbyCardView&quot;).setEnabled(false);</span>
<span class="nc" id="L207">            findPreference(&quot;descriptionDefaultLanguagePref&quot;).setEnabled(false);</span>
<span class="nc" id="L208">            findPreference(&quot;displayLocationPermissionForCardView&quot;).setEnabled(false);</span>
<span class="nc" id="L209">            findPreference(CampaignView.CAMPAIGNS_DEFAULT_PREFERENCE).setEnabled(false);</span>
<span class="nc" id="L210">            findPreference(&quot;managed_exif_tags&quot;).setEnabled(false);</span>
<span class="nc" id="L211">            findPreference(&quot;openDocumentPhotoPickerPref&quot;).setEnabled(false);</span>
<span class="nc" id="L212">            findPreference(&quot;inAppCameraLocationPref&quot;).setEnabled(false);</span>
        }
<span class="nc" id="L214">    }</span>

    /**
     * Asks users to provide location access
     *
     * @param activity
     */
    private void createDialogsAndHandleLocationPermissions(Activity activity) {
<span class="nc" id="L222">        inAppCameraLocationPermissionLauncher.launch(new String[]{permission.ACCESS_FINE_LOCATION});</span>
<span class="nc" id="L223">    }</span>

    /**
     * On some devices, the new Photo Picker with GET_CONTENT takeover
     * redacts location tags from EXIF metadata
     *
     * Show warning to the user when ACTION_GET_CONTENT intent is enabled
     */
    private void showLocationLossWarning() {
<span class="nc" id="L232">        DialogUtil.showAlertDialog(</span>
<span class="nc" id="L233">            getActivity(),</span>
            null,
<span class="nc" id="L235">            getString(R.string.location_loss_warning),</span>
<span class="nc" id="L236">            getString(R.string.ok),</span>
<span class="nc" id="L237">            getString(R.string.read_help_link),</span>
<span class="nc" id="L238">            () -&gt; {},</span>
<span class="nc" id="L239">            () -&gt; Utils.handleWebUrl(requireContext(), Uri.parse(GET_CONTENT_PICKER_HELP_URL)),</span>
            null,
            true
        );
<span class="nc" id="L243">    }</span>

    @Override
    protected Adapter onCreateAdapter(final PreferenceScreen preferenceScreen) {
<span class="nc" id="L247">        return new PreferenceGroupAdapter(preferenceScreen) {</span>
            @Override
            public void onBindViewHolder(PreferenceViewHolder holder, int position) {
<span class="nc" id="L250">                super.onBindViewHolder(holder, position);</span>
<span class="nc" id="L251">                Preference preference = getItem(position);</span>
<span class="nc" id="L252">                View iconFrame = holder.itemView.findViewById(R.id.icon_frame);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                if (iconFrame != null) {</span>
<span class="nc" id="L254">                    iconFrame.setVisibility(View.GONE);</span>
                }
<span class="nc" id="L256">            }</span>
        };
    }

    /**
     * Sets the theme pref
     */
    private void prepareTheme() {
<span class="nc" id="L264">        themeListPreference.setOnPreferenceChangeListener((preference, newValue) -&gt; {</span>
<span class="nc" id="L265">            getActivity().recreate();</span>
<span class="nc" id="L266">            return true;</span>
        });
<span class="nc" id="L268">    }</span>

    /**
     * Prepare and Show language selection dialog box
     * Uses previously saved language if there is any, if not uses phone locale as initial language.
     * Disable default/already selected language from dialog box
     * Get ListPreference key and act accordingly for each ListPreference.
     * saves value chosen by user to shared preferences
     * to remember later and recall MainActivity to reflect language changes
     * @param keyListPreference
     */
    private void prepareAppLanguages(final String keyListPreference) {

        // Gets current language code from shared preferences
<span class="nc" id="L282">        final String languageCode = getCurrentLanguageCode(keyListPreference);</span>
<span class="nc" id="L283">        final List&lt;Language&gt; recentLanguages = recentLanguagesDao.getRecentLanguages();</span>
<span class="nc" id="L284">        HashMap&lt;Integer, String&gt; selectedLanguages = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (keyListPreference.equals(&quot;appUiDefaultLanguagePref&quot;)) {</span>

<span class="nc bnc" id="L288" title="All 2 branches missed.">            assert languageCode != null;</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (languageCode.equals(&quot;&quot;)) {</span>
<span class="nc" id="L290">                selectedLanguages.put(0, Locale.getDefault().getLanguage());</span>
            } else {
<span class="nc" id="L292">                selectedLanguages.put(0, languageCode);</span>
            }
<span class="nc bnc" id="L294" title="All 2 branches missed.">        } else if (keyListPreference.equals(&quot;descriptionDefaultLanguagePref&quot;)) {</span>

<span class="nc bnc" id="L296" title="All 2 branches missed.">            assert languageCode != null;</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            if (languageCode.equals(&quot;&quot;)) {</span>
<span class="nc" id="L298">                selectedLanguages.put(0, Locale.getDefault().getLanguage());</span>

            } else {
<span class="nc" id="L301">                selectedLanguages.put(0, languageCode);</span>
            }
        }

<span class="nc" id="L305">        LanguagesAdapter languagesAdapter = new LanguagesAdapter(</span>
<span class="nc" id="L306">            getActivity(),</span>
            selectedLanguages
        );

<span class="nc" id="L310">        Dialog dialog = new Dialog(getActivity());</span>
<span class="nc" id="L311">        dialog.setContentView(R.layout.dialog_select_language);</span>
<span class="nc" id="L312">        dialog.setCanceledOnTouchOutside(true);</span>
<span class="nc" id="L313">        dialog.getWindow().setLayout((int)(getActivity().getResources().getDisplayMetrics().widthPixels*0.90),</span>
<span class="nc" id="L314">            (int)(getActivity().getResources().getDisplayMetrics().heightPixels*0.90));</span>
<span class="nc" id="L315">        dialog.show();</span>

<span class="nc" id="L317">        EditText editText = dialog.findViewById(R.id.search_language);</span>
<span class="nc" id="L318">        ListView listView = dialog.findViewById(R.id.language_list);</span>
<span class="nc" id="L319">        languageHistoryListView = dialog.findViewById(R.id.language_history_list);</span>
<span class="nc" id="L320">        recentLanguagesTextView = dialog.findViewById(R.id.recent_searches);</span>
<span class="nc" id="L321">        separator = dialog.findViewById(R.id.separator);</span>

<span class="nc" id="L323">        setUpRecentLanguagesSection(recentLanguages, selectedLanguages);</span>

<span class="nc" id="L325">        listView.setAdapter(languagesAdapter);</span>

<span class="nc" id="L327">        editText.addTextChangedListener(new TextWatcher() {</span>
            @Override
            public void beforeTextChanged(CharSequence charSequence, int i, int i1,
                int i2) {
<span class="nc" id="L331">                hideRecentLanguagesSection();</span>
<span class="nc" id="L332">            }</span>

            @Override
            public void onTextChanged(CharSequence charSequence, int i, int i1,
                int i2) {
<span class="nc" id="L337">                languagesAdapter.getFilter().filter(charSequence);</span>
<span class="nc" id="L338">            }</span>

            @Override
            public void afterTextChanged(Editable editable) {

<span class="nc" id="L343">            }</span>
        });

<span class="nc" id="L346">        languageHistoryListView.setOnItemClickListener((adapterView, view, position, id) -&gt; {</span>
<span class="nc" id="L347">            onRecentLanguageClicked(keyListPreference, dialog, adapterView, position);</span>
<span class="nc" id="L348">        });</span>

<span class="nc" id="L350">        listView.setOnItemClickListener(new OnItemClickListener() {</span>
            @Override
            public void onItemClick(AdapterView&lt;?&gt; adapterView, View view, int i,
                long l) {
<span class="nc" id="L354">                String languageCode = ((LanguagesAdapter) adapterView.getAdapter())</span>
<span class="nc" id="L355">                    .getLanguageCode(i);</span>
<span class="nc" id="L356">                final String languageName = ((LanguagesAdapter) adapterView.getAdapter())</span>
<span class="nc" id="L357">                    .getLanguageName(i);</span>
<span class="nc" id="L358">                final boolean isExists = recentLanguagesDao.findRecentLanguage(languageCode);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                if (isExists) {</span>
<span class="nc" id="L360">                    recentLanguagesDao.deleteRecentLanguage(languageCode);</span>
                }
<span class="nc" id="L362">                recentLanguagesDao.addRecentLanguage(new Language(languageName, languageCode));</span>
<span class="nc" id="L363">                saveLanguageValue(languageCode, keyListPreference);</span>
<span class="nc" id="L364">                Locale defLocale = new Locale(languageCode);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                if(keyListPreference.equals(&quot;appUiDefaultLanguagePref&quot;)) {</span>
<span class="nc" id="L366">                    appUiLanguageListPreference.setSummary(defLocale.getDisplayLanguage(defLocale));</span>
<span class="nc" id="L367">                    setLocale(requireActivity(), languageCode);</span>
<span class="nc" id="L368">                    getActivity().recreate();</span>
<span class="nc" id="L369">                    final Intent intent = new Intent(getActivity(), MainActivity.class);</span>
<span class="nc" id="L370">                    startActivity(intent);</span>
<span class="nc" id="L371">                }else {</span>
<span class="nc" id="L372">                    descriptionLanguageListPreference.setSummary(defLocale.getDisplayLanguage(defLocale));</span>
                }
<span class="nc" id="L374">                dialog.dismiss();</span>
<span class="nc" id="L375">            }</span>
        });

<span class="nc" id="L378">        dialog.setOnDismissListener(</span>
<span class="nc" id="L379">            dialogInterface -&gt; languagesAdapter.getFilter().filter(&quot;&quot;));</span>
<span class="nc" id="L380">    }</span>

    /**
     * Set up recent languages section
     *
     * @param recentLanguages recently used languages
     * @param selectedLanguages selected languages
     */
    private void setUpRecentLanguagesSection(List&lt;Language&gt; recentLanguages,
        HashMap&lt;Integer, String&gt; selectedLanguages) {
<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (recentLanguages.isEmpty()) {</span>
<span class="nc" id="L391">            languageHistoryListView.setVisibility(View.GONE);</span>
<span class="nc" id="L392">            recentLanguagesTextView.setVisibility(View.GONE);</span>
<span class="nc" id="L393">            separator.setVisibility(View.GONE);</span>
        } else {
<span class="nc bnc" id="L395" title="All 2 branches missed.">            if (recentLanguages.size() &gt; 5) {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                for (int i = recentLanguages.size()-1; i &gt;=5; i--) {</span>
<span class="nc" id="L397">                    recentLanguagesDao</span>
<span class="nc" id="L398">                        .deleteRecentLanguage(recentLanguages.get(i).getLanguageCode());</span>
                }
            }
<span class="nc" id="L401">            languageHistoryListView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L402">            recentLanguagesTextView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L403">            separator.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L404">            final RecentLanguagesAdapter recentLanguagesAdapter</span>
                = new RecentLanguagesAdapter(
<span class="nc" id="L406">                getActivity(),</span>
<span class="nc" id="L407">                recentLanguagesDao.getRecentLanguages(),</span>
                selectedLanguages);
<span class="nc" id="L409">            languageHistoryListView.setAdapter(recentLanguagesAdapter);</span>
        }
<span class="nc" id="L411">    }</span>

    /**
     * Handles click event for recent language section
     */
    private void onRecentLanguageClicked(String keyListPreference, Dialog dialog, AdapterView&lt;?&gt; adapterView,
        int position) {
<span class="nc" id="L418">        final String recentLanguageCode = ((RecentLanguagesAdapter) adapterView.getAdapter())</span>
<span class="nc" id="L419">            .getLanguageCode(position);</span>
<span class="nc" id="L420">        final String recentLanguageName = ((RecentLanguagesAdapter) adapterView.getAdapter())</span>
<span class="nc" id="L421">            .getLanguageName(position);</span>
<span class="nc" id="L422">        final boolean isExists = recentLanguagesDao.findRecentLanguage(recentLanguageCode);</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (isExists) {</span>
<span class="nc" id="L424">            recentLanguagesDao.deleteRecentLanguage(recentLanguageCode);</span>
        }
<span class="nc" id="L426">        recentLanguagesDao.addRecentLanguage(</span>
            new Language(recentLanguageName, recentLanguageCode));
<span class="nc" id="L428">        saveLanguageValue(recentLanguageCode, keyListPreference);</span>
<span class="nc" id="L429">        final Locale defLocale = new Locale(recentLanguageCode);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (keyListPreference.equals(&quot;appUiDefaultLanguagePref&quot;)) {</span>
<span class="nc" id="L431">            appUiLanguageListPreference.setSummary(defLocale.getDisplayLanguage(defLocale));</span>
<span class="nc" id="L432">            setLocale(requireActivity(), recentLanguageCode);</span>
<span class="nc" id="L433">            getActivity().recreate();</span>
<span class="nc" id="L434">            final Intent intent = new Intent(getActivity(), MainActivity.class);</span>
<span class="nc" id="L435">            startActivity(intent);</span>
<span class="nc" id="L436">        } else {</span>
<span class="nc" id="L437">            descriptionLanguageListPreference.setSummary(defLocale.getDisplayLanguage(defLocale));</span>
        }
<span class="nc" id="L439">        dialog.dismiss();</span>
<span class="nc" id="L440">    }</span>

    /**
     * Remove the section of recent languages
     */
    private void hideRecentLanguagesSection() {
<span class="nc" id="L446">        languageHistoryListView.setVisibility(View.GONE);</span>
<span class="nc" id="L447">        recentLanguagesTextView.setVisibility(View.GONE);</span>
<span class="nc" id="L448">        separator.setVisibility(View.GONE);</span>
<span class="nc" id="L449">    }</span>

    /**
     * Changing the default app language with selected one and save it to SharedPreferences
     */
    public void setLocale(final Activity activity, String userSelectedValue) {
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (userSelectedValue.equals(&quot;&quot;)) {</span>
<span class="nc" id="L456">            userSelectedValue = Locale.getDefault().getLanguage();</span>
        }
<span class="nc" id="L458">        final Locale locale = new Locale(userSelectedValue);</span>
<span class="nc" id="L459">        Locale.setDefault(locale);</span>
<span class="nc" id="L460">        final Configuration configuration = new Configuration();</span>
<span class="nc" id="L461">        configuration.locale = locale;</span>
<span class="nc" id="L462">        activity.getBaseContext().getResources().updateConfiguration(configuration,</span>
<span class="nc" id="L463">            activity.getBaseContext().getResources().getDisplayMetrics());</span>

<span class="nc" id="L465">        final SharedPreferences.Editor editor = activity.getSharedPreferences(&quot;Settings&quot;, MODE_PRIVATE).edit();</span>
<span class="nc" id="L466">        editor.putString(&quot;language&quot;, userSelectedValue);</span>
<span class="nc" id="L467">        editor.apply();</span>
<span class="nc" id="L468">    }</span>

    /**
     * Save userselected language in List Preference
     * @param userSelectedValue
     * @param preferenceKey
     */
    private void saveLanguageValue(final String userSelectedValue, final String preferenceKey) {
<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (preferenceKey.equals(&quot;appUiDefaultLanguagePref&quot;)) {</span>
<span class="nc" id="L477">            defaultKvStore.putString(Prefs.APP_UI_LANGUAGE, userSelectedValue);</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">        } else if (preferenceKey.equals(&quot;descriptionDefaultLanguagePref&quot;)) {</span>
<span class="nc" id="L479">            defaultKvStore.putString(Prefs.DESCRIPTION_LANGUAGE, userSelectedValue);</span>
        }
<span class="nc" id="L481">    }</span>

    /**
     * Gets current language code from shared preferences
     * @param preferenceKey
     * @return
     */
    private String getCurrentLanguageCode(final String preferenceKey) {
<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (preferenceKey.equals(&quot;appUiDefaultLanguagePref&quot;)) {</span>
<span class="nc" id="L490">            return defaultKvStore.getString(Prefs.APP_UI_LANGUAGE, &quot;&quot;);</span>
        }
<span class="nc bnc" id="L492" title="All 2 branches missed.">        if (preferenceKey.equals(&quot;descriptionDefaultLanguagePref&quot;)) {</span>
<span class="nc" id="L493">            return defaultKvStore.getString(Prefs.DESCRIPTION_LANGUAGE, &quot;&quot;);</span>
        }
<span class="nc" id="L495">        return null;</span>
    }

    /**
     * First checks for external storage permissions and then sends logs via email
     */
    private void checkPermissionsAndSendLogs() {
<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (PermissionUtils.hasPermission(getActivity(), PermissionUtils.PERMISSIONS_STORAGE)) {</span>
<span class="nc" id="L503">            commonsLogSender.send(getActivity(), null);</span>
        } else {
<span class="nc" id="L505">            requestExternalStoragePermissions();</span>
        }
<span class="nc" id="L507">    }</span>

    /**
     * Requests external storage permissions and shows a toast stating that log collection has
     * started
     */
    private void requestExternalStoragePermissions() {
<span class="nc" id="L514">        Dexter.withActivity(getActivity())</span>
<span class="nc" id="L515">            .withPermissions(PermissionUtils.PERMISSIONS_STORAGE)</span>
<span class="nc" id="L516">            .withListener(new MultiplePermissionsListener() {</span>
                @Override
                public void onPermissionsChecked(MultiplePermissionsReport report) {
<span class="nc" id="L519">                    ViewUtil.showLongToast(getActivity(),</span>
<span class="nc" id="L520">                        getResources().getString(R.string.log_collection_started));</span>
<span class="nc" id="L521">                }</span>

                @Override
                public void onPermissionRationaleShouldBeShown(
                    List&lt;PermissionRequest&gt; permissions, PermissionToken token) {

<span class="nc" id="L527">                }</span>
            })
<span class="nc" id="L529">            .onSameThread()</span>
<span class="nc" id="L530">            .check();</span>
<span class="nc" id="L531">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>