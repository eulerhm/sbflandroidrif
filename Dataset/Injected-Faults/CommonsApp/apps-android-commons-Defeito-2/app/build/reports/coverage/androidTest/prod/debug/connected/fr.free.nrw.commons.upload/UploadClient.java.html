<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.upload</a> &gt; <span class="el_source">UploadClient.java</span></div><h1>UploadClient.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.upload;

import static fr.free.nrw.commons.di.NetworkingModule.NAMED_COMMONS_CSRF;

import android.content.Context;
import android.net.Uri;
import androidx.annotation.Nullable;
import com.google.gson.Gson;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.contributions.ChunkInfo;
import fr.free.nrw.commons.contributions.Contribution;
import fr.free.nrw.commons.upload.worker.UploadWorker.NotificationUpdateProgressListener;
import io.reactivex.Observable;
import io.reactivex.disposables.CompositeDisposable;
import java.io.File;
import java.io.IOException;
import java.net.URLEncoder;
import java.util.Date;
import java.util.List;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicReference;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;
import okhttp3.MediaType;
import okhttp3.MultipartBody;
import okhttp3.RequestBody;
import fr.free.nrw.commons.auth.csrf.CsrfTokenClient;
import org.wikipedia.dataclient.mwapi.MwException;
import timber.log.Timber;

@Singleton
public class UploadClient {

<span class="nc" id="L36">    private final int CHUNK_SIZE = 512 * 1024; // 512 KB</span>

    //This is maximum duration for which a stash is persisted on MediaWiki
    // https://www.mediawiki.org/wiki/Manual:$wgUploadStashMaxAge
<span class="nc" id="L40">    private final int MAX_CHUNK_AGE = 6 * 3600 * 1000; // 6 hours</span>

    private final UploadInterface uploadInterface;
    private final CsrfTokenClient csrfTokenClient;
    private final PageContentsCreator pageContentsCreator;
    private final FileUtilsWrapper fileUtilsWrapper;
    private final Gson gson;

<span class="nc" id="L48">    private final CompositeDisposable compositeDisposable = new CompositeDisposable();</span>

    @Inject
    public UploadClient(final UploadInterface uploadInterface,
        @Named(NAMED_COMMONS_CSRF) final CsrfTokenClient csrfTokenClient,
        final PageContentsCreator pageContentsCreator,
<span class="nc" id="L54">        final FileUtilsWrapper fileUtilsWrapper, final Gson gson) {</span>
<span class="nc" id="L55">        this.uploadInterface = uploadInterface;</span>
<span class="nc" id="L56">        this.csrfTokenClient = csrfTokenClient;</span>
<span class="nc" id="L57">        this.pageContentsCreator = pageContentsCreator;</span>
<span class="nc" id="L58">        this.fileUtilsWrapper = fileUtilsWrapper;</span>
<span class="nc" id="L59">        this.gson = gson;</span>
<span class="nc" id="L60">    }</span>

    /**
     * Upload file to stash in chunks of specified size. Uploading files in chunks will make
     * handling of large files easier. Also, it will be useful in supporting pause/resume of
     * uploads
     */
    public Observable&lt;StashUploadResult&gt; uploadFileToStash(
        final Context context, final String filename, final Contribution contribution,
        final NotificationUpdateProgressListener notificationUpdater) throws IOException {
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (contribution.getChunkInfo() != null</span>
<span class="nc" id="L71">            &amp;&amp; contribution.getChunkInfo().getTotalChunks() == contribution.getChunkInfo()</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            .getIndexOfNextChunkToUpload()) {</span>
<span class="nc" id="L73">            return Observable.just(new StashUploadResult(StashUploadState.SUCCESS,</span>
<span class="nc" id="L74">                contribution.getChunkInfo().getUploadResult().getFilekey()));</span>
        }

<span class="nc" id="L77">        CommonsApplication.pauseUploads.put(contribution.getPageId(), false);</span>

<span class="nc" id="L79">        final File file = new File(contribution.getLocalUri().getPath());</span>
<span class="nc" id="L80">        final List&lt;File&gt; fileChunks = fileUtilsWrapper.getFileChunks(context, file, CHUNK_SIZE);</span>

<span class="nc" id="L82">        final int totalChunks = fileChunks.size();</span>

<span class="nc" id="L84">        final MediaType mediaType = MediaType</span>
<span class="nc" id="L85">            .parse(FileUtils.getMimeType(context, Uri.parse(file.getPath())));</span>

<span class="nc" id="L87">        final AtomicReference&lt;ChunkInfo&gt; chunkInfo = new AtomicReference&lt;&gt;();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (isStashValid(contribution)) {</span>
<span class="nc" id="L89">            chunkInfo.set(contribution.getChunkInfo());</span>

<span class="nc" id="L91">            Timber.d(&quot;Chunk: Next Chunk: %s, Total Chunks: %s&quot;,</span>
<span class="nc" id="L92">                contribution.getChunkInfo().getIndexOfNextChunkToUpload(),</span>
<span class="nc" id="L93">                contribution.getChunkInfo().getTotalChunks());</span>
        }

<span class="nc" id="L96">        final AtomicInteger index = new AtomicInteger();</span>
<span class="nc" id="L97">        final AtomicBoolean failures = new AtomicBoolean();</span>

<span class="nc" id="L99">        compositeDisposable.add(Observable.fromIterable(fileChunks).forEach(chunkFile -&gt; {</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">            if (CommonsApplication.pauseUploads.get(contribution.getPageId()) || failures.get()) {</span>
<span class="nc" id="L101">                return;</span>
            }

<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (chunkInfo.get() != null &amp;&amp; index.get() &lt; chunkInfo.get()</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                .getIndexOfNextChunkToUpload()) {</span>
<span class="nc" id="L106">                index.incrementAndGet();</span>
<span class="nc" id="L107">                Timber.d(&quot;Chunk: Increment and return: %s&quot;, index.get());</span>
<span class="nc" id="L108">                return;</span>
            }
<span class="nc" id="L110">            index.getAndIncrement();</span>
            final int offset =
<span class="nc bnc" id="L112" title="All 2 branches missed.">                chunkInfo.get() != null ? chunkInfo.get().getUploadResult().getOffset() : 0;</span>

<span class="nc" id="L114">            Timber.d(&quot;Chunk: Sending Chunk number: %s, offset: %s&quot;, index.get(), offset);</span>
            final String filekey =
<span class="nc bnc" id="L116" title="All 2 branches missed.">                chunkInfo.get() != null ? chunkInfo.get().getUploadResult().getFilekey() : null;</span>

<span class="nc" id="L118">            final RequestBody requestBody = RequestBody</span>
<span class="nc" id="L119">                .create(mediaType, chunkFile);</span>
<span class="nc" id="L120">            final CountingRequestBody countingRequestBody = new CountingRequestBody(requestBody,</span>
<span class="nc" id="L121">                notificationUpdater::onProgress, offset,</span>
<span class="nc" id="L122">                file.length());</span>

<span class="nc" id="L124">            compositeDisposable.add(uploadChunkToStash(filename,</span>
<span class="nc" id="L125">                file.length(),</span>
                offset,
                filekey,
<span class="nc" id="L128">                countingRequestBody).subscribe(uploadResult -&gt; {</span>
<span class="nc" id="L129">                Timber.d(&quot;Chunk: Received Chunk number: %s, offset: %s&quot;, index.get(),</span>
<span class="nc" id="L130">                    uploadResult.getOffset());</span>
<span class="nc" id="L131">                chunkInfo.set(</span>
<span class="nc" id="L132">                    new ChunkInfo(uploadResult, index.get(), totalChunks));</span>
<span class="nc" id="L133">                notificationUpdater.onChunkUploaded(contribution, chunkInfo.get());</span>
<span class="nc" id="L134">            }, throwable -&gt; {</span>
<span class="nc" id="L135">                Timber.e(throwable, &quot;Received error in chunk upload&quot;);</span>
<span class="nc" id="L136">                failures.set(true);</span>
<span class="nc" id="L137">            }));</span>
<span class="nc" id="L138">        }));</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (CommonsApplication.pauseUploads.get(contribution.getPageId())) {</span>
<span class="nc" id="L141">            Timber.d(&quot;Upload stash paused %s&quot;, contribution.getPageId());</span>
<span class="nc" id="L142">            return Observable.just(new StashUploadResult(StashUploadState.PAUSED, null));</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        } else if (failures.get()) {</span>
<span class="nc" id="L144">            Timber.d(&quot;Upload stash contains failures %s&quot;, contribution.getPageId());</span>
<span class="nc" id="L145">            return Observable.just(new StashUploadResult(StashUploadState.FAILED, null));</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        } else if (chunkInfo.get() != null) {</span>
<span class="nc" id="L147">            Timber.d(&quot;Upload stash success %s&quot;, contribution.getPageId());</span>
<span class="nc" id="L148">            return Observable.just(new StashUploadResult(StashUploadState.SUCCESS,</span>
<span class="nc" id="L149">                chunkInfo.get().getUploadResult().getFilekey()));</span>
        } else {
<span class="nc" id="L151">            Timber.d(&quot;Upload stash failed %s&quot;, contribution.getPageId());</span>
<span class="nc" id="L152">            return Observable.just(new StashUploadResult(StashUploadState.FAILED, null));</span>
        }
    }

    /**
     * Stash is valid for 6 hours. This function checks the validity of stash
     *
     * @param contribution
     * @return
     */
    private boolean isStashValid(Contribution contribution) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        return contribution.getChunkInfo() != null &amp;&amp;</span>
<span class="nc" id="L164">            contribution.getDateModified()</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                .after(new Date(System.currentTimeMillis() - MAX_CHUNK_AGE));</span>
    }

    /**
     * Uploads a file chunk to stash
     *
     * @param filename            The name of the file being uploaded
     * @param fileSize            The total size of the file
     * @param offset              The offset returned by the previous chunk upload
     * @param fileKey             The filekey returned by the previous chunk upload
     * @param countingRequestBody Request body with chunk file
     * @return
     */
    Observable&lt;UploadResult&gt; uploadChunkToStash(final String filename,
        final long fileSize,
        final long offset,
        final String fileKey,
        final CountingRequestBody countingRequestBody) {
        final MultipartBody.Part filePart;
        try {
<span class="nc" id="L185">            filePart = MultipartBody.Part</span>
<span class="nc" id="L186">                .createFormData(&quot;chunk&quot;, URLEncoder.encode(filename, &quot;utf-8&quot;), countingRequestBody);</span>

<span class="nc" id="L188">            return uploadInterface.uploadFileToStash(toRequestBody(filename),</span>
<span class="nc" id="L189">                toRequestBody(String.valueOf(fileSize)),</span>
<span class="nc" id="L190">                toRequestBody(String.valueOf(offset)),</span>
<span class="nc" id="L191">                toRequestBody(fileKey),</span>
<span class="nc" id="L192">                toRequestBody(csrfTokenClient.getTokenBlocking()),</span>
                filePart)
<span class="nc" id="L194">                .map(UploadResponse::getUpload);</span>
<span class="nc" id="L195">        } catch (final Throwable throwable) {</span>
<span class="nc" id="L196">            Timber.e(throwable, &quot;Failed to upload chunk to stash&quot;);</span>
<span class="nc" id="L197">            return Observable.error(throwable);</span>
        }
    }

    /**
     * Converts string value to request body
     */
    @Nullable
    private RequestBody toRequestBody(@Nullable final String value) {
<span class="nc bnc" id="L206" title="All 2 branches missed.">        return value == null ? null : RequestBody.create(okhttp3.MultipartBody.FORM, value);</span>
    }


    public Observable&lt;UploadResult&gt; uploadFileFromStash(
        final Contribution contribution,
        final String uniqueFileName,
        final String fileKey) {
        try {
<span class="nc" id="L215">            return uploadInterface</span>
<span class="nc" id="L216">                .uploadFileFromStash(csrfTokenClient.getTokenBlocking(),</span>
<span class="nc" id="L217">                    pageContentsCreator.createFrom(contribution),</span>
                    CommonsApplication.DEFAULT_EDIT_SUMMARY,
                    uniqueFileName,
<span class="nc" id="L220">                    fileKey).map(uploadResponse -&gt; {</span>
<span class="nc" id="L221">                    final UploadResponse uploadResult = gson</span>
<span class="nc" id="L222">                        .fromJson(uploadResponse, UploadResponse.class);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                    if (uploadResult.getUpload() == null) {</span>
<span class="nc" id="L224">                        final MwException exception = gson</span>
<span class="nc" id="L225">                            .fromJson(uploadResponse, MwException.class);</span>
<span class="nc" id="L226">                        Timber.e(exception, &quot;Error in uploading file from stash&quot;);</span>
<span class="nc" id="L227">                        throw new Exception(exception.getErrorCode());</span>
                    }
<span class="nc" id="L229">                    return uploadResult.getUpload();</span>
                });
<span class="nc" id="L231">        } catch (final Throwable throwable) {</span>
<span class="nc" id="L232">            Timber.e(throwable, &quot;Exception occurred in uploading file from stash&quot;);</span>
<span class="nc" id="L233">            return Observable.error(throwable);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>