<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CoordinateEditHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.coordinates</a> &gt; <span class="el_source">CoordinateEditHelper.java</span></div><h1>CoordinateEditHelper.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.coordinates;

import static fr.free.nrw.commons.notification.NotificationHelper.NOTIFICATION_EDIT_COORDINATES;

import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.actions.PageEditClient;
import fr.free.nrw.commons.notification.NotificationHelper;
import fr.free.nrw.commons.utils.ViewUtilWrapper;
import io.reactivex.Observable;
import io.reactivex.Single;
import io.reactivex.schedulers.Schedulers;
import java.util.Objects;
import javax.inject.Inject;
import javax.inject.Named;
import org.apache.commons.lang3.StringUtils;
import timber.log.Timber;

/**
 * Helper class for edit and update given coordinates and showing notification about new coordinates
 * upgradation
 */
public class CoordinateEditHelper {

    /**
     * notificationHelper: helps creating notification
     */
    private final NotificationHelper notificationHelper;
    /**
     * * pageEditClient: methods provided by this member posts the edited coordinates
     * to the Media wiki api
     */
    public final PageEditClient pageEditClient;
    /**
     * viewUtil: helps to show Toast
     */
    private final ViewUtilWrapper viewUtil;

    @Inject
    public CoordinateEditHelper(final NotificationHelper notificationHelper,
        @Named(&quot;commons-page-edit&quot;) final PageEditClient pageEditClient,
<span class="nc" id="L46">        final ViewUtilWrapper viewUtil) {</span>
<span class="nc" id="L47">        this.notificationHelper = notificationHelper;</span>
<span class="nc" id="L48">        this.pageEditClient = pageEditClient;</span>
<span class="nc" id="L49">        this.viewUtil = viewUtil;</span>
<span class="nc" id="L50">    }</span>

    /**
     * Public interface to edit coordinates
     * @param context to be added
     * @param media to be added
     * @param Accuracy to be added
     * @return Single&lt;Boolean&gt;
     */
    public Single&lt;Boolean&gt; makeCoordinatesEdit(final Context context, final Media media,
        final String Latitude, final String Longitude, final String Accuracy) {
<span class="nc" id="L61">        viewUtil.showShortToast(context,</span>
<span class="nc" id="L62">            context.getString(R.string.coordinates_edit_helper_make_edit_toast));</span>
<span class="nc" id="L63">        return addCoordinates(media, Latitude, Longitude, Accuracy)</span>
<span class="nc" id="L64">            .flatMapSingle(result -&gt; Single.just(showCoordinatesEditNotification(context, media,</span>
<span class="nc" id="L65">                Latitude, Longitude, Accuracy, result)))</span>
<span class="nc" id="L66">            .firstOrError();</span>
    }

    /**
     * Replaces new coordinates
     * @param media to be added
     * @param Latitude to be added
     * @param Longitude to be added
     * @param Accuracy to be added
     * @return Observable&lt;Boolean&gt;
     */
    private Observable&lt;Boolean&gt; addCoordinates(final Media media, final String Latitude,
        final String Longitude, final String Accuracy) {
<span class="nc" id="L79">        Timber.d(&quot;thread is coordinates adding %s&quot;, Thread.currentThread().getName());</span>
<span class="nc" id="L80">        final String summary = &quot;Adding Coordinates&quot;;</span>

<span class="nc" id="L82">        final StringBuilder buffer = new StringBuilder();</span>

<span class="nc" id="L84">        final String wikiText = pageEditClient.getCurrentWikiText(media.getFilename())</span>
<span class="nc" id="L85">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L86">            .blockingGet();</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (Latitude != null) {</span>
<span class="nc" id="L89">            buffer.append(&quot;\n{{Location|&quot;).append(Latitude).append(&quot;|&quot;).append(Longitude)</span>
<span class="nc" id="L90">                .append(&quot;|&quot;).append(Accuracy).append(&quot;}}&quot;);</span>
        }

<span class="nc" id="L93">        final String editedLocation = buffer.toString();</span>
<span class="nc" id="L94">        final String appendText = getFormattedWikiText(wikiText, editedLocation);</span>

<span class="nc" id="L96">        return pageEditClient.edit(Objects.requireNonNull(media.getFilename())</span>
               , appendText, summary);
    }

    /**
     * Helps to get formatted wikitext with upgraded location
     * @param wikiText current wikitext
     * @param editedLocation new location
     * @return String
     */
    private String getFormattedWikiText(final String wikiText, final String editedLocation){

<span class="nc bnc" id="L108" title="All 4 branches missed.">        if (wikiText.contains(&quot;filedesc&quot;) &amp;&amp; wikiText.contains(&quot;Location&quot;)) {</span>

<span class="nc" id="L110">            final String fromLocationToEnd = wikiText.substring(wikiText.indexOf(&quot;{{Location&quot;));</span>
<span class="nc" id="L111">            final String firstHalf = wikiText.substring(0, wikiText.indexOf(&quot;{{Location&quot;));</span>
<span class="nc" id="L112">            final String lastHalf = fromLocationToEnd.substring(</span>
<span class="nc" id="L113">                fromLocationToEnd.indexOf(&quot;}}&quot;) + 2);</span>

<span class="nc" id="L115">            final int startOfSecondSection = StringUtils.ordinalIndexOf(wikiText,</span>
                &quot;==&quot;, 3);
<span class="nc" id="L117">            final StringBuilder buffer = new StringBuilder();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (wikiText.charAt(wikiText.indexOf(&quot;{{Location&quot;)-1) == '\n') {</span>
<span class="nc" id="L119">                buffer.append(editedLocation.substring(1));</span>
            } else {
<span class="nc" id="L121">                buffer.append(editedLocation);</span>
            }
<span class="nc bnc" id="L123" title="All 4 branches missed.">            if (startOfSecondSection != -1 &amp;&amp; wikiText.charAt(startOfSecondSection-1)!= '\n') {</span>
<span class="nc" id="L124">                buffer.append(&quot;\n&quot;);</span>
            }

<span class="nc" id="L127">            return firstHalf + buffer + lastHalf;</span>

        }
<span class="nc bnc" id="L130" title="All 4 branches missed.">        if (wikiText.contains(&quot;filedesc&quot;) &amp;&amp; !wikiText.contains(&quot;Location&quot;)) {</span>

<span class="nc" id="L132">            final int startOfSecondSection = StringUtils.ordinalIndexOf(wikiText,</span>
                &quot;==&quot;, 3);

<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (startOfSecondSection != -1) {</span>
<span class="nc" id="L136">                final String firstHalf = wikiText.substring(0, startOfSecondSection);</span>
<span class="nc" id="L137">                final String lastHalf = wikiText.substring(startOfSecondSection);</span>
<span class="nc" id="L138">                final String buffer = editedLocation.substring(1)</span>
                    + &quot;\n&quot;;
<span class="nc" id="L140">                return firstHalf + buffer + lastHalf;</span>
            }

<span class="nc" id="L143">            return wikiText + editedLocation;</span>
        }
<span class="nc" id="L145">        return &quot;== {{int:filedesc}} ==&quot; + editedLocation + wikiText;</span>
    }

    /**
     * Update coordinates and shows notification about coordinates update
     * @param context to be added
     * @param media to be added
     * @param latitude to be added
     * @param longitude to be added
     * @param Accuracy to be added
     * @param result to be added
     * @return boolean
     */
    private boolean showCoordinatesEditNotification(final Context context, final Media media,
        final String latitude, final String longitude, final String Accuracy,
        final boolean result) {
        final String message;
<span class="nc" id="L162">        String title = context.getString(R.string.coordinates_edit_helper_show_edit_title);</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (result) {</span>
<span class="nc" id="L165">            media.setCoordinates(</span>
<span class="nc" id="L166">                new fr.free.nrw.commons.location.LatLng(Double.parseDouble(latitude),</span>
<span class="nc" id="L167">                    Double.parseDouble(longitude),</span>
<span class="nc" id="L168">                    Float.parseFloat(Accuracy)));</span>
<span class="nc" id="L169">            title += &quot;: &quot; + context</span>
<span class="nc" id="L170">                .getString(R.string.coordinates_edit_helper_show_edit_title_success);</span>
<span class="nc" id="L171">            final StringBuilder coordinatesInMessage = new StringBuilder();</span>
<span class="nc" id="L172">            final String mediaCoordinate = String.valueOf(media.getCoordinates());</span>
<span class="nc" id="L173">            coordinatesInMessage.append(mediaCoordinate);</span>
<span class="nc" id="L174">            message = context.getString(R.string.coordinates_edit_helper_show_edit_message,</span>
<span class="nc" id="L175">                coordinatesInMessage.toString());</span>
<span class="nc" id="L176">        } else {</span>
<span class="nc" id="L177">            title += &quot;: &quot; + context.getString(R.string.coordinates_edit_helper_show_edit_title);</span>
<span class="nc" id="L178">            message = context.getString(R.string.coordinates_edit_helper_edit_message_else) ;</span>
        }

<span class="nc" id="L181">        final String urlForFile = BuildConfig.COMMONS_URL + &quot;/wiki/&quot; + media.getFilename();</span>
<span class="nc" id="L182">        final Intent browserIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(urlForFile));</span>
<span class="nc" id="L183">        notificationHelper.showNotification(context, title, message, NOTIFICATION_EDIT_COORDINATES,</span>
            browserIntent);
<span class="nc" id="L185">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>