<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NearbyParentFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.nearby.fragments</a> &gt; <span class="el_source">NearbyParentFragment.java</span></div><h1>NearbyParentFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.nearby.fragments;

import static fr.free.nrw.commons.location.LocationServiceManager.LocationChangeType.CUSTOM_QUERY;
import static fr.free.nrw.commons.location.LocationServiceManager.LocationChangeType.LOCATION_SIGNIFICANTLY_CHANGED;
import static fr.free.nrw.commons.location.LocationServiceManager.LocationChangeType.LOCATION_SLIGHTLY_CHANGED;
import static fr.free.nrw.commons.location.LocationServiceManager.LocationChangeType.MAP_UPDATED;
import static fr.free.nrw.commons.wikidata.WikidataConstants.PLACE_OBJECT;

import android.Manifest;
import android.Manifest.permission;
import android.annotation.SuppressLint;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.pm.PackageManager;
import android.content.res.Configuration;
import android.graphics.Color;
import android.graphics.Paint;
import android.graphics.drawable.Drawable;
import android.location.Location;
import android.location.LocationManager;
import android.net.Uri;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.provider.Settings;
import android.text.Html;
import android.text.method.LinkMovementMethod;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.MenuItem.OnMenuItemClickListener;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.Animation;
import android.view.animation.AnimationUtils;
import android.widget.Button;
import android.widget.FrameLayout;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;
import androidx.activity.result.ActivityResultCallback;
import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.annotation.DrawableRes;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.widget.AppCompatButton;
import androidx.appcompat.widget.AppCompatImageView;
import androidx.appcompat.widget.AppCompatTextView;
import androidx.appcompat.widget.SearchView;
import androidx.core.content.ContextCompat;
import androidx.recyclerview.widget.DividerItemDecoration;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import butterknife.BindView;
import butterknife.ButterKnife;
import butterknife.OnClick;
import com.google.android.material.bottomsheet.BottomSheetBehavior;
import com.google.android.material.chip.Chip;
import com.google.android.material.chip.ChipGroup;
import com.google.android.material.floatingactionbutton.FloatingActionButton;
import com.google.android.material.snackbar.Snackbar;
import com.jakewharton.rxbinding2.view.RxView;
import com.jakewharton.rxbinding3.appcompat.RxSearchView;
import com.mapbox.mapboxsdk.annotations.Marker;
import com.mapbox.mapboxsdk.geometry.LatLng;
import com.mapbox.mapboxsdk.geometry.LatLngBounds;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.MapController.NearbyPlacesInfo;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.Utils;
import fr.free.nrw.commons.auth.LoginActivity;
import fr.free.nrw.commons.bookmarks.locations.BookmarkLocationsDao;
import fr.free.nrw.commons.contributions.ContributionController;
import fr.free.nrw.commons.contributions.MainActivity;
import fr.free.nrw.commons.contributions.MainActivity.ActiveFragment;
import fr.free.nrw.commons.di.CommonsDaggerSupportFragment;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.location.LocationServiceManager;
import fr.free.nrw.commons.location.LocationUpdateListener;
import fr.free.nrw.commons.nearby.CheckBoxTriStates;
import fr.free.nrw.commons.nearby.Label;
import fr.free.nrw.commons.nearby.MarkerPlaceGroup;
import fr.free.nrw.commons.nearby.NearbyBaseMarker;
import fr.free.nrw.commons.nearby.NearbyController;
import fr.free.nrw.commons.nearby.NearbyFilterSearchRecyclerViewAdapter;
import fr.free.nrw.commons.nearby.NearbyFilterState;
import fr.free.nrw.commons.nearby.NearbyMarker;
import fr.free.nrw.commons.nearby.Place;
import fr.free.nrw.commons.nearby.contract.NearbyParentFragmentContract;
import fr.free.nrw.commons.nearby.fragments.AdvanceQueryFragment.Callback;
import fr.free.nrw.commons.nearby.presenter.NearbyParentFragmentPresenter;
import fr.free.nrw.commons.upload.FileUtils;
import fr.free.nrw.commons.utils.DialogUtil;
import fr.free.nrw.commons.utils.ExecutorUtils;
import fr.free.nrw.commons.utils.LayoutUtils;
import fr.free.nrw.commons.utils.LocationUtils;
import fr.free.nrw.commons.utils.NearbyFABUtils;
import fr.free.nrw.commons.utils.NetworkUtils;
import fr.free.nrw.commons.utils.PermissionUtils;
import fr.free.nrw.commons.utils.SystemThemeUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import fr.free.nrw.commons.wikidata.WikidataEditListener;
import io.reactivex.Observable;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.schedulers.Schedulers;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import javax.inject.Inject;
import javax.inject.Named;
import kotlin.Unit;
import org.jetbrains.annotations.NotNull;
import org.osmdroid.events.MapEventsReceiver;
import org.osmdroid.events.MapListener;
import org.osmdroid.events.ScrollEvent;
import org.osmdroid.events.ZoomEvent;
import org.osmdroid.tileprovider.tilesource.TileSourceFactory;
import org.osmdroid.util.GeoPoint;
import org.osmdroid.util.constants.GeoConstants;
import org.osmdroid.views.CustomZoomButtonsController;
import org.osmdroid.views.overlay.ItemizedIconOverlay.OnItemGestureListener;
import org.osmdroid.views.overlay.ItemizedOverlayWithFocus;
import org.osmdroid.views.overlay.MapEventsOverlay;
import org.osmdroid.views.overlay.Overlay;
import org.osmdroid.views.overlay.OverlayItem;
import org.osmdroid.views.overlay.ScaleBarOverlay;
import org.osmdroid.views.overlay.ScaleDiskOverlay;
import org.osmdroid.views.overlay.TilesOverlay;
import timber.log.Timber;


<span class="nc" id="L143">public class NearbyParentFragment extends CommonsDaggerSupportFragment</span>
    implements NearbyParentFragmentContract.View,
    WikidataEditListener.WikidataP18EditListener, LocationUpdateListener {

    @BindView(R.id.bottom_sheet)
    RelativeLayout rlBottomSheet;
    @BindView(R.id.bottom_sheet_details)
    View bottomSheetDetails;
    @BindView(R.id.transparentView)
    View transparentView;
    @BindView(R.id.directionsButtonText)
    TextView directionsButtonText;
    @BindView(R.id.wikipediaButtonText)
    TextView wikipediaButtonText;
    @BindView(R.id.wikidataButtonText)
    TextView wikidataButtonText;
    @BindView(R.id.commonsButtonText)
    TextView commonsButtonText;
    @BindView(R.id.fab_plus)
    FloatingActionButton fabPlus;
    @BindView(R.id.fab_camera)
    FloatingActionButton fabCamera;
    @BindView(R.id.fab_gallery)
    FloatingActionButton fabGallery;
    @BindView(R.id.fab_recenter)
    FloatingActionButton fabRecenter;
    @BindView(R.id.bookmarkButtonImage)
    ImageView bookmarkButtonImage;
    @BindView(R.id.bookmarkButton)
    LinearLayout bookmarkButton;
    @BindView(R.id.wikipediaButton)
    LinearLayout wikipediaButton;
    @BindView(R.id.wikidataButton)
    LinearLayout wikidataButton;
    @BindView(R.id.directionsButton)
    LinearLayout directionsButton;
    @BindView(R.id.commonsButton)
    LinearLayout commonsButton;
    @BindView(R.id.description)
    TextView description;
    @BindView(R.id.title)
    TextView title;
    @BindView(R.id.category)
    TextView distance;
    @BindView(R.id.icon)
    ImageView icon;
    @BindView(R.id.search_this_area_button)
    Button searchThisAreaButton;
    @BindView(R.id.map_progress_bar)
    ProgressBar progressBar;
    @BindView(R.id.choice_chip_exists)
    Chip chipExists;
    @BindView(R.id.choice_chip_wlm)
    Chip chipWlm;
    @BindView(R.id.choice_chip_needs_photo)
    Chip chipNeedsPhoto;
    @BindView(R.id.choice_chip_group)
    ChipGroup choiceChipGroup;
    @BindView(R.id.search_view)
    SearchView searchView;
    @BindView(R.id.search_list_view)
    RecyclerView recyclerView;
    @BindView(R.id.nearby_filter_list)
    View nearbyFilterList;
    @BindView(R.id.checkbox_tri_states)
    CheckBoxTriStates checkBoxTriStates;
    @BindView(R.id.map)
    org.osmdroid.views.MapView mapView;
    @BindView(R.id.rv_nearby_list)
    RecyclerView rvNearbyList;
    @BindView(R.id.no_results_message)
    TextView noResultsView;
    @BindView(R.id.tv_attribution)
    AppCompatTextView tvAttribution;
    @BindView(R.id.rl_container_wlm_month_message)
    RelativeLayout rlContainerWLMMonthMessage;
    @BindView(R.id.tv_learn_more)
    AppCompatTextView tvLearnMore;
    @BindView(R.id.iv_toggle_chips)
    AppCompatImageView ivToggleChips;
    @BindView(R.id.chip_view)
    View llContainerChips;
    @BindView(R.id.btn_advanced_options)
    AppCompatButton btnAdvancedOptions;
    @BindView(R.id.fl_container_nearby_children)
    FrameLayout flConainerNearbyChildren;
    @Inject
    LocationServiceManager locationManager;
    @Inject
    NearbyController nearbyController;
    @Inject
    @Named(&quot;default_preferences&quot;)
    JsonKvStore applicationKvStore;
    @Inject
    BookmarkLocationsDao bookmarkLocationDao;
    @Inject
    ContributionController controller;
    @Inject
    WikidataEditListener wikidataEditListener;
    @Inject
    SystemThemeUtils systemThemeUtils;
    @Inject
    CommonPlaceClickActions commonPlaceClickActions;
    private NearbyFilterSearchRecyclerViewAdapter nearbyFilterSearchRecyclerViewAdapter;
    private BottomSheetBehavior bottomSheetListBehavior;
    private BottomSheetBehavior bottomSheetDetailsBehavior;
    private Animation rotate_backward;
    private Animation fab_close;
    private Animation fab_open;
    private Animation rotate_forward;
    private static final float ZOOM_LEVEL = 14f;
<span class="nc" id="L254">    private final String NETWORK_INTENT_ACTION = &quot;android.net.conn.CONNECTIVITY_CHANGE&quot;;</span>
    private BroadcastReceiver broadcastReceiver;
    private boolean isNetworkErrorOccurred;
    private Snackbar snackbar;
    private View view;
    private NearbyParentFragmentPresenter presenter;
    private boolean isDarkTheme;
    private boolean isFABsExpanded;
    private Marker selectedMarker;
    private Place selectedPlace;
    private Place clickedMarkerPlace;
    private boolean isClickedMarkerBookmarked;
<span class="nc" id="L266">    private final double CAMERA_TARGET_SHIFT_FACTOR_PORTRAIT = 0.005;</span>
<span class="nc" id="L267">    private final double CAMERA_TARGET_SHIFT_FACTOR_LANDSCAPE = 0.004;</span>
    private boolean isPermissionDenied;
    private boolean recenterToUserLocation;
    private GeoPoint mapCenter;
<span class="nc" id="L271">    IntentFilter intentFilter = new IntentFilter(NETWORK_INTENT_ACTION);</span>
    private Marker currentLocationMarker;
    private Place lastPlaceToCenter;
    private fr.free.nrw.commons.location.LatLng lastKnownLocation;
    private boolean isVisibleToUser;
    private fr.free.nrw.commons.location.LatLng lastFocusLocation;
    private LatLngBounds latLngBounds;
    private PlaceAdapter adapter;
    private GeoPoint lastMapFocus;
    private NearbyParentFragmentInstanceReadyCallback nearbyParentFragmentInstanceReadyCallback;
<span class="nc" id="L281">    private boolean isAdvancedQueryFragmentVisible = false;</span>
    private Place nearestPlace;
<span class="nc" id="L283">    private ActivityResultLauncher&lt;String[]&gt; inAppCameraLocationPermissionLauncher = registerForActivityResult(</span>
        new ActivityResultContracts.RequestMultiplePermissions(),
<span class="nc" id="L285">        new ActivityResultCallback&lt;Map&lt;String, Boolean&gt;&gt;() {</span>
            @Override
            public void onActivityResult(Map&lt;String, Boolean&gt; result) {
<span class="nc" id="L288">                boolean areAllGranted = true;</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                for (final boolean b : result.values()) {</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">                    areAllGranted = areAllGranted &amp;&amp; b;</span>
<span class="nc" id="L291">                }</span>

<span class="nc bnc" id="L293" title="All 2 branches missed.">                if (areAllGranted) {</span>
<span class="nc" id="L294">                    controller.locationPermissionCallback.onLocationPermissionGranted();</span>
                } else {
<span class="nc bnc" id="L296" title="All 2 branches missed.">                    if (shouldShowRequestPermissionRationale(permission.ACCESS_FINE_LOCATION)) {</span>
<span class="nc" id="L297">                        controller.handleShowRationaleFlowCameraLocation(getActivity());</span>
                    } else {
<span class="nc" id="L299">                        controller.locationPermissionCallback.onLocationPermissionDenied(</span>
<span class="nc" id="L300">                            getActivity().getString(</span>
                                R.string.in_app_camera_location_permission_denied));
                    }
                }
<span class="nc" id="L304">            }</span>
        });

<span class="nc" id="L307">    private ActivityResultLauncher&lt;String&gt; locationPermissionLauncher = registerForActivityResult(</span>
        new ActivityResultContracts.RequestPermission(), isGranted -&gt; {
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (isGranted) {</span>
<span class="nc" id="L310">                locationPermissionGranted();</span>
            } else {
<span class="nc bnc" id="L312" title="All 2 branches missed.">                if (shouldShowRequestPermissionRationale(permission.ACCESS_FINE_LOCATION)) {</span>
<span class="nc" id="L313">                    DialogUtil.showAlertDialog(getActivity(),</span>
<span class="nc" id="L314">                        getActivity().getString(R.string.location_permission_title),</span>
<span class="nc" id="L315">                        getActivity().getString(R.string.location_permission_rationale_nearby),</span>
<span class="nc" id="L316">                        getActivity().getString(android.R.string.ok),</span>
<span class="nc" id="L317">                        getActivity().getString(android.R.string.cancel),</span>
                        () -&gt; {
<span class="nc bnc" id="L319" title="All 2 branches missed.">                            if (!(locationManager.isNetworkProviderEnabled()</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                                || locationManager.isGPSProviderEnabled())) {</span>
<span class="nc" id="L321">                                showLocationOffDialog();</span>
                            }
<span class="nc" id="L323">                        },</span>
<span class="nc" id="L324">                        () -&gt; isPermissionDenied = true,</span>
                        null,
                        false);
                } else {
<span class="nc" id="L328">                    isPermissionDenied = true;</span>
                }
            }
<span class="nc" id="L331">        });</span>

    /**
     * WLM URL
     */
    public static final String WLM_URL = &quot;https://commons.wikimedia.org/wiki/Commons:Mobile_app/Contributing_to_WLM_using_the_app&quot;;
    /**
     * Saves response of list of places for the first time
     */
<span class="nc" id="L340">    private List&lt;Place&gt; places = new ArrayList&lt;&gt;();</span>

    @NonNull
    public static NearbyParentFragment newInstance() {
<span class="nc" id="L344">        NearbyParentFragment fragment = new NearbyParentFragment();</span>
<span class="nc" id="L345">        fragment.setRetainInstance(true);</span>
<span class="nc" id="L346">        return fragment;</span>
    }

    @Override
    public View onCreateView(@NonNull final LayoutInflater inflater, final ViewGroup container,
        final Bundle savedInstanceState) {
<span class="nc" id="L352">        view = inflater.inflate(R.layout.fragment_nearby_parent, container, false);</span>
<span class="nc" id="L353">        ButterKnife.bind(this, view);</span>
<span class="nc" id="L354">        initNetworkBroadCastReceiver();</span>
<span class="nc" id="L355">        presenter = new NearbyParentFragmentPresenter(bookmarkLocationDao);</span>
<span class="nc" id="L356">        setHasOptionsMenu(true);</span>
        // Inflate the layout for this fragment
<span class="nc" id="L358">        return view;</span>

    }

    @Override
    public void onCreateOptionsMenu(@NonNull final Menu menu,
        @NonNull final MenuInflater inflater) {
<span class="nc" id="L365">        inflater.inflate(R.menu.nearby_fragment_menu, menu);</span>
<span class="nc" id="L366">        MenuItem listMenu = menu.findItem(R.id.list_sheet);</span>
<span class="nc" id="L367">        listMenu.setOnMenuItemClickListener(new OnMenuItemClickListener() {</span>
            @Override
            public boolean onMenuItemClick(MenuItem item) {
<span class="nc" id="L370">                listOptionMenuItemClicked();</span>
<span class="nc" id="L371">                return false;</span>
            }
        });
<span class="nc" id="L374">    }</span>

    @Override
    public void onViewCreated(@NonNull final View view, @Nullable final Bundle savedInstanceState) {
<span class="nc" id="L378">        super.onViewCreated(view, savedInstanceState);</span>
<span class="nc" id="L379">        isDarkTheme = systemThemeUtils.isDeviceInNightMode();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (Utils.isMonumentsEnabled(new Date())) {</span>
<span class="nc" id="L381">            rlContainerWLMMonthMessage.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L383">            rlContainerWLMMonthMessage.setVisibility(View.GONE);</span>
        }

<span class="nc" id="L386">        presenter.attachView(this);</span>
<span class="nc" id="L387">        isPermissionDenied = false;</span>
<span class="nc" id="L388">        recenterToUserLocation = false;</span>
<span class="nc" id="L389">        initThemePreferences();</span>
<span class="nc" id="L390">        initViews();</span>
<span class="nc" id="L391">        presenter.setActionListeners(applicationKvStore);</span>
<span class="nc" id="L392">        org.osmdroid.config.Configuration.getInstance().load(this.getContext(),</span>
<span class="nc" id="L393">            PreferenceManager.getDefaultSharedPreferences(this.getContext()));</span>

        // Use the Wikimedia tile server, rather than OpenStreetMap (Mapnik) which has various
        // restrictions that we do not satisfy.
<span class="nc" id="L397">        mapView.setTileSource(TileSourceFactory.WIKIMEDIA);</span>
<span class="nc" id="L398">        mapView.setTilesScaledToDpi(true);</span>

        // Add referer HTTP header because the Wikimedia tile server requires it.
        // This was suggested by Dmitry Brant within an email thread between us and WMF.
<span class="nc" id="L402">        org.osmdroid.config.Configuration.getInstance().getAdditionalHttpRequestProperties().put(</span>
            &quot;Referer&quot;, &quot;http://maps.wikimedia.org/&quot;
        );

<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (applicationKvStore.getString(&quot;LastLocation&quot;)</span>
            != null) { // Checking for last searched location
<span class="nc" id="L408">            String[] locationLatLng = applicationKvStore.getString(&quot;LastLocation&quot;).split(&quot;,&quot;);</span>
<span class="nc" id="L409">            lastMapFocus = new GeoPoint(Double.valueOf(locationLatLng[0]),</span>
<span class="nc" id="L410">                Double.valueOf(locationLatLng[1]));</span>
<span class="nc" id="L411">        } else {</span>
<span class="nc" id="L412">            lastMapFocus = new GeoPoint(51.50550, -0.07520);</span>
        }
<span class="nc" id="L414">        ScaleBarOverlay scaleBarOverlay = new ScaleBarOverlay(mapView);</span>
<span class="nc" id="L415">        scaleBarOverlay.setScaleBarOffset(15, 25);</span>
<span class="nc" id="L416">        Paint barPaint = new Paint();</span>
<span class="nc" id="L417">        barPaint.setARGB(200, 255, 250, 250);</span>
<span class="nc" id="L418">        scaleBarOverlay.setBackgroundPaint(barPaint);</span>
<span class="nc" id="L419">        scaleBarOverlay.enableScaleBar();</span>
<span class="nc" id="L420">        mapView.getOverlays().add(scaleBarOverlay);</span>
<span class="nc" id="L421">        mapView.getZoomController().setVisibility(CustomZoomButtonsController.Visibility.NEVER);</span>
<span class="nc" id="L422">        mapView.getController().setZoom(ZOOM_LEVEL);</span>
<span class="nc" id="L423">        mapView.getOverlays().add(new MapEventsOverlay(new MapEventsReceiver() {</span>
            @Override
            public boolean singleTapConfirmedHelper(GeoPoint p) {
<span class="nc bnc" id="L426" title="All 2 branches missed.">                if (clickedMarkerPlace != null){</span>
<span class="nc" id="L427">                    removeMarker(clickedMarkerPlace);</span>
<span class="nc" id="L428">                    addMarkerToMap(clickedMarkerPlace,isClickedMarkerBookmarked);</span>
                }else {
<span class="nc" id="L430">                    Timber.e(&quot;CLICKED MARKER IS NULL&quot;);</span>
                }
<span class="nc bnc" id="L432" title="All 2 branches missed.">                if (isListBottomSheetExpanded()) {</span>
                    // Back should first hide the bottom sheet if it is expanded
<span class="nc" id="L434">                    hideBottomSheet();</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">                } else if (isDetailsBottomSheetVisible()) {</span>
<span class="nc" id="L436">                    hideBottomDetailsSheet();</span>
                }
<span class="nc" id="L438">                return true;</span>
            }

            @Override
            public boolean longPressHelper(GeoPoint p) {
<span class="nc" id="L443">                return false;</span>
            }
        }));

<span class="nc" id="L447">        mapView.addMapListener(new MapListener() {</span>
            @Override
            public boolean onScroll(ScrollEvent event) {
<span class="nc bnc" id="L450" title="All 2 branches missed.">                if (lastMapFocus != null) {</span>
<span class="nc" id="L451">                    Location mylocation = new Location(&quot;&quot;);</span>
<span class="nc" id="L452">                    Location dest_location = new Location(&quot;&quot;);</span>
<span class="nc" id="L453">                    dest_location.setLatitude(mapView.getMapCenter().getLatitude());</span>
<span class="nc" id="L454">                    dest_location.setLongitude(mapView.getMapCenter().getLongitude());</span>
<span class="nc" id="L455">                    mylocation.setLatitude(lastMapFocus.getLatitude());</span>
<span class="nc" id="L456">                    mylocation.setLongitude(lastMapFocus.getLongitude());</span>
<span class="nc" id="L457">                    Float distance = mylocation.distanceTo(dest_location);//in meters</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">                    if (lastMapFocus != null) {</span>
<span class="nc bnc" id="L459" title="All 4 branches missed.">                        if (isNetworkConnectionEstablished() &amp;&amp; (event.getX() &gt; 0</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                            || event.getY() &gt; 0)) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                            if (distance &gt; 2000.0) {</span>
<span class="nc" id="L462">                                setSearchThisAreaButtonVisibility(true);</span>
                            } else {
<span class="nc" id="L464">                                setSearchThisAreaButtonVisibility(false);</span>
                            }
                        }
                    } else {
<span class="nc" id="L468">                        setSearchThisAreaButtonVisibility(false);</span>
                    }
                }

<span class="nc" id="L472">                return true;</span>
            }

            @Override
            public boolean onZoom(ZoomEvent event) {
<span class="nc" id="L477">                return false;</span>
            }

        });

<span class="nc" id="L482">        mapView.setMultiTouchControls(true);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">        if (nearbyParentFragmentInstanceReadyCallback != null) {</span>
<span class="nc" id="L484">            nearbyParentFragmentInstanceReadyCallback.onReady();</span>
        }
<span class="nc" id="L486">        initNearbyFilter();</span>
<span class="nc" id="L487">        addCheckBoxCallback();</span>
<span class="nc" id="L488">        performMapReadyActions();</span>
<span class="nc" id="L489">        moveCameraToPosition(lastMapFocus);</span>
<span class="nc" id="L490">        initRvNearbyList();</span>
<span class="nc" id="L491">        onResume();</span>
<span class="nc" id="L492">        tvAttribution.setText(Html.fromHtml(getString(R.string.map_attribution)));</span>
<span class="nc" id="L493">        tvAttribution.setMovementMethod(LinkMovementMethod.getInstance());</span>
<span class="nc" id="L494">        btnAdvancedOptions.setOnClickListener(v -&gt; {</span>
<span class="nc" id="L495">            searchView.clearFocus();</span>
<span class="nc" id="L496">            showHideAdvancedQueryFragment(true);</span>
<span class="nc" id="L497">            final AdvanceQueryFragment fragment = new AdvanceQueryFragment();</span>
<span class="nc" id="L498">            final Bundle bundle = new Bundle();</span>
            try {
<span class="nc" id="L500">                bundle.putString(&quot;query&quot;, FileUtils.readFromResource(&quot;/queries/nearby_query.rq&quot;));</span>
<span class="nc" id="L501">            } catch (IOException e) {</span>
<span class="nc" id="L502">                Timber.e(e);</span>
<span class="nc" id="L503">            }</span>
<span class="nc" id="L504">            fragment.setArguments(bundle);</span>
<span class="nc" id="L505">            fragment.callback = new Callback() {</span>
                @Override
                public void close() {
<span class="nc" id="L508">                    showHideAdvancedQueryFragment(false);</span>
<span class="nc" id="L509">                }</span>

                @Override
                public void reset() {
<span class="nc" id="L513">                    presenter.setAdvancedQuery(null);</span>
<span class="nc" id="L514">                    presenter.updateMapAndList(LOCATION_SIGNIFICANTLY_CHANGED);</span>
<span class="nc" id="L515">                    showHideAdvancedQueryFragment(false);</span>
<span class="nc" id="L516">                }</span>

                @Override
                public void apply(@NotNull final String query) {
<span class="nc" id="L520">                    presenter.setAdvancedQuery(query);</span>
<span class="nc" id="L521">                    presenter.updateMapAndList(CUSTOM_QUERY);</span>
<span class="nc" id="L522">                    showHideAdvancedQueryFragment(false);</span>
<span class="nc" id="L523">                }</span>
            };
<span class="nc" id="L525">            getChildFragmentManager().beginTransaction()</span>
<span class="nc" id="L526">                .replace(R.id.fl_container_nearby_children, fragment)</span>
<span class="nc" id="L527">                .commit();</span>
<span class="nc" id="L528">        });</span>
<span class="nc" id="L529">    }</span>

    /**
     * Initialise background based on theme, this should be doe ideally via styles, that would need
     * another refactor
     */
    private void initThemePreferences() {
<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (isDarkTheme) {</span>
<span class="nc" id="L537">            rvNearbyList.setBackgroundColor(</span>
<span class="nc" id="L538">                getContext().getResources().getColor(R.color.contributionListDarkBackground));</span>
<span class="nc" id="L539">            checkBoxTriStates.setTextColor(</span>
<span class="nc" id="L540">                getContext().getResources().getColor(android.R.color.white));</span>
<span class="nc" id="L541">            checkBoxTriStates.setTextColor(</span>
<span class="nc" id="L542">                getContext().getResources().getColor(android.R.color.white));</span>
<span class="nc" id="L543">            nearbyFilterList.setBackgroundColor(</span>
<span class="nc" id="L544">                getContext().getResources().getColor(R.color.contributionListDarkBackground));</span>
<span class="nc" id="L545">            mapView.getOverlayManager().getTilesOverlay()</span>
<span class="nc" id="L546">                .setColorFilter(TilesOverlay.INVERT_COLORS);</span>
        } else {
<span class="nc" id="L548">            rvNearbyList.setBackgroundColor(</span>
<span class="nc" id="L549">                getContext().getResources().getColor(android.R.color.white));</span>
<span class="nc" id="L550">            checkBoxTriStates.setTextColor(</span>
<span class="nc" id="L551">                getContext().getResources().getColor(R.color.contributionListDarkBackground));</span>
<span class="nc" id="L552">            nearbyFilterList.setBackgroundColor(</span>
<span class="nc" id="L553">                getContext().getResources().getColor(android.R.color.white));</span>
<span class="nc" id="L554">            nearbyFilterList.setBackgroundColor(</span>
<span class="nc" id="L555">                getContext().getResources().getColor(android.R.color.white));</span>
        }
<span class="nc" id="L557">    }</span>

    private void initRvNearbyList() {
<span class="nc" id="L560">        rvNearbyList.setLayoutManager(new LinearLayoutManager(getContext()));</span>
<span class="nc" id="L561">        adapter = new PlaceAdapter(bookmarkLocationDao,</span>
            place -&gt; {
<span class="nc" id="L563">                moveCameraToPosition(new GeoPoint(place.location.getLatitude(),place.location.getLongitude()));</span>
<span class="nc" id="L564">                return Unit.INSTANCE;</span>
            },
            (place, isBookmarked) -&gt; {
<span class="nc" id="L567">                updateMarker(isBookmarked, place, null);</span>
<span class="nc" id="L568">                mapView.invalidate();</span>
<span class="nc" id="L569">                return Unit.INSTANCE;</span>
            },
            commonPlaceClickActions,
            inAppCameraLocationPermissionLauncher
        );
<span class="nc" id="L574">        rvNearbyList.setAdapter(adapter);</span>
<span class="nc" id="L575">    }</span>

    private void addCheckBoxCallback() {
<span class="nc" id="L578">        checkBoxTriStates.setCallback(</span>
<span class="nc" id="L579">            (o, state, b, b1) -&gt; presenter.filterByMarkerType(o, state, b, b1));</span>
<span class="nc" id="L580">    }</span>

    private void performMapReadyActions() {
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if (((MainActivity) getActivity()).activeFragment == ActiveFragment.NEARBY) {</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">            if (!applicationKvStore.getBoolean(&quot;doNotAskForLocationPermission&quot;, false) ||</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">                PermissionUtils.hasPermission(getActivity(),</span>
                    new String[]{Manifest.permission.ACCESS_FINE_LOCATION})) {
<span class="nc" id="L587">                checkPermissionsAndPerformAction();</span>
            } else {
<span class="nc" id="L589">                isPermissionDenied = true;</span>
            }
        }
<span class="nc" id="L592">    }</span>

    private void locationPermissionGranted() {
<span class="nc" id="L595">        isPermissionDenied = false;</span>
<span class="nc" id="L596">        applicationKvStore.putBoolean(&quot;doNotAskForLocationPermission&quot;, false);</span>
<span class="nc" id="L597">        lastKnownLocation = locationManager.getLastLocation();</span>
<span class="nc" id="L598">        fr.free.nrw.commons.location.LatLng target = lastKnownLocation;</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">        if (lastKnownLocation != null) {</span>
<span class="nc" id="L600">            GeoPoint targetP = new GeoPoint(target.getLatitude(), target.getLongitude());</span>
<span class="nc" id="L601">            mapCenter = targetP;</span>
<span class="nc" id="L602">            mapView.getController().setCenter(targetP);</span>
<span class="nc" id="L603">            recenterMarkerToPosition(targetP);</span>
<span class="nc" id="L604">            moveCameraToPosition(targetP);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        } else if (locationManager.isGPSProviderEnabled()</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">            || locationManager.isNetworkProviderEnabled()) {</span>
<span class="nc" id="L607">            locationManager.requestLocationUpdatesFromProvider(LocationManager.NETWORK_PROVIDER);</span>
<span class="nc" id="L608">            locationManager.requestLocationUpdatesFromProvider(LocationManager.GPS_PROVIDER);</span>
<span class="nc" id="L609">            setProgressBarVisibility(true);</span>
        } else {
<span class="nc" id="L611">            Toast.makeText(getContext(), getString(R.string.nearby_location_not_available),</span>
<span class="nc" id="L612">                Toast.LENGTH_LONG).show();</span>
        }
<span class="nc" id="L614">        presenter.onMapReady();</span>
<span class="nc" id="L615">        registerUnregisterLocationListener(false);</span>
<span class="nc" id="L616">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L620">        super.onResume();</span>
<span class="nc" id="L621">        mapView.onResume();</span>
<span class="nc" id="L622">        presenter.attachView(this);</span>
<span class="nc" id="L623">        registerNetworkReceiver();</span>
<span class="nc bnc" id="L624" title="All 4 branches missed.">        if (isResumed() &amp;&amp; ((MainActivity) getActivity()).activeFragment == ActiveFragment.NEARBY) {</span>
<span class="nc bnc" id="L625" title="All 4 branches missed.">            if (!isPermissionDenied &amp;&amp; !applicationKvStore.getBoolean(</span>
                &quot;doNotAskForLocationPermission&quot;, false)) {
<span class="nc bnc" id="L627" title="All 2 branches missed.">                if (!locationManager.isGPSProviderEnabled()) {</span>
<span class="nc" id="L628">                    startMapWithCondition(&quot;Without GPS&quot;);</span>
                } else {
<span class="nc" id="L630">                    startTheMap();</span>
                }
            } else {
<span class="nc" id="L633">                startMapWithCondition(&quot;Without Permission&quot;);</span>
            }
        }
<span class="nc" id="L636">    }</span>

    /**
     * Starts the map without GPS and without permission By default it points to 51.50550,-0.07520
     * coordinates, other than that it points to the last known location which can be get by the key
     * &quot;LastLocation&quot; from applicationKvStore
     *
     * @param condition : for which condition the map should start
     */
    private void startMapWithCondition(final String condition) {
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (condition.equals(&quot;Without Permission&quot;)) {</span>
<span class="nc" id="L647">            applicationKvStore.putBoolean(&quot;doNotAskForLocationPermission&quot;, true);</span>
        }
<span class="nc bnc" id="L649" title="All 2 branches missed.">        if (applicationKvStore.getString(&quot;LastLocation&quot;) != null) {</span>
<span class="nc" id="L650">            final String[] locationLatLng</span>
<span class="nc" id="L651">                = applicationKvStore.getString(&quot;LastLocation&quot;).split(&quot;,&quot;);</span>
<span class="nc" id="L652">            lastKnownLocation</span>
<span class="nc" id="L653">                = new fr.free.nrw.commons.location.LatLng(Double.parseDouble(locationLatLng[0]),</span>
<span class="nc" id="L654">                Double.parseDouble(locationLatLng[1]), 1f);</span>
<span class="nc" id="L655">        } else {</span>
<span class="nc" id="L656">            lastKnownLocation = new fr.free.nrw.commons.location.LatLng(51.50550,</span>
                -0.07520, 1f);
        }
<span class="nc bnc" id="L659" title="All 2 branches missed.">        if (mapView != null) {</span>
<span class="nc" id="L660">            recenterMap(lastKnownLocation);</span>
        }
<span class="nc" id="L662">    }</span>

    private void registerNetworkReceiver() {
<span class="nc bnc" id="L665" title="All 2 branches missed.">        if (getActivity() != null) {</span>
<span class="nc" id="L666">            getActivity().registerReceiver(broadcastReceiver, intentFilter);</span>
        }
<span class="nc" id="L668">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L672">        super.onPause();</span>
<span class="nc" id="L673">        mapView.onPause();</span>
<span class="nc" id="L674">        compositeDisposable.clear();</span>
<span class="nc" id="L675">        presenter.detachView();</span>
<span class="nc" id="L676">        registerUnregisterLocationListener(true);</span>
        try {
<span class="nc bnc" id="L678" title="All 4 branches missed.">            if (broadcastReceiver != null &amp;&amp; getActivity() != null) {</span>
<span class="nc" id="L679">                getContext().unregisterReceiver(broadcastReceiver);</span>
            }

<span class="nc bnc" id="L682" title="All 4 branches missed.">            if (locationManager != null &amp;&amp; presenter != null) {</span>
<span class="nc" id="L683">                locationManager.removeLocationListener(presenter);</span>
<span class="nc" id="L684">                locationManager.unregisterLocationManager();</span>
            }
<span class="nc" id="L686">        } catch (final Exception e) {</span>
<span class="nc" id="L687">            Timber.e(e);</span>
            //Broadcast receivers should always be unregistered inside catch, you never know if they were already registered or not
<span class="nc" id="L689">        }</span>
<span class="nc" id="L690">    }</span>

    @Override
    public void onDestroyView() {
<span class="nc" id="L694">        super.onDestroyView();</span>
<span class="nc" id="L695">        presenter.removeNearbyPreferences(applicationKvStore);</span>
<span class="nc" id="L696">    }</span>

    private void initViews() {
<span class="nc" id="L699">        Timber.d(&quot;init views called&quot;);</span>
<span class="nc" id="L700">        initBottomSheets();</span>
<span class="nc" id="L701">        loadAnimations();</span>
<span class="nc" id="L702">        setBottomSheetCallbacks();</span>
<span class="nc" id="L703">        decideButtonVisibilities();</span>
<span class="nc" id="L704">        addActionToTitle();</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">        if (!Utils.isMonumentsEnabled(new Date())) {</span>
<span class="nc" id="L706">            chipWlm.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L708">    }</span>

    /**
     * a) Creates bottom sheet behaviours from bottom sheets, sets initial states and visibility b)
     * Gets the touch event on the map to perform following actions: if fab is open then close fab.
     * if bottom sheet details are expanded then collapse bottom sheet details. if bottom sheet
     * details are collapsed then hide the bottom sheet details. if listBottomSheet is open then
     * hide the list bottom sheet.
     */
    @SuppressLint(&quot;ClickableViewAccessibility&quot;)
    private void initBottomSheets() {
<span class="nc" id="L719">        bottomSheetListBehavior = BottomSheetBehavior.from(rlBottomSheet);</span>
<span class="nc" id="L720">        bottomSheetDetailsBehavior = BottomSheetBehavior.from(bottomSheetDetails);</span>
<span class="nc" id="L721">        bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
<span class="nc" id="L722">        bottomSheetDetails.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L723">        bottomSheetListBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
<span class="nc" id="L724">    }</span>

    public void initNearbyFilter() {
<span class="nc" id="L727">        nearbyFilterList.setVisibility(View.GONE);</span>
<span class="nc" id="L728">        hideBottomSheet();</span>
<span class="nc" id="L729">        searchView.setOnQueryTextFocusChangeListener((v, hasFocus) -&gt; {</span>
<span class="nc" id="L730">            LayoutUtils.setLayoutHeightAllignedToWidth(1.25, nearbyFilterList);</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">            if (hasFocus) {</span>
<span class="nc" id="L732">                nearbyFilterList.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L733">                presenter.searchViewGainedFocus();</span>
            } else {
<span class="nc" id="L735">                nearbyFilterList.setVisibility(View.GONE);</span>
            }
<span class="nc" id="L737">        });</span>
<span class="nc" id="L738">        recyclerView.setHasFixedSize(true);</span>
<span class="nc" id="L739">        recyclerView.addItemDecoration(new DividerItemDecoration(getContext(),</span>
            DividerItemDecoration.VERTICAL));
<span class="nc" id="L741">        final LinearLayoutManager linearLayoutManager = new LinearLayoutManager(getActivity());</span>
<span class="nc" id="L742">        linearLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</span>
<span class="nc" id="L743">        recyclerView.setLayoutManager(linearLayoutManager);</span>
<span class="nc" id="L744">        nearbyFilterSearchRecyclerViewAdapter = new NearbyFilterSearchRecyclerViewAdapter(</span>
<span class="nc" id="L745">            getContext(), new ArrayList&lt;&gt;(Label.valuesAsList()), recyclerView);</span>
<span class="nc" id="L746">        nearbyFilterSearchRecyclerViewAdapter.setCallback(</span>
<span class="nc" id="L747">            new NearbyFilterSearchRecyclerViewAdapter.Callback() {</span>
                @Override
                public void setCheckboxUnknown() {
<span class="nc" id="L750">                    presenter.setCheckboxUnknown();</span>
<span class="nc" id="L751">                }</span>

                @Override
                public void filterByMarkerType(final ArrayList&lt;Label&gt; selectedLabels, final int i,
                    final boolean b, final boolean b1) {
<span class="nc" id="L756">                    presenter.filterByMarkerType(selectedLabels, i, b, b1);</span>
<span class="nc" id="L757">                }</span>

                @Override
                public boolean isDarkTheme() {
<span class="nc" id="L761">                    return isDarkTheme;</span>
                }
            });
<span class="nc" id="L764">        nearbyFilterList.getLayoutParams().width = (int) LayoutUtils.getScreenWidth(getActivity(),</span>
            0.75);
<span class="nc" id="L766">        recyclerView.setAdapter(nearbyFilterSearchRecyclerViewAdapter);</span>
<span class="nc" id="L767">        LayoutUtils.setLayoutHeightAllignedToWidth(1.25, nearbyFilterList);</span>
<span class="nc" id="L768">        compositeDisposable.add(RxSearchView.queryTextChanges(searchView)</span>
<span class="nc" id="L769">            .takeUntil(RxView.detaches(searchView))</span>
<span class="nc" id="L770">            .debounce(500, TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L771">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L772">            .subscribe(query -&gt; {</span>
<span class="nc" id="L773">                ((NearbyFilterSearchRecyclerViewAdapter) recyclerView.getAdapter()).getFilter()</span>
<span class="nc" id="L774">                    .filter(query.toString());</span>
<span class="nc" id="L775">            }));</span>
<span class="nc" id="L776">        initFilterChips();</span>
<span class="nc" id="L777">    }</span>

    @Override
    public void setCheckBoxAction() {
<span class="nc" id="L781">        checkBoxTriStates.addAction();</span>
<span class="nc" id="L782">        checkBoxTriStates.setState(CheckBoxTriStates.UNKNOWN);</span>
<span class="nc" id="L783">    }</span>

    @Override
    public void setCheckBoxState(final int state) {
<span class="nc" id="L787">        checkBoxTriStates.setState(state);</span>
<span class="nc" id="L788">    }</span>

    @Override
    public void setFilterState() {
<span class="nc" id="L792">        chipNeedsPhoto.setChecked(NearbyFilterState.getInstance().isNeedPhotoSelected());</span>
<span class="nc" id="L793">        chipExists.setChecked(NearbyFilterState.getInstance().isExistsSelected());</span>
<span class="nc" id="L794">        chipWlm.setChecked(NearbyFilterState.getInstance().isWlmSelected());</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (NearbyController.currentLocation != null) {</span>
<span class="nc" id="L796">            presenter.filterByMarkerType(nearbyFilterSearchRecyclerViewAdapter.selectedLabels,</span>
<span class="nc" id="L797">                checkBoxTriStates.getState(), true, false);</span>
        }
<span class="nc" id="L799">    }</span>

    private void initFilterChips() {
<span class="nc" id="L802">        chipNeedsPhoto.setOnCheckedChangeListener((buttonView, isChecked) -&gt; {</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">            if (NearbyController.currentLocation != null) {</span>
<span class="nc" id="L804">                checkBoxTriStates.setState(CheckBoxTriStates.CHECKED);</span>
<span class="nc" id="L805">                NearbyFilterState.setNeedPhotoSelected(isChecked);</span>
<span class="nc" id="L806">                presenter.filterByMarkerType(nearbyFilterSearchRecyclerViewAdapter.selectedLabels,</span>
<span class="nc" id="L807">                    checkBoxTriStates.getState(), true, true);</span>
<span class="nc" id="L808">                updatePlaceList(chipNeedsPhoto.isChecked(),</span>
<span class="nc" id="L809">                    chipExists.isChecked(), chipWlm.isChecked());</span>
            } else {
<span class="nc bnc" id="L811" title="All 2 branches missed.">                chipNeedsPhoto.setChecked(!isChecked);</span>
            }
<span class="nc" id="L813">        });</span>

<span class="nc" id="L815">        chipExists.setOnCheckedChangeListener((buttonView, isChecked) -&gt; {</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">            if (NearbyController.currentLocation != null) {</span>
<span class="nc" id="L817">                checkBoxTriStates.setState(CheckBoxTriStates.CHECKED);</span>
<span class="nc" id="L818">                NearbyFilterState.setExistsSelected(isChecked);</span>
<span class="nc" id="L819">                presenter.filterByMarkerType(nearbyFilterSearchRecyclerViewAdapter.selectedLabels,</span>
<span class="nc" id="L820">                    checkBoxTriStates.getState(), true, true);</span>
<span class="nc" id="L821">                updatePlaceList(chipNeedsPhoto.isChecked(),</span>
<span class="nc" id="L822">                    chipExists.isChecked(), chipWlm.isChecked());</span>
            } else {
<span class="nc bnc" id="L824" title="All 2 branches missed.">                chipExists.setChecked(!isChecked);</span>
            }
<span class="nc" id="L826">        });</span>

<span class="nc" id="L828">        chipWlm.setOnCheckedChangeListener((buttonView, isChecked) -&gt; {</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">            if (NearbyController.currentLocation != null) {</span>
<span class="nc" id="L830">                checkBoxTriStates.setState(CheckBoxTriStates.CHECKED);</span>
<span class="nc" id="L831">                NearbyFilterState.setWlmSelected(isChecked);</span>
<span class="nc" id="L832">                presenter.filterByMarkerType(nearbyFilterSearchRecyclerViewAdapter.selectedLabels,</span>
<span class="nc" id="L833">                    checkBoxTriStates.getState(), true, true);</span>
<span class="nc" id="L834">                updatePlaceList(chipNeedsPhoto.isChecked(),</span>
<span class="nc" id="L835">                    chipExists.isChecked(), chipWlm.isChecked());</span>
            } else {
<span class="nc bnc" id="L837" title="All 2 branches missed.">                chipWlm.setChecked(!isChecked);</span>
            }
<span class="nc" id="L839">        });</span>
<span class="nc" id="L840">    }</span>

    /**
     * Updates Nearby place list according to available chip states
     *
     * @param needsPhoto is chipNeedsPhoto checked
     * @param exists     is chipExists checked
     * @param isWlm      is chipWlm checked
     */
    private void updatePlaceList(final boolean needsPhoto, final boolean exists,
        final boolean isWlm) {
<span class="nc" id="L851">        final List&lt;Place&gt; updatedPlaces = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L853" title="All 2 branches missed.">        if (needsPhoto) {</span>
            for (final Place place :
<span class="nc bnc" id="L855" title="All 2 branches missed.">                places) {</span>
<span class="nc bnc" id="L856" title="All 4 branches missed.">                if (place.pic.trim().isEmpty() &amp;&amp; !updatedPlaces.contains(place)) {</span>
<span class="nc" id="L857">                    updatedPlaces.add(place);</span>
                }
<span class="nc" id="L859">            }</span>
        } else {
<span class="nc" id="L861">            updatedPlaces.addAll(places);</span>
        }

<span class="nc bnc" id="L864" title="All 2 branches missed.">        if (exists) {</span>
<span class="nc" id="L865">            for (final Iterator&lt;Place&gt; placeIterator = updatedPlaces.iterator();</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">                placeIterator.hasNext(); ) {</span>
<span class="nc" id="L867">                final Place place = placeIterator.next();</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">                if (!place.exists) {</span>
<span class="nc" id="L869">                    placeIterator.remove();</span>
                }
<span class="nc" id="L871">            }</span>
        }

<span class="nc bnc" id="L874" title="All 2 branches missed.">        if (!isWlm) {</span>
            for (final Place place :
<span class="nc bnc" id="L876" title="All 2 branches missed.">                places) {</span>
<span class="nc bnc" id="L877" title="All 4 branches missed.">                if (place.isMonument() &amp;&amp; updatedPlaces.contains(place)) {</span>
<span class="nc" id="L878">                    updatedPlaces.remove(place);</span>
                }
<span class="nc" id="L880">            }</span>
        } else {
            for (final Place place :
<span class="nc bnc" id="L883" title="All 2 branches missed.">                places) {</span>
<span class="nc bnc" id="L884" title="All 4 branches missed.">                if (place.isMonument() &amp;&amp; !updatedPlaces.contains(place)) {</span>
<span class="nc" id="L885">                    updatedPlaces.add(place);</span>
                }
<span class="nc" id="L887">            }</span>
        }

<span class="nc" id="L890">        adapter.setItems(updatedPlaces);</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">        noResultsView.setVisibility(updatedPlaces.isEmpty() ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L892">    }</span>

    /**
     * Defines how bottom sheets will act on click
     */
    private void setBottomSheetCallbacks() {
<span class="nc" id="L898">        bottomSheetDetailsBehavior.setBottomSheetCallback(new BottomSheetBehavior</span>
<span class="nc" id="L899">            .BottomSheetCallback() {</span>
            @Override
            public void onStateChanged(@NonNull final View bottomSheet, final int newState) {
<span class="nc" id="L902">                prepareViewsForSheetPosition(newState);</span>
<span class="nc" id="L903">            }</span>

            @Override
            public void onSlide(@NonNull final View bottomSheet, final float slideOffset) {

<span class="nc" id="L908">            }</span>
        });

<span class="nc" id="L911">        bottomSheetDetails.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">            if (bottomSheetDetailsBehavior.getState() == BottomSheetBehavior.STATE_COLLAPSED) {</span>
<span class="nc" id="L913">                bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_EXPANDED);</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">            } else if (bottomSheetDetailsBehavior.getState()</span>
                == BottomSheetBehavior.STATE_EXPANDED) {
<span class="nc" id="L916">                bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_COLLAPSED);</span>
            }
<span class="nc" id="L918">        });</span>

<span class="nc" id="L920">        rlBottomSheet.getLayoutParams().height = getActivity().getWindowManager()</span>
<span class="nc" id="L921">            .getDefaultDisplay().getHeight() / 16 * 9;</span>
<span class="nc" id="L922">        bottomSheetListBehavior = BottomSheetBehavior.from(rlBottomSheet);</span>
<span class="nc" id="L923">        bottomSheetListBehavior.setState(BottomSheetBehavior.STATE_COLLAPSED);</span>
<span class="nc" id="L924">        bottomSheetListBehavior.setBottomSheetCallback(new BottomSheetBehavior</span>
<span class="nc" id="L925">            .BottomSheetCallback() {</span>
            @Override
            public void onStateChanged(@NonNull final View bottomSheet, final int newState) {
<span class="nc bnc" id="L928" title="All 2 branches missed.">                if (newState == BottomSheetBehavior.STATE_EXPANDED) {</span>
<span class="nc" id="L929">                    bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
                }
<span class="nc" id="L931">            }</span>

            @Override
            public void onSlide(@NonNull final View bottomSheet, final float slideOffset) {

<span class="nc" id="L936">            }</span>
        });
<span class="nc" id="L938">    }</span>

    /**
     * Loads animations will be used for FABs
     */
    private void loadAnimations() {
<span class="nc" id="L944">        fab_open = AnimationUtils.loadAnimation(getActivity(), R.anim.fab_open);</span>
<span class="nc" id="L945">        fab_close = AnimationUtils.loadAnimation(getActivity(), R.anim.fab_close);</span>
<span class="nc" id="L946">        rotate_forward = AnimationUtils.loadAnimation(getActivity(), R.anim.rotate_forward);</span>
<span class="nc" id="L947">        rotate_backward = AnimationUtils.loadAnimation(getActivity(), R.anim.rotate_backward);</span>
<span class="nc" id="L948">    }</span>

    /**
     * Fits buttons according to our layout
     */
    private void decideButtonVisibilities() {
        // Remove button text if they exceed 1 line or if internal layout has not been built
        // Only need to check for directions button because it is the longest
<span class="nc bnc" id="L956" title="All 4 branches missed.">        if (directionsButtonText.getLineCount() &gt; 1 || directionsButtonText.getLineCount() == 0) {</span>
<span class="nc" id="L957">            wikipediaButtonText.setVisibility(View.GONE);</span>
<span class="nc" id="L958">            wikidataButtonText.setVisibility(View.GONE);</span>
<span class="nc" id="L959">            commonsButtonText.setVisibility(View.GONE);</span>
<span class="nc" id="L960">            directionsButtonText.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L962">    }</span>

    /**
     *
     */
    private void addActionToTitle() {
<span class="nc" id="L968">        title.setOnLongClickListener(view -&gt; {</span>
<span class="nc" id="L969">            Utils.copy(&quot;place&quot;, title.getText().toString(), getContext());</span>
<span class="nc" id="L970">            Toast.makeText(getContext(), R.string.text_copy, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L971">            return true;</span>
        });

<span class="nc" id="L974">        title.setOnClickListener(view -&gt; {</span>
<span class="nc" id="L975">            bottomSheetListBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">            if (bottomSheetDetailsBehavior.getState() == BottomSheetBehavior.STATE_COLLAPSED) {</span>
<span class="nc" id="L977">                bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_EXPANDED);</span>
            } else {
<span class="nc" id="L979">                bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_COLLAPSED);</span>
            }
<span class="nc" id="L981">        });</span>
<span class="nc" id="L982">    }</span>

    /**
     * Centers the map in nearby fragment to a given place and updates nearestPlace
     *
     * @param place is new center of the map
     */
    @Override
    public void centerMapToPlace(@Nullable final Place place) {
<span class="nc" id="L991">        Timber.d(&quot;Map is centered to place&quot;);</span>
        final double cameraShift;
<span class="nc bnc" id="L993" title="All 2 branches missed.">        if (null != place) {</span>
<span class="nc" id="L994">            lastPlaceToCenter = place;</span>
<span class="nc" id="L995">            nearestPlace = place;</span>
        }

<span class="nc bnc" id="L998" title="All 2 branches missed.">        if (null != lastPlaceToCenter) {</span>
<span class="nc" id="L999">            final Configuration configuration = getActivity().getResources().getConfiguration();</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">            if (configuration.orientation == Configuration.ORIENTATION_PORTRAIT) {</span>
<span class="nc" id="L1001">                cameraShift = CAMERA_TARGET_SHIFT_FACTOR_PORTRAIT;</span>
            } else {
<span class="nc" id="L1003">                cameraShift = CAMERA_TARGET_SHIFT_FACTOR_LANDSCAPE;</span>
            }
<span class="nc" id="L1005">            recenterMap(new fr.free.nrw.commons.location.LatLng(</span>
<span class="nc" id="L1006">                lastPlaceToCenter.location.getLatitude() - cameraShift,</span>
<span class="nc" id="L1007">                lastPlaceToCenter.getLocation().getLongitude(), 0));</span>
        }
<span class="nc" id="L1009">    }</span>


    @Override
    public void updateListFragment(final List&lt;Place&gt; placeList) {
<span class="nc" id="L1014">        places = placeList;</span>
<span class="nc" id="L1015">        adapter.setItems(placeList);</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">        noResultsView.setVisibility(placeList.isEmpty() ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L1017">    }</span>

    @Override
    public fr.free.nrw.commons.location.LatLng getLastLocation() {
<span class="nc" id="L1021">        return lastKnownLocation;</span>
    }

    @Override
    public fr.free.nrw.commons.location.LatLng getLastMapFocus() {
<span class="nc" id="L1026">        fr.free.nrw.commons.location.LatLng latLng = new fr.free.nrw.commons.location.LatLng(</span>
<span class="nc" id="L1027">            lastMapFocus.getLatitude(), lastMapFocus.getLongitude(), 100);</span>
<span class="nc" id="L1028">        return latLng;</span>
    }

    /**
     * Computes location where map should be centered
     *
     * @return returns the last location, if available, else returns default location
     */
    @Override
    public fr.free.nrw.commons.location.LatLng getMapCenter() {
<span class="nc bnc" id="L1038" title="All 2 branches missed.">        if (applicationKvStore.getString(&quot;LastLocation&quot;) != null) {</span>
<span class="nc" id="L1039">            final String[] locationLatLng</span>
<span class="nc" id="L1040">                = applicationKvStore.getString(&quot;LastLocation&quot;).split(&quot;,&quot;);</span>
<span class="nc" id="L1041">            lastKnownLocation</span>
<span class="nc" id="L1042">                = new fr.free.nrw.commons.location.LatLng(Double.parseDouble(locationLatLng[0]),</span>
<span class="nc" id="L1043">                Double.parseDouble(locationLatLng[1]), 1f);</span>
<span class="nc" id="L1044">        } else {</span>
<span class="nc" id="L1045">            lastKnownLocation = new fr.free.nrw.commons.location.LatLng(51.50550,</span>
                -0.07520, 1f);
        }
<span class="nc" id="L1048">        fr.free.nrw.commons.location.LatLng latLnge = lastKnownLocation;</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">        if (mapCenter != null) {</span>
<span class="nc" id="L1050">            latLnge = new fr.free.nrw.commons.location.LatLng(</span>
<span class="nc" id="L1051">                mapCenter.getLatitude(), mapCenter.getLongitude(), 100);</span>
        }
<span class="nc" id="L1053">        return latLnge;</span>
    }

    @Override
    public fr.free.nrw.commons.location.LatLng getMapFocus() {
<span class="nc" id="L1058">        fr.free.nrw.commons.location.LatLng mapFocusedLatLng = new fr.free.nrw.commons.location.LatLng(</span>
<span class="nc" id="L1059">            mapView.getMapCenter().getLatitude(), mapView.getMapCenter().getLongitude(), 100);</span>
<span class="nc" id="L1060">        return mapFocusedLatLng;</span>
    }

    @Override
    public LatLng getLastFocusLocation() {
<span class="nc bnc" id="L1065" title="All 2 branches missed.">        return lastFocusLocation == null ? null</span>
<span class="nc" id="L1066">            : LocationUtils.commonsLatLngToMapBoxLatLng(lastFocusLocation);</span>
    }

    @Override
    public boolean isCurrentLocationMarkerVisible() {
<span class="nc bnc" id="L1071" title="All 4 branches missed.">        if (latLngBounds == null || currentLocationMarker == null) {</span>
<span class="nc" id="L1072">            Timber.d(&quot;Map projection bounds are null&quot;);</span>
<span class="nc" id="L1073">            return false;</span>
        } else {
<span class="nc" id="L1075">            return latLngBounds.contains(currentLocationMarker.getPosition());</span>
        }
    }

    @Override
    public boolean isAdvancedQueryFragmentVisible() {
<span class="nc" id="L1081">        return isAdvancedQueryFragmentVisible;</span>
    }

    @Override
    public void showHideAdvancedQueryFragment(final boolean shouldShow) {
<span class="nc bnc" id="L1086" title="All 2 branches missed.">        setHasOptionsMenu(!shouldShow);</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">        flConainerNearbyChildren.setVisibility(shouldShow ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L1088">        isAdvancedQueryFragmentVisible = shouldShow;</span>
<span class="nc" id="L1089">    }</span>

    @Override
    public void centerMapToPosition(fr.free.nrw.commons.location.LatLng searchLatLng) {
<span class="nc bnc" id="L1093" title="All 2 branches missed.">        if (null != searchLatLng &amp;&amp; !(</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">            mapView.getMapCenter().getLatitude() == searchLatLng.getLatitude()</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">                &amp;&amp; mapView.getMapCenter().getLongitude() == searchLatLng.getLongitude())) {</span>
<span class="nc" id="L1096">            recenterMarkerToPosition(</span>
<span class="nc" id="L1097">                new GeoPoint(searchLatLng.getLatitude(), searchLatLng.getLongitude()));</span>
        }
<span class="nc" id="L1099">    }</span>

    @Override
    public boolean isNetworkConnectionEstablished() {
<span class="nc" id="L1103">        return NetworkUtils.isInternetConnectionEstablished(getActivity());</span>
    }

    /**
     * Adds network broadcast receiver to recognize connection established
     */
    private void initNetworkBroadCastReceiver() {
<span class="nc" id="L1110">        broadcastReceiver = new BroadcastReceiver() {</span>
            @Override
            public void onReceive(final Context context, final Intent intent) {
<span class="nc bnc" id="L1113" title="All 2 branches missed.">                if (getActivity() != null) {</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">                    if (NetworkUtils.isInternetConnectionEstablished(getActivity())) {</span>
<span class="nc bnc" id="L1115" title="All 2 branches missed.">                        if (isNetworkErrorOccurred) {</span>
<span class="nc" id="L1116">                            presenter.updateMapAndList(LOCATION_SIGNIFICANTLY_CHANGED);</span>
<span class="nc" id="L1117">                            isNetworkErrorOccurred = false;</span>
                        }

<span class="nc bnc" id="L1120" title="All 2 branches missed.">                        if (snackbar != null) {</span>
<span class="nc" id="L1121">                            snackbar.dismiss();</span>
<span class="nc" id="L1122">                            snackbar = null;</span>
                        }
                    } else {
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                        if (snackbar == null) {</span>
<span class="nc" id="L1126">                            snackbar = Snackbar.make(view, R.string.no_internet,</span>
                                Snackbar.LENGTH_INDEFINITE);
<span class="nc" id="L1128">                            setSearchThisAreaButtonVisibility(false);</span>
<span class="nc" id="L1129">                            setProgressBarVisibility(false);</span>
                        }

<span class="nc" id="L1132">                        isNetworkErrorOccurred = true;</span>
<span class="nc" id="L1133">                        snackbar.show();</span>
                    }
                }
<span class="nc" id="L1136">            }</span>
        };
<span class="nc" id="L1138">    }</span>

    /**
     * Hide or expand bottom sheet according to states of all sheets
     */
    @Override
    public void listOptionMenuItemClicked() {
<span class="nc" id="L1145">        bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
<span class="nc bnc" id="L1146" title="All 2 branches missed.">        if (bottomSheetListBehavior.getState() == BottomSheetBehavior.STATE_COLLAPSED</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">            || bottomSheetListBehavior.getState() == BottomSheetBehavior.STATE_HIDDEN) {</span>
<span class="nc" id="L1148">            bottomSheetListBehavior.setState(BottomSheetBehavior.STATE_EXPANDED);</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">        } else if (bottomSheetListBehavior.getState() == BottomSheetBehavior.STATE_EXPANDED) {</span>
<span class="nc" id="L1150">            bottomSheetListBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
        }
<span class="nc" id="L1152">    }</span>

    @Override
    public void populatePlaces(final fr.free.nrw.commons.location.LatLng curlatLng) {
<span class="nc bnc" id="L1156" title="All 2 branches missed.">        if (curlatLng.equals(getLastMapFocus())) { // Means we are checking around current location</span>
<span class="nc" id="L1157">            populatePlacesForCurrentLocation(getLastMapFocus(), curlatLng, null);</span>
        } else {
<span class="nc" id="L1159">            populatePlacesForAnotherLocation(getLastMapFocus(), curlatLng, null);</span>
        }
<span class="nc bnc" id="L1161" title="All 2 branches missed.">        if (recenterToUserLocation) {</span>
<span class="nc" id="L1162">            recenterToUserLocation = false;</span>
        }
<span class="nc" id="L1164">    }</span>

    @Override
    public void populatePlaces(final fr.free.nrw.commons.location.LatLng curlatLng,
        @Nullable final String customQuery) {
<span class="nc bnc" id="L1169" title="All 4 branches missed.">        if (customQuery == null || customQuery.isEmpty()) {</span>
<span class="nc" id="L1170">            populatePlaces(curlatLng);</span>
<span class="nc" id="L1171">            return;</span>
        }

<span class="nc bnc" id="L1174" title="All 6 branches missed.">        if (curlatLng.equals(lastFocusLocation) || lastFocusLocation == null</span>
            || recenterToUserLocation) { // Means we are checking around current location
<span class="nc" id="L1176">            populatePlacesForCurrentLocation(lastKnownLocation, curlatLng, customQuery);</span>
        } else {
<span class="nc" id="L1178">            populatePlacesForAnotherLocation(lastKnownLocation, curlatLng, customQuery);</span>
        }
<span class="nc bnc" id="L1180" title="All 2 branches missed.">        if (recenterToUserLocation) {</span>
<span class="nc" id="L1181">            recenterToUserLocation = false;</span>
        }
<span class="nc" id="L1183">    }</span>

    private void populatePlacesForCurrentLocation(
        final fr.free.nrw.commons.location.LatLng curlatLng,
        final fr.free.nrw.commons.location.LatLng searchLatLng,
        @Nullable final String customQuery) {
<span class="nc" id="L1189">        final Observable&lt;NearbyController.NearbyPlacesInfo&gt; nearbyPlacesInfoObservable = Observable</span>
<span class="nc" id="L1190">            .fromCallable(() -&gt; nearbyController</span>
<span class="nc" id="L1191">                .loadAttractionsFromLocation(curlatLng, searchLatLng,</span>
<span class="nc" id="L1192">                    false, true, Utils.isMonumentsEnabled(new Date()), customQuery));</span>

<span class="nc" id="L1194">        compositeDisposable.add(nearbyPlacesInfoObservable</span>
<span class="nc" id="L1195">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L1196">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1197">            .subscribe(nearbyPlacesInfo -&gt; {</span>
<span class="nc bnc" id="L1198" title="All 4 branches missed.">                    if (nearbyPlacesInfo.placeList == null || nearbyPlacesInfo.placeList.isEmpty()) {</span>
<span class="nc" id="L1199">                        showErrorMessage(getString(R.string.no_nearby_places_around));</span>
                    } else {
<span class="nc" id="L1201">                        updateMapMarkers(nearbyPlacesInfo, true);</span>
<span class="nc" id="L1202">                        lastFocusLocation = searchLatLng;</span>
<span class="nc" id="L1203">                        lastMapFocus = new GeoPoint(searchLatLng.getLatitude(),</span>
<span class="nc" id="L1204">                            searchLatLng.getLongitude());</span>
                    }
<span class="nc" id="L1206">                },</span>
                throwable -&gt; {
<span class="nc" id="L1208">                    Timber.d(throwable);</span>
<span class="nc" id="L1209">                    showErrorMessage(getString(R.string.error_fetching_nearby_places)</span>
<span class="nc" id="L1210">                        + throwable.getLocalizedMessage());</span>
<span class="nc" id="L1211">                    setProgressBarVisibility(false);</span>
<span class="nc" id="L1212">                    presenter.lockUnlockNearby(false);</span>
<span class="nc" id="L1213">                    setFilterState();</span>
<span class="nc" id="L1214">                }));</span>
<span class="nc" id="L1215">    }</span>

    private void populatePlacesForAnotherLocation(
        final fr.free.nrw.commons.location.LatLng curlatLng,
        final fr.free.nrw.commons.location.LatLng searchLatLng,
        @Nullable final String customQuery) {
<span class="nc" id="L1221">        final Observable&lt;NearbyPlacesInfo&gt; nearbyPlacesInfoObservable = Observable</span>
<span class="nc" id="L1222">            .fromCallable(() -&gt; nearbyController</span>
<span class="nc" id="L1223">                .loadAttractionsFromLocation(curlatLng, searchLatLng,</span>
<span class="nc" id="L1224">                    false, true, Utils.isMonumentsEnabled(new Date()), customQuery));</span>

<span class="nc" id="L1226">        compositeDisposable.add(nearbyPlacesInfoObservable</span>
<span class="nc" id="L1227">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L1228">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1229">            .subscribe(nearbyPlacesInfo -&gt; {</span>
<span class="nc bnc" id="L1230" title="All 4 branches missed.">                    if (nearbyPlacesInfo.placeList == null || nearbyPlacesInfo.placeList.isEmpty()) {</span>
<span class="nc" id="L1231">                        showErrorMessage(getString(R.string.no_nearby_places_around));</span>
                    } else {
                        // Updating last searched location
<span class="nc" id="L1234">                        applicationKvStore.putString(&quot;LastLocation&quot;,</span>
<span class="nc" id="L1235">                            searchLatLng.getLatitude() + &quot;,&quot; + searchLatLng.getLongitude());</span>
<span class="nc" id="L1236">                        updateMapMarkers(nearbyPlacesInfo, false);</span>
<span class="nc" id="L1237">                        lastMapFocus = new GeoPoint(searchLatLng.getLatitude(),</span>
<span class="nc" id="L1238">                            searchLatLng.getLongitude());</span>
                    }
<span class="nc" id="L1240">                },</span>
                throwable -&gt; {
<span class="nc" id="L1242">                    Timber.e(throwable);</span>
<span class="nc" id="L1243">                    showErrorMessage(getString(R.string.error_fetching_nearby_places)</span>
<span class="nc" id="L1244">                        + throwable.getLocalizedMessage());</span>
<span class="nc" id="L1245">                    setProgressBarVisibility(false);</span>
<span class="nc" id="L1246">                    presenter.lockUnlockNearby(false);</span>
<span class="nc" id="L1247">                    setFilterState();</span>
<span class="nc" id="L1248">                }));</span>
<span class="nc" id="L1249">    }</span>

    /**
     * Populates places for your location, should be used for finding nearby places around a
     * location where you are.
     *
     * @param nearbyPlacesInfo This variable has place list information and distances.
     */
    private void updateMapMarkers(final NearbyController.NearbyPlacesInfo nearbyPlacesInfo,
        final boolean shouldUpdateSelectedMarker) {
<span class="nc" id="L1259">        presenter.updateMapMarkers(nearbyPlacesInfo, selectedMarker, shouldUpdateSelectedMarker);</span>
        //TODO
<span class="nc" id="L1261">        setFilterState();</span>
<span class="nc" id="L1262">    }</span>


    @Override
    public boolean isListBottomSheetExpanded() {
<span class="nc bnc" id="L1267" title="All 2 branches missed.">        return bottomSheetListBehavior.getState() == BottomSheetBehavior.STATE_EXPANDED;</span>
    }

    @Override
    public boolean isDetailsBottomSheetVisible() {
<span class="nc bnc" id="L1272" title="All 2 branches missed.">        return !(bottomSheetDetailsBehavior.getState() == BottomSheetBehavior.STATE_HIDDEN);</span>
    }

    @Override
    public void setBottomSheetDetailsSmaller() {
<span class="nc bnc" id="L1277" title="All 2 branches missed.">        if (bottomSheetDetailsBehavior.getState() == BottomSheetBehavior.STATE_EXPANDED) {</span>
<span class="nc" id="L1278">            bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_COLLAPSED);</span>
        } else {
<span class="nc" id="L1280">            bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
        }
<span class="nc" id="L1282">    }</span>

    @Override
    public void addSearchThisAreaButtonAction() {
<span class="nc" id="L1286">        searchThisAreaButton.setOnClickListener(presenter.onSearchThisAreaClicked());</span>
<span class="nc" id="L1287">    }</span>

    @Override
    public void setSearchThisAreaButtonVisibility(final boolean isVisible) {
<span class="nc bnc" id="L1291" title="All 2 branches missed.">        if (isVisible) {</span>
<span class="nc" id="L1292">            searchThisAreaButton.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L1294">            searchThisAreaButton.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L1296">    }</span>

    @Override
    public void setRecyclerViewAdapterAllSelected() {
<span class="nc bnc" id="L1300" title="All 4 branches missed.">        if (nearbyFilterSearchRecyclerViewAdapter != null</span>
            &amp;&amp; NearbyController.currentLocation != null) {
<span class="nc" id="L1302">            nearbyFilterSearchRecyclerViewAdapter.setRecyclerViewAdapterAllSelected();</span>
        }
<span class="nc" id="L1304">    }</span>

    @Override
    public void setRecyclerViewAdapterItemsGreyedOut() {
<span class="nc bnc" id="L1308" title="All 4 branches missed.">        if (nearbyFilterSearchRecyclerViewAdapter != null</span>
            &amp;&amp; NearbyController.currentLocation != null) {
<span class="nc" id="L1310">            nearbyFilterSearchRecyclerViewAdapter.setRecyclerViewAdapterItemsGreyedOut();</span>
        }
<span class="nc" id="L1312">    }</span>

    @Override
    public void setProgressBarVisibility(final boolean isVisible) {
<span class="nc bnc" id="L1316" title="All 2 branches missed.">        if (isVisible) {</span>
<span class="nc" id="L1317">            progressBar.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L1319">            progressBar.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L1321">    }</span>

    @Override
    public void setTabItemContributions() {
<span class="nc" id="L1325">        ((MainActivity) getActivity()).viewPager.setCurrentItem(0);</span>
        // TODO
<span class="nc" id="L1327">    }</span>

    @Override
    public void checkPermissionsAndPerformAction() {
<span class="nc" id="L1331">        Timber.d(&quot;Checking permission and perfoming action&quot;);</span>
<span class="nc" id="L1332">        locationPermissionLauncher.launch(permission.ACCESS_FINE_LOCATION);</span>
<span class="nc" id="L1333">    }</span>

    /**
     * Starts animation of fab plus (turning on opening) and other FABs
     */
    @Override
    public void animateFABs() {
<span class="nc bnc" id="L1340" title="All 2 branches missed.">        if (fabPlus.isShown()) {</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">            if (isFABsExpanded) {</span>
<span class="nc" id="L1342">                collapseFABs(isFABsExpanded);</span>
            } else {
<span class="nc" id="L1344">                expandFABs(isFABsExpanded);</span>
            }
        }
<span class="nc" id="L1347">    }</span>

    private void showFABs() {
<span class="nc" id="L1350">        NearbyFABUtils.addAnchorToBigFABs(fabPlus, bottomSheetDetails.getId());</span>
<span class="nc" id="L1351">        fabPlus.show();</span>
<span class="nc" id="L1352">        NearbyFABUtils.addAnchorToSmallFABs(fabGallery,</span>
<span class="nc" id="L1353">            getView().findViewById(R.id.empty_view).getId());</span>
<span class="nc" id="L1354">        NearbyFABUtils.addAnchorToSmallFABs(fabCamera,</span>
<span class="nc" id="L1355">            getView().findViewById(R.id.empty_view1).getId());</span>
<span class="nc" id="L1356">    }</span>

    /**
     * Expands camera and gallery FABs, turn forward plus FAB
     *
     * @param isFABsExpanded true if they are already expanded
     */
    private void expandFABs(final boolean isFABsExpanded) {
<span class="nc bnc" id="L1364" title="All 2 branches missed.">        if (!isFABsExpanded) {</span>
<span class="nc" id="L1365">            showFABs();</span>
<span class="nc" id="L1366">            fabPlus.startAnimation(rotate_forward);</span>
<span class="nc" id="L1367">            fabCamera.startAnimation(fab_open);</span>
<span class="nc" id="L1368">            fabGallery.startAnimation(fab_open);</span>
<span class="nc" id="L1369">            fabCamera.show();</span>
<span class="nc" id="L1370">            fabGallery.show();</span>
<span class="nc" id="L1371">            this.isFABsExpanded = true;</span>
        }
<span class="nc" id="L1373">    }</span>

    /**
     * Hides all fabs
     */
    private void hideFABs() {
<span class="nc" id="L1379">        NearbyFABUtils.removeAnchorFromFAB(fabPlus);</span>
<span class="nc" id="L1380">        fabPlus.hide();</span>
<span class="nc" id="L1381">        NearbyFABUtils.removeAnchorFromFAB(fabCamera);</span>
<span class="nc" id="L1382">        fabCamera.hide();</span>
<span class="nc" id="L1383">        NearbyFABUtils.removeAnchorFromFAB(fabGallery);</span>
<span class="nc" id="L1384">        fabGallery.hide();</span>
<span class="nc" id="L1385">    }</span>

    /**
     * Collapses camera and gallery FABs, turn back plus FAB
     *
     * @param isFABsExpanded
     */
    private void collapseFABs(final boolean isFABsExpanded) {
<span class="nc bnc" id="L1393" title="All 2 branches missed.">        if (isFABsExpanded) {</span>
<span class="nc" id="L1394">            fabPlus.startAnimation(rotate_backward);</span>
<span class="nc" id="L1395">            fabCamera.startAnimation(fab_close);</span>
<span class="nc" id="L1396">            fabGallery.startAnimation(fab_close);</span>
<span class="nc" id="L1397">            fabCamera.hide();</span>
<span class="nc" id="L1398">            fabGallery.hide();</span>
<span class="nc" id="L1399">            this.isFABsExpanded = false;</span>
        }
<span class="nc" id="L1401">    }</span>

    @Override
    public void displayLoginSkippedWarning() {
<span class="nc bnc" id="L1405" title="All 2 branches missed.">        if (applicationKvStore.getBoolean(&quot;login_skipped&quot;, false)) {</span>
            // prompt the user to login
<span class="nc" id="L1407">            new AlertDialog.Builder(getContext())</span>
<span class="nc" id="L1408">                .setMessage(R.string.login_alert_message)</span>
<span class="nc" id="L1409">                .setPositiveButton(R.string.login, (dialog, which) -&gt; {</span>
                    // logout of the app
<span class="nc" id="L1411">                    BaseLogoutListener logoutListener = new BaseLogoutListener();</span>
<span class="nc" id="L1412">                    CommonsApplication app = (CommonsApplication) getActivity().getApplication();</span>
<span class="nc" id="L1413">                    app.clearApplicationData(getContext(), logoutListener);</span>
<span class="nc" id="L1414">                })</span>
<span class="nc" id="L1415">                .show();</span>
        }
<span class="nc" id="L1417">    }</span>

    private void handleLocationUpdate(final fr.free.nrw.commons.location.LatLng latLng,
        final LocationServiceManager.LocationChangeType locationChangeType) {
<span class="nc" id="L1421">        lastKnownLocation = latLng;</span>
<span class="nc" id="L1422">        NearbyController.currentLocation = lastKnownLocation;</span>
<span class="nc" id="L1423">        presenter.updateMapAndList(locationChangeType);</span>
<span class="nc" id="L1424">    }</span>

    @Override
    public void onLocationChangedSignificantly(final fr.free.nrw.commons.location.LatLng latLng) {
<span class="nc" id="L1428">        Timber.d(&quot;Location significantly changed&quot;);</span>
<span class="nc bnc" id="L1429" title="All 2 branches missed.">        if (latLng != null) {</span>
<span class="nc" id="L1430">            handleLocationUpdate(latLng, LOCATION_SIGNIFICANTLY_CHANGED);</span>
        }
<span class="nc" id="L1432">    }</span>

    @Override
    public void onLocationChangedSlightly(final fr.free.nrw.commons.location.LatLng latLng) {
<span class="nc" id="L1436">        Timber.d(&quot;Location slightly changed&quot;);</span>
<span class="nc bnc" id="L1437" title="All 2 branches missed.">        if (latLng != null) {//If the map has never ever shown the current location, lets do it know</span>
<span class="nc" id="L1438">            handleLocationUpdate(latLng, LOCATION_SLIGHTLY_CHANGED);</span>
        }
<span class="nc" id="L1440">    }</span>

    @Override
    public void onLocationChangedMedium(final fr.free.nrw.commons.location.LatLng latLng) {
<span class="nc" id="L1444">        Timber.d(&quot;Location changed medium&quot;);</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">        if (latLng != null) {//If the map has never ever shown the current location, lets do it know</span>
<span class="nc" id="L1446">            handleLocationUpdate(latLng, LOCATION_SIGNIFICANTLY_CHANGED);</span>
        }
<span class="nc" id="L1448">    }</span>

    public boolean backButtonClicked() {
<span class="nc" id="L1451">        return presenter.backButtonClicked();</span>
    }

    /**
     * onLogoutComplete is called after shared preferences and data stored in local database are
     * cleared.
     */
<span class="nc" id="L1458">    private class BaseLogoutListener implements CommonsApplication.LogoutListener {</span>

        @Override
        public void onLogoutComplete() {
<span class="nc" id="L1462">            Timber.d(&quot;Logout complete callback received.&quot;);</span>
<span class="nc" id="L1463">            final Intent nearbyIntent = new Intent(getActivity(), LoginActivity.class);</span>
<span class="nc" id="L1464">            nearbyIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);</span>
<span class="nc" id="L1465">            nearbyIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L1466">            startActivity(nearbyIntent);</span>
<span class="nc" id="L1467">            getActivity().finish();</span>
<span class="nc" id="L1468">        }</span>
    }

    @Override
    public void setFABPlusAction(final View.OnClickListener onClickListener) {
<span class="nc" id="L1473">        fabPlus.setOnClickListener(onClickListener);</span>
<span class="nc" id="L1474">    }</span>

    @Override
    public void setFABRecenterAction(final View.OnClickListener onClickListener) {
<span class="nc" id="L1478">        fabRecenter.setOnClickListener(onClickListener);</span>
<span class="nc" id="L1479">    }</span>

    @Override
    public void disableFABRecenter() {
<span class="nc" id="L1483">        fabRecenter.setEnabled(false);</span>
<span class="nc" id="L1484">    }</span>

    @Override
    public void enableFABRecenter() {
<span class="nc" id="L1488">        fabRecenter.setEnabled(true);</span>
<span class="nc" id="L1489">    }</span>

    /**
     * Adds a marker for the user's current position. Adds a circle which uses the accuracy * 2, to
     * draw a circle which represents the user's position with an accuracy of 95%.
     * &lt;p&gt;
     * Should be called only on creation of mapboxMap, there is other method to update markers
     * location with users move.
     *
     * @param curLatLng current location
     */
    @Override
    public void addCurrentLocationMarker(final fr.free.nrw.commons.location.LatLng curLatLng) {
<span class="nc bnc" id="L1502" title="All 6 branches missed.">        if (null != curLatLng &amp;&amp; !isPermissionDenied &amp;&amp; locationManager.isGPSProviderEnabled()) {</span>
<span class="nc" id="L1503">            ExecutorUtils.get().submit(() -&gt; {</span>
<span class="nc" id="L1504">                Timber.d(&quot;Adds current location marker&quot;);</span>
<span class="nc" id="L1505">                recenterMarkerToPosition(</span>
<span class="nc" id="L1506">                    new GeoPoint(curLatLng.getLatitude(), curLatLng.getLongitude()));</span>
<span class="nc" id="L1507">            });</span>
        } else {
<span class="nc" id="L1509">            Timber.d(&quot;not adding current location marker..current location is null&quot;);</span>
        }
<span class="nc" id="L1511">    }</span>

    /**
     * Makes map camera follow users location with animation
     *
     * @param curLatLng current location of user
     */
    @Override
    public void updateMapToTrackPosition(final fr.free.nrw.commons.location.LatLng curLatLng) {
<span class="nc" id="L1520">        Timber.d(&quot;Updates map camera to track user position&quot;);</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">        if (null != mapView) {</span>
<span class="nc" id="L1522">            recenterMap(curLatLng);</span>
        }
<span class="nc" id="L1524">    }</span>

    @Override
    public void updateMapMarkers(final List&lt;NearbyBaseMarker&gt; nearbyBaseMarkers,
        final Marker selectedMarker) {
<span class="nc bnc" id="L1529" title="All 2 branches missed.">        if (mapView != null) {</span>
<span class="nc" id="L1530">            presenter.updateMapMarkersToController(nearbyBaseMarkers);</span>
        }
<span class="nc" id="L1532">    }</span>

    @Override
    public void filterOutAllMarkers() {
<span class="nc" id="L1536">        clearAllMarkers();</span>
<span class="nc" id="L1537">    }</span>

    /**
     * Displays all markers
     */
    @Override
    public void displayAllMarkers() {
<span class="nc bnc" id="L1544" title="All 2 branches missed.">        for (final MarkerPlaceGroup markerPlaceGroup : NearbyController.markerLabelList) {</span>
<span class="nc" id="L1545">            updateMarker(markerPlaceGroup.getIsBookmarked(), markerPlaceGroup.getPlace(),</span>
                NearbyController.currentLocation);
<span class="nc" id="L1547">        }</span>
<span class="nc" id="L1548">    }</span>

    /**
     * Filters markers based on selectedLabels and chips
     *
     * @param selectedLabels       label list that user clicked
     * @param displayExists        chip for displaying only existing places
     * @param displayNeedsPhoto    chip for displaying only places need photos
     * @param filterForPlaceState  true if we filter places for place state
     * @param filterForAllNoneType true if we filter places with all none button
     */
    @Override
    public void filterMarkersByLabels(final List&lt;Label&gt; selectedLabels,
        final boolean displayExists,
        final boolean displayNeedsPhoto,
        final boolean displayWlm,
        final boolean filterForPlaceState,
        final boolean filterForAllNoneType) {
        // Remove the previous markers before updating them
<span class="nc" id="L1567">        clearAllMarkers();</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">        for (final MarkerPlaceGroup markerPlaceGroup : NearbyController.markerLabelList) {</span>
<span class="nc" id="L1569">            final Place place = markerPlaceGroup.getPlace();</span>
            // When label filter is engaged
            // then compare it against place's label
<span class="nc bnc" id="L1572" title="All 6 branches missed.">            if (selectedLabels != null &amp;&amp; (selectedLabels.size() != 0 || !filterForPlaceState)</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">                &amp;&amp; (!selectedLabels.contains(place.getLabel())</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">                &amp;&amp; !(selectedLabels.contains(Label.BOOKMARKS)</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">                &amp;&amp; markerPlaceGroup.getIsBookmarked()))) {</span>
<span class="nc" id="L1576">                continue;</span>
            }

<span class="nc bnc" id="L1579" title="All 4 branches missed.">            if (!displayWlm &amp;&amp; place.isMonument()) {</span>
<span class="nc" id="L1580">                continue;</span>
            }

<span class="nc" id="L1583">            boolean shouldUpdateMarker = false;</span>

<span class="nc bnc" id="L1585" title="All 4 branches missed.">            if (displayWlm &amp;&amp; place.isMonument()) {</span>
<span class="nc" id="L1586">                shouldUpdateMarker = true;</span>
<span class="nc bnc" id="L1587" title="All 4 branches missed.">            } else if (displayExists &amp;&amp; displayNeedsPhoto) {</span>
                // Exists and needs photo
<span class="nc bnc" id="L1589" title="All 4 branches missed.">                if (place.exists &amp;&amp; place.pic.trim().isEmpty()) {</span>
<span class="nc" id="L1590">                    shouldUpdateMarker = true;</span>
                }
<span class="nc bnc" id="L1592" title="All 4 branches missed.">            } else if (displayExists &amp;&amp; !displayNeedsPhoto) {</span>
                // Exists and all included needs and doesn't needs photo
<span class="nc bnc" id="L1594" title="All 2 branches missed.">                if (place.exists) {</span>
<span class="nc" id="L1595">                    shouldUpdateMarker = true;</span>
                }
<span class="nc bnc" id="L1597" title="All 4 branches missed.">            } else if (!displayExists &amp;&amp; displayNeedsPhoto) {</span>
                // All and only needs photo
<span class="nc bnc" id="L1599" title="All 2 branches missed.">                if (place.pic.trim().isEmpty()) {</span>
<span class="nc" id="L1600">                    shouldUpdateMarker = true;</span>
                }
<span class="nc bnc" id="L1602" title="All 4 branches missed.">            } else if (!displayExists &amp;&amp; !displayNeedsPhoto) {</span>
                // all
<span class="nc" id="L1604">                shouldUpdateMarker = true;</span>
            }

<span class="nc bnc" id="L1607" title="All 2 branches missed.">            if (shouldUpdateMarker) {</span>
<span class="nc" id="L1608">                updateMarker(markerPlaceGroup.getIsBookmarked(), place,</span>
                    NearbyController.currentLocation);
            }
<span class="nc" id="L1611">        }</span>
<span class="nc bnc" id="L1612" title="All 4 branches missed.">        if (selectedLabels == null || selectedLabels.size() == 0) {</span>
<span class="nc" id="L1613">            ArrayList&lt;NearbyBaseMarker&gt; markerArrayList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1614" title="All 2 branches missed.">            for (final MarkerPlaceGroup markerPlaceGroup : NearbyController.markerLabelList) {</span>
<span class="nc" id="L1615">                NearbyBaseMarker nearbyBaseMarker = new NearbyBaseMarker();</span>
<span class="nc" id="L1616">                nearbyBaseMarker.place(markerPlaceGroup.getPlace());</span>
<span class="nc" id="L1617">                markerArrayList.add(nearbyBaseMarker);</span>
<span class="nc" id="L1618">            }</span>
<span class="nc" id="L1619">            addMarkersToMap(markerArrayList, null);</span>
        }
<span class="nc" id="L1621">    }</span>

    @Override
    public fr.free.nrw.commons.location.LatLng getCameraTarget() {
<span class="nc bnc" id="L1625" title="All 2 branches missed.">        return mapView == null ? null : getMapFocus();</span>
    }

    /**
     * Sets marker icon according to marker status. Sets title and distance.
     *
     * @param isBookmarked true if place is bookmarked
     * @param place
     * @param curLatLng    current location
     */
    public void updateMarker(final boolean isBookmarked, final Place place,
        @Nullable final fr.free.nrw.commons.location.LatLng curLatLng) {
<span class="nc" id="L1637">        addMarkerToMap(place, isBookmarked);</span>
<span class="nc" id="L1638">    }</span>

    /**
     * Highlights nearest place when user clicks on home nearby banner
     *
     * @param nearestPlace nearest place, which has to be highlighted
     */
    private void highlightNearestPlace(Place nearestPlace) {
<span class="nc" id="L1646">        passInfoToSheet(nearestPlace);</span>
<span class="nc" id="L1647">        hideBottomSheet();</span>
<span class="nc" id="L1648">        bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_COLLAPSED);</span>
<span class="nc" id="L1649">    }</span>

    /**
     * Returns drawable of marker icon for given place
     *
     * @param place where marker is to be added
     * @param isBookmarked true if place is bookmarked
     * @return returns the drawable of marker according to the place information
     */
    private @DrawableRes int getIconFor(Place place, Boolean isBookmarked) {
<span class="nc bnc" id="L1659" title="All 2 branches missed.">        if(nearestPlace!=null) {</span>
<span class="nc bnc" id="L1660" title="All 2 branches missed.">            if(place.name.equals(nearestPlace.name)) {</span>
                // Highlight nearest place only when user clicks on the home nearby banner
<span class="nc" id="L1662">                highlightNearestPlace(place);</span>
<span class="nc bnc" id="L1663" title="All 2 branches missed.">                return (isBookmarked?</span>
<span class="nc" id="L1664">                        R.drawable.ic_custom_map_marker_purple_bookmarked:</span>
<span class="nc" id="L1665">                        R.drawable.ic_custom_map_marker_purple);</span>
            }
        }
<span class="nc bnc" id="L1668" title="All 2 branches missed.">        if (place.isMonument()) {</span>
<span class="nc" id="L1669">            return R.drawable.ic_custom_map_marker_monuments;</span>
<span class="nc bnc" id="L1670" title="All 2 branches missed.">        } else if (!place.pic.trim().isEmpty()) {</span>
<span class="nc bnc" id="L1671" title="All 2 branches missed.">            return (isBookmarked ?</span>
<span class="nc" id="L1672">                R.drawable.ic_custom_map_marker_green_bookmarked :</span>
<span class="nc" id="L1673">                R.drawable.ic_custom_map_marker_green);</span>
<span class="nc bnc" id="L1674" title="All 2 branches missed.">        } else if (!place.exists) { // Means that the topic of the Wikidata item does not exist in the real world anymore, for instance it is a past event, or a place that was destroyed</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">            return (isBookmarked ?</span>
<span class="nc" id="L1676">                R.drawable.ic_custom_map_marker_grey_bookmarked :</span>
<span class="nc" id="L1677">                R.drawable.ic_custom_map_marker_grey);</span>
        } else {
<span class="nc bnc" id="L1679" title="All 2 branches missed.">            return (isBookmarked ?</span>
<span class="nc" id="L1680">                R.drawable.ic_custom_map_marker_blue_bookmarked :</span>
<span class="nc" id="L1681">                R.drawable.ic_custom_map_marker);</span>
        }
    }

    /**
     * Adds a marker representing a place to the map with optional bookmark icon.
     *
     * @param place        The Place object containing information about the location.
     * @param isBookMarked A Boolean flag indicating whether the place is bookmarked or not.
     */
    private void addMarkerToMap(Place place, Boolean isBookMarked) {
<span class="nc" id="L1692">        ArrayList&lt;OverlayItem&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1693">        Drawable icon = ContextCompat.getDrawable(getContext(), getIconFor(place, isBookMarked));</span>
<span class="nc" id="L1694">        GeoPoint point = new GeoPoint(place.location.getLatitude(), place.location.getLongitude());</span>
<span class="nc" id="L1695">        OverlayItem item = new OverlayItem(place.name, null, point);</span>
<span class="nc" id="L1696">        item.setMarker(icon);</span>
<span class="nc" id="L1697">        items.add(item);</span>
<span class="nc" id="L1698">        ItemizedOverlayWithFocus overlay = new ItemizedOverlayWithFocus(items,</span>
<span class="nc" id="L1699">            new OnItemGestureListener&lt;OverlayItem&gt;() {</span>
                @Override
                public boolean onItemSingleTapUp(int index, OverlayItem item) {
<span class="nc" id="L1702">                    passInfoToSheet(place);</span>
<span class="nc" id="L1703">                    hideBottomSheet();</span>
<span class="nc bnc" id="L1704" title="All 2 branches missed.">                    if (clickedMarkerPlace != null) {</span>
<span class="nc" id="L1705">                        removeMarker(clickedMarkerPlace);</span>
<span class="nc" id="L1706">                        addMarkerToMap(clickedMarkerPlace,isClickedMarkerBookmarked);</span>
                    }
<span class="nc" id="L1708">                    clickedMarkerPlace = place;</span>
<span class="nc" id="L1709">                    isClickedMarkerBookmarked = isBookMarked ;</span>
<span class="nc" id="L1710">                    bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_COLLAPSED);</span>
<span class="nc" id="L1711">                    return true;</span>
                }

                @Override
                public boolean onItemLongPress(int index, OverlayItem item) {
<span class="nc" id="L1716">                    return false;</span>
                }
<span class="nc" id="L1718">            }, getContext());</span>

<span class="nc" id="L1720">        overlay.setFocusItemsOnTap(true);</span>
<span class="nc" id="L1721">        mapView.getOverlays().add(overlay); // Add the overlay to the map</span>
<span class="nc" id="L1722">    }</span>

    /**
     * Adds multiple markers representing places to the map and handles item gestures.
     *
     * @param nearbyBaseMarkers The list of Place objects containing information about the
     *                          locations.
     */
    private void addMarkersToMap(List&lt;NearbyBaseMarker&gt; nearbyBaseMarkers,
        final Marker selectedMarker) {
<span class="nc" id="L1732">        ArrayList&lt;OverlayItem&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1733" title="All 2 branches missed.">        for (int i = 0; i &lt; nearbyBaseMarkers.size(); i++) {</span>
<span class="nc" id="L1734">            Drawable icon = ContextCompat.getDrawable(getContext(),</span>
<span class="nc" id="L1735">                getIconFor(nearbyBaseMarkers.get(i).getPlace(), false));</span>
<span class="nc" id="L1736">            GeoPoint point = new GeoPoint(</span>
<span class="nc" id="L1737">                nearbyBaseMarkers.get(i).getPlace().location.getLatitude(),</span>
<span class="nc" id="L1738">                nearbyBaseMarkers.get(i).getPlace().location.getLongitude());</span>
<span class="nc" id="L1739">            OverlayItem item = new OverlayItem(nearbyBaseMarkers.get(i).getPlace().name, null,</span>
                point);
<span class="nc" id="L1741">            item.setMarker(icon);</span>
<span class="nc" id="L1742">            items.add(item);</span>
        }
<span class="nc" id="L1744">        ItemizedOverlayWithFocus overlay = new ItemizedOverlayWithFocus(items,</span>
<span class="nc" id="L1745">            new OnItemGestureListener&lt;OverlayItem&gt;() {</span>
                @Override
                public boolean onItemSingleTapUp(int index, OverlayItem item) {
<span class="nc" id="L1748">                    final Place place = nearbyBaseMarkers.get(index).getPlace();</span>
<span class="nc" id="L1749">                    passInfoToSheet(place);</span>
<span class="nc" id="L1750">                    hideBottomSheet();</span>
<span class="nc bnc" id="L1751" title="All 2 branches missed.">                    if (clickedMarkerPlace != null) {</span>
<span class="nc" id="L1752">                        removeMarker(clickedMarkerPlace);</span>
<span class="nc" id="L1753">                        addMarkerToMap(clickedMarkerPlace,isClickedMarkerBookmarked);</span>
                    }
<span class="nc" id="L1755">                    clickedMarkerPlace = place ;</span>
<span class="nc" id="L1756">                    isClickedMarkerBookmarked = false ;</span>
<span class="nc" id="L1757">                    bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_COLLAPSED);</span>
<span class="nc" id="L1758">                    return true;</span>
                }

                @Override
                public boolean onItemLongPress(int index, OverlayItem item) {
<span class="nc" id="L1763">                    return false;</span>
                }
<span class="nc" id="L1765">            }, getContext());</span>
<span class="nc" id="L1766">        overlay.setFocusItemsOnTap(true);</span>
<span class="nc" id="L1767">        mapView.getOverlays().add(overlay);</span>
<span class="nc" id="L1768">    }</span>

    private void removeMarker(Place place){
<span class="nc" id="L1771">        List&lt;Overlay&gt; overlays = mapView.getOverlays();</span>
<span class="nc bnc" id="L1772" title="All 2 branches missed.">        for (int i = 0; i &lt; overlays.size();i++){</span>
<span class="nc bnc" id="L1773" title="All 2 branches missed.">            if (overlays.get(i) instanceof ItemizedOverlayWithFocus){</span>
<span class="nc" id="L1774">                ItemizedOverlayWithFocus item = (ItemizedOverlayWithFocus)overlays.get(i);</span>
<span class="nc" id="L1775">                OverlayItem overlayItem = item.getItem(0);</span>
<span class="nc" id="L1776">                fr.free.nrw.commons.location.LatLng diffLatLang = new fr.free.nrw.commons.location.LatLng(overlayItem.getPoint().getLatitude(),overlayItem.getPoint().getLongitude(),100);</span>
<span class="nc bnc" id="L1777" title="All 4 branches missed.">                if (place.location.getLatitude() == overlayItem.getPoint().getLatitude() &amp;&amp; place.location.getLongitude() == overlayItem.getPoint().getLongitude()){</span>
<span class="nc" id="L1778">                    mapView.getOverlays().remove(i);</span>
<span class="nc" id="L1779">                    mapView.invalidate();</span>
<span class="nc" id="L1780">                    break;</span>
                }
            }
        }
<span class="nc" id="L1784">    }</span>

    @Override
    public void recenterMap(fr.free.nrw.commons.location.LatLng curLatLng) {
<span class="nc bnc" id="L1788" title="All 4 branches missed.">        if (isPermissionDenied || curLatLng == null) {</span>
<span class="nc" id="L1789">            recenterToUserLocation = true;</span>
<span class="nc" id="L1790">            checkPermissionsAndPerformAction();</span>
<span class="nc bnc" id="L1791" title="All 4 branches missed.">            if (!isPermissionDenied &amp;&amp; !(locationManager.isNetworkProviderEnabled()</span>
<span class="nc bnc" id="L1792" title="All 2 branches missed.">                || locationManager.isGPSProviderEnabled())) {</span>
<span class="nc" id="L1793">                showLocationOffDialog();</span>
            }
<span class="nc" id="L1795">            return;</span>
        }
<span class="nc" id="L1797">        addCurrentLocationMarker(curLatLng);</span>
<span class="nc" id="L1798">        mapView.getController()</span>
<span class="nc" id="L1799">            .animateTo(new GeoPoint(curLatLng.getLatitude(), curLatLng.getLongitude()));</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">        if (lastMapFocus != null) {</span>
<span class="nc" id="L1801">            Location mylocation = new Location(&quot;&quot;);</span>
<span class="nc" id="L1802">            Location dest_location = new Location(&quot;&quot;);</span>
<span class="nc" id="L1803">            dest_location.setLatitude(mapView.getMapCenter().getLatitude());</span>
<span class="nc" id="L1804">            dest_location.setLongitude(mapView.getMapCenter().getLongitude());</span>
<span class="nc" id="L1805">            mylocation.setLatitude(lastMapFocus.getLatitude());</span>
<span class="nc" id="L1806">            mylocation.setLongitude(lastMapFocus.getLongitude());</span>
<span class="nc" id="L1807">            Float distance = mylocation.distanceTo(dest_location);//in meters</span>
<span class="nc bnc" id="L1808" title="All 2 branches missed.">            if (lastMapFocus != null) {</span>
<span class="nc bnc" id="L1809" title="All 2 branches missed.">                if (isNetworkConnectionEstablished()) {</span>
<span class="nc bnc" id="L1810" title="All 2 branches missed.">                    if (distance &gt; 2000.0) {</span>
<span class="nc" id="L1811">                        setSearchThisAreaButtonVisibility(true);</span>
                    } else {
<span class="nc" id="L1813">                        setSearchThisAreaButtonVisibility(false);</span>
                    }
                }
            } else {
<span class="nc" id="L1817">                setSearchThisAreaButtonVisibility(false);</span>
            }
        }
<span class="nc" id="L1820">    }</span>

    @Override
    public void showLocationOffDialog() {
        // This creates a dialog box that prompts the user to enable location
<span class="nc" id="L1825">        DialogUtil</span>
<span class="nc" id="L1826">            .showAlertDialog(getActivity(), getString(R.string.ask_to_turn_location_on),</span>
<span class="nc" id="L1827">                getString(R.string.nearby_needs_location),</span>
<span class="nc" id="L1828">                getString(R.string.yes), getString(R.string.no), this::openLocationSettings, null);</span>
<span class="nc" id="L1829">    }</span>

    @Override
    public void openLocationSettings() {
        // This method opens the location settings of the device along with a followup toast.
<span class="nc" id="L1834">        final Intent intent = new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS);</span>
<span class="nc" id="L1835">        final PackageManager packageManager = getActivity().getPackageManager();</span>

<span class="nc bnc" id="L1837" title="All 2 branches missed.">        if (intent.resolveActivity(packageManager) != null) {</span>
<span class="nc" id="L1838">            startActivity(intent);</span>
<span class="nc" id="L1839">            Toast.makeText(getContext(), R.string.recommend_high_accuracy_mode, Toast.LENGTH_LONG)</span>
<span class="nc" id="L1840">                .show();</span>
        } else {
<span class="nc" id="L1842">            Toast.makeText(getContext(), R.string.cannot_open_location_settings, Toast.LENGTH_LONG)</span>
<span class="nc" id="L1843">                .show();</span>
        }
<span class="nc" id="L1845">    }</span>

    @Override
    public void hideBottomSheet() {
<span class="nc" id="L1849">        bottomSheetListBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
<span class="nc" id="L1850">    }</span>

    @Override
    public void hideBottomDetailsSheet() {
<span class="nc" id="L1854">        bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
<span class="nc" id="L1855">    }</span>

    @Override
    public void displayBottomSheetWithInfo(final Marker marker) {
<span class="nc" id="L1859">        selectedMarker = marker;</span>
<span class="nc" id="L1860">        final NearbyMarker nearbyMarker = (NearbyMarker) marker;</span>
<span class="nc" id="L1861">        final Place place = nearbyMarker.getNearbyBaseMarker().getPlace();</span>
<span class="nc" id="L1862">        passInfoToSheet(place);</span>
<span class="nc" id="L1863">        hideBottomSheet();</span>
<span class="nc" id="L1864">        bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_COLLAPSED);</span>
<span class="nc" id="L1865">    }</span>

    /**
     * If nearby details bottom sheet state is collapsed: show fab plus If nearby details bottom
     * sheet state is expanded: show fab plus If nearby details bottom sheet state is hidden: hide
     * all fabs
     *
     * @param bottomSheetState see bottom sheet states
     */
    public void prepareViewsForSheetPosition(final int bottomSheetState) {

<span class="nc bnc" id="L1876" title="All 3 branches missed.">        switch (bottomSheetState) {</span>
            case (BottomSheetBehavior.STATE_COLLAPSED):
<span class="nc" id="L1878">                collapseFABs(isFABsExpanded);</span>
<span class="nc bnc" id="L1879" title="All 2 branches missed.">                if (!fabPlus.isShown()) {</span>
<span class="nc" id="L1880">                    showFABs();</span>
                }
                break;
            case (BottomSheetBehavior.STATE_HIDDEN):
<span class="nc" id="L1884">                transparentView.setClickable(false);</span>
<span class="nc" id="L1885">                transparentView.setAlpha(0);</span>
<span class="nc" id="L1886">                collapseFABs(isFABsExpanded);</span>
<span class="nc" id="L1887">                hideFABs();</span>
                break;
        }
<span class="nc" id="L1890">    }</span>

    /**
     * Same bottom sheet carries information for all nearby places, so we need to pass information
     * (title, description, distance and links) to view on nearby marker click
     *
     * @param place Place of clicked nearby marker
     */
    private void passInfoToSheet(final Place place) {
<span class="nc" id="L1899">        selectedPlace = place;</span>
<span class="nc" id="L1900">        updateBookmarkButtonImage(selectedPlace);</span>

<span class="nc" id="L1902">        bookmarkButton.setOnClickListener(view -&gt; {</span>
<span class="nc" id="L1903">            final boolean isBookmarked = bookmarkLocationDao.updateBookmarkLocation(selectedPlace);</span>
<span class="nc" id="L1904">            updateBookmarkButtonImage(selectedPlace);</span>
<span class="nc" id="L1905">            updateMarker(isBookmarked, selectedPlace, locationManager.getLastLocation());</span>
<span class="nc" id="L1906">            mapView.invalidate();</span>
<span class="nc" id="L1907">        });</span>
<span class="nc" id="L1908">        bookmarkButton.setOnLongClickListener(view -&gt; {</span>
<span class="nc" id="L1909">            Toast.makeText(getContext(), R.string.menu_bookmark, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1910">            return true;</span>
        });

<span class="nc bnc" id="L1913" title="All 2 branches missed.">        wikipediaButton.setVisibility(place.hasWikipediaLink() ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L1914">        wikipediaButton.setOnClickListener(</span>
<span class="nc" id="L1915">            view -&gt; Utils.handleWebUrl(getContext(), selectedPlace.siteLinks.getWikipediaLink()));</span>
<span class="nc" id="L1916">        wikipediaButton.setOnLongClickListener(view -&gt; {</span>
<span class="nc" id="L1917">            Toast.makeText(getContext(), R.string.nearby_wikipedia, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1918">            return true;</span>
        });

<span class="nc bnc" id="L1921" title="All 2 branches missed.">        wikidataButton.setVisibility(place.hasWikidataLink() ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L1922">        wikidataButton.setOnClickListener(</span>
<span class="nc" id="L1923">            view -&gt; Utils.handleWebUrl(getContext(), selectedPlace.siteLinks.getWikidataLink()));</span>
<span class="nc" id="L1924">        wikidataButton.setOnLongClickListener(view -&gt; {</span>
<span class="nc" id="L1925">            Toast.makeText(getContext(), R.string.nearby_wikidata, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1926">            return true;</span>
        });

<span class="nc" id="L1929">        directionsButton.setOnClickListener(view -&gt; Utils.handleGeoCoordinates(getActivity(),</span>
<span class="nc" id="L1930">            selectedPlace.getLocation()));</span>
<span class="nc" id="L1931">        directionsButton.setOnLongClickListener(view -&gt; {</span>
<span class="nc" id="L1932">            Toast.makeText(getContext(), R.string.nearby_directions, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1933">            return true;</span>
        });

<span class="nc bnc" id="L1936" title="All 2 branches missed.">        commonsButton.setVisibility(selectedPlace.hasCommonsLink() ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L1937">        commonsButton.setOnClickListener(</span>
<span class="nc" id="L1938">            view -&gt; Utils.handleWebUrl(getContext(), selectedPlace.siteLinks.getCommonsLink()));</span>
<span class="nc" id="L1939">        commonsButton.setOnLongClickListener(view -&gt; {</span>
<span class="nc" id="L1940">            Toast.makeText(getContext(), R.string.nearby_commons, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1941">            return true;</span>
        });

<span class="nc" id="L1944">        icon.setImageResource(selectedPlace.getLabel().getIcon());</span>

<span class="nc" id="L1946">        title.setText(selectedPlace.name);</span>
<span class="nc" id="L1947">        distance.setText(selectedPlace.distance);</span>
        // Remove label since it is double information
<span class="nc" id="L1949">        String descriptionText = selectedPlace.getLongDescription()</span>
<span class="nc" id="L1950">            .replace(selectedPlace.getName() + &quot; (&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L1951" title="All 2 branches missed.">        descriptionText = (descriptionText.equals(selectedPlace.getLongDescription())</span>
<span class="nc" id="L1952">            ? descriptionText : descriptionText.replaceFirst(&quot;.$&quot;, &quot;&quot;));</span>
        // Set the short description after we remove place name from long description
<span class="nc" id="L1954">        description.setText(descriptionText);</span>

<span class="nc" id="L1956">        fabCamera.setOnClickListener(view -&gt; {</span>
<span class="nc bnc" id="L1957" title="All 2 branches missed.">            if (fabCamera.isShown()) {</span>
<span class="nc" id="L1958">                Timber.d(&quot;Camera button tapped. Place: %s&quot;, selectedPlace.toString());</span>
<span class="nc" id="L1959">                storeSharedPrefs(selectedPlace);</span>
<span class="nc" id="L1960">                controller.initiateCameraPick(getActivity(), inAppCameraLocationPermissionLauncher);</span>
            }
<span class="nc" id="L1962">        });</span>

<span class="nc" id="L1964">        fabGallery.setOnClickListener(view -&gt; {</span>
<span class="nc bnc" id="L1965" title="All 2 branches missed.">            if (fabGallery.isShown()) {</span>
<span class="nc" id="L1966">                Timber.d(&quot;Gallery button tapped. Place: %s&quot;, selectedPlace.toString());</span>
<span class="nc" id="L1967">                storeSharedPrefs(selectedPlace);</span>
<span class="nc" id="L1968">                controller.initiateGalleryPick(getActivity(), chipWlm.isChecked());</span>
            }
<span class="nc" id="L1970">        });</span>
<span class="nc" id="L1971">    }</span>

    private void storeSharedPrefs(final Place selectedPlace) {
<span class="nc" id="L1974">        applicationKvStore.putJson(PLACE_OBJECT, selectedPlace);</span>
<span class="nc" id="L1975">        Place place = applicationKvStore.getJson(PLACE_OBJECT, Place.class);</span>

<span class="nc" id="L1977">        Timber.d(&quot;Stored place object %s&quot;, place.toString());</span>
<span class="nc" id="L1978">    }</span>

    private void updateBookmarkButtonImage(final Place place) {
        final int bookmarkIcon;
<span class="nc bnc" id="L1982" title="All 2 branches missed.">        if (bookmarkLocationDao.findBookmarkLocation(place)) {</span>
<span class="nc" id="L1983">            bookmarkIcon = R.drawable.ic_round_star_filled_24px;</span>
        } else {
<span class="nc" id="L1985">            bookmarkIcon = R.drawable.ic_round_star_border_24px;</span>
        }
<span class="nc bnc" id="L1987" title="All 2 branches missed.">        if (bookmarkButtonImage != null) {</span>
<span class="nc" id="L1988">            bookmarkButtonImage.setImageResource(bookmarkIcon);</span>
        }
<span class="nc" id="L1990">    }</span>

    @Override
    public void onAttach(final Context context) {
<span class="nc" id="L1994">        super.onAttach(context);</span>
<span class="nc" id="L1995">        wikidataEditListener.setAuthenticationStateListener(this);</span>
<span class="nc" id="L1996">    }</span>

    @Override
    public void onDestroy() {
<span class="nc" id="L2000">        super.onDestroy();</span>
<span class="nc" id="L2001">        wikidataEditListener.setAuthenticationStateListener(null);</span>
<span class="nc" id="L2002">    }</span>

    @Override
    public void onWikidataEditSuccessful() {
<span class="nc bnc" id="L2006" title="All 4 branches missed.">        if (presenter != null &amp;&amp; locationManager != null) {</span>
<span class="nc" id="L2007">            presenter.updateMapAndList(MAP_UPDATED);</span>
        }
<span class="nc" id="L2009">    }</span>

    private void showErrorMessage(final String message) {
<span class="nc" id="L2012">        ViewUtil.showLongToast(getActivity(), message);</span>
<span class="nc" id="L2013">    }</span>

    public void registerUnregisterLocationListener(final boolean removeLocationListener) {
        try {
<span class="nc bnc" id="L2017" title="All 2 branches missed.">            if (removeLocationListener) {</span>
<span class="nc" id="L2018">                locationManager.unregisterLocationManager();</span>
<span class="nc" id="L2019">                locationManager.removeLocationListener(this);</span>
<span class="nc" id="L2020">                Timber.d(&quot;Location service manager unregistered and removed&quot;);</span>
            } else {
<span class="nc" id="L2022">                locationManager.addLocationListener(this);</span>
<span class="nc" id="L2023">                locationManager.registerLocationManager();</span>
<span class="nc" id="L2024">                Timber.d(&quot;Location service manager added and registered&quot;);</span>
            }
<span class="nc" id="L2026">        } catch (final Exception e) {</span>
<span class="nc" id="L2027">            Timber.e(e);</span>
            //Broadcasts are tricky, should be catchedonR
<span class="nc" id="L2029">        }</span>
<span class="nc" id="L2030">    }</span>

    @Override
    public void setUserVisibleHint(final boolean isVisibleToUser) {
<span class="nc" id="L2034">        super.setUserVisibleHint(isVisibleToUser);</span>
<span class="nc" id="L2035">        this.isVisibleToUser = isVisibleToUser;</span>
<span class="nc bnc" id="L2036" title="All 4 branches missed.">        if (isResumed() &amp;&amp; isVisibleToUser) {</span>
<span class="nc" id="L2037">            startTheMap();</span>
        } else {
<span class="nc bnc" id="L2039" title="All 2 branches missed.">            if (null != bottomSheetListBehavior) {</span>
<span class="nc" id="L2040">                bottomSheetListBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
            }

<span class="nc bnc" id="L2043" title="All 2 branches missed.">            if (null != bottomSheetDetailsBehavior) {</span>
<span class="nc" id="L2044">                bottomSheetDetailsBehavior.setState(BottomSheetBehavior.STATE_HIDDEN);</span>
            }
        }
<span class="nc" id="L2047">    }</span>

    private void startTheMap() {
<span class="nc" id="L2050">        performMapReadyActions();</span>
<span class="nc" id="L2051">    }</span>

    /**
     * Clears all markers from the map and resets certain map overlays and gestures. After clearing
     * markers, it re-adds a scale bar overlay and rotation gesture overlay to the map.
     */
    @Override
    public void clearAllMarkers() {
<span class="nc" id="L2059">        mapView.getOverlayManager().clear();</span>
<span class="nc" id="L2060">        mapView.invalidate();</span>
<span class="nc" id="L2061">        GeoPoint geoPoint = mapCenter;</span>
<span class="nc bnc" id="L2062" title="All 2 branches missed.">        if (geoPoint != null) {</span>
<span class="nc" id="L2063">            List&lt;Overlay&gt; overlays = mapView.getOverlays();</span>
<span class="nc" id="L2064">            ScaleDiskOverlay diskOverlay =</span>
<span class="nc" id="L2065">                new ScaleDiskOverlay(this.getContext(),</span>
                    geoPoint, 2000, GeoConstants.UnitOfMeasure.foot);
<span class="nc" id="L2067">            Paint circlePaint = new Paint();</span>
<span class="nc" id="L2068">            circlePaint.setColor(Color.rgb(128, 128, 128));</span>
<span class="nc" id="L2069">            circlePaint.setStyle(Paint.Style.STROKE);</span>
<span class="nc" id="L2070">            circlePaint.setStrokeWidth(2f);</span>
<span class="nc" id="L2071">            diskOverlay.setCirclePaint2(circlePaint);</span>
<span class="nc" id="L2072">            Paint diskPaint = new Paint();</span>
<span class="nc" id="L2073">            diskPaint.setColor(Color.argb(40, 128, 128, 128));</span>
<span class="nc" id="L2074">            diskPaint.setStyle(Paint.Style.FILL_AND_STROKE);</span>
<span class="nc" id="L2075">            diskOverlay.setCirclePaint1(diskPaint);</span>
<span class="nc" id="L2076">            diskOverlay.setDisplaySizeMin(900);</span>
<span class="nc" id="L2077">            diskOverlay.setDisplaySizeMax(1700);</span>
<span class="nc" id="L2078">            mapView.getOverlays().add(diskOverlay);</span>
<span class="nc" id="L2079">            org.osmdroid.views.overlay.Marker startMarker = new org.osmdroid.views.overlay.Marker(</span>
                mapView);
<span class="nc" id="L2081">            startMarker.setPosition(geoPoint);</span>
<span class="nc" id="L2082">            startMarker.setAnchor(org.osmdroid.views.overlay.Marker.ANCHOR_CENTER,</span>
                org.osmdroid.views.overlay.Marker.ANCHOR_BOTTOM);
<span class="nc" id="L2084">            startMarker.setIcon(</span>
<span class="nc" id="L2085">                ContextCompat.getDrawable(this.getContext(), R.drawable.current_location_marker));</span>
<span class="nc" id="L2086">            startMarker.setTitle(&quot;Your Location&quot;);</span>
<span class="nc" id="L2087">            startMarker.setTextLabelFontSize(24);</span>
<span class="nc" id="L2088">            mapView.getOverlays().add(startMarker);</span>
        }
<span class="nc" id="L2090">        ScaleBarOverlay scaleBarOverlay = new ScaleBarOverlay(mapView);</span>
<span class="nc" id="L2091">        scaleBarOverlay.setScaleBarOffset(15, 25);</span>
<span class="nc" id="L2092">        Paint barPaint = new Paint();</span>
<span class="nc" id="L2093">        barPaint.setARGB(200, 255, 250, 250);</span>
<span class="nc" id="L2094">        scaleBarOverlay.setBackgroundPaint(barPaint);</span>
<span class="nc" id="L2095">        scaleBarOverlay.enableScaleBar();</span>
<span class="nc" id="L2096">        mapView.getOverlays().add(scaleBarOverlay);</span>
<span class="nc" id="L2097">        mapView.getOverlays().add(new MapEventsOverlay(new MapEventsReceiver() {</span>
            @Override
            public boolean singleTapConfirmedHelper(GeoPoint p) {
<span class="nc bnc" id="L2100" title="All 2 branches missed.">                if (clickedMarkerPlace != null){</span>
<span class="nc" id="L2101">                    removeMarker(clickedMarkerPlace);</span>
<span class="nc" id="L2102">                    addMarkerToMap(clickedMarkerPlace,isClickedMarkerBookmarked);</span>
                }else {
<span class="nc" id="L2104">                    Timber.e(&quot;CLICKED MARKER IS NULL&quot;);</span>
                }
<span class="nc bnc" id="L2106" title="All 2 branches missed.">                if (isListBottomSheetExpanded()) {</span>
                    // Back should first hide the bottom sheet if it is expanded
<span class="nc" id="L2108">                    hideBottomSheet();</span>
<span class="nc bnc" id="L2109" title="All 2 branches missed.">                } else if (isDetailsBottomSheetVisible()) {</span>
<span class="nc" id="L2110">                    hideBottomDetailsSheet();</span>
                }
<span class="nc" id="L2112">                return true;</span>
            }

            @Override
            public boolean longPressHelper(GeoPoint p) {
<span class="nc" id="L2117">                return false;</span>
            }
        }));
<span class="nc" id="L2120">        mapView.setMultiTouchControls(true);</span>
<span class="nc" id="L2121">    }</span>

    /**
     * Recenters the map to the Center and adds a scale disk overlay and a marker at the position.
     *
     * @param geoPoint The GeoPoint representing the new center position of the map.
     */
    private void recenterMarkerToPosition(GeoPoint geoPoint) {
<span class="nc bnc" id="L2129" title="All 2 branches missed.">        if (geoPoint != null) {</span>
<span class="nc" id="L2130">            mapView.getController().setCenter(geoPoint);</span>
<span class="nc" id="L2131">            List&lt;Overlay&gt; overlays = mapView.getOverlays();</span>
<span class="nc bnc" id="L2132" title="All 2 branches missed.">            for (int i = 0; i &lt; overlays.size(); i++) {</span>
<span class="nc bnc" id="L2133" title="All 2 branches missed.">                if (overlays.get(i) instanceof org.osmdroid.views.overlay.Marker) {</span>
<span class="nc" id="L2134">                    mapView.getOverlays().remove(i);</span>
<span class="nc bnc" id="L2135" title="All 2 branches missed.">                } else if (overlays.get(i) instanceof ScaleDiskOverlay) {</span>
<span class="nc" id="L2136">                    mapView.getOverlays().remove(i);</span>
                }
            }
<span class="nc" id="L2139">            ScaleDiskOverlay diskOverlay =</span>
<span class="nc" id="L2140">                new ScaleDiskOverlay(this.getContext(),</span>
                    geoPoint, 2000, GeoConstants.UnitOfMeasure.foot);
<span class="nc" id="L2142">            Paint circlePaint = new Paint();</span>
<span class="nc" id="L2143">            circlePaint.setColor(Color.rgb(128, 128, 128));</span>
<span class="nc" id="L2144">            circlePaint.setStyle(Paint.Style.STROKE);</span>
<span class="nc" id="L2145">            circlePaint.setStrokeWidth(2f);</span>
<span class="nc" id="L2146">            diskOverlay.setCirclePaint2(circlePaint);</span>
<span class="nc" id="L2147">            Paint diskPaint = new Paint();</span>
<span class="nc" id="L2148">            diskPaint.setColor(Color.argb(40, 128, 128, 128));</span>
<span class="nc" id="L2149">            diskPaint.setStyle(Paint.Style.FILL_AND_STROKE);</span>
<span class="nc" id="L2150">            diskOverlay.setCirclePaint1(diskPaint);</span>
<span class="nc" id="L2151">            diskOverlay.setDisplaySizeMin(900);</span>
<span class="nc" id="L2152">            diskOverlay.setDisplaySizeMax(1700);</span>
<span class="nc" id="L2153">            mapView.getOverlays().add(diskOverlay);</span>
<span class="nc" id="L2154">            org.osmdroid.views.overlay.Marker startMarker = new org.osmdroid.views.overlay.Marker(</span>
                mapView);
<span class="nc" id="L2156">            startMarker.setPosition(geoPoint);</span>
<span class="nc" id="L2157">            startMarker.setAnchor(org.osmdroid.views.overlay.Marker.ANCHOR_CENTER,</span>
                org.osmdroid.views.overlay.Marker.ANCHOR_BOTTOM);
<span class="nc" id="L2159">            startMarker.setIcon(</span>
<span class="nc" id="L2160">                ContextCompat.getDrawable(this.getContext(), R.drawable.current_location_marker));</span>
<span class="nc" id="L2161">            startMarker.setTitle(&quot;Your Location&quot;);</span>
<span class="nc" id="L2162">            startMarker.setTextLabelFontSize(24);</span>
<span class="nc" id="L2163">            mapView.getOverlays().add(startMarker);</span>
        }
<span class="nc" id="L2165">    }</span>

    private void moveCameraToPosition(GeoPoint geoPoint) {
<span class="nc" id="L2168">        mapView.getController().animateTo(geoPoint);</span>
<span class="nc" id="L2169">    }</span>

    public interface NearbyParentFragmentInstanceReadyCallback {

        void onReady();
    }

    public void setNearbyParentFragmentInstanceReadyCallback(
        NearbyParentFragmentInstanceReadyCallback nearbyParentFragmentInstanceReadyCallback) {
<span class="nc" id="L2178">        this.nearbyParentFragmentInstanceReadyCallback = nearbyParentFragmentInstanceReadyCallback;</span>
<span class="nc" id="L2179">    }</span>

    @Override
    public void onConfigurationChanged(@NonNull final Configuration newConfig) {
<span class="nc" id="L2183">        super.onConfigurationChanged(newConfig);</span>
<span class="nc" id="L2184">        ViewGroup.LayoutParams rlBottomSheetLayoutParams = rlBottomSheet.getLayoutParams();</span>
<span class="nc" id="L2185">        rlBottomSheetLayoutParams.height =</span>
<span class="nc" id="L2186">            getActivity().getWindowManager().getDefaultDisplay().getHeight() / 16 * 9;</span>
<span class="nc" id="L2187">        rlBottomSheet.setLayoutParams(rlBottomSheetLayoutParams);</span>
<span class="nc" id="L2188">    }</span>

    @OnClick(R.id.tv_learn_more)
    public void onLearnMoreClicked() {
<span class="nc" id="L2192">        Intent intent = new Intent(Intent.ACTION_VIEW);</span>
<span class="nc" id="L2193">        intent.setData(Uri.parse(WLM_URL));</span>
<span class="nc" id="L2194">        startActivity(intent);</span>
<span class="nc" id="L2195">    }</span>

    @OnClick(R.id.iv_toggle_chips)
    public void onToggleChipsClicked() {
<span class="nc bnc" id="L2199" title="All 2 branches missed.">        if (llContainerChips.getVisibility() == View.VISIBLE) {</span>
<span class="nc" id="L2200">            llContainerChips.setVisibility(View.GONE);</span>
        } else {
<span class="nc" id="L2202">            llContainerChips.setVisibility(View.VISIBLE);</span>
        }
<span class="nc" id="L2204">        ivToggleChips.setRotation(ivToggleChips.getRotation() + 180);</span>
<span class="nc" id="L2205">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>