<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SessionManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.auth</a> &gt; <span class="el_source">SessionManager.java</span></div><h1>SessionManager.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.auth;

import android.accounts.Account;
import android.accounts.AccountManager;
import android.content.Context;
import android.os.Build;
import android.text.TextUtils;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;

import fr.free.nrw.commons.auth.login.LoginResult;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;

import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import io.reactivex.Completable;
import io.reactivex.Observable;

/**
 * Manage the current logged in user session.
 */
@Singleton
public class SessionManager {
    private final Context context;
    private Account currentAccount; // Unlike a savings account...  ;-)
    private JsonKvStore defaultKvStore;

    @Inject
    public SessionManager(Context context,
<span class="fc" id="L33">                          @Named(&quot;default_preferences&quot;) JsonKvStore defaultKvStore) {</span>
<span class="fc" id="L34">        this.context = context;</span>
<span class="fc" id="L35">        this.currentAccount = null;</span>
<span class="fc" id="L36">        this.defaultKvStore = defaultKvStore;</span>
<span class="fc" id="L37">    }</span>

    private boolean createAccount(@NonNull String userName, @NonNull String password) {
<span class="nc" id="L40">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L41" title="All 6 branches missed.">        if (account == null || TextUtils.isEmpty(account.name) || !account.name.equals(userName)) {</span>
<span class="nc" id="L42">            removeAccount();</span>
<span class="nc" id="L43">            account = new Account(userName, BuildConfig.ACCOUNT_TYPE);</span>
<span class="nc" id="L44">            return accountManager().addAccountExplicitly(account, password, null);</span>
        }
<span class="nc" id="L46">        return true;</span>
    }

    private void removeAccount() {
<span class="nc" id="L50">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (account != null) {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP_MR1) {</span>
<span class="nc" id="L53">                accountManager().removeAccountExplicitly(account);</span>
            } else {
                //noinspection deprecation
<span class="nc" id="L56">                accountManager().removeAccount(account, null, null);</span>
            }
        }
<span class="nc" id="L59">    }</span>

    public void updateAccount(LoginResult result) {
<span class="nc" id="L62">        boolean accountCreated = createAccount(result.getUserName(), result.getPassword());</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (accountCreated) {</span>
<span class="nc" id="L64">            setPassword(result.getPassword());</span>
        }
<span class="nc" id="L66">    }</span>

    private void setPassword(@NonNull String password) {
<span class="nc" id="L69">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (account != null) {</span>
<span class="nc" id="L71">            accountManager().setPassword(account, password);</span>
        }
<span class="nc" id="L73">    }</span>

    /**
     * @return Account|null
     */
    @Nullable
    public Account getCurrentAccount() {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (currentAccount == null) {</span>
<span class="nc" id="L81">            AccountManager accountManager = AccountManager.get(context);</span>
<span class="nc" id="L82">            Account[] allAccounts = accountManager.getAccountsByType(BuildConfig.ACCOUNT_TYPE);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            if (allAccounts.length != 0) {</span>
<span class="nc" id="L84">                currentAccount = allAccounts[0];</span>
            }
        }
<span class="nc" id="L87">        return currentAccount;</span>
    }

    public boolean doesAccountExist() {
<span class="nc bnc" id="L91" title="All 2 branches missed.">        return getCurrentAccount() != null;</span>
    }

    @Nullable
    public String getUserName() {
<span class="nc" id="L96">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        return account == null ? null : account.name;</span>
    }

    @Nullable
    public String getPassword() {
<span class="nc" id="L102">        Account account = getCurrentAccount();</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        return account == null ? null : accountManager().getPassword(account);</span>
    }

    private AccountManager accountManager() {
<span class="nc" id="L107">        return AccountManager.get(context);</span>
    }

    public boolean isUserLoggedIn() {
<span class="nc" id="L111">        return defaultKvStore.getBoolean(&quot;isUserLoggedIn&quot;, false);</span>
    }

    void setUserLoggedIn(boolean isLoggedIn) {
<span class="nc" id="L115">        defaultKvStore.putBoolean(&quot;isUserLoggedIn&quot;, isLoggedIn);</span>
<span class="nc" id="L116">    }</span>

    public void forceLogin(Context context) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (context != null) {</span>
<span class="nc" id="L120">            LoginActivity.startYourself(context);</span>
        }
<span class="nc" id="L122">    }</span>

    /**
     * 1. Clears existing accounts from account manager
     * 2. Calls MediaWikiApi's logout function to clear cookies
     * @return
     */
    public Completable logout() {
<span class="nc" id="L130">        AccountManager accountManager = AccountManager.get(context);</span>
<span class="nc" id="L131">        Account[] allAccounts = accountManager.getAccountsByType(BuildConfig.ACCOUNT_TYPE);</span>
<span class="nc" id="L132">        return Completable.fromObservable(Observable.fromArray(allAccounts)</span>
<span class="nc" id="L133">                .map(a -&gt; accountManager.removeAccount(a, null, null).getResult()))</span>
<span class="nc" id="L134">                .doOnComplete(() -&gt; {</span>
<span class="nc" id="L135">                    currentAccount = null;</span>
<span class="nc" id="L136">                });</span>
    }

    /**
     * Return a corresponding boolean preference
     *
     * @param key
     * @return
     */
    public boolean getPreference(String key) {
<span class="nc" id="L146">        return defaultKvStore.getBoolean(key);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>