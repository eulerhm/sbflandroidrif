<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookmarkItemsDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.bookmarks.items</a> &gt; <span class="el_source">BookmarkItemsDao.java</span></div><h1>BookmarkItemsDao.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.bookmarks.items;

import android.content.ContentProviderClient;
import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.os.RemoteException;
import fr.free.nrw.commons.category.CategoryItem;
import fr.free.nrw.commons.upload.structure.depictions.DepictedItem;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Provider;
import javax.inject.Singleton;
import org.apache.commons.lang3.StringUtils;

/**
 * Handles database operations for bookmarked items
 */
@Singleton
public class BookmarkItemsDao {

    private final Provider&lt;ContentProviderClient&gt; clientProvider;

    @Inject
    public BookmarkItemsDao(
<span class="nc" id="L29">        @Named(&quot;bookmarksItem&quot;) final Provider&lt;ContentProviderClient&gt; clientProvider) {</span>
<span class="nc" id="L30">        this.clientProvider = clientProvider;</span>
<span class="nc" id="L31">    }</span>


    /**
     * Find all persisted items bookmarks on database
     * @return list of bookmarks
     */
    public List&lt;DepictedItem&gt; getAllBookmarksItems() {
<span class="nc" id="L39">        final List&lt;DepictedItem&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L40">        final ContentProviderClient db = clientProvider.get();</span>
<span class="nc" id="L41">        try (final Cursor cursor = db.query(</span>
            BookmarkItemsContentProvider.BASE_URI,
            Table.ALL_FIELDS,
            null,
            new String[]{},
            null)) {
<span class="nc bnc" id="L47" title="All 4 branches missed.">            while (cursor != null &amp;&amp; cursor.moveToNext()) {</span>
<span class="nc" id="L48">                items.add(fromCursor(cursor));</span>
            }
<span class="nc" id="L50">        } catch (final RemoteException e) {</span>
<span class="nc" id="L51">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc" id="L53">            db.release();</span>
        }
<span class="nc" id="L55">        return items;</span>
    }


    /**
     * Look for a bookmark in database and in order to insert or delete it
     * @param depictedItem : Bookmark object
     * @return boolean : is bookmark now favorite ?
     */
    public boolean updateBookmarkItem(final DepictedItem depictedItem) {
<span class="nc" id="L65">        final boolean bookmarkExists = findBookmarkItem(depictedItem.getId());</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (bookmarkExists) {</span>
<span class="nc" id="L67">            deleteBookmarkItem(depictedItem);</span>
        } else {
<span class="nc" id="L69">            addBookmarkItem(depictedItem);</span>
        }
<span class="nc bnc" id="L71" title="All 2 branches missed.">        return !bookmarkExists;</span>
    }

    /**
     * Add a Bookmark to database
     * @param depictedItem : Bookmark to add
     */
    private void addBookmarkItem(final DepictedItem depictedItem) {
<span class="nc" id="L79">        final ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc" id="L81">            db.insert(BookmarkItemsContentProvider.BASE_URI, toContentValues(depictedItem));</span>
<span class="nc" id="L82">        } catch (final RemoteException e) {</span>
<span class="nc" id="L83">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc" id="L85">            db.release();</span>
        }
<span class="nc" id="L87">    }</span>

    /**
     * Delete a bookmark from database
     * @param depictedItem : Bookmark to delete
     */
    private void deleteBookmarkItem(final DepictedItem depictedItem) {
<span class="nc" id="L94">        final ContentProviderClient db = clientProvider.get();</span>
        try {
<span class="nc" id="L96">            db.delete(BookmarkItemsContentProvider.uriForName(depictedItem.getId()), null, null);</span>
<span class="nc" id="L97">        } catch (final RemoteException e) {</span>
<span class="nc" id="L98">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc" id="L100">            db.release();</span>
        }
<span class="nc" id="L102">    }</span>

    /**
     * Find a bookmark from database based on its name
     * @param depictedItemID : Bookmark to find
     * @return boolean : is bookmark in database ?
     */
    public boolean findBookmarkItem(final String depictedItemID) {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (depictedItemID == null) { //Avoiding NPE's</span>
<span class="nc" id="L111">            return false;</span>
        }
<span class="nc" id="L113">        final ContentProviderClient db = clientProvider.get();</span>
<span class="nc" id="L114">        try (final Cursor cursor = db.query(</span>
            BookmarkItemsContentProvider.BASE_URI,
            Table.ALL_FIELDS,
            Table.COLUMN_ID + &quot;=?&quot;,
            new String[]{depictedItemID},
            null
        )) {
<span class="nc bnc" id="L121" title="All 4 branches missed.">            if (cursor != null &amp;&amp; cursor.moveToFirst()) {</span>
<span class="nc" id="L122">                return true;</span>
            }
<span class="nc bnc" id="L124" title="All 2 branches missed.">        } catch (final RemoteException e) {</span>
<span class="nc" id="L125">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc" id="L127">            db.release();</span>
        }
<span class="nc" id="L129">        return false;</span>
    }

    /**
     * Recives real data from cursor
     * @param cursor : Object for storing database data
     * @return DepictedItem
     */
    DepictedItem fromCursor(final Cursor cursor) {
<span class="nc" id="L138">        final String fileName = cursor.getString(cursor.getColumnIndex(Table.COLUMN_NAME));</span>
<span class="nc" id="L139">        final String description</span>
<span class="nc" id="L140">            = cursor.getString(cursor.getColumnIndex(Table.COLUMN_DESCRIPTION));</span>
<span class="nc" id="L141">        final String imageUrl = cursor.getString(cursor.getColumnIndex(Table.COLUMN_IMAGE));</span>
<span class="nc" id="L142">        final String instanceListString</span>
<span class="nc" id="L143">            = cursor.getString(cursor.getColumnIndex(Table.COLUMN_INSTANCE_LIST));</span>
<span class="nc" id="L144">        final List&lt;String&gt; instanceList = StringToArray(instanceListString);</span>
<span class="nc" id="L145">        final String categoryNameListString = cursor.getString(cursor</span>
<span class="nc" id="L146">            .getColumnIndex(Table.COLUMN_CATEGORIES_NAME_LIST));</span>
<span class="nc" id="L147">        final List&lt;String&gt; categoryNameList = StringToArray(categoryNameListString);</span>
<span class="nc" id="L148">        final String categoryDescriptionListString = cursor.getString(cursor</span>
<span class="nc" id="L149">            .getColumnIndex(Table.COLUMN_CATEGORIES_DESCRIPTION_LIST));</span>
<span class="nc" id="L150">        final List&lt;String&gt; categoryDescriptionList = StringToArray(categoryDescriptionListString);</span>
<span class="nc" id="L151">        final String categoryThumbnailListString = cursor.getString(cursor</span>
<span class="nc" id="L152">            .getColumnIndex(Table.COLUMN_CATEGORIES_THUMBNAIL_LIST));</span>
<span class="nc" id="L153">        final List&lt;String&gt; categoryThumbnailList = StringToArray(categoryThumbnailListString);</span>
<span class="nc" id="L154">        final List&lt;CategoryItem&gt; categoryList = convertToCategoryItems(categoryNameList,</span>
            categoryDescriptionList, categoryThumbnailList);
<span class="nc" id="L156">        final boolean isSelected</span>
<span class="nc" id="L157">            = Boolean.parseBoolean(cursor.getString(cursor</span>
<span class="nc" id="L158">            .getColumnIndex(Table.COLUMN_IS_SELECTED)));</span>
<span class="nc" id="L159">        final String id = cursor.getString(cursor.getColumnIndex(Table.COLUMN_ID));</span>

<span class="nc" id="L161">        return new DepictedItem(</span>
            fileName,
            description,
            imageUrl,
            instanceList,
            categoryList,
            isSelected,
            id
        );
    }

    private List&lt;CategoryItem&gt; convertToCategoryItems(List&lt;String&gt; categoryNameList,
        List&lt;String&gt; categoryDescriptionList, List&lt;String&gt; categoryThumbnailList) {
<span class="nc" id="L174">        List&lt;CategoryItem&gt; categoryItems = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        for(int i=0; i&lt;categoryNameList.size(); i++){</span>
<span class="nc" id="L176">            categoryItems.add(new CategoryItem(categoryNameList.get(i),</span>
<span class="nc" id="L177">                categoryDescriptionList.get(i),</span>
<span class="nc" id="L178">                categoryThumbnailList.get(i), false));</span>
        }
<span class="nc" id="L180">        return categoryItems;</span>
    }

    /**
     * Converts string to List
     * @param listString comma separated single string from of list items
     * @return List of string
     */
    private List&lt;String&gt; StringToArray(final String listString) {
<span class="nc" id="L189">        final String[] elements = listString.split(&quot;,&quot;);</span>
<span class="nc" id="L190">        return Arrays.asList(elements);</span>
    }

    /**
     * Converts string to List
     * @param list list of items
     * @return string comma separated single string of items
     */
    private String ArrayToString(final List&lt;String&gt; list) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (list != null) {</span>
<span class="nc" id="L200">            return StringUtils.join(list, ',');</span>
        }
<span class="nc" id="L202">        return null;</span>
    }

    /**
     * Takes data from DepictedItem and create a content value object
     * @param depictedItem depicted item
     * @return ContentValues
     */
    private ContentValues toContentValues(final DepictedItem depictedItem) {

<span class="nc" id="L212">        final List&lt;String&gt; namesOfCommonsCategories = new ArrayList&lt;&gt;();</span>
        for (final CategoryItem category :
<span class="nc bnc" id="L214" title="All 2 branches missed.">            depictedItem.getCommonsCategories()) {</span>
<span class="nc" id="L215">            namesOfCommonsCategories.add(category.getName());</span>
<span class="nc" id="L216">        }</span>

<span class="nc" id="L218">        final List&lt;String&gt; descriptionsOfCommonsCategories = new ArrayList&lt;&gt;();</span>
        for (final CategoryItem category :
<span class="nc bnc" id="L220" title="All 2 branches missed.">            depictedItem.getCommonsCategories()) {</span>
<span class="nc" id="L221">            descriptionsOfCommonsCategories.add(category.getDescription());</span>
<span class="nc" id="L222">        }</span>

<span class="nc" id="L224">        final List&lt;String&gt; thumbnailsOfCommonsCategories = new ArrayList&lt;&gt;();</span>
        for (final CategoryItem category :
<span class="nc bnc" id="L226" title="All 2 branches missed.">            depictedItem.getCommonsCategories()) {</span>
<span class="nc" id="L227">            thumbnailsOfCommonsCategories.add(category.getThumbnail());</span>
<span class="nc" id="L228">        }</span>

<span class="nc" id="L230">        final ContentValues cv = new ContentValues();</span>
<span class="nc" id="L231">        cv.put(Table.COLUMN_NAME, depictedItem.getName());</span>
<span class="nc" id="L232">        cv.put(Table.COLUMN_DESCRIPTION, depictedItem.getDescription());</span>
<span class="nc" id="L233">        cv.put(Table.COLUMN_IMAGE, depictedItem.getImageUrl());</span>
<span class="nc" id="L234">        cv.put(Table.COLUMN_INSTANCE_LIST, ArrayToString(depictedItem.getInstanceOfs()));</span>
<span class="nc" id="L235">        cv.put(Table.COLUMN_CATEGORIES_NAME_LIST, ArrayToString(namesOfCommonsCategories));</span>
<span class="nc" id="L236">        cv.put(Table.COLUMN_CATEGORIES_DESCRIPTION_LIST,</span>
<span class="nc" id="L237">            ArrayToString(descriptionsOfCommonsCategories));</span>
<span class="nc" id="L238">        cv.put(Table.COLUMN_CATEGORIES_THUMBNAIL_LIST,</span>
<span class="nc" id="L239">            ArrayToString(thumbnailsOfCommonsCategories));</span>
<span class="nc" id="L240">        cv.put(Table.COLUMN_IS_SELECTED, depictedItem.isSelected());</span>
<span class="nc" id="L241">        cv.put(Table.COLUMN_ID, depictedItem.getId());</span>
<span class="nc" id="L242">        return cv;</span>
    }

    /**
     * Table of bookmarksItems data
     */
<span class="nc" id="L248">    public static final class Table {</span>
        public static final String TABLE_NAME = &quot;bookmarksItems&quot;;
        public static final String COLUMN_NAME = &quot;item_name&quot;;
        public static final String COLUMN_DESCRIPTION = &quot;item_description&quot;;
        public static final String COLUMN_IMAGE = &quot;item_image_url&quot;;
        public static final String COLUMN_INSTANCE_LIST = &quot;item_instance_of&quot;;
        public static final String COLUMN_CATEGORIES_NAME_LIST = &quot;item_name_categories&quot;;
        public static final String COLUMN_CATEGORIES_DESCRIPTION_LIST = &quot;item_description_categories&quot;;
        public static final String COLUMN_CATEGORIES_THUMBNAIL_LIST = &quot;item_thumbnail_categories&quot;;
        public static final String COLUMN_IS_SELECTED = &quot;item_is_selected&quot;;
        public static final String COLUMN_ID = &quot;item_id&quot;;

<span class="nc" id="L260">        public static final String[] ALL_FIELDS = {</span>
            COLUMN_NAME,
            COLUMN_DESCRIPTION,
            COLUMN_IMAGE,
            COLUMN_INSTANCE_LIST,
            COLUMN_CATEGORIES_NAME_LIST,
            COLUMN_CATEGORIES_DESCRIPTION_LIST,
            COLUMN_CATEGORIES_THUMBNAIL_LIST,
            COLUMN_IS_SELECTED,
            COLUMN_ID
        };

        static final String DROP_TABLE_STATEMENT = &quot;DROP TABLE IF EXISTS &quot; + TABLE_NAME;
        static final String CREATE_TABLE_STATEMENT = &quot;CREATE TABLE &quot; + TABLE_NAME + &quot; (&quot;
            + COLUMN_NAME + &quot; STRING,&quot;
            + COLUMN_DESCRIPTION + &quot; STRING,&quot;
            + COLUMN_IMAGE + &quot; STRING,&quot;
            + COLUMN_INSTANCE_LIST + &quot; STRING,&quot;
            + COLUMN_CATEGORIES_NAME_LIST + &quot; STRING,&quot;
            + COLUMN_CATEGORIES_DESCRIPTION_LIST + &quot; STRING,&quot;
            + COLUMN_CATEGORIES_THUMBNAIL_LIST + &quot; STRING,&quot;
            + COLUMN_IS_SELECTED + &quot; STRING,&quot;
            + COLUMN_ID + &quot; STRING PRIMARY KEY&quot;
            + &quot;);&quot;;

        /**
         * Creates table
         * @param db SQLiteDatabase
         */
        public static void onCreate(final SQLiteDatabase db) {
<span class="nc" id="L290">            db.execSQL(CREATE_TABLE_STATEMENT);</span>
<span class="nc" id="L291">        }</span>

        /**
         * Deletes database
         * @param db SQLiteDatabase
         */
        public static void onDelete(final SQLiteDatabase db) {
<span class="nc" id="L298">            db.execSQL(DROP_TABLE_STATEMENT);</span>
<span class="nc" id="L299">            onCreate(db);</span>
<span class="nc" id="L300">        }</span>

        /**
         * Updates database
         * @param db SQLiteDatabase
         * @param from starting
         * @param to end
         */
        public static void onUpdate(final SQLiteDatabase db, int from, final int to) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (from == to) {</span>
<span class="nc" id="L310">                return;</span>
            }
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (from &lt; 18) {</span>
                // doesn't exist yet
<span class="nc" id="L314">                from++;</span>
<span class="nc" id="L315">                onUpdate(db, from, to);</span>
<span class="nc" id="L316">                return;</span>
            }

<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (from == 18) {</span>
                // table added in version 19
<span class="nc" id="L321">                onCreate(db);</span>
<span class="nc" id="L322">                from++;</span>
<span class="nc" id="L323">                onUpdate(db, from, to);</span>
            }
<span class="nc" id="L325">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>