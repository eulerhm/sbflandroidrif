<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermissionUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.utils</a> &gt; <span class="el_source">PermissionUtils.java</span></div><h1>PermissionUtils.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.utils;

import android.Manifest;
import android.app.Activity;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Build;
import android.provider.Settings;
import android.widget.Toast;
import androidx.annotation.StringRes;
import androidx.core.content.ContextCompat;
import com.karumi.dexter.Dexter;
import com.karumi.dexter.MultiplePermissionsReport;
import com.karumi.dexter.PermissionToken;
import com.karumi.dexter.listener.PermissionRequest;
import com.karumi.dexter.listener.multi.MultiplePermissionsListener;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.upload.UploadActivity;
import java.util.List;


<span class="nc" id="L24">public class PermissionUtils {</span>

<span class="nc bnc" id="L26" title="All 2 branches missed.">    public static String[] PERMISSIONS_STORAGE = isSDKVersionScopedStorageCompatible() ?</span>
<span class="nc bnc" id="L27" title="All 2 branches missed.">        isSDKVersionTiramisu() ? new String[]{</span>
            Manifest.permission.READ_MEDIA_IMAGES} :
<span class="nc" id="L29">            new String[]{Manifest.permission.READ_EXTERNAL_STORAGE}</span>
<span class="nc bnc" id="L30" title="All 2 branches missed.">        : isSDKVersionTiramisu() ? new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE,</span>
            Manifest.permission.READ_MEDIA_IMAGES}
<span class="nc" id="L32">            : new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE,</span>
                Manifest.permission.READ_EXTERNAL_STORAGE};

    private static boolean isSDKVersionScopedStorageCompatible() {
<span class="nc bnc" id="L36" title="All 2 branches missed.">        return Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.P;</span>
    }

    public static boolean isSDKVersionTiramisu() {
<span class="nc bnc" id="L40" title="All 2 branches missed.">        return Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU;</span>
    }

    /**
     * This method can be used by any activity which requires a permission which has been
     * blocked(marked never ask again by the user) It open the app settings from where the user can
     * manually give us the required permission.
     *
     * @param activity
     */
    private static void askUserToManuallyEnablePermissionFromSettings(Activity activity) {
<span class="nc" id="L51">        Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span>
<span class="nc" id="L52">        Uri uri = Uri.fromParts(&quot;package&quot;, activity.getPackageName(), null);</span>
<span class="nc" id="L53">        intent.setData(uri);</span>
<span class="nc" id="L54">        activity.startActivityForResult(intent,</span>
            CommonsApplication.OPEN_APPLICATION_DETAIL_SETTINGS);
<span class="nc" id="L56">    }</span>

    /**
     * Checks whether the app already has a particular permission
     *
     * @param activity
     * @param permissions permissions to be checked
     * @return
     */
    public static boolean hasPermission(Activity activity, String permissions[]) {
<span class="nc" id="L66">        boolean hasPermission = true;</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        for (String permission : permissions</span>
        ) {
<span class="nc bnc" id="L69" title="All 2 branches missed.">            hasPermission = hasPermission &amp;&amp;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                ContextCompat.checkSelfPermission(activity, permission)</span>
                    == PackageManager.PERMISSION_GRANTED;
        }
<span class="nc" id="L73">        return hasPermission;</span>
    }

    /**
     * Checks for a particular permission and runs the runnable to perform an action when the
     * permission is granted Also, it shows a rationale if needed
     * &lt;p&gt;
     * rationaleTitle and rationaleMessage can be invalid @StringRes. If the value is -1 then no
     * permission rationale will be displayed and permission would be requested
     * &lt;p&gt;
     * Sample usage:
     * &lt;p&gt;
     * PermissionUtils.checkPermissionsAndPerformAction(activity,
     * Manifest.permission.WRITE_EXTERNAL_STORAGE, () -&gt; initiateCameraUpload(activity),
     * R.string.storage_permission_title, R.string.write_storage_permission_rationale);
     * &lt;p&gt;
     * If you don't want the permission rationale to be shown then use:
     * &lt;p&gt;
     * PermissionUtils.checkPermissionsAndPerformAction(activity,
     * Manifest.permission.WRITE_EXTERNAL_STORAGE, () -&gt; initiateCameraUpload(activity), - 1, -1);
     *
     * @param activity            activity requesting permissions
     * @param permissions         the permissions array being requests
     * @param onPermissionGranted the runnable to be executed when the permission is granted
     * @param rationaleTitle      rationale title to be displayed when permission was denied. It can
     *                            be an invalid @StringRes
     * @param rationaleMessage    rationale message to be displayed when permission was denied. It
     *                            can be an invalid @StringRes
     */
    public static void checkPermissionsAndPerformAction(Activity activity,
        Runnable onPermissionGranted, @StringRes int rationaleTitle,
        @StringRes int rationaleMessage, String... permissions) {
<span class="nc" id="L105">        checkPermissionsAndPerformAction(activity, onPermissionGranted, null,</span>
            rationaleTitle, rationaleMessage, permissions);
<span class="nc" id="L107">    }</span>

    /**
     * Checks for a particular permission and runs the corresponding runnables to perform an action
     * when the permission is granted/denied Also, it shows a rationale if needed
     * &lt;p&gt;
     * Sample usage:
     * &lt;p&gt;
     * PermissionUtils.checkPermissionsAndPerformAction(activity,
     * Manifest.permission.WRITE_EXTERNAL_STORAGE, () -&gt; initiateCameraUpload(activity), () -&gt;
     * showMessage(), R.string.storage_permission_title,
     * R.string.write_storage_permission_rationale);
     *
     * @param activity            activity requesting permissions
     * @param permissions         the permissions array being requested
     * @param onPermissionGranted the runnable to be executed when the permission is granted
     * @param onPermissionDenied  the runnable to be executed when the permission is denied(but not
     *                            permanently)
     * @param rationaleTitle      rationale title to be displayed when permission was denied
     * @param rationaleMessage    rationale message to be displayed when permission was denied
     */
    public static void checkPermissionsAndPerformAction(Activity activity,
        Runnable onPermissionGranted, Runnable onPermissionDenied, @StringRes int rationaleTitle,
        @StringRes int rationaleMessage, String... permissions) {
<span class="nc" id="L131">        Dexter.withActivity(activity)</span>
<span class="nc" id="L132">            .withPermissions(permissions)</span>
<span class="nc" id="L133">            .withListener(new MultiplePermissionsListener() {</span>
                @Override
                public void onPermissionsChecked(MultiplePermissionsReport report) {
<span class="nc bnc" id="L136" title="All 2 branches missed.">                    if (report.areAllPermissionsGranted()) {</span>
<span class="nc" id="L137">                        onPermissionGranted.run();</span>
<span class="nc" id="L138">                        return;</span>
                    }
<span class="nc bnc" id="L140" title="All 2 branches missed.">                    if (report.isAnyPermissionPermanentlyDenied()) {</span>
                        // permission is denied permanently, we will show user a dialog message.
<span class="nc" id="L142">                        DialogUtil.showAlertDialog(activity, activity.getString(rationaleTitle),</span>
<span class="nc" id="L143">                            activity.getString(rationaleMessage),</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                            activity.getString(R.string.navigation_item_settings),</span>
                            null,
                            () -&gt; {
<span class="nc" id="L147">                                askUserToManuallyEnablePermissionFromSettings(activity);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                                if (activity instanceof UploadActivity) {</span>
<span class="nc" id="L149">                                    ((UploadActivity) activity).setShowPermissionsDialog(true);</span>
                                }
<span class="nc" id="L151">                            }, null, null,</span>
                            !(activity instanceof UploadActivity));
                    } else {
<span class="nc bnc" id="L154" title="All 2 branches missed.">                        if (null != onPermissionDenied) {</span>
<span class="nc" id="L155">                            onPermissionDenied.run();</span>
                        }
                    }
<span class="nc" id="L158">                }</span>

                @Override
                public void onPermissionRationaleShouldBeShown(List&lt;PermissionRequest&gt; permissions,
                    PermissionToken token) {
<span class="nc bnc" id="L163" title="All 4 branches missed.">                    if (rationaleTitle == -1 &amp;&amp; rationaleMessage == -1) {</span>
<span class="nc" id="L164">                        token.continuePermissionRequest();</span>
<span class="nc" id="L165">                        return;</span>
                    }
<span class="nc" id="L167">                    DialogUtil.showAlertDialog(activity, activity.getString(rationaleTitle),</span>
<span class="nc" id="L168">                        activity.getString(rationaleMessage),</span>
<span class="nc" id="L169">                        activity.getString(android.R.string.ok),</span>
<span class="nc" id="L170">                        activity.getString(android.R.string.cancel),</span>
                        () -&gt; {
<span class="nc bnc" id="L172" title="All 2 branches missed.">                            if (activity instanceof UploadActivity) {</span>
<span class="nc" id="L173">                                ((UploadActivity) activity).setShowPermissionsDialog(true);</span>
                            }
<span class="nc" id="L175">                            token.continuePermissionRequest();</span>
<span class="nc" id="L176">                        }</span>
                        ,
                        () -&gt; {
<span class="nc" id="L179">                            Toast.makeText(activity.getApplicationContext(),</span>
                                    R.string.permissions_are_required_for_functionality,
                                    Toast.LENGTH_LONG)
<span class="nc" id="L182">                                .show();</span>
<span class="nc" id="L183">                            token.cancelPermissionRequest();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                            if (activity instanceof UploadActivity) {</span>
<span class="nc" id="L185">                                activity.finish();</span>
                            }
<span class="nc" id="L187">                        }</span>
                        ,
                        null,
                        false);
<span class="nc" id="L191">                }</span>
            })
<span class="nc" id="L193">            .onSameThread()</span>
<span class="nc" id="L194">            .check();</span>
<span class="nc" id="L195">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>