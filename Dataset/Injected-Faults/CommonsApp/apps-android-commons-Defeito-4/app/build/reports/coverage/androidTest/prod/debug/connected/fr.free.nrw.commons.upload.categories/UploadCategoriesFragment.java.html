<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadCategoriesFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.upload.categories</a> &gt; <span class="el_source">UploadCategoriesFragment.java</span></div><h1>UploadCategoriesFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.upload.categories;

import static fr.free.nrw.commons.wikidata.WikidataConstants.SELECTED_NEARBY_PLACE_CATEGORY;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.os.Bundle;
import android.text.Editable;
import android.view.KeyEvent;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.ProgressBar;
import android.widget.TextView;
import android.widget.Toast;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import butterknife.BindView;
import butterknife.ButterKnife;
import butterknife.OnClick;
import com.google.android.material.textfield.TextInputLayout;
import com.jakewharton.rxbinding2.view.RxView;
import com.jakewharton.rxbinding2.widget.RxTextView;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.category.CategoryItem;
import fr.free.nrw.commons.contributions.ContributionsFragment;
import fr.free.nrw.commons.media.MediaDetailFragment;
import fr.free.nrw.commons.ui.PasteSensitiveTextInputEditText;
import fr.free.nrw.commons.upload.UploadActivity;
import fr.free.nrw.commons.upload.UploadBaseFragment;
import fr.free.nrw.commons.utils.DialogUtil;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.Disposable;
import java.util.List;
import java.util.Objects;
import java.util.concurrent.TimeUnit;
import javax.inject.Inject;
import kotlin.Unit;
import timber.log.Timber;

<span class="nc" id="L49">public class UploadCategoriesFragment extends UploadBaseFragment implements CategoriesContract.View {</span>

    @BindView(R.id.tv_title)
    TextView tvTitle;
    @BindView(R.id.tv_subtitle)
    TextView tvSubTitle;
    @BindView(R.id.til_container_search)
    TextInputLayout tilContainerEtSearch;
    @BindView(R.id.et_search)
    PasteSensitiveTextInputEditText etSearch;
    @BindView(R.id.pb_categories)
    ProgressBar pbCategories;
    @BindView(R.id.rv_categories)
    RecyclerView rvCategories;
    @BindView(R.id.tooltip)
    ImageView tooltip;
    @BindView(R.id.btn_next)
    Button btnNext;
    @BindView(R.id.btn_previous)
    Button btnPrevious;

    @Inject
    CategoriesContract.UserActionListener presenter;
    private UploadCategoryAdapter adapter;
    private Disposable subscribe;
    /**
     * Current media
     */
    private Media media;
    /**
     * Progress Dialog for showing background process
     */
    private ProgressDialog progressDialog;
    /**
     * WikiText from the server
     */
    private String wikiText;
    private String nearbyPlaceCategory;

    @Nullable
    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container,
                             @Nullable Bundle savedInstanceState) {
<span class="nc" id="L92">        return inflater.inflate(R.layout.upload_categories_fragment, container, false);</span>
    }

    @Override
    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
<span class="nc" id="L97">        super.onViewCreated(view, savedInstanceState);</span>
<span class="nc" id="L98">        ButterKnife.bind(this, view);</span>
<span class="nc" id="L99">        final Bundle bundle = getArguments();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (bundle != null) {</span>
<span class="nc" id="L101">            media = bundle.getParcelable(&quot;Existing_Categories&quot;);</span>
<span class="nc" id="L102">            wikiText = bundle.getString(&quot;WikiText&quot;);</span>
<span class="nc" id="L103">            nearbyPlaceCategory = bundle.getString(SELECTED_NEARBY_PLACE_CATEGORY);</span>
        }
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if(callback!=null) {</span>
<span class="nc" id="L106">            init();</span>
<span class="nc" id="L107">            presenter.getCategories().observe(getViewLifecycleOwner(), this::setCategories);</span>
        }

<span class="nc" id="L110">    }</span>

    private void init() {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (media == null) {</span>
<span class="nc" id="L114">            tvTitle.setText(getString(R.string.step_count, callback.getIndexInViewFlipper(this) + 1,</span>
<span class="nc" id="L115">                callback.getTotalNumberOfSteps(), getString(R.string.categories_activity_title)));</span>
        } else {
<span class="nc" id="L117">            tvTitle.setText(R.string.edit_categories);</span>
<span class="nc" id="L118">            tvSubTitle.setVisibility(View.GONE);</span>
<span class="nc" id="L119">            btnNext.setText(R.string.menu_save_categories);</span>
<span class="nc" id="L120">            btnPrevious.setText(R.string.menu_cancel_upload);</span>
        }

<span class="nc" id="L123">        setTvSubTitle();</span>
<span class="nc" id="L124">        tooltip.setOnClickListener(new OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L127">                DialogUtil.showAlertDialog(getActivity(), getString(R.string.categories_activity_title), getString(R.string.categories_tooltip), getString(android.R.string.ok), null, true);</span>
<span class="nc" id="L128">            }</span>
        });
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (media == null) {</span>
<span class="nc" id="L131">            presenter.onAttachView(this);</span>
        } else {
<span class="nc" id="L133">            presenter.onAttachViewWithMedia(this, media);</span>
        }
<span class="nc" id="L135">        initRecyclerView();</span>
<span class="nc" id="L136">        addTextChangeListenerToEtSearch();</span>
<span class="nc" id="L137">    }</span>

    private void addTextChangeListenerToEtSearch() {
<span class="nc" id="L140">        subscribe = RxTextView.textChanges(etSearch)</span>
<span class="nc" id="L141">                .doOnEach(v -&gt; tilContainerEtSearch.setError(null))</span>
<span class="nc" id="L142">                .takeUntil(RxView.detaches(etSearch))</span>
<span class="nc" id="L143">                .debounce(500, TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L144">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L145">                .subscribe(filter -&gt; searchForCategory(filter.toString()), Timber::e);</span>
<span class="nc" id="L146">    }</span>

    /**
     * Removes  the tv subtitle If the activity is the instance of [UploadActivity] and
     * if multiple files aren't selected.
     */
    private void setTvSubTitle() {
<span class="nc" id="L153">        final Activity activity = getActivity();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (activity instanceof UploadActivity) {</span>
<span class="nc" id="L155">            final boolean isMultipleFileSelected = ((UploadActivity) activity).getIsMultipleFilesSelected();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (!isMultipleFileSelected) {</span>
<span class="nc" id="L157">                tvSubTitle.setVisibility(View.GONE);</span>
            }
        }
<span class="nc" id="L160">    }</span>

    private void searchForCategory(String query) {
<span class="nc" id="L163">        presenter.searchForCategories(query);</span>
<span class="nc" id="L164">    }</span>

    private void initRecyclerView() {
<span class="nc" id="L167">        adapter = new UploadCategoryAdapter(categoryItem -&gt; {</span>
<span class="nc" id="L168">            presenter.onCategoryItemClicked(categoryItem);</span>
<span class="nc" id="L169">            return Unit.INSTANCE;</span>
        }, nearbyPlaceCategory);
<span class="nc" id="L171">        rvCategories.setLayoutManager(new LinearLayoutManager(getContext()));</span>
<span class="nc" id="L172">        rvCategories.setAdapter(adapter);</span>
<span class="nc" id="L173">    }</span>

    @Override
    public void onDestroyView() {
<span class="nc" id="L177">        super.onDestroyView();</span>
<span class="nc" id="L178">        presenter.onDetachView();</span>
<span class="nc" id="L179">        subscribe.dispose();</span>
<span class="nc" id="L180">    }</span>

    @Override
    public void showProgress(boolean shouldShow) {
<span class="nc bnc" id="L184" title="All 2 branches missed.">        pbCategories.setVisibility(shouldShow ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L185">    }</span>

    @Override
    public void showError(String error) {
<span class="nc" id="L189">        tilContainerEtSearch.setError(error);</span>
<span class="nc" id="L190">    }</span>

    @Override
    public void showError(int stringResourceId) {
<span class="nc" id="L194">        tilContainerEtSearch.setError(getString(stringResourceId));</span>
<span class="nc" id="L195">    }</span>

    @Override
    public void setCategories(List&lt;CategoryItem&gt; categories) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (categories == null) {</span>
<span class="nc" id="L200">            adapter.clear();</span>
        } else {
<span class="nc" id="L202">            adapter.setItems(categories);</span>
        }
<span class="nc" id="L204">        adapter.notifyDataSetChanged();</span>

        // Nested waiting for search result data to load into the category
        // list and smoothly scroll to the top of the search result list.
<span class="nc" id="L208">        rvCategories.post(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L211">                rvCategories.smoothScrollToPosition(0);</span>
<span class="nc" id="L212">                rvCategories.post(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc" id="L215">                        rvCategories.smoothScrollToPosition(0);</span>
<span class="nc" id="L216">                    }</span>
                });
<span class="nc" id="L218">            }</span>
        });
<span class="nc" id="L220">    }</span>

    @Override
    public void goToNextScreen() {
<span class="nc" id="L224">        callback.onNextButtonClicked(callback.getIndexInViewFlipper(this));</span>
<span class="nc" id="L225">    }</span>

    @Override
    public void showNoCategorySelected() {
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (media == null) {</span>
<span class="nc" id="L230">            DialogUtil.showAlertDialog(getActivity(),</span>
<span class="nc" id="L231">                getString(R.string.no_categories_selected),</span>
<span class="nc" id="L232">                getString(R.string.no_categories_selected_warning_desc),</span>
<span class="nc" id="L233">                getString(R.string.continue_message),</span>
<span class="nc" id="L234">                getString(R.string.cancel),</span>
<span class="nc" id="L235">                () -&gt; goToNextScreen(),</span>
                null);
        } else {
<span class="nc" id="L238">            Toast.makeText(requireContext(), getString(R.string.no_categories_selected),</span>
<span class="nc" id="L239">                Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L240">            presenter.clearPreviousSelection();</span>
<span class="nc" id="L241">            goBackToPreviousScreen();</span>
        }

<span class="nc" id="L244">    }</span>

    /**
     * Gets existing categories from media
     */
    @Override
    public List&lt;String&gt; getExistingCategories() {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        return (media == null) ? null : media.getCategories();</span>
    }

    /**
     * Returns required context
     */
    @Override
    public Context getFragmentContext() {
<span class="nc" id="L259">        return requireContext();</span>
    }

    /**
     * Returns to previous fragment
     */
    @Override
    public void goBackToPreviousScreen() {
<span class="nc" id="L267">        getFragmentManager().popBackStack();</span>
<span class="nc" id="L268">    }</span>

    /**
     * Shows the progress dialog
     */
    @Override
    public void showProgressDialog() {
<span class="nc" id="L275">        progressDialog = new ProgressDialog(requireContext());</span>
<span class="nc" id="L276">        progressDialog.setMessage(getString(R.string.please_wait));</span>
<span class="nc" id="L277">        progressDialog.show();</span>
<span class="nc" id="L278">    }</span>

    /**
     * Hides the progress dialog
     */
    @Override
    public void dismissProgressDialog() {
<span class="nc" id="L285">        progressDialog.dismiss();</span>
<span class="nc" id="L286">    }</span>

    /**
     * Refreshes the categories
     */
    @Override
    public void refreshCategories() {
<span class="nc" id="L293">        final MediaDetailFragment mediaDetailFragment = (MediaDetailFragment) getParentFragment();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        assert mediaDetailFragment != null;</span>
<span class="nc" id="L295">        mediaDetailFragment.updateCategories();</span>
<span class="nc" id="L296">    }</span>

    @OnClick(R.id.btn_next)
    public void onNextButtonClicked() {
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (media != null) {</span>
<span class="nc" id="L301">            presenter.updateCategories(media, wikiText);</span>
        } else {
<span class="nc" id="L303">            presenter.verifyCategories();</span>
        }
<span class="nc" id="L305">    }</span>

    @OnClick(R.id.btn_previous)
    public void onPreviousButtonClicked() {
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (media != null) {</span>
<span class="nc" id="L310">            presenter.clearPreviousSelection();</span>
<span class="nc" id="L311">            adapter.setItems(null);</span>
<span class="nc" id="L312">            final MediaDetailFragment mediaDetailFragment = (MediaDetailFragment) getParentFragment();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            assert mediaDetailFragment != null;</span>
<span class="nc" id="L314">            mediaDetailFragment.onResume();</span>
<span class="nc" id="L315">            goBackToPreviousScreen();</span>
<span class="nc" id="L316">        } else {</span>
<span class="nc" id="L317">            callback.onPreviousButtonClicked(callback.getIndexInViewFlipper(this));</span>
        }
<span class="nc" id="L319">    }</span>

    @Override
    protected void onBecameVisible() {
<span class="nc" id="L323">        super.onBecameVisible();</span>
<span class="nc" id="L324">        presenter.selectCategories();</span>
<span class="nc" id="L325">        final Editable text = etSearch.getText();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (text != null) {</span>
<span class="nc" id="L327">            presenter.searchForCategories(text.toString());</span>
        }
<span class="nc" id="L329">    }</span>

    /**
     * Hides the action bar while opening editing fragment
     */
    @Override
    public void onResume() {
<span class="nc" id="L336">        super.onResume();</span>

<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (media != null) {</span>
<span class="nc" id="L339">            etSearch.setOnKeyListener((v, keyCode, event) -&gt; {</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                if (keyCode == KeyEvent.KEYCODE_BACK) {</span>
<span class="nc" id="L341">                    etSearch.clearFocus();</span>
<span class="nc" id="L342">                    presenter.clearPreviousSelection();</span>
<span class="nc" id="L343">                    final MediaDetailFragment mediaDetailFragment = (MediaDetailFragment) getParentFragment();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                    assert mediaDetailFragment != null;</span>
<span class="nc" id="L345">                    mediaDetailFragment.onResume();</span>
<span class="nc" id="L346">                    goBackToPreviousScreen();</span>
<span class="nc" id="L347">                    return true;</span>
                }
<span class="nc" id="L349">                return false;</span>
            });

<span class="nc" id="L352">            Objects.requireNonNull(getView()).setFocusableInTouchMode(true);</span>
<span class="nc" id="L353">            getView().requestFocus();</span>
<span class="nc" id="L354">            getView().setOnKeyListener((v, keyCode, event) -&gt; {</span>
<span class="nc bnc" id="L355" title="All 4 branches missed.">                if (event.getAction() == KeyEvent.ACTION_UP &amp;&amp; keyCode == KeyEvent.KEYCODE_BACK) {</span>
<span class="nc" id="L356">                    presenter.clearPreviousSelection();</span>
<span class="nc" id="L357">                    final MediaDetailFragment mediaDetailFragment = (MediaDetailFragment) getParentFragment();</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                    assert mediaDetailFragment != null;</span>
<span class="nc" id="L359">                    mediaDetailFragment.onResume();</span>
<span class="nc" id="L360">                    goBackToPreviousScreen();</span>
<span class="nc" id="L361">                    return true;</span>
                }
<span class="nc" id="L363">                return false;</span>
            });

<span class="nc" id="L366">            Objects.requireNonNull(</span>
<span class="nc" id="L367">                ((AppCompatActivity) Objects.requireNonNull(getActivity())).getSupportActionBar())</span>
<span class="nc" id="L368">                .hide();</span>

<span class="nc bnc" id="L370" title="All 2 branches missed.">            if (getParentFragment().getParentFragment().getParentFragment()</span>
                instanceof ContributionsFragment) {
<span class="nc" id="L372">                ((ContributionsFragment) (getParentFragment()</span>
<span class="nc" id="L373">                    .getParentFragment().getParentFragment())).nearbyNotificationCardView</span>
<span class="nc" id="L374">                    .setVisibility(View.GONE);</span>
            }
        }
<span class="nc" id="L377">    }</span>

    /**
     * Shows the action bar while closing editing fragment
     */
    @Override
    public void onStop() {
<span class="nc" id="L384">        super.onStop();</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">        if (media != null) {</span>
<span class="nc" id="L386">            Objects.requireNonNull(</span>
<span class="nc" id="L387">                ((AppCompatActivity) Objects.requireNonNull(getActivity())).getSupportActionBar())</span>
<span class="nc" id="L388">                .show();</span>
        }
<span class="nc" id="L390">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>