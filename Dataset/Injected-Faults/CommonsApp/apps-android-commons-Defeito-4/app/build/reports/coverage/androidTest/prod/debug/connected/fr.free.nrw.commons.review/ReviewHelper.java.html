<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReviewHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.review</a> &gt; <span class="el_source">ReviewHelper.java</span></div><h1>ReviewHelper.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.review;


import androidx.annotation.VisibleForTesting;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.media.MediaClient;
import io.reactivex.Completable;
import io.reactivex.Observable;
import io.reactivex.Single;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.schedulers.Schedulers;
import java.util.Collections;
import javax.inject.Inject;
import javax.inject.Singleton;
import org.apache.commons.lang3.StringUtils;
import org.wikipedia.dataclient.mwapi.MwQueryPage;
import timber.log.Timber;

@Singleton
public class ReviewHelper {

<span class="nc" id="L22">    private static final String[] imageExtensions = new String[]{&quot;.jpg&quot;, &quot;.jpeg&quot;, &quot;.png&quot;};</span>

    private final MediaClient mediaClient;
    private final ReviewInterface reviewInterface;

    @Inject
    ReviewDao dao;

    @Inject
<span class="nc" id="L31">    public ReviewHelper(MediaClient mediaClient, ReviewInterface reviewInterface) {</span>
<span class="nc" id="L32">        this.mediaClient = mediaClient;</span>
<span class="nc" id="L33">        this.reviewInterface = reviewInterface;</span>
<span class="nc" id="L34">    }</span>

    /**
     * Fetches recent changes from MediaWiki API
     * Calls the API to get the latest 50 changes
     * When more results are available, the query gets continued beyond this range
     *
     * @return
     */
    private Observable&lt;MwQueryPage&gt; getRecentChanges() {
<span class="nc" id="L44">        return reviewInterface.getRecentChanges()</span>
<span class="nc" id="L45">                .map(mwQueryResponse -&gt; mwQueryResponse.query().pages())</span>
<span class="nc" id="L46">                .map(recentChanges -&gt; {</span>
<span class="nc" id="L47">                    Collections.shuffle(recentChanges);</span>
<span class="nc" id="L48">                    return recentChanges;</span>
                })
<span class="nc" id="L50">                .flatMapIterable(changes -&gt; changes)</span>
<span class="nc" id="L51">                .filter(recentChange -&gt; isChangeReviewable(recentChange));</span>
    }

    /**
     * Gets a random file change for review.
     * - Picks a random file from those changes
     * - Checks if the file is nominated for deletion
     * - Retries upto 5 times for getting a file which is not nominated for deletion
     *
     * @return Random file change
     */
    public Single&lt;Media&gt; getRandomMedia() {
<span class="nc" id="L63">        return getRecentChanges()</span>
<span class="nc" id="L64">                .flatMapSingle(change -&gt; getRandomMediaFromRecentChange(change))</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                .filter(media -&gt; !StringUtils.isBlank(media.getFilename())</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                   &amp;&amp; !getReviewStatus(media.getPageId())    // Check if the image has already been shown to the user</span>
                )
<span class="nc" id="L68">                .firstOrError();</span>
    }

    /**
     * Returns a proper Media object if the file is not already nominated for deletion
     * Else it returns an empty Media object
     *
     * @param recentChange
     * @return
     */
    private Single&lt;Media&gt; getRandomMediaFromRecentChange(MwQueryPage recentChange) {
<span class="nc" id="L79">        return Single.just(recentChange)</span>
<span class="nc" id="L80">                .flatMap(change -&gt; mediaClient.checkPageExistsUsingTitle(&quot;Commons:Deletion_requests/&quot; + change.title()))</span>
<span class="nc" id="L81">                .flatMap(isDeleted -&gt; {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    if (isDeleted) {</span>
<span class="nc" id="L83">                        return Single.error(new Exception(recentChange.title() + &quot; is deleted&quot;));</span>
                    }
<span class="nc" id="L85">                    return mediaClient.getMedia(recentChange.title());</span>
                });

    }

    /**
     * Checks if the image exists in the reviewed images entity
     *
     * @param image
     * @return
     */
    @VisibleForTesting
    Boolean getReviewStatus(String image){
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if(dao == null){</span>
<span class="nc" id="L99">            return false;</span>
        }
<span class="nc" id="L101">        return Observable.fromCallable(()-&gt; dao.isReviewedAlready(image))</span>
<span class="nc" id="L102">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L103">                .observeOn(AndroidSchedulers.mainThread()).blockingSingle();</span>
    }

    /**
     * Gets the first revision of the file from filename
     *
     * @param filename
     * @return
     */
    public Observable&lt;MwQueryPage.Revision&gt; getFirstRevisionOfFile(String filename) {
<span class="nc" id="L113">        return reviewInterface.getFirstRevisionOfFile(filename)</span>
<span class="nc" id="L114">                .map(response -&gt; response.query().firstPage().revisions().get(0));</span>
    }

    /**
     * Checks Whether Given File is used in any Wiki page or not
     * by calling api for given file
     *
     * @param filename
     * @return
     */
     Observable&lt;Boolean&gt; checkFileUsage(final String filename) {
<span class="nc" id="L125">         return reviewInterface.getGlobalUsageInfo(filename)</span>
<span class="nc" id="L126">             .map(mwQueryResponse -&gt; mwQueryResponse.query().firstPage()</span>
<span class="nc" id="L127">                 .checkWhetherFileIsUsedInWikis());</span>
     }

    /**
     * Checks if the change is reviewable or not.
     * - checks the type and revisionId of the change
     * - checks supported image extensions
     *
     * @param recentChange
     * @return
     */
    private boolean isChangeReviewable(MwQueryPage recentChange) {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        for (String extension : imageExtensions) {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (recentChange.title().endsWith(extension)) {</span>
<span class="nc" id="L141">                return true;</span>
            }
        }

<span class="nc" id="L145">        return false;</span>
    }

    /**
     * Adds reviewed/skipped images to the database
     *
     * @param imageId
     */
    public void addViewedImagesToDB(String imageId) {
<span class="nc" id="L154">        Completable.fromAction(() -&gt; dao.insert(new ReviewEntity(imageId)))</span>
<span class="nc" id="L155">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L156">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L157">            .subscribe(() -&gt; {</span>
                // Inserted successfully
<span class="nc" id="L159">                Timber.i(&quot;Image inserted successfully.&quot;);</span>
<span class="nc" id="L160">                },</span>
                throwable -&gt; {
<span class="nc" id="L162">                    Timber.e(&quot;Image not inserted into the reviewed images database&quot;);</span>
<span class="nc" id="L163">                }</span>
            );
<span class="nc" id="L165">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>