<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.notification</a> &gt; <span class="el_source">NotificationActivity.java</span></div><h1>NotificationActivity.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.notification;

import android.annotation.SuppressLint;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;
import androidx.appcompat.widget.Toolbar;
import androidx.constraintlayout.widget.ConstraintLayout;
import androidx.recyclerview.widget.DividerItemDecoration;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import butterknife.BindView;
import butterknife.ButterKnife;
import com.google.android.material.snackbar.Snackbar;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.Utils;
import fr.free.nrw.commons.notification.models.Notification;
import fr.free.nrw.commons.theme.BaseActivity;
import fr.free.nrw.commons.utils.NetworkUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import io.reactivex.Observable;
import io.reactivex.ObservableSource;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.Disposable;
import io.reactivex.schedulers.Schedulers;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.Callable;
import javax.inject.Inject;
import kotlin.Unit;
import timber.log.Timber;

/**
 * Created by root on 18.12.2017.
 */

<span class="nc" id="L46">public class NotificationActivity extends BaseActivity {</span>
    @BindView(R.id.listView)
    RecyclerView recyclerView;
    @BindView(R.id.progressBar)
    ProgressBar progressBar;
    @BindView(R.id.container)
    RelativeLayout relativeLayout;
    @BindView(R.id.no_notification_background)
    ConstraintLayout no_notification;
    @BindView(R.id.no_notification_text)
    TextView noNotificationText;
    @BindView(R.id.toolbar)
    Toolbar toolbar;


    @Inject
    NotificationController controller;

    private static final String TAG_NOTIFICATION_WORKER_FRAGMENT = &quot;NotificationWorkerFragment&quot;;
    private NotificationWorkerFragment mNotificationWorkerFragment;
    private NotificatinAdapter adapter;
    private List&lt;Notification&gt; notificationList;
    MenuItem notificationMenuItem;
    /**
     * Boolean isRead is true if this notification activity is for read section of notification.
     */
    private boolean isRead;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L76">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L77">        isRead = getIntent().getStringExtra(&quot;title&quot;).equals(&quot;read&quot;);</span>
<span class="nc" id="L78">        setContentView(R.layout.activity_notification);</span>
<span class="nc" id="L79">        ButterKnife.bind(this);</span>
<span class="nc" id="L80">        mNotificationWorkerFragment = (NotificationWorkerFragment) getFragmentManager()</span>
<span class="nc" id="L81">                .findFragmentByTag(TAG_NOTIFICATION_WORKER_FRAGMENT);</span>
<span class="nc" id="L82">        initListView();</span>
<span class="nc" id="L83">        setPageTitle();</span>
<span class="nc" id="L84">        setSupportActionBar(toolbar);</span>
<span class="nc" id="L85">        getSupportActionBar().setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L86">    }</span>

    @Override
    public boolean onSupportNavigateUp() {
<span class="nc" id="L90">        onBackPressed();</span>
<span class="nc" id="L91">        return true;</span>
    }

    /**
     * If this is unread section of the notifications, removeNotification method
     *  Marks the notification as read,
     *  Removes the notification from unread,
     *  Displays the Snackbar.
     *
     * Otherwise returns (read section).
     *
     * @param notification
     */
    @SuppressLint(&quot;CheckResult&quot;)
    public void removeNotification(Notification notification) {
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (isRead) {</span>
<span class="nc" id="L107">            return;</span>
        }
<span class="nc" id="L109">        Disposable disposable = Observable.defer((Callable&lt;ObservableSource&lt;Boolean&gt;&gt;)</span>
<span class="nc" id="L110">                () -&gt; controller.markAsRead(notification))</span>
<span class="nc" id="L111">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L112">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L113">                .subscribe(result -&gt; {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                    if (result) {</span>
<span class="nc" id="L115">                        notificationList.remove(notification);</span>
<span class="nc" id="L116">                        setItems(notificationList);</span>
<span class="nc" id="L117">                        adapter.notifyDataSetChanged();</span>
<span class="nc" id="L118">                        Snackbar snackbar = Snackbar</span>
<span class="nc" id="L119">                                .make(relativeLayout, getString(R.string.notification_mark_read), Snackbar.LENGTH_LONG);</span>

<span class="nc" id="L121">                        snackbar.show();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                        if (notificationList.size() == 0) {</span>
<span class="nc" id="L123">                            setEmptyView();</span>
<span class="nc" id="L124">                            relativeLayout.setVisibility(View.GONE);</span>
<span class="nc" id="L125">                            no_notification.setVisibility(View.VISIBLE);</span>
                        }
<span class="nc" id="L127">                    } else {</span>
<span class="nc" id="L128">                        adapter.notifyDataSetChanged();</span>
<span class="nc" id="L129">                        setItems(notificationList);</span>
<span class="nc" id="L130">                        Toast.makeText(NotificationActivity.this, getString(R.string.some_error), Toast.LENGTH_SHORT).show();</span>
                    }
<span class="nc" id="L132">                }, throwable -&gt; {</span>

<span class="nc" id="L134">                    Timber.e(throwable, &quot;Error occurred while loading notifications&quot;);</span>
<span class="nc" id="L135">                    throwable.printStackTrace();</span>
<span class="nc" id="L136">                    ViewUtil.showShortSnackbar(relativeLayout, R.string.error_notifications);</span>
<span class="nc" id="L137">                    progressBar.setVisibility(View.GONE);</span>
<span class="nc" id="L138">                });</span>
<span class="nc" id="L139">        compositeDisposable.add(disposable);</span>
<span class="nc" id="L140">    }</span>



    private void initListView() {
<span class="nc" id="L145">        recyclerView.setLayoutManager(new LinearLayoutManager(this));</span>
<span class="nc" id="L146">        DividerItemDecoration itemDecor = new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.VERTICAL);</span>
<span class="nc" id="L147">        recyclerView.addItemDecoration(itemDecor);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (isRead) {</span>
<span class="nc" id="L149">            refresh(true);</span>
        } else {
<span class="nc" id="L151">            refresh(false);</span>
        }
<span class="nc" id="L153">        adapter = new NotificatinAdapter(item -&gt; {</span>
<span class="nc" id="L154">            Timber.d(&quot;Notification clicked %s&quot;, item.getLink());</span>
<span class="nc" id="L155">            handleUrl(item.getLink());</span>
<span class="nc" id="L156">            removeNotification(item);</span>
<span class="nc" id="L157">            return Unit.INSTANCE;</span>
        });
<span class="nc" id="L159">        recyclerView.setAdapter(this.adapter);</span>
<span class="nc" id="L160">    }</span>

    private void refresh(boolean archived) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (!NetworkUtils.isInternetConnectionEstablished(this)) {</span>
<span class="nc" id="L164">            progressBar.setVisibility(View.GONE);</span>
<span class="nc" id="L165">            Snackbar.make(relativeLayout, R.string.no_internet, Snackbar.LENGTH_INDEFINITE)</span>
<span class="nc" id="L166">                    .setAction(R.string.retry, view -&gt; refresh(archived)).show();</span>
        } else {
<span class="nc" id="L168">            addNotifications(archived);</span>
        }
<span class="nc" id="L170">        progressBar.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L171">        no_notification.setVisibility(View.GONE);</span>
<span class="nc" id="L172">        relativeLayout.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L173">    }</span>

    @SuppressLint(&quot;CheckResult&quot;)
    private void addNotifications(boolean archived) {
<span class="nc" id="L177">        Timber.d(&quot;Add notifications&quot;);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (mNotificationWorkerFragment == null) {</span>
<span class="nc" id="L179">            progressBar.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L180">            compositeDisposable.add(controller.getNotifications(archived)</span>
<span class="nc" id="L181">                    .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L182">                    .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L183">                    .subscribe(notificationList -&gt; {</span>
<span class="nc" id="L184">                        Collections.reverse(notificationList);</span>
<span class="nc" id="L185">                        Timber.d(&quot;Number of notifications is %d&quot;, notificationList.size());</span>
<span class="nc" id="L186">                        this.notificationList = notificationList;</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                        if (notificationList.size()==0){</span>
<span class="nc" id="L188">                            setEmptyView();</span>
<span class="nc" id="L189">                            relativeLayout.setVisibility(View.GONE);</span>
<span class="nc" id="L190">                            no_notification.setVisibility(View.VISIBLE);</span>
                        } else {
<span class="nc" id="L192">                            setItems(notificationList);</span>
                        }
<span class="nc" id="L194">                        progressBar.setVisibility(View.GONE);</span>
<span class="nc" id="L195">                    }, throwable -&gt; {</span>
<span class="nc" id="L196">                        Timber.e(throwable, &quot;Error occurred while loading notifications&quot;);</span>
<span class="nc" id="L197">                        ViewUtil.showShortSnackbar(relativeLayout, R.string.error_notifications);</span>
<span class="nc" id="L198">                        progressBar.setVisibility(View.GONE);</span>
<span class="nc" id="L199">                    }));</span>
        } else {
<span class="nc" id="L201">            notificationList = mNotificationWorkerFragment.getNotificationList();</span>
<span class="nc" id="L202">            setItems(notificationList);</span>
        }
<span class="nc" id="L204">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L208">        MenuInflater inflater = getMenuInflater();</span>
<span class="nc" id="L209">        inflater.inflate(R.menu.menu_notifications, menu);</span>
<span class="nc" id="L210">        notificationMenuItem = menu.findItem(R.id.archived);</span>
<span class="nc" id="L211">        setMenuItemTitle();</span>
<span class="nc" id="L212">        return true;</span>
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        // Handle item selection
<span class="nc bnc" id="L218" title="All 2 branches missed.">        switch (item.getItemId()) {</span>
            case R.id.archived:
<span class="nc bnc" id="L220" title="All 2 branches missed.">                if (item.getTitle().equals(getString(R.string.menu_option_read))) {</span>
<span class="nc" id="L221">                    NotificationActivity.startYourself(NotificationActivity.this, &quot;read&quot;);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                }else if (item.getTitle().equals(getString(R.string.menu_option_unread))) {</span>
<span class="nc" id="L223">                    onBackPressed();</span>
                }
<span class="nc" id="L225">                return true;</span>
            default:
<span class="nc" id="L227">                return super.onOptionsItemSelected(item);</span>
        }
    }

    private void handleUrl(String url) {
<span class="nc bnc" id="L232" title="All 4 branches missed.">        if (url == null || url.equals(&quot;&quot;)) {</span>
<span class="nc" id="L233">            return;</span>
        }
<span class="nc" id="L235">        Utils.handleWebUrl(this, Uri.parse(url));</span>
<span class="nc" id="L236">    }</span>

    private void setItems(List&lt;Notification&gt; notificationList) {
<span class="nc bnc" id="L239" title="All 4 branches missed.">        if (notificationList == null || notificationList.isEmpty()) {</span>
<span class="nc" id="L240">            ViewUtil.showShortSnackbar(relativeLayout, R.string.no_notifications);</span>
            /*progressBar.setVisibility(View.GONE);
            recyclerView.setVisibility(View.GONE);*/
<span class="nc" id="L243">            relativeLayout.setVisibility(View.GONE);</span>
<span class="nc" id="L244">            setEmptyView();</span>
<span class="nc" id="L245">            no_notification.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L246">            return;</span>
        }
<span class="nc" id="L248">        relativeLayout.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L249">        no_notification.setVisibility(View.GONE);</span>
<span class="nc" id="L250">        adapter.setItems(notificationList);</span>
<span class="nc" id="L251">    }</span>

    public static void startYourself(Context context, String title) {
<span class="nc" id="L254">        Intent intent = new Intent(context, NotificationActivity.class);</span>
<span class="nc" id="L255">        intent.putExtra(&quot;title&quot;, title);</span>

<span class="nc" id="L257">        context.startActivity(intent);</span>
<span class="nc" id="L258">    }</span>

    private void setPageTitle() {
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (getSupportActionBar() != null) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">            if (isRead) {</span>
<span class="nc" id="L263">                getSupportActionBar().setTitle(R.string.read_notifications);</span>
            } else {
<span class="nc" id="L265">                getSupportActionBar().setTitle(R.string.notifications);</span>
            }
        }
<span class="nc" id="L268">    }</span>

    private void setEmptyView() {
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (isRead) {</span>
<span class="nc" id="L272">            noNotificationText.setText(R.string.no_read_notification);</span>
        }else {
<span class="nc" id="L274">            noNotificationText.setText(R.string.no_notification);</span>
        }
<span class="nc" id="L276">    }</span>

    private void setMenuItemTitle() {
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (isRead) {</span>
<span class="nc" id="L280">            notificationMenuItem.setTitle(R.string.menu_option_unread);</span>

        }else {
<span class="nc" id="L283">            notificationMenuItem.setTitle(R.string.menu_option_read);</span>

        }
<span class="nc" id="L286">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>