<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoreBottomSheetFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.navtab</a> &gt; <span class="el_source">MoreBottomSheetFragment.java</span></div><h1>MoreBottomSheetFragment.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.navtab;

import android.accounts.Account;
import android.accounts.AccountManager;
import android.content.ActivityNotFoundException;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.TextView;
import android.widget.Toast;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AlertDialog;
import com.google.android.material.bottomsheet.BottomSheetDialogFragment;
import fr.free.nrw.commons.AboutActivity;
import fr.free.nrw.commons.BuildConfig;
import fr.free.nrw.commons.CommonsApplication;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.WelcomeActivity;
import fr.free.nrw.commons.actions.PageEditClient;
import fr.free.nrw.commons.auth.LoginActivity;
import fr.free.nrw.commons.databinding.FragmentMoreBottomSheetBinding;
import fr.free.nrw.commons.di.ApplicationlessInjection;
import fr.free.nrw.commons.feedback.FeedbackContentCreator;
import fr.free.nrw.commons.feedback.model.Feedback;
import fr.free.nrw.commons.feedback.FeedbackDialog;
import fr.free.nrw.commons.kvstore.BasicKvStore;
import fr.free.nrw.commons.kvstore.JsonKvStore;
import fr.free.nrw.commons.logging.CommonsLogSender;
import fr.free.nrw.commons.profile.ProfileActivity;
import fr.free.nrw.commons.review.ReviewActivity;
import fr.free.nrw.commons.settings.SettingsActivity;
import io.reactivex.Single;
import io.reactivex.SingleSource;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.schedulers.Schedulers;
import java.util.concurrent.Callable;
import javax.inject.Inject;
import javax.inject.Named;
import timber.log.Timber;

<span class="nc" id="L46">public class MoreBottomSheetFragment extends BottomSheetDialogFragment {</span>

    @Inject
    CommonsLogSender commonsLogSender;

    private TextView moreProfile;

    @Inject @Named(&quot;default_preferences&quot;)
    JsonKvStore store;

    @Inject
    @Named(&quot;commons-page-edit&quot;)
    PageEditClient pageEditClient;

    @Nullable
    @Override
    public View onCreateView(@NonNull final LayoutInflater inflater,
        @Nullable final ViewGroup container, @Nullable final Bundle savedInstanceState) {
<span class="nc" id="L64">        super.onCreateView(inflater, container, savedInstanceState);</span>
<span class="nc" id="L65">        final @NonNull FragmentMoreBottomSheetBinding binding =</span>
<span class="nc" id="L66">            FragmentMoreBottomSheetBinding.inflate(inflater, container, false);</span>
<span class="nc" id="L67">        moreProfile = binding.moreProfile;</span>

<span class="nc bnc" id="L69" title="All 2 branches missed.">        if(store.getBoolean(CommonsApplication.IS_LIMITED_CONNECTION_MODE_ENABLED)){</span>
<span class="nc" id="L70">            binding.morePeerReview.setVisibility(View.GONE);</span>
        }

<span class="nc" id="L73">        binding.moreLogout.setOnClickListener(v -&gt; onLogoutClicked());</span>
<span class="nc" id="L74">        binding.moreFeedback.setOnClickListener(v -&gt; onFeedbackClicked());</span>
<span class="nc" id="L75">        binding.moreAbout.setOnClickListener(v -&gt; onAboutClicked());</span>
<span class="nc" id="L76">        binding.moreTutorial.setOnClickListener(v -&gt; onTutorialClicked());</span>
<span class="nc" id="L77">        binding.moreSettings.setOnClickListener(v -&gt; onSettingsClicked());</span>
<span class="nc" id="L78">        binding.moreProfile.setOnClickListener(v -&gt; onProfileClicked());</span>
<span class="nc" id="L79">        binding.morePeerReview.setOnClickListener(v -&gt; onPeerReviewClicked());</span>

<span class="nc" id="L81">        setUserName();</span>
<span class="nc" id="L82">        return binding.getRoot();</span>
    }

    @Override
    public void onAttach(@NonNull final Context context) {
<span class="nc" id="L87">        super.onAttach(context);</span>
<span class="nc" id="L88">        ApplicationlessInjection</span>
<span class="nc" id="L89">            .getInstance(requireActivity().getApplicationContext())</span>
<span class="nc" id="L90">            .getCommonsApplicationComponent()</span>
<span class="nc" id="L91">            .inject(this);</span>
<span class="nc" id="L92">    }</span>

    /**
     * Set the username and user achievements level (if available) in navigationHeader.
     */
    private void setUserName() {
<span class="nc" id="L98">        BasicKvStore store = new BasicKvStore(this.getContext(), getUserName());</span>
<span class="nc" id="L99">        String level = store.getString(&quot;userAchievementsLevel&quot;,&quot;0&quot;);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (level.equals(&quot;0&quot;)) {</span>
<span class="nc" id="L101">            moreProfile.setText(getUserName() + &quot; (&quot; + getString(R.string.see_your_achievements) + &quot;)&quot;);</span>
        }
        else {
<span class="nc" id="L104">            moreProfile.setText(getUserName() + &quot; (&quot; + getString(R.string.level) + &quot; &quot; + level + &quot;)&quot;);</span>
        }
<span class="nc" id="L106">    }</span>

    private String getUserName(){
<span class="nc" id="L109">        final AccountManager accountManager = AccountManager.get(getActivity());</span>
<span class="nc" id="L110">        final Account[] allAccounts = accountManager.getAccountsByType(BuildConfig.ACCOUNT_TYPE);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (allAccounts.length != 0) {</span>
<span class="nc" id="L112">            return allAccounts[0].name;</span>
        }
<span class="nc" id="L114">        return &quot;&quot;;</span>
    }


    protected void onLogoutClicked() {
<span class="nc" id="L119">        new AlertDialog.Builder(requireActivity())</span>
<span class="nc" id="L120">            .setMessage(R.string.logout_verification)</span>
<span class="nc" id="L121">            .setCancelable(false)</span>
<span class="nc" id="L122">            .setPositiveButton(R.string.yes, (dialog, which) -&gt; {</span>
<span class="nc" id="L123">                final CommonsApplication app = (CommonsApplication)</span>
<span class="nc" id="L124">                    requireContext().getApplicationContext();</span>
<span class="nc" id="L125">                app.clearApplicationData(requireContext(), new BaseLogoutListener());</span>
<span class="nc" id="L126">            })</span>
<span class="nc" id="L127">            .setNegativeButton(R.string.no, (dialog, which) -&gt; dialog.cancel())</span>
<span class="nc" id="L128">            .show();</span>
<span class="nc" id="L129">    }</span>

    protected void onFeedbackClicked() {
<span class="nc" id="L132">        showFeedbackDialog();</span>
<span class="nc" id="L133">    }</span>

    /**
     * Creates and shows a dialog asking feedback from users
     */
    private void showFeedbackDialog() {
<span class="nc" id="L139">        new FeedbackDialog(getContext(), this::uploadFeedback).show();</span>
<span class="nc" id="L140">    }</span>

    /**
     * uploads feedback data on the server
     */
    void uploadFeedback(final Feedback feedback) {
<span class="nc" id="L146">        final FeedbackContentCreator feedbackContentCreator = new FeedbackContentCreator(getContext(), feedback);</span>

<span class="nc" id="L148">        Single&lt;Boolean&gt; single =</span>
<span class="nc" id="L149">            pageEditClient.prependEdit(&quot;Commons:Mobile_app/Feedback&quot;, feedbackContentCreator.toString(), &quot;Summary&quot;)</span>
<span class="nc" id="L150">                .flatMapSingle(result -&gt; Single.just(result))</span>
<span class="nc" id="L151">                .firstOrError();</span>

<span class="nc" id="L153">        Single.defer((Callable&lt;SingleSource&lt;Boolean&gt;&gt;) () -&gt; single)</span>
<span class="nc" id="L154">            .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L155">            .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L156">            .subscribe(aBoolean -&gt; {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                if (aBoolean) {</span>
<span class="nc" id="L158">                    Toast.makeText(getContext(), getString(R.string.thanks_feedback), Toast.LENGTH_SHORT)</span>
<span class="nc" id="L159">                        .show();</span>
                } else {
<span class="nc" id="L161">                    Toast.makeText(getContext(), getString(R.string.error_feedback),</span>
<span class="nc" id="L162">                        Toast.LENGTH_SHORT).show();</span>
                }
<span class="nc" id="L164">            });</span>
<span class="nc" id="L165">    }</span>

    /**
     * This method shows the alert dialog when a user wants to send feedback about the app.
     */
    private void showAlertDialog() {
<span class="nc" id="L171">        new AlertDialog.Builder(requireActivity())</span>
<span class="nc" id="L172">            .setMessage(R.string.feedback_sharing_data_alert)</span>
<span class="nc" id="L173">            .setCancelable(false)</span>
<span class="nc" id="L174">            .setPositiveButton(R.string.ok, (dialog, which) -&gt; sendFeedback())</span>
<span class="nc" id="L175">            .show();</span>
<span class="nc" id="L176">    }</span>

    /**
     * This method collects the feedback message and starts the activity with implicit intent
     * to available email client.
     */
    private void sendFeedback() {
<span class="nc" id="L183">        final String technicalInfo = commonsLogSender.getExtraInfo();</span>

<span class="nc" id="L185">        final Intent feedbackIntent = new Intent(Intent.ACTION_SENDTO);</span>
<span class="nc" id="L186">        feedbackIntent.setType(&quot;message/rfc822&quot;);</span>
<span class="nc" id="L187">        feedbackIntent.setData(Uri.parse(&quot;mailto:&quot;));</span>
<span class="nc" id="L188">        feedbackIntent.putExtra(Intent.EXTRA_EMAIL,</span>
            new String[]{CommonsApplication.FEEDBACK_EMAIL});
<span class="nc" id="L190">        feedbackIntent.putExtra(Intent.EXTRA_SUBJECT,</span>
            CommonsApplication.FEEDBACK_EMAIL_SUBJECT);
<span class="nc" id="L192">        feedbackIntent.putExtra(Intent.EXTRA_TEXT, String.format(</span>
            &quot;\n\n%s\n%s&quot;, CommonsApplication.FEEDBACK_EMAIL_TEMPLATE_HEADER, technicalInfo));
        try {
<span class="nc" id="L195">            startActivity(feedbackIntent);</span>
<span class="nc" id="L196">        } catch (final ActivityNotFoundException e) {</span>
<span class="nc" id="L197">            Toast.makeText(getActivity(), R.string.no_email_client, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L198">        }</span>
<span class="nc" id="L199">    }</span>

    protected void onAboutClicked() {
<span class="nc" id="L202">        final Intent intent = new Intent(getActivity(), AboutActivity.class);</span>
<span class="nc" id="L203">        intent.addFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
<span class="nc" id="L204">        requireActivity().startActivity(intent);</span>
<span class="nc" id="L205">    }</span>

    protected void onTutorialClicked() {
<span class="nc" id="L208">        WelcomeActivity.startYourself(getActivity());</span>
<span class="nc" id="L209">    }</span>

    protected void onSettingsClicked() {
<span class="nc" id="L212">        final Intent intent = new Intent(getActivity(), SettingsActivity.class);</span>
<span class="nc" id="L213">        intent.addFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
<span class="nc" id="L214">        requireActivity().startActivity(intent);</span>
<span class="nc" id="L215">    }</span>

    protected void onProfileClicked() {
<span class="nc" id="L218">        ProfileActivity.startYourself(getActivity(), getUserName(), false);</span>
<span class="nc" id="L219">    }</span>

    protected void onPeerReviewClicked() {
<span class="nc" id="L222">        ReviewActivity.startYourself(getActivity(), getString(R.string.title_activity_review));</span>
<span class="nc" id="L223">    }</span>

<span class="nc" id="L225">    private class BaseLogoutListener implements CommonsApplication.LogoutListener {</span>

        @Override
        public void onLogoutComplete() {
<span class="nc" id="L229">            Timber.d(&quot;Logout complete callback received.&quot;);</span>
<span class="nc" id="L230">            final Intent nearbyIntent = new Intent(</span>
<span class="nc" id="L231">                getContext(), LoginActivity.class);</span>
<span class="nc" id="L232">            nearbyIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);</span>
<span class="nc" id="L233">            nearbyIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L234">            startActivity(nearbyIntent);</span>
<span class="nc" id="L235">            requireActivity().finish();</span>
<span class="nc" id="L236">        }</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>