<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.explore</a> &gt; <span class="el_source">SearchActivity.java</span></div><h1>SearchActivity.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.explore;

import android.os.Bundle;
import android.text.TextUtils;
import android.view.View;
import android.widget.FrameLayout;
import android.widget.SearchView;
import androidx.annotation.NonNull;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentTransaction;
import androidx.viewpager.widget.ViewPager;
import butterknife.BindView;
import butterknife.ButterKnife;
import com.google.android.material.tabs.TabLayout;
import com.jakewharton.rxbinding2.view.RxView;
import com.jakewharton.rxbinding2.widget.RxSearchView;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.ViewPagerAdapter;
import fr.free.nrw.commons.category.CategoryImagesCallback;
import fr.free.nrw.commons.explore.categories.search.SearchCategoryFragment;
import fr.free.nrw.commons.explore.depictions.search.SearchDepictionsFragment;
import fr.free.nrw.commons.explore.media.SearchMediaFragment;
import fr.free.nrw.commons.explore.models.RecentSearch;
import fr.free.nrw.commons.explore.recentsearches.RecentSearchesDao;
import fr.free.nrw.commons.explore.recentsearches.RecentSearchesFragment;
import fr.free.nrw.commons.media.MediaDetailPagerFragment;
import fr.free.nrw.commons.theme.BaseActivity;
import fr.free.nrw.commons.utils.FragmentUtils;
import fr.free.nrw.commons.utils.ViewUtil;
import io.reactivex.android.schedulers.AndroidSchedulers;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.concurrent.TimeUnit;
import javax.inject.Inject;
import timber.log.Timber;

/**
 * Represents search screen of this app
 */

<span class="nc" id="L45">public class SearchActivity extends BaseActivity</span>
        implements MediaDetailPagerFragment.MediaDetailProvider, CategoryImagesCallback {

    @BindView(R.id.toolbar_search) Toolbar toolbar;
    @BindView(R.id.searchHistoryContainer) FrameLayout searchHistoryContainer;
    @BindView(R.id.mediaContainer) FrameLayout mediaContainer;
    @BindView(R.id.searchBox) SearchView searchView;
    @BindView(R.id.tab_layout) TabLayout tabLayout;
    @BindView(R.id.viewPager) ViewPager viewPager;

    @Inject
    RecentSearchesDao recentSearchesDao;

    private SearchMediaFragment searchMediaFragment;
    private SearchCategoryFragment searchCategoryFragment;
    private SearchDepictionsFragment searchDepictionsFragment;
    private RecentSearchesFragment recentSearchesFragment;
    private FragmentManager supportFragmentManager;
    private MediaDetailPagerFragment mediaDetails;
    ViewPagerAdapter viewPagerAdapter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L68">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L69">        setContentView(R.layout.activity_search);</span>
<span class="nc" id="L70">        ButterKnife.bind(this);</span>
<span class="nc" id="L71">        setTitle(getString(R.string.title_activity_search));</span>
<span class="nc" id="L72">        setSupportActionBar(toolbar);</span>
<span class="nc" id="L73">        getSupportActionBar().setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L74">        toolbar.setNavigationOnClickListener(v-&gt;onBackPressed());</span>
<span class="nc" id="L75">        supportFragmentManager = getSupportFragmentManager();</span>
<span class="nc" id="L76">        setSearchHistoryFragment();</span>
<span class="nc" id="L77">        viewPagerAdapter = new ViewPagerAdapter(getSupportFragmentManager());</span>
<span class="nc" id="L78">        viewPager.setAdapter(viewPagerAdapter);</span>
<span class="nc" id="L79">        viewPager.setOffscreenPageLimit(2); // Because we want all the fragments to be alive</span>
<span class="nc" id="L80">        tabLayout.setupWithViewPager(viewPager);</span>
<span class="nc" id="L81">        setTabs();</span>
<span class="nc" id="L82">        searchView.setQueryHint(getString(R.string.search_commons));</span>
<span class="nc" id="L83">        searchView.onActionViewExpanded();</span>
<span class="nc" id="L84">        searchView.clearFocus();</span>

<span class="nc" id="L86">    }</span>

    /**
     * This method sets the search history fragment.
     * Search history fragment is displayed when query is empty.
     */
    private void setSearchHistoryFragment() {
<span class="nc" id="L93">        recentSearchesFragment = new RecentSearchesFragment();</span>
<span class="nc" id="L94">        FragmentTransaction transaction = supportFragmentManager.beginTransaction();</span>
<span class="nc" id="L95">        transaction.add(R.id.searchHistoryContainer, recentSearchesFragment).commit();</span>
<span class="nc" id="L96">    }</span>

    /**
     * Sets the titles in the tabLayout and fragments in the viewPager
     */
    public void setTabs() {
<span class="nc" id="L102">        List&lt;Fragment&gt; fragmentList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L103">        List&lt;String&gt; titleList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L104">        searchMediaFragment = new SearchMediaFragment();</span>
<span class="nc" id="L105">        searchDepictionsFragment = new SearchDepictionsFragment();</span>
<span class="nc" id="L106">        searchCategoryFragment= new SearchCategoryFragment();</span>
<span class="nc" id="L107">        fragmentList.add(searchMediaFragment);</span>
<span class="nc" id="L108">        titleList.add(getResources().getString(R.string.search_tab_title_media).toUpperCase());</span>
<span class="nc" id="L109">        fragmentList.add(searchCategoryFragment);</span>
<span class="nc" id="L110">        titleList.add(getResources().getString(R.string.search_tab_title_categories).toUpperCase());</span>
<span class="nc" id="L111">        fragmentList.add(searchDepictionsFragment);</span>
<span class="nc" id="L112">        titleList.add(getResources().getString(R.string.search_tab_title_depictions).toUpperCase());</span>

<span class="nc" id="L114">        viewPagerAdapter.setTabData(fragmentList, titleList);</span>
<span class="nc" id="L115">        viewPagerAdapter.notifyDataSetChanged();</span>
<span class="nc" id="L116">        compositeDisposable.add(RxSearchView.queryTextChanges(searchView)</span>
<span class="nc" id="L117">                .takeUntil(RxView.detaches(searchView))</span>
<span class="nc" id="L118">                .debounce(500, TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L119">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L120">                .subscribe(this::handleSearch, Timber::e</span>
                ));
<span class="nc" id="L122">    }</span>

    private void handleSearch(final CharSequence query) {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!TextUtils.isEmpty(query)) {</span>
<span class="nc" id="L126">            saveRecentSearch(query.toString());</span>
<span class="nc" id="L127">            viewPager.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L128">            tabLayout.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L129">            searchHistoryContainer.setVisibility(View.GONE);</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (FragmentUtils.isFragmentUIActive(searchDepictionsFragment)) {</span>
<span class="nc" id="L132">                searchDepictionsFragment.onQueryUpdated(query.toString());</span>
            }

<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (FragmentUtils.isFragmentUIActive(searchMediaFragment)) {</span>
<span class="nc" id="L136">                searchMediaFragment.onQueryUpdated(query.toString());</span>
            }

<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (FragmentUtils.isFragmentUIActive(searchCategoryFragment)) {</span>
<span class="nc" id="L140">                searchCategoryFragment.onQueryUpdated(query.toString());</span>
            }

         }
        else {
            //Open RecentSearchesFragment
<span class="nc" id="L146">            recentSearchesFragment.updateRecentSearches();</span>
<span class="nc" id="L147">            viewPager.setVisibility(View.GONE);</span>
<span class="nc" id="L148">            tabLayout.setVisibility(View.GONE);</span>
<span class="nc" id="L149">            setSearchHistoryFragment();</span>
<span class="nc" id="L150">            searchHistoryContainer.setVisibility(View.VISIBLE);</span>
        }
<span class="nc" id="L152">    }</span>

    private void saveRecentSearch(@NonNull final String query) {
<span class="nc" id="L155">        final RecentSearch recentSearch = recentSearchesDao.find(query);</span>
        // Newly searched query...
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (recentSearch == null) {</span>
<span class="nc" id="L158">            recentSearchesDao.save(new RecentSearch(null, query, new Date()));</span>
        } else {
<span class="nc" id="L160">            recentSearch.setLastSearched(new Date());</span>
<span class="nc" id="L161">            recentSearchesDao.save(recentSearch);</span>
        }
<span class="nc" id="L163">    }</span>

    /**
     * returns Media Object at position
     * @param i position of Media in the imagesRecyclerView adapter.
     */
    @Override
    public Media getMediaAtPosition(int i) {
<span class="nc" id="L171">        return searchMediaFragment.getMediaAtPosition(i);</span>
    }

    /**
     * returns total number of images present in the imagesRecyclerView adapter.
     */
    @Override
    public int getTotalMediaCount() {
<span class="nc" id="L179">       return searchMediaFragment.getTotalMediaCount();</span>
    }

    @Override
    public Integer getContributionStateAt(int position) {
<span class="nc" id="L184">        return null;</span>
    }

    /**
     * Reload media detail fragment once media is nominated
     *
     * @param index item position that has been nominated
     */
    @Override
    public void refreshNominatedMedia(int index) {
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (getSupportFragmentManager().getBackStackEntryCount() == 1) {</span>
<span class="nc" id="L195">            onBackPressed();</span>
<span class="nc" id="L196">            onMediaClicked(index);</span>
        }
<span class="nc" id="L198">    }</span>

    /**
     * This method is called on success of API call for image Search.
     * The viewpager will notified that number of items have changed.
     */
    @Override
    public void viewPagerNotifyDataSetChanged() {
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (mediaDetails!=null){</span>
<span class="nc" id="L207">            mediaDetails.notifyDataSetChanged();</span>
        }
<span class="nc" id="L209">    }</span>

    /**
     * Open media detail pager fragment on click of image in search results
     * @param index item index that should be opened
     */
    @Override
    public void onMediaClicked(int index) {
<span class="nc" id="L217">        ViewUtil.hideKeyboard(this.findViewById(R.id.searchBox));</span>
<span class="nc" id="L218">        tabLayout.setVisibility(View.GONE);</span>
<span class="nc" id="L219">        viewPager.setVisibility(View.GONE);</span>
<span class="nc" id="L220">        mediaContainer.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L221">        searchView.setVisibility(View.GONE);// to remove searchview when mediaDetails fragment open</span>
<span class="nc bnc" id="L222" title="All 4 branches missed.">        if (mediaDetails == null || !mediaDetails.isVisible()) {</span>
            // set isFeaturedImage true for featured images, to include author field on media detail
<span class="nc" id="L224">            mediaDetails = MediaDetailPagerFragment.newInstance(false, true);</span>
<span class="nc" id="L225">            supportFragmentManager</span>
<span class="nc" id="L226">                    .beginTransaction()</span>
<span class="nc" id="L227">                    .hide(supportFragmentManager.getFragments().get(supportFragmentManager.getBackStackEntryCount()))</span>
<span class="nc" id="L228">                    .add(R.id.mediaContainer, mediaDetails)</span>
<span class="nc" id="L229">                    .addToBackStack(null)</span>
<span class="nc" id="L230">                    .commit();</span>
            // Reason for using hide, add instead of replace is to maintain scroll position after
            // coming back to the search activity. See https://github.com/commons-app/apps-android-commons/issues/1631
            // https://stackoverflow.com/questions/11353075/how-can-i-maintain-fragment-state-when-added-to-the-back-stack/19022550#19022550
<span class="nc" id="L234">            supportFragmentManager.executePendingTransactions();</span>
        }
<span class="nc" id="L236">        mediaDetails.showImage(index);</span>
<span class="nc" id="L237">    }</span>

    /**
     * This method is called on Screen Rotation
     */
    @Override
    protected void onResume() {
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (supportFragmentManager.getBackStackEntryCount()==1){</span>
            //FIXME: Temporary fix for screen rotation inside media details. If we don't call onBackPressed then fragment stack is increasing every time.
            //FIXME: Similar issue like this https://github.com/commons-app/apps-android-commons/issues/894
            // This is called on screen rotation when user is inside media details. Ideally it should show Media Details but since we are not saving the state now. We are throwing the user to search screen otherwise the app was crashing.
            //
<span class="nc" id="L249">            onBackPressed();</span>
        }
<span class="nc" id="L251">        super.onResume();</span>
<span class="nc" id="L252">    }</span>

    /**
     * This method is called on backPressed of anyFragment in the activity.
     * If condition is called when mediaDetailFragment is opened.
     */
    @Override
    public void onBackPressed() {
        //Remove the backstack entry that gets added when share button is clicked
        //fixing:https://github.com/commons-app/apps-android-commons/issues/2296
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (getSupportFragmentManager().getBackStackEntryCount() == 2) {</span>
<span class="nc" id="L263">            supportFragmentManager</span>
<span class="nc" id="L264">                .beginTransaction()</span>
<span class="nc" id="L265">                .remove(mediaDetails)</span>
<span class="nc" id="L266">                .commit();</span>
<span class="nc" id="L267">            supportFragmentManager.popBackStack();</span>
<span class="nc" id="L268">            supportFragmentManager.executePendingTransactions();</span>
        }
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (getSupportFragmentManager().getBackStackEntryCount() == 1) {</span>
            // back to search so show search toolbar and hide navigation toolbar
<span class="nc" id="L272">            searchView.setVisibility(View.VISIBLE);//set the searchview</span>
<span class="nc" id="L273">            tabLayout.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L274">            viewPager.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L275">            mediaContainer.setVisibility(View.GONE);</span>
        } else {
<span class="nc" id="L277">            toolbar.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L279">        super.onBackPressed();</span>
<span class="nc" id="L280">    }</span>

    /**
     * This method is called on click of a recent search to update query in SearchView.
     * @param query Recent Search Query
     */
    public void updateText(String query) {
<span class="nc" id="L287">        searchView.setQuery(query, true);</span>
        // Clear focus of searchView now. searchView.clearFocus(); does not seem to work Check the below link for more details.
        // https://stackoverflow.com/questions/6117967/how-to-remove-focus-without-setting-focus-to-another-control/15481511
<span class="nc" id="L290">        viewPager.requestFocus();</span>
<span class="nc" id="L291">    }</span>

    @Override protected void onDestroy() {
<span class="nc" id="L294">        super.onDestroy();</span>
        //Dispose the disposables when the activity is destroyed
<span class="nc" id="L296">        compositeDisposable.dispose();</span>
<span class="nc" id="L297">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>