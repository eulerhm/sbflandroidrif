<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WikidataItemDetailsActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prodDebug</a> &gt; <a href="index.source.html" class="el_package">fr.free.nrw.commons.explore.depictions</a> &gt; <span class="el_source">WikidataItemDetailsActivity.java</span></div><h1>WikidataItemDetailsActivity.java</h1><pre class="source lang-java linenums">package fr.free.nrw.commons.explore.depictions;

import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.widget.FrameLayout;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.viewpager.widget.ViewPager;
import butterknife.BindView;
import butterknife.ButterKnife;
import com.google.android.material.snackbar.Snackbar;
import com.google.android.material.tabs.TabLayout;
import fr.free.nrw.commons.Media;
import fr.free.nrw.commons.R;
import fr.free.nrw.commons.Utils;
import fr.free.nrw.commons.ViewPagerAdapter;
import fr.free.nrw.commons.bookmarks.items.BookmarkItemsDao;
import fr.free.nrw.commons.category.CategoryImagesCallback;
import fr.free.nrw.commons.explore.depictions.child.ChildDepictionsFragment;
import fr.free.nrw.commons.explore.depictions.media.DepictedImagesFragment;
import fr.free.nrw.commons.explore.depictions.parent.ParentDepictionsFragment;
import fr.free.nrw.commons.media.MediaDetailPagerFragment;
import fr.free.nrw.commons.theme.BaseActivity;
import fr.free.nrw.commons.upload.structure.depictions.DepictModel;
import fr.free.nrw.commons.upload.structure.depictions.DepictedItem;
import fr.free.nrw.commons.wikidata.WikidataConstants;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.schedulers.Schedulers;
import java.util.ArrayList;
import java.util.List;
import javax.inject.Inject;

/**
 * Activity to show depiction media, parent classes and child classes of depicted items in Explore
 */
<span class="nc" id="L44">public class WikidataItemDetailsActivity extends BaseActivity implements MediaDetailPagerFragment.MediaDetailProvider,</span>
    CategoryImagesCallback {
    private FragmentManager supportFragmentManager;
    private DepictedImagesFragment depictionImagesListFragment;
    private MediaDetailPagerFragment mediaDetailPagerFragment;

    /**
     * Name of the depicted item
     * Ex: Rabbit
     */

    @Inject BookmarkItemsDao bookmarkItemsDao;
    private CompositeDisposable compositeDisposable;
    @Inject
    DepictModel depictModel;
    private String wikidataItemName;
    @BindView(R.id.mediaContainer)
    FrameLayout mediaContainer;
    @BindView(R.id.tab_layout)
    TabLayout tabLayout;
    @BindView(R.id.viewPager)
    ViewPager viewPager;
    @BindView(R.id.toolbar)
    Toolbar toolbar;

    ViewPagerAdapter viewPagerAdapter;
    private DepictedItem wikidataItem;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L74">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L75">        setContentView(R.layout.activity_wikidata_item_details);</span>
<span class="nc" id="L76">        ButterKnife.bind(this);</span>
<span class="nc" id="L77">        compositeDisposable = new CompositeDisposable();</span>
<span class="nc" id="L78">        supportFragmentManager = getSupportFragmentManager();</span>
<span class="nc" id="L79">        viewPagerAdapter = new ViewPagerAdapter(getSupportFragmentManager());</span>
<span class="nc" id="L80">        viewPager.setAdapter(viewPagerAdapter);</span>
<span class="nc" id="L81">        viewPager.setOffscreenPageLimit(2);</span>
<span class="nc" id="L82">        tabLayout.setupWithViewPager(viewPager);</span>

<span class="nc" id="L84">        final DepictedItem depictedItem = getIntent().getParcelableExtra(</span>
            WikidataConstants.BOOKMARKS_ITEMS);
<span class="nc" id="L86">        wikidataItem = depictedItem;</span>
<span class="nc" id="L87">        setSupportActionBar(toolbar);</span>
<span class="nc" id="L88">        getSupportActionBar().setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L89">        setTabs();</span>
<span class="nc" id="L90">        setPageTitle();</span>
<span class="nc" id="L91">    }</span>

    /**
     * Gets the passed wikidataItemName from the intents and displays it as the page title
     */
    private void setPageTitle() {
<span class="nc bnc" id="L97" title="All 4 branches missed.">        if (getIntent() != null &amp;&amp; getIntent().getStringExtra(&quot;wikidataItemName&quot;) != null) {</span>
<span class="nc" id="L98">            setTitle(getIntent().getStringExtra(&quot;wikidataItemName&quot;));</span>
        }
<span class="nc" id="L100">    }</span>

    /**
     * This method is called on success of API call for featured Images.
     * The viewpager will notified that number of items have changed.
     */
    @Override
    public void viewPagerNotifyDataSetChanged() {
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (mediaDetailPagerFragment !=null){</span>
<span class="nc" id="L109">            mediaDetailPagerFragment.notifyDataSetChanged();</span>
        }
<span class="nc" id="L111">    }</span>

    /**
     * This activity contains 3 tabs and a viewpager. This method is used to set the titles of tab,
     * Set the fragments according to the tab selected in the viewPager.
     */
    private void setTabs() {
<span class="nc" id="L118">        List&lt;Fragment&gt; fragmentList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L119">        List&lt;String&gt; titleList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L120">        depictionImagesListFragment = new DepictedImagesFragment();</span>
<span class="nc" id="L121">        ChildDepictionsFragment childDepictionsFragment = new ChildDepictionsFragment();</span>
<span class="nc" id="L122">        ParentDepictionsFragment parentDepictionsFragment = new ParentDepictionsFragment();</span>
<span class="nc" id="L123">        wikidataItemName = getIntent().getStringExtra(&quot;wikidataItemName&quot;);</span>
<span class="nc" id="L124">        String entityId = getIntent().getStringExtra(&quot;entityId&quot;);</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">        if (getIntent() != null &amp;&amp; wikidataItemName != null) {</span>
<span class="nc" id="L126">            Bundle arguments = new Bundle();</span>
<span class="nc" id="L127">            arguments.putString(&quot;wikidataItemName&quot;, wikidataItemName);</span>
<span class="nc" id="L128">            arguments.putString(&quot;entityId&quot;, entityId);</span>
<span class="nc" id="L129">            depictionImagesListFragment.setArguments(arguments);</span>
<span class="nc" id="L130">            parentDepictionsFragment.setArguments(arguments);</span>
<span class="nc" id="L131">            childDepictionsFragment.setArguments(arguments);</span>
        }
<span class="nc" id="L133">        fragmentList.add(depictionImagesListFragment);</span>
<span class="nc" id="L134">        titleList.add(getResources().getString(R.string.title_for_media));</span>
<span class="nc" id="L135">        fragmentList.add(childDepictionsFragment);</span>
<span class="nc" id="L136">        titleList.add(getResources().getString(R.string.title_for_child_classes));</span>
<span class="nc" id="L137">        fragmentList.add(parentDepictionsFragment);</span>
<span class="nc" id="L138">        titleList.add(getResources().getString(R.string.title_for_parent_classes));</span>
<span class="nc" id="L139">        viewPagerAdapter.setTabData(fragmentList, titleList);</span>
<span class="nc" id="L140">        viewPager.setOffscreenPageLimit(2);</span>
<span class="nc" id="L141">        viewPagerAdapter.notifyDataSetChanged();</span>

<span class="nc" id="L143">    }</span>


    /**
     * Shows media detail fragment when user clicks on any image in the list
     */
    @Override
    public void onMediaClicked(int position) {
<span class="nc" id="L151">        tabLayout.setVisibility(View.GONE);</span>
<span class="nc" id="L152">        viewPager.setVisibility(View.GONE);</span>
<span class="nc" id="L153">        mediaContainer.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">        if (mediaDetailPagerFragment == null || !mediaDetailPagerFragment.isVisible()) {</span>
            // set isFeaturedImage true for featured images, to include author field on media detail
<span class="nc" id="L156">            mediaDetailPagerFragment = MediaDetailPagerFragment.newInstance(false, true);</span>
<span class="nc" id="L157">            FragmentManager supportFragmentManager = getSupportFragmentManager();</span>
<span class="nc" id="L158">            supportFragmentManager</span>
<span class="nc" id="L159">                    .beginTransaction()</span>
<span class="nc" id="L160">                    .replace(R.id.mediaContainer, mediaDetailPagerFragment)</span>
<span class="nc" id="L161">                    .addToBackStack(null)</span>
<span class="nc" id="L162">                    .commit();</span>
<span class="nc" id="L163">            supportFragmentManager.executePendingTransactions();</span>
        }
<span class="nc" id="L165">        mediaDetailPagerFragment.showImage(position);</span>
<span class="nc" id="L166">    }</span>

    /**
     * This method is called mediaDetailPagerFragment. It returns the Media Object at that Index
     * @param i It is the index of which media object is to be returned which is same as
     *          current index of viewPager.
     * @return Media Object
     */
    @Override
    public Media getMediaAtPosition(int i) {
<span class="nc" id="L176">        return depictionImagesListFragment.getMediaAtPosition(i);</span>
    }

    /**
     * This method is called on backPressed of anyFragment in the activity.
     * If condition is called when mediaDetailFragment is opened.
     */
    @Override
    public void onBackPressed() {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (supportFragmentManager.getBackStackEntryCount() == 1){</span>
<span class="nc" id="L186">            tabLayout.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L187">            viewPager.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L188">            mediaContainer.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L190">        super.onBackPressed();</span>
<span class="nc" id="L191">    }</span>

    /**
     * This method is called on from getCount of MediaDetailPagerFragment
     * The viewpager will contain same number of media items as that of media elements in adapter.
     * @return Total Media count in the adapter
     */
    @Override
    public int getTotalMediaCount() {
<span class="nc" id="L200">        return depictionImagesListFragment.getTotalMediaCount();</span>
    }

    @Override
    public Integer getContributionStateAt(int position) {
<span class="nc" id="L205">        return null;</span>
    }

    /**
     * Reload media detail fragment once media is nominated
     *
     * @param index item position that has been nominated
     */
    @Override
    public void refreshNominatedMedia(int index) {
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (getSupportFragmentManager().getBackStackEntryCount() == 1) {</span>
<span class="nc" id="L216">            onBackPressed();</span>
<span class="nc" id="L217">            onMediaClicked(index);</span>
        }
<span class="nc" id="L219">    }</span>

    /**
     * Consumers should be simply using this method to use this activity.
     *
     * @param context      A Context of the application package implementing this class.
     * @param depictedItem Name of the depicts for displaying its details
     */
    public static void startYourself(Context context, DepictedItem depictedItem) {
<span class="nc" id="L228">        Intent intent = new Intent(context, WikidataItemDetailsActivity.class);</span>
<span class="nc" id="L229">        intent.putExtra(&quot;wikidataItemName&quot;, depictedItem.getName());</span>
<span class="nc" id="L230">        intent.putExtra(&quot;entityId&quot;, depictedItem.getId());</span>
<span class="nc" id="L231">        intent.putExtra(WikidataConstants.BOOKMARKS_ITEMS, depictedItem);</span>
<span class="nc" id="L232">        context.startActivity(intent);</span>
<span class="nc" id="L233">    }</span>

    /**
     * This function inflates the menu
     */
    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L240">        MenuInflater menuInflater=getMenuInflater();</span>
<span class="nc" id="L241">        menuInflater.inflate(R.menu.menu_wikidata_item,menu);</span>

<span class="nc" id="L243">        updateBookmarkState(menu.findItem(R.id.menu_bookmark_current_item));</span>

<span class="nc" id="L245">        return super.onCreateOptionsMenu(menu);</span>
    }

    /**
     * This method handles the logic on item select in toolbar menu
     * Currently only 1 choice is available to open Wikidata item details page in browser
     */
    @Override
    public boolean onOptionsItemSelected(MenuItem item) {

<span class="nc bnc" id="L255" title="All 4 branches missed.">        switch (item.getItemId()){</span>
            case R.id.browser_actions_menu_items:
<span class="nc" id="L257">                String entityId=getIntent().getStringExtra(&quot;entityId&quot;);</span>
<span class="nc" id="L258">                Uri uri = Uri.parse(&quot;https://www.wikidata.org/wiki/&quot; + entityId);</span>
<span class="nc" id="L259">                Utils.handleWebUrl(this, uri);</span>
<span class="nc" id="L260">                return true;</span>
            case R.id.menu_bookmark_current_item:

<span class="nc bnc" id="L263" title="All 2 branches missed.">                if(getIntent().getStringExtra(&quot;fragment&quot;) != null) {</span>
<span class="nc" id="L264">                    compositeDisposable.add(depictModel.getDepictions(</span>
<span class="nc" id="L265">                        getIntent().getStringExtra(&quot;entityId&quot;)</span>
<span class="nc" id="L266">                    ).subscribeOn(Schedulers.io())</span>
<span class="nc" id="L267">                     .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L268">                     .subscribe(depictedItems -&gt; {</span>
<span class="nc" id="L269">                         final boolean bookmarkExists = bookmarkItemsDao.updateBookmarkItem(</span>
<span class="nc" id="L270">                             depictedItems.get(0));</span>
                         final Snackbar snackbar
<span class="nc bnc" id="L272" title="All 2 branches missed.">                             = bookmarkExists ? Snackbar.make(findViewById(R.id.toolbar_layout),</span>
                             R.string.add_bookmark, Snackbar.LENGTH_LONG)
<span class="nc" id="L274">                             : Snackbar.make(findViewById(R.id.toolbar_layout),</span>
                                 R.string.remove_bookmark,
                                 Snackbar.LENGTH_LONG);

<span class="nc" id="L278">                         snackbar.show();</span>
<span class="nc" id="L279">                         updateBookmarkState(item);</span>
<span class="nc" id="L280">                     }));</span>

                } else {
<span class="nc" id="L283">                    final boolean bookmarkExists</span>
<span class="nc" id="L284">                        = bookmarkItemsDao.updateBookmarkItem(wikidataItem);</span>
                    final Snackbar snackbar
<span class="nc bnc" id="L286" title="All 2 branches missed.">                        = bookmarkExists ? Snackbar.make(findViewById(R.id.toolbar_layout),</span>
                        R.string.add_bookmark, Snackbar.LENGTH_LONG)
<span class="nc" id="L288">                        : Snackbar.make(findViewById(R.id.toolbar_layout), R.string.remove_bookmark,</span>
                            Snackbar.LENGTH_LONG);

<span class="nc" id="L291">                    snackbar.show();</span>
<span class="nc" id="L292">                    updateBookmarkState(item);</span>
                }
<span class="nc" id="L294">                return true;</span>
            case  android.R.id.home:
<span class="nc" id="L296">                onBackPressed();</span>
<span class="nc" id="L297">                return true;</span>
            default:
<span class="nc" id="L299">                return super.onOptionsItemSelected(item);</span>
        }
    }

    private void updateBookmarkState(final MenuItem item) {
        final boolean isBookmarked;
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if(getIntent().getStringExtra(&quot;fragment&quot;) != null) {</span>
<span class="nc" id="L306">            isBookmarked</span>
<span class="nc" id="L307">                = bookmarkItemsDao.findBookmarkItem(getIntent().getStringExtra(&quot;entityId&quot;));</span>
        } else {
<span class="nc" id="L309">            isBookmarked = bookmarkItemsDao.findBookmarkItem(wikidataItem.getId());</span>
        }
        final int icon
<span class="nc bnc" id="L312" title="All 2 branches missed.">            = isBookmarked ? R.drawable.menu_ic_round_star_filled_24px</span>
<span class="nc" id="L313">            : R.drawable.menu_ic_round_star_border_24px;</span>
<span class="nc" id="L314">        item.setIcon(icon);</span>
<span class="nc" id="L315">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.0.2</div></body></html>