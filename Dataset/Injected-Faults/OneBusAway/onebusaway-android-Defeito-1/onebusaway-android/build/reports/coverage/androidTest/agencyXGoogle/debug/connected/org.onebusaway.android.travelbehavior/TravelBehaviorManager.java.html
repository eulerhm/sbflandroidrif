<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TravelBehaviorManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.travelbehavior</a> &gt; <span class="el_source">TravelBehaviorManager.java</span></div><h1>TravelBehaviorManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2019 University of South Florida
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.travelbehavior;

import android.app.AlertDialog;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.graphics.drawable.Drawable;
import android.os.Build;
import android.text.Html;
import android.text.TextUtils;
import android.util.Log;
import android.util.Patterns;
import android.view.LayoutInflater;
import android.view.View;
import android.widget.CheckBox;
import android.widget.EditText;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.drawable.DrawableCompat;
import androidx.work.Constraints;
import androidx.work.Data;
import androidx.work.NetworkType;
import androidx.work.OneTimeWorkRequest;
import androidx.work.WorkInfo;
import androidx.work.WorkManager;

import com.google.android.gms.location.ActivityRecognition;
import com.google.android.gms.location.ActivityTransition;
import com.google.android.gms.location.ActivityTransitionRequest;
import com.google.android.gms.location.DetectedActivity;
import com.google.android.gms.tasks.Task;
import com.google.common.util.concurrent.FutureCallback;
import com.google.common.util.concurrent.Futures;
import com.google.common.util.concurrent.ListenableFuture;
import com.google.firebase.analytics.FirebaseAnalytics;

import org.checkerframework.checker.nullness.compatqual.NullableDecl;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.elements.ObaArrivalInfo;
import org.onebusaway.android.travelbehavior.constants.TravelBehaviorConstants;
import org.onebusaway.android.travelbehavior.io.TravelBehaviorFileSaverExecutorManager;
import org.onebusaway.android.travelbehavior.io.task.ArrivalAndDepartureDataSaverTask;
import org.onebusaway.android.travelbehavior.io.task.DestinationReminderDataSaverTask;
import org.onebusaway.android.travelbehavior.io.task.TripPlanDataSaverTask;
import org.onebusaway.android.travelbehavior.io.worker.OptOutTravelBehaviorParticipantWorker;
import org.onebusaway.android.travelbehavior.io.worker.RegisterTravelBehaviorParticipantWorker;
import org.onebusaway.android.travelbehavior.io.worker.UpdateDeviceInfoWorker;
import org.onebusaway.android.travelbehavior.receiver.TransitionBroadcastReceiver;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorFirebaseIOUtils;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorUtils;
import org.onebusaway.android.ui.HomeActivity;
import org.onebusaway.android.util.PermissionUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.opentripplanner.api.model.TripPlan;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;

public class TravelBehaviorManager {

    private static final String TAG = &quot;TravelBehaviorManager&quot;;

    private Context mActivityContext;

    private Context mApplicationContext;

    private FirebaseAnalytics mFirebaseAnalytics;

<span class="nc" id="L90">    public TravelBehaviorManager(Context activityContext, Context applicationContext) {</span>
<span class="nc" id="L91">        mActivityContext = activityContext;</span>
<span class="nc" id="L92">        mApplicationContext = applicationContext;</span>
<span class="nc" id="L93">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(activityContext);</span>
<span class="nc" id="L94">    }</span>

    public void registerTravelBehaviorParticipant() {
<span class="nc" id="L97">        registerTravelBehaviorParticipant(false);</span>
<span class="nc" id="L98">    }</span>

    public void registerTravelBehaviorParticipant(boolean forceStart) {
        // Do not register if enrolling is no more allowed;
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (!TravelBehaviorUtils.allowEnrollMoreParticipantsInStudy()) {</span>
<span class="nc" id="L103">            return;</span>
        }

<span class="nc" id="L106">        boolean isUserOptOut = PreferenceUtils.getBoolean(TravelBehaviorConstants.USER_OPT_OUT,</span>
                false);
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (forceStart) isUserOptOut = false;</span>
        // If user opt out or Global switch is off then do nothing
<span class="nc bnc" id="L110" title="All 4 branches missed.">        if (!TravelBehaviorUtils.isTravelBehaviorActiveInRegion() || isUserOptOut) {</span>
<span class="nc" id="L111">            stopCollectingData();</span>
<span class="nc" id="L112">            return;</span>
        }

<span class="nc" id="L115">        boolean isUserOptIn = PreferenceUtils.getBoolean(TravelBehaviorConstants.USER_OPT_IN,</span>
                false);

        // If the user not opt in yet
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!isUserOptIn) {</span>
<span class="nc" id="L120">            showParticipationDialog();</span>
        }
<span class="nc" id="L122">    }</span>

    private void showParticipationDialog() {
<span class="nc" id="L125">        View v = LayoutInflater.from(mActivityContext).inflate(R.layout.research_participation_dialog, null);</span>
<span class="nc" id="L126">        CheckBox neverShowDialog = v.findViewById(R.id.research_never_ask_again);</span>

<span class="nc" id="L128">        new AlertDialog.Builder(mActivityContext)</span>
<span class="nc" id="L129">                .setView(v)</span>
<span class="nc" id="L130">                .setTitle(R.string.travel_behavior_opt_in_title)</span>
<span class="nc" id="L131">                .setIcon(createIcon())</span>
<span class="nc" id="L132">                .setCancelable(false)</span>
<span class="nc" id="L133">                .setPositiveButton(R.string.travel_behavior_dialog_learn_more,</span>
<span class="nc" id="L134">                        (dialog, which) -&gt; showAgeDialog())</span>
<span class="nc" id="L135">                .setNegativeButton(R.string.travel_behavior_dialog_not_now,</span>
                        (dialog, which) -&gt; {
                            // If the user has chosen not to see the dialog again opt them out of the study, otherwise do nothing so they are prompted again later
<span class="nc bnc" id="L138" title="All 2 branches missed.">                            if (neverShowDialog.isChecked()) {</span>
<span class="nc" id="L139">                                optOutUser();</span>
<span class="nc" id="L140">                                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L141">                                        mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_out_at_first_dialog),</span>
                                        null);
                            } else {
<span class="nc" id="L144">                                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L145">                                        mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_enroll_not_now),</span>
                                        null);
                            }
<span class="nc" id="L148">                        })</span>
<span class="nc" id="L149">                .create().show();</span>
<span class="nc" id="L150">    }</span>

    private void showAgeDialog() {
<span class="nc" id="L153">        new AlertDialog.Builder(mActivityContext)</span>
<span class="nc" id="L154">                .setMessage(R.string.travel_behavior_age_message)</span>
<span class="nc" id="L155">                .setTitle(R.string.travel_behavior_opt_in_title)</span>
<span class="nc" id="L156">                .setIcon(createIcon())</span>
<span class="nc" id="L157">                .setCancelable(false)</span>
<span class="nc" id="L158">                .setPositiveButton(R.string.travel_behavior_dialog_yes,</span>
                        (dialog, which) -&gt; {
<span class="nc" id="L160">                            showInformedConsent();</span>
<span class="nc" id="L161">                            dialog.dismiss();</span>
<span class="nc" id="L162">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L163">                                    mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_in_over_18),</span>
                                    null);
<span class="nc" id="L165">                        })</span>
<span class="nc" id="L166">                .setNegativeButton(R.string.travel_behavior_dialog_no,</span>
                        (dialog, which) -&gt; {
<span class="nc" id="L168">                            Toast.makeText(mApplicationContext,</span>
<span class="nc" id="L169">                                    R.string.travel_behavior_age_invalid_message, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L170">                            optOutUser();</span>
<span class="nc" id="L171">                            dialog.dismiss();</span>
<span class="nc" id="L172">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L173">                                    mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_out_under_18),</span>
                                    null);
<span class="nc" id="L175">                        })</span>
<span class="nc" id="L176">                .create().show();</span>
<span class="nc" id="L177">    }</span>

    private void showInformedConsent() {
<span class="nc" id="L180">        String consentHtml = getHtmlConsentDocument();</span>
<span class="nc" id="L181">        new AlertDialog.Builder(mActivityContext)</span>
<span class="nc" id="L182">                .setMessage(Html.fromHtml(consentHtml))</span>
<span class="nc" id="L183">                .setTitle(R.string.travel_behavior_opt_in_title)</span>
<span class="nc" id="L184">                .setIcon(createIcon())</span>
<span class="nc" id="L185">                .setCancelable(false)</span>
<span class="nc" id="L186">                .setPositiveButton(R.string.travel_behavior_dialog_consent_agree,</span>
                        (dialog, which) -&gt; {
<span class="nc" id="L188">                            showEmailDialog();</span>
<span class="nc" id="L189">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L190">                                    mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_in_informed_consent),</span>
                                    null);
<span class="nc" id="L192">                        })</span>
<span class="nc" id="L193">                .setNegativeButton(R.string.travel_behavior_dialog_consent_disagree,</span>
                        (dialog, which) -&gt; {
<span class="nc" id="L195">                            optOutUser();</span>
<span class="nc" id="L196">                            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L197">                                    mApplicationContext.getString(R.string.analytics_label_button_travel_behavior_opt_out_informed_consent),</span>
                                    null);
<span class="nc" id="L199">                        })</span>
<span class="nc" id="L200">                .create().show();</span>
<span class="nc" id="L201">    }</span>

    private String getHtmlConsentDocument() {
<span class="nc" id="L204">        InputStream inputStream = mApplicationContext.getResources().</span>
<span class="nc" id="L205">                openRawResource(R.raw.travel_behavior_informed_consent);</span>
<span class="nc" id="L206">        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span>

<span class="nc" id="L208">        byte[] buf = new byte[1024];</span>
        int len;
        try {
<span class="nc bnc" id="L211" title="All 2 branches missed.">            while ((len = inputStream.read(buf)) != -1) {</span>
<span class="nc" id="L212">                outputStream.write(buf, 0, len);</span>
            }
<span class="nc" id="L214">            outputStream.close();</span>
<span class="nc" id="L215">            inputStream.close();</span>
<span class="nc" id="L216">        } catch (IOException e) {</span>
<span class="nc" id="L217">            e.printStackTrace();</span>
<span class="nc" id="L218">        }</span>
<span class="nc" id="L219">        return outputStream.toString();</span>
    }

    private void showEmailDialog() {
<span class="nc" id="L223">        showEmailDialog(null);</span>
<span class="nc" id="L224">    }</span>

    private void showEmailDialog(String email) {
<span class="nc" id="L227">        LayoutInflater inflater = ((AppCompatActivity) mActivityContext).getLayoutInflater();</span>
<span class="nc" id="L228">        final View editTextView = inflater.inflate(R.layout.travel_behavior_email_dialog, null);</span>
<span class="nc" id="L229">        EditText emailEditText = editTextView.findViewById(R.id.tb_email_edittext);</span>
<span class="nc" id="L230">        EditText emailEditTextConfirm = editTextView.findViewById(R.id.tb_email_edittext_confirm);</span>

<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (email != null) {</span>
<span class="nc" id="L233">            emailEditText.setText(email);</span>
        }

<span class="nc" id="L236">        new AlertDialog.Builder(mActivityContext)</span>
<span class="nc" id="L237">                .setTitle(R.string.travel_behavior_opt_in_title)</span>
<span class="nc" id="L238">                .setMessage(R.string.travel_behavior_email_message)</span>
<span class="nc" id="L239">                .setIcon(createIcon())</span>
<span class="nc" id="L240">                .setCancelable(false)</span>
<span class="nc" id="L241">                .setView(editTextView)</span>
<span class="nc" id="L242">                .setPositiveButton(R.string.travel_behavior_dialog_email_save,</span>
                        (dialog, which) -&gt; {
<span class="nc" id="L244">                            String currentEmail = emailEditText.getText().toString();</span>
<span class="nc" id="L245">                            String currentEmailConfirm = emailEditTextConfirm.getText().toString();</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">                            if (!TextUtils.isEmpty(currentEmail) &amp;&amp;</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                                    Patterns.EMAIL_ADDRESS.matcher(currentEmail).matches() &amp;&amp;</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                                    currentEmail.equalsIgnoreCase(currentEmailConfirm)) {</span>
<span class="nc" id="L249">                                registerUser(currentEmail);</span>
<span class="nc" id="L250">                                checkPermissions();</span>
                            } else {
<span class="nc" id="L252">                                Toast.makeText(mApplicationContext, R.string.travel_behavior_email_invalid,</span>
<span class="nc" id="L253">                                        Toast.LENGTH_LONG).show();</span>
                                // Android automatically dismisses the dialog.
                                // Show the dialog again if the email is invalid
<span class="nc" id="L256">                                showEmailDialog(currentEmail);</span>
                            }
<span class="nc" id="L258">                        })</span>
<span class="nc" id="L259">                .create().show();</span>
<span class="nc" id="L260">    }</span>

    private void checkPermissions() {
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (!PermissionUtils.hasGrantedAllPermissions(mApplicationContext, TravelBehaviorConstants.PERMISSIONS)) {</span>
<span class="nc" id="L264">            HomeActivity homeActivity = (HomeActivity) mActivityContext;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {</span>
                // When targeting Android 11 and up, BACKGROUND_LOCATION and ACTIVITY_RECOGNITION_PERMISSION must be requested independently of all other permissions
                // Request activity permission here, and then background location the subsequent callback set up in HomeActivity
<span class="nc" id="L268">                homeActivity.requestPhysicalActivityPermission();</span>
            }
        }
<span class="nc" id="L271">    }</span>

    private void registerUser(String email) {
<span class="nc" id="L274">        Data myData = new Data.Builder()</span>
<span class="nc" id="L275">                .putString(TravelBehaviorConstants.USER_EMAIL, email)</span>
<span class="nc" id="L276">                .build();</span>

<span class="nc" id="L278">        Constraints constraints = new Constraints.Builder()</span>
<span class="nc" id="L279">                .setRequiredNetworkType(NetworkType.CONNECTED)</span>
<span class="nc" id="L280">                .build();</span>

<span class="nc" id="L282">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.</span>
                Builder(RegisterTravelBehaviorParticipantWorker.class)
<span class="nc" id="L284">                .setInputData(myData)</span>
<span class="nc" id="L285">                .setConstraints(constraints)</span>
<span class="nc" id="L286">                .build();</span>

<span class="nc" id="L288">        WorkManager workManager = WorkManager.getInstance();</span>
<span class="nc" id="L289">        workManager.enqueue(workRequest);</span>
<span class="nc" id="L290">        ListenableFuture&lt;WorkInfo&gt; listenableFuture = workManager.</span>
<span class="nc" id="L291">                getWorkInfoById(workRequest.getId());</span>
<span class="nc" id="L292">        Futures.addCallback(listenableFuture, new FutureCallback&lt;WorkInfo&gt;() {</span>
            @Override
            public void onSuccess(@NullableDecl WorkInfo result) {
<span class="nc" id="L295">                AppCompatActivity activity = (AppCompatActivity) mActivityContext;</span>
<span class="nc" id="L296">                activity.runOnUiThread(() -&gt; Toast.makeText(mApplicationContext, R.string.travel_behavior_enroll_success,</span>
<span class="nc" id="L297">                        Toast.LENGTH_LONG).show());</span>
<span class="nc" id="L298">            }</span>

            @Override
            public void onFailure(Throwable t) {
<span class="nc" id="L302">                AppCompatActivity activity = (AppCompatActivity) mActivityContext;</span>
<span class="nc" id="L303">                activity.runOnUiThread(() -&gt; Toast.makeText(mApplicationContext, R.string.travel_behavior_enroll_fail,</span>
<span class="nc" id="L304">                        Toast.LENGTH_LONG).show());</span>
<span class="nc" id="L305">            }</span>
<span class="nc" id="L306">        }, TravelBehaviorFileSaverExecutorManager.getInstance().getThreadPoolExecutor());</span>
<span class="nc" id="L307">    }</span>

    public static void startCollectingData(Context applicationContext) {
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">        if (TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc" id="L311">            new TravelBehaviorManager(null, applicationContext).startCollectingData();</span>
        }
<span class="fc" id="L313">    }</span>

    private void startCollectingData() {
<span class="nc" id="L316">        int[] activities = {DetectedActivity.IN_VEHICLE,</span>
                DetectedActivity.ON_BICYCLE, DetectedActivity.WALKING,
                DetectedActivity.STILL, DetectedActivity.RUNNING};

<span class="nc" id="L320">        List&lt;ActivityTransition&gt; transitions = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L322" title="All 2 branches missed.">        for (int activity : activities) {</span>
<span class="nc" id="L323">            transitions.add(new ActivityTransition.Builder()</span>
<span class="nc" id="L324">                    .setActivityType(activity)</span>
<span class="nc" id="L325">                    .setActivityTransition(ActivityTransition.ACTIVITY_TRANSITION_ENTER)</span>
<span class="nc" id="L326">                    .build());</span>

<span class="nc" id="L328">            transitions.add(new ActivityTransition.Builder()</span>
<span class="nc" id="L329">                    .setActivityType(activity)</span>
<span class="nc" id="L330">                    .setActivityTransition(ActivityTransition.ACTIVITY_TRANSITION_EXIT)</span>
<span class="nc" id="L331">                    .build());</span>
        }

<span class="nc" id="L334">        ActivityTransitionRequest atr = new ActivityTransitionRequest(transitions);</span>
<span class="nc" id="L335">        Intent intent = new Intent(mApplicationContext, TransitionBroadcastReceiver.class);</span>
        // If pending intent is already created do not create a new one

//        PendingIntent pi = PendingIntent.getBroadcast(mApplicationContext, 100, intent,
//                PendingIntent.FLAG_NO_CREATE);

        // The above method returns null if the pending intent is not active
        // it returns the pending intent object if the pending intent is alive
        // --&gt; The idea is here that if the pending intent is alive (i.e., pi object is not null)
        // then do not create a new object
        // However, every time the above method is called, the application stops receiving
        // activity transitions
        // TODO: figure out the problem described above

        int flags;
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S) {</span>
<span class="nc" id="L351">            flags = PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_MUTABLE;</span>
        } else {
<span class="nc" id="L353">            flags = PendingIntent.FLAG_UPDATE_CURRENT;</span>
        }
<span class="nc" id="L355">        PendingIntent pi = PendingIntent.getBroadcast(mApplicationContext, 100,</span>
                intent, flags);
<span class="nc" id="L357">        Task&lt;Void&gt; task = ActivityRecognition.getClient(mApplicationContext)</span>
<span class="nc" id="L358">                .requestActivityTransitionUpdates(atr, pi);</span>
<span class="nc" id="L359">        task.addOnCompleteListener(task1 -&gt; {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (task1.isSuccessful()) {</span>
<span class="nc" id="L361">                Log.d(TAG, &quot;Travel behavior activity-transition-update set up&quot;);</span>
            } else {

<span class="nc" id="L364">                TravelBehaviorFirebaseIOUtils.logErrorMessage(task1.getException(),</span>
                        &quot;Travel behavior activity-transition-update failed set up: &quot;);
            }
<span class="nc" id="L367">        });</span>

<span class="nc" id="L369">        saveDeviceInformation();</span>
<span class="nc" id="L370">    }</span>

    private void saveDeviceInformation() {
<span class="nc" id="L373">        String uid = PreferenceUtils.getString(TravelBehaviorConstants.USER_ID);</span>
<span class="nc" id="L374">        Data myData = new Data.Builder()</span>
<span class="nc" id="L375">                .putString(TravelBehaviorConstants.USER_ID, uid)</span>
<span class="nc" id="L376">                .build();</span>

<span class="nc" id="L378">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.Builder(</span>
                UpdateDeviceInfoWorker.class)
<span class="nc" id="L380">                .setInputData(myData)</span>
<span class="nc" id="L381">                .build();</span>
<span class="nc" id="L382">        WorkManager.getInstance().enqueue(workRequest);</span>
<span class="nc" id="L383">    }</span>

    public void stopCollectingData() {
<span class="nc" id="L386">        Intent intent = new Intent(mApplicationContext, TransitionBroadcastReceiver.class);</span>
        int flags;
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S) {</span>
<span class="nc" id="L389">            flags = PendingIntent.FLAG_NO_CREATE | PendingIntent.FLAG_MUTABLE;</span>
        } else {
<span class="nc" id="L391">            flags = PendingIntent.FLAG_NO_CREATE;</span>
        }
<span class="nc" id="L393">        PendingIntent pi = PendingIntent.getBroadcast(mApplicationContext, 100, intent,</span>
                flags);
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (pi != null) {</span>
<span class="nc" id="L396">            ActivityRecognition.getClient(mApplicationContext).removeActivityUpdates(pi);</span>
<span class="nc" id="L397">            pi.cancel();</span>
        }
<span class="nc" id="L399">    }</span>

    private Drawable createIcon() {
<span class="nc" id="L402">        Drawable icon = mApplicationContext.getResources().getDrawable(R.drawable.ic_light_bulb);</span>
<span class="nc" id="L403">        DrawableCompat.setTint(icon, mApplicationContext.getResources().getColor(R.color.theme_primary));</span>
<span class="nc" id="L404">        return icon;</span>
    }

    public static void optOutUser() {
<span class="nc" id="L408">        PreferenceUtils.saveBoolean(TravelBehaviorConstants.USER_OPT_OUT, true);</span>
<span class="nc" id="L409">        PreferenceUtils.saveBoolean(TravelBehaviorConstants.USER_OPT_IN, false);</span>
<span class="nc" id="L410">    }</span>

    public static void optOutUserOnServer() {
<span class="nc" id="L413">        String uid = PreferenceUtils.getString(TravelBehaviorConstants.USER_ID);</span>
<span class="nc" id="L414">        Data myData = new Data.Builder()</span>
<span class="nc" id="L415">                .putString(TravelBehaviorConstants.USER_ID, uid)</span>
<span class="nc" id="L416">                .build();</span>

<span class="nc" id="L418">        OneTimeWorkRequest workRequest = new OneTimeWorkRequest.Builder(</span>
                OptOutTravelBehaviorParticipantWorker.class)
<span class="nc" id="L420">                .setInputData(myData)</span>
<span class="nc" id="L421">                .build();</span>
<span class="nc" id="L422">        WorkManager.getInstance().enqueue(workRequest);</span>
<span class="nc" id="L423">    }</span>

    public static void optInUser(String uid) {
<span class="nc" id="L426">        PreferenceUtils.saveString(TravelBehaviorConstants.USER_ID, uid);</span>
<span class="nc" id="L427">        PreferenceUtils.saveBoolean(TravelBehaviorConstants.USER_OPT_IN, true);</span>
<span class="nc" id="L428">        PreferenceUtils.saveBoolean(TravelBehaviorConstants.USER_OPT_OUT, false);</span>
<span class="nc" id="L429">    }</span>

    public static void saveDestinationReminders(String currStopId, String destStopId, String tripId,
                                                String routeId, Long serverTime) {
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc" id="L434">            DestinationReminderDataSaverTask saverTask = new DestinationReminderDataSaverTask(currStopId,</span>
<span class="nc" id="L435">                    destStopId, tripId, routeId, serverTime, Application.get().getApplicationContext());</span>
<span class="nc" id="L436">            TravelBehaviorFileSaverExecutorManager manager = TravelBehaviorFileSaverExecutorManager.getInstance();</span>
<span class="nc" id="L437">            manager.runTask(saverTask);</span>
        }
<span class="nc" id="L439">    }</span>

    public static void saveArrivalInfo(ObaArrivalInfo[] info, String url, long serverTime, String stopId) {
<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc" id="L443">            ArrivalAndDepartureDataSaverTask saverTask = new ArrivalAndDepartureDataSaverTask(info,</span>
<span class="nc" id="L444">                    serverTime, url, stopId, Application.get().getApplicationContext());</span>
<span class="nc" id="L445">            TravelBehaviorFileSaverExecutorManager manager = TravelBehaviorFileSaverExecutorManager.getInstance();</span>
<span class="nc" id="L446">            manager.runTask(saverTask);</span>
        }
<span class="nc" id="L448">    }</span>

    public static void saveTripPlan(TripPlan tripPlan, String url, Context applicationContext) {
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc" id="L452">            TripPlanDataSaverTask dataSaverTask = new TripPlanDataSaverTask(tripPlan, url,</span>
                    applicationContext);
            TravelBehaviorFileSaverExecutorManager executorManager =
<span class="nc" id="L455">                    TravelBehaviorFileSaverExecutorManager.getInstance();</span>
<span class="nc" id="L456">            executorManager.runTask(dataSaverTask);</span>
        }
<span class="nc" id="L458">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>