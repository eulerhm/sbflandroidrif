<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TripDetailsListFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">TripDetailsListFragment.java</span></div><h1>TripDetailsListFragment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2012-2015 Paul Watts (paulcwatts@gmail.com), University of South Florida,
 * Benjamin Du (bendu@me.com), and individual contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.Dialog;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.IntentSender;
import android.content.SharedPreferences;
import android.content.res.ColorStateList;
import android.graphics.Color;
import android.graphics.Paint;
import android.graphics.PorterDuff;
import android.graphics.drawable.Drawable;
import android.graphics.drawable.GradientDrawable;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.provider.Settings;
import android.text.TextUtils;
import android.text.format.DateUtils;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.BaseAdapter;
import android.widget.CheckBox;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import androidx.core.graphics.drawable.DrawableCompat;
import androidx.loader.app.LoaderManager;
import androidx.loader.content.AsyncTaskLoader;
import androidx.loader.content.Loader;

import com.google.android.gms.common.api.ApiException;
import com.google.android.gms.common.api.ResolvableApiException;
import com.google.android.gms.location.LocationRequest;
import com.google.android.gms.location.LocationServices;
import com.google.android.gms.location.LocationSettingsRequest;
import com.google.android.gms.location.LocationSettingsResponse;
import com.google.android.gms.location.LocationSettingsStatusCodes;
import com.google.android.gms.tasks.OnCompleteListener;
import com.google.android.gms.tasks.Task;
import com.google.firebase.analytics.FirebaseAnalytics;

import org.apache.commons.lang3.StringUtils;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.elements.ObaReferences;
import org.onebusaway.android.io.elements.ObaRoute;
import org.onebusaway.android.io.elements.ObaStop;
import org.onebusaway.android.io.elements.ObaTrip;
import org.onebusaway.android.io.elements.ObaTripSchedule;
import org.onebusaway.android.io.elements.ObaTripStatus;
import org.onebusaway.android.io.elements.OccupancyState;
import org.onebusaway.android.io.elements.Status;
import org.onebusaway.android.io.request.ObaTripDetailsRequest;
import org.onebusaway.android.io.request.ObaTripDetailsResponse;
import org.onebusaway.android.nav.NavigationService;
import org.onebusaway.android.travelbehavior.TravelBehaviorManager;
import org.onebusaway.android.util.ArrivalInfoUtils;
import org.onebusaway.android.util.DBUtil;
import org.onebusaway.android.util.LocationUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.onebusaway.android.util.UIUtils;

import java.util.Calendar;
import java.util.GregorianCalendar;
import java.util.concurrent.TimeUnit;

<span class="nc" id="L99">public class TripDetailsListFragment extends ListFragment {</span>

    public static final String TAG = &quot;TripDetailsListFragment&quot;;

    public static final String TRIP_ID = &quot;.TripId&quot;;

    public static final String STOP_ID = &quot;.StopId&quot;;

    public static final String ROUTE_ID = &quot;.RouteId&quot;;

    public static final String SCROLL_MODE = &quot;.ScrollMode&quot;;

    public static final String SCROLL_MODE_VEHICLE = &quot;vehicle&quot;;

    public static final String SCROLL_MODE_STOP = &quot;stop&quot;;

    public static final String TRIP_ACTIVE = &quot;.TripActive&quot;;

    public static final String DEST_ID = &quot;.DestinationId&quot;;

    public static final String ACTION_SERVICE_DESTROYED = &quot;NavigationServiceDestroyed&quot;;

    private static final long REFRESH_PERIOD = 60 * 1000;

    private static final int TRIP_DETAILS_LOADER = 0;

    public static final int REQUEST_ENABLE_LOCATION = 1;

    private String mTripId;

    private String mRouteId;

    private String mStopId;

    private String mScrollMode;

    private String mDestinationId;

    private Integer mStopIndex;

    private Integer mDestinationIndex;

    private boolean mActiveTrip;

    private ObaTripDetailsResponse mTripInfo;

    private TripDetailsAdapter mAdapter;

<span class="nc" id="L147">    private final TripDetailsLoaderCallback mTripDetailsCallback = new TripDetailsLoaderCallback();</span>

    private LocationRequest mLocationRequest;
    private Task&lt;LocationSettingsResponse&gt; mResult;

    private FirebaseAnalytics mFirebaseAnalytics;

    /**
     * Builds an intent used to set the trip and stop for the TripDetailsListFragment directly
     * (i.e., when TripDetailsActivity is not used)
     */
    public static class IntentBuilder {

        private Intent mIntent;

<span class="nc" id="L162">        public IntentBuilder(Context context, String tripId) {</span>
<span class="nc" id="L163">            mIntent = new Intent(context, TripDetailsListFragment.class);</span>
<span class="nc" id="L164">            mIntent.putExtra(TripDetailsListFragment.TRIP_ID, tripId);</span>
<span class="nc" id="L165">        }</span>

        public IntentBuilder setStopId(String stopId) {
<span class="nc" id="L168">            mIntent.putExtra(TripDetailsListFragment.STOP_ID, stopId);</span>
<span class="nc" id="L169">            return this;</span>
        }

        public Intent build() {
<span class="nc" id="L173">            return mIntent;</span>
        }
    }

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L179">        super.onActivityCreated(savedInstanceState);</span>

        // Start out with a progress indicator.
<span class="nc" id="L182">        setListShown(false);</span>

        // We have a menu item to show in action bar.
<span class="nc" id="L185">        setHasOptionsMenu(true);</span>

<span class="nc" id="L187">        getListView().setOnItemClickListener(mClickListener);</span>
<span class="nc" id="L188">        getListView().setOnItemLongClickListener(mLongClickListener);</span>

        // Get saved routeId if it exists - avoids potential NPE in onOptionsItemSelected() (#515)
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L192">            mRouteId = savedInstanceState.getString(ROUTE_ID);</span>
        }

<span class="nc" id="L195">        Bundle args = getArguments();</span>
<span class="nc" id="L196">        mTripId = args.getString(TRIP_ID);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (mTripId == null) {</span>
<span class="nc" id="L198">            Log.e(TAG, &quot;TripId is null&quot;);</span>
<span class="nc" id="L199">            throw new RuntimeException(&quot;TripId should not be null&quot;);</span>
        }

<span class="nc" id="L202">        mStopId = args.getString(STOP_ID);</span>

<span class="nc" id="L204">        mScrollMode = args.getString(SCROLL_MODE);</span>

<span class="nc" id="L206">        mActiveTrip = args.getBoolean(TRIP_ACTIVE);</span>

<span class="nc" id="L208">        mDestinationId = args.getString(DEST_ID);</span>

<span class="nc" id="L210">        getLoaderManager().initLoader(TRIP_DETAILS_LOADER, null, mTripDetailsCallback);</span>
<span class="nc" id="L211">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater,
                             ViewGroup root, Bundle savedInstanceState) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (root == null) {</span>
            // Currently in a layout without a container, so no
            // reason to create our view.
<span class="nc" id="L219">            return null;</span>
        }
<span class="nc" id="L221">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(getActivity());</span>
<span class="nc" id="L222">        return inflater.inflate(R.layout.trip_details, null);</span>
    }

    @Override
    public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L227">        super.onSaveInstanceState(outState);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (mRouteId != null) {</span>
<span class="nc" id="L229">            outState.putString(ROUTE_ID, mRouteId);</span>
        }
<span class="nc" id="L231">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L235">        mRefreshHandler.removeCallbacks(mRefresh);</span>
<span class="nc" id="L236">        super.onPause();</span>
<span class="nc" id="L237">    }</span>

    @Override
    public void onResume() {
        // Try to show any old data just in case we're coming out of sleep
<span class="nc" id="L242">        TripDetailsLoader loader = getTripDetailsLoader();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (loader != null) {</span>
<span class="nc" id="L244">            ObaTripDetailsResponse lastGood = loader.getLastGoodResponse();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (lastGood != null) {</span>
<span class="nc" id="L246">                setTripDetails(lastGood);</span>
            }
        }

<span class="nc" id="L250">        getLoaderManager().restartLoader(TRIP_DETAILS_LOADER, null, mTripDetailsCallback);</span>

        // If our timer would have gone off, then refresh.
<span class="nc" id="L253">        long lastResponseTime = getTripDetailsLoader().getLastResponseTime();</span>
<span class="nc" id="L254">        long newPeriod = Math.min(REFRESH_PERIOD, (lastResponseTime + REFRESH_PERIOD)</span>
<span class="nc" id="L255">                - System.currentTimeMillis());</span>
        // Wait at least one second at least, and the full minute at most.
        //Log.d(TAG, &quot;Refresh period:&quot; + newPeriod);
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (newPeriod &lt;= 0) {</span>
<span class="nc" id="L259">            refresh();</span>
        } else {
<span class="nc" id="L261">            mRefreshHandler.postDelayed(mRefresh, newPeriod);</span>
        }

<span class="nc" id="L264">        super.onResume();</span>
<span class="nc" id="L265">    }</span>

    //
    // Action Bar / Options Menu
    //
    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span class="nc" id="L272">        inflater.inflate(R.menu.trip_details, menu);</span>
<span class="nc" id="L273">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc" id="L277">        final int id = item.getItemId();</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (id == R.id.refresh) {</span>
<span class="nc" id="L279">            refresh();</span>
<span class="nc" id="L280">            return true;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        } else if (id == R.id.show_on_map) {</span>
<span class="nc" id="L282">            HomeActivity.start(getActivity(), mRouteId);</span>
<span class="nc" id="L283">            return true;</span>
        }
<span class="nc" id="L285">        return false;</span>
    }

    private void setTripDetails(ObaTripDetailsResponse data) {
<span class="nc" id="L289">        mTripInfo = data;</span>

<span class="nc" id="L291">        final int code = mTripInfo.getCode();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (code == ObaApi.OBA_OK) {</span>
<span class="nc" id="L293">            setEmptyText(&quot;&quot;);</span>
        } else {
<span class="nc" id="L295">            setEmptyText(UIUtils.getRouteErrorString(getActivity(), code));</span>
<span class="nc" id="L296">            return;</span>
        }

<span class="nc" id="L299">        setUpHeader();</span>
<span class="nc" id="L300">        final ListView listView = getListView();</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (mAdapter == null) {  // first time displaying list</span>
<span class="nc" id="L303">            mAdapter = new TripDetailsAdapter();</span>
<span class="nc" id="L304">            getListView().setDivider(null);</span>
<span class="nc" id="L305">            setListAdapter(mAdapter);</span>
<span class="nc" id="L306">            setScroller(listView);</span>

            // Scroll to stop if we have the stopId available
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (mStopId != null) {</span>
<span class="nc" id="L310">                mStopIndex = findIndexForStop(mTripInfo.getSchedule().getStopTimes(), mStopId);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                if (mStopIndex != null) {</span>
<span class="nc" id="L312">                    listView.post(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L315">                            listView.setSelection(mStopIndex);</span>
<span class="nc" id="L316">                        }</span>
                    });
                }
            } else {
                // If we don't have a stop, then scroll to the current position of the bus
<span class="nc" id="L321">                final Integer nextStop = mAdapter.getNextStopIndex();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                if (nextStop != null) {</span>
<span class="nc" id="L323">                    listView.post(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L326">                            listView.setSelection(nextStop - 1);</span>
<span class="nc" id="L327">                        }</span>
                    });
                }
            }

<span class="nc bnc" id="L332" title="All 2 branches missed.">            if (mDestinationId != null) {</span>
<span class="nc" id="L333">                mDestinationIndex = findIndexForStop(mTripInfo.getSchedule().getStopTimes(), mDestinationId);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                if (mDestinationIndex != null) {</span>
<span class="nc" id="L335">                    listView.post(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L338">                            listView.setSelection(mDestinationIndex);</span>
<span class="nc" id="L339">                        }</span>
                    });
                }
            }

<span class="nc" id="L344">            mAdapter.notifyDataSetChanged();</span>
        } else {  // refresh, keep scroll position
<span class="nc" id="L346">            int index = listView.getFirstVisiblePosition();</span>
<span class="nc" id="L347">            View v = listView.getChildAt(0);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            int top = (v == null) ? 0 : v.getTop();</span>

<span class="nc" id="L350">            mAdapter.notifyDataSetChanged();</span>
<span class="nc" id="L351">            listView.setSelectionFromTop(index, top);</span>
        }
<span class="nc" id="L353">    }</span>

    private void setUpHeader() {
<span class="nc" id="L356">        ObaTripStatus status = mTripInfo.getStatus();</span>
<span class="nc" id="L357">        ObaReferences refs = mTripInfo.getRefs();</span>

<span class="nc" id="L359">        Context context = getActivity();</span>

<span class="nc" id="L361">        String tripId = mTripInfo.getId();</span>

<span class="nc" id="L363">        ObaTrip trip = refs.getTrip(tripId);</span>
<span class="nc" id="L364">        mRouteId = trip.getRouteId();</span>
<span class="nc" id="L365">        ObaRoute route = refs.getRoute(mRouteId);</span>
<span class="nc" id="L366">        TextView routeShortName = (TextView) getView().findViewById(R.id.short_name);</span>
<span class="nc" id="L367">        routeShortName.setText(route.getShortName());</span>

<span class="nc" id="L369">        TextView headsign = (TextView) getView().findViewById(R.id.long_name);</span>
<span class="nc" id="L370">        headsign.setText(trip.getHeadsign());</span>

<span class="nc" id="L372">        TextView tripShortName = (TextView) getView().findViewById(R.id.trip_short_name);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (!StringUtils.isBlank(trip.getShortName())) {</span>
<span class="nc" id="L374">            tripShortName.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L375">            tripShortName.setText(trip.getShortName());</span>
        } else {
<span class="nc" id="L377">            tripShortName.setVisibility(View.GONE);</span>
        }

<span class="nc" id="L380">        TextView agency = (TextView) getView().findViewById(R.id.agency);</span>
<span class="nc" id="L381">        agency.setText(refs.getAgency(route.getAgencyId()).getName());</span>

<span class="nc" id="L383">        TextView vehicleView = (TextView) getView().findViewById(R.id.vehicle);</span>
<span class="nc" id="L384">        TextView vehicleDeviation = (TextView) getView().findViewById(R.id.status);</span>
<span class="nc" id="L385">        ViewGroup realtime = (ViewGroup) getView().findViewById(</span>
                R.id.eta_realtime_indicator);
<span class="nc" id="L387">        realtime.setVisibility(View.GONE);</span>
<span class="nc" id="L388">        ViewGroup statusLayout = (ViewGroup) getView().findViewById(</span>
                R.id.status_layout);
<span class="nc" id="L390">        ViewGroup occupancyView = getView().findViewById(R.id.occupancy);</span>

<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (status == null) {</span>
            // Show schedule info only
<span class="nc" id="L394">            vehicleView.setText(null);</span>
<span class="nc" id="L395">            vehicleView.setVisibility(View.GONE);</span>
<span class="nc" id="L396">            vehicleDeviation.setText(context.getString(R.string.trip_details_scheduled_data));</span>
<span class="nc" id="L397">            return;</span>
        }

<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (!TextUtils.isEmpty(status.getVehicleId())) {</span>
            // Show vehicle info
<span class="nc" id="L402">            vehicleView</span>
<span class="nc" id="L403">                    .setText(context.getString(R.string.trip_details_vehicle,</span>
<span class="nc" id="L404">                            status.getVehicleId()));</span>
<span class="nc" id="L405">            vehicleView.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L407">            vehicleView.setVisibility(View.GONE);</span>
        }

        // Set status color in header
<span class="nc" id="L411">        statusLayout.setBackgroundResource(</span>
                R.drawable.round_corners_style_b_header_status);
<span class="nc" id="L413">        GradientDrawable d = (GradientDrawable) statusLayout.getBackground();</span>

        int statusColor;

<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (!status.isPredicted()) {</span>
            // We have only schedule info, but the bus position can still be interpolated
<span class="nc" id="L419">            statusColor = R.color.stop_info_scheduled_time;</span>
<span class="nc" id="L420">            d.setColor(getResources().getColor(statusColor));</span>

<span class="nc bnc" id="L422" title="All 2 branches missed.">            if (Status.CANCELED.equals(status.getStatus())) {</span>
                // Canceled trip
<span class="nc" id="L424">                vehicleDeviation.setText(context.getString(R.string.stop_info_canceled));</span>
            } else {
                // Scheduled trip
<span class="nc" id="L427">                vehicleDeviation.setText(context.getString(R.string.trip_details_scheduled_data));</span>
            }
<span class="nc" id="L429">            return;</span>
        }

        /**
         * We have real-time info
         */
<span class="nc" id="L435">        realtime.setVisibility(View.VISIBLE);</span>

<span class="nc" id="L437">        long deviation = status.getScheduleDeviation();</span>
<span class="nc" id="L438">        long deviationMin = TimeUnit.SECONDS.toMinutes(status.getScheduleDeviation());</span>
<span class="nc" id="L439">        long minutes = Math.abs(deviation) / 60;</span>
<span class="nc" id="L440">        long seconds = Math.abs(deviation) % 60;</span>
<span class="nc" id="L441">        String lastUpdate = DateUtils.formatDateTime(getActivity(),</span>
<span class="nc" id="L442">                status.getLastUpdateTime(),</span>
                DateUtils.FORMAT_SHOW_TIME |
                        DateUtils.FORMAT_NO_NOON |
                        DateUtils.FORMAT_NO_MIDNIGHT
        );

<span class="nc" id="L448">        statusColor = ArrivalInfoUtils.computeColorFromDeviation(deviationMin);</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (statusColor != R.color.stop_info_ontime) {</span>
            // Show early/late/scheduled color
<span class="nc" id="L451">            d.setColor(getResources().getColor(statusColor));</span>
        } else {
            // For on-time, use header default color
<span class="nc" id="L454">            d.setColor(getResources().getColor(R.color.theme_primary));</span>
        }

<span class="nc bnc" id="L457" title="All 2 branches missed.">        if (deviation &gt;= 0) {</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">            if (deviation &lt; 60) {</span>
<span class="nc" id="L459">                vehicleDeviation.setText(</span>
<span class="nc" id="L460">                        context.getString(R.string.trip_details_real_time_sec_late, seconds,</span>
                                lastUpdate));
            } else {
<span class="nc" id="L463">                vehicleDeviation.setText(</span>
<span class="nc" id="L464">                        context.getString(R.string.trip_details_real_time_min_sec_late,</span>
<span class="nc" id="L465">                                minutes, seconds, lastUpdate));</span>
            }
        } else {
<span class="nc bnc" id="L468" title="All 2 branches missed.">            if (deviation &gt; -60) {</span>
<span class="nc" id="L469">                vehicleDeviation.setText(</span>
<span class="nc" id="L470">                        context.getString(R.string.trip_details_real_time_sec_early, seconds,</span>
                                lastUpdate));
            } else {
<span class="nc" id="L473">                vehicleDeviation.setText(</span>
<span class="nc" id="L474">                        context.getString(R.string.trip_details_real_time_min_sec_early, minutes,</span>
<span class="nc" id="L475">                                seconds, lastUpdate));</span>
            }
        }

<span class="nc bnc" id="L479" title="All 2 branches missed.">        if (status.getOccupancyStatus() != null) {</span>
            // Real-time occupancy data
<span class="nc" id="L481">            UIUtils.setOccupancyVisibilityAndColor(occupancyView, status.getOccupancyStatus(), OccupancyState.REALTIME);</span>
<span class="nc" id="L482">            UIUtils.setOccupancyContentDescription(occupancyView, status.getOccupancyStatus(), OccupancyState.REALTIME);</span>
        } else {
            // Hide occupancy by setting null value
<span class="nc" id="L485">            UIUtils.setOccupancyVisibilityAndColor(occupancyView, null, OccupancyState.REALTIME);</span>
<span class="nc" id="L486">            UIUtils.setOccupancyContentDescription(occupancyView, null, OccupancyState.REALTIME);</span>
        }
<span class="nc" id="L488">    }</span>

    private Integer findIndexForStop(ObaTripSchedule.StopTime[] stopTimes, String stopId) {
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (stopId == null) {</span>
<span class="nc" id="L492">            return null;</span>
        }
<span class="nc bnc" id="L494" title="All 2 branches missed.">        for (int i = 0; i &lt; stopTimes.length; i++) {</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">            if (stopId.equals(stopTimes[i].getStopId())) {</span>
<span class="nc" id="L496">                return i;</span>
            }
        }
<span class="nc" id="L499">        return null;</span>
    }

    private void showArrivals(String stopId, String stopName, String stopDirection) {
<span class="nc" id="L503">        new ArrivalsListActivity.Builder(getActivity(), stopId)</span>
<span class="nc" id="L504">                .setUpMode(NavHelp.UP_MODE_BACK)</span>
<span class="nc" id="L505">                .setStopName(stopName)</span>
<span class="nc" id="L506">                .setStopDirection(stopDirection)</span>
<span class="nc" id="L507">                .start();</span>
<span class="nc" id="L508">    }</span>

<span class="nc" id="L510">    private final AdapterView.OnItemClickListener mClickListener = new AdapterView.OnItemClickListener() {</span>
        @Override
        public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
<span class="nc bnc" id="L513" title="All 4 branches missed.">            if (mTripInfo == null || mTripInfo.getSchedule() == null) {</span>
<span class="nc" id="L514">                return;</span>
            }
<span class="nc" id="L516">            ObaTripSchedule.StopTime time = mTripInfo.getSchedule().getStopTimes()[position];</span>
<span class="nc" id="L517">            ObaReferences refs = mTripInfo.getRefs();</span>
<span class="nc" id="L518">            String stopId = time.getStopId();</span>
<span class="nc" id="L519">            ObaStop stop = refs.getStop(stopId);</span>
<span class="nc" id="L520">            showArrivals(stopId, stop.getName(), stop.getDirection());</span>
<span class="nc" id="L521">        }</span>
    };

<span class="nc" id="L524">    private final AdapterView.OnItemLongClickListener mLongClickListener = new AdapterView.OnItemLongClickListener() {</span>
        @Override
        public boolean onItemLongClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
<span class="nc bnc" id="L527" title="All 2 branches missed.">            if (position &gt; 1) {</span>
                // Build AlertDialog
<span class="nc" id="L529">                AlertDialog.Builder bldr = new AlertDialog.Builder(getActivity());</span>
<span class="nc" id="L530">                bldr.setMessage(R.string.destination_reminder_dialog_msg).setTitle(R.string.destination_reminder_dialog_title);</span>

                // Confirmation button
<span class="nc" id="L533">                bldr.setPositiveButton(R.string.destination_reminder_confirm, new DialogInterface.OnClickListener() {</span>
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L536" title="All 2 branches missed.">                        if(!LocationUtils.isLocationEnabled(getContext())) {</span>
<span class="nc" id="L537">                            askUserToTurnLocationOn();</span>
<span class="nc" id="L538">                            return;</span>
                        }
<span class="nc" id="L540">                        int locMode = LocationUtils.getLocationMode(getContext());</span>

                        // If location is already on but not on &quot;High Accuracy&quot; mode, ask user to do so!
                        // If the user hasn't opted out of &quot;Change Location Mode&quot; dialog, show it to them
<span class="nc" id="L544">                        SharedPreferences prefs = Application.getPrefs();</span>
<span class="nc bnc" id="L545" title="All 4 branches missed.">                        if (!(prefs.getBoolean(getString(R.string.preference_key_never_show_change_location_mode_dialog), false))</span>
                                &amp;&amp; locMode != Settings.Secure.LOCATION_MODE_HIGH_ACCURACY) {
<span class="nc" id="L547">                            getDialogForLocationModeChanges().show();</span>
                        }

                        // Warn users that destination reminders are in beta
<span class="nc bnc" id="L551" title="All 2 branches missed.">                        if (!(prefs.getBoolean(getString(R.string.preference_key_never_show_destination_reminder_beta_dialog), false))) {</span>
<span class="nc" id="L552">                            createDestinationReminderBetaDialog().show();</span>
                        }

<span class="nc" id="L555">                        ObaAnalytics.reportUiEvent(mFirebaseAnalytics, getString(R.string.analytics_label_destination_reminder), getString(R.string.analytics_label_destination_reminder_variant_started));</span>

<span class="nc" id="L557">                        startNavigationService(setUpNavigationService(position));</span>
<span class="nc" id="L558">                        Toast.makeText(Application.get(),</span>
<span class="nc" id="L559">                                Application.get().getString(R.string.destination_reminder_title),</span>
                                Toast.LENGTH_LONG
<span class="nc" id="L561">                        ).show();</span>

<span class="nc" id="L563">                        TravelBehaviorManager.saveDestinationReminders(mStopId, mDestinationId,</span>
<span class="nc" id="L564">                                mTripId, mRouteId, mTripInfo.getCurrentTime());</span>
<span class="nc" id="L565">                    }</span>
                });

                // Cancellation Button
<span class="nc" id="L569">                bldr.setNegativeButton(R.string.destination_reminder_cancel, (dialog, which) -&gt; {</span>
<span class="nc" id="L570">                });</span>

                // Display
<span class="nc" id="L573">                AlertDialog dialog = bldr.create();</span>
<span class="nc" id="L574">                dialog.setOwnerActivity(getActivity());</span>
<span class="nc" id="L575">                dialog.show();</span>
            }

<span class="nc" id="L578">            return true;</span>
        }

        /**
         * @param pId Position of a stop for which we started Destination alert
         * @return Intent object to be used for starting navigation service
         */
        private Intent setUpNavigationService(int pId) {
<span class="nc" id="L586">            ObaTripSchedule.StopTime timeLast = mTripInfo.getSchedule().getStopTimes()[pId-1];</span>
<span class="nc" id="L587">            ObaTripSchedule.StopTime timeDest = mTripInfo.getSchedule().getStopTimes()[pId];</span>
<span class="nc" id="L588">            ObaReferences refs = mTripInfo.getRefs();</span>
<span class="nc" id="L589">            String destStopId = timeDest.getStopId();</span>
<span class="nc" id="L590">            String lastStopId = timeLast.getStopId();</span>
<span class="nc" id="L591">            ObaStop destStop = refs.getStop(destStopId);</span>
<span class="nc" id="L592">            ObaStop lastStop = refs.getStop(lastStopId);</span>

<span class="nc" id="L594">            DBUtil.addToDB(lastStop);</span>
<span class="nc" id="L595">            DBUtil.addToDB(destStop);</span>

<span class="nc" id="L597">            Intent serviceIntent = new Intent(getContext(), NavigationService.class);</span>

<span class="nc" id="L599">            mDestinationId = destStop.getId();</span>
<span class="nc" id="L600">            serviceIntent.putExtra(NavigationService.DESTINATION_ID, mDestinationId);</span>
<span class="nc" id="L601">            serviceIntent.putExtra(NavigationService.BEFORE_STOP_ID, lastStop.getId());</span>
<span class="nc" id="L602">            serviceIntent.putExtra(NavigationService.TRIP_ID, mTripId);</span>

            // update UI
<span class="nc bnc" id="L605" title="All 2 branches missed.">            if (mDestinationId != null) {</span>
<span class="nc" id="L606">                mDestinationIndex = findIndexForStop(mTripInfo.getSchedule().getStopTimes(), mDestinationId);</span>
            }
<span class="nc" id="L608">            mAdapter.notifyDataSetChanged();</span>
            // Save Intent so that we can call up startNavigationService() from onActivityResult() later
<span class="nc" id="L610">            getActivity().setIntent(serviceIntent);</span>
<span class="nc" id="L611">            return serviceIntent;</span>
        }

        /**
         * This will allow user to turn on location within application context
         */
        private void askUserToTurnLocationOn() {
<span class="nc" id="L618">            mLocationRequest = LocationRequest.create();</span>
<span class="nc" id="L619">            mLocationRequest.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);</span>

            // Specifies the types of location services the client is interested in using.
<span class="nc" id="L622">            LocationSettingsRequest.Builder builder = new LocationSettingsRequest.Builder();</span>
<span class="nc" id="L623">            builder.addLocationRequest(mLocationRequest);</span>

<span class="nc" id="L625">            mResult = LocationServices.getSettingsClient(getActivity()).checkLocationSettings(builder.build());</span>

            // When the Task(mResult is of type Task) completes, the client can check the location settings
            // by looking at the status code from the LocationSettingsResponse object.
<span class="nc" id="L629">            mResult.addOnCompleteListener(new OnCompleteListener&lt;LocationSettingsResponse&gt;() {</span>
                @Override
                public void onComplete(Task&lt;LocationSettingsResponse&gt; task) {
                    try {
<span class="nc" id="L633">                        LocationSettingsResponse response = task.getResult(ApiException.class);</span>
                        // All loc settings are satisfied if we are at this line. Code flow never comes here!
<span class="nc" id="L635">                    } catch (ApiException APIexc) {</span>
<span class="nc bnc" id="L636" title="All 3 branches missed.">                        switch (APIexc.getStatusCode()) {</span>
                            case LocationSettingsStatusCodes.RESOLUTION_REQUIRED:
                                // Location settings are not satisfied. But could be fixed by showing the
                                // user a dialog.
                                try {
<span class="nc" id="L641">                                    ResolvableApiException resolvable = (ResolvableApiException) APIexc;</span>
                                    // Show the dialog by calling startResolutionForResult(),
                                    // and check the result in onActivityResult()
<span class="nc" id="L644">                                    Log.d(TAG, &quot;Showing dialog to user for desired location settings...&quot;);</span>
<span class="nc" id="L645">                                    resolvable.startResolutionForResult(getActivity(), REQUEST_ENABLE_LOCATION);</span>
<span class="nc" id="L646">                                } catch (IntentSender.SendIntentException sendIntExc) {</span>
                                    // Ignore the error.
<span class="nc" id="L648">                                } catch (ClassCastException classCastExc) {</span>
                                    // Ignore, should be an impossible error.
<span class="nc" id="L650">                                }</span>
<span class="nc" id="L651">                                break;</span>
                            case LocationSettingsStatusCodes.SETTINGS_CHANGE_UNAVAILABLE:
                                // Location settings are not satisfied. However, we have no way to fix the
                                // settings so we won't show the dialog.
<span class="nc" id="L655">                                Log.d(TAG, &quot;Location settings are inadequate, and cannot be fixed here. Dialog not created.&quot;);</span>
                                break;
                        }
<span class="nc" id="L658">                    }</span>
<span class="nc" id="L659">                }</span>
            });
<span class="nc" id="L661">        }</span>

        /**
         * Create &quot;High Accuracy GPS needed alert&quot; dialog
         *
         * @return dialog for &quot;High Accuracy GPS needed alert&quot;
         */
        private Dialog getDialogForLocationModeChanges() {
<span class="nc" id="L669">            View view = getActivity().getLayoutInflater().inflate(R.layout.change_locationmode_dialog, null);</span>
<span class="nc" id="L670">            CheckBox neverShowDialog = view.findViewById(R.id.change_locationmode_never_ask_again);</span>

<span class="nc" id="L672">            neverShowDialog.setOnCheckedChangeListener((compoundButton, isChecked) -&gt; {</span>
                // Save the preference
<span class="nc" id="L674">                PreferenceUtils.saveBoolean(getString(R.string.preference_key_never_show_change_location_mode_dialog), isChecked);</span>
<span class="nc" id="L675">            });</span>

<span class="nc" id="L677">            Drawable icon = getResources().getDrawable(android.R.drawable.ic_dialog_map);</span>
<span class="nc" id="L678">            DrawableCompat.setTint(icon, getResources().getColor(R.color.theme_primary));</span>

<span class="nc" id="L680">            AlertDialog.Builder builder = new AlertDialog.Builder(getActivity())</span>
<span class="nc" id="L681">                    .setTitle(R.string.main_changelocationmode_title)</span>
<span class="nc" id="L682">                    .setIcon(icon)</span>
<span class="nc" id="L683">                    .setCancelable(false)</span>
<span class="nc" id="L684">                    .setView(view)</span>
<span class="nc" id="L685">                    .setPositiveButton(R.string.rt_yes,</span>
<span class="nc" id="L686">                            (dialog, which) -&gt; startActivity(new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS))</span>
                    )
<span class="nc" id="L688">                    .setNegativeButton(R.string.rt_no,</span>
                            (dialog, which) -&gt; {
                                // No code required..
<span class="nc" id="L691">                            }</span>
                    );
<span class="nc" id="L693">            return builder.create();</span>
        }
    };

    /**
     * Create dialog reminding user that destination reminders are in beta
     *
     * @return dialog reminding user that destination reminders are in beta
     */
    private Dialog createDestinationReminderBetaDialog() {
<span class="nc" id="L703">        View view = getActivity().getLayoutInflater().inflate(R.layout.destination_reminder_beta_dialog, null);</span>
<span class="nc" id="L704">        CheckBox neverShowDialog = view.findViewById(R.id.destination_reminder_beta_never_show_again);</span>

<span class="nc" id="L706">        neverShowDialog.setOnCheckedChangeListener((compoundButton, isChecked) -&gt; {</span>
            // Save the preference
<span class="nc" id="L708">            PreferenceUtils.saveBoolean(getString(R.string.preference_key_never_show_destination_reminder_beta_dialog), isChecked);</span>
<span class="nc" id="L709">        });</span>

<span class="nc" id="L711">        Drawable icon = getResources().getDrawable(android.R.drawable.ic_dialog_alert);</span>
<span class="nc" id="L712">        DrawableCompat.setTint(icon, getResources().getColor(R.color.theme_primary));</span>

<span class="nc" id="L714">        AlertDialog.Builder builder = new AlertDialog.Builder(getActivity())</span>
<span class="nc" id="L715">                .setTitle(R.string.destination_reminder_beta_title)</span>
<span class="nc" id="L716">                .setIcon(icon)</span>
<span class="nc" id="L717">                .setCancelable(false)</span>
<span class="nc" id="L718">                .setView(view)</span>
<span class="nc" id="L719">                .setPositiveButton(R.string.ok, (dialogInterface, i) -&gt; {</span>
<span class="nc" id="L720">                        }</span>
                );
<span class="nc" id="L722">        return builder.create();</span>
    }

<span class="nc" id="L725">    private final Handler mRefreshHandler = new Handler();</span>

<span class="nc" id="L727">    private final Runnable mRefresh = new Runnable() {</span>
        public void run() {
<span class="nc" id="L729">            refresh();</span>
<span class="nc" id="L730">        }</span>
    };

    private TripDetailsLoader getTripDetailsLoader() {
        // If the Fragment hasn't been attached to an Activity yet, return null
<span class="nc bnc" id="L735" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L736">            return null;</span>
        }

<span class="nc" id="L739">        Loader&lt;ObaTripDetailsResponse&gt; l =</span>
<span class="nc" id="L740">                getLoaderManager().getLoader(TRIP_DETAILS_LOADER);</span>
<span class="nc" id="L741">        return (TripDetailsLoader) l;</span>
    }

    private void refresh() {
<span class="nc bnc" id="L745" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L746">            UIUtils.showProgress(this, true);</span>
<span class="nc" id="L747">            getTripDetailsLoader().onContentChanged();</span>
        }
<span class="nc" id="L749">    }</span>

<span class="nc" id="L751">    private final class TripDetailsLoaderCallback</span>
            implements LoaderManager.LoaderCallbacks&lt;ObaTripDetailsResponse&gt; {

        @Override
        public Loader&lt;ObaTripDetailsResponse&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L756">            return new TripDetailsLoader(getActivity(), mTripId);</span>
        }

        @Override
        public void onLoadFinished(Loader&lt;ObaTripDetailsResponse&gt; loader,
                                   ObaTripDetailsResponse data) {
<span class="nc" id="L762">            setTripDetails(data);</span>

            // The list should now be shown.
<span class="nc bnc" id="L765" title="All 2 branches missed.">            if (isResumed()) {</span>
<span class="nc" id="L766">                setListShown(true);</span>
            } else {
<span class="nc" id="L768">                setListShownNoAnimation(true);</span>
            }

            // Clear any pending refreshes
<span class="nc" id="L772">            mRefreshHandler.removeCallbacks(mRefresh);</span>

            // Post an update
<span class="nc" id="L775">            mRefreshHandler.postDelayed(mRefresh, REFRESH_PERIOD);</span>
<span class="nc" id="L776">        }</span>

        @Override
        public void onLoaderReset(Loader&lt;ObaTripDetailsResponse&gt; loader) {
            // Nothing to do right here...
<span class="nc" id="L781">        }</span>
    }

    private final static class TripDetailsLoader extends AsyncTaskLoader&lt;ObaTripDetailsResponse&gt; {

        private final String mTripId;

        private ObaTripDetailsResponse mLastGoodResponse;

<span class="nc" id="L790">        private long mLastResponseTime = 0;</span>

<span class="nc" id="L792">        private long mLastGoodResponseTime = 0;</span>

        TripDetailsLoader(Context context, String tripId) {
<span class="nc" id="L795">            super(context);</span>
<span class="nc" id="L796">            mTripId = tripId;</span>
<span class="nc" id="L797">        }</span>

        @Override
        public ObaTripDetailsResponse loadInBackground() {
<span class="nc" id="L801">            return ObaTripDetailsRequest.newRequest(getContext(), mTripId).call();</span>
        }

        @Override
        public void deliverResult(ObaTripDetailsResponse data) {
<span class="nc" id="L806">            mLastResponseTime = System.currentTimeMillis();</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (data.getCode() == ObaApi.OBA_OK) {</span>
<span class="nc" id="L808">                mLastGoodResponse = data;</span>
<span class="nc" id="L809">                mLastGoodResponseTime = mLastResponseTime;</span>
            }
<span class="nc" id="L811">            super.deliverResult(data);</span>
<span class="nc" id="L812">        }</span>

        public long getLastResponseTime() {
<span class="nc" id="L815">            return mLastResponseTime;</span>
        }

        public ObaTripDetailsResponse getLastGoodResponse() {
<span class="nc" id="L819">            return mLastGoodResponse;</span>
        }

        public long getLastGoodResponseTime() {
<span class="nc" id="L823">            return mLastGoodResponseTime;</span>
        }
    }

    private final class TripDetailsAdapter extends BaseAdapter {

        LayoutInflater mInflater;

        ObaTripSchedule mSchedule;
        ObaReferences mRefs;
        ObaTripStatus mStatus;

        Integer mNextStopIndex;

<span class="nc" id="L837">        public TripDetailsAdapter() {</span>
<span class="nc" id="L838">            this.mInflater = LayoutInflater.from(TripDetailsListFragment.this.getActivity());</span>

<span class="nc" id="L840">            updateData();</span>
<span class="nc" id="L841">        }</span>

        private void updateData() {
<span class="nc" id="L844">            this.mSchedule = mTripInfo.getSchedule();</span>
<span class="nc" id="L845">            this.mRefs = mTripInfo.getRefs();</span>
<span class="nc" id="L846">            this.mStatus = mTripInfo.getStatus();</span>

<span class="nc" id="L848">            mNextStopIndex = null;</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">            if (mStatus == null) {</span>
                // We don't have real-time data - clear next stop index
<span class="nc" id="L851">                return;</span>
            }

            // Based on real-time data, set the index for the next stop
<span class="nc" id="L855">            String stopId = mStatus.getNextStop();</span>
            int i;
<span class="nc bnc" id="L857" title="All 2 branches missed.">            for (i = 0; i &lt; mSchedule.getStopTimes().length; i++) {</span>
<span class="nc" id="L858">                ObaTripSchedule.StopTime time = mSchedule.getStopTimes()[i];</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">                if (time.getStopId().equals(stopId)) {</span>
<span class="nc" id="L860">                    mNextStopIndex = i;</span>
<span class="nc" id="L861">                    break;</span>
                }
            }
<span class="nc" id="L864">        }</span>

        @Override
        public void notifyDataSetChanged() {
<span class="nc" id="L868">            updateData();</span>
<span class="nc" id="L869">            super.notifyDataSetChanged();</span>
<span class="nc" id="L870">        }</span>

        @Override
        public int getCount() {
<span class="nc" id="L874">            return mSchedule.getStopTimes().length;</span>
        }

        @Override
        public Object getItem(int position) {
<span class="nc" id="L879">            return mSchedule.getStopTimes()[position];</span>
        }

        @Override
        public long getItemId(int position) {
<span class="nc" id="L884">            return position;</span>
        }

        @Override
        public View getView(int position, View convertView, ViewGroup parent) {
<span class="nc bnc" id="L889" title="All 2 branches missed.">            if (convertView == null) {</span>
<span class="nc" id="L890">                convertView = mInflater.inflate(R.layout.trip_details_listitem, parent, false);</span>
            }

<span class="nc" id="L893">            ObaTripSchedule.StopTime stopTime = mSchedule.getStopTimes()[position];</span>
<span class="nc" id="L894">            ObaStop stop = mRefs.getStop(stopTime.getStopId());</span>
<span class="nc" id="L895">            ObaTrip trip = mRefs.getTrip(mTripId);</span>
<span class="nc" id="L896">            ObaRoute route = mRefs.getRoute(trip.getRouteId());</span>

<span class="nc" id="L898">            TextView stopName = (TextView) convertView.findViewById(R.id.stop_name);</span>
<span class="nc" id="L899">            stopName.setText(UIUtils.formatDisplayText(stop.getName()));</span>

<span class="nc" id="L901">            TextView time = (TextView) convertView.findViewById(R.id.time);</span>
<span class="nc" id="L902">            ViewGroup realtime = (ViewGroup) convertView.findViewById(</span>
                    R.id.eta_realtime_indicator);
<span class="nc" id="L904">            realtime.setVisibility(View.GONE);</span>
<span class="nc" id="L905">            ViewGroup occupancyView = convertView.findViewById(R.id.occupancy);</span>

            long date;
<span class="nc" id="L908">            long deviation = 0;</span>
            int statusColor;
<span class="nc bnc" id="L910" title="All 2 branches missed.">            if (mStatus != null) {</span>
                // If we have real-time info, use that
<span class="nc" id="L912">                date = mStatus.getServiceDate();</span>
<span class="nc" id="L913">                deviation = mStatus.getScheduleDeviation();</span>
<span class="nc" id="L914">                long deviationMin = TimeUnit.SECONDS.toMinutes(mStatus.getScheduleDeviation());</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">                if (mStatus.isPredicted()) {</span>
<span class="nc" id="L916">                    statusColor = ArrivalInfoUtils.computeColorFromDeviation(deviationMin);</span>
                } else {
<span class="nc" id="L918">                    statusColor = R.color.stop_info_scheduled_time;</span>
                }
<span class="nc" id="L920">            } else {</span>
                // Use current date - its only to offset time correctly from midnight
<span class="nc" id="L922">                Calendar cal = new GregorianCalendar();</span>
                // Reset to midnight of today
<span class="nc" id="L924">                cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L925">                cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L926">                cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L927">                cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L928">                date = cal.getTime().getTime();</span>
<span class="nc" id="L929">                statusColor = R.color.stop_info_scheduled_time;</span>
            }
<span class="nc" id="L931">            time.setText(DateUtils.formatDateTime(getActivity(),</span>
<span class="nc" id="L932">                    date + stopTime.getArrivalTime() * 1000</span>
                            + deviation * 1000,
                    DateUtils.FORMAT_SHOW_TIME |
                            DateUtils.FORMAT_NO_NOON |
                            DateUtils.FORMAT_NO_MIDNIGHT
            ));

<span class="nc bnc" id="L939" title="All 4 branches missed.">            if (mStatus != null &amp;&amp; Status.CANCELED.equals(mStatus.getStatus())) {</span>
                // CANCELED trip - Strike through the text fields
<span class="nc" id="L941">                stopName.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
<span class="nc" id="L942">                time.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
            }

<span class="nc bnc" id="L945" title="All 2 branches missed.">            if (stopTime.getPredictedOccupancy() != null) {</span>
                // Predicted occupancy data
<span class="nc" id="L947">                UIUtils.setOccupancyVisibilityAndColor(occupancyView, stopTime.getPredictedOccupancy(), OccupancyState.PREDICTED);</span>
<span class="nc" id="L948">                UIUtils.setOccupancyContentDescription(occupancyView, stopTime.getPredictedOccupancy(), OccupancyState.PREDICTED);</span>
            } else {
                // Historical occupancy data
<span class="nc" id="L951">                UIUtils.setOccupancyVisibilityAndColor(occupancyView, stopTime.getHistoricalOccupancy(), OccupancyState.HISTORICAL);</span>
<span class="nc" id="L952">                UIUtils.setOccupancyContentDescription(occupancyView, stopTime.getHistoricalOccupancy(), OccupancyState.HISTORICAL);</span>
            }

<span class="nc" id="L955">            ImageView bus = (ImageView) convertView.findViewById(R.id.bus_icon);</span>
<span class="nc" id="L956">            ImageView stopIcon = (ImageView) convertView.findViewById(R.id.stop_icon);</span>
<span class="nc" id="L957">            ImageView flagIcon = (ImageView) convertView.findViewById(R.id.destination_icon);</span>
<span class="nc" id="L958">            ImageView topLine = (ImageView) convertView.findViewById(R.id.top_line);</span>
<span class="nc" id="L959">            ImageView bottomLine = (ImageView) convertView.findViewById(R.id.bottom_line);</span>
<span class="nc" id="L960">            ImageView transitStop = (ImageView) convertView.findViewById(R.id.transit_stop);</span>

            // Set bus and realtime indicator to match status color
            int id;
<span class="nc bnc" id="L964" title="All 7 branches missed.">            switch (route.getType()) {</span>
                case ObaRoute.TYPE_FERRY:
<span class="nc" id="L966">                    id = R.drawable.ic_ferry;</span>
<span class="nc" id="L967">                    break;</span>
                case ObaRoute.TYPE_SUBWAY:
<span class="nc" id="L969">                    id = R.drawable.ic_subway;</span>
<span class="nc" id="L970">                    break;</span>
                case ObaRoute.TYPE_CABLECAR:
<span class="nc" id="L972">                    id = R.drawable.ic_tram;</span>
<span class="nc" id="L973">                    break;</span>
                case ObaRoute.TYPE_TRAM:
<span class="nc" id="L975">                    id = R.drawable.ic_tram;</span>
<span class="nc" id="L976">                    break;</span>
                case ObaRoute.TYPE_RAIL:
<span class="nc" id="L978">                    id = R.drawable.ic_train;</span>
<span class="nc" id="L979">                    break;</span>
                case ObaRoute.TYPE_BUS:
<span class="nc" id="L981">                    id = R.drawable.ic_bus;</span>
<span class="nc" id="L982">                    break;</span>
                default:
<span class="nc" id="L984">                    id = R.drawable.ic_bus;</span>
                    break;
            }
<span class="nc" id="L987">            bus.setImageDrawable(getResources().getDrawable(id));</span>
<span class="nc" id="L988">            bus.setColorFilter(Color.WHITE, PorterDuff.Mode.SRC_IN); // Make the icon itself white</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span class="nc" id="L990">                bus.setBackgroundTintList(ColorStateList.valueOf(getResources().getColor(statusColor))); // Change the circle's color</span>
            }
<span class="nc" id="L992">            UIUtils.setRealtimeIndicatorColor(realtime, getResources().getColor(statusColor),</span>
<span class="nc" id="L993">                    android.R.color.transparent);</span>

            int routeColor;
            // If a route color (other than the default white) is included in the API response, then use it
<span class="nc bnc" id="L997" title="All 4 branches missed.">            if (route.getColor() != null &amp;&amp; route.getColor() != android.R.color.white) {</span>
<span class="nc" id="L998">                routeColor = route.getColor();</span>
            } else {
                // Use the theme color
<span class="nc" id="L1001">                routeColor = getResources().getColor(R.color.theme_primary);</span>
            }

<span class="nc" id="L1004">            stopIcon.setColorFilter(routeColor);</span>
<span class="nc" id="L1005">            topLine.setColorFilter(routeColor);</span>
<span class="nc" id="L1006">            bottomLine.setColorFilter(routeColor);</span>
<span class="nc" id="L1007">            transitStop.setColorFilter(routeColor);</span>
<span class="nc" id="L1008">            flagIcon.setColorFilter(routeColor);</span>

<span class="nc bnc" id="L1010" title="All 2 branches missed.">            if (position == 0) {</span>
                // First stop in trip - hide the top half of the transit line
<span class="nc" id="L1012">                topLine.setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L1013">                bottomLine.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">            } else if (position == mSchedule.getStopTimes().length - 1) {</span>
                // Last stop in trip - hide the bottom half of the transit line
<span class="nc" id="L1016">                topLine.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1017">                bottomLine.setVisibility(View.INVISIBLE);</span>
            } else {
                // Middle of trip - show top and bottom transit lines
<span class="nc" id="L1020">                topLine.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1021">                bottomLine.setVisibility(View.VISIBLE);</span>
            }

<span class="nc bnc" id="L1024" title="All 4 branches missed.">            if (mDestinationIndex != null &amp;&amp; mDestinationIndex == position) {</span>
<span class="nc" id="L1025">                stopIcon.setVisibility(View.GONE);</span>
<span class="nc" id="L1026">                flagIcon.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L1027" title="All 4 branches missed.">            } else if (mStopIndex != null &amp;&amp; mStopIndex == position) {</span>
<span class="nc" id="L1028">                stopIcon.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1029">                flagIcon.setVisibility(View.GONE);</span>
            } else {
<span class="nc" id="L1031">                flagIcon.setVisibility(View.GONE);</span>
<span class="nc" id="L1032">                stopIcon.setVisibility(View.GONE);</span>
            }

<span class="nc bnc" id="L1035" title="All 2 branches missed.">            if (mNextStopIndex != null) {</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">                if (position == mNextStopIndex - 1) {</span>
                    // The bus just passed this stop - show the bus icon here
<span class="nc" id="L1038">                    bus.setVisibility(View.VISIBLE);</span>

<span class="nc bnc" id="L1040" title="All 4 branches missed.">                    if (mStatus != null &amp;&amp; mStatus.isPredicted()) {</span>
                        // Show realtime indicator
<span class="nc" id="L1042">                        realtime.setVisibility(View.VISIBLE);</span>
                    }
                } else {
<span class="nc" id="L1045">                    bus.setVisibility(View.INVISIBLE);</span>
                }

<span class="nc bnc" id="L1048" title="All 2 branches missed.">                if (position &lt; mNextStopIndex) {</span>
                    // Bus passed stop - fade out views for these stops
<span class="nc" id="L1050">                    stopName.setTextColor(getResources().getColor(R.color.trip_details_passed));</span>
<span class="nc" id="L1051">                    time.setTextColor(getResources().getColor(R.color.trip_details_passed));</span>

                    // Set alpha for occupancy background
<span class="nc" id="L1054">                    int alpha = (int) (.35f * 255);  // X percent transparency</span>
<span class="nc" id="L1055">                    occupancyView.setBackgroundResource(R.drawable.occupancy_background);</span>
<span class="nc" id="L1056">                    GradientDrawable d = (GradientDrawable) occupancyView.getBackground();</span>
<span class="nc" id="L1057">                    d.setAlpha(alpha);</span>

                    // Set alpha for occupancy person icons
<span class="nc bnc" id="L1060" title="All 2 branches missed.">                    for (int index = 0; index &lt; occupancyView.getChildCount(); ++index) {</span>
<span class="nc" id="L1061">                        ((ImageView) occupancyView.getChildAt(index)).setAlpha(alpha);</span>
                    }
<span class="nc" id="L1063">                } else {</span>
                    // Bus hasn't yet passed this stop - leave full color
<span class="nc" id="L1065">                    stopName.setTextColor(getResources().getColor(R.color.trip_details_not_passed));</span>
<span class="nc" id="L1066">                    time.setTextColor(getResources().getColor(R.color.trip_details_not_passed));</span>
                }
            } else {
                // No &quot;next stop&quot; info - hide the bus icon
<span class="nc" id="L1070">                bus.setVisibility(View.INVISIBLE);</span>
                // Bus hasn't passed this stop - leave full color
<span class="nc" id="L1072">                stopName.setTextColor(getResources().getColor(R.color.trip_details_not_passed));</span>
<span class="nc" id="L1073">                time.setTextColor(getResources().getColor(R.color.trip_details_not_passed));</span>
            }
<span class="nc" id="L1075">            return convertView;</span>
        }

        /**
         * Returns the next stop index based on real-time info, or null no estimated next stop
         * exists
         *
         * @return the next stop index based on real-time info, or null no estimated next stop
         * exists
         */
        public Integer getNextStopIndex() {
<span class="nc" id="L1086">            return mNextStopIndex;</span>
        }
    }

    private void setScroller(final ListView listView)
    {
<span class="nc bnc" id="L1092" title="All 2 branches missed.">        if (mScrollMode == null) {</span>
            // Don't automatically scroll to stop or vehicle icon
<span class="nc" id="L1094">            return;</span>
        }

<span class="nc bnc" id="L1097" title="All 3 branches missed.">        switch (mScrollMode) {</span>
            case SCROLL_MODE_VEHICLE: {
                // Scroll to bus marker if scroll mode is set to vehicle &amp; we have index.
<span class="nc" id="L1100">                final Integer nextStop = mAdapter.getNextStopIndex();</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">                if (nextStop != null) {</span>
<span class="nc" id="L1102">                    listView.post(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L1105">                            listView.setSelection(nextStop - 1);</span>
<span class="nc" id="L1106">                        }</span>
                    });
                } else {
                    // If we couldn't get the bus marker, fall back to stop.
<span class="nc" id="L1110">                    mStopIndex = findIndexForStop(mTripInfo.getSchedule().getStopTimes(), mStopId);</span>
<span class="nc bnc" id="L1111" title="All 2 branches missed.">                    if (mStopIndex != null) {</span>
<span class="nc" id="L1112">                        listView.post(new Runnable() {</span>
                            @Override
                            public void run() {
<span class="nc" id="L1115">                                listView.setSelection(mStopIndex);</span>
<span class="nc" id="L1116">                            }</span>
                        });
                    }
                }
                break;
            }

            case SCROLL_MODE_STOP: {
                // Scroll to stop if we have the stopId available
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                if (mStopId != null) {</span>
<span class="nc" id="L1126">                    mStopIndex = findIndexForStop(mTripInfo.getSchedule().getStopTimes(), mStopId);</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">                    if (mStopIndex != null) {</span>
<span class="nc" id="L1128">                        listView.post(new Runnable() {</span>
                            @Override
                            public void run() {
<span class="nc" id="L1131">                                listView.setSelection(mStopIndex);</span>
<span class="nc" id="L1132">                            }</span>
                        });
                    }
                } else {
                    // If we don't have a stop, then scroll to the current position of the bus
<span class="nc" id="L1137">                    final Integer nextStop = mAdapter.getNextStopIndex();</span>
<span class="nc bnc" id="L1138" title="All 2 branches missed.">                    if (nextStop != null) {</span>
<span class="nc" id="L1139">                        listView.post(new Runnable() {</span>
                            @Override
                            public void run() {
<span class="nc" id="L1142">                                listView.setSelection(nextStop - 1);</span>
<span class="nc" id="L1143">                            }</span>
                        });
                    }
                }
                break;
            }
        }
<span class="nc" id="L1150">        mAdapter.notifyDataSetChanged();</span>
<span class="nc" id="L1151">    }</span>

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data)
    {
<span class="nc bnc" id="L1156" title="All 2 branches missed.">        if (requestCode == REQUEST_ENABLE_LOCATION) {</span>
<span class="nc bnc" id="L1157" title="All 3 branches missed.">            switch (resultCode) {</span>
                case Activity.RESULT_OK:
                    // All required changes were successfully made
<span class="nc" id="L1160">                    Log.d(TAG, &quot;Location enabled&quot;);</span>
<span class="nc" id="L1161">                    startNavigationService(getActivity().getIntent());</span>
<span class="nc" id="L1162">                    break;</span>
                case Activity.RESULT_CANCELED:
                    // The user was asked to change settings but chose not to
<span class="nc" id="L1165">                    Log.d(TAG, &quot;Location not enabled&quot;);</span>
<span class="nc" id="L1166">                    break;</span>
                default:
                    break;
            }
        }
<span class="nc" id="L1171">    }</span>

    /**
     * Starts the navigation service for destination reminders
     * @param serviceIntent
     */
    private void startNavigationService(Intent serviceIntent) {
<span class="nc bnc" id="L1178" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {</span>
<span class="nc" id="L1179">            Application.get().getApplicationContext().startForegroundService(serviceIntent);</span>
        } else {
<span class="nc" id="L1181">            Application.get().getApplicationContext().startService(serviceIntent);</span>
        }

        // Register receiver
<span class="nc" id="L1185">        registerReceiver();</span>
<span class="nc" id="L1186">    }</span>

    /**
     * Register receiver so that when trip is cancelled by user then flag will be removed from screen
     */
    private void registerReceiver() {
        // filter specifies which event Receiver should listen to
<span class="nc" id="L1193">        IntentFilter filter = new IntentFilter();</span>
<span class="nc" id="L1194">        filter.addAction(ACTION_SERVICE_DESTROYED);</span>
<span class="nc" id="L1195">        getActivity().registerReceiver(new TripEndReceiver(), filter);</span>
<span class="nc" id="L1196">    }</span>

    /**
     * When user cancels trip from &quot;Notification menu&quot; then destination flag in trip details screen
     * should be removed.
     *
     * From {@link NavigationService 's} onDestroy(), we send broadcast action
     */
<span class="nc" id="L1204">    class TripEndReceiver extends BroadcastReceiver {</span>
        private static final String TAG = &quot;TripEndReceiver&quot;;

        @Override
        public void onReceive(Context context, Intent intent) {
<span class="nc bnc" id="L1209" title="All 2 branches missed.">            if (intent.getAction().equals(ACTION_SERVICE_DESTROYED)) {</span>
<span class="nc" id="L1210">                Log.d(TAG,&quot;Action received in BroadcastReceiver, trip is destroyed&quot;);</span>

                // This is used to set flagIcon on trip details screen so setting it to null
<span class="nc" id="L1213">                mDestinationId = null;</span>
<span class="nc" id="L1214">                mDestinationIndex = null;</span>

                // It will call up getView() so that flag icon gets unset
<span class="nc" id="L1217">                mAdapter.notifyDataSetChanged();</span>

                // Unregister this receiver now
<span class="nc" id="L1220">                getActivity().unregisterReceiver(this);</span>
            }
<span class="nc" id="L1222">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>