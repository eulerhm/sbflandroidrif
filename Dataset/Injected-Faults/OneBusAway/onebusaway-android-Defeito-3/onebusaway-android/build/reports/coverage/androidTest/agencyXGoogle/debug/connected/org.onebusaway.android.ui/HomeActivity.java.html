<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HomeActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">HomeActivity.java</span></div><h1>HomeActivity.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2012-2017 Paul Watts (paulcwatts@gmail.com),
 * University of South Florida (sjbarbeau@gmail.com),
 * Microsoft Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import com.google.android.gms.common.ConnectionResult;
import com.google.android.gms.common.GoogleApiAvailability;
import com.google.android.gms.common.api.GoogleApiClient;
import com.google.android.material.floatingactionbutton.FloatingActionButton;
import com.google.firebase.analytics.FirebaseAnalytics;

import com.sothree.slidinguppanel.SlidingUpPanelLayout;

import org.onebusaway.android.BuildConfig;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.elements.ObaRegion;
import org.onebusaway.android.io.elements.ObaRoute;
import org.onebusaway.android.io.elements.ObaStop;
import org.onebusaway.android.io.request.ObaArrivalInfoResponse;
import org.onebusaway.android.map.MapModeController;
import org.onebusaway.android.map.MapParams;
import org.onebusaway.android.map.googlemapsv2.BaseMapFragment;
import org.onebusaway.android.map.googlemapsv2.LayerInfo;
import org.onebusaway.android.region.ObaRegionsTask;
import org.onebusaway.android.report.ui.ReportActivity;
import org.onebusaway.android.travelbehavior.TravelBehaviorManager;
import org.onebusaway.android.travelbehavior.constants.TravelBehaviorConstants;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorUtils;
import org.onebusaway.android.tripservice.TripService;
import org.onebusaway.android.util.FragmentUtils;
import org.onebusaway.android.util.LocationUtils;
import org.onebusaway.android.util.PermissionUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.onebusaway.android.util.RegionUtils;
import org.onebusaway.android.util.ShowcaseViewUtils;
import org.onebusaway.android.util.UIUtils;
import org.opentripplanner.routing.bike_rental.BikeRentalStation;

import android.Manifest;
import android.app.Dialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.content.pm.PackageManager.NameNotFoundException;
import android.content.res.Resources;
import android.graphics.Paint;
import android.graphics.drawable.GradientDrawable;
import android.location.Location;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.text.TextUtils;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.Window;
import android.view.accessibility.AccessibilityManager;
import android.view.animation.Animation;
import android.view.animation.Transformation;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;

import java.lang.ref.WeakReference;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.annotation.NonNull;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.content.ContextCompat;
import androidx.fragment.app.FragmentManager;

import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_ACTIVITY_FEED;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_HELP;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_MY_REMINDERS;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_NEARBY;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_OPEN_SOURCE;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_PAY_FARE;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_PINS;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_PLAN_TRIP;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_PROFILE;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_SEND_FEEDBACK;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_SETTINGS;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_SIGN_IN;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_STARRED_ROUTES;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NAVDRAWER_ITEM_STARRED_STOPS;
import static org.onebusaway.android.ui.NavigationDrawerFragment.NavigationDrawerCallbacks;
import static org.onebusaway.android.util.PermissionUtils.BACKGROUND_LOCATION_PERMISSION_REQUEST;
import static org.onebusaway.android.util.PermissionUtils.LOCATION_PERMISSIONS;
import static uk.co.markormesher.android_fab.FloatingActionButton.POSITION_BOTTOM;
import static uk.co.markormesher.android_fab.FloatingActionButton.POSITION_END;
import static uk.co.markormesher.android_fab.FloatingActionButton.POSITION_START;

<span class="nc" id="L128">public class HomeActivity extends AppCompatActivity</span>
        implements BaseMapFragment.OnFocusChangedListener,
        BaseMapFragment.OnProgressBarChangedListener,
        ArrivalsListFragment.Listener, NavigationDrawerCallbacks,
        ObaRegionsTask.Callback {

    interface SlidingPanelController {

        /**
         * Sets the height of the sliding panel in pixels
         *
         * @param heightInPixels height of panel in pixels
         */
        void setPanelHeightPixels(int heightInPixels);

        /**
         * Returns the current height of the sliding panel in pixels, or -1 if the panel isn't yet
         * initialized
         *
         * @return the current height of the sliding panel in pixels, or -1 if the panel isn't yet
         * initialized
         */
        int getPanelHeightPixels();
    }

    public static final String TWITTER_URL = &quot;http://mobile.twitter.com/onebusaway&quot;;

    private static final String WHATS_NEW_VER = &quot;whatsNewVer&quot;;

    private static final String CHECK_REGION_VER = &quot;checkRegionVer&quot;;

    private static final int HELP_DIALOG = 1;

    private static final int WHATSNEW_DIALOG = 2;

    private static final int LEGEND_DIALOG = 3;

    //One week, in milliseconds
    private static final long REGION_UPDATE_THRESHOLD = 1000 * 60 * 60 * 24 * 7;

    private static final String TAG = &quot;HomeActivity&quot;;

    WeakReference&lt;AppCompatActivity&gt; mActivityWeakRef;

    ArrivalsListFragment mArrivalsListFragment;

    ArrivalsListHeader mArrivalsListHeader;

    View mArrivalsListHeaderView;

    View mArrivalsListHeaderSubView;

    private FloatingActionButton mFabMyLocation;

    uk.co.markormesher.android_fab.FloatingActionButton mLayersFab;

    private static int MY_LOC_DEFAULT_BOTTOM_MARGIN;

    private static int LAYERS_FAB_DEFAULT_BOTTOM_MARGIN;

    private static final int MY_LOC_BTN_ANIM_DURATION = 100;  // ms

    Animation mMyLocationAnimation;

    /**
     * GoogleApiClient being used for Location Services
     */
    protected GoogleApiClient mGoogleApiClient;

    // Bottom Sliding panel
    SlidingUpPanelLayout mSlidingPanel;

    public static final int BATTERY_OPTIMIZATIONS_PERMISSION_REQUEST = 111;

    /**
     * Fragment managing the behaviors, interactions and presentation of the navigation drawer.
     */
    private NavigationDrawerFragment mNavigationDrawerFragment;

    /**
     * Currently selected navigation drawer position (so we don't unnecessarily swap fragments
     * if the same item is selected).  Initialized to -1 so the initial callback from
     * NavigationDrawerFragment always instantiates the fragments
     */
<span class="nc" id="L212">    private int mCurrentNavDrawerPosition = -1;</span>

    /**
     * Fragments that can be selected as main content via the NavigationDrawer
     */
    MyStarredStopsFragment mMyStarredStopsFragment;
    MyStarredRoutesFragment mMyStarredRoutesFragment;

    BaseMapFragment mMapFragment;

    MyRemindersFragment mMyRemindersFragment;

    /**
     * Control which menu options are shown per fragment menu groups
     */
<span class="nc" id="L227">    private boolean mShowStarredStopsMenu = false;</span>

<span class="nc" id="L229">    private boolean mShowStarredRoutesMenu = false;</span>

<span class="nc" id="L231">    private boolean mShowArrivalsMenu = false;</span>

    /**
     * Stop that has current focus on the map.  We retain a reference to the StopId,
     * since during rapid rotations its possible that a reference to a ObaStop object in
     * mFocusedStop can still be null, and we don't want to lose the state of which stopId is in
     * focus.  We also need access to the focused stop properties, hence why we also have
     * mFocusedStop
     */
<span class="nc" id="L240">    String mFocusedStopId = null;</span>

    /**
     * Bike rental station ID that has the focus currently.
     */
<span class="nc" id="L245">    String mBikeRentalStationId = null;</span>

<span class="nc" id="L247">    ObaStop mFocusedStop = null;</span>

<span class="nc" id="L249">    ImageView mExpandCollapse = null;</span>

<span class="nc" id="L251">    ProgressBar mMapProgressBar = null;</span>

<span class="nc" id="L253">    boolean mLastMapProgressBarState = true;</span>

    private static final String INITIAL_STARTUP = &quot;initialStartup&quot;;

<span class="nc" id="L257">    boolean mInitialStartup = true;</span>

    private FirebaseAnalytics mFirebaseAnalytics;

    private ActivityResultLauncher&lt;String&gt; travelBehaviorPermissionsLauncher;

    /**
     * Starts the MapActivity with a particular stop focused with the center of
     * the map at a particular point.
     *
     * @param context The context of the activity.
     * @param focusId The stop to focus.
     * @param lat     The latitude of the map center.
     * @param lon     The longitude of the map center.
     */
    public static void start(Context context,
                             String focusId,
                             double lat,
                             double lon) {
<span class="nc" id="L276">        context.startActivity(makeIntent(context, focusId, lat, lon));</span>
<span class="nc" id="L277">    }</span>

    /**
     * Starts the MapActivity with a particular stop focused with the center of
     * the map at a particular point.
     *
     * @param context The context of the activity.
     * @param stop    The stop to focus on.
     */
    public static void start(Context context, ObaStop stop) {
<span class="nc" id="L287">        context.startActivity(makeIntent(context, stop));</span>
<span class="nc" id="L288">    }</span>

    /**
     * Starts the MapActivity in &quot;RouteMode&quot;, which shows stops along a route,
     * and does not get new stops when the user pans the map.
     *
     * @param context The context of the activity.
     * @param routeId The route to show.
     */
    public static void start(Context context, String routeId) {
<span class="nc" id="L298">        context.startActivity(makeIntent(context, routeId));</span>
<span class="nc" id="L299">    }</span>

    /**
     * Returns an intent that will start the MapActivity with a particular stop
     * focused with the center of the map at a particular point.
     *
     * @param context The context of the activity.
     * @param focusId The stop to focus.
     * @param lat     The latitude of the map center.
     * @param lon     The longitude of the map center.
     */
    public static Intent makeIntent(Context context,
                                    String focusId,
                                    double lat,
                                    double lon) {
<span class="nc" id="L314">        Intent myIntent = new Intent(context, HomeActivity.class);</span>
<span class="nc" id="L315">        myIntent.putExtra(MapParams.STOP_ID, focusId);</span>
<span class="nc" id="L316">        myIntent.putExtra(MapParams.CENTER_LAT, lat);</span>
<span class="nc" id="L317">        myIntent.putExtra(MapParams.CENTER_LON, lon);</span>
<span class="nc" id="L318">        return myIntent;</span>
    }

    /**
     * Returns an intent that will start the MapActivity with a particular stop
     * focused with the center of the map at a particular point.
     *
     * @param context The context of the activity.
     * @param stop    The stop to focus on.
     */
    public static Intent makeIntent(Context context, ObaStop stop) {
<span class="nc" id="L329">        Intent myIntent = new Intent(context, HomeActivity.class);</span>
<span class="nc" id="L330">        myIntent.putExtra(MapParams.STOP_ID, stop.getId());</span>
<span class="nc" id="L331">        myIntent.putExtra(MapParams.STOP_NAME, stop.getName());</span>
<span class="nc" id="L332">        myIntent.putExtra(MapParams.STOP_CODE, stop.getStopCode());</span>
<span class="nc" id="L333">        myIntent.putExtra(MapParams.CENTER_LAT, stop.getLatitude());</span>
<span class="nc" id="L334">        myIntent.putExtra(MapParams.CENTER_LON, stop.getLongitude());</span>
<span class="nc" id="L335">        return myIntent;</span>
    }

    /**
     * Returns an intent that starts the MapActivity in &quot;RouteMode&quot;, which shows
     * stops along a route, and does not get new stops when the user pans the
     * map.
     *
     * @param context The context of the activity.
     * @param routeId The route to show.
     */
    public static Intent makeIntent(Context context, String routeId) {
<span class="nc" id="L347">        Intent myIntent = new Intent(context, HomeActivity.class);</span>
<span class="nc" id="L348">        myIntent.putExtra(MapParams.MODE, MapParams.MODE_ROUTE);</span>
<span class="nc" id="L349">        myIntent.putExtra(MapParams.ZOOM_TO_ROUTE, true);</span>
<span class="nc" id="L350">        myIntent.putExtra(MapParams.ROUTE_ID, routeId);</span>
<span class="nc" id="L351">        return myIntent;</span>
    }

    SlidingPanelController mSlidingPanelController;

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L358">        requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);</span>
<span class="nc" id="L359">        super.onCreate(savedInstanceState);</span>

<span class="nc" id="L361">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(this);</span>

<span class="nc" id="L363">        setContentView(R.layout.main);</span>

<span class="nc" id="L365">        mActivityWeakRef = new WeakReference&lt;&gt;(this);</span>

<span class="nc" id="L367">        mInitialStartup = Application.getPrefs().getBoolean(INITIAL_STARTUP, true);</span>

<span class="nc" id="L369">        setupNavigationDrawer();</span>

<span class="nc" id="L371">        setupSlidingPanel();</span>

<span class="nc" id="L373">        setupMapState(savedInstanceState);</span>

<span class="nc" id="L375">        setupLayersSpeedDial();</span>

<span class="nc" id="L377">        setupMyLocationButton();</span>

<span class="nc" id="L379">        setupZoomButtons();</span>

<span class="nc" id="L381">        setupGooglePlayServices();</span>

<span class="nc" id="L383">        setupPermissions(this);</span>

<span class="nc" id="L385">        UIUtils.setupActionBar(this);</span>

        // To enable checkBatteryOptimizations, also uncomment the
        // REQUEST_IGNORE_BATTERY_OPTIMIZATIONS permission in AndroidManifest.xml
        // See https://github.com/OneBusAway/onebusaway-android/pull/988#discussion_r299950506
//        checkBatteryOptimizations();

<span class="nc" id="L392">        new TravelBehaviorManager(this, getApplicationContext()).</span>
<span class="nc" id="L393">                registerTravelBehaviorParticipant();</span>

<span class="nc bnc" id="L395" title="All 4 branches missed.">        if (!mInitialStartup || PermissionUtils.hasGrantedAtLeastOnePermission(this, LOCATION_PERMISSIONS)) {</span>
            // It's not the first startup or if the user has already granted location permissions (Android L and lower), then check the region status
            // Otherwise, wait for a permission callback from the BaseMapFragment before checking the region status
<span class="nc" id="L398">            checkRegionStatus();</span>
        }

        // Check to see if we should show the welcome tutorial
<span class="nc" id="L402">        Bundle b = getIntent().getExtras();</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (b != null) {</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (b.getBoolean(ShowcaseViewUtils.TUTORIAL_WELCOME)) {</span>
                // Show the welcome tutorial
<span class="nc" id="L406">                ShowcaseViewUtils.showTutorial(ShowcaseViewUtils.TUTORIAL_WELCOME, this, null, false);</span>
            }
        }
<span class="nc" id="L409">    }</span>

    @Override
    public void onStart() {
<span class="nc" id="L413">        super.onStart();</span>
        // Make sure GoogleApiClient is connected, if available
<span class="nc bnc" id="L415" title="All 4 branches missed.">        if (mGoogleApiClient != null &amp;&amp; !mGoogleApiClient.isConnected()) {</span>
<span class="nc" id="L416">            mGoogleApiClient.connect();</span>
        }
<span class="nc" id="L418">        AccessibilityManager am = (AccessibilityManager) getSystemService(ACCESSIBILITY_SERVICE);</span>
<span class="nc" id="L419">        Boolean isTalkBackEnabled = am.isTouchExplorationEnabled();</span>
<span class="nc" id="L420">        ObaAnalytics.setAccessibility(mFirebaseAnalytics, isTalkBackEnabled);</span>
<span class="nc" id="L421">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L425">        super.onResume();</span>

        // Make sure header has sliding panel state
<span class="nc bnc" id="L428" title="All 4 branches missed.">        if (mArrivalsListHeader != null &amp;&amp; mSlidingPanel != null) {</span>
<span class="nc" id="L429">            mArrivalsListHeader.setSlidingPanelCollapsed(isSlidingPanelCollapsed());</span>
        }

        // Check if the map zoom controls should be displayed
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (mCurrentNavDrawerPosition == NAVDRAWER_ITEM_NEARBY) {</span>
<span class="nc" id="L434">            checkDisplayZoomControls();</span>
        } else {
<span class="nc" id="L436">            showZoomControls(false);</span>
        }
<span class="nc" id="L438">        checkLeftHandMode();</span>
<span class="nc" id="L439">        updateLayersFab();</span>

<span class="nc" id="L441">        mFabMyLocation.requestLayout();</span>
<span class="nc" id="L442">    }</span>

    @Override
    protected void onPause() {
<span class="nc" id="L446">        ShowcaseViewUtils.hideShowcaseView();</span>
<span class="nc" id="L447">        super.onPause();</span>
<span class="nc" id="L448">    }</span>

    @Override
    public void onStop() {
        // Tear down GoogleApiClient
<span class="nc bnc" id="L453" title="All 4 branches missed.">        if (mGoogleApiClient != null &amp;&amp; mGoogleApiClient.isConnected()) {</span>
<span class="nc" id="L454">            mGoogleApiClient.disconnect();</span>
        }
<span class="nc" id="L456">        mLayersFab.closeSpeedDialMenu();</span>
<span class="nc" id="L457">        super.onStop();</span>
<span class="nc" id="L458">    }</span>

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L462">        super.onSaveInstanceState(outState);</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (mFocusedStopId != null) {</span>
<span class="nc" id="L464">            outState.putString(MapParams.STOP_ID, mFocusedStopId);</span>

<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (mFocusedStop != null) {</span>
<span class="nc" id="L467">                outState.putString(MapParams.STOP_CODE, mFocusedStop.getStopCode());</span>
<span class="nc" id="L468">                outState.putString(MapParams.STOP_NAME, mFocusedStop.getName());</span>
            }
        }
<span class="nc bnc" id="L471" title="All 2 branches missed.">        if (mBikeRentalStationId != null) {</span>
<span class="nc" id="L472">            outState.putString(MapParams.BIKE_STATION_ID, mBikeRentalStationId);</span>
        }
<span class="nc" id="L474">    }</span>

    @Override
    public void onNavigationDrawerItemSelected(int position) {
<span class="nc" id="L478">        goToNavDrawerItem(position);</span>
<span class="nc" id="L479">    }</span>

    private void goToNavDrawerItem(int item) {
        // Update the main content by replacing fragments
<span class="nc bnc" id="L483" title="All 11 branches missed.">        switch (item) {</span>
            case NAVDRAWER_ITEM_STARRED_STOPS:
<span class="nc bnc" id="L485" title="All 2 branches missed.">                if (mCurrentNavDrawerPosition != NAVDRAWER_ITEM_STARRED_STOPS) {</span>
<span class="nc" id="L486">                    showStarredStopsFragment();</span>
<span class="nc" id="L487">                    mCurrentNavDrawerPosition = item;</span>
<span class="nc" id="L488">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L489">                            getString(R.string.analytics_label_button_press_star),</span>
                            null);
                }
                break;
            case NAVDRAWER_ITEM_STARRED_ROUTES:
<span class="nc bnc" id="L494" title="All 2 branches missed.">                if (mCurrentNavDrawerPosition != NAVDRAWER_ITEM_STARRED_ROUTES) {</span>
<span class="nc" id="L495">                    showStarredRoutesFragment();</span>
<span class="nc" id="L496">                    mCurrentNavDrawerPosition = item;</span>
<span class="nc" id="L497">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L498">                            getString(R.string.analytics_label_button_press_star),</span>
                            null);
                }
                break;
            // below values are deprecated; fall through to NAVDRAWER_ITEM_NEARBY
            case NAVDRAWER_ITEM_SIGN_IN:
            case NAVDRAWER_ITEM_PROFILE:
            case NAVDRAWER_ITEM_PINS:
            case NAVDRAWER_ITEM_ACTIVITY_FEED:
            case NAVDRAWER_ITEM_NEARBY:
<span class="nc bnc" id="L508" title="All 2 branches missed.">                if (mCurrentNavDrawerPosition != NAVDRAWER_ITEM_NEARBY) {</span>
<span class="nc" id="L509">                    showMapFragment();</span>
<span class="nc" id="L510">                    mCurrentNavDrawerPosition = NAVDRAWER_ITEM_NEARBY;</span>
<span class="nc" id="L511">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L512">                            getString(R.string.analytics_label_button_press_nearby),</span>
                            null);
                }
                break;
            case NAVDRAWER_ITEM_MY_REMINDERS:
<span class="nc bnc" id="L517" title="All 2 branches missed.">                if (mCurrentNavDrawerPosition != NAVDRAWER_ITEM_MY_REMINDERS) {</span>
<span class="nc" id="L518">                    showMyRemindersFragment();</span>
<span class="nc" id="L519">                    mCurrentNavDrawerPosition = item;</span>
<span class="nc" id="L520">                    ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L521">                            getString(R.string.analytics_label_button_press_reminders),</span>
                            null);
                }
                break;
            case NAVDRAWER_ITEM_PLAN_TRIP:
<span class="nc" id="L526">                Intent planTrip = new Intent(HomeActivity.this, TripPlanActivity.class);</span>
<span class="nc" id="L527">                startActivity(planTrip);</span>
<span class="nc" id="L528">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L529">                        getString(R.string.analytics_label_button_press_trip_plan),</span>
                        null);
<span class="nc" id="L531">                break;</span>
            case NAVDRAWER_ITEM_PAY_FARE:
<span class="nc" id="L533">                UIUtils.launchPayMyFareApp(this);</span>
<span class="nc" id="L534">                break;</span>
            case NAVDRAWER_ITEM_SETTINGS:
<span class="nc" id="L536">                Intent preferences = new Intent(HomeActivity.this, PreferencesActivity.class);</span>
<span class="nc" id="L537">                startActivity(preferences);</span>
<span class="nc" id="L538">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L539">                        getString(R.string.analytics_label_button_press_settings),</span>
                        null);
<span class="nc" id="L541">                break;</span>
            case NAVDRAWER_ITEM_HELP:
<span class="nc" id="L543">                showDialog(HELP_DIALOG);</span>
<span class="nc" id="L544">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L545">                        getString(R.string.analytics_label_button_press_help),</span>
                        null);
<span class="nc" id="L547">                break;</span>
            case NAVDRAWER_ITEM_SEND_FEEDBACK:
<span class="nc" id="L549">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L550">                        getString(R.string.analytics_label_button_press_feedback),</span>
                        null);
<span class="nc" id="L552">                goToSendFeedBack();</span>
<span class="nc" id="L553">                break;</span>
            case NAVDRAWER_ITEM_OPEN_SOURCE:
<span class="nc" id="L555">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L556">                        getString(R.string.analytics_label_button_press_open_source),</span>
                        null);
<span class="nc" id="L558">                Intent i = new Intent(Intent.ACTION_VIEW);</span>
<span class="nc" id="L559">                i.setData(Uri.parse(getString(R.string.open_source_github)));</span>
<span class="nc" id="L560">                startActivity(i);</span>
                break;
        }
<span class="nc" id="L563">        invalidateOptionsMenu();</span>
<span class="nc" id="L564">    }</span>

    private void handleNearbySelection() {
<span class="nc" id="L567">    }</span>

    private void showMapFragment() {
<span class="nc" id="L570">        FragmentManager fm = getSupportFragmentManager();</span>
        /**
         * Hide everything that shouldn't be shown
         */
<span class="nc" id="L574">        hideStarredRoutesFragment();</span>
<span class="nc" id="L575">        hideStarredStopsFragment();</span>
<span class="nc" id="L576">        hideReminderFragment();</span>
<span class="nc" id="L577">        mShowStarredStopsMenu = false;</span>
        /**
         * Show fragment (we use show instead of replace to keep the map state)
         */
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (mMapFragment == null) {</span>
            // First check to see if an instance of BaseMapFragment already exists (see #356)
<span class="nc" id="L583">            mMapFragment = (BaseMapFragment) fm.findFragmentByTag(BaseMapFragment.TAG);</span>

<span class="nc bnc" id="L585" title="All 2 branches missed.">            if (mMapFragment == null) {</span>
                // No existing fragment was found, so create a new one
<span class="nc" id="L587">                Log.d(TAG, &quot;Creating new BaseMapFragment&quot;);</span>
<span class="nc" id="L588">                mMapFragment = BaseMapFragment.newInstance();</span>
<span class="nc" id="L589">                mMapFragment.setOnLocationPermissionResultListener(result -&gt; {</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">                            if (mInitialStartup) {</span>
                                // Whether or not the user granted permissions, check region status
                                // (they'll be asked to manually pick region if they denied)
<span class="nc" id="L593">                                mInitialStartup = false;</span>
<span class="nc" id="L594">                                PreferenceUtils.saveBoolean(INITIAL_STARTUP, false);</span>
<span class="nc" id="L595">                                checkRegionStatus();</span>
                            }
<span class="nc" id="L597">                        });</span>
<span class="nc" id="L598">                fm.beginTransaction()</span>
<span class="nc" id="L599">                        .add(R.id.main_fragment_container, mMapFragment, BaseMapFragment.TAG)</span>
<span class="nc" id="L600">                        .commit();</span>
            }
        }

        // Register listener for map focus callbacks
<span class="nc" id="L605">        mMapFragment.setOnFocusChangeListener(this);</span>
<span class="nc" id="L606">        mMapFragment.setOnProgressBarChangedListener(this);</span>

<span class="nc" id="L608">        getSupportFragmentManager().beginTransaction().show(mMapFragment).commit();</span>

<span class="nc" id="L610">        showFloatingActionButtons();</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (mLastMapProgressBarState) {</span>
<span class="nc" id="L612">            showMapProgressBar();</span>
        }
<span class="nc" id="L614">        mShowArrivalsMenu = true;</span>
<span class="nc bnc" id="L615" title="All 4 branches missed.">        if (mFocusedStopId != null &amp;&amp; mSlidingPanel != null) {</span>
            // if we've focused on a stop, then show the panel that was previously hidden
<span class="nc" id="L617">            mSlidingPanel.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);</span>
        }
<span class="nc" id="L619">        setTitle(getResources().getString(R.string.navdrawer_item_nearby));</span>

<span class="nc" id="L621">        checkDisplayZoomControls();</span>
<span class="nc" id="L622">    }</span>

    private void showStarredStopsFragment() {
<span class="nc" id="L625">        FragmentManager fm = getSupportFragmentManager();</span>
        /**
         * Hide everything that shouldn't be shown
         */
<span class="nc" id="L629">        hideFloatingActionButtons();</span>
<span class="nc" id="L630">        hideMapProgressBar();</span>
<span class="nc" id="L631">        hideMapFragment();</span>
<span class="nc" id="L632">        hideReminderFragment();</span>
<span class="nc" id="L633">        hideStarredRoutesFragment();</span>
<span class="nc" id="L634">        hideSlidingPanel();</span>
<span class="nc" id="L635">        mShowArrivalsMenu = false;</span>
<span class="nc" id="L636">        showZoomControls(false);</span>

        /**
         * Show fragment (we use show instead of replace to keep the map state)
         */
<span class="nc" id="L641">        mShowStarredStopsMenu = true;</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">        if (mMyStarredStopsFragment == null) {</span>
            // First check to see if an instance of MyStarredStopsFragment already exists (see #356)
<span class="nc" id="L644">            mMyStarredStopsFragment = (MyStarredStopsFragment) fm</span>
<span class="nc" id="L645">                    .findFragmentByTag(MyStarredStopsFragment.TAG);</span>

<span class="nc bnc" id="L647" title="All 2 branches missed.">            if (mMyStarredStopsFragment == null) {</span>
                // No existing fragment was found, so create a new one
<span class="nc" id="L649">                Log.d(TAG, &quot;Creating new MyStarredStopsFragment&quot;);</span>
<span class="nc" id="L650">                mMyStarredStopsFragment = new MyStarredStopsFragment();</span>
<span class="nc" id="L651">                fm.beginTransaction().add(R.id.main_fragment_container, mMyStarredStopsFragment,</span>
<span class="nc" id="L652">                        MyStarredStopsFragment.TAG).commit();</span>
            }
        }
<span class="nc" id="L655">        fm.beginTransaction().show(mMyStarredStopsFragment).commit();</span>
<span class="nc" id="L656">        setTitle(getResources().getString(R.string.navdrawer_item_starred_stops));</span>
<span class="nc" id="L657">    }</span>

    private void showStarredRoutesFragment() {
<span class="nc" id="L660">        FragmentManager fm = getSupportFragmentManager();</span>
        /**
         * Hide everything that shouldn't be shown
         */
<span class="nc" id="L664">        hideFloatingActionButtons();</span>
<span class="nc" id="L665">        hideMapProgressBar();</span>
<span class="nc" id="L666">        hideMapFragment();</span>
<span class="nc" id="L667">        hideReminderFragment();</span>
<span class="nc" id="L668">        hideSlidingPanel();</span>
<span class="nc" id="L669">        hideStarredStopsFragment();</span>
<span class="nc" id="L670">        mShowArrivalsMenu = false;</span>
<span class="nc" id="L671">        showZoomControls(false);</span>

        /**
         * Show fragment (we use show instead of replace to keep the map state)
         */
<span class="nc" id="L676">        mShowStarredRoutesMenu = true;</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (mMyStarredRoutesFragment == null) {</span>
            // First check to see if an instance of MyStarredRoutesFragment already exists
<span class="nc" id="L679">            mMyStarredRoutesFragment = (MyStarredRoutesFragment) fm</span>
<span class="nc" id="L680">                    .findFragmentByTag(MyStarredRoutesFragment.TAG);</span>

<span class="nc bnc" id="L682" title="All 2 branches missed.">            if (mMyStarredRoutesFragment == null) {</span>
                // No existing fragment was found, so create a new one
<span class="nc" id="L684">                Log.d(TAG, &quot;Creating new MyStarredRoutesFragment&quot;);</span>
<span class="nc" id="L685">                mMyStarredRoutesFragment = new MyStarredRoutesFragment();</span>
<span class="nc" id="L686">                fm.beginTransaction().add(R.id.main_fragment_container, mMyStarredRoutesFragment,</span>
<span class="nc" id="L687">                        MyStarredRoutesFragment.TAG).commit();</span>
            }
        }
<span class="nc" id="L690">        fm.beginTransaction().show(mMyStarredRoutesFragment).commit();</span>
<span class="nc" id="L691">        setTitle(getResources().getString(R.string.navdrawer_item_starred_routes));</span>
<span class="nc" id="L692">    }</span>

    private void showMyRemindersFragment() {
<span class="nc" id="L695">        FragmentManager fm = getSupportFragmentManager();</span>
        /**
         * Hide everything that shouldn't be shown
         */
<span class="nc" id="L699">        hideFloatingActionButtons();</span>
<span class="nc" id="L700">        hideMapProgressBar();</span>
<span class="nc" id="L701">        hideStarredRoutesFragment();</span>
<span class="nc" id="L702">        hideStarredStopsFragment();</span>
<span class="nc" id="L703">        hideMapFragment();</span>
<span class="nc" id="L704">        hideSlidingPanel();</span>
<span class="nc" id="L705">        mShowArrivalsMenu = false;</span>
<span class="nc" id="L706">        mShowStarredStopsMenu = false;</span>
<span class="nc" id="L707">        showZoomControls(false);</span>
        /**
         * Show fragment (we use show instead of replace to keep the map state)
         */
<span class="nc bnc" id="L711" title="All 2 branches missed.">        if (mMyRemindersFragment == null) {</span>
            // First check to see if an instance of MyRemindersFragment already exists (see #356)
<span class="nc" id="L713">            mMyRemindersFragment = (MyRemindersFragment) fm</span>
<span class="nc" id="L714">                    .findFragmentByTag(MyRemindersFragment.TAG);</span>

<span class="nc bnc" id="L716" title="All 2 branches missed.">            if (mMyRemindersFragment == null) {</span>
                // No existing fragment was found, so create a new one
<span class="nc" id="L718">                Log.d(TAG, &quot;Creating new MyRemindersFragment&quot;);</span>
<span class="nc" id="L719">                mMyRemindersFragment = new MyRemindersFragment();</span>
<span class="nc" id="L720">                fm.beginTransaction().add(R.id.main_fragment_container, mMyRemindersFragment,</span>
<span class="nc" id="L721">                        MyRemindersFragment.TAG).commit();</span>
            }
        }
<span class="nc" id="L724">        fm.beginTransaction().show(mMyRemindersFragment).commit();</span>
<span class="nc" id="L725">        setTitle(getResources().getString(R.string.navdrawer_item_my_reminders));</span>
<span class="nc" id="L726">    }</span>

    private void hideMapFragment() {
<span class="nc" id="L729">        FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L730">        mMapFragment = (BaseMapFragment) fm.findFragmentByTag(BaseMapFragment.TAG);</span>
<span class="nc bnc" id="L731" title="All 4 branches missed.">        if (mMapFragment != null &amp;&amp; !mMapFragment.isHidden()) {</span>
<span class="nc" id="L732">            fm.beginTransaction().hide(mMapFragment).commit();</span>
        }
<span class="nc" id="L734">    }</span>

    private void hideStarredStopsFragment() {
<span class="nc" id="L737">        FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L738">        mMyStarredStopsFragment = (MyStarredStopsFragment) fm.findFragmentByTag(</span>
                MyStarredStopsFragment.TAG);
<span class="nc bnc" id="L740" title="All 4 branches missed.">        if (mMyStarredStopsFragment != null &amp;&amp; !mMyStarredStopsFragment.isHidden()) {</span>
<span class="nc" id="L741">            fm.beginTransaction().hide(mMyStarredStopsFragment).commit();</span>
        }
<span class="nc" id="L743">    }</span>

    private void hideStarredRoutesFragment() {
<span class="nc" id="L746">        FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L747">        mMyStarredRoutesFragment = (MyStarredRoutesFragment) fm.findFragmentByTag(</span>
                MyStarredRoutesFragment.TAG);
<span class="nc bnc" id="L749" title="All 4 branches missed.">        if (mMyStarredRoutesFragment != null &amp;&amp; !mMyStarredRoutesFragment.isHidden()) {</span>
<span class="nc" id="L750">            fm.beginTransaction().hide(mMyStarredRoutesFragment).commit();</span>
        }
<span class="nc" id="L752">    }</span>

    private void hideReminderFragment() {
<span class="nc" id="L755">        FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L756">        mMyRemindersFragment = (MyRemindersFragment) fm</span>
<span class="nc" id="L757">                .findFragmentByTag(MyRemindersFragment.TAG);</span>
<span class="nc bnc" id="L758" title="All 4 branches missed.">        if (mMyRemindersFragment != null &amp;&amp; !mMyRemindersFragment.isHidden()) {</span>
<span class="nc" id="L759">            fm.beginTransaction().hide(mMyRemindersFragment).commit();</span>
        }
<span class="nc" id="L761">    }</span>

    private void hideSlidingPanel() {
<span class="nc bnc" id="L764" title="All 2 branches missed.">        if (mSlidingPanel != null) {</span>
<span class="nc" id="L765">            mSlidingPanel.setPanelState(SlidingUpPanelLayout.PanelState.HIDDEN);</span>
        }
<span class="nc" id="L767">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L771">        getMenuInflater().inflate(R.menu.main_options, menu);</span>

<span class="nc" id="L773">        UIUtils.setupSearch(this, menu);</span>

        // Initialize fragment menu visibility here, so we don't have overlap between the various fragments
<span class="nc" id="L776">        setupOptionsMenu(menu);</span>

<span class="nc" id="L778">        return super.onCreateOptionsMenu(menu);</span>
    }

    @Override
    public boolean onPrepareOptionsMenu(Menu menu) {
<span class="nc" id="L783">        super.onPrepareOptionsMenu(menu);</span>

        // Manage fragment menu visibility here, so we don't have overlap between the various fragments
<span class="nc" id="L786">        setupOptionsMenu(menu);</span>

<span class="nc" id="L788">        return true;</span>
    }

    private void setupOptionsMenu(Menu menu) {
<span class="nc" id="L792">        menu.setGroupVisible(R.id.main_options_menu_group, true);</span>
<span class="nc" id="L793">        menu.setGroupVisible(R.id.arrival_list_menu_group, mShowArrivalsMenu);</span>
<span class="nc" id="L794">        menu.setGroupVisible(R.id.starred_stop_menu_group, mShowStarredStopsMenu);</span>
<span class="nc" id="L795">        menu.setGroupVisible(R.id.starred_route_menu_group, mShowStarredRoutesMenu);</span>
<span class="nc" id="L796">    }</span>

    @Override
    @SuppressWarnings(&quot;deprecation&quot;)
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc" id="L801">        Log.d(TAG, &quot;onOptionsItemSelected&quot;);</span>
<span class="nc" id="L802">        final int id = item.getItemId();</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">        if (id == R.id.search) {</span>
<span class="nc" id="L804">            onSearchRequested();</span>
<span class="nc" id="L805">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L806">                    getString(R.string.analytics_label_button_press_search_box),</span>
                    null);
<span class="nc" id="L808">            return true;</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">        } else if (id == R.id.recent_stops_routes) {</span>
<span class="nc" id="L810">            ShowcaseViewUtils.doNotShowTutorial(ShowcaseViewUtils.TUTORIAL_RECENT_STOPS_ROUTES);</span>
<span class="nc" id="L811">            Intent myIntent = new Intent(this, MyRecentStopsAndRoutesActivity.class);</span>
<span class="nc" id="L812">            startActivity(myIntent);</span>
<span class="nc" id="L813">            return true;</span>
        }
<span class="nc" id="L815">        return super.onOptionsItemSelected(item);</span>
    }

    @Override
    protected Dialog onCreateDialog(int id) {
<span class="nc bnc" id="L820" title="All 4 branches missed.">        switch (id) {</span>
            case HELP_DIALOG:
<span class="nc" id="L822">                return createHelpDialog();</span>

            case WHATSNEW_DIALOG:
<span class="nc" id="L825">                return createWhatsNewDialog();</span>

            case LEGEND_DIALOG:
<span class="nc" id="L828">                return createLegendDialog();</span>
        }
<span class="nc" id="L830">        return super.onCreateDialog(id);</span>
    }

    @SuppressWarnings(&quot;deprecation&quot;)
    private Dialog createHelpDialog() {
<span class="nc" id="L835">        AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc" id="L836">        builder.setTitle(R.string.main_help_title);</span>
        // If a custom API URL is set, hide Contact Us, as we don't have a contact email to use
        int options;
<span class="nc bnc" id="L839" title="All 2 branches missed.">        if (TextUtils.isEmpty(Application.get().getCustomApiUrl())) {</span>
<span class="nc" id="L840">            options = R.array.main_help_options;</span>
        } else {
            // Hide &quot;Contact Us&quot;
<span class="nc" id="L843">            options = R.array.main_help_options_no_contact_us;</span>
        }
<span class="nc" id="L845">        builder.setItems(options,</span>
<span class="nc" id="L846">                new DialogInterface.OnClickListener() {</span>
                    public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L848" title="All 7 branches missed.">                        switch (which) {</span>
                            case 0:
<span class="nc" id="L850">                                ShowcaseViewUtils.resetAllTutorials(HomeActivity.this);</span>
<span class="nc" id="L851">                                NavHelp.goHome(HomeActivity.this, true);</span>
<span class="nc" id="L852">                                break;</span>
                            case 1:
<span class="nc" id="L854">                                showDialog(LEGEND_DIALOG);</span>
<span class="nc" id="L855">                                break;</span>
                            case 2:
<span class="nc" id="L857">                                showDialog(WHATSNEW_DIALOG);</span>
<span class="nc" id="L858">                                break;</span>
                            case 3:
<span class="nc" id="L860">                                AgenciesActivity.start(HomeActivity.this);</span>
<span class="nc" id="L861">                                break;</span>
                            case 4:
<span class="nc" id="L863">                                String twitterUrl = TWITTER_URL;</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">                                if (Application.get().getCurrentRegion() != null &amp;&amp;</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">                                        !TextUtils.isEmpty(Application.get().getCurrentRegion()</span>
<span class="nc" id="L866">                                                .getTwitterUrl())) {</span>
<span class="nc" id="L867">                                    twitterUrl = Application.get().getCurrentRegion()</span>
<span class="nc" id="L868">                                            .getTwitterUrl();</span>
                                }
<span class="nc" id="L870">                                UIUtils.goToUrl(HomeActivity.this, twitterUrl);</span>
<span class="nc" id="L871">                                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L872">                                        getString(R.string.analytics_label_twitter),</span>
                                        null);
<span class="nc" id="L874">                                break;</span>
                            case 5:
                                // Contact us
<span class="nc" id="L877">                                goToSendFeedBack();</span>
                                break;
                        }
<span class="nc" id="L880">                    }</span>
                }
        );
<span class="nc" id="L883">        return builder.create();</span>
    }

    @SuppressWarnings(&quot;deprecation&quot;)
    private Dialog createWhatsNewDialog() {
<span class="nc" id="L888">        TextView textView = (TextView) getLayoutInflater().inflate(R.layout.whats_new_dialog, null);</span>
<span class="nc" id="L889">        textView.setText(R.string.main_help_whatsnew);</span>

<span class="nc" id="L891">        AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc" id="L892">        builder.setTitle(R.string.main_help_whatsnew_title);</span>
<span class="nc" id="L893">        builder.setIcon(R.mipmap.ic_launcher);</span>
<span class="nc" id="L894">        builder.setView(textView);</span>
<span class="nc" id="L895">        builder.setNeutralButton(R.string.main_help_close,</span>
<span class="nc" id="L896">                (dialog, which) -&gt; dismissDialog(WHATSNEW_DIALOG)</span>
        );
<span class="nc" id="L898">        builder.setOnDismissListener(new DialogInterface.OnDismissListener() {</span>
            @Override
            public void onDismiss(DialogInterface dialog) {
<span class="nc" id="L901">                boolean showOptOut = Application.getPrefs()</span>
<span class="nc" id="L902">                        .getBoolean(ShowcaseViewUtils.TUTORIAL_OPT_OUT_DIALOG, true);</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">                if (showOptOut) {</span>
<span class="nc" id="L904">                    ShowcaseViewUtils.showOptOutDialog(HomeActivity.this);</span>
                }
<span class="nc" id="L906">            }</span>
        });
<span class="nc" id="L908">        return builder.create();</span>
    }

    @SuppressWarnings(&quot;deprecation&quot;)
    private Dialog createLegendDialog() {
<span class="nc" id="L913">        AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc" id="L914">        builder.setTitle(R.string.main_help_legend_title);</span>

<span class="nc" id="L916">        Resources resources = getResources();</span>
<span class="nc" id="L917">        LayoutInflater inflater = LayoutInflater.from(getApplicationContext());</span>
<span class="nc" id="L918">        View legendDialogView = inflater.inflate(R.layout.legend_dialog, null);</span>
<span class="nc" id="L919">        final float etaTextFontSize = 30;</span>

        // On time view
<span class="nc" id="L922">        View etaAndMin = legendDialogView.findViewById(R.id.eta_view_ontime);</span>
<span class="nc" id="L923">        GradientDrawable d1 = (GradientDrawable) etaAndMin.getBackground();</span>
<span class="nc" id="L924">        d1.setColor(resources.getColor(R.color.stop_info_ontime));</span>
<span class="nc" id="L925">        etaAndMin.findViewById(R.id.eta_realtime_indicator).setVisibility(View.VISIBLE);</span>
<span class="nc" id="L926">        TextView etaTextView = etaAndMin.findViewById(R.id.eta);</span>
<span class="nc" id="L927">        etaTextView.setTextSize(etaTextFontSize);</span>
<span class="nc" id="L928">        etaTextView.setText(&quot;5&quot;);</span>

        // Early View
<span class="nc" id="L931">        etaAndMin = legendDialogView.findViewById(R.id.eta_view_early);</span>
<span class="nc" id="L932">        d1 = (GradientDrawable) etaAndMin.getBackground();</span>
<span class="nc" id="L933">        d1.setColor(resources.getColor(R.color.stop_info_early));</span>
<span class="nc" id="L934">        etaAndMin.findViewById(R.id.eta_realtime_indicator).setVisibility(View.VISIBLE);</span>
<span class="nc" id="L935">        etaTextView = etaAndMin.findViewById(R.id.eta);</span>
<span class="nc" id="L936">        etaTextView.setTextSize(etaTextFontSize);</span>
<span class="nc" id="L937">        etaTextView.setText(&quot;5&quot;);</span>

        // Delayed View
<span class="nc" id="L940">        etaAndMin = legendDialogView.findViewById(R.id.eta_view_delayed);</span>
<span class="nc" id="L941">        d1 = (GradientDrawable) etaAndMin.getBackground();</span>
<span class="nc" id="L942">        d1.setColor(resources.getColor(R.color.stop_info_delayed));</span>
<span class="nc" id="L943">        etaAndMin.findViewById(R.id.eta_realtime_indicator).setVisibility(View.VISIBLE);</span>
<span class="nc" id="L944">        etaTextView = etaAndMin.findViewById(R.id.eta);</span>
<span class="nc" id="L945">        etaTextView.setTextSize(etaTextFontSize);</span>
<span class="nc" id="L946">        etaTextView.setText(&quot;5&quot;);</span>

        // Scheduled View
<span class="nc" id="L949">        etaAndMin = legendDialogView.findViewById(R.id.eta_view_scheduled);</span>
<span class="nc" id="L950">        d1 = (GradientDrawable) etaAndMin.getBackground();</span>
<span class="nc" id="L951">        d1.setColor(resources.getColor(R.color.stop_info_scheduled_time));</span>
<span class="nc" id="L952">        etaAndMin.findViewById(R.id.eta_realtime_indicator).setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L953">        etaTextView = etaAndMin.findViewById(R.id.eta);</span>
<span class="nc" id="L954">        etaTextView.setTextSize(etaTextFontSize);</span>
<span class="nc" id="L955">        etaTextView.setText(&quot;5&quot;);</span>

        // Canceled View
<span class="nc" id="L958">        etaAndMin = legendDialogView.findViewById(R.id.eta_view_canceled);</span>
<span class="nc" id="L959">        d1 = (GradientDrawable) etaAndMin.getBackground();</span>
<span class="nc" id="L960">        d1.setColor(resources.getColor(R.color.stop_info_scheduled_time));</span>
<span class="nc" id="L961">        etaAndMin.findViewById(R.id.eta_realtime_indicator).setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L962">        etaTextView = etaAndMin.findViewById(R.id.eta);</span>
<span class="nc" id="L963">        etaTextView.setTextSize(etaTextFontSize);</span>
<span class="nc" id="L964">        etaTextView.setText(&quot;5&quot;);</span>
<span class="nc" id="L965">        etaTextView.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>
<span class="nc" id="L966">        TextView etaMin = etaAndMin.findViewById(R.id.eta_min);</span>
<span class="nc" id="L967">        etaMin.setPaintFlags(Paint.STRIKE_THRU_TEXT_FLAG);</span>

<span class="nc" id="L969">        builder.setView(legendDialogView);</span>

<span class="nc" id="L971">        builder.setNeutralButton(R.string.main_help_close,</span>
<span class="nc" id="L972">                (dialog, which) -&gt; dismissDialog(LEGEND_DIALOG)</span>
        );
<span class="nc" id="L974">        return builder.create();</span>
    }

    /**
     * Show the &quot;What's New&quot; message if a new version was just installed
     *
     * @return true if a new version was just installed, false if not
     */
    @SuppressWarnings(&quot;deprecation&quot;)
    private boolean autoShowWhatsNew() {
<span class="nc" id="L984">        SharedPreferences settings = Application.getPrefs();</span>

        // Get the current app version.
<span class="nc" id="L987">        PackageManager pm = getPackageManager();</span>
<span class="nc" id="L988">        PackageInfo appInfo = null;</span>
        try {
<span class="nc" id="L990">            appInfo = pm.getPackageInfo(getPackageName(),</span>
                    PackageManager.GET_META_DATA);
<span class="nc" id="L992">        } catch (NameNotFoundException e) {</span>
            // Do nothing, perhaps we'll get to show it again? Or never.
<span class="nc" id="L994">            return false;</span>
<span class="nc" id="L995">        }</span>

<span class="nc" id="L997">        final int oldVer = settings.getInt(WHATS_NEW_VER, 0);</span>
<span class="nc" id="L998">        final int newVer = appInfo.versionCode;</span>

<span class="nc bnc" id="L1000" title="All 6 branches missed.">        if (oldVer &lt; newVer &amp;&amp; mActivityWeakRef.get() != null &amp;&amp; !mActivityWeakRef.get().isFinishing()) {</span>
<span class="nc" id="L1001">            mActivityWeakRef.get().showDialog(WHATSNEW_DIALOG);</span>

            // Updates will remove the alarms. This should put them back.
            // (Unfortunately I can't find a way to reschedule them without
            // having the app run again).
<span class="nc" id="L1006">            TripService.scheduleAll(this, true);</span>
<span class="nc" id="L1007">            PreferenceUtils.saveInt(WHATS_NEW_VER, appInfo.versionCode);</span>
<span class="nc" id="L1008">            return true;</span>
        }
<span class="nc" id="L1010">        return false;</span>
    }

    /**
     * Called by the BaseMapFragment when a stop obtains focus, or no stops have focus
     *
     * @param stop     the ObaStop that obtained focus, or null if no stop is in focus
     * @param routes   a HashMap of all route display names that serve this stop - key is routeId
     * @param location the user touch location on the map, or null if the focus was otherwise
     *                 cleared programmatically
     */
    @Override
    public void onFocusChanged(ObaStop stop, HashMap&lt;String, ObaRoute&gt; routes, Location location) {
        // Check to see if we're already focused on this same stop - if so, we shouldn't do anything
<span class="nc bnc" id="L1024" title="All 4 branches missed.">        if (mFocusedStopId != null &amp;&amp; stop != null &amp;&amp;</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">                mFocusedStopId.equalsIgnoreCase(stop.getId())) {</span>
<span class="nc" id="L1026">            return;</span>
        }
<span class="nc" id="L1028">        FragmentManager fm = getSupportFragmentManager();</span>
        // If the fragment's state has already been saved, then don't change the state (return)
<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (fm.isStateSaved()) {</span>
<span class="nc" id="L1031">            return;</span>
        }

<span class="nc" id="L1034">        mFocusedStop = stop;</span>

<span class="nc bnc" id="L1036" title="All 2 branches missed.">        if (stop != null) {</span>
<span class="nc" id="L1037">            mBikeRentalStationId = null;</span>
<span class="nc" id="L1038">            mFocusedStopId = stop.getId();</span>
            // A stop on the map was just tapped, show it in the sliding panel
<span class="nc" id="L1040">            updateArrivalListFragment(stop.getId(), stop.getName(), stop.getStopCode(), stop,</span>
                    routes);

<span class="nc" id="L1043">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1044">                    getString(R.string.analytics_label_button_press_map_icon),</span>
                    null);
        } else {
            // No stop is in focus (e.g., user tapped on the map), so hide the panel
            // and clear the currently focused stopId
<span class="nc" id="L1049">            mFocusedStopId = null;</span>
<span class="nc" id="L1050">            moveFabsLocation();</span>
<span class="nc" id="L1051">            mSlidingPanel.setPanelState(SlidingUpPanelLayout.PanelState.HIDDEN);</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">            if (mArrivalsListFragment != null) {</span>
<span class="nc" id="L1053">                fm.beginTransaction().remove(mArrivalsListFragment).commit();</span>
            }
<span class="nc" id="L1055">            mShowArrivalsMenu = false;</span>
        }
<span class="nc" id="L1057">    }</span>

    /**
     * Called from the BaseMapFragment when a BikeRentalStation is clicked.
     *
     * @param bikeRentalStation the bike rental station that was clicked.
     */
    @Override
    public void onFocusChanged(BikeRentalStation bikeRentalStation) {
<span class="nc" id="L1066">        Log.d(TAG, &quot;Bike Station Clicked on map&quot;);</span>

        // Check to see if we're already focused on this same bike rental station - if so, we shouldn't do anything
<span class="nc bnc" id="L1069" title="All 4 branches missed.">        if (mBikeRentalStationId != null &amp;&amp; bikeRentalStation != null &amp;&amp;</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">                mBikeRentalStationId.equalsIgnoreCase(bikeRentalStation.id)) {</span>
<span class="nc" id="L1071">            return;</span>
        }

<span class="nc bnc" id="L1074" title="All 2 branches missed.">        if (bikeRentalStation == null) {</span>
<span class="nc" id="L1075">            mBikeRentalStationId = null;</span>
        } else {
<span class="nc" id="L1077">            mBikeRentalStationId = bikeRentalStation.id;</span>
        }
<span class="nc" id="L1079">    }</span>

    @Override
    public void onProgressBarChanged(boolean showProgressBar) {
<span class="nc" id="L1083">        mLastMapProgressBarState = showProgressBar;</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">        if (showProgressBar) {</span>
<span class="nc" id="L1085">            showMapProgressBar();</span>
        } else {
<span class="nc" id="L1087">            hideMapProgressBar();</span>
        }
<span class="nc" id="L1089">    }</span>

    /**
     * Called by the ArrivalsListFragment when the ListView is created
     *
     * @param listView the ListView that was just created
     */
    @Override
    public void onListViewCreated(ListView listView) {
        // Set the scrollable view in the sliding panel
<span class="nc" id="L1099">        mSlidingPanel.setScrollableView(listView);</span>
<span class="nc" id="L1100">    }</span>

    /**
     * Called by the ArrivalsListFragment when we have new updated arrival information
     *
     * @param response new arrival information
     */
    @Override
    public void onArrivalTimesUpdated(ObaArrivalInfoResponse response) {
<span class="nc bnc" id="L1109" title="All 4 branches missed.">        if (response == null || response.getStop() == null) {</span>
<span class="nc" id="L1110">            return;</span>
        }

        // If we're missing any local references (e.g., if orientation just changed), store the values
<span class="nc bnc" id="L1114" title="All 2 branches missed.">        if (mFocusedStopId == null) {</span>
<span class="nc" id="L1115">            mFocusedStopId = response.getStop().getId();</span>
        }
<span class="nc bnc" id="L1117" title="All 2 branches missed.">        if (mFocusedStop == null) {</span>
<span class="nc" id="L1118">            mFocusedStop = response.getStop();</span>

            // Since mFocusedStop was null, the layout changed, and we should recenter map on stop
<span class="nc bnc" id="L1121" title="All 4 branches missed.">            if (mMapFragment != null &amp;&amp; mSlidingPanel != null) {</span>
<span class="nc" id="L1122">                mMapFragment.setMapCenter(mFocusedStop.getLocation(), false,</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                        mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.ANCHORED);</span>
            }

            // ...and we should add a focus marker for this stop
<span class="nc bnc" id="L1127" title="All 2 branches missed.">            if (mMapFragment != null) {</span>
<span class="nc" id="L1128">                mMapFragment.setFocusStop(mFocusedStop, response.getRoutes());</span>
            }
        }

        // Header might have changed height, so make sure my location button is set above the header
<span class="nc" id="L1133">        moveFabsLocation();</span>

        // Show arrival info related tutorials
<span class="nc" id="L1136">        showArrivalInfoTutorials(response);</span>
<span class="nc" id="L1137">    }</span>

    /**
     * Triggers the various tutorials related to arrival info and the sliding panel header
     *
     * @param response arrival info, which is required for some tutorials
     */
    private void showArrivalInfoTutorials(ObaArrivalInfoResponse response) {
        // If we're already showing a ShowcaseView, we don't want to stack another on top
<span class="nc bnc" id="L1146" title="All 2 branches missed.">        if (ShowcaseViewUtils.isShowcaseViewShowing()) {</span>
<span class="nc" id="L1147">            return;</span>
        }

        // If we can't see the map or sliding panel, we can't see the arrival info, so return
<span class="nc bnc" id="L1151" title="All 4 branches missed.">        if (mMapFragment.isHidden() || !mMapFragment.isVisible() ||</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">                mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.HIDDEN) {</span>
<span class="nc" id="L1153">            return;</span>
        }

        /**
         * The ShowcaseViewUtils.showTutorial() method takes care of checking if a tutorial has
         * already been shown, so we can just list the tutorials in order of how they should be
         * shown to the user.
         */

        // Show the tutorial explaining arrival times
<span class="nc" id="L1163">        ShowcaseViewUtils.showTutorial(ShowcaseViewUtils.TUTORIAL_ARRIVAL_HEADER_ARRIVAL_INFO, this,</span>
                response, false);

        // Make sure the panel is stationary before showing the starred routes tutorial
<span class="nc bnc" id="L1167" title="All 2 branches missed.">        if (mSlidingPanel != null &amp;&amp;</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">                (isSlidingPanelCollapsed() ||</span>
<span class="nc bnc" id="L1169" title="All 2 branches missed.">                        mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.ANCHORED ||</span>
<span class="nc bnc" id="L1170" title="All 2 branches missed.">                        mSlidingPanel.getPanelState()</span>
                                == SlidingUpPanelLayout.PanelState.EXPANDED)) {
<span class="nc" id="L1172">            ShowcaseViewUtils</span>
<span class="nc" id="L1173">                    .showTutorial(ShowcaseViewUtils.TUTORIAL_ARRIVAL_HEADER_STAR_ROUTE, this,</span>
                            response, false);
        }
<span class="nc" id="L1176">        ShowcaseViewUtils.showTutorial(ShowcaseViewUtils.TUTORIAL_RECENT_STOPS_ROUTES, this, null, false);</span>
<span class="nc" id="L1177">    }</span>

    /**
     * Called by the ArrivalListFragment when the user selects the &quot;Show route on map&quot; for a
     * particular route/trip
     *
     * @param arrivalInfo The arrival information for the route/trip that the user selected
     * @return true if the listener has consumed the event, false otherwise
     */
    @Override
    public boolean onShowRouteOnMapSelected(ArrivalInfo arrivalInfo) {
        // If the panel is fully expanded, change it to anchored so the user can see the map
<span class="nc bnc" id="L1189" title="All 2 branches missed.">        if (mSlidingPanel != null) {</span>
<span class="nc" id="L1190">            mSlidingPanel.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);</span>
        }

<span class="nc" id="L1193">        Bundle bundle = new Bundle();</span>
<span class="nc" id="L1194">        bundle.putBoolean(MapParams.ZOOM_TO_ROUTE, false);</span>
<span class="nc" id="L1195">        bundle.putBoolean(MapParams.ZOOM_INCLUDE_CLOSEST_VEHICLE, true);</span>
<span class="nc" id="L1196">        bundle.putString(MapParams.ROUTE_ID, arrivalInfo.getInfo().getRouteId());</span>
<span class="nc" id="L1197">        mMapFragment.setMapMode(MapParams.MODE_ROUTE, bundle);</span>

<span class="nc" id="L1199">        return true;</span>
    }

    /**
     * Called when the user selects the &quot;Sort by&quot; option in ArrivalsListFragment
     */
    @Override
    public void onSortBySelected() {
        // If the sliding panel isn't open, then open it to show what we're sorting
<span class="nc bnc" id="L1208" title="All 2 branches missed.">        if (mSlidingPanel != null) {</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">            if (isSlidingPanelCollapsed()) {</span>
<span class="nc" id="L1210">                mSlidingPanel.setPanelState(SlidingUpPanelLayout.PanelState.ANCHORED);</span>
            }
        }
<span class="nc" id="L1213">    }</span>

    @Override
    public void onBackPressed() {
        // Collapse the panel when the user presses the back button
<span class="nc bnc" id="L1218" title="All 2 branches missed.">        if (mSlidingPanel != null) {</span>
            // Collapse the sliding panel if its anchored or expanded
<span class="nc bnc" id="L1220" title="All 2 branches missed.">            if (mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.EXPANDED</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">                    || mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.ANCHORED) {</span>
<span class="nc" id="L1222">                mSlidingPanel.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);</span>
<span class="nc" id="L1223">                return;</span>
            }
            // Clear focused stop and close the sliding panel if its collapsed
<span class="nc bnc" id="L1226" title="All 2 branches missed.">            if (mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.COLLAPSED) {</span>
                // Clear the stop focus in map fragment, which will trigger a callback to close the
                // panel via BaseMapFragment.OnFocusChangedListener in this.onFocusChanged()
<span class="nc" id="L1229">                mMapFragment.setFocusStop(null, null);</span>
<span class="nc" id="L1230">                return;</span>
            }
        }
<span class="nc" id="L1233">        super.onBackPressed();</span>
<span class="nc" id="L1234">    }</span>

    /**
     * Redraw navigation drawer. This is necessary because we do not know whether to draw the
     * &quot;Plan A Trip&quot; option until a region is selected.
     */
    private void redrawNavigationDrawerFragment() {
<span class="nc bnc" id="L1241" title="All 2 branches missed.">        if (mNavigationDrawerFragment != null) {</span>
<span class="nc" id="L1242">            mNavigationDrawerFragment.populateNavDrawer();</span>
        }
<span class="nc" id="L1244">    }</span>

    /**
     * Create a new fragment to show the arrivals list for the given stop.  An ObaStop object
     * should
     * be passed in if available.  In all cases a stopId, stopName, and stopCode must be provided.
     *
     * @param stopId   Stop ID of the stop to show arrivals for
     * @param stopName Stop name of the stop to show arrivals for
     * @param stopCode Stop Code (rider-facing ID) of the stop to show arrivals for
     * @param stop     The ObaStop object for the stop to show arrivals for, or null if we don't
     *                 have
     *                 this yet.
     * @param routes   A HashMap of all route display names that serve this stop - key is routeId,
     *                 or
     *                 null if we don't have this yet.
     */
    private void updateArrivalListFragment(@NonNull String stopId, @NonNull String stopName,
                                           @NonNull String stopCode, ObaStop stop, HashMap&lt;String, ObaRoute&gt; routes) {
<span class="nc" id="L1263">        FragmentManager fm = getSupportFragmentManager();</span>
        Intent intent;

<span class="nc" id="L1266">        mArrivalsListFragment = new ArrivalsListFragment();</span>
<span class="nc" id="L1267">        mArrivalsListFragment.setListener(this);</span>

        // Set the header for the arrival list to be the top of the sliding panel
<span class="nc" id="L1270">        mArrivalsListHeader = new ArrivalsListHeader(this, mArrivalsListFragment,</span>
<span class="nc" id="L1271">                getSupportFragmentManager());</span>
<span class="nc" id="L1272">        mArrivalsListFragment.setHeader(mArrivalsListHeader, mArrivalsListHeaderView);</span>
<span class="nc" id="L1273">        mArrivalsListHeader.setSlidingPanelController(mSlidingPanelController);</span>
<span class="nc" id="L1274">        mArrivalsListHeader.setSlidingPanelCollapsed(isSlidingPanelCollapsed());</span>
<span class="nc" id="L1275">        mShowArrivalsMenu = true;</span>
<span class="nc" id="L1276">        mExpandCollapse = mArrivalsListHeaderView.findViewById(R.id.expand_collapse);</span>

<span class="nc bnc" id="L1278" title="All 4 branches missed.">        if (stop != null &amp;&amp; routes != null) {</span>
            // Use ObaStop and ObaRoute objects, since we can pre-populate some of the fields
            // before getting an API response
<span class="nc" id="L1281">            intent = new ArrivalsListFragment.IntentBuilder(this, stop, routes).build();</span>
        } else {
            // We don't have an ObaStop (likely started from Intent or after rotating device)
            // Some fields will be blank until we get an API response
<span class="nc" id="L1285">            intent = new ArrivalsListFragment.IntentBuilder(this, stopId)</span>
<span class="nc" id="L1286">                    .setStopName(stopName)</span>
<span class="nc" id="L1287">                    .setStopCode(stopCode)</span>
<span class="nc" id="L1288">                    .build();</span>
        }

<span class="nc" id="L1291">        mArrivalsListFragment.setArguments(FragmentUtils.getIntentArgs(intent));</span>
<span class="nc" id="L1292">        fm.beginTransaction().replace(R.id.slidingFragment, mArrivalsListFragment).commit();</span>
<span class="nc" id="L1293">        showSlidingPanel();</span>
<span class="nc" id="L1294">        moveFabsLocation();</span>
<span class="nc" id="L1295">    }</span>

    private void showSlidingPanel() {
<span class="nc bnc" id="L1298" title="All 2 branches missed.">        if (mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.HIDDEN) {</span>
<span class="nc" id="L1299">            mSlidingPanel.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);</span>
        }

<span class="nc" id="L1302">    }</span>

    private void goToSendFeedBack() {
<span class="nc bnc" id="L1305" title="All 2 branches missed.">        if (mFocusedStop != null) {</span>
<span class="nc" id="L1306">            ReportActivity.start(this, mFocusedStopId, mFocusedStop.getName(), mFocusedStop.getStopCode(),</span>
<span class="nc" id="L1307">                    mFocusedStop.getLatitude(), mFocusedStop.getLongitude(), mGoogleApiClient);</span>
        } else {
<span class="nc" id="L1309">            Location loc = Application.getLastKnownLocation(this, mGoogleApiClient);</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">            if (loc != null) {</span>
<span class="nc" id="L1311">                ReportActivity.start(this, loc.getLatitude(), loc.getLongitude(), mGoogleApiClient);</span>
            } else {
<span class="nc" id="L1313">                ReportActivity.start(this, mGoogleApiClient);</span>
            }
        }
<span class="nc" id="L1316">    }</span>

    /**
     * Checks region status, which can potentially including forcing a reload of region
     * info from the server.  Also includes auto-selection of closest region.
     */
    private void checkRegionStatus() {
        //First check for custom API URL set by user via Preferences, since if that is set we don't need region info from the REST API
<span class="nc bnc" id="L1324" title="All 2 branches missed.">        if (!TextUtils.isEmpty(Application.get().getCustomApiUrl())) {</span>
<span class="nc" id="L1325">            return;</span>
        }

        // Check if region is hard-coded for this build flavor
        if (BuildConfig.USE_FIXED_REGION) {
            ObaRegion r = RegionUtils.getRegionFromBuildFlavor();
            // Set the hard-coded region
            RegionUtils.saveToProvider(this, Collections.singletonList(r));
            Application.get().setCurrentRegion(r);
            // Disable any region auto-selection in preferences
            PreferenceUtils
                    .saveBoolean(getString(R.string.preference_key_auto_select_region), false);
            return;
        }

<span class="nc" id="L1340">        boolean forceReload = false;</span>
<span class="nc" id="L1341">        boolean showProgressDialog = true;</span>

        //If we don't have region info selected, or if enough time has passed since last region info update,
        //force contacting the server again
<span class="nc bnc" id="L1345" title="All 2 branches missed.">        if (Application.get().getCurrentRegion() == null ||</span>
<span class="nc bnc" id="L1346" title="All 2 branches missed.">                new Date().getTime() - Application.get().getLastRegionUpdateDate()</span>
                        &gt; REGION_UPDATE_THRESHOLD) {
<span class="nc" id="L1348">            forceReload = true;</span>
<span class="nc" id="L1349">            Log.d(TAG,</span>
                    &quot;Region info has expired (or does not exist), forcing a reload from the server...&quot;);
        }

<span class="nc bnc" id="L1353" title="All 2 branches missed.">        if (Application.get().getCurrentRegion() != null) {</span>
            //We already have region info locally, so just check current region status quietly in the background
<span class="nc" id="L1355">            showProgressDialog = false;</span>
        }

        try {
<span class="nc" id="L1359">            PackageInfo appInfo = getPackageManager().getPackageInfo(getPackageName(),</span>
                    PackageManager.GET_META_DATA);
<span class="nc" id="L1361">            SharedPreferences settings = Application.getPrefs();</span>
<span class="nc" id="L1362">            final int oldVer = settings.getInt(CHECK_REGION_VER, 0);</span>
<span class="nc" id="L1363">            final int newVer = appInfo.versionCode;</span>

<span class="nc bnc" id="L1365" title="All 2 branches missed.">            if (oldVer &lt; newVer) {</span>
<span class="nc" id="L1366">                forceReload = true;</span>
            }
<span class="nc" id="L1368">            PreferenceUtils.saveInt(CHECK_REGION_VER, appInfo.versionCode);</span>
<span class="nc" id="L1369">        } catch (NameNotFoundException e) {</span>
            // Do nothing
<span class="nc" id="L1371">        }</span>

        //Check region status, possibly forcing a reload from server and checking proximity to current region
<span class="nc" id="L1374">        List&lt;ObaRegionsTask.Callback&gt; callbacks = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1375">        callbacks.add(mMapFragment);</span>
<span class="nc" id="L1376">        callbacks.add(this);</span>
<span class="nc" id="L1377">        ObaRegionsTask task = new ObaRegionsTask(this, callbacks, forceReload, showProgressDialog);</span>
<span class="nc" id="L1378">        task.execute();</span>
<span class="nc" id="L1379">    }</span>

    //
    // Region Task Callback
    //
    @Override
    public void onRegionTaskFinished(boolean currentRegionChanged) {
        // Show &quot;What's New&quot; (which might need refreshed Regions API contents)
<span class="nc" id="L1387">        boolean update = autoShowWhatsNew();</span>

        // Redraw nav drawer if the region changed, or if we just installed a new version
<span class="nc bnc" id="L1390" title="All 4 branches missed.">        if (currentRegionChanged || update) {</span>
<span class="nc" id="L1391">            redrawNavigationDrawerFragment();</span>
        }

        // If region changed and was auto-selected, show user what region we're using
<span class="nc bnc" id="L1395" title="All 2 branches missed.">        if (currentRegionChanged</span>
<span class="nc" id="L1396">                &amp;&amp; Application.getPrefs()</span>
<span class="nc bnc" id="L1397" title="All 2 branches missed.">                .getBoolean(getString(R.string.preference_key_auto_select_region), true)</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">                &amp;&amp; Application.get().getCurrentRegion() != null</span>
<span class="nc bnc" id="L1399" title="All 2 branches missed.">                &amp;&amp; UIUtils.canManageDialog(this)) {</span>
<span class="nc" id="L1400">            Toast.makeText(getApplicationContext(),</span>
<span class="nc" id="L1401">                    getString(R.string.region_region_found,</span>
<span class="nc" id="L1402">                            Application.get().getCurrentRegion().getName()),</span>
                    Toast.LENGTH_LONG
<span class="nc" id="L1404">            ).show();</span>
        }
<span class="nc" id="L1406">        updateLayersFab();</span>
<span class="nc" id="L1407">    }</span>

    private void setupZoomButtons() {
<span class="nc" id="L1410">        ImageButton mZoomInBtn = findViewById(R.id.btnZoomIn);</span>
<span class="nc" id="L1411">        ImageButton mZoomOutBtn = findViewById(R.id.btnZoomOut);</span>
<span class="nc" id="L1412">        mZoomInBtn.setOnClickListener(view -&gt; mMapFragment.zoomIn());</span>
<span class="nc" id="L1413">        mZoomOutBtn.setOnClickListener(view -&gt; mMapFragment.zoomOut());</span>
<span class="nc" id="L1414">    }</span>

    private void setupMyLocationButton() {
        // Initialize the My Location button
<span class="nc" id="L1418">        mFabMyLocation = findViewById(R.id.btnMyLocation);</span>
<span class="nc" id="L1419">        mFabMyLocation.setOnClickListener(view -&gt; {</span>
<span class="nc bnc" id="L1420" title="All 2 branches missed.">            if (mMapFragment != null) {</span>
                // Reset the preference to ask user to enable location
<span class="nc" id="L1422">                PreferenceUtils.saveBoolean(getString(R.string.preference_key_never_show_location_dialog), false);</span>
<span class="nc" id="L1423">                PreferenceUtils.setUserDeniedLocationPermissions(false);</span>

<span class="nc" id="L1425">                mMapFragment.setMyLocation(true, true);</span>
<span class="nc" id="L1426">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L1427">                        getString(R.string.analytics_label_button_press_location),</span>
                        null);
            }
<span class="nc" id="L1430">        });</span>
<span class="nc" id="L1431">        ViewGroup.MarginLayoutParams p = (ViewGroup.MarginLayoutParams) mFabMyLocation</span>
<span class="nc" id="L1432">                .getLayoutParams();</span>
<span class="nc" id="L1433">        MY_LOC_DEFAULT_BOTTOM_MARGIN = p.bottomMargin;</span>
<span class="nc" id="L1434">        checkLeftHandMode();</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">        if (mCurrentNavDrawerPosition == NAVDRAWER_ITEM_NEARBY) {</span>
<span class="nc" id="L1436">            showFloatingActionButtons();</span>
<span class="nc" id="L1437">            showMapProgressBar();</span>
        } else {
<span class="nc" id="L1439">            hideFloatingActionButtons();</span>
<span class="nc" id="L1440">            hideMapProgressBar();</span>
        }
<span class="nc" id="L1442">    }</span>

    private void checkDisplayZoomControls() {
<span class="nc" id="L1445">        boolean displayZoom = Application.getPrefs().getBoolean(</span>
<span class="nc" id="L1446">                getString(R.string.preference_key_show_zoom_controls), false);</span>
<span class="nc" id="L1447">        showZoomControls(displayZoom);</span>
<span class="nc" id="L1448">    }</span>

    /**
     * Shows zoom controls if state is true, hides the zoom controls if state is false
     * @param showZoom true if the zoom controls should be visible, false if they should be hidden
     */
    private void showZoomControls(boolean showZoom) {
<span class="nc" id="L1455">        LinearLayout zoomLayout = findViewById(R.id.zoom_buttons_layout);</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">        if (zoomLayout != null) {</span>
<span class="nc bnc" id="L1457" title="All 2 branches missed.">            if (showZoom) {</span>
<span class="nc" id="L1458">                zoomLayout.setVisibility(LinearLayout.VISIBLE);</span>
            } else {
<span class="nc" id="L1460">                zoomLayout.setVisibility(LinearLayout.GONE);</span>
            }
        }
<span class="nc" id="L1463">    }</span>

    private void checkLeftHandMode() {
<span class="nc" id="L1466">        boolean leftHandMode = Application.getPrefs().getBoolean(</span>
<span class="nc" id="L1467">                getString(R.string.preference_key_left_hand_mode), false);</span>
<span class="nc" id="L1468">        setFABLocation(leftHandMode);</span>
<span class="nc" id="L1469">    }</span>


    private void setFABLocation(boolean leftHandMode) {
<span class="nc bnc" id="L1473" title="All 2 branches missed.">        if (mFabMyLocation != null) {</span>
<span class="nc" id="L1474">            RelativeLayout.LayoutParams layoutParams = (RelativeLayout.LayoutParams) mFabMyLocation</span>
<span class="nc" id="L1475">                    .getLayoutParams();</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">            if (leftHandMode) {</span>
<span class="nc" id="L1477">                layoutParams.addRule(RelativeLayout.ALIGN_PARENT_LEFT);</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) {</span>
<span class="nc" id="L1479">                    layoutParams.removeRule(RelativeLayout.ALIGN_PARENT_RIGHT);</span>
                }
            } else {
<span class="nc" id="L1482">                layoutParams.addRule(RelativeLayout.ALIGN_PARENT_RIGHT);</span>
<span class="nc bnc" id="L1483" title="All 2 branches missed.">                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) {</span>
<span class="nc" id="L1484">                    layoutParams.removeRule(RelativeLayout.ALIGN_PARENT_LEFT);</span>
                }
            }
        }
<span class="nc bnc" id="L1488" title="All 2 branches missed.">        if (mLayersFab != null) {</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">            if (leftHandMode) {</span>
<span class="nc" id="L1490">                mLayersFab.setButtonPosition(POSITION_BOTTOM | POSITION_START);</span>
            } else {
<span class="nc" id="L1492">                mLayersFab.setButtonPosition(POSITION_BOTTOM | POSITION_END);</span>
            }
        }
<span class="nc" id="L1495">    }</span>
    
    /**
     * Moves both Floating Action Buttons as response to sliding panel height changes.
     * &lt;p&gt;
     * Currently there are two FAB that can be moved, the My location button and the Layers button.
     */
    synchronized private void moveFabsLocation() {
<span class="nc" id="L1503">        moveFabLocation(mFabMyLocation, MY_LOC_DEFAULT_BOTTOM_MARGIN);</span>
<span class="nc" id="L1504">        moveFabLocation(mLayersFab, LAYERS_FAB_DEFAULT_BOTTOM_MARGIN);</span>
<span class="nc" id="L1505">    }</span>

    private void moveFabLocation(final View fab, final int initialMargin) {
<span class="nc bnc" id="L1508" title="All 2 branches missed.">        if (fab == null) {</span>
<span class="nc" id="L1509">            return;</span>
        }
<span class="nc bnc" id="L1511" title="All 2 branches missed.">        if (mMyLocationAnimation != null &amp;&amp;</span>
<span class="nc bnc" id="L1512" title="All 4 branches missed.">                (mMyLocationAnimation.hasStarted() &amp;&amp; !mMyLocationAnimation.hasEnded())) {</span>
            // We're already animating - do nothing

            //return;
        }

<span class="nc bnc" id="L1518" title="All 2 branches missed.">        if (mMyLocationAnimation != null) {</span>
<span class="nc" id="L1519">            mMyLocationAnimation.reset();</span>
        }

        // Post this to a handler to allow the header to settle before animating the button
<span class="nc" id="L1523">        final Handler h = new Handler();</span>
<span class="nc" id="L1524">        h.postDelayed(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L1527">                final ViewGroup.MarginLayoutParams p = (ViewGroup.MarginLayoutParams) fab</span>
<span class="nc" id="L1528">                        .getLayoutParams();</span>

<span class="nc" id="L1530">                int tempMargin = initialMargin;</span>

<span class="nc bnc" id="L1532" title="All 2 branches missed.">                if (mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.COLLAPSED) {</span>
<span class="nc" id="L1533">                    tempMargin += mSlidingPanel.getPanelHeight();</span>
<span class="nc bnc" id="L1534" title="All 2 branches missed.">                    if (p.bottomMargin == tempMargin) {</span>
                        // Button is already in the right position, do nothing
<span class="nc" id="L1536">                        return;</span>
                    }
                } else {
<span class="nc bnc" id="L1539" title="All 2 branches missed.">                    if (mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.HIDDEN) {</span>
<span class="nc bnc" id="L1540" title="All 2 branches missed.">                        if (p.bottomMargin == tempMargin) {</span>
                            // Button is already in the right position, do nothing
<span class="nc" id="L1542">                            return;</span>
                        }
                    }
                }

<span class="nc" id="L1547">                final int goalMargin = tempMargin;</span>
<span class="nc" id="L1548">                final int currentMargin = p.bottomMargin;</span>

<span class="nc" id="L1550">                mMyLocationAnimation = new Animation() {</span>
                    @Override
                    protected void applyTransformation(float interpolatedTime, Transformation t) {
                        int bottom;
<span class="nc bnc" id="L1554" title="All 2 branches missed.">                        if (goalMargin &gt; currentMargin) {</span>
<span class="nc" id="L1555">                            bottom = currentMargin + (int) (Math.abs(currentMargin - goalMargin)</span>
                                    * interpolatedTime);
                        } else {
<span class="nc" id="L1558">                            bottom = currentMargin - (int) (Math.abs(currentMargin - goalMargin)</span>
                                    * interpolatedTime);
                        }
<span class="nc" id="L1561">                        UIUtils.setMargins(fab,</span>
                                p.leftMargin,
                                p.topMargin,
                                p.rightMargin,
                                bottom);
<span class="nc" id="L1566">                    }</span>
                };
<span class="nc" id="L1568">                mMyLocationAnimation.setDuration(MY_LOC_BTN_ANIM_DURATION);</span>
<span class="nc" id="L1569">                fab.startAnimation(mMyLocationAnimation);</span>
<span class="nc" id="L1570">            }</span>
        }, 100);
<span class="nc" id="L1572">    }</span>

    private void showFloatingActionButtons() {
<span class="nc bnc" id="L1575" title="All 4 branches missed.">        if (mFabMyLocation == null &amp;&amp; mLayersFab == null) {</span>
<span class="nc" id="L1576">            return;</span>
        }
<span class="nc bnc" id="L1578" title="All 4 branches missed.">        if (mFabMyLocation != null &amp;&amp; mFabMyLocation.getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L1579">            mFabMyLocation.setVisibility(View.VISIBLE);</span>
        }
<span class="nc bnc" id="L1581" title="All 4 branches missed.">        if (mLayersFab != null &amp;&amp; mLayersFab.getVisibility() != View.VISIBLE) {</span>
<span class="nc bnc" id="L1582" title="All 2 branches missed.">            if (Application.isBikeshareEnabled()) {</span>
<span class="nc" id="L1583">                mLayersFab.setVisibility(View.VISIBLE);</span>
            }
        }
<span class="nc" id="L1586">    }</span>

    private void hideFloatingActionButtons() {
<span class="nc bnc" id="L1589" title="All 4 branches missed.">        if (mFabMyLocation == null &amp;&amp; mLayersFab == null) {</span>
<span class="nc" id="L1590">            return;</span>
        }
<span class="nc bnc" id="L1592" title="All 4 branches missed.">        if (mFabMyLocation != null &amp;&amp; mFabMyLocation.getVisibility() != View.GONE) {</span>
<span class="nc" id="L1593">            mFabMyLocation.setVisibility(View.GONE);</span>
        }
<span class="nc bnc" id="L1595" title="All 4 branches missed.">        if (mLayersFab != null &amp;&amp; mLayersFab.getVisibility() != View.GONE) {</span>
<span class="nc" id="L1596">            mLayersFab.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L1598">    }</span>

    private void showMapProgressBar() {
<span class="nc bnc" id="L1601" title="All 2 branches missed.">        if (mMapProgressBar == null) {</span>
<span class="nc" id="L1602">            return;</span>
        }
<span class="nc bnc" id="L1604" title="All 2 branches missed.">        if (mMapProgressBar.getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L1605">            mMapProgressBar.setVisibility(View.VISIBLE);</span>
        }
<span class="nc" id="L1607">    }</span>

    private void hideMapProgressBar() {
<span class="nc bnc" id="L1610" title="All 2 branches missed.">        if (mMapProgressBar == null) {</span>
<span class="nc" id="L1611">            return;</span>
        }
<span class="nc bnc" id="L1613" title="All 2 branches missed.">        if (mMapProgressBar.getVisibility() != View.GONE) {</span>
<span class="nc" id="L1614">            mMapProgressBar.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L1616">    }</span>

    private void setupNavigationDrawer() {
<span class="nc" id="L1619">        mNavigationDrawerFragment = (NavigationDrawerFragment)</span>
<span class="nc" id="L1620">                getSupportFragmentManager().findFragmentById(R.id.navigation_drawer);</span>

        // Set up the drawer.
<span class="nc" id="L1623">        mNavigationDrawerFragment.setUp(</span>
                R.id.navigation_drawer,
<span class="nc" id="L1625">                findViewById(R.id.nav_drawer_left_pane));</span>

        // Was this activity started to show a route or stop on the map? If so, switch to MapFragment
<span class="nc" id="L1628">        Bundle bundle = getIntent().getExtras();</span>
<span class="nc bnc" id="L1629" title="All 2 branches missed.">        if (bundle != null) {</span>
<span class="nc" id="L1630">            String routeId = bundle.getString(MapParams.ROUTE_ID);</span>
<span class="nc" id="L1631">            String stopId = bundle.getString(MapParams.STOP_ID);</span>
<span class="nc bnc" id="L1632" title="All 4 branches missed.">            if (routeId != null || stopId != null) {</span>
<span class="nc" id="L1633">                mNavigationDrawerFragment.selectItem(NAVDRAWER_ITEM_NEARBY);</span>
            }
        }
<span class="nc" id="L1636">    }</span>

    private void setupGooglePlayServices() {
        // Init Google Play Services as early as possible in the Fragment lifecycle to give it time
<span class="nc" id="L1640">        GoogleApiAvailability api = GoogleApiAvailability.getInstance();</span>
<span class="nc bnc" id="L1641" title="All 2 branches missed.">        if (api.isGooglePlayServicesAvailable(this)</span>
                == ConnectionResult.SUCCESS) {
<span class="nc" id="L1643">            mGoogleApiClient = LocationUtils.getGoogleApiClientWithCallbacks(this);</span>
<span class="nc" id="L1644">            mGoogleApiClient.connect();</span>
        }
<span class="nc" id="L1646">    }</span>

    private void setupLayersSpeedDial() {
<span class="nc" id="L1649">        mLayersFab = findViewById(R.id.layersSpeedDial);</span>

<span class="nc" id="L1651">        ViewGroup.MarginLayoutParams p = (ViewGroup.MarginLayoutParams) mLayersFab</span>
<span class="nc" id="L1652">                .getLayoutParams();</span>
<span class="nc" id="L1653">        LAYERS_FAB_DEFAULT_BOTTOM_MARGIN = p.bottomMargin;</span>

<span class="nc" id="L1655">        mLayersFab.setButtonIconResource(R.drawable.ic_layers_white_24dp);</span>
<span class="nc" id="L1656">        mLayersFab.setButtonBackgroundColour(ContextCompat.getColor(this, R.color.theme_accent));</span>

<span class="nc" id="L1658">        LayersSpeedDialAdapter adapter = new LayersSpeedDialAdapter(this);</span>
        // Add the BaseMapFragment listener to activate the layer on the map
<span class="nc" id="L1660">        adapter.addLayerActivationListener(mMapFragment);</span>

        // Add another listener to rebuild the menu options after selection. This other listener
        // was added here because the call to rebuildSpeedDialMenu exists on the FAB and we have a
        // reference to it only in the main activity.
<span class="nc" id="L1665">        adapter.addLayerActivationListener(new LayersSpeedDialAdapter.LayerActivationListener() {</span>
            @Override
            public void onActivateLayer(LayerInfo layer) {
<span class="nc" id="L1668">                Handler h = new Handler(getMainLooper());</span>
<span class="nc" id="L1669">                h.postDelayed(() -&gt; mLayersFab.rebuildSpeedDialMenu(), 100);</span>
<span class="nc" id="L1670">            }</span>

            @Override
            public void onDeactivateLayer(LayerInfo layer) {
<span class="nc" id="L1674">                Handler h = new Handler(getMainLooper());</span>
<span class="nc" id="L1675">                h.postDelayed(() -&gt; mLayersFab.rebuildSpeedDialMenu(), 100);</span>
<span class="nc" id="L1676">            }</span>
        });
<span class="nc" id="L1678">        mLayersFab.setSpeedDialMenuAdapter(adapter);</span>
<span class="nc" id="L1679">        mLayersFab.setOnSpeedDialMenuOpenListener(</span>
<span class="nc" id="L1680">                v -&gt; mLayersFab.setButtonIconResource(R.drawable.ic_add_white_24dp));</span>
<span class="nc" id="L1681">        mLayersFab.setOnSpeedDialMenuCloseListener(</span>
<span class="nc" id="L1682">                v -&gt; mLayersFab.setButtonIconResource(R.drawable.ic_layers_white_24dp));</span>
<span class="nc" id="L1683">        mLayersFab.setContentCoverEnabled(false);</span>
<span class="nc" id="L1684">    }</span>

    /**
     * Method used to (re)display the layers FAB button when the activity restarts or regions data
     * is updated
     */
    private void updateLayersFab() {
<span class="nc bnc" id="L1691" title="All 4 branches missed.">        if (Application.isBikeshareEnabled()</span>
                &amp;&amp; mCurrentNavDrawerPosition == NAVDRAWER_ITEM_NEARBY) {
<span class="nc" id="L1693">            mLayersFab.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L1695">            mLayersFab.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L1697">        mLayersFab.rebuildSpeedDialMenu();</span>
<span class="nc" id="L1698">    }</span>


    private void setupSlidingPanel() {
<span class="nc" id="L1702">        mSlidingPanel = findViewById(R.id.bottom_sliding_layout);</span>
<span class="nc" id="L1703">        mArrivalsListHeaderView = findViewById(R.id.arrivals_list_header);</span>
<span class="nc" id="L1704">        mArrivalsListHeaderSubView = mArrivalsListHeaderView.findViewById(R.id.main_header_content);</span>

<span class="nc" id="L1706">        mSlidingPanel.setPanelState(</span>
                SlidingUpPanelLayout.PanelState.HIDDEN);  // Don't show the panel until we have content
<span class="nc" id="L1708">        mSlidingPanel.setOverlayed(true);</span>
<span class="nc" id="L1709">        mSlidingPanel.setAnchorPoint(MapModeController.OVERLAY_PERCENTAGE);</span>
<span class="nc" id="L1710">        mSlidingPanel.addPanelSlideListener(new SlidingUpPanelLayout.PanelSlideListener() {</span>

            @Override
            public void onPanelStateChanged(View panel, SlidingUpPanelLayout.PanelState previousState, SlidingUpPanelLayout.PanelState newState) {
<span class="nc bnc" id="L1714" title="All 2 branches missed.">                if (previousState == SlidingUpPanelLayout.PanelState.HIDDEN) {</span>
<span class="nc" id="L1715">                    return;</span>
                }

<span class="nc bnc" id="L1718" title="All 5 branches missed.">                switch (newState) {</span>
                    case EXPANDED:
<span class="nc" id="L1720">                        onPanelExpanded(panel);</span>
<span class="nc" id="L1721">                        break;</span>
                    case COLLAPSED:
<span class="nc" id="L1723">                        onPanelCollapsed(panel);</span>
<span class="nc" id="L1724">                        break;</span>
                    case ANCHORED:
<span class="nc" id="L1726">                        onPanelAnchored(panel);</span>
<span class="nc" id="L1727">                        break;</span>
                    case HIDDEN:
<span class="nc" id="L1729">                        onPanelHidden(panel);</span>
                        break;
                }
<span class="nc" id="L1732">            }</span>

            @Override
            public void onPanelSlide(View panel, float slideOffset) {
<span class="nc" id="L1736">                Log.d(TAG, &quot;onPanelSlide, offset &quot; + slideOffset);</span>
<span class="nc bnc" id="L1737" title="All 2 branches missed.">                if (mArrivalsListHeader != null) {</span>
<span class="nc" id="L1738">                    mArrivalsListHeader.closeStatusPopups();</span>
                }
<span class="nc" id="L1740">            }</span>

            public void onPanelExpanded(View panel) {
<span class="nc" id="L1743">                Log.d(TAG, &quot;onPanelExpanded&quot;);</span>
<span class="nc bnc" id="L1744" title="All 2 branches missed.">                if (mArrivalsListHeader != null) {</span>
<span class="nc" id="L1745">                    mArrivalsListHeader.setSlidingPanelCollapsed(false);</span>
<span class="nc" id="L1746">                    mArrivalsListHeader.refresh();</span>
                }

                // Accessibility
<span class="nc bnc" id="L1750" title="All 2 branches missed.">                if (mExpandCollapse != null) {</span>
<span class="nc" id="L1751">                    mExpandCollapse.setContentDescription(Application.get().getResources()</span>
<span class="nc" id="L1752">                            .getString(R.string.stop_header_sliding_panel_open));</span>
                }
<span class="nc" id="L1754">            }</span>

            public void onPanelCollapsed(View panel) {
<span class="nc" id="L1757">                Log.d(TAG, &quot;onPanelCollapsed&quot;);</span>
<span class="nc bnc" id="L1758" title="All 2 branches missed.">                if (mMapFragment != null) {</span>
<span class="nc" id="L1759">                    mMapFragment.getMapView()</span>
<span class="nc" id="L1760">                            .setPadding(null, null, null, mSlidingPanel.getPanelHeight());</span>
                }
<span class="nc bnc" id="L1762" title="All 2 branches missed.">                if (mArrivalsListHeader != null) {</span>
<span class="nc" id="L1763">                    mArrivalsListHeader.setSlidingPanelCollapsed(true);</span>
<span class="nc" id="L1764">                    mArrivalsListHeader.refresh();</span>
                }
<span class="nc" id="L1766">                moveFabsLocation();</span>

                // Accessibility
<span class="nc bnc" id="L1769" title="All 2 branches missed.">                if (mExpandCollapse != null) {</span>
<span class="nc" id="L1770">                    mExpandCollapse.setContentDescription(Application.get().getResources()</span>
<span class="nc" id="L1771">                            .getString(R.string.stop_header_sliding_panel_collapsed));</span>
                }
<span class="nc" id="L1773">            }</span>

            public void onPanelAnchored(View panel) {
<span class="nc" id="L1776">                Log.d(TAG, &quot;onPanelAnchored&quot;);</span>
<span class="nc bnc" id="L1777" title="All 2 branches missed.">                if (mMapFragment != null) {</span>
<span class="nc" id="L1778">                    mMapFragment.getMapView()</span>
<span class="nc" id="L1779">                            .setPadding(null, null, null, mSlidingPanel.getPanelHeight());</span>
                }
<span class="nc bnc" id="L1781" title="All 4 branches missed.">                if (mFocusedStop != null &amp;&amp; mMapFragment != null) {</span>
<span class="nc" id="L1782">                    mMapFragment.setMapCenter(mFocusedStop.getLocation(), true, true);</span>
                }
<span class="nc bnc" id="L1784" title="All 2 branches missed.">                if (mArrivalsListHeader != null) {</span>
<span class="nc" id="L1785">                    mArrivalsListHeader.setSlidingPanelCollapsed(false);</span>
<span class="nc" id="L1786">                    mArrivalsListHeader.refresh();</span>
                }

                // Accessibility
<span class="nc bnc" id="L1790" title="All 2 branches missed.">                if (mExpandCollapse != null) {</span>
<span class="nc" id="L1791">                    mExpandCollapse.setContentDescription(Application.get().getResources()</span>
<span class="nc" id="L1792">                            .getString(R.string.stop_header_sliding_panel_open));</span>
                }
<span class="nc" id="L1794">            }</span>

            public void onPanelHidden(View panel) {
<span class="nc" id="L1797">                Log.d(TAG, &quot;onPanelHidden&quot;);</span>
                // We need to hide the panel when switching between fragments via the navdrawer,
                // so we shouldn't put anything here that causes us to lose the state of the
                // MapFragment or the ArrivalListFragment (e.g., removing the ArrivalListFragment)
<span class="nc bnc" id="L1801" title="All 2 branches missed.">                if (mMapFragment != null) {</span>
<span class="nc" id="L1802">                    mMapFragment.getMapView().setPadding(null, null, null, 0);</span>
                }

                // Accessibility - reset it here so its ready for next showing
<span class="nc bnc" id="L1806" title="All 2 branches missed.">                if (mExpandCollapse != null) {</span>
<span class="nc" id="L1807">                    mExpandCollapse.setContentDescription(Application.get().getResources()</span>
<span class="nc" id="L1808">                            .getString(R.string.stop_header_sliding_panel_collapsed));</span>
                }
<span class="nc" id="L1810">            }</span>
        });

<span class="nc" id="L1813">        mSlidingPanelController = new SlidingPanelController() {</span>
            @Override
            public void setPanelHeightPixels(int heightInPixels) {
<span class="nc bnc" id="L1816" title="All 2 branches missed.">                if (mSlidingPanel != null) {</span>
<span class="nc bnc" id="L1817" title="All 2 branches missed.">                    if (mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.DRAGGING ||</span>
<span class="nc bnc" id="L1818" title="All 2 branches missed.">                            mSlidingPanel.getPanelState()</span>
                                    == SlidingUpPanelLayout.PanelState.HIDDEN) {
                        // Don't resize header yet - see #294 - header size will be refreshed on panel state change
<span class="nc" id="L1821">                        return;</span>
                    }
<span class="nc bnc" id="L1823" title="All 2 branches missed.">                    if (mSlidingPanel.getPanelHeight() != heightInPixels) {</span>
<span class="nc" id="L1824">                        mSlidingPanel.setPanelHeight(heightInPixels);</span>
<span class="nc" id="L1825">                        mArrivalsListHeaderView.getLayoutParams().height = heightInPixels;</span>
<span class="nc" id="L1826">                        mArrivalsListHeaderSubView.getLayoutParams().height = heightInPixels;</span>
                    }
                }
<span class="nc" id="L1829">            }</span>

            @Override
            public int getPanelHeightPixels() {
<span class="nc bnc" id="L1833" title="All 2 branches missed.">                if (mSlidingPanel != null) {</span>
<span class="nc" id="L1834">                    return mSlidingPanel.getPanelHeight();</span>
                }
<span class="nc" id="L1836">                return -1;</span>
            }
        };
<span class="nc" id="L1839">    }</span>

    /**
     * Sets up the initial map state, based on a previous savedInstanceState for this activity,
     * or an Intent that was passed into this activity
     */
    private void setupMapState(Bundle savedInstanceState) {
        String stopId;
        String stopName;
        String stopCode;
        // Check savedInstanceState to see if there is a previous state for this activity
<span class="nc bnc" id="L1850" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
            // We're recreating an instance with a previous state, so show the focused stop in panel
<span class="nc" id="L1852">            stopId = savedInstanceState.getString(MapParams.STOP_ID);</span>
<span class="nc" id="L1853">            stopName = savedInstanceState.getString(MapParams.STOP_NAME);</span>
<span class="nc" id="L1854">            stopCode = savedInstanceState.getString(MapParams.STOP_CODE);</span>

<span class="nc bnc" id="L1856" title="All 2 branches missed.">            if (stopId != null) {</span>
<span class="nc" id="L1857">                mFocusedStopId = stopId;</span>
                // We don't have an ObaStop or ObaRoute mapping, so just pass in null for those
<span class="nc" id="L1859">                updateArrivalListFragment(stopId, stopName, stopCode, null, null);</span>
            }
        } else {
            // Check intent passed into Activity
<span class="nc" id="L1863">            Bundle bundle = getIntent().getExtras();</span>
<span class="nc bnc" id="L1864" title="All 2 branches missed.">            if (bundle != null) {</span>
                // Did this activity start to focus on a stop?  If so, set focus and show arrival info
<span class="nc" id="L1866">                stopId = bundle.getString(MapParams.STOP_ID);</span>
<span class="nc" id="L1867">                stopName = bundle.getString(MapParams.STOP_NAME);</span>
<span class="nc" id="L1868">                stopCode = bundle.getString(MapParams.STOP_CODE);</span>
<span class="nc" id="L1869">                double lat = bundle.getDouble(MapParams.CENTER_LAT);</span>
<span class="nc" id="L1870">                double lon = bundle.getDouble(MapParams.CENTER_LON);</span>

<span class="nc bnc" id="L1872" title="All 6 branches missed.">                if (stopId != null &amp;&amp; lat != 0.0 &amp;&amp; lon != 0.0) {</span>
<span class="nc" id="L1873">                    mFocusedStopId = stopId;</span>
<span class="nc" id="L1874">                    updateArrivalListFragment(stopId, stopName, stopCode, null, null);</span>
                }
            }
        }
<span class="nc" id="L1878">        mMapProgressBar = findViewById(R.id.progress_horizontal);</span>
<span class="nc" id="L1879">    }</span>

    /**
     * Setup permissions that are only requested if the user joins the travel behavior study. This
     * method must be called from #onCreate().
     *
     * A call to #requestPhysicalActivityPermission() invokes the permission request, and should only
     * be called in the case when the user opts into the study.
     * @param activity
     */
    private void setupPermissions(AppCompatActivity activity) {
<span class="nc" id="L1890">        travelBehaviorPermissionsLauncher =</span>
<span class="nc" id="L1891">                registerForActivityResult(new ActivityResultContracts.RequestPermission(), isGranted -&gt; {</span>
<span class="nc bnc" id="L1892" title="All 2 branches missed.">                    if (isGranted) {</span>
                        // User opt-ed into study and granted physical activity tracking - now request background location permissions (when targeting Android 11 we can't request both simultaneously)
<span class="nc bnc" id="L1894" title="All 2 branches missed.">                        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {</span>
<span class="nc" id="L1895">                            activity.requestPermissions(TravelBehaviorConstants.BACKGROUND_LOCATION_PERMISSION, BACKGROUND_LOCATION_PERMISSION_REQUEST);</span>
                        }
                    }
<span class="nc" id="L1898">                });</span>
<span class="nc" id="L1899">    }</span>

    /**
     * Requests physical activity permissions, and then subsequently background location
     * permissions (based on the initialization in #setupPermissions() if the user grants physical
     * activity permissions. This method should only be called after the user opts into the travel behavior study.
     */
    public void requestPhysicalActivityPermission() {
<span class="nc bnc" id="L1907" title="All 2 branches missed.">        if (travelBehaviorPermissionsLauncher != null){</span>
<span class="nc" id="L1908">            travelBehaviorPermissionsLauncher.launch(Manifest.permission.ACTIVITY_RECOGNITION);</span>
        }
<span class="nc" id="L1910">    }</span>

    /**
     * Our definition of collapsed is consistent with SlidingPanel pre-v3.0.0 definition - we don't
     * consider the panel changing from the hidden state to the collapsed state to be a &quot;collapsed&quot;
     * event.  v3.0.0 and higher fire the &quot;collapsed&quot; event when coming from the hidden state.
     * This method provides us with a collapsed state that is consistent with the pre-v3.0.0
     * definition
     * of a collapse event, to make our event model consistent with post v3.0.0 SlidingPanel.
     *
     * @return true if the panel isn't expanded or anchored, false if it is not
     */
    private boolean isSlidingPanelCollapsed() {
<span class="nc bnc" id="L1923" title="All 2 branches missed.">        return !(mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.EXPANDED ||</span>
<span class="nc bnc" id="L1924" title="All 2 branches missed.">                mSlidingPanel.getPanelState() == SlidingUpPanelLayout.PanelState.ANCHORED);</span>
    }

    public ArrivalsListFragment getArrivalsListFragment() {
<span class="nc" id="L1928">        return mArrivalsListFragment;</span>
    }

    private void checkBatteryOptimizations() {
<span class="nc bnc" id="L1932" title="All 2 branches missed.">        if (PreferenceUtils.getBoolean(getString(R.string.not_request_battery_optimizations_key),</span>
<span class="nc bnc" id="L1933" title="All 2 branches missed.">                false) || !TravelBehaviorUtils.isUserParticipatingInStudy()) {</span>
<span class="nc" id="L1934">            return;</span>
        }

<span class="nc" id="L1937">        Boolean ignoringBatteryOptimizations = Application.isIgnoringBatteryOptimizations(getApplicationContext());</span>
<span class="nc bnc" id="L1938" title="All 4 branches missed.">        if (ignoringBatteryOptimizations != null &amp;&amp; !ignoringBatteryOptimizations) {</span>
<span class="nc" id="L1939">            showIgnoreBatteryOptimizationDialog();</span>
        }
<span class="nc" id="L1941">    }</span>

    private void showIgnoreBatteryOptimizationDialog() {
<span class="nc" id="L1944">        new android.app.AlertDialog.Builder(this)</span>
<span class="nc" id="L1945">                .setMessage(R.string.application_ignoring_battery_opt_message)</span>
<span class="nc" id="L1946">                .setTitle(R.string.application_ignoring_battery_opt_title)</span>
<span class="nc" id="L1947">                .setIcon(R.drawable.ic_alert_warning)</span>
<span class="nc" id="L1948">                .setCancelable(false)</span>
<span class="nc" id="L1949">                .setPositiveButton(R.string.travel_behavior_dialog_yes,</span>
                        (dialog, which) -&gt; {
<span class="nc bnc" id="L1951" title="All 2 branches missed.">                            if (PermissionUtils.hasGrantedAllPermissions(this, new String[]{Manifest.</span>
                                    permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS})) {
<span class="nc" id="L1953">                                UIUtils.openBatteryIgnoreIntent(this);</span>
                            } else {
<span class="nc bnc" id="L1955" title="All 2 branches missed.">                                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {</span>
<span class="nc" id="L1956">                                    requestPermissions(new String[]{Manifest.</span>
                                                    permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS},
                                            BATTERY_OPTIMIZATIONS_PERMISSION_REQUEST);
                                }
                            }
<span class="nc" id="L1961">                            PreferenceUtils.saveBoolean(getString(R.string.not_request_battery_optimizations_key),</span>
                                    true);
<span class="nc" id="L1963">                        })</span>
<span class="nc" id="L1964">                .setNegativeButton(R.string.travel_behavior_dialog_no,</span>
                        (dialog, which) -&gt; {
<span class="nc" id="L1966">                            PreferenceUtils.saveBoolean(getString(R.string.not_request_battery_optimizations_key),</span>
                                    true);
<span class="nc" id="L1968">                        })</span>
<span class="nc" id="L1969">                .create().show();</span>
<span class="nc" id="L1970">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>