<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PreferencesActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.ui</a> &gt; <span class="el_source">PreferencesActivity.java</span></div><h1>PreferencesActivity.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2010-2017 Brian Ferris (bdferris@onebusaway.org),
 * University of South Florida (sjbarbeau@gmail.com),
 * Microsoft Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.ui;

import static org.onebusaway.android.util.PermissionUtils.RESTORE_BACKUP_PERMISSION_REQUEST;
import static org.onebusaway.android.util.PermissionUtils.SAVE_BACKUP_PERMISSION_REQUEST;
import static org.onebusaway.android.util.PermissionUtils.STORAGE_PERMISSIONS;
import static org.onebusaway.android.util.UIUtils.setAppTheme;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.preference.CheckBoxPreference;
import android.preference.ListPreference;
import android.preference.Preference;
import android.preference.Preference.OnPreferenceChangeListener;
import android.preference.PreferenceActivity;
import android.preference.PreferenceCategory;
import android.preference.PreferenceScreen;
import android.text.TextUtils;
import android.util.Log;
import android.util.Patterns;
import android.view.LayoutInflater;
import android.view.Window;
import android.widget.LinearLayout;
import android.widget.Toast;

import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatDelegate;
import androidx.appcompat.widget.Toolbar;
import androidx.core.app.ActivityCompat;

import com.google.firebase.analytics.FirebaseAnalytics;

import org.onebusaway.android.BuildConfig;
import org.onebusaway.android.R;
import org.onebusaway.android.app.Application;
import org.onebusaway.android.io.ObaAnalytics;
import org.onebusaway.android.io.elements.ObaRegion;
import org.onebusaway.android.provider.ObaContract;
import org.onebusaway.android.region.ObaRegionsTask;
import org.onebusaway.android.travelbehavior.TravelBehaviorManager;
import org.onebusaway.android.travelbehavior.io.coroutines.FirebaseDataPusher;
import org.onebusaway.android.travelbehavior.utils.TravelBehaviorUtils;
import org.onebusaway.android.util.BackupUtils;
import org.onebusaway.android.util.BuildFlavorUtils;
import org.onebusaway.android.util.PermissionUtils;
import org.onebusaway.android.util.PreferenceUtils;
import org.onebusaway.android.util.ShowcaseViewUtils;

import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;

<span class="nc" id="L77">public class PreferencesActivity extends PreferenceActivity</span>
        implements Preference.OnPreferenceClickListener, OnPreferenceChangeListener,
        SharedPreferences.OnSharedPreferenceChangeListener, ObaRegionsTask.Callback {

    private static final String TAG = &quot;PreferencesActivity&quot;;

    public static final String SHOW_CHECK_REGION_DIALOG = &quot;.checkRegionDialog&quot;;

    public static final int REQUEST_CODE_RESTORE_BACKUP = 1234;

    Preference mPreference;

    Preference mLeftHandMode;

    Preference mCustomApiUrlPref;

    Preference mCustomOtpApiUrlPref;

    Preference mAnalyticsPref;

    CheckBoxPreference mTravelBehaviorPref;

    Preference mHideAlertsPref;

    Preference mTutorialPref;

    Preference mDonatePref;

    Preference mPoweredByObaPref;

    Preference mAboutPref;

    Preference mSaveBackup;

    Preference mRestoreBackup;

    Preference pushFirebaseData;

    boolean mAutoSelectInitialValue;

<span class="nc" id="L117">    boolean mOtpCustomAPIUrlChanged = false;</span>
    //Save initial value so we can compare to current value in onDestroy()

    ListPreference preferredUnits;

    ListPreference mThemePref;

    private FirebaseAnalytics mFirebaseAnalytics;

    @SuppressWarnings(&quot;deprecation&quot;)
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L128">        requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);</span>
<span class="nc" id="L129">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L130">        setProgressBarIndeterminate(true);</span>

<span class="nc" id="L132">        addPreferencesFromResource(R.xml.preferences);</span>

<span class="nc" id="L134">        mFirebaseAnalytics = FirebaseAnalytics.getInstance(this);</span>

<span class="nc" id="L136">        mPreference = findPreference(getString(R.string.preference_key_region));</span>
<span class="nc" id="L137">        mPreference.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L139">        mLeftHandMode = findPreference(getString(R.string.preference_key_left_hand_mode));</span>
<span class="nc" id="L140">        mLeftHandMode.setOnPreferenceChangeListener(this);</span>

<span class="nc" id="L142">        mSaveBackup = findPreference(getString(R.string.preference_key_save_backup));</span>
<span class="nc" id="L143">        mSaveBackup.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L145">        mRestoreBackup = findPreference(getString(R.string.preference_key_restore_backup));</span>
<span class="nc" id="L146">        mRestoreBackup.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L148">        mCustomApiUrlPref = findPreference(getString(R.string.preference_key_oba_api_url));</span>
<span class="nc" id="L149">        mCustomApiUrlPref.setOnPreferenceChangeListener(this);</span>

<span class="nc" id="L151">        mCustomOtpApiUrlPref = findPreference(getString(R.string.preference_key_otp_api_url));</span>
<span class="nc" id="L152">        mCustomOtpApiUrlPref.setOnPreferenceChangeListener(this);</span>

<span class="nc" id="L154">        mAnalyticsPref = findPreference(getString(R.string.preferences_key_analytics));</span>
<span class="nc" id="L155">        mAnalyticsPref.setOnPreferenceChangeListener(this);</span>

<span class="nc" id="L157">        mTravelBehaviorPref = (CheckBoxPreference) findPreference(getString(R.string.preferences_key_travel_behavior));</span>
<span class="nc" id="L158">        mTravelBehaviorPref.setOnPreferenceChangeListener(this);</span>

<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!TravelBehaviorUtils.isTravelBehaviorActiveInRegion() ||</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                (!TravelBehaviorUtils.allowEnrollMoreParticipantsInStudy() &amp;&amp;</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                        !TravelBehaviorUtils.isUserParticipatingInStudy())) {</span>
<span class="nc" id="L163">            PreferenceCategory aboutCategory = (PreferenceCategory)</span>
<span class="nc" id="L164">                    findPreference(getString(R.string.preferences_category_about));</span>
<span class="nc" id="L165">            aboutCategory.removePreference(mTravelBehaviorPref);</span>
<span class="nc" id="L166">        } else {</span>
<span class="nc" id="L167">            mTravelBehaviorPref.setChecked(TravelBehaviorUtils.isUserParticipatingInStudy());</span>
        }

<span class="nc" id="L170">        pushFirebaseData = findPreference(getString(R.string.preference_key_push_firebase_data));</span>
<span class="nc" id="L171">        pushFirebaseData.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L173">        mHideAlertsPref = findPreference(getString(R.string.preference_key_hide_alerts));</span>
<span class="nc" id="L174">        mHideAlertsPref.setOnPreferenceChangeListener(this);</span>

<span class="nc" id="L176">        mTutorialPref = findPreference(getString(R.string.preference_key_tutorial));</span>
<span class="nc" id="L177">        mTutorialPref.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L179">        mDonatePref = findPreference(getString(R.string.preferences_key_donate));</span>
<span class="nc" id="L180">        mDonatePref.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L182">        mPoweredByObaPref = findPreference(getString(R.string.preferences_key_powered_by_oba));</span>
<span class="nc" id="L183">        mPoweredByObaPref.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L185">        mAboutPref = findPreference(getString(R.string.preferences_key_about));</span>
<span class="nc" id="L186">        mAboutPref.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L188">        SharedPreferences settings = Application.getPrefs();</span>
<span class="nc" id="L189">        mAutoSelectInitialValue = settings</span>
<span class="nc" id="L190">                .getBoolean(getString(R.string.preference_key_auto_select_region), true);</span>

<span class="nc" id="L192">        preferredUnits = (ListPreference) findPreference(</span>
<span class="nc" id="L193">                getString(R.string.preference_key_preferred_units));</span>

<span class="nc" id="L195">        mThemePref = (ListPreference) findPreference(</span>
<span class="nc" id="L196">                getString(R.string.preference_key_app_theme));</span>
<span class="nc" id="L197">        mThemePref.setOnPreferenceChangeListener(this);</span>

<span class="nc" id="L199">        settings.registerOnSharedPreferenceChangeListener(this);</span>

<span class="nc" id="L201">        PreferenceScreen preferenceScreen = getPreferenceScreen();</span>
        // Hide any preferences that shouldn't be shown if the region is hard-coded via build flavor
        if (BuildConfig.USE_FIXED_REGION) {
            PreferenceCategory regionCategory = (PreferenceCategory)
                    findPreference(getString(R.string.preferences_category_location));
            regionCategory.removeAll();
            preferenceScreen.removePreference(regionCategory);
            PreferenceCategory advancedCategory = (PreferenceCategory)
                    findPreference(getString(R.string.preferences_category_advanced));
            Preference experimentalRegion = findPreference(
                    getString(R.string.preference_key_experimental_regions));
            advancedCategory.removePreference(experimentalRegion);
        }

        // If the Android version is Oreo (8.0) hide &quot;Notification&quot; preference
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {</span>
<span class="nc" id="L217">            getPreferenceScreen().removePreference(findPreference(getString(R.string.preference_key_notifications)));</span>
        }

        // If the Android version is lower than Nougat (7.0) and equal to or above Pie (9.0) hide &quot;Share trip logs&quot; preference
<span class="nc bnc" id="L221" title="All 4 branches missed.">        if ((Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.N) || (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P)) {</span>
<span class="nc" id="L222">            getPreferenceScreen().removePreference(findPreference(getString(R.string.preferences_key_user_debugging_logs_category)));</span>
        }

        // If its the OBA brand flavor, then show the &quot;Donate&quot; preference and hide &quot;Powered by OBA&quot;
<span class="nc" id="L226">        PreferenceCategory aboutCategory = (PreferenceCategory)</span>
<span class="nc" id="L227">                findPreference(getString(R.string.preferences_category_about));</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (BuildConfig.FLAVOR_brand.equalsIgnoreCase(BuildFlavorUtils.OBA_FLAVOR_BRAND)) {</span>
<span class="nc" id="L229">            aboutCategory.removePreference(mPoweredByObaPref);</span>
        } else {
            // Its not the OBA brand flavor, then hide the &quot;Donate&quot; preference and show &quot;Powered by OBA&quot;
<span class="nc" id="L232">            aboutCategory.removePreference(mDonatePref);</span>
        }

<span class="nc" id="L235">        boolean showCheckRegionDialog = getIntent().getBooleanExtra(SHOW_CHECK_REGION_DIALOG, false);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (showCheckRegionDialog) {</span>
<span class="nc" id="L237">            showCheckRegionDialog();</span>
        }
<span class="nc" id="L239">    }</span>

    @Override
    protected void onResume() {
<span class="nc" id="L243">        super.onResume();</span>

<span class="nc" id="L245">        changePreferenceSummary(getString(R.string.preference_key_region));</span>
<span class="nc" id="L246">        changePreferenceSummary(getString(R.string.preference_key_preferred_units));</span>
<span class="nc" id="L247">        changePreferenceSummary(getString(R.string.preference_key_app_theme));</span>
<span class="nc" id="L248">        changePreferenceSummary(getString(R.string.preference_key_otp_api_url));</span>

        // Remove preferences for notifications if no trip planning
<span class="nc" id="L251">        ObaRegion obaRegion = Application.get().getCurrentRegion();</span>
<span class="nc bnc" id="L252" title="All 4 branches missed.">        if (obaRegion != null &amp;&amp; TextUtils.isEmpty(obaRegion.getOtpBaseUrl())) {</span>
<span class="nc" id="L253">            PreferenceCategory notifications = (PreferenceCategory)</span>
<span class="nc" id="L254">                    findPreference(getString(R.string.preference_key_notifications));</span>
<span class="nc" id="L255">            Preference tripPlan = findPreference(</span>
<span class="nc" id="L256">                    getString(R.string.preference_key_trip_plan_notifications));</span>

<span class="nc bnc" id="L258" title="All 4 branches missed.">            if (notifications != null &amp;&amp; tripPlan != null) {</span>
<span class="nc" id="L259">                notifications.removePreference(tripPlan);</span>
            }
        }
<span class="nc" id="L262">    }</span>

    @Override
    protected void onPostCreate(Bundle savedInstanceState) {
<span class="nc" id="L266">        super.onPostCreate(savedInstanceState);</span>
<span class="nc" id="L267">        setupActionBar();</span>
<span class="nc" id="L268">    }</span>

    private void showCheckRegionDialog() {
<span class="nc" id="L271">        ObaRegion obaRegion = Application.get().getCurrentRegion();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (obaRegion == null) {</span>
<span class="nc" id="L273">            return;</span>
        }

<span class="nc" id="L276">        new AlertDialog.Builder(this)</span>
<span class="nc" id="L277">                .setTitle(getString(R.string.preference_region_dialog_title))</span>
<span class="nc" id="L278">                .setMessage(getString(R.string.preference_region_dialog_message, obaRegion.getName()))</span>
<span class="nc" id="L279">                .setPositiveButton(&quot;OK&quot;, new DialogInterface.OnClickListener() {</span>
                    public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L281">                    }</span>
<span class="nc" id="L282">                }).show();</span>
<span class="nc" id="L283">    }</span>

    /**
     * Changes the summary of a preference based on a given preference key
     *
     * @param preferenceKey preference key that triggers a change in summary
     */
    private void changePreferenceSummary(String preferenceKey) {
        // Change the current region summary and server API URL summary
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_region))</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">                || preferenceKey.equalsIgnoreCase(getString(R.string.preference_key_oba_api_url))) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            if (Application.get().getCurrentRegion() != null) {</span>
<span class="nc" id="L295">                mPreference.setSummary(Application.get().getCurrentRegion().getName());</span>
<span class="nc" id="L296">                mCustomApiUrlPref</span>
<span class="nc" id="L297">                        .setSummary(getString(R.string.preferences_oba_api_servername_summary));</span>
<span class="nc" id="L298">                String customOtpApiUrl = Application.get().getCustomOtpApiUrl();</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                if (!TextUtils.isEmpty(customOtpApiUrl)) {</span>
<span class="nc" id="L300">                    mCustomOtpApiUrlPref.setSummary(customOtpApiUrl);</span>
                } else {
<span class="nc" id="L302">                    mCustomOtpApiUrlPref</span>
<span class="nc" id="L303">                            .setSummary(getString(R.string.preferences_otp_api_servername_summary));</span>
                }
<span class="nc" id="L305">            } else {</span>
<span class="nc" id="L306">                mPreference.setSummary(getString(R.string.preferences_region_summary_custom_api));</span>
<span class="nc" id="L307">                mCustomApiUrlPref.setSummary(Application.get().getCustomApiUrl());</span>
            }
<span class="nc" id="L309">        } else if (preferenceKey</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                .equalsIgnoreCase(getString(R.string.preference_key_preferred_units))) {</span>
<span class="nc" id="L311">            preferredUnits.setSummary(preferredUnits.getValue());</span>
<span class="nc" id="L312">        } else if (preferenceKey</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                .equalsIgnoreCase(getString(R.string.preference_key_app_theme))) {</span>
<span class="nc" id="L314">            mThemePref.setSummary(mThemePref.getValue());</span>
<span class="nc" id="L315">        } else if (preferenceKey</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                .equalsIgnoreCase(getString(R.string.preference_key_otp_api_url))) {</span>
<span class="nc" id="L317">            String customOtpApiUrl = Application.get().getCustomOtpApiUrl();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">            if (!TextUtils.isEmpty(customOtpApiUrl)) {</span>
<span class="nc" id="L319">                mCustomOtpApiUrlPref.setSummary(customOtpApiUrl);</span>
            } else {
<span class="nc" id="L321">                mCustomOtpApiUrlPref.setSummary(</span>
<span class="nc" id="L322">                        getString(R.string.preferences_otp_api_servername_summary));</span>
            }
<span class="nc" id="L324">            Application.get().setUseOldOtpApiUrlVersion(false);</span>
        }
<span class="nc" id="L326">    }</span>

    @Override
    public boolean onPreferenceClick(Preference pref) {
<span class="nc" id="L330">        Log.d(TAG, &quot;preference - &quot; + pref.getKey());</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (pref.equals(mPreference)) {</span>
<span class="nc" id="L332">            RegionsActivity.start(this);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">        } else if (pref.equals(mTutorialPref)) {</span>
<span class="nc" id="L334">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L335">                    getString(R.string.analytics_label_button_press_tutorial),</span>
                    null);
<span class="nc" id="L337">            ShowcaseViewUtils.resetAllTutorials(this);</span>
<span class="nc" id="L338">            NavHelp.goHome(this, true);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        } else if (pref.equals(mDonatePref)) {</span>
<span class="nc" id="L340">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L341">                    getString(R.string.analytics_label_button_press_donate),</span>
                    null);
<span class="nc" id="L343">            Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(getString(R.string.donate_url)));</span>
<span class="nc" id="L344">            startActivity(intent);</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">        } else if (pref.equals(mPoweredByObaPref)) {</span>
<span class="nc" id="L346">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L347">                    getString(R.string.analytics_label_button_press_powered_by_oba),</span>
                    null);
<span class="nc" id="L349">            Intent intent = new Intent(Intent.ACTION_VIEW,</span>
<span class="nc" id="L350">                    Uri.parse(getString(R.string.powered_by_oba_url)));</span>
<span class="nc" id="L351">            startActivity(intent);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">        } else if (pref.equals(mAboutPref)) {</span>
<span class="nc" id="L353">            ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L354">                    getString(R.string.analytics_label_button_press_about),</span>
                    null);
<span class="nc" id="L356">            AboutActivity.start(this);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">        } else if (pref.equals(mSaveBackup)) {</span>
            // SavePreference will get the click event but will ignore it if permissions haven't
            // been granted yet so we can handle permissions here
<span class="nc" id="L360">            maybeRequestPermissions(SAVE_BACKUP_PERMISSION_REQUEST);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        } else if (pref.equals(mRestoreBackup)){</span>
            // RestorePreference will get the click event but will ignore it if permissions haven't
            // been granted yet so we can handle permissions here.
<span class="nc" id="L364">            maybeRequestPermissions(RESTORE_BACKUP_PERMISSION_REQUEST);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">        } else if (pref.equals(pushFirebaseData)) {</span>
            // Try to push firebase data to the server
<span class="nc" id="L367">            FirebaseDataPusher pusher = new FirebaseDataPusher();</span>
<span class="nc" id="L368">            pusher.push(this);</span>
        }
<span class="nc" id="L370">        return true;</span>
    }

    private void maybeRequestPermissions(int permissionRequest) {
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (!PermissionUtils.hasGrantedAllPermissions(this, STORAGE_PERMISSIONS)) {</span>
            // Request permissions from the user
<span class="nc" id="L376">            ActivityCompat.requestPermissions(this, STORAGE_PERMISSIONS, permissionRequest);</span>
        }
<span class="nc" id="L378">    }</span>

    @SuppressLint(&quot;MissingPermission&quot;)
    @Override
    public void onRequestPermissionsResult(
            int requestCode, String[] permissions, int[] grantResults) {
<span class="nc" id="L384">        int result = PackageManager.PERMISSION_DENIED;</span>
<span class="nc bnc" id="L385" title="All 4 branches missed.">        if (requestCode == SAVE_BACKUP_PERMISSION_REQUEST || requestCode == RESTORE_BACKUP_PERMISSION_REQUEST) {</span>
<span class="nc bnc" id="L386" title="All 4 branches missed.">            if (grantResults.length &gt; 0 &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc" id="L387">                result = PackageManager.PERMISSION_GRANTED;</span>
                // User granted permission
<span class="nc bnc" id="L389" title="All 2 branches missed.">                if (requestCode == SAVE_BACKUP_PERMISSION_REQUEST) {</span>
<span class="nc" id="L390">                    BackupUtils.save(this);</span>
                } else {
                    // For restore, ask them to browse to the backup file, because after targeting Android 11 we can't just access it directly
                    // This is automatically invoked by RestorePreference.onClick(), so do nothing here
                }
            } else {
<span class="nc" id="L396">                showStoragePermissionDialog(this, requestCode);</span>
            }
        }
<span class="nc" id="L399">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L403">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (requestCode == REQUEST_CODE_RESTORE_BACKUP) {</span>
<span class="nc" id="L405">            BackupUtils.restore(this, data.getData());</span>
        }
<span class="nc" id="L407">    }</span>

    /**
     * Shows the dialog to explain why storage permissions are needed
     * @param activity Activity used to show the dialog
     * @param requestCode The requesting permission code (SAVE_BACKUP_PERMISSION_REQUEST or RESTORE_BACKUP_PERMISSION_REQUEST)
     */
    private void showStoragePermissionDialog(Activity activity, int requestCode) {
<span class="nc" id="L415">        androidx.appcompat.app.AlertDialog.Builder builder = new androidx.appcompat.app.AlertDialog.Builder(this)</span>
<span class="nc" id="L416">                .setTitle(R.string.storage_permissions_title)</span>
<span class="nc" id="L417">                .setMessage(R.string.storage_permissions_message)</span>
<span class="nc" id="L418">                .setCancelable(false)</span>
<span class="nc" id="L419">                .setPositiveButton(R.string.ok,</span>
                        (dialog, which) -&gt; {
                            // Request permissions from the user
<span class="nc" id="L422">                            ActivityCompat</span>
<span class="nc" id="L423">                                    .requestPermissions(activity, STORAGE_PERMISSIONS, requestCode);</span>
<span class="nc" id="L424">                        }</span>
                )
<span class="nc" id="L426">                .setNegativeButton(R.string.no_thanks,</span>
                        (dialog, which) -&gt; {
                            // No-op
<span class="nc" id="L429">                        }</span>
                );
<span class="nc" id="L431">        builder.create().show();</span>
<span class="nc" id="L432">    }</span>

    @Override
    public boolean onPreferenceChange(Preference preference, Object newValue) {
<span class="nc bnc" id="L436" title="All 4 branches missed.">        if (preference.equals(mCustomApiUrlPref) &amp;&amp; newValue instanceof String) {</span>
<span class="nc" id="L437">            String apiUrl = (String) newValue;</span>

<span class="nc bnc" id="L439" title="All 2 branches missed.">            if (!TextUtils.isEmpty(apiUrl)) {</span>
<span class="nc" id="L440">                boolean validUrl = validateUrl(apiUrl);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                if (!validUrl) {</span>
<span class="nc" id="L442">                    Toast.makeText(this, getString(R.string.custom_api_url_error),</span>
<span class="nc" id="L443">                            Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L444">                    return false;</span>
                }
                //User entered a custom API Url, so set the region info to null
<span class="nc" id="L447">                Application.get().setCurrentRegion(null);</span>
<span class="nc" id="L448">                Log.d(TAG, &quot;User entered new API URL, set region to null.&quot;);</span>
<span class="nc" id="L449">            } else {</span>
                //User cleared the API URL preference value, so re-initialize regions
<span class="nc" id="L451">                Log.d(TAG, &quot;User entered blank API URL, re-initializing regions...&quot;);</span>
<span class="nc" id="L452">                NavHelp.goHome(this, false);</span>
            }
        }
<span class="nc bnc" id="L455" title="All 4 branches missed.">        if (preference.equals(mCustomOtpApiUrlPref) &amp;&amp; newValue instanceof String) {</span>
<span class="nc" id="L456">            String apiUrl = (String) newValue;</span>

<span class="nc bnc" id="L458" title="All 2 branches missed.">            if (!TextUtils.isEmpty(apiUrl)) {</span>
<span class="nc" id="L459">                boolean validUrl = validateUrl(apiUrl);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                if (!validUrl) {</span>
<span class="nc" id="L461">                    Toast.makeText(this, getString(R.string.custom_otp_api_url_error),</span>
<span class="nc" id="L462">                            Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L463">                    return false;</span>
                }
            }
<span class="nc" id="L466">            mOtpCustomAPIUrlChanged = true;</span>
<span class="nc bnc" id="L467" title="All 4 branches missed.">        } else if (preference.equals(mAnalyticsPref) &amp;&amp; newValue instanceof Boolean) {</span>
<span class="nc" id="L468">            Boolean isAnalyticsActive = (Boolean) newValue;</span>
            //Report if the analytics turns off, just before shared preference changed
<span class="nc" id="L470">            ObaAnalytics.setSendAnonymousData(mFirebaseAnalytics, isAnalyticsActive);</span>
<span class="nc bnc" id="L471" title="All 4 branches missed.">        } else if (preference.equals(mTravelBehaviorPref) &amp;&amp; newValue instanceof Boolean) {</span>
<span class="nc" id="L472">            Boolean activateTravelBehaviorCollection = (Boolean) newValue;</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">            if (activateTravelBehaviorCollection) {</span>
<span class="nc" id="L474">                new TravelBehaviorManager(this, getApplicationContext()).</span>
<span class="nc" id="L475">                        registerTravelBehaviorParticipant(true);</span>
            } else {
<span class="nc" id="L477">                showOptOutDialog();</span>
<span class="nc" id="L478">                return false;</span>
            }
<span class="nc bnc" id="L480" title="All 4 branches missed.">        } else if (preference.equals(mLeftHandMode) &amp;&amp; newValue instanceof Boolean) {</span>
<span class="nc" id="L481">            Boolean isLeftHandEnabled = (Boolean) newValue;</span>
            //Report if left handed mode is turned on, just before shared preference changed
<span class="nc" id="L483">            ObaAnalytics.setLeftHanded(mFirebaseAnalytics, isLeftHandEnabled);</span>
<span class="nc bnc" id="L484" title="All 4 branches missed.">        } else if (preference.equals(mHideAlertsPref) &amp;&amp; newValue instanceof Boolean) {</span>
<span class="nc" id="L485">            Boolean hideAlerts = (Boolean) newValue;</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">            if (hideAlerts) {</span>
<span class="nc" id="L487">                ObaContract.ServiceAlerts.hideAllAlerts();</span>
            }
        }
<span class="nc" id="L490">        return true;</span>
    }

    /**
     * Shows the dialog to explain user is choosing to opt out of travel behavior research study
     */
    private void showOptOutDialog() {
<span class="nc" id="L497">        androidx.appcompat.app.AlertDialog.Builder builder = new androidx.appcompat.app.AlertDialog.Builder(this)</span>
<span class="nc" id="L498">                .setTitle(R.string.travel_behavior_dialog_opt_out_title)</span>
<span class="nc" id="L499">                .setMessage(R.string.travel_behavior_dialog_opt_out_message)</span>
<span class="nc" id="L500">                .setCancelable(false)</span>
<span class="nc" id="L501">                .setPositiveButton(R.string.ok,</span>
                        (dialog, which) -&gt; {
                            // Remove user from study
<span class="nc" id="L504">                            new TravelBehaviorManager(this, getApplicationContext()).</span>
<span class="nc" id="L505">                                    stopCollectingData();</span>
<span class="nc" id="L506">                            TravelBehaviorManager.optOutUser();</span>
<span class="nc" id="L507">                            TravelBehaviorManager.optOutUserOnServer();</span>
                            // Change preference
<span class="nc" id="L509">                            mTravelBehaviorPref.setChecked(false);</span>
<span class="nc" id="L510">                            PreferenceUtils.saveBoolean(getString(R.string.preferences_key_travel_behavior), false);</span>
<span class="nc" id="L511">                        }</span>
                )
<span class="nc" id="L513">                .setNegativeButton(R.string.cancel,</span>
                        (dialog, which) -&gt; {
                            // No-op
<span class="nc" id="L516">                        }</span>
                );
<span class="nc" id="L518">        builder.create().show();</span>
<span class="nc" id="L519">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc" id="L523">        SharedPreferences settings = Application.getPrefs();</span>
<span class="nc" id="L524">        boolean currentValue = settings</span>
<span class="nc" id="L525">                .getBoolean(getString(R.string.preference_key_auto_select_region), true);</span>

        //If the use has selected to auto-select region, and the previous state of the setting was false, 
        //then run the auto-select by going to HomeFragment
<span class="nc bnc" id="L529" title="All 4 branches missed.">        if ((currentValue &amp;&amp; !mAutoSelectInitialValue)) {</span>
<span class="nc" id="L530">            Log.d(TAG,</span>
                    &quot;User re-enabled auto-select regions pref, auto-selecting via Home Activity...&quot;);
<span class="nc" id="L532">            NavHelp.goHome(this, false);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">        } else if (mOtpCustomAPIUrlChanged) {</span>
            // Redraw the navigation drawer when custom otp api url is entered
<span class="nc" id="L535">            NavHelp.goHome(this, false);</span>
        }

<span class="nc" id="L538">        super.onDestroy();</span>
<span class="nc" id="L539">    }</span>

    @Override
    public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) {
<span class="nc" id="L543">        SharedPreferences settings = Application.getPrefs();</span>
        // Listening to changes to a custom Preference doesn't seem to work, so we can listen to changes to the shared pref value instead
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (key.equals(getString(R.string.preference_key_experimental_regions))) {</span>
<span class="nc" id="L546">            boolean experimentalServers = settings</span>
<span class="nc" id="L547">                    .getBoolean(getString(R.string.preference_key_experimental_regions), false);</span>
<span class="nc" id="L548">            Log.d(TAG, &quot;Experimental regions shared preference changed to &quot; + experimentalServers);</span>

            /*
            Force a refresh of the regions list, but don't using blocking progress dialog
            inside the ObaRegionsTask AsyncTask.
            We need to use our own Action Bar progress bar here so its linked to this activity,
            which will survive orientation changes.
            */
<span class="nc" id="L556">            setProgressBarIndeterminateVisibility(true);</span>
<span class="nc" id="L557">            List&lt;ObaRegionsTask.Callback&gt; callbacks = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L558">            callbacks.add(this);</span>
<span class="nc" id="L559">            ObaRegionsTask task = new ObaRegionsTask(this, callbacks, true, false);</span>
<span class="nc" id="L560">            task.execute();</span>

            // Wait to change the region preference description until the task callback
            //Analytics
<span class="nc bnc" id="L564" title="All 2 branches missed.">            if (experimentalServers) {</span>
<span class="nc" id="L565">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L566">                        getString(R.string.analytics_label_button_press_experimental_on),</span>
                        null);
            } else {
<span class="nc" id="L569">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L570">                        getString(R.string.analytics_label_button_press_experimental_off),</span>
                        null);
            }
<span class="nc bnc" id="L573" title="All 2 branches missed.">        } else if (key.equals(getString(R.string.preference_key_oba_api_url))) {</span>
            // Change the region preference description to show we're not using a region
<span class="nc" id="L575">            changePreferenceSummary(key);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">        } else if (key.equals(getString(R.string.preference_key_otp_api_url))) {</span>
            // Change the otp url preference description
<span class="nc" id="L578">            changePreferenceSummary(key);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">        } else if (key.equalsIgnoreCase(getString(R.string.preference_key_preferred_units))) {</span>
            // Change the preferred units description
<span class="nc" id="L581">            changePreferenceSummary(key);</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">        } else if (key.equalsIgnoreCase(getString(R.string.preference_key_app_theme))) {</span>
            // Change the app theme preference description
<span class="nc" id="L584">            changePreferenceSummary(key);</span>
            // Update the app theme
<span class="nc" id="L586">            setAppTheme(settings.getString(key, getString(R.string.preferences_app_theme_option_system_default)));</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">        } else if (key.equalsIgnoreCase(getString(R.string.preference_key_auto_select_region))) {</span>
            //Analytics
<span class="nc" id="L589">            boolean autoSelect = settings</span>
<span class="nc" id="L590">                    .getBoolean(getString(R.string.preference_key_auto_select_region), true);</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">            if (autoSelect) {</span>
<span class="nc" id="L592">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L593">                        getString(R.string.analytics_label_button_press_auto),</span>
                        null);
            } else {
<span class="nc" id="L596">                ObaAnalytics.reportUiEvent(mFirebaseAnalytics,</span>
<span class="nc" id="L597">                        getString(R.string.analytics_label_button_press_manual),</span>
                        null);
            }
<span class="nc bnc" id="L600" title="All 2 branches missed.">        } else if (key.equalsIgnoreCase(getString(R.string.preferences_key_analytics))) {</span>
<span class="nc" id="L601">            Boolean isAnalyticsActive = settings.getBoolean(Application.get().</span>
<span class="nc" id="L602">                    getString(R.string.preferences_key_analytics), Boolean.TRUE);</span>
            //Report if the analytics turns on, just after shared preference changed
<span class="nc" id="L604">            ObaAnalytics.setSendAnonymousData(mFirebaseAnalytics, isAnalyticsActive);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        } else if (key.equalsIgnoreCase(getString(R.string.preference_key_arrival_info_style))) {</span>
            // Change the arrival info description
<span class="nc" id="L607">            changePreferenceSummary(key);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        } else if (key.equalsIgnoreCase(getString(R.string.preference_key_show_negative_arrivals))) {</span>
<span class="nc" id="L609">            boolean showDepartedBuses = settings.getBoolean(Application.get().</span>
<span class="nc" id="L610">                    getString(R.string.preference_key_show_negative_arrivals), Boolean.FALSE);</span>
<span class="nc" id="L611">            ObaAnalytics.setShowDepartedVehicles(mFirebaseAnalytics, showDepartedBuses);</span>
        }
<span class="nc" id="L613">    }</span>

    /**
     * Returns true if the provided apiUrl could be a valid URL, false if it could not
     *
     * @param apiUrl the URL to validate
     * @return true if the provided apiUrl could be a valid URL, false if it could not
     */
    private boolean validateUrl(String apiUrl) {
        try {
            // URI.parse() doesn't tell us if the scheme is missing, so use URL() instead (#126)
<span class="nc" id="L624">            URL url = new URL(apiUrl);</span>
<span class="nc" id="L625">        } catch (MalformedURLException e) {</span>
            // Assume HTTPS scheme if none is provided
<span class="nc" id="L627">            apiUrl = getString(R.string.https_prefix) + apiUrl;</span>
<span class="nc" id="L628">        }</span>
<span class="nc" id="L629">        return Patterns.WEB_URL.matcher(apiUrl).matches();</span>
    }

    /**
     * Imitate Action Bar with back button - from http://stackoverflow.com/a/27455363/937715
     */
    private void setupActionBar() {
<span class="nc" id="L636">        LinearLayout root = (LinearLayout) findViewById(android.R.id.list).getParent()</span>
<span class="nc" id="L637">                .getParent().getParent();</span>
<span class="nc" id="L638">        Toolbar bar = (Toolbar) LayoutInflater.from(this)</span>
<span class="nc" id="L639">                .inflate(R.layout.settings_toolbar, root, false);</span>
<span class="nc" id="L640">        root.addView(bar, 0); // insert at top</span>

<span class="nc" id="L642">        bar.setNavigationOnClickListener(v -&gt; finish());</span>
<span class="nc" id="L643">    }</span>

    //
    // Region Task Callback
    //
    public void onRegionTaskFinished(boolean currentRegionChanged) {
<span class="nc" id="L649">        setProgressBarIndeterminateVisibility(false);</span>

<span class="nc bnc" id="L651" title="All 2 branches missed.">        if (currentRegionChanged) {</span>
            // If region was auto-selected, show user the region we're using
<span class="nc" id="L653">            if (Application.getPrefs()</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">                    .getBoolean(getString(R.string.preference_key_auto_select_region), true)</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                    &amp;&amp; Application.get().getCurrentRegion() != null) {</span>
<span class="nc" id="L656">                Toast.makeText(this,</span>
<span class="nc" id="L657">                        getString(R.string.region_region_found,</span>
<span class="nc" id="L658">                                Application.get().getCurrentRegion().getName()),</span>
                        Toast.LENGTH_LONG
<span class="nc" id="L660">                ).show();</span>
            }

            // Update the preference summary to show the newly selected region
<span class="nc" id="L664">            changePreferenceSummary(getString(R.string.preference_key_region));</span>

            // Since the current region was updated as a result of enabling/disabling experimental servers, go home
<span class="nc" id="L667">            NavHelp.goHome(this, false);</span>
        }
<span class="nc" id="L669">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>