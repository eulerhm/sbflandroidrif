<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SchedulerTask.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.tripservice</a> &gt; <span class="el_source">SchedulerTask.java</span></div><h1>SchedulerTask.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2016 Paul Watts (paulcwatts@gmail.com),
 * University of South Florida (sjbarbeau@gmail.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.tripservice;

import org.onebusaway.android.provider.ObaContract;

import android.content.ContentResolver;
import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.net.Uri;
import android.text.format.Time;

/**
 * This is the runnable that implements scheduling of trips (for the reminder feature).
 * It can schedule one or many trips, depending on the URI.
 *
 * @author paulw
 */
public final class SchedulerTask implements Runnable {
    //private static final String TAG = &quot;SchedulerTask&quot;;

    private static final long ONE_MINUTE = 60 * 1000;

    private static final long LOOKAHEAD_DURATION_MS = 5 * ONE_MINUTE;

<span class="nc" id="L41">    private static final String[] PROJECTION = {</span>
            ObaContract.Trips._ID,
            ObaContract.Trips.STOP_ID,
            ObaContract.Trips.REMINDER,
            ObaContract.Trips.DEPARTURE,
            ObaContract.Trips.DAYS
    };

    private static final int COL_ID = 0;

    private static final int COL_STOP_ID = 1;

    private static final int COL_REMINDER = 2;

    private static final int COL_DEPARTURE = 3;

    private static final int COL_DAYS = 4;

    private final Context mContext;

    private final ContentResolver mCR;

    private final TaskContext mTaskContext;

    private final Uri mUri;

<span class="nc" id="L67">    public SchedulerTask(Context context, TaskContext taskContext, Uri uri) {</span>
<span class="nc" id="L68">        mContext = context;</span>
<span class="nc" id="L69">        mCR = mContext.getContentResolver();</span>
<span class="nc" id="L70">        mTaskContext = taskContext;</span>
<span class="nc" id="L71">        mUri = uri;</span>
<span class="nc" id="L72">    }</span>

    @Override
    public void run() {
<span class="nc" id="L76">        cleanupOldAlerts();</span>
<span class="nc" id="L77">        Cursor c = mCR.query(mUri, PROJECTION, null, null, null);</span>

        try {
<span class="nc" id="L80">            Time tNow = new Time();</span>
<span class="nc" id="L81">            tNow.setToNow();</span>
<span class="nc" id="L82">            final long now = tNow.toMillis(false);</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (c != null) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                while (c.moveToNext()) {</span>
<span class="nc" id="L86">                    schedule1(c, tNow, now);</span>
                }
            }
        } finally {
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (c != null) {</span>
<span class="nc" id="L91">                c.close();</span>
            }
<span class="nc" id="L93">            mTaskContext.taskComplete();</span>
        }
<span class="nc" id="L95">    }</span>

    // This schedules an alarm to go off when we need it to start polling,
    // and instantiates an TripAlert in the database if needed.

    private void schedule1(Cursor c, Time tNow, long now) {
<span class="nc" id="L101">        final String tripId = c.getString(COL_ID);</span>
<span class="nc" id="L102">        final String stopId = c.getString(COL_STOP_ID);</span>
<span class="nc" id="L103">        final Uri tripUri = ObaContract.Trips.buildUri(tripId, stopId);</span>

<span class="nc" id="L105">        final int departureMins = c.getInt(COL_DEPARTURE);</span>
<span class="nc" id="L106">        final long reminderMS = c.getInt(COL_REMINDER) * ONE_MINUTE;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (reminderMS == 0) {</span>
<span class="nc" id="L108">            return;</span>
        }
<span class="nc" id="L110">        final int days = c.getInt(COL_DAYS);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (days == 0) {</span>
<span class="nc" id="L112">            Time tmp = new Time();</span>
<span class="nc" id="L113">            tmp.set(0, departureMins, 0, tNow.monthDay, tNow.month, tNow.year);</span>
<span class="nc" id="L114">            tmp.normalize(false);</span>
<span class="nc" id="L115">            long remindTime = tmp.toMillis(false) - reminderMS;</span>
<span class="nc" id="L116">            long triggerTime = remindTime - LOOKAHEAD_DURATION_MS;</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (!scheduleAlert(tripUri, tripId, stopId, triggerTime)) {</span>
                // If we failed to schedule a one-off alert, then it's
                // probably been cancelled or in the past and we should
                // just delete it.
<span class="nc" id="L122">                mCR.delete(tripUri, null, null);</span>
            }
<span class="nc" id="L124">        } else {</span>
<span class="nc" id="L125">            final int currentWeekDay = tNow.weekDay;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            for (int i = 0; i &lt; 7; ++i) {</span>
<span class="nc" id="L127">                final int day = (currentWeekDay + i) % 7;</span>
<span class="nc" id="L128">                final int bit = ObaContract.Trips.getDayBit(day);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if ((days &amp; bit) == bit) {</span>
<span class="nc" id="L130">                    Time tmp = new Time();</span>
<span class="nc" id="L131">                    tmp.set(0, departureMins, 0, tNow.monthDay + i, tNow.month,</span>
                            tNow.year);
<span class="nc" id="L133">                    tmp.normalize(false);</span>
<span class="nc" id="L134">                    long remindTime = tmp.toMillis(false) - reminderMS;</span>
<span class="nc" id="L135">                    long triggerTime = remindTime - LOOKAHEAD_DURATION_MS;</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">                    if (scheduleAlert(tripUri, tripId, stopId, triggerTime)) {</span>
<span class="nc" id="L138">                        return;</span>
                    }
                }
            }
        }
<span class="nc" id="L143">    }</span>

    private boolean scheduleAlert(Uri uri,
                                  String tripId,
                                  String stopId,
                                  long triggerTime) {

<span class="nc" id="L150">        Time tmp = new Time();</span>
<span class="nc" id="L151">        tmp.set(triggerTime);</span>
        //Log.d(TAG, &quot;Scheduling poll: &quot; + uri.toString() + &quot;  &quot;
        //        + tmp.format2445());

        // Check to see if this alert has already been cancelled.
<span class="nc" id="L156">        Uri alertUri = null;</span>

<span class="nc" id="L158">        Cursor cAlert = mCR.query(ObaContract.TripAlerts.CONTENT_URI,</span>
                new String[]{ObaContract.TripAlerts._ID, ObaContract.TripAlerts.STATE},
<span class="nc" id="L160">                String.format(&quot;%s=? AND %s=? AND %s=?&quot;,</span>
                        ObaContract.TripAlerts.TRIP_ID,
                        ObaContract.TripAlerts.STOP_ID,
                        ObaContract.TripAlerts.START_TIME),
<span class="nc" id="L164">                new String[]{tripId, stopId, String.valueOf(triggerTime)},</span>
                null);

<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (cAlert != null) {</span>
            try {
<span class="nc bnc" id="L169" title="All 2 branches missed.">                if (cAlert.moveToNext()) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                    if (cAlert.getInt(1) == ObaContract.TripAlerts.STATE_CANCELLED) {</span>
<span class="nc" id="L171">                        return false;</span>
                    }
<span class="nc" id="L173">                    alertUri = ObaContract.TripAlerts.buildUri(cAlert.getInt(0));</span>

                }
            } finally {
<span class="nc" id="L177">                cAlert.close();</span>
            }
        }
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (alertUri == null) {</span>
            // Insert a new trip alert.
<span class="nc" id="L182">            ContentValues values = new ContentValues();</span>
<span class="nc" id="L183">            values.put(ObaContract.TripAlerts.TRIP_ID, tripId);</span>
<span class="nc" id="L184">            values.put(ObaContract.TripAlerts.STOP_ID, stopId);</span>
<span class="nc" id="L185">            values.put(ObaContract.TripAlerts.START_TIME, triggerTime);</span>
<span class="nc" id="L186">            alertUri = mCR.insert(ObaContract.TripAlerts.CONTENT_URI, values);</span>
        }

        // Should we schedule it in every case here??? What about when it's
        // already polling???
<span class="nc" id="L191">        TripService.pollTrip(mContext, alertUri, triggerTime);</span>
<span class="nc" id="L192">        return true;</span>
    }

    /**
     * Remove any alerts that are more than 24 hours in the past.
     */
    private void cleanupOldAlerts() {
<span class="nc" id="L199">        long then = System.currentTimeMillis() - ONE_MINUTE * 60 * 24;</span>

<span class="nc" id="L201">        mCR.delete(ObaContract.TripAlerts.CONTENT_URI,</span>
                ObaContract.TripAlerts.START_TIME + &quot; &lt; &quot; + then,
                null);
<span class="nc" id="L204">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>