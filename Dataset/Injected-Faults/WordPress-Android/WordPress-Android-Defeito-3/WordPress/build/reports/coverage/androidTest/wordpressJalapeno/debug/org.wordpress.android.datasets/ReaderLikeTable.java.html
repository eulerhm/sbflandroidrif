<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderLikeTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.datasets</a> &gt; <span class="el_source">ReaderLikeTable.java</span></div><h1>ReaderLikeTable.java</h1><pre class="source lang-java linenums">package org.wordpress.android.datasets;

import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteStatement;

import org.wordpress.android.models.ReaderComment;
import org.wordpress.android.models.ReaderPost;
import org.wordpress.android.models.ReaderUserIdList;
import org.wordpress.android.util.SqlUtils;

/**
 * stores likes for Reader posts and comments
 */
<span class="nc" id="L16">public class ReaderLikeTable {</span>
    protected static void createTables(SQLiteDatabase db) {
<span class="nc" id="L18">        db.execSQL(&quot;CREATE TABLE tbl_post_likes (&quot;</span>
                   + &quot; post_id INTEGER DEFAULT 0,&quot;
                   + &quot; blog_id INTEGER DEFAULT 0,&quot;
                   + &quot; user_id INTEGER DEFAULT 0,&quot;
                   + &quot; PRIMARY KEY (blog_id, post_id, user_id))&quot;);

<span class="nc" id="L24">        db.execSQL(&quot;CREATE TABLE tbl_comment_likes (&quot;</span>
                   + &quot; comment_id INTEGER DEFAULT 0,&quot;
                   + &quot; blog_id INTEGER DEFAULT 0,&quot;
                   + &quot; user_id INTEGER DEFAULT 0,&quot;
                   + &quot; PRIMARY KEY (blog_id, comment_id, user_id))&quot;);
<span class="nc" id="L29">    }</span>

    protected static void dropTables(SQLiteDatabase db) {
<span class="nc" id="L32">        db.execSQL(&quot;DROP TABLE IF EXISTS tbl_post_likes&quot;);</span>
<span class="nc" id="L33">        db.execSQL(&quot;DROP TABLE IF EXISTS tbl_comment_likes&quot;);</span>
<span class="nc" id="L34">    }</span>

    protected static void reset(SQLiteDatabase db) {
<span class="nc" id="L37">        dropTables(db);</span>
<span class="nc" id="L38">        createTables(db);</span>
<span class="nc" id="L39">    }</span>

    /*
     * purge likes attached to posts/comments that no longer exist
     */
    protected static int purge(SQLiteDatabase db) {
<span class="nc" id="L45">        int numDeleted = db.delete(&quot;tbl_post_likes&quot;, &quot;post_id NOT IN (SELECT DISTINCT post_id FROM tbl_posts)&quot;, null);</span>
<span class="nc" id="L46">        numDeleted += db.delete(&quot;tbl_comment_likes&quot;, &quot;comment_id NOT IN (SELECT DISTINCT comment_id FROM tbl_comments)&quot;,</span>
                                null);
<span class="nc" id="L48">        return numDeleted;</span>
    }

    /*
     * returns userIds of users who like the passed post
     */
    public static ReaderUserIdList getLikesForPost(ReaderPost post) {
<span class="nc" id="L55">        ReaderUserIdList userIds = new ReaderUserIdList();</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L57">            return userIds;</span>
        }

<span class="nc" id="L60">        String[] args = {Long.toString(post.blogId), Long.toString(post.postId)};</span>
<span class="nc" id="L61">        Cursor c = ReaderDatabase.getReadableDb()</span>
<span class="nc" id="L62">                                 .rawQuery(&quot;SELECT user_id FROM tbl_post_likes WHERE blog_id=? AND post_id=?&quot;, args);</span>
        try {
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L66">                    userIds.add(c.getLong(0));</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }

<span class="nc" id="L70">            return userIds;</span>
        } finally {
<span class="nc" id="L72">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static int getNumLikesForPost(ReaderPost post) {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L78">            return 0;</span>
        }
<span class="nc" id="L80">        String[] args = {Long.toString(post.blogId), Long.toString(post.postId)};</span>
<span class="nc" id="L81">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                                    &quot;SELECT count(*) FROM tbl_post_likes WHERE blog_id=? AND post_id=?&quot;, args);
    }

    public static void setCurrentUserLikesPost(ReaderPost post, boolean isLiked, long wpComUserId) {
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L87">            return;</span>
        }
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (isLiked) {</span>
<span class="nc" id="L90">            ContentValues values = new ContentValues();</span>
<span class="nc" id="L91">            values.put(&quot;blog_id&quot;, post.blogId);</span>
<span class="nc" id="L92">            values.put(&quot;post_id&quot;, post.postId);</span>
<span class="nc" id="L93">            values.put(&quot;user_id&quot;, wpComUserId);</span>
<span class="nc" id="L94">            ReaderDatabase.getWritableDb().insert(&quot;tbl_post_likes&quot;, null, values);</span>
<span class="nc" id="L95">        } else {</span>
<span class="nc" id="L96">            String[] args = {Long.toString(post.blogId), Long.toString(post.postId), Long.toString(wpComUserId)};</span>
<span class="nc" id="L97">            ReaderDatabase.getWritableDb().delete(&quot;tbl_post_likes&quot;, &quot;blog_id=? AND post_id=? AND user_id=?&quot;, args);</span>
        }
<span class="nc" id="L99">    }</span>

    public static void setLikesForPost(ReaderPost post, ReaderUserIdList userIds) {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L103">            return;</span>
        }

<span class="nc" id="L106">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L107">        db.beginTransaction();</span>
<span class="nc" id="L108">        SQLiteStatement stmt =</span>
<span class="nc" id="L109">                db.compileStatement(&quot;INSERT INTO tbl_post_likes (blog_id, post_id, user_id) VALUES (?1,?2,?3)&quot;);</span>
        try {
            // first delete all likes for this post
<span class="nc" id="L112">            String[] args = {Long.toString(post.blogId), Long.toString(post.postId)};</span>
<span class="nc" id="L113">            db.delete(&quot;tbl_post_likes&quot;, &quot;blog_id=? AND post_id=?&quot;, args);</span>

            // now insert the passed likes
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (userIds != null) {</span>
<span class="nc" id="L117">                stmt.bindLong(1, post.blogId);</span>
<span class="nc" id="L118">                stmt.bindLong(2, post.postId);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                for (Long userId : userIds) {</span>
<span class="nc" id="L120">                    stmt.bindLong(3, userId);</span>
<span class="nc" id="L121">                    stmt.execute();</span>
<span class="nc" id="L122">                }</span>
            }

<span class="nc" id="L125">            db.setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L127">            db.endTransaction();</span>
<span class="nc" id="L128">            SqlUtils.closeStatement(stmt);</span>
        }
<span class="nc" id="L130">    }</span>


    /****
     * comment likes
     */

    public static ReaderUserIdList getLikesForComment(ReaderComment comment) {
<span class="nc" id="L138">        ReaderUserIdList userIds = new ReaderUserIdList();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (comment == null) {</span>
<span class="nc" id="L140">            return userIds;</span>
        }

<span class="nc" id="L143">        String[] args = {Long.toString(comment.blogId),</span>
<span class="nc" id="L144">                Long.toString(comment.commentId)};</span>
<span class="nc" id="L145">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(</span>
                &quot;SELECT user_id FROM tbl_comment_likes WHERE blog_id=? AND comment_id=?&quot;, args);
        try {
<span class="nc bnc" id="L148" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L150">                    userIds.add(c.getLong(0));</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }

<span class="nc" id="L154">            return userIds;</span>
        } finally {
<span class="nc" id="L156">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static int getNumLikesForComment(ReaderComment comment) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (comment == null) {</span>
<span class="nc" id="L162">            return 0;</span>
        }
<span class="nc" id="L164">        String[] args = {Long.toString(comment.blogId),</span>
<span class="nc" id="L165">                Long.toString(comment.commentId)};</span>
<span class="nc" id="L166">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                                    &quot;SELECT count(*) FROM tbl_comment_likes WHERE blog_id=? AND comment_id=?&quot;, args);
    }

    public static void setCurrentUserLikesComment(ReaderComment comment, boolean isLiked, long wpComUserId) {
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (comment == null) {</span>
<span class="nc" id="L172">            return;</span>
        }

<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (isLiked) {</span>
<span class="nc" id="L176">            ContentValues values = new ContentValues();</span>
<span class="nc" id="L177">            values.put(&quot;blog_id&quot;, comment.blogId);</span>
<span class="nc" id="L178">            values.put(&quot;comment_id&quot;, comment.commentId);</span>
<span class="nc" id="L179">            values.put(&quot;user_id&quot;, wpComUserId);</span>
<span class="nc" id="L180">            ReaderDatabase.getWritableDb().insert(&quot;tbl_comment_likes&quot;, null, values);</span>
<span class="nc" id="L181">        } else {</span>
<span class="nc" id="L182">            String[] args = {Long.toString(comment.blogId),</span>
<span class="nc" id="L183">                    Long.toString(comment.commentId),</span>
<span class="nc" id="L184">                    Long.toString(wpComUserId)};</span>
<span class="nc" id="L185">            ReaderDatabase.getWritableDb().delete(&quot;tbl_comment_likes&quot;,</span>
                                                  &quot;blog_id=? AND comment_id=? AND user_id=?&quot;, args);
        }
<span class="nc" id="L188">    }</span>

    public static void setLikesForComment(ReaderComment comment, ReaderUserIdList userIds) {
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (comment == null) {</span>
<span class="nc" id="L192">            return;</span>
        }

<span class="nc" id="L195">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L196">        db.beginTransaction();</span>
<span class="nc" id="L197">        SQLiteStatement stmt = db.compileStatement(</span>
                &quot;INSERT INTO tbl_comment_likes (blog_id, comment_id, user_id) VALUES (?1,?2,?3)&quot;);
        try {
<span class="nc" id="L200">            String[] args = {Long.toString(comment.blogId),</span>
<span class="nc" id="L201">                    Long.toString(comment.commentId)};</span>
<span class="nc" id="L202">            db.delete(&quot;tbl_comment_likes&quot;, &quot;blog_id=? AND comment_id=?&quot;, args);</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (userIds != null) {</span>
<span class="nc" id="L205">                stmt.bindLong(1, comment.blogId);</span>
<span class="nc" id="L206">                stmt.bindLong(2, comment.commentId);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                for (Long userId : userIds) {</span>
<span class="nc" id="L208">                    stmt.bindLong(3, userId);</span>
<span class="nc" id="L209">                    stmt.execute();</span>
<span class="nc" id="L210">                }</span>
            }

<span class="nc" id="L213">            db.setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L215">            db.endTransaction();</span>
<span class="nc" id="L216">            SqlUtils.closeStatement(stmt);</span>
        }
<span class="nc" id="L218">    }</span>
}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>