<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WPWebViewViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.viewmodel.wpwebview</a> &gt; <span class="el_source">WPWebViewViewModel.kt</span></div><h1>WPWebViewViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.viewmodel.wpwebview

import androidx.annotation.DrawableRes
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.LifecycleOwner
import androidx.lifecycle.LifecycleRegistry
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.Observer
import androidx.lifecycle.ViewModel
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.ui.PreviewMode
import org.wordpress.android.ui.PreviewMode.DESKTOP
import org.wordpress.android.ui.PreviewMode.MOBILE
import org.wordpress.android.ui.PreviewMode.TABLET
import org.wordpress.android.ui.PreviewModeHandler
import org.wordpress.android.ui.WPWebViewUsageCategory
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.util.DisplayUtilsWrapper
import org.wordpress.android.util.NetworkUtilsWrapper
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.viewmodel.SingleLiveEvent
import org.wordpress.android.viewmodel.helpers.ConnectionStatus
import org.wordpress.android.viewmodel.helpers.ConnectionStatus.AVAILABLE
import org.wordpress.android.viewmodel.wpwebview.WPWebViewViewModel.WebPreviewUiState.WebPreviewContentUiState
import org.wordpress.android.viewmodel.wpwebview.WPWebViewViewModel.WebPreviewUiState.WebPreviewFullscreenProgressUiState
import org.wordpress.android.viewmodel.wpwebview.WPWebViewViewModel.WebPreviewUiState.WebPreviewFullscreenUiState.WebPreviewFullscreenErrorUiState
import javax.inject.Inject

class WPWebViewViewModel
<span class="nc" id="L32">@Inject constructor(</span>
<span class="nc" id="L33">    private val displayUtils: DisplayUtilsWrapper,</span>
<span class="nc" id="L34">    private val networkUtils: NetworkUtilsWrapper,</span>
<span class="nc" id="L35">    private val analyticsTrackerWrapper: AnalyticsTrackerWrapper,</span>
    connectionStatus: LiveData&lt;ConnectionStatus&gt;
<span class="nc" id="L37">) : ViewModel(), PreviewModeHandler {</span>
    private var isStarted = false
<span class="nc" id="L39">    private var wpWebViewUsageCategory: WPWebViewUsageCategory = WPWebViewUsageCategory.WEBVIEW_STANDARD</span>

<span class="nc" id="L41">    private val _uiState: MutableLiveData&lt;WebPreviewUiState&gt; = MutableLiveData()</span>
<span class="nc" id="L42">    val uiState: LiveData&lt;WebPreviewUiState&gt; = _uiState</span>
<span class="nc" id="L43">    private val _loadNeeded = SingleLiveEvent&lt;Boolean&gt;()</span>
<span class="nc" id="L44">    val loadNeeded: LiveData&lt;Boolean&gt; = _loadNeeded</span>

<span class="nc" id="L46">    private val _navigateBack = SingleLiveEvent&lt;Unit&gt;()</span>
<span class="nc" id="L47">    val navigateBack: LiveData&lt;Unit&gt; = _navigateBack</span>

<span class="nc" id="L49">    private val _navigateForward = SingleLiveEvent&lt;Unit&gt;()</span>
<span class="nc" id="L50">    val navigateForward: LiveData&lt;Unit&gt; = _navigateForward</span>

<span class="nc" id="L52">    private val _share = SingleLiveEvent&lt;Unit&gt;()</span>
<span class="nc" id="L53">    val share: LiveData&lt;Unit&gt; = _share</span>

<span class="nc" id="L55">    private val _openInExternalBrowser = SingleLiveEvent&lt;Unit&gt;()</span>
<span class="nc" id="L56">    val openExternalBrowser: LiveData&lt;Unit&gt; = _openInExternalBrowser</span>

<span class="nc" id="L58">    private val _previewModeSelector = MutableLiveData&lt;PreviewModeSelectorStatus&gt;()</span>
<span class="nc" id="L59">    val previewModeSelector: LiveData&lt;PreviewModeSelectorStatus&gt; = _previewModeSelector</span>

<span class="nc" id="L61">    private val _navbarUiState: MutableLiveData&lt;NavBarUiState&gt; = MutableLiveData()</span>
<span class="nc" id="L62">    val navbarUiState: LiveData&lt;NavBarUiState&gt; = _navbarUiState</span>

<span class="nc" id="L64">    private val _previewMode: MutableLiveData&lt;PreviewMode&gt; = MutableLiveData()</span>
<span class="nc" id="L65">    val previewMode: LiveData&lt;PreviewMode&gt; = _previewMode</span>

<span class="nc" id="L67">    private val lifecycleOwner = object : LifecycleOwner {</span>
<span class="nc" id="L68">        val lifecycleRegistry = LifecycleRegistry(this)</span>
<span class="nc" id="L69">        override fun getLifecycle(): Lifecycle = lifecycleRegistry</span>
    }

    private val defaultPreviewMode: PreviewMode
<span class="nc bnc" id="L73" title="All 2 branches missed.">        get() = if (displayUtils.isTablet()) TABLET else MOBILE</span>

<span class="nc" id="L75">    init {</span>
<span class="nc" id="L76">        lifecycleOwner.lifecycleRegistry.currentState = Lifecycle.State.CREATED</span>
<span class="nc" id="L77">        connectionStatus.observe(lifecycleOwner, Observer {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (it == AVAILABLE) {</span>
<span class="nc" id="L79">                loadIfNecessary()</span>
            }
<span class="nc" id="L81">        })</span>
<span class="nc" id="L82">    }</span>

    fun start(webViewUsageCategory: WPWebViewUsageCategory) {
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (isStarted) {</span>
<span class="nc" id="L86">            return</span>
        }
<span class="nc" id="L88">        isStarted = true</span>
<span class="nc" id="L89">        wpWebViewUsageCategory = webViewUsageCategory</span>
<span class="nc" id="L90">        _navbarUiState.value = NavBarUiState(</span>
<span class="nc" id="L91">                forwardNavigationEnabled = false,</span>
<span class="nc" id="L92">                backNavigationEnabled = false,</span>
<span class="nc" id="L93">                previewModeHintVisible = false,</span>
<span class="nc" id="L94">                reviewHintResId = getPreviewHintResId(defaultPreviewMode)</span>
        )
<span class="nc" id="L96">        _previewMode.value = defaultPreviewMode</span>
<span class="nc" id="L97">        _previewModeSelector.value = PreviewModeSelectorStatus(</span>
<span class="nc" id="L98">                isVisible = false,</span>
<span class="nc" id="L99">                isEnabled = false,</span>
<span class="nc" id="L100">                selectedPreviewMode = defaultPreviewMode</span>
        )

<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (WPWebViewUsageCategory.isActionableDirectUsage(wpWebViewUsageCategory)) {</span>
<span class="nc" id="L104">            updateUiState(WPWebViewUsageCategory.actionableDirectUsageToWebPreviewUiState(wpWebViewUsageCategory))</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        } else if (networkUtils.isNetworkAvailable()) {</span>
<span class="nc" id="L106">            updateUiState(WebPreviewFullscreenProgressUiState)</span>
        } else {
<span class="nc" id="L108">            updateUiState(WebPreviewFullscreenErrorUiState())</span>
        }
<span class="nc" id="L110">        lifecycleOwner.lifecycleRegistry.currentState = Lifecycle.State.STARTED</span>
<span class="nc" id="L111">    }</span>

    override fun onCleared() {
<span class="nc" id="L114">        lifecycleOwner.lifecycleRegistry.currentState = Lifecycle.State.DESTROYED</span>
<span class="nc" id="L115">        super.onCleared()</span>
<span class="nc" id="L116">    }</span>

    private fun updateUiState(uiState: WebPreviewUiState) {
<span class="nc" id="L119">        _uiState.value = uiState</span>
<span class="nc" id="L120">    }</span>

    /**
     * Update the ui state if the Loading or Error screen is being shown.
     * In other words don't update it after a configuration change.
     */
    fun onUrlLoaded() {
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (uiState.value !is WebPreviewContentUiState) {</span>
<span class="nc" id="L128">            updateUiState(WebPreviewContentUiState)</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">            _previewModeSelector.value = _previewModeSelector.value?.copy(isEnabled = true)</span>
        }
<span class="nc" id="L131">        _loadNeeded.value = false</span>
<span class="nc" id="L132">    }</span>

    /**
     * Update the ui state if the Loading or Success screen is being shown.
     */
    fun onReceivedError() {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (uiState.value is WebPreviewContentUiState) {</span>
<span class="nc" id="L139">            return</span>
        }
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (uiState.value !is WebPreviewFullscreenErrorUiState) {</span>
<span class="nc" id="L142">            updateUiState(WebPreviewFullscreenErrorUiState())</span>
        }
<span class="nc" id="L144">        _loadNeeded.value = false</span>
<span class="nc" id="L145">    }</span>

    fun loadIfNecessary() {
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (isActionableDirectUsage()) return</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (uiState.value !is WebPreviewFullscreenProgressUiState &amp;&amp;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                uiState.value !is WebPreviewContentUiState</span>
        ) {
<span class="nc" id="L153">            updateUiState(WebPreviewFullscreenProgressUiState)</span>
<span class="nc" id="L154">            _loadNeeded.value = true</span>
        }
<span class="nc" id="L156">    }</span>

<span class="nc" id="L158">    fun isActionableDirectUsage() = WPWebViewUsageCategory.isActionableDirectUsage(wpWebViewUsageCategory)</span>

<span class="nc" id="L160">    fun getMenuUiState() = wpWebViewUsageCategory.menuUiState</span>

    fun navigateBack() {
<span class="nc" id="L163">        analyticsTrackerWrapper.track(Stat.WEBVIEW_NAVIGATED_BACK)</span>
<span class="nc" id="L164">        _navigateBack.call()</span>
<span class="nc" id="L165">    }</span>

    fun navigateForward() {
<span class="nc" id="L168">        analyticsTrackerWrapper.track(Stat.WEBVIEW_NAVIGATED_FORWARD)</span>
<span class="nc" id="L169">        _navigateForward.call()</span>
<span class="nc" id="L170">    }</span>

    fun toggleBackNavigation(isEnabled: Boolean) {
<span class="nc" id="L173">        _navbarUiState.value = navbarUiState.value!!.copy(backNavigationEnabled = isEnabled)</span>
<span class="nc" id="L174">    }</span>

    fun toggleForwardNavigation(isEnabled: Boolean) {
<span class="nc" id="L177">        _navbarUiState.value = navbarUiState.value!!.copy(forwardNavigationEnabled = isEnabled)</span>
<span class="nc" id="L178">    }</span>

    fun share() {
<span class="nc" id="L181">        analyticsTrackerWrapper.track(Stat.WEBVIEW_SHARE_TAPPED)</span>
<span class="nc" id="L182">        _share.call()</span>
<span class="nc" id="L183">    }</span>

    fun openPageInExternalBrowser() {
<span class="nc" id="L186">        analyticsTrackerWrapper.track(Stat.WEBVIEW_OPEN_IN_BROWSER_TAPPED)</span>
<span class="nc" id="L187">        _openInExternalBrowser.call()</span>
<span class="nc" id="L188">    }</span>

    fun togglePreviewModeSelectorVisibility(isVisible: Boolean) {
<span class="nc" id="L191">        _previewModeSelector.value = PreviewModeSelectorStatus(isVisible, true, previewMode.value!!)</span>
<span class="nc" id="L192">    }</span>

    fun selectPreviewMode(selectedPreviewMode: PreviewMode) {
<span class="nc" id="L195">        analyticsTrackerWrapper.track(</span>
<span class="nc" id="L196">                Stat.WEBVIEW_PREVIEW_DEVICE_CHANGED,</span>
<span class="nc" id="L197">                mapOf(TRACK_SELECTED_OPTION_NAME to selectedPreviewMode.name.lowercase())</span>
        )
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (previewMode.value != selectedPreviewMode) {</span>
<span class="nc" id="L200">            _previewMode.value = selectedPreviewMode</span>
<span class="nc" id="L201">            _navbarUiState.value =</span>
<span class="nc" id="L202">                    navbarUiState.value!!.copy(</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">                            previewModeHintVisible = selectedPreviewMode != MOBILE,</span>
<span class="nc" id="L204">                            reviewHintResId = getPreviewHintResId(selectedPreviewMode)</span>
                    )
<span class="nc" id="L206">            updateUiState(WebPreviewFullscreenProgressUiState)</span>
        }
<span class="nc" id="L208">    }</span>

    fun track(stat: Stat) {
<span class="nc" id="L211">        analyticsTrackerWrapper.track(stat)</span>
<span class="nc" id="L212">    }</span>

<span class="nc bnc" id="L214" title="All 3 branches missed.">    private fun getPreviewHintResId(previewMode: PreviewMode) = when (previewMode) {</span>
<span class="nc" id="L215">        MOBILE -&gt; R.string.web_preview_mobile</span>
<span class="nc" id="L216">        TABLET -&gt; R.string.web_preview_tablet</span>
<span class="nc" id="L217">        DESKTOP -&gt; R.string.web_preview_desktop</span>
<span class="nc" id="L218">    }</span>

<span class="nc" id="L220">    data class NavBarUiState(</span>
<span class="nc" id="L221">        val forwardNavigationEnabled: Boolean,</span>
<span class="nc" id="L222">        val backNavigationEnabled: Boolean,</span>
<span class="nc" id="L223">        val previewModeHintVisible: Boolean,</span>
<span class="nc" id="L224">        val reviewHintResId: Int</span>
    )

<span class="nc" id="L227">    data class PreviewModeSelectorStatus(</span>
<span class="nc" id="L228">        val isVisible: Boolean,</span>
<span class="nc" id="L229">        val isEnabled: Boolean,</span>
<span class="nc" id="L230">        val selectedPreviewMode: PreviewMode</span>
    )

<span class="nc" id="L233">    sealed class WebPreviewUiState(</span>
<span class="nc" id="L234">        val fullscreenProgressLayoutVisibility: Boolean = false,</span>
<span class="nc" id="L235">        val actionableEmptyView: Boolean = false</span>
    ) {
<span class="nc" id="L237">        object WebPreviewContentUiState : WebPreviewUiState()</span>

<span class="nc" id="L239">        object WebPreviewFullscreenProgressUiState : WebPreviewUiState(</span>
<span class="nc" id="L240">                fullscreenProgressLayoutVisibility = true</span>
        )

<span class="nc" id="L243">        sealed class WebPreviewFullscreenUiState : WebPreviewUiState(actionableEmptyView = true) {</span>
            abstract val imageRes: Int
            abstract val titleText: UiStringRes?
            abstract val subtitleText: UiStringRes?
            abstract val buttonVisibility: Boolean

<span class="nc" id="L249">            data class WebPreviewFullscreenErrorUiState(</span>
<span class="nc" id="L250">                @DrawableRes</span>
<span class="nc" id="L251">                override val imageRes: Int = R.drawable.img_illustration_cloud_off_152dp,</span>
<span class="nc" id="L252">                override val titleText: UiStringRes = UiStringRes(R.string.error_browser_no_network),</span>
<span class="nc" id="L253">                override val subtitleText: UiStringRes = UiStringRes(R.string.error_network_connection),</span>
<span class="nc" id="L254">                override val buttonVisibility: Boolean = true</span>
<span class="nc" id="L255">            ) : WebPreviewFullscreenUiState()</span>

<span class="nc" id="L257">            object WebPreviewFullscreenNotAvailableUiState : WebPreviewFullscreenUiState() {</span>
                @DrawableRes
<span class="nc" id="L259">                override val imageRes: Int = R.drawable.img_illustration_empty_results_216dp</span>
<span class="nc" id="L260">                override val titleText: UiStringRes = UiStringRes(R.string.preview_unavailable_self_hosted_sites)</span>
<span class="nc" id="L261">                override val subtitleText: UiStringRes? = null</span>
<span class="nc" id="L262">                override val buttonVisibility: Boolean = false</span>
            }
        }
<span class="nc" id="L265">    }</span>

<span class="nc bnc" id="L267" title="All 2 branches missed.">    override fun selectedPreviewMode(): PreviewMode = _previewMode.value ?: defaultPreviewMode</span>

    override fun onPreviewModeChanged(mode: PreviewMode) {
<span class="nc" id="L270">        togglePreviewModeSelectorVisibility(false)</span>
<span class="nc" id="L271">        selectPreviewMode(mode)</span>
<span class="nc" id="L272">    }</span>

    companion object {
        const val TRACK_SELECTED_OPTION_NAME = &quot;selected_option_name&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>