<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderSubsActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader</a> &gt; <span class="el_source">ReaderSubsActivity.java</span></div><h1>ReaderSubsActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader;

import android.content.Intent;
import android.os.Bundle;
import android.text.TextUtils;
import android.view.View;
import android.view.ViewGroup;
import android.view.inputmethod.EditorInfo;
import android.webkit.URLUtil;
import android.widget.EditText;
import android.widget.ProgressBar;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentPagerAdapter;
import androidx.viewpager.widget.PagerAdapter;
import androidx.viewpager.widget.ViewPager;

import com.google.android.material.elevation.ElevationOverlayProvider;
import com.google.android.material.floatingactionbutton.FloatingActionButton;
import com.google.android.material.snackbar.Snackbar;
import com.google.android.material.tabs.TabLayout;

import org.greenrobot.eventbus.EventBus;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.datasets.ReaderBlogTable;
import org.wordpress.android.datasets.ReaderTagTable;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.models.ReaderTag;
import org.wordpress.android.models.ReaderTagType;
import org.wordpress.android.ui.LocaleAwareActivity;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.reader.actions.ReaderActions;
import org.wordpress.android.ui.reader.actions.ReaderBlogActions;
import org.wordpress.android.ui.reader.actions.ReaderTagActions;
import org.wordpress.android.ui.reader.adapters.ReaderBlogAdapter.ReaderBlogType;
import org.wordpress.android.ui.reader.adapters.ReaderTagAdapter;
import org.wordpress.android.ui.reader.services.update.ReaderUpdateLogic.UpdateTask;
import org.wordpress.android.ui.reader.services.update.ReaderUpdateServiceStarter;
import org.wordpress.android.ui.reader.tracker.ReaderTracker;
import org.wordpress.android.ui.reader.utils.ReaderUtils;
import org.wordpress.android.ui.reader.views.ReaderFollowButton;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.EditTextUtils;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.UrlUtils;
import org.wordpress.android.widgets.WPSnackbar;
import org.wordpress.android.widgets.WPViewPager;

import java.util.ArrayList;
import java.util.EnumSet;
import java.util.List;

import javax.inject.Inject;

/**
 * activity which shows the user's subscriptions - includes
 * followed tags and followed blogs
 */
<span class="nc" id="L70">public class ReaderSubsActivity extends LocaleAwareActivity</span>
        implements ReaderTagAdapter.TagDeletedListener {
    private EditText mEditAdd;
    private FloatingActionButton mFabButton;
    private ReaderFollowButton mBtnAdd;
    private WPViewPager mViewPager;
    private SubsPageAdapter mPageAdapter;

    private String mLastAddedTagName;
    private boolean mHasPerformedUpdate;

    private static final String KEY_LAST_ADDED_TAG_NAME = &quot;last_added_tag_name&quot;;

    private static final int NUM_TABS = 3;

    public static final int TAB_IDX_FOLLOWED_TAGS = 0;
    public static final int TAB_IDX_FOLLOWED_BLOGS = 1;

    @Inject AccountStore mAccountStore;
    @Inject ReaderTracker mReaderTracker;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L93">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L94">        ((WordPress) getApplication()).component().inject(this);</span>

<span class="nc" id="L96">        setContentView(R.layout.reader_activity_subs);</span>
<span class="nc" id="L97">        restoreState(savedInstanceState);</span>

<span class="nc" id="L99">        mViewPager = findViewById(R.id.viewpager);</span>
<span class="nc" id="L100">        mViewPager.setOffscreenPageLimit(NUM_TABS - 1);</span>
<span class="nc" id="L101">        mViewPager.setAdapter(getPageAdapter());</span>

<span class="nc" id="L103">        TabLayout tabLayout = findViewById(R.id.tab_layout);</span>
<span class="nc" id="L104">        tabLayout.setTabMode(TabLayout.MODE_SCROLLABLE);</span>
<span class="nc" id="L105">        tabLayout.setupWithViewPager(mViewPager);</span>

<span class="nc" id="L107">        Toolbar toolbar = findViewById(R.id.toolbar_main);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (toolbar != null) {</span>
<span class="nc" id="L109">            setSupportActionBar(toolbar);</span>
<span class="nc" id="L110">            toolbar.setNavigationOnClickListener(v -&gt; onBackPressed());</span>
        }

<span class="nc" id="L113">        ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (actionBar != null) {</span>
            // Shadow removed on Activities with a tab toolbar
<span class="nc" id="L116">            actionBar.setDisplayShowTitleEnabled(true);</span>
<span class="nc" id="L117">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
        }

<span class="nc" id="L120">        View bottomBar = findViewById(R.id.layout_bottom);</span>

<span class="nc" id="L122">        ElevationOverlayProvider elevationOverlayProvider = new ElevationOverlayProvider(this);</span>
<span class="nc" id="L123">        float appbarElevation = getResources().getDimension(R.dimen.appbar_elevation);</span>
<span class="nc" id="L124">        int elevatedColor = elevationOverlayProvider.compositeOverlayWithThemeSurfaceColorIfNeeded(appbarElevation);</span>

<span class="nc" id="L126">        bottomBar.setBackgroundColor(elevatedColor);</span>

<span class="nc" id="L128">        mEditAdd = findViewById(R.id.edit_add);</span>
<span class="nc" id="L129">        mEditAdd.setOnEditorActionListener((v, actionId, event) -&gt; {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (actionId == EditorInfo.IME_ACTION_DONE) {</span>
<span class="nc" id="L131">                addCurrentEntry();</span>
            }
<span class="nc" id="L133">            return false;</span>
        });

<span class="nc" id="L136">        mFabButton = findViewById(R.id.fab_button);</span>
<span class="nc" id="L137">        mFabButton.setOnClickListener(view -&gt; ReaderActivityLauncher.showReaderInterests(this));</span>

<span class="nc" id="L139">        mBtnAdd = findViewById(R.id.btn_add);</span>
<span class="nc" id="L140">        mBtnAdd.setOnClickListener(v -&gt; addCurrentEntry());</span>

<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
            // return to the page the user was on the last time they viewed this activity
<span class="nc" id="L144">            restorePreviousPage();</span>
        }

        // note this listener must be assigned after we've already called restorePreviousPage()
<span class="nc" id="L148">        mViewPager.addOnPageChangeListener(new ViewPager.SimpleOnPageChangeListener() {</span>
            @Override
            public void onPageSelected(int position) {
                // remember which page the user last viewed
<span class="nc" id="L152">                String pageTitle = (String) getPageAdapter().getPageTitle(position);</span>
<span class="nc" id="L153">                AppPrefs.setReaderSubsPageTitle(pageTitle);</span>
<span class="nc" id="L154">            }</span>
        });

<span class="nc" id="L157">        mReaderTracker.track(Stat.READER_MANAGE_VIEW_DISPLAYED);</span>
<span class="nc" id="L158">    }</span>

    @Override
    protected void onPause() {
<span class="nc" id="L162">        EventBus.getDefault().unregister(this);</span>
<span class="nc" id="L163">        super.onPause();</span>
<span class="nc" id="L164">    }</span>

    @Override
    protected void onResume() {
<span class="nc" id="L168">        super.onResume();</span>
<span class="nc" id="L169">        EventBus.getDefault().register(this);</span>

        // update list of tags and blogs from the server
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (!mHasPerformedUpdate) {</span>
<span class="nc" id="L173">            performUpdate();</span>
        }
<span class="nc" id="L175">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ReaderEvents.FollowedTagsChanged event) {
<span class="nc" id="L180">        AppLog.d(AppLog.T.READER, &quot;reader subs &gt; followed tags changed&quot;);</span>
<span class="nc" id="L181">        getPageAdapter().refreshFollowedTagFragment();</span>
<span class="nc" id="L182">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ReaderEvents.FollowedBlogsChanged event) {
<span class="nc" id="L187">        AppLog.d(AppLog.T.READER, &quot;reader subs &gt; followed blogs changed&quot;);</span>
<span class="nc" id="L188">        getPageAdapter().refreshBlogFragments(ReaderBlogType.FOLLOWED);</span>
<span class="nc" id="L189">    }</span>

    private void performUpdate() {
<span class="nc" id="L192">        performUpdate(EnumSet.of(</span>
                UpdateTask.TAGS,
                UpdateTask.FOLLOWED_BLOGS));
<span class="nc" id="L195">    }</span>

    private void performUpdate(EnumSet&lt;UpdateTask&gt; tasks) {
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!NetworkUtils.isNetworkAvailable(this)) {</span>
<span class="nc" id="L199">            return;</span>
        }

<span class="nc" id="L202">        ReaderUpdateServiceStarter.startService(this, tasks);</span>
<span class="nc" id="L203">        mHasPerformedUpdate = true;</span>
<span class="nc" id="L204">    }</span>

    private void restoreState(Bundle state) {
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (state != null) {</span>
<span class="nc" id="L208">            mLastAddedTagName = state.getString(KEY_LAST_ADDED_TAG_NAME);</span>
<span class="nc" id="L209">            mHasPerformedUpdate = state.getBoolean(ReaderConstants.KEY_ALREADY_UPDATED);</span>
        }
<span class="nc" id="L211">    }</span>

    private SubsPageAdapter getPageAdapter() {
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (mPageAdapter == null) {</span>
<span class="nc" id="L215">            List&lt;Fragment&gt; fragments = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L217">            fragments.add(ReaderTagFragment.newInstance());</span>
<span class="nc" id="L218">            fragments.add(ReaderBlogFragment.newInstance(ReaderBlogType.FOLLOWED));</span>

<span class="nc" id="L220">            FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L221">            mPageAdapter = new SubsPageAdapter(fm, fragments);</span>
        }
<span class="nc" id="L223">        return mPageAdapter;</span>
    }

    private boolean hasPageAdapter() {
<span class="nc bnc" id="L227" title="All 2 branches missed.">        return mPageAdapter != null;</span>
    }

    @Override
    public void onSaveInstanceState(@NonNull Bundle outState) {
<span class="nc" id="L232">        outState.putBoolean(ReaderConstants.KEY_ALREADY_UPDATED, mHasPerformedUpdate);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (mLastAddedTagName != null) {</span>
<span class="nc" id="L234">            outState.putString(KEY_LAST_ADDED_TAG_NAME, mLastAddedTagName);</span>
        }
<span class="nc" id="L236">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L237">    }</span>

    @Override
    public void onBackPressed() {
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (!TextUtils.isEmpty(mLastAddedTagName)) {</span>
<span class="nc" id="L242">            EventBus.getDefault().postSticky(new ReaderEvents.TagAdded(mLastAddedTagName));</span>
        }
<span class="nc" id="L244">        mReaderTracker.track(Stat.READER_MANAGE_VIEW_DISMISSED);</span>
<span class="nc" id="L245">        super.onBackPressed();</span>
<span class="nc" id="L246">    }</span>

    /*
     * follow the tag or url the user typed into the EditText
     */
    private void addCurrentEntry() {
<span class="nc" id="L252">        String entry = EditTextUtils.getText(mEditAdd).trim();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (TextUtils.isEmpty(entry)) {</span>
<span class="nc" id="L254">            return;</span>
        }

        // is it a url or a tag?
<span class="nc bnc" id="L258" title="All 2 branches missed.">        boolean isUrl = !entry.contains(&quot; &quot;)</span>
<span class="nc bnc" id="L259" title="All 4 branches missed.">                        &amp;&amp; (entry.contains(&quot;.&quot;) || entry.contains(&quot;://&quot;));</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (isUrl) {</span>
<span class="nc" id="L261">            addAsUrl(entry);</span>
        } else {
<span class="nc" id="L263">            addAsTag(entry);</span>
        }
<span class="nc" id="L265">    }</span>

    /*
     * follow editText entry as a tag
     */
    private void addAsTag(final String entry) {
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (TextUtils.isEmpty(entry)) {</span>
<span class="nc" id="L272">            return;</span>
        }

<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (!ReaderTag.isValidTagName(entry)) {</span>
<span class="nc" id="L276">            showInfoSnackbar(getString(R.string.reader_toast_err_tag_invalid));</span>
<span class="nc" id="L277">            return;</span>
        }

<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (ReaderTagTable.isFollowedTagName(entry)) {</span>
<span class="nc" id="L281">            showInfoSnackbar(getString(R.string.reader_toast_err_tag_exists));</span>
<span class="nc" id="L282">            return;</span>
        }

        // tag is valid, follow it
<span class="nc" id="L286">        mEditAdd.setText(null);</span>
<span class="nc" id="L287">        EditTextUtils.hideSoftInput(mEditAdd);</span>
<span class="nc" id="L288">        performAddTag(entry);</span>
<span class="nc" id="L289">    }</span>

    /*
     * follow editText entry as a url
     */
    private void addAsUrl(final String entry) {
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (TextUtils.isEmpty(entry)) {</span>
<span class="nc" id="L296">            return;</span>
        }

        // normalize the url and prepend protocol if not supplied
        final String normUrl;
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (!entry.contains(&quot;://&quot;)) {</span>
<span class="nc" id="L302">            normUrl = UrlUtils.normalizeUrl(&quot;http://&quot; + entry);</span>
        } else {
<span class="nc" id="L304">            normUrl = UrlUtils.normalizeUrl(entry);</span>
        }

        // if this isn't a valid URL, add original entry as a tag
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (!URLUtil.isNetworkUrl(normUrl)) {</span>
<span class="nc" id="L309">            addAsTag(entry);</span>
<span class="nc" id="L310">            return;</span>
        }

        // make sure it isn't already followed
<span class="nc bnc" id="L314" title="All 4 branches missed.">        if (ReaderBlogTable.isFollowedBlogUrl(normUrl) || ReaderBlogTable.isFollowedFeedUrl(normUrl)) {</span>
<span class="nc" id="L315">            showInfoSnackbar(getString(R.string.reader_toast_err_already_follow_blog));</span>
<span class="nc" id="L316">            return;</span>
        }

        // URL is valid, so follow it
<span class="nc" id="L320">        performAddUrl(normUrl);</span>
<span class="nc" id="L321">    }</span>

    /*
     * called when user manually enters a tag - passed tag is assumed to be validated
     */
    private void performAddTag(final String tagName) {
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(this)) {</span>
<span class="nc" id="L328">            return;</span>
        }

<span class="nc" id="L331">        showProgress();</span>
<span class="nc" id="L332">        final ReaderTag tag = ReaderUtils.createTagFromTagName(tagName, ReaderTagType.FOLLOWED);</span>

<span class="nc" id="L334">        ReaderActions.ActionListener actionListener = succeeded -&gt; {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (isFinishing()) {</span>
<span class="nc" id="L336">                return;</span>
            }

<span class="nc" id="L339">            hideProgress();</span>
<span class="nc" id="L340">            getPageAdapter().refreshFollowedTagFragment();</span>

<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (succeeded) {</span>
<span class="nc" id="L343">                showInfoSnackbar(getString(R.string.reader_label_added_tag, tag.getLabel()));</span>
<span class="nc" id="L344">                mLastAddedTagName = tag.getTagSlug();</span>
<span class="nc" id="L345">                mReaderTracker.trackTag(</span>
                        AnalyticsTracker.Stat.READER_TAG_FOLLOWED,
                        mLastAddedTagName,
                        ReaderTracker.SOURCE_SETTINGS
                );
            } else {
<span class="nc" id="L351">                showInfoSnackbar(getString(R.string.reader_toast_err_add_tag));</span>
<span class="nc" id="L352">                mLastAddedTagName = null;</span>
            }
<span class="nc" id="L354">        };</span>

<span class="nc" id="L356">        ReaderTagActions.addTag(tag, actionListener, mAccountStore.hasAccessToken());</span>
<span class="nc" id="L357">    }</span>

    /*
     * start a two-step process to follow a blog by url:
     * 1. test whether the url is reachable (API will follow any url, even if it doesn't exist)
     * 2. perform the actual follow
     * note that the passed URL is assumed to be normalized and validated
     */
    private void performAddUrl(final String blogUrl) {
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(this)) {</span>
<span class="nc" id="L367">            return;</span>
        }

<span class="nc" id="L370">        showProgress();</span>

<span class="nc" id="L372">        ReaderActions.OnRequestListener&lt;Void&gt; requestListener = new ReaderActions.OnRequestListener&lt;Void&gt;() {</span>
            @Override
            public void onSuccess(Void result) {
<span class="nc bnc" id="L375" title="All 2 branches missed.">                if (!isFinishing()) {</span>
<span class="nc" id="L376">                    followBlogUrl(blogUrl);</span>
                }
<span class="nc" id="L378">            }</span>

            @Override
            public void onFailure(int statusCode) {
<span class="nc bnc" id="L382" title="All 2 branches missed.">                if (!isFinishing()) {</span>
<span class="nc" id="L383">                    hideProgress();</span>
                    String errMsg;
<span class="nc bnc" id="L385" title="All 3 branches missed.">                    switch (statusCode) {</span>
                        case 401:
<span class="nc" id="L387">                            errMsg = getString(R.string.reader_toast_err_follow_blog_not_authorized);</span>
<span class="nc" id="L388">                            break;</span>
                        case 0: // can happen when host name not found
                        case 404:
<span class="nc" id="L391">                            errMsg = getString(R.string.reader_toast_err_follow_blog_not_found);</span>
<span class="nc" id="L392">                            break;</span>
                        default:
<span class="nc" id="L394">                            errMsg = getString(R.string.reader_toast_err_follow_blog) + &quot; (&quot; + statusCode + &quot;)&quot;;</span>
                            break;
                    }
<span class="nc" id="L397">                    showInfoSnackbar(errMsg);</span>
                }
<span class="nc" id="L399">            }</span>
        };
<span class="nc" id="L401">        ReaderBlogActions.checkUrlReachable(blogUrl, requestListener);</span>
<span class="nc" id="L402">    }</span>

    private void followBlogUrl(String normUrl) {
<span class="nc" id="L405">        ReaderActions.ActionListener followListener = succeeded -&gt; {</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">            if (isFinishing()) {</span>
<span class="nc" id="L407">                return;</span>
            }
<span class="nc" id="L409">            hideProgress();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">            if (succeeded) {</span>
                // clear the edit text and hide the soft keyboard
<span class="nc" id="L412">                mEditAdd.setText(null);</span>
<span class="nc" id="L413">                EditTextUtils.hideSoftInput(mEditAdd);</span>
<span class="nc" id="L414">                showInfoSnackbar(getString(R.string.reader_label_followed_blog));</span>
<span class="nc" id="L415">                getPageAdapter().refreshBlogFragments(ReaderBlogType.FOLLOWED);</span>
                // update tags if the site we added belongs to a tag we don't yet have
                // also update followed blogs so lists are ready in case we need to present them
                // in bottom sheet reader filtering
<span class="nc" id="L419">                performUpdate(EnumSet.of(UpdateTask.TAGS, UpdateTask.FOLLOWED_BLOGS));</span>
            } else {
<span class="nc" id="L421">                showInfoSnackbar(getString(R.string.reader_toast_err_follow_blog));</span>
            }
<span class="nc" id="L423">        };</span>
        // note that this uses the endpoint to follow as a feed since typed URLs are more
        // likely to point to a feed than a wp blog (and the endpoint should internally
        // follow it as a blog if it is one)
<span class="nc" id="L427">        ReaderBlogActions.followFeedByUrl(</span>
                normUrl,
                followListener,
                ReaderTracker.SOURCE_SETTINGS,
                mReaderTracker
        );
<span class="nc" id="L433">    }</span>

    /*
     * called prior to following to show progress and disable controls
     */
    private void showProgress() {
<span class="nc" id="L439">        final ProgressBar progress = findViewById(R.id.progress_follow);</span>
<span class="nc" id="L440">        progress.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L441">        mEditAdd.setEnabled(false);</span>
<span class="nc" id="L442">        mBtnAdd.setEnabled(false);</span>
<span class="nc" id="L443">    }</span>

    /*
     * called after following to hide progress and re-enable controls
     */
    private void hideProgress() {
<span class="nc" id="L449">        final ProgressBar progress = findViewById(R.id.progress_follow);</span>
<span class="nc" id="L450">        progress.setVisibility(View.GONE);</span>
<span class="nc" id="L451">        mEditAdd.setEnabled(true);</span>
<span class="nc" id="L452">        mBtnAdd.setEnabled(true);</span>
<span class="nc" id="L453">    }</span>

    /*
     * Snackbar message shown when adding/removing or something goes wrong
     */
    private void showInfoSnackbar(String text) {
<span class="nc" id="L459">        View bottomView = findViewById(R.id.layout_bottom);</span>

<span class="nc" id="L461">        Snackbar snackbar = WPSnackbar.make(bottomView, text, Snackbar.LENGTH_LONG);</span>
<span class="nc" id="L462">        snackbar.setAnchorView(bottomView);</span>
<span class="nc" id="L463">        snackbar.show();</span>
<span class="nc" id="L464">    }</span>

    /*
     * triggered by a tag fragment's adapter after user removes a tag - note that the network
     * request has already been made when this is called
     */
    @Override
    public void onTagDeleted(ReaderTag tag) {
<span class="nc" id="L472">        mReaderTracker.trackTag(</span>
                AnalyticsTracker.Stat.READER_TAG_UNFOLLOWED,
<span class="nc" id="L474">                tag.getTagSlug(),</span>
                ReaderTracker.SOURCE_SETTINGS
        );
<span class="nc bnc" id="L477" title="All 4 branches missed.">        if (mLastAddedTagName != null &amp;&amp; mLastAddedTagName.equalsIgnoreCase(tag.getTagSlug())) {</span>
<span class="nc" id="L478">            mLastAddedTagName = null;</span>
        }
<span class="nc" id="L480">        String labelRemovedTag = getString(R.string.reader_label_removed_tag);</span>
<span class="nc" id="L481">        showInfoSnackbar(String.format(labelRemovedTag, tag.getLabel()));</span>
<span class="nc" id="L482">    }</span>

    /*
     * return to the previously selected page in the viewPager
     */
    private void restorePreviousPage() {
<span class="nc bnc" id="L488" title="All 4 branches missed.">        if (mViewPager == null || !hasPageAdapter()) {</span>
<span class="nc" id="L489">            return;</span>
        }

<span class="nc" id="L492">        String pageTitle = AppPrefs.getReaderSubsPageTitle();</span>

<span class="nc bnc" id="L494" title="All 2 branches missed.">        if (getIntent().hasExtra(ReaderConstants.ARG_SUBS_TAB_POSITION)) {</span>
<span class="nc" id="L495">            PagerAdapter adapter = getPageAdapter();</span>
<span class="nc" id="L496">            int tabIndex = getIntent().getIntExtra(ReaderConstants.ARG_SUBS_TAB_POSITION, TAB_IDX_FOLLOWED_TAGS);</span>
<span class="nc" id="L497">            pageTitle = (String) adapter.getPageTitle(tabIndex);</span>

<span class="nc bnc" id="L499" title="All 2 branches missed.">            if (!TextUtils.isEmpty(pageTitle)) AppPrefs.setReaderSubsPageTitle(pageTitle);</span>
        }

<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (TextUtils.isEmpty(pageTitle)) {</span>
<span class="nc" id="L503">            return;</span>
        }

<span class="nc" id="L506">        PagerAdapter adapter = getPageAdapter();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        for (int i = 0; i &lt; adapter.getCount(); i++) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">            if (pageTitle.equals(adapter.getPageTitle(i))) {</span>
<span class="nc" id="L509">                mViewPager.setCurrentItem(i);</span>
<span class="nc" id="L510">                return;</span>
            }
        }
<span class="nc" id="L513">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
<span class="nc" id="L517">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (requestCode == RequestCodes.READER_INTERESTS) {</span>
<span class="nc" id="L519">            performUpdate(EnumSet.of(UpdateTask.TAGS));</span>
        }
<span class="nc" id="L521">    }</span>

    private class SubsPageAdapter extends FragmentPagerAdapter {
        private final List&lt;Fragment&gt; mFragments;

<span class="nc" id="L526">        SubsPageAdapter(FragmentManager fm, List&lt;Fragment&gt; fragments) {</span>
<span class="nc" id="L527">            super(fm);</span>
<span class="nc" id="L528">            mFragments = fragments;</span>
<span class="nc" id="L529">        }</span>

        @Override
        public CharSequence getPageTitle(int position) {
<span class="nc bnc" id="L533" title="All 3 branches missed.">            switch (position) {</span>
                case TAB_IDX_FOLLOWED_TAGS:
<span class="nc" id="L535">                    return getString(R.string.reader_page_followed_tags);</span>
                case TAB_IDX_FOLLOWED_BLOGS:
<span class="nc" id="L537">                    return getString(R.string.reader_page_followed_blogs);</span>
                default:
<span class="nc" id="L539">                    return super.getPageTitle(position);</span>
            }
        }

        @Override
        public Fragment getItem(int position) {
<span class="nc" id="L545">            return mFragments.get(position);</span>
        }

        @Override
        public int getCount() {
<span class="nc" id="L550">            return mFragments.size();</span>
        }

        @Override
        public Object instantiateItem(ViewGroup container, int position) {
<span class="nc" id="L555">            Object ret = super.instantiateItem(container, position);</span>
<span class="nc" id="L556">            mFragments.set(position, (Fragment) ret);</span>
<span class="nc" id="L557">            return ret;</span>
        }

        private void refreshFollowedTagFragment() {
<span class="nc bnc" id="L561" title="All 2 branches missed.">            for (Fragment fragment : mFragments) {</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">                if (fragment instanceof ReaderTagFragment) {</span>
<span class="nc" id="L563">                    ReaderTagFragment tagFragment = (ReaderTagFragment) fragment;</span>
<span class="nc" id="L564">                    tagFragment.refresh();</span>
                }
<span class="nc" id="L566">            }</span>
<span class="nc" id="L567">        }</span>

        private void refreshBlogFragments(ReaderBlogType blogType) {
<span class="nc bnc" id="L570" title="All 2 branches missed.">            for (Fragment fragment : mFragments) {</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                if (fragment instanceof ReaderBlogFragment) {</span>
<span class="nc" id="L572">                    ReaderBlogFragment blogFragment = (ReaderBlogFragment) fragment;</span>
<span class="nc bnc" id="L573" title="All 4 branches missed.">                    if (blogType == null || blogType.equals(blogFragment.getBlogType())) {</span>
<span class="nc" id="L574">                        blogFragment.refresh();</span>
                    }
                }
<span class="nc" id="L577">            }</span>
<span class="nc" id="L578">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>