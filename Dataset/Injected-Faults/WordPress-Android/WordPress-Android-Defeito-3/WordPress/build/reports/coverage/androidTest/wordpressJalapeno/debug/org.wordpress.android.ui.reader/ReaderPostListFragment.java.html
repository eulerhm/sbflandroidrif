<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderPostListFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader</a> &gt; <span class="el_source">ReaderPostListFragment.java</span></div><h1>ReaderPostListFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.graphics.drawable.Drawable;
import android.os.Bundle;
import android.text.Html;
import android.text.Spannable;
import android.text.SpannableStringBuilder;
import android.text.TextUtils;
import android.text.style.ImageSpan;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.Animation;
import android.widget.AutoCompleteTextView;
import android.widget.ProgressBar;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.widget.SearchView;
import androidx.core.content.ContextCompat;
import androidx.fragment.app.FragmentManager;
import androidx.lifecycle.ViewModelProvider;
import androidx.recyclerview.widget.RecyclerView;

import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.google.android.material.elevation.ElevationOverlayProvider;
import com.google.android.material.snackbar.Snackbar;
import com.google.android.material.tabs.TabLayout;
import com.google.android.material.tabs.TabLayout.OnTabSelectedListener;
import com.google.android.material.tabs.TabLayout.Tab;

import org.greenrobot.eventbus.EventBus;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.datasets.ReaderBlogTable;
import org.wordpress.android.datasets.ReaderDatabase;
import org.wordpress.android.datasets.ReaderPostTable;
import org.wordpress.android.datasets.ReaderSearchTable;
import org.wordpress.android.datasets.ReaderTagTable;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.generated.AccountActionBuilder;
import org.wordpress.android.fluxc.generated.ReaderActionBuilder;
import org.wordpress.android.fluxc.model.ReaderSiteModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.AccountStore.AddOrDeleteSubscriptionPayload;
import org.wordpress.android.fluxc.store.AccountStore.AddOrDeleteSubscriptionPayload.SubscriptionAction;
import org.wordpress.android.fluxc.store.AccountStore.OnSubscriptionUpdated;
import org.wordpress.android.fluxc.store.ReaderStore;
import org.wordpress.android.fluxc.store.ReaderStore.OnReaderSitesSearched;
import org.wordpress.android.fluxc.store.ReaderStore.ReaderSearchSitesPayload;
import org.wordpress.android.models.FilterCriteria;
import org.wordpress.android.models.ReaderBlog;
import org.wordpress.android.models.ReaderPost;
import org.wordpress.android.models.ReaderPostDiscoverData;
import org.wordpress.android.models.ReaderTag;
import org.wordpress.android.models.ReaderTagType;
import org.wordpress.android.ui.ActionableEmptyView;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.EmptyViewMessageType;
import org.wordpress.android.ui.FilteredRecyclerView;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.ViewPagerFragment;
import org.wordpress.android.ui.main.BottomNavController;
import org.wordpress.android.ui.main.SitePickerActivity;
import org.wordpress.android.ui.main.WPMainActivity;
import org.wordpress.android.ui.main.WPMainNavigationView;
import org.wordpress.android.ui.main.WPMainNavigationView.PageType;
import org.wordpress.android.ui.mysite.SelectedSiteRepository;
import org.wordpress.android.ui.mysite.cards.quickstart.QuickStartRepository;
import org.wordpress.android.ui.pages.SnackbarMessageHolder;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.reader.ReaderEvents.TagAdded;
import org.wordpress.android.ui.reader.ReaderTypes.ReaderPostListType;
import org.wordpress.android.ui.reader.actions.ReaderActions;
import org.wordpress.android.ui.reader.adapters.ReaderPostAdapter;
import org.wordpress.android.ui.reader.adapters.ReaderSearchSuggestionAdapter;
import org.wordpress.android.ui.reader.adapters.ReaderSearchSuggestionRecyclerAdapter;
import org.wordpress.android.ui.reader.adapters.ReaderSiteSearchAdapter;
import org.wordpress.android.ui.reader.adapters.ReaderSiteSearchAdapter.SiteSearchAdapterListener;
import org.wordpress.android.ui.reader.comments.ThreadedCommentsActionSource;
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.OpenEditorForReblog;
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowBookmarkedSavedOnlyLocallyDialog;
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowBookmarkedTab;
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowNoSitesToReblog;
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowReportPost;
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowSitePickerForResult;
import org.wordpress.android.ui.reader.discover.ReaderPostCardActionType;
import org.wordpress.android.ui.reader.services.post.ReaderPostServiceStarter;
import org.wordpress.android.ui.reader.services.post.ReaderPostServiceStarter.UpdateAction;
import org.wordpress.android.ui.reader.services.search.ReaderSearchServiceStarter;
import org.wordpress.android.ui.reader.services.update.ReaderUpdateLogic.UpdateTask;
import org.wordpress.android.ui.reader.services.update.ReaderUpdateServiceStarter;
import org.wordpress.android.ui.reader.services.update.TagUpdateClientUtilsProvider;
import org.wordpress.android.ui.reader.subfilter.ActionType.OpenSubsAtPage;
import org.wordpress.android.ui.reader.subfilter.BottomSheetUiState.BottomSheetVisible;
import org.wordpress.android.ui.reader.subfilter.SubFilterViewModel;
import org.wordpress.android.ui.reader.subfilter.SubfilterListItem.Site;
import org.wordpress.android.ui.reader.subfilter.SubfilterListItem.SiteAll;
import org.wordpress.android.ui.reader.tracker.ReaderTracker;
import org.wordpress.android.ui.reader.usecases.ReaderSiteFollowUseCase.FollowSiteState.FollowStatusChanged;
import org.wordpress.android.ui.reader.utils.ReaderUtils;
import org.wordpress.android.ui.reader.viewmodels.ReaderModeInfo;
import org.wordpress.android.ui.reader.viewmodels.ReaderPostListViewModel;
import org.wordpress.android.ui.reader.viewmodels.ReaderViewModel;
import org.wordpress.android.ui.reader.views.ReaderSiteHeaderView;
import org.wordpress.android.ui.utils.UiHelpers;
import org.wordpress.android.util.AniUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.DisplayUtils;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.QuickStartUtilsWrapper;
import org.wordpress.android.util.SnackbarItem;
import org.wordpress.android.util.SnackbarItem.Action;
import org.wordpress.android.util.SnackbarItem.Info;
import org.wordpress.android.util.SnackbarSequencer;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.WPActivityUtils;
import org.wordpress.android.util.config.SeenUnseenWithCounterFeatureConfig;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.viewmodel.main.WPMainActivityViewModel;
import org.wordpress.android.widgets.AppRatingDialog;
import org.wordpress.android.widgets.RecyclerItemDecoration;
import org.wordpress.android.widgets.WPSnackbar;

import java.util.ArrayList;
import java.util.EnumSet;
import java.util.List;
import java.util.Stack;

import javax.inject.Inject;

import static org.wordpress.android.fluxc.generated.AccountActionBuilder.newUpdateSubscriptionNotificationPostAction;
import static org.wordpress.android.ui.reader.ReaderActivityLauncher.OpenUrlType.INTERNAL;

import kotlin.Unit;

<span class="nc" id="L151">public class ReaderPostListFragment extends ViewPagerFragment</span>
        implements ReaderInterfaces.OnPostSelectedListener,
        ReaderInterfaces.OnFollowListener,
        ReaderInterfaces.OnPostListItemButtonListener,
        WPMainActivity.OnActivityBackPressedListener,
        WPMainActivity.OnScrollToTopListener {
    private static final int TAB_POSTS = 0;
    private static final int TAB_SITES = 1;
    private static final int NO_POSITION = -1;

    private ReaderPostAdapter mPostAdapter;
    private ReaderSiteSearchAdapter mSiteSearchAdapter;
    private ReaderSearchSuggestionAdapter mSearchSuggestionAdapter;
    private ReaderSearchSuggestionRecyclerAdapter mSearchSuggestionRecyclerAdapter;

    private FilteredRecyclerView mRecyclerView;
<span class="nc" id="L167">    private boolean mFirstLoad = true;</span>

    private View mNewPostsBar;
    private ActionableEmptyView mActionableEmptyView;
    private ProgressBar mProgress;
    private TabLayout mSearchTabs;

    private SearchView mSearchView;
    private MenuItem mSearchMenuItem;

    private View mSubFilterComponent;
    private View mSubFiltersListButton;
    private TextView mSubFilterTitle;
    private View mRemoveFilterButton;

<span class="nc" id="L182">    private boolean mIsTopLevel = false;</span>
    private static final String SUBFILTER_BOTTOM_SHEET_TAG = &quot;SUBFILTER_BOTTOM_SHEET_TAG&quot;;

    private BottomNavController mBottomNavController;

    private ReaderTag mCurrentTag;
<span class="nc" id="L188">    private ReaderTag mTagFragmentStartedWith = null;</span>
    private long mCurrentBlogId;
    private long mCurrentFeedId;
    private String mCurrentSearchQuery;
    private ReaderPostListType mPostListType;
    private ReaderSiteModel mLastTappedSiteSearchResult;

    private int mRestorePosition;
    private int mSiteSearchRestorePosition;
    private int mPostSearchAdapterPos;
    private int mSiteSearchAdapterPos;
<span class="nc" id="L199">    private int mSearchTabsPos = NO_POSITION;</span>

    private boolean mIsUpdating;
    private boolean mWasPaused;
    private boolean mHasUpdatedPosts;
    private boolean mIsAnimatingOutNewPostsBar;

    private static boolean mHasPurgedReaderDb;

<span class="nc" id="L208">    private final HistoryStack mTagPreviewHistory = new HistoryStack(&quot;tag_preview_history&quot;);</span>

    private AlertDialog mBookmarksSavedLocallyDialog;

    private ReaderPostListViewModel mViewModel;
    // This VM is initialized only on the Following tab
    private SubFilterViewModel mSubFilterViewModel;
<span class="nc" id="L215">    private ReaderViewModel mReaderViewModel = null;</span>

    @Inject ViewModelProvider.Factory mViewModelFactory;
    @Inject AccountStore mAccountStore;
    @Inject ReaderStore mReaderStore;
    @Inject Dispatcher mDispatcher;
    @Inject ImageManager mImageManager;
    @Inject UiHelpers mUiHelpers;
    @Inject TagUpdateClientUtilsProvider mTagUpdateClientUtilsProvider;
    @Inject QuickStartUtilsWrapper mQuickStartUtilsWrapper;
    @Inject SeenUnseenWithCounterFeatureConfig mSeenUnseenWithCounterFeatureConfig;
    @Inject QuickStartRepository mQuickStartRepository;
    @Inject ReaderTracker mReaderTracker;
    @Inject SnackbarSequencer mSnackbarSequencer;

<span class="nc" id="L230">    private enum ActionableEmptyViewButtonType {</span>
<span class="nc" id="L231">        DISCOVER,</span>
<span class="nc" id="L232">        FOLLOWED</span>
    }

    private static class HistoryStack extends Stack&lt;String&gt; {
        private final String mKeyName;

<span class="nc" id="L238">        HistoryStack(@SuppressWarnings(&quot;SameParameterValue&quot;) String keyName) {</span>
<span class="nc" id="L239">            mKeyName = keyName;</span>
<span class="nc" id="L240">        }</span>

        void restoreInstance(Bundle bundle) {
<span class="nc" id="L243">            clear();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (bundle.containsKey(mKeyName)) {</span>
<span class="nc" id="L245">                ArrayList&lt;String&gt; history = bundle.getStringArrayList(mKeyName);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">                if (history != null) {</span>
<span class="nc" id="L247">                    this.addAll(history);</span>
                }
            }
<span class="nc" id="L250">        }</span>

        void saveInstance(Bundle bundle) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">            if (!isEmpty()) {</span>
<span class="nc" id="L254">                ArrayList&lt;String&gt; history = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L255">                history.addAll(this);</span>
<span class="nc" id="L256">                bundle.putStringArrayList(mKeyName, history);</span>
            }
<span class="nc" id="L258">        }</span>
    }

    /*
     * show posts with a specific tag (either TAG_FOLLOWED or TAG_PREVIEW)
     */
    static ReaderPostListFragment newInstanceForTag(@NonNull ReaderTag tag, ReaderPostListType listType) {
<span class="nc" id="L265">        return newInstanceForTag(tag, listType, false);</span>
    }

    static ReaderPostListFragment newInstanceForTag(
            @NonNull ReaderTag tag,
            ReaderPostListType listType,
            boolean isTopLevel
    ) {
<span class="nc" id="L273">        AppLog.d(T.READER, &quot;reader post list &gt; newInstance (tag)&quot;);</span>

<span class="nc" id="L275">        Bundle args = new Bundle();</span>
        // Tag this fragment is started with
<span class="nc" id="L277">        args.putSerializable(ReaderConstants.ARG_ORIGINAL_TAG, tag);</span>
        // Tag this fragment is started with but also used for savedState
<span class="nc" id="L279">        args.putSerializable(ReaderConstants.ARG_TAG, tag);</span>
<span class="nc" id="L280">        args.putSerializable(ReaderConstants.ARG_POST_LIST_TYPE, listType);</span>
<span class="nc" id="L281">        args.putBoolean(ReaderConstants.ARG_IS_TOP_LEVEL, isTopLevel);</span>

<span class="nc" id="L283">        ReaderPostListFragment fragment = new ReaderPostListFragment();</span>
<span class="nc" id="L284">        fragment.setArguments(args);</span>
<span class="nc" id="L285">        fragment.trackTagLoaded(tag);</span>

<span class="nc" id="L287">        return fragment;</span>
    }

    static ReaderPostListFragment newInstanceForSearch() {
<span class="nc" id="L291">        AppLog.d(T.READER, &quot;reader post list &gt; newInstance (search)&quot;);</span>

<span class="nc" id="L293">        Bundle args = new Bundle();</span>
<span class="nc" id="L294">        args.putSerializable(ReaderConstants.ARG_POST_LIST_TYPE, ReaderPostListType.SEARCH_RESULTS);</span>
<span class="nc" id="L295">        args.putBoolean(ReaderConstants.ARG_IS_TOP_LEVEL, false);</span>

<span class="nc" id="L297">        ReaderPostListFragment fragment = new ReaderPostListFragment();</span>
<span class="nc" id="L298">        fragment.setArguments(args);</span>
<span class="nc" id="L299">        return fragment;</span>
    }

    /*
     * show posts in a specific blog
     */
    public static ReaderPostListFragment newInstanceForBlog(long blogId) {
<span class="nc" id="L306">        AppLog.d(T.READER, &quot;reader post list &gt; newInstance (blog)&quot;);</span>

<span class="nc" id="L308">        Bundle args = new Bundle();</span>
<span class="nc" id="L309">        args.putLong(ReaderConstants.ARG_BLOG_ID, blogId);</span>
<span class="nc" id="L310">        args.putSerializable(ReaderConstants.ARG_POST_LIST_TYPE, ReaderPostListType.BLOG_PREVIEW);</span>

<span class="nc" id="L312">        ReaderPostListFragment fragment = new ReaderPostListFragment();</span>
<span class="nc" id="L313">        fragment.setArguments(args);</span>

<span class="nc" id="L315">        return fragment;</span>
    }

    public static ReaderPostListFragment newInstanceForFeed(long feedId) {
<span class="nc" id="L319">        AppLog.d(T.READER, &quot;reader post list &gt; newInstance (blog)&quot;);</span>

<span class="nc" id="L321">        Bundle args = new Bundle();</span>
<span class="nc" id="L322">        args.putLong(ReaderConstants.ARG_FEED_ID, feedId);</span>
<span class="nc" id="L323">        args.putLong(ReaderConstants.ARG_BLOG_ID, feedId);</span>
<span class="nc" id="L324">        args.putSerializable(ReaderConstants.ARG_POST_LIST_TYPE, ReaderPostListType.BLOG_PREVIEW);</span>

<span class="nc" id="L326">        ReaderPostListFragment fragment = new ReaderPostListFragment();</span>
<span class="nc" id="L327">        fragment.setArguments(args);</span>

<span class="nc" id="L329">        return fragment;</span>
    }

    @Nullable
    public SiteModel getSelectedSite() {
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (getActivity() instanceof WPMainActivity) {</span>
<span class="nc" id="L335">            WPMainActivity mainActivity = (WPMainActivity) getActivity();</span>
<span class="nc" id="L336">            return mainActivity.getSelectedSite();</span>
        }
<span class="nc" id="L338">        return null;</span>
    }

    @Override
    public void setArguments(Bundle args) {
<span class="nc" id="L343">        super.setArguments(args);</span>

<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (args != null) {</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">            if (args.containsKey(ReaderConstants.ARG_TAG)) {</span>
<span class="nc" id="L347">                mCurrentTag = (ReaderTag) args.getSerializable(ReaderConstants.ARG_TAG);</span>
            }
<span class="nc bnc" id="L349" title="All 2 branches missed.">            if (args.containsKey(ReaderConstants.ARG_ORIGINAL_TAG)) {</span>
<span class="nc" id="L350">                mTagFragmentStartedWith = (ReaderTag) args.getSerializable(ReaderConstants.ARG_ORIGINAL_TAG);</span>
            }
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (args.containsKey(ReaderConstants.ARG_POST_LIST_TYPE)) {</span>
<span class="nc" id="L353">                mPostListType = (ReaderPostListType) args.getSerializable(ReaderConstants.ARG_POST_LIST_TYPE);</span>
            }

<span class="nc bnc" id="L356" title="All 2 branches missed.">            if (args.containsKey(ReaderConstants.ARG_IS_TOP_LEVEL)) {</span>
<span class="nc" id="L357">                mIsTopLevel = args.getBoolean(ReaderConstants.ARG_IS_TOP_LEVEL);</span>
            }

<span class="nc" id="L360">            mCurrentBlogId = args.getLong(ReaderConstants.ARG_BLOG_ID);</span>
<span class="nc" id="L361">            mCurrentFeedId = args.getLong(ReaderConstants.ARG_FEED_ID);</span>
<span class="nc" id="L362">            mCurrentSearchQuery = args.getString(ReaderConstants.ARG_SEARCH_QUERY);</span>

<span class="nc bnc" id="L364" title="All 4 branches missed.">            if (getPostListType() == ReaderPostListType.TAG_PREVIEW &amp;&amp; hasCurrentTag()) {</span>
<span class="nc" id="L365">                mTagPreviewHistory.push(getCurrentTagName());</span>
            }
        }
<span class="nc" id="L368">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L372">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L373">        ((WordPress) getActivity().getApplication()).component().inject(this);</span>

<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L376">            AppLog.d(T.READER, &quot;reader post list &gt; restoring instance state&quot;);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            if (savedInstanceState.containsKey(ReaderConstants.ARG_TAG)) {</span>
<span class="nc" id="L378">                mCurrentTag = (ReaderTag) savedInstanceState.getSerializable(ReaderConstants.ARG_TAG);</span>
            }
<span class="nc bnc" id="L380" title="All 2 branches missed.">            if (savedInstanceState.containsKey(ReaderConstants.ARG_BLOG_ID)) {</span>
<span class="nc" id="L381">                mCurrentBlogId = savedInstanceState.getLong(ReaderConstants.ARG_BLOG_ID);</span>
            }
<span class="nc bnc" id="L383" title="All 2 branches missed.">            if (savedInstanceState.containsKey(ReaderConstants.ARG_FEED_ID)) {</span>
<span class="nc" id="L384">                mCurrentFeedId = savedInstanceState.getLong(ReaderConstants.ARG_FEED_ID);</span>
            }
<span class="nc bnc" id="L386" title="All 2 branches missed.">            if (savedInstanceState.containsKey(ReaderConstants.ARG_SEARCH_QUERY)) {</span>
<span class="nc" id="L387">                mCurrentSearchQuery = savedInstanceState.getString(ReaderConstants.ARG_SEARCH_QUERY);</span>
            }
<span class="nc bnc" id="L389" title="All 2 branches missed.">            if (savedInstanceState.containsKey(ReaderConstants.ARG_POST_LIST_TYPE)) {</span>
<span class="nc" id="L390">                mPostListType =</span>
<span class="nc" id="L391">                        (ReaderPostListType) savedInstanceState.getSerializable(ReaderConstants.ARG_POST_LIST_TYPE);</span>
            }
<span class="nc bnc" id="L393" title="All 2 branches missed.">            if (getPostListType() == ReaderPostListType.TAG_PREVIEW) {</span>
<span class="nc" id="L394">                mTagPreviewHistory.restoreInstance(savedInstanceState);</span>
            }
<span class="nc bnc" id="L396" title="All 2 branches missed.">            if (savedInstanceState.containsKey(ReaderConstants.ARG_IS_TOP_LEVEL)) {</span>
<span class="nc" id="L397">                mIsTopLevel = savedInstanceState.getBoolean(ReaderConstants.ARG_IS_TOP_LEVEL);</span>
            }

<span class="nc bnc" id="L400" title="All 2 branches missed.">            if (savedInstanceState.containsKey(ReaderConstants.ARG_ORIGINAL_TAG)) {</span>
<span class="nc" id="L401">                mTagFragmentStartedWith =</span>
<span class="nc" id="L402">                        (ReaderTag) savedInstanceState.getSerializable(ReaderConstants.ARG_ORIGINAL_TAG);</span>
            }

<span class="nc" id="L405">            mRestorePosition = savedInstanceState.getInt(ReaderConstants.KEY_RESTORE_POSITION);</span>
<span class="nc" id="L406">            mSiteSearchRestorePosition = savedInstanceState.getInt(ReaderConstants.KEY_SITE_SEARCH_RESTORE_POSITION);</span>
<span class="nc" id="L407">            mWasPaused = savedInstanceState.getBoolean(ReaderConstants.KEY_WAS_PAUSED);</span>
<span class="nc" id="L408">            mHasUpdatedPosts = savedInstanceState.getBoolean(ReaderConstants.KEY_ALREADY_UPDATED);</span>
<span class="nc" id="L409">            mFirstLoad = savedInstanceState.getBoolean(ReaderConstants.KEY_FIRST_LOAD);</span>
<span class="nc" id="L410">            mSearchTabsPos = savedInstanceState.getInt(ReaderConstants.KEY_ACTIVE_SEARCH_TAB, NO_POSITION);</span>
        }
<span class="nc" id="L412">    }</span>

    @Override public void onActivityCreated(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L415">        super.onActivityCreated(savedInstanceState);</span>
<span class="nc" id="L416">        mViewModel = new ViewModelProvider(this, mViewModelFactory)</span>
<span class="nc" id="L417">                .get(ReaderPostListViewModel.class);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (mIsTopLevel) {</span>
<span class="nc" id="L419">            mReaderViewModel = new ViewModelProvider(getParentFragment(), mViewModelFactory)</span>
<span class="nc" id="L420">                    .get(ReaderViewModel.class);</span>
        }

<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (isFilterableScreen()) {</span>
<span class="nc" id="L424">            initSubFilterViewModel(savedInstanceState);</span>
        }

<span class="nc" id="L427">        mViewModel.getNavigationEvents().observe(getViewLifecycleOwner(),</span>
<span class="nc" id="L428">                event -&gt; event.applyIfNotHandled(navTarget -&gt; {</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                    if (navTarget instanceof ShowSitePickerForResult) {</span>
<span class="nc" id="L430">                        ShowSitePickerForResult data = (ShowSitePickerForResult) navTarget;</span>
<span class="nc" id="L431">                        ActivityLauncher.showSitePickerForResult(</span>
                                ReaderPostListFragment.this,
<span class="nc" id="L433">                                data.getPreselectedSite(),</span>
<span class="nc" id="L434">                                data.getMode()</span>
                        );
<span class="nc bnc" id="L436" title="All 2 branches missed.">                    } else if (navTarget instanceof OpenEditorForReblog) {</span>
<span class="nc" id="L437">                        OpenEditorForReblog data = (OpenEditorForReblog) navTarget;</span>
<span class="nc" id="L438">                        ActivityLauncher.openEditorForReblog(</span>
<span class="nc" id="L439">                                getActivity(),</span>
<span class="nc" id="L440">                                data.getSite(),</span>
<span class="nc" id="L441">                                data.getPost(),</span>
<span class="nc" id="L442">                                data.getSource()</span>
                        );
<span class="nc bnc" id="L444" title="All 2 branches missed.">                    } else if (navTarget instanceof ShowNoSitesToReblog) {</span>
<span class="nc" id="L445">                        ReaderActivityLauncher.showNoSiteToReblog(getActivity());</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                    } else if (navTarget instanceof ShowBookmarkedTab) {</span>
<span class="nc" id="L447">                        ActivityLauncher.viewSavedPostsListInReader(getActivity());</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                    } else if (navTarget instanceof ShowBookmarkedSavedOnlyLocallyDialog) {</span>
<span class="nc" id="L449">                        showBookmarksSavedLocallyDialog((ShowBookmarkedSavedOnlyLocallyDialog) navTarget);</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">                    } else if (navTarget instanceof ShowReportPost) {</span>
<span class="nc" id="L451">                        ShowReportPost data = (ShowReportPost) navTarget;</span>
<span class="nc" id="L452">                        ReaderActivityLauncher.openUrl(</span>
<span class="nc" id="L453">                                getContext(),</span>
<span class="nc" id="L454">                                ReaderUtils.getReportPostUrl(data.getUrl()),</span>
                                INTERNAL);
<span class="nc" id="L456">                    } else {</span>
<span class="nc" id="L457">                        throw new IllegalStateException(&quot;Action not supported in ReaderPostListFragment &quot; + navTarget);</span>
                    }
<span class="nc" id="L459">                    return Unit.INSTANCE;</span>
                }));

<span class="nc" id="L462">        mViewModel.getSnackbarEvents().observe(getViewLifecycleOwner(), event -&gt;</span>
<span class="nc" id="L463">                event.applyIfNotHandled(holder -&gt; {</span>
<span class="nc" id="L464">                    showSnackbar(holder);</span>
<span class="nc" id="L465">                    return Unit.INSTANCE;</span>
                })
        );

<span class="nc" id="L469">        mViewModel.getPreloadPostEvents().observe(getViewLifecycleOwner(), event -&gt;</span>
<span class="nc" id="L470">                event.applyIfNotHandled(holder -&gt; {</span>
<span class="nc" id="L471">                    addWebViewCachingFragment(holder.getBlogId(), holder.getPostId());</span>
<span class="nc" id="L472">                    return Unit.INSTANCE;</span>
                })
        );

<span class="nc" id="L476">        mViewModel.getRefreshPosts().observe(getViewLifecycleOwner(), event -&gt;</span>
<span class="nc" id="L477">                event.applyIfNotHandled(holder -&gt; {</span>
<span class="nc" id="L478">                    refreshPosts();</span>
<span class="nc" id="L479">                    return Unit.INSTANCE;</span>
                })
        );

<span class="nc" id="L483">        mViewModel.getUpdateFollowStatus().observe(getViewLifecycleOwner(), this::setFollowStatusForBlog);</span>

<span class="nc" id="L485">        mViewModel.start(mReaderViewModel);</span>

<span class="nc bnc" id="L487" title="All 2 branches missed.">        if (isFollowingScreen()) {</span>
<span class="nc" id="L488">            mSubFilterViewModel.onUserComesToReader();</span>
        }

<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (getPostListType() == ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L492">            mRecyclerView.showAppBarLayout();</span>
<span class="nc" id="L493">            mSearchMenuItem.expandActionView();</span>
<span class="nc" id="L494">            mRecyclerView.setToolbarScrollFlags(0);</span>
        }
<span class="nc" id="L496">    }</span>

    private void setFollowStatusForBlog(FollowStatusChanged readerData) {
<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (!hasPostAdapter()) {</span>
<span class="nc" id="L500">            return;</span>
        }
<span class="nc" id="L502">        getPostAdapter().setFollowStatusForBlog(readerData.getBlogId(), readerData.getFollowing());</span>
<span class="nc" id="L503">    }</span>

    private void showSnackbar(SnackbarMessageHolder holder) {
<span class="nc bnc" id="L506" title="All 4 branches missed.">        if (!isAdded() || getView() == null) return;</span>
<span class="nc" id="L507">        mSnackbarSequencer.enqueue(</span>
                new SnackbarItem(
                        new Info(
<span class="nc" id="L510">                                getSnackbarParent(),</span>
<span class="nc" id="L511">                                holder.getMessage(),</span>
<span class="nc" id="L512">                                holder.getDuration(),</span>
<span class="nc" id="L513">                                holder.isImportant()</span>
                        ),
<span class="nc bnc" id="L515" title="All 2 branches missed.">                        holder.getButtonTitle() != null</span>
<span class="nc" id="L516">                                ? new Action(holder.getButtonTitle(), view -&gt; holder.getButtonAction().invoke()) : null</span>
                )
        );
<span class="nc" id="L519">    }</span>

    private void addWebViewCachingFragment(Long blogId, Long postId) {
<span class="nc" id="L522">        String tag = blogId + &quot;&quot; + postId;</span>

<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (getParentFragmentManager().findFragmentByTag(tag) == null) {</span>
<span class="nc" id="L525">            getParentFragmentManager().beginTransaction()</span>
<span class="nc" id="L526">                                      .add(ReaderPostWebViewCachingFragment.newInstance(blogId, postId), tag)</span>
<span class="nc" id="L527">                                      .commit();</span>
        }
<span class="nc" id="L529">    }</span>

    private void initSubFilterViewModel(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L532">        WPMainActivityViewModel wpMainActivityViewModel = new ViewModelProvider(requireActivity(), mViewModelFactory)</span>
<span class="nc" id="L533">                .get(WPMainActivityViewModel.class);</span>
<span class="nc" id="L534">        mSubFilterViewModel = new ViewModelProvider(this, mViewModelFactory).get(</span>
<span class="nc" id="L535">                SubFilterViewModel.SUBFILTER_VM_BASE_KEY + mTagFragmentStartedWith.getKeyString(),</span>
                SubFilterViewModel.class
        );

<span class="nc" id="L539">        mSubFilterViewModel.getCurrentSubFilter().observe(getViewLifecycleOwner(), subfilterListItem -&gt; {</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">            if (getPostListType() != ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L541">                mSubFilterViewModel.onSubfilterSelected(subfilterListItem);</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (shouldShowEmptyViewForSelfHostedCta()) {</span>
<span class="nc" id="L543">                    setEmptyTitleDescriptionAndButton(false);</span>
<span class="nc" id="L544">                    showEmptyView();</span>
                }
            }
<span class="nc" id="L547">        });</span>

<span class="nc" id="L549">        mSubFilterViewModel.getReaderModeInfo().observe(getViewLifecycleOwner(), readerModeInfo -&gt; {</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">            if (readerModeInfo != null) {</span>
<span class="nc" id="L551">                changeReaderMode(readerModeInfo, true);</span>

<span class="nc bnc" id="L553" title="All 2 branches missed.">                if (readerModeInfo.getLabel() != null) {</span>
<span class="nc" id="L554">                    mSubFilterTitle.setText(</span>
<span class="nc" id="L555">                            mUiHelpers.getTextOfUiString(</span>
<span class="nc" id="L556">                                    requireActivity(),</span>
<span class="nc" id="L557">                                    readerModeInfo.getLabel()</span>
                            )
                    );
                }

<span class="nc bnc" id="L562" title="All 2 branches missed.">                if (readerModeInfo.isFiltered()) {</span>
<span class="nc" id="L563">                    mRemoveFilterButton.setVisibility(View.VISIBLE);</span>
                } else {
<span class="nc" id="L565">                    mRemoveFilterButton.setVisibility(View.GONE);</span>
                }
            }
<span class="nc" id="L568">        });</span>

<span class="nc" id="L570">        mSubFilterViewModel.getBottomSheetUiState().observe(getViewLifecycleOwner(), event -&gt; {</span>
<span class="nc" id="L571">            event.applyIfNotHandled(uiState -&gt; {</span>
<span class="nc" id="L572">                FragmentManager fm = getChildFragmentManager();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                if (fm != null) {</span>
<span class="nc" id="L574">                    SubfilterBottomSheetFragment bottomSheet =</span>
<span class="nc" id="L575">                            (SubfilterBottomSheetFragment) fm.findFragmentByTag(SUBFILTER_BOTTOM_SHEET_TAG);</span>
<span class="nc bnc" id="L576" title="All 4 branches missed.">                    if (uiState.isVisible() &amp;&amp; bottomSheet == null) {</span>
<span class="nc" id="L577">                        mSubFilterViewModel.loadSubFilters();</span>
<span class="nc" id="L578">                        BottomSheetVisible visibleState = (BottomSheetVisible) uiState;</span>
<span class="nc" id="L579">                        bottomSheet = SubfilterBottomSheetFragment.newInstance(</span>
<span class="nc" id="L580">                                SubFilterViewModel.SUBFILTER_VM_BASE_KEY + mTagFragmentStartedWith.getKeyString(),</span>
<span class="nc" id="L581">                                visibleState.getCategories(),</span>
<span class="nc" id="L582">                                mUiHelpers.getTextOfUiString(requireContext(), visibleState.getTitle())</span>
                        );
<span class="nc" id="L584">                        mReaderTracker.track(Stat.READER_FILTER_SHEET_DISPLAYED);</span>
<span class="nc" id="L585">                        bottomSheet.show(getChildFragmentManager(), SUBFILTER_BOTTOM_SHEET_TAG);</span>
<span class="nc bnc" id="L586" title="All 4 branches missed.">                    } else if (!uiState.isVisible() &amp;&amp; bottomSheet != null) {</span>
<span class="nc" id="L587">                        bottomSheet.dismiss();</span>
                    }
                }
<span class="nc" id="L590">                return null;</span>
            });
<span class="nc" id="L592">        });</span>

<span class="nc" id="L594">        mSubFilterViewModel.getBottomSheetEmptyViewAction().observe(getViewLifecycleOwner(), event -&gt; {</span>
<span class="nc" id="L595">            event.applyIfNotHandled(action -&gt; {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                if (action instanceof OpenSubsAtPage) {</span>
<span class="nc" id="L597">                    ReaderActivityLauncher.showReaderSubs(</span>
<span class="nc" id="L598">                            requireActivity(),</span>
<span class="nc" id="L599">                            ((OpenSubsAtPage) action).getTabIndex()</span>
                    );
                } else {
<span class="nc" id="L602">                    wpMainActivityViewModel.onOpenLoginPage(</span>
<span class="nc" id="L603">                            WPMainNavigationView.Companion.getPosition(PageType.MY_SITE)</span>
                    );
                }

<span class="nc" id="L607">                return null;</span>
            });
<span class="nc" id="L609">        });</span>

<span class="nc" id="L611">        mSubFilterViewModel.getUpdateTagsAndSites().observe(getViewLifecycleOwner(), event -&gt; {</span>
<span class="nc" id="L612">            event.applyIfNotHandled(tasks -&gt; {</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                if (NetworkUtils.isNetworkAvailable(getActivity())) {</span>
<span class="nc" id="L614">                    ReaderUpdateServiceStarter.startService(getActivity(), tasks);</span>
                }
<span class="nc" id="L616">                return null;</span>
            });
<span class="nc" id="L618">        });</span>

<span class="nc" id="L620">        mSubFilterViewModel.start(mTagFragmentStartedWith, mCurrentTag, savedInstanceState);</span>
<span class="nc" id="L621">    }</span>

    private void initSubFilterViews(ViewGroup rootView, LayoutInflater inflater) {
<span class="nc" id="L624">        mSubFilterComponent = inflater.inflate(R.layout.subfilter_component, rootView, false);</span>
<span class="nc" id="L625">        ((ViewGroup) rootView.findViewById(R.id.sub_filter_component_container)).addView(mSubFilterComponent);</span>

<span class="nc" id="L627">        mSubFiltersListButton = mSubFilterComponent.findViewById(R.id.filter_selection);</span>
<span class="nc" id="L628">        mSubFiltersListButton.setOnClickListener(v -&gt; {</span>
<span class="nc" id="L629">            mSubFilterViewModel.onSubFiltersListButtonClicked();</span>
<span class="nc" id="L630">        });</span>

<span class="nc" id="L632">        mSubFilterTitle = mSubFilterComponent.findViewById(R.id.selected_filter_name);</span>

<span class="nc" id="L634">        mRemoveFilterButton = mSubFilterComponent.findViewById(R.id.remove_filter_button);</span>
<span class="nc" id="L635">        mRemoveFilterButton.setOnClickListener(v -&gt; {</span>
<span class="nc" id="L636">            mReaderTracker.track(Stat.READER_FILTER_SHEET_CLEARED);</span>
<span class="nc" id="L637">            mSubFilterViewModel.setDefaultSubfilter();</span>
<span class="nc" id="L638">        });</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">        mSubFilterComponent.setVisibility(isFilterableScreen() ? View.VISIBLE : View.GONE);</span>

<span class="nc" id="L641">        ElevationOverlayProvider elevationOverlayProvider = new ElevationOverlayProvider(mRecyclerView.getContext());</span>
<span class="nc" id="L642">        float cardElevation = getResources().getDimension(R.dimen.card_elevation);</span>
<span class="nc" id="L643">        int elevatedCardColor = elevationOverlayProvider.compositeOverlayWithThemeSurfaceColorIfNeeded(cardElevation);</span>
<span class="nc" id="L644">        mSubFilterComponent.setBackgroundColor(elevatedCardColor);</span>
<span class="nc" id="L645">    }</span>

    private void changeReaderMode(ReaderModeInfo readerModeInfo, boolean onlyOnChanges) {
<span class="nc" id="L648">        boolean changesDetected = false;</span>

<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (onlyOnChanges) {</span>
<span class="nc bnc" id="L651" title="All 4 branches missed.">            changesDetected = (readerModeInfo.getTag() != null</span>
                               &amp;&amp; mCurrentTag != null
<span class="nc bnc" id="L653" title="All 2 branches missed.">                               &amp;&amp; !readerModeInfo.getTag().equals(mCurrentTag))</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">                              || (mPostListType != readerModeInfo.getListType())</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                              || (mCurrentBlogId != readerModeInfo.getBlogId())</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                              || (mCurrentFeedId != readerModeInfo.getFeedId())</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                              || (readerModeInfo.isFirstLoad());</span>

<span class="nc bnc" id="L659" title="All 4 branches missed.">            if (changesDetected &amp;&amp; !readerModeInfo.isFirstLoad()) {</span>
<span class="nc" id="L660">                trackTagLoaded(readerModeInfo.getTag());</span>
            }
        }

<span class="nc bnc" id="L664" title="All 4 branches missed.">        if (onlyOnChanges &amp;&amp; !changesDetected) return;</span>

<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (readerModeInfo.getTag() != null) {</span>
<span class="nc" id="L667">            mCurrentTag = readerModeInfo.getTag();</span>
        }

<span class="nc" id="L670">        mPostListType = readerModeInfo.getListType();</span>
<span class="nc" id="L671">        mCurrentBlogId = readerModeInfo.getBlogId();</span>
<span class="nc" id="L672">        mCurrentFeedId = readerModeInfo.getFeedId();</span>

<span class="nc" id="L674">        resetPostAdapter(mPostListType);</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (readerModeInfo.getRequestNewerPosts()) {</span>
<span class="nc" id="L676">            updatePosts(false);</span>
        }
<span class="nc" id="L678">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L682">        super.onPause();</span>

<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (mBookmarksSavedLocallyDialog != null) {</span>
<span class="nc" id="L685">            mBookmarksSavedLocallyDialog.dismiss();</span>
        }
<span class="nc" id="L687">        mWasPaused = true;</span>

<span class="nc bnc" id="L689" title="All 2 branches missed.">        mViewModel.onFragmentPause(mIsTopLevel, getPostListType() == ReaderPostListType.SEARCH_RESULTS,</span>
<span class="nc" id="L690">                isFilterableScreen());</span>
<span class="nc" id="L691">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L695">        super.onResume();</span>
        /*
         * This is a workaround for https://github.com/wordpress-mobile/WordPress-Android/issues/11985.
         * The RecyclerView doesn't get redrawn correctly when the adapter finishes its initialization in onStart.
         */
<span class="nc" id="L700">        getPostAdapter().notifyDataSetChanged();</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">        if (mWasPaused) {</span>
<span class="nc" id="L702">            AppLog.d(T.READER, &quot;reader post list &gt; resumed from paused state&quot;);</span>
<span class="nc" id="L703">            mWasPaused = false;</span>

            Site currentSite;

<span class="nc bnc" id="L707" title="All 2 branches missed.">            if (getPostListType() == ReaderPostListType.TAG_FOLLOWED) {</span>
<span class="nc" id="L708">                resumeFollowedTag();</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">            } else if ((currentSite = getSiteIfBlogPreview()) != null) {</span>
<span class="nc" id="L710">                resumeFollowedSite(currentSite);</span>
            } else {
<span class="nc" id="L712">                refreshPosts();</span>
            }

<span class="nc bnc" id="L715" title="All 2 branches missed.">            if (mIsTopLevel) {</span>
                // Remove sticky event if not consumed
<span class="nc" id="L717">                EventBus.getDefault().removeStickyEvent(ReaderEvents.TagAdded.class);</span>
            }

            // if the user tapped a site to show site preview, it's possible they also changed the follow
            // status so tell the search adapter to check whether it has the correct follow status
<span class="nc bnc" id="L722" title="All 4 branches missed.">            if (getPostListType() == ReaderPostListType.SEARCH_RESULTS &amp;&amp; mLastTappedSiteSearchResult != null) {</span>
<span class="nc" id="L723">                getSiteSearchAdapter().checkFollowStatusForSite(mLastTappedSiteSearchResult);</span>
<span class="nc" id="L724">                mLastTappedSiteSearchResult = null;</span>
            }

<span class="nc bnc" id="L727" title="All 2 branches missed.">            if (getPostListType() == ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L728">                return;</span>
            }
        }

<span class="nc bnc" id="L732" title="All 2 branches missed.">        if (shouldShowEmptyViewForSelfHostedCta()) {</span>
<span class="nc" id="L733">            setEmptyTitleDescriptionAndButton(false);</span>
<span class="nc" id="L734">            showEmptyView();</span>
        }

<span class="nc bnc" id="L737" title="All 2 branches missed.">        mViewModel.onFragmentResume(mIsTopLevel, getPostListType() == ReaderPostListType.SEARCH_RESULTS,</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">                isFilterableScreen(), isFilterableScreen() ? mSubFilterViewModel.getCurrentSubfilterValue() : null);</span>
<span class="nc" id="L739">    }</span>

    /*
     * called when fragment is resumed and we're looking at posts in a followed tag
     */
    private void resumeFollowedTag() {
<span class="nc" id="L745">        TagAdded addedTag = EventBus.getDefault().getStickyEvent(ReaderEvents.TagAdded.class);</span>
<span class="nc bnc" id="L746" title="All 4 branches missed.">        if (isFollowingScreen() &amp;&amp; addedTag != null) {</span>
<span class="nc" id="L747">            EventBus.getDefault().removeStickyEvent(addedTag);</span>
            // user just added a tag so switch to it.
<span class="nc" id="L749">            ReaderTag newTag = ReaderUtils.getTagFromTagName(addedTag.getTagName(), ReaderTagType.FOLLOWED);</span>
<span class="nc" id="L750">            mSubFilterViewModel.setSubfilterFromTag(newTag);</span>
<span class="nc bnc" id="L751" title="All 4 branches missed.">        } else if (isFollowingScreen() &amp;&amp; !ReaderTagTable.tagExists(getCurrentTag())) {</span>
            // user just removed a tag which was selected in the subfilter
<span class="nc" id="L753">            mSubFilterViewModel.setDefaultSubfilter();</span>
        } else {
            // otherwise, refresh posts to make sure any changes are reflected and auto-update
            // posts in the current tag if it's time
<span class="nc" id="L757">            refreshPosts();</span>
<span class="nc" id="L758">            updateCurrentTagIfTime();</span>
        }
<span class="nc" id="L760">    }</span>

    @Nullable
    private Site getSiteIfBlogPreview() {
<span class="nc" id="L764">        Site currentSite = null;</span>

<span class="nc bnc" id="L766" title="All 4 branches missed.">        if (isFilterableScreen() &amp;&amp; getPostListType() == ReaderPostListType.BLOG_PREVIEW) {</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">            currentSite = mSubFilterViewModel.getCurrentSubfilterValue() instanceof Site ? (Site) (mSubFilterViewModel</span>
<span class="nc" id="L768">                    .getCurrentSubfilterValue()) : null;</span>
        }

<span class="nc" id="L771">        return currentSite;</span>
    }

    private void resumeFollowedSite(Site currentSite) {
<span class="nc" id="L775">        ReaderBlog blog = currentSite.getBlog();</span>
<span class="nc" id="L776">        boolean isSiteStillAvailable = false;</span>

<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (blog != null) {</span>
<span class="nc bnc" id="L779" title="All 4 branches missed.">            if ((blog.hasFeedUrl() &amp;&amp; ReaderBlogTable.isFollowedFeed(blog.feedId))</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">                || ReaderBlogTable.isFollowedBlog(blog.blogId)) {</span>
<span class="nc" id="L781">                isSiteStillAvailable = true;</span>
            }
        }

<span class="nc bnc" id="L785" title="All 2 branches missed.">        if (isSiteStillAvailable) {</span>
<span class="nc" id="L786">            refreshPosts();</span>
        } else {
<span class="nc bnc" id="L788" title="All 2 branches missed.">            if (isFilterableScreen()) {</span>
<span class="nc" id="L789">                mSubFilterViewModel.setDefaultSubfilter();</span>
            }
        }
<span class="nc" id="L792">    }</span>

    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    public void onAttach(@NonNull Context context) {
<span class="nc" id="L797">        super.onAttach(context);</span>

        // detect the bottom nav controller when this fragment is hosted in the main activity - this is used to
        // hide the bottom nav when the user searches from the reader
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (context instanceof BottomNavController) {</span>
<span class="nc" id="L802">            mBottomNavController = (BottomNavController) context;</span>
        }
<span class="nc" id="L804">    }</span>

    @Override
    public void onDetach() {
<span class="nc" id="L808">        super.onDetach();</span>
<span class="nc" id="L809">        mBottomNavController = null;</span>
<span class="nc" id="L810">    }</span>

    @Override
    public void onStart() {
<span class="nc" id="L814">        super.onStart();</span>
<span class="nc" id="L815">        mDispatcher.register(this);</span>
<span class="nc" id="L816">        EventBus.getDefault().register(this);</span>

<span class="nc" id="L818">        reloadTags();</span>

        // purge database and update followed tags/blog if necessary - note that we don't purge unless
        // there's a connection to avoid removing posts the user would expect to see offline
<span class="nc bnc" id="L822" title="All 4 branches missed.">        if (getPostListType() == ReaderPostListType.TAG_FOLLOWED &amp;&amp; NetworkUtils.isNetworkAvailable(getActivity())) {</span>
<span class="nc" id="L823">            purgeDatabaseIfNeeded();</span>
        }

<span class="nc" id="L826">        checkPostAdapter();</span>
<span class="nc" id="L827">    }</span>

    @Override
    public void onStop() {
<span class="nc" id="L831">        super.onStop();</span>
<span class="nc" id="L832">        mNewPostsBar.clearAnimation();</span>
<span class="nc" id="L833">        mDispatcher.unregister(this);</span>
<span class="nc" id="L834">        EventBus.getDefault().unregister(this);</span>
<span class="nc" id="L835">    }</span>

    /*
     * ensures the adapter is created and posts are updated if they haven't already been
     */
    private void checkPostAdapter() {
<span class="nc bnc" id="L841" title="All 4 branches missed.">        if (isAdded() &amp;&amp; mRecyclerView.getAdapter() == null) {</span>
<span class="nc" id="L842">            mRecyclerView.setAdapter(getPostAdapter());</span>
<span class="nc" id="L843">            refreshPosts();</span>
<span class="nc bnc" id="L844" title="All 4 branches missed.">            if (!mHasUpdatedPosts &amp;&amp; NetworkUtils.isNetworkAvailable(getActivity())) {</span>
<span class="nc" id="L845">                mHasUpdatedPosts = true;</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">                if (getPostListType().isTagType()) {</span>
<span class="nc" id="L847">                    updateCurrentTagIfTime();</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">                } else if (getPostListType() == ReaderPostListType.BLOG_PREVIEW) {</span>
<span class="nc" id="L849">                    updatePostsInCurrentBlogOrFeed(ReaderPostServiceStarter.UpdateAction.REQUEST_NEWER);</span>
                }
            }
        }
<span class="nc" id="L853">    }</span>

    /*
     * reset the post adapter to initial state and create it again using the passed list type
     */
    private void resetPostAdapter(ReaderPostListType postListType) {
<span class="nc" id="L859">        mPostListType = postListType;</span>
<span class="nc" id="L860">        mPostAdapter = null;</span>
<span class="nc" id="L861">        mRecyclerView.setAdapter(null);</span>
<span class="nc" id="L862">        mRecyclerView.setAdapter(getPostAdapter());</span>
<span class="nc" id="L863">        mRecyclerView.setSwipeToRefreshEnabled(isSwipeToRefreshSupported());</span>
<span class="nc" id="L864">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ReaderEvents.FollowedTagsChanged event) {
<span class="nc bnc" id="L869" title="All 2 branches missed.">        if (getPostListType() == ReaderPostListType.TAG_FOLLOWED) {</span>
            // reload the tag filter since tags have changed
<span class="nc" id="L871">            reloadTags();</span>

            // update the current tag if the list fragment is empty - this will happen if
            // the tag table was previously empty (ie: first run)
<span class="nc bnc" id="L875" title="All 2 branches missed.">            if (isPostAdapterEmpty()) {</span>
<span class="nc" id="L876">                updateCurrentTag();</span>
            }
        }
<span class="nc" id="L879">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ReaderEvents.FollowedBlogsChanged event) {
        // refresh posts if user is viewing &quot;Followed Sites&quot;
<span class="nc bnc" id="L885" title="All 2 branches missed.">        if (getPostListType() == ReaderPostListType.TAG_FOLLOWED</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">            &amp;&amp; hasCurrentTag()</span>
<span class="nc bnc" id="L887" title="All 4 branches missed.">            &amp;&amp; (getCurrentTag().isFollowedSites() || getCurrentTag().isDefaultInMemoryTag())) {</span>
<span class="nc" id="L888">            refreshPosts();</span>
        }
<span class="nc" id="L890">    }</span>

    @Override
    public void onSaveInstanceState(@NonNull Bundle outState) {
<span class="nc" id="L894">        AppLog.d(T.READER, &quot;reader post list &gt; saving instance state&quot;);</span>

<span class="nc bnc" id="L896" title="All 2 branches missed.">        if (mCurrentTag != null) {</span>
<span class="nc" id="L897">            outState.putSerializable(ReaderConstants.ARG_TAG, mCurrentTag);</span>
        }

<span class="nc bnc" id="L900" title="All 2 branches missed.">        if (mTagFragmentStartedWith != null) {</span>
<span class="nc" id="L901">            outState.putSerializable(ReaderConstants.ARG_ORIGINAL_TAG, mTagFragmentStartedWith);</span>
        }

<span class="nc bnc" id="L904" title="All 2 branches missed.">        if (getPostListType() == ReaderPostListType.TAG_PREVIEW) {</span>
<span class="nc" id="L905">            mTagPreviewHistory.saveInstance(outState);</span>
<span class="nc bnc" id="L906" title="All 4 branches missed.">        } else if (getPostListType() == ReaderPostListType.SEARCH_RESULTS</span>
                   &amp;&amp; mSearchView != null
<span class="nc bnc" id="L908" title="All 2 branches missed.">                   &amp;&amp; mSearchView.getQuery() != null) {</span>
<span class="nc" id="L909">            String query = mSearchView.getQuery().toString();</span>
<span class="nc" id="L910">            outState.putString(ReaderConstants.ARG_SEARCH_QUERY, query);</span>
        }

<span class="nc" id="L913">        outState.putLong(ReaderConstants.ARG_BLOG_ID, mCurrentBlogId);</span>
<span class="nc" id="L914">        outState.putLong(ReaderConstants.ARG_FEED_ID, mCurrentFeedId);</span>
<span class="nc" id="L915">        outState.putBoolean(ReaderConstants.KEY_WAS_PAUSED, mWasPaused);</span>
<span class="nc" id="L916">        outState.putBoolean(ReaderConstants.KEY_ALREADY_UPDATED, mHasUpdatedPosts);</span>
<span class="nc" id="L917">        outState.putBoolean(ReaderConstants.KEY_FIRST_LOAD, mFirstLoad);</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">        if (mRecyclerView != null) {</span>
<span class="nc" id="L919">            outState.putBoolean(ReaderConstants.KEY_IS_REFRESHING, mRecyclerView.isRefreshing());</span>
<span class="nc" id="L920">            outState.putInt(ReaderConstants.KEY_RESTORE_POSITION, getCurrentPosition());</span>
        }
<span class="nc" id="L922">        outState.putSerializable(ReaderConstants.ARG_POST_LIST_TYPE, getPostListType());</span>
<span class="nc" id="L923">        outState.putBoolean(ReaderConstants.ARG_IS_TOP_LEVEL, mIsTopLevel);</span>

<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (isSearchTabsShowing()) {</span>
<span class="nc" id="L926">            int tabPosition = getSearchTabsPosition();</span>
<span class="nc" id="L927">            outState.putInt(ReaderConstants.KEY_ACTIVE_SEARCH_TAB, tabPosition);</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">            int siteSearchPosition = tabPosition == TAB_SITES ? getCurrentPosition() : mSiteSearchAdapterPos;</span>
<span class="nc" id="L929">            outState.putInt(ReaderConstants.KEY_SITE_SEARCH_RESTORE_POSITION, siteSearchPosition);</span>
        }

<span class="nc bnc" id="L932" title="All 4 branches missed.">        if (isFilterableTag(mTagFragmentStartedWith) &amp;&amp; mSubFilterViewModel != null) {</span>
<span class="nc" id="L933">            mSubFilterViewModel.onSaveInstanceState(outState);</span>
        }

<span class="nc" id="L936">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L937">    }</span>

    private int getCurrentPosition() {
<span class="nc bnc" id="L940" title="All 4 branches missed.">        if (mRecyclerView != null &amp;&amp; hasPostAdapter()) {</span>
<span class="nc" id="L941">            return mRecyclerView.getCurrentPosition();</span>
        } else {
<span class="nc" id="L943">            return -1;</span>
        }
    }

    private void updatePosts(boolean forced) {
<span class="nc bnc" id="L948" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L949">            return;</span>
        }

<span class="nc bnc" id="L952" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(getActivity())) {</span>
<span class="nc" id="L953">            mRecyclerView.setRefreshing(false);</span>
<span class="nc" id="L954">            return;</span>
        }

<span class="nc bnc" id="L957" title="All 2 branches missed.">        if (forced) {</span>
            // Update the tags on post refresh since following some sites (like P2) will change followed tags and blogs
<span class="nc" id="L959">            ReaderUpdateServiceStarter.startService(getContext(),</span>
<span class="nc" id="L960">                    EnumSet.of(UpdateTask.TAGS, UpdateTask.FOLLOWED_BLOGS));</span>
        }

<span class="nc bnc" id="L963" title="All 2 branches missed.">        if (mFirstLoad) {</span>
            // let onResume() take care of this logic, as the FilteredRecyclerView.FilterListener onLoadData
            // method is called on two moments: once for first time load, and then each time the swipe to
            // refresh gesture triggers a refresh.
<span class="nc" id="L967">            mRecyclerView.setRefreshing(false);</span>
<span class="nc" id="L968">            mFirstLoad = false;</span>
        } else {
<span class="nc bnc" id="L970" title="All 2 branches missed.">            UpdateAction updateAction = forced ? UpdateAction.REQUEST_REFRESH</span>
<span class="nc" id="L971">                    : UpdateAction.REQUEST_NEWER;</span>
<span class="nc bnc" id="L972" title="All 3 branches missed.">            switch (getPostListType()) {</span>
                case TAG_FOLLOWED:
                    // fall through to TAG_PREVIEW
                case TAG_PREVIEW:
<span class="nc" id="L976">                    updatePostsWithTag(getCurrentTag(), updateAction);</span>
<span class="nc" id="L977">                    break;</span>
                case BLOG_PREVIEW:
<span class="nc" id="L979">                    updatePostsInCurrentBlogOrFeed(updateAction);</span>
<span class="nc" id="L980">                    break;</span>
                case SEARCH_RESULTS:
                    // no-op
                    break;
            }
            // make sure swipe-to-refresh progress shows since this is a manual refresh
<span class="nc" id="L986">            mRecyclerView.setRefreshing(true);</span>
        }
<span class="nc bnc" id="L988" title="All 4 branches missed.">        if (getCurrentTag() != null &amp;&amp; getCurrentTag().isBookmarked()) {</span>
<span class="nc" id="L989">            ReaderPostTable.purgeUnbookmarkedPostsWithBookmarkTag();</span>
<span class="nc" id="L990">            refreshPosts();</span>
        }
<span class="nc" id="L992">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L996">        final ViewGroup rootView = (ViewGroup) inflater.inflate(R.layout.reader_fragment_post_cards, container, false);</span>
<span class="nc" id="L997">        mRecyclerView = rootView.findViewById(R.id.reader_recycler_view);</span>

<span class="nc" id="L999">        mActionableEmptyView = rootView.findViewById(R.id.empty_custom_view);</span>

<span class="nc" id="L1001">        mRecyclerView.setLogT(AppLog.T.READER);</span>
<span class="nc" id="L1002">        mRecyclerView.setCustomEmptyView();</span>
<span class="nc" id="L1003">        mRecyclerView.setFilterListener(new FilteredRecyclerView.FilterListener() {</span>
            @Override
            public List&lt;FilterCriteria&gt; onLoadFilterCriteriaOptions(boolean refresh) {
<span class="nc" id="L1006">                return null;</span>
            }

            @Override
            public void onLoadFilterCriteriaOptionsAsync(
                    FilteredRecyclerView.FilterCriteriaAsyncLoaderListener listener, boolean refresh) {
<span class="nc" id="L1012">            }</span>

            @Override
            public void onLoadData(boolean forced) {
<span class="nc bnc" id="L1016" title="All 2 branches missed.">                if (forced) {</span>
<span class="nc" id="L1017">                    mReaderTracker.track(AnalyticsTracker.Stat.READER_PULL_TO_REFRESH);</span>
                }
<span class="nc" id="L1019">                updatePosts(forced);</span>
<span class="nc" id="L1020">            }</span>

            @Override
            public void onFilterSelected(int position, FilterCriteria criteria) {
<span class="nc" id="L1024">                onTagChanged((ReaderTag) criteria);</span>
<span class="nc" id="L1025">            }</span>

            @Override
            public FilterCriteria onRecallSelection() {
<span class="nc bnc" id="L1029" title="All 2 branches missed.">                if (hasCurrentTag()) {</span>
                    ReaderTag defaultTag;

<span class="nc" id="L1032">                    defaultTag = ReaderUtils.getDefaultTagFromDbOrCreateInMemory(</span>
<span class="nc" id="L1033">                            requireActivity(),</span>
                            mTagUpdateClientUtilsProvider
                    );

<span class="nc" id="L1037">                    ReaderTag tag = ReaderUtils.getValidTagForSharedPrefs(</span>
<span class="nc" id="L1038">                            getCurrentTag(),</span>
<span class="nc" id="L1039">                            mIsTopLevel,</span>
<span class="nc" id="L1040">                            mRecyclerView,</span>
                            defaultTag);

<span class="nc" id="L1043">                    return tag;</span>
                } else {
<span class="nc" id="L1045">                    AppLog.w(T.READER, &quot;reader post list &gt; no current tag in onRecallSelection&quot;);</span>
<span class="nc" id="L1046">                    return ReaderUtils.getDefaultTag();</span>
                }
            }

            @Override
            public String onShowEmptyViewMessage(EmptyViewMessageType emptyViewMsgType) {
<span class="nc" id="L1052">                return null;</span>
            }

            @Override
            public void onShowCustomEmptyView(EmptyViewMessageType emptyViewMsgType) {
<span class="nc" id="L1057">                setEmptyTitleDescriptionAndButton(</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">                        EmptyViewMessageType.NETWORK_ERROR.equals(emptyViewMsgType)</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">                        || EmptyViewMessageType.PERMISSION_ERROR.equals(emptyViewMsgType)</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">                        || EmptyViewMessageType.GENERIC_ERROR.equals(emptyViewMsgType));</span>
<span class="nc" id="L1061">            }</span>
        });

        // add the item decoration (dividers) to the recycler, skipping the first item if the first
        // item is the tag toolbar (shown when viewing posts in followed tags) - this is to avoid
        // having the tag toolbar take up more vertical space than necessary
<span class="nc" id="L1067">        int spacingHorizontal = getResources().getDimensionPixelSize(R.dimen.reader_card_margin);</span>
<span class="nc" id="L1068">        int spacingVertical = getResources().getDimensionPixelSize(R.dimen.reader_card_gutters);</span>
<span class="nc" id="L1069">        mRecyclerView.addItemDecoration(new RecyclerItemDecoration(spacingHorizontal, spacingVertical, false));</span>

<span class="nc" id="L1071">        mRecyclerView.setToolbarBackgroundColor(0);</span>
<span class="nc" id="L1072">        mRecyclerView.setToolbarSpinnerDrawable(R.drawable.ic_dropdown_primary_30_24dp);</span>

<span class="nc bnc" id="L1074" title="All 2 branches missed.">        if (mIsTopLevel) {</span>
<span class="nc" id="L1075">            mRecyclerView.setToolbarTitle(</span>
                    R.string.reader_screen_title,
<span class="nc" id="L1077">                    getResources().getDimensionPixelSize(R.dimen.margin_extra_large)</span>
            );
        } else {
<span class="nc" id="L1080">            mRecyclerView.setToolbarLeftAndRightPadding(</span>
<span class="nc" id="L1081">                    getResources().getDimensionPixelSize(R.dimen.margin_medium),</span>
<span class="nc" id="L1082">                    getResources().getDimensionPixelSize(R.dimen.margin_extra_large));</span>
        }

        // add a menu to the filtered recycler's toolbar
<span class="nc bnc" id="L1086" title="All 4 branches missed.">        if (mAccountStore.hasAccessToken() &amp;&amp; getPostListType() == ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L1087">            setupRecyclerToolbar();</span>
        }

<span class="nc" id="L1090">        mRecyclerView.setSwipeToRefreshEnabled(isSwipeToRefreshSupported());</span>

        // bar that appears at top after new posts are loaded
<span class="nc" id="L1093">        mNewPostsBar = rootView.findViewById(R.id.layout_new_posts);</span>
<span class="nc" id="L1094">        mNewPostsBar.setVisibility(View.GONE);</span>
<span class="nc" id="L1095">        mNewPostsBar.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L1098">                mRecyclerView.scrollRecycleViewToPosition(0);</span>
<span class="nc" id="L1099">                refreshPosts();</span>
<span class="nc" id="L1100">            }</span>
        });

        // progress bar that appears when loading more posts
<span class="nc" id="L1104">        mProgress = rootView.findViewById(R.id.progress_footer);</span>
<span class="nc" id="L1105">        mProgress.setVisibility(View.GONE);</span>

<span class="nc bnc" id="L1107" title="All 4 branches missed.">        if (savedInstanceState != null &amp;&amp; savedInstanceState.getBoolean(ReaderConstants.KEY_IS_REFRESHING)) {</span>
<span class="nc" id="L1108">            mIsUpdating = true;</span>
<span class="nc" id="L1109">            mRecyclerView.setRefreshing(true);</span>
        }


<span class="nc bnc" id="L1113" title="All 2 branches missed.">        if (isFilterableScreen()) {</span>
<span class="nc" id="L1114">            initSubFilterViews(rootView, inflater);</span>
        }

<span class="nc" id="L1117">        return rootView;</span>
    }

    /*
     * adds a menu to the recycler's toolbar containing search items - only called
     * for followed tags
     */
    private void setupRecyclerToolbar() {
<span class="nc" id="L1125">        Menu menu = mRecyclerView.addToolbarMenu(R.menu.reader_list);</span>
<span class="nc" id="L1126">        mSearchMenuItem = menu.findItem(R.id.menu_reader_search);</span>

<span class="nc" id="L1128">        mSearchView = (SearchView) mSearchMenuItem.getActionView();</span>
<span class="nc" id="L1129">        mSearchView.setQueryHint(getString(R.string.reader_hint_post_search));</span>
<span class="nc" id="L1130">        mSearchView.setSubmitButtonEnabled(false);</span>
<span class="nc" id="L1131">        mSearchView.setIconifiedByDefault(true);</span>
<span class="nc" id="L1132">        mSearchView.setIconified(true);</span>

        // force the search view to take up as much horizontal space as possible (without this
        // it looks truncated on landscape)
<span class="nc" id="L1136">        int maxWidth = DisplayUtils.getWindowPixelWidth(requireActivity());</span>
<span class="nc" id="L1137">        mSearchView.setMaxWidth(maxWidth);</span>

        // this is hacky, but we want to change the SearchView's autocomplete to show suggestions
        // after a single character is typed, and there's no less hacky way to do this...
<span class="nc" id="L1141">        View view = mSearchView.findViewById(androidx.appcompat.R.id.search_src_text);</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">        if (view instanceof AutoCompleteTextView) {</span>
<span class="nc" id="L1143">            ((AutoCompleteTextView) view).setThreshold(1);</span>
        }

<span class="nc" id="L1146">        mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {</span>
            @Override
            public boolean onMenuItemActionExpand(MenuItem item) {
<span class="nc bnc" id="L1149" title="All 2 branches missed.">                if (getPostListType() != ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L1150">                    mReaderTracker.track(AnalyticsTracker.Stat.READER_SEARCH_LOADED);</span>
                }
<span class="nc" id="L1152">                resetPostAdapter(ReaderPostListType.SEARCH_RESULTS);</span>
<span class="nc" id="L1153">                populateSearchSuggestions(null);</span>
<span class="nc" id="L1154">                showSearchMessageOrSuggestions();</span>
                // hide the bottom navigation when search is active
<span class="nc bnc" id="L1156" title="All 2 branches missed.">                if (mBottomNavController != null) {</span>
<span class="nc" id="L1157">                    mBottomNavController.onRequestHideBottomNavigation();</span>
                }

<span class="nc" id="L1160">                return true;</span>
            }

            @Override
            public boolean onMenuItemActionCollapse(MenuItem item) {
<span class="nc" id="L1165">                requireActivity().finish();</span>
<span class="nc" id="L1166">                return false;</span>
            }
        });

<span class="nc" id="L1170">        mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {</span>
                                               @Override
                                               public boolean onQueryTextSubmit(String query) {
<span class="nc" id="L1173">                                                   submitSearchQuery(query);</span>
<span class="nc" id="L1174">                                                   return true;</span>
                                               }

                                               @Override
                                               public boolean onQueryTextChange(String newText) {
<span class="nc" id="L1179">                                                   populateSearchSuggestions(newText);</span>
<span class="nc" id="L1180">                                                   showSearchMessageOrSuggestions();</span>
<span class="nc" id="L1181">                                                   return true;</span>
                                               }
                                           }
        );
<span class="nc" id="L1185">    }</span>

    private void showSearchMessageOrSuggestions() {
<span class="nc bnc" id="L1188" title="All 2 branches missed.">        boolean hasQuery = !isSearchViewEmpty();</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">        boolean hasPerformedSearch = !TextUtils.isEmpty(mCurrentSearchQuery);</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">        boolean isSearching = getPostListType() == ReaderPostListType.SEARCH_RESULTS;</span>

        // prevents suggestions from being shown after the search view has been collapsed
<span class="nc bnc" id="L1193" title="All 2 branches missed.">        if (!isSearching) {</span>
<span class="nc" id="L1194">            return;</span>
        }

        // prevents suggestions from being shown above search results after configuration changes
<span class="nc bnc" id="L1198" title="All 4 branches missed.">        if (mWasPaused &amp;&amp; hasPerformedSearch) {</span>
<span class="nc" id="L1199">            return;</span>
        }

<span class="nc bnc" id="L1202" title="All 4 branches missed.">        if (!hasQuery || !hasPerformedSearch) {</span>
            // clear posts and sites so only the suggestions or the empty view are visible
<span class="nc" id="L1204">            getPostAdapter().clear();</span>
<span class="nc" id="L1205">            getSiteSearchAdapter().clear();</span>

<span class="nc" id="L1207">            hideSearchTabs();</span>

            // clears the last performed query
<span class="nc" id="L1210">            mCurrentSearchQuery = null;</span>

<span class="nc bnc" id="L1212" title="All 2 branches missed.">            final boolean hasSuggestions =</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">                    mSearchSuggestionRecyclerAdapter != null &amp;&amp; mSearchSuggestionRecyclerAdapter.getItemCount() &gt; 0;</span>

<span class="nc bnc" id="L1215" title="All 2 branches missed.">            if (hasSuggestions) {</span>
<span class="nc" id="L1216">                hideSearchMessage();</span>
<span class="nc" id="L1217">                showSearchSuggestions();</span>
            } else {
<span class="nc" id="L1219">                showSearchMessage();</span>
<span class="nc" id="L1220">                hideSearchSuggestions();</span>
            }
        }
<span class="nc" id="L1223">    }</span>

    /*
     * start the search service to search for posts matching the current query - the passed
     * offset is used during infinite scroll, pass zero for initial search
     */
    private void updatePostsInCurrentSearch(int offset) {
<span class="nc" id="L1230">        ReaderSearchServiceStarter.startService(getActivity(), mCurrentSearchQuery, offset);</span>
<span class="nc" id="L1231">    }</span>

    /*
     * start a search for reader sites matching the current search query
     */
    private void updateSitesInCurrentSearch(int offset) {
<span class="nc bnc" id="L1237" title="All 2 branches missed.">        if (getSearchTabsPosition() == TAB_SITES) {</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">            if (offset == 0) {</span>
<span class="nc" id="L1239">                mRecyclerView.setRefreshing(true);</span>
            } else {
<span class="nc" id="L1241">                showLoadingProgress(true);</span>
            }
        }
<span class="nc" id="L1244">        ReaderSearchSitesPayload payload = new ReaderSearchSitesPayload(</span>
                mCurrentSearchQuery,
                ReaderConstants.READER_MAX_SEARCH_RESULTS_TO_REQUEST,
                offset,
                false);
<span class="nc" id="L1249">        mDispatcher.dispatch(ReaderActionBuilder.newReaderSearchSitesAction(payload));</span>
<span class="nc" id="L1250">    }</span>

    private void submitSearchQuery(@NonNull String query) {
<span class="nc bnc" id="L1253" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1254">            return;</span>
        }

<span class="nc" id="L1257">        mSearchView.clearFocus(); // this will hide suggestions and the virtual keyboard</span>
<span class="nc" id="L1258">        hideSearchMessage();</span>
<span class="nc" id="L1259">        hideSearchSuggestions();</span>

        // remember this query for future suggestions
<span class="nc" id="L1262">        String trimQuery = query.trim();</span>
<span class="nc" id="L1263">        ReaderSearchTable.addOrUpdateQueryString(trimQuery);</span>

        // remove cached results for this search - search results are ephemeral so each search
        // should be treated as a &quot;fresh&quot; one
<span class="nc" id="L1267">        ReaderTag searchTag = ReaderUtils.getTagForSearchQuery(trimQuery);</span>
<span class="nc" id="L1268">        ReaderPostTable.deletePostsWithTag(searchTag);</span>

<span class="nc" id="L1270">        mPostAdapter.setCurrentTag(searchTag);</span>
<span class="nc" id="L1271">        mCurrentSearchQuery = trimQuery;</span>
<span class="nc" id="L1272">        updatePostsInCurrentSearch(0);</span>
<span class="nc" id="L1273">        updateSitesInCurrentSearch(0);</span>

        // track that the user performed a search
<span class="nc bnc" id="L1276" title="All 2 branches missed.">        if (!trimQuery.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1277">            mReaderTracker.trackQuery(AnalyticsTracker.Stat.READER_SEARCH_PERFORMED, trimQuery);</span>
        }
<span class="nc" id="L1279">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onReaderSitesSearched(OnReaderSitesSearched event) {
<span class="nc bnc" id="L1284" title="All 4 branches missed.">        if (!isAdded() || getPostListType() != ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L1285">            return;</span>
        }

<span class="nc bnc" id="L1288" title="All 2 branches missed.">        if (!isUpdating()) {</span>
<span class="nc" id="L1289">            mRecyclerView.setRefreshing(false);</span>
        }
<span class="nc" id="L1291">        showLoadingProgress(false);</span>

<span class="nc" id="L1293">        ReaderSiteSearchAdapter adapter = getSiteSearchAdapter();</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1295">            adapter.clear();</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">        } else if (StringUtils.equals(event.searchTerm, mCurrentSearchQuery)) {</span>
<span class="nc" id="L1297">            adapter.setCanLoadMore(event.canLoadMore);</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">            if (event.offset == 0) {</span>
<span class="nc" id="L1299">                adapter.setSiteList(event.sites);</span>
            } else {
<span class="nc" id="L1301">                adapter.addSiteList(event.sites);</span>
            }
<span class="nc bnc" id="L1303" title="All 2 branches missed.">            if (mSiteSearchRestorePosition &gt; 0) {</span>
<span class="nc" id="L1304">                mRecyclerView.scrollRecycleViewToPosition(mSiteSearchRestorePosition);</span>
            }
        }

<span class="nc bnc" id="L1308" title="All 4 branches missed.">        if (getSearchTabsPosition() == TAB_SITES &amp;&amp; adapter.isEmpty()) {</span>
<span class="nc" id="L1309">            setEmptyTitleDescriptionAndButton(event.isError());</span>
<span class="nc" id="L1310">            showEmptyView();</span>
        }

<span class="nc" id="L1313">        mSiteSearchRestorePosition = 0;</span>
<span class="nc" id="L1314">    }</span>

    /*
     * reuse &quot;empty&quot; view to let user know what they're querying
     */
    private void showSearchMessage() {
<span class="nc bnc" id="L1320" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1321">            return;</span>
        }

<span class="nc" id="L1324">        setEmptyTitleDescriptionAndButton(false);</span>
<span class="nc" id="L1325">        showEmptyView();</span>
<span class="nc" id="L1326">    }</span>

    private void hideSearchMessage() {
<span class="nc" id="L1329">        hideEmptyView();</span>
<span class="nc" id="L1330">    }</span>

    private void showSearchSuggestions() {
<span class="nc" id="L1333">        mRecyclerView.showSearchSuggestions();</span>
<span class="nc" id="L1334">    }</span>

    private void hideSearchSuggestions() {
<span class="nc" id="L1337">        mRecyclerView.hideSearchSuggestions();</span>
<span class="nc" id="L1338">    }</span>

    /*
     * create the TabLayout that separates search results between POSTS and SITES and places it below
     * the FilteredRecyclerView's toolbar
     */
    private void createSearchTabs() {
<span class="nc bnc" id="L1345" title="All 2 branches missed.">        if (mSearchTabs == null) {</span>
<span class="nc" id="L1346">            ViewGroup rootView = getView().findViewById(android.R.id.content);</span>
<span class="nc" id="L1347">            LayoutInflater inflater = LayoutInflater.from(getActivity());</span>
<span class="nc" id="L1348">            mSearchTabs = (TabLayout) inflater.inflate(R.layout.reader_search_tabs, rootView);</span>
<span class="nc" id="L1349">            mSearchTabs.setVisibility(View.GONE);</span>
<span class="nc" id="L1350">            mRecyclerView.getAppBarLayout().addView(mSearchTabs);</span>
        }
<span class="nc" id="L1352">    }</span>

    private boolean isSearchTabsShowing() {
<span class="nc bnc" id="L1355" title="All 4 branches missed.">        return mSearchTabs != null &amp;&amp; mSearchTabs.getVisibility() == View.VISIBLE;</span>
    }

    private void showSearchTabs() {
<span class="nc bnc" id="L1359" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1360">            return;</span>
        }
<span class="nc bnc" id="L1362" title="All 2 branches missed.">        if (mSearchTabs == null) {</span>
<span class="nc" id="L1363">            createSearchTabs();</span>
        }
<span class="nc bnc" id="L1365" title="All 2 branches missed.">        if (mSearchTabs.getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L1366">            mSearchTabs.setVisibility(View.VISIBLE);</span>

<span class="nc" id="L1368">            mPostSearchAdapterPos = 0;</span>
<span class="nc" id="L1369">            mSiteSearchAdapterPos = 0;</span>

<span class="nc" id="L1371">            mSearchTabs.addOnTabSelectedListener(new OnTabSelectedListener() {</span>
                @Override public void onTabSelected(Tab tab) {
<span class="nc bnc" id="L1373" title="All 2 branches missed.">                    if (tab.getPosition() == TAB_POSTS) {</span>
<span class="nc" id="L1374">                        mRecyclerView.setAdapter(getPostAdapter());</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">                        if (mPostSearchAdapterPos &gt; 0) {</span>
<span class="nc" id="L1376">                            mRecyclerView.scrollRecycleViewToPosition(mPostSearchAdapterPos);</span>
                        }
<span class="nc bnc" id="L1378" title="All 2 branches missed.">                        if (getPostAdapter().isEmpty()) {</span>
<span class="nc" id="L1379">                            setEmptyTitleDescriptionAndButton(false);</span>
<span class="nc" id="L1380">                            showEmptyView();</span>
                        } else {
<span class="nc" id="L1382">                            hideEmptyView();</span>
                        }
<span class="nc bnc" id="L1384" title="All 2 branches missed.">                    } else if (tab.getPosition() == TAB_SITES) {</span>
<span class="nc" id="L1385">                        mRecyclerView.setAdapter(getSiteSearchAdapter());</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">                        if (mSiteSearchAdapterPos &gt; 0) {</span>
<span class="nc" id="L1387">                            mRecyclerView.scrollRecycleViewToPosition(mSiteSearchAdapterPos);</span>
                        }
<span class="nc bnc" id="L1389" title="All 2 branches missed.">                        if (getSiteSearchAdapter().isEmpty()) {</span>
<span class="nc" id="L1390">                            setEmptyTitleDescriptionAndButton(false);</span>
<span class="nc" id="L1391">                            showEmptyView();</span>
                        } else {
<span class="nc" id="L1393">                            hideEmptyView();</span>
                        }
                    }
<span class="nc" id="L1396">                }</span>

                @Override public void onTabUnselected(Tab tab) {
<span class="nc bnc" id="L1399" title="All 2 branches missed.">                    if (tab.getPosition() == TAB_POSTS) {</span>
<span class="nc" id="L1400">                        mPostSearchAdapterPos = mRecyclerView.getCurrentPosition();</span>
<span class="nc bnc" id="L1401" title="All 2 branches missed.">                    } else if (tab.getPosition() == TAB_SITES) {</span>
<span class="nc" id="L1402">                        mSiteSearchAdapterPos = mRecyclerView.getCurrentPosition();</span>
                    }
<span class="nc" id="L1404">                }</span>

                @Override public void onTabReselected(Tab tab) {
<span class="nc" id="L1407">                    mRecyclerView.smoothScrollToPosition(0);</span>
<span class="nc" id="L1408">                }</span>
            });

<span class="nc bnc" id="L1411" title="All 4 branches missed.">            if (mSearchTabsPos != NO_POSITION &amp;&amp; mSearchTabsPos != mSearchTabs.getSelectedTabPosition()) {</span>
<span class="nc" id="L1412">                Tab tab = mSearchTabs.getTabAt(mSearchTabsPos);</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">                if (tab != null) {</span>
<span class="nc" id="L1414">                    tab.select();</span>
                }
<span class="nc" id="L1416">                mSearchTabsPos = NO_POSITION;</span>
            }
        }
<span class="nc" id="L1419">    }</span>

    private void hideSearchTabs() {
<span class="nc bnc" id="L1422" title="All 6 branches missed.">        if (isAdded() &amp;&amp; mSearchTabs != null &amp;&amp; mSearchTabs.getVisibility() == View.VISIBLE) {</span>
<span class="nc" id="L1423">            mSearchTabs.setVisibility(View.GONE);</span>
<span class="nc" id="L1424">            mSearchTabs.clearOnTabSelectedListeners();</span>
<span class="nc bnc" id="L1425" title="All 2 branches missed.">            if (mSearchTabs.getSelectedTabPosition() != TAB_POSTS) {</span>
<span class="nc" id="L1426">                mSearchTabs.getTabAt(TAB_POSTS).select();</span>
            }
<span class="nc" id="L1428">            mRecyclerView.setAdapter(getPostAdapter());</span>
<span class="nc" id="L1429">            mLastTappedSiteSearchResult = null;</span>
<span class="nc" id="L1430">            showLoadingProgress(false);</span>
        }
<span class="nc" id="L1432">    }</span>

    private int getSearchTabsPosition() {
<span class="nc bnc" id="L1435" title="All 2 branches missed.">        return isSearchTabsShowing() ? mSearchTabs.getSelectedTabPosition() : -1;</span>
    }

    private void populateSearchSuggestions(String query) {
<span class="nc" id="L1439">        populateSearchSuggestionAdapter(query);</span>
<span class="nc" id="L1440">        populateSearchSuggestionRecyclerAdapter(null); // always passing null as there's no need to filter</span>
<span class="nc" id="L1441">    }</span>

    /*
     * create and assign the suggestion adapter for the search view
     */
    private void createSearchSuggestionAdapter() {
<span class="nc" id="L1447">        mSearchSuggestionAdapter = new ReaderSearchSuggestionAdapter(getActivity());</span>
<span class="nc" id="L1448">        mSearchView.setSuggestionsAdapter(mSearchSuggestionAdapter);</span>

<span class="nc" id="L1450">        mSearchView.setOnSuggestionListener(new SearchView.OnSuggestionListener() {</span>
            @Override
            public boolean onSuggestionSelect(int position) {
<span class="nc" id="L1453">                return false;</span>
            }

            @Override
            public boolean onSuggestionClick(int position) {
<span class="nc" id="L1458">                String query = mSearchSuggestionAdapter.getSuggestion(position);</span>
<span class="nc" id="L1459">                onSearchSuggestionClicked(query);</span>
<span class="nc" id="L1460">                return true;</span>
            }
        });

<span class="nc" id="L1464">        mSearchSuggestionAdapter.setOnSuggestionDeleteClickListener(this::onSearchSuggestionDeleteClicked);</span>
<span class="nc" id="L1465">        mSearchSuggestionAdapter.setOnSuggestionClearClickListener(this::onSearchSuggestionClearClicked);</span>
<span class="nc" id="L1466">    }</span>

    private void populateSearchSuggestionAdapter(String query) {
<span class="nc bnc" id="L1469" title="All 2 branches missed.">        if (mSearchSuggestionAdapter == null) {</span>
<span class="nc" id="L1470">            createSearchSuggestionAdapter();</span>
        }
<span class="nc" id="L1472">        mSearchSuggestionAdapter.setFilter(query);</span>
<span class="nc" id="L1473">    }</span>

    private void resetSearchSuggestionAdapter() {
<span class="nc" id="L1476">        mSearchView.setSuggestionsAdapter(null);</span>
<span class="nc" id="L1477">        mSearchSuggestionAdapter = null;</span>
<span class="nc" id="L1478">    }</span>

    private void createSearchSuggestionRecyclerAdapter() {
<span class="nc" id="L1481">        mSearchSuggestionRecyclerAdapter = new ReaderSearchSuggestionRecyclerAdapter();</span>
<span class="nc" id="L1482">        mRecyclerView.setSearchSuggestionAdapter(mSearchSuggestionRecyclerAdapter);</span>

<span class="nc" id="L1484">        mSearchSuggestionRecyclerAdapter.setOnSuggestionClickListener(this::onSearchSuggestionClicked);</span>
<span class="nc" id="L1485">        mSearchSuggestionRecyclerAdapter.setOnSuggestionDeleteClickListener(this::onSearchSuggestionDeleteClicked);</span>
<span class="nc" id="L1486">        mSearchSuggestionRecyclerAdapter.setOnSuggestionClearClickListener(this::onSearchSuggestionClearClicked);</span>
<span class="nc" id="L1487">    }</span>

    private void populateSearchSuggestionRecyclerAdapter(String query) {
<span class="nc bnc" id="L1490" title="All 2 branches missed.">        if (mSearchSuggestionRecyclerAdapter == null) {</span>
<span class="nc" id="L1491">            createSearchSuggestionRecyclerAdapter();</span>
        }
<span class="nc" id="L1493">        mSearchSuggestionRecyclerAdapter.setQuery(query);</span>
<span class="nc" id="L1494">    }</span>

    private void resetSearchSuggestionRecyclerAdapter() {
<span class="nc" id="L1497">        mRecyclerView.setSearchSuggestionAdapter(null);</span>
<span class="nc" id="L1498">        mSearchSuggestionRecyclerAdapter = null;</span>
<span class="nc" id="L1499">    }</span>

    private void onSearchSuggestionClicked(String query) {
<span class="nc bnc" id="L1502" title="All 2 branches missed.">        if (!TextUtils.isEmpty(query)) {</span>
<span class="nc" id="L1503">            mSearchView.setQuery(query, true);</span>
        }
<span class="nc" id="L1505">    }</span>

    private void onSearchSuggestionDeleteClicked(String query) {
<span class="nc" id="L1508">        ReaderSearchTable.deleteQueryString(query);</span>

<span class="nc" id="L1510">        mSearchSuggestionAdapter.reload();</span>
<span class="nc" id="L1511">        mSearchSuggestionRecyclerAdapter.reload();</span>

<span class="nc" id="L1513">        showSearchMessageOrSuggestions();</span>
<span class="nc" id="L1514">    }</span>

    private void onSearchSuggestionClearClicked() {
<span class="nc" id="L1517">        showClearSearchSuggestionsConfirmationDialog(getContext());</span>
<span class="nc" id="L1518">    }</span>

    private void showClearSearchSuggestionsConfirmationDialog(final Context context) {
<span class="nc" id="L1521">        new MaterialAlertDialogBuilder(context)</span>
<span class="nc" id="L1522">                .setMessage(R.string.dlg_confirm_clear_search_history)</span>
<span class="nc" id="L1523">                .setCancelable(true)</span>
<span class="nc" id="L1524">                .setNegativeButton(R.string.no, null)</span>
<span class="nc" id="L1525">                .setPositiveButton(R.string.yes, (dialog, id) -&gt; clearSearchSuggestions())</span>
<span class="nc" id="L1526">                .create()</span>
<span class="nc" id="L1527">                .show();</span>
<span class="nc" id="L1528">    }</span>

    private void clearSearchSuggestions() {
<span class="nc" id="L1531">        mReaderTracker.track(Stat.READER_SEARCH_HISTORY_CLEARED);</span>
<span class="nc" id="L1532">        ReaderSearchTable.deleteAllQueries();</span>

<span class="nc" id="L1534">        mSearchSuggestionAdapter.swapCursor(null);</span>
<span class="nc" id="L1535">        mSearchSuggestionRecyclerAdapter.swapCursor(null);</span>

<span class="nc" id="L1537">        showSearchMessageOrSuggestions();</span>
<span class="nc" id="L1538">    }</span>

    /*
     * is the search input showing?
     */
    private boolean isSearchViewExpanded() {
<span class="nc bnc" id="L1544" title="All 4 branches missed.">        return mSearchView != null &amp;&amp; !mSearchView.isIconified();</span>
    }

    private boolean isSearchViewEmpty() {
<span class="nc bnc" id="L1548" title="All 4 branches missed.">        return mSearchView != null &amp;&amp; mSearchView.getQuery().length() == 0;</span>
    }

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ReaderEvents.SearchPostsStarted event) {
<span class="nc bnc" id="L1554" title="All 4 branches missed.">        if (!isAdded() || getPostListType() != ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L1555">            return;</span>
        }

<span class="nc bnc" id="L1558" title="All 2 branches missed.">        UpdateAction updateAction = event.getOffset() == 0 ? UpdateAction.REQUEST_NEWER : UpdateAction.REQUEST_OLDER;</span>
<span class="nc" id="L1559">        setIsUpdating(true, updateAction);</span>
<span class="nc" id="L1560">        setEmptyTitleDescriptionAndButton(false);</span>
<span class="nc" id="L1561">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ReaderEvents.SearchPostsEnded event) {
<span class="nc bnc" id="L1566" title="All 4 branches missed.">        if (!isAdded() || getPostListType() != ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L1567">            return;</span>
        }

<span class="nc bnc" id="L1570" title="All 2 branches missed.">        UpdateAction updateAction = event.getOffset() == 0 ? UpdateAction.REQUEST_NEWER : UpdateAction.REQUEST_OLDER;</span>
<span class="nc" id="L1571">        setIsUpdating(false, updateAction);</span>

        // load the results if the search succeeded and it's the current search - note that success
        // means the search didn't fail, not necessarily that is has results - which is fine because
        // if there aren't results then refreshing will show the empty message
<span class="nc bnc" id="L1576" title="All 2 branches missed.">        if (event.didSucceed()</span>
<span class="nc bnc" id="L1577" title="All 2 branches missed.">            &amp;&amp; getPostListType() == ReaderPostListType.SEARCH_RESULTS</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">            &amp;&amp; event.getQuery().equals(mCurrentSearchQuery)) {</span>
<span class="nc" id="L1579">            refreshPosts();</span>
<span class="nc" id="L1580">            showSearchTabs();</span>
        } else {
<span class="nc" id="L1582">            hideSearchTabs();</span>
        }
<span class="nc" id="L1584">    }</span>

    /*
     * returns the parent view for snackbars - if this fragment is hosted in the main activity we want the
     * parent to be the main activity's CoordinatorLayout
     */
    private View getSnackbarParent() {
<span class="nc" id="L1591">        View coordinator = getActivity().findViewById(R.id.coordinator_layout);</span>
<span class="nc bnc" id="L1592" title="All 2 branches missed.">        if (coordinator != null) {</span>
<span class="nc" id="L1593">            return coordinator;</span>
        }
<span class="nc" id="L1595">        return getView();</span>
    }

    private void setEmptyTitleDescriptionAndButton(boolean requestFailed) {
<span class="nc bnc" id="L1599" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1600">            return;</span>
        }

<span class="nc" id="L1603">        int heightToolbar = getActivity().getResources().getDimensionPixelSize(R.dimen.toolbar_height);</span>
<span class="nc" id="L1604">        int heightTabs = getActivity().getResources().getDimensionPixelSize(R.dimen.tab_height);</span>
<span class="nc" id="L1605">        mActionableEmptyView.updateLayoutForSearch(false, 0);</span>
<span class="nc" id="L1606">        mActionableEmptyView.subtitle.setContentDescription(null);</span>
<span class="nc" id="L1607">        boolean isSearching = false;</span>
        String title;
<span class="nc" id="L1609">        String description = null;</span>
<span class="nc" id="L1610">        ActionableEmptyViewButtonType button = null;</span>

        // Ensure the default image is reset for empty views before applying logic
<span class="nc" id="L1613">        mActionableEmptyView.image.setImageResource(R.drawable.img_illustration_empty_results_216dp);</span>

<span class="nc bnc" id="L1615" title="All 2 branches missed.">        if (shouldShowEmptyViewForSelfHostedCta()) {</span>
<span class="nc" id="L1616">            setEmptyTitleAndDescriptionForSelfHostedCta();</span>
<span class="nc" id="L1617">            return;</span>
<span class="nc bnc" id="L1618" title="All 4 branches missed.">        } else if (getPostListType() == ReaderPostListType.TAG_FOLLOWED &amp;&amp; getCurrentTag().isBookmarked()) {</span>
<span class="nc" id="L1619">            setEmptyTitleAndDescriptionForBookmarksList();</span>
<span class="nc" id="L1620">            return;</span>
<span class="nc bnc" id="L1621" title="All 2 branches missed.">        } else if (!NetworkUtils.isNetworkAvailable(getActivity())) {</span>
<span class="nc" id="L1622">            title = getString(R.string.reader_empty_posts_no_connection);</span>
<span class="nc bnc" id="L1623" title="All 2 branches missed.">        } else if (requestFailed) {</span>
<span class="nc bnc" id="L1624" title="All 2 branches missed.">            if (getPostListType() == ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L1625">                title = getString(R.string.reader_empty_search_request_failed);</span>
            } else {
<span class="nc" id="L1627">                title = getString(R.string.reader_empty_posts_request_failed);</span>
            }
<span class="nc bnc" id="L1629" title="All 4 branches missed.">        } else if (isUpdating() &amp;&amp; getPostListType() != ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L1630">            title = getString(R.string.reader_empty_posts_in_tag_updating);</span>
        } else {
<span class="nc bnc" id="L1632" title="All 4 branches missed.">            switch (getPostListType()) {</span>
                case TAG_FOLLOWED:
<span class="nc bnc" id="L1634" title="All 4 branches missed.">                    if (getCurrentTag().isFollowedSites() || getCurrentTag().isDefaultInMemoryTag()) {</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">                        if (ReaderBlogTable.hasFollowedBlogs()) {</span>
<span class="nc" id="L1636">                            title = getString(R.string.reader_empty_followed_blogs_no_recent_posts_title);</span>
<span class="nc" id="L1637">                            description = getString(R.string.reader_empty_followed_blogs_no_recent_posts_description);</span>
                        } else {
<span class="nc" id="L1639">                            title = getString(R.string.reader_empty_followed_blogs_title);</span>
<span class="nc" id="L1640">                            description = getString(R.string.reader_empty_followed_blogs_description);</span>
                        }
<span class="nc" id="L1642">                        mActionableEmptyView.image.setImageResource(</span>
                                R.drawable.img_illustration_following_empty_results_196dp);
<span class="nc" id="L1644">                        button = ActionableEmptyViewButtonType.DISCOVER;</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">                    } else if (getCurrentTag().isPostsILike()) {</span>
<span class="nc" id="L1646">                        title = getString(R.string.reader_empty_posts_liked_title);</span>
<span class="nc" id="L1647">                        description = getString(R.string.reader_empty_posts_liked_description);</span>
<span class="nc" id="L1648">                        button = ActionableEmptyViewButtonType.FOLLOWED;</span>
<span class="nc bnc" id="L1649" title="All 2 branches missed.">                    } else if (getCurrentTag().isListTopic()) {</span>
<span class="nc" id="L1650">                        title = getString(R.string.reader_empty_posts_in_custom_list);</span>
                    } else {
<span class="nc" id="L1652">                        title = getString(R.string.reader_empty_posts_in_tag);</span>
                    }
<span class="nc" id="L1654">                    break;</span>
                case BLOG_PREVIEW:
<span class="nc" id="L1656">                    title = getString(R.string.reader_empty_posts_in_blog);</span>
<span class="nc" id="L1657">                    break;</span>
                case SEARCH_RESULTS:
<span class="nc" id="L1659">                    isSearching = true;</span>

<span class="nc bnc" id="L1661" title="All 4 branches missed.">                    if (isSearchViewEmpty() || TextUtils.isEmpty(mCurrentSearchQuery)) {</span>
<span class="nc" id="L1662">                        title = getString(R.string.reader_label_post_search_explainer);</span>
<span class="nc" id="L1663">                        mActionableEmptyView.updateLayoutForSearch(true, heightToolbar);</span>
<span class="nc bnc" id="L1664" title="All 2 branches missed.">                    } else if (isUpdating()) {</span>
<span class="nc" id="L1665">                        title = &quot;&quot;;</span>
<span class="nc" id="L1666">                        mActionableEmptyView.updateLayoutForSearch(true, heightToolbar);</span>
                    } else {
<span class="nc" id="L1668">                        title = getString(R.string.reader_empty_search_title);</span>
<span class="nc" id="L1669">                        String formattedQuery = &quot;&lt;em&gt;&quot; + mCurrentSearchQuery + &quot;&lt;/em&gt;&quot;;</span>
<span class="nc" id="L1670">                        description = String.format(getString(R.string.reader_empty_search_description),</span>
                                formattedQuery);
<span class="nc" id="L1672">                        mActionableEmptyView.updateLayoutForSearch(true, heightToolbar + heightTabs);</span>
                    }
<span class="nc" id="L1674">                    break;</span>
                case TAG_PREVIEW:
                    // fall through to the default case
                default:
<span class="nc" id="L1678">                    title = getString(R.string.reader_empty_posts_in_tag);</span>
                    break;
            }
        }

<span class="nc" id="L1683">        setEmptyTitleDescriptionAndButton(title, description, button, isSearching);</span>
<span class="nc" id="L1684">    }</span>

    /*
     * Currently, only local bookmarks are supported.  Show an empty view if the local database has no data.
     */
    private void setEmptyTitleAndDescriptionForBookmarksList() {
        // replace %s placeholder with bookmark outline icon
<span class="nc" id="L1691">        String description = getString(R.string.reader_empty_saved_posts_description);</span>
<span class="nc" id="L1692">        SpannableStringBuilder ssb = new SpannableStringBuilder(description);</span>
<span class="nc" id="L1693">        int imagePlaceholderPosition = description.indexOf(&quot;%s&quot;);</span>
<span class="nc" id="L1694">        addBookmarkImageSpan(ssb, imagePlaceholderPosition);</span>
<span class="nc" id="L1695">        mActionableEmptyView.image.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1696">        mActionableEmptyView.title.setText(R.string.reader_empty_saved_posts_title);</span>
<span class="nc" id="L1697">        mActionableEmptyView.subtitle.setText(ssb);</span>
<span class="nc" id="L1698">        mActionableEmptyView.subtitle</span>
<span class="nc" id="L1699">                .setContentDescription(getString(R.string.reader_empty_saved_posts_content_description));</span>
<span class="nc" id="L1700">        mActionableEmptyView.subtitle.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1701">        mActionableEmptyView.button.setText(R.string.reader_empty_followed_blogs_button_followed);</span>
<span class="nc" id="L1702">        mActionableEmptyView.button.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1703">        mActionableEmptyView.button.setOnClickListener(new View.OnClickListener() {</span>
            @Override public void onClick(View view) {
<span class="nc" id="L1705">                setCurrentTagFromEmptyViewButton(ActionableEmptyViewButtonType.FOLLOWED);</span>
<span class="nc" id="L1706">            }</span>
        });
<span class="nc" id="L1708">    }</span>

    private boolean shouldShowEmptyViewForSelfHostedCta() {
<span class="nc bnc" id="L1711" title="All 4 branches missed.">        return isFilterableScreen() &amp;&amp; !mAccountStore.hasAccessToken() &amp;&amp; mSubFilterViewModel</span>
<span class="nc bnc" id="L1712" title="All 2 branches missed.">                .getCurrentSubfilterValue() instanceof SiteAll;</span>
    }

    private void setEmptyTitleAndDescriptionForSelfHostedCta() {
<span class="nc bnc" id="L1716" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1717">            return;</span>
        }

<span class="nc" id="L1720">        mActionableEmptyView.image.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1721">        mActionableEmptyView.title.setText(getString(R.string.reader_self_hosted_select_filter));</span>
<span class="nc" id="L1722">        mActionableEmptyView.subtitle.setVisibility(View.GONE);</span>
<span class="nc" id="L1723">        mActionableEmptyView.button.setVisibility(View.GONE);</span>
<span class="nc" id="L1724">    }</span>

    private void addBookmarkImageSpan(SpannableStringBuilder ssb, int imagePlaceholderPosition) {
<span class="nc" id="L1727">        Drawable d = ContextCompat.getDrawable(getActivity(), R.drawable.ic_bookmark_grey_dark_18dp);</span>
<span class="nc" id="L1728">        d.setBounds(0, 0, (int) (d.getIntrinsicWidth() * 1.2), (int) (d.getIntrinsicHeight() * 1.2));</span>
<span class="nc" id="L1729">        ssb.setSpan(new ImageSpan(d), imagePlaceholderPosition, imagePlaceholderPosition + 2,</span>
                Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
<span class="nc" id="L1731">    }</span>

    private void setEmptyTitleDescriptionAndButton(@NonNull String title, String description,
                                                   final ActionableEmptyViewButtonType button, boolean isSearching) {
<span class="nc bnc" id="L1735" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1736">            return;</span>
        }

<span class="nc bnc" id="L1739" title="All 4 branches missed.">        mActionableEmptyView.image.setVisibility(!isUpdating() &amp;&amp; !isSearching ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L1740">        mActionableEmptyView.title.setText(title);</span>

<span class="nc bnc" id="L1742" title="All 2 branches missed.">        if (description == null) {</span>
<span class="nc" id="L1743">            mActionableEmptyView.subtitle.setVisibility(View.GONE);</span>
        } else {
<span class="nc" id="L1745">            mActionableEmptyView.subtitle.setVisibility(View.VISIBLE);</span>

<span class="nc bnc" id="L1747" title="All 4 branches missed.">            if (description.contains(&quot;&lt;&quot;) &amp;&amp; description.contains(&quot;&gt;&quot;)) {</span>
<span class="nc" id="L1748">                mActionableEmptyView.subtitle.setText(Html.fromHtml(description));</span>
            } else {
<span class="nc" id="L1750">                mActionableEmptyView.subtitle.setText(description);</span>
            }
        }

<span class="nc bnc" id="L1754" title="All 2 branches missed.">        if (button == null) {</span>
<span class="nc" id="L1755">            mActionableEmptyView.button.setVisibility(View.GONE);</span>
        } else {
<span class="nc" id="L1757">            mActionableEmptyView.button.setVisibility(View.VISIBLE);</span>

<span class="nc bnc" id="L1759" title="All 3 branches missed.">            switch (button) {</span>
                case DISCOVER:
<span class="nc" id="L1761">                    mActionableEmptyView.button.setText(R.string.reader_empty_followed_blogs_button_discover);</span>
<span class="nc" id="L1762">                    break;</span>
                case FOLLOWED:
<span class="nc" id="L1764">                    mActionableEmptyView.button.setText(R.string.reader_empty_followed_blogs_button_followed);</span>
                    break;
            }

<span class="nc" id="L1768">            mActionableEmptyView.button.setOnClickListener(new View.OnClickListener() {</span>
                @Override public void onClick(View view) {
<span class="nc" id="L1770">                    setCurrentTagFromEmptyViewButton(button);</span>
<span class="nc" id="L1771">                }</span>
            });
        }
<span class="nc" id="L1774">    }</span>

    private void showEmptyView() {
<span class="nc bnc" id="L1777" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L1778">            mActionableEmptyView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1779">            mActionableEmptyView.announceEmptyStateForAccessibility();</span>
        }
<span class="nc" id="L1781">    }</span>

    private void hideEmptyView() {
<span class="nc bnc" id="L1784" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L1785">            mActionableEmptyView.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L1787">    }</span>

    private void setCurrentTagFromEmptyViewButton(ActionableEmptyViewButtonType button) {
<span class="nc" id="L1790">        ReaderTag tag = null;</span>

<span class="nc bnc" id="L1792" title="All 3 branches missed.">        switch (button) {</span>
            case DISCOVER:
<span class="nc" id="L1794">                tag = ReaderUtils.getTagFromEndpoint(ReaderTag.DISCOVER_PATH);</span>
<span class="nc" id="L1795">                break;</span>
            case FOLLOWED:
<span class="nc" id="L1797">                tag = ReaderUtils.getTagFromEndpoint(ReaderTag.FOLLOWING_PATH);</span>
                break;
        }
<span class="nc bnc" id="L1800" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L1801">            tag = ReaderUtils.getDefaultTag();</span>
        }

<span class="nc" id="L1804">        mViewModel.onEmptyStateButtonTapped(tag);</span>
<span class="nc" id="L1805">    }</span>

    /*
     * called by post adapter when data has been loaded
     */
<span class="nc" id="L1810">    private final ReaderInterfaces.DataLoadedListener mDataLoadedListener = new ReaderInterfaces.DataLoadedListener() {</span>
        @Override
        public void onDataLoaded(boolean isEmpty) {
<span class="nc bnc" id="L1813" title="All 2 branches missed.">            if (!isAdded()) {</span>
<span class="nc" id="L1814">                return;</span>
            }
<span class="nc bnc" id="L1816" title="All 2 branches missed.">            if (isEmpty) {</span>
<span class="nc bnc" id="L1817" title="All 2 branches missed.">                if (getPostListType() != ReaderPostListType.SEARCH_RESULTS</span>
<span class="nc bnc" id="L1818" title="All 4 branches missed.">                    || getSearchTabsPosition() == TAB_SITES &amp;&amp; getSiteSearchAdapter().isEmpty()</span>
<span class="nc bnc" id="L1819" title="All 4 branches missed.">                    || getSearchTabsPosition() == TAB_POSTS &amp;&amp; getPostAdapter().isEmpty()) {</span>
<span class="nc" id="L1820">                    setEmptyTitleDescriptionAndButton(false);</span>
<span class="nc" id="L1821">                    showEmptyView();</span>
                }
            } else {
<span class="nc" id="L1824">                hideEmptyView();</span>
<span class="nc" id="L1825">                announceListStateForAccessibility();</span>
<span class="nc bnc" id="L1826" title="All 2 branches missed.">                if (mRestorePosition &gt; 0) {</span>
<span class="nc" id="L1827">                    AppLog.d(T.READER, &quot;reader post list &gt; restoring position&quot;);</span>
<span class="nc" id="L1828">                    mRecyclerView.scrollRecycleViewToPosition(mRestorePosition);</span>
                }
<span class="nc bnc" id="L1830" title="All 4 branches missed.">                if (getPostListType() == ReaderPostListType.SEARCH_RESULTS &amp;&amp; !isSearchTabsShowing()) {</span>
<span class="nc" id="L1831">                    showSearchTabs();</span>
                }
            }
<span class="nc" id="L1834">            mRestorePosition = 0;</span>
<span class="nc" id="L1835">        }</span>
    };

    private void announceListStateForAccessibility() {
<span class="nc bnc" id="L1839" title="All 2 branches missed.">        if (getView() != null) {</span>
<span class="nc" id="L1840">            getView().announceForAccessibility(getString(R.string.reader_acessibility_list_loaded,</span>
<span class="nc" id="L1841">                    getPostAdapter().getItemCount()));</span>
        }
<span class="nc" id="L1843">    }</span>

    private void showBookmarksSavedLocallyDialog(ShowBookmarkedSavedOnlyLocallyDialog holder) {
<span class="nc" id="L1846">        mBookmarksSavedLocallyDialog = new MaterialAlertDialogBuilder(requireActivity())</span>
<span class="nc" id="L1847">                .setTitle(getString(holder.getTitle()))</span>
<span class="nc" id="L1848">                .setMessage(getString(holder.getMessage()))</span>
<span class="nc" id="L1849">                .setPositiveButton(holder.getButtonLabel(), (dialog, which) -&gt; holder.getOkButtonAction().invoke())</span>
<span class="nc" id="L1850">                .setCancelable(false)</span>
<span class="nc" id="L1851">                .create();</span>
<span class="nc" id="L1852">        mBookmarksSavedLocallyDialog.show();</span>
<span class="nc" id="L1853">    }</span>

    private boolean isBookmarksList() {
<span class="nc bnc" id="L1856" title="All 4 branches missed.">        return getPostListType() == ReaderPostListType.TAG_FOLLOWED</span>
<span class="nc bnc" id="L1857" title="All 2 branches missed.">               &amp;&amp; (mCurrentTag != null &amp;&amp; mCurrentTag.isBookmarked());</span>
    }

    /*
     * called by post adapter to load older posts when user scrolls to the last post
     */
<span class="nc" id="L1863">    private final ReaderActions.DataRequestedListener mDataRequestedListener =</span>
<span class="nc" id="L1864">            new ReaderActions.DataRequestedListener() {</span>
                @Override
                public void onRequestData() {
                    // skip if update is already in progress
<span class="nc bnc" id="L1868" title="All 2 branches missed.">                    if (isUpdating()) {</span>
<span class="nc" id="L1869">                        return;</span>
                    }

                    // request older posts unless we already have the max # to show
<span class="nc bnc" id="L1873" title="All 4 branches missed.">                    switch (getPostListType()) {</span>
                        case TAG_FOLLOWED:
                            // fall through to TAG_PREVIEW
                        case TAG_PREVIEW:
<span class="nc bnc" id="L1877" title="All 2 branches missed.">                            if (ReaderPostTable.getNumPostsWithTag(mCurrentTag)</span>
                                &lt; ReaderConstants.READER_MAX_POSTS_TO_DISPLAY) {
                                // request older posts
<span class="nc" id="L1880">                                updatePostsWithTag(getCurrentTag(), UpdateAction.REQUEST_OLDER);</span>
<span class="nc" id="L1881">                                mReaderTracker.track(AnalyticsTracker.Stat.READER_INFINITE_SCROLL);</span>
                            }
                            break;

                        case BLOG_PREVIEW:
                            int numPosts;
<span class="nc bnc" id="L1887" title="All 2 branches missed.">                            if (mCurrentFeedId != 0) {</span>
<span class="nc" id="L1888">                                numPosts = ReaderPostTable.getNumPostsInFeed(mCurrentFeedId);</span>
                            } else {
<span class="nc" id="L1890">                                numPosts = ReaderPostTable.getNumPostsInBlog(mCurrentBlogId);</span>
                            }
<span class="nc bnc" id="L1892" title="All 2 branches missed.">                            if (numPosts &lt; ReaderConstants.READER_MAX_POSTS_TO_DISPLAY) {</span>
<span class="nc" id="L1893">                                updatePostsInCurrentBlogOrFeed(UpdateAction.REQUEST_OLDER);</span>
<span class="nc" id="L1894">                                mReaderTracker.track(AnalyticsTracker.Stat.READER_INFINITE_SCROLL);</span>
                            }
                            break;

                        case SEARCH_RESULTS:
<span class="nc" id="L1899">                            ReaderTag searchTag = ReaderUtils.getTagForSearchQuery(mCurrentSearchQuery);</span>
<span class="nc" id="L1900">                            int offset = ReaderPostTable.getNumPostsWithTag(searchTag);</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">                            if (offset &lt; ReaderConstants.READER_MAX_POSTS_TO_DISPLAY) {</span>
<span class="nc" id="L1902">                                updatePostsInCurrentSearch(offset);</span>
<span class="nc" id="L1903">                                mReaderTracker.track(AnalyticsTracker.Stat.READER_INFINITE_SCROLL);</span>
                            }
                            break;
                    }
<span class="nc" id="L1907">                }</span>
            };

    private ReaderPostAdapter getPostAdapter() {
<span class="nc bnc" id="L1911" title="All 2 branches missed.">        if (mPostAdapter == null) {</span>
<span class="nc" id="L1912">            AppLog.d(T.READER, &quot;reader post list &gt; creating post adapter&quot;);</span>
<span class="nc" id="L1913">            Context context = WPActivityUtils.getThemedContext(getActivity());</span>
<span class="nc" id="L1914">            mPostAdapter = new ReaderPostAdapter(</span>
                    context,
<span class="nc" id="L1916">                    getPostListType(),</span>
                    mImageManager,
                    mUiHelpers,
                    mIsTopLevel
            );
<span class="nc" id="L1921">            mPostAdapter.setOnFollowListener(this);</span>
<span class="nc" id="L1922">            mPostAdapter.setOnPostSelectedListener(this);</span>
<span class="nc" id="L1923">            mPostAdapter.setOnPostListItemButtonListener(this);</span>
<span class="nc" id="L1924">            mPostAdapter.setOnDataLoadedListener(mDataLoadedListener);</span>
<span class="nc" id="L1925">            mPostAdapter.setOnDataRequestedListener(mDataRequestedListener);</span>
<span class="nc bnc" id="L1926" title="All 2 branches missed.">            if (getActivity() instanceof ReaderSiteHeaderView.OnBlogInfoLoadedListener) {</span>
<span class="nc" id="L1927">                mPostAdapter.setOnBlogInfoLoadedListener((ReaderSiteHeaderView.OnBlogInfoLoadedListener) getActivity());</span>
            }
<span class="nc bnc" id="L1929" title="All 2 branches missed.">            if (getPostListType().isTagType()) {</span>
<span class="nc" id="L1930">                mPostAdapter.setCurrentTag(getCurrentTag());</span>
<span class="nc bnc" id="L1931" title="All 2 branches missed.">            } else if (getPostListType() == ReaderPostListType.BLOG_PREVIEW) {</span>
<span class="nc" id="L1932">                mPostAdapter.setCurrentBlogAndFeed(mCurrentBlogId, mCurrentFeedId);</span>
<span class="nc bnc" id="L1933" title="All 2 branches missed.">            } else if (getPostListType() == ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L1934">                ReaderTag searchTag = ReaderUtils.getTagForSearchQuery(mCurrentSearchQuery);</span>
<span class="nc" id="L1935">                mPostAdapter.setCurrentTag(searchTag);</span>
            }
        }
<span class="nc" id="L1938">        return mPostAdapter;</span>
    }

    private ReaderSiteSearchAdapter getSiteSearchAdapter() {
<span class="nc bnc" id="L1942" title="All 2 branches missed.">        if (mSiteSearchAdapter == null) {</span>
<span class="nc" id="L1943">            mSiteSearchAdapter = new ReaderSiteSearchAdapter(new SiteSearchAdapterListener() {</span>
                @Override
                public void onSiteClicked(@NonNull ReaderSiteModel site) {
<span class="nc" id="L1946">                    mLastTappedSiteSearchResult = site;</span>
<span class="nc" id="L1947">                    ReaderActivityLauncher.showReaderBlogOrFeedPreview(</span>
<span class="nc" id="L1948">                            getActivity(),</span>
<span class="nc" id="L1949">                            site.getSiteId(),</span>
<span class="nc" id="L1950">                            site.getFeedId(),</span>
<span class="nc" id="L1951">                            site.isFollowing(),</span>
<span class="nc" id="L1952">                            mPostAdapter.getSource(),</span>
                            mReaderTracker
                    );
<span class="nc" id="L1955">                }</span>

                @Override
                public void onLoadMore(int offset) {
<span class="nc" id="L1959">                    showLoadingProgress(true);</span>
<span class="nc" id="L1960">                    updateSitesInCurrentSearch(offset);</span>
<span class="nc" id="L1961">                }</span>
            });
        }
<span class="nc" id="L1964">        return mSiteSearchAdapter;</span>
    }

    private boolean hasPostAdapter() {
<span class="nc bnc" id="L1968" title="All 2 branches missed.">        return (mPostAdapter != null);</span>
    }

    private boolean isPostAdapterEmpty() {
<span class="nc bnc" id="L1972" title="All 4 branches missed.">        return (mPostAdapter == null || mPostAdapter.isEmpty());</span>
    }

    private boolean isCurrentTag(final ReaderTag tag) {
<span class="nc" id="L1976">        return ReaderTag.isSameTag(tag, mCurrentTag);</span>
    }

    private boolean isCurrentTagName(String tagName) {
<span class="nc bnc" id="L1980" title="All 4 branches missed.">        return (tagName != null &amp;&amp; tagName.equalsIgnoreCase(getCurrentTagName()));</span>
    }

    private ReaderTag getCurrentTag() {
<span class="nc" id="L1984">        return mCurrentTag;</span>
    }

    private String getCurrentTagName() {
<span class="nc bnc" id="L1988" title="All 2 branches missed.">        return (mCurrentTag != null ? mCurrentTag.getTagSlug() : &quot;&quot;);</span>
    }

    private boolean hasCurrentTag() {
<span class="nc bnc" id="L1992" title="All 2 branches missed.">        return mCurrentTag != null;</span>
    }

    private void setCurrentTag(final ReaderTag tag) {
<span class="nc bnc" id="L1996" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L1997">            return;</span>
        }

        // skip if this is already the current tag and the post adapter is already showing it
<span class="nc bnc" id="L2001" title="All 2 branches missed.">        if (isCurrentTag(tag)</span>
<span class="nc bnc" id="L2002" title="All 2 branches missed.">            &amp;&amp; hasPostAdapter()</span>
<span class="nc bnc" id="L2003" title="All 2 branches missed.">            &amp;&amp; getPostAdapter().isCurrentTag(tag)) {</span>
<span class="nc" id="L2004">            return;</span>
        }

<span class="nc" id="L2007">        mCurrentTag = tag;</span>

<span class="nc bnc" id="L2009" title="All 2 branches missed.">        if (isFilterableScreen()) {</span>
<span class="nc bnc" id="L2010" title="All 4 branches missed.">            if (isFilterableTag(mCurrentTag) || mCurrentTag.isDefaultInMemoryTag()) {</span>
<span class="nc" id="L2011">                mSubFilterViewModel.onSubfilterReselected();</span>
            } else {
<span class="nc" id="L2013">                changeReaderMode(new ReaderModeInfo(</span>
                                tag,
                                ReaderPostListType.TAG_FOLLOWED,
                                0,
                                0,
                                false,
                                null,
                                false,
<span class="nc bnc" id="L2021" title="All 2 branches missed.">                                mRemoveFilterButton.getVisibility() == View.VISIBLE),</span>
                        false
                );
            }
        }

        ReaderTag validTag;

<span class="nc" id="L2029">        validTag = ReaderUtils.getValidTagForSharedPrefs(</span>
                tag,
                mIsTopLevel,
                mRecyclerView,
<span class="nc" id="L2033">                ReaderUtils.getDefaultTagFromDbOrCreateInMemory(</span>
<span class="nc" id="L2034">                        requireActivity(),</span>
                        mTagUpdateClientUtilsProvider
                )
        );

<span class="nc bnc" id="L2039" title="All 4 branches missed.">        switch (getPostListType()) {</span>
            case TAG_FOLLOWED:
                // remember this as the current tag if viewing followed tag
<span class="nc" id="L2042">                AppPrefs.setReaderTag(validTag);</span>

<span class="nc" id="L2044">                break;</span>
            case TAG_PREVIEW:
<span class="nc" id="L2046">                mTagPreviewHistory.push(tag.getTagSlug());</span>
<span class="nc" id="L2047">                break;</span>
            case BLOG_PREVIEW:
<span class="nc bnc" id="L2049" title="All 2 branches missed.">                if (mIsTopLevel) {</span>
<span class="nc" id="L2050">                    AppPrefs.setReaderTag(validTag);</span>
                }
                // noop
                break;
            case SEARCH_RESULTS:
                // noop
                break;
        }

<span class="nc" id="L2059">        getPostAdapter().setCurrentTag(mCurrentTag);</span>
<span class="nc" id="L2060">        hideNewPostsBar();</span>
<span class="nc" id="L2061">        showLoadingProgress(false);</span>
<span class="nc" id="L2062">        updateCurrentTagIfTime();</span>
<span class="nc" id="L2063">    }</span>

    @Override
    public View getScrollableViewForUniqueIdProvision() {
<span class="nc" id="L2067">        return mRecyclerView.getInternalRecyclerView();</span>
    }

    /*
     * called by the activity when user hits the back button - returns true if the back button
     * is handled here and should be ignored by the activity
     */
    @Override
    public boolean onActivityBackPressed() {
<span class="nc bnc" id="L2076" title="All 2 branches missed.">        if (isSearchViewExpanded()) {</span>
<span class="nc" id="L2077">            mSearchMenuItem.collapseActionView();</span>
<span class="nc" id="L2078">            return true;</span>
        } else {
<span class="nc" id="L2080">            return goBackInTagHistory();</span>
        }
    }

    /*
     * when previewing posts with a specific tag, a history of previewed tags is retained so
     * the user can navigate back through them - this is faster and requires less memory
     * than creating a new fragment for each previewed tag
     */
    private boolean goBackInTagHistory() {
<span class="nc bnc" id="L2090" title="All 2 branches missed.">        if (mTagPreviewHistory.empty()) {</span>
<span class="nc" id="L2091">            return false;</span>
        }

<span class="nc" id="L2094">        String tagName = mTagPreviewHistory.pop();</span>
<span class="nc bnc" id="L2095" title="All 2 branches missed.">        if (isCurrentTagName(tagName)) {</span>
<span class="nc bnc" id="L2096" title="All 2 branches missed.">            if (mTagPreviewHistory.empty()) {</span>
<span class="nc" id="L2097">                return false;</span>
            }
<span class="nc" id="L2099">            tagName = mTagPreviewHistory.pop();</span>
        }

<span class="nc" id="L2102">        ReaderTag newTag = ReaderUtils.getTagFromTagName(tagName, ReaderTagType.FOLLOWED);</span>
<span class="nc" id="L2103">        setCurrentTag(newTag);</span>

<span class="nc" id="L2105">        return true;</span>
    }

    /*
     * refresh adapter so latest posts appear
     */
    private void refreshPosts() {
<span class="nc" id="L2112">        hideNewPostsBar();</span>
<span class="nc bnc" id="L2113" title="All 2 branches missed.">        if (hasPostAdapter()) {</span>
<span class="nc" id="L2114">            getPostAdapter().refresh();</span>
        }
<span class="nc" id="L2116">    }</span>

    /*
     * same as above but clears posts before refreshing
     */
    private void reloadPosts() {
<span class="nc" id="L2122">        hideNewPostsBar();</span>
<span class="nc bnc" id="L2123" title="All 2 branches missed.">        if (hasPostAdapter()) {</span>
<span class="nc" id="L2124">            getPostAdapter().reload();</span>
        }
<span class="nc" id="L2126">    }</span>

    /*
     * reload the list of tags for the dropdown filter
     */
    private void reloadTags() {
<span class="nc bnc" id="L2132" title="All 4 branches missed.">        if (isAdded() &amp;&amp; mRecyclerView != null) {</span>
<span class="nc" id="L2133">            mRecyclerView.refreshFilterCriteriaOptions();</span>
        }
<span class="nc" id="L2135">    }</span>

    /*
     * get posts for the current blog from the server
     */
    private void updatePostsInCurrentBlogOrFeed(final UpdateAction updateAction) {
<span class="nc bnc" id="L2141" title="All 2 branches missed.">        if (!NetworkUtils.isNetworkAvailable(getActivity())) {</span>
<span class="nc" id="L2142">            AppLog.i(T.READER, &quot;reader post list &gt; network unavailable, canceled blog update&quot;);</span>
<span class="nc" id="L2143">            return;</span>
        }
<span class="nc bnc" id="L2145" title="All 2 branches missed.">        if (mCurrentFeedId != 0) {</span>
<span class="nc" id="L2146">            ReaderPostServiceStarter.startServiceForFeed(getActivity(), mCurrentFeedId, updateAction);</span>
        } else {
<span class="nc" id="L2148">            ReaderPostServiceStarter.startServiceForBlog(getActivity(), mCurrentBlogId, updateAction);</span>
        }
<span class="nc" id="L2150">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ReaderEvents.UpdatePostsStarted event) {
<span class="nc bnc" id="L2155" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L2156">            return;</span>
        }
        // check if the event is related to this instance of the ReaderPostListFragment
<span class="nc bnc" id="L2159" title="All 4 branches missed.">        if (event.getReaderTag() != null &amp;&amp; !isCurrentTag(event.getReaderTag())) {</span>
<span class="nc" id="L2160">            return;</span>
        }
<span class="nc" id="L2162">        setIsUpdating(true, event.getAction());</span>
<span class="nc" id="L2163">        setEmptyTitleDescriptionAndButton(false);</span>
<span class="nc" id="L2164">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ReaderEvents.UpdatePostsEnded event) {
<span class="nc bnc" id="L2169" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L2170">            return;</span>
        }
        // check if the event is related to this instance of the ReaderPostListFragment
<span class="nc bnc" id="L2173" title="All 4 branches missed.">        if (event.getReaderTag() != null &amp;&amp; !isCurrentTag(event.getReaderTag())) {</span>
<span class="nc" id="L2174">            return;</span>
        }
<span class="nc" id="L2176">        setIsUpdating(false, event.getAction());</span>

        // don't show new posts if user is searching - posts will automatically
        // appear when search is exited
<span class="nc bnc" id="L2180" title="All 2 branches missed.">        if (isSearchViewExpanded()</span>
<span class="nc bnc" id="L2181" title="All 2 branches missed.">            || getPostListType() == ReaderPostListType.SEARCH_RESULTS) {</span>
<span class="nc" id="L2182">            return;</span>
        }

        // determine whether to show the &quot;new posts&quot; bar - when this is shown, the newly
        // downloaded posts aren't displayed until the user taps the bar - only appears
        // when there are new posts in a followed tag and the user has scrolled the list
        // beyond the first post
<span class="nc bnc" id="L2189" title="All 2 branches missed.">        if (event.getResult() == ReaderActions.UpdateResult.HAS_NEW</span>
<span class="nc bnc" id="L2190" title="All 2 branches missed.">            &amp;&amp; event.getAction() == UpdateAction.REQUEST_NEWER</span>
<span class="nc bnc" id="L2191" title="All 2 branches missed.">            &amp;&amp; getPostListType() == ReaderPostListType.TAG_FOLLOWED</span>
<span class="nc bnc" id="L2192" title="All 2 branches missed.">            &amp;&amp; !isPostAdapterEmpty()</span>
<span class="nc bnc" id="L2193" title="All 4 branches missed.">            &amp;&amp; (!isAdded() || !mRecyclerView.isFirstItemVisible())) {</span>
<span class="nc" id="L2194">            showNewPostsBar();</span>
<span class="nc bnc" id="L2195" title="All 2 branches missed.">        } else if (event.getResult().isNewOrChanged()</span>
<span class="nc bnc" id="L2196" title="All 2 branches missed.">                   || event.getAction() == UpdateAction.REQUEST_REFRESH) {</span>
<span class="nc" id="L2197">            refreshPosts();</span>
        } else {
<span class="nc bnc" id="L2199" title="All 2 branches missed.">            boolean requestFailed = (event.getResult() == ReaderActions.UpdateResult.FAILED);</span>
<span class="nc" id="L2200">            setEmptyTitleDescriptionAndButton(requestFailed);</span>
            // if we requested posts in order to fill a gap but the request failed or didn't
            // return any posts, reload the adapter so the gap marker is reset (hiding its
            // progress bar)
<span class="nc bnc" id="L2204" title="All 2 branches missed.">            if (event.getAction() == UpdateAction.REQUEST_OLDER_THAN_GAP) {</span>
<span class="nc" id="L2205">                reloadPosts();</span>
            }
        }
<span class="nc" id="L2208">    }</span>

    /*
     * get latest posts for this tag from the server
     */
    private void updatePostsWithTag(ReaderTag tag, UpdateAction updateAction) {
<span class="nc bnc" id="L2214" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L2215">            return;</span>
        }

<span class="nc bnc" id="L2218" title="All 2 branches missed.">        if (!NetworkUtils.isNetworkAvailable(getActivity())) {</span>
<span class="nc" id="L2219">            AppLog.i(T.READER, &quot;reader post list &gt; network unavailable, canceled tag update&quot;);</span>
<span class="nc" id="L2220">            return;</span>
        }
<span class="nc bnc" id="L2222" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L2223">            AppLog.w(T.READER, &quot;null tag passed to updatePostsWithTag&quot;);</span>
<span class="nc" id="L2224">            return;</span>
        }
<span class="nc" id="L2226">        AppLog.d(T.READER,</span>
<span class="nc" id="L2227">                &quot;reader post list &gt; updating tag &quot; + tag.getTagNameForLog() + &quot;, updateAction=&quot; + updateAction.name());</span>
<span class="nc" id="L2228">        ReaderPostServiceStarter.startServiceForTag(getActivity(), tag, updateAction);</span>
<span class="nc" id="L2229">    }</span>

    private void updateCurrentTag() {
<span class="nc" id="L2232">        updatePostsWithTag(getCurrentTag(), UpdateAction.REQUEST_NEWER);</span>
<span class="nc" id="L2233">    }</span>

    /*
     * update the current tag if it's time to do so - note that the check is done in the
     * background since it can be expensive and this is called when the fragment is
     * resumed, which on slower devices can result in a janky experience
     */
    private void updateCurrentTagIfTime() {
<span class="nc bnc" id="L2241" title="All 4 branches missed.">        if (!isAdded() || !hasCurrentTag()) {</span>
<span class="nc" id="L2242">            return;</span>
        }
<span class="nc" id="L2244">        new Thread() {</span>
            @Override
            public void run() {
<span class="nc bnc" id="L2247" title="All 4 branches missed.">                if (ReaderTagTable.shouldAutoUpdateTag(getCurrentTag()) &amp;&amp; isAdded()) {</span>
<span class="nc" id="L2248">                    getActivity().runOnUiThread(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L2251">                            updateCurrentTag();</span>
<span class="nc" id="L2252">                        }</span>
                    });
                }
<span class="nc" id="L2255">            }</span>
<span class="nc" id="L2256">        }.start();</span>
<span class="nc" id="L2257">    }</span>

    private boolean isUpdating() {
<span class="nc" id="L2260">        return mIsUpdating;</span>
    }

    /*
     * show/hide progress bar which appears at the bottom of the activity when loading more posts
     */
    private void showLoadingProgress(boolean showProgress) {
<span class="nc bnc" id="L2267" title="All 4 branches missed.">        if (isAdded() &amp;&amp; mProgress != null) {</span>
<span class="nc bnc" id="L2268" title="All 2 branches missed.">            if (showProgress) {</span>
<span class="nc" id="L2269">                mProgress.bringToFront();</span>
<span class="nc" id="L2270">                mProgress.setVisibility(View.VISIBLE);</span>
            } else {
<span class="nc" id="L2272">                mProgress.setVisibility(View.GONE);</span>
            }
        }
<span class="nc" id="L2275">    }</span>

    private void setIsUpdating(boolean isUpdating, UpdateAction updateAction) {
<span class="nc bnc" id="L2278" title="All 4 branches missed.">        if (!isAdded() || mIsUpdating == isUpdating) {</span>
<span class="nc" id="L2279">            return;</span>
        }

<span class="nc bnc" id="L2282" title="All 2 branches missed.">        if (updateAction == UpdateAction.REQUEST_OLDER) {</span>
            // show/hide progress bar at bottom if these are older posts
<span class="nc" id="L2284">            showLoadingProgress(isUpdating);</span>
<span class="nc bnc" id="L2285" title="All 4 branches missed.">        } else if (isUpdating &amp;&amp; isPostAdapterEmpty()) {</span>
            // show swipe-to-refresh if update started and no posts are showing
<span class="nc" id="L2287">            mRecyclerView.setRefreshing(true);</span>
<span class="nc bnc" id="L2288" title="All 2 branches missed.">        } else if (!isUpdating) {</span>
            // hide swipe-to-refresh progress if update is complete
<span class="nc" id="L2290">            mRecyclerView.setRefreshing(false);</span>
        }
<span class="nc" id="L2292">        mIsUpdating = isUpdating;</span>

        // if swipe-to-refresh isn't active, keep it disabled during an update - this prevents
        // doing a refresh while another update is already in progress
<span class="nc bnc" id="L2296" title="All 4 branches missed.">        if (mRecyclerView != null &amp;&amp; !mRecyclerView.isRefreshing()) {</span>
<span class="nc bnc" id="L2297" title="All 4 branches missed.">            mRecyclerView.setSwipeToRefreshEnabled(!isUpdating &amp;&amp; isSwipeToRefreshSupported());</span>
        }
<span class="nc" id="L2299">    }</span>

    /*
     * swipe-to-refresh isn't supported for search results since they're really brief snapshots
     * and are unlikely to show new posts due to the way they're sorted
     */
    private boolean isSwipeToRefreshSupported() {
<span class="nc bnc" id="L2306" title="All 2 branches missed.">        return getPostListType() != ReaderPostListType.SEARCH_RESULTS;</span>
    }

    /*
     * bar that appears at the top when new posts have been retrieved
     */
    private boolean isNewPostsBarShowing() {
<span class="nc bnc" id="L2313" title="All 4 branches missed.">        return (mNewPostsBar != null &amp;&amp; mNewPostsBar.getVisibility() == View.VISIBLE);</span>
    }

    /*
     * scroll listener assigned to the recycler when the &quot;new posts&quot; bar is shown to hide
     * it upon scrolling
     */
<span class="nc" id="L2320">    private final RecyclerView.OnScrollListener mOnScrollListener = new RecyclerView.OnScrollListener() {</span>
        @Override
        public void onScrolled(@NonNull RecyclerView recyclerView, int dx, int dy) {
<span class="nc" id="L2323">            super.onScrolled(recyclerView, dx, dy);</span>
<span class="nc" id="L2324">            hideNewPostsBar();</span>
<span class="nc" id="L2325">        }</span>
    };

    private void showNewPostsBar() {
<span class="nc bnc" id="L2329" title="All 4 branches missed.">        if (!isAdded() || isNewPostsBarShowing()) {</span>
<span class="nc" id="L2330">            return;</span>
        }

<span class="nc" id="L2333">        AniUtils.startAnimation(mNewPostsBar, R.anim.reader_top_bar_in);</span>
<span class="nc" id="L2334">        mNewPostsBar.setVisibility(View.VISIBLE);</span>

        // assign the scroll listener to hide the bar when the recycler is scrolled, but don't assign
        // it right away since the user may be scrolling when the bar appears (which would cause it
        // to disappear as soon as it's displayed)
<span class="nc" id="L2339">        mRecyclerView.postDelayed(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc bnc" id="L2342" title="All 4 branches missed.">                if (isAdded() &amp;&amp; isNewPostsBarShowing()) {</span>
<span class="nc" id="L2343">                    mRecyclerView.addOnScrollListener(mOnScrollListener);</span>
                }
<span class="nc" id="L2345">            }</span>
        }, 1000L);

        // remove the gap marker if it's showing, since it's no longer valid
<span class="nc" id="L2349">        getPostAdapter().removeGapMarker();</span>
<span class="nc" id="L2350">    }</span>

    private void hideNewPostsBar() {
<span class="nc bnc" id="L2353" title="All 6 branches missed.">        if (!isAdded() || !isNewPostsBarShowing() || mIsAnimatingOutNewPostsBar) {</span>
<span class="nc" id="L2354">            return;</span>
        }

<span class="nc" id="L2357">        mIsAnimatingOutNewPostsBar = true;</span>

        // remove the onScrollListener assigned in showNewPostsBar()
<span class="nc" id="L2360">        mRecyclerView.removeOnScrollListener(mOnScrollListener);</span>

<span class="nc" id="L2362">        Animation.AnimationListener listener = new Animation.AnimationListener() {</span>
            @Override
            public void onAnimationStart(Animation animation) {
<span class="nc" id="L2365">            }</span>

            @Override
            public void onAnimationEnd(Animation animation) {
<span class="nc bnc" id="L2369" title="All 2 branches missed.">                if (isAdded()) {</span>
<span class="nc" id="L2370">                    mNewPostsBar.setVisibility(View.GONE);</span>
<span class="nc" id="L2371">                    mIsAnimatingOutNewPostsBar = false;</span>
                }
<span class="nc" id="L2373">            }</span>

            @Override
            public void onAnimationRepeat(Animation animation) {
<span class="nc" id="L2377">            }</span>
        };
<span class="nc" id="L2379">        AniUtils.startAnimation(mNewPostsBar, R.anim.reader_top_bar_out, listener);</span>
<span class="nc" id="L2380">    }</span>

    /*
     * are we showing all posts with a specific tag (followed or previewed), or all
     * posts in a specific blog?
     */
    private ReaderPostListType getPostListType() {
<span class="nc bnc" id="L2387" title="All 2 branches missed.">        return (mPostListType != null ? mPostListType : ReaderTypes.DEFAULT_POST_LIST_TYPE);</span>
    }

    /*
     * called from adapter when user taps a post
     */
    @Override
    public void onPostSelected(ReaderPost post) {
<span class="nc bnc" id="L2395" title="All 4 branches missed.">        if (!isAdded() || post == null) {</span>
<span class="nc" id="L2396">            return;</span>
        }

<span class="nc" id="L2399">        AppRatingDialog.INSTANCE.incrementInteractions(</span>
                AnalyticsTracker.Stat.APP_REVIEWS_EVENT_INCREMENTED_BY_OPENING_READER_POST
        );

<span class="nc bnc" id="L2403" title="All 2 branches missed.">        if (post.isBookmarked) {</span>
<span class="nc bnc" id="L2404" title="All 2 branches missed.">            if (isBookmarksList()) {</span>
<span class="nc" id="L2405">                mReaderTracker.trackBlog(</span>
                        AnalyticsTracker.Stat.READER_SAVED_POST_OPENED_FROM_SAVED_POST_LIST,
                        post.blogId,
                        post.feedId,
<span class="nc" id="L2409">                        post.isFollowedByCurrentUser,</span>
<span class="nc" id="L2410">                        mPostAdapter.getSource()</span>
                );
            } else {
<span class="nc" id="L2413">                mReaderTracker.trackBlog(</span>
                        AnalyticsTracker.Stat.READER_SAVED_POST_OPENED_FROM_OTHER_POST_LIST,
                        post.blogId,
                        post.feedId,
<span class="nc" id="L2417">                        post.isFollowedByCurrentUser,</span>
<span class="nc" id="L2418">                        mPostAdapter.getSource()</span>
                );
            }
        }

        // &quot;discover&quot; posts that highlight another post should open the original (source) post when tapped
<span class="nc bnc" id="L2424" title="All 2 branches missed.">        if (post.isDiscoverPost()) {</span>
<span class="nc" id="L2425">            ReaderPostDiscoverData discoverData = post.getDiscoverData();</span>
<span class="nc bnc" id="L2426" title="All 2 branches missed.">            if (discoverData != null</span>
<span class="nc bnc" id="L2427" title="All 2 branches missed.">                &amp;&amp; discoverData.getDiscoverType() == ReaderPostDiscoverData.DiscoverType.EDITOR_PICK) {</span>
<span class="nc bnc" id="L2428" title="All 4 branches missed.">                if (discoverData.getBlogId() != 0 &amp;&amp; discoverData.getPostId() != 0) {</span>
<span class="nc" id="L2429">                    ReaderActivityLauncher.showReaderPostDetail(</span>
<span class="nc" id="L2430">                            getActivity(),</span>
<span class="nc" id="L2431">                            discoverData.getBlogId(),</span>
<span class="nc" id="L2432">                            discoverData.getPostId());</span>
<span class="nc" id="L2433">                    return;</span>
<span class="nc bnc" id="L2434" title="All 2 branches missed.">                } else if (discoverData.hasPermalink()) {</span>
<span class="nc bnc" id="L2435" title="All 2 branches missed.">                    if (mSeenUnseenWithCounterFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L2436">                        mViewModel.onExternalPostOpened(post);</span>
                    }
                    // if we don't have a blogId/postId, we sadly resort to showing the post
                    // in a WebView activity - this will happen for non-JP self-hosted
<span class="nc" id="L2440">                    ReaderActivityLauncher.openUrl(getActivity(), discoverData.getPermaLink());</span>
<span class="nc" id="L2441">                    return;</span>
                }
            }
        }

        // if this is a cross-post, we want to show the original post
<span class="nc bnc" id="L2447" title="All 2 branches missed.">        if (post.isXpost()) {</span>
<span class="nc" id="L2448">            ReaderActivityLauncher.showReaderPostDetail(getActivity(), post.xpostBlogId, post.xpostPostId);</span>
<span class="nc" id="L2449">            return;</span>
        }

<span class="nc" id="L2452">        ReaderPostListType type = getPostListType();</span>

<span class="nc bnc" id="L2454" title="All 4 branches missed.">        switch (type) {</span>
            case TAG_FOLLOWED:
                // fall through to the TAG_PREVIEW
            case TAG_PREVIEW:
<span class="nc" id="L2458">                ReaderActivityLauncher.showReaderPostPagerForTag(</span>
<span class="nc" id="L2459">                        getActivity(),</span>
<span class="nc" id="L2460">                        getCurrentTag(),</span>
<span class="nc" id="L2461">                        getPostListType(),</span>
                        post.blogId,
                        post.postId);
<span class="nc" id="L2464">                break;</span>
            case BLOG_PREVIEW:
<span class="nc" id="L2466">                ReaderActivityLauncher.showReaderPostPagerForBlog(</span>
<span class="nc" id="L2467">                        getActivity(),</span>
                        post.blogId,
                        post.postId);
<span class="nc" id="L2470">                break;</span>
            case SEARCH_RESULTS:
<span class="nc" id="L2472">                mReaderTracker.trackPost(AnalyticsTracker.Stat.READER_SEARCH_RESULT_TAPPED, post);</span>
<span class="nc" id="L2473">                ReaderActivityLauncher.showReaderPostDetail(getActivity(), post.blogId, post.postId);</span>
                break;
        }
<span class="nc" id="L2476">    }</span>

    /*
     * called when user selects a tag from the tag toolbar
     */
    private void onTagChanged(@NonNull ReaderTag tag) {
<span class="nc bnc" id="L2482" title="All 4 branches missed.">        if (!isAdded() || isCurrentTag(tag)) {</span>
<span class="nc" id="L2483">            return;</span>
        }
        // clear 'post removed from saved posts' undo items
<span class="nc bnc" id="L2486" title="All 2 branches missed.">        if (getPostListType() == ReaderPostListType.TAG_FOLLOWED) {</span>
<span class="nc" id="L2487">            ReaderPostTable.purgeUnbookmarkedPostsWithBookmarkTag();</span>
        }

<span class="nc" id="L2490">        trackTagLoaded(tag);</span>
<span class="nc" id="L2491">        AppLog.d(T.READER, String.format(&quot;reader post list &gt; tag %s displayed&quot;, tag.getTagNameForLog()));</span>
<span class="nc" id="L2492">        setCurrentTag(tag);</span>
<span class="nc" id="L2493">    }</span>

    /**
     * WARNING: Do not replace the static reader tracker with the corresponding instance reader tracker
     * as this will result into a {@link NullPointerException} crash on specific scenarios.
     * &lt;p&gt;
     * This is because this method is also being triggered through the static
     * {@link ReaderPostListFragment#newInstanceForTag} method, which means that the
     * {@link ReaderPostListFragment#mReaderTracker} field instance will not be yet available, and
     * as thus cannot be used, or else it will result in a {@link NullPointerException}.
     */
    private void trackTagLoaded(@Nullable ReaderTag tag) {
<span class="nc bnc" id="L2505" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L2506">            return;</span>
        }

        AnalyticsTracker.Stat stat;
<span class="nc bnc" id="L2510" title="All 2 branches missed.">        if (tag.isTagTopic()) {</span>
<span class="nc" id="L2511">            stat = AnalyticsTracker.Stat.READER_TAG_LOADED;</span>
<span class="nc bnc" id="L2512" title="All 2 branches missed.">        } else if (tag.isListTopic()) {</span>
<span class="nc" id="L2513">            stat = AnalyticsTracker.Stat.READER_LIST_LOADED;</span>
        } else {
<span class="nc" id="L2515">            return;</span>
        }

<span class="nc" id="L2518">        ReaderTracker.trackTag(stat, tag.getTagSlug());</span>
<span class="nc" id="L2519">    }</span>

    @Override
    public void onButtonClicked(ReaderPost post, ReaderPostCardActionType actionType) {
<span class="nc bnc" id="L2523" title="All 12 branches missed.">        switch (actionType) {</span>
            case FOLLOW:
<span class="nc" id="L2525">                mViewModel.onFollowSiteClicked(</span>
                        post,
<span class="nc" id="L2527">                        isBookmarksList(),</span>
<span class="nc" id="L2528">                        mPostAdapter.getSource()</span>
                );
<span class="nc" id="L2530">                break;</span>
            case SITE_NOTIFICATIONS:
<span class="nc" id="L2532">                mViewModel.onSiteNotificationMenuClicked(</span>
                        post.blogId,
                        post.postId,
<span class="nc" id="L2535">                        isBookmarksList(),</span>
<span class="nc" id="L2536">                        mPostAdapter.getSource()</span>
                );
<span class="nc" id="L2538">                break;</span>
            case SHARE:
<span class="nc" id="L2540">                mReaderTracker.trackBlog(</span>
                        AnalyticsTracker.Stat.SHARED_ITEM_READER,
                        post.blogId,
                        post.feedId,
<span class="nc" id="L2544">                        post.isFollowedByCurrentUser,</span>
<span class="nc" id="L2545">                        mPostAdapter.getSource()</span>
                );
<span class="nc" id="L2547">                sharePost(post);</span>
<span class="nc" id="L2548">                break;</span>
            case VISIT_SITE:
<span class="nc" id="L2550">                mReaderTracker.track(AnalyticsTracker.Stat.READER_ARTICLE_VISITED);</span>
<span class="nc" id="L2551">                ReaderActivityLauncher.openPost(getContext(), post);</span>
<span class="nc" id="L2552">                break;</span>
            case LIKE:
<span class="nc" id="L2554">                mViewModel.onLikeButtonClicked(</span>
                        post,
<span class="nc" id="L2556">                        isBookmarksList(),</span>
<span class="nc" id="L2557">                        mPostAdapter.getSource()</span>
                );
<span class="nc" id="L2559">                break;</span>
            case REBLOG:
<span class="nc" id="L2561">                mViewModel.onReblogButtonClicked(</span>
                        post,
<span class="nc" id="L2563">                        isBookmarksList(),</span>
<span class="nc" id="L2564">                        mPostAdapter.getSource()</span>
                );
<span class="nc" id="L2566">                break;</span>
            case REPORT_POST:
<span class="nc" id="L2568">                mViewModel.onReportPostButtonClicked(</span>
                        post,
<span class="nc" id="L2570">                        isBookmarksList(),</span>
<span class="nc" id="L2571">                        mPostAdapter.getSource()</span>
                );
<span class="nc" id="L2573">                break;</span>
            case BLOCK_SITE:
<span class="nc" id="L2575">                mViewModel.onBlockSiteButtonClicked(</span>
                        post,
<span class="nc" id="L2577">                        isBookmarksList(),</span>
<span class="nc" id="L2578">                        mPostAdapter.getSource()</span>
                );
<span class="nc" id="L2580">                break;</span>
            case BOOKMARK:
<span class="nc" id="L2582">                mViewModel.onBookmarkButtonClicked(</span>
                        post.blogId,
                        post.postId,
<span class="nc" id="L2585">                        isBookmarksList(),</span>
<span class="nc" id="L2586">                        mPostAdapter.getSource()</span>
                );
<span class="nc" id="L2588">                break;</span>
            case COMMENTS:
<span class="nc" id="L2590">                ReaderActivityLauncher.showReaderComments(</span>
<span class="nc" id="L2591">                        requireContext(),</span>
                        post.blogId,
                        post.postId,
<span class="nc" id="L2594">                        ThreadedCommentsActionSource.READER_POST_CARD.getSourceDescription()</span>
                );
<span class="nc" id="L2596">                break;</span>
            case TOGGLE_SEEN_STATUS:
<span class="nc bnc" id="L2598" title="All 2 branches missed.">                if (mSeenUnseenWithCounterFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L2599">                    mViewModel.onToggleSeenStatusClicked(</span>
                            post,
<span class="nc" id="L2601">                            isBookmarksList(),</span>
<span class="nc" id="L2602">                            mPostAdapter.getSource()</span>
                    );
                }
                break;
            case SPACER_NO_ACTION:
                break;
        }
<span class="nc" id="L2609">    }</span>

    @Override
    public void onFollowTapped(View view, String blogName, final long blogId, final long feedId) {
<span class="nc" id="L2613">        mDispatcher.dispatch(AccountActionBuilder.newFetchSubscriptionsAction());</span>

<span class="nc bnc" id="L2615" title="All 2 branches missed.">        String blog = TextUtils.isEmpty(blogName)</span>
<span class="nc" id="L2616">                ? getString(R.string.reader_followed_blog_notifications_this)</span>
<span class="nc" id="L2617">                : blogName;</span>

<span class="nc bnc" id="L2619" title="All 2 branches missed.">        if (blogId &gt; 0) {</span>
<span class="nc" id="L2620">            WPSnackbar.make(getSnackbarParent(), Html.fromHtml(getString(R.string.reader_followed_blog_notifications,</span>
                    &quot;&lt;b&gt;&quot;, blog, &quot;&lt;/b&gt;&quot;)), Snackbar.LENGTH_LONG)
<span class="nc" id="L2622">                      .setAction(getString(R.string.reader_followed_blog_notifications_action),</span>
<span class="nc" id="L2623">                              new View.OnClickListener() {</span>
                                  @Override public void onClick(View view) {
<span class="nc" id="L2625">                                      mReaderTracker.trackBlog(</span>
                                              AnalyticsTracker.Stat.FOLLOWED_BLOG_NOTIFICATIONS_READER_ENABLED,
                                              blogId,
                                              feedId
                                      );
<span class="nc" id="L2630">                                      AddOrDeleteSubscriptionPayload payload = new AddOrDeleteSubscriptionPayload(</span>
<span class="nc" id="L2631">                                              String.valueOf(blogId), SubscriptionAction.NEW);</span>
<span class="nc" id="L2632">                                      mDispatcher.dispatch(newUpdateSubscriptionNotificationPostAction(payload));</span>
<span class="nc" id="L2633">                                      ReaderBlogTable.setNotificationsEnabledByBlogId(blogId, true);</span>
<span class="nc" id="L2634">                                  }</span>
                              })
<span class="nc" id="L2636">                      .show();</span>
        }
<span class="nc" id="L2638">    }</span>

    @Override
    public void onFollowingTapped() {
<span class="nc" id="L2642">        mDispatcher.dispatch(AccountActionBuilder.newFetchSubscriptionsAction());</span>
<span class="nc" id="L2643">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSubscriptionUpdated(OnSubscriptionUpdated event) {
<span class="nc bnc" id="L2648" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L2649">            AppLog.e(T.API, ReaderPostListFragment.class.getSimpleName() + &quot;.onSubscriptionUpdated: &quot;</span>
                            + event.error.type + &quot; - &quot; + event.error.message);
        } else {
<span class="nc" id="L2652">            mDispatcher.dispatch(AccountActionBuilder.newFetchSubscriptionsAction());</span>
        }
<span class="nc" id="L2654">    }</span>

    private void sharePost(ReaderPost post) {
<span class="nc bnc" id="L2657" title="All 2 branches missed.">        String url = (post.hasShortUrl() ? post.getShortUrl() : post.getUrl());</span>

<span class="nc" id="L2659">        Intent intent = new Intent(Intent.ACTION_SEND);</span>
<span class="nc" id="L2660">        intent.setType(&quot;text/plain&quot;);</span>
<span class="nc" id="L2661">        intent.putExtra(Intent.EXTRA_TEXT, url);</span>
<span class="nc" id="L2662">        intent.putExtra(Intent.EXTRA_SUBJECT, post.getTitle());</span>

        try {
<span class="nc" id="L2665">            startActivity(Intent.createChooser(intent, getString(R.string.share_link)));</span>
<span class="nc" id="L2666">        } catch (android.content.ActivityNotFoundException ex) {</span>
<span class="nc" id="L2667">            ToastUtils.showToast(getActivity(), R.string.reader_toast_err_share_intent);</span>
<span class="nc" id="L2668">        }</span>
<span class="nc" id="L2669">    }</span>

    /*
     * purge reader db if it hasn't been done yet
     */
    private void purgeDatabaseIfNeeded() {
<span class="nc bnc" id="L2675" title="All 2 branches missed.">        if (!mHasPurgedReaderDb) {</span>
<span class="nc" id="L2676">            AppLog.d(T.READER, &quot;reader post list &gt; purging database&quot;);</span>
<span class="nc" id="L2677">            mHasPurgedReaderDb = true;</span>
<span class="nc" id="L2678">            ReaderDatabase.purgeAsync();</span>
        }
<span class="nc" id="L2680">    }</span>

    @Override
    public void onScrollToTop() {
<span class="nc bnc" id="L2684" title="All 4 branches missed.">        if (isAdded() &amp;&amp; getCurrentPosition() &gt; 0) {</span>
<span class="nc" id="L2685">            mRecyclerView.smoothScrollToPosition(0);</span>
        }
<span class="nc" id="L2687">    }</span>

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L2691">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L2692" title="All 4 branches missed.">        if (requestCode == RequestCodes.SITE_PICKER &amp;&amp; resultCode == Activity.RESULT_OK) {</span>
<span class="nc" id="L2693">            int siteLocalId = data.getIntExtra(</span>
                    SitePickerActivity.KEY_SITE_LOCAL_ID,
                    SelectedSiteRepository.UNAVAILABLE
            );
<span class="nc" id="L2697">            mViewModel.onReblogSiteSelected(siteLocalId);</span>
        }
<span class="nc" id="L2699">    }</span>

    private boolean isFollowingScreen() {
<span class="nc bnc" id="L2702" title="All 4 branches missed.">        return mTagFragmentStartedWith != null &amp;&amp; mTagFragmentStartedWith.isFollowedSites();</span>
    }

    private boolean isFilterableScreen() {
<span class="nc" id="L2706">        return isFilterableTag(mTagFragmentStartedWith);</span>
    }

    private boolean isFilterableTag(ReaderTag tag) {
<span class="nc bnc" id="L2710" title="All 4 branches missed.">        return tag != null &amp;&amp; tag.isFilterable();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>