<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InviteLinksApiCallsProvider.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.people</a> &gt; <span class="el_source">InviteLinksApiCallsProvider.kt</span></div><h1>InviteLinksApiCallsProvider.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.people

import org.wordpress.android.WordPress
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import org.wordpress.android.viewmodel.ContextProvider
import javax.inject.Inject
import kotlin.coroutines.resume
import kotlin.coroutines.suspendCoroutine
import com.android.volley.VolleyError
import com.google.gson.Gson
import com.google.gson.JsonParseException
import com.google.gson.reflect.TypeToken
import com.wordpress.rest.RestRequest.ErrorListener
import com.wordpress.rest.RestRequest.Listener
import org.json.JSONObject
import org.wordpress.android.R
import org.wordpress.android.R.string
import org.wordpress.android.ui.people.InviteLinksApiCallsProvider.InviteLinksCallResult.Failure
import org.wordpress.android.ui.people.InviteLinksApiCallsProvider.InviteLinksCallResult.Success
import org.wordpress.android.util.VolleyUtils

<span class="nc" id="L23">class InviteLinksApiCallsProvider @Inject constructor(</span>
<span class="nc" id="L24">    private val contextProvider: ContextProvider</span>
) {
<span class="nc bnc" id="L26" title="All 2 branches missed.">    suspend fun getInviteLinksStatus(blogId: Long): InviteLinksCallResult = suspendCoroutine { cont -&gt;</span>
<span class="nc" id="L27">        val endPointPath = &quot;/sites/$blogId/invites&quot;</span>

<span class="nc" id="L29">        val listener = Listener { jsonObject -&gt;</span>
<span class="nc" id="L30">            val result = getLinks(jsonObject)</span>
<span class="nc" id="L31">            AppLog.d(</span>
<span class="nc" id="L32">                    T.PEOPLE,</span>
<span class="nc" id="L33">                    &quot;getInviteLinksStatus &gt; Succeeded [blogId=$blogId - result = &quot; +</span>
<span class="nc" id="L34">                            &quot;${(result as Success).links.map { &quot;Name: ${it.role} Expiry: ${it.expiry}&quot; }}]&quot;</span>
            )
<span class="nc" id="L36">            cont.resume(result)</span>
<span class="nc" id="L37">        }</span>
<span class="nc" id="L38">        val errorListener = ErrorListener { volleyError -&gt;</span>
<span class="nc" id="L39">            val error = getErrorStringAndLog(&quot;getInviteLinksStatus&quot;, blogId, volleyError)</span>
<span class="nc" id="L40">            cont.resume(Failure(error))</span>
<span class="nc" id="L41">        }</span>

<span class="nc" id="L43">        WordPress.getRestClientUtilsV1_1().get(</span>
<span class="nc" id="L44">                endPointPath,</span>
<span class="nc" id="L45">                listener,</span>
<span class="nc" id="L46">                errorListener</span>
        )
<span class="nc" id="L48">    }</span>

<span class="nc bnc" id="L50" title="All 2 branches missed.">    suspend fun generateLinks(blogId: Long): InviteLinksCallResult = suspendCoroutine { cont -&gt;</span>
<span class="nc" id="L51">        val endPointPath = &quot;/sites/$blogId/invites/links/generate&quot;</span>

<span class="nc" id="L53">        val listener = Listener { jsonObject -&gt;</span>
<span class="nc" id="L54">            AppLog.d(</span>
<span class="nc" id="L55">                    T.PEOPLE,</span>
<span class="nc" id="L56">                    &quot;generateLinks &gt; Succeeded [blogId=$blogId]&quot;</span>
            )
<span class="nc" id="L58">            cont.resume(Success(listOf()))</span>
<span class="nc" id="L59">        }</span>
<span class="nc" id="L60">        val errorListener = ErrorListener { volleyError -&gt;</span>
<span class="nc" id="L61">            val error = getErrorStringAndLog(&quot;generateLinks&quot;, blogId, volleyError)</span>
<span class="nc" id="L62">            cont.resume(Failure(error))</span>
<span class="nc" id="L63">        }</span>

<span class="nc" id="L65">        WordPress.getRestClientUtilsV2().post(</span>
<span class="nc" id="L66">                endPointPath,</span>
<span class="nc" id="L67">                listener,</span>
<span class="nc" id="L68">                errorListener</span>
        )
<span class="nc" id="L70">    }</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">    suspend fun disableLinks(blogId: Long): InviteLinksCallResult = suspendCoroutine { cont -&gt;</span>
<span class="nc" id="L73">        val endPointPath = &quot;/sites/$blogId/invites/links/disable&quot;</span>

<span class="nc" id="L75">        val listener = Listener { jsonObject -&gt;</span>
<span class="nc" id="L76">            AppLog.d(</span>
<span class="nc" id="L77">                    T.PEOPLE,</span>
<span class="nc" id="L78">                    &quot;deleteLinks &gt; Succeeded [blogId=$blogId]&quot;</span>
            )
<span class="nc" id="L80">            cont.resume(Success(listOf()))</span>
<span class="nc" id="L81">        }</span>
<span class="nc" id="L82">        val errorListener = ErrorListener { volleyError -&gt;</span>
<span class="nc" id="L83">            val error = getErrorStringAndLog(&quot;deleteLinks&quot;, blogId, volleyError)</span>
<span class="nc" id="L84">            cont.resume(Failure(error))</span>
<span class="nc" id="L85">        }</span>

<span class="nc" id="L87">        WordPress.getRestClientUtilsV2().post(</span>
<span class="nc" id="L88">                endPointPath,</span>
<span class="nc" id="L89">                listener,</span>
<span class="nc" id="L90">                errorListener</span>
        )
<span class="nc" id="L92">    }</span>

    private fun getLinks(json: JSONObject?): InviteLinksCallResult {
<span class="nc bnc" id="L95" title="All 4 branches missed.">        return json?.let {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (it.has(&quot;links&quot;)) {</span>
<span class="nc" id="L97">                try {</span>
<span class="nc" id="L98">                    val linksSection = it.getJSONArray(&quot;links&quot;).toString()</span>
<span class="nc" id="L99">                    val gson = Gson()</span>
<span class="nc" id="L100">                    val mapType = object : TypeToken&lt;Array&lt;InviteLinksItem&gt;&gt;() {}.type</span>
<span class="nc" id="L101">                    val linksData = gson.fromJson&lt;Array&lt;InviteLinksItem&gt;&gt;(linksSection, mapType).toList()</span>

<span class="nc" id="L103">                    Success(linksData)</span>
<span class="nc" id="L104">                } catch (jsonEx: JsonParseException) {</span>
<span class="nc" id="L105">                    AppLog.d(T.PEOPLE, &quot;getLinks &gt; Error parsing server API response: error[{${jsonEx.message}}]&quot;)</span>
<span class="nc" id="L106">                    Failure(contextProvider.getContext().getString((string.invite_links_bad_format_response)))</span>
                }
            } else {
<span class="nc" id="L109">                Success(listOf())</span>
            }
<span class="nc" id="L111">        } ?: Failure(contextProvider.getContext().getString(string.invite_links_null_response))</span>
    }

    private fun getErrorStringAndLog(
        functionName: String,
        blogId: Long,
        volleyError: VolleyError?
    ): String {
<span class="nc" id="L119">        val error = VolleyUtils.errStringFromVolleyError(volleyError)</span>
<span class="nc bnc" id="L120" title="All 6 branches missed.">        return if (error.isNullOrEmpty()) {</span>
<span class="nc" id="L121">            AppLog.d(</span>
<span class="nc" id="L122">                    T.PEOPLE,</span>
<span class="nc" id="L123">                    &quot;$functionName &gt; Failed with empty string &quot; +</span>
<span class="nc" id="L124">                            &quot;[blogId=$blogId - volleyError = $volleyError]&quot;</span>
            )
<span class="nc" id="L126">            contextProvider.getContext().getString(R.string.invite_links_generic_get_data_error)</span>
<span class="nc" id="L127">        } else {</span>
<span class="nc" id="L128">            AppLog.d(</span>
<span class="nc" id="L129">                    T.PEOPLE,</span>
<span class="nc" id="L130">                    &quot;$functionName &gt; Failed [blogId=$blogId - error = $error]&quot;</span>
            )
<span class="nc" id="L132">            error</span>
        }
    }

<span class="nc" id="L136">    data class InviteLinksItem(val role: String, val expiry: Long, val link: String /*UriWrapper*/)</span>

    sealed class InviteLinksCallResult {
<span class="nc" id="L139">        data class Success(val links: List&lt;InviteLinksItem&gt;) : InviteLinksCallResult()</span>
<span class="nc" id="L140">        data class Failure(val error: String) : InviteLinksCallResult()</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>