<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QRCodeAuthFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.qrcodeauth</a> &gt; <span class="el_source">QRCodeAuthFragment.kt</span></div><h1>QRCodeAuthFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.qrcodeauth

import android.os.Bundle
import android.view.View
import androidx.fragment.app.Fragment
import androidx.activity.OnBackPressedCallback
import androidx.fragment.app.activityViewModels
import androidx.fragment.app.viewModels
import androidx.lifecycle.lifecycleScope
import com.google.mlkit.vision.codescanner.GmsBarcodeScanning
import dagger.hilt.android.AndroidEntryPoint
import kotlinx.coroutines.flow.launchIn
import kotlinx.coroutines.flow.onEach
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.databinding.QrcodeauthFragmentBinding
import org.wordpress.android.ui.posts.BasicDialogViewModel
import org.wordpress.android.ui.posts.BasicDialogViewModel.BasicDialogModel
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthActionEvent.FinishActivity
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthActionEvent.LaunchDismissDialog
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthActionEvent.LaunchScanner
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthActivity.Companion.DEEP_LINK_URI_KEY
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthActivity.Companion.IS_DEEP_LINK_KEY
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthUiState.Content
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthUiState.Error
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthUiState.Loading
import org.wordpress.android.ui.qrcodeauth.QRCodeAuthUiState.Scanning
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

@AndroidEntryPoint
@Suppress(&quot;TooManyFunctions&quot;)
<span class="nc" id="L34">class QRCodeAuthFragment : Fragment(R.layout.qrcodeauth_fragment) {</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>

<span class="nc" id="L37">    private val viewModel: QRCodeAuthViewModel by viewModels()</span>
<span class="nc" id="L38">    private val dialogViewModel: BasicDialogViewModel by activityViewModels()</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L41">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L42">        with(QrcodeauthFragmentBinding.bind(view)) {</span>
<span class="nc" id="L43">            initBackPressHandler()</span>
<span class="nc" id="L44">            observeViewModel()</span>
<span class="nc" id="L45">            initViewModel(savedInstanceState)</span>
<span class="nc" id="L46">        }</span>
<span class="nc" id="L47">    }</span>

    private fun QrcodeauthFragmentBinding.observeViewModel() {
<span class="nc bnc" id="L50" title="All 2 branches missed.">        viewModel.actionEvents.onEach { handleActionEvents(it) }.launchIn(viewLifecycleOwner.lifecycleScope)</span>
<span class="nc" id="L51">        dialogViewModel.onInteraction.observeEvent(viewLifecycleOwner) { viewModel.onDialogInteraction(it) }</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">        viewModel.uiState.onEach { renderUi(it) }.launchIn(viewLifecycleOwner.lifecycleScope)</span>
<span class="nc" id="L53">    }</span>

    private fun initViewModel(savedInstanceState: Bundle?) {
<span class="nc bnc" id="L56" title="All 6 branches missed.">        val(uri, isDeepLink) = requireActivity().intent?.extras?.let {</span>
<span class="nc" id="L57">            val uri = it.getString(DEEP_LINK_URI_KEY, null)</span>
<span class="nc" id="L58">            val isDeepLink = it.getBoolean(IS_DEEP_LINK_KEY, false)</span>
<span class="nc" id="L59">            uri to isDeepLink</span>
<span class="nc" id="L60">        } ?: (null to false)</span>

<span class="nc" id="L62">        viewModel.start(uri, isDeepLink, savedInstanceState)</span>
<span class="nc" id="L63">    }</span>

    private fun handleActionEvents(actionEvent: QRCodeAuthActionEvent) {
<span class="nc" id="L66">        when (actionEvent) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            is LaunchDismissDialog -&gt; launchDismissDialog(actionEvent.dialogModel)</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            is LaunchScanner -&gt; launchScanner()</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            is FinishActivity -&gt; requireActivity().finish()</span>
        }
<span class="nc" id="L71">    }</span>

    private fun QrcodeauthFragmentBinding.renderUi(uiState: QRCodeAuthUiState) {
<span class="nc" id="L74">        uiHelpers.updateVisibility(contentLayout.contentContainer, uiState.contentVisibility)</span>
<span class="nc" id="L75">        uiHelpers.updateVisibility(errorLayout.errorContainer, uiState.errorVisibility)</span>
<span class="nc" id="L76">        uiHelpers.updateVisibility(loadingLayout.loadingContainer, uiState.loadingVisibility)</span>
<span class="nc" id="L77">        when (uiState) {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            is Content -&gt; { applyContentState(uiState) }</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            is Error -&gt; { applyErrorState(uiState) }</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            is Loading -&gt; { } // NO OP</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            is Scanning -&gt; { } // NO OP</span>
        }
<span class="nc" id="L83">    }</span>

    private fun QrcodeauthFragmentBinding.applyContentState(uiState: Content) {
<span class="nc" id="L86">        uiHelpers.updateVisibility(contentLayout.contentContainer, uiState.contentVisibility)</span>
<span class="nc" id="L87">        uiHelpers.updateVisibility(contentLayout.progress, uiState.isProgressShowing)</span>
<span class="nc" id="L88">        uiHelpers.setTextOrHide(contentLayout.contentTitle, uiState.title)</span>
<span class="nc" id="L89">        uiHelpers.setTextOrHide(contentLayout.contentSubtitle, uiState.subtitle)</span>
<span class="nc" id="L90">        uiHelpers.setImageOrHide(contentLayout.contentImage, uiState.image)</span>
<span class="nc" id="L91">        contentLayout.contentContainer.alpha = uiState.alpha</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        uiState.primaryActionButton?.let { action -&gt;</span>
<span class="nc" id="L93">            uiHelpers.setTextOrHide(contentLayout.contentPrimaryAction, action.label)</span>
<span class="nc" id="L94">            uiHelpers.updateVisibility(contentLayout.contentPrimaryAction, action.isVisible)</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            contentLayout.contentPrimaryAction.setOnClickListener { action.clickAction?.invoke() }</span>
<span class="nc" id="L96">            contentLayout.contentPrimaryAction.isEnabled = action.isEnabled</span>
<span class="nc" id="L97">        }</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        uiState.secondaryActionButton?.let { action -&gt;</span>
<span class="nc" id="L99">            uiHelpers.setTextOrHide(contentLayout.contentSecondaryAction, action.label)</span>
<span class="nc" id="L100">            uiHelpers.updateVisibility(contentLayout.contentSecondaryAction, action.isVisible)</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            contentLayout.contentSecondaryAction.setOnClickListener { action.clickAction?.invoke() }</span>
<span class="nc" id="L102">            contentLayout.contentSecondaryAction.isEnabled = action.isEnabled</span>
<span class="nc" id="L103">        }</span>
<span class="nc" id="L104">    }</span>

    private fun QrcodeauthFragmentBinding.applyErrorState(uiState: Error) {
<span class="nc" id="L107">        uiHelpers.updateVisibility(errorLayout.errorContainer, uiState.errorVisibility)</span>
<span class="nc" id="L108">        uiHelpers.setImageOrHide(errorLayout.errorImage, uiState.image)</span>
<span class="nc" id="L109">        uiHelpers.setTextOrHide(errorLayout.errorTitle, uiState.title)</span>
<span class="nc" id="L110">        uiHelpers.setTextOrHide(errorLayout.errorSubtitle, uiState.subtitle)</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        uiState.primaryActionButton?.let { action -&gt;</span>
<span class="nc" id="L112">            uiHelpers.setTextOrHide(errorLayout.errorPrimaryAction, action.label)</span>
<span class="nc" id="L113">            errorLayout.errorPrimaryAction.setOnClickListener { action.clickAction.invoke() }</span>
<span class="nc" id="L114">        }</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        uiState.secondaryActionButton?.let { action -&gt;</span>
<span class="nc" id="L116">            uiHelpers.setTextOrHide(errorLayout.errorSecondaryAction, action.label)</span>
<span class="nc" id="L117">            errorLayout.errorSecondaryAction.setOnClickListener { action.clickAction.invoke() }</span>
<span class="nc" id="L118">        }</span>
<span class="nc" id="L119">    }</span>

    private fun launchDismissDialog(model: QRCodeAuthDialogModel) {
<span class="nc" id="L122">        dialogViewModel.showDialog(requireActivity().supportFragmentManager,</span>
<span class="nc" id="L123">                BasicDialogModel(model.tag,</span>
<span class="nc" id="L124">                        getString(model.title),</span>
<span class="nc" id="L125">                        getString(model.message),</span>
<span class="nc" id="L126">                        getString(model.positiveButtonLabel),</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                        model.negativeButtonLabel?.let { label -&gt; getString(label) },</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                        model.cancelButtonLabel?.let { label -&gt; getString(label) }</span>
                ))
<span class="nc" id="L130">    }</span>

    private fun launchScanner() {
<span class="nc" id="L133">        viewModel.track(Stat.QRLOGIN_SCANNER_DISPLAYED)</span>
<span class="nc" id="L134">        val scanner = GmsBarcodeScanning.getClient(requireContext())</span>
<span class="nc" id="L135">        scanner.startScan()</span>
<span class="nc" id="L136">                .addOnSuccessListener { barcode -&gt; viewModel.onScanSuccess(barcode.rawValue) }</span>
<span class="nc" id="L137">                .addOnFailureListener { viewModel.onScanFailure() }</span>
<span class="nc" id="L138">    }</span>

    private fun initBackPressHandler() {
<span class="nc" id="L141">        requireActivity().onBackPressedDispatcher.addCallback(</span>
<span class="nc" id="L142">                viewLifecycleOwner,</span>
<span class="nc" id="L143">                object : OnBackPressedCallback(</span>
<span class="nc" id="L144">                        true</span>
                ) {
                    override fun handleOnBackPressed() {
<span class="nc" id="L147">                        viewModel.onBackPressed()</span>
<span class="nc" id="L148">                    }</span>
                })
<span class="nc" id="L150">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L153">        viewModel.writeToBundle(outState)</span>
<span class="nc" id="L154">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L155">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>