<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlansViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.plans</a> &gt; <span class="el_source">PlansViewModel.kt</span></div><h1>PlansViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.plans

import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.coroutines.CoroutineDispatcher
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.action.PlanOffersAction.FETCH_PLAN_OFFERS
import org.wordpress.android.fluxc.generated.PlanOffersActionBuilder
import org.wordpress.android.fluxc.model.plans.PlanOffersModel
import org.wordpress.android.fluxc.store.PlanOffersStore
import org.wordpress.android.fluxc.store.PlanOffersStore.OnPlanOffersFetched
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.plans.PlansViewModel.PlansListStatus.DONE
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.viewmodel.ScopedViewModel
import org.wordpress.android.viewmodel.SingleLiveEvent
import javax.inject.Inject
import javax.inject.Named

<span class="nc" id="L25">class PlansViewModel @Inject constructor(</span>
<span class="nc" id="L26">    private val dispatcher: Dispatcher,</span>
<span class="nc" id="L27">    @Suppress(&quot;unused&quot;)</span>
    private var plansStore: PlanOffersStore,
<span class="nc" id="L29">    @param:Named(UI_THREAD) private val uiDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L30">    private val analyticsTrackerWrapper: AnalyticsTrackerWrapper</span>
<span class="nc" id="L31">) : ScopedViewModel(uiDispatcher) {</span>
    enum class PlansListStatus {
<span class="nc" id="L33">        DONE,</span>
<span class="nc" id="L34">        ERROR,</span>
<span class="nc" id="L35">        ERROR_WITH_CACHE,</span>
<span class="nc" id="L36">        FETCHING</span>
    }

<span class="nc" id="L39">    private val _listStatus = MutableLiveData&lt;PlansListStatus&gt;()</span>
    val listStatus: LiveData&lt;PlansListStatus&gt;
<span class="nc" id="L41">        get() = _listStatus</span>

<span class="nc" id="L43">    private val _plans = MutableLiveData&lt;List&lt;PlanOffersModel&gt;?&gt;()</span>
<span class="nc" id="L44">    private val _cachedPlans = MutableLiveData&lt;List&lt;PlanOffersModel&gt;?&gt;()</span>
    val plans: LiveData&lt;List&lt;PlanOffersModel&gt;?&gt;
<span class="nc" id="L46">        get() = _plans</span>

<span class="nc" id="L48">    private val _showDialog = SingleLiveEvent&lt;PlanOffersModel&gt;()</span>
    val showDialog: LiveData&lt;PlanOffersModel&gt;
<span class="nc" id="L50">        get() = _showDialog</span>

    private var isStarted = false

<span class="nc" id="L54">    init {</span>
<span class="nc" id="L55">        dispatcher.register(this)</span>
<span class="nc" id="L56">    }</span>

    fun create() {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (isStarted) {</span>
<span class="nc" id="L60">            return</span>
        }
<span class="nc" id="L62">        fetchPlans()</span>
<span class="nc" id="L63">        isStarted = true</span>
<span class="nc" id="L64">    }</span>

    private fun fetchPlans() {
<span class="nc" id="L67">        _listStatus.value = PlansListStatus.FETCHING</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        launch {</span>
<span class="nc" id="L69">            dispatcher.dispatch(PlanOffersActionBuilder.generateNoPayloadAction(FETCH_PLAN_OFFERS))</span>
<span class="nc" id="L70">        }</span>
<span class="nc" id="L71">    }</span>

    override fun onCleared() {
<span class="nc" id="L74">        dispatcher.unregister(this)</span>
<span class="nc" id="L75">        super.onCleared()</span>
<span class="nc" id="L76">    }</span>

    fun onItemClicked(item: PlanOffersModel) {
<span class="nc" id="L79">        analyticsTrackerWrapper.track(Stat.OPENED_PLANS_COMPARISON)</span>
<span class="nc" id="L80">        _showDialog.value = item</span>
<span class="nc" id="L81">    }</span>

    fun onPullToRefresh() {
<span class="nc" id="L84">        fetchPlans()</span>
<span class="nc" id="L85">    }</span>

    fun onShowCachedPlansButtonClicked() {
<span class="nc" id="L88">        _listStatus.value = DONE</span>
<span class="nc" id="L89">        _plans.value = _cachedPlans.value</span>
<span class="nc" id="L90">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    @SuppressWarnings(&quot;unused&quot;)
    fun onPlanOffersFetched(event: OnPlanOffersFetched) {
<span class="nc bnc" id="L95" title="All 8 branches missed.">        if (event.isError &amp;&amp; event.planOffers?.isEmpty() == false) {</span>
<span class="nc" id="L96">            _listStatus.value = PlansListStatus.ERROR_WITH_CACHE</span>
<span class="nc" id="L97">            _cachedPlans.value = event.planOffers</span>
<span class="nc" id="L98">            _plans.value = emptyList()</span>
<span class="nc" id="L99">            AppLog.e(T.API, &quot;An error occurred while fetching plans. Cache is available.&quot;)</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        } else if (event.isError) {</span>
<span class="nc" id="L101">            _listStatus.value = PlansListStatus.ERROR</span>
<span class="nc" id="L102">            _plans.value = emptyList()</span>
<span class="nc" id="L103">            AppLog.e(T.API, &quot;An error occurred while fetching plans. Cache is not available.&quot;)</span>
        } else {
<span class="nc" id="L105">            _listStatus.value = DONE</span>
<span class="nc" id="L106">            _plans.value = event.planOffers</span>
        }
<span class="nc" id="L108">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>