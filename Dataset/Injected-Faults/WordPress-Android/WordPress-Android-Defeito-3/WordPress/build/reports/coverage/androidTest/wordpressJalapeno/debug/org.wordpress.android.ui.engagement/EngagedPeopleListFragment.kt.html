<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EngagedPeopleListFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.engagement</a> &gt; <span class="el_source">EngagedPeopleListFragment.kt</span></div><h1>EngagedPeopleListFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.engagement

import android.content.Context
import android.os.Bundle
import android.os.Parcelable
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.fragment.app.Fragment
import androidx.lifecycle.Lifecycle.State
import androidx.lifecycle.ViewModelProvider
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.ui.ActionableEmptyView
import org.wordpress.android.ui.WPWebViewActivity
import org.wordpress.android.ui.engagement.BottomSheetAction.HideBottomSheet
import org.wordpress.android.ui.engagement.BottomSheetAction.ShowBottomSheet
import org.wordpress.android.ui.engagement.EngagedListNavigationEvent.OpenUserProfileBottomSheet
import org.wordpress.android.ui.engagement.EngagedListNavigationEvent.PreviewCommentInReader
import org.wordpress.android.ui.engagement.EngagedListNavigationEvent.PreviewPostInReader
import org.wordpress.android.ui.engagement.EngagedListNavigationEvent.PreviewSiteById
import org.wordpress.android.ui.engagement.EngagedListNavigationEvent.PreviewSiteByUrl
import org.wordpress.android.ui.engagement.EngagedListServiceRequestEvent.RequestBlogPost
import org.wordpress.android.ui.engagement.EngagedListServiceRequestEvent.RequestComment
import org.wordpress.android.ui.engagement.EngagedPeopleListViewModel.EngagedPeopleListUiState
import org.wordpress.android.ui.engagement.UserProfileViewModel.Companion.USER_PROFILE_VM_KEY
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.reader.ReaderActivityLauncher
import org.wordpress.android.ui.reader.actions.ReaderPostActions
import org.wordpress.android.ui.reader.services.comment.ReaderCommentService
import org.wordpress.android.ui.reader.tracker.ReaderTracker
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.SnackbarItem
import org.wordpress.android.util.SnackbarItem.Action
import org.wordpress.android.util.SnackbarItem.Info
import org.wordpress.android.util.SnackbarSequencer
import org.wordpress.android.util.WPUrlUtils
import org.wordpress.android.util.analytics.AnalyticsUtilsWrapper
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.viewmodel.ResourceProvider
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

<span class="nc" id="L47">class EngagedPeopleListFragment : Fragment() {</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">    @Inject lateinit var resourceProvider: ResourceProvider</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">    @Inject lateinit var imageManager: ImageManager</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">    @Inject lateinit var snackbarSequencer: SnackbarSequencer</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">    @Inject lateinit var readerTracker: ReaderTracker</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">    @Inject lateinit var analyticsUtilsWrapper: AnalyticsUtilsWrapper</span>

    private lateinit var viewModel: EngagedPeopleListViewModel
    private lateinit var userProfileViewModel: UserProfileViewModel
    private lateinit var recycler: RecyclerView
    private lateinit var loadingView: View
    private lateinit var rootView: View
    private lateinit var emptyView: ActionableEmptyView

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L64">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc" id="L66">        viewModel = ViewModelProvider(this, viewModelFactory).get(EngagedPeopleListViewModel::class.java)</span>
<span class="nc" id="L67">        userProfileViewModel = ViewModelProvider(this, viewModelFactory)</span>
<span class="nc" id="L68">                .get(USER_PROFILE_VM_KEY, UserProfileViewModel::class.java)</span>
<span class="nc" id="L69">    }</span>

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
<span class="nc" id="L72">        return inflater.inflate(R.layout.engaged_people_list_fragment, container, false)</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L76">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc" id="L78">        rootView = view</span>
<span class="nc" id="L79">        recycler = view.findViewById(R.id.recycler)</span>
<span class="nc" id="L80">        loadingView = view.findViewById(R.id.loading_view)</span>
<span class="nc" id="L81">        emptyView = view.findViewById(R.id.actionable_empty_view)</span>

<span class="nc" id="L83">        val listScenario = requireArguments().getParcelable&lt;ListScenario&gt;(KEY_LIST_SCENARIO)</span>

<span class="nc" id="L85">        val layoutManager = LinearLayoutManager(activity)</span>

<span class="nc bnc" id="L87" title="All 4 branches missed.">        savedInstanceState?.getParcelable&lt;Parcelable&gt;(KEY_LIST_STATE)?.let {</span>
<span class="nc" id="L88">            layoutManager.onRestoreInstanceState(it)</span>
<span class="nc" id="L89">        }</span>

<span class="nc bnc" id="L91" title="All 2 branches missed.">        recycler.layoutManager = layoutManager</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        userProfileViewModel.onBottomSheetAction.observeEvent(viewLifecycleOwner, { state -&gt;</span>
<span class="nc" id="L94">            val fragmentManager = childFragmentManager</span>
<span class="nc" id="L95">            fragmentManager?.let {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                var bottomSheet = it.findFragmentByTag(USER_PROFILE_BOTTOM_SHEET_TAG) as? UserProfileBottomSheetFragment</span>

<span class="nc" id="L98">                when (state) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                    ShowBottomSheet -&gt; {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                        if (bottomSheet == null) {</span>
<span class="nc" id="L101">                            bottomSheet = UserProfileBottomSheetFragment.newInstance(USER_PROFILE_VM_KEY)</span>
<span class="nc" id="L102">                            bottomSheet.show(fragmentManager, USER_PROFILE_BOTTOM_SHEET_TAG)</span>
                        }
                    }
<span class="nc bnc" id="L105" title="All 2 branches missed.">                    HideBottomSheet -&gt; {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                        bottomSheet?.apply { this.dismiss() }</span>
                    }
                }
<span class="nc" id="L109">            }</span>
<span class="nc" id="L110">        })</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner, { state -&gt;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (!isAdded) return@observe</span>

<span class="nc" id="L115">            updateUiState(state)</span>
<span class="nc" id="L116">        })</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">        viewModel.onNavigationEvent.observeEvent(viewLifecycleOwner, { event -&gt;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (!isAdded) return@observeEvent</span>

<span class="nc" id="L121">            manageNavigation(event)</span>
<span class="nc" id="L122">        })</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">        viewModel.onSnackbarMessage.observeEvent(viewLifecycleOwner, { messageHolder -&gt;</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">            if (!isAdded || !lifecycle.currentState.isAtLeast(State.RESUMED)) return@observeEvent</span>

<span class="nc" id="L127">            showSnackbar(messageHolder)</span>
<span class="nc" id="L128">        })</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">        viewModel.onServiceRequestEvent.observeEvent(viewLifecycleOwner, { serviceRequest -&gt;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (!isAdded) return@observeEvent</span>

<span class="nc" id="L133">            manageServiceRequest(serviceRequest)</span>
<span class="nc" id="L134">        })</span>

<span class="nc bnc" id="L136" title="All 2 branches missed.">        viewModel.start(listScenario!!)</span>
<span class="nc" id="L137">    }</span>

    private fun manageNavigation(event: EngagedListNavigationEvent) {
<span class="nc" id="L140">        with(requireActivity()) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (this.isFinishing) return@with</span>

<span class="nc" id="L143">            when (event) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                is PreviewSiteById -&gt; {</span>
<span class="nc" id="L145">                    ReaderActivityLauncher.showReaderBlogPreview(</span>
<span class="nc" id="L146">                            this,</span>
<span class="nc" id="L147">                            event.siteId,</span>
                            // TODO: this can be true if we use this fragment for NOTE_FOLLOW_TYPE notifications
<span class="nc" id="L149">                            false,</span>
<span class="nc" id="L150">                            event.source,</span>
<span class="nc" id="L151">                            readerTracker</span>
                    )
                }
<span class="nc bnc" id="L154" title="All 2 branches missed.">                is PreviewSiteByUrl -&gt; {</span>
<span class="nc" id="L155">                    val url = event.siteUrl</span>
<span class="nc" id="L156">                    openUrl(this, url, event.source)</span>
                }
<span class="nc bnc" id="L158" title="All 2 branches missed.">                is PreviewCommentInReader -&gt; {</span>
<span class="nc" id="L159">                    ReaderActivityLauncher.showReaderComments(</span>
<span class="nc" id="L160">                            this,</span>
<span class="nc" id="L161">                            event.siteId,</span>
<span class="nc" id="L162">                            event.commentPostId,</span>
<span class="nc" id="L163">                            event.postOrCommentId,</span>
<span class="nc" id="L164">                            event.source.sourceDescription</span>
                    )
                }
<span class="nc bnc" id="L167" title="All 2 branches missed.">                is PreviewPostInReader -&gt; {</span>
<span class="nc" id="L168">                    ReaderActivityLauncher.showReaderPostDetail(this, event.siteId, event.postId)</span>
                }
<span class="nc bnc" id="L170" title="All 2 branches missed.">                is OpenUserProfileBottomSheet -&gt; {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                    userProfileViewModel.onBottomSheetOpen(event.userProfile, event.onClick, event.source)</span>
                }
            }

<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (event.closeUserProfileIfOpened) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                userProfileViewModel.onBottomSheetCancelled()</span>
            }
<span class="nc" id="L178">        }</span>
<span class="nc" id="L179">    }</span>

    private fun updateUiState(state: EngagedPeopleListUiState) {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        uiHelpers.updateVisibility(loadingView, state.showLoading)</span>

<span class="nc" id="L184">        setupAdapter(state.engageItemsList)</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (state.showEmptyState) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            uiHelpers.setTextOrHide(emptyView.title, state.emptyStateTitle)</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            uiHelpers.setTextOrHide(emptyView.button, state.emptyStateButtonText)</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">            emptyView.button.setOnClickListener { state.emptyStateAction?.invoke() }</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">            emptyView.visibility = View.VISIBLE</span>
        } else {
<span class="nc bnc" id="L193" title="All 2 branches missed.">            emptyView.visibility = View.GONE</span>
        }
<span class="nc" id="L195">    }</span>

    private fun manageServiceRequest(serviceRequest: EngagedListServiceRequestEvent) {
<span class="nc" id="L198">        with(requireActivity()) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (this.isFinishing) return@with</span>

<span class="nc" id="L201">            when (serviceRequest) {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                is RequestBlogPost -&gt; ReaderPostActions.requestBlogPost(</span>
<span class="nc" id="L203">                        serviceRequest.siteId,</span>
<span class="nc" id="L204">                        serviceRequest.postId,</span>
<span class="nc" id="L205">                        null</span>
                )
<span class="nc bnc" id="L207" title="All 2 branches missed.">                is RequestComment -&gt; ReaderCommentService.startServiceForComment(</span>
<span class="nc" id="L208">                        this,</span>
<span class="nc" id="L209">                        serviceRequest.siteId,</span>
<span class="nc" id="L210">                        serviceRequest.postId,</span>
<span class="nc" id="L211">                        serviceRequest.commentId</span>
                )
            }
<span class="nc" id="L214">        }</span>
<span class="nc" id="L215">    }</span>

    private fun openUrl(context: Context, url: String, source: String) {
<span class="nc" id="L218">        analyticsUtilsWrapper.trackBlogPreviewedByUrl(source)</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (WPUrlUtils.isWordPressCom(url)) {</span>
<span class="nc" id="L220">            WPWebViewActivity.openUrlByUsingGlobalWPCOMCredentials(context, url)</span>
        } else {
<span class="nc" id="L222">            WPWebViewActivity.openURL(context, url)</span>
        }
<span class="nc" id="L224">    }</span>

    private fun setupAdapter(items: List&lt;EngageItem&gt;) {
<span class="nc bnc" id="L227" title="All 6 branches missed.">        val adapter = recycler.adapter as? EngagedPeopleAdapter ?: EngagedPeopleAdapter(</span>
<span class="nc" id="L228">                imageManager,</span>
<span class="nc" id="L229">                resourceProvider</span>
<span class="nc" id="L230">        ).also {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">            recycler.adapter = it</span>
<span class="nc" id="L232">        }</span>

<span class="nc bnc" id="L234" title="All 4 branches missed.">        val recyclerViewState = recycler.layoutManager?.onSaveInstanceState()</span>
<span class="nc" id="L235">        adapter.loadData(items)</span>
<span class="nc bnc" id="L236" title="All 4 branches missed.">        recycler.layoutManager?.onRestoreInstanceState(recyclerViewState)</span>
<span class="nc" id="L237">    }</span>

    private fun showSnackbar(holder: SnackbarMessageHolder) {
<span class="nc" id="L240">        snackbarSequencer.enqueue(</span>
<span class="nc" id="L241">                SnackbarItem(</span>
<span class="nc" id="L242">                        Info(</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                                view = rootView,</span>
<span class="nc" id="L244">                                textRes = holder.message,</span>
<span class="nc" id="L245">                                duration = Snackbar.LENGTH_LONG</span>
                        ),
<span class="nc bnc" id="L247" title="All 2 branches missed.">                        holder.buttonTitle?.let {</span>
<span class="nc" id="L248">                            Action(</span>
<span class="nc" id="L249">                                    textRes = holder.buttonTitle,</span>
<span class="nc" id="L250">                                    clickListener = { holder.buttonAction() }</span>
                            )
                        },
<span class="nc" id="L253">                        dismissCallback = { _, event -&gt; holder.onDismissAction(event) }</span>
                )
        )
<span class="nc" id="L256">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L259">        super.onSaveInstanceState(outState)</span>

<span class="nc bnc" id="L261" title="All 4 branches missed.">        recycler.layoutManager?.let {</span>
<span class="nc" id="L262">            outState.putParcelable(KEY_LIST_STATE, it.onSaveInstanceState())</span>
<span class="nc" id="L263">        }</span>
<span class="nc" id="L264">    }</span>

    companion object {
        private const val KEY_LIST_SCENARIO = &quot;list_scenario&quot;
        private const val KEY_LIST_STATE = &quot;list_state&quot;

        private const val USER_PROFILE_BOTTOM_SHEET_TAG = &quot;USER_PROFILE_BOTTOM_SHEET_TAG&quot;

        @JvmStatic
        fun newInstance(listScenario: ListScenario): EngagedPeopleListFragment {
<span class="nc" id="L274">            val args = Bundle()</span>
<span class="nc" id="L275">            args.putParcelable(KEY_LIST_SCENARIO, listScenario)</span>

<span class="nc" id="L277">            val fragment = EngagedPeopleListFragment()</span>
<span class="nc" id="L278">            fragment.arguments = args</span>

<span class="nc" id="L280">            return fragment</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>