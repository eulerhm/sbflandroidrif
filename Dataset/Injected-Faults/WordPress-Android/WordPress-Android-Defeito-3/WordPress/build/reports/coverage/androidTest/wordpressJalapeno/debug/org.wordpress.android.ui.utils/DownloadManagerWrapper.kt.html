<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DownloadManagerWrapper.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.utils</a> &gt; <span class="el_source">DownloadManagerWrapper.kt</span></div><h1>DownloadManagerWrapper.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.utils

import android.app.DownloadManager
import android.app.DownloadManager.Query
import android.app.DownloadManager.Request
import android.content.ActivityNotFoundException
import android.content.ContentResolver
import android.content.Context
import android.content.Intent
import android.database.Cursor
import android.net.Uri
import android.webkit.MimeTypeMap
import android.webkit.URLUtil
import androidx.core.content.FileProvider
import org.wordpress.android.BuildConfig
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import java.io.File
import javax.inject.Inject
import javax.inject.Singleton

<span class="nc" id="L22">@Singleton</span>
class DownloadManagerWrapper
<span class="nc" id="L24">@Inject constructor(private val context: Context) {</span>
<span class="nc" id="L25">    fun enqueue(request: Request): Long = downloadManager().enqueue(request)</span>

<span class="nc" id="L27">    fun buildRequest(fileUrl: String) = Request(Uri.parse(fileUrl))</span>

<span class="nc" id="L29">    fun query(query: Query): Cursor = downloadManager().query(query)</span>

<span class="nc" id="L31">    fun buildQuery() = Query()</span>

<span class="nc" id="L33">    fun guessUrl(fileUrl: String): String = URLUtil.guessUrl(fileUrl)</span>

    fun getMimeType(url: String): String? {
<span class="nc" id="L36">        var type: String? = null</span>
<span class="nc" id="L37">        val extension = MimeTypeMap.getFileExtensionFromUrl(url)</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">        if (extension != null) {</span>
<span class="nc" id="L39">            val mime = MimeTypeMap.getSingleton()</span>
<span class="nc" id="L40">            type = mime.getMimeTypeFromExtension(extension)</span>
        }
<span class="nc" id="L42">        return type</span>
    }

    private fun toPublicUri(fileUrl: String): Uri {
<span class="nc" id="L46">        val fileUri = Uri.parse(fileUrl)</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        return if (ContentResolver.SCHEME_FILE == fileUri.scheme) {</span>
<span class="nc" id="L48">            val file = File(fileUri.path)</span>
<span class="nc" id="L49">            FileProvider.getUriForFile(</span>
<span class="nc" id="L50">                    context,</span>
<span class="nc" id="L51">                    &quot;${BuildConfig.APPLICATION_ID}.provider&quot;,</span>
<span class="nc" id="L52">                    file</span>
            )
<span class="nc" id="L54">        } else {</span>
<span class="nc" id="L55">            fileUri</span>
        }
    }

    fun openDownloadedAttachment(
        context: Context,
        fileUrl: String,
        attachmentMimeType: String
    ) {
<span class="nc" id="L64">        val attachmentUri = toPublicUri(fileUrl)</span>

<span class="nc" id="L66">        val openAttachmentIntent = Intent(Intent.ACTION_VIEW)</span>
<span class="nc" id="L67">        openAttachmentIntent.setDataAndType(attachmentUri, attachmentMimeType)</span>
<span class="nc" id="L68">        openAttachmentIntent.flags = Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK</span>
<span class="nc" id="L69">        try {</span>
<span class="nc" id="L70">            context.startActivity(openAttachmentIntent)</span>
<span class="nc" id="L71">        } catch (e: ActivityNotFoundException) {</span>
<span class="nc" id="L72">            AppLog.e(T.READER, &quot;No browser found on the device: ${e.message}&quot;)</span>
        }
<span class="nc" id="L74">    }</span>

    private fun downloadManager() =
<span class="nc bnc" id="L77" title="All 2 branches missed.">            (context.getSystemService(Context.DOWNLOAD_SERVICE) as DownloadManager)</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>