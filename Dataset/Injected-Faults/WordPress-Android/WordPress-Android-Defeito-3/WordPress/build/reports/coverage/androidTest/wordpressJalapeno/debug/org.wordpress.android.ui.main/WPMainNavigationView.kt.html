<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WPMainNavigationView.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.main</a> &gt; <span class="el_source">WPMainNavigationView.kt</span></div><h1>WPMainNavigationView.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.main

import android.annotation.SuppressLint
import android.content.Context
import android.util.AttributeSet
import android.view.LayoutInflater
import android.view.MenuItem
import android.view.View
import android.widget.ImageView
import android.widget.TextView
import androidx.annotation.DrawableRes
import androidx.annotation.IdRes
import androidx.annotation.StringRes
import androidx.core.content.res.ResourcesCompat
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentManager
import com.google.android.material.bottomnavigation.BottomNavigationItemView
import com.google.android.material.bottomnavigation.BottomNavigationMenuView
import com.google.android.material.bottomnavigation.BottomNavigationView
import com.google.android.material.bottomnavigation.BottomNavigationView.OnNavigationItemReselectedListener
import com.google.android.material.bottomnavigation.BottomNavigationView.OnNavigationItemSelectedListener
import com.google.android.material.bottomnavigation.LabelVisibilityMode
import org.wordpress.android.BuildConfig
import org.wordpress.android.R
import org.wordpress.android.ui.main.WPMainActivity.OnScrollToTopListener
import org.wordpress.android.ui.main.WPMainNavigationView.PageType.MY_SITE
import org.wordpress.android.ui.main.WPMainNavigationView.PageType.NOTIFS
import org.wordpress.android.ui.main.WPMainNavigationView.PageType.READER
import org.wordpress.android.ui.mysite.MySiteFragment
import org.wordpress.android.ui.notifications.NotificationsListFragment
import org.wordpress.android.ui.posts.PostUtils.EntryPoint
import org.wordpress.android.ui.prefs.AppPrefs
import org.wordpress.android.ui.reader.ReaderFragment
import org.wordpress.android.util.AniUtils
import org.wordpress.android.util.AniUtils.Duration
import org.wordpress.android.util.extensions.getColorStateListFromAttribute

/*
 * Bottom navigation view and related adapter used by the main activity for the
 * four primary views - note that we ignore the built-in icons and labels and
 * insert our own custom views so we have more control over their appearance
 */
<span class="nc" id="L43">class WPMainNavigationView @JvmOverloads constructor(</span>
    context: Context,
<span class="nc" id="L45">    attrs: AttributeSet? = null,</span>
<span class="nc" id="L46">    defStyleAttr: Int = 0</span>
<span class="nc" id="L47">) : BottomNavigationView(context, attrs, defStyleAttr),</span>
        OnNavigationItemSelectedListener, OnNavigationItemReselectedListener {
    private lateinit var navAdapter: NavAdapter
    private lateinit var fragmentManager: FragmentManager
    private lateinit var pageListener: OnPageListener
<span class="nc" id="L52">    private var prevPosition = -1</span>
<span class="nc" id="L53">    private val unselectedButtonAlpha = ResourcesCompat.getFloat(</span>
<span class="nc" id="L54">            resources,</span>
<span class="nc" id="L55">            R.dimen.material_emphasis_disabled</span>
    )

    private var currentPosition: Int
<span class="nc" id="L59">        get() = getPositionForItemId(selectedItemId)</span>
<span class="nc" id="L60">        set(position) = updateCurrentPosition(position)</span>

    val activeFragment: Fragment?
<span class="nc bnc" id="L63" title="All 2 branches missed.">        get() = navAdapter.getFragment(currentPosition)</span>

    var currentSelectedPage: PageType
<span class="nc" id="L66">        get() = getPageForItemId(selectedItemId)</span>
<span class="nc" id="L67">        set(pageType) = updateCurrentPosition(pages().indexOf(pageType))</span>

    interface OnPageListener {
        fun onPageChanged(position: Int)
        fun onNewPostButtonClicked(promptId: Int, origin: EntryPoint)
    }

    fun init(fm: FragmentManager, listener: OnPageListener) {
<span class="nc" id="L75">        fragmentManager = fm</span>
<span class="nc" id="L76">        pageListener = listener</span>

<span class="nc" id="L78">        navAdapter = NavAdapter()</span>
<span class="nc" id="L79">        assignNavigationListeners(true)</span>
<span class="nc" id="L80">        disableShiftMode()</span>

        // overlay each item with our custom view
<span class="nc bnc" id="L83" title="All 2 branches missed.">        val menuView = getChildAt(0) as BottomNavigationMenuView</span>
<span class="nc" id="L84">        if (!BuildConfig.ENABLE_READER) hideReaderTab()</span>

<span class="nc" id="L86">        val inflater = LayoutInflater.from(context)</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        for (i in 0 until menu.size()) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            val itemView = menuView.getChildAt(i) as BottomNavigationItemView</span>
<span class="nc" id="L89">            val customView: View = inflater.inflate(R.layout.navbar_item, menuView, false)</span>

<span class="nc" id="L91">            val txtLabel = customView.findViewById&lt;TextView&gt;(R.id.nav_label)</span>
<span class="nc" id="L92">            val imgIcon = customView.findViewById&lt;ImageView&gt;(R.id.nav_icon)</span>
<span class="nc" id="L93">            txtLabel.text = getTitleForPosition(i)</span>
<span class="nc" id="L94">            customView.contentDescription = getContentDescriptionForPosition(i)</span>
<span class="nc" id="L95">            imgIcon.setImageResource(getDrawableResForPosition(i))</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (i == getPosition(READER)) {</span>
<span class="nc" id="L97">                customView.id = R.id.bottom_nav_reader_button // identify view for QuickStart</span>
            }
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (i == getPosition(NOTIFS)) {</span>
<span class="nc" id="L100">                customView.id = R.id.bottom_nav_notifications_button // identify view for QuickStart</span>
            }

<span class="nc" id="L103">            itemView.addView(customView)</span>
        }

<span class="nc" id="L106">        currentPosition = AppPrefs.getMainPageIndex(numPages() - 1)</span>
<span class="nc" id="L107">    }</span>

    private fun hideReaderTab() {
<span class="nc" id="L110">        menu.removeItem(R.id.nav_reader)</span>
<span class="nc" id="L111">    }</span>

    @SuppressLint(&quot;WrongConstant&quot;)
    private fun disableShiftMode() {
<span class="nc" id="L115">        labelVisibilityMode = LabelVisibilityMode.LABEL_VISIBILITY_LABELED</span>
<span class="nc" id="L116">    }</span>

    private fun assignNavigationListeners(assign: Boolean) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        setOnNavigationItemSelectedListener(if (assign) this else null)</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        setOnNavigationItemReselectedListener(if (assign) this else null)</span>
<span class="nc" id="L121">    }</span>

    override fun onNavigationItemSelected(item: MenuItem): Boolean {
<span class="nc" id="L124">        val position = getPositionForItemId(item.itemId)</span>
<span class="nc" id="L125">        currentPosition = position</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        pageListener.onPageChanged(position)</span>
<span class="nc" id="L127">        return true</span>
    }

    override fun onNavigationItemReselected(item: MenuItem) {
        // scroll the active fragment's contents to the top when user re-taps the current item
<span class="nc" id="L132">        val position = getPositionForItemId(item.itemId)</span>
<span class="nc bnc" id="L133" title="All 6 branches missed.">        (navAdapter.getFragment(position) as? OnScrollToTopListener)?.onScrollToTop()</span>
<span class="nc" id="L134">    }</span>

    private fun getPositionForItemId(@IdRes itemId: Int): Int {
<span class="nc" id="L137">        return getPosition(getPageForItemId(itemId))</span>
    }

    private fun getPageForItemId(@IdRes itemId: Int): PageType {
<span class="nc bnc" id="L141" title="All 3 branches missed.">        return when (itemId) {</span>
<span class="nc" id="L142">            R.id.nav_sites -&gt; MY_SITE</span>
<span class="nc" id="L143">            R.id.nav_reader -&gt; READER</span>
<span class="nc" id="L144">            else -&gt; NOTIFS</span>
        }
    }

    @IdRes
    private fun getItemIdForPosition(position: Int): Int {
<span class="nc bnc" id="L150" title="All 5 branches missed.">        return when (getPageTypeOrNull(position)) {</span>
<span class="nc" id="L151">            MY_SITE -&gt; R.id.nav_sites</span>
<span class="nc" id="L152">            READER -&gt; R.id.nav_reader</span>
<span class="nc" id="L153">            else -&gt; R.id.nav_notifications</span>
        }
    }

    private fun updateCurrentPosition(position: Int) {
        // remove the title and selected state from the previously selected item
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (prevPosition &gt; -1) {</span>
<span class="nc" id="L160">            setTitleViewSelected(prevPosition, false)</span>
<span class="nc" id="L161">            setImageViewSelected(prevPosition, false)</span>
        }

        // set the title and selected state from the newly selected item
<span class="nc" id="L165">        setTitleViewSelected(position, true)</span>

<span class="nc" id="L167">        setImageViewSelected(position, true)</span>

<span class="nc" id="L169">        AppPrefs.setMainPageIndex(position)</span>

        // temporarily disable the nav listeners so they don't fire when we change the selected page
<span class="nc" id="L172">        assignNavigationListeners(false)</span>
<span class="nc" id="L173">        try {</span>
<span class="nc" id="L174">            selectedItemId = getItemIdForPosition(position)</span>
        } finally {
<span class="nc" id="L176">            assignNavigationListeners(true)</span>
        }

<span class="nc bnc" id="L179" title="All 2 branches missed.">        val fragment = navAdapter.getFragment(position)</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        val previousFragment = navAdapter.getFragment(prevPosition)</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (fragment != null) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (previousFragment != null) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                fragmentManager.beginTransaction().detach(previousFragment).attach(fragment).commit()</span>
            } else {
<span class="nc bnc" id="L185" title="All 2 branches missed.">                fragmentManager.beginTransaction().attach(fragment).commit()</span>
            }
        }
<span class="nc" id="L188">        prevPosition = position</span>
<span class="nc" id="L189">    }</span>

    private fun setImageViewSelected(position: Int, isSelected: Boolean) {
<span class="nc bnc" id="L192" title="All 2 branches missed.">        getImageViewForPosition(position)?.let {</span>
<span class="nc" id="L193">            it.isSelected = isSelected</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            it.alpha = if (isSelected) 1f else unselectedButtonAlpha</span>
<span class="nc" id="L195">        }</span>
<span class="nc" id="L196">    }</span>

    private fun setTitleViewSelected(position: Int, isSelected: Boolean) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        getTitleViewForPosition(position)?.setTextColor(</span>
<span class="nc" id="L200">                context.getColorStateListFromAttribute(</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                        if (isSelected) R.attr.wpColorNavBar else R.attr.wpColorOnSurfaceMedium</span>
                )
        )
<span class="nc" id="L204">    }</span>

    @DrawableRes
    private fun getDrawableResForPosition(position: Int): Int {
<span class="nc bnc" id="L208" title="All 5 branches missed.">        return when (getPageTypeOrNull(position)) {</span>
<span class="nc" id="L209">            MY_SITE -&gt; R.drawable.ic_my_sites_white_24dp</span>
<span class="nc" id="L210">            READER -&gt; R.drawable.ic_reader_white_24dp</span>
<span class="nc" id="L211">            else -&gt; R.drawable.ic_bell_white_24dp</span>
        }
    }

    private fun getTitleForPosition(position: Int): CharSequence {
<span class="nc bnc" id="L216" title="All 5 branches missed.">        @StringRes val idRes: Int = when (pages().getOrNull(position)) {</span>
<span class="nc" id="L217">            MY_SITE -&gt; R.string.my_site_section_screen_title</span>
<span class="nc" id="L218">            READER -&gt; R.string.reader_screen_title</span>
<span class="nc" id="L219">            else -&gt; R.string.notifications_screen_title</span>
        }
<span class="nc" id="L221">        return context.getString(idRes)</span>
    }

    private fun getContentDescriptionForPosition(position: Int): CharSequence {
<span class="nc bnc" id="L225" title="All 5 branches missed.">        @StringRes val idRes: Int = when (pages().getOrNull(position)) {</span>
<span class="nc" id="L226">            MY_SITE -&gt; R.string.tabbar_accessibility_label_my_site</span>
<span class="nc" id="L227">            READER -&gt; R.string.tabbar_accessibility_label_reader</span>
<span class="nc" id="L228">            else -&gt; R.string.tabbar_accessibility_label_notifications</span>
        }
<span class="nc" id="L230">        return context.getString(idRes)</span>
    }

    fun getContentDescriptionForPageType(pageType: PageType): CharSequence {
<span class="nc" id="L234">        return getContentDescriptionForPosition(getPosition(pageType))</span>
    }

    private fun getTagForPageType(pageType: PageType): String {
<span class="nc bnc" id="L238" title="All 3 branches missed.">        return when (pageType) {</span>
<span class="nc" id="L239">            MY_SITE -&gt; TAG_MY_SITE</span>
<span class="nc" id="L240">            READER -&gt; TAG_READER</span>
<span class="nc" id="L241">            NOTIFS -&gt; TAG_NOTIFS</span>
        }
    }

    private fun getTitleViewForPosition(position: Int): TextView? {
<span class="nc bnc" id="L246" title="All 2 branches missed.">        return getItemView(position)?.findViewById(R.id.nav_label)</span>
    }

    private fun getImageViewForPosition(position: Int): ImageView? {
<span class="nc" id="L250">        val itemView = getItemView(position)</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        return itemView?.findViewById(R.id.nav_icon)</span>
    }

<span class="nc bnc" id="L254" title="All 2 branches missed.">    fun getFragment(pageType: PageType) = navAdapter.getFragmentIfExists(getPosition(pageType))</span>

    private fun getItemView(position: Int): BottomNavigationItemView? {
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (isValidPosition(position)) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            val menuView = getChildAt(0) as BottomNavigationMenuView</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">            return menuView.getChildAt(position) as BottomNavigationItemView</span>
        }
<span class="nc" id="L261">        return null</span>
    }

    fun showReaderBadge(showBadge: Boolean) {
<span class="nc" id="L265">        showBadge(getPosition(READER), showBadge)</span>
<span class="nc" id="L266">    }</span>

    fun showNoteBadge(showBadge: Boolean) {
<span class="nc" id="L269">        showBadge(getPosition(NOTIFS), showBadge)</span>
<span class="nc" id="L270">    }</span>

    /*
     * show or hide the badge on the 'pageId' icon in the bottom bar
     */
    private fun showBadge(pageId: Int, showBadge: Boolean) {
<span class="nc bnc" id="L276" title="All 2 branches missed.">        val badgeView = getItemView(pageId)?.findViewById&lt;View&gt;(R.id.nav_badge)</span>

<span class="nc bnc" id="L278" title="All 2 branches missed.">        val currentVisibility = badgeView?.visibility</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">        val newVisibility = if (showBadge) View.VISIBLE else View.GONE</span>
<span class="nc bnc" id="L280" title="All 4 branches missed.">        if (currentVisibility == newVisibility) {</span>
<span class="nc" id="L281">            return</span>
        }

<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (showBadge) {</span>
<span class="nc" id="L285">            AniUtils.fadeIn(badgeView, Duration.MEDIUM)</span>
        } else {
<span class="nc" id="L287">            AniUtils.fadeOut(badgeView, Duration.MEDIUM)</span>
        }
<span class="nc" id="L289">    }</span>

    private fun isValidPosition(position: Int): Boolean {
<span class="nc bnc" id="L292" title="All 4 branches missed.">        return position in 0 until numPages()</span>
    }

<span class="nc" id="L295">    private inner class NavAdapter {</span>
        private fun createFragment(pageType: PageType): Fragment {
<span class="nc bnc" id="L297" title="All 3 branches missed.">            val fragment = when (pageType) {</span>
<span class="nc" id="L298">                MY_SITE -&gt; MySiteFragment.newInstance()</span>
<span class="nc" id="L299">                READER -&gt; ReaderFragment()</span>
<span class="nc" id="L300">                NOTIFS -&gt; NotificationsListFragment.newInstance()</span>
            }
<span class="nc bnc" id="L302" title="All 2 branches missed.">            fragmentManager.beginTransaction()</span>
<span class="nc" id="L303">                    .add(R.id.fragment_container, fragment, getTagForPageType(pageType))</span>
<span class="nc" id="L304">                    .commitNow()</span>
<span class="nc" id="L305">            return fragment</span>
        }

        internal fun getFragment(position: Int): Fragment? {
<span class="nc bnc" id="L309" title="All 2 branches missed.">            return pages().getOrNull(position)?.let { pageType -&gt;</span>
<span class="nc bnc" id="L310" title="All 4 branches missed.">                fragmentManager.findFragmentByTag(getTagForPageType(pageType)) ?: createFragment(pageType)</span>
            }
        }

        internal fun getFragmentIfExists(position: Int): Fragment? {
<span class="nc bnc" id="L315" title="All 2 branches missed.">            return pages().getOrNull(position)?.let { pageType -&gt;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                fragmentManager.findFragmentByTag(getTagForPageType(pageType))</span>
            }
        }
    }

    companion object {
<span class="nc" id="L322">        private val pages = if (BuildConfig.ENABLE_READER) listOf(MY_SITE, READER, NOTIFS) else listOf(MY_SITE, NOTIFS)</span>

        private const val TAG_MY_SITE = &quot;tag-mysite&quot;
        private const val TAG_READER = &quot;tag-reader&quot;
        private const val TAG_NOTIFS = &quot;tag-notifs&quot;

<span class="nc" id="L328">        private fun numPages(): Int = pages.size</span>

<span class="nc" id="L330">        private fun pages(): List&lt;PageType&gt; = pages</span>

        private fun getPageTypeOrNull(position: Int): PageType? {
<span class="nc" id="L333">            return pages().getOrNull(position)</span>
        }

        fun getPosition(pageType: PageType): Int {
<span class="nc" id="L337">            return pages().indexOf(pageType)</span>
        }

        @JvmStatic
        fun getPageType(position: Int): PageType {
<span class="nc" id="L342">            return pages()[position]</span>
        }
    }

    enum class PageType {
<span class="nc" id="L347">        MY_SITE, READER, NOTIFS</span>
    }
<span class="nc" id="L349">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>