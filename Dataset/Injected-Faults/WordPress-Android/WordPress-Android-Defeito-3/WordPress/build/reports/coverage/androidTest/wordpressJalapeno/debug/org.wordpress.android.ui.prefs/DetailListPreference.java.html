<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DetailListPreference.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs</a> &gt; <span class="el_source">DetailListPreference.java</span></div><h1>DetailListPreference.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs;

import android.content.Context;
import android.content.DialogInterface;
import android.content.res.Resources;
import android.content.res.TypedArray;
import android.os.Bundle;
import android.preference.ListPreference;
import android.text.TextUtils;
import android.util.AttributeSet;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.RadioButton;
import android.widget.TextView;

import androidx.appcompat.app.AlertDialog;

import com.google.android.material.dialog.MaterialAlertDialogBuilder;

import org.apache.commons.lang3.ArrayUtils;
import org.jetbrains.annotations.NotNull;
import org.wordpress.android.R;
import org.wordpress.android.ui.utils.UiHelpers;

import java.util.Locale;

/**
 * Custom {@link ListPreference} used to display detail text per item.
 */

public class DetailListPreference extends ListPreference
        implements PreferenceHint {
    private DetailListAdapter mListAdapter;
    private String[] mDetails;
    private String mStartingValue;
    private int mSelectedIndex;
    private String mHint;
    private AlertDialog mDialog;
    private int mWhichButtonClicked;

    public DetailListPreference(Context context, AttributeSet attrs) {
<span class="nc" id="L44">        super(context, attrs);</span>

<span class="nc" id="L46">        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.DetailListPreference);</span>

<span class="nc bnc" id="L48" title="All 2 branches missed.">        for (int i = 0; i &lt; array.getIndexCount(); ++i) {</span>
<span class="nc" id="L49">            int index = array.getIndex(i);</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">            if (index == R.styleable.DetailListPreference_entryDetails) {</span>
<span class="nc" id="L51">                int id = array.getResourceId(index, -1);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">                if (id != -1) {</span>
<span class="nc" id="L53">                    mDetails = array.getResources().getStringArray(id);</span>
                }
<span class="nc bnc" id="L55" title="All 2 branches missed.">            } else if (index == R.styleable.DetailListPreference_longClickHint) {</span>
<span class="nc" id="L56">                mHint = array.getString(index);</span>
            }
        }

<span class="nc" id="L60">        array.recycle();</span>

<span class="nc" id="L62">        mSelectedIndex = -1;</span>
<span class="nc" id="L63">    }</span>

    @Override
    public CharSequence getEntry() {
<span class="nc" id="L67">        int index = findIndexOfValue(getValue());</span>
<span class="nc" id="L68">        CharSequence[] entries = getEntries();</span>

<span class="nc bnc" id="L70" title="All 6 branches missed.">        if (entries != null &amp;&amp; index &gt;= 0 &amp;&amp; index &lt; entries.length) {</span>
<span class="nc" id="L71">            return entries[index];</span>
        }
<span class="nc" id="L73">        return null;</span>
    }

    @Override
    protected void showDialog(Bundle state) {
<span class="nc" id="L78">        Context context = getContext();</span>
<span class="nc" id="L79">        Resources res = context.getResources();</span>
<span class="nc" id="L80">        int topOffset = res.getDimensionPixelOffset(R.dimen.settings_fragment_dialog_vertical_inset);</span>

<span class="nc" id="L82">        AlertDialog.Builder builder = new MaterialAlertDialogBuilder(context)</span>
<span class="nc" id="L83">                .setBackgroundInsetTop(topOffset)</span>
<span class="nc" id="L84">                .setBackgroundInsetBottom(topOffset);</span>

<span class="nc" id="L86">        mWhichButtonClicked = DialogInterface.BUTTON_NEGATIVE;</span>
<span class="nc" id="L87">        builder.setPositiveButton(android.R.string.ok, this);</span>
<span class="nc" id="L88">        builder.setNegativeButton(res.getString(android.R.string.cancel).toUpperCase(Locale.getDefault()), this);</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (mDetails == null) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            mDetails = new String[getEntries() == null ? 1 : getEntries().length];</span>
        }

<span class="nc" id="L94">        mListAdapter = new DetailListAdapter(getContext(), R.layout.detail_list_preference, mDetails);</span>
<span class="nc" id="L95">        mStartingValue = getValue();</span>
<span class="nc" id="L96">        mSelectedIndex = findIndexOfValue(mStartingValue);</span>

<span class="nc" id="L98">        builder.setSingleChoiceItems(mListAdapter, mSelectedIndex,</span>
<span class="nc" id="L99">                (dialog, which) -&gt; mSelectedIndex = which);</span>

<span class="nc" id="L101">        View titleView = View.inflate(getContext(), R.layout.detail_list_preference_title, null);</span>

<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (titleView != null) {</span>
<span class="nc" id="L104">            TextView titleText = titleView.findViewById(R.id.title);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (titleText != null) {</span>
<span class="nc" id="L106">                titleText.setText(getTitle());</span>
            }

<span class="nc" id="L109">            builder.setCustomTitle(titleView);</span>
<span class="nc" id="L110">        } else {</span>
<span class="nc" id="L111">            builder.setTitle(getTitle());</span>
        }

<span class="nc" id="L114">        mDialog = builder.create();</span>

<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (state != null) {</span>
<span class="nc" id="L117">            mDialog.onRestoreInstanceState(state);</span>
        }
<span class="nc" id="L119">        mDialog.setOnDismissListener(this);</span>
<span class="nc" id="L120">        mDialog.show();</span>

<span class="nc" id="L122">        ListView listView = mDialog.getListView();</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (listView != null) {</span>
<span class="nc" id="L125">            listView.setDividerHeight(0);</span>
<span class="nc" id="L126">            listView.setClipToPadding(true);</span>
<span class="nc" id="L127">            listView.setPadding(0, 0, 0, res.getDimensionPixelSize(R.dimen.site_settings_divider_height));</span>
        }

<span class="nc" id="L130">        UiHelpers.Companion.adjustDialogSize(mDialog);</span>
<span class="nc" id="L131">    }</span>

    @Override
    public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L135">        mWhichButtonClicked = which;</span>
<span class="nc" id="L136">    }</span>

    @Override
    public void onDismiss(DialogInterface dialog) {
<span class="nc" id="L140">        mDialog = null;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        onDialogClosed(mWhichButtonClicked == DialogInterface.BUTTON_POSITIVE);</span>
<span class="nc" id="L142">    }</span>

    @Override
    protected void onDialogClosed(boolean positiveResult) {
<span class="nc bnc" id="L146" title="All 2 branches missed.">        int index = positiveResult ? mSelectedIndex : findIndexOfValue(mStartingValue);</span>
<span class="nc" id="L147">        CharSequence[] values = getEntryValues();</span>
<span class="nc bnc" id="L148" title="All 6 branches missed.">        if (values != null &amp;&amp; index &gt;= 0 &amp;&amp; index &lt; values.length) {</span>
<span class="nc" id="L149">            String value = String.valueOf(values[index]);</span>
<span class="nc" id="L150">            callChangeListener(value);</span>
        }
<span class="nc" id="L152">    }</span>

    @Override
    public boolean hasHint() {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        return !TextUtils.isEmpty(mHint);</span>
    }

    @Override
    public String getHint() {
<span class="nc" id="L161">        return mHint;</span>
    }

    @Override
    public void setHint(String hint) {
<span class="nc" id="L166">        mHint = hint;</span>
<span class="nc" id="L167">    }</span>

    public void remove(int index) {
<span class="nc bnc" id="L170" title="All 4 branches missed.">        if (index &lt; 0 || index &gt;= mDetails.length) {</span>
<span class="nc" id="L171">            return;</span>
        }

<span class="nc" id="L174">        mDetails = ArrayUtils.remove(mDetails, index);</span>
<span class="nc" id="L175">        mListAdapter = new DetailListAdapter(getContext(), R.layout.detail_list_preference, mDetails);</span>
<span class="nc" id="L176">    }</span>

    public void refreshAdapter() {
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (mListAdapter != null) {</span>
<span class="nc" id="L180">            mListAdapter.notifyDataSetChanged();</span>
        }
<span class="nc" id="L182">    }</span>

    public void setDetails(String[] details) {
<span class="nc" id="L185">        mDetails = details;</span>
<span class="nc" id="L186">        refreshAdapter();</span>
<span class="nc" id="L187">    }</span>

    private class DetailListAdapter extends ArrayAdapter&lt;String&gt; {
<span class="nc" id="L190">        DetailListAdapter(Context context, int resource, String[] objects) {</span>
<span class="nc" id="L191">            super(context, resource, objects);</span>
<span class="nc" id="L192">        }</span>

        @NotNull
        @Override
        public View getView(final int position, View convertView, @NotNull ViewGroup parent) {
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (convertView == null) {</span>
<span class="nc" id="L198">                convertView = View.inflate(getContext(), R.layout.detail_list_preference, null);</span>
            }

<span class="nc" id="L201">            final RadioButton radioButton = convertView.findViewById(R.id.radio);</span>
<span class="nc" id="L202">            TextView mainText = convertView.findViewById(R.id.main_text);</span>
<span class="nc" id="L203">            TextView detailText = convertView.findViewById(R.id.detail_text);</span>

<span class="nc bnc" id="L205" title="All 6 branches missed.">            if (mainText != null &amp;&amp; getEntries() != null &amp;&amp; position &lt; getEntries().length) {</span>
<span class="nc" id="L206">                mainText.setText(getEntries()[position]);</span>
            }

<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (detailText != null) {</span>
<span class="nc bnc" id="L210" title="All 6 branches missed.">                if (mDetails != null &amp;&amp; position &lt; mDetails.length &amp;&amp; !TextUtils.isEmpty(mDetails[position])) {</span>
<span class="nc" id="L211">                    detailText.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L212">                    detailText.setText(mDetails[position]);</span>
                } else {
<span class="nc" id="L214">                    detailText.setVisibility(View.GONE);</span>
                }
            }

<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (radioButton != null) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                radioButton.setChecked(mSelectedIndex == position);</span>
            }

<span class="nc" id="L222">            convertView.setOnClickListener(v -&gt; changeSelection(position));</span>

<span class="nc" id="L224">            return convertView;</span>
        }

        private void changeSelection(int position) {
<span class="nc" id="L228">            mSelectedIndex = position;</span>
<span class="nc" id="L229">            notifyDataSetChanged();</span>
<span class="nc" id="L230">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>