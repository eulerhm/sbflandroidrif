<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AztecVideoLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts.services</a> &gt; <span class="el_source">AztecVideoLoader.java</span></div><h1>AztecVideoLoader.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts.services;

import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.drawable.BitmapDrawable;
import android.graphics.drawable.Drawable;
import android.media.ThumbnailUtils;
import android.os.AsyncTask;
import android.provider.MediaStore.Images.Thumbnails;
import android.text.TextUtils;
import android.util.DisplayMetrics;

import org.wordpress.android.WordPress;
import org.wordpress.android.ui.utils.AuthenticationUtils;
import org.wordpress.android.util.ImageUtils;
import org.wordpress.aztec.Html;

import java.io.File;
import java.lang.ref.WeakReference;

import javax.inject.Inject;

public class AztecVideoLoader implements Html.VideoThumbnailGetter {
    private final Context mContext;
    private final Drawable mLoadingInProgress;
    @Inject AuthenticationUtils mAuthenticationUtils;

<span class="nc" id="L28">    public AztecVideoLoader(Context context, Drawable loadingInProgressDrawable) {</span>
<span class="nc" id="L29">        ((WordPress) WordPress.getContext().getApplicationContext()).component().inject(this);</span>
<span class="nc" id="L30">        mContext = context;</span>
<span class="nc" id="L31">        mLoadingInProgress = loadingInProgressDrawable;</span>
<span class="nc" id="L32">    }</span>

    public void loadVideoThumbnail(final String url, final Html.VideoThumbnailGetter.Callbacks callbacks,
                                   final int maxWidth) {
<span class="nc" id="L36">        loadVideoThumbnail(url, callbacks, maxWidth, 0);</span>
<span class="nc" id="L37">    }</span>

    public void loadVideoThumbnail(final String url, final Html.VideoThumbnailGetter.Callbacks callbacks,
                                   final int maxWidth, final int minWidth) {
<span class="nc bnc" id="L41" title="All 4 branches missed.">        if (TextUtils.isEmpty(url) || maxWidth &lt;= 0) {</span>
<span class="nc" id="L42">            callbacks.onThumbnailFailed();</span>
<span class="nc" id="L43">            return;</span>
        }

<span class="nc" id="L46">        callbacks.onThumbnailLoading(mLoadingInProgress);</span>
<span class="nc" id="L47">        new LoadAztecVideoTask(mContext, mAuthenticationUtils, url, maxWidth, callbacks).execute();</span>
<span class="nc" id="L48">    }</span>

    private static class LoadAztecVideoTask extends AsyncTask&lt;Void, Void, Bitmap&gt; {
        final String mUrl;
        final int mMaxWidth;
        final Html.VideoThumbnailGetter.Callbacks mCallbacks;
        final AuthenticationUtils mAuthenticationUtils;
        final WeakReference&lt;Context&gt; mContext;

        LoadAztecVideoTask(Context context,
                           AuthenticationUtils authenticationUtils,
                           String url,
                           int maxWidth,
<span class="nc" id="L61">                           Html.VideoThumbnailGetter.Callbacks callbacks) {</span>
<span class="nc" id="L62">            mContext = new WeakReference&lt;&gt;(context);</span>
<span class="nc" id="L63">            mAuthenticationUtils = authenticationUtils;</span>
<span class="nc" id="L64">            mUrl = url;</span>
<span class="nc" id="L65">            mMaxWidth = maxWidth;</span>
<span class="nc" id="L66">            mCallbacks = callbacks;</span>
<span class="nc" id="L67">        }</span>

        @Override
        protected Bitmap doInBackground(Void... params) {
            // If local file
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (new File(mUrl).exists()) {</span>
<span class="nc" id="L73">                return ThumbnailUtils.createVideoThumbnail(mUrl, Thumbnails.FULL_SCREEN_KIND);</span>
            }

<span class="nc" id="L76">            return ImageUtils.getVideoFrameFromVideo(mUrl, mMaxWidth, mAuthenticationUtils.getAuthHeaders(mUrl));</span>
        }

        @Override
        protected void onPostExecute(Bitmap thumb) {
<span class="nc bnc" id="L81" title="All 2 branches missed.">            if (mContext.get() == null) {</span>
<span class="nc" id="L82">                return;</span>
            }
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (thumb == null) {</span>
<span class="nc" id="L85">                mCallbacks.onThumbnailFailed();</span>
<span class="nc" id="L86">                return;</span>
            }
<span class="nc" id="L88">            thumb = ImageUtils.getScaledBitmapAtLongestSide(thumb, mMaxWidth);</span>
<span class="nc" id="L89">            thumb.setDensity(DisplayMetrics.DENSITY_DEFAULT);</span>
<span class="nc" id="L90">            BitmapDrawable bitmapDrawable = new BitmapDrawable(mContext.get().getResources(), thumb);</span>
<span class="nc" id="L91">            mCallbacks.onThumbnailLoaded(bitmapDrawable);</span>
<span class="nc" id="L92">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>