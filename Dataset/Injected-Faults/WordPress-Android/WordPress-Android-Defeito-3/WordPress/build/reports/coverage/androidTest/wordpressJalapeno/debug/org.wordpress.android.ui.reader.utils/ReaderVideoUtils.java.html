<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderVideoUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.utils</a> &gt; <span class="el_source">ReaderVideoUtils.java</span></div><h1>ReaderVideoUtils.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.utils;

import android.net.Uri;
import android.text.TextUtils;

import com.android.volley.Response;
import com.android.volley.VolleyError;
import com.android.volley.toolbox.JsonArrayRequest;

import org.json.JSONArray;
import org.json.JSONObject;
import org.wordpress.android.WordPress;
import org.wordpress.android.datasets.ReaderThumbnailTable;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.JSONUtils;
import org.wordpress.android.util.MediaUtils;

public class ReaderVideoUtils {
<span class="nc" id="L20">    private ReaderVideoUtils() {</span>
<span class="nc" id="L21">        throw new AssertionError();</span>
    }

    /*
     * determine whether we can show a thumbnail image for the passed video - currently
     * we support YouTube, Vimeo &amp; standard images
     */
    public static boolean canShowVideoThumbnail(String videoUrl) {
<span class="nc bnc" id="L29" title="All 2 branches missed.">        return isVimeoLink(videoUrl)</span>
<span class="nc bnc" id="L30" title="All 2 branches missed.">               || isYouTubeVideoLink(videoUrl)</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">               || MediaUtils.isValidImage(videoUrl);</span>
    }

    public static void retrieveVideoThumbnailUrl(final String videoUrl, final VideoThumbnailUrlListener listener) {
        // if this is a YouTube video we can determine the thumbnail url from the passed url,
        // otherwise check if we've already cached the thumbnail url for this video
        String thumbnailUrl;
<span class="nc bnc" id="L38" title="All 2 branches missed.">        if (ReaderVideoUtils.isYouTubeVideoLink(videoUrl)) {</span>
<span class="nc" id="L39">            thumbnailUrl = ReaderVideoUtils.getYouTubeThumbnailUrl(videoUrl);</span>
        } else {
<span class="nc" id="L41">            thumbnailUrl = ReaderThumbnailTable.getThumbnailUrl(videoUrl);</span>
        }
<span class="nc bnc" id="L43" title="All 2 branches missed.">        if (!TextUtils.isEmpty(thumbnailUrl)) {</span>
<span class="nc" id="L44">            listener.showThumbnail(thumbnailUrl);</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">        } else if (MediaUtils.isValidImage(videoUrl)) {</span>
<span class="nc" id="L46">            listener.showThumbnail(videoUrl);</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        } else if (ReaderVideoUtils.isVimeoLink(videoUrl)) {</span>
<span class="nc" id="L48">            listener.showPlaceholder();</span>
<span class="nc" id="L49">            ReaderVideoUtils.requestVimeoThumbnail(videoUrl, new FetchVideoThumbnailListener() {</span>
                @Override
                public void onResponse(boolean successful, String thumbnailUrl) {
<span class="nc" id="L52">                    listener.showThumbnail(videoUrl);</span>
<span class="nc" id="L53">                    listener.cacheThumbnailUrl(videoUrl);</span>
<span class="nc" id="L54">                }</span>
            });
        } else {
<span class="nc" id="L57">            AppLog.d(AppLog.T.UTILS, &quot;no video thumbnail for &quot; + videoUrl);</span>
<span class="nc" id="L58">            listener.showPlaceholder();</span>
        }
<span class="nc" id="L60">    }</span>


    /*
     * returns the url to get the full-size (480x360) thumbnail url for the passed video
     * see http://www.reelseo.com/youtube-thumbnail-image/ for other sizes
     */
    public static String getYouTubeThumbnailUrl(final String videoUrl) {
<span class="nc" id="L68">        String videoId = getYouTubeVideoId(videoUrl);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (TextUtils.isEmpty(videoId)) {</span>
<span class="nc" id="L70">            return &quot;&quot;;</span>
        }
        // note that this *must* use https rather than http - ex: https://img.youtube.com/vi/ClbE019cLNI/0.jpg
<span class="nc" id="L73">        return &quot;https://img.youtube.com/vi/&quot; + videoId + &quot;/0.jpg&quot;;</span>
    }

    /*
     * returns true if the passed url is a link to a YouTube video
     */
    public static boolean isYouTubeVideoLink(final String link) {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        return (!TextUtils.isEmpty(getYouTubeVideoId(link)));</span>
    }

    /*
     * extract the video id from the passed YouTube url
     */
    private static String getYouTubeVideoId(final String link) {
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (link == null) {</span>
<span class="nc" id="L88">            return &quot;&quot;;</span>
        }

<span class="nc" id="L91">        Uri uri = Uri.parse(link);</span>
        try {
<span class="nc" id="L93">            String host = uri.getHost();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            if (host == null) {</span>
<span class="nc" id="L95">                return &quot;&quot;;</span>
            }

            // youtube.com links
<span class="nc bnc" id="L99" title="All 4 branches missed.">            if (host.equals(&quot;youtube.com&quot;) || host.equals(&quot;www.youtube.com&quot;)) {</span>
                // if link contains &quot;watch&quot; in the path, then the id is in the &quot;v=&quot; query param
<span class="nc bnc" id="L101" title="All 2 branches missed.">                if (link.contains(&quot;watch&quot;)) {</span>
<span class="nc" id="L102">                    return uri.getQueryParameter(&quot;v&quot;);</span>
                }
                // if the link contains &quot;embed&quot; in the path, then the id is the last path segment
                // ex: https://www.youtube.com/embed/fw3w68YrKwc?version=3&amp;#038;rel=1&amp;#038;
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (link.contains(&quot;/embed/&quot;)) {</span>
<span class="nc" id="L107">                    return uri.getLastPathSegment();</span>
                }
<span class="nc" id="L109">                return &quot;&quot;;</span>
            }

            // youtu.be urls have the videoId as the path - ex: http://youtu.be/pEnXclbO9jg
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (host.equals(&quot;youtu.be&quot;)) {</span>
<span class="nc" id="L114">                String path = uri.getPath();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (path == null) {</span>
<span class="nc" id="L116">                    return &quot;&quot;;</span>
                }
                // remove the leading slash
<span class="nc" id="L119">                return path.replace(&quot;/&quot;, &quot;&quot;);</span>
            }

            // YouTube mobile urls include video id in fragment, ex:
            // http://m.youtube.com/?dc=organic&amp;source=mog#/watch?v=t77Vlme_pf8
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (host.equals(&quot;m.youtube.com&quot;)) {</span>
<span class="nc" id="L125">                String fragment = uri.getFragment();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                if (fragment == null) {</span>
<span class="nc" id="L127">                    return &quot;&quot;;</span>
                }
<span class="nc" id="L129">                int index = fragment.lastIndexOf(&quot;v=&quot;);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                if (index != -1) {</span>
<span class="nc" id="L131">                    return fragment.substring(index + 2, fragment.length());</span>
                }
            }

<span class="nc" id="L135">            return &quot;&quot;;</span>
<span class="nc" id="L136">        } catch (UnsupportedOperationException e) {</span>
<span class="nc" id="L137">            AppLog.e(T.READER, e);</span>
<span class="nc" id="L138">            return &quot;&quot;;</span>
<span class="nc" id="L139">        } catch (IndexOutOfBoundsException e) {</span>
            // thrown by substring
<span class="nc" id="L141">            AppLog.e(T.READER, e);</span>
<span class="nc" id="L142">            return &quot;&quot;;</span>
        }
    }

    /*
     * returns true if the passed url is a link to a Vimeo video
     */
    public static boolean isVimeoLink(final String link) {
<span class="nc bnc" id="L150" title="All 2 branches missed.">        return (!TextUtils.isEmpty(getVimeoVideoId(link)));</span>
    }

    /*
     * extract the video id from the passed Vimeo url
     * ex: http://player.vimeo.com/video/72386905 -&gt; 72386905
     */
    private static String getVimeoVideoId(final String link) {
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (link == null) {</span>
<span class="nc" id="L159">            return &quot;&quot;;</span>
        }
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!link.contains(&quot;player.vimeo.com&quot;)) {</span>
<span class="nc" id="L162">            return &quot;&quot;;</span>
        }

<span class="nc" id="L165">        Uri uri = Uri.parse(link);</span>
<span class="nc" id="L166">        return uri.getLastPathSegment();</span>
    }

    /*
     * unlike YouTube thumbnails, Vimeo thumbnails require network request
     */
    public static void requestVimeoThumbnail(final String videoUrl, final FetchVideoThumbnailListener thumbListener) {
        // useless without a listener
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (thumbListener == null) {</span>
<span class="nc" id="L175">            return;</span>
        }

<span class="nc" id="L178">        String id = getVimeoVideoId(videoUrl);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (TextUtils.isEmpty(id)) {</span>
<span class="nc" id="L180">            thumbListener.onResponse(false, null);</span>
<span class="nc" id="L181">            return;</span>
        }

<span class="nc" id="L184">        Response.Listener&lt;JSONArray&gt; listener = new Response.Listener&lt;JSONArray&gt;() {</span>
            public void onResponse(JSONArray response) {
<span class="nc" id="L186">                String thumbnailUrl = null;</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">                if (response != null &amp;&amp; response.length() &gt; 0) {</span>
<span class="nc" id="L188">                    JSONObject json = response.optJSONObject(0);</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">                    if (json != null &amp;&amp; json.has(&quot;thumbnail_large&quot;)) {</span>
<span class="nc" id="L190">                        thumbnailUrl = JSONUtils.getString(json, &quot;thumbnail_large&quot;);</span>
                    }
                }
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if (TextUtils.isEmpty(thumbnailUrl)) {</span>
<span class="nc" id="L194">                    thumbListener.onResponse(false, null);</span>
                } else {
<span class="nc" id="L196">                    thumbListener.onResponse(true, thumbnailUrl);</span>
                }
<span class="nc" id="L198">            }</span>
        };
<span class="nc" id="L200">        Response.ErrorListener errorListener = new Response.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L203">                AppLog.e(T.READER, volleyError);</span>
<span class="nc" id="L204">                thumbListener.onResponse(false, null);</span>
<span class="nc" id="L205">            }</span>
        };

<span class="nc" id="L208">        String url = &quot;https://vimeo.com/api/v2/video/&quot; + id + &quot;.json&quot;;</span>
<span class="nc" id="L209">        JsonArrayRequest request = new JsonArrayRequest(url, listener, errorListener);</span>

<span class="nc" id="L211">        WordPress.requestQueue.add(request);</span>
<span class="nc" id="L212">    }</span>

    public interface FetchVideoThumbnailListener {
        void onResponse(boolean successful, String thumbnailUrl);
    }

    public interface VideoThumbnailUrlListener {
        void showThumbnail(String thumbnailUrl);
        void showPlaceholder();
        void cacheThumbnailUrl(String thumbnailUrl);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>