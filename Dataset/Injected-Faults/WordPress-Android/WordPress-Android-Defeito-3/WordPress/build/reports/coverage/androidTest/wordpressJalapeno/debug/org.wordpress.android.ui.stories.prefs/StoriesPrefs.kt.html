<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StoriesPrefs.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stories.prefs</a> &gt; <span class="el_source">StoriesPrefs.kt</span></div><h1>StoriesPrefs.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stories.prefs

import android.annotation.SuppressLint
import android.content.Context
import android.net.Uri
import androidx.preference.PreferenceManager
import com.wordpress.stories.compose.story.StoryFrameItem
import com.wordpress.stories.compose.story.StoryFrameItem.BackgroundSource.FileBackgroundSource
import com.wordpress.stories.compose.story.StoryFrameItem.BackgroundSource.UriBackgroundSource
import com.wordpress.stories.compose.story.StorySerializerUtils
import org.wordpress.android.fluxc.model.LocalOrRemoteId.LocalId
import org.wordpress.android.fluxc.model.LocalOrRemoteId.RemoteId
import javax.inject.Inject
import javax.inject.Singleton

<span class="fc" id="L16">@Singleton</span>
<span class="fc" id="L17">class StoriesPrefs @Inject constructor(</span>
<span class="fc" id="L18">    private val context: Context</span>
) {
    companion object {
        private const val KEY_STORIES_SLIDE_INCREMENTAL_ID = &quot;incremental_id&quot;
        private const val KEY_PREFIX_STORIES_SLIDE_ID = &quot;story_slide_id-&quot;
        private const val KEY_PREFIX_TEMP_MEDIA_ID = &quot;t-&quot;
        private const val KEY_PREFIX_LOCAL_MEDIA_ID = &quot;l-&quot;
        private const val KEY_PREFIX_REMOTE_MEDIA_ID = &quot;r-&quot;
    }

    private fun buildSlideKey(siteId: Long, mediaId: RemoteId): String {
<span class="nc" id="L29">        return KEY_PREFIX_STORIES_SLIDE_ID + siteId.toString() + &quot;-&quot; +</span>
<span class="nc" id="L30">                KEY_PREFIX_REMOTE_MEDIA_ID + mediaId.value.toString()</span>
    }

    private fun buildSlideKey(siteId: Long, mediaId: LocalId): String {
<span class="nc" id="L34">        return KEY_PREFIX_STORIES_SLIDE_ID + siteId.toString() + &quot;-&quot; +</span>
<span class="nc" id="L35">                KEY_PREFIX_LOCAL_MEDIA_ID + mediaId.value.toString()</span>
    }

    private fun buildSlideKey(siteId: Long, tempId: TempId): String {
<span class="nc" id="L39">        return KEY_PREFIX_STORIES_SLIDE_ID + siteId.toString() + &quot;-&quot; +</span>
<span class="nc" id="L40">                KEY_PREFIX_TEMP_MEDIA_ID + tempId.id</span>
    }

    @SuppressLint(&quot;ApplySharedPref&quot;)
    @Synchronized
    fun getNewIncrementalTempId(): Long {
<span class="nc" id="L46">        var currentIncrementalId = getIncrementalTempId()</span>
<span class="nc" id="L47">        currentIncrementalId++</span>
<span class="nc" id="L48">        val editor = PreferenceManager.getDefaultSharedPreferences(context).edit()</span>
<span class="nc" id="L49">        editor.putLong(KEY_STORIES_SLIDE_INCREMENTAL_ID, currentIncrementalId)</span>
<span class="nc" id="L50">        editor.commit()</span>
<span class="nc" id="L51">        return currentIncrementalId</span>
    }

    private fun getIncrementalTempId(): Long {
<span class="nc" id="L55">        return PreferenceManager.getDefaultSharedPreferences(context).getLong(</span>
<span class="nc" id="L56">                        KEY_STORIES_SLIDE_INCREMENTAL_ID,</span>
<span class="nc" id="L57">                        0</span>
                )
    }

    fun checkSlideIdExists(siteId: Long, mediaId: RemoteId): Boolean {
<span class="nc" id="L62">        val slideIdKey = buildSlideKey(siteId, mediaId)</span>
<span class="nc" id="L63">        return PreferenceManager.getDefaultSharedPreferences(context).contains(slideIdKey)</span>
    }

    private fun checkSlideIdExists(siteId: Long, tempId: TempId): Boolean {
<span class="nc" id="L67">        val slideIdKey = buildSlideKey(siteId, tempId)</span>
<span class="nc" id="L68">        return PreferenceManager.getDefaultSharedPreferences(context).contains(slideIdKey)</span>
    }

    private fun checkSlideIdExists(siteId: Long, localId: LocalId): Boolean {
<span class="nc" id="L72">        val slideIdKey = buildSlideKey(siteId, localId)</span>
<span class="nc" id="L73">        return PreferenceManager.getDefaultSharedPreferences(context).contains(slideIdKey)</span>
    }

    private fun checkSlideOriginalBackgroundMediaExists(siteId: Long, mediaId: RemoteId): Boolean {
<span class="nc" id="L77">        return checkSlideOriginalBackgroundMediaExists(getSlideWithRemoteId(siteId, mediaId))</span>
    }

    private fun checkSlideOriginalBackgroundMediaExists(siteId: Long, mediaId: TempId): Boolean {
<span class="nc" id="L81">        return checkSlideOriginalBackgroundMediaExists(getSlideWithTempId(siteId, mediaId))</span>
    }

    private fun checkSlideOriginalBackgroundMediaExists(siteId: Long, mediaId: LocalId): Boolean {
<span class="nc" id="L85">        return checkSlideOriginalBackgroundMediaExists(getSlideWithLocalId(siteId, mediaId))</span>
    }

    private fun checkSlideOriginalBackgroundMediaExists(storyFrameItem: StoryFrameItem?): Boolean {
<span class="nc bnc" id="L89" title="All 2 branches missed.">        storyFrameItem?.let { frame -&gt;</span>
            // now check the background media exists or is accessible on this device
<span class="nc" id="L91">            frame.source.let { source -&gt;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                if (source is FileBackgroundSource) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                    source.file?.let {</span>
<span class="nc" id="L94">                        return it.exists()</span>
<span class="nc" id="L95">                    } ?: return false</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                } else if (source is UriBackgroundSource) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                    source.contentUri?.let {</span>
<span class="nc" id="L98">                        return isUriAccessible(it)</span>
<span class="nc" id="L99">                    } ?: return false</span>
                }
<span class="nc" id="L101">            }</span>
<span class="nc" id="L102">        }</span>
<span class="nc" id="L103">        return false</span>
    }

    private fun isUriAccessible(uri: Uri): Boolean {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (uri.toString().startsWith(&quot;http&quot;)) {</span>
            // TODO: assume it'll be accessible - we'll figure out later
            // potentially force external download using MediaUtils.downloadExternalMedia() here to ensure
<span class="nc" id="L110">            return true</span>
        }
<span class="nc" id="L112">        try {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            context.contentResolver.openInputStream(uri)?.let {</span>
<span class="nc" id="L114">                it.close()</span>
<span class="nc" id="L115">                return true</span>
            }
<span class="nc" id="L117">        } catch (e: java.lang.Exception) {</span>
<span class="nc" id="L118">            e.printStackTrace()</span>
        }
<span class="nc" id="L120">        return false</span>
    }

    private fun saveSlide(slideIdKey: String, storySlideJson: String) {
<span class="nc" id="L124">        val editor = PreferenceManager.getDefaultSharedPreferences(context).edit()</span>
<span class="nc" id="L125">        editor.putString(slideIdKey, storySlideJson)</span>
<span class="nc" id="L126">        editor.apply()</span>
<span class="nc" id="L127">    }</span>

    fun isValidSlide(siteId: Long, mediaId: RemoteId): Boolean {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        return checkSlideIdExists(siteId, mediaId) &amp;&amp;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                checkSlideOriginalBackgroundMediaExists(siteId, mediaId)</span>
    }

    fun isValidSlide(siteId: Long, tempId: TempId): Boolean {
<span class="nc bnc" id="L135" title="All 2 branches missed.">        return checkSlideIdExists(siteId, tempId) &amp;&amp;</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                checkSlideOriginalBackgroundMediaExists(siteId, tempId)</span>
    }

    fun isValidSlide(siteId: Long, localId: LocalId): Boolean {
<span class="nc bnc" id="L140" title="All 2 branches missed.">        return checkSlideIdExists(siteId, localId) &amp;&amp;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                checkSlideOriginalBackgroundMediaExists(siteId, localId)</span>
    }

    private fun getSlideJson(slideIdKey: String): String? {
<span class="nc" id="L145">        return PreferenceManager.getDefaultSharedPreferences(context).getString(slideIdKey, null)</span>
    }

    fun getSlideWithRemoteId(siteId: Long, mediaId: RemoteId): StoryFrameItem? {
<span class="nc" id="L149">        val jsonSlide = getSlideJson(buildSlideKey(siteId, mediaId))</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        jsonSlide?.let {</span>
<span class="nc" id="L151">            return StorySerializerUtils.deserializeStoryFrameItem(jsonSlide)</span>
<span class="nc" id="L152">        } ?: return null</span>
    }

    fun getSlideWithLocalId(siteId: Long, mediaId: LocalId): StoryFrameItem? {
<span class="nc" id="L156">        val jsonSlide = getSlideJson(buildSlideKey(siteId, mediaId))</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        jsonSlide?.let {</span>
<span class="nc" id="L158">            return StorySerializerUtils.deserializeStoryFrameItem(jsonSlide)</span>
<span class="nc" id="L159">        } ?: return null</span>
    }

    fun getSlideWithTempId(siteId: Long, tempId: TempId): StoryFrameItem? {
<span class="nc" id="L163">        val jsonSlide = getSlideJson(buildSlideKey(siteId, tempId))</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        jsonSlide?.let {</span>
<span class="nc" id="L165">            return StorySerializerUtils.deserializeStoryFrameItem(jsonSlide)</span>
<span class="nc" id="L166">        } ?: return null</span>
    }

    fun saveSlideWithTempId(siteId: Long, tempId: TempId, storyFrameItem: StoryFrameItem) {
<span class="nc" id="L170">        val slideIdKey = buildSlideKey(siteId, tempId)</span>
<span class="nc" id="L171">        saveSlide(slideIdKey, StorySerializerUtils.serializeStoryFrameItem(storyFrameItem))</span>
<span class="nc" id="L172">    }</span>

    fun saveSlideWithLocalId(siteId: Long, mediaId: LocalId, storyFrameItem: StoryFrameItem) {
<span class="nc" id="L175">        val slideIdKey = buildSlideKey(siteId, mediaId)</span>
<span class="nc" id="L176">        saveSlide(slideIdKey, StorySerializerUtils.serializeStoryFrameItem(storyFrameItem))</span>
<span class="nc" id="L177">    }</span>

    fun saveSlideWithRemoteId(siteId: Long, mediaId: RemoteId, storyFrameItem: StoryFrameItem) {
<span class="nc" id="L180">        val slideIdKey = buildSlideKey(siteId, mediaId)</span>
<span class="nc" id="L181">        saveSlide(slideIdKey, StorySerializerUtils.serializeStoryFrameItem(storyFrameItem))</span>
<span class="nc" id="L182">    }</span>

    fun deleteSlideWithTempId(siteId: Long, tempId: TempId) {
<span class="nc" id="L185">        val slideIdKey = buildSlideKey(siteId, tempId)</span>
<span class="nc" id="L186">        val editor = PreferenceManager.getDefaultSharedPreferences(context).edit()</span>
<span class="nc" id="L187">        editor.remove(slideIdKey)</span>
<span class="nc" id="L188">        editor.apply()</span>
<span class="nc" id="L189">    }</span>

    fun deleteSlideWithLocalId(siteId: Long, mediaId: LocalId) {
<span class="nc" id="L192">        val slideIdKey = buildSlideKey(siteId, mediaId)</span>
<span class="nc" id="L193">        val editor = PreferenceManager.getDefaultSharedPreferences(context).edit()</span>
<span class="nc" id="L194">        editor.remove(slideIdKey)</span>
<span class="nc" id="L195">        editor.apply()</span>
<span class="nc" id="L196">    }</span>

    fun deleteSlideWithRemoteId(siteId: Long, mediaId: RemoteId) {
<span class="nc" id="L199">        val slideIdKey = buildSlideKey(siteId, mediaId)</span>
<span class="nc" id="L200">        PreferenceManager.getDefaultSharedPreferences(context).edit().apply {</span>
<span class="nc" id="L201">            remove(slideIdKey)</span>
<span class="nc" id="L202">            apply()</span>
<span class="nc" id="L203">        }</span>
<span class="nc" id="L204">    }</span>

    // Phase 2: this method is likely used after a first phase in which a local media which only has a temporary id has
    // then be replaced by a local id. At this point, we now have a remote Id and we can replace the local
    // media id with the remote media id.
    fun replaceLocalMediaIdKeyedSlideWithRemoteMediaIdKeyedSlide(
        localIdKey: Int,
        remoteIdKey: Long,
        localSiteId: Long
    ) {
        // look for the slide saved with the local id key (mediaFile.id), and re-convert to mediaId.
<span class="nc bnc" id="L215" title="All 2 branches missed.">        getSlideWithLocalId(</span>
<span class="nc" id="L216">                localSiteId,</span>
<span class="nc" id="L217">                LocalId(localIdKey)</span>
<span class="nc" id="L218">        )?.let {</span>
<span class="nc" id="L219">            it.id = remoteIdKey.toString() // update the StoryFrameItem id to hold the same value as the remote mediaID</span>
<span class="nc" id="L220">            saveSlideWithRemoteId(</span>
<span class="nc" id="L221">                    localSiteId,</span>
<span class="nc" id="L222">                    RemoteId(remoteIdKey), // use the new mediaId as key</span>
<span class="nc" id="L223">                    it</span>
            )
            // now delete the old entry
<span class="nc" id="L226">            deleteSlideWithLocalId(</span>
<span class="nc" id="L227">                    localSiteId,</span>
<span class="nc" id="L228">                    LocalId(localIdKey)</span>
            )
<span class="nc" id="L230">        }</span>
<span class="nc" id="L231">    }</span>

    // Phase 1: this method is likely used at the beginning when a local media which only has a temporary id needs now
    // to be assigned with a localMediaId. At a later point when the media is uploaded to the server, it will be
    // assigned a remote Id which will replace this localId.
    fun replaceTempMediaIdKeyedSlideWithLocalMediaIdKeyedSlide(
        tempId: TempId,
        localId: LocalId,
        localSiteId: Long
    ): StoryFrameItem? {
        // look for the slide saved with the local id key (mediaFile.id), and re-convert to mediaId.
<span class="nc bnc" id="L242" title="All 2 branches missed.">        getSlideWithTempId(</span>
<span class="nc" id="L243">                localSiteId,</span>
<span class="nc" id="L244">                tempId</span>
<span class="nc" id="L245">        )?.let {</span>
<span class="nc" id="L246">            it.id = localId.value.toString()</span>
<span class="nc" id="L247">            saveSlideWithLocalId(</span>
<span class="nc" id="L248">                    localSiteId,</span>
<span class="nc" id="L249">                    localId, // use the new localId as key</span>
<span class="nc" id="L250">                    it</span>
            )
            // now delete the old entry
<span class="nc" id="L253">            deleteSlideWithTempId(</span>
<span class="nc" id="L254">                    localSiteId,</span>
<span class="nc" id="L255">                    tempId</span>
            )
<span class="nc" id="L257">            return it</span>
        }
<span class="nc" id="L259">        return null</span>
    }

<span class="nc" id="L262">    data class TempId(val id: String)</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>