<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SiteSettingsFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs</a> &gt; <span class="el_source">SiteSettingsFragment.java</span></div><h1>SiteSettingsFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs;

import android.app.Activity;
import android.app.Dialog;
import android.app.DialogFragment;
import android.app.ProgressDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.res.Resources;
import android.os.Bundle;
import android.os.Handler;
import android.preference.EditTextPreference;
import android.preference.Preference;
import android.preference.PreferenceCategory;
import android.preference.PreferenceFragment;
import android.preference.PreferenceGroup;
import android.preference.PreferenceScreen;
import android.provider.ContactsContract;
import android.text.TextUtils;
import android.util.SparseBooleanArray;
import android.view.ActionMode;
import android.view.HapticFeedbackConstants;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.Window;
import android.view.WindowManager.LayoutParams;
import android.widget.AdapterView;
import android.widget.BaseAdapter;
import android.widget.EditText;
import android.widget.ListAdapter;
import android.widget.ListView;
import android.widget.NumberPicker.Formatter;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.collection.SparseArrayCompat;
import androidx.core.view.MenuItemCompat;
import androidx.core.view.ViewCompat;
import androidx.lifecycle.ViewModelProvider;
import androidx.recyclerview.widget.LinearLayoutManager;

import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.google.android.material.floatingactionbutton.FloatingActionButton;
import com.google.android.material.snackbar.Snackbar;

import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.text.StringEscapeUtils;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.jetbrains.annotations.NotNull;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.wordpress.android.BuildConfig;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.generated.SiteActionBuilder;
import org.wordpress.android.fluxc.model.SiteHomepageSettings.ShowOnFront;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.store.SiteStore.DeleteSiteError;
import org.wordpress.android.fluxc.store.SiteStore.OnSiteChanged;
import org.wordpress.android.support.ZendeskHelper;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.WPWebViewActivity;
import org.wordpress.android.ui.accounts.HelpActivity.Origin;
import org.wordpress.android.ui.bloggingreminders.BloggingReminderUtils;
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersViewModel;
import org.wordpress.android.ui.plans.PlansConstants;
import org.wordpress.android.ui.prefs.EditTextPreferenceWithValidation.ValidationType;
import org.wordpress.android.ui.prefs.SiteSettingsFormatDialog.FormatType;
import org.wordpress.android.ui.prefs.homepage.HomepageSettingsDialog;
import org.wordpress.android.ui.prefs.timezone.SiteSettingsTimezoneBottomSheet;
import org.wordpress.android.ui.utils.UiHelpers;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.extensions.ContextExtensionsKt;
import org.wordpress.android.util.HtmlUtils;
import org.wordpress.android.util.LocaleManager;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.UrlUtils;
import org.wordpress.android.util.ValidationUtils;
import org.wordpress.android.util.extensions.ViewExtensionsKt;
import org.wordpress.android.util.WPActivityUtils;
import org.wordpress.android.util.WPPrefUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils.BlockEditorEnabledSource;
import org.wordpress.android.util.config.BloggingPromptsFeatureConfig;
import org.wordpress.android.util.config.BloggingRemindersFeatureConfig;
import org.wordpress.android.util.config.ManageCategoriesFeatureConfig;
import org.wordpress.android.widgets.WPSnackbar;

import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import javax.inject.Inject;

import static org.wordpress.android.ui.prefs.WPComSiteSettings.supportsJetpackSiteAcceleratorSettings;

import kotlin.Triple;

/**
 * Allows interfacing with WordPress site settings. Works with WP.com and WP.org v4.5+ (pending).
 * &lt;p&gt;
 * Settings are synced automatically when local changes are made.
 */

<span class="nc" id="L124">public class SiteSettingsFragment extends PreferenceFragment</span>
        implements Preference.OnPreferenceChangeListener,
        Preference.OnPreferenceClickListener,
        AdapterView.OnItemLongClickListener,
        Dialog.OnDismissListener,
        SiteSettingsInterface.SiteSettingsListener,
        SiteSettingsTimezoneBottomSheet.TimezoneSelectionCallback {
    /**
     * When the user removes a site (by selecting Delete Site) the parent {@link Activity} result
     * is set to this value and {@link Activity#finish()} is invoked.
     */
    public static final int RESULT_BLOG_REMOVED = Activity.RESULT_FIRST_USER;

    /**
     * Provides the regex to identify domain HTTP(S) protocol and/or 'www' sub-domain.
     * &lt;p&gt;
     * Used to format user-facing {@link String}'s in certain preferences.
     */
    public static final String ADDRESS_FORMAT_REGEX = &quot;^(https?://(w{3})?|www\\.)&quot;;

    /**
     * url that points to wordpress.com purchases
     */
    public static final String WORDPRESS_PURCHASES_URL = &quot;https://wordpress.com/purchases&quot;;

    /**
     * url for redirecting free users to empty their sites (start over)
     */
    public static final String WORDPRESS_EMPTY_SITE_SUPPORT_URL = &quot;https://en.support.wordpress.com/empty-site/&quot;;

    /**
     * Used to move the Uncategorized category to the beginning of the category list.
     */
    private static final int UNCATEGORIZED_CATEGORY_ID = 1;

    private static final String TIMEZONE_BOTTOM_SHEET_TAG = &quot;timezone-dialog-tag&quot;;
    private static final String BLOGGING_REMINDERS_BOTTOM_SHEET_TAG = &quot;blogging-reminders-dialog-tag&quot;;

    /**
     * Request code used when creating the {@link RelatedPostsDialog}.
     */
    private static final int RELATED_POSTS_REQUEST_CODE = 1;
    private static final int THREADING_REQUEST_CODE = 2;
    private static final int PAGING_REQUEST_CODE = 3;
    private static final int CLOSE_AFTER_REQUEST_CODE = 4;
    private static final int MULTIPLE_LINKS_REQUEST_CODE = 5;
    private static final int DELETE_SITE_REQUEST_CODE = 6;
    private static final int DATE_FORMAT_REQUEST_CODE = 7;
    private static final int TIME_FORMAT_REQUEST_CODE = 8;
    private static final int POSTS_PER_PAGE_REQUEST_CODE = 9;

    private static final String DELETE_SITE_TAG = &quot;delete-site&quot;;
    private static final String PURCHASE_ORIGINAL_RESPONSE_KEY = &quot;originalResponse&quot;;
    private static final String PURCHASE_ACTIVE_KEY = &quot;active&quot;;
    private static final String ANALYTICS_ERROR_PROPERTY_KEY = &quot;error&quot;;

    private static final long FETCH_DELAY = 1000;

    @Inject AccountStore mAccountStore;
    @Inject SiteStore mSiteStore;
    @Inject Dispatcher mDispatcher;
    @Inject ZendeskHelper mZendeskHelper;
    @Inject ViewModelProvider.Factory mViewModelFactory;
    @Inject BloggingRemindersFeatureConfig mBloggingRemindersFeatureConfig;
    @Inject BloggingPromptsFeatureConfig mBloggingPromptsFeatureConfig;
    @Inject ManageCategoriesFeatureConfig mManageCategoriesFeatureConfig;
    @Inject UiHelpers mUiHelpers;

    private BloggingRemindersViewModel mBloggingRemindersViewModel;

    public SiteModel mSite;

    // Can interface with WP.com or WP.org
    public SiteSettingsInterface mSiteSettings;

    // Reference to the list of items being edited in the current list editor
    private List&lt;String&gt; mEditingList;

    // Used to ensure that settings are only fetched once throughout the lifecycle of the fragment
    private boolean mShouldFetch;

    // General settings
    private EditTextPreference mTitlePref;
    private EditTextPreference mTaglinePref;
    private EditTextPreference mAddressPref;
    private DetailListPreference mPrivacyPref;
    private DetailListPreference mLanguagePref;

    // Homepage settings
    private WPPreference mHomepagePref;

    // Account settings (NOTE: only for WP.org)
    private EditTextPreference mUsernamePref;
    private EditTextPreferenceWithValidation mPasswordPref;

    // Writing settings
    private WPSwitchPreference mGutenbergDefaultForNewPosts;
    private DetailListPreference mCategoryPref;
    private DetailListPreference mFormatPref;
    private WPPreference mDateFormatPref;
    private WPPreference mTimeFormatPref;
    private DetailListPreference mWeekStartPref;
    private Preference mRelatedPostsPref;
    private Preference mTagsPref;
    private Preference mTimezonePref;
    private Preference mBloggingRemindersPref;
    private Preference mPostsPerPagePref;
    private WPSwitchPreference mAmpPref;
    private Preference mCategoriesPref;

    // Media settings
    private EditTextPreference mSiteQuotaSpacePref;

    // Discussion settings preview
    private WPSwitchPreference mAllowCommentsPref;
    private WPSwitchPreference mSendPingbacksPref;
    private WPSwitchPreference mReceivePingbacksPref;

    // Discussion settings -&gt; Defaults for New Posts
    private WPSwitchPreference mAllowCommentsNested;
    private WPSwitchPreference mSendPingbacksNested;
    private WPSwitchPreference mReceivePingbacksNested;
    private PreferenceScreen mMorePreference;

    // Discussion settings -&gt; Comments
    private WPSwitchPreference mIdentityRequiredPreference;
    private WPSwitchPreference mUserAccountRequiredPref;
    private Preference mCloseAfterPref;
    private DetailListPreference mSortByPref;
    private Preference mThreadingPref;
    private Preference mPagingPref;
    private DetailListPreference mAllowlistPref;
    private Preference mMultipleLinksPref;
    private Preference mModerationHoldPref;
    private Preference mDenylistPref;

    // Advanced settings
    private Preference mStartOverPref;
    private Preference mExportSitePref;
    private Preference mDeleteSitePref;

    // Jetpack settings
    private PreferenceScreen mJpSecuritySettings;
    private WPSwitchPreference mJpMonitorActivePref;
    private WPSwitchPreference mJpMonitorEmailNotesPref;
    private WPSwitchPreference mJpMonitorWpNotesPref;
    private WPSwitchPreference mJpBruteForcePref;
    private WPPreference mJpAllowlistPref;
    private WPSwitchPreference mJpSsoPref;
    private WPSwitchPreference mJpMatchEmailPref;
    private WPSwitchPreference mJpUseTwoFactorPref;

    // Speed up settings
    private WPSwitchPreference mLazyLoadImages;
    private WPSwitchPreference mLazyLoadImagesNested;

    // Jetpack media settings
    private WPSwitchPreference mAdFreeVideoHosting;
    private WPSwitchPreference mAdFreeVideoHostingNested;

    // Jetpack search
    private WPSwitchPreference mImprovedSearch;

    private PreferenceScreen mJetpackPerformanceMoreSettings;
    // Site accelerator settings
    private PreferenceScreen mSiteAcceleratorSettings;
    private PreferenceScreen mSiteAcceleratorSettingsNested;
    private WPSwitchPreference mSiteAccelerator;
    private WPSwitchPreference mSiteAcceleratorNested;
    private WPSwitchPreference mServeImagesFromOurServers;
    private WPSwitchPreference mServeImagesFromOurServersNested;
    private WPSwitchPreference mServeStaticFilesFromOurServers;
    private WPSwitchPreference mServeStaticFilesFromOurServersNested;

<span class="nc" id="L298">    public boolean mEditingEnabled = true;</span>

    // Reference to the state of the fragment
<span class="nc" id="L301">    private boolean mIsFragmentPaused = false;</span>

    // Hold for Moderation and Denylist settings
    private Dialog mDialog;
    private ActionMode mActionMode;
    private MultiSelectRecyclerViewAdapter mAdapter;

    // Delete site
    private ProgressDialog mDeleteSiteProgressDialog;

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L313">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L314">        Activity activity = getActivity();</span>
<span class="nc" id="L315">        ((WordPress) activity.getApplication()).component().inject(this);</span>

        // make sure we have local site data and a network connection, otherwise finish activity
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(activity)) {</span>
<span class="nc" id="L319">            getActivity().finish();</span>
<span class="nc" id="L320">            return;</span>
        }

<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L324">            mSite = (SiteModel) getArguments().getSerializable(WordPress.SITE);</span>
        } else {
<span class="nc" id="L326">            mSite = (SiteModel) savedInstanceState.getSerializable(WordPress.SITE);</span>
        }

<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (mSite == null) {</span>
<span class="nc" id="L330">            ToastUtils.showToast(getActivity(), R.string.blog_not_found, ToastUtils.Duration.SHORT);</span>
<span class="nc" id="L331">            getActivity().finish();</span>
<span class="nc" id="L332">            return;</span>
        }

        // track successful settings screen access
<span class="nc" id="L336">        AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_ACCESSED, mSite);</span>

        // setup state to fetch remote settings
<span class="nc" id="L339">        mShouldFetch = true;</span>

        // initialize the appropriate settings interface (WP.com or WP.org)
<span class="nc" id="L342">        mSiteSettings = SiteSettingsInterface.getInterface(activity, mSite, this);</span>

<span class="nc" id="L344">        setRetainInstance(true);</span>
<span class="nc" id="L345">        addPreferencesFromResource();</span>

        // toggle which preferences are shown and set references
<span class="nc" id="L348">        initPreferences();</span>
<span class="nc" id="L349">    }</span>

    public void addPreferencesFromResource() {
<span class="nc" id="L352">        addPreferencesFromResource(R.xml.site_settings);</span>

        // add Disconnect option for Jetpack sites when running a debug build
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (shouldShowDisconnect()) {</span>
<span class="nc" id="L356">            PreferenceCategory parent =</span>
<span class="nc" id="L357">                    (PreferenceCategory) findPreference(getString(R.string.pref_key_site_discussion));</span>
<span class="nc" id="L358">            Preference disconnectPref = new Preference(getActivity());</span>
<span class="nc" id="L359">            disconnectPref.setTitle(getString(R.string.jetpack_disconnect_pref_title));</span>
<span class="nc" id="L360">            disconnectPref.setKey(getString(R.string.pref_key_site_disconnect));</span>
<span class="nc" id="L361">            disconnectPref.setOnPreferenceClickListener(preference -&gt; {</span>
<span class="nc" id="L362">                disconnectFromJetpack();</span>
<span class="nc" id="L363">                return true;</span>
            });
<span class="nc" id="L365">            parent.addPreference(disconnectPref);</span>
        }
<span class="nc" id="L367">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L371">        super.onPause();</span>
        // Locally save the site. mSite can be null after site deletion or site removal (.org sites)
<span class="nc" id="L373">        updateTitle();</span>
<span class="nc" id="L374">        mIsFragmentPaused = true;</span>
<span class="nc" id="L375">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L379">        super.onResume();</span>

        // Fragment#onResume() is called after FragmentActivity#onPostResume().
        // The latter is the most secure way of keeping track of the activity's state, and
        // avoid calls to commitAllowingStateLoss.
<span class="nc" id="L384">        mIsFragmentPaused = false;</span>

        // always load cached settings
<span class="nc" id="L387">        mSiteSettings.init(false);</span>

<span class="nc bnc" id="L389" title="All 2 branches missed.">        if (mShouldFetch) {</span>
<span class="nc" id="L390">            new Handler().postDelayed(() -&gt; {</span>
                // initialize settings with locally cached values, fetch remote on first pass
<span class="nc" id="L392">                mSiteSettings.init(true);</span>
<span class="nc" id="L393">            }, FETCH_DELAY);</span>
            // stop future calls from fetching remote settings
<span class="nc" id="L395">            mShouldFetch = false;</span>
        }
<span class="nc" id="L397">    }</span>

    @Override
    public void onDestroyView() {
<span class="nc" id="L401">        removeJetpackSecurityScreenToolbar();</span>
<span class="nc" id="L402">        mDispatcher.unregister(this);</span>
<span class="nc" id="L403">        super.onDestroyView();</span>
<span class="nc" id="L404">    }</span>

    @Override
    public void onDestroy() {
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (mSiteSettings != null) {</span>
<span class="nc" id="L409">            mSiteSettings.clear();</span>
        }
<span class="nc" id="L411">        super.onDestroy();</span>
<span class="nc" id="L412">    }</span>

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (data != null) {</span>
<span class="nc bnc" id="L417" title="All 9 branches missed.">            switch (requestCode) {</span>
                case RELATED_POSTS_REQUEST_CODE:
                    // data is null if user cancelled editing Related Posts settings
<span class="nc" id="L420">                    mSiteSettings.setShowRelatedPosts(data.getBooleanExtra(</span>
                            RelatedPostsDialog.SHOW_RELATED_POSTS_KEY, false));
<span class="nc" id="L422">                    mSiteSettings.setShowRelatedPostHeader(data.getBooleanExtra(</span>
                            RelatedPostsDialog.SHOW_HEADER_KEY, false));
<span class="nc" id="L424">                    mSiteSettings.setShowRelatedPostImages(data.getBooleanExtra(</span>
                            RelatedPostsDialog.SHOW_IMAGES_KEY, false));
<span class="nc" id="L426">                    onPreferenceChange(mRelatedPostsPref, mSiteSettings.getRelatedPostsDescription());</span>
<span class="nc" id="L427">                    break;</span>
                case THREADING_REQUEST_CODE:
<span class="nc" id="L429">                    int levels = data.getIntExtra(NumberPickerDialog.CUR_VALUE_KEY, -1);</span>
<span class="nc bnc" id="L430" title="All 4 branches missed.">                    mSiteSettings.setShouldThreadComments(levels &gt; 1 &amp;&amp; data.getBooleanExtra(</span>
                            NumberPickerDialog.SWITCH_ENABLED_KEY, false));
<span class="nc" id="L432">                    onPreferenceChange(mThreadingPref, levels);</span>
<span class="nc" id="L433">                    break;</span>
                case PAGING_REQUEST_CODE:
<span class="nc" id="L435">                    mSiteSettings.setShouldPageComments(data.getBooleanExtra(NumberPickerDialog.SWITCH_ENABLED_KEY,</span>
                            false));
<span class="nc" id="L437">                    onPreferenceChange(mPagingPref, data.getIntExtra(</span>
                            NumberPickerDialog.CUR_VALUE_KEY, -1));
<span class="nc" id="L439">                    break;</span>
                case CLOSE_AFTER_REQUEST_CODE:
<span class="nc" id="L441">                    mSiteSettings.setShouldCloseAfter(data.getBooleanExtra(NumberPickerDialog.SWITCH_ENABLED_KEY,</span>
                            false));
<span class="nc" id="L443">                    onPreferenceChange(mCloseAfterPref, data.getIntExtra(NumberPickerDialog.CUR_VALUE_KEY, -1));</span>
<span class="nc" id="L444">                    break;</span>
                case MULTIPLE_LINKS_REQUEST_CODE:
<span class="nc" id="L446">                    int numLinks = data.getIntExtra(NumberPickerDialog.CUR_VALUE_KEY, -1);</span>
<span class="nc bnc" id="L447" title="All 4 branches missed.">                    if (numLinks &lt; 0 || numLinks == mSiteSettings.getMultipleLinks()) {</span>
<span class="nc" id="L448">                        return;</span>
                    }
<span class="nc" id="L450">                    onPreferenceChange(mMultipleLinksPref, numLinks);</span>
<span class="nc" id="L451">                    break;</span>
                case DATE_FORMAT_REQUEST_CODE:
<span class="nc" id="L453">                    String dateFormatValue = data.getStringExtra(SiteSettingsFormatDialog.KEY_FORMAT_VALUE);</span>
<span class="nc" id="L454">                    setDateTimeFormatPref(FormatType.DATE_FORMAT, mDateFormatPref, dateFormatValue);</span>
<span class="nc" id="L455">                    onPreferenceChange(mDateFormatPref, dateFormatValue);</span>
<span class="nc" id="L456">                    break;</span>
                case TIME_FORMAT_REQUEST_CODE:
<span class="nc" id="L458">                    String timeFormatValue = data.getStringExtra(SiteSettingsFormatDialog.KEY_FORMAT_VALUE);</span>
<span class="nc" id="L459">                    setDateTimeFormatPref(FormatType.TIME_FORMAT, mTimeFormatPref, timeFormatValue);</span>
<span class="nc" id="L460">                    onPreferenceChange(mTimeFormatPref, timeFormatValue);</span>
<span class="nc" id="L461">                    break;</span>
                case POSTS_PER_PAGE_REQUEST_CODE:
<span class="nc" id="L463">                    int numPosts = data.getIntExtra(NumberPickerDialog.CUR_VALUE_KEY, -1);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">                    if (numPosts &gt; -1) {</span>
<span class="nc" id="L465">                        onPreferenceChange(mPostsPerPagePref, numPosts);</span>
                    }
<span class="nc" id="L467">                    break;</span>
            }
        } else {
<span class="nc bnc" id="L470" title="All 2 branches missed.">            if (requestCode == DELETE_SITE_REQUEST_CODE) {</span>
<span class="nc" id="L471">                deleteSite();</span>
            }
        }

<span class="nc" id="L475">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc" id="L476">    }</span>

    @Override
    public View onCreateView(@NonNull LayoutInflater inflater,
                             ViewGroup container,
                             Bundle savedInstanceState) {
        // use a wrapper to apply the Calypso theme

<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (getActivity().getActionBar() != null) {</span>
<span class="nc" id="L485">            getActivity().getActionBar().setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L486">            getActivity().getActionBar().setDisplayShowHomeEnabled(true);</span>
        }

<span class="nc" id="L489">        View view = super.onCreateView(inflater, container, savedInstanceState);</span>

<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (view != null) {</span>
<span class="nc" id="L492">            setupPreferenceList(view.findViewById(android.R.id.list), getResources());</span>
        }
<span class="nc" id="L494">        mDispatcher.register(this);</span>

<span class="nc" id="L496">        return view;</span>
    }

    @Override
    public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
<span class="nc" id="L501">        super.onViewCreated(view, savedInstanceState);</span>
<span class="nc" id="L502">        initBloggingReminders();</span>
<span class="nc" id="L503">    }</span>

    private AppCompatActivity getAppCompatActivity() {
<span class="nc" id="L506">        return (AppCompatActivity) getActivity();</span>
    }

    @Override
    public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L511">        removeJetpackSecurityScreenToolbar();</span>
<span class="nc" id="L512">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L513">        outState.putSerializable(WordPress.SITE, mSite);</span>
<span class="nc" id="L514">        setupMorePreferenceScreen();</span>
<span class="nc" id="L515">        setupJetpackSecurityScreen();</span>
<span class="nc" id="L516">    }</span>

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L520">        super.onActivityCreated(savedInstanceState);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L522">            setupMorePreferenceScreen();</span>
<span class="nc" id="L523">            setupJetpackSecurityScreen();</span>

<span class="nc" id="L525">            SiteSettingsTimezoneBottomSheet bottomSheet =</span>
<span class="nc" id="L526">                    (SiteSettingsTimezoneBottomSheet) (getAppCompatActivity())</span>
<span class="nc" id="L527">                            .getSupportFragmentManager().findFragmentByTag(TIMEZONE_BOTTOM_SHEET_TAG);</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">            if (bottomSheet != null) {</span>
<span class="nc" id="L529">                bottomSheet.setTimezoneSettingCallback(this);</span>
            }
        }
<span class="nc" id="L532">    }</span>

    @Override
    public boolean onPreferenceTreeClick(PreferenceScreen screen, Preference preference) {
<span class="nc" id="L536">        super.onPreferenceTreeClick(screen, preference);</span>

        // More preference selected, style the Discussion screen
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (preference == mMorePreference) {</span>
            // track user accessing the full Discussion settings screen
<span class="nc" id="L541">            AnalyticsUtils.trackWithSiteDetails(</span>
                    AnalyticsTracker.Stat.SITE_SETTINGS_ACCESSED_MORE_SETTINGS, mSite);

<span class="nc" id="L544">            return setupMorePreferenceScreen();</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">        } else if (preference == mJpSecuritySettings) {</span>
<span class="nc" id="L546">            AnalyticsTracker.track(Stat.SITE_SETTINGS_JETPACK_SECURITY_SETTINGS_VIEWED);</span>
<span class="nc" id="L547">            setupJetpackSecurityScreen();</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">        } else if (preference == mSiteAcceleratorSettings) {</span>
<span class="nc" id="L549">            setupSiteAcceleratorScreen();</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">        } else if (preference == mSiteAcceleratorSettingsNested) {</span>
<span class="nc" id="L551">            setupNestedSiteAcceleratorScreen();</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">        } else if (preference == mJetpackPerformanceMoreSettings) {</span>
<span class="nc" id="L553">            setupJetpackMoreSettingsScreen();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">        } else if (preference == findPreference(getString(R.string.pref_key_site_start_over_screen))) {</span>
<span class="nc" id="L555">            Dialog dialog = ((PreferenceScreen) preference).getDialog();</span>
<span class="nc bnc" id="L556" title="All 4 branches missed.">            if (mSite == null || dialog == null) {</span>
<span class="nc" id="L557">                return false;</span>
            }

<span class="nc" id="L560">            AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_START_OVER_ACCESSED, mSite);</span>

<span class="nc bnc" id="L562" title="All 2 branches missed.">            if (mSite.getHasFreePlan()) {</span>
                // Don't show the start over detail screen for free users, instead show the support page
<span class="nc" id="L564">                dialog.dismiss();</span>
<span class="nc" id="L565">                WPWebViewActivity.openUrlByUsingGlobalWPCOMCredentials(getActivity(), WORDPRESS_EMPTY_SITE_SUPPORT_URL);</span>
            } else {
<span class="nc" id="L567">                setupPreferenceList(dialog.findViewById(android.R.id.list), getResources());</span>
<span class="nc" id="L568">                String title = getString(R.string.start_over);</span>
<span class="nc" id="L569">                WPActivityUtils.addToolbarToDialog(this, dialog, title);</span>
            }
<span class="nc bnc" id="L571" title="All 2 branches missed.">        } else if (preference == mDateFormatPref) {</span>
<span class="nc" id="L572">            showDateOrTimeFormatDialog(FormatType.DATE_FORMAT);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        } else if (preference == mTimeFormatPref) {</span>
<span class="nc" id="L574">            showDateOrTimeFormatDialog(FormatType.TIME_FORMAT);</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">        } else if (preference == mPostsPerPagePref) {</span>
<span class="nc" id="L576">            showPostsPerPageDialog();</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">        } else if (preference == mTimezonePref) {</span>
<span class="nc" id="L578">            setupTimezoneBottomSheet();</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">        } else if (preference == mBloggingRemindersPref) {</span>
<span class="nc" id="L580">            setupBloggingRemindersBottomSheet();</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">        } else if (preference == mHomepagePref) {</span>
<span class="nc" id="L582">            showHomepageSettings();</span>
        }

<span class="nc" id="L585">        return false;</span>
    }

    @Override
    public boolean onPreferenceClick(Preference preference) {
<span class="nc bnc" id="L590" title="All 2 branches missed.">        if (preference == mRelatedPostsPref) {</span>
<span class="nc" id="L591">            showRelatedPostsDialog();</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">        } else if (preference == mMultipleLinksPref) {</span>
<span class="nc" id="L593">            showMultipleLinksDialog();</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">        } else if (preference == mModerationHoldPref) {</span>
<span class="nc" id="L595">            mEditingList = mSiteSettings.getModerationKeys();</span>
<span class="nc" id="L596">            showListEditorDialog(R.string.site_settings_moderation_hold_title,</span>
                    R.string.site_settings_hold_for_moderation_description);
<span class="nc bnc" id="L598" title="All 2 branches missed.">        } else if (preference == mDenylistPref) {</span>
<span class="nc" id="L599">            mEditingList = mSiteSettings.getDenylistKeys();</span>
<span class="nc" id="L600">            showListEditorDialog(R.string.site_settings_denylist_title,</span>
                    R.string.site_settings_denylist_description);
<span class="nc bnc" id="L602" title="All 2 branches missed.">        } else if (preference == mJpAllowlistPref) {</span>
<span class="nc" id="L603">            AnalyticsTracker.track(Stat.SITE_SETTINGS_JETPACK_ALLOWLISTED_IPS_VIEWED);</span>
<span class="nc" id="L604">            mEditingList = mSiteSettings.getJetpackAllowlistKeys();</span>
<span class="nc" id="L605">            showListEditorDialog(R.string.jetpack_brute_force_allowlist_title,</span>
                    R.string.site_settings_jetpack_allowlist_description);
<span class="nc bnc" id="L607" title="All 2 branches missed.">        } else if (preference == mStartOverPref) {</span>
<span class="nc" id="L608">            handleStartOver();</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">        } else if (preference == mCloseAfterPref) {</span>
<span class="nc" id="L610">            showCloseAfterDialog();</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        } else if (preference == mPagingPref) {</span>
<span class="nc" id="L612">            showPagingDialog();</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">        } else if (preference == mThreadingPref) {</span>
<span class="nc" id="L614">            showThreadingDialog();</span>
<span class="nc bnc" id="L615" title="All 4 branches missed.">        } else if (preference == mCategoryPref || preference == mFormatPref) {</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">            return !shouldShowListPreference((DetailListPreference) preference);</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">        } else if (preference == mExportSitePref) {</span>
<span class="nc" id="L618">            showExportContentDialog();</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">        } else if (preference == mDeleteSitePref) {</span>
<span class="nc" id="L620">            AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_DELETE_SITE_ACCESSED, mSite);</span>
<span class="nc" id="L621">            requestPurchasesForDeletionCheck();</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        } else if (preference == mTagsPref) {</span>
<span class="nc" id="L623">            SiteSettingsTagListActivity.showTagList(getActivity(), mSite);</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">        } else if (preference == mCategoriesPref) {</span>
<span class="nc" id="L625">            ActivityLauncher.showCategoriesList(getActivity(), mSite);</span>
        } else {
<span class="nc" id="L627">            return false;</span>
        }

<span class="nc" id="L630">        return true;</span>
    }

    private void disconnectFromJetpack() {
<span class="nc" id="L634">        MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L635">        builder.setMessage(R.string.jetpack_disconnect_confirmation_message);</span>
<span class="nc" id="L636">        builder.setPositiveButton(R.string.jetpack_disconnect_confirm, (dialog, which) -&gt; {</span>
<span class="nc" id="L637">            String url = String.format(Locale.US, &quot;jetpack-blogs/%d/mine/delete&quot;, mSite.getSiteId());</span>
<span class="nc" id="L638">            WordPress.getRestClientUtilsV1_1().post(url, response -&gt; {</span>
<span class="nc" id="L639">                AppLog.v(AppLog.T.API, &quot;Successfully disconnected Jetpack site&quot;);</span>
<span class="nc" id="L640">                ToastUtils.showToast(getActivity(), R.string.jetpack_disconnect_success_toast);</span>
<span class="nc" id="L641">                mDispatcher.dispatch(SiteActionBuilder.newRemoveSiteAction(mSite));</span>
<span class="nc" id="L642">                mSite = null;</span>
<span class="nc" id="L643">            }, error -&gt; {</span>
<span class="nc" id="L644">                AppLog.e(AppLog.T.API, &quot;Error disconnecting Jetpack site&quot;);</span>
<span class="nc" id="L645">                ToastUtils.showToast(getActivity(), R.string.jetpack_disconnect_error_toast);</span>
<span class="nc" id="L646">            });</span>
<span class="nc" id="L647">        });</span>
<span class="nc" id="L648">        builder.setNegativeButton(android.R.string.cancel, null);</span>
<span class="nc" id="L649">        builder.show();</span>
<span class="nc" id="L650">    }</span>

    @Override
    public boolean onPreferenceChange(Preference preference, Object newValue) {
<span class="nc bnc" id="L654" title="All 4 branches missed.">        if (newValue == null || !mEditingEnabled) {</span>
<span class="nc" id="L655">            return false;</span>
        }

<span class="nc bnc" id="L658" title="All 2 branches missed.">        if (preference == mJpAllowlistPref) {</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">            if (mJpAllowlistPref.getSummary() != mSiteSettings.getJetpackProtectAllowlistSummary()) {</span>
<span class="nc" id="L660">                AnalyticsTracker.track(Stat.SITE_SETTINGS_JETPACK_ALLOWLISTED_IPS_CHANGED);</span>
            }
<span class="nc" id="L662">            mJpAllowlistPref.setSummary(mSiteSettings.getJetpackProtectAllowlistSummary());</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">        } else if (preference == mJpMonitorActivePref) {</span>
<span class="nc" id="L664">            mJpMonitorActivePref.setChecked((Boolean) newValue);</span>
<span class="nc" id="L665">            mSiteSettings.enableJetpackMonitor((Boolean) newValue);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">        } else if (preference == mJpMonitorEmailNotesPref) {</span>
<span class="nc" id="L667">            mJpMonitorEmailNotesPref.setChecked((Boolean) newValue);</span>
<span class="nc" id="L668">            mSiteSettings.enableJetpackMonitorEmailNotifications((Boolean) newValue);</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">        } else if (preference == mJpMonitorWpNotesPref) {</span>
<span class="nc" id="L670">            mJpMonitorWpNotesPref.setChecked((Boolean) newValue);</span>
<span class="nc" id="L671">            mSiteSettings.enableJetpackMonitorWpNotifications((Boolean) newValue);</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">        } else if (preference == mJpBruteForcePref) {</span>
<span class="nc" id="L673">            mJpBruteForcePref.setChecked((Boolean) newValue);</span>
<span class="nc" id="L674">            mSiteSettings.enableJetpackProtect((Boolean) newValue);</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        } else if (preference == mJpSsoPref) {</span>
<span class="nc" id="L676">            mJpSsoPref.setChecked((Boolean) newValue);</span>
<span class="nc" id="L677">            mSiteSettings.enableJetpackSso((Boolean) newValue);</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">        } else if (preference == mJpMatchEmailPref) {</span>
<span class="nc" id="L679">            mJpMatchEmailPref.setChecked((Boolean) newValue);</span>
<span class="nc" id="L680">            mSiteSettings.enableJetpackSsoMatchEmail((Boolean) newValue);</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        } else if (preference == mJpUseTwoFactorPref) {</span>
<span class="nc" id="L682">            mJpUseTwoFactorPref.setChecked((Boolean) newValue);</span>
<span class="nc" id="L683">            mSiteSettings.enableJetpackSsoTwoFactor((Boolean) newValue);</span>
<span class="nc bnc" id="L684" title="All 4 branches missed.">        } else if (preference == mLazyLoadImages || preference == mLazyLoadImagesNested) {</span>
<span class="nc" id="L685">            setLazyLoadImagesChecked((Boolean) newValue);</span>
<span class="nc bnc" id="L686" title="All 4 branches missed.">        } else if (preference == mAdFreeVideoHosting || preference == mAdFreeVideoHostingNested) {</span>
<span class="nc" id="L687">            setAdFreeHostingChecked((Boolean) newValue);</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">        } else if (preference == mImprovedSearch) {</span>
<span class="nc" id="L689">            Boolean checked = (Boolean) newValue;</span>
<span class="nc" id="L690">            mImprovedSearch.setChecked(checked);</span>
<span class="nc" id="L691">            mSiteSettings.enableImprovedSearch(checked);</span>
<span class="nc" id="L692">            mSiteSettings.setJetpackSearchEnabled(checked);</span>
<span class="nc bnc" id="L693" title="All 4 branches missed.">        } else if (preference == mSiteAccelerator || preference == mSiteAcceleratorNested) {</span>
<span class="nc" id="L694">            Boolean checked = (Boolean) newValue;</span>
<span class="nc" id="L695">            setServeImagesFromOurServersChecked(checked);</span>
<span class="nc" id="L696">            setServeStaticFilesFromOurServersChecked(checked);</span>
<span class="nc" id="L697">            updateSiteAccelerator();</span>
<span class="nc bnc" id="L698" title="All 4 branches missed.">        } else if (preference == mServeImagesFromOurServers || preference == mServeImagesFromOurServersNested) {</span>
<span class="nc" id="L699">            Boolean checked = (Boolean) newValue;</span>
<span class="nc" id="L700">            setServeImagesFromOurServersChecked(checked);</span>
<span class="nc" id="L701">            updateSiteAccelerator();</span>
<span class="nc bnc" id="L702" title="All 4 branches missed.">        } else if (preference == mServeStaticFilesFromOurServers</span>
                   || preference == mServeStaticFilesFromOurServersNested) {
<span class="nc" id="L704">            Boolean checked = (Boolean) newValue;</span>
<span class="nc" id="L705">            setServeStaticFilesFromOurServersChecked(checked);</span>
<span class="nc" id="L706">            updateSiteAccelerator();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">        } else if (preference == mTitlePref) {</span>
<span class="nc" id="L708">            mSiteSettings.setTitle(newValue.toString());</span>
<span class="nc" id="L709">            changeEditTextPreferenceValue(mTitlePref, mSiteSettings.getTitle());</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">        } else if (preference == mTaglinePref) {</span>
<span class="nc" id="L711">            mSiteSettings.setTagline(newValue.toString());</span>
<span class="nc" id="L712">            changeEditTextPreferenceValue(mTaglinePref, mSiteSettings.getTagline());</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">        } else if (preference == mAddressPref) {</span>
<span class="nc" id="L714">            mSiteSettings.setAddress(newValue.toString());</span>
<span class="nc" id="L715">            changeEditTextPreferenceValue(mAddressPref, mSiteSettings.getAddress());</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">        } else if (preference == mLanguagePref) {</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">            if (!mSiteSettings.setLanguageCode(newValue.toString())) {</span>
<span class="nc" id="L718">                AppLog.w(AppLog.T.SETTINGS,</span>
<span class="nc" id="L719">                        &quot;Unknown language code &quot; + newValue.toString() + &quot; selected in Site Settings.&quot;);</span>
<span class="nc" id="L720">                ToastUtils.showToast(getActivity(), R.string.site_settings_unknown_language_code_error);</span>
            }
<span class="nc" id="L722">            changeLanguageValue(mSiteSettings.getLanguageCode());</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">        } else if (preference == mPrivacyPref) {</span>
<span class="nc" id="L724">            mSiteSettings.setPrivacy(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L725">            setDetailListPreferenceValue(mPrivacyPref,</span>
<span class="nc" id="L726">                    String.valueOf(mSiteSettings.getPrivacy()),</span>
<span class="nc" id="L727">                    mSiteSettings.getPrivacyDescription());</span>
<span class="nc bnc" id="L728" title="All 4 branches missed.">        } else if (preference == mAllowCommentsPref || preference == mAllowCommentsNested) {</span>
<span class="nc" id="L729">            setAllowComments((Boolean) newValue);</span>
<span class="nc bnc" id="L730" title="All 4 branches missed.">        } else if (preference == mSendPingbacksPref || preference == mSendPingbacksNested) {</span>
<span class="nc" id="L731">            setSendPingbacks((Boolean) newValue);</span>
<span class="nc bnc" id="L732" title="All 4 branches missed.">        } else if (preference == mReceivePingbacksPref || preference == mReceivePingbacksNested) {</span>
<span class="nc" id="L733">            setReceivePingbacks((Boolean) newValue);</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">        } else if (preference == mCloseAfterPref) {</span>
<span class="nc" id="L735">            mSiteSettings.setCloseAfter(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L736">            mCloseAfterPref.setSummary(mSiteSettings.getCloseAfterDescription());</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">        } else if (preference == mSortByPref) {</span>
<span class="nc" id="L738">            mSiteSettings.setCommentSorting(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L739">            setDetailListPreferenceValue(mSortByPref,</span>
<span class="nc" id="L740">                    newValue.toString(),</span>
<span class="nc" id="L741">                    mSiteSettings.getSortingDescription());</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">        } else if (preference == mThreadingPref) {</span>
<span class="nc" id="L743">            mSiteSettings.setThreadingLevels(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L744">            mThreadingPref.setSummary(mSiteSettings.getThreadingDescription());</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">        } else if (preference == mPagingPref) {</span>
<span class="nc" id="L746">            mSiteSettings.setPagingCount(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L747">            mPagingPref.setSummary(mSiteSettings.getPagingDescription());</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">        } else if (preference == mIdentityRequiredPreference) {</span>
<span class="nc" id="L749">            mSiteSettings.setIdentityRequired((Boolean) newValue);</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">        } else if (preference == mUserAccountRequiredPref) {</span>
<span class="nc" id="L751">            mSiteSettings.setUserAccountRequired((Boolean) newValue);</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">        } else if (preference == mAllowlistPref) {</span>
<span class="nc" id="L753">            updateAllowlistSettings(Integer.parseInt(newValue.toString()));</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">        } else if (preference == mMultipleLinksPref) {</span>
<span class="nc" id="L755">            mSiteSettings.setMultipleLinks(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L756">            String s = StringUtils.getQuantityString(getActivity(), R.string.site_settings_multiple_links_summary_zero,</span>
                    R.string.site_settings_multiple_links_summary_one,
                    R.string.site_settings_multiple_links_summary_other,
<span class="nc" id="L759">                    mSiteSettings.getMultipleLinks());</span>
<span class="nc" id="L760">            mMultipleLinksPref.setSummary(s);</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">        } else if (preference == mUsernamePref) {</span>
<span class="nc" id="L762">            mSiteSettings.setUsername(newValue.toString());</span>
<span class="nc" id="L763">            changeEditTextPreferenceValue(mUsernamePref, mSiteSettings.getUsername());</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">        } else if (preference == mPasswordPref) {</span>
<span class="nc" id="L765">            mSiteSettings.setPassword(newValue.toString());</span>
<span class="nc" id="L766">            ToastUtils.showToast(getActivity(), R.string.site_settings_password_updated, ToastUtils.Duration.SHORT);</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">        } else if (preference == mCategoryPref) {</span>
<span class="nc" id="L768">            mSiteSettings.setDefaultCategory(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L769">            setDetailListPreferenceValue(mCategoryPref,</span>
<span class="nc" id="L770">                    newValue.toString(),</span>
<span class="nc" id="L771">                    mSiteSettings.getDefaultCategoryForDisplay());</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">        } else if (preference == mFormatPref) {</span>
<span class="nc" id="L773">            mSiteSettings.setDefaultFormat(newValue.toString());</span>
<span class="nc" id="L774">            setDetailListPreferenceValue(mFormatPref,</span>
<span class="nc" id="L775">                    newValue.toString(),</span>
<span class="nc" id="L776">                    mSiteSettings.getDefaultPostFormatDisplay());</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">        } else if (preference == mRelatedPostsPref) {</span>
<span class="nc" id="L778">            mRelatedPostsPref.setSummary(newValue.toString());</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">        } else if (preference == mModerationHoldPref) {</span>
<span class="nc" id="L780">            mModerationHoldPref.setSummary(mSiteSettings.getModerationHoldDescription());</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">        } else if (preference == mDenylistPref) {</span>
<span class="nc" id="L782">            mDenylistPref.setSummary(mSiteSettings.getDenylistDescription());</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">        } else if (preference == mWeekStartPref) {</span>
<span class="nc" id="L784">            mSiteSettings.setStartOfWeek(newValue.toString());</span>
<span class="nc" id="L785">            mWeekStartPref.setValue(newValue.toString());</span>
<span class="nc" id="L786">            mWeekStartPref.setSummary(mWeekStartPref.getEntry());</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">        } else if (preference == mDateFormatPref) {</span>
<span class="nc" id="L788">            mSiteSettings.setDateFormat(newValue.toString());</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">        } else if (preference == mTimeFormatPref) {</span>
<span class="nc" id="L790">            mSiteSettings.setTimeFormat(newValue.toString());</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">        } else if (preference == mPostsPerPagePref) {</span>
<span class="nc" id="L792">            mPostsPerPagePref.setSummary(newValue.toString());</span>
<span class="nc" id="L793">            mSiteSettings.setPostsPerPage(Integer.parseInt(newValue.toString()));</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">        } else if (preference == mAmpPref) {</span>
<span class="nc" id="L795">            mSiteSettings.setAmpEnabled((Boolean) newValue);</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">        } else if (preference == mTimezonePref) {</span>
<span class="nc" id="L797">            setTimezonePref(newValue.toString());</span>
<span class="nc" id="L798">            mSiteSettings.setTimezone(newValue.toString());</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">        } else if (preference == mGutenbergDefaultForNewPosts) {</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">            if (((Boolean) newValue)) {</span>
<span class="nc" id="L801">                SiteUtils.enableBlockEditor(mDispatcher, mSite);</span>
            } else {
<span class="nc" id="L803">                SiteUtils.disableBlockEditor(mDispatcher, mSite);</span>
            }
<span class="nc" id="L805">            AnalyticsUtils.trackWithSiteDetails(</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">                    ((Boolean) newValue) ? Stat.EDITOR_GUTENBERG_ENABLED : Stat.EDITOR_GUTENBERG_DISABLED,</span>
<span class="nc" id="L807">                    mSite, BlockEditorEnabledSource.VIA_SITE_SETTINGS.asPropertyMap());</span>
            // we need to refresh metadata as gutenberg_enabled is now part of the user data
<span class="nc" id="L809">            AnalyticsUtils.refreshMetadata(mAccountStore, mSiteStore);</span>
        } else {
<span class="nc" id="L811">            return false;</span>
        }

<span class="nc" id="L814">        mSiteSettings.saveSettings();</span>

<span class="nc" id="L816">        return true;</span>
    }

    @Override
    public boolean onItemLongClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
<span class="nc" id="L821">        ListView listView = (ListView) parent;</span>
<span class="nc" id="L822">        ListAdapter listAdapter = listView.getAdapter();</span>
<span class="nc" id="L823">        Object obj = listAdapter.getItem(position);</span>

<span class="nc bnc" id="L825" title="All 2 branches missed.">        if (obj != null) {</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">            if (obj instanceof View.OnLongClickListener) {</span>
<span class="nc" id="L827">                View.OnLongClickListener longListener = (View.OnLongClickListener) obj;</span>
<span class="nc" id="L828">                return longListener.onLongClick(view);</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">            } else if (obj instanceof PreferenceHint) {</span>
<span class="nc" id="L830">                PreferenceHint hintObj = (PreferenceHint) obj;</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                if (hintObj.hasHint()) {</span>
<span class="nc" id="L832">                    HashMap&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L833">                    properties.put(&quot;hint_shown&quot;, hintObj.getHint());</span>
<span class="nc" id="L834">                    AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_HINT_TOAST_SHOWN, mSite,</span>
                            properties);
<span class="nc" id="L836">                    ToastUtils.showToast(getActivity(), hintObj.getHint(), ToastUtils.Duration.SHORT);</span>
                }
<span class="nc" id="L838">                return true;</span>
            }
        }

<span class="nc" id="L842">        return false;</span>
    }

    @Override
    public void onDismiss(DialogInterface dialog) {
<span class="nc bnc" id="L847" title="All 2 branches missed.">        if (mEditingList == mSiteSettings.getModerationKeys()) {</span>
<span class="nc" id="L848">            onPreferenceChange(mModerationHoldPref, mEditingList.size());</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">        } else if (mEditingList == mSiteSettings.getDenylistKeys()) {</span>
<span class="nc" id="L850">            onPreferenceChange(mDenylistPref, mEditingList.size());</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">        } else if (mEditingList == mSiteSettings.getJetpackAllowlistKeys()) {</span>
<span class="nc" id="L852">            onPreferenceChange(mJpAllowlistPref, mEditingList.size());</span>
        }
<span class="nc" id="L854">        mEditingList = null;</span>
<span class="nc" id="L855">    }</span>

    @Override
    public void onSaveError(Exception error) {
<span class="nc bnc" id="L859" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L860">            return;</span>
        }
<span class="nc" id="L862">        ToastUtils.showToast(getActivity(), R.string.error_post_remote_site_settings);</span>
<span class="nc" id="L863">        getActivity().finish();</span>
<span class="nc" id="L864">    }</span>

    @Override
    public void onFetchError(Exception error) {
<span class="nc bnc" id="L868" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L869">            return;</span>
        }
<span class="nc" id="L871">        ToastUtils.showToast(getActivity(), R.string.error_fetch_remote_site_settings);</span>
<span class="nc" id="L872">        getActivity().finish();</span>
<span class="nc" id="L873">    }</span>

    @Override
    public void onSettingsUpdated() {
<span class="nc bnc" id="L877" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L878">            setPreferencesFromSiteSettings();</span>
        }
<span class="nc" id="L880">    }</span>

    @Override
    public void onSettingsSaved() {
<span class="nc" id="L884">        updateTitle();</span>
<span class="nc" id="L885">        mDispatcher.dispatch(SiteActionBuilder.newFetchSiteAction(mSite));</span>
<span class="nc" id="L886">    }</span>

    private void updateTitle() {
<span class="nc bnc" id="L889" title="All 2 branches missed.">        if (mSite != null) {</span>
<span class="nc" id="L890">            SiteModel updatedSite = mSiteStore.getSiteByLocalId(mSite.getId());</span>
            // updatedSite can be null after site deletion or site removal (.org sites)
<span class="nc bnc" id="L892" title="All 2 branches missed.">            if (updatedSite != null) {</span>
<span class="nc" id="L893">                updatedSite.setName(mSiteSettings.getTitle());</span>
                // Locally save the site
<span class="nc" id="L895">                mDispatcher.dispatch(SiteActionBuilder.newUpdateSiteAction(updatedSite));</span>
            }
        }
<span class="nc" id="L898">    }</span>

    @Override
    public void onCredentialsValidated(Exception error) {
<span class="nc bnc" id="L902" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L903">            return;</span>
        }
<span class="nc bnc" id="L905" title="All 2 branches missed.">        if (error != null) {</span>
<span class="nc" id="L906">            ToastUtils.showToast(WordPress.getContext(), R.string.username_or_password_incorrect);</span>
        }
<span class="nc" id="L908">    }</span>

    private void setupPreferenceList(ListView prefList, Resources res) {
<span class="nc bnc" id="L911" title="All 4 branches missed.">        if (prefList == null || res == null) {</span>
<span class="nc" id="L912">            return;</span>
        }

        // customize list dividers
<span class="nc" id="L916">        prefList.setDivider(ContextExtensionsKt.getDrawableFromAttribute(getActivity(), android.R.attr.listDivider));</span>
<span class="nc" id="L917">        prefList.setDividerHeight(res.getDimensionPixelSize(R.dimen.site_settings_divider_height));</span>
        // handle long clicks on preferences to display hints
<span class="nc" id="L919">        prefList.setOnItemLongClickListener(this);</span>
        // remove footer divider bar
<span class="nc" id="L921">        prefList.setFooterDividersEnabled(false);</span>
<span class="nc" id="L922">        prefList.setOverscrollFooter(res.getDrawable(android.R.color.transparent));</span>
<span class="nc" id="L923">        ViewCompat.setNestedScrollingEnabled(prefList, true);</span>
<span class="nc" id="L924">    }</span>

    /**
     * Helper method to retrieve {@link Preference} references and initialize any data.
     */
    public void initPreferences() {
<span class="nc" id="L930">        mTitlePref = (EditTextPreference) getChangePref(R.string.pref_key_site_title);</span>
<span class="nc" id="L931">        mTaglinePref = (EditTextPreference) getChangePref(R.string.pref_key_site_tagline);</span>
<span class="nc" id="L932">        mAddressPref = (EditTextPreference) getChangePref(R.string.pref_key_site_address);</span>
<span class="nc" id="L933">        mPrivacyPref = (DetailListPreference) getChangePref(R.string.pref_key_site_visibility);</span>
<span class="nc" id="L934">        mLanguagePref = (DetailListPreference) getChangePref(R.string.pref_key_site_language);</span>
<span class="nc" id="L935">        mUsernamePref = (EditTextPreference) getChangePref(R.string.pref_key_site_username);</span>
<span class="nc" id="L936">        mPasswordPref = (EditTextPreferenceWithValidation) getChangePref(R.string.pref_key_site_password);</span>
<span class="nc" id="L937">        mPasswordPref.setValidationType(ValidationType.PASSWORD_SELF_HOSTED);</span>
<span class="nc" id="L938">        mPasswordPref.setDialogMessage(R.string.site_settings_update_password_message);</span>
<span class="nc" id="L939">        mPasswordPref.setOnPreferenceChangeListener(this);</span>
<span class="nc" id="L940">        mCategoryPref = (DetailListPreference) getChangePref(R.string.pref_key_site_category);</span>
<span class="nc" id="L941">        mTagsPref = getClickPref(R.string.pref_key_site_tags);</span>
<span class="nc" id="L942">        mFormatPref = (DetailListPreference) getChangePref(R.string.pref_key_site_format);</span>
<span class="nc" id="L943">        mAllowCommentsPref = (WPSwitchPreference) getChangePref(R.string.pref_key_site_allow_comments);</span>
<span class="nc" id="L944">        mAllowCommentsNested = (WPSwitchPreference) getChangePref(R.string.pref_key_site_allow_comments_nested);</span>
<span class="nc" id="L945">        mSendPingbacksPref = (WPSwitchPreference) getChangePref(R.string.pref_key_site_send_pingbacks);</span>
<span class="nc" id="L946">        mSendPingbacksNested = (WPSwitchPreference) getChangePref(R.string.pref_key_site_send_pingbacks_nested);</span>
<span class="nc" id="L947">        mReceivePingbacksPref = (WPSwitchPreference) getChangePref(R.string.pref_key_site_receive_pingbacks);</span>
<span class="nc" id="L948">        mReceivePingbacksNested = (WPSwitchPreference) getChangePref(R.string.pref_key_site_receive_pingbacks_nested);</span>
<span class="nc" id="L949">        mIdentityRequiredPreference = (WPSwitchPreference) getChangePref(R.string.pref_key_site_identity_required);</span>
<span class="nc" id="L950">        mUserAccountRequiredPref = (WPSwitchPreference) getChangePref(R.string.pref_key_site_user_account_required);</span>
<span class="nc" id="L951">        mSortByPref = (DetailListPreference) getChangePref(R.string.pref_key_site_sort_by);</span>
<span class="nc" id="L952">        mAllowlistPref = (DetailListPreference) getChangePref(R.string.pref_key_site_allowlist);</span>
<span class="nc" id="L953">        mMorePreference = (PreferenceScreen) getClickPref(R.string.pref_key_site_more_discussion);</span>
<span class="nc" id="L954">        mRelatedPostsPref = getClickPref(R.string.pref_key_site_related_posts);</span>
<span class="nc" id="L955">        mCloseAfterPref = getClickPref(R.string.pref_key_site_close_after);</span>
<span class="nc" id="L956">        mPagingPref = getClickPref(R.string.pref_key_site_paging);</span>
<span class="nc" id="L957">        mThreadingPref = getClickPref(R.string.pref_key_site_threading);</span>
<span class="nc" id="L958">        mMultipleLinksPref = getClickPref(R.string.pref_key_site_multiple_links);</span>
<span class="nc" id="L959">        mModerationHoldPref = getClickPref(R.string.pref_key_site_moderation_hold);</span>
<span class="nc" id="L960">        mDenylistPref = getClickPref(R.string.pref_key_site_denylist);</span>
<span class="nc" id="L961">        mStartOverPref = getClickPref(R.string.pref_key_site_start_over);</span>
<span class="nc" id="L962">        mExportSitePref = getClickPref(R.string.pref_key_site_export_site);</span>
<span class="nc" id="L963">        mDeleteSitePref = getClickPref(R.string.pref_key_site_delete_site);</span>
<span class="nc" id="L964">        mJpSecuritySettings = (PreferenceScreen) getClickPref(R.string.pref_key_jetpack_security_screen);</span>
<span class="nc" id="L965">        mJpMonitorActivePref = (WPSwitchPreference) getChangePref(R.string.pref_key_jetpack_monitor_uptime);</span>
<span class="nc" id="L966">        mJpMonitorEmailNotesPref =</span>
<span class="nc" id="L967">                (WPSwitchPreference) getChangePref(R.string.pref_key_jetpack_send_email_notifications);</span>
<span class="nc" id="L968">        mJpMonitorWpNotesPref = (WPSwitchPreference) getChangePref(R.string.pref_key_jetpack_send_wp_notifications);</span>
<span class="nc" id="L969">        mJpSsoPref = (WPSwitchPreference) getChangePref(R.string.pref_key_jetpack_allow_wpcom_sign_in);</span>
<span class="nc" id="L970">        mJpBruteForcePref = (WPSwitchPreference) getChangePref(R.string.pref_key_jetpack_prevent_brute_force);</span>
<span class="nc" id="L971">        mJpMatchEmailPref = (WPSwitchPreference) getChangePref(R.string.pref_key_jetpack_match_via_email);</span>
<span class="nc" id="L972">        mJpUseTwoFactorPref = (WPSwitchPreference) getChangePref(R.string.pref_key_jetpack_require_two_factor);</span>
<span class="nc" id="L973">        mJpAllowlistPref = (WPPreference) getClickPref(R.string.pref_key_jetpack_brute_force_allowlist);</span>
<span class="nc" id="L974">        mWeekStartPref = (DetailListPreference) getChangePref(R.string.pref_key_site_week_start);</span>
<span class="nc" id="L975">        mDateFormatPref = (WPPreference) getChangePref(R.string.pref_key_site_date_format);</span>
<span class="nc" id="L976">        mTimeFormatPref = (WPPreference) getChangePref(R.string.pref_key_site_time_format);</span>
<span class="nc" id="L977">        mPostsPerPagePref = getClickPref(R.string.pref_key_site_posts_per_page);</span>
<span class="nc" id="L978">        mTimezonePref = getClickPref(R.string.pref_key_site_timezone);</span>
<span class="nc" id="L979">        mBloggingRemindersPref = getClickPref(R.string.pref_key_blogging_reminders);</span>
<span class="nc" id="L980">        mHomepagePref = (WPPreference) getChangePref(R.string.pref_key_homepage_settings);</span>
<span class="nc" id="L981">        updateHomepageSummary();</span>
<span class="nc" id="L982">        mAmpPref = (WPSwitchPreference) getChangePref(R.string.pref_key_site_amp);</span>
<span class="nc" id="L983">        mSiteQuotaSpacePref = (EditTextPreference) getChangePref(R.string.pref_key_site_quota_space);</span>
<span class="nc" id="L984">        sortLanguages();</span>
<span class="nc" id="L985">        mGutenbergDefaultForNewPosts =</span>
<span class="nc" id="L986">                (WPSwitchPreference) getChangePref(R.string.pref_key_gutenberg_default_for_new_posts);</span>
<span class="nc" id="L987">        mGutenbergDefaultForNewPosts.setChecked(SiteUtils.isBlockEditorDefaultForNewPost(mSite));</span>

<span class="nc" id="L989">        mSiteAcceleratorSettings = (PreferenceScreen) getClickPref(R.string.pref_key_site_accelerator_settings);</span>
<span class="nc" id="L990">        mSiteAcceleratorSettingsNested =</span>
<span class="nc" id="L991">                (PreferenceScreen) getClickPref(R.string.pref_key_site_accelerator_settings_nested);</span>
<span class="nc" id="L992">        mSiteAccelerator = (WPSwitchPreference) getChangePref(R.string.pref_key_site_accelerator);</span>
<span class="nc" id="L993">        mSiteAcceleratorNested = (WPSwitchPreference) getChangePref(R.string.pref_key_site_accelerator_nested);</span>
<span class="nc" id="L994">        mServeImagesFromOurServers =</span>
<span class="nc" id="L995">                (WPSwitchPreference) getChangePref(R.string.pref_key_serve_images_from_our_servers);</span>
<span class="nc" id="L996">        mServeImagesFromOurServersNested =</span>
<span class="nc" id="L997">                (WPSwitchPreference) getChangePref(R.string.pref_key_serve_images_from_our_servers_nested);</span>
<span class="nc" id="L998">        mServeStaticFilesFromOurServers =</span>
<span class="nc" id="L999">                (WPSwitchPreference) getChangePref(R.string.pref_key_serve_static_files_from_our_servers);</span>
<span class="nc" id="L1000">        mServeStaticFilesFromOurServersNested =</span>
<span class="nc" id="L1001">                (WPSwitchPreference) getChangePref(R.string.pref_key_serve_static_files_from_our_servers_nested);</span>

<span class="nc" id="L1003">        mLazyLoadImages = (WPSwitchPreference) getChangePref(R.string.pref_key_lazy_load_images);</span>
<span class="nc" id="L1004">        mLazyLoadImagesNested = (WPSwitchPreference) getChangePref(R.string.pref_key_lazy_load_images_nested);</span>

<span class="nc" id="L1006">        mAdFreeVideoHosting = (WPSwitchPreference) getChangePref(R.string.pref_key_ad_free_video_hosting);</span>
<span class="nc" id="L1007">        mAdFreeVideoHostingNested = (WPSwitchPreference) getChangePref(R.string.pref_key_ad_free_video_hosting_nested);</span>

<span class="nc" id="L1009">        mImprovedSearch = (WPSwitchPreference) getChangePref(R.string.pref_key_improved_search);</span>

<span class="nc" id="L1011">        mJetpackPerformanceMoreSettings =</span>
<span class="nc" id="L1012">                (PreferenceScreen) getClickPref(R.string.pref_key_jetpack_performance_more_settings);</span>
<span class="nc" id="L1013">        mCategoriesPref = getClickPref(R.string.pref_key_site_categories);</span>

<span class="nc" id="L1015">        boolean isAccessedViaWPComRest = SiteUtils.isAccessedViaWPComRest(mSite);</span>

        // .com sites hide the Account category, self-hosted sites hide the Related Posts preference
<span class="nc bnc" id="L1018" title="All 2 branches missed.">        if (!isAccessedViaWPComRest) {</span>
            // self-hosted, non-jetpack site
<span class="nc" id="L1020">            removeNonSelfHostedPreferences();</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">        } else if (mSite.isJetpackConnected()) {</span>
            // jetpack site
<span class="nc" id="L1023">            removeNonJetpackPreferences();</span>
        } else {
            // wp.com site
<span class="nc" id="L1026">            removeNonWPComPreferences();</span>
        }

<span class="nc bnc" id="L1029" title="All 2 branches missed.">        if (!mSite.isUsingWpComRestApi()) {</span>
<span class="nc" id="L1030">            WPPrefUtils.removePreference(this, R.string.pref_key_homepage, R.string.pref_key_homepage_settings);</span>
        }

        // hide Admin options depending of capabilities on this site
<span class="nc bnc" id="L1034" title="All 6 branches missed.">        if ((!isAccessedViaWPComRest &amp;&amp; !mSite.isSelfHostedAdmin())</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">            || (isAccessedViaWPComRest &amp;&amp; !mSite.getHasCapabilityManageOptions())) {</span>
<span class="nc" id="L1036">            hideAdminRequiredPreferences();</span>
        }

        // hide site accelerator jetpack settings if plugin version &lt; 5.8
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        if (!supportsJetpackSiteAcceleratorSettings(mSite)</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">            &amp;&amp; mSite.getPlanId() != PlansConstants.BUSINESS_PLAN_ID) {</span>
<span class="nc" id="L1042">            removeJetpackSiteAcceleratorSettings();</span>
        }
<span class="nc bnc" id="L1044" title="All 4 branches missed.">        if (!mSite.isJetpackConnected() || (mSite.getPlanId() != PlansConstants.JETPACK_BUSINESS_PLAN_ID</span>
<span class="nc bnc" id="L1045" title="All 2 branches missed.">                                            &amp;&amp; mSite.getPlanId() != PlansConstants.JETPACK_PREMIUM_PLAN_ID)) {</span>
<span class="nc" id="L1046">            removeJetpackMediaSettings();</span>
        }

        // Simple WPCom Sites now always default to Gutenberg Editor
<span class="nc bnc" id="L1050" title="All 2 branches missed.">        if (SiteUtils.alwaysDefaultToGutenberg(mSite)) {</span>
<span class="nc" id="L1051">            removeEditorPreferences();</span>
        }

        // Hide &quot;Manage&quot; Categories if feature is not enabled
<span class="nc bnc" id="L1055" title="All 2 branches missed.">        if (!mManageCategoriesFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L1056">            removeCategoriesPreference();</span>
        }
<span class="nc" id="L1058">    }</span>

    private void updateHomepageSummary() {
<span class="nc bnc" id="L1061" title="All 2 branches missed.">        if (mSite.isUsingWpComRestApi()) {</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">            if (mSite.getShowOnFront() != null) {</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">                if (mSite.getShowOnFront().equals(ShowOnFront.POSTS.getValue())) {</span>
<span class="nc" id="L1064">                    mHomepagePref.setSummary(R.string.site_settings_classic_blog);</span>
                } else {
<span class="nc" id="L1066">                    mHomepagePref.setSummary(R.string.site_settings_static_homepage);</span>
                }
            }
        } else {
<span class="nc" id="L1070">            WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_homepage_settings);</span>
        }
<span class="nc" id="L1072">    }</span>

    private void setupJetpackSearch() {
<span class="nc bnc" id="L1075" title="All 4 branches missed.">        boolean isJetpackBusiness = mSite != null &amp;&amp; mSite.isJetpackConnected()</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">                                    &amp;&amp; mSite.getPlanId() == PlansConstants.JETPACK_BUSINESS_PLAN_ID;</span>
<span class="nc bnc" id="L1077" title="All 4 branches missed.">        if (isJetpackBusiness || mSiteSettings.getJetpackSearchSupported()) {</span>
<span class="nc" id="L1078">            mImprovedSearch</span>
<span class="nc bnc" id="L1079" title="All 4 branches missed.">                    .setChecked(mSiteSettings.isImprovedSearchEnabled() || mSiteSettings.getJetpackSearchEnabled());</span>
        } else {
<span class="nc" id="L1081">            removeJetpackSearchSettings();</span>
        }
<span class="nc" id="L1083">    }</span>

    public void setEditingEnabled(boolean enabled) {
        // excludes mAddressPref, mMorePreference, mJpSecuritySettings
<span class="nc" id="L1087">        final Preference[] editablePreference = {</span>
                mTitlePref, mTaglinePref, mPrivacyPref, mLanguagePref, mUsernamePref,
                mPasswordPref, mCategoryPref, mCategoriesPref, mTagsPref, mFormatPref, mAllowCommentsPref,
                mAllowCommentsNested, mSendPingbacksPref, mSendPingbacksNested, mReceivePingbacksPref,
                mReceivePingbacksNested, mIdentityRequiredPreference, mUserAccountRequiredPref,
                mSortByPref, mAllowlistPref, mRelatedPostsPref, mCloseAfterPref, mPagingPref,
                mThreadingPref, mMultipleLinksPref, mModerationHoldPref, mDenylistPref, mWeekStartPref,
                mDateFormatPref, mTimeFormatPref, mTimezonePref, mBloggingRemindersPref, mPostsPerPagePref, mAmpPref,
                mDeleteSitePref, mJpMonitorActivePref, mJpMonitorEmailNotesPref, mJpSsoPref,
                mJpMonitorWpNotesPref, mJpBruteForcePref, mJpAllowlistPref, mJpMatchEmailPref, mJpUseTwoFactorPref,
                mGutenbergDefaultForNewPosts, mHomepagePref
        };

<span class="nc bnc" id="L1100" title="All 2 branches missed.">        for (Preference preference : editablePreference) {</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">            if (preference != null) {</span>
<span class="nc" id="L1102">                preference.setEnabled(enabled);</span>
            }
        }

<span class="nc" id="L1106">        mEditingEnabled = enabled;</span>
<span class="nc" id="L1107">    }</span>

    private void showPostsPerPageDialog() {
<span class="nc" id="L1110">        Bundle args = new Bundle();</span>
<span class="nc" id="L1111">        args.putBoolean(NumberPickerDialog.SHOW_SWITCH_KEY, false);</span>
<span class="nc" id="L1112">        args.putString(NumberPickerDialog.TITLE_KEY, getString(R.string.site_settings_posts_per_page_title));</span>
<span class="nc" id="L1113">        args.putInt(NumberPickerDialog.MIN_VALUE_KEY, 1);</span>
<span class="nc" id="L1114">        args.putInt(NumberPickerDialog.MAX_VALUE_KEY, getResources().getInteger(R.integer.posts_per_page_limit));</span>
<span class="nc" id="L1115">        args.putInt(NumberPickerDialog.CUR_VALUE_KEY, mSiteSettings.getPostsPerPage());</span>
<span class="nc" id="L1116">        showNumberPickerDialog(args, POSTS_PER_PAGE_REQUEST_CODE, &quot;posts-per-page-dialog&quot;);</span>
<span class="nc" id="L1117">    }</span>

    private void showRelatedPostsDialog() {
<span class="nc" id="L1120">        DialogFragment relatedPosts = new RelatedPostsDialog();</span>
<span class="nc" id="L1121">        Bundle args = new Bundle();</span>
<span class="nc" id="L1122">        args.putBoolean(RelatedPostsDialog.SHOW_RELATED_POSTS_KEY, mSiteSettings.getShowRelatedPosts());</span>
<span class="nc" id="L1123">        args.putBoolean(RelatedPostsDialog.SHOW_HEADER_KEY, mSiteSettings.getShowRelatedPostHeader());</span>
<span class="nc" id="L1124">        args.putBoolean(RelatedPostsDialog.SHOW_IMAGES_KEY, mSiteSettings.getShowRelatedPostImages());</span>
<span class="nc" id="L1125">        relatedPosts.setArguments(args);</span>
<span class="nc" id="L1126">        relatedPosts.setTargetFragment(this, RELATED_POSTS_REQUEST_CODE);</span>
<span class="nc" id="L1127">        relatedPosts.show(getFragmentManager(), &quot;related-posts&quot;);</span>
<span class="nc" id="L1128">    }</span>

    private void showNumberPickerDialog(Bundle args, int requestCode, String tag) {
<span class="nc" id="L1131">        showNumberPickerDialog(args, requestCode, tag, null);</span>
<span class="nc" id="L1132">    }</span>

    private void showNumberPickerDialog(Bundle args, int requestCode, String tag, Formatter format) {
<span class="nc" id="L1135">        NumberPickerDialog dialog = new NumberPickerDialog();</span>
<span class="nc" id="L1136">        dialog.setNumberFormat(format);</span>
<span class="nc" id="L1137">        dialog.setArguments(args);</span>
<span class="nc" id="L1138">        dialog.setTargetFragment(this, requestCode);</span>
<span class="nc" id="L1139">        dialog.show(getFragmentManager(), tag);</span>
<span class="nc" id="L1140">    }</span>

    private void showPagingDialog() {
<span class="nc" id="L1143">        Bundle args = new Bundle();</span>
<span class="nc" id="L1144">        args.putBoolean(NumberPickerDialog.SHOW_SWITCH_KEY, true);</span>
<span class="nc" id="L1145">        args.putBoolean(NumberPickerDialog.SWITCH_ENABLED_KEY, mSiteSettings.getShouldPageComments());</span>
<span class="nc" id="L1146">        args.putString(NumberPickerDialog.SWITCH_TITLE_KEY, getString(R.string.site_settings_paging_title));</span>
<span class="nc" id="L1147">        args.putString(NumberPickerDialog.SWITCH_DESC_KEY, getString(R.string.site_settings_paging_dialog_description));</span>
<span class="nc" id="L1148">        args.putString(NumberPickerDialog.TITLE_KEY, getString(R.string.site_settings_paging_title));</span>
<span class="nc" id="L1149">        args.putString(NumberPickerDialog.HEADER_TEXT_KEY, getString(R.string.site_settings_paging_dialog_header));</span>
<span class="nc" id="L1150">        args.putInt(NumberPickerDialog.MIN_VALUE_KEY, 1);</span>
<span class="nc" id="L1151">        args.putInt(NumberPickerDialog.MAX_VALUE_KEY, getResources().getInteger(R.integer.paging_limit));</span>
<span class="nc" id="L1152">        args.putInt(NumberPickerDialog.CUR_VALUE_KEY, mSiteSettings.getPagingCount());</span>
<span class="nc" id="L1153">        showNumberPickerDialog(args, PAGING_REQUEST_CODE, &quot;paging-dialog&quot;);</span>
<span class="nc" id="L1154">    }</span>

    private void showThreadingDialog() {
<span class="nc" id="L1157">        Bundle args = new Bundle();</span>
<span class="nc" id="L1158">        args.putBoolean(NumberPickerDialog.SHOW_SWITCH_KEY, true);</span>
<span class="nc" id="L1159">        args.putBoolean(NumberPickerDialog.SWITCH_ENABLED_KEY, mSiteSettings.getShouldThreadComments());</span>
<span class="nc" id="L1160">        args.putString(NumberPickerDialog.SWITCH_TITLE_KEY, getString(R.string.site_settings_threading_title));</span>
<span class="nc" id="L1161">        args.putString(NumberPickerDialog.SWITCH_DESC_KEY,</span>
<span class="nc" id="L1162">                getString(R.string.site_settings_threading_dialog_description));</span>
<span class="nc" id="L1163">        args.putString(NumberPickerDialog.TITLE_KEY, getString(R.string.site_settings_threading_title));</span>
<span class="nc" id="L1164">        args.putString(NumberPickerDialog.HEADER_TEXT_KEY, getString(R.string.site_settings_threading_dialog_header));</span>
<span class="nc" id="L1165">        args.putInt(NumberPickerDialog.MIN_VALUE_KEY, 2);</span>
<span class="nc" id="L1166">        args.putInt(NumberPickerDialog.MAX_VALUE_KEY, getResources().getInteger(R.integer.threading_limit));</span>
<span class="nc" id="L1167">        args.putInt(NumberPickerDialog.CUR_VALUE_KEY, mSiteSettings.getThreadingLevels());</span>
<span class="nc" id="L1168">        showNumberPickerDialog(args, THREADING_REQUEST_CODE, &quot;threading-dialog&quot;,</span>
<span class="nc" id="L1169">                value -&gt; mSiteSettings.getThreadingDescriptionForLevel(value));</span>
<span class="nc" id="L1170">    }</span>

    private void showExportContentDialog() {
<span class="nc" id="L1173">        MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L1174">        builder.setTitle(R.string.export_your_content);</span>
<span class="nc" id="L1175">        String email = mAccountStore.getAccount().getEmail();</span>
<span class="nc" id="L1176">        builder.setMessage(getString(R.string.export_your_content_message, email));</span>
<span class="nc" id="L1177">        builder.setPositiveButton(R.string.site_settings_export_content_title, (dialog, which) -&gt; {</span>
<span class="nc" id="L1178">            AnalyticsUtils.trackWithSiteDetails(Stat.SITE_SETTINGS_EXPORT_SITE_REQUESTED, mSite);</span>
<span class="nc" id="L1179">            exportSite();</span>
<span class="nc" id="L1180">        });</span>
<span class="nc" id="L1181">        builder.setNegativeButton(R.string.cancel, null);</span>

<span class="nc" id="L1183">        builder.show();</span>
<span class="nc" id="L1184">        AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_EXPORT_SITE_ACCESSED, mSite);</span>
<span class="nc" id="L1185">    }</span>

    private void showDateOrTimeFormatDialog(@NonNull FormatType formatType) {
        String formatString =
<span class="nc bnc" id="L1189" title="All 2 branches missed.">                formatType == FormatType.DATE_FORMAT ? mSiteSettings.getDateFormat() : mSiteSettings.getTimeFormat();</span>
<span class="nc" id="L1190">        SiteSettingsFormatDialog dialog = SiteSettingsFormatDialog.newInstance(formatType, formatString);</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">        int requestCode = formatType == FormatType.DATE_FORMAT ? DATE_FORMAT_REQUEST_CODE : TIME_FORMAT_REQUEST_CODE;</span>
<span class="nc" id="L1192">        dialog.setTargetFragment(this, requestCode);</span>
<span class="nc" id="L1193">        dialog.show(getFragmentManager(), &quot;format-dialog-tag&quot;);</span>
<span class="nc" id="L1194">    }</span>

    private void setupTimezoneBottomSheet() {
<span class="nc bnc" id="L1197" title="All 4 branches missed.">        if (mTimezonePref == null || !isAdded()) {</span>
<span class="nc" id="L1198">            return;</span>
        }

<span class="nc" id="L1201">        SiteSettingsTimezoneBottomSheet bottomSheet = SiteSettingsTimezoneBottomSheet.newInstance();</span>
<span class="nc" id="L1202">        bottomSheet.setTimezoneSettingCallback(this);</span>
<span class="nc" id="L1203">        bottomSheet.show((getAppCompatActivity()).getSupportFragmentManager(), TIMEZONE_BOTTOM_SHEET_TAG);</span>
<span class="nc" id="L1204">    }</span>

    private void initBloggingReminders() {
<span class="nc bnc" id="L1207" title="All 4 branches missed.">        if (mBloggingRemindersPref == null || !isAdded()) {</span>
<span class="nc" id="L1208">            return;</span>
        }

<span class="nc bnc" id="L1211" title="All 2 branches missed.">        if (!mBloggingRemindersFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L1212">            removeBloggingRemindersSettings();</span>
        } else {
<span class="nc bnc" id="L1214" title="All 2 branches missed.">            if (mBloggingPromptsFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L1215">                mBloggingRemindersPref.setTitle(R.string.site_settings_blogging_reminders_and_prompts_title);</span>
            }

<span class="nc" id="L1218">            mBloggingRemindersViewModel = new ViewModelProvider(getAppCompatActivity(), mViewModelFactory)</span>
<span class="nc" id="L1219">                    .get(BloggingRemindersViewModel.class);</span>
<span class="nc" id="L1220">            BloggingReminderUtils.observeBottomSheet(</span>
<span class="nc" id="L1221">                    mBloggingRemindersViewModel.isBottomSheetShowing(),</span>
<span class="nc" id="L1222">                    getAppCompatActivity(),</span>
                    BLOGGING_REMINDERS_BOTTOM_SHEET_TAG,
<span class="nc" id="L1224">                    () -&gt; getAppCompatActivity().getSupportFragmentManager()</span>
            );
<span class="nc" id="L1226">            mBloggingRemindersViewModel.getBlogSettingsUiState(mSite.getId()).observe(getAppCompatActivity(), s -&gt; {</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">                if (mBloggingRemindersPref != null) {</span>
<span class="nc" id="L1228">                    CharSequence summary = mUiHelpers.getTextOfUiString(getActivity(), s);</span>
<span class="nc" id="L1229">                    mBloggingRemindersPref.setSummary(summary);</span>
                }
<span class="nc" id="L1231">            });</span>
        }
<span class="nc" id="L1233">    }</span>

    private void setupBloggingRemindersBottomSheet() {
<span class="nc bnc" id="L1236" title="All 4 branches missed.">        if (mBloggingRemindersPref == null || !isAdded()) {</span>
<span class="nc" id="L1237">            return;</span>
        }
<span class="nc" id="L1239">        mBloggingRemindersViewModel.onBlogSettingsItemClicked(mSite.getId());</span>
<span class="nc" id="L1240">    }</span>

    private void showHomepageSettings() {
<span class="nc" id="L1243">        HomepageSettingsDialog homepageSettingsDialog = HomepageSettingsDialog.Companion.newInstance(mSite);</span>
<span class="nc" id="L1244">        homepageSettingsDialog</span>
<span class="nc" id="L1245">                .show((getAppCompatActivity()).getSupportFragmentManager(), &quot;homepage-settings-dialog-tag&quot;);</span>
<span class="nc" id="L1246">    }</span>

    private void dismissProgressDialog(ProgressDialog progressDialog) {
<span class="nc bnc" id="L1249" title="All 4 branches missed.">        if (progressDialog != null &amp;&amp; progressDialog.isShowing()) {</span>
            try {
<span class="nc" id="L1251">                progressDialog.dismiss();</span>
<span class="nc" id="L1252">            } catch (IllegalArgumentException e) {</span>
                // dialog doesn't exist
<span class="nc" id="L1254">            }</span>
        }
<span class="nc" id="L1256">    }</span>

    private void requestPurchasesForDeletionCheck() {
<span class="nc" id="L1259">        final ProgressDialog progressDialog =</span>
<span class="nc" id="L1260">                ProgressDialog.show(getActivity(), &quot;&quot;, getString(R.string.checking_purchases), true, false);</span>
<span class="nc" id="L1261">        AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_DELETE_SITE_PURCHASES_REQUESTED, mSite);</span>
<span class="nc" id="L1262">        WordPress.getRestClientUtils().getSitePurchases(mSite.getSiteId(), response -&gt; {</span>
<span class="nc" id="L1263">            dismissProgressDialog(progressDialog);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">            if (isAdded()) {</span>
<span class="nc" id="L1265">                showPurchasesOrDeleteSiteDialog(response);</span>
            }
<span class="nc" id="L1267">        }, error -&gt; {</span>
<span class="nc" id="L1268">            dismissProgressDialog(progressDialog);</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">            if (isAdded()) {</span>
<span class="nc" id="L1270">                ToastUtils.showToast(getActivity(), getString(R.string.purchases_request_error));</span>
<span class="nc" id="L1271">                AppLog.e(AppLog.T.API,</span>
<span class="nc" id="L1272">                        &quot;Error occurred while requesting purchases for deletion check: &quot; + error.toString());</span>
            }
<span class="nc" id="L1274">        });</span>
<span class="nc" id="L1275">    }</span>

    private void showPurchasesOrDeleteSiteDialog(JSONObject response) {
        try {
<span class="nc" id="L1279">            JSONArray purchases = response.getJSONArray(PURCHASE_ORIGINAL_RESPONSE_KEY);</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">            if (hasActivePurchases(purchases)) {</span>
<span class="nc" id="L1281">                showPurchasesDialog();</span>
            } else {
<span class="nc" id="L1283">                showDeleteSiteWarningDialog();</span>
            }
<span class="nc" id="L1285">        } catch (JSONException e) {</span>
<span class="nc" id="L1286">            AppLog.e(AppLog.T.API, &quot;Error occurred while trying to delete site: &quot; + e.toString());</span>
<span class="nc" id="L1287">        }</span>
<span class="nc" id="L1288">    }</span>

    private void showPurchasesDialog() {
<span class="nc" id="L1291">        MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L1292">        builder.setTitle(R.string.premium_upgrades_title);</span>
<span class="nc" id="L1293">        builder.setMessage(R.string.premium_upgrades_message);</span>
<span class="nc" id="L1294">        builder.setPositiveButton(R.string.show_purchases, (dialog, which) -&gt; {</span>
<span class="nc" id="L1295">            AnalyticsUtils.trackWithSiteDetails(</span>
                    Stat.SITE_SETTINGS_DELETE_SITE_PURCHASES_SHOW_CLICKED, mSite);
<span class="nc" id="L1297">            WPWebViewActivity.openUrlByUsingGlobalWPCOMCredentials(getActivity(), WORDPRESS_PURCHASES_URL);</span>
<span class="nc" id="L1298">        });</span>
<span class="nc" id="L1299">        builder.setNegativeButton(getString(R.string.cancel), (dialog, which) -&gt; dialog.dismiss());</span>
<span class="nc" id="L1300">        builder.show();</span>
<span class="nc" id="L1301">        AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_DELETE_SITE_PURCHASES_SHOWN, mSite);</span>
<span class="nc" id="L1302">    }</span>

    private boolean hasActivePurchases(JSONArray purchases) throws JSONException {
<span class="nc bnc" id="L1305" title="All 2 branches missed.">        for (int i = 0; i &lt; purchases.length(); i++) {</span>
<span class="nc" id="L1306">            JSONObject purchase = purchases.getJSONObject(i);</span>
<span class="nc" id="L1307">            int active = purchase.getInt(PURCHASE_ACTIVE_KEY);</span>

<span class="nc bnc" id="L1309" title="All 2 branches missed.">            if (active == 1) {</span>
<span class="nc" id="L1310">                return true;</span>
            }
        }

<span class="nc" id="L1314">        return false;</span>
    }

    private void showDeleteSiteWarningDialog() {
<span class="nc bnc" id="L1318" title="All 4 branches missed.">        if (!isAdded() || mIsFragmentPaused) {</span>
<span class="nc" id="L1319">            return;</span>
        }

<span class="nc" id="L1322">        MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L1323">        builder.setTitle(R.string.delete_site_warning_title);</span>
<span class="nc" id="L1324">        String text = getString(R.string.delete_site_warning, &quot;&lt;b&gt;&quot; + UrlUtils.getHost(mSite.getUrl()) + &quot;&lt;/b&gt;&quot;)</span>
                      + &quot;&lt;br&gt;&lt;br&gt;&quot;
<span class="nc" id="L1326">                      + &quot;&lt;i&gt;&quot; + getString(R.string.delete_site_warning_subtitle) + &quot;&lt;/i&gt;&quot;;</span>
<span class="nc" id="L1327">        builder.setMessage(HtmlUtils.fromHtml(text));</span>
<span class="nc" id="L1328">        builder.setPositiveButton(R.string.yes, (dialog, which) -&gt; showDeleteSiteDialog());</span>
<span class="nc" id="L1329">        builder.setNegativeButton(R.string.cancel, null);</span>
<span class="nc" id="L1330">        builder.show();</span>
<span class="nc" id="L1331">    }</span>

    private void showDeleteSiteDialog() {
<span class="nc bnc" id="L1334" title="All 2 branches missed.">        if (mIsFragmentPaused) {</span>
<span class="nc" id="L1335">            return; // Do not show the DeleteSiteDialogFragment if the fragment was paused.</span>
        }
        // DialogFragment internally uses commit(), and not commitAllowingStateLoss, crashing the app in case like that.
<span class="nc" id="L1338">        Bundle args = new Bundle();</span>
<span class="nc" id="L1339">        args.putString(DeleteSiteDialogFragment.SITE_DOMAIN_KEY, UrlUtils.getHost(mSite.getUrl()));</span>
<span class="nc" id="L1340">        DeleteSiteDialogFragment deleteSiteDialogFragment = new DeleteSiteDialogFragment();</span>
<span class="nc" id="L1341">        deleteSiteDialogFragment.setArguments(args);</span>
<span class="nc" id="L1342">        deleteSiteDialogFragment.setTargetFragment(this, DELETE_SITE_REQUEST_CODE);</span>
<span class="nc" id="L1343">        deleteSiteDialogFragment.show(getFragmentManager(), DELETE_SITE_TAG);</span>
<span class="nc" id="L1344">        AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_DELETE_SITE_ACCESSED, mSite);</span>
<span class="nc" id="L1345">    }</span>

    private void showCloseAfterDialog() {
<span class="nc" id="L1348">        Bundle args = new Bundle();</span>
<span class="nc" id="L1349">        args.putBoolean(NumberPickerDialog.SHOW_SWITCH_KEY, true);</span>
<span class="nc" id="L1350">        args.putBoolean(NumberPickerDialog.SWITCH_ENABLED_KEY, mSiteSettings.getShouldCloseAfter());</span>
<span class="nc" id="L1351">        args.putString(NumberPickerDialog.SWITCH_TITLE_KEY,</span>
<span class="nc" id="L1352">                getString(R.string.site_settings_close_after_dialog_switch_text));</span>
<span class="nc" id="L1353">        args.putString(NumberPickerDialog.SWITCH_DESC_KEY,</span>
<span class="nc" id="L1354">                getString(R.string.site_settings_close_after_dialog_description));</span>
<span class="nc" id="L1355">        args.putString(NumberPickerDialog.TITLE_KEY, getString(R.string.site_settings_close_after_dialog_title));</span>
<span class="nc" id="L1356">        args.putString(NumberPickerDialog.HEADER_TEXT_KEY, getString(R.string.site_settings_close_after_dialog_header));</span>
<span class="nc" id="L1357">        args.putInt(NumberPickerDialog.MIN_VALUE_KEY, 1);</span>
<span class="nc" id="L1358">        args.putInt(NumberPickerDialog.MAX_VALUE_KEY, getResources().getInteger(R.integer.close_after_limit));</span>
<span class="nc" id="L1359">        args.putInt(NumberPickerDialog.CUR_VALUE_KEY, mSiteSettings.getCloseAfter());</span>
<span class="nc" id="L1360">        showNumberPickerDialog(args, CLOSE_AFTER_REQUEST_CODE, &quot;close-after-dialog&quot;);</span>
<span class="nc" id="L1361">    }</span>

    private void showMultipleLinksDialog() {
<span class="nc" id="L1364">        Bundle args = new Bundle();</span>
<span class="nc" id="L1365">        args.putBoolean(NumberPickerDialog.SHOW_SWITCH_KEY, false);</span>
<span class="nc" id="L1366">        args.putString(NumberPickerDialog.TITLE_KEY, getString(R.string.site_settings_multiple_links_title));</span>
<span class="nc" id="L1367">        args.putInt(NumberPickerDialog.MIN_VALUE_KEY, 0);</span>
<span class="nc" id="L1368">        args.putInt(NumberPickerDialog.MAX_VALUE_KEY, getResources().getInteger(R.integer.max_links_limit));</span>
<span class="nc" id="L1369">        args.putInt(NumberPickerDialog.CUR_VALUE_KEY, mSiteSettings.getMultipleLinks());</span>
<span class="nc" id="L1370">        showNumberPickerDialog(args, MULTIPLE_LINKS_REQUEST_CODE, &quot;multiple-links-dialog&quot;);</span>
<span class="nc" id="L1371">    }</span>

    public void setPreferencesFromSiteSettings() {
<span class="nc" id="L1374">        changeEditTextPreferenceValue(mTitlePref, mSiteSettings.getTitle());</span>
<span class="nc" id="L1375">        changeEditTextPreferenceValue(mTaglinePref, mSiteSettings.getTagline());</span>
<span class="nc" id="L1376">        changeEditTextPreferenceValue(mAddressPref, mSiteSettings.getAddress());</span>
<span class="nc" id="L1377">        changeEditTextPreferenceValue(mUsernamePref, mSiteSettings.getUsername());</span>
<span class="nc" id="L1378">        changeEditTextPreferenceValue(mPasswordPref, mSiteSettings.getPassword());</span>
<span class="nc" id="L1379">        changeLanguageValue(mSiteSettings.getLanguageCode());</span>
<span class="nc" id="L1380">        setDetailListPreferenceValue(mPrivacyPref,</span>
<span class="nc" id="L1381">                String.valueOf(mSiteSettings.getPrivacy()),</span>
<span class="nc" id="L1382">                mSiteSettings.getPrivacyDescription());</span>
<span class="nc" id="L1383">        setCategories();</span>
<span class="nc" id="L1384">        setPostFormats();</span>
<span class="nc" id="L1385">        setAllowComments(mSiteSettings.getAllowComments());</span>
<span class="nc" id="L1386">        setSendPingbacks(mSiteSettings.getSendPingbacks());</span>
<span class="nc" id="L1387">        setReceivePingbacks(mSiteSettings.getReceivePingbacks());</span>
<span class="nc" id="L1388">        setDetailListPreferenceValue(mSortByPref,</span>
<span class="nc" id="L1389">                String.valueOf(mSiteSettings.getCommentSorting()),</span>
<span class="nc" id="L1390">                mSiteSettings.getSortingDescription());</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">        int approval = mSiteSettings.getManualApproval()</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">                ? mSiteSettings.getUseCommentAllowlist() ? 0</span>
<span class="nc" id="L1393">                : -1 : 1;</span>
<span class="nc" id="L1394">        setDetailListPreferenceValue(mAllowlistPref, String.valueOf(approval), getAllowlistSummary(approval));</span>
<span class="nc" id="L1395">        String s = StringUtils.getQuantityString(getActivity(), R.string.site_settings_multiple_links_summary_zero,</span>
                R.string.site_settings_multiple_links_summary_one,
                R.string.site_settings_multiple_links_summary_other,
<span class="nc" id="L1398">                mSiteSettings.getMultipleLinks());</span>
<span class="nc" id="L1399">        mMultipleLinksPref.setSummary(s);</span>
<span class="nc" id="L1400">        mIdentityRequiredPreference.setChecked(mSiteSettings.getIdentityRequired());</span>
<span class="nc" id="L1401">        mUserAccountRequiredPref.setChecked(mSiteSettings.getUserAccountRequired());</span>
<span class="nc" id="L1402">        mThreadingPref.setSummary(mSiteSettings.getThreadingDescription());</span>
<span class="nc" id="L1403">        mCloseAfterPref.setSummary(mSiteSettings.getCloseAfterDescriptionForPeriod());</span>
<span class="nc" id="L1404">        mPagingPref.setSummary(mSiteSettings.getPagingDescription());</span>
<span class="nc" id="L1405">        mRelatedPostsPref.setSummary(mSiteSettings.getRelatedPostsDescription());</span>
<span class="nc" id="L1406">        mModerationHoldPref.setSummary(mSiteSettings.getModerationHoldDescription());</span>
<span class="nc" id="L1407">        mDenylistPref.setSummary(mSiteSettings.getDenylistDescription());</span>
<span class="nc" id="L1408">        mJpMonitorActivePref.setChecked(mSiteSettings.isJetpackMonitorEnabled());</span>
<span class="nc" id="L1409">        mJpMonitorEmailNotesPref.setChecked(mSiteSettings.shouldSendJetpackMonitorEmailNotifications());</span>
<span class="nc" id="L1410">        mJpMonitorWpNotesPref.setChecked(mSiteSettings.shouldSendJetpackMonitorWpNotifications());</span>
<span class="nc" id="L1411">        mJpBruteForcePref.setChecked(mSiteSettings.isJetpackProtectEnabled());</span>
<span class="nc" id="L1412">        mJpSsoPref.setChecked(mSiteSettings.isJetpackSsoEnabled());</span>
<span class="nc" id="L1413">        mJpMatchEmailPref.setChecked(mSiteSettings.isJetpackSsoMatchEmailEnabled());</span>
<span class="nc" id="L1414">        mJpUseTwoFactorPref.setChecked(mSiteSettings.isJetpackSsoTwoFactorEnabled());</span>
<span class="nc" id="L1415">        mJpAllowlistPref.setSummary(mSiteSettings.getJetpackProtectAllowlistSummary());</span>
<span class="nc" id="L1416">        mWeekStartPref.setValue(mSiteSettings.getStartOfWeek());</span>
<span class="nc" id="L1417">        mWeekStartPref.setSummary(mWeekStartPref.getEntry());</span>
<span class="nc" id="L1418">        mGutenbergDefaultForNewPosts.setChecked(SiteUtils.isBlockEditorDefaultForNewPost(mSite));</span>
<span class="nc" id="L1419">        setLazyLoadImagesChecked(mSiteSettings.isLazyLoadImagesEnabled());</span>
<span class="nc" id="L1420">        setAdFreeHostingChecked(mSiteSettings.isAdFreeHostingEnabled());</span>
<span class="nc bnc" id="L1421" title="All 4 branches missed.">        boolean checked = mSiteSettings.isImprovedSearchEnabled() || mSiteSettings.getJetpackSearchEnabled();</span>
<span class="nc" id="L1422">        mImprovedSearch.setChecked(checked);</span>

<span class="nc" id="L1424">        updateSiteAccelerator();</span>
<span class="nc" id="L1425">        setServeImagesFromOurServersChecked(mSiteSettings.isServeImagesFromOurServersEnabled());</span>
<span class="nc" id="L1426">        setServeStaticFilesFromOurServersChecked(mSiteSettings.isServeStaticFilesFromOurServersEnabled());</span>

<span class="nc bnc" id="L1428" title="All 2 branches missed.">        if (mSiteSettings.getAmpSupported()) {</span>
<span class="nc" id="L1429">            mAmpPref.setChecked(mSiteSettings.getAmpEnabled());</span>
        } else {
<span class="nc" id="L1431">            WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_traffic);</span>
        }

<span class="nc" id="L1434">        setupJetpackSearch();</span>

        // Remove More Jetpack performance settings when the search is not visible
<span class="nc bnc" id="L1437" title="All 2 branches missed.">        if (!isShowingImproveSearchPreference()) {</span>
<span class="nc" id="L1438">            removeMoreJetpackSettings();</span>
        }

<span class="nc" id="L1441">        setDateTimeFormatPref(FormatType.DATE_FORMAT, mDateFormatPref, mSiteSettings.getDateFormat());</span>
<span class="nc" id="L1442">        setDateTimeFormatPref(FormatType.TIME_FORMAT, mTimeFormatPref, mSiteSettings.getTimeFormat());</span>

<span class="nc" id="L1444">        mPostsPerPagePref.setSummary(String.valueOf(mSiteSettings.getPostsPerPage()));</span>
<span class="nc" id="L1445">        setTimezonePref(mSiteSettings.getTimezone());</span>
<span class="nc" id="L1446">        changeEditTextPreferenceValue(mSiteQuotaSpacePref, mSiteSettings.getQuotaDiskSpace());</span>
<span class="nc" id="L1447">    }</span>

    private boolean isShowingImproveSearchPreference() {
<span class="nc bnc" id="L1450" title="All 2 branches missed.">        return mJetpackPerformanceMoreSettings.findPreference(getString(R.string.pref_key_jetpack_search_settings))</span>
               != null;
    }

    private void updateSiteAccelerator() {
<span class="nc bnc" id="L1455" title="All 2 branches missed.">        boolean siteAcceleratorEnabled = mSiteSettings.isServeImagesFromOurServersEnabled() || mSiteSettings</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">                .isServeStaticFilesFromOurServersEnabled();</span>
<span class="nc bnc" id="L1457" title="All 2 branches missed.">        setSiteAcceleratorSettingsSummary(siteAcceleratorEnabled ? R.string.site_settings_site_accelerator_on</span>
<span class="nc" id="L1458">                : R.string.site_settings_site_accelerator_off);</span>
<span class="nc" id="L1459">        setSiteAcceleratorChecked(siteAcceleratorEnabled);</span>
<span class="nc" id="L1460">        ListAdapter adapter = mSiteAcceleratorSettings.getRootAdapter();</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">        if (adapter instanceof BaseAdapter) {</span>
<span class="nc" id="L1462">            ((BaseAdapter) adapter).notifyDataSetChanged();</span>
        }
<span class="nc" id="L1464">        ListAdapter adapterNested = mSiteAcceleratorSettingsNested.getRootAdapter();</span>
<span class="nc bnc" id="L1465" title="All 2 branches missed.">        if (adapterNested instanceof BaseAdapter) {</span>
<span class="nc" id="L1466">            ((BaseAdapter) adapterNested).notifyDataSetChanged();</span>
        }
<span class="nc" id="L1468">    }</span>

    private void setSiteAcceleratorSettingsSummary(int summaryRes) {
<span class="nc" id="L1471">        mSiteAcceleratorSettings.setSummary(summaryRes);</span>
<span class="nc" id="L1472">        mSiteAcceleratorSettingsNested.setSummary(summaryRes);</span>
<span class="nc" id="L1473">    }</span>

    private void setSiteAcceleratorChecked(boolean checked) {
<span class="nc" id="L1476">        mSiteAccelerator.setChecked(checked);</span>
<span class="nc" id="L1477">        mSiteAcceleratorNested.setChecked(checked);</span>
<span class="nc" id="L1478">    }</span>

    private void setLazyLoadImagesChecked(boolean checked) {
<span class="nc" id="L1481">        mSiteSettings.enableLazyLoadImages(checked);</span>
<span class="nc" id="L1482">        mLazyLoadImages.setChecked(checked);</span>
<span class="nc" id="L1483">        mLazyLoadImagesNested.setChecked(checked);</span>
<span class="nc" id="L1484">    }</span>

    private void setAdFreeHostingChecked(boolean checked) {
<span class="nc" id="L1487">        mSiteSettings.enableAdFreeHosting(checked);</span>
<span class="nc" id="L1488">        mAdFreeVideoHosting.setChecked(checked);</span>
<span class="nc" id="L1489">        mAdFreeVideoHostingNested.setChecked(checked);</span>
<span class="nc" id="L1490">    }</span>

    private void setServeImagesFromOurServersChecked(boolean checked) {
<span class="nc" id="L1493">        mSiteSettings.enableServeImagesFromOurServers(checked);</span>
<span class="nc" id="L1494">        mServeImagesFromOurServers.setChecked(checked);</span>
<span class="nc" id="L1495">        mServeImagesFromOurServersNested.setChecked(checked);</span>
<span class="nc" id="L1496">    }</span>

    private void setServeStaticFilesFromOurServersChecked(boolean checked) {
<span class="nc" id="L1499">        mSiteSettings.enableServeStaticFilesFromOurServers(checked);</span>
<span class="nc" id="L1500">        mServeStaticFilesFromOurServers.setChecked(checked);</span>
<span class="nc" id="L1501">        mServeStaticFilesFromOurServersNested.setChecked(checked);</span>
<span class="nc" id="L1502">    }</span>

    private void setDateTimeFormatPref(FormatType formatType, WPPreference formatPref, String formatValue) {
<span class="nc" id="L1505">        String[] entries = formatType.getEntries(getActivity());</span>
<span class="nc" id="L1506">        String[] values = formatType.getValues(getActivity());</span>

        // return predefined format if there's a match
<span class="nc bnc" id="L1509" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; i++) {</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">            if (values[i].equals(formatValue)) {</span>
<span class="nc" id="L1511">                formatPref.setSummary(entries[i]);</span>
<span class="nc" id="L1512">                return;</span>
            }
        }

        // not a predefined format, so it must be custom
<span class="nc" id="L1517">        formatPref.setSummary(R.string.site_settings_format_entry_custom);</span>
<span class="nc" id="L1518">    }</span>

    private void setTimezonePref(String timezoneValue) {
<span class="nc bnc" id="L1521" title="All 2 branches missed.">        if (timezoneValue == null) {</span>
<span class="nc" id="L1522">            return;</span>
        }

<span class="nc" id="L1525">        String timezone = timezoneValue.replace(&quot;_&quot;, &quot; &quot;);</span>
<span class="nc" id="L1526">        int index = timezone.lastIndexOf(&quot;/&quot;);</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">        if (index &gt; -1) {</span>
<span class="nc" id="L1528">            mTimezonePref.setSummary(timezone.substring(index + 1));</span>
        } else {
<span class="nc" id="L1530">            mTimezonePref.setSummary(timezone);</span>
        }
<span class="nc" id="L1532">    }</span>

    private void setBloggingRemindersValue(String value) {
<span class="nc bnc" id="L1535" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L1536">            return;</span>
        }
<span class="nc" id="L1538">        mBloggingRemindersPref.setSummary(value);</span>
<span class="nc" id="L1539">    }</span>

    private void setCategories() {
        // Ignore if there are no changes
<span class="nc bnc" id="L1543" title="All 2 branches missed.">        if (mSiteSettings.isSameCategoryList(mCategoryPref.getEntryValues())) {</span>
<span class="nc" id="L1544">            mCategoryPref.setValue(String.valueOf(mSiteSettings.getDefaultCategory()));</span>
<span class="nc" id="L1545">            mCategoryPref.setSummary(mSiteSettings.getDefaultCategoryForDisplay());</span>
<span class="nc" id="L1546">            return;</span>
        }

<span class="nc" id="L1549">        SparseArrayCompat&lt;String&gt; categories = mSiteSettings.getCategoryNames();</span>
<span class="nc" id="L1550">        CharSequence[] entries = new CharSequence[categories.size()];</span>
<span class="nc" id="L1551">        CharSequence[] values = new CharSequence[categories.size()];</span>
<span class="nc" id="L1552">        int i = 0;</span>
<span class="nc" id="L1553">        int numOfCategories = categories.size();</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">        for (int j = 0; j &lt; numOfCategories; j++) {</span>
<span class="nc" id="L1555">            int key = categories.keyAt(j);</span>
<span class="nc" id="L1556">            entries[i] = categories.get(key);</span>
<span class="nc" id="L1557">            values[i] = String.valueOf(key);</span>
<span class="nc bnc" id="L1558" title="All 2 branches missed.">            if (key == UNCATEGORIZED_CATEGORY_ID) {</span>
<span class="nc" id="L1559">                CharSequence temp = entries[0];</span>
<span class="nc" id="L1560">                entries[0] = entries[i];</span>
<span class="nc" id="L1561">                entries[i] = temp;</span>
<span class="nc" id="L1562">                temp = values[0];</span>
<span class="nc" id="L1563">                values[0] = values[i];</span>
<span class="nc" id="L1564">                values[i] = temp;</span>
            }
<span class="nc" id="L1566">            ++i;</span>
        }

<span class="nc" id="L1569">        mCategoryPref.setEntries(entries);</span>
<span class="nc" id="L1570">        mCategoryPref.setEntryValues(values);</span>
<span class="nc" id="L1571">        mCategoryPref.setValue(String.valueOf(mSiteSettings.getDefaultCategory()));</span>
<span class="nc" id="L1572">        mCategoryPref.setSummary(mSiteSettings.getDefaultCategoryForDisplay());</span>
<span class="nc" id="L1573">    }</span>

    private void setPostFormats() {
        // Ignore if there are no changes
<span class="nc bnc" id="L1577" title="All 2 branches missed.">        if (mSiteSettings.isSameFormatList(mFormatPref.getEntryValues())) {</span>
<span class="nc" id="L1578">            mFormatPref.setValue(mSiteSettings.getDefaultPostFormat());</span>
<span class="nc" id="L1579">            mFormatPref.setSummary(mSiteSettings.getDefaultPostFormatDisplay());</span>
<span class="nc" id="L1580">            return;</span>
        }

        // clone the post formats map
<span class="nc" id="L1584">        final Map&lt;String, String&gt; postFormats = new HashMap&lt;&gt;(mSiteSettings.getFormats());</span>

        // transform the keys and values into arrays and set the ListPreference's data
<span class="nc" id="L1587">        mFormatPref.setEntries(postFormats.values().toArray(new String[0]));</span>
<span class="nc" id="L1588">        mFormatPref.setEntryValues(postFormats.keySet().toArray(new String[0]));</span>
<span class="nc" id="L1589">        mFormatPref.setValue(mSiteSettings.getDefaultPostFormat());</span>
<span class="nc" id="L1590">        mFormatPref.setSummary(mSiteSettings.getDefaultPostFormatDisplay());</span>
<span class="nc" id="L1591">    }</span>

    private void setAllowComments(boolean newValue) {
<span class="nc" id="L1594">        mSiteSettings.setAllowComments(newValue);</span>
<span class="nc" id="L1595">        mAllowCommentsPref.setChecked(newValue);</span>
<span class="nc" id="L1596">        mAllowCommentsNested.setChecked(newValue);</span>
<span class="nc" id="L1597">    }</span>

    private void setSendPingbacks(boolean newValue) {
<span class="nc" id="L1600">        mSiteSettings.setSendPingbacks(newValue);</span>
<span class="nc" id="L1601">        mSendPingbacksPref.setChecked(newValue);</span>
<span class="nc" id="L1602">        mSendPingbacksNested.setChecked(newValue);</span>
<span class="nc" id="L1603">    }</span>

    private void setReceivePingbacks(boolean newValue) {
<span class="nc" id="L1606">        mSiteSettings.setReceivePingbacks(newValue);</span>
<span class="nc" id="L1607">        mReceivePingbacksPref.setChecked(newValue);</span>
<span class="nc" id="L1608">        mReceivePingbacksNested.setChecked(newValue);</span>
<span class="nc" id="L1609">    }</span>

    public void setDetailListPreferenceValue(DetailListPreference pref, String value, String summary) {
<span class="nc" id="L1612">        pref.setValue(value);</span>
<span class="nc" id="L1613">        pref.setSummary(summary);</span>
<span class="nc" id="L1614">        pref.refreshAdapter();</span>
<span class="nc" id="L1615">    }</span>

    /**
     * Helper method to perform validation and set multiple properties on an EditTextPreference.
     * If newValue is equal to the current preference text no action will be taken.
     */
    public void changeEditTextPreferenceValue(EditTextPreference pref, String newValue) {
<span class="nc bnc" id="L1622" title="All 6 branches missed.">        if (newValue == null || pref == null || pref.getEditText().isInEditMode()) {</span>
<span class="nc" id="L1623">            return;</span>
        }

<span class="nc bnc" id="L1626" title="All 2 branches missed.">        if (!newValue.equals(pref.getSummary())) {</span>
<span class="nc" id="L1627">            String formattedValue = StringEscapeUtils.unescapeHtml4(newValue.replaceFirst(ADDRESS_FORMAT_REGEX, &quot;&quot;));</span>

<span class="nc" id="L1629">            pref.setText(formattedValue);</span>
<span class="nc" id="L1630">            pref.setSummary(formattedValue);</span>
        }
<span class="nc" id="L1632">    }</span>

    /**
     * Detail strings for the dialog are generated in the selected language.
     *
     * @param newValue languageCode
     */
    private void changeLanguageValue(String newValue) {
<span class="nc bnc" id="L1640" title="All 4 branches missed.">        if (mLanguagePref == null || newValue == null) {</span>
<span class="nc" id="L1641">            return;</span>
        }

<span class="nc bnc" id="L1644" title="All 2 branches missed.">        if (TextUtils.isEmpty(mLanguagePref.getSummary())</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">            || !newValue.equals(mLanguagePref.getValue())) {</span>
<span class="nc" id="L1646">            mLanguagePref.setValue(newValue);</span>
<span class="nc" id="L1647">            String summary = LocaleManager.getLanguageString(newValue, LocaleManager.languageLocale(newValue));</span>
<span class="nc" id="L1648">            mLanguagePref.setSummary(summary);</span>
<span class="nc" id="L1649">            mLanguagePref.refreshAdapter();</span>
        }
<span class="nc" id="L1651">    }</span>

    private void sortLanguages() {
<span class="nc bnc" id="L1654" title="All 2 branches missed.">        if (mLanguagePref == null) {</span>
<span class="nc" id="L1655">            return;</span>
        }

<span class="nc" id="L1658">        Triple&lt;String[], String[], String[]&gt; supportedLocales = LocaleManager</span>
<span class="nc" id="L1659">                .createSortedLanguageDisplayStrings(mLanguagePref.getEntryValues(), LocaleManager.languageLocale(null));</span>
<span class="nc bnc" id="L1660" title="All 2 branches missed.">        if (supportedLocales != null) {</span>
<span class="nc" id="L1661">            String[] sortedEntries = supportedLocales.component1();</span>
<span class="nc" id="L1662">            String[] sortedValues = supportedLocales.component2();</span>
<span class="nc" id="L1663">            String[] localizedEntries = supportedLocales.component3();</span>

<span class="nc" id="L1665">            mLanguagePref.setEntries(sortedEntries);</span>
<span class="nc" id="L1666">            mLanguagePref.setEntryValues(sortedValues);</span>
<span class="nc" id="L1667">            mLanguagePref.setDetails(localizedEntries);</span>
        }
<span class="nc" id="L1669">    }</span>

    private String getAllowlistSummary(int value) {
<span class="nc bnc" id="L1672" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc bnc" id="L1673" title="All 4 branches missed.">            switch (value) {</span>
                case -1:
<span class="nc" id="L1675">                    return getString(R.string.site_settings_allowlist_none_summary);</span>
                case 0:
<span class="nc" id="L1677">                    return getString(R.string.site_settings_allowlist_known_summary);</span>
                case 1:
<span class="nc" id="L1679">                    return getString(R.string.site_settings_allowlist_all_summary);</span>
            }
        }
<span class="nc" id="L1682">        return &quot;&quot;;</span>
    }

    private void updateAllowlistSettings(int val) {
<span class="nc bnc" id="L1686" title="All 2 branches missed.">        mSiteSettings.setManualApproval(val == -1);</span>
<span class="nc bnc" id="L1687" title="All 2 branches missed.">        mSiteSettings.setUseCommentAllowlist(val == 0);</span>
<span class="nc" id="L1688">        setDetailListPreferenceValue(mAllowlistPref,</span>
<span class="nc" id="L1689">                String.valueOf(val),</span>
<span class="nc" id="L1690">                getAllowlistSummary(val));</span>
<span class="nc" id="L1691">    }</span>

    private void handleStartOver() {
        // Only paid plans should be handled here, free plans should be redirected to website from &quot;Start Over&quot; button
<span class="nc bnc" id="L1695" title="All 4 branches missed.">        if (mSite == null || mSite.getHasFreePlan()) {</span>
<span class="nc" id="L1696">            return;</span>
        }
<span class="nc" id="L1698">        Intent intent = new Intent(Intent.ACTION_SEND);</span>
<span class="nc" id="L1699">        intent.setType(ContactsContract.CommonDataKinds.Email.CONTENT_ITEM_TYPE);</span>
<span class="nc" id="L1700">        intent.putExtra(Intent.EXTRA_EMAIL, new String[]{&quot;help@wordpress.com&quot;});</span>
<span class="nc" id="L1701">        intent.putExtra(Intent.EXTRA_SUBJECT, getString(R.string.start_over_email_subject,</span>
<span class="nc" id="L1702">                SiteUtils.getHomeURLOrHostName(mSite)));</span>
<span class="nc" id="L1703">        intent.putExtra(Intent.EXTRA_TEXT, getString(R.string.start_over_email_body, mSite.getUrl()));</span>
        try {
<span class="nc" id="L1705">            startActivity(Intent.createChooser(intent, getString(R.string.contact_support)));</span>
<span class="nc" id="L1706">        } catch (android.content.ActivityNotFoundException ex) {</span>
<span class="nc" id="L1707">            ToastUtils.showToast(getActivity(), R.string.start_over_email_intent_error);</span>
<span class="nc" id="L1708">        }</span>
<span class="nc" id="L1709">        AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_START_OVER_CONTACT_SUPPORT_CLICKED,</span>
                mSite);
<span class="nc" id="L1711">    }</span>

    private void showListEditorDialog(int titleRes, int headerRes) {
<span class="nc" id="L1714">        mDialog = new Dialog(getActivity(), R.style.WordPress);</span>
<span class="nc" id="L1715">        mDialog.setOnDismissListener(this);</span>
<span class="nc" id="L1716">        mDialog.setTitle(titleRes);</span>
<span class="nc" id="L1717">        mDialog.setContentView(getListEditorView(getString(headerRes)));</span>
<span class="nc" id="L1718">        mDialog.show();</span>
<span class="nc" id="L1719">        WPActivityUtils.addToolbarToDialog(this, mDialog, getString(titleRes));</span>
<span class="nc" id="L1720">    }</span>

    private View getListEditorView(String headerText) {
<span class="nc" id="L1723">        View view = View.inflate(getActivity(), R.layout.list_editor, null);</span>
<span class="nc" id="L1724">        ((TextView) view.findViewById(R.id.list_editor_header_text)).setText(headerText);</span>

<span class="nc" id="L1726">        mAdapter = null;</span>
<span class="nc" id="L1727">        final EmptyViewRecyclerView list = view.findViewById(R.id.list);</span>
<span class="nc" id="L1728">        list.setLayoutManager(</span>
                new SmoothScrollLinearLayoutManager(
<span class="nc" id="L1730">                        getActivity(),</span>
                        LinearLayoutManager.VERTICAL,
                        false,
<span class="nc" id="L1733">                        getResources().getInteger(android.R.integer.config_mediumAnimTime)</span>
                )
        );
<span class="nc" id="L1736">        list.setAdapter(getAdapter());</span>
<span class="nc" id="L1737">        list.setEmptyView(view.findViewById(R.id.empty_view));</span>
<span class="nc" id="L1738">        list.addOnItemTouchListener(</span>
                new RecyclerViewItemClickListener(
<span class="nc" id="L1740">                        getActivity(),</span>
                        list,
<span class="nc" id="L1742">                        new RecyclerViewItemClickListener.OnItemClickListener() {</span>
                            @Override
                            public void onItemClick(View view, int position) {
<span class="nc bnc" id="L1745" title="All 2 branches missed.">                                if (mActionMode != null) {</span>
<span class="nc" id="L1746">                                    getAdapter().toggleItemSelected(position);</span>
<span class="nc" id="L1747">                                    mActionMode.invalidate();</span>
<span class="nc bnc" id="L1748" title="All 2 branches missed.">                                    if (getAdapter().getItemsSelected().size() &lt;= 0) {</span>
<span class="nc" id="L1749">                                        mActionMode.finish();</span>
                                    }
                                }
<span class="nc" id="L1752">                            }</span>

                            @Override
                            public void onLongItemClick(View view, int position) {
<span class="nc bnc" id="L1756" title="All 2 branches missed.">                                if (mActionMode == null) {</span>
<span class="nc bnc" id="L1757" title="All 2 branches missed.">                                    if (view.isHapticFeedbackEnabled()) {</span>
<span class="nc" id="L1758">                                        view.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span>
                                    }

<span class="nc" id="L1761">                                    mDialog.getWindow().getDecorView().startActionMode(new ActionModeCallback());</span>
<span class="nc" id="L1762">                                    getAdapter().setItemSelected(position);</span>
<span class="nc" id="L1763">                                    mActionMode.invalidate();</span>
                                }
<span class="nc" id="L1765">                            }</span>
                        }
                )
        );
<span class="nc" id="L1769">        FloatingActionButton button = view.findViewById(R.id.fab_button);</span>
<span class="nc" id="L1770">        button.setOnClickListener(v -&gt; {</span>
<span class="nc" id="L1771">            MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L1772">            final EditText input = new EditText(getActivity());</span>
<span class="nc" id="L1773">            input.setWidth(getResources().getDimensionPixelSize(R.dimen.list_editor_input_max_width));</span>
<span class="nc" id="L1774">            input.setHint(R.string.site_settings_list_editor_input_hint);</span>
<span class="nc" id="L1775">            builder.setPositiveButton(android.R.string.ok, (dialog, which) -&gt; {</span>
<span class="nc" id="L1776">                String entry = input.getText().toString();</span>
<span class="nc bnc" id="L1777" title="All 4 branches missed.">                if (!TextUtils.isEmpty(entry) &amp;&amp; !mEditingList.contains(entry)) {</span>
                    // don't modify mEditingList if it's not a reference to the JP allowlist keys
<span class="nc bnc" id="L1779" title="All 4 branches missed.">                    if (mEditingList == mSiteSettings.getJetpackAllowlistKeys() &amp;&amp; !isValidIpOrRange(entry)) {</span>
<span class="nc" id="L1780">                        ToastUtils.showToast(getActivity(), R.string.invalid_ip_or_range);</span>
<span class="nc" id="L1781">                        return;</span>
                    }

<span class="nc" id="L1784">                    mEditingList.add(entry);</span>
<span class="nc" id="L1785">                    getAdapter().notifyItemInserted(getAdapter().getItemCount() - 1);</span>
<span class="nc" id="L1786">                    list.post(() -&gt; list.smoothScrollToPosition(getAdapter().getItemCount() - 1)</span>
                    );
<span class="nc" id="L1788">                    mSiteSettings.saveSettings();</span>
<span class="nc" id="L1789">                    AnalyticsUtils.trackWithSiteDetails(Stat.SITE_SETTINGS_ADDED_LIST_ITEM,</span>
                            mSite);
                }
<span class="nc" id="L1792">            });</span>
<span class="nc" id="L1793">            builder.setNegativeButton(R.string.cancel, null);</span>
<span class="nc" id="L1794">            final AlertDialog alertDialog = builder.create();</span>
<span class="nc" id="L1795">            int spacing = getResources().getDimensionPixelSize(R.dimen.dlp_padding_start);</span>
<span class="nc" id="L1796">            alertDialog.setView(input, spacing, spacing, spacing, 0);</span>
<span class="nc" id="L1797">            alertDialog.requestWindowFeature(Window.FEATURE_NO_TITLE);</span>
<span class="nc" id="L1798">            alertDialog.getWindow().setSoftInputMode(LayoutParams.SOFT_INPUT_STATE_VISIBLE);</span>
<span class="nc" id="L1799">            alertDialog.setOnDismissListener(</span>
<span class="nc" id="L1800">                    dialog -&gt; alertDialog.getWindow().setSoftInputMode(LayoutParams.SOFT_INPUT_STATE_HIDDEN));</span>
<span class="nc" id="L1801">            alertDialog.show();</span>
<span class="nc" id="L1802">        });</span>
<span class="nc" id="L1803">        button.setOnLongClickListener(view1 -&gt; {</span>
<span class="nc bnc" id="L1804" title="All 2 branches missed.">            if (view1.isHapticFeedbackEnabled()) {</span>
<span class="nc" id="L1805">                view1.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span>
            }

<span class="nc" id="L1808">            Toast.makeText(view1.getContext(), R.string.add, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1809">            return true;</span>
        });
<span class="nc" id="L1811">        ViewExtensionsKt.redirectContextClickToLongPressListener(button);</span>

<span class="nc" id="L1813">        return view;</span>
    }

    /**
     * Verifies that a given string can correctly be interpreted as an IP address or an IP range.
     */
    private boolean isValidIpOrRange(String entry) {
        // empty strings are not valid
<span class="nc bnc" id="L1821" title="All 2 branches missed.">        if (TextUtils.isEmpty(entry)) {</span>
<span class="nc" id="L1822">            return false;</span>
        }

        // remove whitespace
<span class="nc" id="L1826">        entry = entry.replaceAll(&quot;\\s&quot;, &quot;&quot;);</span>

        // if entry is a range it will be formatted as two IP addresses separated by a '-'
<span class="nc" id="L1829">        String[] ipStrings = entry.split(&quot;-&quot;);</span>

        // entry is not well-formed if there are more than 2 ipStrings (a range) or no ipStrings
<span class="nc bnc" id="L1832" title="All 4 branches missed.">        if (ipStrings.length &gt; 2 || ipStrings.length &lt; 1) {</span>
<span class="nc" id="L1833">            return false;</span>
        }

        // if any IP string is not a valid IP address then entry is not valid
<span class="nc bnc" id="L1837" title="All 2 branches missed.">        for (String ip : ipStrings) {</span>
<span class="nc bnc" id="L1838" title="All 2 branches missed.">            if (!ValidationUtils.validateIPv4(ip)) {</span>
<span class="nc" id="L1839">                return false;</span>
            }
        }

<span class="nc" id="L1843">        return true;</span>
    }

    public boolean shouldShowListPreference(DetailListPreference preference) {
<span class="nc bnc" id="L1847" title="All 6 branches missed.">        return preference != null &amp;&amp; preference.getEntries() != null &amp;&amp; preference.getEntries().length &gt; 0;</span>
    }

    private void setupJetpackSecurityScreen() {
<span class="nc bnc" id="L1851" title="All 4 branches missed.">        if (mJpSecuritySettings == null || !isAdded()) {</span>
<span class="nc" id="L1852">            return;</span>
        }
<span class="nc" id="L1854">        String title = getString(R.string.jetpack_security_setting_title);</span>
<span class="nc" id="L1855">        Dialog dialog = mJpSecuritySettings.getDialog();</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">        if (dialog != null) {</span>
<span class="nc" id="L1857">            setupPreferenceList(dialog.findViewById(android.R.id.list), getResources());</span>
<span class="nc" id="L1858">            WPActivityUtils.addToolbarToDialog(this, dialog, title);</span>
        }
<span class="nc" id="L1860">    }</span>

    private void setupSiteAcceleratorScreen() {
<span class="nc bnc" id="L1863" title="All 4 branches missed.">        if (mSiteAcceleratorSettings == null || !isAdded()) {</span>
<span class="nc" id="L1864">            return;</span>
        }
<span class="nc" id="L1866">        String title = getString(R.string.site_settings_site_accelerator);</span>
<span class="nc" id="L1867">        Dialog dialog = mSiteAcceleratorSettings.getDialog();</span>
<span class="nc bnc" id="L1868" title="All 2 branches missed.">        if (dialog != null) {</span>
<span class="nc" id="L1869">            setupPreferenceList(dialog.findViewById(android.R.id.list), getResources());</span>
<span class="nc" id="L1870">            WPActivityUtils.addToolbarToDialog(this, dialog, title);</span>
        }
<span class="nc" id="L1872">    }</span>

    private void setupJetpackMoreSettingsScreen() {
<span class="nc bnc" id="L1875" title="All 4 branches missed.">        if (mJetpackPerformanceMoreSettings == null || !isAdded()) {</span>
<span class="nc" id="L1876">            return;</span>
        }
<span class="nc" id="L1878">        String title = getString(R.string.site_settings_performance);</span>
<span class="nc" id="L1879">        Dialog dialog = mJetpackPerformanceMoreSettings.getDialog();</span>
<span class="nc bnc" id="L1880" title="All 2 branches missed.">        if (dialog != null) {</span>
<span class="nc" id="L1881">            setupPreferenceList(dialog.findViewById(android.R.id.list), getResources());</span>
<span class="nc" id="L1882">            WPActivityUtils.addToolbarToDialog(this, dialog, title);</span>
        }
<span class="nc" id="L1884">    }</span>

    private void setupNestedSiteAcceleratorScreen() {
<span class="nc bnc" id="L1887" title="All 4 branches missed.">        if (mSiteAcceleratorSettingsNested == null || !isAdded()) {</span>
<span class="nc" id="L1888">            return;</span>
        }
<span class="nc" id="L1890">        String title = getString(R.string.site_settings_site_accelerator);</span>
<span class="nc" id="L1891">        Dialog dialog = mSiteAcceleratorSettingsNested.getDialog();</span>
<span class="nc bnc" id="L1892" title="All 2 branches missed.">        if (dialog != null) {</span>
<span class="nc" id="L1893">            setupPreferenceList(dialog.findViewById(android.R.id.list), getResources());</span>
<span class="nc" id="L1894">            WPActivityUtils.addToolbarToDialog(this, dialog, title);</span>
        }
<span class="nc" id="L1896">    }</span>

    private boolean setupMorePreferenceScreen() {
<span class="nc bnc" id="L1899" title="All 4 branches missed.">        if (mMorePreference == null || !isAdded()) {</span>
<span class="nc" id="L1900">            return false;</span>
        }
<span class="nc" id="L1902">        String title = getString(R.string.site_settings_discussion_title);</span>
<span class="nc" id="L1903">        Dialog dialog = mMorePreference.getDialog();</span>
<span class="nc bnc" id="L1904" title="All 2 branches missed.">        if (dialog != null) {</span>
<span class="nc" id="L1905">            dialog.setTitle(title);</span>
<span class="nc" id="L1906">            setupPreferenceList(dialog.findViewById(android.R.id.list), getResources());</span>
<span class="nc" id="L1907">            WPActivityUtils.addToolbarToDialog(this, dialog, title);</span>
<span class="nc" id="L1908">            return true;</span>
        }
<span class="nc" id="L1910">        return false;</span>
    }

    private void removeJetpackSecurityScreenToolbar() {
<span class="nc bnc" id="L1914" title="All 4 branches missed.">        if (mJpSecuritySettings == null || !isAdded()) {</span>
<span class="nc" id="L1915">            return;</span>
        }
<span class="nc" id="L1917">        Dialog securityDialog = mJpSecuritySettings.getDialog();</span>
<span class="nc" id="L1918">        WPActivityUtils.removeToolbarFromDialog(this, securityDialog);</span>
<span class="nc" id="L1919">    }</span>

    private void hideAdminRequiredPreferences() {
<span class="nc" id="L1922">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_general);</span>
<span class="nc" id="L1923">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_discussion);</span>
<span class="nc" id="L1924">        WPPrefUtils.removePreference(this, R.string.pref_key_site_writing, R.string.pref_key_site_category);</span>
<span class="nc" id="L1925">        WPPrefUtils.removePreference(this, R.string.pref_key_site_writing, R.string.pref_key_site_format);</span>
<span class="nc" id="L1926">        WPPrefUtils.removePreference(this, R.string.pref_key_site_writing, R.string.pref_key_site_related_posts);</span>
<span class="nc" id="L1927">    }</span>

    private void removeNonSelfHostedPreferences() {
<span class="nc" id="L1930">        mUsernamePref.setEnabled(true);</span>
<span class="nc" id="L1931">        mPasswordPref.setEnabled(true);</span>
<span class="nc" id="L1932">        removeGeneralSettingsExceptBloggingReminders();</span>
<span class="nc" id="L1933">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_writing);</span>
<span class="nc" id="L1934">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_discussion);</span>
<span class="nc" id="L1935">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_advanced);</span>
<span class="nc" id="L1936">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_quota);</span>
<span class="nc" id="L1937">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_jetpack_settings);</span>
<span class="nc" id="L1938">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen,</span>
                R.string.pref_key_jetpack_performance_settings);
<span class="nc" id="L1940">    }</span>

    /**
     * This removes all preferences from the General preference group, except for Blogging Reminders  in practice it
     * is removed as well, but then added back.
     * &lt;p&gt;
     * In the future, we should consider either moving the Blogging Reminders preference to its own group or
     * replace this approach with something more scalable and efficient.
     */
    private void removeGeneralSettingsExceptBloggingReminders() {
<span class="nc" id="L1950">        PreferenceGroup group = (PreferenceGroup) findPreference(getString(R.string.pref_key_site_general));</span>
<span class="nc bnc" id="L1951" title="All 4 branches missed.">        if (group != null &amp;&amp; mBloggingRemindersPref != null) {</span>
<span class="nc" id="L1952">            group.removeAll();</span>
<span class="nc" id="L1953">            group.addPreference(mBloggingRemindersPref);</span>
        }
<span class="nc" id="L1955">    }</span>

    private void removeNonJetpackPreferences() {
<span class="nc" id="L1958">        removePrivateOptionFromPrivacySetting();</span>
<span class="nc" id="L1959">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_advanced);</span>
<span class="nc" id="L1960">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_account);</span>
<span class="nc" id="L1961">        WPPrefUtils.removePreference(this, R.string.pref_key_site_general, R.string.pref_key_site_language);</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">        if (!mSite.hasDiskSpaceQuotaInformation()) {</span>
<span class="nc" id="L1963">            WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_quota);</span>
        }
<span class="nc" id="L1965">    }</span>

    private void removeJetpackSiteAcceleratorSettings() {
<span class="nc" id="L1968">        WPPrefUtils.removePreference(this, R.string.pref_key_jetpack_performance_settings,</span>
                R.string.pref_key_site_accelerator_settings);
<span class="nc" id="L1970">        WPPrefUtils.removePreference(this, R.string.pref_key_jetpack_performance_and_speed_settings,</span>
                R.string.pref_key_site_accelerator_settings_nested);
<span class="nc" id="L1972">    }</span>

    private void removeJetpackMediaSettings() {
<span class="nc" id="L1975">        WPPrefUtils.removePreference(this, R.string.pref_key_jetpack_performance_settings,</span>
                R.string.pref_key_ad_free_video_hosting);
<span class="nc" id="L1977">        WPPrefUtils.removePreference(this, R.string.pref_key_jetpack_performance_more_settings,</span>
                R.string.pref_key_jetpack_performance_media_settings);
<span class="nc" id="L1979">    }</span>

    private void removeJetpackSearchSettings() {
<span class="nc" id="L1982">        WPPrefUtils.removePreference(this, R.string.pref_key_jetpack_performance_more_settings,</span>
                R.string.pref_key_jetpack_search_settings);
<span class="nc" id="L1984">    }</span>

    private void removeMoreJetpackSettings() {
<span class="nc" id="L1987">        WPPrefUtils.removePreference(this, R.string.pref_key_jetpack_performance_settings,</span>
                R.string.pref_key_jetpack_performance_more_settings);
<span class="nc" id="L1989">    }</span>

    private void removeBloggingRemindersSettings() {
<span class="nc" id="L1992">        WPPrefUtils.removePreference(this, R.string.pref_key_site_general, R.string.pref_key_blogging_reminders);</span>
<span class="nc" id="L1993">    }</span>

    private void removePrivateOptionFromPrivacySetting() {
<span class="nc bnc" id="L1996" title="All 2 branches missed.">        if (mPrivacyPref == null) {</span>
<span class="nc" id="L1997">            return;</span>
        }

<span class="nc" id="L2000">        final CharSequence[] entries = mPrivacyPref.getEntries();</span>
<span class="nc" id="L2001">        mPrivacyPref.remove(ArrayUtils.indexOf(entries, getString(R.string.site_settings_privacy_private_summary)));</span>
<span class="nc" id="L2002">    }</span>

    private void removeNonWPComPreferences() {
<span class="nc" id="L2005">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_site_account);</span>
<span class="nc" id="L2006">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen, R.string.pref_key_jetpack_settings);</span>
<span class="nc" id="L2007">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen,</span>
                R.string.pref_key_jetpack_performance_media_settings);
<span class="nc" id="L2009">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen,</span>
                R.string.pref_key_jetpack_performance_settings);
<span class="nc" id="L2011">    }</span>

    private void removeEditorPreferences() {
<span class="nc" id="L2014">        WPPrefUtils.removePreference(this, R.string.pref_key_site_editor,</span>
                R.string.pref_key_gutenberg_default_for_new_posts);
<span class="nc" id="L2016">        WPPrefUtils.removePreference(this, R.string.pref_key_site_screen,</span>
                R.string.pref_key_site_editor);
<span class="nc" id="L2018">    }</span>

    private void removeCategoriesPreference() {
<span class="nc" id="L2021">        WPPrefUtils.removePreference(this, R.string.pref_key_site_writing, R.string.pref_key_site_categories);</span>
<span class="nc" id="L2022">    }</span>

    private Preference getChangePref(int id) {
<span class="nc" id="L2025">        return WPPrefUtils.getPrefAndSetChangeListener(this, id, this);</span>
    }

    private Preference getClickPref(int id) {
<span class="nc" id="L2029">        return WPPrefUtils.getPrefAndSetClickListener(this, id, this);</span>
    }

    private void exportSite() {
<span class="nc bnc" id="L2033" title="All 2 branches missed.">        if (mSite.isWPCom()) {</span>
<span class="nc" id="L2034">            final ProgressDialog progressDialog = ProgressDialog</span>
<span class="nc" id="L2035">                    .show(getActivity(), &quot;&quot;, getActivity().getString(R.string.exporting_content_progress), true, true);</span>
<span class="nc" id="L2036">            WordPress.getRestClientUtils().exportContentAll(mSite.getSiteId(), response -&gt; {</span>
<span class="nc bnc" id="L2037" title="All 2 branches missed.">                if (isAdded()) {</span>
<span class="nc" id="L2038">                    AnalyticsUtils.trackWithSiteDetails(</span>
                            Stat.SITE_SETTINGS_EXPORT_SITE_RESPONSE_OK, mSite);
<span class="nc" id="L2040">                    dismissProgressDialog(progressDialog);</span>
<span class="nc" id="L2041">                    WPSnackbar.make(getView(), R.string.export_email_sent, Snackbar.LENGTH_LONG).show();</span>
                }
<span class="nc" id="L2043">            }, error -&gt; {</span>
<span class="nc bnc" id="L2044" title="All 2 branches missed.">                if (isAdded()) {</span>
<span class="nc" id="L2045">                    HashMap&lt;String, Object&gt; errorProperty = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2046">                    errorProperty.put(ANALYTICS_ERROR_PROPERTY_KEY, error.getMessage());</span>
<span class="nc" id="L2047">                    AnalyticsUtils.trackWithSiteDetails(</span>
                            Stat.SITE_SETTINGS_EXPORT_SITE_RESPONSE_ERROR,
                            mSite, errorProperty);
<span class="nc" id="L2050">                    dismissProgressDialog(progressDialog);</span>
                }
<span class="nc" id="L2052">            });</span>
        }
<span class="nc" id="L2054">    }</span>

    private void deleteSite() {
<span class="nc bnc" id="L2057" title="All 2 branches missed.">        if (mSite.isWPCom()) {</span>
<span class="nc" id="L2058">            mDeleteSiteProgressDialog =</span>
<span class="nc" id="L2059">                    ProgressDialog.show(getActivity(), &quot;&quot;, getString(R.string.delete_site_progress), true, false);</span>
<span class="nc" id="L2060">            AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_DELETE_SITE_REQUESTED, mSite);</span>
<span class="nc" id="L2061">            mDispatcher.dispatch(SiteActionBuilder.newDeleteSiteAction(mSite));</span>
        }
<span class="nc" id="L2063">    }</span>

    public void handleSiteDeleted() {
<span class="nc" id="L2066">        AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat</span>
                .SITE_SETTINGS_DELETE_SITE_RESPONSE_OK, mSite);
<span class="nc" id="L2068">        dismissProgressDialog(mDeleteSiteProgressDialog);</span>
<span class="nc" id="L2069">        mDeleteSiteProgressDialog = null;</span>
<span class="nc" id="L2070">        mSite = null;</span>
<span class="nc" id="L2071">    }</span>

    public void handleDeleteSiteError(DeleteSiteError error) {
<span class="nc" id="L2074">        AppLog.e(AppLog.T.SETTINGS, &quot;SiteDeleted error: &quot; + error.type);</span>

<span class="nc" id="L2076">        HashMap&lt;String, Object&gt; errorProperty = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2077">        errorProperty.put(ANALYTICS_ERROR_PROPERTY_KEY, error.message);</span>
<span class="nc" id="L2078">        AnalyticsUtils.trackWithSiteDetails(</span>
                AnalyticsTracker.Stat.SITE_SETTINGS_DELETE_SITE_RESPONSE_ERROR, mSite,
                errorProperty);
<span class="nc" id="L2081">        dismissProgressDialog(mDeleteSiteProgressDialog);</span>
<span class="nc" id="L2082">        mDeleteSiteProgressDialog = null;</span>

<span class="nc" id="L2084">        showDeleteSiteErrorDialog();</span>
<span class="nc" id="L2085">    }</span>

    private void showDeleteSiteErrorDialog() {
<span class="nc" id="L2088">        MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L2089">        builder.setTitle(R.string.error_deleting_site);</span>
<span class="nc" id="L2090">        builder.setMessage(R.string.error_deleting_site_summary);</span>
<span class="nc" id="L2091">        builder.setNegativeButton(R.string.cancel, (dialog, which) -&gt; dialog.dismiss());</span>
<span class="nc" id="L2092">        builder.setPositiveButton(R.string.contact_support,</span>
<span class="nc" id="L2093">                (dialog, which) -&gt; mZendeskHelper.createNewTicket(getActivity(), Origin.DELETE_SITE, mSite));</span>
<span class="nc" id="L2094">        builder.show();</span>
<span class="nc" id="L2095">    }</span>

    private MultiSelectRecyclerViewAdapter getAdapter() {
<span class="nc bnc" id="L2098" title="All 2 branches missed.">        if (mAdapter == null) {</span>
<span class="nc" id="L2099">            mAdapter = new MultiSelectRecyclerViewAdapter(mEditingList);</span>
        }

<span class="nc" id="L2102">        return mAdapter;</span>
    }

    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSiteChanged(OnSiteChanged event) {
<span class="nc bnc" id="L2107" title="All 4 branches missed.">        if (!event.isError() &amp;&amp; mSite != null) {</span>
<span class="nc" id="L2108">            mSite = mSiteStore.getSiteByLocalId(mSite.getId());</span>
<span class="nc" id="L2109">            updateHomepageSummary();</span>
        }
<span class="nc" id="L2111">    }</span>

    // Using an interface callback, cause this SiteSettingsFragment is a extending deprecated PreferenceFragment.  So,
    // can't use neither setTargetFragment nor onActivityResult before re-writing this!
    @Override
    public void onSelectTimezone(@NotNull String timezone) {
<span class="nc" id="L2117">        mSiteSettings.setTimezone(timezone);</span>
<span class="nc" id="L2118">        onPreferenceChange(mTimezonePref, timezone);</span>
<span class="nc" id="L2119">    }</span>

<span class="nc" id="L2121">    private final class ActionModeCallback implements ActionMode.Callback {</span>
        @Override
        public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
<span class="nc bnc" id="L2124" title="All 3 branches missed.">            switch (menuItem.getItemId()) {</span>
                case R.id.menu_delete:
<span class="nc" id="L2126">                    SparseBooleanArray checkedItems = getAdapter().getItemsSelected();</span>

<span class="nc" id="L2128">                    HashMap&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2129">                    properties.put(&quot;num_items_deleted&quot;, checkedItems.size());</span>
<span class="nc" id="L2130">                    AnalyticsUtils.trackWithSiteDetails(AnalyticsTracker.Stat.SITE_SETTINGS_DELETED_LIST_ITEMS,</span>
                            mSite, properties);

<span class="nc bnc" id="L2133" title="All 2 branches missed.">                    for (int i = checkedItems.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L2134">                        final int index = checkedItems.keyAt(i);</span>

<span class="nc bnc" id="L2136" title="All 2 branches missed.">                        if (checkedItems.get(index)) {</span>
<span class="nc" id="L2137">                            mEditingList.remove(index);</span>
                        }
                    }

<span class="nc" id="L2141">                    mSiteSettings.saveSettings();</span>
<span class="nc" id="L2142">                    mActionMode.finish();</span>
<span class="nc" id="L2143">                    return true;</span>
                case R.id.menu_select_all:
<span class="nc bnc" id="L2145" title="All 2 branches missed.">                    for (int i = 0; i &lt; getAdapter().getItemCount(); i++) {</span>
<span class="nc" id="L2146">                        getAdapter().setItemSelected(i);</span>
                    }

<span class="nc" id="L2149">                    mActionMode.invalidate();</span>
<span class="nc" id="L2150">                    return true;</span>
                default:
<span class="nc" id="L2152">                    return false;</span>
            }
        }

        @Override
        public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
<span class="nc" id="L2158">            mActionMode = actionMode;</span>
<span class="nc" id="L2159">            MenuInflater inflater = actionMode.getMenuInflater();</span>
<span class="nc" id="L2160">            inflater.inflate(R.menu.list_editor, menu);</span>

            // we cant use support version of action mode, since we start it on view
            // because of this we need to apply icon tint manually (it's supported only from api 26+)
<span class="nc" id="L2164">            MenuItem selectAll = menu.findItem(R.id.menu_select_all);</span>
<span class="nc" id="L2165">            MenuItem delete = menu.findItem(R.id.menu_delete);</span>
<span class="nc" id="L2166">            MenuItemCompat.setIconTintList(selectAll,</span>
<span class="nc" id="L2167">                    ContextExtensionsKt.getColorStateListFromAttribute(getActivity(), R.attr.wpColorActionModeIcon));</span>
<span class="nc" id="L2168">            MenuItemCompat.setIconTintList(delete,</span>
<span class="nc" id="L2169">                    ContextExtensionsKt.getColorStateListFromAttribute(getActivity(), R.attr.wpColorActionModeIcon));</span>

<span class="nc" id="L2171">            return true;</span>
        }

        @Override
        public void onDestroyActionMode(ActionMode mode) {
<span class="nc" id="L2176">            getAdapter().removeItemsSelected();</span>
<span class="nc" id="L2177">            mActionMode = null;</span>
<span class="nc" id="L2178">        }</span>

        @Override
        public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
<span class="nc" id="L2182">            actionMode.setTitle(getString(</span>
                    R.string.site_settings_list_editor_action_mode_title,
<span class="nc" id="L2184">                    getAdapter().getItemsSelected().size())</span>
            );
<span class="nc" id="L2186">            return true;</span>
        }

        @SuppressWarnings(&quot;unused&quot;)
        @Subscribe(threadMode = ThreadMode.MAIN)
        public void onSiteChanged(OnSiteChanged event) {
<span class="nc bnc" id="L2192" title="All 2 branches missed.">            if (!event.isError()) {</span>
<span class="nc" id="L2193">                mSite = mSiteStore.getSiteByLocalId(mSite.getId());</span>
            }
<span class="nc" id="L2195">        }</span>
    }

    /**
     * Show Disconnect button for development purposes. Only available in debug builds on Jetpack sites.
     */
    private boolean shouldShowDisconnect() {
<span class="nc bnc" id="L2202" title="All 6 branches missed.">        return BuildConfig.DEBUG &amp;&amp; mSite.isJetpackConnected() &amp;&amp; mSite.isUsingWpComRestApi();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>