<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PluginBrowserViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.viewmodel.plugins</a> &gt; <span class="el_source">PluginBrowserViewModel.kt</span></div><h1>PluginBrowserViewModel.kt</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package org.wordpress.android.viewmodel.plugins</span>

import android.os.Bundle
import android.os.Handler
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode
import org.wordpress.android.WordPress
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.generated.PluginActionBuilder
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.model.plugin.ImmutablePluginModel
import org.wordpress.android.fluxc.model.plugin.PluginDirectoryType
import org.wordpress.android.fluxc.store.PluginStore
import org.wordpress.android.fluxc.store.PluginStore.FetchPluginDirectoryPayload
import org.wordpress.android.fluxc.store.PluginStore.OnPluginDirectoryFetched
import org.wordpress.android.fluxc.store.PluginStore.OnPluginDirectorySearched
import org.wordpress.android.fluxc.store.PluginStore.OnSitePluginConfigured
import org.wordpress.android.fluxc.store.PluginStore.OnSitePluginDeleted
import org.wordpress.android.fluxc.store.PluginStore.OnSitePluginInstalled
import org.wordpress.android.fluxc.store.PluginStore.OnSitePluginUpdated
import org.wordpress.android.fluxc.store.PluginStore.OnWPOrgPluginFetched
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.fluxc.store.SiteStore.OnSiteChanged
import org.wordpress.android.models.networkresource.ListState
import org.wordpress.android.ui.ListDiffCallback
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import org.wordpress.android.util.SiteUtils
import org.wordpress.android.viewmodel.plugins.PluginBrowserViewModel.PluginListType.FEATURED
import org.wordpress.android.viewmodel.plugins.PluginBrowserViewModel.PluginListType.NEW
import org.wordpress.android.viewmodel.plugins.PluginBrowserViewModel.PluginListType.POPULAR
import org.wordpress.android.viewmodel.plugins.PluginBrowserViewModel.PluginListType.SEARCH
import org.wordpress.android.viewmodel.plugins.PluginBrowserViewModel.PluginListType.SITE
import javax.inject.Inject
import kotlin.properties.Delegates

private const val KEY_SEARCH_QUERY = &quot;KEY_SEARCH_QUERY&quot;
private const val KEY_TITLE = &quot;KEY_TITLE&quot;

typealias PluginListState = ListState&lt;ImmutablePluginModel&gt;

<span class="nc" id="L45">class PluginBrowserViewModel @Inject constructor(</span>
<span class="nc" id="L46">    private val mDispatcher: Dispatcher,</span>
<span class="nc" id="L47">    private val mPluginStore: PluginStore,</span>
<span class="nc" id="L48">    private val mSiteStore: SiteStore</span>
<span class="nc" id="L49">) : ViewModel() {</span>
    enum class PluginListType {
<span class="nc" id="L51">        SITE,</span>
<span class="nc" id="L52">        FEATURED,</span>
<span class="nc" id="L53">        POPULAR,</span>
<span class="nc" id="L54">        NEW,</span>
<span class="nc" id="L55">        SEARCH</span>
    }

    private var isStarted = false

<span class="nc" id="L60">    private val handler = Handler()</span>

<span class="nc" id="L62">    private val _featuredPluginsLiveData = MutableLiveData&lt;PluginListState&gt;()</span>
<span class="nc" id="L63">    private val _popularPluginsLiveData = MutableLiveData&lt;PluginListState&gt;()</span>
<span class="nc" id="L64">    private val _newPluginsLiveData = MutableLiveData&lt;PluginListState&gt;()</span>
<span class="nc" id="L65">    private val _sitePluginsLiveData = MutableLiveData&lt;PluginListState&gt;()</span>
<span class="nc" id="L66">    private val _searchResultsLiveData = MutableLiveData&lt;PluginListState&gt;()</span>

    val featuredPluginsLiveData: LiveData&lt;PluginListState&gt;
<span class="nc" id="L69">        get() = _featuredPluginsLiveData</span>

    val popularPluginsLiveData: LiveData&lt;PluginListState&gt;
<span class="nc" id="L72">        get() = _popularPluginsLiveData</span>

    val newPluginsLiveData: LiveData&lt;PluginListState&gt;
<span class="nc" id="L75">        get() = _newPluginsLiveData</span>

    val sitePluginsLiveData: LiveData&lt;PluginListState&gt;
<span class="nc" id="L78">        get() = _sitePluginsLiveData</span>

    val searchResultsLiveData: LiveData&lt;PluginListState&gt;
<span class="nc" id="L81">        get() = _searchResultsLiveData</span>

    private var featuredPlugins: ListState&lt;ImmutablePluginModel&gt;
<span class="nc" id="L84">            by Delegates.observable(ListState.Init()) { _, _, new -&gt;</span>
                _featuredPluginsLiveData.postValue(new)
            }
    private var popularPlugins: ListState&lt;ImmutablePluginModel&gt;
<span class="nc" id="L88">            by Delegates.observable(ListState.Init()) { _, _, new -&gt;</span>
                _popularPluginsLiveData.postValue(new)
            }
    private var newPlugins: ListState&lt;ImmutablePluginModel&gt;
<span class="nc" id="L92">            by Delegates.observable(ListState.Init()) { _, _, new -&gt;</span>
                _newPluginsLiveData.postValue(new)
            }
    private var sitePlugins: ListState&lt;ImmutablePluginModel&gt;
<span class="nc" id="L96">            by Delegates.observable(ListState.Init()) { _, _, new -&gt;</span>
                _sitePluginsLiveData.postValue(new)
            }
    private var searchResults: ListState&lt;ImmutablePluginModel&gt;
<span class="nc" id="L100">            by Delegates.observable(ListState.Init()) { _, _, new -&gt;</span>
                _searchResultsLiveData.postValue(new)
            }

<span class="nc" id="L104">    private val _title = MutableLiveData&lt;String&gt;()</span>
    val title: LiveData&lt;String&gt;
<span class="nc" id="L106">        get() = _title</span>

<span class="nc bnc" id="L108" title="All 2 branches missed.">    lateinit var site: SiteModel</span>

<span class="nc" id="L110">    var searchQuery: String by Delegates.observable(&quot;&quot;) {</span>
        _, oldValue, newValue -&gt;
        if (newValue != oldValue) {
            submitSearch(newValue, true)
        }
    }

    private val shouldSearch: Boolean
<span class="nc bnc" id="L118" title="All 2 branches missed.">        get() = searchQuery.length &gt; 1 // We need at least 2 characters to be able to search plugins</span>

<span class="nc" id="L120">    init {</span>
<span class="nc" id="L121">        mDispatcher.register(this)</span>
<span class="nc" id="L122">    }</span>

    override fun onCleared() {
<span class="nc" id="L125">        mDispatcher.unregister(this)</span>
<span class="nc" id="L126">        super.onCleared()</span>
<span class="nc" id="L127">    }</span>

    fun writeToBundle(outState: Bundle) {
<span class="nc" id="L130">        outState.putSerializable(WordPress.SITE, site)</span>
<span class="nc" id="L131">        outState.putString(KEY_SEARCH_QUERY, searchQuery)</span>
<span class="nc" id="L132">        outState.putString(KEY_TITLE, _title.value)</span>
<span class="nc" id="L133">    }</span>

    fun readFromBundle(savedInstanceState: Bundle) {
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (isStarted) {</span>
            // This was called due to a config change where the data survived, we don't need to
            // read from the bundle
<span class="nc" id="L139">            return</span>
        }
<span class="nc bnc" id="L141" title="All 2 branches missed.">        site = savedInstanceState.getSerializable(WordPress.SITE) as SiteModel</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        searchQuery = requireNotNull(savedInstanceState.getString(KEY_SEARCH_QUERY))</span>
<span class="nc" id="L143">        setTitle(savedInstanceState.getString(KEY_TITLE))</span>
<span class="nc" id="L144">    }</span>

    fun start() {
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (isStarted) {</span>
<span class="nc" id="L148">            return</span>
        }
<span class="nc" id="L150">        updateListStateToReady(PluginDirectoryType.FEATURED)</span>
<span class="nc" id="L151">        updateListStateToReady(PluginDirectoryType.NEW)</span>
<span class="nc" id="L152">        updateListStateToReady(PluginDirectoryType.POPULAR)</span>
<span class="nc" id="L153">        updateListStateToReady(PluginDirectoryType.SITE)</span>

<span class="nc" id="L155">        fetchPlugins(SITE, false)</span>
<span class="nc" id="L156">        fetchPlugins(FEATURED, false)</span>
<span class="nc" id="L157">        fetchPlugins(POPULAR, false)</span>
<span class="nc" id="L158">        fetchPlugins(NEW, false)</span>

<span class="nc" id="L160">        isStarted = true</span>
<span class="nc" id="L161">    }</span>

    // Actions

    fun getDiffCallback(oldList: List&lt;ImmutablePluginModel&gt;, newList: List&lt;ImmutablePluginModel&gt;):
            ListDiffCallback&lt;ImmutablePluginModel&gt; {
<span class="nc" id="L167">        val areItemsTheSame: (ImmutablePluginModel?, ImmutablePluginModel?) -&gt; Boolean = { old, new -&gt;</span>
<span class="nc bnc" id="L168" title="All 4 branches missed.">            old?.slug == new?.slug</span>
        }

<span class="nc" id="L171">        val areContentsTheSame: (ImmutablePluginModel?, ImmutablePluginModel?) -&gt; Boolean = { old, new -&gt;</span>
<span class="nc" id="L172">            var same = false</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            old?.let {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                new?.let {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                    same = old.slug == new.slug &amp;&amp;</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                            old.displayName == new.displayName &amp;&amp;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                            old.authorName == new.authorName &amp;&amp;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                            old.icon == new.icon &amp;&amp;</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                            old.isInstalled == new.isInstalled &amp;&amp;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                            old.isActive == new.isActive &amp;&amp;</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                            old.isAutoUpdateEnabled == new.isAutoUpdateEnabled &amp;&amp;</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                            old.installedVersion == new.installedVersion &amp;&amp;</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                            old.wpOrgPluginVersion == new.wpOrgPluginVersion &amp;&amp;</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                            old.averageStarRating == new.averageStarRating</span>
<span class="nc" id="L185">                }</span>
            }
<span class="nc" id="L187">            same</span>
        }
<span class="nc" id="L189">        return ListDiffCallback(oldList, newList, areItemsTheSame, areContentsTheSame)</span>
    }

    fun loadMore(listType: PluginListType) {
<span class="nc" id="L193">        fetchPlugins(listType, true)</span>
<span class="nc" id="L194">    }</span>

    fun pullToRefresh(pluginListType: PluginListType) {
<span class="nc" id="L197">        fetchPlugins(pluginListType, false)</span>
<span class="nc" id="L198">    }</span>

    // Network Requests

    private fun fetchPlugins(listType: PluginListType, loadMore: Boolean) {
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (!shouldFetchPlugins(listType, loadMore)) {</span>
<span class="nc" id="L204">            return</span>
        }
<span class="nc bnc" id="L206" title="All 6 branches missed.">        when (listType) {</span>
            SITE -&gt; {
<span class="nc" id="L208">                sitePlugins = ListState.Loading(sitePlugins, loadMore)</span>
<span class="nc" id="L209">                val payload = FetchPluginDirectoryPayload(PluginDirectoryType.SITE, site, loadMore)</span>
<span class="nc" id="L210">                mDispatcher.dispatch(PluginActionBuilder.newFetchPluginDirectoryAction(payload))</span>
            }
            FEATURED -&gt; {
<span class="nc" id="L213">                featuredPlugins = ListState.Loading(featuredPlugins, loadMore)</span>
<span class="nc" id="L214">                val featuredPayload = FetchPluginDirectoryPayload(PluginDirectoryType.FEATURED, site, loadMore)</span>
<span class="nc" id="L215">                mDispatcher.dispatch(PluginActionBuilder.newFetchPluginDirectoryAction(featuredPayload))</span>
            }
            POPULAR -&gt; {
<span class="nc" id="L218">                popularPlugins = ListState.Loading(popularPlugins, loadMore)</span>
<span class="nc" id="L219">                val popularPayload = FetchPluginDirectoryPayload(PluginDirectoryType.POPULAR, site, loadMore)</span>
<span class="nc" id="L220">                mDispatcher.dispatch(PluginActionBuilder.newFetchPluginDirectoryAction(popularPayload))</span>
            }
            NEW -&gt; {
<span class="nc" id="L223">                newPlugins = ListState.Loading(newPlugins, loadMore)</span>
<span class="nc" id="L224">                val newPayload = FetchPluginDirectoryPayload(PluginDirectoryType.NEW, site, loadMore)</span>
<span class="nc" id="L225">                mDispatcher.dispatch(PluginActionBuilder.newFetchPluginDirectoryAction(newPayload))</span>
            }
            SEARCH -&gt; {
<span class="nc" id="L228">                searchResults = ListState.Loading(searchResults, loadMore)</span>
<span class="nc" id="L229">                val searchPayload = PluginStore.SearchPluginDirectoryPayload(site, searchQuery, 1)</span>
<span class="nc" id="L230">                mDispatcher.dispatch(PluginActionBuilder.newSearchPluginDirectoryAction(searchPayload))</span>
            }
        }
<span class="nc" id="L233">    }</span>

    private fun shouldFetchPlugins(listType: PluginListType, loadMore: Boolean): Boolean {
<span class="nc bnc" id="L236" title="All 4 branches missed.">        if (listType == SITE &amp;&amp; SiteUtils.isNonAtomicBusinessPlanSite(site)) {</span>
<span class="nc" id="L237">            return false</span>
        }
<span class="nc bnc" id="L239" title="All 5 branches missed.">        return when (listType) {</span>
<span class="nc" id="L240">            SITE -&gt; sitePlugins.shouldFetch(loadMore)</span>
<span class="nc" id="L241">            FEATURED -&gt; featuredPlugins.shouldFetch(loadMore)</span>
<span class="nc" id="L242">            POPULAR -&gt; popularPlugins.shouldFetch(loadMore)</span>
<span class="nc" id="L243">            NEW -&gt; newPlugins.shouldFetch(loadMore)</span>
            // We should always do the initial search because the string might have changed and it is
            // already optimized in submitSearch with a delay. Even though FluxC allows it, we don't do multiple
            // pages of search, so if we are trying to load more, we can ignore it
<span class="nc bnc" id="L247" title="All 2 branches missed.">            SEARCH -&gt; !loadMore</span>
        }
    }

    // Network Callbacks

    @Subscribe(threadMode = ThreadMode.MAIN)
    @SuppressWarnings(&quot;unused&quot;)
    fun onWPOrgPluginFetched(event: OnWPOrgPluginFetched) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (event.isError) {</span>
<span class="nc" id="L257">            AppLog.e(T.PLUGINS, &quot;An error occurred while fetching the wporg plugin with type: &quot; + event.error.type)</span>
<span class="nc" id="L258">            return</span>
        }
<span class="nc" id="L260">        updateAllPluginListsForSlug(event.pluginSlug)</span>
<span class="nc" id="L261">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    @SuppressWarnings(&quot;unused&quot;)
    fun onPluginDirectoryFetched(event: OnPluginDirectoryFetched) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (event.isError) {</span>
<span class="nc" id="L267">            AppLog.e(T.PLUGINS, &quot;An error occurred while fetching the plugin directory &quot; + event.type + &quot;: &quot; +</span>
<span class="nc" id="L268">                    event.error.type)</span>
<span class="nc" id="L269">            updateListStateToError(event.type, event.error.message)</span>
        } else {
<span class="nc" id="L271">            updateListStateToSuccess(event.type, event.canLoadMore)</span>
        }
<span class="nc" id="L273">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    @SuppressWarnings(&quot;unused&quot;)
    fun onPluginDirectorySearched(event: OnPluginDirectorySearched) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (searchQuery != event.searchTerm) {</span>
<span class="nc" id="L279">            return</span>
        }
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (event.isError) {</span>
<span class="nc" id="L282">            AppLog.e(T.PLUGINS, &quot;An error occurred while searching the plugin directory&quot;)</span>
<span class="nc" id="L283">            searchResults = ListState.Error(searchResults, event.error.message)</span>
<span class="nc" id="L284">            return</span>
        }
<span class="nc" id="L286">        searchResults = ListState.Success(event.plugins, false) // Disable pagination for search</span>
<span class="nc" id="L287">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    @SuppressWarnings(&quot;unused&quot;)
    fun onSitePluginConfigured(event: OnSitePluginConfigured) {
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (event.isError) {</span>
            // The error should be handled wherever the action has been triggered from (probably PluginDetailActivity)
<span class="nc" id="L294">            return</span>
        }
<span class="nc" id="L296">        updateAllPluginListsForSlug(event.slug)</span>
<span class="nc" id="L297">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    @SuppressWarnings(&quot;unused&quot;)
    fun onSitePluginDeleted(event: OnSitePluginDeleted) {
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (event.isError) {</span>
            // The error should be handled wherever the action has been triggered from (probably PluginDetailActivity)
<span class="nc" id="L304">            return</span>
        }
<span class="nc" id="L306">        updateAllPluginListsForSlug(event.slug)</span>
<span class="nc" id="L307">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    @SuppressWarnings(&quot;unused&quot;)
    fun onSitePluginInstalled(event: OnSitePluginInstalled) {
<span class="nc bnc" id="L312" title="All 2 branches missed.">        if (event.isError) {</span>
            // The error should be handled wherever the action has been triggered from (probably PluginDetailActivity)
<span class="nc" id="L314">            return</span>
        }
<span class="nc" id="L316">        updateAllPluginListsForSlug(event.slug)</span>
<span class="nc" id="L317">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    @SuppressWarnings(&quot;unused&quot;)
    fun onSitePluginUpdated(event: OnSitePluginUpdated) {
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (event.isError) {</span>
            // The error should be handled wherever the action has been triggered from (probably PluginDetailActivity)
<span class="nc" id="L324">            return</span>
        }
<span class="nc" id="L326">        updateAllPluginListsForSlug(event.slug)</span>
<span class="nc" id="L327">    }</span>

    @Subscribe(threadMode = ThreadMode.BACKGROUND)
    @SuppressWarnings(&quot;unused&quot;)
    fun onSiteChanged(event: OnSiteChanged) {
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (event.isError) {</span>
            // The error should be safe to ignore since we are not triggering the action and there is nothing we need
            // to do about it
<span class="nc" id="L335">            return</span>
        }

<span class="nc bnc" id="L338" title="All 2 branches missed.">        site = if (site.isUsingWpComRestApi) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            requireNotNull(mSiteStore.getSiteBySiteId(site.siteId))</span>
        } else {
<span class="nc bnc" id="L341" title="All 2 branches missed.">            requireNotNull(mSiteStore.getSiteByLocalId(site.id))</span>
        }
<span class="nc" id="L343">    }</span>

    // Keeping the data up to date

    private fun updateAllPluginListsForSlug(slug: String?) {
<span class="nc bnc" id="L348" title="All 2 branches missed.">        mPluginStore.getImmutablePluginBySlug(site, slug)?.let { updatedPlugin -&gt;</span>
<span class="nc" id="L349">            val transformFunc: (List&lt;ImmutablePluginModel&gt;) -&gt; List&lt;ImmutablePluginModel&gt; = { list -&gt;</span>
<span class="nc" id="L350">                list.map { currentPlugin -&gt;</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                    if (currentPlugin.slug == slug) updatedPlugin else currentPlugin</span>
                }
            }
<span class="nc" id="L354">            featuredPlugins = featuredPlugins.transform(transformFunc)</span>
<span class="nc" id="L355">            newPlugins = newPlugins.transform(transformFunc)</span>
<span class="nc" id="L356">            searchResults = searchResults.transform(transformFunc)</span>
<span class="nc" id="L357">            popularPlugins = popularPlugins.transform(transformFunc)</span>

<span class="nc" id="L359">            sitePlugins = sitePlugins.transform { list -&gt;</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                if (!updatedPlugin.isInstalled) {</span>
<span class="nc bnc" id="L361" title="All 4 branches missed.">                    list.filter { it.slug != slug }</span>
<span class="nc bnc" id="L362" title="All 4 branches missed.">                } else if (list.none { it.slug == slug }) {</span>
<span class="nc" id="L363">                    list.plus(updatedPlugin).sortedBy { it.displayName }</span>
                } else {
<span class="nc bnc" id="L365" title="All 2 branches missed.">                    list.map { if (it.slug == slug) updatedPlugin else it }</span>
                }
            }
<span class="nc" id="L368">        }</span>
<span class="nc" id="L369">    }</span>

    private fun submitSearch(query: String, delayed: Boolean) {
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (delayed) {</span>
<span class="nc" id="L373">            handler.postDelayed({</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if (query == searchQuery) {</span>
<span class="nc" id="L375">                    submitSearch(query, false)</span>
                }
<span class="nc" id="L377">            }, 250)</span>
        } else {
<span class="nc" id="L379">            searchResults = ListState.Ready(ArrayList())</span>

<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (shouldSearch) {</span>
<span class="nc" id="L382">                fetchPlugins(SEARCH, false)</span>
            }
        }
<span class="nc" id="L385">    }</span>

    fun shouldShowEmptySearchResultsView(): Boolean {
        // Search query is less than 2 characters
<span class="nc bnc" id="L389" title="All 2 branches missed.">        if (!shouldSearch) {</span>
<span class="nc" id="L390">            return false</span>
        }
<span class="nc" id="L392">        return when (searchResults) {</span>
<span class="nc bnc" id="L393" title="All 4 branches missed.">            is ListState.Success, is ListState.Error -&gt; searchResults.data.isEmpty()</span>
<span class="nc" id="L394">            else -&gt; false</span>
        }
    }

    fun setTitle(title: String?) {
<span class="nc bnc" id="L399" title="All 2 branches missed.">        _title.postValue(title ?: &quot;&quot;)</span>
<span class="nc" id="L400">    }</span>

    // ListState Helpers

    private fun updateListStateToReady(directoryType: PluginDirectoryType) {
<span class="nc" id="L405">        val pluginList = mPluginStore.getPluginDirectory(site, directoryType)</span>
<span class="nc bnc" id="L406" title="All 5 branches missed.">        when (directoryType) {</span>
<span class="nc" id="L407">            PluginDirectoryType.FEATURED -&gt; featuredPlugins = ListState.Ready(pluginList)</span>
<span class="nc" id="L408">            PluginDirectoryType.NEW -&gt; newPlugins = ListState.Ready(pluginList)</span>
<span class="nc" id="L409">            PluginDirectoryType.POPULAR -&gt; popularPlugins = ListState.Ready(pluginList)</span>
<span class="nc" id="L410">            PluginDirectoryType.SITE -&gt; sitePlugins = ListState.Ready(pluginList)</span>
        }
<span class="nc" id="L412">    }</span>

    private fun updateListStateToSuccess(directoryType: PluginDirectoryType, canLoadMore: Boolean) {
<span class="nc" id="L415">        val pluginList = mPluginStore.getPluginDirectory(site, directoryType)</span>
<span class="nc bnc" id="L416" title="All 5 branches missed.">        when (directoryType) {</span>
<span class="nc" id="L417">            PluginDirectoryType.FEATURED -&gt; featuredPlugins = ListState.Success(pluginList, canLoadMore)</span>
<span class="nc" id="L418">            PluginDirectoryType.NEW -&gt; newPlugins = ListState.Success(pluginList, canLoadMore)</span>
<span class="nc" id="L419">            PluginDirectoryType.POPULAR -&gt; popularPlugins = ListState.Success(pluginList, canLoadMore)</span>
<span class="nc" id="L420">            PluginDirectoryType.SITE -&gt; sitePlugins = ListState.Success(pluginList, canLoadMore)</span>
        }
<span class="nc" id="L422">    }</span>

    private fun updateListStateToError(directoryType: PluginDirectoryType, errorMessage: String?) {
<span class="nc bnc" id="L425" title="All 5 branches missed.">        when (directoryType) {</span>
<span class="nc" id="L426">            PluginDirectoryType.FEATURED -&gt; featuredPlugins = ListState.Error(featuredPlugins, errorMessage)</span>
<span class="nc" id="L427">            PluginDirectoryType.NEW -&gt; newPlugins = ListState.Error(newPlugins, errorMessage)</span>
<span class="nc" id="L428">            PluginDirectoryType.POPULAR -&gt; popularPlugins = ListState.Error(popularPlugins, errorMessage)</span>
<span class="nc" id="L429">            PluginDirectoryType.SITE -&gt; sitePlugins = ListState.Error(sitePlugins, errorMessage)</span>
        }
<span class="nc" id="L431">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>