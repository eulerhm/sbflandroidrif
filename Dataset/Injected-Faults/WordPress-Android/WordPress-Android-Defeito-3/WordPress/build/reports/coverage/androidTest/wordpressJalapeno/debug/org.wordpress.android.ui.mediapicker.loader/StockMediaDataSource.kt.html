<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StockMediaDataSource.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.mediapicker.loader</a> &gt; <span class="el_source">StockMediaDataSource.kt</span></div><h1>StockMediaDataSource.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.mediapicker.loader

import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.withContext
import org.wordpress.android.R
import org.wordpress.android.fluxc.store.StockMediaStore
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.ui.mediapicker.MediaItem
import org.wordpress.android.ui.mediapicker.MediaItem.Identifier.StockMediaIdentifier
import org.wordpress.android.ui.mediapicker.MediaType.IMAGE
import org.wordpress.android.ui.mediapicker.loader.MediaSource.MediaLoadingResult
import org.wordpress.android.ui.mediapicker.loader.MediaSource.MediaLoadingResult.Empty
import org.wordpress.android.ui.mediapicker.loader.MediaSource.MediaLoadingResult.Failure
import org.wordpress.android.ui.mediapicker.loader.MediaSource.MediaLoadingResult.Success
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringResWithParams
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.NetworkUtilsWrapper
import javax.inject.Inject
import javax.inject.Named

<span class="nc" id="L22">class StockMediaDataSource</span>
<span class="nc" id="L23">@Inject constructor(</span>
<span class="nc" id="L24">    private val stockMediaStore: StockMediaStore,</span>
<span class="nc" id="L25">    @param:Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L26">    private val networkUtilsWrapper: NetworkUtilsWrapper</span>
) : MediaSource {
    override suspend fun load(
        forced: Boolean,
        loadMore: Boolean,
        filter: String?
    ): MediaLoadingResult {
<span class="nc bnc" id="L33" title="All 2 branches missed.">        if (!networkUtilsWrapper.isNetworkAvailable()) {</span>
<span class="nc" id="L34">            return Failure(</span>
<span class="nc" id="L35">                    UiStringRes(R.string.no_network_title),</span>
<span class="nc" id="L36">                    htmlSubtitle = UiStringRes(R.string.no_network_message),</span>
<span class="nc" id="L37">                    image = R.drawable.img_illustration_cloud_off_152dp,</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">                    data = if (loadMore) get() else listOf()</span>
            )
        }
<span class="nc bnc" id="L41" title="All 4 branches missed.">        return withValidFilter(filter) { validFilter -&gt;</span>
<span class="nc" id="L42">            val result = stockMediaStore.fetchStockMedia(validFilter, loadMore)</span>
<span class="nc" id="L43">            val error = result.error</span>
<span class="nc" id="L44">            return@withValidFilter when {</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">                error != null -&gt; {</span>
<span class="nc" id="L46">                    Failure(</span>
<span class="nc" id="L47">                            UiStringRes(R.string.media_loading_failed),</span>
<span class="nc" id="L48">                            htmlSubtitle = UiStringText(error.message),</span>
<span class="nc" id="L49">                            image = R.drawable.img_illustration_cloud_off_152dp,</span>
<span class="nc" id="L50">                            data = get()</span>
                    )
                }
                else -&gt; {
<span class="nc" id="L54">                    val data = get()</span>
<span class="nc bnc" id="L55" title="All 4 branches missed.">                    if (data.isNotEmpty()) {</span>
<span class="nc" id="L56">                        Success(data, result.canLoadMore)</span>
                    } else {
<span class="nc" id="L58">                        Empty(</span>
<span class="nc" id="L59">                                UiStringRes(R.string.media_empty_search_list),</span>
<span class="nc" id="L60">                                image = R.drawable.img_illustration_empty_results_216dp</span>
                        )
                    }
                }
            }
<span class="nc" id="L65">        } ?: buildDefaultScreen()</span>
    }

    private fun buildDefaultScreen(): MediaLoadingResult {
<span class="nc" id="L69">        val title = UiStringRes(R.string.stock_media_picker_initial_empty_text)</span>
<span class="nc" id="L70">        val link = &quot;&lt;a href='https://pexels.com/'&gt;Pexels&lt;/a&gt;&quot;</span>
<span class="nc" id="L71">        val subtitle = UiStringResWithParams(</span>
<span class="nc" id="L72">                R.string.stock_media_picker_initial_empty_subtext,</span>
<span class="nc" id="L73">                listOf(UiStringText(link))</span>
        )
<span class="nc" id="L75">        return Empty(title, subtitle)</span>
    }

<span class="nc" id="L78">    private suspend fun get(): List&lt;MediaItem&gt; {</span>
<span class="nc" id="L79">        return stockMediaStore.getStockMedia()</span>
<span class="nc" id="L80">                .mapNotNull {</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">                    it.url?.let { url -&gt;</span>
<span class="nc" id="L82">                        MediaItem(</span>
<span class="nc" id="L83">                                StockMediaIdentifier(it.url, it.name, it.title),</span>
<span class="nc" id="L84">                                url,</span>
<span class="nc" id="L85">                                it.name,</span>
<span class="nc" id="L86">                                IMAGE,</span>
<span class="nc" id="L87">                                null,</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">                                it.date?.toLongOrNull() ?: 0</span>
                        )
                    }
                }
    }

    private suspend fun &lt;T&gt; withValidFilter(filter: String?, action: suspend (filter: String) -&gt; T): T? {
<span class="nc bnc" id="L95" title="All 4 branches missed.">        return if (filter != null &amp;&amp; filter.length &gt;= MIN_SEARCH_QUERY_SIZE) {</span>
<span class="nc" id="L96">            withContext(bgDispatcher) {</span>
<span class="nc" id="L97">                action(filter)</span>
            }
        } else {
<span class="nc" id="L100">            null</span>
        }
    }

    companion object {
        private const val MIN_SEARCH_QUERY_SIZE = 3
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>