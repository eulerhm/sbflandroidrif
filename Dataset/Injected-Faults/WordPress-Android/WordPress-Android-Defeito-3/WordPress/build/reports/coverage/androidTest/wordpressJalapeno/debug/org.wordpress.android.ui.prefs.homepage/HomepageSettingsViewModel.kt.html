<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HomepageSettingsViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs.homepage</a> &gt; <span class="el_source">HomepageSettingsViewModel.kt</span></div><h1>HomepageSettingsViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs.homepage

import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.flow.collect
import kotlinx.coroutines.flow.filter
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode
import org.wordpress.android.R
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.model.SiteHomepageSettings
import org.wordpress.android.fluxc.model.SiteHomepageSettings.ShowOnFront
import org.wordpress.android.fluxc.model.page.PageModel
import org.wordpress.android.fluxc.store.SiteOptionsStore
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.fluxc.store.SiteStore.OnSiteChanged
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.prefs.homepage.HomepageSettingsDataLoader.LoadingResult.Data
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ScopedViewModel
import javax.inject.Inject
import javax.inject.Named

class HomepageSettingsViewModel
<span class="nc" id="L29">@Inject constructor(</span>
<span class="nc" id="L30">    @Named(UI_THREAD) private val mainDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L31">    @Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L32">    private val dispatcher: Dispatcher,</span>
<span class="nc" id="L33">    private val homepageSettingsDataLoader: HomepageSettingsDataLoader,</span>
<span class="nc" id="L34">    private val siteStore: SiteStore,</span>
<span class="nc" id="L35">    private val siteOptionsStore: SiteOptionsStore</span>
<span class="nc" id="L36">) : ScopedViewModel(mainDispatcher) {</span>
<span class="nc" id="L37">    private val _uiState = MutableLiveData&lt;HomepageSettingsUiState&gt;()</span>
<span class="nc" id="L38">    val uiState: LiveData&lt;HomepageSettingsUiState&gt; = _uiState</span>
<span class="nc" id="L39">    private val _dismissDialogEvent = MutableLiveData&lt;Event&lt;Unit&gt;&gt;()</span>
<span class="nc" id="L40">    val dismissDialogEvent: LiveData&lt;Event&lt;Unit&gt;&gt; = _dismissDialogEvent</span>

    fun classicBlogSelected() {
<span class="nc" id="L43">        updateUiStateFromMainThread { it.updateClassicBlogState(isClassicBlogState = true) }</span>
<span class="nc" id="L44">    }</span>

    fun staticHomepageSelected() {
<span class="nc" id="L47">        updateUiStateFromMainThread { it.updateClassicBlogState(isClassicBlogState = false) }</span>
<span class="nc" id="L48">    }</span>

    fun onPageOnFrontSelected(id: Int): Boolean {
<span class="nc" id="L51">        return updateUiStateFromMainThread { it.updateWithPageOnFront(id) }</span>
    }

    fun onPageForPostsSelected(id: Int): Boolean {
<span class="nc" id="L55">        return updateUiStateFromMainThread { it.updateWithPageForPosts(id) }</span>
    }

    fun onPageOnFrontDialogOpened() {
<span class="nc" id="L59">        onDialogStateChange(pageOnFrontDialogOpened = true)</span>
<span class="nc" id="L60">    }</span>

    fun onPageForPostsDialogOpened() {
<span class="nc" id="L63">        onDialogStateChange(pageForPostsDialogOpened = true)</span>
<span class="nc" id="L64">    }</span>

    fun onDialogHidden() {
<span class="nc" id="L67">        onDialogStateChange()</span>
<span class="nc" id="L68">    }</span>

<span class="nc" id="L70">    private fun onDialogStateChange(</span>
<span class="nc" id="L71">        pageOnFrontDialogOpened: Boolean = false,</span>
<span class="nc" id="L72">        pageForPostsDialogOpened: Boolean = false</span>
    ) {
<span class="nc" id="L74">        updateUiStateFromMainThread { pagesUiState -&gt;</span>
<span class="nc" id="L75">            pagesUiState.copy(</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                    pageOnFrontState = pagesUiState.pageOnFrontState?.copy(</span>
<span class="nc" id="L77">                            isExpanded = pageOnFrontDialogOpened</span>
                    ),
<span class="nc bnc" id="L79" title="All 2 branches missed.">                    pageForPostsState = pagesUiState.pageForPostsState?.copy(</span>
<span class="nc" id="L80">                            isExpanded = pageForPostsDialogOpened</span>
                    )
            )
        }
<span class="nc" id="L84">    }</span>

    fun onAcceptClicked() {
<span class="nc" id="L87">        val currentUiState = _uiState.value</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (currentUiState == null) {</span>
<span class="nc" id="L89">            updateUiStateFromMainThread { it.updateWithError(R.string.site_settings_failed_to_save_homepage_settings) }</span>
<span class="nc" id="L90">            return</span>
        }
<span class="nc" id="L92">        updateUiStateFromMainThread { it.updateWithLoading() }</span>
<span class="nc" id="L93">        launch {</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            val siteHomepageSettings = if (currentUiState.isClassicBlogState) {</span>
<span class="nc" id="L95">                SiteHomepageSettings.Posts</span>
            } else {
<span class="nc" id="L97">                val pageForPostsModel = currentUiState.pageForPostsState</span>
<span class="nc" id="L98">                val pageOnFrontModel = currentUiState.pageOnFrontState</span>
<span class="nc bnc" id="L99" title="All 4 branches missed.">                if (pageForPostsModel == null || pageOnFrontModel == null) {</span>
<span class="nc" id="L100">                    updateUiState {</span>
<span class="nc" id="L101">                        it.updateWithError(R.string.site_settings_cannot_save_homepage_settings_before_pages_loaded)</span>
                    }
<span class="nc" id="L103">                    return@launch</span>
                }
<span class="nc bnc" id="L105" title="All 2 branches missed.">                if (pageForPostsModel == pageOnFrontModel) {</span>
<span class="nc" id="L106">                    updateUiState {</span>
<span class="nc" id="L107">                        it.updateWithError(R.string.site_settings_page_for_posts_and_homepage_cannot_be_equal)</span>
                    }
<span class="nc" id="L109">                    return@launch</span>
                }

<span class="nc" id="L112">                SiteHomepageSettings.StaticPage(</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                        pageForPostsId = pageForPostsModel.getSelectedItemRemoteId() ?: 0,</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                        pageOnFrontId = pageOnFrontModel.getSelectedItemRemoteId() ?: 0</span>
                )
            }
<span class="nc" id="L117">            val updateResult = siteOptionsStore.updateHomepage(currentUiState.siteModel, siteHomepageSettings)</span>
<span class="nc" id="L118">            when (updateResult.isError) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                true -&gt; {</span>
<span class="nc" id="L120">                    updateUiState { it.updateWithError(R.string.site_settings_failed_update_homepage_settings) }</span>
                }
<span class="nc bnc" id="L122" title="All 2 branches missed.">                false -&gt; _dismissDialogEvent.value = Event(Unit)</span>
            }
<span class="nc" id="L124">        }</span>
<span class="nc" id="L125">    }</span>

    fun onDismissClicked() {
<span class="nc" id="L128">        _dismissDialogEvent.value = Event(Unit)</span>
<span class="nc" id="L129">    }</span>

    fun getSelectedPageOnFrontId(): Long? {
<span class="nc bnc" id="L132" title="All 4 branches missed.">        return _uiState.value?.pageOnFrontState?.getSelectedItemRemoteId()</span>
    }

    fun getSelectedPageForPostsId(): Long? {
<span class="nc bnc" id="L136" title="All 4 branches missed.">        return _uiState.value?.pageForPostsState?.getSelectedItemRemoteId()</span>
    }

    fun isClassicBlog(): Boolean? {
<span class="nc bnc" id="L140" title="All 2 branches missed.">        return _uiState.value?.isClassicBlogState</span>
    }

    fun start(siteId: Int, savedClassicBlogValue: Boolean?, savedPageForPostsId: Long?, savedPageOnFrontId: Long?) {
<span class="nc" id="L144">        dispatcher.register(this)</span>
<span class="nc" id="L145">        launch {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            val siteModel = siteStore.getSiteByLocalId(siteId)</span>
<span class="nc" id="L147">                    ?: throw IllegalStateException(&quot;SiteModel has to be present&quot;)</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            val isClassicBlog = savedClassicBlogValue ?: siteModel.showOnFront == ShowOnFront.POSTS.value</span>
<span class="nc" id="L149">            _uiState.value = HomepageSettingsUiState(</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                    isClassicBlogState = isClassicBlog,</span>
<span class="nc" id="L151">                    siteModel = siteModel</span>
            )
<span class="nc bnc" id="L153" title="All 2 branches missed.">            val pageOnFrontId = savedPageOnFrontId ?: siteModel.pageOnFront</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            val pageForPostsId = savedPageForPostsId ?: siteModel.pageForPosts</span>
<span class="nc" id="L155">            val loadPagesFlow = homepageSettingsDataLoader.loadPages(</span>
<span class="nc" id="L156">                    siteModel</span>
            )

<span class="nc" id="L159">            withContext(bgDispatcher) {</span>
<span class="nc" id="L160">                loadPagesFlow.filter { loadingResult -&gt;</span>
                    loadingResult !is Data || loadingResult.pages.isValid(pageOnFrontId, pageForPostsId)
                }
<span class="nc" id="L163">                        .collect { loadingResult -&gt;</span>
                            updateUiState { currentValue -&gt;
<span class="nc" id="L165">                                currentValue.updateWithLoadingResult(loadingResult, pageForPostsId, pageOnFrontId)</span>
                            }
                        }
<span class="nc" id="L168">            }</span>
<span class="nc" id="L169">        }</span>
<span class="nc" id="L170">    }</span>

    override fun onCleared() {
<span class="nc" id="L173">        dispatcher.unregister(this)</span>
<span class="nc" id="L174">        super.onCleared()</span>
<span class="nc" id="L175">    }</span>

    private fun List&lt;PageModel&gt;.isValid(
        pageOnFrontRemoteId: Long,
        pageForPostsRemoteId: Long
    ): Boolean {
<span class="nc bnc" id="L181" title="All 8 branches missed.">        return this.isNotEmpty() &amp;&amp; this.hasPage(pageOnFrontRemoteId) &amp;&amp; this.hasPage(pageForPostsRemoteId)</span>
    }

    private fun List&lt;PageModel&gt;.hasPage(remoteId: Long): Boolean {
<span class="nc bnc" id="L185" title="All 6 branches missed.">        return remoteId &lt;= 0 || this.any { it.remoteId == remoteId }</span>
    }

    @Subscribe(threadMode = ThreadMode.MAIN)
    fun onSiteChanged(event: OnSiteChanged) {
<span class="nc" id="L190">        val currentUiState = _uiState.value</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">        if (!event.isError &amp;&amp; currentUiState != null) {</span>
<span class="nc" id="L192">            val siteModel = currentUiState.siteModel</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            val updatedSite = siteStore.getSiteByLocalId(siteModel.id)</span>
<span class="nc" id="L194">                    ?: throw IllegalStateException(&quot;SiteModel has to be present&quot;)</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (updatedSite.showOnFront != siteModel.showOnFront ||</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                    updatedSite.pageOnFront != siteModel.pageOnFront ||</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                    updatedSite.pageForPosts != siteModel.pageForPosts) {</span>
<span class="nc" id="L198">                updateUiStateFromMainThread { it.copy(siteModel = updatedSite) }</span>
            }
        }
<span class="nc" id="L201">    }</span>

    private suspend fun updateUiState(copyFunction: (HomepageSettingsUiState) -&gt; HomepageSettingsUiState): Boolean {
<span class="nc bnc" id="L204" title="All 2 branches missed.">        return withContext(mainDispatcher) {</span>
<span class="nc" id="L205">            updateUiStateFromMainThread { copyFunction(it) }</span>
        }
    }

    private fun updateUiStateFromMainThread(
        copyFunction: (HomepageSettingsUiState) -&gt; HomepageSettingsUiState
    ): Boolean {
<span class="nc" id="L212">        val currentState = _uiState.value</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        return if (currentState != null) {</span>
<span class="nc" id="L214">            _uiState.value = copyFunction(currentState)</span>
<span class="nc" id="L215">            true</span>
        } else {
<span class="nc" id="L217">            false</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>