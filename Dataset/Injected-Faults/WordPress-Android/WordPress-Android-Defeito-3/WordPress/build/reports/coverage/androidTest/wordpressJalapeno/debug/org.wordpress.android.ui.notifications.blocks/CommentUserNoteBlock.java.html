<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommentUserNoteBlock.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.notifications.blocks</a> &gt; <span class="el_source">CommentUserNoteBlock.java</span></div><h1>CommentUserNoteBlock.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.notifications.blocks;

import android.annotation.SuppressLint;
import android.content.Context;
import android.text.Html;
import android.text.Spannable;
import android.text.SpannableStringBuilder;
import android.text.TextUtils;
import android.view.View;
import android.widget.ImageView;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.core.view.ViewCompat;

import org.wordpress.android.R;
import org.wordpress.android.fluxc.model.CommentStatus;
import org.wordpress.android.fluxc.tools.FormattableContent;
import org.wordpress.android.ui.notifications.utils.NotificationsUtilsWrapper;
import org.wordpress.android.util.extensions.ContextExtensionsKt;
import org.wordpress.android.util.DateTimeUtils;
import org.wordpress.android.util.GravatarUtils;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageType;

// A user block with slightly different formatting for display in a comment detail
public class CommentUserNoteBlock extends UserNoteBlock {
    private static final String EMPTY_LINE = &quot;\n\t&quot;;
    private static final String DOUBLE_EMPTY_LINE = &quot;\n\t\n\t&quot;;
<span class="nc" id="L30">    private CommentStatus mCommentStatus = CommentStatus.APPROVED;</span>
    private int mNormalBackgroundColor;
    private int mIndentedLeftPadding;
    private final Context mContext;
    private boolean mStatusChanged;

    private FormattableContent mCommentData;
    private final long mTimestamp;

    private CommentUserNoteBlockHolder mNoteBlockHolder;

    public interface OnCommentStatusChangeListener {
        void onCommentStatusChanged(CommentStatus newStatus);
    }

    public CommentUserNoteBlock(Context context, FormattableContent noteObject,
                                FormattableContent commentTextBlock,
                                long timestamp, OnNoteBlockTextClickListener onNoteBlockTextClickListener,
                                OnGravatarClickedListener onGravatarClickedListener,
                                ImageManager imageManager, NotificationsUtilsWrapper notificationsUtilsWrapper) {
<span class="nc" id="L50">        super(context, noteObject, onNoteBlockTextClickListener, onGravatarClickedListener, imageManager,</span>
                notificationsUtilsWrapper);
<span class="nc" id="L52">        mContext = context;</span>
<span class="nc" id="L53">        mCommentData = commentTextBlock;</span>
<span class="nc" id="L54">        mTimestamp = timestamp;</span>

<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (context != null) {</span>
<span class="nc" id="L57">            setAvatarSize(context.getResources().getDimensionPixelSize(R.dimen.avatar_sz_small));</span>
        }
<span class="nc" id="L59">    }</span>

    @Override
    public BlockType getBlockType() {
<span class="nc" id="L63">        return BlockType.USER_COMMENT;</span>
    }

    @Override
    public int getLayoutResourceId() {
<span class="nc" id="L68">        return R.layout.note_block_comment_user;</span>
    }

    @SuppressLint(&quot;ClickableViewAccessibility&quot;) // fixed by setting a click listener to avatarImageView
    @Override
    public View configureView(View view) {
<span class="nc" id="L74">        mNoteBlockHolder = (CommentUserNoteBlockHolder) view.getTag();</span>

<span class="nc" id="L76">        setUserName();</span>
<span class="nc" id="L77">        setUserCommentAgo();</span>
<span class="nc" id="L78">        setUserCommentSite();</span>
<span class="nc" id="L79">        setUserAvatar();</span>
<span class="nc" id="L80">        setUserComment();</span>
<span class="nc" id="L81">        setCommentStatus(view);</span>

<span class="nc" id="L83">        return view;</span>
    }

    private void setUserName() {
<span class="nc" id="L87">        mNoteBlockHolder.mNameTextView.setText(</span>
<span class="nc" id="L88">                Html.fromHtml(&quot;&lt;strong&gt;&quot; + getNoteText().toString() + &quot;&lt;/strong&gt;&quot;)</span>
        );
<span class="nc" id="L90">    }</span>

    private void setUserCommentAgo() {
<span class="nc" id="L93">        mNoteBlockHolder.mAgoTextView.setText(DateTimeUtils.timeSpanFromTimestamp(getTimestamp(),</span>
<span class="nc" id="L94">                mNoteBlockHolder.mAgoTextView.getContext()));</span>
<span class="nc" id="L95">    }</span>

    private void setUserCommentSite() {
<span class="nc bnc" id="L98" title="All 4 branches missed.">        if (!TextUtils.isEmpty(getMetaHomeTitle()) || !TextUtils.isEmpty(getMetaSiteUrl())) {</span>
<span class="nc" id="L99">            mNoteBlockHolder.mBulletTextView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L100">            mNoteBlockHolder.mSiteTextView.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (!TextUtils.isEmpty(getMetaHomeTitle())) {</span>
<span class="nc" id="L102">                mNoteBlockHolder.mSiteTextView.setText(getMetaHomeTitle());</span>
            } else {
<span class="nc" id="L104">                mNoteBlockHolder.mSiteTextView.setText(getMetaSiteUrl().replace(&quot;http://&quot;, &quot;&quot;).replace(&quot;https://&quot;, &quot;&quot;));</span>
            }
        } else {
<span class="nc" id="L107">            mNoteBlockHolder.mBulletTextView.setVisibility(View.GONE);</span>
<span class="nc" id="L108">            mNoteBlockHolder.mSiteTextView.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L110">        mNoteBlockHolder.mSiteTextView.setImportantForAccessibility(View.IMPORTANT_FOR_ACCESSIBILITY_NO);</span>
<span class="nc" id="L111">    }</span>

    private void setUserAvatar() {
<span class="nc" id="L114">        String imageUrl = &quot;&quot;;</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (hasImageMediaItem()) {</span>
<span class="nc" id="L116">            imageUrl = GravatarUtils.fixGravatarUrl(getNoteMediaItem().getUrl(), getAvatarSize());</span>
<span class="nc" id="L117">            mNoteBlockHolder.mAvatarImageView.setContentDescription(</span>
<span class="nc" id="L118">                    mContext.getString(R.string.profile_picture, getNoteText().toString())</span>
            );
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (!TextUtils.isEmpty(getUserUrl())) {</span>
<span class="nc" id="L121">                mNoteBlockHolder.mAvatarImageView.setOnClickListener(new View.OnClickListener() {</span>
                    @Override
                    public void onClick(View v) {
<span class="nc" id="L124">                        showBlogPreview();</span>
<span class="nc" id="L125">                    }</span>
                });
                //noinspection AndroidLintClickableViewAccessibility
<span class="nc" id="L128">                mNoteBlockHolder.mAvatarImageView.setOnTouchListener(mOnGravatarTouchListener);</span>
            } else {
<span class="nc" id="L130">                mNoteBlockHolder.mAvatarImageView.setOnClickListener(null);</span>
                //noinspection AndroidLintClickableViewAccessibility
<span class="nc" id="L132">                mNoteBlockHolder.mAvatarImageView.setOnTouchListener(null);</span>
<span class="nc" id="L133">                mNoteBlockHolder.mAvatarImageView.setContentDescription(null);</span>
            }
        } else {
<span class="nc" id="L136">            mNoteBlockHolder.mAvatarImageView.setOnClickListener(null);</span>
            //noinspection AndroidLintClickableViewAccessibility
<span class="nc" id="L138">            mNoteBlockHolder.mAvatarImageView.setOnTouchListener(null);</span>
<span class="nc" id="L139">            mNoteBlockHolder.mAvatarImageView.setContentDescription(null);</span>
        }
<span class="nc" id="L141">        mImageManager.loadIntoCircle(mNoteBlockHolder.mAvatarImageView, ImageType.AVATAR_WITH_BACKGROUND, imageUrl);</span>
<span class="nc" id="L142">    }</span>

    private void setUserComment() {
<span class="nc" id="L145">        Spannable spannable = getCommentTextOfNotification(mNoteBlockHolder);</span>
<span class="nc" id="L146">        NoteBlockClickableSpan[] spans = spannable.getSpans(0, spannable.length(), NoteBlockClickableSpan.class);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        for (NoteBlockClickableSpan span : spans) {</span>
<span class="nc" id="L148">            span.enableColors(mContext);</span>
        }

<span class="nc" id="L151">        mNoteBlockHolder.mCommentTextView.setText(spannable);</span>
<span class="nc" id="L152">    }</span>

    private void setCommentStatus(@NonNull final View view) {
        // Change display based on comment status and type:
        // 1. Comment replies are indented and have a 'pipe' background
        // 2. Unapproved comments have different background and text color
<span class="nc" id="L158">        int paddingStart = ViewCompat.getPaddingStart(view);</span>
<span class="nc" id="L159">        int paddingTop = view.getPaddingTop();</span>
<span class="nc" id="L160">        int paddingEnd = ViewCompat.getPaddingEnd(view);</span>
<span class="nc" id="L161">        int paddingBottom = view.getPaddingBottom();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (mCommentStatus == CommentStatus.UNAPPROVED) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (hasCommentNestingLevel()) {</span>
<span class="nc" id="L164">                paddingStart = mIndentedLeftPadding;</span>
<span class="nc" id="L165">                view.setBackgroundResource(R.drawable.bg_rectangle_warning_surface_with_padding);</span>
            } else {
<span class="nc" id="L167">                view.setBackgroundResource(R.drawable.bg_rectangle_warning_surface);</span>
            }

<span class="nc" id="L170">            mNoteBlockHolder.mDividerView.setVisibility(View.INVISIBLE);</span>
        } else {
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (hasCommentNestingLevel()) {</span>
<span class="nc" id="L173">                paddingStart = mIndentedLeftPadding;</span>
<span class="nc" id="L174">                view.setBackgroundResource(R.drawable.comment_reply_background);</span>
<span class="nc" id="L175">                mNoteBlockHolder.mDividerView.setVisibility(View.INVISIBLE);</span>
            } else {
<span class="nc" id="L177">                view.setBackgroundColor(mNormalBackgroundColor);</span>
<span class="nc" id="L178">                mNoteBlockHolder.mDividerView.setVisibility(View.VISIBLE);</span>
            }
        }
<span class="nc" id="L181">        ViewCompat.setPaddingRelative(view, paddingStart, paddingTop, paddingEnd, paddingBottom);</span>
        // If status was changed, fade in the view
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (mStatusChanged) {</span>
<span class="nc" id="L184">            mStatusChanged = false;</span>
<span class="nc" id="L185">            view.setAlpha(0.4f);</span>
<span class="nc" id="L186">            view.animate().alpha(1.0f).start();</span>
        }
<span class="nc" id="L188">    }</span>

    private Spannable getCommentTextOfNotification(CommentUserNoteBlockHolder noteBlockHolder) {
<span class="nc" id="L191">        SpannableStringBuilder builder = mNotificationsUtilsWrapper</span>
<span class="nc" id="L192">                .getSpannableContentForRanges(mCommentData,</span>
<span class="nc" id="L193">                        noteBlockHolder.mCommentTextView, getOnNoteBlockTextClickListener(), false);</span>
<span class="nc" id="L194">        return removeNewLineInList(builder);</span>
    }

    private Spannable removeNewLineInList(SpannableStringBuilder builder) {
<span class="nc" id="L198">        String content = builder.toString();</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        while (content.contains(DOUBLE_EMPTY_LINE)) {</span>
<span class="nc" id="L200">            int doubleSpaceIndex = content.indexOf(DOUBLE_EMPTY_LINE);</span>
<span class="nc" id="L201">            builder.replace(doubleSpaceIndex, doubleSpaceIndex + DOUBLE_EMPTY_LINE.length(), EMPTY_LINE);</span>
<span class="nc" id="L202">            content = builder.toString();</span>
<span class="nc" id="L203">        }</span>
<span class="nc" id="L204">        return builder;</span>
    }

    private long getTimestamp() {
<span class="nc" id="L208">        return mTimestamp;</span>
    }

    private boolean hasCommentNestingLevel() {
<span class="nc bnc" id="L212" title="All 4 branches missed.">        return mCommentData.getNestLevel() != null &amp;&amp; mCommentData.getNestLevel() &gt; 0;</span>
    }

    @Override
    public Object getViewHolder(View view) {
<span class="nc" id="L217">        return new CommentUserNoteBlockHolder(view);</span>
    }

    private class CommentUserNoteBlockHolder {
        private final ImageView mAvatarImageView;
        private final TextView mNameTextView;
        private final TextView mAgoTextView;
        private final TextView mBulletTextView;
        private final TextView mSiteTextView;
        private final TextView mCommentTextView;
        private final View mDividerView;

<span class="nc" id="L229">        CommentUserNoteBlockHolder(View view) {</span>
<span class="nc" id="L230">            mNameTextView = view.findViewById(R.id.user_name);</span>
<span class="nc" id="L231">            mAgoTextView = view.findViewById(R.id.user_comment_ago);</span>
<span class="nc" id="L232">            mAgoTextView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L233">            mBulletTextView = view.findViewById(R.id.user_comment_bullet);</span>
<span class="nc" id="L234">            mSiteTextView = view.findViewById(R.id.user_comment_site);</span>
<span class="nc" id="L235">            mCommentTextView = view.findViewById(R.id.user_comment);</span>
<span class="nc" id="L236">            mCommentTextView.setMovementMethod(new NoteBlockLinkMovementMethod());</span>
<span class="nc" id="L237">            mAvatarImageView = view.findViewById(R.id.user_avatar);</span>
<span class="nc" id="L238">            mDividerView = view.findViewById(R.id.divider_view);</span>

<span class="nc" id="L240">            mSiteTextView.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">                    if (getOnNoteBlockTextClickListener() != null) {</span>
<span class="nc" id="L244">                        getOnNoteBlockTextClickListener().showSitePreview(getMetaSiteId(), getMetaSiteUrl());</span>
                    }
<span class="nc" id="L246">                }</span>
            });

            // show all comments on this post when user clicks the comment text
<span class="nc" id="L250">            mCommentTextView.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">                    if (getOnNoteBlockTextClickListener() != null) {</span>
<span class="nc" id="L254">                        getOnNoteBlockTextClickListener().showReaderPostComments();</span>
                    }
<span class="nc" id="L256">                }</span>
            });
<span class="nc" id="L258">        }</span>
    }

    public void configureResources(Context context) {
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (context == null) {</span>
<span class="nc" id="L263">            return;</span>
        }

<span class="nc" id="L266">        mNormalBackgroundColor = ContextExtensionsKt.getColorFromAttribute(context, R.attr.colorSurface);</span>
        // Double margin_extra_large for increased indent in comment replies
<span class="nc" id="L268">        mIndentedLeftPadding = context.getResources().getDimensionPixelSize(R.dimen.margin_extra_large) * 2;</span>
<span class="nc" id="L269">    }</span>

<span class="nc" id="L271">    private final OnCommentStatusChangeListener mOnCommentChangedListener = new OnCommentStatusChangeListener() {</span>
        @Override
        public void onCommentStatusChanged(CommentStatus newStatus) {
<span class="nc" id="L274">            mCommentStatus = newStatus;</span>
<span class="nc" id="L275">            mStatusChanged = true;</span>
<span class="nc" id="L276">        }</span>
    };

    public void setCommentStatus(CommentStatus status) {
<span class="nc" id="L280">        mCommentStatus = status;</span>
<span class="nc" id="L281">    }</span>

    public OnCommentStatusChangeListener getOnCommentChangeListener() {
<span class="nc" id="L284">        return mOnCommentChangedListener;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>