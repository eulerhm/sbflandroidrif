<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BadgedImageView.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.widgets</a> &gt; <span class="el_source">BadgedImageView.kt</span></div><h1>BadgedImageView.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.widgets

import android.content.Context
import android.graphics.Bitmap
import android.graphics.Bitmap.Config.ARGB_8888
import android.graphics.Canvas
import android.graphics.Color
import android.graphics.Paint
import android.graphics.Paint.ANTI_ALIAS_FLAG
import android.graphics.Paint.Style
import android.graphics.PorterDuff.Mode.CLEAR
import android.graphics.PorterDuffXfermode
import android.graphics.drawable.Drawable
import android.util.AttributeSet
import androidx.annotation.DrawableRes
import androidx.appcompat.widget.AppCompatImageView
import org.wordpress.android.R
import org.wordpress.android.util.DisplayUtils

/**
 * A ImageView that can draw a badge at the corner of its view.
 * The main difference between this implementation and others commonly found online, is that this one uses
 * Porter/Duff Compositing to create a transparent space between the badge background and the view.
 */
<span class="nc" id="L25">class BadgedImageView @JvmOverloads constructor(</span>
    context: Context,
<span class="nc" id="L27">    attrs: AttributeSet? = null,</span>
<span class="nc" id="L28">    defStyleAttr: Int = 0</span>
<span class="nc" id="L29">) : AppCompatImageView(context, attrs, defStyleAttr) {</span>
    companion object {
        const val DEFAULT_BADGE_BACKGROUND_SIZE = 16f
        const val DEFAULT_BADGE_BACKGROUND_BORDER_WIDTH = 0f
        const val DEFAULT_BADGE_ICON_SIZE = 16f
        const val DEFAULT_BADGE_HORIZONTAL_OFFSET = 0f
        const val DEFAULT_BADGE_VERTICAL_OFFSET = 0f
    }

<span class="nc" id="L38">    var badgeBackground: Drawable? = null</span>
        set(value) {
<span class="nc" id="L40">            field = value</span>
<span class="nc" id="L41">            invalidate()</span>
<span class="nc" id="L42">        }</span>
<span class="nc" id="L43">    var badgeBackgroundSize: Float = 0f</span>
        set(value) {
<span class="nc" id="L45">            field = value</span>
<span class="nc" id="L46">            invalidate()</span>
<span class="nc" id="L47">        }</span>
<span class="nc" id="L48">    var badgeBackgroundBorderWidth: Float = 0f</span>
        set(value) {
<span class="nc" id="L50">            field = value</span>
<span class="nc" id="L51">            invalidate()</span>
<span class="nc" id="L52">        }</span>
<span class="nc" id="L53">    var badgeIcon: Drawable? = null</span>
        set(value) {
<span class="nc" id="L55">            field = value</span>
<span class="nc" id="L56">            invalidate()</span>
<span class="nc" id="L57">        }</span>
<span class="nc" id="L58">    var badgeIconSize: Float = 0f</span>
        set(value) {
<span class="nc" id="L60">            field = value</span>
<span class="nc" id="L61">            invalidate()</span>
<span class="nc" id="L62">        }</span>
<span class="nc" id="L63">    var badgeHorizontalOffset: Float = 0f</span>
        set(value) {
<span class="nc" id="L65">            field = value</span>
<span class="nc" id="L66">            invalidate()</span>
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">    var badgeVerticalOffset: Float = 0f</span>
        set(value) {
<span class="nc" id="L70">            field = value</span>
<span class="nc" id="L71">            invalidate()</span>
<span class="nc" id="L72">        }</span>

<span class="nc" id="L74">    init {</span>
<span class="nc" id="L75">        val styledAttributes = context.obtainStyledAttributes(attrs, R.styleable.BadgedImageView)</span>

<span class="nc" id="L77">        badgeBackground = styledAttributes.getDrawable(</span>
<span class="nc" id="L78">                R.styleable.BadgedImageView_badgeBackground</span>
        )

<span class="nc" id="L81">        badgeBackgroundSize = styledAttributes.getDimension(</span>
<span class="nc" id="L82">                R.styleable.BadgedImageView_badgeBackgroundSize,</span>
<span class="nc" id="L83">                DisplayUtils.dpToPx(context, DEFAULT_BADGE_BACKGROUND_SIZE.toInt()).toFloat()</span>
        )

<span class="nc" id="L86">        badgeBackgroundBorderWidth = styledAttributes.getDimension(</span>
<span class="nc" id="L87">                R.styleable.BadgedImageView_badgeBackgroundBorderWidth,</span>
<span class="nc" id="L88">                DisplayUtils.dpToPx(context, DEFAULT_BADGE_BACKGROUND_BORDER_WIDTH.toInt()).toFloat()</span>
        )

<span class="nc" id="L91">        badgeIcon = styledAttributes.getDrawable(</span>
<span class="nc" id="L92">                R.styleable.BadgedImageView_badgeIcon</span>
        )

<span class="nc" id="L95">        badgeIconSize = styledAttributes.getDimension(</span>
<span class="nc" id="L96">                R.styleable.BadgedImageView_badgeIconSize,</span>
<span class="nc" id="L97">                DisplayUtils.dpToPx(context, DEFAULT_BADGE_ICON_SIZE.toInt()).toFloat()</span>
        )

<span class="nc" id="L100">        badgeHorizontalOffset = styledAttributes.getDimension(</span>
<span class="nc" id="L101">                R.styleable.BadgedImageView_badgeHorizontalOffset,</span>
<span class="nc" id="L102">                DisplayUtils.dpToPx(context, DEFAULT_BADGE_HORIZONTAL_OFFSET.toInt()).toFloat()</span>
        )

<span class="nc" id="L105">        badgeVerticalOffset = styledAttributes.getDimension(</span>
<span class="nc" id="L106">                R.styleable.BadgedImageView_badgeVerticalOffset,</span>
<span class="nc" id="L107">                DisplayUtils.dpToPx(context, DEFAULT_BADGE_VERTICAL_OFFSET.toInt()).toFloat()</span>
        )

<span class="nc" id="L110">        styledAttributes.recycle()</span>
<span class="nc" id="L111">    }</span>

<span class="nc" id="L113">    private val paint = Paint(ANTI_ALIAS_FLAG)</span>
<span class="nc" id="L114">    private val eraserPaint = Paint(ANTI_ALIAS_FLAG).apply {</span>
<span class="nc" id="L115">        color = Color.TRANSPARENT</span>
<span class="nc" id="L116">        style = Style.FILL_AND_STROKE</span>
<span class="nc" id="L117">        strokeWidth = badgeBackgroundBorderWidth</span>
<span class="nc" id="L118">        xfermode = PorterDuffXfermode(CLEAR)</span>
<span class="nc" id="L119">    }</span>

    private var tempCanvasBitmap: Bitmap? = null
    private var tempCanvas: Canvas? = null
<span class="nc" id="L123">    private var invalidated = true</span>

    fun setBadgeBackground(@DrawableRes badgeBackgroundResId: Int) {
<span class="nc" id="L126">        badgeBackground = context.getDrawable(badgeBackgroundResId)</span>
<span class="nc" id="L127">    }</span>

    fun setBadgeIcon(@DrawableRes badgeIconResId: Int) {
<span class="nc" id="L130">        badgeIcon = context.getDrawable(badgeIconResId)</span>
<span class="nc" id="L131">    }</span>

    override fun invalidate() {
<span class="nc" id="L134">        invalidated = true</span>
<span class="nc" id="L135">        super.invalidate()</span>
<span class="nc" id="L136">    }</span>

    override fun onSizeChanged(width: Int, height: Int, oldWidht: Int, oldHeight: Int) {
<span class="nc" id="L139">        super.onSizeChanged(width, height, oldWidht, oldHeight)</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">        val sizeChanged = width != oldWidht || height != oldHeight</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">        val isValid = width &gt; 0 &amp;&amp; height &gt; 0</span>

<span class="nc bnc" id="L143" title="All 6 branches missed.">        if (isValid &amp;&amp; (tempCanvas == null || sizeChanged)) {</span>
<span class="nc" id="L144">            tempCanvasBitmap = Bitmap.createBitmap(</span>
<span class="nc" id="L145">                    width + badgeBackgroundSize.toInt() / 2,</span>
<span class="nc" id="L146">                    height + badgeBackgroundSize.toInt() / 2,</span>
<span class="nc" id="L147">                    ARGB_8888</span>
            )
<span class="nc bnc" id="L149" title="All 2 branches missed.">            tempCanvas = tempCanvasBitmap?.let { Canvas(it) }</span>
<span class="nc" id="L150">            invalidated = true</span>
        }
<span class="nc" id="L152">    }</span>

    override fun onDraw(canvas: Canvas) {
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (invalidated) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            tempCanvas?.let {</span>
<span class="nc" id="L157">                clearCanvas(it)</span>
<span class="nc" id="L158">                super.onDraw(it)</span>
<span class="nc" id="L159">                drawBadge(it)</span>
<span class="nc" id="L160">            }</span>

<span class="nc" id="L162">            invalidated = false</span>
        }
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!invalidated) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            tempCanvasBitmap?.let { canvas.drawBitmap(it, 0f, 0f, paint) }</span>
        }
<span class="nc" id="L167">    }</span>

    private fun clearCanvas(canvas: Canvas) {
<span class="nc" id="L170">        canvas.drawColor(Color.TRANSPARENT, CLEAR)</span>
<span class="nc" id="L171">    }</span>

    private fun drawBadge(canvas: Canvas) {
<span class="nc" id="L174">        val x = pivotX + width / 2f - badgeBackgroundSize / 2f + badgeHorizontalOffset</span>
<span class="nc" id="L175">        val y = pivotY + height / 2f - badgeBackgroundSize / 2f + badgeVerticalOffset</span>

<span class="nc" id="L177">        drawBadgeSpace(canvas, x, y)</span>
<span class="nc" id="L178">        drawBadgeBackground(canvas, x, y)</span>
<span class="nc" id="L179">        drawBadgeIcon(canvas, x, y)</span>
<span class="nc" id="L180">    }</span>

    private fun drawBadgeSpace(canvas: Canvas, x: Float, y: Float) {
<span class="nc" id="L183">        canvas.drawCircle(x, y, badgeBackgroundSize / 2f + badgeBackgroundBorderWidth, eraserPaint)</span>
<span class="nc" id="L184">    }</span>

    private fun drawBadgeBackground(canvas: Canvas, x: Float, y: Float) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (badgeBackground != null) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            badgeBackground?.setBounds(0, 0, badgeBackgroundSize.toInt(), badgeBackgroundSize.toInt())</span>
<span class="nc" id="L189">            canvas.save()</span>
<span class="nc" id="L190">            canvas.translate(x - badgeBackgroundSize / 2f, y - badgeBackgroundSize / 2f)</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            badgeBackground?.draw(canvas)</span>
<span class="nc" id="L192">            canvas.restore()</span>
        }
<span class="nc" id="L194">    }</span>

    private fun drawBadgeIcon(canvas: Canvas, x: Float, y: Float) {
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (badgeIcon != null) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            badgeIcon?.setBounds(0, 0, badgeIconSize.toInt(), badgeIconSize.toInt())</span>
<span class="nc" id="L199">            canvas.save()</span>
<span class="nc" id="L200">            canvas.translate(x - badgeIconSize / 2f, y - badgeIconSize / 2f)</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            badgeIcon?.draw(canvas)</span>
<span class="nc" id="L202">            canvas.restore()</span>
        }
<span class="nc" id="L204">    }</span>
<span class="nc" id="L205">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>