<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FluxCUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">FluxCUtils.java</span></div><h1>FluxCUtils.java</h1><pre class="source lang-java linenums">package org.wordpress.android.util;

import android.content.Context;
import android.net.Uri;
import android.text.TextUtils;
import android.webkit.MimeTypeMap;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;

import org.wordpress.android.fluxc.model.MediaModel;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.helpers.MediaFile;

import java.io.File;

<span class="nc" id="L19">public class FluxCUtils {</span>
    public static class FluxCUtilsLoggingException extends Exception {
        public FluxCUtilsLoggingException(String message) {
<span class="nc" id="L22">            super(message);</span>
<span class="nc" id="L23">        }</span>
        public FluxCUtilsLoggingException(Throwable originalException) {
<span class="nc" id="L25">            super(originalException);</span>
<span class="nc" id="L26">        }</span>
    }

    /**
     * This method doesn't do much, but insure we're doing the same check in all parts of the app.
     *
     * @return true if the user is signed in a WordPress.com account or if he has a .org site.
     */
    public static boolean isSignedInWPComOrHasWPOrgSite(AccountStore accountStore, SiteStore siteStore) {
<span class="pc bpc" id="L35" title="3 of 4 branches missed.">        return accountStore.hasAccessToken() || siteStore.hasSiteAccessedViaXMLRPC();</span>
    }

    public static MediaModel mediaModelFromMediaFile(MediaFile file) {
<span class="nc bnc" id="L39" title="All 2 branches missed.">        if (file == null) {</span>
<span class="nc" id="L40">            return null;</span>
        }

<span class="nc" id="L43">        MediaModel mediaModel = new MediaModel();</span>
<span class="nc" id="L44">        mediaModel.setFileName(file.getFileName());</span>
<span class="nc" id="L45">        mediaModel.setFilePath(file.getFilePath());</span>
<span class="nc" id="L46">        mediaModel.setFileExtension(org.wordpress.android.fluxc.utils.MediaUtils.getExtension(file.getFilePath()));</span>
<span class="nc" id="L47">        mediaModel.setMimeType(file.getMimeType());</span>
<span class="nc" id="L48">        mediaModel.setThumbnailUrl(file.getThumbnailURL());</span>
<span class="nc" id="L49">        mediaModel.setUrl(file.getFileURL());</span>
<span class="nc" id="L50">        mediaModel.setTitle(file.getTitle());</span>
<span class="nc" id="L51">        mediaModel.setDescription(file.getDescription());</span>
<span class="nc" id="L52">        mediaModel.setCaption(file.getCaption());</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">        mediaModel.setMediaId(file.getMediaId() != null ? Long.valueOf(file.getMediaId()) : 0);</span>
<span class="nc" id="L54">        mediaModel.setId(file.getId());</span>
<span class="nc" id="L55">        mediaModel.setUploadState(file.getUploadState());</span>
<span class="nc" id="L56">        mediaModel.setLocalSiteId(Integer.valueOf(file.getBlogId()));</span>
<span class="nc" id="L57">        mediaModel.setVideoPressGuid(ShortcodeUtils.getVideoPressIdFromShortCode(file.getVideoPressShortCode()));</span>
<span class="nc" id="L58">        return mediaModel;</span>
    }

    public static MediaFile mediaFileFromMediaModel(MediaModel media) {
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (media == null) {</span>
<span class="nc" id="L63">            return null;</span>
        }

<span class="nc" id="L66">        MediaFile mediaFile = new MediaFile();</span>
<span class="nc" id="L67">        mediaFile.setBlogId(String.valueOf(media.getLocalSiteId()));</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        mediaFile.setMediaId(media.getMediaId() &gt; 0 ? String.valueOf(media.getMediaId()) : null);</span>
<span class="nc" id="L69">        mediaFile.setId(media.getId());</span>
<span class="nc" id="L70">        mediaFile.setFileName(media.getFileName());</span>
<span class="nc" id="L71">        mediaFile.setFilePath(media.getFilePath());</span>
<span class="nc" id="L72">        mediaFile.setMimeType(media.getMimeType());</span>
<span class="nc" id="L73">        mediaFile.setThumbnailURL(media.getThumbnailUrl());</span>
<span class="nc" id="L74">        mediaFile.setFileURL(media.getUrl());</span>
<span class="nc" id="L75">        mediaFile.setTitle(media.getTitle());</span>
<span class="nc" id="L76">        mediaFile.setDescription(media.getDescription());</span>
<span class="nc" id="L77">        mediaFile.setCaption(media.getCaption());</span>
<span class="nc" id="L78">        mediaFile.setUploadState(media.getUploadState());</span>
<span class="nc" id="L79">        mediaFile.setVideo(org.wordpress.android.fluxc.utils.MediaUtils.isVideoMimeType(media.getMimeType()));</span>
<span class="nc" id="L80">        mediaFile.setVideoPressShortCode(ShortcodeUtils.getVideoPressShortcodeFromId(media.getVideoPressGuid()));</span>
<span class="nc" id="L81">        mediaFile.setHeight(media.getHeight());</span>
<span class="nc" id="L82">        mediaFile.setWidth(media.getWidth());</span>
<span class="nc" id="L83">        return mediaFile;</span>
    }

    /**
     * This method returns a FluxC MediaModel from a device media URI
     *
     * @return MediaModel or null in case of problems reading the URI
     */
    public static MediaModel mediaModelFromLocalUri(@NonNull Context context,
                                                    @NonNull Uri uri,
                                                    @Nullable String mimeType,
                                                    @NonNull org.wordpress.android.fluxc.store.MediaStore mediaStore,
                                                    int localSiteId) {
<span class="nc" id="L96">        String path = MediaUtils.getRealPathFromURI(context, uri);</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (TextUtils.isEmpty(path)) {</span>
<span class="nc" id="L99">            AppLog.d(T.UTILS, &quot;The input URI &quot; + uri.toString() + &quot; can't be read.&quot;);</span>
<span class="nc" id="L100">            return null;</span>
        }

<span class="nc" id="L103">        File file = new File(path);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!file.exists()) {</span>
<span class="nc" id="L105">            AppLog.d(T.UTILS, &quot;The input URI &quot; + uri.toString() + &quot;, converted locally to &quot; + path</span>
                           + &quot; doesn't exist.&quot;);
<span class="nc" id="L107">            return null;</span>
        }

<span class="nc" id="L110">        MediaModel media = mediaStore.instantiateMediaModel();</span>
<span class="nc" id="L111">        String filename = org.wordpress.android.fluxc.utils.MediaUtils.getFileName(path);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (filename == null) filename = &quot;&quot;;</span>
<span class="nc" id="L113">        String fileExtension = org.wordpress.android.fluxc.utils.MediaUtils.getExtension(path);</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (TextUtils.isEmpty(mimeType)) {</span>
<span class="nc" id="L116">            mimeType = UrlUtils.getUrlMimeType(uri.toString());</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            if (mimeType == null) {</span>
<span class="nc" id="L118">                mimeType = MimeTypeMap.getSingleton().getMimeTypeFromExtension(fileExtension);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (mimeType == null) {</span>
                    // Default to image jpeg
<span class="nc" id="L121">                    mimeType = &quot;image/jpeg&quot;;</span>
                }
            }
        }

<span class="nc" id="L126">        String title = filename;</span>
        // Remove extension from title
<span class="nc bnc" id="L128" title="All 4 branches missed.">        if (fileExtension != null &amp;&amp; title.contains(&quot;.&quot; + fileExtension)) {</span>
<span class="nc" id="L129">            title = title.substring(0, title.lastIndexOf(fileExtension) - 1);</span>
        }

        // If file extension is null, upload won't work on wordpress.com
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (fileExtension == null) {</span>
<span class="nc" id="L134">            fileExtension = MimeTypeMap.getSingleton().getExtensionFromMimeType(mimeType);</span>
<span class="nc" id="L135">            filename += &quot;.&quot; + fileExtension;</span>
        }

<span class="nc" id="L138">        media.setFileName(filename);</span>
<span class="nc" id="L139">        media.setTitle(title);</span>
<span class="nc" id="L140">        media.setFilePath(path);</span>
<span class="nc" id="L141">        media.setLocalSiteId(localSiteId);</span>
<span class="nc" id="L142">        media.setFileExtension(fileExtension);</span>
<span class="nc" id="L143">        media.setMimeType(mimeType);</span>
<span class="nc" id="L144">        media.setUploadState(MediaModel.MediaUploadState.QUEUED);</span>
<span class="nc" id="L145">        media.setUploadDate(DateTimeUtils.iso8601UTCFromTimestamp(System.currentTimeMillis() / 1000));</span>

<span class="nc" id="L147">        return media;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>