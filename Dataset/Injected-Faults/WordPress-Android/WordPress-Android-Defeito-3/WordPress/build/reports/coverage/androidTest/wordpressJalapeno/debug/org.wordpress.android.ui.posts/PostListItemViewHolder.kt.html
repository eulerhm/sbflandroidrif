<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostListItemViewHolder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PostListItemViewHolder.kt</span></div><h1>PostListItemViewHolder.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import android.graphics.drawable.Drawable
import android.view.LayoutInflater
import android.view.Menu
import android.view.View
import android.view.ViewGroup
import android.widget.FrameLayout
import android.widget.ImageButton
import android.widget.ImageView
import android.widget.ImageView.ScaleType
import android.widget.PopupMenu
import android.widget.ProgressBar
import android.widget.TextView
import androidx.annotation.ColorRes
import androidx.annotation.LayoutRes
import androidx.constraintlayout.widget.ConstraintLayout
import androidx.core.content.ContextCompat
import androidx.recyclerview.widget.RecyclerView
import org.wordpress.android.R
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.util.extensions.expandTouchTargetArea
import org.wordpress.android.util.extensions.getDrawableFromAttribute
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.util.image.ImageType
import org.wordpress.android.viewmodel.posts.PostListItemAction
import org.wordpress.android.viewmodel.posts.PostListItemAction.MoreItem
import org.wordpress.android.viewmodel.posts.PostListItemAction.SingleItem
import org.wordpress.android.viewmodel.uistate.ProgressBarUiState
import org.wordpress.android.viewmodel.uistate.ProgressBarUiState.Determinate
import org.wordpress.android.viewmodel.uistate.ProgressBarUiState.Indeterminate
import org.wordpress.android.viewmodel.posts.PostListItemType.PostListItemUiState
import org.wordpress.android.viewmodel.posts.PostListItemUiStateData
import org.wordpress.android.widgets.PostListButton
import org.wordpress.android.widgets.WPTextView
import java.util.concurrent.atomic.AtomicBoolean

<span class="nc" id="L39">sealed class PostListItemViewHolder(</span>
    @LayoutRes layout: Int,
    parent: ViewGroup,
<span class="nc" id="L42">    private val imageManager: ImageManager,</span>
<span class="nc" id="L43">    private val uiHelpers: UiHelpers</span>
<span class="nc" id="L44">) : RecyclerView.ViewHolder(LayoutInflater.from(parent.context).inflate(layout, parent, false)) {</span>
<span class="nc" id="L45">    private val featuredImageView: ImageView = itemView.findViewById(R.id.image_featured)</span>
<span class="nc" id="L46">    private val titleTextView: WPTextView = itemView.findViewById(R.id.title)</span>
<span class="nc" id="L47">    private val postInfoTextView: WPTextView = itemView.findViewById(R.id.post_info)</span>
<span class="nc" id="L48">    private val statusesTextView: WPTextView = itemView.findViewById(R.id.statuses_label)</span>
<span class="nc" id="L49">    private val uploadProgressBar: ProgressBar = itemView.findViewById(R.id.upload_progress)</span>
<span class="nc" id="L50">    private val disabledOverlay: FrameLayout = itemView.findViewById(R.id.disabled_overlay)</span>
<span class="nc" id="L51">    private val container: ConstraintLayout = itemView.findViewById(R.id.container)</span>
<span class="nc" id="L52">    private val selectableBackground: Drawable? = parent.context.getDrawableFromAttribute(</span>
<span class="nc" id="L53">            android.R.attr.selectableItemBackground</span>
    )
    /**
     * Url of an image loaded in the `featuredImageView`.
     */
    private var loadedFeaturedImgUrl: String? = null

    companion object {
<span class="nc" id="L61">        var isClickEnabled = AtomicBoolean(true)</span>
    }

    abstract fun onBind(item: PostListItemUiState)

<span class="nc" id="L66">    class Standard(</span>
        parent: ViewGroup,
        imageManager: ImageManager,
<span class="nc" id="L69">        private val uiHelpers: UiHelpers</span>
<span class="nc" id="L70">    ) : PostListItemViewHolder(R.layout.post_list_item, parent, imageManager, uiHelpers) {</span>
<span class="nc" id="L71">        private val excerptTextView: WPTextView = itemView.findViewById(R.id.excerpt)</span>
<span class="nc" id="L72">        private val actionButtons: List&lt;PostListButton&gt; = listOf(</span>
<span class="nc" id="L73">                itemView.findViewById(R.id.btn_primary),</span>
<span class="nc" id="L74">                itemView.findViewById(R.id.btn_secondary),</span>
<span class="nc" id="L75">                itemView.findViewById(R.id.btn_ternary)</span>
        )

        override fun onBind(item: PostListItemUiState) {
<span class="nc" id="L79">            setBasicValues(item.data)</span>

<span class="nc" id="L81">            uiHelpers.setTextOrHide(excerptTextView, item.data.excerpt)</span>
<span class="nc" id="L82">            itemView.setOnClickListener {</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                if (isSafeClick(it)) {</span>
<span class="nc" id="L84">                    item.onSelected.invoke()</span>
                }
<span class="nc" id="L86">            }</span>

<span class="nc" id="L88">            actionButtons.forEachIndexed { index, button -&gt;</span>
<span class="nc" id="L89">                updateMenuItem(button, item.actions.getOrNull(index))</span>
<span class="nc" id="L90">            }</span>
<span class="nc" id="L91">        }</span>

        private fun updateMenuItem(postListButton: PostListButton, action: PostListItemAction?) {
<span class="nc bnc" id="L94" title="All 2 branches missed.">            uiHelpers.updateVisibility(postListButton, action != null)</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L96">                when (action) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                    is SingleItem -&gt; {</span>
<span class="nc" id="L98">                        postListButton.updateButtonType(action.buttonType)</span>
<span class="nc" id="L99">                        postListButton.setOnClickListener {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                            if (isSafeClick(it)) {</span>
<span class="nc" id="L101">                                action.onButtonClicked.invoke(action.buttonType)</span>
                            }
<span class="nc" id="L103">                        }</span>
                    }
<span class="nc bnc" id="L105" title="All 2 branches missed.">                    is MoreItem -&gt; {</span>
<span class="nc" id="L106">                        postListButton.updateButtonType(action.buttonType)</span>
<span class="nc" id="L107">                        postListButton.setOnClickListener { view -&gt;</span>
<span class="nc" id="L108">                            action.onButtonClicked.invoke(action.buttonType)</span>
<span class="nc" id="L109">                            onMoreClicked(action.actions, view)</span>
<span class="nc" id="L110">                        }</span>
                    }
                }
            }
<span class="nc" id="L114">        }</span>

        // Purpose of this method is to prevent 2 Editors
        // from being launched simultaneously and then producing a crash
        private fun isSafeClick(view: View): Boolean {
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (isClickEnabled.getAndSet(false)) {</span>
<span class="nc" id="L120">                view.postDelayed({</span>
<span class="nc" id="L121">                    isClickEnabled.set(true)</span>
<span class="nc" id="L122">                }, 1000)</span>
<span class="nc" id="L123">                return true</span>
            }
<span class="nc" id="L125">            return false</span>
        }
    }

<span class="nc" id="L129">    class Compact(</span>
        parent: ViewGroup,
        imageManager: ImageManager,
<span class="nc" id="L132">        private val uiHelpers: UiHelpers</span>
<span class="nc" id="L133">    ) : PostListItemViewHolder(R.layout.post_list_item_compact, parent, imageManager, uiHelpers) {</span>
<span class="nc" id="L134">        private val moreButton: ImageButton = itemView.findViewById(R.id.more_button)</span>

        override fun onBind(item: PostListItemUiState) {
<span class="nc" id="L137">            setBasicValues(item.data)</span>

<span class="nc" id="L139">            itemView.setOnClickListener { item.onSelected.invoke() }</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            uiHelpers.updateVisibility(moreButton, item.compactActions.actions.isNotEmpty())</span>
<span class="nc" id="L141">            moreButton.expandTouchTargetArea(R.dimen.post_list_more_button_extra_padding)</span>
<span class="nc" id="L142">            moreButton.setOnClickListener { onMoreClicked(item.compactActions.actions, moreButton) }</span>
<span class="nc" id="L143">        }</span>
    }

    protected fun setBasicValues(data: PostListItemUiStateData) {
<span class="nc" id="L147">        uiHelpers.setTextOrHide(titleTextView, data.title)</span>
<span class="nc" id="L148">        updatePostInfoLabel(postInfoTextView, data.postInfo)</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        uiHelpers.updateVisibility(statusesTextView, data.statuses.isNotEmpty())</span>
<span class="nc" id="L150">        updateStatusesLabel(statusesTextView, data.statuses, data.statusesDelimiter, data.statusesColor)</span>
<span class="nc" id="L151">        showFeaturedImage(data.imageUrl)</span>
<span class="nc" id="L152">        updateProgressBarState(data.progressBarUiState)</span>
<span class="nc" id="L153">        uiHelpers.updateVisibility(disabledOverlay, data.showOverlay)</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (data.disableRippleEffect) {</span>
<span class="nc" id="L155">            container.background = null</span>
        } else {
<span class="nc" id="L157">            container.background = selectableBackground</span>
        }
<span class="nc" id="L159">    }</span>

    private fun updatePostInfoLabel(view: TextView, uiStrings: List&lt;UiString&gt;?) {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        val concatenatedText = uiStrings?.joinToString(separator = &quot;  Â·  &quot;) {</span>
<span class="nc" id="L163">            uiHelpers.getTextOfUiString(view.context, it)</span>
        }
<span class="nc" id="L165">        uiHelpers.setTextOrHide(view, concatenatedText)</span>
<span class="nc" id="L166">    }</span>

    protected fun onMoreClicked(actions: List&lt;PostListItemAction&gt;, v: View) {
<span class="nc" id="L169">        val menu = PopupMenu(v.context, v)</span>
<span class="nc" id="L170">        actions.forEach { singleItemAction -&gt;</span>
<span class="nc" id="L171">            val menuItem = menu.menu.add(</span>
<span class="nc" id="L172">                    Menu.NONE,</span>
<span class="nc" id="L173">                    singleItemAction.buttonType.value,</span>
<span class="nc" id="L174">                    Menu.NONE,</span>
<span class="nc" id="L175">                    singleItemAction.buttonType.textResId</span>
            )
<span class="nc" id="L177">            menuItem.setOnMenuItemClickListener {</span>
<span class="nc" id="L178">                singleItemAction.onButtonClicked.invoke(singleItemAction.buttonType)</span>
<span class="nc" id="L179">                true</span>
            }
<span class="nc" id="L181">        }</span>
<span class="nc" id="L182">        menu.show()</span>
<span class="nc" id="L183">    }</span>

    private fun updateProgressBarState(progressBarUiState: ProgressBarUiState) {
<span class="nc" id="L186">        uiHelpers.updateVisibility(uploadProgressBar, progressBarUiState.visibility)</span>
<span class="nc" id="L187">        when (progressBarUiState) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            Indeterminate -&gt; uploadProgressBar.isIndeterminate = true</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">            is Determinate -&gt; {</span>
<span class="nc" id="L190">                uploadProgressBar.isIndeterminate = false</span>
<span class="nc" id="L191">                uploadProgressBar.progress = progressBarUiState.progress</span>
            }
        }
<span class="nc" id="L194">    }</span>

    private fun updateStatusesLabel(
        view: WPTextView,
        statuses: List&lt;UiString&gt;,
        delimiter: UiString,
        @ColorRes color: Int?
    ) {
<span class="nc" id="L202">        val separator = uiHelpers.getTextOfUiString(view.context, delimiter)</span>
<span class="nc" id="L203">        view.text = statuses.joinToString(separator) { uiHelpers.getTextOfUiString(view.context, it) }</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        color?.let { statusColor -&gt;</span>
<span class="nc" id="L205">            view.setTextColor(</span>
<span class="nc" id="L206">                    ContextCompat.getColor(</span>
<span class="nc" id="L207">                            itemView.context,</span>
<span class="nc" id="L208">                            statusColor</span>
                    )
            )
<span class="nc" id="L211">        }</span>
<span class="nc" id="L212">    }</span>

    private fun showFeaturedImage(imageUrl: String?) {
<span class="nc bnc" id="L215" title="All 8 branches missed.">        if (!imageUrl.isNullOrBlank() &amp;&amp; imageUrl == loadedFeaturedImgUrl) {</span>
            // Suppress blinking as the media upload progresses
<span class="nc" id="L217">            return</span>
        }
<span class="nc bnc" id="L219" title="All 6 branches missed.">        if (imageUrl.isNullOrBlank()) {</span>
<span class="nc" id="L220">            featuredImageView.visibility = View.GONE</span>
<span class="nc" id="L221">            imageManager.cancelRequestAndClearImageView(featuredImageView)</span>
        } else {
<span class="nc" id="L223">            featuredImageView.visibility = View.VISIBLE</span>
<span class="nc" id="L224">            imageManager.load(featuredImageView, ImageType.PHOTO, imageUrl, ScaleType.CENTER_CROP)</span>
        }
<span class="nc" id="L226">        loadedFeaturedImgUrl = imageUrl</span>
<span class="nc" id="L227">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>