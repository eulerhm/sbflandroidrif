<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommentDetailFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.comments</a> &gt; <span class="el_source">CommentDetailFragment.java</span></div><h1>CommentDetailFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.comments;

import android.app.Activity;
import android.content.ActivityNotFoundException;
import android.content.ClipData;
import android.content.ClipboardManager;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.text.Editable;
import android.text.Html;
import android.text.TextUtils;
import android.text.TextWatcher;
import android.view.HapticFeedbackConstants;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.inputmethod.EditorInfo;
import android.widget.ImageView;
import android.widget.ProgressBar;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AlertDialog;
import androidx.core.content.ContextCompat;
import androidx.core.content.res.ResourcesCompat;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentTransaction;

import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.google.android.material.elevation.ElevationOverlayProvider;
import com.google.android.material.snackbar.Snackbar;

import org.apache.commons.text.StringEscapeUtils;
import org.greenrobot.eventbus.EventBus;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.jetbrains.annotations.NotNull;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.datasets.NotificationsTable;
import org.wordpress.android.datasets.ReaderPostTable;
import org.wordpress.android.datasets.UserSuggestionTable;
import org.wordpress.android.fluxc.action.CommentAction;
import org.wordpress.android.fluxc.generated.CommentActionBuilder;
import org.wordpress.android.fluxc.model.CommentModel;
import org.wordpress.android.fluxc.model.CommentStatus;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.CommentStore.OnCommentChanged;
import org.wordpress.android.fluxc.store.CommentStore.RemoteCommentPayload;
import org.wordpress.android.fluxc.store.CommentStore.RemoteCreateCommentPayload;
import org.wordpress.android.fluxc.store.CommentStore.RemoteLikeCommentPayload;
import org.wordpress.android.fluxc.store.CommentsStore;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.tools.FluxCImageLoader;
import org.wordpress.android.models.Note;
import org.wordpress.android.models.Note.EnabledActions;
import org.wordpress.android.models.UserSuggestion;
import org.wordpress.android.models.usecases.LocalCommentCacheUpdateHandler;
import org.wordpress.android.ui.ActivityId;
import org.wordpress.android.ui.CollapseFullScreenDialogFragment;
import org.wordpress.android.ui.CollapseFullScreenDialogFragment.Builder;
import org.wordpress.android.ui.CollapseFullScreenDialogFragment.OnCollapseListener;
import org.wordpress.android.ui.CollapseFullScreenDialogFragment.OnConfirmListener;
import org.wordpress.android.ui.CommentFullScreenDialogFragment;
import org.wordpress.android.ui.ViewPagerFragment;
import org.wordpress.android.ui.comments.CommentActions.OnCommentActionListener;
import org.wordpress.android.ui.comments.CommentActions.OnNoteCommentActionListener;
import org.wordpress.android.ui.comments.unified.CommentIdentifier;
import org.wordpress.android.ui.comments.unified.CommentIdentifier.NotificationCommentIdentifier;
import org.wordpress.android.ui.comments.unified.CommentIdentifier.SiteCommentIdentifier;
import org.wordpress.android.ui.comments.unified.CommentSource;
import org.wordpress.android.ui.comments.unified.CommentsStoreAdapter;
import org.wordpress.android.ui.comments.unified.UnifiedCommentsEditActivity;
import org.wordpress.android.ui.notifications.NotificationEvents;
import org.wordpress.android.ui.notifications.NotificationFragment;
import org.wordpress.android.ui.notifications.NotificationsDetailListFragment;
import org.wordpress.android.ui.reader.ReaderActivityLauncher;
import org.wordpress.android.ui.reader.ReaderAnim;
import org.wordpress.android.ui.reader.actions.ReaderActions;
import org.wordpress.android.ui.reader.actions.ReaderPostActions;
import org.wordpress.android.ui.suggestion.Suggestion;
import org.wordpress.android.ui.suggestion.adapters.SuggestionAdapter;
import org.wordpress.android.ui.suggestion.service.SuggestionEvents;
import org.wordpress.android.ui.suggestion.util.SuggestionServiceConnectionManager;
import org.wordpress.android.ui.suggestion.util.SuggestionUtils;
import org.wordpress.android.util.AniUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.ColorUtils;
import org.wordpress.android.util.extensions.ContextExtensionsKt;
import org.wordpress.android.util.DateTimeUtils;
import org.wordpress.android.util.EditTextUtils;
import org.wordpress.android.util.GravatarUtils;
import org.wordpress.android.util.HtmlUtils;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.extensions.ViewExtensionsKt;
import org.wordpress.android.util.WPLinkMovementMethod;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.util.config.UnifiedCommentsCommentEditFeatureConfig;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageType;
import org.wordpress.android.widgets.SuggestionAutoCompleteText;
import org.wordpress.android.widgets.WPSnackbar;

import java.util.EnumSet;
import java.util.List;
import java.util.Locale;

import javax.inject.Inject;

import kotlinx.coroutines.BuildersKt;
import kotlinx.coroutines.CoroutineStart;
import kotlinx.coroutines.Dispatchers;
import kotlinx.coroutines.GlobalScope;

/**
 * comment detail displayed from both the notification list and the comment list
 * prior to this there were separate comment detail screens for each list
 *
 * @deprecated Comments are being refactored as part of Comments Unification project. If you are adding any
 * features or modifying this class, please ping develric or klymyam
 */
@Deprecated
<span class="nc" id="L133">public class CommentDetailFragment extends ViewPagerFragment implements NotificationFragment, OnConfirmListener,</span>
        OnCollapseListener {
    private static final String KEY_MODE = &quot;KEY_MODE&quot;;
    private static final String KEY_SITE_LOCAL_ID = &quot;KEY_SITE_LOCAL_ID&quot;;
    private static final String KEY_COMMENT_ID = &quot;KEY_COMMENT_ID&quot;;
    private static final String KEY_NOTE_ID = &quot;KEY_NOTE_ID&quot;;
    private static final String KEY_REPLY_TEXT = &quot;KEY_REPLY_TEXT&quot;;

    private static final int INTENT_COMMENT_EDITOR = 1010;

    private CommentModel mComment;
    private SiteModel mSite;

    private Note mNote;
    private SuggestionAdapter mSuggestionAdapter;
    private SuggestionServiceConnectionManager mSuggestionServiceConnectionManager;
    private TextView mTxtStatus;
    private TextView mTxtContent;
    private View mSubmitReplyBtn;
    private SuggestionAutoCompleteText mEditReply;
    private ViewGroup mLayoutReply;
    private ViewGroup mLayoutButtons;
    private ViewGroup mCommentContentLayout;
    private View mBtnLikeComment;
    private ImageView mBtnLikeIcon;
    private TextView mBtnLikeTextView;
    private View mBtnModerateComment;
    private ImageView mBtnModerateIcon;
    private TextView mBtnModerateTextView;
    private View mBtnSpamComment;
    private TextView mBtnSpamCommentText;
    private View mBtnMoreComment;
    private View mSnackbarAnchor;
    private View mNestedScrollView;
    private String mRestoredReplyText;
    private String mRestoredNoteId;
<span class="nc" id="L169">    private boolean mIsUsersBlog = false;</span>
    private boolean mShouldFocusReplyField;
    private String mPreviousStatus;
<span class="nc" id="L172">    private float mNormalOpacity = 1f;</span>
    private float mMediumOpacity;

    @Inject AccountStore mAccountStore;
    @Inject CommentsStoreAdapter mCommentsStoreAdapter;
    @Inject SiteStore mSiteStore;
    @Inject FluxCImageLoader mImageLoader;
    @Inject ImageManager mImageManager;
    @Inject CommentsStore mCommentsStore;
    @Inject LocalCommentCacheUpdateHandler mLocalCommentCacheUpdateHandler;
    @Inject UnifiedCommentsCommentEditFeatureConfig mUnifiedCommentsCommentEditFeatureConfig;

<span class="nc" id="L184">    private boolean mIsSubmittingReply = false;</span>
    private NotificationsDetailListFragment mNotificationsDetailListFragment;
    private OnPostClickListener mOnPostClickListener;
    private OnCommentActionListener mOnCommentActionListener;
    private OnNoteCommentActionListener mOnNoteCommentActionListener;

    private CommentSource mCommentSource;

    /*
     * these determine which actions (moderation, replying, marking as spam) to enable
     * for this comment - all actions are enabled when opened from the comment list, only
     * changed when opened from a notification
     */
<span class="nc" id="L197">    private EnumSet&lt;EnabledActions&gt; mEnabledActions = EnumSet.allOf(EnabledActions.class);</span>

    /*
     * used when called from comment list
     */
    static CommentDetailFragment newInstance(SiteModel site, CommentModel commentModel) {
<span class="nc" id="L203">        CommentDetailFragment fragment = new CommentDetailFragment();</span>
<span class="nc" id="L204">        Bundle args = new Bundle();</span>
<span class="nc" id="L205">        args.putSerializable(KEY_MODE, CommentSource.SITE_COMMENTS);</span>
<span class="nc" id="L206">        args.putInt(KEY_SITE_LOCAL_ID, site.getId());</span>
<span class="nc" id="L207">        args.putLong(KEY_COMMENT_ID, commentModel.getRemoteCommentId());</span>
<span class="nc" id="L208">        fragment.setArguments(args);</span>
<span class="nc" id="L209">        return fragment;</span>
    }

    /*
     * used when called from notification list for a comment notification
     */
    public static CommentDetailFragment newInstance(final String noteId, final String replyText) {
<span class="nc" id="L216">        CommentDetailFragment fragment = new CommentDetailFragment();</span>
<span class="nc" id="L217">        Bundle args = new Bundle();</span>
<span class="nc" id="L218">        args.putSerializable(KEY_MODE, CommentSource.NOTIFICATION);</span>
<span class="nc" id="L219">        args.putString(KEY_NOTE_ID, noteId);</span>
<span class="nc" id="L220">        args.putString(KEY_REPLY_TEXT, replyText);</span>
<span class="nc" id="L221">        fragment.setArguments(args);</span>
<span class="nc" id="L222">        return fragment;</span>
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L227">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L228">        ((WordPress) getActivity().getApplication()).component().inject(this);</span>

<span class="nc" id="L230">        mCommentSource = (CommentSource) getArguments().getSerializable(KEY_MODE);</span>

<span class="nc bnc" id="L232" title="All 3 branches missed.">        switch (mCommentSource) {</span>
            case SITE_COMMENTS:
<span class="nc" id="L234">                setComment(getArguments().getLong(KEY_COMMENT_ID), getArguments().getInt(KEY_SITE_LOCAL_ID));</span>
<span class="nc" id="L235">                break;</span>
            case NOTIFICATION:
<span class="nc" id="L237">                setNote(getArguments().getString(KEY_NOTE_ID));</span>
<span class="nc" id="L238">                setReplyText(getArguments().getString(KEY_REPLY_TEXT));</span>
                break;
        }

<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (savedInstanceState.getString(KEY_NOTE_ID) != null) {</span>
                // The note will be set in onResume()
                // See WordPress.deferredInit()
<span class="nc" id="L246">                mRestoredNoteId = savedInstanceState.getString(KEY_NOTE_ID);</span>
            } else {
<span class="nc" id="L248">                int siteId = savedInstanceState.getInt(KEY_SITE_LOCAL_ID);</span>
<span class="nc" id="L249">                long commentId = savedInstanceState.getLong(KEY_COMMENT_ID);</span>
<span class="nc" id="L250">                setComment(commentId, siteId);</span>
            }
        }

<span class="nc" id="L254">        setHasOptionsMenu(true);</span>
<span class="nc" id="L255">    }</span>

    @Override
    public void onSaveInstanceState(@NotNull Bundle outState) {
<span class="nc" id="L259">        super.onSaveInstanceState(outState);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (mComment != null) {</span>
<span class="nc" id="L261">            outState.putLong(KEY_COMMENT_ID, mComment.getRemoteCommentId());</span>
<span class="nc" id="L262">            outState.putInt(KEY_SITE_LOCAL_ID, mSite.getId());</span>
        }

<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (mNote != null) {</span>
<span class="nc" id="L266">            outState.putString(KEY_NOTE_ID, mNote.getId());</span>
        }
<span class="nc" id="L268">    }</span>

    @Override
    public void onDestroy() {
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (mSuggestionServiceConnectionManager != null) {</span>
<span class="nc" id="L273">            mSuggestionServiceConnectionManager.unbindFromService();</span>
        }
<span class="nc" id="L275">        super.onDestroy();</span>
<span class="nc" id="L276">    }</span>

    // touching the file resulted in the MethodLength, it's suppressed until we get time to refactor this method
    @SuppressWarnings(&quot;checkstyle:MethodLength&quot;)
    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L282">        final View view = inflater.inflate(R.layout.comment_detail_fragment, container, false);</span>

<span class="nc" id="L284">        mMediumOpacity = ResourcesCompat.getFloat(getResources(), R.dimen.material_emphasis_medium);</span>

<span class="nc" id="L286">        mTxtStatus = view.findViewById(R.id.text_status);</span>
<span class="nc" id="L287">        mTxtContent = view.findViewById(R.id.text_content);</span>

        //noinspection InflateParams
<span class="nc" id="L290">        mLayoutButtons = (ViewGroup) inflater.inflate(R.layout.comment_action_footer, null, false);</span>
<span class="nc" id="L291">        mBtnLikeComment = mLayoutButtons.findViewById(R.id.btn_like);</span>
<span class="nc" id="L292">        mBtnLikeIcon = mLayoutButtons.findViewById(R.id.btn_like_icon);</span>
<span class="nc" id="L293">        mBtnLikeTextView = mLayoutButtons.findViewById(R.id.btn_like_text);</span>
<span class="nc" id="L294">        mBtnModerateComment = mLayoutButtons.findViewById(R.id.btn_moderate);</span>
<span class="nc" id="L295">        mBtnModerateIcon = mLayoutButtons.findViewById(R.id.btn_moderate_icon);</span>
<span class="nc" id="L296">        mBtnModerateTextView = mLayoutButtons.findViewById(R.id.btn_moderate_text);</span>
<span class="nc" id="L297">        mBtnSpamComment = mLayoutButtons.findViewById(R.id.btn_spam);</span>
<span class="nc" id="L298">        mBtnSpamCommentText = mLayoutButtons.findViewById(R.id.btn_spam_text);</span>
<span class="nc" id="L299">        mBtnMoreComment = mLayoutButtons.findViewById(R.id.btn_more);</span>
<span class="nc" id="L300">        mSnackbarAnchor = view.findViewById(R.id.layout_bottom);</span>
<span class="nc" id="L301">        mNestedScrollView = view.findViewById(R.id.nested_scroll_view);</span>

        // As we are using CommentDetailFragment in a ViewPager, and we also use nested fragments within
        // CommentDetailFragment itself:
        // It is important to have a live reference to the Comment Container layout at the moment this layout is
        // inflated (onCreateView), so we can make sure we set its ID correctly once we have an actual Comment object
        // to populate it with. Otherwise, we could be searching and finding the container for _another fragment/page
        // in the viewpager_, which would cause strange results (changing the views for a different fragment than we
        // intended to).
<span class="nc" id="L310">        mCommentContentLayout = view.findViewById(R.id.comment_content_container);</span>

<span class="nc" id="L312">        mLayoutReply = view.findViewById(R.id.layout_comment_box);</span>

<span class="nc" id="L314">        ElevationOverlayProvider elevationOverlayProvider = new ElevationOverlayProvider(view.getContext());</span>
<span class="nc" id="L315">        float appbarElevation = getResources().getDimension(R.dimen.appbar_elevation);</span>
<span class="nc" id="L316">        int elevatedColor = elevationOverlayProvider.compositeOverlayWithThemeSurfaceColorIfNeeded(appbarElevation);</span>

<span class="nc" id="L318">        mLayoutReply.setBackgroundColor(elevatedColor);</span>

<span class="nc" id="L320">        mSubmitReplyBtn = mLayoutReply.findViewById(R.id.btn_submit_reply);</span>
<span class="nc" id="L321">        mSubmitReplyBtn.setEnabled(false);</span>
<span class="nc" id="L322">        mSubmitReplyBtn.setOnLongClickListener(view1 -&gt; {</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">            if (view1.isHapticFeedbackEnabled()) {</span>
<span class="nc" id="L324">                view1.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span>
            }

<span class="nc" id="L327">            Toast.makeText(view1.getContext(), R.string.send, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L328">            return true;</span>
        });
<span class="nc" id="L330">        ViewExtensionsKt.redirectContextClickToLongPressListener(mSubmitReplyBtn);</span>

<span class="nc" id="L332">        mEditReply = mLayoutReply.findViewById(R.id.edit_comment);</span>
<span class="nc" id="L333">        mEditReply.initializeWithPrefix('@');</span>
<span class="nc" id="L334">        mEditReply.addTextChangedListener(new TextWatcher() {</span>
            @Override
            public void beforeTextChanged(CharSequence s, int start, int count, int after) {
<span class="nc" id="L337">            }</span>

            @Override
            public void onTextChanged(CharSequence s, int start, int before, int count) {
<span class="nc" id="L341">            }</span>

            @Override
            public void afterTextChanged(Editable s) {
<span class="nc bnc" id="L345" title="All 2 branches missed.">                mSubmitReplyBtn.setEnabled(!TextUtils.isEmpty(s.toString().trim()));</span>
<span class="nc" id="L346">            }</span>
        });

<span class="nc" id="L349">        ImageView buttonExpand = mLayoutReply.findViewById(R.id.button_expand);</span>
<span class="nc" id="L350">        buttonExpand.setOnClickListener(</span>
                v -&gt; {
<span class="nc" id="L352">                    Bundle bundle = CommentFullScreenDialogFragment.Companion.newBundle(</span>
<span class="nc" id="L353">                            mEditReply.getText().toString(),</span>
<span class="nc" id="L354">                            mEditReply.getSelectionStart(),</span>
<span class="nc" id="L355">                            mEditReply.getSelectionEnd(),</span>
<span class="nc" id="L356">                            mSite.getSiteId()</span>
                    );

<span class="nc" id="L359">                    new Builder(requireContext())</span>
<span class="nc" id="L360">                            .setTitle(R.string.comment)</span>
<span class="nc" id="L361">                            .setOnCollapseListener(this)</span>
<span class="nc" id="L362">                            .setOnConfirmListener(this)</span>
<span class="nc" id="L363">                            .setContent(CommentFullScreenDialogFragment.class, bundle)</span>
<span class="nc" id="L364">                            .setAction(R.string.send)</span>
<span class="nc" id="L365">                            .setHideActivityBar(true)</span>
<span class="nc" id="L366">                            .build()</span>
<span class="nc" id="L367">                            .show(requireActivity().getSupportFragmentManager(),</span>
<span class="nc" id="L368">                                    CollapseFullScreenDialogFragment.TAG + getCommentSpecificFragmentTagSuffix());</span>
<span class="nc" id="L369">                }</span>
        );
<span class="nc" id="L371">        buttonExpand.setOnLongClickListener(v -&gt; {</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (v.isHapticFeedbackEnabled()) {</span>
<span class="nc" id="L373">                v.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span>
            }

<span class="nc" id="L376">            Toast.makeText(v.getContext(), R.string.description_expand, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L377">            return true;</span>
        });
<span class="nc" id="L379">        ViewExtensionsKt.redirectContextClickToLongPressListener(buttonExpand);</span>
<span class="nc" id="L380">        setReplyUniqueId();</span>

        // hide comment like button until we know it can be enabled in showCommentAsNotification()
<span class="nc" id="L383">        mBtnLikeComment.setVisibility(View.GONE);</span>

        // hide moderation buttons until updateModerationButtons() is called
<span class="nc" id="L386">        mLayoutButtons.setVisibility(View.GONE);</span>

        // this is necessary in order for anchor tags in the comment text to be clickable
<span class="nc" id="L389">        mTxtContent.setLinksClickable(true);</span>
<span class="nc" id="L390">        mTxtContent.setMovementMethod(WPLinkMovementMethod.getInstance());</span>

<span class="nc" id="L392">        mEditReply.setHint(R.string.reader_hint_comment_on_comment);</span>
<span class="nc" id="L393">        mEditReply.setOnEditorActionListener((v, actionId, event) -&gt; {</span>
<span class="nc bnc" id="L394" title="All 4 branches missed.">            if (actionId == EditorInfo.IME_ACTION_DONE || actionId == EditorInfo.IME_ACTION_SEND) {</span>
<span class="nc" id="L395">                submitReply();</span>
            }
<span class="nc" id="L397">            return false;</span>
        });

<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (!TextUtils.isEmpty(mRestoredReplyText)) {</span>
<span class="nc" id="L401">            mEditReply.setText(mRestoredReplyText);</span>
<span class="nc" id="L402">            mRestoredReplyText = null;</span>
        }

<span class="nc" id="L405">        mSubmitReplyBtn.setOnClickListener(v -&gt; submitReply());</span>

<span class="nc" id="L407">        mBtnSpamComment.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">            if (mComment == null) {</span>
<span class="nc" id="L409">                return;</span>
            }

<span class="nc bnc" id="L412" title="All 2 branches missed.">            if (CommentStatus.fromString(mComment.getStatus()) == CommentStatus.SPAM) {</span>
<span class="nc" id="L413">                moderateComment(CommentStatus.APPROVED);</span>
<span class="nc" id="L414">                announceCommentStatusChangeForAccessibility(CommentStatus.UNSPAM);</span>
            } else {
<span class="nc" id="L416">                moderateComment(CommentStatus.SPAM);</span>
<span class="nc" id="L417">                announceCommentStatusChangeForAccessibility(CommentStatus.SPAM);</span>
            }
<span class="nc" id="L419">        });</span>

<span class="nc" id="L421">        mBtnLikeComment.setOnClickListener(v -&gt; likeComment(false));</span>

<span class="nc" id="L423">        mBtnMoreComment.setOnClickListener(v -&gt; showMoreMenu(v));</span>
        // hide more button until we know it can be enabled
<span class="nc" id="L425">        mBtnMoreComment.setVisibility(View.GONE);</span>

<span class="nc" id="L427">        setupSuggestionServiceAndAdapter();</span>

<span class="nc" id="L429">        return view;</span>
    }

    private String getCommentSpecificFragmentTagSuffix() {
<span class="nc" id="L433">        return &quot;_&quot; + mComment.getRemoteSiteId() + &quot;_&quot; + mComment.getRemoteCommentId();</span>
    }

    @Override
    public void onConfirm(@Nullable Bundle result) {
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L439">            mEditReply.setText(result.getString(CommentFullScreenDialogFragment.RESULT_REPLY));</span>
<span class="nc" id="L440">            submitReply();</span>
        }
<span class="nc" id="L442">    }</span>

    @Override
    public void onCollapse(@Nullable Bundle result) {
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L447">            mEditReply.setText(result.getString(CommentFullScreenDialogFragment.RESULT_REPLY));</span>
<span class="nc" id="L448">            mEditReply.setSelection(result.getInt(</span>
                    CommentFullScreenDialogFragment.RESULT_SELECTION_START),
<span class="nc" id="L450">                    result.getInt(CommentFullScreenDialogFragment.RESULT_SELECTION_END));</span>
<span class="nc" id="L451">            mEditReply.requestFocus();</span>
        }
<span class="nc" id="L453">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L457">        super.onResume();</span>
<span class="nc" id="L458">        ActivityId.trackLastActivity(ActivityId.COMMENT_DETAIL);</span>

        // Set the note if we retrieved the noteId from savedInstanceState
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (!TextUtils.isEmpty(mRestoredNoteId)) {</span>
<span class="nc" id="L462">            setNote(mRestoredNoteId);</span>
<span class="nc" id="L463">            mRestoredNoteId = null;</span>
        }

        // reattach listeners to collapsible reply dialog
        // we need to to it in onResume to make sure mComment is already intialized
<span class="nc" id="L468">        CollapseFullScreenDialogFragment fragment =</span>
<span class="nc" id="L469">                (CollapseFullScreenDialogFragment) requireActivity().getSupportFragmentManager().findFragmentByTag(</span>
<span class="nc" id="L470">                        CollapseFullScreenDialogFragment.TAG + getCommentSpecificFragmentTagSuffix());</span>

<span class="nc bnc" id="L472" title="All 4 branches missed.">        if (fragment != null &amp;&amp; fragment.isAdded()) {</span>
<span class="nc" id="L473">            fragment.setOnCollapseListener(this);</span>
<span class="nc" id="L474">            fragment.setOnConfirmListener(this);</span>
        }
<span class="nc" id="L476">    }</span>

    private void setupSuggestionServiceAndAdapter() {
<span class="nc bnc" id="L479" title="All 6 branches missed.">        if (!isAdded() || mSite == null || !SiteUtils.isAccessedViaWPComRest(mSite)) {</span>
<span class="nc" id="L480">            return;</span>
        }
<span class="nc" id="L482">        mSuggestionServiceConnectionManager = new SuggestionServiceConnectionManager(getActivity(), mSite.getSiteId());</span>
<span class="nc" id="L483">        mSuggestionAdapter = SuggestionUtils.setupUserSuggestions(mSite, getActivity(),</span>
                mSuggestionServiceConnectionManager);
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (mSuggestionAdapter != null) {</span>
<span class="nc" id="L486">            mEditReply.setAdapter(mSuggestionAdapter);</span>
        }
<span class="nc" id="L488">    }</span>

    private void setReplyUniqueId() {
<span class="nc bnc" id="L491" title="All 4 branches missed.">        if (mEditReply != null &amp;&amp; isAdded()) {</span>
<span class="nc" id="L492">            String sId = null;</span>
<span class="nc bnc" id="L493" title="All 4 branches missed.">            if (mSite != null &amp;&amp; mComment != null) {</span>
<span class="nc" id="L494">                sId = String.format(Locale.US, &quot;%d-%d&quot;, mSite.getSiteId(), mComment.getRemoteCommentId());</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">            } else if (mNote != null) {</span>
<span class="nc" id="L496">                sId = String.format(Locale.US, &quot;%d-%d&quot;, mNote.getSiteId(), mNote.getCommentId());</span>
            }
<span class="nc bnc" id="L498" title="All 2 branches missed.">            if (sId != null) {</span>
<span class="nc" id="L499">                mEditReply.getAutoSaveTextHelper().setUniqueId(sId);</span>
<span class="nc" id="L500">                mEditReply.getAutoSaveTextHelper().loadString(mEditReply);</span>
            }
        }
<span class="nc" id="L503">    }</span>

    private void setComment(final long commentRemoteId, final int siteLocalId) {
<span class="nc" id="L506">        final SiteModel site = mSiteStore.getSiteByLocalId(siteLocalId);</span>
<span class="nc" id="L507">        setComment(mCommentsStoreAdapter.getCommentBySiteAndRemoteId(site, commentRemoteId), site);</span>
<span class="nc" id="L508">    }</span>

    private void setComment(@Nullable final CommentModel comment, @Nullable final SiteModel site) {
<span class="nc" id="L511">        mComment = comment;</span>
<span class="nc" id="L512">        mSite = site;</span>

        // is this comment on one of the user's blogs? it won't be if this was displayed from a
        // notification about a reply to a comment this user posted on someone else's blog
<span class="nc bnc" id="L516" title="All 4 branches missed.">        mIsUsersBlog = (comment != null &amp;&amp; site != null);</span>

<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L519">            showComment();</span>
        }

        // Reset the reply unique id since mComment just changed.
<span class="nc" id="L523">        setReplyUniqueId();</span>
<span class="nc" id="L524">    }</span>

    private void disableShouldFocusReplyField() {
<span class="nc" id="L527">        mShouldFocusReplyField = false;</span>
<span class="nc" id="L528">    }</span>

    public void enableShouldFocusReplyField() {
<span class="nc" id="L531">        mShouldFocusReplyField = true;</span>
<span class="nc" id="L532">    }</span>

    @Override
    public Note getNote() {
<span class="nc" id="L536">        return mNote;</span>
    }

    private SiteModel createDummyWordPressComSite(long siteId) {
<span class="nc" id="L540">        SiteModel site = new SiteModel();</span>
<span class="nc" id="L541">        site.setIsWPCom(true);</span>
<span class="nc" id="L542">        site.setSiteId(siteId);</span>
<span class="nc" id="L543">        return site;</span>
    }

    public void setNote(Note note) {
<span class="nc" id="L547">        mNote = note;</span>
<span class="nc" id="L548">        mSite = mSiteStore.getSiteBySiteId(note.getSiteId());</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">        if (mSite == null) {</span>
            // This should not exist, we should clean that screen so a note without a site/comment can be displayed
<span class="nc" id="L551">            mSite = createDummyWordPressComSite(mNote.getSiteId());</span>
        }
<span class="nc bnc" id="L553" title="All 4 branches missed.">        if (isAdded() &amp;&amp; mNote != null) {</span>
<span class="nc" id="L554">            showComment();</span>
        }
<span class="nc" id="L556">    }</span>

    @Override
    public void setNote(String noteId) {
<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (noteId == null) {</span>
<span class="nc" id="L561">            showErrorToastAndFinish();</span>
<span class="nc" id="L562">            return;</span>
        }

<span class="nc" id="L565">        Note note = NotificationsTable.getNoteById(noteId);</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">        if (note == null) {</span>
<span class="nc" id="L567">            showErrorToastAndFinish();</span>
<span class="nc" id="L568">            return;</span>
        }
<span class="nc" id="L570">        setNote(note);</span>
<span class="nc" id="L571">    }</span>

    private void setReplyText(String replyText) {
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (replyText == null) {</span>
<span class="nc" id="L575">            return;</span>
        }
<span class="nc" id="L577">        mRestoredReplyText = replyText;</span>
<span class="nc" id="L578">    }</span>

    private void showErrorToastAndFinish() {
<span class="nc" id="L581">        AppLog.e(AppLog.T.NOTIFS, &quot;Note could not be found.&quot;);</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">        if (getActivity() != null) {</span>
<span class="nc" id="L583">            ToastUtils.showToast(getActivity(), R.string.error_notification_open);</span>
<span class="nc" id="L584">            getActivity().finish();</span>
        }
<span class="nc" id="L586">    }</span>

    @SuppressWarnings(&quot;deprecation&quot;) // TODO: Remove when minSdkVersion &gt;= 23
    public void onAttach(@NotNull Activity activity) {
<span class="nc" id="L590">        super.onAttach(activity);</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">        if (activity instanceof OnPostClickListener) {</span>
<span class="nc" id="L592">            mOnPostClickListener = (OnPostClickListener) activity;</span>
        }
<span class="nc bnc" id="L594" title="All 2 branches missed.">        if (activity instanceof OnCommentActionListener) {</span>
<span class="nc" id="L595">            mOnCommentActionListener = (OnCommentActionListener) activity;</span>
        }
<span class="nc bnc" id="L597" title="All 2 branches missed.">        if (activity instanceof OnNoteCommentActionListener) {</span>
<span class="nc" id="L598">            mOnNoteCommentActionListener = (OnNoteCommentActionListener) activity;</span>
        }
<span class="nc" id="L600">    }</span>

    @Override
    public void onStart() {
<span class="nc" id="L604">        super.onStart();</span>
<span class="nc" id="L605">        EventBus.getDefault().register(this);</span>
<span class="nc" id="L606">        mCommentsStoreAdapter.register(this);</span>
<span class="nc" id="L607">        showComment();</span>
<span class="nc" id="L608">    }</span>

    @Override
    public void onStop() {
<span class="nc" id="L612">        EventBus.getDefault().unregister(this);</span>
<span class="nc" id="L613">        mCommentsStoreAdapter.unregister(this);</span>
<span class="nc" id="L614">        super.onStop();</span>
<span class="nc" id="L615">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(SuggestionEvents.SuggestionNameListUpdated event) {
        // check if the updated suggestions are for the current blog and update the suggestions
<span class="nc bnc" id="L621" title="All 4 branches missed.">        if (event.mRemoteBlogId != 0</span>
            &amp;&amp; mSite != null
<span class="nc bnc" id="L623" title="All 4 branches missed.">            &amp;&amp; event.mRemoteBlogId == mSite.getSiteId()</span>
            &amp;&amp; mSuggestionAdapter != null
        ) {
<span class="nc" id="L626">            List&lt;UserSuggestion&gt; userSuggestions = UserSuggestionTable.getSuggestionsForSite(event.mRemoteBlogId);</span>
<span class="nc" id="L627">            List&lt;Suggestion&gt; suggestions = Suggestion.Companion.fromUserSuggestions(userSuggestions);</span>
<span class="nc" id="L628">            mSuggestionAdapter.setSuggestionList(suggestions);</span>
        }
<span class="nc" id="L630">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L634">        super.onPause();</span>
<span class="nc" id="L635">    }</span>

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L639">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L640" title="All 4 branches missed.">        if (requestCode == INTENT_COMMENT_EDITOR &amp;&amp; resultCode == Activity.RESULT_OK) {</span>
<span class="nc" id="L641">            reloadComment();</span>
        }
<span class="nc" id="L643">    }</span>

    /**
     * Reload the current comment from the local database
     */
    private void reloadComment() {
<span class="nc bnc" id="L649" title="All 2 branches missed.">        if (mComment == null) {</span>
<span class="nc" id="L650">            return;</span>
        }
<span class="nc" id="L652">        CommentModel updatedComment = mCommentsStoreAdapter.getCommentByLocalId(mComment.getId());</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">        if (updatedComment != null) {</span>
<span class="nc" id="L654">            setComment(updatedComment, mSite);</span>
        }
<span class="nc bnc" id="L656" title="All 2 branches missed.">        if (mNotificationsDetailListFragment != null) {</span>
<span class="nc" id="L657">            mNotificationsDetailListFragment.refreshBlocksForEditedComment(mNote.getId());</span>
        }
<span class="nc" id="L659">    }</span>

    /**
     * open the comment for editing
     */
    private void editComment() {
<span class="nc bnc" id="L665" title="All 4 branches missed.">        if (!isAdded() || mComment == null) {</span>
<span class="nc" id="L666">            return;</span>
        }
<span class="nc" id="L668">        AnalyticsUtils.trackCommentActionWithSiteDetails(Stat.COMMENT_EDITOR_OPENED,</span>
<span class="nc" id="L669">                mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>

        // IMPORTANT: don't use getActivity().startActivityForResult() or else onActivityResult()
        // won't be called in this fragment
        // https://code.google.com/p/android/issues/detail?id=15394#c45
<span class="nc bnc" id="L674" title="All 2 branches missed.">        if (mUnifiedCommentsCommentEditFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L675">            final CommentIdentifier commentIdentifier = mapCommentIdentifier();</span>
<span class="nc" id="L676">            final Intent intent =</span>
<span class="nc" id="L677">                    UnifiedCommentsEditActivity.createIntent(requireActivity(), commentIdentifier, mSite);</span>
<span class="nc" id="L678">            startActivityForResult(intent, INTENT_COMMENT_EDITOR);</span>
<span class="nc" id="L679">        } else {</span>
<span class="nc" id="L680">            Intent intent = new Intent(getActivity(), EditCommentActivity.class);</span>
<span class="nc" id="L681">            intent.putExtra(WordPress.SITE, mSite);</span>
<span class="nc" id="L682">            intent.putExtra(EditCommentActivity.KEY_COMMENT, mComment);</span>
<span class="nc bnc" id="L683" title="All 4 branches missed.">            if (mNote != null &amp;&amp; mComment == null) {</span>
<span class="nc" id="L684">                intent.putExtra(EditCommentActivity.KEY_NOTE_ID, mNote.getId());</span>
            }
<span class="nc" id="L686">            startActivityForResult(intent, INTENT_COMMENT_EDITOR);</span>
        }
<span class="nc" id="L688">    }</span>

    @Nullable
    private CommentIdentifier mapCommentIdentifier() {
<span class="nc bnc" id="L692" title="All 3 branches missed.">        switch (mCommentSource) {</span>
            case SITE_COMMENTS:
<span class="nc" id="L694">                return new SiteCommentIdentifier(mComment.getId(), mComment.getRemoteCommentId());</span>
            case NOTIFICATION:
<span class="nc" id="L696">                return new NotificationCommentIdentifier(mNote.getId(), mNote.getCommentId());</span>
            default:
<span class="nc" id="L698">                return null;</span>
        }
    }

    /*
     * display the current comment
     */
    private void showComment() {
<span class="nc bnc" id="L706" title="All 4 branches missed.">        if (!isAdded() || getView() == null) {</span>
<span class="nc" id="L707">            return;</span>
        }

        // these two views contain all the other views except the progress bar
<span class="nc" id="L711">        final View layoutBottom = getView().findViewById(R.id.layout_bottom);</span>

        // hide container views when comment is null (will happen when opened from a notification)
<span class="nc bnc" id="L714" title="All 2 branches missed.">        if (mComment == null) {</span>
<span class="nc" id="L715">            mNestedScrollView.setVisibility(View.GONE);</span>
<span class="nc" id="L716">            layoutBottom.setVisibility(View.GONE);</span>

<span class="nc bnc" id="L718" title="All 2 branches missed.">            if (mNote != null) {</span>
<span class="nc" id="L719">                SiteModel site = mSiteStore.getSiteBySiteId(mNote.getSiteId());</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">                if (site == null) {</span>
                    // This should not exist, we should clean that screen so a note without a site/comment
                    // can be displayed
<span class="nc" id="L723">                    site = createDummyWordPressComSite(mNote.getSiteId());</span>
                }

                // Check if the comment is already in our store
<span class="nc" id="L727">                CommentModel comment = mCommentsStoreAdapter.getCommentBySiteAndRemoteId(site, mNote.getCommentId());</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">                if (comment != null) {</span>
                    // It exists, then show it as a &quot;Notification&quot;
<span class="nc" id="L730">                    showCommentAsNotification(mNote, site, comment);</span>
                } else {
                    // It's not in our store yet, request it.
<span class="nc" id="L733">                    RemoteCommentPayload payload = new RemoteCommentPayload(site, mNote.getCommentId());</span>
<span class="nc" id="L734">                    mCommentsStoreAdapter.dispatch(CommentActionBuilder.newFetchCommentAction(payload));</span>
<span class="nc" id="L735">                    setProgressVisible(true);</span>

                    // Show a &quot;temporary&quot; comment built from the note data, the view will be refreshed once the
                    // comment has been fetched.
<span class="nc" id="L739">                    showCommentAsNotification(mNote, site, null);</span>
                }
            }
<span class="nc" id="L742">            return;</span>
        }

<span class="nc" id="L745">        mNestedScrollView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L746">        layoutBottom.setVisibility(View.VISIBLE);</span>

        // Add action buttons footer
<span class="nc bnc" id="L749" title="All 4 branches missed.">        if (mNote == null &amp;&amp; mLayoutButtons.getParent() == null) {</span>
<span class="nc" id="L750">            mCommentContentLayout.addView(mLayoutButtons);</span>
        }

<span class="nc" id="L753">        final ImageView imgAvatar = getView().findViewById(R.id.image_avatar);</span>
<span class="nc" id="L754">        final TextView txtName = getView().findViewById(R.id.text_name);</span>
<span class="nc" id="L755">        final TextView txtDate = getView().findViewById(R.id.text_date);</span>

<span class="nc bnc" id="L757" title="All 2 branches missed.">        txtName.setText(mComment.getAuthorName() == null ? getString(R.string.anonymous) : mComment.getAuthorName());</span>
<span class="nc" id="L758">        txtDate.setText(DateTimeUtils.javaDateToTimeSpan(DateTimeUtils.dateFromIso8601(mComment.getDatePublished()),</span>
<span class="nc" id="L759">                WordPress.getContext()));</span>

<span class="nc" id="L761">        String renderingError = getString(R.string.comment_unable_to_show_error);</span>
<span class="nc" id="L762">        mTxtContent.post(() -&gt; CommentUtils.displayHtmlComment(mTxtContent, mComment.getContent(),</span>
<span class="nc" id="L763">                mTxtContent.getWidth(), mTxtContent.getLineHeight(), renderingError));</span>

<span class="nc" id="L765">        int avatarSz = getResources().getDimensionPixelSize(R.dimen.avatar_sz_large);</span>
<span class="nc" id="L766">        String avatarUrl = &quot;&quot;;</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">        if (mComment.getAuthorProfileImageUrl() != null) {</span>
<span class="nc" id="L768">            avatarUrl = GravatarUtils.fixGravatarUrl(mComment.getAuthorProfileImageUrl(), avatarSz);</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">        } else if (mComment.getAuthorEmail() != null) {</span>
<span class="nc" id="L770">            avatarUrl = GravatarUtils.gravatarFromEmail(mComment.getAuthorEmail(), avatarSz);</span>
        }
<span class="nc" id="L772">        mImageManager.loadIntoCircle(imgAvatar, ImageType.AVATAR_WITH_BACKGROUND, avatarUrl);</span>

<span class="nc" id="L774">        updateStatusViews();</span>

        // navigate to author's blog when avatar or name clicked
<span class="nc bnc" id="L777" title="All 2 branches missed.">        if (mComment.getAuthorUrl() != null) {</span>
<span class="nc" id="L778">            View.OnClickListener authorListener =</span>
<span class="nc" id="L779">                    v -&gt; ReaderActivityLauncher.openUrl(getActivity(), mComment.getAuthorUrl());</span>
<span class="nc" id="L780">            imgAvatar.setOnClickListener(authorListener);</span>
<span class="nc" id="L781">            txtName.setOnClickListener(authorListener);</span>
<span class="nc" id="L782">            txtName.setTextColor(ContextExtensionsKt.getColorFromAttribute(txtName.getContext(), R.attr.colorPrimary));</span>
<span class="nc" id="L783">        } else {</span>
<span class="nc" id="L784">            txtName.setTextColor(</span>
<span class="nc" id="L785">                    ContextExtensionsKt.getColorFromAttribute(txtName.getContext(), R.attr.colorOnSurface));</span>
        }

<span class="nc" id="L788">        showPostTitle(mSite, mComment.getRemotePostId());</span>

        // make sure reply box is showing
<span class="nc bnc" id="L791" title="All 4 branches missed.">        if (mLayoutReply.getVisibility() != View.VISIBLE &amp;&amp; canReply()) {</span>
<span class="nc" id="L792">            AniUtils.animateBottomBar(mLayoutReply, true);</span>
<span class="nc bnc" id="L793" title="All 4 branches missed.">            if (mEditReply != null &amp;&amp; mShouldFocusReplyField) {</span>
<span class="nc" id="L794">                mEditReply.performClick();</span>
<span class="nc" id="L795">                disableShouldFocusReplyField();</span>
            }
        }

<span class="nc" id="L799">        getActivity().invalidateOptionsMenu();</span>
<span class="nc" id="L800">    }</span>

    /*
     * displays the passed post title for the current comment, updates stored title if one doesn't exist
     */
    private void setPostTitle(TextView txtTitle, String postTitle, boolean isHyperlink) {
<span class="nc bnc" id="L806" title="All 4 branches missed.">        if (txtTitle == null || !isAdded()) {</span>
<span class="nc" id="L807">            return;</span>
        }
<span class="nc bnc" id="L809" title="All 2 branches missed.">        if (TextUtils.isEmpty(postTitle)) {</span>
<span class="nc" id="L810">            txtTitle.setText(R.string.untitled);</span>
<span class="nc" id="L811">            return;</span>
        }

        // if comment doesn't have a post title, set it to the passed one and save to comment table
<span class="nc bnc" id="L815" title="All 4 branches missed.">        if (mComment != null &amp;&amp; mComment.getPostTitle() == null) {</span>
<span class="nc" id="L816">            mComment.setPostTitle(postTitle);</span>
<span class="nc" id="L817">            mCommentsStoreAdapter.dispatch(CommentActionBuilder.newUpdateCommentAction(mComment));</span>
        }

        // display &quot;on [Post Title]...&quot;
<span class="nc bnc" id="L821" title="All 2 branches missed.">        if (isHyperlink) {</span>
<span class="nc" id="L822">            String html = getString(R.string.on)</span>
<span class="nc" id="L823">                          + &quot; &lt;font color=&quot; + HtmlUtils.colorResToHtmlColor(getActivity(),</span>
<span class="nc" id="L824">                    ContextExtensionsKt.getColorResIdFromAttribute(getActivity(), R.attr.colorPrimary))</span>
                          + &quot;&gt;&quot;
<span class="nc" id="L826">                          + postTitle.trim()</span>
                          + &quot;&lt;/font&gt;&quot;;
<span class="nc" id="L828">            txtTitle.setText(Html.fromHtml(html));</span>
<span class="nc" id="L829">        } else {</span>
<span class="nc" id="L830">            String text = getString(R.string.on) + &quot; &quot; + postTitle.trim();</span>
<span class="nc" id="L831">            txtTitle.setText(text);</span>
        }
<span class="nc" id="L833">    }</span>

    /*
     * ensure the post associated with this comment is available to the reader and show its
     * title above the comment
     */
    private void showPostTitle(final SiteModel site, final long postId) {
<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L841">            return;</span>
        }

<span class="nc" id="L844">        final TextView txtPostTitle = getView().findViewById(R.id.text_post_title);</span>
<span class="nc" id="L845">        boolean postExists = ReaderPostTable.postExists(site.getSiteId(), postId);</span>

        // the post this comment is on can only be requested if this is a .com blog or a
        // jetpack-enabled self-hosted blog, and we have valid .com credentials
<span class="nc bnc" id="L849" title="All 4 branches missed.">        boolean canRequestPost = SiteUtils.isAccessedViaWPComRest(site) &amp;&amp; mAccountStore.hasAccessToken();</span>

        final String title;
        final boolean hasTitle;
<span class="nc bnc" id="L853" title="All 2 branches missed.">        if (mComment.getPostTitle() != null) {</span>
            // use comment's stored post title if available
<span class="nc" id="L855">            title = mComment.getPostTitle();</span>
<span class="nc" id="L856">            hasTitle = true;</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">        } else if (postExists) {</span>
            // use title from post if available
<span class="nc" id="L859">            title = ReaderPostTable.getPostTitle(site.getSiteId(), postId);</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">            hasTitle = !TextUtils.isEmpty(title);</span>
        } else {
<span class="nc" id="L862">            title = null;</span>
<span class="nc" id="L863">            hasTitle = false;</span>
        }
<span class="nc bnc" id="L865" title="All 2 branches missed.">        if (hasTitle) {</span>
<span class="nc" id="L866">            setPostTitle(txtPostTitle, title, canRequestPost);</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">        } else if (canRequestPost) {</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">            txtPostTitle.setText(postExists ? R.string.untitled : R.string.loading);</span>
        }

        // if this is a .com or jetpack blog, tapping the title shows the associated post
        // in the reader
<span class="nc bnc" id="L873" title="All 2 branches missed.">        if (canRequestPost) {</span>
            // first make sure this post is available to the reader, and once it's retrieved set
            // the title if it wasn't set above
<span class="nc bnc" id="L876" title="All 2 branches missed.">            if (!postExists) {</span>
<span class="nc" id="L877">                AppLog.d(T.COMMENTS, &quot;comment detail &gt; retrieving post&quot;);</span>
<span class="nc" id="L878">                ReaderPostActions</span>
<span class="nc" id="L879">                        .requestBlogPost(site.getSiteId(), postId, new ReaderActions.OnRequestListener&lt;String&gt;() {</span>
                            @Override
                            public void onSuccess(String blogUrl) {
<span class="nc bnc" id="L882" title="All 2 branches missed.">                                if (!isAdded()) {</span>
<span class="nc" id="L883">                                    return;</span>
                                }

                                // update title if it wasn't set above
<span class="nc bnc" id="L887" title="All 2 branches missed.">                                if (!hasTitle) {</span>
<span class="nc" id="L888">                                    String postTitle = ReaderPostTable.getPostTitle(site.getSiteId(), postId);</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">                                    if (!TextUtils.isEmpty(postTitle)) {</span>
<span class="nc" id="L890">                                        setPostTitle(txtPostTitle, postTitle, true);</span>
                                    } else {
<span class="nc" id="L892">                                        txtPostTitle.setText(R.string.untitled);</span>
                                    }
                                }
<span class="nc" id="L895">                            }</span>

                            @Override
                            public void onFailure(int statusCode) {
<span class="nc" id="L899">                            }</span>
                        });
            }

<span class="nc" id="L903">            txtPostTitle.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">                if (mOnPostClickListener != null) {</span>
<span class="nc" id="L905">                    mOnPostClickListener.onPostClicked(getNote(), site.getSiteId(),</span>
<span class="nc" id="L906">                            (int) mComment.getRemotePostId());</span>
                } else {
                    // right now this will happen from notifications
<span class="nc" id="L909">                    AppLog.i(T.COMMENTS, &quot;comment detail &gt; no post click listener&quot;);</span>
<span class="nc" id="L910">                    ReaderActivityLauncher.showReaderPostDetail(getActivity(), site.getSiteId(),</span>
<span class="nc" id="L911">                            mComment.getRemotePostId());</span>
                }
<span class="nc" id="L913">            });</span>
        }
<span class="nc" id="L915">    }</span>

    // TODO klymyam remove legacy comment tracking after new comments are shipped and new funnels are made
    private void trackModerationEvent(final CommentStatus newStatus) {
<span class="nc bnc" id="L919" title="All 8 branches missed.">        switch (newStatus) {</span>
            case APPROVED:
<span class="nc bnc" id="L921" title="All 2 branches missed.">                if (mCommentSource == CommentSource.NOTIFICATION) {</span>
<span class="nc" id="L922">                    AnalyticsTracker.track(Stat.NOTIFICATION_APPROVED);</span>
                }
<span class="nc" id="L924">                AnalyticsUtils.trackCommentActionWithSiteDetails(Stat.COMMENT_APPROVED,</span>
<span class="nc" id="L925">                        mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>
<span class="nc" id="L926">                break;</span>
            case UNAPPROVED:
<span class="nc bnc" id="L928" title="All 2 branches missed.">                if (mCommentSource == CommentSource.NOTIFICATION) {</span>
<span class="nc" id="L929">                    AnalyticsTracker.track(Stat.NOTIFICATION_UNAPPROVED);</span>
                }
<span class="nc" id="L931">                AnalyticsUtils.trackCommentActionWithSiteDetails(Stat.COMMENT_UNAPPROVED,</span>
<span class="nc" id="L932">                        mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>
<span class="nc" id="L933">                break;</span>
            case SPAM:
<span class="nc bnc" id="L935" title="All 2 branches missed.">                if (mCommentSource == CommentSource.NOTIFICATION) {</span>
<span class="nc" id="L936">                    AnalyticsTracker.track(Stat.NOTIFICATION_FLAGGED_AS_SPAM);</span>
                }
<span class="nc" id="L938">                AnalyticsUtils.trackCommentActionWithSiteDetails(Stat.COMMENT_SPAMMED,</span>
<span class="nc" id="L939">                        mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>
<span class="nc" id="L940">                break;</span>
            case UNSPAM:
<span class="nc" id="L942">                AnalyticsUtils.trackCommentActionWithSiteDetails(Stat.COMMENT_UNSPAMMED,</span>
<span class="nc" id="L943">                        mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>
<span class="nc" id="L944">                break;</span>
            case TRASH:
<span class="nc bnc" id="L946" title="All 2 branches missed.">                if (mCommentSource == CommentSource.NOTIFICATION) {</span>
<span class="nc" id="L947">                    AnalyticsTracker.track(Stat.NOTIFICATION_TRASHED);</span>
                }
<span class="nc" id="L949">                AnalyticsUtils.trackCommentActionWithSiteDetails(Stat.COMMENT_TRASHED,</span>
<span class="nc" id="L950">                        mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>
<span class="nc" id="L951">                break;</span>
            case UNTRASH:
<span class="nc" id="L953">                AnalyticsUtils.trackCommentActionWithSiteDetails(Stat.COMMENT_UNTRASHED,</span>
<span class="nc" id="L954">                        mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>
<span class="nc" id="L955">                break;</span>
            case DELETED:
<span class="nc" id="L957">                AnalyticsUtils.trackCommentActionWithSiteDetails(Stat.COMMENT_DELETED,</span>
<span class="nc" id="L958">                        mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>
<span class="nc" id="L959">                break;</span>
            case ALL:
                break;
        }
<span class="nc" id="L963">    }</span>

    /*
     * approve, disapprove, spam, or trash the current comment
     */
    private void moderateComment(CommentStatus newStatus) {
<span class="nc bnc" id="L969" title="All 4 branches missed.">        if (!isAdded() || mComment == null) {</span>
<span class="nc" id="L970">            return;</span>
        }
<span class="nc bnc" id="L972" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(getActivity())) {</span>
<span class="nc" id="L973">            return;</span>
        }

<span class="nc" id="L976">        mPreviousStatus = mComment.getStatus();</span>

        // Restoring comment from trash or spam works by approving it, but we want to track the actual action
        // instead of generic Approve action
        CommentStatus statusToTrack;
<span class="nc bnc" id="L981" title="All 4 branches missed.">        if (CommentStatus.fromString(mPreviousStatus) == CommentStatus.SPAM &amp;&amp; newStatus == CommentStatus.APPROVED) {</span>
<span class="nc" id="L982">            statusToTrack = CommentStatus.UNSPAM;</span>
<span class="nc bnc" id="L983" title="All 4 branches missed.">        } else if (CommentStatus.fromString(mPreviousStatus) == CommentStatus.TRASH</span>
                   &amp;&amp; newStatus == CommentStatus.APPROVED) {
<span class="nc" id="L985">            statusToTrack = CommentStatus.UNTRASH;</span>
        } else {
<span class="nc" id="L987">            statusToTrack = newStatus;</span>
        }

<span class="nc" id="L990">        trackModerationEvent(statusToTrack);</span>

        // Fire the appropriate listener if we have one
<span class="nc bnc" id="L993" title="All 4 branches missed.">        if (mNote != null &amp;&amp; mOnNoteCommentActionListener != null) {</span>
<span class="nc" id="L994">            mOnNoteCommentActionListener.onModerateCommentForNote(mNote, newStatus);</span>
<span class="nc" id="L995">            dispatchModerationAction(newStatus);</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">        } else if (mOnCommentActionListener != null) {</span>
<span class="nc" id="L997">            mOnCommentActionListener.onModerateComment(mSite, mComment, newStatus);</span>
            // Sad, but onModerateComment does the moderation itself (due to the undo bar), this should be refactored,
            // That's why we don't call dispatchModerationAction() here.
        }

<span class="nc" id="L1002">        updateStatusViews();</span>
<span class="nc" id="L1003">    }</span>

    private void dispatchModerationAction(CommentStatus newStatus) {
<span class="nc bnc" id="L1006" title="All 2 branches missed.">        if (newStatus == CommentStatus.DELETED) {</span>
            // For deletion, we need to dispatch a specific action.
<span class="nc" id="L1008">            mCommentsStoreAdapter</span>
<span class="nc" id="L1009">                    .dispatch(CommentActionBuilder.newDeleteCommentAction(new RemoteCommentPayload(mSite, mComment)));</span>
        } else {
            // Actual moderation (push the modified comment).
<span class="nc" id="L1012">            mComment.setStatus(newStatus.toString());</span>
<span class="nc" id="L1013">            mCommentsStoreAdapter</span>
<span class="nc" id="L1014">                    .dispatch(CommentActionBuilder.newPushCommentAction(new RemoteCommentPayload(mSite, mComment)));</span>
        }
<span class="nc" id="L1016">    }</span>

    /*
     * post comment box text as a reply to the current comment
     */
    private void submitReply() {
<span class="nc bnc" id="L1022" title="All 6 branches missed.">        if (mComment == null || !isAdded() || mIsSubmittingReply) {</span>
<span class="nc" id="L1023">            return;</span>
        }

<span class="nc bnc" id="L1026" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(getActivity())) {</span>
<span class="nc" id="L1027">            return;</span>
        }

<span class="nc" id="L1030">        final String replyText = EditTextUtils.getText(mEditReply);</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">        if (TextUtils.isEmpty(replyText)) {</span>
<span class="nc" id="L1032">            return;</span>
        }

        // disable editor, hide soft keyboard, hide submit icon, and show progress spinner while submitting
<span class="nc" id="L1036">        mEditReply.setEnabled(false);</span>
<span class="nc" id="L1037">        EditTextUtils.hideSoftInput(mEditReply);</span>
<span class="nc" id="L1038">        mSubmitReplyBtn.setVisibility(View.GONE);</span>
<span class="nc" id="L1039">        final ProgressBar progress = getView().findViewById(R.id.progress_submit_comment);</span>
<span class="nc" id="L1040">        progress.setVisibility(View.VISIBLE);</span>

<span class="nc" id="L1042">        mIsSubmittingReply = true;</span>

<span class="nc" id="L1044">        AnalyticsUtils.trackCommentReplyWithDetails(</span>
<span class="nc" id="L1045">                false, mSite, mComment, mCommentSource.toAnalyticsCommentActionSource());</span>

        // Pseudo comment reply
<span class="nc" id="L1048">        CommentModel reply = new CommentModel();</span>
<span class="nc" id="L1049">        reply.setContent(replyText);</span>

<span class="nc" id="L1051">        mCommentsStoreAdapter</span>
<span class="nc" id="L1052">                .dispatch(CommentActionBuilder.newCreateNewCommentAction(new RemoteCreateCommentPayload(mSite,</span>
                        mComment,
                        reply)));
<span class="nc" id="L1055">    }</span>

    /*
     * update the text, drawable &amp; click listener for mBtnModerate based on
     * the current status of the comment, show mBtnSpam if the comment isn't
     * already marked as spam, and show the current status of the comment
     */
    private void updateStatusViews() {
<span class="nc bnc" id="L1063" title="All 4 branches missed.">        if (!isAdded() || mComment == null) {</span>
<span class="nc" id="L1064">            return;</span>
        }

        final int statusTextResId; // string resource id for status text
        final int statusColor; // color for status text

<span class="nc" id="L1070">        CommentStatus commentStatus = CommentStatus.fromString(mComment.getStatus());</span>
<span class="nc bnc" id="L1071" title="All 4 branches missed.">        switch (commentStatus) {</span>
            case APPROVED:
<span class="nc" id="L1073">                statusTextResId = R.string.comment_status_approved;</span>
<span class="nc" id="L1074">                statusColor = ContextExtensionsKt.getColorFromAttribute(getActivity(), R.attr.wpColorWarningDark);</span>
<span class="nc" id="L1075">                break;</span>
            case UNAPPROVED:
<span class="nc" id="L1077">                statusTextResId = R.string.comment_status_unapproved;</span>
<span class="nc" id="L1078">                statusColor = ContextExtensionsKt.getColorFromAttribute(getActivity(), R.attr.wpColorWarningDark);</span>
<span class="nc" id="L1079">                break;</span>
            case SPAM:
<span class="nc" id="L1081">                statusTextResId = R.string.comment_status_spam;</span>
<span class="nc" id="L1082">                statusColor = ContextExtensionsKt.getColorFromAttribute(getActivity(), R.attr.colorError);</span>
<span class="nc" id="L1083">                break;</span>
            case TRASH:
            default:
<span class="nc" id="L1086">                statusTextResId = R.string.comment_status_trash;</span>
<span class="nc" id="L1087">                statusColor = ContextExtensionsKt.getColorFromAttribute(getActivity(), R.attr.colorError);</span>
                break;
        }

<span class="nc bnc" id="L1091" title="All 2 branches missed.">        if (canLike()) {</span>
<span class="nc" id="L1092">            mBtnLikeComment.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">            if (mComment != null) {</span>
<span class="nc" id="L1094">                toggleLikeButton(mComment.getILike());</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">            } else if (mNote != null) {</span>
<span class="nc" id="L1096">                mNote.hasLikedComment();</span>
            }
        }

        // comment status is only shown if this comment is from one of this user's blogs and the
        // comment hasn't been CommentStatus.APPROVED
<span class="nc bnc" id="L1102" title="All 4 branches missed.">        if (mIsUsersBlog &amp;&amp; commentStatus != CommentStatus.APPROVED) {</span>
<span class="nc" id="L1103">            mTxtStatus.setText(getString(statusTextResId).toUpperCase(Locale.getDefault()));</span>
<span class="nc" id="L1104">            mTxtStatus.setTextColor(statusColor);</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">            if (mTxtStatus.getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L1106">                mTxtStatus.clearAnimation();</span>
<span class="nc" id="L1107">                AniUtils.fadeIn(mTxtStatus, AniUtils.Duration.LONG);</span>
            }
        } else {
<span class="nc" id="L1110">            mTxtStatus.setVisibility(View.GONE);</span>
        }

<span class="nc bnc" id="L1113" title="All 2 branches missed.">        if (canModerate()) {</span>
<span class="nc" id="L1114">            setModerateButtonForStatus(commentStatus);</span>
<span class="nc" id="L1115">            mBtnModerateComment.setOnClickListener(v -&gt; performModerateAction());</span>
<span class="nc" id="L1116">            mBtnModerateComment.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L1118">            mBtnModerateComment.setVisibility(View.GONE);</span>
        }

<span class="nc bnc" id="L1121" title="All 2 branches missed.">        if (canMarkAsSpam()) {</span>
<span class="nc" id="L1122">            mBtnSpamComment.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">            if (commentStatus == CommentStatus.SPAM) {</span>
<span class="nc" id="L1124">                mBtnSpamCommentText.setText(R.string.mnu_comment_unspam);</span>
            } else {
<span class="nc" id="L1126">                mBtnSpamCommentText.setText(R.string.mnu_comment_spam);</span>
            }
        } else {
<span class="nc" id="L1129">            mBtnSpamComment.setVisibility(View.GONE);</span>
        }

<span class="nc bnc" id="L1132" title="All 2 branches missed.">        if (canTrash()) {</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">            if (commentStatus == CommentStatus.TRASH) {</span>
<span class="nc" id="L1134">                ColorUtils.INSTANCE.setImageResourceWithTint(mBtnModerateIcon, R.drawable.ic_undo_white_24dp,</span>
                        ContextExtensionsKt
<span class="nc" id="L1136">                                .getColorResIdFromAttribute(mBtnModerateTextView.getContext(), R.attr.colorOnSurface));</span>
<span class="nc" id="L1137">                mBtnModerateTextView.setText(R.string.mnu_comment_untrash);</span>
            }
        }

<span class="nc bnc" id="L1141" title="All 2 branches missed.">        if (canShowMore()) {</span>
<span class="nc" id="L1142">            mBtnMoreComment.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L1144">            mBtnMoreComment.setVisibility(View.GONE);</span>
        }

<span class="nc" id="L1147">        mLayoutButtons.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1148">    }</span>

    private void performModerateAction() {
<span class="nc bnc" id="L1151" title="All 6 branches missed.">        if (mComment == null || !isAdded() || !NetworkUtils.checkConnection(getActivity())) {</span>
<span class="nc" id="L1152">            return;</span>
        }

<span class="nc" id="L1155">        CommentStatus newStatus = CommentStatus.APPROVED;</span>
<span class="nc" id="L1156">        CommentStatus currentStatus = CommentStatus.fromString(mComment.getStatus());</span>
<span class="nc bnc" id="L1157" title="All 2 branches missed.">        if (currentStatus == CommentStatus.APPROVED) {</span>
<span class="nc" id="L1158">            newStatus = CommentStatus.UNAPPROVED;</span>
        }
<span class="nc" id="L1160">        announceCommentStatusChangeForAccessibility(</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">                currentStatus == CommentStatus.TRASH ? CommentStatus.UNTRASH : newStatus);</span>

<span class="nc" id="L1163">        setModerateButtonForStatus(newStatus);</span>
<span class="nc" id="L1164">        AniUtils.startAnimation(mBtnModerateIcon, R.anim.notifications_button_scale);</span>
<span class="nc" id="L1165">        moderateComment(newStatus);</span>
<span class="nc" id="L1166">    }</span>

    private void setModerateButtonForStatus(CommentStatus status) {
        int color;

<span class="nc bnc" id="L1171" title="All 2 branches missed.">        if (status == CommentStatus.APPROVED) {</span>
<span class="nc" id="L1172">            color = ContextExtensionsKt</span>
<span class="nc" id="L1173">                    .getColorResIdFromAttribute(mBtnModerateTextView.getContext(), R.attr.colorSecondary);</span>
<span class="nc" id="L1174">            mBtnModerateTextView.setText(R.string.comment_status_approved);</span>
<span class="nc" id="L1175">            mBtnModerateTextView.setAlpha(mNormalOpacity);</span>
<span class="nc" id="L1176">            mBtnModerateIcon.setAlpha(mNormalOpacity);</span>
        } else {
<span class="nc" id="L1178">            color = ContextExtensionsKt</span>
<span class="nc" id="L1179">                    .getColorResIdFromAttribute(mBtnModerateTextView.getContext(), R.attr.colorOnSurface);</span>
<span class="nc" id="L1180">            mBtnModerateTextView.setText(R.string.mnu_comment_approve);</span>
<span class="nc" id="L1181">            mBtnModerateTextView.setAlpha(mMediumOpacity);</span>
<span class="nc" id="L1182">            mBtnModerateIcon.setAlpha(mMediumOpacity);</span>
        }

<span class="nc" id="L1185">        ColorUtils.INSTANCE.setImageResourceWithTint(mBtnModerateIcon, R.drawable.ic_checkmark_white_24dp, color);</span>
<span class="nc" id="L1186">        mBtnModerateTextView.setTextColor(ContextCompat.getColor(requireContext(), color));</span>
<span class="nc" id="L1187">    }</span>

    /*
     * does user have permission to moderate/reply/spam this comment?
     */
    private boolean canModerate() {
<span class="nc bnc" id="L1193" title="All 4 branches missed.">        return mEnabledActions != null &amp;&amp; (mEnabledActions.contains(EnabledActions.ACTION_APPROVE)</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">                                           || mEnabledActions.contains(EnabledActions.ACTION_UNAPPROVE));</span>
    }

    private boolean canMarkAsSpam() {
<span class="nc bnc" id="L1198" title="All 4 branches missed.">        return (mEnabledActions != null &amp;&amp; mEnabledActions.contains(EnabledActions.ACTION_SPAM));</span>
    }

    private boolean canReply() {
<span class="nc bnc" id="L1202" title="All 4 branches missed.">        return (mEnabledActions != null &amp;&amp; mEnabledActions.contains(EnabledActions.ACTION_REPLY));</span>
    }

    private boolean canTrash() {
<span class="nc" id="L1206">        return canModerate();</span>
    }

    private boolean canEdit() {
<span class="nc bnc" id="L1210" title="All 6 branches missed.">        return mSite != null &amp;&amp; (mSite.getHasCapabilityEditOthersPosts() || mSite.isSelfHostedAdmin());</span>
    }

    private boolean canLike() {
<span class="nc bnc" id="L1214" title="All 6 branches missed.">        return (mEnabledActions != null &amp;&amp; mEnabledActions.contains(EnabledActions.ACTION_LIKE)</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">                &amp;&amp; mSite != null &amp;&amp; SiteUtils.isAccessedViaWPComRest(mSite));</span>
    }

    /*
     * The more button contains controls which only moderates can use
     */
    private boolean canShowMore() {
<span class="nc" id="L1222">        return canModerate();</span>
    }

    /*
     * display the comment associated with the passed notification
     */
    private void showCommentAsNotification(Note note, @NonNull SiteModel site, @Nullable CommentModel comment) {
<span class="nc bnc" id="L1229" title="All 2 branches missed.">        if (getView() == null) {</span>
<span class="nc" id="L1230">            return;</span>
        }
<span class="nc" id="L1232">        View view = getView();</span>

        // hide standard comment views, since we'll be adding note blocks instead
<span class="nc" id="L1235">        View commentContent = view.findViewById(R.id.comment_content);</span>
<span class="nc bnc" id="L1236" title="All 2 branches missed.">        if (commentContent != null) {</span>
<span class="nc" id="L1237">            commentContent.setVisibility(View.GONE);</span>
        }

<span class="nc" id="L1240">        View commentText = view.findViewById(R.id.text_content);</span>
<span class="nc bnc" id="L1241" title="All 2 branches missed.">        if (commentText != null) {</span>
<span class="nc" id="L1242">            commentText.setVisibility(View.GONE);</span>
        }

        /*
         * determine which actions to enable for this comment - if the comment is from this user's
         * blog then all actions will be enabled, but they won't be if it's a reply to a comment
         * this user made on someone else's blog
         */
<span class="nc" id="L1250">        mEnabledActions = note.getEnabledActions();</span>

        // Set 'Reply to (Name)' in comment reply EditText if it's a reasonable size
<span class="nc bnc" id="L1253" title="All 4 branches missed.">        if (!TextUtils.isEmpty(mNote.getCommentAuthorName()) &amp;&amp; mNote.getCommentAuthorName().length() &lt; 28) {</span>
<span class="nc" id="L1254">            mEditReply.setHint(String.format(getString(R.string.comment_reply_to_user), mNote.getCommentAuthorName()));</span>
        }

<span class="nc bnc" id="L1257" title="All 2 branches missed.">        if (comment != null) {</span>
<span class="nc" id="L1258">            setComment(comment, site);</span>
        } else {
<span class="nc" id="L1260">            setComment(note.buildComment(), site);</span>
        }

<span class="nc" id="L1263">        addDetailFragment(note.getId());</span>

<span class="nc" id="L1265">        getActivity().invalidateOptionsMenu();</span>
<span class="nc" id="L1266">    }</span>

    private void addDetailFragment(String noteId) {
        // Now we'll add a detail fragment list
<span class="nc" id="L1270">        FragmentManager fragmentManager = getChildFragmentManager();</span>
<span class="nc" id="L1271">        FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();</span>
<span class="nc" id="L1272">        mNotificationsDetailListFragment = NotificationsDetailListFragment.newInstance(noteId);</span>
<span class="nc" id="L1273">        mNotificationsDetailListFragment.setFooterView(mLayoutButtons);</span>
<span class="nc" id="L1274">        fragmentTransaction.replace(mCommentContentLayout.getId(), mNotificationsDetailListFragment);</span>
<span class="nc" id="L1275">        fragmentTransaction.commitAllowingStateLoss();</span>
<span class="nc" id="L1276">    }</span>

    // Like or unlike a comment via the REST API
    private void likeComment(boolean forceLike) {
<span class="nc bnc" id="L1280" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1281">            return;</span>
        }
<span class="nc bnc" id="L1283" title="All 4 branches missed.">        if (forceLike &amp;&amp; mBtnLikeComment.isActivated()) {</span>
<span class="nc" id="L1284">            return;</span>
        }

<span class="nc bnc" id="L1287" title="All 2 branches missed.">        toggleLikeButton(!mBtnLikeComment.isActivated());</span>

<span class="nc" id="L1289">        ReaderAnim.animateLikeButton(mBtnLikeIcon, mBtnLikeComment.isActivated());</span>

        // Bump analytics
        // TODO klymyam remove legacy comment tracking after new comments are shipped and new funnels are made
<span class="nc bnc" id="L1293" title="All 2 branches missed.">        if (mCommentSource == CommentSource.NOTIFICATION) {</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">            AnalyticsTracker.track(mBtnLikeComment.isActivated() ? Stat.NOTIFICATION_LIKED : Stat.NOTIFICATION_UNLIKED);</span>
        }
<span class="nc" id="L1296">        AnalyticsUtils.trackCommentActionWithSiteDetails(</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">                mBtnLikeComment.isActivated() ? Stat.COMMENT_LIKED : Stat.COMMENT_UNLIKED,</span>
<span class="nc" id="L1298">                mCommentSource.toAnalyticsCommentActionSource(), mSite);</span>

<span class="nc bnc" id="L1300" title="All 4 branches missed.">        if (mNotificationsDetailListFragment != null &amp;&amp; mComment != null) {</span>
            // Optimistically set comment to approved when liking an unapproved comment
            // WP.com will set a comment to approved if it is liked while unapproved
<span class="nc bnc" id="L1303" title="All 2 branches missed.">            if (mBtnLikeComment.isActivated()</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">                &amp;&amp; CommentStatus.fromString(mComment.getStatus()) == CommentStatus.UNAPPROVED) {</span>
<span class="nc" id="L1305">                mComment.setStatus(CommentStatus.APPROVED.toString());</span>
<span class="nc" id="L1306">                mNotificationsDetailListFragment.refreshBlocksForCommentStatus(CommentStatus.APPROVED);</span>
<span class="nc" id="L1307">                setModerateButtonForStatus(CommentStatus.APPROVED);</span>
            }
        }
<span class="nc" id="L1310">        mCommentsStoreAdapter.dispatch(CommentActionBuilder.newLikeCommentAction(</span>
<span class="nc" id="L1311">                new RemoteLikeCommentPayload(mSite, mComment, mBtnLikeComment.isActivated())));</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">        mBtnLikeComment.announceForAccessibility(getText(mBtnLikeComment.isActivated() ? R.string.comment_liked_talkback</span>
<span class="nc" id="L1313">                : R.string.comment_unliked_talkback));</span>
<span class="nc" id="L1314">    }</span>

    private void toggleLikeButton(boolean isLiked) {
        int color;
        int drawable;

<span class="nc bnc" id="L1320" title="All 2 branches missed.">        if (isLiked) {</span>
<span class="nc" id="L1321">            color = ContextExtensionsKt.getColorResIdFromAttribute(mBtnLikeIcon.getContext(), R.attr.colorSecondary);</span>
<span class="nc" id="L1322">            drawable = R.drawable.ic_star_white_24dp;</span>
<span class="nc" id="L1323">            mBtnLikeTextView.setText(getResources().getString(R.string.mnu_comment_liked));</span>
<span class="nc" id="L1324">            mBtnLikeComment.setActivated(true);</span>
<span class="nc" id="L1325">            mBtnLikeTextView.setAlpha(mNormalOpacity);</span>
<span class="nc" id="L1326">            mBtnLikeIcon.setAlpha(mNormalOpacity);</span>
        } else {
<span class="nc" id="L1328">            color = ContextExtensionsKt.getColorResIdFromAttribute(mBtnLikeIcon.getContext(), R.attr.colorOnSurface);</span>
<span class="nc" id="L1329">            drawable = R.drawable.ic_star_outline_white_24dp;</span>
<span class="nc" id="L1330">            mBtnLikeTextView.setText(getResources().getString(R.string.reader_label_like));</span>
<span class="nc" id="L1331">            mBtnLikeComment.setActivated(false);</span>
<span class="nc" id="L1332">            mBtnLikeTextView.setAlpha(mMediumOpacity);</span>
<span class="nc" id="L1333">            mBtnLikeIcon.setAlpha(mMediumOpacity);</span>
        }

<span class="nc" id="L1336">        ColorUtils.INSTANCE.setImageResourceWithTint(mBtnLikeIcon, drawable, color);</span>
<span class="nc" id="L1337">        mBtnLikeTextView.setTextColor(ContextCompat.getColor(requireContext(), color));</span>
<span class="nc" id="L1338">    }</span>

    private void setProgressVisible(boolean visible) {
<span class="nc bnc" id="L1341" title="All 4 branches missed.">        final ProgressBar progress = (isAdded() &amp;&amp; getView() != null</span>
<span class="nc" id="L1342">                ? (ProgressBar) getView().findViewById(R.id.progress_loading) : null);</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">        if (progress != null) {</span>
<span class="nc bnc" id="L1344" title="All 2 branches missed.">            progress.setVisibility(visible ? View.VISIBLE : View.GONE);</span>
        }
<span class="nc" id="L1346">    }</span>

    private void onCommentModerated(OnCommentChanged event) {
        // send signal for listeners to perform any needed updates
<span class="nc bnc" id="L1350" title="All 2 branches missed.">        if (mNote != null) {</span>
<span class="nc" id="L1351">            EventBus.getDefault().postSticky(new NotificationEvents.NoteLikeOrModerationStatusChanged(mNote.getId()));</span>
        }

<span class="nc bnc" id="L1354" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L1355">            return;</span>
        }

<span class="nc bnc" id="L1358" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1359">            mComment.setStatus(mPreviousStatus);</span>
<span class="nc" id="L1360">            updateStatusViews();</span>
<span class="nc" id="L1361">            ToastUtils.showToast(getActivity(), R.string.error_moderate_comment);</span>
        } else {
<span class="nc" id="L1363">            reloadComment();</span>
        }
<span class="nc" id="L1365">    }</span>

    private void onCommentCreated(OnCommentChanged event) {
<span class="nc" id="L1368">        mIsSubmittingReply = false;</span>
<span class="nc" id="L1369">        mEditReply.setEnabled(true);</span>
<span class="nc" id="L1370">        mSubmitReplyBtn.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1371">        getView().findViewById(R.id.progress_submit_comment).setVisibility(View.GONE);</span>
<span class="nc" id="L1372">        updateStatusViews();</span>

<span class="nc bnc" id="L1374" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">            if (isAdded()) {</span>
<span class="nc" id="L1376">                String strUnEscapeHTML = StringEscapeUtils.unescapeHtml4(event.error.message);</span>
<span class="nc" id="L1377">                ToastUtils.showToast(getActivity(), strUnEscapeHTML, ToastUtils.Duration.LONG);</span>
                // refocus editor on failure and show soft keyboard
<span class="nc" id="L1379">                EditTextUtils.showSoftInput(mEditReply);</span>
            }
<span class="nc" id="L1381">            return;</span>
        }

<span class="nc" id="L1384">        reloadComment();</span>

<span class="nc bnc" id="L1386" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L1387">            ToastUtils.showToast(getActivity(), getString(R.string.note_reply_successful));</span>
<span class="nc" id="L1388">            mEditReply.setText(null);</span>
<span class="nc" id="L1389">            mEditReply.getAutoSaveTextHelper().clearSavedText(mEditReply);</span>
        }

        // Self Hosted site does not return a newly created comment, so we need to fetch it manually.
<span class="nc bnc" id="L1393" title="All 4 branches missed.">        if (!mSite.isUsingWpComRestApi() &amp;&amp; !event.changedCommentsLocalIds.isEmpty()) {</span>
<span class="nc" id="L1394">            CommentModel createdComment =</span>
<span class="nc" id="L1395">                    mCommentsStoreAdapter.getCommentByLocalId(event.changedCommentsLocalIds.get(0));</span>

<span class="nc bnc" id="L1397" title="All 2 branches missed.">            if (createdComment != null) {</span>
<span class="nc" id="L1398">                mCommentsStoreAdapter.dispatch(CommentActionBuilder.newFetchCommentAction(</span>
<span class="nc" id="L1399">                        new RemoteCommentPayload(mSite, createdComment.getRemoteCommentId())));</span>
            }
        }

        // approve the comment
<span class="nc bnc" id="L1404" title="All 4 branches missed.">        if (mComment != null &amp;&amp; !(CommentStatus.fromString(mComment.getStatus()) == CommentStatus.APPROVED)) {</span>
<span class="nc" id="L1405">            moderateComment(CommentStatus.APPROVED);</span>
        }
<span class="nc" id="L1407">    }</span>

    private void onCommentLiked(OnCommentChanged event) {
        // send signal for listeners to perform any needed updates
<span class="nc bnc" id="L1411" title="All 2 branches missed.">        if (mNote != null) {</span>
<span class="nc" id="L1412">            EventBus.getDefault().postSticky(new NotificationEvents.NoteLikeOrModerationStatusChanged(mNote.getId()));</span>
        }

<span class="nc bnc" id="L1415" title="All 2 branches missed.">        if (event.isError()) {</span>
            // Revert button state in case of an error
<span class="nc bnc" id="L1417" title="All 2 branches missed.">            toggleLikeButton(!mBtnLikeComment.isActivated());</span>
        }
<span class="nc" id="L1419">    }</span>

    // OnChanged events

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onCommentChanged(OnCommentChanged event) {
<span class="nc" id="L1426">        setProgressVisible(false);</span>
        // requesting local comment cache refresh
<span class="nc" id="L1428">        BuildersKt.launch(GlobalScope.INSTANCE,</span>
<span class="nc" id="L1429">                Dispatchers.getMain(),</span>
                CoroutineStart.DEFAULT,
<span class="nc" id="L1431">                (coroutineScope, continuation) -&gt; mLocalCommentCacheUpdateHandler.requestCommentsUpdate(continuation)</span>

        );
        // Moderating comment
<span class="nc bnc" id="L1435" title="All 2 branches missed.">        if (event.causeOfChange == CommentAction.PUSH_COMMENT) {</span>
<span class="nc" id="L1436">            onCommentModerated(event);</span>
<span class="nc" id="L1437">            mPreviousStatus = null;</span>
<span class="nc" id="L1438">            return;</span>
        }

        // New comment (reply)
<span class="nc bnc" id="L1442" title="All 2 branches missed.">        if (event.causeOfChange == CommentAction.CREATE_NEW_COMMENT) {</span>
<span class="nc" id="L1443">            onCommentCreated(event);</span>
<span class="nc" id="L1444">            return;</span>
        }

        // Like/Unlike
<span class="nc bnc" id="L1448" title="All 2 branches missed.">        if (event.causeOfChange == CommentAction.LIKE_COMMENT) {</span>
<span class="nc" id="L1449">            onCommentLiked(event);</span>
<span class="nc" id="L1450">            return;</span>
        }

<span class="nc bnc" id="L1453" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1454">            AppLog.i(T.TESTS, &quot;event error type: &quot; + event.error.type + &quot; - message: &quot; + event.error.message);</span>
<span class="nc bnc" id="L1455" title="All 4 branches missed.">            if (isAdded() &amp;&amp; !TextUtils.isEmpty(event.error.message)) {</span>
<span class="nc" id="L1456">                ToastUtils.showToast(getActivity(), event.error.message);</span>
            }
<span class="nc" id="L1458">            return;</span>
        }
<span class="nc" id="L1460">    }</span>

    private void announceCommentStatusChangeForAccessibility(CommentStatus newStatus) {
<span class="nc" id="L1463">        int resId = -1;</span>
<span class="nc bnc" id="L1464" title="All 9 branches missed.">        switch (newStatus) {</span>
            case APPROVED:
<span class="nc" id="L1466">                resId = R.string.comment_approved_talkback;</span>
<span class="nc" id="L1467">                break;</span>
            case UNAPPROVED:
<span class="nc" id="L1469">                resId = R.string.comment_unapproved_talkback;</span>
<span class="nc" id="L1470">                break;</span>
            case SPAM:
<span class="nc" id="L1472">                resId = R.string.comment_spam_talkback;</span>
<span class="nc" id="L1473">                break;</span>
            case TRASH:
<span class="nc" id="L1475">                resId = R.string.comment_trash_talkback;</span>
<span class="nc" id="L1476">                break;</span>
            case DELETED:
<span class="nc" id="L1478">                resId = R.string.comment_delete_talkback;</span>
<span class="nc" id="L1479">                break;</span>
            case UNSPAM:
<span class="nc" id="L1481">                resId = R.string.comment_unspam_talkback;</span>
<span class="nc" id="L1482">                break;</span>
            case UNTRASH:
<span class="nc" id="L1484">                resId = R.string.comment_untrash_talkback;</span>
<span class="nc" id="L1485">                break;</span>
            case ALL:
                // ignore
<span class="nc" id="L1488">                break;</span>
            default:
<span class="nc" id="L1490">                AppLog.w(T.COMMENTS,</span>
                        &quot;AnnounceCommentStatusChangeForAccessibility - Missing switch branch for comment status: &quot;
                        + newStatus);
        }
<span class="nc bnc" id="L1494" title="All 4 branches missed.">        if (resId != -1 &amp;&amp; getView() != null) {</span>
<span class="nc" id="L1495">            getView().announceForAccessibility(getText(resId));</span>
        }
<span class="nc" id="L1497">    }</span>

    // Handle More Menu
    private void showMoreMenu(View view) {
<span class="nc" id="L1501">        androidx.appcompat.widget.PopupMenu morePopupMenu =</span>
<span class="nc" id="L1502">                new androidx.appcompat.widget.PopupMenu(requireContext(), view);</span>
<span class="nc" id="L1503">        morePopupMenu.setOnMenuItemClickListener(item -&gt; {</span>
<span class="nc bnc" id="L1504" title="All 2 branches missed.">            if (item.getItemId() == R.id.action_edit) {</span>
<span class="nc" id="L1505">                editComment();</span>
<span class="nc" id="L1506">                return true;</span>
            }
<span class="nc bnc" id="L1508" title="All 2 branches missed.">            if (item.getItemId() == R.id.action_trash) {</span>
<span class="nc" id="L1509">                trashComment();</span>
<span class="nc" id="L1510">                return true;</span>
            }
<span class="nc bnc" id="L1512" title="All 2 branches missed.">            if (item.getItemId() == R.id.action_copy_link_address) {</span>
<span class="nc" id="L1513">                copyCommentLinkAddress();</span>
<span class="nc" id="L1514">                return true;</span>
            }
<span class="nc" id="L1516">            return false;</span>
        });

<span class="nc" id="L1519">        morePopupMenu.inflate(R.menu.menu_comment_more);</span>

<span class="nc" id="L1521">        MenuItem trashMenuItem = morePopupMenu.getMenu().findItem(R.id.action_trash);</span>
<span class="nc" id="L1522">        MenuItem copyLinkAddress = morePopupMenu.getMenu().findItem(R.id.action_copy_link_address);</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">        if (canTrash()) {</span>
<span class="nc" id="L1524">            CommentStatus commentStatus = CommentStatus.fromString(mComment.getStatus());</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">            if (commentStatus == CommentStatus.TRASH) {</span>
<span class="nc" id="L1526">                copyLinkAddress.setVisible(false);</span>
<span class="nc" id="L1527">                trashMenuItem.setTitle(R.string.mnu_comment_delete_permanently);</span>
            } else {
<span class="nc" id="L1529">                trashMenuItem.setTitle(R.string.mnu_comment_trash);</span>
<span class="nc bnc" id="L1530" title="All 2 branches missed.">                if (commentStatus == CommentStatus.SPAM) {</span>
<span class="nc" id="L1531">                    copyLinkAddress.setVisible(false);</span>
                } else {
<span class="nc" id="L1533">                    copyLinkAddress.setVisible(true);</span>
                }
            }
<span class="nc" id="L1536">        } else {</span>
<span class="nc" id="L1537">            trashMenuItem.setVisible(false);</span>
<span class="nc" id="L1538">            copyLinkAddress.setVisible(false);</span>
        }

<span class="nc" id="L1541">        MenuItem editMenuItem = morePopupMenu.getMenu().findItem(R.id.action_edit);</span>
<span class="nc" id="L1542">        editMenuItem.setVisible(false);</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">        if (canEdit()) {</span>
<span class="nc" id="L1544">            editMenuItem.setVisible(true);</span>
        }
<span class="nc" id="L1546">        morePopupMenu.show();</span>
<span class="nc" id="L1547">    }</span>

    private void trashComment() {
<span class="nc bnc" id="L1550" title="All 4 branches missed.">        if (!isAdded() || mComment == null) {</span>
<span class="nc" id="L1551">            return;</span>
        }

<span class="nc" id="L1554">        CommentStatus status = CommentStatus.fromString(mComment.getStatus());</span>
        // If the comment status is trash or spam, next deletion is a permanent deletion.
<span class="nc bnc" id="L1556" title="All 4 branches missed.">        if (status == CommentStatus.TRASH || status == CommentStatus.SPAM) {</span>
<span class="nc" id="L1557">            AlertDialog.Builder dialogBuilder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L1558">            dialogBuilder.setTitle(getResources().getText(R.string.delete));</span>
<span class="nc" id="L1559">            dialogBuilder.setMessage(getResources().getText(R.string.dlg_sure_to_delete_comment));</span>
<span class="nc" id="L1560">            dialogBuilder.setPositiveButton(getResources().getText(R.string.yes),</span>
                    (dialog, whichButton) -&gt; {
<span class="nc" id="L1562">                        moderateComment(CommentStatus.DELETED);</span>
<span class="nc" id="L1563">                        announceCommentStatusChangeForAccessibility(CommentStatus.DELETED);</span>
<span class="nc" id="L1564">                    });</span>
<span class="nc" id="L1565">            dialogBuilder.setNegativeButton(</span>
<span class="nc" id="L1566">                    getResources().getText(R.string.no),</span>
                    null);
<span class="nc" id="L1568">            dialogBuilder.setCancelable(true);</span>
<span class="nc" id="L1569">            dialogBuilder.create().show();</span>
<span class="nc" id="L1570">        } else {</span>
<span class="nc" id="L1571">            moderateComment(CommentStatus.TRASH);</span>
<span class="nc" id="L1572">            announceCommentStatusChangeForAccessibility(CommentStatus.TRASH);</span>
        }
<span class="nc" id="L1574">    }</span>

    private void copyCommentLinkAddress() {
        try {
<span class="nc" id="L1578">            ClipboardManager clipboard = (ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);</span>
<span class="nc" id="L1579">            clipboard.setPrimaryClip(ClipData.newPlainText(&quot;CommentLinkAddress&quot;, mComment.getUrl()));</span>
<span class="nc" id="L1580">            showSnackBar(getString(R.string.comment_q_action_copied_url));</span>
<span class="nc" id="L1581">        } catch (Exception e) {</span>
<span class="nc" id="L1582">            AppLog.e(T.UTILS, e);</span>
<span class="nc" id="L1583">            showSnackBar(getString(R.string.error_copy_to_clipboard));</span>
<span class="nc" id="L1584">        }</span>
<span class="nc" id="L1585">    }</span>

    private void showSnackBar(String message) {
<span class="nc" id="L1588">        View view = getView();</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">        if (view != null) {</span>
<span class="nc" id="L1590">            Snackbar snackBar = WPSnackbar.make(view, message, Snackbar.LENGTH_LONG)</span>
<span class="nc" id="L1591">                                          .setAction(getString(R.string.share_action),</span>
                                                  v -&gt; {
                                                      try {
<span class="nc" id="L1594">                                                          Intent intent = new Intent(Intent.ACTION_SEND);</span>
<span class="nc" id="L1595">                                                          intent.setType(&quot;text/plain&quot;);</span>
<span class="nc" id="L1596">                                                          intent.putExtra(Intent.EXTRA_TEXT, mComment.getUrl());</span>
<span class="nc" id="L1597">                                                          startActivity(Intent.createChooser(intent,</span>
<span class="nc" id="L1598">                                                                  getString(R.string.comment_share_link_via)));</span>
<span class="nc" id="L1599">                                                      } catch (ActivityNotFoundException exception) {</span>
<span class="nc" id="L1600">                                                          ToastUtils.showToast(view.getContext(),</span>
                                                                  R.string.comment_toast_err_share_intent);
<span class="nc" id="L1602">                                                      }</span>
<span class="nc" id="L1603">                                                  })</span>
<span class="nc" id="L1604">                                          .setAnchorView(mSnackbarAnchor);</span>
<span class="nc" id="L1605">            snackBar.show();</span>
        }
<span class="nc" id="L1607">    }</span>

    @Override
    @Nullable public View getScrollableViewForUniqueIdProvision() {
<span class="nc" id="L1611">        return mNestedScrollView;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>