<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StoryEditorMedia.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stories.media</a> &gt; <span class="el_source">StoryEditorMedia.kt</span></div><h1>StoryEditorMedia.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stories.media

import android.net.Uri
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Job
import kotlinx.coroutines.launch
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.posts.ProgressDialogUiState
import org.wordpress.android.ui.posts.ProgressDialogUiState.HiddenProgressDialog
import org.wordpress.android.ui.posts.ProgressDialogUiState.VisibleProgressDialog
import org.wordpress.android.ui.posts.editor.media.AddExistingMediaSource
import org.wordpress.android.ui.posts.editor.media.AddExistingMediaToPostUseCase
import org.wordpress.android.ui.posts.editor.media.AddLocalMediaToPostUseCase
import org.wordpress.android.ui.posts.editor.media.EditorMediaListener
import org.wordpress.android.ui.stories.media.StoryEditorMedia.AddMediaToStoryPostUiState.AddingMediaToStoryIdle
import org.wordpress.android.ui.stories.media.StoryEditorMedia.AddMediaToStoryPostUiState.AddingMultipleMediaToStory
import org.wordpress.android.ui.stories.media.StoryEditorMedia.AddMediaToStoryPostUiState.AddingSingleMediaToStory
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.util.MediaUtilsWrapper
import org.wordpress.android.viewmodel.Event
import javax.inject.Inject
import javax.inject.Named
import kotlin.coroutines.CoroutineContext

<span class="nc" id="L31">class StoryEditorMedia @Inject constructor(</span>
<span class="nc" id="L32">    private val mediaUtilsWrapper: MediaUtilsWrapper,</span>
<span class="nc" id="L33">    private val addLocalMediaToPostUseCase: AddLocalMediaToPostUseCase,</span>
<span class="nc" id="L34">    private val addExistingMediaToPostUseCase: AddExistingMediaToPostUseCase,</span>
<span class="nc" id="L35">    @Named(UI_THREAD) private val mainDispatcher: CoroutineDispatcher</span>
) : CoroutineScope {
    // region Fields
<span class="nc" id="L38">    private var job: Job = Job()</span>

    override val coroutineContext: CoroutineContext
<span class="nc" id="L41">        get() = mainDispatcher + job</span>

    private lateinit var site: SiteModel
    private lateinit var editorMediaListener: EditorMediaListener

<span class="nc" id="L46">    private val _uiState: MutableLiveData&lt;AddMediaToStoryPostUiState&gt; = MutableLiveData()</span>
<span class="nc" id="L47">    val uiState: LiveData&lt;AddMediaToStoryPostUiState&gt; = _uiState</span>

<span class="nc" id="L49">    private val _snackBarMessage = MutableLiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt;()</span>
<span class="nc" id="L50">    val snackBarMessage = _snackBarMessage as LiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt;</span>

    fun start(site: SiteModel, editorMediaListener: EditorMediaListener) {
<span class="nc" id="L53">        this.site = site</span>
<span class="nc" id="L54">        this.editorMediaListener = editorMediaListener</span>
<span class="nc" id="L55">        _uiState.value = AddingMediaToStoryIdle</span>
<span class="nc" id="L56">    }</span>

    // region Adding new media to a post
    fun advertiseImageOptimisationAndAddMedia(uriList: List&lt;Uri&gt;) {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (mediaUtilsWrapper.shouldAdvertiseImageOptimization()) {</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            editorMediaListener.advertiseImageOptimization {</span>
<span class="nc" id="L62">                addNewMediaItemsToEditorAsync(</span>
<span class="nc" id="L63">                        uriList,</span>
<span class="nc" id="L64">                        false</span>
                )
<span class="nc" id="L66">            }</span>
        } else {
<span class="nc" id="L68">            addNewMediaItemsToEditorAsync(uriList, false)</span>
        }
<span class="nc" id="L70">    }</span>

    fun addNewMediaItemsToEditorAsync(uriList: List&lt;Uri&gt;, freshlyTaken: Boolean) {
<span class="nc" id="L73">        launch {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            _uiState.value = if (uriList.size &gt; 1) {</span>
<span class="nc" id="L75">                AddingMultipleMediaToStory</span>
            } else {
<span class="nc" id="L77">                AddingSingleMediaToStory</span>
            }
<span class="nc" id="L79">            val allMediaSucceed = addLocalMediaToPostUseCase.addNewMediaToEditorAsync(</span>
<span class="nc" id="L80">                    uriList,</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                    site,</span>
<span class="nc" id="L82">                    freshlyTaken,</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                    editorMediaListener,</span>
<span class="nc" id="L84">                    false // don't start upload for StoryComposer, that'll be all started</span>
                                            // when finished composing
            )
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (!allMediaSucceed) {</span>
<span class="nc" id="L88">                _snackBarMessage.value = Event(SnackbarMessageHolder(UiStringRes(R.string.gallery_error)))</span>
            }
<span class="nc" id="L90">            _uiState.value = AddingMediaToStoryIdle</span>
<span class="nc" id="L91">        }</span>
<span class="nc" id="L92">    }</span>

    fun onPhotoPickerMediaChosen(uriList: List&lt;Uri&gt;) {
<span class="nc bnc" id="L95" title="All 2 branches missed.">        val onlyVideos = uriList.all { mediaUtilsWrapper.isVideo(it.toString()) }</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (onlyVideos) {</span>
<span class="nc" id="L97">            addNewMediaItemsToEditorAsync(uriList, false)</span>
        } else {
<span class="nc" id="L99">            advertiseImageOptimisationAndAddMedia(uriList)</span>
        }
<span class="nc" id="L101">    }</span>
    // endregion

    fun addExistingMediaToEditorAsync(source: AddExistingMediaSource, mediaIdList: List&lt;Long&gt;) {
<span class="nc" id="L105">        launch {</span>
<span class="nc" id="L106">            addExistingMediaToPostUseCase.addMediaExistingInRemoteToEditorAsync(</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                    site,</span>
<span class="nc" id="L108">                    source,</span>
<span class="nc" id="L109">                    mediaIdList,</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                    editorMediaListener</span>
            )
<span class="nc" id="L112">        }</span>
<span class="nc" id="L113">    }</span>

    fun cancelAddMediaToEditorActions() {
<span class="nc" id="L116">        job.cancel()</span>
<span class="nc" id="L117">    }</span>

<span class="nc" id="L119">    sealed class AddMediaToStoryPostUiState(</span>
<span class="nc" id="L120">        val editorOverlayVisibility: Boolean,</span>
<span class="nc" id="L121">        val progressDialogUiState: ProgressDialogUiState</span>
    ) {
        /**
         * Adding multiple media items at once can take several seconds on slower devices, so we show a blocking
         * progress dialog in this situation - otherwise the user could accidentally back out of the process
         * before all items were added
         */
<span class="nc" id="L128">        object AddingMultipleMediaToStory : AddMediaToStoryPostUiState(</span>
<span class="nc" id="L129">                editorOverlayVisibility = true,</span>
<span class="nc" id="L130">                progressDialogUiState = VisibleProgressDialog(</span>
<span class="nc" id="L131">                        messageString = UiStringRes(R.string.add_media_progress),</span>
<span class="nc" id="L132">                        cancelable = false,</span>
<span class="nc" id="L133">                        indeterminate = true</span>
                )
        )

<span class="nc" id="L137">        object AddingSingleMediaToStory : AddMediaToStoryPostUiState(true, HiddenProgressDialog)</span>

<span class="nc" id="L139">        object AddingMediaToStoryIdle : AddMediaToStoryPostUiState(false, HiddenProgressDialog)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>