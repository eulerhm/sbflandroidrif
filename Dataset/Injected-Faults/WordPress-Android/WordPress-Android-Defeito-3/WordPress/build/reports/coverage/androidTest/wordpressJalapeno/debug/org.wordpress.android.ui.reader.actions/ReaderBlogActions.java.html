<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderBlogActions.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.actions</a> &gt; <span class="el_source">ReaderBlogActions.java</span></div><h1>ReaderBlogActions.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.actions;

import android.text.TextUtils;
import android.util.Pair;

import com.android.volley.Request;
import com.android.volley.Response;
import com.android.volley.VolleyError;
import com.android.volley.toolbox.StringRequest;
import com.wordpress.rest.RestRequest;

import org.json.JSONObject;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.datasets.ReaderBlogTable;
import org.wordpress.android.datasets.ReaderPostTable;
import org.wordpress.android.datasets.ReaderTagTable;
import org.wordpress.android.models.ReaderBlog;
import org.wordpress.android.models.ReaderPostList;
import org.wordpress.android.models.ReaderTag;
import org.wordpress.android.models.ReaderTagType;
import org.wordpress.android.ui.reader.actions.ReaderActions.ActionListener;
import org.wordpress.android.ui.reader.actions.ReaderActions.UpdateBlogInfoListener;
import org.wordpress.android.ui.reader.tracker.ReaderTracker;
import org.wordpress.android.ui.reader.utils.ReaderUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.UrlUtils;
import org.wordpress.android.util.VolleyUtils;

import java.net.HttpURLConnection;
import java.util.Map;

<span class="nc" id="L34">public class ReaderBlogActions {</span>
<span class="nc" id="L35">    public static class BlockedBlogResult {</span>
        public long blogId;
        public long feedId;
        // Key: Pair&lt;ReaderTagSlug, ReaderTagType&gt;, Value: ReaderPostList
        public Map&lt;Pair&lt;String, ReaderTagType&gt;, ReaderPostList&gt; deletedRows;
        public boolean wasFollowing;
    }

    private static String jsonToString(JSONObject json) {
<span class="nc bnc" id="L44" title="All 2 branches missed.">        return (json != null ? json.toString() : &quot;&quot;);</span>
    }

    public static boolean followBlogById(final long blogId,
                                         final long feedId,
                                         final boolean isAskingToFollow,
                                         final ActionListener actionListener,
                                         final String source,
                                         final ReaderTracker readerTracker) {
<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (blogId == 0) {</span>
<span class="nc" id="L54">            ReaderActions.callActionListener(actionListener, false);</span>
<span class="nc" id="L55">            return false;</span>
        }

<span class="nc" id="L58">        ReaderBlogTable.setIsFollowedBlogId(blogId, isAskingToFollow);</span>
<span class="nc" id="L59">        ReaderPostTable.setFollowStatusForPostsInBlog(blogId, isAskingToFollow);</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (isAskingToFollow) {</span>
<span class="nc" id="L62">            readerTracker.trackBlog(</span>
                    AnalyticsTracker.Stat.READER_BLOG_FOLLOWED,
                    blogId,
                    feedId,
                    source
            );
        } else {
<span class="nc" id="L69">            readerTracker.trackBlog(</span>
                    AnalyticsTracker.Stat.READER_BLOG_UNFOLLOWED,
                    blogId,
                    feedId,
                    source
            );
        }

<span class="nc bnc" id="L77" title="All 2 branches missed.">        final String actionName = (isAskingToFollow ? &quot;follow&quot; : &quot;unfollow&quot;);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        final String path = &quot;sites/&quot; + blogId + &quot;/follows/&quot; + (isAskingToFollow ? &quot;new?source=android&quot; : &quot;mine/delete&quot;);</span>

<span class="nc" id="L80">        com.wordpress.rest.RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L83">                boolean success = isFollowActionSuccessful(jsonObject, isAskingToFollow);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                if (success) {</span>
<span class="nc" id="L85">                    AppLog.d(T.READER, &quot;blog &quot; + actionName + &quot; succeeded&quot;);</span>
                } else {
<span class="nc" id="L87">                    AppLog.w(T.READER, &quot;blog &quot; + actionName + &quot; failed - &quot; + jsonToString(jsonObject) + &quot; - &quot; + path);</span>
<span class="nc" id="L88">                    localRevertFollowBlogId(blogId, isAskingToFollow);</span>
                }
<span class="nc" id="L90">                ReaderActions.callActionListener(actionListener, success);</span>
<span class="nc" id="L91">            }</span>
        };
<span class="nc" id="L93">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L96">                AppLog.w(T.READER, &quot;blog &quot; + actionName + &quot; failed with error&quot;);</span>
<span class="nc" id="L97">                AppLog.e(T.READER, volleyError);</span>
                // check if we get a 403 when unfollowing - this will happen when we attempt
                // to unfollow a blog that no longer exists - the workaround is to unfollow
                // by url - note that the v1.2 endpoint will return a 404 in this situation
<span class="nc" id="L101">                int status = VolleyUtils.statusCodeFromVolleyError(volleyError);</span>
<span class="nc bnc" id="L102" title="All 4 branches missed.">                if (status == 403 &amp;&amp; !isAskingToFollow) {</span>
<span class="nc" id="L103">                    internalUnfollowBlogByUrl(blogId, actionListener);</span>
                } else {
<span class="nc" id="L105">                    localRevertFollowBlogId(blogId, isAskingToFollow);</span>
<span class="nc" id="L106">                    ReaderActions.callActionListener(actionListener, false);</span>
                }
<span class="nc" id="L108">            }</span>
        };
<span class="nc" id="L110">        WordPress.getRestClientUtilsV1_1().post(path, listener, errorListener);</span>

<span class="nc" id="L112">        return true;</span>
    }

    private static void internalUnfollowBlogByUrl(long blogId,
                                                  final ActionListener actionListener) {
<span class="nc" id="L117">        String blogUrl = ReaderBlogTable.getBlogUrl(blogId);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (TextUtils.isEmpty(blogUrl)) {</span>
<span class="nc" id="L119">            AppLog.w(T.READER, &quot;URL not found for blogId &quot; + blogId);</span>
<span class="nc" id="L120">            ReaderActions.callActionListener(actionListener, false);</span>
<span class="nc" id="L121">            return;</span>
        }

<span class="nc" id="L124">        com.wordpress.rest.RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject response) {
<span class="nc" id="L127">                ReaderActions.callActionListener(actionListener, true);</span>
<span class="nc" id="L128">            }</span>
        };
<span class="nc" id="L130">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError error) {
<span class="nc" id="L133">                AppLog.e(T.READER, error);</span>
<span class="nc" id="L134">                ReaderActions.callActionListener(actionListener, false);</span>
<span class="nc" id="L135">            }</span>
        };

<span class="nc" id="L138">        String path = &quot;/read/following/mine/delete?url=&quot; + UrlUtils.urlEncode(blogUrl);</span>
<span class="nc" id="L139">        WordPress.getRestClientUtilsV1_1().post(path, listener, errorListener);</span>
<span class="nc" id="L140">    }</span>

    public static boolean followFeedById(@SuppressWarnings(&quot;unused&quot;) final long blogId,
                                         final long feedId,
                                         final boolean isAskingToFollow,
                                         final ActionListener actionListener,
                                         final String source,
                                         final ReaderTracker readerTracker) {
<span class="nc" id="L148">        ReaderBlog blogInfo = ReaderBlogTable.getFeedInfo(feedId);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (blogInfo != null) {</span>
<span class="nc" id="L150">            return internalFollowFeed(</span>
                    blogInfo.blogId,
                    blogInfo.feedId,
<span class="nc" id="L153">                    blogInfo.getFeedUrl(),</span>
                    isAskingToFollow,
                    actionListener,
                    source,
                    readerTracker
            );
        }

<span class="nc" id="L161">        updateFeedInfo(feedId, null, new UpdateBlogInfoListener() {</span>
            @Override
            public void onResult(ReaderBlog blogInfo) {
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (blogInfo != null) {</span>
<span class="nc" id="L165">                    internalFollowFeed(</span>
                            blogInfo.blogId,
                            blogInfo.feedId,
<span class="nc" id="L168">                            blogInfo.getFeedUrl(),</span>
                            isAskingToFollow,
                            actionListener,
                            source,
                            readerTracker
                    );
                } else {
<span class="nc" id="L175">                    ReaderActions.callActionListener(actionListener, false);</span>
                }
<span class="nc" id="L177">            }</span>
        });

<span class="nc" id="L180">        return true;</span>
    }

    public static void followFeedByUrl(final String feedUrl,
                                       final ActionListener actionListener,
                                       final String source,
                                       final ReaderTracker readerTracker) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (TextUtils.isEmpty(feedUrl)) {</span>
<span class="nc" id="L188">            ReaderActions.callActionListener(actionListener, false);</span>
<span class="nc" id="L189">            return;</span>
        }

        // use existing blog info if we can
<span class="nc" id="L193">        ReaderBlog blogInfo = ReaderBlogTable.getFeedInfo(ReaderBlogTable.getFeedIdFromUrl(feedUrl));</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (blogInfo != null) {</span>
<span class="nc" id="L195">            internalFollowFeed(</span>
                    blogInfo.blogId,
                    blogInfo.feedId,
<span class="nc" id="L198">                    blogInfo.getFeedUrl(),</span>
                    true,
                    actionListener,
                    source,
                    readerTracker
            );
<span class="nc" id="L204">            return;</span>
        }

        // otherwise, look it up via the endpoint
<span class="nc" id="L208">        updateFeedInfo(0, feedUrl, new UpdateBlogInfoListener() {</span>
            @Override
            public void onResult(ReaderBlog blogInfo) {
                // note we attempt to follow even when the look up fails (blogInfo = null) because that
                // endpoint doesn't perform feed discovery, whereas the endpoint to follow a feed does
<span class="nc bnc" id="L213" title="All 2 branches missed.">                long blogIdToFollow = blogInfo != null ? blogInfo.blogId : 0;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                long feedIdToFollow = blogInfo != null ? blogInfo.feedId : 0;</span>
<span class="nc bnc" id="L215" title="All 4 branches missed.">                String feedUrlToFollow = (blogInfo != null &amp;&amp; blogInfo.hasFeedUrl()) ? blogInfo.getFeedUrl() : feedUrl;</span>
<span class="nc" id="L216">                internalFollowFeed(</span>
                        blogIdToFollow,
                        feedIdToFollow,
                        feedUrlToFollow,
                        true,
                        actionListener,
                        source,
                        readerTracker
                );
<span class="nc" id="L225">            }</span>
        });
<span class="nc" id="L227">    }</span>

    private static boolean internalFollowFeed(
            final long blogId,
            final long feedId,
            final String feedUrl,
            final boolean isAskingToFollow,
            final ActionListener actionListener,
            final String source,
            final ReaderTracker readerTracker
    ) {
        // feedUrl is required
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (TextUtils.isEmpty(feedUrl)) {</span>
<span class="nc" id="L240">            ReaderActions.callActionListener(actionListener, false);</span>
<span class="nc" id="L241">            return false;</span>
        }

<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (feedId != 0) {</span>
<span class="nc" id="L245">            ReaderBlogTable.setIsFollowedFeedId(feedId, isAskingToFollow);</span>
<span class="nc" id="L246">            ReaderPostTable.setFollowStatusForPostsInFeed(feedId, isAskingToFollow);</span>
        }

<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (isAskingToFollow) {</span>
<span class="nc" id="L250">            readerTracker.trackBlog(</span>
                    AnalyticsTracker.Stat.READER_BLOG_FOLLOWED,
                    blogId,
                    feedId,
                    source
            );
        } else {
<span class="nc" id="L257">            readerTracker.trackBlog(</span>
                    AnalyticsTracker.Stat.READER_BLOG_UNFOLLOWED,
                    blogId,
                    feedId,
                    source
            );
        }

<span class="nc bnc" id="L265" title="All 2 branches missed.">        final String actionName = (isAskingToFollow ? &quot;follow&quot; : &quot;unfollow&quot;);</span>
<span class="nc" id="L266">        final String path = &quot;read/following/mine/&quot;</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                            + (isAskingToFollow ? &quot;new?source=android&amp;url=&quot; : &quot;delete?url=&quot;)</span>
<span class="nc" id="L268">                            + UrlUtils.urlEncode(feedUrl);</span>

<span class="nc" id="L270">        com.wordpress.rest.RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L273">                boolean success = isFollowActionSuccessful(jsonObject, isAskingToFollow);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                if (success) {</span>
<span class="nc" id="L275">                    AppLog.d(T.READER, &quot;feed &quot; + actionName + &quot; succeeded&quot;);</span>
                } else {
<span class="nc" id="L277">                    AppLog.w(T.READER, &quot;feed &quot; + actionName + &quot; failed - &quot; + jsonToString(jsonObject) + &quot; - &quot; + path);</span>
<span class="nc" id="L278">                    localRevertFollowFeedId(feedId, isAskingToFollow);</span>
                }
<span class="nc" id="L280">                ReaderActions.callActionListener(actionListener, success);</span>
<span class="nc" id="L281">            }</span>
        };
<span class="nc" id="L283">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L286">                AppLog.w(T.READER, &quot;feed &quot; + actionName + &quot; failed with error&quot;);</span>
<span class="nc" id="L287">                AppLog.e(T.READER, volleyError);</span>
<span class="nc" id="L288">                localRevertFollowFeedId(feedId, isAskingToFollow);</span>
<span class="nc" id="L289">                ReaderActions.callActionListener(actionListener, false);</span>
<span class="nc" id="L290">            }</span>
        };
<span class="nc" id="L292">        WordPress.getRestClientUtilsV1_1().post(path, listener, errorListener);</span>

<span class="nc" id="L294">        return true;</span>
    }

    /*
     * helper routine when following a blog from a post view
     */
    public static boolean followBlog(final Long blogId,
                                     final Long feedId,
                                     boolean isAskingToFollow,
                                     ActionListener actionListener,
                                     final String source,
                                     ReaderTracker readerTracker) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (ReaderUtils.isExternalFeed(blogId, feedId)) {</span>
<span class="nc" id="L307">            return followFeedById(blogId, feedId, isAskingToFollow, actionListener, source, readerTracker);</span>
        } else {
<span class="nc" id="L309">            return followBlogById(blogId, feedId, isAskingToFollow, actionListener, source, readerTracker);</span>
        }
    }

    /*
     * called when a follow/unfollow fails, restores local data to previous state
     */
    private static void localRevertFollowBlogId(long blogId, boolean isAskingToFollow) {
<span class="nc bnc" id="L317" title="All 2 branches missed.">        ReaderBlogTable.setIsFollowedBlogId(blogId, !isAskingToFollow);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        ReaderPostTable.setFollowStatusForPostsInBlog(blogId, !isAskingToFollow);</span>
<span class="nc" id="L319">    }</span>

    private static void localRevertFollowFeedId(long feedId, boolean isAskingToFollow) {
<span class="nc bnc" id="L322" title="All 2 branches missed.">        ReaderBlogTable.setIsFollowedFeedId(feedId, !isAskingToFollow);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        ReaderPostTable.setFollowStatusForPostsInFeed(feedId, !isAskingToFollow);</span>
<span class="nc" id="L324">    }</span>

    /*
     * returns whether a follow/unfollow was successful based on the response to:
     * read/follows/new
     * read/follows/delete
     * site/$site/follows/new
     * site/$site/follows/mine/delete
     */
    private static boolean isFollowActionSuccessful(JSONObject json, boolean isAskingToFollow) {
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (json == null) {</span>
<span class="nc" id="L335">            return false;</span>
        }

        boolean isSubscribed;
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (json.has(&quot;subscribed&quot;)) {</span>
            // read/follows/
<span class="nc" id="L341">            isSubscribed = json.optBoolean(&quot;subscribed&quot;, false);</span>
        } else {
            // site/$site/follows/
<span class="nc bnc" id="L344" title="All 4 branches missed.">            isSubscribed = json.has(&quot;is_following&quot;) &amp;&amp; json.optBoolean(&quot;is_following&quot;, false);</span>
        }
<span class="nc bnc" id="L346" title="All 2 branches missed.">        return (isSubscribed == isAskingToFollow);</span>
    }

    /*
     * request info about a specific blog
     */
    public static void updateBlogInfo(long blogId,
                                      final String blogUrl,
                                      final UpdateBlogInfoListener infoListener) {
        // must pass either a valid id or url
<span class="nc bnc" id="L356" title="All 2 branches missed.">        final boolean hasBlogId = (blogId != 0);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">        final boolean hasBlogUrl = !TextUtils.isEmpty(blogUrl);</span>
<span class="nc bnc" id="L358" title="All 4 branches missed.">        if (!hasBlogId &amp;&amp; !hasBlogUrl) {</span>
<span class="nc" id="L359">            AppLog.w(T.READER, &quot;cannot get blog info without either id or url&quot;);</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (infoListener != null) {</span>
<span class="nc" id="L361">                infoListener.onResult(null);</span>
            }
<span class="nc" id="L363">            return;</span>
        }

<span class="nc" id="L366">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L369">                handleUpdateBlogInfoResponse(jsonObject, infoListener);</span>
<span class="nc" id="L370">            }</span>
        };
<span class="nc" id="L372">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
                // authentication error may indicate that API access has been disabled for this blog
<span class="nc" id="L376">                int statusCode = VolleyUtils.statusCodeFromVolleyError(volleyError);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                boolean isAuthErr = (statusCode == HttpURLConnection.HTTP_FORBIDDEN);</span>
                // if we failed to get the blog info using the id and this isn't an authentication
                // error, try again using just the domain
<span class="nc bnc" id="L380" title="All 6 branches missed.">                if (!isAuthErr &amp;&amp; hasBlogId &amp;&amp; hasBlogUrl) {</span>
<span class="nc" id="L381">                    AppLog.w(T.READER, &quot;failed to get blog info by id, retrying with url&quot;);</span>
<span class="nc" id="L382">                    updateBlogInfo(0, blogUrl, infoListener);</span>
                } else {
<span class="nc" id="L384">                    AppLog.e(T.READER, volleyError);</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    if (infoListener != null) {</span>
<span class="nc" id="L386">                        infoListener.onResult(null);</span>
                    }
                }
<span class="nc" id="L389">            }</span>
        };

<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (hasBlogId) {</span>
<span class="nc" id="L393">            WordPress.getRestClientUtilsV1_1().get(&quot;read/sites/&quot; + blogId, listener, errorListener);</span>
        } else {
<span class="nc" id="L395">            WordPress.getRestClientUtilsV1_1()</span>
<span class="nc" id="L396">                     .get(&quot;read/sites/&quot; + UrlUtils.urlEncode(UrlUtils.getHost(blogUrl)), listener, errorListener);</span>
        }
<span class="nc" id="L398">    }</span>

    public static void updateFeedInfo(long feedId, String feedUrl, final UpdateBlogInfoListener infoListener) {
        // must pass either a valid id or url
<span class="nc bnc" id="L402" title="All 2 branches missed.">        final boolean hasFeedId = (feedId != 0);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        final boolean hasFeedUrl = !TextUtils.isEmpty(feedUrl);</span>
<span class="nc bnc" id="L404" title="All 4 branches missed.">        if (!hasFeedId &amp;&amp; !hasFeedUrl) {</span>
<span class="nc" id="L405">            AppLog.w(T.READER, &quot;cannot update Feed info without either id or url&quot;);</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">            if (infoListener != null) {</span>
<span class="nc" id="L407">                infoListener.onResult(null);</span>
            }
<span class="nc" id="L409">            return;</span>
        }

<span class="nc" id="L412">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L415">                handleUpdateBlogInfoResponse(jsonObject, infoListener);</span>
<span class="nc" id="L416">            }</span>
        };
<span class="nc" id="L418">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L421">                AppLog.e(T.READER, volleyError);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                if (infoListener != null) {</span>
<span class="nc" id="L423">                    infoListener.onResult(null);</span>
                }
<span class="nc" id="L425">            }</span>
        };
        String path;
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (feedId != 0) {</span>
<span class="nc" id="L429">            path = &quot;read/feed/&quot; + feedId;</span>
        } else {
<span class="nc" id="L431">            path = &quot;read/feed/&quot; + UrlUtils.urlEncode(feedUrl);</span>
        }
<span class="nc" id="L433">        WordPress.getRestClientUtilsV1_1().get(path, listener, errorListener);</span>
<span class="nc" id="L434">    }</span>

    private static void handleUpdateBlogInfoResponse(JSONObject jsonObject, UpdateBlogInfoListener infoListener) {
<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (jsonObject == null) {</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">            if (infoListener != null) {</span>
<span class="nc" id="L439">                infoListener.onResult(null);</span>
            }
<span class="nc" id="L441">            return;</span>
        }

<span class="nc" id="L444">        ReaderBlog blogInfo = ReaderBlog.fromJson(jsonObject);</span>
<span class="nc" id="L445">        ReaderBlogTable.addOrUpdateBlog(blogInfo);</span>

<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (infoListener != null) {</span>
<span class="nc" id="L448">            infoListener.onResult(blogInfo);</span>
        }
<span class="nc" id="L450">    }</span>

    /*
     * tests whether the passed url can be reached - does NOT use authentication, and does not
     * account for 404 replacement pages used by ISPs such as Charter
     */
    public static void checkUrlReachable(final String blogUrl,
                                         final ReaderActions.OnRequestListener&lt;Void&gt; requestListener) {
        // listener is required
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (requestListener == null) {</span>
<span class="nc" id="L460">            return;</span>
        }

<span class="nc" id="L463">        Response.Listener&lt;String&gt; listener = new Response.Listener&lt;String&gt;() {</span>
            @Override
            public void onResponse(String response) {
<span class="nc" id="L466">                requestListener.onSuccess(null);</span>
<span class="nc" id="L467">            }</span>
        };
<span class="nc" id="L469">        Response.ErrorListener errorListener = new Response.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L472">                AppLog.e(T.READER, volleyError);</span>
                int statusCode;
                // check specifically for auth failure class rather than relying on status code
                // since a redirect to an unauthorized url may return a 301 rather than a 401
<span class="nc bnc" id="L476" title="All 2 branches missed.">                if (volleyError instanceof com.android.volley.AuthFailureError) {</span>
<span class="nc" id="L477">                    statusCode = 401;</span>
                } else {
<span class="nc" id="L479">                    statusCode = VolleyUtils.statusCodeFromVolleyError(volleyError);</span>
                }
                // Volley treats a 301 redirect as a failure here, we should treat it as
                // success since it means the blog url is reachable
<span class="nc bnc" id="L483" title="All 2 branches missed.">                if (statusCode == 301) {</span>
<span class="nc" id="L484">                    requestListener.onSuccess(null);</span>
                } else {
<span class="nc" id="L486">                    requestListener.onFailure(statusCode);</span>
                }
<span class="nc" id="L488">            }</span>
        };

        // TODO: this should be a HEAD request, but even though Volley supposedly supports HEAD
        // using it results in &quot;java.lang.IllegalStateException: Unknown method type&quot;
<span class="nc" id="L493">        StringRequest request = new StringRequest(</span>
                Request.Method.GET,
                blogUrl,
                listener,
                errorListener);
<span class="nc" id="L498">        WordPress.requestQueue.add(request);</span>
<span class="nc" id="L499">    }</span>

    public static BlockedBlogResult blockBlogFromReaderLocal(final long blogId, final long feedId) {
<span class="nc" id="L502">        final BlockedBlogResult blockResult = new BlockedBlogResult();</span>
<span class="nc" id="L503">        blockResult.blogId = blogId;</span>
<span class="nc" id="L504">        blockResult.feedId = feedId;</span>
<span class="nc" id="L505">        blockResult.deletedRows = ReaderPostTable.getTagPostMap(blogId);</span>
<span class="nc" id="L506">        blockResult.wasFollowing = ReaderBlogTable.isFollowedBlog(blogId);</span>

<span class="nc" id="L508">        ReaderPostTable.deletePostsInBlog(blockResult.blogId);</span>
<span class="nc" id="L509">        ReaderBlogTable.setIsFollowedBlogId(blockResult.blogId, false);</span>
<span class="nc" id="L510">        return blockResult;</span>
    }

    /*
     * block a blog - result includes the list of posts that were deleted by the block so they
     * can be restored if the user undoes the block
     */
    public static void blockBlogFromReaderRemote(BlockedBlogResult blockResult, final ActionListener actionListener) {
<span class="nc" id="L518">        com.wordpress.rest.RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L521">                ReaderActions.callActionListener(actionListener, true);</span>
<span class="nc" id="L522">            }</span>
        };
<span class="nc" id="L524">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L527">                AppLog.e(T.READER, volleyError);</span>
<span class="nc" id="L528">                undoBlockBlogLocal(blockResult);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">                if (blockResult.wasFollowing) {</span>
<span class="nc" id="L530">                    ReaderBlogTable.setIsFollowedBlogId(blockResult.blogId, true);</span>
                }
<span class="nc" id="L532">                ReaderActions.callActionListener(actionListener, false);</span>
<span class="nc" id="L533">            }</span>
        };

<span class="nc" id="L536">        AppLog.i(T.READER, &quot;blocking blog &quot; + blockResult.blogId);</span>
<span class="nc" id="L537">        String path = &quot;me/block/sites/&quot; + blockResult.blogId + &quot;/new&quot;;</span>
<span class="nc" id="L538">        WordPress.getRestClientUtilsV1_1().post(path, listener, errorListener);</span>
<span class="nc" id="L539">    }</span>

    public static void undoBlockBlogFromReader(final BlockedBlogResult blockResult,
                                               final String source,
                                               final ReaderTracker readerTracker) {
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (blockResult == null) {</span>
<span class="nc" id="L545">            return;</span>
        }
<span class="nc" id="L547">        undoBlockBlogLocal(blockResult);</span>

<span class="nc" id="L549">        com.wordpress.rest.RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L552" title="All 4 branches missed.">                boolean success = (jsonObject != null &amp;&amp; jsonObject.optBoolean(&quot;success&quot;));</span>
                // re-follow the blog if it was being followed prior to the block
<span class="nc bnc" id="L554" title="All 4 branches missed.">                if (success &amp;&amp; blockResult.wasFollowing) {</span>
<span class="nc" id="L555">                    followBlogById(</span>
                            blockResult.blogId,
                            blockResult.feedId,
                            true,
                            null,
                            source,
                            readerTracker
                    );
<span class="nc bnc" id="L563" title="All 2 branches missed.">                } else if (!success) {</span>
<span class="nc" id="L564">                    AppLog.w(T.READER, &quot;failed to unblock blog &quot; + blockResult.blogId);</span>
                }
<span class="nc" id="L566">            }</span>
        };
<span class="nc" id="L568">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L571">                AppLog.e(T.READER, volleyError);</span>
<span class="nc" id="L572">            }</span>
        };

<span class="nc" id="L575">        AppLog.i(T.READER, &quot;unblocking blog &quot; + blockResult.blogId);</span>
<span class="nc" id="L576">        String path = &quot;me/block/sites/&quot; + blockResult.blogId + &quot;/delete&quot;;</span>
<span class="nc" id="L577">        WordPress.getRestClientUtilsV1_1().post(path, listener, errorListener);</span>
<span class="nc" id="L578">    }</span>

    private static void undoBlockBlogLocal(final BlockedBlogResult blockResult) {
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (blockResult.deletedRows != null) {</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">            for (Pair&lt;String, ReaderTagType&gt; tagInfo : blockResult.deletedRows.keySet()) {</span>
<span class="nc" id="L583">                ReaderTag tag = ReaderTagTable.getTag(tagInfo.first, tagInfo.second);</span>
<span class="nc" id="L584">                ReaderPostTable.addOrUpdatePosts(tag, blockResult.deletedRows.get(tagInfo));</span>
<span class="nc" id="L585">            }</span>
        }
<span class="nc" id="L587">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>