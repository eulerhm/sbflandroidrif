<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader</a> &gt; <span class="el_source">ReaderFragment.kt</span></div><h1>ReaderFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader

import android.os.Bundle
import android.view.LayoutInflater
import android.view.Menu
import android.view.MenuInflater
import android.view.MenuItem
import android.view.View
import android.widget.TextView
import androidx.annotation.NonNull
import androidx.appcompat.app.AppCompatActivity
import androidx.core.view.isVisible
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import androidx.viewpager2.adapter.FragmentStateAdapter
import androidx.viewpager2.widget.ViewPager2
import com.google.android.material.tabs.TabLayout
import com.google.android.material.tabs.TabLayoutMediator
import org.greenrobot.eventbus.EventBus
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode.MAIN
import org.wordpress.android.R
import org.wordpress.android.R.string
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.ReaderFragmentLayoutBinding
import org.wordpress.android.models.ReaderTagList
import org.wordpress.android.ui.ScrollableViewInitializedListener
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.quickstart.QuickStartEvent
import org.wordpress.android.ui.reader.ReaderTypes.ReaderPostListType
import org.wordpress.android.ui.reader.discover.ReaderDiscoverFragment
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsFragment
import org.wordpress.android.ui.reader.services.update.ReaderUpdateLogic.UpdateTask.FOLLOWED_BLOGS
import org.wordpress.android.ui.reader.services.update.ReaderUpdateLogic.UpdateTask.TAGS
import org.wordpress.android.ui.reader.services.update.ReaderUpdateServiceStarter
import org.wordpress.android.ui.reader.viewmodels.ReaderViewModel
import org.wordpress.android.ui.reader.viewmodels.ReaderViewModel.ReaderUiState.ContentUiState
import org.wordpress.android.ui.reader.viewmodels.ReaderViewModel.ReaderUiState.ContentUiState.TabUiState
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.QuickStartUtilsWrapper
import org.wordpress.android.util.SnackbarItem
import org.wordpress.android.util.SnackbarItem.Action
import org.wordpress.android.util.SnackbarItem.Info
import org.wordpress.android.util.SnackbarSequencer
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.widgets.QuickStartFocusPoint
import java.util.EnumSet
import javax.inject.Inject

<span class="nc" id="L51">class ReaderFragment : Fragment(R.layout.reader_fragment_layout), ScrollableViewInitializedListener {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">    @Inject lateinit var quickStartUtilsWrapper: QuickStartUtilsWrapper</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">    @Inject lateinit var snackbarSequencer: SnackbarSequencer</span>
    private lateinit var viewModel: ReaderViewModel

    private var searchMenuItem: MenuItem? = null
    private var settingsMenuItem: MenuItem? = null
    private var settingsMenuItemFocusPoint: QuickStartFocusPoint? = null

    private var binding: ReaderFragmentLayoutBinding? = null

<span class="nc" id="L64">    private val viewPagerCallback = object : ViewPager2.OnPageChangeCallback() {</span>
        override fun onPageSelected(position: Int) {
<span class="nc" id="L66">            super.onPageSelected(position)</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">            viewModel.uiState.value?.let {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                if (it is ContentUiState) {</span>
<span class="nc" id="L69">                    val selectedTag = it.readerTagList[position]</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                    viewModel.onTagChanged(selectedTag)</span>
                }
<span class="nc" id="L72">            }</span>
<span class="nc" id="L73">        }</span>
    }

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L77">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc" id="L79">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L82">        setHasOptionsMenu(true)</span>
<span class="nc" id="L83">        binding = ReaderFragmentLayoutBinding.bind(view).apply {</span>
<span class="nc" id="L84">            initToolbar()</span>
<span class="nc" id="L85">            initViewPager()</span>
<span class="nc" id="L86">            initViewModel()</span>
<span class="nc" id="L87">        }</span>
<span class="nc" id="L88">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L91">        super.onDestroyView()</span>
<span class="nc" id="L92">        searchMenuItem = null</span>
<span class="nc" id="L93">        settingsMenuItem = null</span>
<span class="nc" id="L94">        settingsMenuItemFocusPoint = null</span>
<span class="nc" id="L95">        binding = null</span>
<span class="nc" id="L96">    }</span>

    override fun onResume() {
<span class="nc" id="L99">        super.onResume()</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        viewModel.onScreenInForeground()</span>
<span class="nc" id="L101">    }</span>

    override fun onPause() {
<span class="nc" id="L104">        super.onPause()</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">        activity?.let { viewModel.onScreenInBackground(it.isChangingConfigurations) }</span>
<span class="nc" id="L106">    }</span>

    override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
<span class="nc" id="L109">        inflater.inflate(R.menu.reader_home, menu)</span>
<span class="nc" id="L110">        menu.findItem(R.id.menu_search).apply {</span>
<span class="nc" id="L111">            searchMenuItem = this</span>
<span class="nc bnc" id="L112" title="All 6 branches missed.">            this.isVisible = viewModel.uiState.value?.searchMenuItemUiState?.isVisible ?: false</span>
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">        menu.findItem(R.id.menu_settings).apply {</span>
<span class="nc" id="L115">            settingsMenuItem = this</span>
<span class="nc" id="L116">            settingsMenuItemFocusPoint = this.actionView.findViewById(R.id.menu_quick_start_focus_point)</span>
<span class="nc bnc" id="L117" title="All 6 branches missed.">            this.isVisible = viewModel.uiState.value?.settingsMenuItemUiState?.isVisible ?: false</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            settingsMenuItemFocusPoint?.isVisible =</span>
<span class="nc bnc" id="L119" title="All 6 branches missed.">                    viewModel.uiState.value?.settingsMenuItemUiState?.showQuickStartFocusPoint ?: false</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            this.actionView.setOnClickListener { viewModel.onSettingsActionClicked() }</span>
<span class="nc" id="L121">        }</span>
<span class="nc" id="L122">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L125" title="All 3 branches missed.">        return when (item.itemId) {</span>
            R.id.menu_search -&gt; {
<span class="nc bnc" id="L127" title="All 2 branches missed.">                viewModel.onSearchActionClicked()</span>
<span class="nc" id="L128">                true</span>
            }
            R.id.menu_settings -&gt; {
<span class="nc bnc" id="L131" title="All 2 branches missed.">                viewModel.onSettingsActionClicked()</span>
<span class="nc" id="L132">                true</span>
            }
            else -&gt; {
<span class="nc" id="L135">                super.onOptionsItemSelected(item)</span>
            }
        }
    }

    private fun ReaderFragmentLayoutBinding.initToolbar() {
<span class="nc" id="L141">        toolbar.title = getString(string.reader_screen_title)</span>
<span class="nc" id="L142">        (requireActivity() as AppCompatActivity).setSupportActionBar(toolbar)</span>
<span class="nc" id="L143">    }</span>

    private fun ReaderFragmentLayoutBinding.initViewPager() {
<span class="nc" id="L146">        viewPager.registerOnPageChangeCallback(viewPagerCallback)</span>
<span class="nc" id="L147">    }</span>

    private fun ReaderFragmentLayoutBinding.initViewModel() {
<span class="nc" id="L150">        viewModel = ViewModelProvider(this@ReaderFragment, viewModelFactory).get(ReaderViewModel::class.java)</span>
<span class="nc" id="L151">        startObserving()</span>
<span class="nc" id="L152">    }</span>

    private fun ReaderFragmentLayoutBinding.startObserving() {
<span class="nc bnc" id="L155" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner) { uiState -&gt;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            uiState?.let {</span>
<span class="nc" id="L157">                when (it) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                    is ContentUiState -&gt; {</span>
<span class="nc" id="L159">                        updateTabs(it)</span>
                    }
                }
<span class="nc" id="L162">                uiHelpers.updateVisibility(tabLayout, uiState.tabLayoutVisible)</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                searchMenuItem?.isVisible = uiState.searchMenuItemUiState.isVisible</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                settingsMenuItem?.isVisible = uiState.settingsMenuItemUiState.isVisible</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                settingsMenuItemFocusPoint?.isVisible =</span>
<span class="nc bnc" id="L166" title="All 6 branches missed.">                        viewModel.uiState.value?.settingsMenuItemUiState?.showQuickStartFocusPoint ?: false</span>
<span class="nc" id="L167">            }</span>
<span class="nc" id="L168">        }</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">        viewModel.updateTags.observeEvent(viewLifecycleOwner) {</span>
<span class="nc" id="L171">            ReaderUpdateServiceStarter.startService(context, EnumSet.of(TAGS, FOLLOWED_BLOGS))</span>
<span class="nc" id="L172">        }</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">        viewModel.selectTab.observeEvent(viewLifecycleOwner) { navTarget -&gt;</span>
<span class="nc" id="L175">            viewPager.setCurrentItem(navTarget.position, navTarget.smoothAnimation)</span>
<span class="nc" id="L176">        }</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        viewModel.showSearch.observeEvent(viewLifecycleOwner) {</span>
<span class="nc" id="L179">            ReaderActivityLauncher.showReaderSearch(context)</span>
<span class="nc" id="L180">        }</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        viewModel.showSettings.observeEvent(viewLifecycleOwner) {</span>
<span class="nc" id="L183">            ReaderActivityLauncher.showReaderSubs(context)</span>
<span class="nc" id="L184">        }</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">        viewModel.showReaderInterests.observeEvent(viewLifecycleOwner) {</span>
<span class="nc" id="L187">            showReaderInterests()</span>
<span class="nc" id="L188">        }</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">        viewModel.closeReaderInterests.observeEvent(viewLifecycleOwner) {</span>
<span class="nc" id="L191">            closeReaderInterests()</span>
<span class="nc" id="L192">        }</span>

<span class="nc bnc" id="L194" title="All 2 branches missed.">        viewModel.quickStartPromptEvent.observeEvent(viewLifecycleOwner) { prompt -&gt;</span>
<span class="nc" id="L195">            val message = quickStartUtilsWrapper.stylizeQuickStartPrompt(</span>
<span class="nc" id="L196">                    requireActivity(),</span>
<span class="nc" id="L197">                    prompt.shortMessagePrompt,</span>
<span class="nc" id="L198">                    prompt.iconId</span>
            )

<span class="nc" id="L201">            showSnackbar(</span>
<span class="nc" id="L202">                    SnackbarMessageHolder(</span>
<span class="nc" id="L203">                            message = UiStringText(message),</span>
<span class="nc" id="L204">                            duration = prompt.duration,</span>
                            onDismissAction = {
<span class="nc bnc" id="L206" title="All 2 branches missed.">                                viewModel.onQuickStartPromptDismissed()</span>
<span class="nc" id="L207">                            },</span>
<span class="nc" id="L208">                            isImportant = false</span>
                    )
            )
<span class="nc" id="L211">        }</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">        viewModel.start()</span>
<span class="nc" id="L214">    }</span>

    private fun ReaderFragmentLayoutBinding.showSnackbar(holder: SnackbarMessageHolder) {
<span class="nc bnc" id="L217" title="All 4 branches missed.">        if (!isAdded || view == null) return</span>
<span class="nc" id="L218">        snackbarSequencer.enqueue(</span>
<span class="nc" id="L219">                SnackbarItem(</span>
<span class="nc" id="L220">                        info = Info(</span>
<span class="nc" id="L221">                                view = coordinatorLayout,</span>
<span class="nc" id="L222">                                textRes = holder.message,</span>
<span class="nc" id="L223">                                duration = holder.duration,</span>
<span class="nc" id="L224">                                isImportant = holder.isImportant</span>
                        ),
<span class="nc bnc" id="L226" title="All 2 branches missed.">                        action = holder.buttonTitle?.let {</span>
<span class="nc" id="L227">                            Action(</span>
<span class="nc" id="L228">                                    textRes = holder.buttonTitle,</span>
<span class="nc" id="L229">                                    clickListener = { holder.buttonAction() }</span>
                            )
                        }
                )
        )
<span class="nc" id="L234">    }</span>

    private fun ReaderFragmentLayoutBinding.updateTabs(uiState: ContentUiState) {
<span class="nc bnc" id="L237" title="All 4 branches missed.">        if (viewPager.adapter == null || uiState.shouldUpdateViewPager) {</span>
<span class="nc" id="L238">            updateViewPagerAdapterAndMediator(uiState)</span>
        }
<span class="nc" id="L240">        uiState.tabUiStates.forEachIndexed { index, tabUiState -&gt;</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            val tab = tabLayout.getTabAt(index) as TabLayout.Tab</span>
<span class="nc" id="L242">            updateTab(tab, tabUiState)</span>
<span class="nc" id="L243">        }</span>
<span class="nc" id="L244">    }</span>

    private fun ReaderFragmentLayoutBinding.updateTab(tab: TabLayout.Tab, tabUiState: TabUiState) {
<span class="nc bnc" id="L247" title="All 2 branches missed.">        val customView = tab.customView ?: createTabCustomView(tab)</span>
<span class="nc" id="L248">        with(customView) {</span>
<span class="nc" id="L249">            val title = findViewById&lt;TextView&gt;(R.id.tab_label)</span>
<span class="nc" id="L250">            title.text = uiHelpers.getTextOfUiString(requireContext(), tabUiState.label)</span>
<span class="nc" id="L251">        }</span>
<span class="nc" id="L252">    }</span>

    private fun ReaderFragmentLayoutBinding.updateViewPagerAdapterAndMediator(uiState: ContentUiState) {
<span class="nc" id="L255">        viewPager.adapter = TabsAdapter(this@ReaderFragment, uiState.readerTagList)</span>
<span class="nc" id="L256">        TabLayoutMediator(tabLayout, viewPager, ReaderTabConfigurationStrategy(uiState)).attach()</span>
<span class="nc" id="L257">    }</span>

<span class="nc" id="L259">    private inner class ReaderTabConfigurationStrategy(</span>
<span class="nc" id="L260">        private val uiState: ContentUiState</span>
    ) : TabLayoutMediator.TabConfigurationStrategy {
        override fun onConfigureTab(@NonNull tab: TabLayout.Tab, position: Int) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">            binding?.updateTab(tab, uiState.tabUiStates[position])</span>
<span class="nc" id="L264">        }</span>
    }

    private fun ReaderFragmentLayoutBinding.createTabCustomView(tab: TabLayout.Tab): View {
<span class="nc" id="L268">        val customView = LayoutInflater.from(context)</span>
<span class="nc" id="L269">                .inflate(R.layout.tab_custom_view, tabLayout, false)</span>
<span class="nc" id="L270">        tab.customView = customView</span>
<span class="nc" id="L271">        return customView</span>
    }

    fun requestBookmarkTab() {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        viewModel.bookmarkTabRequested()</span>
<span class="nc" id="L276">    }</span>

<span class="nc" id="L278">    private class TabsAdapter(parent: Fragment, private val tags: ReaderTagList) : FragmentStateAdapter(parent) {</span>
<span class="nc" id="L279">        override fun getItemCount(): Int = tags.size</span>

        override fun createFragment(position: Int): Fragment {
<span class="nc bnc" id="L282" title="All 2 branches missed.">            return if (tags[position].isDiscover) {</span>
<span class="nc" id="L283">                ReaderDiscoverFragment()</span>
<span class="nc" id="L284">            } else {</span>
<span class="nc" id="L285">                ReaderPostListFragment.newInstanceForTag(</span>
<span class="nc" id="L286">                        tags[position],</span>
<span class="nc" id="L287">                        ReaderPostListType.TAG_FOLLOWED,</span>
<span class="nc" id="L288">                        true</span>
                )
            }
        }
    }

    private fun showReaderInterests() {
<span class="nc" id="L295">        val readerInterestsFragment = childFragmentManager.findFragmentByTag(ReaderInterestsFragment.TAG)</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (readerInterestsFragment == null) {</span>
<span class="nc" id="L297">            childFragmentManager.beginTransaction()</span>
<span class="nc" id="L298">                    .replace(</span>
<span class="nc" id="L299">                            R.id.interests_fragment_container,</span>
<span class="nc" id="L300">                            ReaderInterestsFragment(),</span>
<span class="nc" id="L301">                            ReaderInterestsFragment.TAG</span>
                    )
<span class="nc" id="L303">                    .commitNow()</span>
        }
<span class="nc" id="L305">    }</span>

    private fun closeReaderInterests() {
<span class="nc" id="L308">        val readerInterestsFragment = childFragmentManager.findFragmentByTag(ReaderInterestsFragment.TAG)</span>
<span class="nc bnc" id="L309" title="All 6 branches missed.">        if (readerInterestsFragment?.isAdded == true) {</span>
<span class="nc" id="L310">            childFragmentManager.beginTransaction()</span>
<span class="nc" id="L311">                    .remove(readerInterestsFragment)</span>
<span class="nc" id="L312">                    .commitNow()</span>
        }
<span class="nc" id="L314">    }</span>

    override fun onScrollableViewInitialized(containerId: Int) {
<span class="nc bnc" id="L317" title="All 4 branches missed.">        binding?.appBar?.liftOnScrollTargetViewId = containerId</span>
<span class="nc" id="L318">    }</span>

    override fun onStart() {
<span class="nc" id="L321">        super.onStart()</span>
<span class="nc" id="L322">        EventBus.getDefault().register(this)</span>
<span class="nc" id="L323">    }</span>

    override fun onStop() {
<span class="nc" id="L326">        super.onStop()</span>
<span class="nc" id="L327">        EventBus.getDefault().unregister(this)</span>
<span class="nc" id="L328">    }</span>

    @Subscribe(sticky = true, threadMode = MAIN)
    fun onEvent(event: QuickStartEvent) {
<span class="nc bnc" id="L332" title="All 4 branches missed.">        if (!isAdded || view == null) {</span>
<span class="nc" id="L333">            return</span>
        }
<span class="nc bnc" id="L335" title="All 2 branches missed.">        viewModel.onQuickStartEventReceived(event)</span>
<span class="nc" id="L336">        EventBus.getDefault().removeStickyEvent(event)</span>
<span class="nc" id="L337">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>