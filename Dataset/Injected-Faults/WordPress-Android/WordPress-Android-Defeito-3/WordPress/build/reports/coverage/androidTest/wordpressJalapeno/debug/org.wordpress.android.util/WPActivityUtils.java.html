<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WPActivityUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">WPActivityUtils.java</span></div><h1>WPActivityUtils.java</h1><pre class="source lang-java linenums">package org.wordpress.android.util;

import android.app.Dialog;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.content.pm.ResolveInfo;
import android.net.Uri;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.view.ViewGroup.LayoutParams;
import android.view.Window;
import android.widget.ListView;

import androidx.annotation.NonNull;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;
import androidx.core.view.ViewCompat;

import com.google.android.material.appbar.AppBarLayout;
import com.google.android.material.appbar.MaterialToolbar;

import org.wordpress.android.R;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.extensions.DialogExtensionsKt;
import org.wordpress.android.util.extensions.WindowExtensionsKt;

import java.util.ArrayList;
import java.util.List;

<span class="nc" id="L34">public class WPActivityUtils {</span>
    public static final String READER_DEEPLINK_ACTIVITY_ALIAS = &quot;org.wordpress.android.WPComPostReaderActivity&quot;;

    // Hack! PreferenceScreens don't show the toolbar, so we'll manually add one
    // See: http://stackoverflow.com/a/27455363/309558

    // TODO: android.app.Fragment  is deprecated since Android P.
    // Needs to be replaced with android.support.v4.app.Fragment
    // See https://developer.android.com/reference/android/app/Fragment
    public static void addToolbarToDialog(final android.app.Fragment context, final Dialog dialog, String title) {
<span class="nc bnc" id="L44" title="All 4 branches missed.">        if (!context.isAdded() || dialog == null) {</span>
<span class="nc" id="L45">            return;</span>
        }

<span class="nc" id="L48">        View dialogContainerView = DialogExtensionsKt.getPreferenceDialogContainerView(dialog);</span>

<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (dialogContainerView == null) {</span>
<span class="nc" id="L51">            AppLog.e(T.SETTINGS, &quot;Preference Dialog View was null when adding Toolbar&quot;);</span>
<span class="nc" id="L52">            return;</span>
        }

        // find the root view, then make sure the toolbar doesn't already exist
<span class="nc" id="L56">        ViewGroup root = (ViewGroup) dialogContainerView.getParent();</span>

        // if we already added an appbar to the dialog it will be in the view one level above it's parent
<span class="nc" id="L59">        ViewGroup modifiedRoot = (ViewGroup) dialogContainerView.getParent().getParent();</span>
<span class="nc bnc" id="L60" title="All 4 branches missed.">        if (modifiedRoot != null &amp;&amp; modifiedRoot.findViewById(R.id.appbar_main) != null) {</span>
<span class="nc" id="L61">            return;</span>
        }

        // remove view from the root
<span class="nc" id="L65">        root.removeView(dialogContainerView);</span>

        // inflate our own layout with coordinator layout and appbar
<span class="nc" id="L68">        ViewGroup dialogViewWrapper = (ViewGroup) LayoutInflater.from(</span>
<span class="nc" id="L69">                context.getActivity()).inflate(</span>
                R.layout.preference_screen_wrapper, root,
                false);

        // container that will host content of the dialog
<span class="nc" id="L74">        ViewGroup listContainer = dialogViewWrapper.findViewById(R.id.list_container);</span>

<span class="nc" id="L76">        final ListView listOfPreferences = dialogContainerView.findViewById(android.R.id.list);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (listOfPreferences != null) {</span>
<span class="nc" id="L78">            ViewCompat.setNestedScrollingEnabled(listOfPreferences, true);</span>
        }

        // add dialog view into container
<span class="nc" id="L82">        LayoutParams lp = dialogContainerView.getLayoutParams();</span>
<span class="nc" id="L83">        lp.height = LayoutParams.MATCH_PARENT;</span>
<span class="nc" id="L84">        lp.width = LayoutParams.MATCH_PARENT;</span>
<span class="nc" id="L85">        listContainer.addView(dialogContainerView, lp);</span>

        // add layout with container back to root view
<span class="nc" id="L88">        root.addView(dialogViewWrapper);</span>

<span class="nc" id="L90">        AppBarLayout appbar = dialogViewWrapper.findViewById(R.id.appbar_main);</span>
<span class="nc" id="L91">        MaterialToolbar toolbar = appbar.findViewById(R.id.toolbar_main);</span>

<span class="nc" id="L93">        appbar.setLiftOnScrollTargetViewId(android.R.id.list);</span>

<span class="nc" id="L95">        dialog.getWindow().setWindowAnimations(R.style.DialogAnimations);</span>
<span class="nc" id="L96">        toolbar.setTitle(title);</span>
<span class="nc" id="L97">        toolbar.setNavigationOnClickListener(v -&gt; dialog.dismiss());</span>
<span class="nc" id="L98">        toolbar.setNavigationContentDescription(R.string.navigate_up_desc);</span>
<span class="nc" id="L99">    }</span>

    /**
     * Checks for a {@link Toolbar} at the first child element of a given {@link Dialog} and
     * removes it if it exists.
     * &lt;p&gt;
     * Originally added to prevent a crash that occurs with nested PreferenceScreens that added
     * a toolbar via {@link WPActivityUtils#addToolbarToDialog(android.app.Fragment, Dialog, String)}. The
     * crash can be reproduced by turning 'Don't keep activities' on from Developer options.
     */

    // TODO: android.app.Fragment  is deprecated since Android P.
    // Needs to be replaced with android.support.v4.app.Fragment
    // See https://developer.android.com/reference/android/app/Fragment
    public static void removeToolbarFromDialog(final android.app.Fragment context, final Dialog dialog) {
<span class="nc bnc" id="L114" title="All 4 branches missed.">        if (dialog == null || !context.isAdded()) {</span>
<span class="nc" id="L115">            return;</span>
        }

<span class="nc" id="L118">        View dialogContainerView = DialogExtensionsKt.getPreferenceDialogContainerView(dialog);</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (dialogContainerView == null) {</span>
<span class="nc" id="L121">            AppLog.e(T.SETTINGS, &quot;Preference Dialog View was null when removing Toolbar&quot;);</span>
<span class="nc" id="L122">            return;</span>
        }

<span class="nc" id="L125">        ViewGroup root = (ViewGroup) dialogContainerView.getParent().getParent();</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (root.getChildAt(0) instanceof Toolbar) {</span>
<span class="nc" id="L128">            root.removeViewAt(0);</span>
        }
<span class="nc" id="L130">    }</span>

    public static Context getThemedContext(Context context) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (context instanceof AppCompatActivity) {</span>
<span class="nc" id="L134">            ActionBar actionBar = ((AppCompatActivity) context).getSupportActionBar();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (actionBar != null) {</span>
<span class="nc" id="L136">                return actionBar.getThemedContext();</span>
            }
        }
<span class="nc" id="L139">        return context;</span>
    }

    public static boolean isEmailClientAvailable(Context context) {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (context == null) {</span>
<span class="nc" id="L144">            return false;</span>
        }
<span class="nc bnc" id="L146" title="All 2 branches missed.">        return !queryEmailApps(context, false).isEmpty();</span>
    }

    public static void openEmailClientChooser(Context context, String title) {
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (context == null) {</span>
<span class="nc" id="L151">            return;</span>
        }
<span class="nc" id="L153">        List&lt;Intent&gt; appIntents = new ArrayList();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        for (ResolveInfo resolveInfo : queryEmailApps(context, true)) {</span>
<span class="nc" id="L155">            Intent intent = context.getPackageManager().getLaunchIntentForPackage(resolveInfo.activityInfo.packageName);</span>
<span class="nc" id="L156">            appIntents.add(intent);</span>
<span class="nc" id="L157">        }</span>
<span class="nc" id="L158">        Intent emailAppIntent = Intent.makeMainSelectorActivity(Intent.ACTION_MAIN, Intent.CATEGORY_APP_EMAIL);</span>
<span class="nc" id="L159">        emailAppIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L160">        Intent[] appIntentsArray = appIntents.toArray(new Intent[appIntents.size()]);</span>
<span class="nc" id="L161">        Intent chooserIntent = Intent.createChooser(emailAppIntent, title);</span>
<span class="nc" id="L162">        chooserIntent.putExtra(Intent.EXTRA_INITIAL_INTENTS, appIntentsArray);</span>
<span class="nc" id="L163">        context.startActivity(chooserIntent);</span>
<span class="nc" id="L164">    }</span>

    private static List&lt;ResolveInfo&gt; queryEmailApps(@NonNull Context context, Boolean excludeCategoryEmailApps) {
<span class="nc" id="L167">        PackageManager packageManager = context.getPackageManager();</span>
<span class="nc" id="L168">        List&lt;ResolveInfo&gt; intentsInfoList = new ArrayList();</span>

        // Get all apps with category email
<span class="nc" id="L171">        Intent emailAppIntent = Intent.makeMainSelectorActivity(Intent.ACTION_MAIN, Intent.CATEGORY_APP_EMAIL);</span>
<span class="nc" id="L172">        List&lt;ResolveInfo&gt; emailAppIntentInfo =</span>
<span class="nc" id="L173">                packageManager.queryIntentActivities(emailAppIntent, PackageManager.MATCH_ALL);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (!excludeCategoryEmailApps) {</span>
<span class="nc" id="L175">            intentsInfoList.addAll(emailAppIntentInfo);</span>
        }

        // Get all apps that are able to send emails
<span class="nc" id="L179">        Intent sendEmailAppIntent = new Intent(Intent.ACTION_SENDTO);</span>
<span class="nc" id="L180">        sendEmailAppIntent.setData(Uri.parse(&quot;mailto:&quot;));</span>
<span class="nc" id="L181">        List&lt;ResolveInfo&gt; sendEmailAppIntentInfo =</span>
<span class="nc" id="L182">                packageManager.queryIntentActivities(sendEmailAppIntent, PackageManager.MATCH_ALL);</span>

<span class="nc" id="L184">        addNewIntents(intentsInfoList, emailAppIntentInfo, sendEmailAppIntentInfo);</span>
<span class="nc" id="L185">        return intentsInfoList;</span>
    }

    private static void addNewIntents(List&lt;ResolveInfo&gt; list, List&lt;ResolveInfo&gt; existing, List&lt;ResolveInfo&gt; intents) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        for (ResolveInfo intent : intents) {</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">            if (!intentExistsInList(intent, existing) &amp;&amp; !intentExistsInList(intent, list)) {</span>
<span class="nc" id="L191">                list.add(intent);</span>
            }
<span class="nc" id="L193">        }</span>
<span class="nc" id="L194">    }</span>

    private static boolean intentExistsInList(ResolveInfo intent, List&lt;ResolveInfo&gt; list) {
<span class="nc bnc" id="L197" title="All 2 branches missed.">        for (ResolveInfo item : list) {</span>
<span class="nc" id="L198">            if (intent.activityInfo.applicationInfo.processName</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                    .equals(item.activityInfo.applicationInfo.processName)) {</span>
<span class="nc" id="L200">                return true;</span>
            }
<span class="nc" id="L202">        }</span>
<span class="nc" id="L203">        return false;</span>
    }

    public static void disableReaderDeeplinks(Context context) {
<span class="nc" id="L207">        PackageManager pm = context.getPackageManager();</span>
<span class="nc" id="L208">        pm.setComponentEnabledSetting(new ComponentName(context, READER_DEEPLINK_ACTIVITY_ALIAS),</span>
                PackageManager.COMPONENT_ENABLED_STATE_DISABLED, PackageManager.DONT_KILL_APP);
<span class="nc" id="L210">    }</span>

    public static void enableReaderDeeplinks(Context context) {
<span class="nc" id="L213">        PackageManager pm = context.getPackageManager();</span>
<span class="nc" id="L214">        pm.setComponentEnabledSetting(new ComponentName(context, READER_DEEPLINK_ACTIVITY_ALIAS),</span>
                PackageManager.COMPONENT_ENABLED_STATE_ENABLED, PackageManager.DONT_KILL_APP);
<span class="nc" id="L216">    }</span>

    /**
     * @deprecated Use {@link WindowExtensionsKt} instead.
     */
    @Deprecated
    public static void setLightStatusBar(Window window, boolean showInLightMode) {
<span class="nc" id="L223">        WindowExtensionsKt.setLightStatusBar(window, showInLightMode);</span>
<span class="nc" id="L224">    }</span>

    /**
     * @deprecated Use {@link WindowExtensionsKt} instead.
     */
    @Deprecated
    public static void setLightNavigationBar(Window window, boolean showInLightMode) {
<span class="nc" id="L231">        WindowExtensionsKt.setLightNavigationBar(window, showInLightMode, true);</span>
<span class="nc" id="L232">    }</span>

    /**
     * @deprecated Use {@link WindowExtensionsKt} instead.
     */
    @Deprecated
    public static void showFullScreen(View decorView) {
<span class="nc" id="L239">        int flags = decorView.getSystemUiVisibility();</span>
<span class="nc" id="L240">        flags = flags | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN | View.SYSTEM_UI_FLAG_LAYOUT_STABLE;</span>
<span class="nc" id="L241">        decorView.setSystemUiVisibility(flags);</span>
<span class="nc" id="L242">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>