<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScanHistoryFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.jetpack.scan.history</a> &gt; <span class="el_source">ScanHistoryFragment.kt</span></div><h1>ScanHistoryFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.jetpack.scan.history

import android.os.Bundle
import android.view.MenuItem
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import androidx.viewpager2.adapter.FragmentStateAdapter
import com.google.android.material.tabs.TabLayout.OnTabSelectedListener
import com.google.android.material.tabs.TabLayout.Tab
import com.google.android.material.tabs.TabLayoutMediator
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.FullscreenErrorWithRetryBinding
import org.wordpress.android.databinding.ScanHistoryFragmentBinding
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.ui.ScrollableViewInitializedListener
import org.wordpress.android.ui.jetpack.scan.history.ScanHistoryViewModel.TabUiState
import org.wordpress.android.ui.jetpack.scan.history.ScanHistoryViewModel.UiState.ContentUiState
import org.wordpress.android.ui.jetpack.scan.history.ScanHistoryViewModel.UiState.ErrorUiState
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.LocaleManagerWrapper
import javax.inject.Inject

<span class="nc" id="L26">class ScanHistoryFragment : Fragment(R.layout.scan_history_fragment), ScrollableViewInitializedListener {</span>
<span class="nc bnc" id="L27" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L28" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L29" title="All 2 branches missed.">    @Inject lateinit var localeManagerWrapper: LocaleManagerWrapper</span>
    private lateinit var viewModel: ScanHistoryViewModel
    private var binding: ScanHistoryFragmentBinding? = null

<span class="nc" id="L33">    private val onTabSelectedListener = object : OnTabSelectedListener {</span>
        override fun onTabReselected(tab: Tab) {
<span class="nc" id="L35">        }</span>

        override fun onTabUnselected(tab: Tab) {
<span class="nc" id="L38">        }</span>

        override fun onTabSelected(tab: Tab) {
<span class="nc bnc" id="L41" title="All 2 branches missed.">            viewModel.onTabSelected(tab.position)</span>
<span class="nc" id="L42">        }</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L46">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L47">        binding = ScanHistoryFragmentBinding.bind(view).apply {</span>
<span class="nc" id="L48">            initDagger()</span>
<span class="nc" id="L49">            initViewModel(getSite(savedInstanceState))</span>
<span class="nc" id="L50">            initToolbar()</span>
<span class="nc" id="L51">        }</span>
<span class="nc" id="L52">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L55">        super.onDestroyView()</span>
<span class="nc" id="L56">        binding = null</span>
<span class="nc" id="L57">    }</span>

    private fun initDagger() {
<span class="nc bnc" id="L60" title="All 4 branches missed.">        (requireActivity().application as WordPress).component()?.inject(this)</span>
<span class="nc" id="L61">    }</span>

    private fun ScanHistoryFragmentBinding.initViewModel(site: SiteModel) {
<span class="nc" id="L64">        viewModel = ViewModelProvider(this@ScanHistoryFragment, viewModelFactory).get(ScanHistoryViewModel::class.java)</span>
<span class="nc" id="L65">        setupObservers()</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        viewModel.start(site)</span>
<span class="nc" id="L67">    }</span>

    private fun ScanHistoryFragmentBinding.setupObservers() {
<span class="nc bnc" id="L70" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner, { uiState -&gt;</span>
<span class="nc" id="L71">            uiHelpers.updateVisibility(tabLayout, uiState.contentVisible)</span>
<span class="nc" id="L72">            uiHelpers.updateVisibility(viewPager, uiState.contentVisible)</span>
<span class="nc" id="L73">            uiHelpers.updateVisibility(fullscreenErrorWithRetry.errorLayout, uiState.errorVisible)</span>
<span class="nc" id="L74">            when (uiState) {</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                is ContentUiState -&gt; {</span>
<span class="nc" id="L76">                    updateTabs(uiState.tabs)</span>
                }
<span class="nc bnc" id="L78" title="All 2 branches missed.">                is ErrorUiState -&gt; fullscreenErrorWithRetry.updateErrorLayout(uiState)</span>
            }
<span class="nc" id="L80">        })</span>
<span class="nc" id="L81">    }</span>

    private fun FullscreenErrorWithRetryBinding.updateErrorLayout(uiState: ErrorUiState) {
<span class="nc" id="L84">        uiHelpers.setTextOrHide(errorTitle, uiState.title)</span>
<span class="nc" id="L85">        uiHelpers.updateVisibility(errorImage, true)</span>
<span class="nc" id="L86">        errorImage.setImageResource(uiState.img)</span>
<span class="nc" id="L87">        errorRetry.setOnClickListener { uiState.retry.invoke() }</span>
<span class="nc" id="L88">    }</span>

    private fun ScanHistoryFragmentBinding.updateTabs(list: List&lt;TabUiState&gt;) {
<span class="nc" id="L91">        val adapter = ScanHistoryTabAdapter(list, this@ScanHistoryFragment)</span>
<span class="nc" id="L92">        viewPager.adapter = adapter</span>

<span class="nc" id="L94">        TabLayoutMediator(tabLayout, viewPager) { tab, position -&gt;</span>
<span class="nc" id="L95">            tab.text = uiHelpers.getTextOfUiString(requireContext(), list[position].label)</span>
<span class="nc" id="L96">                    .toString()</span>
<span class="nc" id="L97">                    .toUpperCase(localeManagerWrapper.getLocale())</span>
<span class="nc" id="L98">        }.attach()</span>
<span class="nc" id="L99">        tabLayout.addOnTabSelectedListener(onTabSelectedListener)</span>
<span class="nc" id="L100">    }</span>

    private fun ScanHistoryFragmentBinding.initToolbar() {
<span class="nc" id="L103">        setHasOptionsMenu(true)</span>
<span class="nc" id="L104">        val activity = (requireActivity() as AppCompatActivity)</span>
<span class="nc" id="L105">        toolbarMain.title = getString(R.string.scan_history)</span>
<span class="nc" id="L106">        activity.setSupportActionBar(toolbarMain)</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        activity.supportActionBar?.let {</span>
<span class="nc" id="L108">            it.setHomeButtonEnabled(true)</span>
<span class="nc" id="L109">            it.setDisplayHomeAsUpEnabled(true)</span>
<span class="nc" id="L110">        }</span>
<span class="nc" id="L111">    }</span>

    private fun getSite(savedInstanceState: Bundle?): SiteModel {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        return if (savedInstanceState == null) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            requireActivity().intent.getSerializableExtra(WordPress.SITE) as SiteModel</span>
        } else {
<span class="nc bnc" id="L117" title="All 2 branches missed.">            savedInstanceState.getSerializable(WordPress.SITE) as SiteModel</span>
        }
    }

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc bnc" id="L122" title="All 2 branches missed.">        outState.putSerializable(WordPress.SITE, viewModel.site)</span>
<span class="nc" id="L123">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L124">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (item.itemId == android.R.id.home) {</span>
<span class="nc" id="L128">            requireActivity().onBackPressed()</span>
<span class="nc" id="L129">            return true</span>
        }
<span class="nc" id="L131">        return super.onOptionsItemSelected(item)</span>
    }

<span class="nc" id="L134">    private class ScanHistoryTabAdapter(</span>
<span class="nc" id="L135">        private val items: List&lt;TabUiState&gt;,</span>
        parent: Fragment
<span class="nc" id="L137">    ) : FragmentStateAdapter(parent) {</span>
<span class="nc" id="L138">        override fun getItemCount(): Int = items.count()</span>

<span class="nc" id="L140">        override fun createFragment(position: Int): Fragment = ScanHistoryListFragment.newInstance(items[position].type)</span>
    }

    override fun onScrollableViewInitialized(viewId: Int) {
<span class="nc bnc" id="L144" title="All 4 branches missed.">        binding?.appbarMain?.liftOnScrollTargetViewId = viewId</span>
<span class="nc" id="L145">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>