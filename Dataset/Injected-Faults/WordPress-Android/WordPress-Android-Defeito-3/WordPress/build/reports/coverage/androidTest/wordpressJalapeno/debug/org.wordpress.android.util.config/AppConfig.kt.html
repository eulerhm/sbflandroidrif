<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppConfig.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util.config</a> &gt; <span class="el_source">AppConfig.kt</span></div><h1>AppConfig.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.util.config

import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.util.config.AppConfig.FeatureState.BuildConfigValue
import org.wordpress.android.util.config.AppConfig.FeatureState.ManuallyOverriden
import org.wordpress.android.util.config.ExperimentConfig.Variant
import javax.inject.Inject
import javax.inject.Singleton

<span class="fc" id="L11">@Singleton</span>
class AppConfig
<span class="fc" id="L13">@Inject constructor(</span>
<span class="fc" id="L14">    private val remoteConfig: RemoteConfig,</span>
<span class="fc" id="L15">    private val analyticsTracker: AnalyticsTrackerWrapper,</span>
<span class="fc" id="L16">    private val manualFeatureConfig: ManualFeatureConfig</span>
) {
    /**
     * We need to keep the value of an already loaded feature flag to make sure the value is not changed while using the app.
     * We should only reload the flags when the application is created.
     */
<span class="fc" id="L22">    private val experimentValues = mutableMapOf&lt;String, String&gt;()</span>
<span class="fc" id="L23">    private val remoteConfigCheck = RemoteConfigCheck(this)</span>

    /**
     * This method initialized the config
     */
    fun init() {
<span class="fc" id="L29">        remoteConfig.init()</span>
<span class="fc" id="L30">        remoteConfigCheck.checkRemoteFields()</span>
<span class="fc" id="L31">    }</span>

    /**
     * This method triggers refresh of remote configuration.
     */
    fun refresh() {
<span class="nc" id="L37">        remoteConfig.refresh()</span>
<span class="nc" id="L38">    }</span>

    /**
     * Get the enabled state of a feature flag. If the flag is enabled in the BuildConfig file, it overrides the
     * remote value. The correct approach is to disable a feature flag for a release version and only enable it remotely.
     * Once the feature is ready to be fully released, we can enable the BuildConfig value.
     * @param feature feature which we're checking remotely
     */
    fun isEnabled(feature: FeatureConfig): Boolean {
<span class="fc" id="L47">        return featureState(feature).isEnabled</span>
    }

    /**
     * Get the enabled flag and the source where it came from.
     * @param feature feature we're checking remotely
     */
    fun featureState(feature: FeatureConfig): FeatureState {
<span class="fc" id="L55">        return buildFeatureState(feature)</span>
    }

    private fun buildFeatureState(feature: FeatureConfig): FeatureState {
<span class="fc" id="L59">        return when {</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">            manualFeatureConfig.hasManualSetup(feature) -&gt; {</span>
<span class="nc" id="L61">                ManuallyOverriden(manualFeatureConfig.isManuallyEnabled(feature))</span>
            }
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">            feature.remoteField == null -&gt; {</span>
<span class="nc" id="L64">                BuildConfigValue(feature.buildConfigValue)</span>
            }
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">            feature.buildConfigValue -&gt; {</span>
<span class="nc" id="L67">                BuildConfigValue(feature.buildConfigValue)</span>
            }
            else -&gt; {
<span class="fc" id="L70">                remoteConfig.getFeatureState(feature.remoteField)</span>
            }
        }
    }

    /**
     * Get the currently selected variant for a given experiment. This function returns null if there is no variant
     * for the current user (and the user is in the control group).
     */
    fun getCurrentVariant(experiment: ExperimentConfig): Variant {
<span class="nc" id="L80">        val value = experimentValues.getOrPut(experiment.remoteField) {</span>
<span class="nc" id="L81">            val remoteValue = remoteConfig.getString(experiment.remoteField)</span>
<span class="nc" id="L82">            analyticsTracker.track(</span>
<span class="nc" id="L83">                    Stat.EXPERIMENT_VARIANT_SET,</span>
<span class="nc" id="L84">                    mapOf(experiment.remoteField to remoteValue)</span>
            )
<span class="nc" id="L86">            remoteValue</span>
        }
<span class="nc bnc" id="L88" title="All 6 branches missed.">        return experiment.variants.find { it.value == value }</span>
<span class="nc" id="L89">                ?: throw IllegalArgumentException(&quot;Remote variant does not match local value: $value&quot;)</span>
    }

<span class="pc" id="L92">    sealed class FeatureState(open val isEnabled: Boolean, val name: String) {</span>
<span class="nc" id="L93">        data class ManuallyOverriden(override val isEnabled: Boolean) : FeatureState(isEnabled, &quot;manually_overriden&quot;)</span>
<span class="nc" id="L94">        data class BuildConfigValue(override val isEnabled: Boolean) : FeatureState(isEnabled, &quot;build_config_value&quot;)</span>
<span class="nc" id="L95">        data class RemoteValue(override val isEnabled: Boolean) : FeatureState(isEnabled, &quot;remote_source_value&quot;)</span>
<span class="nc" id="L96">        data class StaticValue(override val isEnabled: Boolean) : FeatureState(isEnabled, &quot;static_source_value&quot;)</span>
<span class="fc" id="L97">        data class DefaultValue(override val isEnabled: Boolean) : FeatureState(isEnabled, &quot;default_source_value&quot;)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>