<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocaleManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">LocaleManager.java</span></div><h1>LocaleManager.java</h1><pre class="source lang-java linenums">package org.wordpress.android.util;

import android.annotation.SuppressLint;
import android.content.Context;
import android.content.SharedPreferences;
import android.content.res.Configuration;
import android.content.res.Resources;
import android.os.Build;
import android.preference.PreferenceManager;
import android.text.TextUtils;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;

import java.text.Collator;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.Locale;
import java.util.Map;
import java.util.regex.Pattern;

import kotlin.Triple;

/**
 * Helper class for working with localized strings. Ensures updates to the users
 * selected language is properly saved and resources appropriately updated for the
 * android version.
 */
<span class="nc" id="L30">public class LocaleManager {</span>
    /**
     * Key used for saving the language selection to shared preferences.
     */
    private static final String LANGUAGE_KEY = &quot;language-pref&quot;;

    /**
     * Pattern to split a language string (to parse the language and region values).
     */
<span class="nc" id="L39">    private static Pattern languageSplitter = Pattern.compile(&quot;_&quot;);</span>

    /**
     * Activate the locale associated with the provided context.
     *
     * @param context The current context.
     */
    public static Context setLocale(Context context) {
<span class="nc" id="L47">        return updateResources(context, getLanguage(context));</span>
    }

    /**
     * Apply locale to the provided configuration.
     *
     * @param context current context used to access Shared Preferences.
     * @param configuration configuration that the locale should be applied to.
     */
    public static Configuration updatedConfigLocale(Context context, Configuration configuration) {
<span class="nc" id="L57">        Locale locale = languageLocale(getLanguage(context));</span>
<span class="nc" id="L58">        Locale.setDefault(locale);</span>

        // NOTE: Earlier versions of Android require both of these to be set, otherwise
        // RTL may not be implemented properly.
<span class="nc" id="L62">        configuration.setLocale(locale);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.N_MR1) {</span>
<span class="nc" id="L64">            configuration.locale = locale;</span>
        }

<span class="nc" id="L67">        return configuration;</span>
    }

    /**
     * Change the active locale to the language provided. Save the updated language
     * settings to sharedPreferences.
     *
     * @param context  The current context
     * @param language The 2-letter language code (example &quot;en&quot;) to switch to
     */
    public static void setNewLocale(Context context, String language) {
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (isSameLanguage(language)) {</span>
<span class="nc" id="L79">            return;</span>
        }
<span class="nc" id="L81">        saveLanguageToPref(context, language);</span>
<span class="nc" id="L82">        updateResources(context, language);</span>
<span class="nc" id="L83">    }</span>

    /**
     * Compare the language for the current context with another language.
     *
     * @param language The language to compare
     * @return True if the languages are the same, else false
     */
    public static boolean isSameLanguage(@NonNull String language) {
<span class="nc" id="L92">        Locale newLocale = languageLocale(language);</span>
<span class="nc" id="L93">        return Locale.getDefault().toString().equals(newLocale.toString());</span>
    }

    /**
     * If the user has selected a language other than the device default, return that
     * language code, else just return the device default language code.
     *
     * @return The 2-letter language code (example &quot;en&quot;)
     */
    public static String getLanguage(Context context) {
<span class="nc" id="L103">        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span>
<span class="nc" id="L104">        return prefs.getString(LANGUAGE_KEY, LanguageUtils.getCurrentDeviceLanguageCode());</span>
    }

    /**
     * Convert the device language code (codes defined by ISO 639-1) to a Language ID.
     * Language IDs, used only by WordPress, are integer values that map to a language code.
     * http://bit.ly/2H7gksN
     **/
    public static @NonNull String getLanguageWordPressId(Context context) {
<span class="nc" id="L113">        final String deviceLanguageCode = LanguageUtils.getPatchedCurrentDeviceLanguage(context);</span>

<span class="nc" id="L115">        Map&lt;String, String&gt; languageCodeToID = LocaleManager.generateLanguageMap(context);</span>
<span class="nc" id="L116">        String langID = null;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (languageCodeToID.containsKey(deviceLanguageCode)) {</span>
<span class="nc" id="L118">            langID = languageCodeToID.get(deviceLanguageCode);</span>
        } else {
<span class="nc" id="L120">            int pos = deviceLanguageCode.indexOf(&quot;_&quot;);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (pos &gt; -1) {</span>
<span class="nc" id="L122">                String newLang = deviceLanguageCode.substring(0, pos);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (languageCodeToID.containsKey(newLang)) {</span>
<span class="nc" id="L124">                    langID = languageCodeToID.get(newLang);</span>
                }
            }
        }

<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (langID == null) {</span>
            // fallback to device language code if there is no match
<span class="nc" id="L131">            langID = deviceLanguageCode;</span>
        }
<span class="nc" id="L133">        return langID;</span>
    }

    /**
     * Save the updated language to SharedPreferences.
     * Use commit() instead of apply() to ensure the language preference is saved instantly
     * as the app may be restarted immediately.
     *
     * @param context  The current context
     * @param language The 2-letter language code (example &quot;en&quot;)
     */
    @SuppressLint(&quot;ApplySharedPref&quot;)
    private static void saveLanguageToPref(Context context, String language) {
<span class="nc" id="L146">        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span>
<span class="nc" id="L147">        prefs.edit().putString(LANGUAGE_KEY, language).commit();</span>
<span class="nc" id="L148">    }</span>

    /**
     * Update resources for the current session.
     *
     * @param context  The current active context
     * @param language The 2-letter language code (example &quot;en&quot;)
     * @return The modified context containing the updated localized resources
     */
    private static Context updateResources(Context context, String language) {
<span class="nc" id="L158">        Locale locale = languageLocale(language);</span>
<span class="nc" id="L159">        Locale.setDefault(locale);</span>

<span class="nc" id="L161">        Resources res = context.getResources();</span>
<span class="nc" id="L162">        Configuration config = new Configuration(res.getConfiguration());</span>

        // NOTE: Earlier versions of Android require both of these to be set, otherwise
        // RTL may not be implemented properly.
<span class="nc" id="L166">        config.setLocale(locale);</span>
<span class="nc" id="L167">        context = context.createConfigurationContext(config);</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.N_MR1) {</span>
<span class="nc" id="L170">            config.locale = locale;</span>
<span class="nc" id="L171">            res.updateConfiguration(config, res.getDisplayMetrics());</span>
        }

<span class="nc" id="L174">        return context;</span>
    }

    /**
     * Method gets around a bug in the java.util.Formatter for API 7.x as detailed here
     * [https://bugs.openjdk.java.net/browse/JDK-8167567]. Any strings that contain
     * locale-specific grouping separators should use:
     * &lt;code&gt;
     * String.format(LocaleManager.getSafeLocale(context), baseString, val)
     * &lt;/code&gt;
     * &lt;p&gt;
     * An example of a string that contains locale-specific grouping separators:
     * &lt;code&gt;
     * &lt;string name=&quot;test&quot;&gt;%,d likes&lt;/string&gt;
     * &lt;/code&gt;
     */
    public static Locale getSafeLocale(@Nullable Context context) {
        Locale baseLocale;
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (context == null) {</span>
<span class="nc" id="L193">            baseLocale = Locale.getDefault();</span>
        } else {
<span class="nc" id="L195">            Configuration config = context.getResources().getConfiguration();</span>
<span class="nc" id="L196">            baseLocale = config.getLocales().get(0);</span>
        }

<span class="nc" id="L199">        return languageLocale(baseLocale.getLanguage());</span>
    }

    /**
     * Gets a locale for the given language code.
     *
     * @param languageCode The language code (example &quot;en&quot; or &quot;es-US&quot;). If null or empty will return
     *                     the current default locale.
     */
    public static Locale languageLocale(@Nullable String languageCode) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (TextUtils.isEmpty(languageCode)) {</span>
<span class="nc" id="L210">            return Locale.getDefault();</span>
        }
        // Attempt to parse language and region codes.
<span class="nc" id="L213">        String[] opts = languageSplitter.split(languageCode, 0);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (opts.length &gt; 1) {</span>
<span class="nc" id="L215">            return new Locale(opts[0], opts[1]);</span>
        } else {
<span class="nc" id="L217">            return new Locale(opts[0]);</span>
        }
    }

    /**
     * Creates a map from language codes to WordPress language IDs.
     */
    public static Map&lt;String, String&gt; generateLanguageMap(Context context) {
<span class="nc" id="L225">        String[] languageIds = context.getResources().getStringArray(org.wordpress.android.R.array.lang_ids);</span>
<span class="nc" id="L226">        String[] languageCodes = context.getResources().getStringArray(org.wordpress.android.R.array.language_codes);</span>

<span class="nc" id="L228">        Map&lt;String, String&gt; languageMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L229" title="All 4 branches missed.">        for (int i = 0; i &lt; languageIds.length &amp;&amp; i &lt; languageCodes.length; ++i) {</span>
<span class="nc" id="L230">            languageMap.put(languageCodes[i], languageIds[i]);</span>
        }

<span class="nc" id="L233">        return languageMap;</span>
    }

    /**
     * Generates display strings for given language codes. Used as entries in language preference.
     */
    @Nullable
    public static Triple&lt;String[], String[], String[]&gt; createSortedLanguageDisplayStrings(CharSequence[] languageCodes,
                                                                                Locale locale) {
<span class="nc bnc" id="L242" title="All 4 branches missed.">        if (languageCodes == null || languageCodes.length &lt; 1) {</span>
<span class="nc" id="L243">            return null;</span>
        }

<span class="nc" id="L246">        ArrayList&lt;String&gt; entryStrings = new ArrayList&lt;&gt;(languageCodes.length);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        for (int i = 0; i &lt; languageCodes.length; ++i) {</span>
            // &quot;__&quot; is used to sort the language code with the display string so both arrays are sorted at the same time
<span class="nc" id="L249">            entryStrings.add(i, StringUtils.capitalize(</span>
<span class="nc" id="L250">                    getLanguageString(languageCodes[i].toString(), locale)) + &quot;__&quot; + languageCodes[i]);</span>
        }

<span class="nc" id="L253">        Collections.sort(entryStrings, Collator.getInstance(locale));</span>

<span class="nc" id="L255">        String[] sortedEntries = new String[languageCodes.length];</span>
<span class="nc" id="L256">        String[] sortedValues = new String[languageCodes.length];</span>
<span class="nc" id="L257">        String[] detailStrings = new String[languageCodes.length];</span>

<span class="nc bnc" id="L259" title="All 2 branches missed.">        for (int i = 0; i &lt; entryStrings.size(); ++i) {</span>
            // now, we can split the sorted array to extract the display string and the language code
<span class="nc" id="L261">            String[] split = entryStrings.get(i).split(&quot;__&quot;);</span>
<span class="nc" id="L262">            sortedEntries[i] = split[0];</span>
<span class="nc" id="L263">            sortedValues[i] = split[1];</span>
<span class="nc" id="L264">            detailStrings[i] =</span>
<span class="nc" id="L265">                    StringUtils.capitalize(getLanguageString(sortedValues[i], languageLocale(sortedValues[i])));</span>
        }

<span class="nc" id="L268">        return new Triple&lt;&gt;(sortedEntries, sortedValues, detailStrings);</span>
    }

    /**
     * Generates detail display strings in the currently selected locale. Used as detail text
     * in language preference dialog.
     */
    @Nullable
    public static String[] createLanguageDetailDisplayStrings(CharSequence[] languageCodes) {
<span class="nc bnc" id="L277" title="All 4 branches missed.">        if (languageCodes == null || languageCodes.length &lt; 1) {</span>
<span class="nc" id="L278">            return null;</span>
        }

<span class="nc" id="L281">        String[] detailStrings = new String[languageCodes.length];</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        for (int i = 0; i &lt; languageCodes.length; ++i) {</span>
<span class="nc" id="L283">            detailStrings[i] = StringUtils.capitalize(getLanguageString(</span>
<span class="nc" id="L284">                    languageCodes[i].toString(), languageLocale(languageCodes[i].toString())));</span>
        }

<span class="nc" id="L287">        return detailStrings;</span>
    }

    /**
     * Return a non-null display string for a given language code.
     */
    public static String getLanguageString(String languageCode, Locale displayLocale) {
<span class="nc bnc" id="L294" title="All 6 branches missed.">        if (languageCode == null || languageCode.length() &lt; 2 || languageCode.length() &gt; 6) {</span>
<span class="nc" id="L295">            return &quot;&quot;;</span>
        }

<span class="nc" id="L298">        Locale languageLocale = languageLocale(languageCode);</span>
<span class="nc" id="L299">        String displayLanguage = StringUtils.capitalize(languageLocale.getDisplayLanguage(displayLocale));</span>
<span class="nc" id="L300">        String displayCountry = languageLocale.getDisplayCountry(displayLocale);</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (!TextUtils.isEmpty(displayCountry)) {</span>
<span class="nc" id="L303">            return displayLanguage + &quot; (&quot; + displayCountry + &quot;)&quot;;</span>
        }
<span class="nc" id="L305">        return displayLanguage;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>