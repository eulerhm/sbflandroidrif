<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostsListActivity.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PostsListActivity.kt</span></div><h1>PostsListActivity.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import android.app.Activity
import android.app.ProgressDialog
import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.view.HapticFeedbackConstants
import android.view.Menu
import android.view.MenuItem
import android.view.MenuItem.OnActionExpandListener
import android.view.View
import android.widget.AdapterView
import android.widget.Toast
import androidx.annotation.DrawableRes
import androidx.appcompat.widget.SearchView
import androidx.appcompat.widget.Toolbar
import androidx.core.content.ContextCompat
import androidx.lifecycle.ViewModelProvider
import androidx.viewpager.widget.ViewPager.OnPageChangeListener
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.PostListActivityBinding
import org.wordpress.android.editor.gutenberg.GutenbergEditorFragment
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.model.LocalOrRemoteId.LocalId
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.push.NotificationType
import org.wordpress.android.push.NotificationsProcessingService.ARG_NOTIFICATION_TYPE
import org.wordpress.android.ui.ActivityId
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.LocaleAwareActivity
import org.wordpress.android.ui.PagePostCreationSourcesDetail.STORY_FROM_POSTS_LIST
import org.wordpress.android.ui.RequestCodes
import org.wordpress.android.ui.ScrollableViewInitializedListener
import org.wordpress.android.ui.bloggingreminders.BloggingReminderUtils.observeBottomSheet
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersViewModel
import org.wordpress.android.ui.main.MainActionListItem.ActionType
import org.wordpress.android.ui.notifications.SystemNotificationsTracker
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.photopicker.MediaPickerLauncher
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogNegativeClickInterface
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogOnDismissByOutsideTouchInterface
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogPositiveClickInterface
import org.wordpress.android.ui.posts.EditPostSettingsFragment.EditPostActivityHook
import org.wordpress.android.ui.posts.PostListType.SEARCH
import org.wordpress.android.ui.posts.PrepublishingBottomSheetFragment.Companion.newInstance
import org.wordpress.android.ui.posts.adapters.AuthorSelectionAdapter
import org.wordpress.android.ui.posts.prepublishing.PrepublishingBottomSheetListener
import org.wordpress.android.ui.stories.StoriesMediaPickerResultHandler
import org.wordpress.android.ui.uploads.UploadActionUseCase
import org.wordpress.android.ui.uploads.UploadUtilsWrapper
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.SnackbarItem
import org.wordpress.android.util.SnackbarSequencer
import org.wordpress.android.util.extensions.redirectContextClickToLongPressListener
import org.wordpress.android.util.extensions.setLiftOnScrollTargetViewIdAndRequestLayout
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.viewmodel.posts.PostListCreateMenuViewModel
import javax.inject.Inject

const val EXTRA_TARGET_POST_LOCAL_ID = &quot;targetPostLocalId&quot;
const val STATE_KEY_PREVIEW_STATE = &quot;stateKeyPreviewState&quot;
const val STATE_KEY_BOTTOMSHEET_POST_ID = &quot;stateKeyBottomSheetPostId&quot;

<span class="nc" id="L70">class PostsListActivity : LocaleAwareActivity(),</span>
        EditPostActivityHook,
        PrepublishingBottomSheetListener,
        BasicDialogPositiveClickInterface,
        BasicDialogNegativeClickInterface,
        BasicDialogOnDismissByOutsideTouchInterface,
        ScrollableViewInitializedListener {
<span class="nc bnc" id="L77" title="All 2 branches missed.">    @Inject internal lateinit var siteStore: SiteStore</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">    @Inject internal lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">    @Inject internal lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">    @Inject internal lateinit var remotePreviewLogicHelper: RemotePreviewLogicHelper</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">    @Inject internal lateinit var previewStateHelper: PreviewStateHelper</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">    @Inject internal lateinit var progressDialogHelper: ProgressDialogHelper</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    @Inject internal lateinit var dispatcher: Dispatcher</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">    @Inject internal lateinit var uploadActionUseCase: UploadActionUseCase</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">    @Inject internal lateinit var snackbarSequencer: SnackbarSequencer</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">    @Inject internal lateinit var uploadUtilsWrapper: UploadUtilsWrapper</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">    @Inject internal lateinit var systemNotificationTracker: SystemNotificationsTracker</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">    @Inject internal lateinit var editPostRepository: EditPostRepository</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">    @Inject internal lateinit var mediaPickerLauncher: MediaPickerLauncher</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">    @Inject internal lateinit var storiesMediaPickerResultHandler: StoriesMediaPickerResultHandler</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">    @Inject internal lateinit var bloggingRemindersViewModel: BloggingRemindersViewModel</span>

    private lateinit var site: SiteModel
    private lateinit var binding: PostListActivityBinding

<span class="nc bnc" id="L96" title="All 2 branches missed.">    override fun getSite() = site</span>
<span class="nc" id="L97">    override fun getEditPostRepository() = editPostRepository</span>

    private lateinit var viewModel: PostListMainViewModel
    private lateinit var postListCreateMenuViewModel: PostListCreateMenuViewModel

    private lateinit var postsPagerAdapter: PostsPagerAdapter
    private lateinit var searchActionButton: MenuItem
    private lateinit var toggleViewLayoutMenuItem: MenuItem

    private var restorePreviousSearch = false

    private var progressDialog: ProgressDialog? = null

<span class="nc" id="L110">    private var onPageChangeListener: OnPageChangeListener = object : OnPageChangeListener {</span>
<span class="nc" id="L111">        override fun onPageScrolled(position: Int, positionOffset: Float, positionOffsetPixels: Int) {}</span>

        override fun onPageSelected(position: Int) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">            viewModel.onTabChanged(position)</span>
<span class="nc" id="L115">        }</span>

<span class="nc" id="L117">        override fun onPageScrollStateChanged(state: Int) {}</span>
    }

    override fun onNewIntent(intent: Intent) {
<span class="nc" id="L121">        super.onNewIntent(intent)</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (!intent.hasExtra(WordPress.SITE)) {</span>
<span class="nc" id="L123">            AppLog.e(AppLog.T.POSTS, &quot;PostListActivity started without a site.&quot;)</span>
<span class="nc" id="L124">            finish()</span>
<span class="nc" id="L125">            return</span>
        }
<span class="nc" id="L127">        restartWhenSiteHasChanged(intent)</span>
<span class="nc" id="L128">        loadIntentData(intent)</span>
<span class="nc" id="L129">    }</span>

    private fun restartWhenSiteHasChanged(intent: Intent) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        val site = intent.getSerializableExtra(WordPress.SITE) as SiteModel</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">        if (site.id != this.site.id) {</span>
<span class="nc" id="L134">            finish()</span>
<span class="nc" id="L135">            startActivity(intent)</span>
<span class="nc" id="L136">            return</span>
        }
<span class="nc" id="L138">    }</span>

    public override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L141">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        (application as WordPress).component().inject(this)</span>
<span class="nc" id="L143">        with(PostListActivityBinding.inflate(layoutInflater)) {</span>
<span class="nc" id="L144">            setContentView(root)</span>
<span class="nc" id="L145">            binding = this</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">            site = if (savedInstanceState == null) {</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">                checkNotNull(intent.getSerializableExtra(WordPress.SITE) as? SiteModel) {</span>
<span class="nc" id="L149">                    &quot;SiteModel cannot be null, check the PendingIntent starting PostsListActivity&quot;</span>
                }
            } else {
<span class="nc" id="L152">                restorePreviousSearch = true</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                savedInstanceState.getSerializable(WordPress.SITE) as SiteModel</span>
            }

<span class="nc bnc" id="L156" title="All 2 branches missed.">            val initPreviewState = if (savedInstanceState == null) {</span>
<span class="nc" id="L157">                PostListRemotePreviewState.NONE</span>
            } else {
<span class="nc" id="L159">                PostListRemotePreviewState.fromInt(savedInstanceState.getInt(STATE_KEY_PREVIEW_STATE, 0))</span>
            }

<span class="nc bnc" id="L162" title="All 2 branches missed.">            val currentBottomSheetPostId = if (savedInstanceState == null) {</span>
<span class="nc" id="L163">                LocalId(0)</span>
            } else {
<span class="nc" id="L165">                LocalId(savedInstanceState.getInt(STATE_KEY_BOTTOMSHEET_POST_ID, 0))</span>
            }

<span class="nc" id="L168">            val actionsShownByDefault = intent.getBooleanExtra(ACTIONS_SHOWN_BY_DEFAULT, false)</span>
<span class="nc" id="L169">            val tabIndex = intent.getIntExtra(TAB_INDEX, PostListType.PUBLISHED.ordinal)</span>

<span class="nc" id="L171">            setupActionBar()</span>
<span class="nc" id="L172">            setupContent()</span>
<span class="nc" id="L173">            initViewModel(initPreviewState, currentBottomSheetPostId)</span>
<span class="nc" id="L174">            initBloggingReminders()</span>
<span class="nc" id="L175">            initCreateMenuViewModel(tabIndex, actionsShownByDefault)</span>
<span class="nc" id="L176">            loadIntentData(intent)</span>
<span class="nc" id="L177">        }</span>
<span class="nc" id="L178">    }</span>

    private fun setupActionBar() {
<span class="nc" id="L181">        val toolbar = findViewById&lt;Toolbar&gt;(R.id.toolbar)</span>
<span class="nc" id="L182">        setSupportActionBar(toolbar)</span>

<span class="nc" id="L184">        title = getString(R.string.my_site_btn_blog_posts)</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        supportActionBar?.setDisplayShowTitleEnabled(true)</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        supportActionBar?.setDisplayHomeAsUpEnabled(true)</span>
<span class="nc" id="L187">    }</span>

    private fun PostListActivityBinding.setupContent() {
<span class="nc" id="L190">        val authorSelectionAdapter = AuthorSelectionAdapter(this@PostsListActivity)</span>
<span class="nc" id="L191">        postListAuthorSelection.adapter = authorSelectionAdapter</span>

<span class="nc" id="L193">        postListAuthorSelection.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {</span>
<span class="nc" id="L194">            override fun onNothingSelected(parent: AdapterView&lt;*&gt;) {}</span>

            override fun onItemSelected(parent: AdapterView&lt;*&gt;, view: View?, position: Int, id: Long) {
<span class="nc bnc" id="L197" title="All 2 branches missed.">                viewModel.updateAuthorFilterSelection(id)</span>
<span class="nc" id="L198">            }</span>
        }

        // Just a safety measure - there shouldn't by any existing listeners since this method is called just once.
<span class="nc" id="L202">        postPager.clearOnPageChangeListeners()</span>

        // this method call needs to be below `clearOnPageChangeListeners` as it internally adds an OnPageChangeListener
<span class="nc" id="L205">        tabLayout.setupWithViewPager(postPager)</span>
<span class="nc" id="L206">        postPager.addOnPageChangeListener(onPageChangeListener)</span>
<span class="nc" id="L207">        fabButton.setOnClickListener {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            viewModel.fabClicked()</span>
<span class="nc" id="L209">        }</span>

<span class="nc" id="L211">        fabButton.setOnLongClickListener {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            viewModel.onFabLongPressed()</span>
<span class="nc" id="L213">            return@setOnLongClickListener true</span>
        }

<span class="nc" id="L216">        fabButton.redirectContextClickToLongPressListener()</span>

<span class="nc" id="L218">        fabTooltip.setOnClickListener {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            postListCreateMenuViewModel.onTooltipTapped()</span>
<span class="nc" id="L220">        }</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">        postsPagerAdapter = PostsPagerAdapter(POST_LIST_PAGES, site, supportFragmentManager)</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        postPager.adapter = postsPagerAdapter</span>
<span class="nc" id="L224">    }</span>

    private fun PostListActivityBinding.initCreateMenuViewModel(tabIndex: Int, actionsShownByDefault: Boolean) {
<span class="nc" id="L227">        postListCreateMenuViewModel = ViewModelProvider(this@PostsListActivity, viewModelFactory)</span>
<span class="nc" id="L228">                .get(PostListCreateMenuViewModel::class.java)</span>

<span class="nc bnc" id="L230" title="All 2 branches missed.">        postListCreateMenuViewModel.isBottomSheetShowing.observeEvent(this@PostsListActivity, { isBottomSheetShowing -&gt;</span>
<span class="nc" id="L231">            var createMenuFragment = supportFragmentManager.findFragmentByTag(PostListCreateMenuFragment.TAG)</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (createMenuFragment == null) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                if (isBottomSheetShowing) {</span>
<span class="nc" id="L234">                    createMenuFragment = PostListCreateMenuFragment.newInstance()</span>
<span class="nc" id="L235">                    createMenuFragment.show(supportFragmentManager, PostListCreateMenuFragment.TAG)</span>
                }
            } else {
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (!isBottomSheetShowing) {</span>
<span class="nc" id="L239">                    createMenuFragment as PostListCreateMenuFragment</span>
<span class="nc" id="L240">                    createMenuFragment.dismiss()</span>
                }
            }
<span class="nc" id="L243">        })</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">        postListCreateMenuViewModel.fabUiState.observe(this@PostsListActivity, { fabUiState -&gt;</span>
<span class="nc" id="L246">            val message = resources.getString(fabUiState.CreateContentMessageId)</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (fabUiState.isFabTooltipVisible) {</span>
<span class="nc" id="L249">                fabTooltip.setMessage(message)</span>
<span class="nc" id="L250">                fabTooltip.show()</span>
            } else {
<span class="nc" id="L252">                fabTooltip.hide()</span>
            }

<span class="nc" id="L255">            fabButton.contentDescription = message</span>
<span class="nc" id="L256">        })</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">        postListCreateMenuViewModel.createAction.observe(this@PostsListActivity, { createAction -&gt;</span>
<span class="nc bnc" id="L259" title="All 8 branches missed.">            when (createAction) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                ActionType.CREATE_NEW_POST -&gt; viewModel.newPost()</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                ActionType.CREATE_NEW_STORY -&gt; viewModel.newStoryPost()</span>
<span class="nc" id="L262">                ActionType.CREATE_NEW_PAGE -&gt; Unit</span>
<span class="nc" id="L263">                ActionType.NO_ACTION -&gt; Unit</span>
<span class="nc" id="L264">                null -&gt; Unit</span>
            }
<span class="nc" id="L266">        })</span>

        // Notification opens in Drafts tab
<span class="nc bnc" id="L269" title="All 2 branches missed.">        tabLayout.getTabAt(tabIndex)?.select()</span>

<span class="nc bnc" id="L271" title="All 4 branches missed.">        postListCreateMenuViewModel.start(site, actionsShownByDefault)</span>
<span class="nc" id="L272">    }</span>

    private fun PostListActivityBinding.initViewModel(
        initPreviewState: PostListRemotePreviewState,
        currentBottomSheetPostId: LocalId
    ) {
<span class="nc" id="L278">        viewModel = ViewModelProvider(this@PostsListActivity, viewModelFactory).get(PostListMainViewModel::class.java)</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">        viewModel.start(site, initPreviewState, currentBottomSheetPostId, editPostRepository, this@PostsListActivity)</span>

<span class="nc bnc" id="L281" title="All 2 branches missed.">        viewModel.viewState.observe(this@PostsListActivity, { state -&gt;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">            state?.let {</span>
<span class="nc" id="L283">                loadViewState(state)</span>
<span class="nc" id="L284">            }</span>
<span class="nc" id="L285">        })</span>

<span class="nc bnc" id="L287" title="All 2 branches missed.">        viewModel.postListAction.observe(this@PostsListActivity, { postListAction -&gt;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">            postListAction?.let { action -&gt;</span>
<span class="nc" id="L289">                handlePostListAction(</span>
<span class="nc" id="L290">                        this@PostsListActivity,</span>
<span class="nc" id="L291">                        action,</span>
<span class="nc" id="L292">                        remotePreviewLogicHelper,</span>
<span class="nc" id="L293">                        previewStateHelper,</span>
<span class="nc" id="L294">                        mediaPickerLauncher</span>
                )
<span class="nc" id="L296">            }</span>
<span class="nc" id="L297">        })</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        viewModel.selectTab.observe(this@PostsListActivity, { tabIndex -&gt;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            tabIndex?.let {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                tabLayout.getTabAt(tabIndex)?.select()</span>
<span class="nc" id="L301">            }</span>
<span class="nc" id="L302">        })</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        viewModel.scrollToLocalPostId.observe(this@PostsListActivity, { targetLocalPostId -&gt;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            targetLocalPostId?.let {</span>
<span class="nc bnc" id="L305" title="All 4 branches missed.">                postsPagerAdapter.getItemAtPosition(postPager.currentItem)?.scrollToTargetPost(targetLocalPostId)</span>
<span class="nc" id="L306">            }</span>
<span class="nc" id="L307">        })</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        viewModel.snackBarMessage.observe(this@PostsListActivity, {</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">            it?.let { snackBarHolder -&gt; showSnackBar(snackBarHolder) }</span>
<span class="nc" id="L310">        })</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        viewModel.toastMessage.observe(this@PostsListActivity, {</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            it?.show(this@PostsListActivity)</span>
<span class="nc" id="L313">        })</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">        viewModel.previewState.observe(this@PostsListActivity, {</span>
<span class="nc" id="L315">            progressDialog = progressDialogHelper.updateProgressDialogState(</span>
<span class="nc" id="L316">                    this@PostsListActivity,</span>
<span class="nc" id="L317">                    progressDialog,</span>
<span class="nc" id="L318">                    it.progressDialogUiState,</span>
<span class="nc" id="L319">                    uiHelpers</span>
            )
<span class="nc" id="L321">        })</span>
<span class="nc" id="L322">        setupActions()</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        viewModel.openPrepublishingBottomSheet.observeEvent(this@PostsListActivity, {</span>
<span class="nc" id="L324">            val fragment = supportFragmentManager.findFragmentByTag(PrepublishingBottomSheetFragment.TAG)</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            if (fragment == null) {</span>
<span class="nc" id="L326">                val prepublishingFragment = newInstance(</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                        site = site,</span>
<span class="nc" id="L328">                        isPage = editPostRepository.isPage,</span>
<span class="nc" id="L329">                        isStoryPost = false</span>
                )
<span class="nc" id="L331">                prepublishingFragment.show(supportFragmentManager, PrepublishingBottomSheetFragment.TAG)</span>
            }
<span class="nc" id="L333">        })</span>

<span class="nc" id="L335">        setupFabEvents()</span>
<span class="nc" id="L336">    }</span>

    private fun initBloggingReminders() {
<span class="nc" id="L339">        bloggingRemindersViewModel = ViewModelProvider(</span>
<span class="nc" id="L340">                this,</span>
<span class="nc" id="L341">                viewModelFactory</span>
<span class="nc" id="L342">        ).get(BloggingRemindersViewModel::class.java)</span>

<span class="nc" id="L344">        observeBottomSheet(</span>
<span class="nc" id="L345">                bloggingRemindersViewModel.isBottomSheetShowing,</span>
<span class="nc" id="L346">                this,</span>
<span class="nc" id="L347">                BLOGGING_REMINDERS_FRAGMENT_TAG,</span>
                {
<span class="nc bnc" id="L349" title="All 2 branches missed.">                    if (!this.isFinishing) {</span>
<span class="nc" id="L350">                        this.supportFragmentManager</span>
                    } else {
<span class="nc" id="L352">                        null</span>
                    }
                }
        )
<span class="nc" id="L356">    }</span>

    private fun setupActions() {
<span class="nc bnc" id="L359" title="All 2 branches missed.">        viewModel.dialogAction.observe(this@PostsListActivity, {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            it?.show(this@PostsListActivity, supportFragmentManager, uiHelpers)</span>
<span class="nc" id="L361">        })</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">        viewModel.postUploadAction.observe(this@PostsListActivity, {</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">            it?.let { uploadAction -&gt;</span>
<span class="nc" id="L364">                handleUploadAction(</span>
<span class="nc" id="L365">                        uploadAction,</span>
<span class="nc" id="L366">                        this@PostsListActivity,</span>
<span class="nc" id="L367">                        findViewById(R.id.coordinator),</span>
<span class="nc" id="L368">                        uploadActionUseCase,</span>
<span class="nc" id="L369">                        uploadUtilsWrapper</span>
                ) { isFirstTimePublishing -&gt;
<span class="nc bnc" id="L371" title="All 2 branches missed.">                    bloggingRemindersViewModel.onPublishingPost(site.id, isFirstTimePublishing)</span>
<span class="nc" id="L372">                }</span>
<span class="nc" id="L373">            }</span>
<span class="nc" id="L374">        })</span>
<span class="nc" id="L375">    }</span>

    private fun PostListActivityBinding.setupFabEvents() {
<span class="nc bnc" id="L378" title="All 2 branches missed.">        viewModel.onFabClicked.observeEvent(this@PostsListActivity, {</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">            postListCreateMenuViewModel.onFabClicked()</span>
<span class="nc" id="L380">        })</span>

<span class="nc bnc" id="L382" title="All 2 branches missed.">        viewModel.onFabLongPressedForCreateMenu.observeEvent(this@PostsListActivity, {</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            postListCreateMenuViewModel.onFabLongPressed()</span>
<span class="nc" id="L384">            Toast.makeText(fabButton.context, R.string.create_post_story_fab_tooltip, Toast.LENGTH_SHORT).show()</span>
<span class="nc" id="L385">        })</span>

<span class="nc bnc" id="L387" title="All 2 branches missed.">        viewModel.onFabLongPressedForPostList.observe(this@PostsListActivity, {</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            if (fabButton.isHapticFeedbackEnabled) {</span>
<span class="nc" id="L389">                fabButton.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS)</span>
            }
<span class="nc" id="L391">            Toast.makeText(fabButton.context, R.string.create_post_fab_tooltip, Toast.LENGTH_SHORT).show()</span>
<span class="nc" id="L392">        })</span>
<span class="nc" id="L393">    }</span>

    private fun PostListActivityBinding.loadViewState(state: PostListMainViewState) {
<span class="nc bnc" id="L396" title="All 2 branches missed.">        if (state.isFabVisible) {</span>
<span class="nc" id="L397">            fabButton.show()</span>
        } else {
<span class="nc" id="L399">            fabButton.hide()</span>
        }

<span class="nc bnc" id="L402" title="All 2 branches missed.">        val authorSelectionVisibility = if (state.isAuthorFilterVisible) View.VISIBLE else View.GONE</span>
<span class="nc" id="L403">        postListAuthorSelection.visibility = authorSelectionVisibility</span>
<span class="nc" id="L404">        postListTabLayoutFadingEdge.visibility = authorSelectionVisibility</span>

<span class="nc" id="L406">        val tabLayoutPaddingStart =</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">                if (state.isAuthorFilterVisible) {</span>
<span class="nc" id="L408">                    resources.getDimensionPixelSize(R.dimen.posts_list_tab_layout_fading_edge_width)</span>
<span class="nc" id="L409">                } else 0</span>
<span class="nc" id="L410">        tabLayout.setPaddingRelative(tabLayoutPaddingStart, 0, 0, 0)</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">        val authorSelectionAdapter = postListAuthorSelection.adapter as AuthorSelectionAdapter</span>
<span class="nc" id="L412">        authorSelectionAdapter.updateItems(state.authorFilterItems)</span>

<span class="nc bnc" id="L414" title="All 2 branches missed.">        authorSelectionAdapter.getIndexOfSelection(state.authorFilterSelection)?.let { selectionIndex -&gt;</span>
<span class="nc" id="L415">            postListAuthorSelection.setSelection(selectionIndex)</span>
<span class="nc" id="L416">        }</span>
<span class="nc" id="L417">    }</span>

    private fun showSnackBar(holder: SnackbarMessageHolder) {
<span class="nc bnc" id="L420" title="All 2 branches missed.">        findViewById&lt;View&gt;(R.id.coordinator)?.let { parent -&gt;</span>
<span class="nc" id="L421">            snackbarSequencer.enqueue(</span>
<span class="nc" id="L422">                    SnackbarItem(</span>
<span class="nc" id="L423">                            SnackbarItem.Info(</span>
<span class="nc" id="L424">                                    view = parent,</span>
<span class="nc" id="L425">                                    textRes = holder.message,</span>
<span class="nc" id="L426">                                    duration = Snackbar.LENGTH_LONG</span>
                            ),
<span class="nc bnc" id="L428" title="All 2 branches missed.">                            holder.buttonTitle?.let {</span>
<span class="nc" id="L429">                                SnackbarItem.Action(</span>
<span class="nc" id="L430">                                        textRes = holder.buttonTitle,</span>
<span class="nc" id="L431">                                        clickListener = { holder.buttonAction() }</span>
                                )
                            },
<span class="nc" id="L434">                            dismissCallback = { _, event -&gt; holder.onDismissAction(event) }</span>
                    )
            )
<span class="nc" id="L437">        }</span>
<span class="nc" id="L438">    }</span>

    private fun loadIntentData(intent: Intent) {
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (intent.hasExtra(ARG_NOTIFICATION_TYPE)) {</span>
<span class="nc" id="L442">            val notificationType: NotificationType =</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                    intent.getSerializableExtra(ARG_NOTIFICATION_TYPE) as NotificationType</span>
<span class="nc" id="L444">            systemNotificationTracker.trackTappedNotification(notificationType)</span>
        }

<span class="nc" id="L447">        val targetPostId = intent.getIntExtra(EXTRA_TARGET_POST_LOCAL_ID, -1)</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">        if (targetPostId != -1) {</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">            viewModel.showTargetPost(targetPostId)</span>
        }
<span class="nc" id="L451">    }</span>

    public override fun onResume() {
<span class="nc" id="L454">        super.onResume()</span>
<span class="nc" id="L455">        ActivityId.trackLastActivity(ActivityId.POSTS)</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">        postListCreateMenuViewModel.onResume()</span>
<span class="nc" id="L457">    }</span>

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
<span class="nc" id="L460">        super.onActivityResult(requestCode, resultCode, data)</span>

<span class="nc" id="L462">        when {</span>
<span class="nc bnc" id="L463" title="All 4 branches missed.">            requestCode == RequestCodes.EDIT_POST &amp;&amp; resultCode == Activity.RESULT_OK -&gt; {</span>
<span class="nc bnc" id="L464" title="All 4 branches missed.">                if (data != null &amp;&amp; EditPostActivity.checkToRestart(data)) {</span>
<span class="nc" id="L465">                    ActivityLauncher.editPostOrPageForResult(</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">                            data, this, site,</span>
<span class="nc" id="L467">                            data.getIntExtra(EditPostActivity.EXTRA_POST_LOCAL_ID, 0)</span>
                    )

                    // a restart will happen so, no need to continue here
<span class="nc" id="L471">                    return</span>
                }

<span class="nc bnc" id="L474" title="All 2 branches missed.">                viewModel.handleEditPostResult(data)</span>
            }
<span class="nc bnc" id="L476" title="All 2 branches missed.">            requestCode == RequestCodes.REMOTE_PREVIEW_POST -&gt; {</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">                viewModel.handleRemotePreviewClosing()</span>
            }
<span class="nc bnc" id="L479" title="All 2 branches missed.">            requestCode == RequestCodes.PHOTO_PICKER &amp;&amp;</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                    resultCode == Activity.RESULT_OK &amp;&amp;</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">                    data != null -&gt; {</span>
<span class="nc" id="L482">                storiesMediaPickerResultHandler.handleMediaPickerResultForStories(</span>
<span class="nc" id="L483">                        data,</span>
<span class="nc" id="L484">                        this,</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                        site,</span>
<span class="nc" id="L486">                        STORY_FROM_POSTS_LIST</span>
                )
            }
<span class="nc bnc" id="L489" title="All 2 branches missed.">            requestCode == RequestCodes.CREATE_STORY -&gt; {</span>
<span class="nc bnc" id="L490" title="All 4 branches missed.">                val isNewStory = data?.getStringExtra(GutenbergEditorFragment.ARG_STORY_BLOCK_ID) == null</span>
<span class="nc" id="L491">                bloggingRemindersViewModel.onPublishingPost(</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">                        site.id,</span>
<span class="nc" id="L493">                        isNewStory</span>
                )
            }
        }
<span class="nc" id="L497">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L500" title="All 2 branches missed.">        if (item.itemId == android.R.id.home) {</span>
<span class="nc" id="L501">            onBackPressed()</span>
<span class="nc" id="L502">            return true</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">        } else if (item.itemId == R.id.toggle_post_list_item_layout) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">            viewModel.toggleViewLayout()</span>
<span class="nc" id="L505">            return true</span>
        }
<span class="nc" id="L507">        return super.onOptionsItemSelected(item)</span>
    }

    override fun onCreateOptionsMenu(menu: Menu): Boolean {
<span class="nc" id="L511">        super.onCreateOptionsMenu(menu)</span>
<span class="nc" id="L512">        menu?.let {</span>
<span class="nc" id="L513">            menuInflater.inflate(R.menu.posts_list_toggle_view_layout, it)</span>
<span class="nc" id="L514">            toggleViewLayoutMenuItem = it.findItem(R.id.toggle_post_list_item_layout)</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">            viewModel.viewLayoutTypeMenuUiState.observe(this, { menuUiState -&gt;</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                menuUiState?.let {</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">                    updateMenuIcon(menuUiState.iconRes, toggleViewLayoutMenuItem)</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                    updateMenuTitle(menuUiState.title, toggleViewLayoutMenuItem)</span>
<span class="nc" id="L519">                }</span>
<span class="nc" id="L520">            })</span>

<span class="nc" id="L522">            searchActionButton = it.findItem(R.id.toggle_post_search)</span>

<span class="nc" id="L524">            initSearchFragment()</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">            binding.initSearchView()</span>
<span class="nc" id="L526">        }</span>
<span class="nc" id="L527">        return true</span>
    }

    private fun initSearchFragment() {
<span class="nc" id="L531">        val searchFragmentTag = &quot;search_fragment&quot;</span>

<span class="nc" id="L533">        var searchFragment = supportFragmentManager.findFragmentByTag(searchFragmentTag)</span>

<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (searchFragment == null) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">            searchFragment = PostListFragment.newInstance(site, SEARCH)</span>
<span class="nc" id="L537">            supportFragmentManager</span>
<span class="nc" id="L538">                    .beginTransaction()</span>
<span class="nc" id="L539">                    .replace(R.id.search_container, searchFragment, searchFragmentTag)</span>
<span class="nc" id="L540">                    .commit()</span>
        }
<span class="nc" id="L542">    }</span>

    private fun PostListActivityBinding.initSearchView() {
<span class="nc bnc" id="L545" title="All 2 branches missed.">        searchActionButton.setOnActionExpandListener(object : OnActionExpandListener {</span>
            override fun onMenuItemActionExpand(item: MenuItem?): Boolean {
<span class="nc bnc" id="L547" title="All 2 branches missed.">                viewModel.onSearchExpanded(restorePreviousSearch)</span>
<span class="nc" id="L548">                return true</span>
            }

            override fun onMenuItemActionCollapse(item: MenuItem?): Boolean {
<span class="nc bnc" id="L552" title="All 2 branches missed.">                viewModel.onSearchCollapsed()</span>
<span class="nc" id="L553">                return true</span>
            }
        })

<span class="nc bnc" id="L557" title="All 4 branches missed.">        val searchView = searchActionButton.actionView as SearchView</span>
<span class="nc" id="L558">        searchView.setOnQueryTextListener(object : SearchView.OnQueryTextListener {</span>
            override fun onQueryTextSubmit(query: String): Boolean {
<span class="nc bnc" id="L560" title="All 2 branches missed.">                viewModel.onSearch(query)</span>
<span class="nc" id="L561">                return true</span>
            }

            override fun onQueryTextChange(newText: String): Boolean {
<span class="nc bnc" id="L565" title="All 2 branches missed.">                if (restorePreviousSearch) {</span>
<span class="nc" id="L566">                    restorePreviousSearch = false</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">                    searchView.setQuery(viewModel.searchQuery.value, false)</span>
                } else {
<span class="nc bnc" id="L569" title="All 2 branches missed.">                    viewModel.onSearch(newText)</span>
                }
<span class="nc" id="L571">                return true</span>
            }
        })

<span class="nc bnc" id="L575" title="All 2 branches missed.">        viewModel.isSearchExpanded.observe(this@PostsListActivity, { isExpanded -&gt;</span>
<span class="nc bnc" id="L576" title="All 4 branches missed.">            toggleViewLayoutMenuItem.isVisible = !isExpanded</span>
<span class="nc" id="L577">            toggleSearch(isExpanded)</span>
<span class="nc" id="L578">        })</span>
<span class="nc" id="L579">    }</span>

    private fun PostListActivityBinding.toggleSearch(isExpanded: Boolean) {
<span class="nc" id="L582">        val tabContainer = findViewById&lt;View&gt;(R.id.tabContainer)</span>
<span class="nc" id="L583">        val searchContainer = findViewById&lt;View&gt;(R.id.search_container)</span>

<span class="nc bnc" id="L585" title="All 2 branches missed.">        if (isExpanded) {</span>
<span class="nc" id="L586">            postPager.visibility = View.GONE</span>
<span class="nc" id="L587">            tabContainer.visibility = View.GONE</span>
<span class="nc" id="L588">            searchContainer.visibility = View.VISIBLE</span>
<span class="nc bnc" id="L589" title="All 4 branches missed.">            if (!searchActionButton.isActionViewExpanded) {</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">                searchActionButton.expandActionView()</span>
            }
<span class="nc" id="L592">            appbarMain.setLiftOnScrollTargetViewIdAndRequestLayout(R.id.posts_search_recycler_view_id)</span>
        } else {
<span class="nc" id="L594">            postPager.visibility = View.VISIBLE</span>
<span class="nc" id="L595">            tabContainer.visibility = View.VISIBLE</span>
<span class="nc" id="L596">            searchContainer.visibility = View.GONE</span>
<span class="nc bnc" id="L597" title="All 4 branches missed.">            if (searchActionButton.isActionViewExpanded) {</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                searchActionButton.collapseActionView()</span>
            }
<span class="nc bnc" id="L600" title="All 2 branches missed.">            appbarMain.getTag(R.id.posts_non_search_recycler_view_id_tag_key)?.let {</span>
<span class="nc" id="L601">                appbarMain.setLiftOnScrollTargetViewIdAndRequestLayout(it as Int)</span>
<span class="nc" id="L602">            }</span>
        }
<span class="nc" id="L604">    }</span>

    public override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L607">        super.onSaveInstanceState(outState)</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        outState.putSerializable(WordPress.SITE, site)</span>
<span class="nc bnc" id="L609" title="All 4 branches missed.">        viewModel.previewState.value?.let {</span>
<span class="nc" id="L610">            outState.putInt(STATE_KEY_PREVIEW_STATE, it.value)</span>
<span class="nc" id="L611">        }</span>
<span class="nc bnc" id="L612" title="All 4 branches missed.">        viewModel.currentBottomSheetPostId?.let {</span>
<span class="nc" id="L613">            outState.putInt(STATE_KEY_BOTTOMSHEET_POST_ID, it.value)</span>
<span class="nc" id="L614">        }</span>
<span class="nc" id="L615">    }</span>

    // BasicDialogFragment Callbacks

    override fun onPositiveClicked(instanceTag: String) {
<span class="nc bnc" id="L620" title="All 2 branches missed.">        viewModel.onPositiveClickedForBasicDialog(instanceTag)</span>
<span class="nc" id="L621">    }</span>

    override fun onNegativeClicked(instanceTag: String) {
<span class="nc bnc" id="L624" title="All 2 branches missed.">        viewModel.onNegativeClickedForBasicDialog(instanceTag)</span>
<span class="nc" id="L625">    }</span>

    override fun onDismissByOutsideTouch(instanceTag: String) {
<span class="nc bnc" id="L628" title="All 2 branches missed.">        viewModel.onDismissByOutsideTouchForBasicDialog(instanceTag)</span>
<span class="nc" id="L629">    }</span>

    // Menu PostListViewLayoutType handling

    private fun updateMenuIcon(@DrawableRes iconRes: Int, menuItem: MenuItem) {
<span class="nc bnc" id="L634" title="All 2 branches missed.">        ContextCompat.getDrawable(this, iconRes)?.let { drawable -&gt;</span>
<span class="nc" id="L635">            menuItem.setIcon(drawable)</span>
        }
<span class="nc" id="L637">    }</span>

    private fun updateMenuTitle(title: UiString, menuItem: MenuItem): MenuItem? {
<span class="nc" id="L640">        return menuItem.setTitle(uiHelpers.getTextOfUiString(this@PostsListActivity, title))</span>
    }

    override fun onSubmitButtonClicked(publishPost: PublishPost) {
<span class="nc bnc" id="L644" title="All 2 branches missed.">        viewModel.onBottomSheetPublishButtonClicked()</span>
<span class="nc" id="L645">    }</span>

    override fun onScrollableViewInitialized(containerId: Int) {
<span class="nc bnc" id="L648" title="All 2 branches missed.">        binding.appbarMain.setLiftOnScrollTargetViewIdAndRequestLayout(containerId)</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">        binding.appbarMain.setTag(R.id.posts_non_search_recycler_view_id_tag_key, containerId)</span>
<span class="nc" id="L650">    }</span>

    companion object {
        private const val BLOGGING_REMINDERS_FRAGMENT_TAG = &quot;blogging_reminders_fragment_tag&quot;
        private const val ACTIONS_SHOWN_BY_DEFAULT = &quot;actions_shown_by_default&quot;
        private const val TAB_INDEX = &quot;tab_index&quot;

        @JvmStatic
        fun buildIntent(context: Context, site: SiteModel): Intent {
<span class="nc" id="L659">            val intent = Intent(context, PostsListActivity::class.java)</span>
<span class="nc" id="L660">            intent.putExtra(WordPress.SITE, site)</span>
<span class="nc" id="L661">            return buildIntent(context, site, PostListType.PUBLISHED, false)</span>
        }

        @JvmStatic
<span class="nc" id="L665">        fun buildIntent(</span>
            context: Context,
            site: SiteModel,
            postListType: PostListType,
            actionsShownByDefault: Boolean,
<span class="nc" id="L670">            notificationType: NotificationType? = null</span>
        ): Intent {
<span class="nc" id="L672">            val intent = Intent(context, PostsListActivity::class.java)</span>
<span class="nc" id="L673">            intent.putExtra(WordPress.SITE, site)</span>
<span class="nc" id="L674">            intent.putExtra(ACTIONS_SHOWN_BY_DEFAULT, actionsShownByDefault)</span>
<span class="nc" id="L675">            intent.putExtra(TAB_INDEX, postListType.ordinal)</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">            if (notificationType != null) {</span>
<span class="nc" id="L677">                intent.putExtra(ARG_NOTIFICATION_TYPE, notificationType)</span>
            }
<span class="nc" id="L679">            return intent</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>