<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocalNotificationWorker.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.workers.notification.local</a> &gt; <span class="el_source">LocalNotificationWorker.kt</span></div><h1>LocalNotificationWorker.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.workers.notification.local

import android.app.PendingIntent
import android.content.Context
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import androidx.core.content.ContextCompat
import androidx.work.CoroutineWorker
import androidx.work.Data
import androidx.work.ListenableWorker
import androidx.work.WorkerFactory
import androidx.work.WorkerParameters
import androidx.work.workDataOf
import org.wordpress.android.R
import org.wordpress.android.workers.notification.local.LocalNotification.Type

<span class="nc" id="L17">class LocalNotificationWorker(</span>
<span class="nc" id="L18">    val context: Context,</span>
    params: WorkerParameters,
<span class="nc" id="L20">    private val localNotificationHandlerFactory: LocalNotificationHandlerFactory</span>
<span class="nc" id="L21">) : CoroutineWorker(context, params) {</span>
    override suspend fun doWork(): Result {
<span class="nc" id="L23">        val id = inputData.getInt(ID, -1)</span>
<span class="nc" id="L24">        val type = Type.fromTag(inputData.getString(TYPE))</span>

<span class="nc bnc" id="L26" title="All 4 branches missed.">        if (id == -1 || type == null) return Result.failure()</span>

<span class="nc" id="L28">        val localNotificationHandler = localNotificationHandlerFactory.buildLocalNotificationHandler(type)</span>
<span class="nc bnc" id="L29" title="All 2 branches missed.">        if (localNotificationHandler.shouldShowNotification()) {</span>
<span class="nc" id="L30">            NotificationManagerCompat.from(context).notify(id, localNotificationBuilder(id).build())</span>
<span class="nc" id="L31">            localNotificationHandler.onNotificationShown()</span>
        }

<span class="nc" id="L34">        return Result.success()</span>
    }

    private fun localNotificationBuilder(notificationId: Int): NotificationCompat.Builder {
<span class="nc" id="L38">        val title = inputData.getInt(TITLE, -1)</span>
<span class="nc" id="L39">        val text = inputData.getInt(TEXT, -1)</span>
<span class="nc" id="L40">        val icon = inputData.getInt(ICON, -1)</span>
<span class="nc" id="L41">        val firstActionIcon = inputData.getInt(FIRST_ACTION_ICON, -1)</span>
<span class="nc" id="L42">        val firstActionTitle = inputData.getInt(FIRST_ACTION_TITLE, -1)</span>
<span class="nc" id="L43">        val secondActionIcon = inputData.getInt(SECOND_ACTION_ICON, -1)</span>
<span class="nc" id="L44">        val secondActionTitle = inputData.getInt(SECOND_ACTION_TITLE, -1)</span>

<span class="nc" id="L46">        return NotificationCompat.Builder(context, context.getString(R.string.notification_channel_normal_id)).apply {</span>
<span class="nc" id="L47">            val firstActionPendingIntent = getFirstActionPendingIntent(notificationId)</span>
<span class="nc" id="L48">            setContentIntent(firstActionPendingIntent)</span>
<span class="nc" id="L49">            setSmallIcon(icon)</span>
<span class="nc" id="L50">            setContentTitle(context.getString(title))</span>
<span class="nc" id="L51">            setContentText(context.getString(text))</span>
<span class="nc" id="L52">            addAction(firstActionIcon, context.getString(firstActionTitle), firstActionPendingIntent)</span>
<span class="nc" id="L53">            val secondActionPendingIntent = getSecondActionPendingIntent(notificationId)</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            if (secondActionPendingIntent != null) {</span>
<span class="nc" id="L55">                addAction(secondActionIcon, context.getString(secondActionTitle), secondActionPendingIntent)</span>
            }
<span class="nc" id="L57">            priority = NotificationCompat.PRIORITY_DEFAULT</span>
<span class="nc" id="L58">            setCategory(NotificationCompat.CATEGORY_REMINDER)</span>
<span class="nc" id="L59">            setAutoCancel(true)</span>
<span class="nc" id="L60">            setColorized(true)</span>
<span class="nc" id="L61">            color = ContextCompat.getColor(context, R.color.blue_50)</span>
<span class="nc" id="L62">        }</span>
    }

    private fun getFirstActionPendingIntent(notificationId: Int): PendingIntent? {
<span class="nc" id="L66">        val type = Type.fromTag(inputData.getString(TYPE))</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        val handler = type?.let { localNotificationHandlerFactory.buildLocalNotificationHandler(it) }</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        return handler?.buildFirstActionPendingIntent(context, notificationId)</span>
    }

    private fun getSecondActionPendingIntent(notificationId: Int): PendingIntent? {
<span class="nc" id="L72">        val type = Type.fromTag(inputData.getString(TYPE))</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        val handler = type?.let { localNotificationHandlerFactory.buildLocalNotificationHandler(it) }</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        return handler?.buildSecondActionPendingIntent(context, notificationId)</span>
    }

<span class="fc" id="L77">    class Factory(</span>
<span class="fc" id="L78">        private val localNotificationHandlerFactory: LocalNotificationHandlerFactory</span>
<span class="fc" id="L79">    ) : WorkerFactory() {</span>
        override fun createWorker(
            appContext: Context,
            workerClassName: String,
            workerParameters: WorkerParameters
        ): ListenableWorker? {
<span class="nc bnc" id="L85" title="All 2 branches missed.">            return if (workerClassName == LocalNotificationWorker::class.java.name) {</span>
<span class="nc" id="L86">                LocalNotificationWorker(appContext, workerParameters, localNotificationHandlerFactory)</span>
            } else {
<span class="nc" id="L88">                null</span>
            }
        }
    }

    companion object {
        private const val TYPE = &quot;key_type&quot;
        private const val ID = &quot;key_id&quot;
        private const val TITLE = &quot;key_title&quot;
        private const val TEXT = &quot;key_text&quot;
        private const val ICON = &quot;key_icon&quot;
        private const val FIRST_ACTION_ICON = &quot;key_first_action_icon&quot;
        private const val FIRST_ACTION_TITLE = &quot;key_first_action_title&quot;
        private const val SECOND_ACTION_ICON = &quot;key_second_action_icon&quot;
        private const val SECOND_ACTION_TITLE = &quot;key_second_action_title&quot;

        fun buildData(localNotification: LocalNotification): Data {
<span class="nc" id="L105">            return workDataOf(</span>
<span class="nc" id="L106">                    TYPE to localNotification.type.tag,</span>
<span class="nc" id="L107">                    ID to localNotification.id,</span>
<span class="nc" id="L108">                    TITLE to localNotification.title,</span>
<span class="nc" id="L109">                    TEXT to localNotification.text,</span>
<span class="nc" id="L110">                    ICON to localNotification.icon,</span>
<span class="nc" id="L111">                    FIRST_ACTION_ICON to localNotification.firstActionIcon,</span>
<span class="nc" id="L112">                    FIRST_ACTION_TITLE to localNotification.firstActionTitle,</span>
<span class="nc" id="L113">                    SECOND_ACTION_ICON to localNotification.secondActionIcon,</span>
<span class="nc" id="L114">                    SECOND_ACTION_TITLE to localNotification.secondActionTitle</span>
            )
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>