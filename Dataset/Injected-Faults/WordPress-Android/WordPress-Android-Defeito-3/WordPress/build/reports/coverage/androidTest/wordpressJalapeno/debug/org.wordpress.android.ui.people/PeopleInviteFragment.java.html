<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PeopleInviteFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.people</a> &gt; <span class="el_source">PeopleInviteFragment.java</span></div><h1>PeopleInviteFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.people;


import android.content.Intent;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextUtils;
import android.text.TextWatcher;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.View;
import android.view.ViewGroup;
import android.view.inputmethod.EditorInfo;
import android.widget.AutoCompleteTextView;
import android.widget.EditText;
import android.widget.ProgressBar;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.Fragment;
import androidx.lifecycle.ViewModelProvider;

import com.facebook.shimmer.ShimmerFrameLayout;
import com.google.android.material.button.MaterialButton;
import com.google.android.material.snackbar.Snackbar;
import com.google.android.material.textfield.TextInputLayout;
import com.google.android.material.textview.MaterialTextView;

import org.jetbrains.annotations.NotNull;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.fluxc.model.RoleModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.models.RoleUtils;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.people.PeopleInviteDialogFragment.DialogMode;
import org.wordpress.android.ui.people.WPEditTextWithChipsOutlined.ItemValidationState;
import org.wordpress.android.ui.people.WPEditTextWithChipsOutlined.ItemsManagerInterface;
import org.wordpress.android.ui.people.utils.PeopleUtils;
import org.wordpress.android.ui.people.utils.PeopleUtils.ValidateUsernameCallback.ValidationResult;
import org.wordpress.android.ui.utils.UiHelpers;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.viewmodel.ContextProvider;
import org.wordpress.android.widgets.WPSnackbar;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Hashtable;
import java.util.List;
import java.util.Map;

import javax.inject.Inject;

import static com.google.android.material.textfield.TextInputLayout.END_ICON_DROPDOWN_MENU;
import static com.google.android.material.textfield.TextInputLayout.END_ICON_NONE;

import kotlin.Unit;

<span class="nc" id="L71">public class PeopleInviteFragment extends Fragment implements RoleSelectDialogFragment.OnRoleSelectListener,</span>
        PeopleManagementActivity.InvitationSender {
    private static final String URL_USER_ROLES_DOCUMENTATION = &quot;https://en.support.wordpress.com/user-roles/&quot;;
    private static final String FLAG_SUCCESS = &quot;SUCCESS&quot;;
    private static final String KEY_USERNAMES = &quot;usernames&quot;;
    private static final String KEY_SELECTED_ROLE = &quot;selected-role&quot;;
    public static final String DIALOG_TAG = &quot;dialog_fragment_tag&quot;;

<span class="nc" id="L79">    private ArrayList&lt;String&gt; mUsernames = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L80">    private final HashMap&lt;String, String&gt; mUsernameResults = new HashMap&lt;&gt;();</span>
<span class="nc" id="L81">    private final Map&lt;String, View&gt; mUsernameErrorViews = new Hashtable&lt;&gt;();</span>

    private WPEditTextWithChipsOutlined mUsernamesEmails;
    private AutoCompleteTextView mRoleTextView;
    private TextInputLayout mRoleContainer;
    private EditText mCustomMessageEditText;

    private ViewGroup mCoordinator;
    private ViewGroup mInviteLinkContainer;
    private ShimmerFrameLayout mShimmerContainer;
    private MaterialButton mGenerateLinksButton;
    private ViewGroup mLoadAndRetryLinksContainer;
    private MaterialButton mRetryButton;
    private ProgressBar mLoadingLinksProgress;
    private ViewGroup mManageLinksContainer;
    private MaterialButton mShareLinksButton;
    private AutoCompleteTextView mLinksRoleTextView;
    private TextInputLayout mLinksRoleContainer;
    private MaterialButton mDisableLinksButton;
    private MaterialTextView mExpireDateTextView;

    private List&lt;RoleModel&gt; mInviteRoles;
    private String mCurrentRole;
<span class="nc" id="L104">    private String mCustomMessage = &quot;&quot;;</span>
<span class="nc" id="L105">    private boolean mInviteOperationInProgress = false;</span>
    private SiteModel mSite;

    @Inject SiteStore mSiteStore;
    @Inject ViewModelProvider.Factory mViewModelFactory;
    @Inject UiHelpers mUiHelpers;
    @Inject ContextProvider mContextProvider;

    private PeopleInviteViewModel mViewModel;

    public static PeopleInviteFragment newInstance(SiteModel site) {
<span class="nc" id="L116">        PeopleInviteFragment peopleInviteFragment = new PeopleInviteFragment();</span>
<span class="nc" id="L117">        Bundle bundle = new Bundle();</span>
<span class="nc" id="L118">        bundle.putSerializable(WordPress.SITE, site);</span>
<span class="nc" id="L119">        peopleInviteFragment.setArguments(bundle);</span>
<span class="nc" id="L120">        return peopleInviteFragment;</span>
    }

    private void updateSiteOrFinishActivity() {
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (getArguments() != null) {</span>
<span class="nc" id="L125">            mSite = (SiteModel) getArguments().getSerializable(WordPress.SITE);</span>
        } else {
<span class="nc" id="L127">            mSite = (SiteModel) getActivity().getIntent().getSerializableExtra(WordPress.SITE);</span>
        }

<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (mSite == null) {</span>
<span class="nc" id="L131">            ToastUtils.showToast(getActivity(), R.string.blog_not_found, ToastUtils.Duration.SHORT);</span>
<span class="nc" id="L132">            getActivity().finish();</span>
        }
<span class="nc" id="L134">    }</span>

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span class="nc" id="L138">        inflater.inflate(R.menu.people_invite, menu);</span>
<span class="nc" id="L139">        super.onCreateOptionsMenu(menu, inflater);</span>
<span class="nc" id="L140">    }</span>

    @Override
    public void onPrepareOptionsMenu(Menu menu) {
<span class="nc bnc" id="L144" title="All 2 branches missed.">        menu.getItem(0).setEnabled(!mInviteOperationInProgress); // here pass the index of send menu item</span>
<span class="nc" id="L145">        super.onPrepareOptionsMenu(menu);</span>
<span class="nc" id="L146">    }</span>

    @Override
    public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L150">        super.onSaveInstanceState(outState);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (mCurrentRole != null) {</span>
<span class="nc" id="L152">            outState.putString(KEY_SELECTED_ROLE, mCurrentRole);</span>
        }
<span class="nc" id="L154">        outState.putStringArrayList(KEY_USERNAMES, new ArrayList&lt;&gt;(mUsernamesEmails.getChipsStrings()));</span>
<span class="nc" id="L155">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L159">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L160">        ((WordPress) getActivity().getApplicationContext()).component().inject(this);</span>
<span class="nc" id="L161">        updateSiteOrFinishActivity();</span>
<span class="nc" id="L162">        mInviteRoles = RoleUtils.getInviteRoles(mSiteStore, mSite, mContextProvider.getContext());</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L165">            mCurrentRole = savedInstanceState.getString(KEY_SELECTED_ROLE);</span>
<span class="nc" id="L166">            ArrayList&lt;String&gt; retainedUsernames = savedInstanceState.getStringArrayList(KEY_USERNAMES);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (retainedUsernames != null) {</span>
<span class="nc" id="L168">                mUsernames.clear();</span>
<span class="nc" id="L169">                mUsernames.addAll(retainedUsernames);</span>
            }
        }

        // retain this fragment across configuration changes
        // WARNING: use setRetainInstance wisely. In this case we need this to be able to get the
        // results of network connections in the same fragment if going through a configuration change
        // (for example, device rotation occurs). Given the simplicity of this particular use case
        // (the fragment state keeps only a couple of EditText components and the SAVE button, it is
        // OK to use it here.
<span class="nc" id="L179">        setRetainInstance(true);</span>
<span class="nc" id="L180">    }</span>

    @Override
    public View onCreateView(final LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L184">        setHasOptionsMenu(true);</span>
<span class="nc" id="L185">        View rootView = inflater.inflate(R.layout.people_invite_fragment, container, false);</span>

<span class="nc" id="L187">        Toolbar toolbar = rootView.findViewById(R.id.toolbar_main);</span>
<span class="nc" id="L188">        ((AppCompatActivity) getActivity()).setSupportActionBar(toolbar);</span>
<span class="nc" id="L189">        ActionBar actionBar = ((AppCompatActivity) getActivity()).getSupportActionBar();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L191">            actionBar.setHomeButtonEnabled(true);</span>
<span class="nc" id="L192">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L193">            actionBar.setTitle(R.string.invite_people);</span>
        }

<span class="nc" id="L196">        mInviteLinkContainer = rootView.findViewById(R.id.invite_links_container);</span>
<span class="nc" id="L197">        mShimmerContainer = rootView.findViewById(R.id.shimmer_view_container);</span>
<span class="nc" id="L198">        mGenerateLinksButton = rootView.findViewById(R.id.generate_links);</span>
<span class="nc" id="L199">        mLoadAndRetryLinksContainer = rootView.findViewById(R.id.load_and_retry_container);</span>
<span class="nc" id="L200">        mRetryButton = rootView.findViewById(R.id.get_status_retry);</span>
<span class="nc" id="L201">        mLoadingLinksProgress = rootView.findViewById(R.id.get_links_status_progress);</span>
<span class="nc" id="L202">        mManageLinksContainer = rootView.findViewById(R.id.manage_links_container);</span>
<span class="nc" id="L203">        mShareLinksButton = rootView.findViewById(R.id.share_links);</span>
<span class="nc" id="L204">        mLinksRoleTextView = rootView.findViewById(R.id.links_role);</span>
<span class="nc" id="L205">        mLinksRoleContainer = rootView.findViewById(R.id.links_role_container);</span>
<span class="nc" id="L206">        mDisableLinksButton = rootView.findViewById(R.id.disable_button);</span>
<span class="nc" id="L207">        mExpireDateTextView = rootView.findViewById(R.id.expire_date);</span>

<span class="nc" id="L209">        return rootView;</span>
    }

    @Override
    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
<span class="nc" id="L214">        super.onViewCreated(view, savedInstanceState);</span>

<span class="nc" id="L216">        mViewModel = new ViewModelProvider(this, mViewModelFactory).get(PeopleInviteViewModel.class);</span>

<span class="nc" id="L218">        mGenerateLinksButton.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            if (!isAdded()) return;</span>
<span class="nc" id="L220">            mViewModel.onGenerateLinksButtonClicked();</span>
<span class="nc" id="L221">        });</span>

<span class="nc" id="L223">        mShareLinksButton.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (!isAdded()) return;</span>
<span class="nc" id="L225">            mViewModel.onShareButtonClicked(</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                    mLinksRoleTextView.getText() != null</span>
<span class="nc" id="L227">                            ? mLinksRoleTextView.getText().toString()</span>
<span class="nc" id="L228">                            : &quot;&quot;</span>
            );
<span class="nc" id="L230">        });</span>

<span class="nc" id="L232">        mDisableLinksButton.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">            if (!isAdded()) return;</span>

<span class="nc" id="L235">            PeopleInviteDialogFragment</span>
<span class="nc" id="L236">                    .newInstance(this, DialogMode.DISABLE_INVITE_LINKS_CONFIRMATION)</span>
<span class="nc" id="L237">                    .show(getParentFragmentManager(), DIALOG_TAG);</span>
<span class="nc" id="L238">        });</span>

<span class="nc" id="L240">        mRetryButton.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (!isAdded()) return;</span>
<span class="nc" id="L242">            mViewModel.onRetryButtonClicked();</span>
<span class="nc" id="L243">        });</span>

<span class="nc" id="L245">        mViewModel.getSnackbarEvents().observe(getViewLifecycleOwner(), event -&gt;</span>
<span class="nc" id="L246">                event.applyIfNotHandled(holder -&gt; {</span>
<span class="nc" id="L247">                    WPSnackbar.make(mCoordinator,</span>
<span class="nc" id="L248">                            mUiHelpers.getTextOfUiString(mContextProvider.getContext(), holder.getMessage()),</span>
                            Snackbar.LENGTH_LONG)
<span class="nc" id="L250">                              .show();</span>
<span class="nc" id="L251">                    return Unit.INSTANCE;</span>
                })
        );

<span class="nc" id="L255">        mViewModel.getInviteLinksUiState().observe(getViewLifecycleOwner(), uiState -&gt; {</span>
<span class="nc" id="L256">            manageLinksControlsVisibility(uiState);</span>

<span class="nc" id="L258">            manageShimmerSection(uiState.isShimmerSectionVisible(), uiState.getStartShimmer());</span>

<span class="nc" id="L260">            manageActionButtonsEnabledState(uiState.isActionButtonsEnabled());</span>

<span class="nc bnc" id="L262" title="All 4 branches missed.">            switch (uiState.getType()) {</span>
                case HIDDEN:
                case LOADING:
                case GET_STATUS_RETRY:
                    // Nothing to do here
<span class="nc" id="L267">                    break;</span>
                case LINKS_GENERATE:
<span class="nc" id="L269">                    mManageLinksContainer.setVisibility(View.GONE);</span>
<span class="nc" id="L270">                    mGenerateLinksButton.setVisibility(View.VISIBLE);</span>

<span class="nc" id="L272">                    break;</span>
                case LINKS_AVAILABLE:
<span class="nc" id="L274">                    mGenerateLinksButton.setVisibility(View.GONE);</span>
<span class="nc" id="L275">                    mManageLinksContainer.setVisibility(View.VISIBLE);</span>

<span class="nc" id="L277">                    setLinksRoleControlsBehaviour(uiState.isRoleSelectionAllowed());</span>

<span class="nc" id="L279">                    mLinksRoleTextView.setText(uiState.getInviteLinksSelectedRole().getRoleDisplayName());</span>
<span class="nc" id="L280">                    mExpireDateTextView.setText(</span>
<span class="nc" id="L281">                            getString(</span>
                                    R.string.invite_links_expire_date,
<span class="nc" id="L283">                                    uiState.getInviteLinksSelectedRole().getExpiryDate()</span>
                            )
                    );

                    break;
            }
<span class="nc" id="L289">        });</span>

<span class="nc" id="L291">        mViewModel.getShareLink().observe(getViewLifecycleOwner(), event -&gt;</span>
<span class="nc" id="L292">            event.applyIfNotHandled(linksItem -&gt; {</span>
<span class="nc" id="L293">                Intent shareIntent = new Intent(Intent.ACTION_SEND);</span>
<span class="nc" id="L294">                shareIntent.setType(&quot;text/plain&quot;);</span>
<span class="nc" id="L295">                shareIntent.putExtra(Intent.EXTRA_TEXT, linksItem.getLink());</span>

<span class="nc" id="L297">                startActivity(Intent.createChooser(shareIntent, getResources().getString(R.string.share_link)));</span>

<span class="nc" id="L299">                return null;</span>
            }
        ));

<span class="nc" id="L303">        mViewModel.getShowSelectLinksRoleDialog().observe(getViewLifecycleOwner(), event -&gt;</span>
<span class="nc" id="L304">            event.applyIfNotHandled(roles -&gt; {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                if (isAdded()) {</span>
<span class="nc" id="L306">                    PeopleInviteDialogFragment</span>
<span class="nc" id="L307">                            .newInstance(this, DialogMode.INVITE_LINKS_ROLE_SELECTION, roles)</span>
<span class="nc" id="L308">                            .show(getParentFragmentManager(), DIALOG_TAG);</span>
                }

<span class="nc" id="L311">                return null;</span>
            }
        ));

<span class="nc" id="L315">        mViewModel.start(mSite);</span>
<span class="nc" id="L316">    }</span>

    @Override
    public void onViewStateRestored(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L320">        super.onViewStateRestored(savedInstanceState);</span>

<span class="nc" id="L322">        mUsernamesEmails = getView().findViewById(R.id.user_names_emails);</span>
<span class="nc" id="L323">        mRoleContainer = getView().findViewById(R.id.role_container);</span>
<span class="nc" id="L324">        mRoleTextView = getView().findViewById(R.id.role);</span>
<span class="nc" id="L325">        mCustomMessageEditText = (EditText) getView().findViewById(R.id.message);</span>
<span class="nc" id="L326">        mCoordinator = getView().findViewById(R.id.coordinator_layout);</span>

<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (TextUtils.isEmpty(mCurrentRole)) {</span>
<span class="nc" id="L329">            mCurrentRole = getDefaultRole();</span>
        }

<span class="nc" id="L332">        mUsernamesEmails.setItemsManager(new ItemsManagerInterface() {</span>
            @Override public void onRemoveItem(@NotNull String item) {
<span class="nc" id="L334">                removeUsername(item);</span>
<span class="nc" id="L335">            }</span>

            @Override public void onAddItem(@NotNull String item) {
<span class="nc" id="L338">                addUsername(item, null);</span>
<span class="nc" id="L339">            }</span>
        });

        // if mUsernamesEmails is not empty, this means fragment retained itself
        // if mUsernamesEmails is empty, but we have manually retained usernames, this means that fragment was destroyed
        // and we need to recreate manually added views and revalidate usernames
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (mUsernamesEmails.hasChips()) {</span>
<span class="nc" id="L346">            mUsernameErrorViews.clear();</span>
<span class="nc" id="L347">            populateUsernameChips(new ArrayList&lt;&gt;(mUsernamesEmails.getChipsStrings()));</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">        } else if (!mUsernames.isEmpty()) {</span>
<span class="nc" id="L349">            populateUsernameChips(new ArrayList&lt;&gt;(mUsernames));</span>
        }

<span class="nc" id="L352">        mRoleTextView.setShowSoftInputOnFocus(false);</span>
<span class="nc" id="L353">        mRoleTextView.setInputType(EditorInfo.TYPE_NULL);</span>
<span class="nc" id="L354">        mRoleTextView.setKeyListener(null);</span>
<span class="nc" id="L355">        refreshRoleTextView();</span>

<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (mInviteRoles.size() &gt; 1) {</span>
<span class="nc" id="L358">            mRoleContainer.setEndIconMode(END_ICON_DROPDOWN_MENU);</span>
<span class="nc" id="L359">            mRoleTextView.setOnClickListener(v -&gt; RoleSelectDialogFragment.show(PeopleInviteFragment.this, 0, mSite));</span>
<span class="nc" id="L360">            mRoleTextView.setFocusable(true);</span>
<span class="nc" id="L361">            mRoleTextView.setFocusableInTouchMode(true);</span>
        } else {
<span class="nc" id="L363">            mRoleContainer.setEndIconMode(END_ICON_NONE);</span>
<span class="nc" id="L364">            mRoleTextView.setOnClickListener(null);</span>
<span class="nc" id="L365">            mRoleTextView.setFocusable(false);</span>
<span class="nc" id="L366">            mRoleTextView.setFocusableInTouchMode(false);</span>
        }

<span class="nc" id="L369">        mRoleContainer.setEndIconOnClickListener(null);</span>
<span class="nc" id="L370">        mRoleContainer.setEndIconCheckable(false);</span>

<span class="nc" id="L372">        MaterialTextView moreInfo = (MaterialTextView) getView().findViewById(R.id.learn_more);</span>
<span class="nc" id="L373">        moreInfo.setOnClickListener(</span>
<span class="nc" id="L374">                v -&gt; ActivityLauncher.openUrlExternal(v.getContext(), URL_USER_ROLES_DOCUMENTATION)</span>
        );

<span class="nc" id="L377">        mCustomMessageEditText.addTextChangedListener(new TextWatcher() {</span>
            @Override
            public void beforeTextChanged(CharSequence s, int start, int count, int after) {
<span class="nc" id="L380">            }</span>

            @Override
            public void onTextChanged(CharSequence s, int start, int before, int count) {
<span class="nc" id="L384">                mCustomMessage = mCustomMessageEditText.getText().toString();</span>
<span class="nc" id="L385">            }</span>

            @Override
            public void afterTextChanged(Editable s) {
<span class="nc" id="L389">            }</span>
        });

        // important for accessibility - talkback
<span class="nc" id="L393">        getActivity().setTitle(R.string.invite_people);</span>
<span class="nc" id="L394">    }</span>

    private void resetEditTextContent(EditText editText) {
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (editText != null) {</span>
<span class="nc" id="L398">            editText.setText(&quot;&quot;);</span>
        }
<span class="nc" id="L400">    }</span>

    private String getDefaultRole() {
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (mInviteRoles.isEmpty()) {</span>
<span class="nc" id="L404">            return null;</span>
        }
<span class="nc" id="L406">        return mInviteRoles.get(0).getName();</span>
    }

    private void populateUsernameChips(Collection&lt;String&gt; usernames) {
<span class="nc bnc" id="L410" title="All 4 branches missed.">        if (usernames != null &amp;&amp; usernames.size() &gt; 0) {</span>
<span class="nc" id="L411">            validateAndStyleUsername(usernames, null);</span>
        }
<span class="nc" id="L413">    }</span>

    private void addUsername(@NotNull String username, ValidationEndListener validationEndListener) {
<span class="nc bnc" id="L416" title="All 4 branches missed.">        if (username.isEmpty() || mUsernamesEmails.containsChip(username)) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">            if (validationEndListener != null) {</span>
<span class="nc" id="L418">                validationEndListener.onValidationEnd();</span>
            }
<span class="nc" id="L420">            return;</span>
        }
<span class="nc" id="L422">        validateAndStyleUsername(Collections.singletonList(username), validationEndListener);</span>
<span class="nc" id="L423">    }</span>

    private void removeUsername(String username) {
<span class="nc" id="L426">        mUsernameResults.remove(username);</span>
<span class="nc" id="L427">        mUsernamesEmails.removeChip(username);</span>
<span class="nc" id="L428">        updateUsernameError(username, null);</span>
<span class="nc" id="L429">    }</span>

    private boolean isUserInInvitees(String username) {
<span class="nc" id="L432">        return mUsernamesEmails.containsChip(username);</span>
    }

    @Override
    public void onRoleSelected(RoleModel newRole) {
<span class="nc" id="L437">        setRole(newRole.getName());</span>

<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (mUsernamesEmails.hasChips()) {</span>
            // clear the username results list and let the 'validate' routine do the updates
<span class="nc" id="L441">            mUsernameResults.clear();</span>

<span class="nc" id="L443">            validateAndStyleUsername(mUsernamesEmails.getChipsStrings(), null);</span>
        }
<span class="nc" id="L445">    }</span>

    private void setRole(String newRole) {
<span class="nc" id="L448">        mCurrentRole = newRole;</span>
<span class="nc" id="L449">        refreshRoleTextView();</span>
<span class="nc" id="L450">    }</span>

    private void refreshRoleTextView() {
<span class="nc" id="L453">        mRoleTextView.setText(RoleUtils.getDisplayName(mCurrentRole, mInviteRoles));</span>
<span class="nc" id="L454">    }</span>

    private void validateAndStyleUsername(Collection&lt;String&gt; usernames,
                                          final ValidationEndListener validationEndListener) {
<span class="nc" id="L458">        List&lt;String&gt; usernamesToCheck = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L460" title="All 2 branches missed.">        for (String username : usernames) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if (mUsernameResults.containsKey(username)) {</span>
<span class="nc" id="L462">                String resultMessage = mUsernameResults.get(username);</span>
<span class="nc" id="L463">                styleChip(username, resultMessage);</span>
<span class="nc" id="L464">                updateUsernameError(username, resultMessage);</span>
<span class="nc" id="L465">            } else {</span>
<span class="nc" id="L466">                styleChip(username, null);</span>
<span class="nc" id="L467">                updateUsernameError(username, null);</span>

<span class="nc" id="L469">                usernamesToCheck.add(username);</span>
            }
<span class="nc" id="L471">        }</span>

<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (usernamesToCheck.size() &gt; 0) {</span>
<span class="nc" id="L474">            long wpcomBlogId = mSite.getSiteId();</span>
<span class="nc" id="L475">            PeopleUtils.validateUsernames(usernamesToCheck, mCurrentRole, wpcomBlogId,</span>
<span class="nc" id="L476">                    new PeopleUtils.ValidateUsernameCallback() {</span>
                        @Override
                        public void onUsernameValidation(String username,
                                                         ValidationResult validationResult) {
<span class="nc bnc" id="L480" title="All 2 branches missed.">                            if (!isAdded()) {</span>
<span class="nc" id="L481">                                return;</span>
                            }

<span class="nc bnc" id="L484" title="All 2 branches missed.">                            if (!isUserInInvitees(username)) {</span>
                                // user is removed from invitees before validation
<span class="nc" id="L486">                                return;</span>
                            }

<span class="nc" id="L489">                            final String usernameResultString =</span>
<span class="nc" id="L490">                                    getValidationErrorString(username, validationResult);</span>
<span class="nc" id="L491">                            mUsernameResults.put(username, usernameResultString);</span>

<span class="nc" id="L493">                            styleChip(username, usernameResultString);</span>
<span class="nc" id="L494">                            updateUsernameError(username, usernameResultString);</span>
<span class="nc" id="L495">                        }</span>

                        @Override
                        public void onValidationFinished() {
<span class="nc bnc" id="L499" title="All 2 branches missed.">                            if (validationEndListener != null) {</span>
<span class="nc" id="L500">                                validationEndListener.onValidationEnd();</span>
                            }
<span class="nc" id="L502">                        }</span>

                        @Override
                        public void onError() {
                            // properly style the button
<span class="nc" id="L507">                        }</span>
                    });
<span class="nc" id="L509">        } else {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">            if (validationEndListener != null) {</span>
<span class="nc" id="L511">                validationEndListener.onValidationEnd();</span>
            }
        }
<span class="nc" id="L514">    }</span>

    private void styleChip(String username, @Nullable String validationResultMessage) {
<span class="nc bnc" id="L517" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L518">            return;</span>
        }

<span class="nc bnc" id="L521" title="All 2 branches missed.">        ItemValidationState resultState = validationResultMessage == null ? ItemValidationState.NEUTRAL</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                : (validationResultMessage.equals(FLAG_SUCCESS)</span>
<span class="nc" id="L523">                        ? ItemValidationState.VALIDATED</span>
<span class="nc" id="L524">                        : ItemValidationState.VALIDATED_WITH_ERRORS);</span>

<span class="nc" id="L526">        mUsernamesEmails.addOrUpdateChip(username, resultState);</span>
<span class="nc" id="L527">    }</span>

    private
    @Nullable
    String getValidationErrorString(String username, ValidationResult validationResult) {
<span class="nc bnc" id="L532" title="All 7 branches missed.">        switch (validationResult) {</span>
            case USER_NOT_FOUND:
<span class="nc" id="L534">                return getString(R.string.invite_username_not_found, username);</span>
            case ALREADY_MEMBER:
<span class="nc" id="L536">                return getString(R.string.invite_already_a_member, username);</span>
            case ALREADY_FOLLOWING:
<span class="nc" id="L538">                return getString(R.string.invite_already_following, username);</span>
            case BLOCKED_INVITES:
<span class="nc" id="L540">                return getString(R.string.invite_user_blocked_invites, username);</span>
            case INVALID_EMAIL:
<span class="nc" id="L542">                return getString(R.string.invite_invalid_email, username);</span>
            case USER_FOUND:
<span class="nc" id="L544">                return FLAG_SUCCESS;</span>
        }

<span class="nc" id="L547">        return null;</span>
    }

    private void updateUsernameError(String username, @Nullable String usernameResult) {
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L552">            return;</span>
        }

        TextView usernameErrorTextView;
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (mUsernameErrorViews.containsKey(username)) {</span>
<span class="nc" id="L557">            usernameErrorTextView = (TextView) mUsernameErrorViews.get(username);</span>

<span class="nc bnc" id="L559" title="All 4 branches missed.">            if (usernameResult == null || usernameResult.equals(FLAG_SUCCESS)) {</span>
                // no error so we need to remove the existing error view
<span class="nc" id="L561">                ((ViewGroup) usernameErrorTextView.getParent()).removeView(usernameErrorTextView);</span>
<span class="nc" id="L562">                mUsernameErrorViews.remove(username);</span>
<span class="nc" id="L563">                return;</span>
            }
        } else {
<span class="nc bnc" id="L566" title="All 4 branches missed.">            if (usernameResult == null || usernameResult.equals(FLAG_SUCCESS)) {</span>
                // no error so no need to create a new error view
<span class="nc" id="L568">                return;</span>
            }

<span class="nc" id="L571">            final ViewGroup usernameErrorsContainer = (ViewGroup) getView()</span>
<span class="nc" id="L572">                    .findViewById(R.id.username_errors_container);</span>

<span class="nc" id="L574">            usernameErrorTextView = (TextView) LayoutInflater.from(getActivity())</span>
<span class="nc" id="L575">                                                             .inflate(R.layout.people_invite_error_view,</span>
                                                                     usernameErrorsContainer, false);

<span class="nc" id="L578">            usernameErrorsContainer.addView(usernameErrorTextView);</span>

<span class="nc" id="L580">            mUsernameErrorViews.put(username, usernameErrorTextView);</span>
        }
<span class="nc" id="L582">        usernameErrorTextView.setText(usernameResult);</span>
<span class="nc" id="L583">    }</span>

    private void clearUsernames(Collection&lt;String&gt; usernames) {
<span class="nc bnc" id="L586" title="All 2 branches missed.">        for (String username : usernames) {</span>
<span class="nc" id="L587">            removeUsername(username);</span>
<span class="nc" id="L588">        }</span>

<span class="nc bnc" id="L590" title="All 2 branches missed.">        if (!mUsernamesEmails.hasChips()) {</span>
<span class="nc" id="L591">            setRole(getDefaultRole());</span>
<span class="nc" id="L592">            resetEditTextContent(mCustomMessageEditText);</span>
        }
<span class="nc" id="L594">    }</span>

    @Override
    public void send() {
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L599">            return;</span>
        }

<span class="nc bnc" id="L602" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(getActivity())) {</span>
<span class="nc" id="L603">            enableSendButton(true);</span>
<span class="nc" id="L604">            return;</span>
        }

<span class="nc" id="L607">        enableSendButton(false);</span>

<span class="nc" id="L609">        String lastMinuteUser = mUsernamesEmails.getTextIfAvailableOrNull();</span>

<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (lastMinuteUser != null) {</span>
<span class="nc" id="L612">            addUsername(lastMinuteUser, new ValidationEndListener() {</span>
                @Override
                public void onValidationEnd() {
<span class="nc bnc" id="L615" title="All 2 branches missed.">                    if (!checkAndSend()) {</span>
                        // re-enable SEND button if validation failed
<span class="nc" id="L617">                        enableSendButton(true);</span>
                    }
<span class="nc" id="L619">                }</span>
            });
        } else {
<span class="nc bnc" id="L622" title="All 2 branches missed.">            if (!checkAndSend()) {</span>
                // re-enable SEND button if validation failed
<span class="nc" id="L624">                enableSendButton(true);</span>
            }
        }
<span class="nc" id="L627">    }</span>

    /*
     * returns true if send is attempted, false if validation failed
     * */
    private boolean checkAndSend() {
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L634">            return false;</span>
        }

<span class="nc bnc" id="L637" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(getActivity())) {</span>
<span class="nc" id="L638">            return false;</span>
        }

<span class="nc bnc" id="L641" title="All 2 branches missed.">        if (!mUsernamesEmails.hasChips()) {</span>
<span class="nc" id="L642">            ToastUtils.showToast(getActivity(), R.string.invite_error_no_usernames);</span>
<span class="nc" id="L643">            return false;</span>
        }

<span class="nc" id="L646">        int invalidCount = 0;</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">        for (String usernameResultString : mUsernameResults.values()) {</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">            if (!usernameResultString.equals(FLAG_SUCCESS)) {</span>
<span class="nc" id="L649">                invalidCount++;</span>
            }
<span class="nc" id="L651">        }</span>

<span class="nc bnc" id="L653" title="All 2 branches missed.">        if (invalidCount &gt; 0) {</span>
<span class="nc" id="L654">            ToastUtils.showToast(getActivity(),</span>
<span class="nc" id="L655">                    StringUtils.getQuantityString(getActivity(), 0,</span>
                            R.string.invite_error_invalid_usernames_one,
                            R.string.invite_error_invalid_usernames_multiple,
                            invalidCount));
<span class="nc" id="L659">            return false;</span>
        }

        // set the &quot;SEND&quot; option disabled
<span class="nc" id="L663">        enableSendButton(false);</span>

<span class="nc" id="L665">        long wpcomBlogId = mSite.getSiteId();</span>
<span class="nc" id="L666">        PeopleUtils.sendInvitations(</span>
<span class="nc" id="L667">                new ArrayList&lt;&gt;(mUsernamesEmails.getChipsStrings()), mCurrentRole, mCustomMessage, wpcomBlogId,</span>
<span class="nc" id="L668">                new PeopleUtils.InvitationsSendCallback() {</span>
                    @Override
                    public void onSent(List&lt;String&gt; succeededUsernames, Map&lt;String, String&gt; failedUsernameErrors) {
<span class="nc bnc" id="L671" title="All 2 branches missed.">                        if (!isAdded()) {</span>
<span class="nc" id="L672">                            return;</span>
                        }

<span class="nc" id="L675">                        clearUsernames(succeededUsernames);</span>

<span class="nc bnc" id="L677" title="All 2 branches missed.">                        if (failedUsernameErrors.size() != 0) {</span>
<span class="nc" id="L678">                            clearUsernames(failedUsernameErrors.keySet());</span>

<span class="nc bnc" id="L680" title="All 2 branches missed.">                            for (Map.Entry&lt;String, String&gt; error : failedUsernameErrors.entrySet()) {</span>
<span class="nc" id="L681">                                final String username = error.getKey();</span>
<span class="nc" id="L682">                                final String errorMessage = error.getValue();</span>
<span class="nc" id="L683">                                mUsernameResults.put(username, getString(R.string.invite_error_for_username,</span>
                                        username, errorMessage));
<span class="nc" id="L685">                            }</span>

<span class="nc" id="L687">                            populateUsernameChips(failedUsernameErrors.keySet());</span>

<span class="nc bnc" id="L689" title="All 2 branches missed.">                            ToastUtils.showToast(getActivity(), succeededUsernames.isEmpty()</span>
<span class="nc" id="L690">                                    ? R.string.invite_error_sending</span>
<span class="nc" id="L691">                                    : R.string.invite_error_some_failed);</span>

<span class="nc bnc" id="L693" title="All 2 branches missed.">                            if (!succeededUsernames.isEmpty()) {</span>
<span class="nc" id="L694">                                AnalyticsTracker.track(Stat.PEOPLE_MANAGEMENT_USER_INVITED);</span>
                            }
                        } else {
<span class="nc" id="L697">                            ToastUtils.showToast(getActivity(), R.string.invite_sent, ToastUtils.Duration.LONG);</span>
<span class="nc" id="L698">                            AnalyticsTracker.track(Stat.PEOPLE_MANAGEMENT_USER_INVITED);</span>
                        }

                        // set the &quot;SEND&quot; option enabled again
<span class="nc" id="L702">                        enableSendButton(true);</span>
<span class="nc" id="L703">                    }</span>

                    @Override
                    public void onError() {
<span class="nc bnc" id="L707" title="All 2 branches missed.">                        if (!isAdded()) {</span>
<span class="nc" id="L708">                            return;</span>
                        }
<span class="nc" id="L710">                        ToastUtils.showToast(getActivity(), R.string.invite_error_sending);</span>
                        // set the &quot;SEND&quot; option enabled again
<span class="nc" id="L712">                        enableSendButton(true);</span>
<span class="nc" id="L713">                    }</span>
                });

<span class="nc" id="L716">        return true;</span>
    }

    private void enableSendButton(boolean enable) {
<span class="nc bnc" id="L720" title="All 2 branches missed.">        mInviteOperationInProgress = !enable;</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (getActivity() != null) {</span>
<span class="nc" id="L722">            getActivity().invalidateOptionsMenu();</span>
        }
<span class="nc" id="L724">    }</span>

    private void manageActionButtonsEnabledState(boolean enable) {
<span class="nc" id="L727">        mGenerateLinksButton.setEnabled(enable);</span>
<span class="nc" id="L728">        mShareLinksButton.setEnabled(enable);</span>
<span class="nc" id="L729">        mLinksRoleTextView.setEnabled(enable);</span>
<span class="nc" id="L730">        mDisableLinksButton.setEnabled(enable);</span>
<span class="nc" id="L731">    }</span>

    private void manageShimmerSection(boolean showShimmerSection, boolean startShimmer) {
<span class="nc bnc" id="L734" title="All 2 branches missed.">        mShimmerContainer.setVisibility(showShimmerSection ? View.VISIBLE : View.GONE);</span>

<span class="nc bnc" id="L736" title="All 2 branches missed.">        if (startShimmer) {</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">            if (mShimmerContainer.isShimmerVisible()) {</span>
<span class="nc" id="L738">                mShimmerContainer.startShimmer();</span>
            } else {
<span class="nc" id="L740">                mShimmerContainer.showShimmer(true);</span>
            }
        } else {
<span class="nc" id="L743">            mShimmerContainer.hideShimmer();</span>
        }
<span class="nc" id="L745">    }</span>

    private void manageLinksControlsVisibility(InviteLinksUiState uiState) {
<span class="nc bnc" id="L748" title="All 2 branches missed.">        mInviteLinkContainer.setVisibility(uiState.isLinksSectionVisible() ? View.VISIBLE : View.GONE);</span>

<span class="nc" id="L750">        mLoadAndRetryLinksContainer.setVisibility(</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">                uiState.getLoadAndRetryUiState() == LoadAndRetryUiState.HIDDEN</span>
<span class="nc" id="L752">                        ? View.GONE</span>
<span class="nc" id="L753">                        : View.VISIBLE</span>
        );
<span class="nc" id="L755">        mLoadingLinksProgress.setVisibility(</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">                uiState.getLoadAndRetryUiState() == LoadAndRetryUiState.LOADING</span>
<span class="nc" id="L757">                        ? View.VISIBLE</span>
<span class="nc" id="L758">                        : View.GONE</span>
        );
<span class="nc" id="L760">        mRetryButton.setVisibility(</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">                uiState.getLoadAndRetryUiState() == LoadAndRetryUiState.RETRY</span>
<span class="nc" id="L762">                        ? View.VISIBLE</span>
<span class="nc" id="L763">                        : View.GONE</span>
        );
<span class="nc" id="L765">    }</span>

    private void setLinksRoleControlsBehaviour(boolean allowRoleSelection) {
<span class="nc" id="L768">        mLinksRoleTextView.setShowSoftInputOnFocus(false);</span>
<span class="nc" id="L769">        mLinksRoleTextView.setInputType(EditorInfo.TYPE_NULL);</span>
<span class="nc" id="L770">        mLinksRoleTextView.setKeyListener(null);</span>

<span class="nc bnc" id="L772" title="All 2 branches missed.">        if (allowRoleSelection) {</span>
<span class="nc" id="L773">            mLinksRoleContainer.setEndIconMode(END_ICON_DROPDOWN_MENU);</span>
<span class="nc" id="L774">            mLinksRoleTextView.setOnClickListener(v -&gt; {</span>
<span class="nc" id="L775">                mViewModel.onLinksRoleClicked();</span>
<span class="nc" id="L776">            });</span>
<span class="nc" id="L777">            mLinksRoleTextView.setFocusable(true);</span>
<span class="nc" id="L778">            mLinksRoleTextView.setFocusableInTouchMode(true);</span>
        } else {
<span class="nc" id="L780">            mLinksRoleContainer.setEndIconMode(END_ICON_NONE);</span>
<span class="nc" id="L781">            mLinksRoleTextView.setOnClickListener(null);</span>
<span class="nc" id="L782">            mLinksRoleTextView.setFocusable(false);</span>
<span class="nc" id="L783">            mLinksRoleTextView.setFocusableInTouchMode(false);</span>
        }

<span class="nc" id="L786">        mLinksRoleContainer.setEndIconOnClickListener(null);</span>
<span class="nc" id="L787">        mLinksRoleContainer.setEndIconCheckable(false);</span>
<span class="nc" id="L788">    }</span>

    public interface ValidationEndListener {
        void onValidationEnd();
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>