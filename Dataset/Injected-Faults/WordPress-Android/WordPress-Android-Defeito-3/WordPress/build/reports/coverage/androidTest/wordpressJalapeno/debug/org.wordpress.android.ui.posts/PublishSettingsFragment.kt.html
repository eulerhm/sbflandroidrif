<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PublishSettingsFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PublishSettingsFragment.kt</span></div><h1>PublishSettingsFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import android.annotation.SuppressLint
import android.app.AlarmManager
import android.app.PendingIntent
import android.content.Context.ALARM_SERVICE
import android.content.Intent
import android.os.Bundle
import android.os.Parcelable
import android.provider.CalendarContract
import android.provider.CalendarContract.Events
import android.view.Gravity
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.LinearLayout
import android.widget.TextView
import androidx.annotation.LayoutRes
import androidx.core.app.NotificationManagerCompat
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import kotlinx.parcelize.Parcelize
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.fluxc.store.PostSchedulingNotificationStore.SchedulingReminderModel
import org.wordpress.android.ui.posts.EditPostSettingsFragment.EditPostActivityHook
import org.wordpress.android.ui.posts.PublishSettingsFragmentType.EDIT_POST
import org.wordpress.android.util.AccessibilityUtils
import org.wordpress.android.util.ToastUtils
import org.wordpress.android.util.ToastUtils.Duration.SHORT
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

<span class="nc" id="L35">abstract class PublishSettingsFragment : Fragment() {</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">    @Inject lateinit var analyticsTrackerWrapper: AnalyticsTrackerWrapper</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">    lateinit var viewModel: PublishSettingsViewModel</span>

    @LayoutRes protected abstract fun getContentLayout(): Int

    protected abstract fun getPublishSettingsFragmentType(): PublishSettingsFragmentType

    protected abstract fun setupContent(
        rootView: ViewGroup,
        viewModel: PublishSettingsViewModel
    )

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
<span class="nc bnc" id="L50" title="All 2 branches missed.">        val rootView = inflater.inflate(getContentLayout(), container, false) as ViewGroup</span>
<span class="nc" id="L51">        val dateAndTime = rootView.findViewById&lt;TextView&gt;(R.id.publish_time_and_date)</span>
<span class="nc" id="L52">        val dateAndTimeContainer = rootView.findViewById&lt;LinearLayout&gt;(R.id.publish_time_and_date_container)</span>
<span class="nc" id="L53">        val publishNotification = rootView.findViewById&lt;TextView&gt;(R.id.publish_notification)</span>
<span class="nc" id="L54">        val publishNotificationTitle = rootView.findViewById&lt;TextView&gt;(R.id.publish_notification_title)</span>
<span class="nc" id="L55">        val publishNotificationContainer = rootView.findViewById&lt;LinearLayout&gt;(R.id.publish_notification_container)</span>
<span class="nc" id="L56">        val addToCalendarContainer = rootView.findViewById&lt;LinearLayout&gt;(R.id.post_add_to_calendar_container)</span>
<span class="nc" id="L57">        val addToCalendar = rootView.findViewById&lt;TextView&gt;(R.id.post_add_to_calendar)</span>

<span class="nc" id="L59">        AccessibilityUtils.disableHintAnnouncement(dateAndTime)</span>
<span class="nc" id="L60">        AccessibilityUtils.disableHintAnnouncement(publishNotification)</span>

<span class="nc" id="L62">        dateAndTimeContainer.setOnClickListener { showPostDateSelectionDialog() }</span>

<span class="nc" id="L64">        setupContent(rootView, viewModel)</span>

<span class="nc" id="L66">        viewModel.onDatePicked.observeEvent(viewLifecycleOwner, {</span>
<span class="nc" id="L67">            showPostTimeSelectionDialog()</span>
<span class="nc" id="L68">        })</span>
<span class="nc" id="L69">        viewModel.onPublishedDateChanged.observeEvent(viewLifecycleOwner, { date -&gt;</span>
<span class="nc" id="L70">            viewModel.updatePost(date, getPostRepository())</span>
<span class="nc" id="L71">            trackPostScheduled()</span>
<span class="nc" id="L72">        })</span>
<span class="nc" id="L73">        viewModel.onNotificationTime.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            it?.let { notificationTime -&gt;</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                getPostRepository()?.let { postRepository -&gt;</span>
<span class="nc" id="L76">                    viewModel.scheduleNotification(postRepository, notificationTime)</span>
<span class="nc" id="L77">                }</span>
<span class="nc" id="L78">            }</span>
<span class="nc" id="L79">        })</span>
<span class="nc" id="L80">        viewModel.onUiModel.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            it?.let { uiModel -&gt;</span>
<span class="nc" id="L82">                dateAndTime.text = uiModel.publishDateLabel</span>
<span class="nc" id="L83">                publishNotificationTitle.isEnabled = uiModel.notificationEnabled</span>
<span class="nc" id="L84">                publishNotification.isEnabled = uiModel.notificationEnabled</span>
<span class="nc" id="L85">                publishNotificationContainer.isEnabled = uiModel.notificationEnabled</span>
<span class="nc" id="L86">                addToCalendar.isEnabled = uiModel.notificationEnabled</span>
<span class="nc" id="L87">                addToCalendarContainer.isEnabled = uiModel.notificationEnabled</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (uiModel.notificationEnabled) {</span>
<span class="nc" id="L89">                    publishNotificationContainer.setOnClickListener {</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">                        getPostRepository()?.getPost()?.let { postModel -&gt;</span>
<span class="nc" id="L91">                            viewModel.onShowDialog(postModel)</span>
<span class="nc" id="L92">                        }</span>
<span class="nc" id="L93">                    }</span>
<span class="nc" id="L94">                    addToCalendarContainer.setOnClickListener {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                        getPostRepository()?.let { postRepository -&gt;</span>
<span class="nc" id="L96">                            viewModel.onAddToCalendar(postRepository)</span>
<span class="nc" id="L97">                        }</span>
<span class="nc" id="L98">                    }</span>
                } else {
<span class="nc" id="L100">                    publishNotificationContainer.setOnClickListener(null)</span>
<span class="nc" id="L101">                    addToCalendarContainer.setOnClickListener(null)</span>
                }
<span class="nc" id="L103">                publishNotification.setText(uiModel.notificationLabel)</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                publishNotificationContainer.visibility = if (uiModel.notificationVisible) View.VISIBLE else View.GONE</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                addToCalendarContainer.visibility = if (uiModel.notificationVisible) View.VISIBLE else View.GONE</span>
<span class="nc" id="L106">            }</span>
<span class="nc" id="L107">        })</span>
<span class="nc" id="L108">        viewModel.onShowNotificationDialog.observeEvent(viewLifecycleOwner, { notificationTime -&gt;</span>
<span class="nc" id="L109">            showNotificationTimeSelectionDialog(notificationTime)</span>
<span class="nc" id="L110">        })</span>
<span class="nc" id="L111">        viewModel.onToast.observeEvent(viewLifecycleOwner, {</span>
<span class="nc" id="L112">            ToastUtils.showToast(</span>
<span class="nc" id="L113">                    context,</span>
<span class="nc" id="L114">                    it,</span>
<span class="nc" id="L115">                    SHORT,</span>
<span class="nc" id="L116">                    Gravity.TOP</span>
            )
<span class="nc" id="L118">        })</span>
<span class="nc" id="L119">        viewModel.onNotificationAdded.observeEvent(viewLifecycleOwner, { notification -&gt;</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            activity?.let {</span>
<span class="nc" id="L121">                NotificationManagerCompat.from(it).cancel(notification.id)</span>
<span class="nc" id="L122">                val notificationIntent = Intent(it, PublishNotificationReceiver::class.java)</span>
<span class="nc" id="L123">                notificationIntent.putExtra(PublishNotificationReceiver.NOTIFICATION_ID, notification.id)</span>
<span class="nc" id="L124">                val pendingIntent = PendingIntent.getBroadcast(</span>
<span class="nc" id="L125">                        it,</span>
<span class="nc" id="L126">                        notification.id,</span>
<span class="nc" id="L127">                        notificationIntent,</span>
<span class="nc" id="L128">                        PendingIntent.FLAG_CANCEL_CURRENT or PendingIntent.FLAG_IMMUTABLE</span>
                )

<span class="nc bnc" id="L131" title="All 2 branches missed.">                val alarmManager = it.getSystemService(ALARM_SERVICE) as AlarmManager</span>
<span class="nc" id="L132">                alarmManager.set(</span>
<span class="nc" id="L133">                        AlarmManager.RTC_WAKEUP,</span>
<span class="nc" id="L134">                        notification.scheduledTime,</span>
<span class="nc" id="L135">                        pendingIntent</span>
                )
<span class="nc" id="L137">            }</span>
<span class="nc" id="L138">        })</span>
<span class="nc" id="L139">        viewModel.onAddToCalendar.observeEvent(viewLifecycleOwner, { calendarEvent -&gt;</span>
<span class="nc" id="L140">            val calIntent = Intent(Intent.ACTION_INSERT)</span>
<span class="nc" id="L141">            calIntent.data = Events.CONTENT_URI</span>
<span class="nc" id="L142">            calIntent.type = &quot;vnd.android.cursor.item/event&quot;</span>
<span class="nc" id="L143">            calIntent.putExtra(Events.TITLE, calendarEvent.title)</span>
<span class="nc" id="L144">            calIntent.putExtra(Events.DESCRIPTION, calendarEvent.description)</span>
<span class="nc" id="L145">            calIntent.putExtra(CalendarContract.EXTRA_EVENT_BEGIN_TIME, calendarEvent.startTime)</span>
<span class="nc" id="L146">            startActivity(calIntent)</span>
<span class="nc" id="L147">        })</span>
<span class="nc" id="L148">        viewModel.start(getPostRepository())</span>
<span class="nc" id="L149">        return rootView</span>
    }

    private fun trackPostScheduled() {
<span class="nc bnc" id="L153" title="All 3 branches missed.">        when (getPublishSettingsFragmentType()) {</span>
            EDIT_POST -&gt; {
<span class="nc" id="L155">                analyticsTrackerWrapper.trackPostSettings(Stat.EDITOR_POST_SCHEDULE_CHANGED)</span>
            }
            PublishSettingsFragmentType.PREPUBLISHING_NUDGES -&gt; {
<span class="nc" id="L158">                analyticsTrackerWrapper.trackPrepublishingNudges(Stat.EDITOR_POST_SCHEDULE_CHANGED)</span>
            }
        }
<span class="nc" id="L161">    }</span>

    private fun showPostDateSelectionDialog() {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L165">            return</span>
        }

<span class="nc" id="L168">        val fragment = PostDatePickerDialogFragment.newInstance(getPublishSettingsFragmentType())</span>
<span class="nc" id="L169">        fragment.show(requireActivity().supportFragmentManager, PostDatePickerDialogFragment.TAG)</span>
<span class="nc" id="L170">    }</span>

    private fun showPostTimeSelectionDialog() {
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L174">            return</span>
        }

<span class="nc" id="L177">        val fragment = PostTimePickerDialogFragment.newInstance(getPublishSettingsFragmentType())</span>
<span class="nc" id="L178">        fragment.show(requireActivity().supportFragmentManager, PostTimePickerDialogFragment.TAG)</span>
<span class="nc" id="L179">    }</span>

    private fun showNotificationTimeSelectionDialog(schedulingReminderPeriod: SchedulingReminderModel.Period?) {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L183">            return</span>
        }

<span class="nc" id="L186">        val fragment = PostNotificationScheduleTimeDialogFragment.newInstance(</span>
<span class="nc" id="L187">                schedulingReminderPeriod,</span>
<span class="nc" id="L188">                getPublishSettingsFragmentType()</span>
        )
<span class="nc" id="L190">        fragment.show(requireActivity().supportFragmentManager, PostNotificationScheduleTimeDialogFragment.TAG)</span>
<span class="nc" id="L191">    }</span>

    private fun getPostRepository(): EditPostRepository? {
<span class="nc bnc" id="L194" title="All 2 branches missed.">        return getEditPostActivityHook()?.editPostRepository</span>
    }

    private fun getEditPostActivityHook(): EditPostActivityHook? {
<span class="nc bnc" id="L198" title="All 2 branches missed.">        val activity = activity ?: return null</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">        return if (activity is EditPostActivityHook) {</span>
<span class="nc" id="L201">            activity</span>
        } else {
<span class="nc" id="L203">            throw RuntimeException(&quot;$activity must implement EditPostActivityHook&quot;)</span>
        }
    }
}

@Parcelize
@SuppressLint(&quot;ParcelCreator&quot;)
enum class PublishSettingsFragmentType : Parcelable {
<span class="nc" id="L211">    EDIT_POST,</span>
<span class="nc" id="L212">    PREPUBLISHING_NUDGES</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>