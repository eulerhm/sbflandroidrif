<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TagsFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">TagsFragment.java</span></div><h1>TagsFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts;

import android.os.Bundle;
import android.text.Editable;
import android.text.TextUtils;
import android.text.TextWatcher;
import android.view.KeyEvent;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.EditText;

import androidx.annotation.LayoutRes;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import org.apache.commons.text.StringEscapeUtils;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.TaxonomyStore;
import org.wordpress.android.fluxc.store.TaxonomyStore.OnTaxonomyChanged;
import org.wordpress.android.util.ActivityUtils;

import javax.inject.Inject;

import static org.wordpress.android.ui.posts.PostSettingsTagsActivity.KEY_TAGS;

public abstract class TagsFragment extends Fragment implements TextWatcher, View.OnKeyListener, TagSelectedListener {
    private SiteModel mSite;

    private EditText mTagsEditText;
    private TagsRecyclerViewAdapter mAdapter;

    @Inject Dispatcher mDispatcher;
    @Inject TaxonomyStore mTaxonomyStore;

    private String mTags;

    TagsSelectedListener mTagsSelectedListener;

<span class="nc" id="L48">    public TagsFragment() {</span>
<span class="nc" id="L49">    }</span>

    protected abstract @LayoutRes int getContentLayout();

    protected abstract String getTagsFromEditPostRepositoryOrArguments();

    @Override public void onCreate(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L56">        super.onCreate(savedInstanceState);</span>

<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (getArguments() != null) {</span>
<span class="nc" id="L59">            mSite = (SiteModel) getArguments().getSerializable(WordPress.SITE);</span>
<span class="nc" id="L60">            mTags = getArguments().getString(KEY_TAGS);</span>

<span class="nc bnc" id="L62" title="All 2 branches missed.">            if (mSite == null) {</span>
<span class="nc" id="L63">                throw new IllegalStateException(&quot;Required argument mSite is missing.&quot;);</span>
            }
        }
<span class="nc" id="L66">    }</span>

    @Override public void onDetach() {
<span class="nc" id="L69">        super.onDetach();</span>
<span class="nc" id="L70">        mTagsSelectedListener = null;</span>
<span class="nc" id="L71">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        // Inflate the layout for this fragment
<span class="nc" id="L77">        return inflater.inflate(getContentLayout(), container, false);</span>
    }

    @Override public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
<span class="nc" id="L81">        super.onViewCreated(view, savedInstanceState);</span>

<span class="nc" id="L83">        RecyclerView recyclerView = (RecyclerView) view.findViewById(R.id.tags_suggestion_list);</span>
<span class="nc" id="L84">        recyclerView.setHasFixedSize(true);</span>
<span class="nc" id="L85">        recyclerView.setLayoutManager(new LinearLayoutManager(requireActivity()));</span>

<span class="nc" id="L87">        mAdapter = new TagsRecyclerViewAdapter(requireActivity(), this);</span>
<span class="nc" id="L88">        mAdapter.setAllTags(mTaxonomyStore.getTagsForSite(mSite));</span>
<span class="nc" id="L89">        recyclerView.setAdapter(mAdapter);</span>

<span class="nc" id="L91">        mTagsEditText = (EditText) view.findViewById(R.id.tags_edit_text);</span>
<span class="nc" id="L92">        mTagsEditText.setOnKeyListener(this);</span>
<span class="nc" id="L93">        mTagsEditText.requestFocus();</span>
<span class="nc" id="L94">        ActivityUtils.showKeyboard(mTagsEditText);</span>
<span class="nc" id="L95">        mTagsEditText.post(() -&gt; mTagsEditText.addTextChangedListener(TagsFragment.this));</span>

<span class="nc" id="L97">        loadTags();</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (!TextUtils.isEmpty(mTags)) {</span>
            // add a , at the end so the user can start typing a new tag
<span class="nc" id="L101">            mTags += &quot;,&quot;;</span>
<span class="nc" id="L102">            mTags = StringEscapeUtils.unescapeHtml4(mTags);</span>
<span class="nc" id="L103">            mTagsEditText.setText(mTags);</span>
<span class="nc" id="L104">            mTagsEditText.setSelection(mTagsEditText.length());</span>
        }
<span class="nc" id="L106">        filterListForCurrentText();</span>
<span class="nc" id="L107">    }</span>

    private void loadTags() {
<span class="nc" id="L110">        mTags = getTagsFromEditPostRepositoryOrArguments();</span>
<span class="nc" id="L111">    }</span>

    @Override
    public void onStart() {
<span class="nc" id="L115">        super.onStart();</span>
<span class="nc" id="L116">        mDispatcher.register(this);</span>
<span class="nc" id="L117">    }</span>

    @Override
    public void onStop() {
<span class="nc" id="L121">        mDispatcher.unregister(this);</span>
<span class="nc" id="L122">        super.onStop();</span>
<span class="nc" id="L123">    }</span>

    @Override
    public boolean onKey(View view, int keyCode, KeyEvent keyEvent) {
<span class="nc bnc" id="L127" title="All 4 branches missed.">        if ((keyEvent.getAction() == KeyEvent.ACTION_DOWN)</span>
            &amp;&amp; (keyCode == KeyEvent.KEYCODE_ENTER)) {
            // Since we don't allow new lines, we should add comma on &quot;enter&quot; to separate the tags
<span class="nc" id="L130">            String currentText = mTagsEditText.getText().toString();</span>
<span class="nc bnc" id="L131" title="All 4 branches missed.">            if (!currentText.isEmpty() &amp;&amp; !currentText.endsWith(&quot;,&quot;)) {</span>
<span class="nc" id="L132">                mTagsEditText.setText(currentText.concat(&quot;,&quot;));</span>
<span class="nc" id="L133">                mTagsEditText.setSelection(mTagsEditText.length());</span>
            }
<span class="nc" id="L135">            return true;</span>
        }
<span class="nc" id="L137">        return false;</span>
    }

    @Override
    public void beforeTextChanged(CharSequence charSequence, int i, int i1, int i2) {
        // No-op
<span class="nc" id="L143">    }</span>

    @Override
    public void onTextChanged(CharSequence charSequence, int i, int i1, int i2) {
<span class="nc" id="L147">        filterListForCurrentText();</span>
<span class="nc" id="L148">        mTagsSelectedListener.onTagsSelected(charSequence.toString());</span>
<span class="nc" id="L149">    }</span>

    @Override
    public void afterTextChanged(Editable editable) {
        // No-op
<span class="nc" id="L154">    }</span>

    // Find the text after the last occurrence of &quot;,&quot; and filter with it
    private void filterListForCurrentText() {
<span class="nc" id="L158">        String text = mTagsEditText.getText().toString();</span>
<span class="nc" id="L159">        int endIndex = text.lastIndexOf(&quot;,&quot;);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (endIndex == -1) {</span>
<span class="nc" id="L161">            mAdapter.filter(text);</span>
        } else {
<span class="nc" id="L163">            String textToFilter = text.substring(endIndex + 1).trim();</span>
<span class="nc" id="L164">            mAdapter.filter(textToFilter);</span>
        }
<span class="nc" id="L166">    }</span>

    public void onTagSelected(@NonNull String selectedTag) {
<span class="nc" id="L169">        String text = mTagsEditText.getText().toString();</span>
        String updatedText;
<span class="nc" id="L171">        int endIndex = text.lastIndexOf(&quot;,&quot;);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (endIndex == -1) {</span>
            // no &quot;,&quot; found, replace the current text with the selectedTag
<span class="nc" id="L174">            updatedText = selectedTag;</span>
        } else {
            // there are multiple tags already, only update the text after the last &quot;,&quot;
<span class="nc" id="L177">            updatedText = text.substring(0, endIndex + 1) + selectedTag;</span>
        }
<span class="nc" id="L179">        updatedText += &quot;,&quot;;</span>
<span class="nc" id="L180">        updatedText = StringEscapeUtils.unescapeHtml4(updatedText);</span>
<span class="nc" id="L181">        mTagsEditText.setText(updatedText);</span>
<span class="nc" id="L182">        mTagsEditText.setSelection(mTagsEditText.length());</span>
<span class="nc" id="L183">    }</span>

    boolean wereTagsChanged() {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (mTags != null) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            return !mTags.equals(mTagsEditText.getText().toString());</span>
        } else {
<span class="nc bnc" id="L189" title="All 2 branches missed.">            return !mTagsEditText.getText().toString().isEmpty();</span>
        }
    }

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onTaxonomyChanged(OnTaxonomyChanged event) {
<span class="nc bnc" id="L196" title="All 2 branches missed.">        switch (event.causeOfChange) {</span>
            case FETCH_TAGS:
<span class="nc" id="L198">                mAdapter.setAllTags(mTaxonomyStore.getTagsForSite(mSite));</span>
<span class="nc" id="L199">                filterListForCurrentText();</span>
                break;
        }
<span class="nc" id="L202">    }</span>

    void closeKeyboard() {
<span class="nc" id="L205">        ActivityUtils.hideKeyboardForced(mTagsEditText);</span>
<span class="nc" id="L206">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>