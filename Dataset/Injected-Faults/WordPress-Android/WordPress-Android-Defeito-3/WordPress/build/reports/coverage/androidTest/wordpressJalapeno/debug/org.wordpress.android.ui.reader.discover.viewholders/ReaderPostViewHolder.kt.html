<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderPostViewHolder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.discover.viewholders</a> &gt; <span class="el_source">ReaderPostViewHolder.kt</span></div><h1>ReaderPostViewHolder.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.discover.viewholders

import android.content.Context
import android.view.Gravity
import android.view.View
import android.view.ViewGroup
import androidx.appcompat.widget.ListPopupWindow
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.analytics.AnalyticsTracker
import org.wordpress.android.databinding.ReaderCardviewPostBinding
import org.wordpress.android.datasets.ReaderThumbnailTable
import org.wordpress.android.ui.reader.adapters.ReaderMenuAdapter
import org.wordpress.android.ui.reader.discover.ReaderCardUiState
import org.wordpress.android.ui.reader.discover.ReaderCardUiState.ReaderPostUiState
import org.wordpress.android.ui.reader.discover.ReaderPostCardAction
import org.wordpress.android.ui.reader.discover.ReaderPostCardAction.PrimaryAction
import org.wordpress.android.ui.reader.tracker.ReaderTracker
import org.wordpress.android.ui.reader.utils.ReaderVideoUtils
import org.wordpress.android.ui.reader.utils.ReaderVideoUtils.VideoThumbnailUrlListener
import org.wordpress.android.ui.reader.views.ReaderIconCountView
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.extensions.expandTouchTargetArea
import org.wordpress.android.util.extensions.getDrawableResIdFromAttribute
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.util.image.ImageType.BLAVATAR_CIRCULAR
import org.wordpress.android.util.image.ImageType.PHOTO_ROUNDED_CORNERS
import org.wordpress.android.util.image.ImageType.VIDEO
import org.wordpress.android.util.extensions.viewBinding

<span class="nc" id="L31">class ReaderPostViewHolder(</span>
<span class="nc" id="L32">    private val uiHelpers: UiHelpers,</span>
<span class="nc" id="L33">    private val imageManager: ImageManager,</span>
<span class="nc" id="L34">    private val readerTracker: ReaderTracker,</span>
    parentView: ViewGroup
<span class="nc" id="L36">) : ReaderViewHolder&lt;ReaderCardviewPostBinding&gt;(parentView.viewBinding(ReaderCardviewPostBinding::inflate)) {</span>
<span class="nc" id="L37">    val viewContext: Context = binding.postContainer.context</span>

<span class="nc" id="L39">    init {</span>
<span class="nc" id="L40">        with(binding) {</span>
<span class="nc" id="L41">            layoutDiscover.expandTouchTargetArea(R.dimen.reader_discover_layout_extra_padding, true)</span>
<span class="nc" id="L42">            imageMore.expandTouchTargetArea(R.dimen.reader_more_image_extra_padding, false)</span>
<span class="nc" id="L43">        }</span>
<span class="nc" id="L44">    }</span>

<span class="nc" id="L46">    override fun onBind(uiState: ReaderCardUiState) = with(binding) {</span>
<span class="nc" id="L47">        val state = uiState as ReaderPostUiState</span>

        // Expandable tags section
<span class="nc" id="L50">        uiHelpers.updateVisibility(expandableTagsView, state.expandableTagsViewVisibility)</span>
<span class="nc" id="L51">        expandableTagsView.updateUi(state.tagItems)</span>

        // Blog section
<span class="nc" id="L54">        updateBlogSection(state)</span>

        // More menu
<span class="nc" id="L57">        uiHelpers.updateVisibility(imageMore, state.moreMenuVisibility)</span>
<span class="nc" id="L58">        imageMore.setOnClickListener { uiState.onMoreButtonClicked.invoke(state) }</span>

        // Featured image section
<span class="nc" id="L61">        updateFeaturedImage(state)</span>
<span class="nc" id="L62">        uiHelpers.updateVisibility(imageVideoOverlay, state.videoOverlayVisibility)</span>
<span class="nc" id="L63">        uiHelpers.setTextOrHide(textPhotoTitle, state.photoTitle)</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        uiHelpers.updateVisibility(thumbnailStrip, state.thumbnailStripSection != null)</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        state.thumbnailStripSection?.let {</span>
<span class="nc" id="L66">            thumbnailStrip.loadThumbnails(it.images, it.isPrivate, it.content)</span>
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">        loadVideoThumbnail(state)</span>
<span class="nc" id="L69">        imageVideoOverlay.setOnClickListener { state.onVideoOverlayClicked(uiState.postId, uiState.blogId) }</span>

        // Content section
<span class="nc" id="L72">        uiHelpers.setTextOrHide(textTitle, state.title)</span>
<span class="nc" id="L73">        uiHelpers.setTextOrHide(textExcerpt, state.excerpt)</span>
<span class="nc" id="L74">        postContainer.setOnClickListener {</span>
<span class="nc" id="L75">            readerTracker.trackBlog(</span>
<span class="nc" id="L76">                    AnalyticsTracker.Stat.READER_POST_CARD_TAPPED,</span>
<span class="nc" id="L77">                    state.blogId,</span>
<span class="nc" id="L78">                    state.feedId,</span>
<span class="nc" id="L79">                    state.isFollowed,</span>
<span class="nc" id="L80">                    state.source</span>
            )
<span class="nc" id="L82">            state.onItemClicked(uiState.postId, uiState.blogId)</span>
<span class="nc" id="L83">        }</span>

        // Discover section
<span class="nc" id="L86">        updateDiscoverSection(state)</span>

        // Action buttons section
<span class="nc" id="L89">        updateActionButton(uiState.postId, uiState.blogId, uiState.likeAction, countLikes)</span>
<span class="nc" id="L90">        updateActionButton(uiState.postId, uiState.blogId, uiState.reblogAction, reblog)</span>
<span class="nc" id="L91">        updateActionButton(uiState.postId, uiState.blogId, uiState.commentsAction, countComments)</span>
<span class="nc" id="L92">        updateActionButton(uiState.postId, uiState.blogId, uiState.bookmarkAction, bookmark)</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">        state.moreMenuItems?.let {</span>
<span class="nc" id="L95">            renderMoreMenu(state, state.moreMenuItems, imageMore)</span>
<span class="nc" id="L96">        }</span>

<span class="nc" id="L98">        state.onItemRendered.invoke(uiState)</span>
<span class="nc" id="L99">    }</span>

<span class="nc" id="L101">    private fun updateBlogSection(state: ReaderPostUiState) = with(binding.layoutBlogSection) {</span>
<span class="nc" id="L102">        updateAvatarOrBlavatar(state)</span>
<span class="nc" id="L103">        uiHelpers.setTextOrHide(textAuthorAndBlogName, state.blogSection.blogName)</span>
<span class="nc" id="L104">        uiHelpers.setTextOrHide(textBlogUrl, state.blogSection.blogUrl)</span>
<span class="nc" id="L105">        uiHelpers.updateVisibility(dotSeparator, state.blogSection.dotSeparatorVisibility)</span>
<span class="nc" id="L106">        uiHelpers.setTextOrHide(textDateline, state.blogSection.dateLine)</span>

<span class="nc" id="L108">        root.setBackgroundResource(</span>
<span class="nc" id="L109">                root.context.getDrawableResIdFromAttribute(</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                        state.blogSection.blogSectionClickData?.background ?: 0</span>
                )
        )
<span class="nc bnc" id="L113" title="All 6 branches missed.">        state.blogSection.blogSectionClickData?.onBlogSectionClicked?.let {</span>
<span class="nc" id="L114">            root.setOnClickListener {</span>
<span class="nc" id="L115">                state.blogSection.blogSectionClickData.onBlogSectionClicked.invoke(state.postId, state.blogId)</span>
<span class="nc" id="L116">            }</span>
<span class="nc" id="L117">        } ?: run {</span>
<span class="nc" id="L118">            root.setOnClickListener(null)</span>
<span class="nc" id="L119">            root.isClickable = false</span>
<span class="nc" id="L120">        }</span>
<span class="nc" id="L121">    }</span>

<span class="nc" id="L123">    private fun updateFeaturedImage(state: ReaderPostUiState) = with(binding) {</span>
<span class="nc" id="L124">        uiHelpers.updateVisibility(imageFeatured, state.featuredImageVisibility)</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (state.featuredImageUrl == null) {</span>
<span class="nc" id="L126">            imageManager.cancelRequestAndClearImageView(imageFeatured)</span>
        } else {
<span class="nc" id="L128">            imageManager.loadImageWithCorners(</span>
<span class="nc" id="L129">                    imageFeatured,</span>
<span class="nc" id="L130">                    PHOTO_ROUNDED_CORNERS,</span>
<span class="nc" id="L131">                    state.featuredImageUrl,</span>
<span class="nc" id="L132">                    uiHelpers.getPxOfUiDimen(WordPress.getContext(), state.featuredImageCornerRadius)</span>
            )
        }
<span class="nc" id="L135">    }</span>

<span class="nc" id="L137">    private fun updateAvatarOrBlavatar(state: ReaderPostUiState) = with(binding.layoutBlogSection) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        uiHelpers.updateVisibility(imageAvatarOrBlavatar, state.blogSection.avatarOrBlavatarUrl != null)</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (state.blogSection.avatarOrBlavatarUrl == null) {</span>
<span class="nc" id="L140">            imageManager.cancelRequestAndClearImageView(imageAvatarOrBlavatar)</span>
        } else {
<span class="nc" id="L142">            imageManager.loadIntoCircle(</span>
<span class="nc" id="L143">                    imageAvatarOrBlavatar,</span>
<span class="nc" id="L144">                    state.blogSection.blavatarType, state.blogSection.avatarOrBlavatarUrl</span>
            )
        }

<span class="nc bnc" id="L148" title="All 4 branches missed.">        val canShowAuthorsAvatar = state.blogSection.authorAvatarUrl != null &amp;&amp; state.blogSection.isAuthorAvatarVisible</span>
<span class="nc" id="L149">        uiHelpers.updateVisibility(authorsAvatar, canShowAuthorsAvatar)</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (!canShowAuthorsAvatar) {</span>
<span class="nc" id="L152">            imageManager.cancelRequestAndClearImageView(authorsAvatar)</span>
        } else {
<span class="nc" id="L154">            imageManager.loadIntoCircle(authorsAvatar, BLAVATAR_CIRCULAR, state.blogSection.authorAvatarUrl!!)</span>
        }
<span class="nc" id="L156">    }</span>

<span class="nc" id="L158">    private fun updateDiscoverSection(state: ReaderPostUiState) = with(binding) {</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">        uiHelpers.updateVisibility(imageDiscoverAvatar, state.discoverSection?.discoverAvatarUrl != null)</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        uiHelpers.updateVisibility(layoutDiscover, state.discoverSection != null)</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        uiHelpers.setTextOrHide(textDiscover, state.discoverSection?.discoverText)</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">        if (state.discoverSection?.discoverAvatarUrl == null) {</span>
<span class="nc" id="L163">            imageManager.cancelRequestAndClearImageView(imageDiscoverAvatar)</span>
        } else {
            // TODO do we need to use `imagemanager.load` for blavatar?
<span class="nc" id="L166">            imageManager.loadIntoCircle(</span>
<span class="nc" id="L167">                    imageDiscoverAvatar,</span>
<span class="nc" id="L168">                    state.discoverSection.imageType,</span>
<span class="nc" id="L169">                    state.discoverSection.discoverAvatarUrl</span>
            )
        }
<span class="nc" id="L172">        layoutDiscover.setOnClickListener {</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">            state.discoverSection?.onDiscoverClicked?.invoke(state.postId, state.blogId)</span>
<span class="nc" id="L174">        }</span>
<span class="nc" id="L175">    }</span>

    private fun updateActionButton(postId: Long, blogId: Long, state: PrimaryAction, view: View) {
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (view is ReaderIconCountView) {</span>
<span class="nc" id="L179">            view.setCount(state.count)</span>
        }
<span class="nc" id="L181">        view.isEnabled = state.isEnabled</span>
<span class="nc" id="L182">        view.isSelected = state.isSelected</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        view.contentDescription = state.contentDescription?.let { uiHelpers.getTextOfUiString(view.context, it) }</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        view.setOnClickListener { state.onClicked?.invoke(postId, blogId, state.type) }</span>
<span class="nc" id="L185">    }</span>

<span class="nc" id="L187">    private fun loadVideoThumbnail(state: ReaderPostUiState) = with(binding) {</span>
        /* TODO ideally, we'd be passing just a thumbnail url in the UiState. However, the code for retrieving
            thumbnail from full video URL needs to be fully refactored. */
<span class="nc bnc" id="L190" title="All 2 branches missed.">        state.fullVideoUrl?.let { videoUrl -&gt;</span>
<span class="nc" id="L191">            ReaderVideoUtils.retrieveVideoThumbnailUrl(videoUrl, object : VideoThumbnailUrlListener {</span>
                override fun showThumbnail(thumbnailUrl: String) {
<span class="nc" id="L193">                    imageManager.loadImageWithCorners(</span>
<span class="nc" id="L194">                            imageFeatured,</span>
<span class="nc" id="L195">                            PHOTO_ROUNDED_CORNERS,</span>
<span class="nc" id="L196">                            thumbnailUrl,</span>
<span class="nc" id="L197">                            uiHelpers.getPxOfUiDimen(WordPress.getContext(), state.featuredImageCornerRadius)</span>
                    )
<span class="nc" id="L199">                }</span>

                override fun showPlaceholder() {
<span class="nc" id="L202">                    imageManager.load(imageFeatured, VIDEO)</span>
<span class="nc" id="L203">                }</span>

                override fun cacheThumbnailUrl(thumbnailUrl: String) {
<span class="nc" id="L206">                    ReaderThumbnailTable.addThumbnail(state.postId, videoUrl, thumbnailUrl)</span>
<span class="nc" id="L207">                }</span>
            })
<span class="nc" id="L209">        }</span>
<span class="nc" id="L210">    }</span>

    private fun renderMoreMenu(uiState: ReaderPostUiState, actions: List&lt;ReaderPostCardAction&gt;, v: View) {
<span class="nc" id="L213">        readerTracker.track(AnalyticsTracker.Stat.POST_CARD_MORE_TAPPED)</span>
<span class="nc" id="L214">        val listPopup = ListPopupWindow(v.context)</span>
<span class="nc" id="L215">        listPopup.width = v.context.resources.getDimensionPixelSize(R.dimen.menu_item_width)</span>
<span class="nc" id="L216">        listPopup.setAdapter(ReaderMenuAdapter(v.context, uiHelpers, actions))</span>
<span class="nc" id="L217">        listPopup.setDropDownGravity(Gravity.END)</span>
<span class="nc" id="L218">        listPopup.anchorView = v</span>
<span class="nc" id="L219">        listPopup.isModal = true</span>
<span class="nc" id="L220">        listPopup.setOnItemClickListener { _, _, position, _ -&gt;</span>
<span class="nc" id="L221">            listPopup.dismiss()</span>
<span class="nc" id="L222">            val item = actions[position]</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            item.onClicked?.invoke(uiState.postId, uiState.blogId, item.type)</span>
<span class="nc" id="L224">        }</span>
<span class="nc" id="L225">        listPopup.setOnDismissListener { uiState.onMoreDismissed.invoke(uiState) }</span>
<span class="nc" id="L226">        listPopup.show()</span>
<span class="nc" id="L227">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>