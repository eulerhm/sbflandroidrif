<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HomePagePickerFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.sitecreation.theme</a> &gt; <span class="el_source">HomePagePickerFragment.kt</span></div><h1>HomePagePickerFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.sitecreation.theme

import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.core.view.isGone
import androidx.core.view.updateLayoutParams
import androidx.fragment.app.Fragment
import androidx.fragment.app.activityViewModels
import androidx.lifecycle.ViewModelProvider
import androidx.recyclerview.widget.LinearLayoutManager
import com.google.android.material.appbar.AppBarLayout
import dagger.hilt.android.AndroidEntryPoint
import org.wordpress.android.R
import org.wordpress.android.databinding.HomePagePickerFragmentBinding
import org.wordpress.android.ui.layoutpicker.LayoutCategoryAdapter
import org.wordpress.android.ui.layoutpicker.LayoutPickerUiState
import org.wordpress.android.ui.layoutpicker.LayoutPickerViewModel.DesignPreviewAction.Dismiss
import org.wordpress.android.ui.layoutpicker.LayoutPickerViewModel.DesignPreviewAction.Show
import org.wordpress.android.ui.sitecreation.theme.DesignPreviewFragment.Companion.DESIGN_PREVIEW_TAG
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.DisplayUtilsWrapper
import org.wordpress.android.util.ToastUtils
import org.wordpress.android.util.config.SiteNameFeatureConfig
import org.wordpress.android.util.extensions.setVisible
import org.wordpress.android.util.image.ImageManager
import javax.inject.Inject

/**
 * Implements the Home Page Picker UI
 */
@Suppress(&quot;TooManyFunctions&quot;)
@AndroidEntryPoint
<span class="nc" id="L35">class HomePagePickerFragment : Fragment() {</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">    @Inject lateinit var imageManager: ImageManager</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">    @Inject lateinit var displayUtils: DisplayUtilsWrapper</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">    @Inject internal lateinit var uiHelper: UiHelpers</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">    @Inject lateinit var siteNameFeatureConfig: SiteNameFeatureConfig</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">    @Inject lateinit var thumbDimensionProvider: SiteDesignPickerDimensionProvider</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">    @Inject lateinit var recommendedDimensionProvider: SiteDesignRecommendedDimensionProvider</span>
<span class="nc" id="L43">    private val viewModel: HomePagePickerViewModel by activityViewModels()</span>

    private val siteIntent: String?
<span class="nc bnc" id="L46" title="All 2 branches missed.">        get() = arguments?.getString(ARG_SITE_INTENT)</span>

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
<span class="nc" id="L53">        return inflater.inflate(R.layout.home_page_picker_fragment, container, false)</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L57">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc bnc" id="L59" title="All 2 branches missed.">        savedInstanceState?.let {</span>
<span class="nc" id="L60">            viewModel.loadSavedState(it)</span>
<span class="nc" id="L61">        }</span>

<span class="nc" id="L63">        with(HomePagePickerFragmentBinding.bind(view)) {</span>
<span class="nc" id="L64">            modalLayoutPickerCategoriesSkeleton.root.isGone = true</span>
<span class="nc" id="L65">            categoriesRecyclerView.isGone = true</span>
<span class="nc" id="L66">            layoutsRecyclerView.apply {</span>
<span class="nc" id="L67">                layoutManager = LinearLayoutManager(requireActivity())</span>
<span class="nc" id="L68">                adapter = LayoutCategoryAdapter(</span>
<span class="nc" id="L69">                        viewModel.nestedScrollStates,</span>
<span class="nc" id="L70">                        thumbDimensionProvider,</span>
<span class="nc" id="L71">                        recommendedDimensionProvider,</span>
<span class="nc" id="L72">                        showRowDividers = false,</span>
<span class="nc" id="L73">                        useLargeCategoryHeading = true,</span>
<span class="nc" id="L74">                        footerLayoutResId = R.layout.home_page_picker_footer</span>
                )
<span class="nc" id="L76">            }</span>

<span class="nc" id="L78">            setupUi()</span>
<span class="nc" id="L79">            setupViewModel()</span>
<span class="nc" id="L80">            setupActionListeners()</span>
<span class="nc" id="L81">        }</span>
<span class="nc" id="L82">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L85">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L86">        viewModel.writeToBundle(outState)</span>
<span class="nc" id="L87">    }</span>

    private fun HomePagePickerFragmentBinding.setupUi() {
<span class="nc bnc" id="L90" title="All 2 branches missed.">        siteCreationThemeHeader.title?.setText(R.string.hpp_title)</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        siteCreationThemeHeader.subtitle?.isGone = true</span>
<span class="nc" id="L92">        modalLayoutPickerLayoutsSkeleton.layoutsSkeleton.updateLayoutParams {</span>
<span class="nc" id="L93">            height = recommendedDimensionProvider.rowHeight</span>
<span class="nc" id="L94">        }</span>
<span class="nc" id="L95">        modalLayoutPickerLayoutsSkeleton.skeletonCardView.updateLayoutParams {</span>
<span class="nc" id="L96">            height = recommendedDimensionProvider.previewHeight</span>
<span class="nc" id="L97">            width = recommendedDimensionProvider.previewWidth</span>
<span class="nc" id="L98">        }</span>
<span class="nc" id="L99">    }</span>

    private fun HomePagePickerFragmentBinding.setupViewModel() {
<span class="nc" id="L102">        viewModel.uiState.observe(viewLifecycleOwner) { uiState -&gt;</span>
<span class="nc" id="L103">            setHeaderVisibility(uiState.isHeaderVisible)</span>
<span class="nc" id="L104">            setContentVisibility(uiState.loadingSkeletonVisible, uiState.errorViewVisible)</span>
<span class="nc" id="L105">            when (uiState) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                is LayoutPickerUiState.Loading -&gt; { // Nothing more to do here</span>
                }
<span class="nc bnc" id="L108" title="All 2 branches missed.">                is LayoutPickerUiState.Content -&gt; {</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">                    (layoutsRecyclerView.adapter as? LayoutCategoryAdapter)?.update(uiState.layoutCategories)</span>
                }
<span class="nc bnc" id="L111" title="All 2 branches missed.">                is LayoutPickerUiState.Error -&gt; {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    uiState.toast?.let { ToastUtils.showToast(requireContext(), it) }</span>
                }
            }
<span class="nc" id="L115">        }</span>

<span class="nc" id="L117">        viewModel.onPreviewActionPressed.observe(viewLifecycleOwner) { action -&gt;</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">            activity?.supportFragmentManager?.let { fm -&gt;</span>
<span class="nc" id="L119">                when (action) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                    is Show -&gt; {</span>
<span class="nc" id="L121">                        val previewFragment = DesignPreviewFragment.newInstance()</span>
<span class="nc" id="L122">                        previewFragment.show(fm, DESIGN_PREVIEW_TAG)</span>
                    }
<span class="nc bnc" id="L124" title="All 2 branches missed.">                    is Dismiss -&gt; {</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">                        (fm.findFragmentByTag(DESIGN_PREVIEW_TAG) as? DesignPreviewFragment)?.dismiss()</span>
<span class="nc bnc" id="L126" title="All 4 branches missed.">                        (viewModel.uiState.value as? LayoutPickerUiState.Content)?.let {</span>
<span class="nc" id="L127">                            viewModel.updateUiState(it.copy(selectedLayoutSlug = null))</span>
<span class="nc" id="L128">                            viewModel.loadLayouts()</span>
<span class="nc" id="L129">                        }</span>
                    }
                }
<span class="nc" id="L132">            }</span>
<span class="nc" id="L133">        }</span>

<span class="nc" id="L135">        viewModel.start(siteIntent, displayUtils.isTablet())</span>
<span class="nc" id="L136">    }</span>

    private fun HomePagePickerFragmentBinding.setHeaderVisibility(visible: Boolean) {
<span class="nc" id="L139">        uiHelper.fadeInfadeOutViews(</span>
<span class="nc" id="L140">                homePagePickerTitlebar.appBarTitle,</span>
<span class="nc" id="L141">                siteCreationThemeHeader.title,</span>
<span class="nc" id="L142">                visible</span>
        )
<span class="nc" id="L144">    }</span>

    private fun HomePagePickerFragmentBinding.setContentVisibility(skeleton: Boolean, error: Boolean) {
<span class="nc" id="L147">        modalLayoutPickerLayoutsSkeleton.layoutsSkeleton.setVisible(skeleton)</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">        layoutsRecyclerView.setVisible(!skeleton &amp;&amp; !error)</span>
<span class="nc" id="L149">        errorView.setVisible(error)</span>
<span class="nc" id="L150">    }</span>

    private fun HomePagePickerFragmentBinding.setupActionListeners() {
<span class="nc" id="L153">        homePagePickerTitlebar.skipButton.setOnClickListener { viewModel.onSkippedTapped() }</span>
<span class="nc" id="L154">        errorView.button.setOnClickListener { viewModel.onRetryClicked() }</span>
<span class="nc" id="L155">        homePagePickerTitlebar.backButton.setOnClickListener { viewModel.onBackPressed() }</span>
<span class="nc" id="L156">        setScrollListener()</span>
<span class="nc" id="L157">    }</span>

    private fun HomePagePickerFragmentBinding.setScrollListener() {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (displayUtils.isPhoneLandscape()) return // Always visible</span>
<span class="nc" id="L161">        val scrollThreshold = resources.getDimension(R.dimen.picker_header_scroll_snap_threshold).toInt()</span>
<span class="nc" id="L162">        appBarLayout.addOnOffsetChangedListener(AppBarLayout.OnOffsetChangedListener { _, verticalOffset -&gt;</span>
<span class="nc" id="L163">            viewModel.onAppBarOffsetChanged(verticalOffset, scrollThreshold)</span>
<span class="nc" id="L164">        })</span>
<span class="nc" id="L165">        viewModel.onAppBarOffsetChanged(0, scrollThreshold)</span>
<span class="nc" id="L166">    }</span>

    companion object {
        private const val ARG_SITE_INTENT = &quot;arg_site_intent&quot;

        fun newInstance(siteIntent: String?): HomePagePickerFragment {
<span class="nc" id="L172">            val bundle = Bundle().apply {</span>
<span class="nc" id="L173">                putString(ARG_SITE_INTENT, siteIntent)</span>
<span class="nc" id="L174">            }</span>

<span class="nc" id="L176">            return HomePagePickerFragment().apply {</span>
<span class="nc" id="L177">                arguments = bundle</span>
<span class="nc" id="L178">            }</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>