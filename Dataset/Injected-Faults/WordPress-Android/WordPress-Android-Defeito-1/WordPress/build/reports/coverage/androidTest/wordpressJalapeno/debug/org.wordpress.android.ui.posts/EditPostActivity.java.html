<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EditPostActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">EditPostActivity.java</span></div><h1>EditPostActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Intent;
import android.content.res.Configuration;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.Bundle;
import android.os.Handler;
import android.preference.PreferenceManager;
import android.text.TextUtils;
import android.view.DragEvent;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.webkit.MimeTypeMap;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.StringRes;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.widget.Toolbar;
import androidx.core.app.ActivityCompat.OnRequestPermissionsResultCallback;
import androidx.core.util.Consumer;
import androidx.core.util.Pair;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentPagerAdapter;
import androidx.fragment.app.FragmentStatePagerAdapter;
import androidx.fragment.app.FragmentTransaction;
import androidx.lifecycle.LiveData;
import androidx.lifecycle.ViewModelProvider;
import androidx.viewpager.widget.PagerAdapter;
import androidx.viewpager.widget.ViewPager;

import com.automattic.android.tracks.crashlogging.CrashLogging;
import com.google.android.material.appbar.AppBarLayout;
import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.google.android.material.snackbar.Snackbar;

import org.greenrobot.eventbus.EventBus;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.jetbrains.annotations.NotNull;
import org.wordpress.android.BuildConfig;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.editor.AztecEditorFragment;
import org.wordpress.android.editor.EditorEditMediaListener;
import org.wordpress.android.editor.EditorFragmentAbstract;
import org.wordpress.android.editor.EditorFragmentAbstract.EditorDragAndDropListener;
import org.wordpress.android.editor.EditorFragmentAbstract.EditorFragmentListener;
import org.wordpress.android.editor.EditorFragmentAbstract.EditorFragmentNotAddedException;
import org.wordpress.android.editor.EditorFragmentAbstract.TrackableEvent;
import org.wordpress.android.editor.EditorFragmentActivity;
import org.wordpress.android.editor.EditorImageMetaData;
import org.wordpress.android.editor.EditorImagePreviewListener;
import org.wordpress.android.editor.EditorImageSettingsListener;
import org.wordpress.android.editor.EditorMediaUploadListener;
import org.wordpress.android.editor.EditorMediaUtils;
import org.wordpress.android.editor.EditorThemeUpdateListener;
import org.wordpress.android.editor.ExceptionLogger;
import org.wordpress.android.editor.ImageSettingsDialogFragment;
import org.wordpress.android.editor.gutenberg.DialogVisibility;
import org.wordpress.android.editor.gutenberg.GutenbergEditorFragment;
import org.wordpress.android.editor.gutenberg.GutenbergPropsBuilder;
import org.wordpress.android.editor.gutenberg.GutenbergWebViewAuthorizationData;
import org.wordpress.android.editor.gutenberg.StorySaveMediaListener;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.action.AccountAction;
import org.wordpress.android.fluxc.generated.AccountActionBuilder;
import org.wordpress.android.fluxc.generated.EditorThemeActionBuilder;
import org.wordpress.android.fluxc.generated.MediaActionBuilder;
import org.wordpress.android.fluxc.generated.PostActionBuilder;
import org.wordpress.android.fluxc.generated.SiteActionBuilder;
import org.wordpress.android.fluxc.model.AccountModel;
import org.wordpress.android.fluxc.model.CauseOfOnPostChanged;
import org.wordpress.android.fluxc.model.CauseOfOnPostChanged.RemoteAutoSavePost;
import org.wordpress.android.fluxc.model.EditorTheme;
import org.wordpress.android.fluxc.model.EditorThemeSupport;
import org.wordpress.android.fluxc.model.LocalOrRemoteId.LocalId;
import org.wordpress.android.fluxc.model.MediaModel;
import org.wordpress.android.fluxc.model.MediaModel.MediaUploadState;
import org.wordpress.android.fluxc.model.PostImmutableModel;
import org.wordpress.android.fluxc.model.PostModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.model.post.PostStatus;
import org.wordpress.android.fluxc.network.rest.wpcom.site.PrivateAtomicCookie;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.AccountStore.OnAccountChanged;
import org.wordpress.android.fluxc.store.EditorThemeStore;
import org.wordpress.android.fluxc.store.EditorThemeStore.FetchEditorThemePayload;
import org.wordpress.android.fluxc.store.EditorThemeStore.OnEditorThemeChanged;
import org.wordpress.android.fluxc.store.MediaStore;
import org.wordpress.android.fluxc.store.MediaStore.FetchMediaListPayload;
import org.wordpress.android.fluxc.store.MediaStore.MediaError;
import org.wordpress.android.fluxc.store.MediaStore.MediaErrorType;
import org.wordpress.android.fluxc.store.MediaStore.OnMediaChanged;
import org.wordpress.android.fluxc.store.MediaStore.OnMediaListFetched;
import org.wordpress.android.fluxc.store.MediaStore.OnMediaUploaded;
import org.wordpress.android.fluxc.store.PostStore;
import org.wordpress.android.fluxc.store.PostStore.OnPostChanged;
import org.wordpress.android.fluxc.store.PostStore.OnPostUploaded;
import org.wordpress.android.fluxc.store.PostStore.RemotePostPayload;
import org.wordpress.android.fluxc.store.QuickStartStore;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.store.SiteStore.FetchPrivateAtomicCookiePayload;
import org.wordpress.android.fluxc.store.SiteStore.OnPrivateAtomicCookieFetched;
import org.wordpress.android.fluxc.store.UploadStore;
import org.wordpress.android.fluxc.store.bloggingprompts.BloggingPromptsStore;
import org.wordpress.android.fluxc.tools.FluxCImageLoader;
import org.wordpress.android.imageeditor.preview.PreviewImageFragment.Companion.EditImageData;
import org.wordpress.android.support.ZendeskHelper;
import org.wordpress.android.ui.ActivityId;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.LocaleAwareActivity;
import org.wordpress.android.ui.PrivateAtCookieRefreshProgressDialog;
import org.wordpress.android.ui.PrivateAtCookieRefreshProgressDialog.PrivateAtCookieProgressDialogOnDismissListener;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.Shortcut;
import org.wordpress.android.ui.history.HistoryListItem.Revision;
import org.wordpress.android.ui.media.MediaBrowserActivity;
import org.wordpress.android.ui.media.MediaBrowserType;
import org.wordpress.android.ui.media.MediaPreviewActivity;
import org.wordpress.android.ui.media.MediaSettingsActivity;
import org.wordpress.android.ui.pages.SnackbarMessageHolder;
import org.wordpress.android.ui.photopicker.MediaPickerConstants;
import org.wordpress.android.ui.photopicker.MediaPickerLauncher;
import org.wordpress.android.ui.photopicker.PhotoPickerFragment;
import org.wordpress.android.ui.photopicker.PhotoPickerFragment.PhotoPickerIcon;
import org.wordpress.android.ui.posts.EditPostRepository.UpdatePostResult;
import org.wordpress.android.ui.posts.EditPostRepository.UpdatePostResult.Updated;
import org.wordpress.android.ui.posts.EditPostSettingsFragment.EditPostSettingsCallback;
import org.wordpress.android.ui.posts.FeaturedImageHelper.EnqueueFeaturedImageResult;
import org.wordpress.android.ui.posts.InsertMediaDialog.InsertMediaCallback;
import org.wordpress.android.ui.posts.PostEditorAnalyticsSession.Editor;
import org.wordpress.android.ui.posts.PostEditorAnalyticsSession.Outcome;
import org.wordpress.android.ui.posts.PostUtils.EntryPoint;
import org.wordpress.android.ui.posts.RemotePreviewLogicHelper.PreviewLogicOperationResult;
import org.wordpress.android.ui.posts.RemotePreviewLogicHelper.RemotePreviewType;
import org.wordpress.android.ui.posts.editor.EditorActionsProvider;
import org.wordpress.android.ui.posts.editor.EditorPhotoPicker;
import org.wordpress.android.ui.posts.editor.EditorPhotoPickerListener;
import org.wordpress.android.ui.posts.editor.EditorTracker;
import org.wordpress.android.ui.posts.editor.ImageEditorTracker;
import org.wordpress.android.ui.posts.editor.PostLoadingState;
import org.wordpress.android.ui.posts.editor.PrimaryEditorAction;
import org.wordpress.android.ui.posts.editor.SecondaryEditorAction;
import org.wordpress.android.ui.posts.editor.StorePostViewModel;
import org.wordpress.android.ui.posts.editor.StorePostViewModel.ActivityFinishState;
import org.wordpress.android.ui.posts.editor.StorePostViewModel.UpdateFromEditor;
import org.wordpress.android.ui.posts.editor.StorePostViewModel.UpdateFromEditor.PostFields;
import org.wordpress.android.ui.posts.editor.StoriesEventListener;
import org.wordpress.android.ui.posts.editor.XPostsCapabilityChecker;
import org.wordpress.android.ui.posts.editor.media.AddExistingMediaSource;
import org.wordpress.android.ui.posts.editor.media.EditorMedia;
import org.wordpress.android.ui.posts.editor.media.EditorMediaListener;
import org.wordpress.android.ui.posts.prepublishing.PrepublishingBottomSheetListener;
import org.wordpress.android.ui.posts.prepublishing.home.usecases.PublishPostImmediatelyUseCase;
import org.wordpress.android.ui.posts.reactnative.ReactNativeRequestHandler;
import org.wordpress.android.ui.posts.services.AztecImageLoader;
import org.wordpress.android.ui.posts.services.AztecVideoLoader;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.prefs.SiteSettingsInterface;
import org.wordpress.android.ui.reader.utils.ReaderUtilsWrapper;
import org.wordpress.android.ui.stories.StoryRepositoryWrapper;
import org.wordpress.android.ui.stories.prefs.StoriesPrefs;
import org.wordpress.android.ui.stories.usecase.LoadStoryFromStoriesPrefsUseCase;
import org.wordpress.android.ui.suggestion.SuggestionActivity;
import org.wordpress.android.ui.suggestion.SuggestionType;
import org.wordpress.android.ui.uploads.PostEvents;
import org.wordpress.android.ui.uploads.ProgressEvent;
import org.wordpress.android.ui.uploads.UploadService;
import org.wordpress.android.ui.uploads.UploadUtils;
import org.wordpress.android.ui.uploads.UploadUtilsWrapper;
import org.wordpress.android.ui.utils.AuthenticationUtils;
import org.wordpress.android.ui.utils.UiHelpers;
import org.wordpress.android.util.ActivityUtils;
import org.wordpress.android.util.AniUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.AutolinkUtils;
import org.wordpress.android.util.DateTimeUtilsWrapper;
import org.wordpress.android.util.DisplayUtils;
import org.wordpress.android.util.FluxCUtils;
import org.wordpress.android.util.ListUtils;
import org.wordpress.android.util.LocaleManager;
import org.wordpress.android.util.LocaleManagerWrapper;
import org.wordpress.android.util.MediaUtils;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.PermissionUtils;
import org.wordpress.android.util.ReblogUtils;
import org.wordpress.android.util.ShortcutUtils;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.StorageUtilsProvider.Source;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.ToastUtils.Duration;
import org.wordpress.android.util.UrlUtils;
import org.wordpress.android.util.WPMediaUtils;
import org.wordpress.android.util.WPPermissionUtils;
import org.wordpress.android.util.WPUrlUtils;
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils.BlockEditorEnabledSource;
import org.wordpress.android.util.config.GlobalStyleSupportFeatureConfig;
import org.wordpress.android.util.extensions.AppBarLayoutExtensionsKt;
import org.wordpress.android.util.helpers.MediaFile;
import org.wordpress.android.util.helpers.MediaGallery;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.viewmodel.helpers.ToastMessageHolder;
import org.wordpress.android.viewmodel.storage.StorageUtilsViewModel;
import org.wordpress.android.widgets.AppRatingDialog;
import org.wordpress.android.widgets.WPSnackbar;
import org.wordpress.android.widgets.WPViewPager;
import org.wordpress.aztec.exceptions.DynamicLayoutGetBlockIndexOutOfBoundsException;
import org.wordpress.aztec.util.AztecLog;

import java.io.File;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.inject.Inject;

import static org.wordpress.android.analytics.AnalyticsTracker.Stat.APP_REVIEWS_EVENT_INCREMENTED_BY_PUBLISHING_POST_OR_PAGE;
import static org.wordpress.android.editor.gutenberg.GutenbergEditorFragment.MEDIA_ID_NO_FEATURED_IMAGE_SET;
import static org.wordpress.android.imageeditor.preview.PreviewImageFragment.PREVIEW_IMAGE_REDUCED_SIZE_FACTOR;
import static org.wordpress.android.ui.history.HistoryDetailContainerFragment.KEY_REVISION;

import kotlin.Unit;
import kotlin.jvm.functions.Function0;

<span class="nc" id="L249">public class EditPostActivity extends LocaleAwareActivity implements</span>
        EditorFragmentActivity,
        EditorImageSettingsListener,
        EditorImagePreviewListener,
        EditorEditMediaListener,
        EditorDragAndDropListener,
        EditorFragmentListener,
        OnRequestPermissionsResultCallback,
        PhotoPickerFragment.PhotoPickerListener,
        EditorPhotoPickerListener,
        EditorMediaListener,
        EditPostSettingsFragment.EditPostActivityHook,
        PostSettingsListDialogFragment.OnPostSettingsDialogFragmentListener,
        HistoryListFragment.HistoryItemClickInterface,
        EditPostSettingsCallback,
        PrepublishingBottomSheetListener,
        PrivateAtCookieProgressDialogOnDismissListener,
        ExceptionLogger,
        SiteSettingsInterface.SiteSettingsListener {
    public static final String ACTION_REBLOG = &quot;reblogAction&quot;;
    public static final String EXTRA_POST_LOCAL_ID = &quot;postModelLocalId&quot;;
    public static final String EXTRA_LOAD_AUTO_SAVE_REVISION = &quot;loadAutosaveRevision&quot;;
    public static final String EXTRA_POST_REMOTE_ID = &quot;postModelRemoteId&quot;;
    public static final String EXTRA_IS_PAGE = &quot;isPage&quot;;
    public static final String EXTRA_IS_PROMO = &quot;isPromo&quot;;
    public static final String EXTRA_IS_QUICKPRESS = &quot;isQuickPress&quot;;
    public static final String EXTRA_IS_LANDING_EDITOR = &quot;isLandingEditor&quot;;
    public static final String EXTRA_IS_LANDING_EDITOR_OPENED_FOR_NEW_SITE = &quot;isLandingEditorOpenedForNewSite&quot;;
    public static final String EXTRA_QUICKPRESS_BLOG_ID = &quot;quickPressBlogId&quot;;
    public static final String EXTRA_UPLOAD_NOT_STARTED = &quot;savedAsLocalDraft&quot;;
    public static final String EXTRA_HAS_FAILED_MEDIA = &quot;hasFailedMedia&quot;;
    public static final String EXTRA_HAS_CHANGES = &quot;hasChanges&quot;;
    public static final String EXTRA_RESTART_EDITOR = &quot;isSwitchingEditors&quot;;
    public static final String EXTRA_INSERT_MEDIA = &quot;insertMedia&quot;;
    public static final String EXTRA_IS_NEW_POST = &quot;isNewPost&quot;;
    public static final String EXTRA_REBLOG_POST_TITLE = &quot;reblogPostTitle&quot;;
    public static final String EXTRA_REBLOG_POST_IMAGE = &quot;reblogPostImage&quot;;
    public static final String EXTRA_REBLOG_POST_QUOTE = &quot;reblogPostQuote&quot;;
    public static final String EXTRA_REBLOG_POST_CITATION = &quot;reblogPostCitation&quot;;
    public static final String EXTRA_PAGE_TITLE = &quot;pageTitle&quot;;
    public static final String EXTRA_PAGE_CONTENT = &quot;pageContent&quot;;
    public static final String EXTRA_PAGE_TEMPLATE = &quot;pageTemplate&quot;;
    public static final String EXTRA_PROMPT_ID = &quot;extraPromptId&quot;;
    public static final String EXTRA_ENTRY_POINT = &quot;extraEntryPoint&quot;;
    private static final String STATE_KEY_EDITOR_FRAGMENT = &quot;editorFragment&quot;;
    private static final String STATE_KEY_DROPPED_MEDIA_URIS = &quot;stateKeyDroppedMediaUri&quot;;
    private static final String STATE_KEY_POST_LOCAL_ID = &quot;stateKeyPostModelLocalId&quot;;
    private static final String STATE_KEY_POST_REMOTE_ID = &quot;stateKeyPostModelRemoteId&quot;;
    private static final String STATE_KEY_POST_LOADING_STATE = &quot;stateKeyPostLoadingState&quot;;
    private static final String STATE_KEY_IS_NEW_POST = &quot;stateKeyIsNewPost&quot;;
    private static final String STATE_KEY_IS_PHOTO_PICKER_VISIBLE = &quot;stateKeyPhotoPickerVisible&quot;;
    private static final String STATE_KEY_HTML_MODE_ON = &quot;stateKeyHtmlModeOn&quot;;
    private static final String STATE_KEY_REVISION = &quot;stateKeyRevision&quot;;
    private static final String STATE_KEY_EDITOR_SESSION_DATA = &quot;stateKeyEditorSessionData&quot;;
    private static final String STATE_KEY_GUTENBERG_IS_SHOWN = &quot;stateKeyGutenbergIsShown&quot;;
    private static final String STATE_KEY_MEDIA_CAPTURE_PATH = &quot;stateKeyMediaCapturePath&quot;;

    private static final int PAGE_CONTENT = 0;
    private static final int PAGE_SETTINGS = 1;
    private static final int PAGE_PUBLISH_SETTINGS = 2;
    private static final int PAGE_HISTORY = 3;

    private AztecImageLoader mAztecImageLoader;

<span class="nc" id="L313">    enum RestartEditorOptions {</span>
<span class="nc" id="L314">        NO_RESTART,</span>
<span class="nc" id="L315">        RESTART_SUPPRESS_GUTENBERG,</span>
<span class="nc" id="L316">        RESTART_DONT_SUPPRESS_GUTENBERG,</span>
    }

<span class="nc" id="L319">    private RestartEditorOptions mRestartEditorOption = RestartEditorOptions.NO_RESTART;</span>

    private boolean mShowAztecEditor;
    private boolean mShowGutenbergEditor;

    private List&lt;String&gt; mPendingVideoPressInfoRequests;

    private PostEditorAnalyticsSession mPostEditorAnalyticsSession;
<span class="nc" id="L327">    private boolean mIsConfigChange = false;</span>

    /**
     * The {@link PagerAdapter} that will provide
     * fragments for each of the sections. We use a
     * {@link FragmentPagerAdapter} derivative, which will keep every
     * loaded fragment in memory. If this becomes too memory intensive, it
     * may be best to switch to a
     * {@link FragmentStatePagerAdapter}.
     */
    SectionsPagerAdapter mSectionsPagerAdapter;

    /**
     * The {@link ViewPager} that will host the section contents.
     */
    WPViewPager mViewPager;

    private Revision mRevision;

    private EditorFragmentAbstract mEditorFragment;
    private EditPostSettingsFragment mEditPostSettingsFragment;
    private EditorMediaUploadListener mEditorMediaUploadListener;
    private EditorPhotoPicker mEditorPhotoPicker;

    private ProgressDialog mProgressDialog;
    private ProgressDialog mAddingMediaToEditorProgressDialog;

    private boolean mIsNewPost;
    private boolean mIsPage;
    private boolean mIsLandingEditor;
    private boolean mHasSetPostContent;
<span class="nc" id="L358">    private PostLoadingState mPostLoadingState = PostLoadingState.NONE;</span>
<span class="nc" id="L359">    @Nullable private Boolean mIsXPostsCapable = null;</span>

    @Nullable Consumer&lt;String&gt; mOnGetSuggestionResult;

    // For opening the context menu after permissions have been granted
<span class="nc" id="L364">    private View mMenuView = null;</span>


    private AppBarLayout mAppBarLayout;
    private Toolbar mToolbar;

    private Handler mShowPrepublishingBottomSheetHandler;
    private Runnable mShowPrepublishingBottomSheetRunnable;

<span class="nc" id="L373">    private boolean mHtmlModeMenuStateOn = false;</span>

    @Inject Dispatcher mDispatcher;
    @Inject AccountStore mAccountStore;
    @Inject SiteStore mSiteStore;
    @Inject PostStore mPostStore;
    @Inject MediaStore mMediaStore;
    @Inject UploadStore mUploadStore;
    @Inject EditorThemeStore mEditorThemeStore;
    @Inject FluxCImageLoader mImageLoader;
    @Inject ShortcutUtils mShortcutUtils;
    @Inject QuickStartStore mQuickStartStore;
    @Inject ImageManager mImageManager;
    @Inject UiHelpers mUiHelpers;
    @Inject RemotePreviewLogicHelper mRemotePreviewLogicHelper;
    @Inject ProgressDialogHelper mProgressDialogHelper;
    @Inject FeaturedImageHelper mFeaturedImageHelper;
    @Inject ReactNativeRequestHandler mReactNativeRequestHandler;
    @Inject EditorMedia mEditorMedia;
    @Inject LocaleManagerWrapper mLocaleManagerWrapper;
    @Inject EditPostRepository mEditPostRepository;
    @Inject PostUtilsWrapper mPostUtils;
    @Inject EditorTracker mEditorTracker;
    @Inject UploadUtilsWrapper mUploadUtilsWrapper;
    @Inject EditorActionsProvider mEditorActionsProvider;
    @Inject DateTimeUtilsWrapper mDateTimeUtils;
    @Inject ViewModelProvider.Factory mViewModelFactory;
    @Inject ReaderUtilsWrapper mReaderUtilsWrapper;
    @Inject protected PrivateAtomicCookie mPrivateAtomicCookie;
    @Inject ImageEditorTracker mImageEditorTracker;
    @Inject ReblogUtils mReblogUtils;
    @Inject AnalyticsTrackerWrapper mAnalyticsTrackerWrapper;
    @Inject PublishPostImmediatelyUseCase mPublishPostImmediatelyUseCase;
    @Inject XPostsCapabilityChecker mXpostsCapabilityChecker;
    @Inject CrashLogging mCrashLogging;
    @Inject MediaPickerLauncher mMediaPickerLauncher;
    @Inject StoryRepositoryWrapper mStoryRepositoryWrapper;
    @Inject LoadStoryFromStoriesPrefsUseCase mLoadStoryFromStoriesPrefsUseCase;
    @Inject StoriesPrefs mStoriesPrefs;
    @Inject StoriesEventListener mStoriesEventListener;
    @Inject UpdateFeaturedImageUseCase mUpdateFeaturedImageUseCase;
    @Inject GlobalStyleSupportFeatureConfig mGlobalStyleSupportFeatureConfig;
    @Inject ZendeskHelper mZendeskHelper;
    @Inject BloggingPromptsStore mBloggingPromptsStore;

    private StorePostViewModel mViewModel;
    private StorageUtilsViewModel mStorageUtilsViewModel;
    private EditorBloggingPromptsViewModel mEditorBloggingPromptsViewModel;

    private SiteModel mSite;
    private SiteSettingsInterface mSiteSettings;
    private boolean mIsJetpackSsoEnabled;
<span class="nc" id="L425">    private boolean mStoryEditingCancelled = false;</span>

<span class="nc" id="L427">    private boolean mNetworkErrorOnLastMediaFetchAttempt = false;</span>

    public static boolean checkToRestart(@NonNull Intent data) {
<span class="nc bnc" id="L430" title="All 2 branches missed.">        return data.hasExtra(EditPostActivity.EXTRA_RESTART_EDITOR)</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">               &amp;&amp; RestartEditorOptions.valueOf(data.getStringExtra(EditPostActivity.EXTRA_RESTART_EDITOR))</span>
                  != RestartEditorOptions.NO_RESTART;
    }

    private void newPostSetup() {
<span class="nc" id="L436">        mIsNewPost = true;</span>

<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (mSite == null) {</span>
<span class="nc" id="L439">            showErrorAndFinish(R.string.blog_not_found);</span>
<span class="nc" id="L440">            return;</span>
        }
<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (!mSite.isVisible()) {</span>
<span class="nc" id="L443">            showErrorAndFinish(R.string.error_blog_hidden);</span>
<span class="nc" id="L444">            return;</span>
        }

        // Create a new post
<span class="nc" id="L448">        mEditPostRepository.set(() -&gt; {</span>
<span class="nc" id="L449">            PostModel post = mPostStore.instantiatePostModel(mSite, mIsPage, null, null);</span>
<span class="nc" id="L450">            post.setStatus(PostStatus.DRAFT.toString());</span>
<span class="nc" id="L451">            return post;</span>
        });
<span class="nc" id="L453">        mEditPostRepository.savePostSnapshot();</span>
<span class="nc" id="L454">        EventBus.getDefault().postSticky(</span>
<span class="nc" id="L455">                new PostEvents.PostOpenedInEditor(mEditPostRepository.getLocalSiteId(), mEditPostRepository.getId()));</span>
<span class="nc" id="L456">        mShortcutUtils.reportShortcutUsed(Shortcut.CREATE_NEW_POST);</span>
<span class="nc" id="L457">    }</span>

    private void newPostFromShareAction() {
<span class="nc" id="L460">        Intent intent = getIntent();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (isMediaTypeIntent(intent)) {</span>
<span class="nc" id="L462">            newPostSetup();</span>
<span class="nc" id="L463">            setPostMediaFromShareAction();</span>
        } else {
<span class="nc" id="L465">            final String title = intent.getStringExtra(Intent.EXTRA_SUBJECT);</span>
<span class="nc" id="L466">            final String text = intent.getStringExtra(Intent.EXTRA_TEXT);</span>
<span class="nc" id="L467">            String content = migrateToGutenbergEditor(AutolinkUtils.autoCreateLinks(text));</span>
<span class="nc" id="L468">            newPostSetup(title, content);</span>
        }
<span class="nc" id="L470">    }</span>

    private void newReblogPostSetup() {
<span class="nc" id="L473">        Intent intent = getIntent();</span>
<span class="nc" id="L474">        final String title = intent.getStringExtra(EXTRA_REBLOG_POST_TITLE);</span>
<span class="nc" id="L475">        final String quote = intent.getStringExtra(EXTRA_REBLOG_POST_QUOTE);</span>
<span class="nc" id="L476">        final String citation = intent.getStringExtra(EXTRA_REBLOG_POST_CITATION);</span>
<span class="nc" id="L477">        final String image = intent.getStringExtra(EXTRA_REBLOG_POST_IMAGE);</span>
<span class="nc" id="L478">        String content = mReblogUtils.reblogContent(image, quote, title, citation);</span>

<span class="nc" id="L480">        newPostSetup(title, content);</span>
<span class="nc" id="L481">    }</span>

    private void newPageFromLayoutPickerSetup(String title, String layoutSlug) {
<span class="nc" id="L484">        String content = mSiteStore.getBlockLayoutContent(mSite, layoutSlug);</span>
<span class="nc" id="L485">        newPostSetup(title, content);</span>
<span class="nc" id="L486">    }</span>

    private void newPostSetup(String title, String content) {
<span class="nc" id="L489">        mIsNewPost = true;</span>

<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (mSite == null) {</span>
<span class="nc" id="L492">            showErrorAndFinish(R.string.blog_not_found);</span>
<span class="nc" id="L493">            return;</span>
        }
<span class="nc bnc" id="L495" title="All 2 branches missed.">        if (!mSite.isVisible()) {</span>
<span class="nc" id="L496">            showErrorAndFinish(R.string.error_blog_hidden);</span>
<span class="nc" id="L497">            return;</span>
        }
        // Create a new post
<span class="nc" id="L500">        mEditPostRepository.set(() -&gt; {</span>
<span class="nc" id="L501">            PostModel post = mPostStore.instantiatePostModel(mSite, mIsPage, title, content,</span>
<span class="nc" id="L502">                    PostStatus.DRAFT.toString(), null, null, false);</span>
<span class="nc" id="L503">            return post;</span>
        });
<span class="nc" id="L505">        mEditPostRepository.savePostSnapshot();</span>
<span class="nc" id="L506">        EventBus.getDefault().postSticky(</span>
<span class="nc" id="L507">                new PostEvents.PostOpenedInEditor(mEditPostRepository.getLocalSiteId(), mEditPostRepository.getId()));</span>
<span class="nc" id="L508">        mShortcutUtils.reportShortcutUsed(Shortcut.CREATE_NEW_POST);</span>
<span class="nc" id="L509">    }</span>

    private void createPostEditorAnalyticsSessionTracker(boolean showGutenbergEditor, PostImmutableModel post,
                                                         SiteModel site, boolean isNewPost) {
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (mPostEditorAnalyticsSession == null) {</span>
<span class="nc" id="L514">            mPostEditorAnalyticsSession = new PostEditorAnalyticsSession(</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                    showGutenbergEditor ? Editor.GUTENBERG : Editor.CLASSIC,</span>
                    post, site, isNewPost, mAnalyticsTrackerWrapper);
        }
<span class="nc" id="L518">    }</span>

    @Override @SuppressWarnings(&quot;checkstyle:MethodLength&quot;)
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L522">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L523">        ((WordPress) getApplication()).component().inject(this);</span>
<span class="nc" id="L524">        mDispatcher.register(this);</span>
<span class="nc" id="L525">        mViewModel = new ViewModelProvider(this, mViewModelFactory).get(StorePostViewModel.class);</span>
<span class="nc" id="L526">        mStorageUtilsViewModel = new ViewModelProvider(this, mViewModelFactory).get(StorageUtilsViewModel.class);</span>
<span class="nc" id="L527">        mEditorBloggingPromptsViewModel =</span>
<span class="nc" id="L528">                new ViewModelProvider(this, mViewModelFactory).get(EditorBloggingPromptsViewModel.class);</span>
<span class="nc" id="L529">        setContentView(R.layout.new_edit_post_activity);</span>

<span class="nc bnc" id="L531" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L532">            mSite = (SiteModel) getIntent().getSerializableExtra(WordPress.SITE);</span>
        } else {
<span class="nc" id="L534">            mSite = (SiteModel) savedInstanceState.getSerializable(WordPress.SITE);</span>
        }

<span class="nc" id="L537">        mIsLandingEditor = getIntent().getExtras().getBoolean(EXTRA_IS_LANDING_EDITOR);</span>

        // TODO: Make sure to use the latest fresh info about the site we've in the DB
        // set only the editor setting for now.
<span class="nc bnc" id="L541" title="All 2 branches missed.">        if (mSite != null) {</span>
<span class="nc" id="L542">            SiteModel refreshedSite = mSiteStore.getSiteByLocalId(mSite.getId());</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">            if (refreshedSite != null) {</span>
<span class="nc" id="L544">                mSite.setMobileEditor(refreshedSite.getMobileEditor());</span>
            }

<span class="nc" id="L547">            mSiteSettings = SiteSettingsInterface.getInterface(this, mSite, this);</span>
            // initialize settings with locally cached values, fetch remote on first pass
<span class="nc" id="L549">            fetchSiteSettings();</span>
        }

        // Check whether to show the visual editor
<span class="nc" id="L553">        PreferenceManager.setDefaultValues(this, R.xml.account_settings, false);</span>
<span class="nc" id="L554">        mShowAztecEditor = AppPrefs.isAztecEditorEnabled();</span>
<span class="nc" id="L555">        mEditorPhotoPicker = new EditorPhotoPicker(this, this, this, mShowAztecEditor);</span>

        // TODO when aztec is the only editor, remove this part and set the overlay bottom margin in xml
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (mShowAztecEditor) {</span>
<span class="nc" id="L559">            View overlay = findViewById(R.id.view_overlay);</span>
<span class="nc" id="L560">            ViewGroup.MarginLayoutParams layoutParams = (ViewGroup.MarginLayoutParams) overlay.getLayoutParams();</span>
<span class="nc" id="L561">            layoutParams.bottomMargin = getResources().getDimensionPixelOffset(R.dimen.aztec_format_bar_height);</span>
<span class="nc" id="L562">            overlay.setLayoutParams(layoutParams);</span>
        }

        // Set up the action bar.
<span class="nc" id="L566">        mToolbar = findViewById(R.id.toolbar_main);</span>
<span class="nc" id="L567">        setSupportActionBar(mToolbar);</span>
<span class="nc" id="L568">        final ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L570">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
        }

<span class="nc" id="L573">        mAppBarLayout = findViewById(R.id.appbar_main);</span>

<span class="nc" id="L575">        FragmentManager fragmentManager = getSupportFragmentManager();</span>
<span class="nc" id="L576">        Bundle extras = getIntent().getExtras();</span>
<span class="nc" id="L577">        String action = getIntent().getAction();</span>
<span class="nc" id="L578">        boolean isRestarting = checkToRestart(getIntent());</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">            if (!getIntent().hasExtra(EXTRA_POST_LOCAL_ID)</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                || Intent.ACTION_SEND.equals(action)</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">                || Intent.ACTION_SEND_MULTIPLE.equals(action)</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                || NEW_MEDIA_POST.equals(action)</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">                || getIntent().hasExtra(EXTRA_IS_QUICKPRESS)) {</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">                if (getIntent().hasExtra(EXTRA_QUICKPRESS_BLOG_ID)) {</span>
                    // QuickPress might want to use a different blog than the current blog
<span class="nc" id="L587">                    int localSiteId = getIntent().getIntExtra(EXTRA_QUICKPRESS_BLOG_ID, -1);</span>
<span class="nc" id="L588">                    mSite = mSiteStore.getSiteByLocalId(localSiteId);</span>
                }

<span class="nc" id="L591">                mIsPage = extras.getBoolean(EXTRA_IS_PAGE);</span>
<span class="nc bnc" id="L592" title="All 4 branches missed.">                if (mIsPage &amp;&amp; !TextUtils.isEmpty(extras.getString(EXTRA_PAGE_TITLE))) {</span>
<span class="nc" id="L593">                    newPageFromLayoutPickerSetup(extras.getString(EXTRA_PAGE_TITLE),</span>
<span class="nc" id="L594">                            extras.getString(EXTRA_PAGE_TEMPLATE));</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                } else if (Intent.ACTION_SEND.equals(action)) {</span>
<span class="nc" id="L596">                    newPostFromShareAction();</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                } else if (ACTION_REBLOG.equals(action)) {</span>
<span class="nc" id="L598">                    newReblogPostSetup();</span>
                } else {
<span class="nc" id="L600">                    newPostSetup();</span>
                }
            } else {
<span class="nc" id="L603">                mEditPostRepository.loadPostByLocalPostId(extras.getInt(EXTRA_POST_LOCAL_ID));</span>
                // Load post from extra)s

<span class="nc bnc" id="L606" title="All 2 branches missed.">                if (mEditPostRepository.hasPost()) {</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                    if (extras.getBoolean(EXTRA_LOAD_AUTO_SAVE_REVISION)) {</span>
<span class="nc" id="L608">                        mEditPostRepository.update(postModel -&gt; {</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">                            boolean updateTitle = !TextUtils.isEmpty(postModel.getAutoSaveTitle());</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">                            if (updateTitle) {</span>
<span class="nc" id="L611">                                postModel.setTitle(postModel.getAutoSaveTitle());</span>
                            }
<span class="nc bnc" id="L613" title="All 2 branches missed.">                            boolean updateContent = !TextUtils.isEmpty(postModel.getAutoSaveContent());</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                            if (updateContent) {</span>
<span class="nc" id="L615">                                postModel.setContent(postModel.getAutoSaveContent());</span>
                            }
<span class="nc bnc" id="L617" title="All 2 branches missed.">                            boolean updateExcerpt = !TextUtils.isEmpty(postModel.getAutoSaveExcerpt());</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">                            if (updateExcerpt) {</span>
<span class="nc" id="L619">                                postModel.setExcerpt(postModel.getAutoSaveExcerpt());</span>
                            }
<span class="nc bnc" id="L621" title="All 6 branches missed.">                            return updateTitle || updateContent || updateExcerpt;</span>
                        });
<span class="nc" id="L623">                        mEditPostRepository.savePostSnapshot();</span>
                    }

<span class="nc" id="L626">                    initializePostObject();</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                } else if (isRestarting) {</span>
<span class="nc" id="L628">                    newPostSetup();</span>
                }
            }

<span class="nc bnc" id="L632" title="All 4 branches missed.">            if (isRestarting &amp;&amp; extras.getBoolean(EXTRA_IS_NEW_POST)) {</span>
                // editor was on a new post before the switch so, keep that signal.
                // Fixes https://github.com/wordpress-mobile/gutenberg-mobile/issues/2072
<span class="nc" id="L635">                mIsNewPost = true;</span>
            }

            // retrieve Editor session data if switched editors
<span class="nc bnc" id="L639" title="All 4 branches missed.">            if (isRestarting &amp;&amp; extras.containsKey(STATE_KEY_EDITOR_SESSION_DATA)) {</span>
<span class="nc" id="L640">                mPostEditorAnalyticsSession = PostEditorAnalyticsSession</span>
<span class="nc" id="L641">                        .fromBundle(extras, STATE_KEY_EDITOR_SESSION_DATA, mAnalyticsTrackerWrapper);</span>
            }
        } else {
<span class="nc" id="L644">            mEditorMedia.setDroppedMediaUris(savedInstanceState.getParcelableArrayList(STATE_KEY_DROPPED_MEDIA_URIS));</span>
<span class="nc" id="L645">            mIsNewPost = savedInstanceState.getBoolean(STATE_KEY_IS_NEW_POST, false);</span>
<span class="nc" id="L646">            updatePostLoadingAndDialogState(PostLoadingState.fromInt(</span>
<span class="nc" id="L647">                    savedInstanceState.getInt(STATE_KEY_POST_LOADING_STATE, 0)));</span>
<span class="nc" id="L648">            mRevision = savedInstanceState.getParcelable(STATE_KEY_REVISION);</span>
<span class="nc" id="L649">            mPostEditorAnalyticsSession = PostEditorAnalyticsSession</span>
<span class="nc" id="L650">                    .fromBundle(savedInstanceState, STATE_KEY_EDITOR_SESSION_DATA, mAnalyticsTrackerWrapper);</span>

            // if we have a remote id saved, let's first try that, as the local Id might have changed after FETCH_POSTS
<span class="nc bnc" id="L653" title="All 2 branches missed.">            if (savedInstanceState.containsKey(STATE_KEY_POST_REMOTE_ID)) {</span>
<span class="nc" id="L654">                mEditPostRepository.loadPostByRemotePostId(savedInstanceState.getLong(STATE_KEY_POST_REMOTE_ID), mSite);</span>
<span class="nc" id="L655">                initializePostObject();</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">            } else if (savedInstanceState.containsKey(STATE_KEY_POST_LOCAL_ID)) {</span>
<span class="nc" id="L657">                mEditPostRepository.loadPostByLocalPostId(savedInstanceState.getInt(STATE_KEY_POST_LOCAL_ID));</span>
<span class="nc" id="L658">                initializePostObject();</span>
            }

<span class="nc" id="L661">            mEditorFragment =</span>
<span class="nc" id="L662">                    (EditorFragmentAbstract) fragmentManager.getFragment(savedInstanceState, STATE_KEY_EDITOR_FRAGMENT);</span>

<span class="nc bnc" id="L664" title="All 2 branches missed.">            if (mEditorFragment instanceof EditorMediaUploadListener) {</span>
<span class="nc" id="L665">                mEditorMediaUploadListener = (EditorMediaUploadListener) mEditorFragment;</span>
            }

<span class="nc bnc" id="L668" title="All 2 branches missed.">            if (mEditorFragment instanceof StorySaveMediaListener) {</span>
<span class="nc" id="L669">                mStoriesEventListener.setSaveMediaListener((StorySaveMediaListener) mEditorFragment);</span>
            }
        }

<span class="nc bnc" id="L673" title="All 2 branches missed.">        if (mSite == null) {</span>
<span class="nc" id="L674">            ToastUtils.showToast(this, R.string.blog_not_found, ToastUtils.Duration.SHORT);</span>
<span class="nc" id="L675">            finish();</span>
<span class="nc" id="L676">            return;</span>
        }

        // Ensure we have a valid post
<span class="nc bnc" id="L680" title="All 2 branches missed.">        if (!mEditPostRepository.hasPost()) {</span>
<span class="nc" id="L681">            showErrorAndFinish(R.string.post_not_found);</span>
<span class="nc" id="L682">            return;</span>
        }

<span class="nc" id="L685">        mEditorMedia.start(mSite, this);</span>
<span class="nc" id="L686">        startObserving();</span>

<span class="nc bnc" id="L688" title="All 4 branches missed.">        if (mHasSetPostContent = mEditorFragment != null) {</span>
<span class="nc" id="L689">            mEditorFragment.setImageLoader(mImageLoader);</span>
        }

        // Ensure that this check happens when mPost is set
<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L694">            String restartEditorOptionName = getIntent().getStringExtra(EXTRA_RESTART_EDITOR);</span>
            RestartEditorOptions restartEditorOption =
<span class="nc bnc" id="L696" title="All 2 branches missed.">                    restartEditorOptionName == null ? RestartEditorOptions.RESTART_DONT_SUPPRESS_GUTENBERG</span>
<span class="nc" id="L697">                            : RestartEditorOptions.valueOf(restartEditorOptionName);</span>

<span class="nc" id="L699">            mShowGutenbergEditor =</span>
<span class="nc bnc" id="L700" title="All 4 branches missed.">                    PostUtils.shouldShowGutenbergEditor(mIsNewPost, mEditPostRepository.getContent(), mSite)</span>
                    &amp;&amp; restartEditorOption != RestartEditorOptions.RESTART_SUPPRESS_GUTENBERG;
<span class="nc" id="L702">        } else {</span>
<span class="nc" id="L703">            mShowGutenbergEditor = savedInstanceState.getBoolean(STATE_KEY_GUTENBERG_IS_SHOWN);</span>
        }

        // ok now we are sure to have both a valid Post and showGutenberg flag, let's start the editing session tracker
<span class="nc" id="L707">        createPostEditorAnalyticsSessionTracker(mShowGutenbergEditor, mEditPostRepository.getPost(), mSite, mIsNewPost);</span>

<span class="nc" id="L709">        logTemplateSelection();</span>

        // Bump post created analytics only once, first time the editor is opened
<span class="nc bnc" id="L712" title="All 6 branches missed.">        if (mIsNewPost &amp;&amp; savedInstanceState == null &amp;&amp; !isRestarting) {</span>
<span class="nc" id="L713">            AnalyticsUtils.trackEditorCreatedPost(</span>
                    action,
<span class="nc" id="L715">                    getIntent(),</span>
<span class="nc" id="L716">                    mSiteStore.getSiteByLocalId(mEditPostRepository.getLocalSiteId()),</span>
<span class="nc" id="L717">                    mEditPostRepository.getPost()</span>
            );
        }

<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (!mIsNewPost) {</span>
            // if we are opening an existing Post, and it contains a Story block, pre-fetch the media in case
            // the user wants to edit the block (we'll need to download it first if the slides images weren't
            // created on this device)
<span class="nc bnc" id="L725" title="All 2 branches missed.">            if (PostUtils.contentContainsWPStoryGutenbergBlocks(mEditPostRepository.getPost().getContent())) {</span>
<span class="nc" id="L726">                fetchMediaList();</span>
            }

            // if we are opening a Post for which an error notification exists, we need to remove it from the dashboard
            // to prevent the user from tapping RETRY on a Post that is being currently edited
<span class="nc" id="L731">            UploadService.cancelFinalNotification(this, mEditPostRepository.getPost());</span>
<span class="nc" id="L732">            resetUploadingMediaToFailedIfPostHasNotMediaInProgressOrQueued();</span>
        }

<span class="nc" id="L735">        setTitle(SiteUtils.getSiteNameOrHomeURL(mSite));</span>

<span class="nc" id="L737">        mSectionsPagerAdapter = new SectionsPagerAdapter(fragmentManager);</span>

        // we need to make sure AT cookie is available when trying to edit post on private AT site
<span class="nc bnc" id="L740" title="All 4 branches missed.">        if (mSite.isPrivateWPComAtomic() &amp;&amp; mPrivateAtomicCookie.isCookieRefreshRequired()) {</span>
<span class="nc" id="L741">            PrivateAtCookieRefreshProgressDialog.Companion.showIfNecessary(fragmentManager);</span>
<span class="nc" id="L742">            mDispatcher.dispatch(SiteActionBuilder.newFetchPrivateAtomicCookieAction(</span>
<span class="nc" id="L743">                    new FetchPrivateAtomicCookiePayload(mSite.getSiteId())));</span>
        } else {
<span class="nc" id="L745">            setupViewPager();</span>
        }
<span class="nc" id="L747">        ActivityId.trackLastActivity(ActivityId.POST_EDITOR);</span>

<span class="nc" id="L749">        setupPrepublishingBottomSheetRunnable();</span>

<span class="nc" id="L751">        mStoriesEventListener.start(this.getLifecycle(), mSite, mEditPostRepository, this);</span>

        // The check on savedInstanceState should allow to show the dialog only on first start
        // (even in cases when the VM could be re-created like when activity is destroyed in the background)
<span class="nc bnc" id="L755" title="All 2 branches missed.">        mStorageUtilsViewModel.start(savedInstanceState == null);</span>
<span class="nc" id="L756">    }</span>

    private void presentNewPageNoticeIfNeeded() {
<span class="nc bnc" id="L759" title="All 4 branches missed.">        if (!mIsPage || !mIsNewPost) {</span>
<span class="nc" id="L760">            return;</span>
        }
<span class="nc bnc" id="L762" title="All 2 branches missed.">        String message = mEditPostRepository.getContent().isEmpty() ? getString(R.string.mlp_notice_blank_page_created)</span>
<span class="nc" id="L763">                : getString(R.string.mlp_notice_page_created);</span>
<span class="nc" id="L764">        mEditorFragment.showNotice(message);</span>
<span class="nc" id="L765">    }</span>

    private void fetchSiteSettings() {
<span class="nc" id="L768">        mSiteSettings.init(true);</span>
<span class="nc" id="L769">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPrivateAtomicCookieFetched(OnPrivateAtomicCookieFetched event) {
        // if the dialog is not showing by the time cookie fetched it means that it was dismissed and content was loaded
<span class="nc bnc" id="L775" title="All 2 branches missed.">        if (PrivateAtCookieRefreshProgressDialog.Companion.isShowing(getSupportFragmentManager())) {</span>
<span class="nc" id="L776">            setupViewPager();</span>
<span class="nc" id="L777">            PrivateAtCookieRefreshProgressDialog.Companion.dismissIfNecessary(getSupportFragmentManager());</span>
        }
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L780">            AppLog.e(AppLog.T.EDITOR,</span>
                    &quot;Failed to load private AT cookie. &quot; + event.error.type + &quot; - &quot; + event.error.message);
<span class="nc" id="L782">            WPSnackbar.make(findViewById(R.id.editor_activity), R.string.media_accessing_failed, Snackbar.LENGTH_LONG)</span>
<span class="nc" id="L783">                      .show();</span>
        }
<span class="nc" id="L785">    }</span>

    @Override
    public void onCookieProgressDialogCancelled() {
<span class="nc" id="L789">        WPSnackbar.make(findViewById(R.id.editor_activity), R.string.media_accessing_failed, Snackbar.LENGTH_LONG)</span>
<span class="nc" id="L790">                  .show();</span>
<span class="nc" id="L791">        setupViewPager();</span>
<span class="nc" id="L792">    }</span>

    // SiteSettingsListener
    @Override
<span class="nc" id="L796">    public void onSaveError(Exception error) { }</span>

    @Override
<span class="nc" id="L799">    public void onFetchError(Exception error) { }</span>

    @Override
    public void onSettingsUpdated() {
        // Let's hold the value in local variable as listener is too noisy
<span class="nc bnc" id="L804" title="All 4 branches missed.">        boolean isJetpackSsoEnabled = mSite.isJetpackConnected() &amp;&amp; mSiteSettings.isJetpackSsoEnabled();</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">        if (mIsJetpackSsoEnabled != isJetpackSsoEnabled) {</span>
<span class="nc" id="L806">            mIsJetpackSsoEnabled = isJetpackSsoEnabled;</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L808">                GutenbergEditorFragment gutenbergFragment = (GutenbergEditorFragment) mEditorFragment;</span>
<span class="nc" id="L809">                gutenbergFragment.setJetpackSsoEnabled(mIsJetpackSsoEnabled);</span>
<span class="nc" id="L810">                gutenbergFragment.updateCapabilities(getGutenbergPropsBuilder());</span>
            }
        }
<span class="nc" id="L813">    }</span>

    @Override
<span class="nc" id="L816">    public void onSettingsSaved() { }</span>

    @Override
<span class="nc" id="L819">    public void onCredentialsValidated(Exception error) { }</span>

    private void setupViewPager() {
        // Set up the ViewPager with the sections adapter.
<span class="nc" id="L823">        mViewPager = findViewById(R.id.pager);</span>
<span class="nc" id="L824">        mViewPager.setAdapter(mSectionsPagerAdapter);</span>
<span class="nc" id="L825">        mViewPager.setOffscreenPageLimit(4);</span>
<span class="nc" id="L826">        mViewPager.setPagingEnabled(false);</span>

        // When swiping between different sections, select the corresponding tab. We can also use ActionBar.Tab#select()
        // to do this if we have a reference to the Tab.
<span class="nc" id="L830">        mViewPager.clearOnPageChangeListeners();</span>
<span class="nc" id="L831">        mViewPager.addOnPageChangeListener(new ViewPager.SimpleOnPageChangeListener() {</span>
            @Override
            public void onPageSelected(int position) {
<span class="nc" id="L834">                invalidateOptionsMenu();</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">                if (position == PAGE_CONTENT) {</span>
<span class="nc" id="L836">                    setTitle(SiteUtils.getSiteNameOrHomeURL(mSite));</span>
<span class="nc" id="L837">                    AppBarLayoutExtensionsKt.setLiftOnScrollTargetViewIdAndRequestLayout(mAppBarLayout, View.NO_ID);</span>
<span class="nc" id="L838">                    mToolbar.setBackgroundResource(R.drawable.tab_layout_background);</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">                } else if (position == PAGE_SETTINGS) {</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">                    setTitle(mEditPostRepository.isPage() ? R.string.page_settings : R.string.post_settings);</span>
<span class="nc" id="L841">                    mEditorPhotoPicker.hidePhotoPicker();</span>
<span class="nc" id="L842">                    mAppBarLayout.setLiftOnScrollTargetViewId(R.id.settings_fragment_root);</span>
<span class="nc" id="L843">                    mToolbar.setBackground(null);</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">                } else if (position == PAGE_PUBLISH_SETTINGS) {</span>
<span class="nc" id="L845">                    setTitle(R.string.publish_date);</span>
<span class="nc" id="L846">                    mEditorPhotoPicker.hidePhotoPicker();</span>
<span class="nc" id="L847">                    AppBarLayoutExtensionsKt.setLiftOnScrollTargetViewIdAndRequestLayout(mAppBarLayout, View.NO_ID);</span>
<span class="nc" id="L848">                    mToolbar.setBackground(null);</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">                } else if (position == PAGE_HISTORY) {</span>
<span class="nc" id="L850">                    setTitle(R.string.history_title);</span>
<span class="nc" id="L851">                    mEditorPhotoPicker.hidePhotoPicker();</span>
<span class="nc" id="L852">                    mAppBarLayout.setLiftOnScrollTargetViewId(R.id.empty_recycler_view);</span>
<span class="nc" id="L853">                    mToolbar.setBackground(null);</span>
                }
<span class="nc" id="L855">            }</span>
        });
<span class="nc" id="L857">    }</span>

    private void startObserving() {
<span class="nc" id="L860">        mEditorMedia.getUiState().observe(this, uiState -&gt; {</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">            if (uiState != null) {</span>
<span class="nc" id="L862">                updateAddingMediaToEditorProgressDialogState(uiState.getProgressDialogUiState());</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">                if (uiState.getEditorOverlayVisibility()) {</span>
<span class="nc" id="L864">                    showOverlay(false);</span>
                } else {
<span class="nc" id="L866">                    hideOverlay();</span>
                }
            }
<span class="nc" id="L869">        });</span>
<span class="nc" id="L870">        mEditorMedia.getSnackBarMessage().observe(this, event -&gt; {</span>
<span class="nc" id="L871">            SnackbarMessageHolder messageHolder = event.getContentIfNotHandled();</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">            if (messageHolder != null) {</span>
<span class="nc" id="L873">                WPSnackbar.make(</span>
<span class="nc" id="L874">                                findViewById(R.id.editor_activity),</span>
<span class="nc" id="L875">                                mUiHelpers.getTextOfUiString(this, messageHolder.getMessage()),</span>
                                Snackbar.LENGTH_SHORT
                        )
<span class="nc" id="L878">                        .show();</span>
            }
<span class="nc" id="L880">        });</span>
<span class="nc" id="L881">        mEditorMedia.getToastMessage().observe(this, event -&gt; {</span>
<span class="nc" id="L882">            ToastMessageHolder contentIfNotHandled = event.getContentIfNotHandled();</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">            if (contentIfNotHandled != null) {</span>
<span class="nc" id="L884">                contentIfNotHandled.show(this);</span>
            }
<span class="nc" id="L886">        });</span>
<span class="nc" id="L887">        mViewModel.getOnSavePostTriggered().observe(this, unitEvent -&gt; unitEvent.applyIfNotHandled(unit -&gt; {</span>
<span class="nc" id="L888">            updateAndSavePostAsync();</span>
<span class="nc" id="L889">            return null;</span>
        }));
<span class="nc" id="L891">        mViewModel.getOnFinish().observe(this, finishEvent -&gt; finishEvent.applyIfNotHandled(activityFinishState -&gt; {</span>
<span class="nc bnc" id="L892" title="All 4 branches missed.">            switch (activityFinishState) {</span>
                case SAVED_ONLINE:
<span class="nc" id="L894">                    saveResult(true, false);</span>
<span class="nc" id="L895">                    break;</span>
                case SAVED_LOCALLY:
<span class="nc" id="L897">                    saveResult(true, true);</span>
<span class="nc" id="L898">                    break;</span>
                case CANCELLED:
<span class="nc" id="L900">                    saveResult(false, true);</span>
                    break;
            }
<span class="nc" id="L903">            removePostOpenInEditorStickyEvent();</span>
<span class="nc" id="L904">            mEditorMedia.definitelyDeleteBackspaceDeletedMediaItemsAsync();</span>
<span class="nc" id="L905">            finish();</span>
<span class="nc" id="L906">            return null;</span>
        }));
<span class="nc" id="L908">        mEditPostRepository.getPostChanged().observe(this, postEvent -&gt; postEvent.applyIfNotHandled(post -&gt; {</span>
<span class="nc" id="L909">            mViewModel.savePostToDb(mEditPostRepository, mSite);</span>
<span class="nc" id="L910">            return null;</span>
        }));
<span class="nc" id="L912">        mStorageUtilsViewModel.getCheckStorageWarning().observe(this, event -&gt;</span>
<span class="nc" id="L913">                event.applyIfNotHandled(unit -&gt; {</span>
<span class="nc" id="L914">                    mStorageUtilsViewModel.onStorageWarningCheck(getSupportFragmentManager(), Source.EDITOR);</span>
<span class="nc" id="L915">                    return null;</span>
                })
        );
<span class="nc" id="L918">        mEditorBloggingPromptsViewModel.getOnBloggingPromptLoaded().observe(this, event -&gt; {</span>
<span class="nc" id="L919">            event.applyIfNotHandled(loadedPrompt -&gt; {</span>
<span class="nc" id="L920">                    mEditPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L921">                        postModel.setContent(loadedPrompt.getContent());</span>
<span class="nc" id="L922">                        postModel.setAnsweredPromptId(loadedPrompt.getPromptId());</span>
<span class="nc" id="L923">                        postModel.setTagNames(loadedPrompt.getTag());</span>
<span class="nc" id="L924">                        return true;</span>
                    }, (postModel, result) -&gt; {
<span class="nc" id="L926">                        refreshEditorContent();</span>
<span class="nc" id="L927">                        return null;</span>
                    });
<span class="nc" id="L929">                return null;</span>
            });
<span class="nc" id="L931">        });</span>
<span class="nc" id="L932">    }</span>

    private void initializePostObject() {
<span class="nc bnc" id="L935" title="All 2 branches missed.">        if (mEditPostRepository.hasPost()) {</span>
<span class="nc" id="L936">            mEditPostRepository.savePostSnapshotWhenEditorOpened();</span>
<span class="nc" id="L937">            mEditPostRepository.replace(UploadService::updatePostWithCurrentlyCompletedUploads);</span>
<span class="nc" id="L938">            mIsPage = mEditPostRepository.isPage();</span>

<span class="nc" id="L940">            EventBus.getDefault().postSticky(new PostEvents.PostOpenedInEditor(mEditPostRepository.getLocalSiteId(),</span>
<span class="nc" id="L941">                    mEditPostRepository.getId()));</span>

<span class="nc" id="L943">            mEditorMedia.purgeMediaToPostAssociationsIfNotInPostAnymoreAsync();</span>
        }
<span class="nc" id="L945">    }</span>

    // this method aims at recovering the current state of media items if they're inconsistent within the PostModel.
    private void resetUploadingMediaToFailedIfPostHasNotMediaInProgressOrQueued() {
<span class="nc" id="L949">        boolean useAztec = AppPrefs.isAztecEditorEnabled();</span>

<span class="nc bnc" id="L951" title="All 4 branches missed.">        if (!useAztec || UploadService.hasPendingOrInProgressMediaUploadsForPost(mEditPostRepository.getPost())) {</span>
<span class="nc" id="L952">            return;</span>
        }
<span class="nc" id="L954">        mEditPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L955">            String oldContent = postModel.getContent();</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">            if (!AztecEditorFragment.hasMediaItemsMarkedUploading(EditPostActivity.this, oldContent)</span>
                // we need to make sure items marked failed are still failed or not as well
<span class="nc bnc" id="L958" title="All 2 branches missed.">                &amp;&amp; !AztecEditorFragment.hasMediaItemsMarkedFailed(EditPostActivity.this, oldContent)) {</span>
<span class="nc" id="L959">                return false;</span>
            }

<span class="nc" id="L962">            String newContent = AztecEditorFragment.resetUploadingMediaToFailed(EditPostActivity.this, oldContent);</span>

<span class="nc bnc" id="L964" title="All 6 branches missed.">            if (!TextUtils.isEmpty(oldContent) &amp;&amp; newContent != null &amp;&amp; oldContent.compareTo(newContent) != 0) {</span>
<span class="nc" id="L965">                postModel.setContent(newContent);</span>
<span class="nc" id="L966">                return true;</span>
            }
<span class="nc" id="L968">            return false;</span>
        }, null);
<span class="nc" id="L970">    }</span>

    @Override
    protected void onResume() {
<span class="nc" id="L974">        super.onResume();</span>

<span class="nc" id="L976">        EventBus.getDefault().register(this);</span>

<span class="nc" id="L978">        reattachUploadingMediaForAztec();</span>

        // Bump editor opened event every time the activity is resumed, to match the EDITOR_CLOSED event onPause
<span class="nc" id="L981">        PostUtils.trackOpenEditorAnalytics(mEditPostRepository.getPost(), mSite);</span>
<span class="nc" id="L982">        mIsConfigChange = false;</span>
<span class="nc" id="L983">    }</span>

    private void reattachUploadingMediaForAztec() {
<span class="nc bnc" id="L986" title="All 2 branches missed.">        if (mEditorMediaUploadListener != null) {</span>
<span class="nc" id="L987">            mEditorMedia.reattachUploadingMediaForAztec(</span>
                    mEditPostRepository,
                    mEditorFragment instanceof AztecEditorFragment,
                    mEditorMediaUploadListener
            );
        }
<span class="nc" id="L993">    }</span>

    @Override
    protected void onPause() {
<span class="nc" id="L997">        super.onPause();</span>

<span class="nc" id="L999">        EventBus.getDefault().unregister(this);</span>
<span class="nc" id="L1000">        AnalyticsTracker.track(AnalyticsTracker.Stat.EDITOR_CLOSED);</span>
<span class="nc" id="L1001">    }</span>

    @Override protected void onStop() {
<span class="nc" id="L1004">        super.onStop();</span>
<span class="nc bnc" id="L1005" title="All 4 branches missed.">        if (mAztecImageLoader != null &amp;&amp; isFinishing()) {</span>
<span class="nc" id="L1006">            mAztecImageLoader.clearTargets();</span>
<span class="nc" id="L1007">            mAztecImageLoader = null;</span>
        }

<span class="nc bnc" id="L1010" title="All 4 branches missed.">        if (mShowPrepublishingBottomSheetHandler != null &amp;&amp; mShowPrepublishingBottomSheetRunnable != null) {</span>
<span class="nc" id="L1011">            mShowPrepublishingBottomSheetHandler.removeCallbacks(mShowPrepublishingBottomSheetRunnable);</span>
        }
<span class="nc" id="L1013">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc bnc" id="L1017" title="All 4 branches missed.">        if (!mIsConfigChange &amp;&amp; (mRestartEditorOption == RestartEditorOptions.NO_RESTART)) {</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">            if (mPostEditorAnalyticsSession != null) {</span>
<span class="nc" id="L1019">                mPostEditorAnalyticsSession.end();</span>
            }
        }

<span class="nc" id="L1023">        mDispatcher.unregister(this);</span>
<span class="nc" id="L1024">        mEditorMedia.cancelAddMediaToEditorActions();</span>
<span class="nc" id="L1025">        removePostOpenInEditorStickyEvent();</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">        if (mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L1027">            ((AztecEditorFragment) mEditorFragment).disableContentLogOnCrashes();</span>
        }

<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (mReactNativeRequestHandler != null) {</span>
<span class="nc" id="L1031">            mReactNativeRequestHandler.destroy();</span>
        }

<span class="nc" id="L1034">        super.onDestroy();</span>
<span class="nc" id="L1035">    }</span>

    private void removePostOpenInEditorStickyEvent() {
        PostEvents.PostOpenedInEditor stickyEvent =
<span class="nc" id="L1039">                EventBus.getDefault().getStickyEvent(PostEvents.PostOpenedInEditor.class);</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        if (stickyEvent != null) {</span>
            // &quot;Consume&quot; the sticky event
<span class="nc" id="L1042">            EventBus.getDefault().removeStickyEvent(stickyEvent);</span>
        }
<span class="nc" id="L1044">    }</span>

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L1048">        super.onSaveInstanceState(outState);</span>
        // Saves both post objects so we can restore them in onCreate()
<span class="nc" id="L1050">        updateAndSavePostAsync();</span>
<span class="nc" id="L1051">        outState.putInt(STATE_KEY_POST_LOCAL_ID, mEditPostRepository.getId());</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">        if (!mEditPostRepository.isLocalDraft()) {</span>
<span class="nc" id="L1053">            outState.putLong(STATE_KEY_POST_REMOTE_ID, mEditPostRepository.getRemotePostId());</span>
        }
<span class="nc" id="L1055">        outState.putInt(STATE_KEY_POST_LOADING_STATE, mPostLoadingState.getValue());</span>
<span class="nc" id="L1056">        outState.putBoolean(STATE_KEY_IS_NEW_POST, mIsNewPost);</span>
<span class="nc" id="L1057">        outState.putBoolean(STATE_KEY_IS_PHOTO_PICKER_VISIBLE, mEditorPhotoPicker.isPhotoPickerShowing());</span>
<span class="nc" id="L1058">        outState.putBoolean(STATE_KEY_HTML_MODE_ON, mHtmlModeMenuStateOn);</span>
<span class="nc" id="L1059">        outState.putSerializable(WordPress.SITE, mSite);</span>
<span class="nc" id="L1060">        outState.putParcelable(STATE_KEY_REVISION, mRevision);</span>

<span class="nc" id="L1062">        outState.putSerializable(STATE_KEY_EDITOR_SESSION_DATA, mPostEditorAnalyticsSession);</span>
<span class="nc" id="L1063">        mIsConfigChange = true; // don't call sessionData.end() in onDestroy() if this is an Android config change</span>

<span class="nc" id="L1065">        outState.putBoolean(STATE_KEY_GUTENBERG_IS_SHOWN, mShowGutenbergEditor);</span>

<span class="nc" id="L1067">        outState.putParcelableArrayList(STATE_KEY_DROPPED_MEDIA_URIS, mEditorMedia.getDroppedMediaUris());</span>

<span class="nc bnc" id="L1069" title="All 2 branches missed.">        if (mEditorFragment != null) {</span>
<span class="nc" id="L1070">            getSupportFragmentManager().putFragment(outState, STATE_KEY_EDITOR_FRAGMENT, mEditorFragment);</span>
        }

        // We must save the media capture path when the activity is destroyed to handle orientation changes during
        // photo capture (see: https://github.com/wordpress-mobile/WordPress-Android/issues/11296)
<span class="nc" id="L1075">        outState.putString(STATE_KEY_MEDIA_CAPTURE_PATH, mMediaCapturePath);</span>
<span class="nc" id="L1076">    }</span>

    @Override
    protected void onRestoreInstanceState(Bundle savedInstanceState) {
<span class="nc" id="L1080">        super.onRestoreInstanceState(savedInstanceState);</span>

<span class="nc" id="L1082">        mHtmlModeMenuStateOn = savedInstanceState.getBoolean(STATE_KEY_HTML_MODE_ON);</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">        if (savedInstanceState.getBoolean(STATE_KEY_IS_PHOTO_PICKER_VISIBLE, false)) {</span>
<span class="nc" id="L1084">            mEditorPhotoPicker.showPhotoPicker(mSite);</span>
        }

        // Restore media capture path for orientation changes during photo capture
<span class="nc" id="L1088">        mMediaCapturePath = savedInstanceState.getString(STATE_KEY_MEDIA_CAPTURE_PATH, &quot;&quot;);</span>
<span class="nc" id="L1089">    }</span>

    @Override
    public void onConfigurationChanged(Configuration newConfig) {
<span class="nc" id="L1093">        super.onConfigurationChanged(newConfig);</span>

<span class="nc" id="L1095">        mEditorPhotoPicker.onOrientationChanged(newConfig.orientation);</span>
<span class="nc" id="L1096">    }</span>

    private PrimaryEditorAction getPrimaryAction() {
<span class="nc" id="L1099">        return mEditorActionsProvider</span>
<span class="nc" id="L1100">                .getPrimaryAction(mEditPostRepository.getStatus(), UploadUtils.userCanPublish(mSite), mIsLandingEditor);</span>
    }

    private String getPrimaryActionText() {
<span class="nc" id="L1104">        return getString(getPrimaryAction().getTitleResource());</span>
    }

    private SecondaryEditorAction getSecondaryAction() {
<span class="nc" id="L1108">        return mEditorActionsProvider</span>
<span class="nc" id="L1109">                .getSecondaryAction(mEditPostRepository.getStatus(), UploadUtils.userCanPublish(mSite));</span>
    }

    private @Nullable String getSecondaryActionText() {
<span class="nc" id="L1113">        @StringRes Integer titleResource = getSecondaryAction().getTitleResource();</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">        return titleResource != null ? getString(titleResource) : null;</span>
    }

    private boolean shouldSwitchToGutenbergBeVisible(
            EditorFragmentAbstract editorFragment,
            SiteModel site
    ) {
        // Some guard conditions
<span class="nc bnc" id="L1122" title="All 2 branches missed.">        if (!mEditPostRepository.hasPost()) {</span>
<span class="nc" id="L1123">            AppLog.w(T.EDITOR, &quot;shouldSwitchToGutenbergBeVisible got a null post parameter.&quot;);</span>
<span class="nc" id="L1124">            return false;</span>
        }

<span class="nc bnc" id="L1127" title="All 2 branches missed.">        if (editorFragment == null) {</span>
<span class="nc" id="L1128">            AppLog.w(T.EDITOR, &quot;shouldSwitchToGutenbergBeVisible got a null editorFragment parameter.&quot;);</span>
<span class="nc" id="L1129">            return false;</span>
        }

        // Check whether the content has blocks.
<span class="nc" id="L1133">        boolean hasBlocks = false;</span>
<span class="nc" id="L1134">        boolean isEmpty = false;</span>
        try {
<span class="nc" id="L1136">            final String content = (String) editorFragment.getContent(mEditPostRepository.getContent());</span>
<span class="nc" id="L1137">            hasBlocks = PostUtils.contentContainsGutenbergBlocks(content);</span>
<span class="nc" id="L1138">            isEmpty = TextUtils.isEmpty(content);</span>
<span class="nc" id="L1139">        } catch (EditorFragmentNotAddedException e) {</span>
            // legacy exception; just ignore.
<span class="nc" id="L1141">        }</span>

        // if content has blocks or empty, offer the switch to Gutenberg. The block editor doesn't have good
        //  &quot;Classic Block&quot; support yet so, don't offer a switch to it if content doesn't have blocks. If the post
        //  is empty but the user hasn't enabled &quot;Use Gutenberg for new posts&quot; in Site Setting,
        //  don't offer the switch.
<span class="nc bnc" id="L1147" title="All 6 branches missed.">        return hasBlocks || (SiteUtils.isBlockEditorDefaultForNewPost(site) &amp;&amp; isEmpty);</span>
    }

    /*
     * shows/hides the overlay which appears atop the editor, which effectively disables it
     */
    private void showOverlay(boolean animate) {
<span class="nc" id="L1154">        View overlay = findViewById(R.id.view_overlay);</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">        if (animate) {</span>
<span class="nc" id="L1156">            AniUtils.fadeIn(overlay, AniUtils.Duration.MEDIUM);</span>
        } else {
<span class="nc" id="L1158">            overlay.setVisibility(View.VISIBLE);</span>
        }
<span class="nc" id="L1160">    }</span>

    private void hideOverlay() {
<span class="nc" id="L1163">        View overlay = findViewById(R.id.view_overlay);</span>
<span class="nc" id="L1164">        overlay.setVisibility(View.GONE);</span>
<span class="nc" id="L1165">    }</span>

    @Override
    public void onPhotoPickerShown() {
        // animate in the editor overlay
<span class="nc" id="L1170">        showOverlay(true);</span>

<span class="nc bnc" id="L1172" title="All 2 branches missed.">        if (mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L1173">            ((AztecEditorFragment) mEditorFragment).enableMediaMode(true);</span>
        }
<span class="nc" id="L1175">    }</span>

    @Override
    public void onPhotoPickerHidden() {
<span class="nc" id="L1179">        hideOverlay();</span>

<span class="nc bnc" id="L1181" title="All 2 branches missed.">        if (mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L1182">            ((AztecEditorFragment) mEditorFragment).enableMediaMode(false);</span>
        }
<span class="nc" id="L1184">    }</span>

    /*
     * called by PhotoPickerFragment when media is selected - may be a single item or a list of items
     */
    @Override
    public void onPhotoPickerMediaChosen(@NotNull final List&lt;? extends Uri&gt; uriList) {
<span class="nc" id="L1191">        mEditorPhotoPicker.hidePhotoPicker();</span>
<span class="nc" id="L1192">        mEditorMedia.onPhotoPickerMediaChosen(uriList);</span>
<span class="nc" id="L1193">    }</span>

    /*
     * called by PhotoPickerFragment when user clicks an icon to launch the camera, native
     * picker, or WP media picker
     */
    @Override
    public void onPhotoPickerIconClicked(@NonNull PhotoPickerIcon icon, boolean allowMultipleSelection) {
<span class="nc" id="L1201">        mEditorPhotoPicker.hidePhotoPicker();</span>
<span class="nc bnc" id="L1202" title="All 4 branches missed.">        if (!icon.requiresUploadPermission() || WPMediaUtils.currentUserCanUploadMedia(mSite)) {</span>
<span class="nc" id="L1203">            mEditorPhotoPicker.setAllowMultipleSelection(allowMultipleSelection);</span>
<span class="nc bnc" id="L1204" title="All 9 branches missed.">            switch (icon) {</span>
                case ANDROID_CAPTURE_PHOTO:
<span class="nc" id="L1206">                    launchCamera();</span>
<span class="nc" id="L1207">                    break;</span>
                case ANDROID_CAPTURE_VIDEO:
<span class="nc" id="L1209">                    launchVideoCamera();</span>
<span class="nc" id="L1210">                    break;</span>
                case ANDROID_CHOOSE_PHOTO_OR_VIDEO:
<span class="nc" id="L1212">                    WPMediaUtils.launchMediaLibrary(this, allowMultipleSelection);</span>
<span class="nc" id="L1213">                    break;</span>
                case ANDROID_CHOOSE_PHOTO:
<span class="nc" id="L1215">                    launchPictureLibrary();</span>
<span class="nc" id="L1216">                    break;</span>
                case ANDROID_CHOOSE_VIDEO:
<span class="nc" id="L1218">                    launchVideoLibrary();</span>
<span class="nc" id="L1219">                    break;</span>
                case WP_MEDIA:
<span class="nc" id="L1221">                    mMediaPickerLauncher.viewWPMediaLibraryPickerForResult(this, mSite, MediaBrowserType.EDITOR_PICKER);</span>
<span class="nc" id="L1222">                    break;</span>
                case STOCK_MEDIA:
<span class="nc bnc" id="L1224" title="All 2 branches missed.">                    final int requestCode = allowMultipleSelection</span>
<span class="nc" id="L1225">                            ? RequestCodes.STOCK_MEDIA_PICKER_MULTI_SELECT</span>
<span class="nc" id="L1226">                            : RequestCodes.STOCK_MEDIA_PICKER_SINGLE_SELECT_FOR_GUTENBERG_BLOCK;</span>
<span class="nc" id="L1227">                    mMediaPickerLauncher</span>
<span class="nc" id="L1228">                            .showStockMediaPickerForResult(this, mSite, requestCode, allowMultipleSelection);</span>
<span class="nc" id="L1229">                    break;</span>
                case GIF:
<span class="nc" id="L1231">                    mMediaPickerLauncher.showGifPickerForResult(</span>
                            this,
                            mSite,
                            allowMultipleSelection
                    );
<span class="nc" id="L1236">                    break;</span>
            }
        } else {
<span class="nc" id="L1239">            WPSnackbar.make(findViewById(R.id.editor_activity), R.string.media_error_no_permission_upload,</span>
<span class="nc" id="L1240">                    Snackbar.LENGTH_SHORT).show();</span>
        }
<span class="nc" id="L1242">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L1246">        super.onCreateOptionsMenu(menu);</span>
<span class="nc" id="L1247">        MenuInflater inflater = getMenuInflater();</span>
<span class="nc" id="L1248">        inflater.inflate(R.menu.edit_post, menu);</span>
<span class="nc" id="L1249">        return true;</span>
    }

    @Override
    public boolean onPrepareOptionsMenu(Menu menu) {
<span class="nc" id="L1254">        boolean showMenuItems = true;</span>
<span class="nc bnc" id="L1255" title="All 4 branches missed.">        if (mViewPager != null &amp;&amp; mViewPager.getCurrentItem() &gt; PAGE_CONTENT) {</span>
<span class="nc" id="L1256">            showMenuItems = false;</span>
        }

<span class="nc" id="L1259">        MenuItem secondaryAction = menu.findItem(R.id.menu_secondary_action);</span>
<span class="nc" id="L1260">        MenuItem previewMenuItem = menu.findItem(R.id.menu_preview_post);</span>
<span class="nc" id="L1261">        MenuItem viewHtmlModeMenuItem = menu.findItem(R.id.menu_html_mode);</span>
<span class="nc" id="L1262">        MenuItem historyMenuItem = menu.findItem(R.id.menu_history);</span>
<span class="nc" id="L1263">        MenuItem settingsMenuItem = menu.findItem(R.id.menu_post_settings);</span>
<span class="nc" id="L1264">        MenuItem helpMenuItem = menu.findItem(R.id.menu_editor_help);</span>

<span class="nc bnc" id="L1266" title="All 4 branches missed.">        if (secondaryAction != null &amp;&amp; mEditPostRepository.hasPost()) {</span>
<span class="nc bnc" id="L1267" title="All 4 branches missed.">            secondaryAction.setVisible(showMenuItems &amp;&amp; getSecondaryAction().isVisible());</span>
<span class="nc" id="L1268">            secondaryAction.setTitle(getSecondaryActionText());</span>
        }

<span class="nc bnc" id="L1271" title="All 2 branches missed.">        if (previewMenuItem != null) {</span>
<span class="nc" id="L1272">            previewMenuItem.setVisible(showMenuItems);</span>
        }

<span class="nc bnc" id="L1275" title="All 2 branches missed.">        if (viewHtmlModeMenuItem != null) {</span>
<span class="nc bnc" id="L1276" title="All 6 branches missed.">            viewHtmlModeMenuItem.setVisible(((mEditorFragment instanceof AztecEditorFragment)</span>
                                             || (mEditorFragment instanceof GutenbergEditorFragment)) &amp;&amp; showMenuItems);
<span class="nc bnc" id="L1278" title="All 2 branches missed.">            viewHtmlModeMenuItem.setTitle(mHtmlModeMenuStateOn ? R.string.menu_visual_mode : R.string.menu_html_mode);</span>
        }

<span class="nc bnc" id="L1281" title="All 2 branches missed.">        if (historyMenuItem != null) {</span>
<span class="nc bnc" id="L1282" title="All 4 branches missed.">            boolean hasHistory = !mIsNewPost &amp;&amp; mSite.isUsingWpComRestApi();</span>
<span class="nc bnc" id="L1283" title="All 4 branches missed.">            historyMenuItem.setVisible(showMenuItems &amp;&amp; hasHistory);</span>
        }

<span class="nc bnc" id="L1286" title="All 2 branches missed.">        if (settingsMenuItem != null) {</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">            settingsMenuItem.setTitle(mIsPage ? R.string.page_settings : R.string.post_settings);</span>
<span class="nc" id="L1288">            settingsMenuItem.setVisible(showMenuItems);</span>
        }

        // Set text of the primary action button in the ActionBar
<span class="nc bnc" id="L1292" title="All 2 branches missed.">        if (mEditPostRepository.hasPost()) {</span>
<span class="nc" id="L1293">            MenuItem primaryAction = menu.findItem(R.id.menu_primary_action);</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">            if (primaryAction != null) {</span>
<span class="nc" id="L1295">                primaryAction.setTitle(getPrimaryActionText());</span>
<span class="nc bnc" id="L1296" title="All 4 branches missed.">                primaryAction.setVisible(mViewPager != null &amp;&amp; mViewPager.getCurrentItem() != PAGE_HISTORY</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">                                         &amp;&amp; mViewPager.getCurrentItem() != PAGE_PUBLISH_SETTINGS);</span>
            }
        }

<span class="nc" id="L1301">        MenuItem switchToGutenbergMenuItem = menu.findItem(R.id.menu_switch_to_gutenberg);</span>

        // The following null checks should basically be redundant but were added to manage
        // an odd behaviour recorded with Android 8.0.0
        // (see https://github.com/wordpress-mobile/WordPress-Android/issues/9748 for more information)
<span class="nc bnc" id="L1306" title="All 2 branches missed.">        if (switchToGutenbergMenuItem != null) {</span>
<span class="nc bnc" id="L1307" title="All 2 branches missed.">            boolean switchToGutenbergVisibility = mShowGutenbergEditor ? false</span>
<span class="nc" id="L1308">                    : shouldSwitchToGutenbergBeVisible(mEditorFragment, mSite);</span>
<span class="nc" id="L1309">            switchToGutenbergMenuItem.setVisible(switchToGutenbergVisibility);</span>
        }

<span class="nc" id="L1312">        MenuItem contentInfo = menu.findItem(R.id.menu_content_info);</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">        if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L1314">            contentInfo.setOnMenuItemClickListener((menuItem) -&gt; {</span>
                try {
<span class="nc" id="L1316">                    mEditorFragment.showContentInfo();</span>
<span class="nc" id="L1317">                } catch (EditorFragmentNotAddedException e) {</span>
<span class="nc" id="L1318">                    ToastUtils.showToast(WordPress.getContext(), R.string.toast_content_info_failed);</span>
<span class="nc" id="L1319">                }</span>
<span class="nc" id="L1320">                return true;</span>
            });
        } else {
<span class="nc" id="L1323">            contentInfo.setVisible(false); // only show the menu item when for Gutenberg</span>
        }

<span class="nc bnc" id="L1326" title="All 2 branches missed.">        if (helpMenuItem != null) {</span>
<span class="nc bnc" id="L1327" title="All 4 branches missed.">            if (mEditorFragment instanceof GutenbergEditorFragment</span>
                &amp;&amp; showMenuItems
            ) {
<span class="nc" id="L1330">                helpMenuItem.setVisible(true);</span>
            } else {
<span class="nc" id="L1332">                helpMenuItem.setVisible(false);</span>
            }
        }

<span class="nc" id="L1336">        return super.onPrepareOptionsMenu(menu);</span>
    }

    @Override
    public void onRequestPermissionsResult(int requestCode,
                                           @NonNull String[] permissions,
                                           @NonNull int[] grantResults) {
<span class="nc" id="L1343">        super.onRequestPermissionsResult(requestCode, permissions, grantResults);</span>
<span class="nc" id="L1344">        boolean allGranted = WPPermissionUtils.setPermissionListAsked(</span>
                this, requestCode, permissions, grantResults, true);

<span class="nc bnc" id="L1347" title="All 2 branches missed.">        if (allGranted) {</span>
<span class="nc bnc" id="L1348" title="All 3 branches missed.">            switch (requestCode) {</span>
                case WPPermissionUtils.EDITOR_MEDIA_PERMISSION_REQUEST_CODE:
<span class="nc bnc" id="L1350" title="All 2 branches missed.">                    if (mMenuView != null) {</span>
<span class="nc" id="L1351">                        super.openContextMenu(mMenuView);</span>
<span class="nc" id="L1352">                        mMenuView = null;</span>
                    }
                    break;
                case WPPermissionUtils.EDITOR_DRAG_DROP_PERMISSION_REQUEST_CODE:
<span class="nc" id="L1356">                    mEditorMedia.addNewMediaItemsToEditorAsync(mEditorMedia.getDroppedMediaUris(), false);</span>
<span class="nc" id="L1357">                    mEditorMedia.getDroppedMediaUris().clear();</span>
                    break;
            }
        }
<span class="nc" id="L1361">    }</span>

    private boolean handleBackPressed() {
<span class="nc" id="L1364">        Fragment fragment = getSupportFragmentManager().findFragmentByTag(</span>
                ImageSettingsDialogFragment.IMAGE_SETTINGS_DIALOG_TAG);
<span class="nc bnc" id="L1366" title="All 4 branches missed.">        if (fragment != null &amp;&amp; fragment.isVisible()) {</span>
<span class="nc bnc" id="L1367" title="All 2 branches missed.">            if (fragment instanceof ImageSettingsDialogFragment) {</span>
<span class="nc" id="L1368">                ImageSettingsDialogFragment imFragment = (ImageSettingsDialogFragment) fragment;</span>
<span class="nc" id="L1369">                imFragment.dismissFragment();</span>
            }

<span class="nc" id="L1372">            return false;</span>
        }

<span class="nc bnc" id="L1375" title="All 2 branches missed.">        if (mViewPager.getCurrentItem() == PAGE_PUBLISH_SETTINGS) {</span>
<span class="nc" id="L1376">            mViewPager.setCurrentItem(PAGE_SETTINGS);</span>
<span class="nc" id="L1377">            invalidateOptionsMenu();</span>
<span class="nc bnc" id="L1378" title="All 2 branches missed.">        } else if (mViewPager.getCurrentItem() &gt; PAGE_CONTENT) {</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">            if (mViewPager.getCurrentItem() == PAGE_SETTINGS) {</span>
<span class="nc" id="L1380">                mEditorFragment.setFeaturedImageId(mEditPostRepository.getFeaturedImageId());</span>
            }

<span class="nc" id="L1383">            mViewPager.setCurrentItem(PAGE_CONTENT);</span>
<span class="nc" id="L1384">            invalidateOptionsMenu();</span>
<span class="nc bnc" id="L1385" title="All 2 branches missed.">        } else if (mEditorPhotoPicker.isPhotoPickerShowing()) {</span>
<span class="nc" id="L1386">            mEditorPhotoPicker.hidePhotoPicker();</span>
        } else {
<span class="nc" id="L1388">            performWhenNoStoriesBeingSaved(new DoWhenNoStoriesBeingSavedCallback() {</span>
                @Override public void doWhenNoStoriesBeingSaved() {
<span class="nc" id="L1390">                    savePostAndOptionallyFinish(true, false);</span>
<span class="nc" id="L1391">                }</span>
            });
        }

<span class="nc" id="L1395">        return true;</span>
    }

    interface DoWhenNoStoriesBeingSavedCallback {
        void doWhenNoStoriesBeingSaved();
    }

    private void performWhenNoStoriesBeingSaved(DoWhenNoStoriesBeingSavedCallback callback) {
<span class="nc bnc" id="L1403" title="All 2 branches missed.">        if (mStoriesEventListener.getStoriesSavingInProgress().isEmpty()) {</span>
<span class="nc" id="L1404">            callback.doWhenNoStoriesBeingSaved();</span>
        } else {
            // Oops! A story is still being saved, let's wait
<span class="nc" id="L1407">            ToastUtils.showToast(EditPostActivity.this,</span>
<span class="nc" id="L1408">                    getString(R.string.toast_edit_story_update_in_progress_title));</span>
        }
<span class="nc" id="L1410">    }</span>

    private RemotePreviewLogicHelper.RemotePreviewHelperFunctions getEditPostActivityStrategyFunctions() {
<span class="nc" id="L1413">        return new RemotePreviewLogicHelper.RemotePreviewHelperFunctions() {</span>
            @Override
            public boolean notifyUploadInProgress(@NotNull PostImmutableModel post) {
<span class="nc bnc" id="L1416" title="All 2 branches missed.">                if (UploadService.hasInProgressMediaUploadsForPost(post)) {</span>
<span class="nc" id="L1417">                    ToastUtils.showToast(EditPostActivity.this,</span>
<span class="nc" id="L1418">                            getString(R.string.editor_toast_uploading_please_wait), Duration.SHORT);</span>
<span class="nc" id="L1419">                    return true;</span>
                } else {
<span class="nc" id="L1421">                    return false;</span>
                }
            }

            @Override
            public void notifyEmptyDraft() {
<span class="nc" id="L1427">                ToastUtils.showToast(EditPostActivity.this,</span>
<span class="nc" id="L1428">                        getString(R.string.error_preview_empty_draft), Duration.SHORT);</span>
<span class="nc" id="L1429">            }</span>

            @Override
            public void startUploading(boolean isRemoteAutoSave, @Nullable PostImmutableModel post) {
<span class="nc bnc" id="L1433" title="All 2 branches missed.">                if (isRemoteAutoSave) {</span>
<span class="nc" id="L1434">                    updatePostLoadingAndDialogState(PostLoadingState.REMOTE_AUTO_SAVING_FOR_PREVIEW, post);</span>
<span class="nc" id="L1435">                    savePostAndOptionallyFinish(false, true);</span>
                } else {
<span class="nc" id="L1437">                    updatePostLoadingAndDialogState(PostLoadingState.UPLOADING_FOR_PREVIEW, post);</span>
<span class="nc" id="L1438">                    savePostAndOptionallyFinish(false, false);</span>
                }
<span class="nc" id="L1440">            }</span>

            @Override
            public void notifyEmptyPost() {
<span class="nc" id="L1444">                String message =</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">                        getString(mIsPage ? R.string.error_preview_empty_page : R.string.error_preview_empty_post);</span>
<span class="nc" id="L1446">                ToastUtils.showToast(EditPostActivity.this, message, Duration.SHORT);</span>
<span class="nc" id="L1447">            }</span>
        };
    }

    // Menu actions
    @Override
    public boolean onOptionsItemSelected(final MenuItem item) {
<span class="nc" id="L1454">        int itemId = item.getItemId();</span>

<span class="nc bnc" id="L1456" title="All 2 branches missed.">        if (itemId == android.R.id.home) {</span>
<span class="nc" id="L1457">            return handleBackPressed();</span>
        }

<span class="nc" id="L1460">        mEditorPhotoPicker.hidePhotoPicker();</span>

<span class="nc bnc" id="L1462" title="All 2 branches missed.">        if (itemId == R.id.menu_primary_action) {</span>
<span class="nc" id="L1463">            performPrimaryAction();</span>
        } else {
            // Disable other action bar buttons while a media upload is in progress
            // (unnecessary for Aztec since it supports progress reattachment)
<span class="nc bnc" id="L1467" title="All 4 branches missed.">            if (!(mShowAztecEditor || mShowGutenbergEditor)</span>
<span class="nc bnc" id="L1468" title="All 4 branches missed.">                &amp;&amp; (mEditorFragment.isUploadingMedia() || mEditorFragment.isActionInProgress())) {</span>
<span class="nc" id="L1469">                ToastUtils.showToast(this, R.string.editor_toast_uploading_please_wait, Duration.SHORT);</span>
<span class="nc" id="L1470">                return false;</span>
            }

<span class="nc bnc" id="L1473" title="All 2 branches missed.">            if (itemId == R.id.menu_history) {</span>
<span class="nc" id="L1474">                AnalyticsTracker.track(Stat.REVISIONS_LIST_VIEWED);</span>
<span class="nc" id="L1475">                ActivityUtils.hideKeyboard(this);</span>
<span class="nc" id="L1476">                mViewPager.setCurrentItem(PAGE_HISTORY);</span>
<span class="nc bnc" id="L1477" title="All 2 branches missed.">            } else if (itemId == R.id.menu_preview_post) {</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">                if (!showPreview()) {</span>
<span class="nc" id="L1479">                    return false;</span>
                }
<span class="nc bnc" id="L1481" title="All 2 branches missed.">            } else if (itemId == R.id.menu_post_settings) {</span>
<span class="nc bnc" id="L1482" title="All 2 branches missed.">                if (mEditPostSettingsFragment != null) {</span>
<span class="nc" id="L1483">                    mEditPostSettingsFragment.refreshViews();</span>
                }
<span class="nc" id="L1485">                ActivityUtils.hideKeyboard(this);</span>
<span class="nc" id="L1486">                mViewPager.setCurrentItem(PAGE_SETTINGS);</span>
<span class="nc bnc" id="L1487" title="All 2 branches missed.">            } else if (itemId == R.id.menu_secondary_action) {</span>
<span class="nc" id="L1488">                return performSecondaryAction();</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">            } else if (itemId == R.id.menu_html_mode) {</span>
                // toggle HTML mode
<span class="nc bnc" id="L1491" title="All 2 branches missed.">                if (mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L1492">                    ((AztecEditorFragment) mEditorFragment).onToolbarHtmlButtonClicked();</span>
<span class="nc bnc" id="L1493" title="All 2 branches missed.">                } else if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L1494">                    ((GutenbergEditorFragment) mEditorFragment).onToggleHtmlMode();</span>
                }
<span class="nc bnc" id="L1496" title="All 2 branches missed.">            } else if (itemId == R.id.menu_switch_to_gutenberg) {</span>
                // The following boolean check should be always redundant but was added to manage
                // an odd behaviour recorded with Android 8.0.0
                // (see https://github.com/wordpress-mobile/WordPress-Android/issues/9748 for more information)
<span class="nc bnc" id="L1500" title="All 2 branches missed.">                if (shouldSwitchToGutenbergBeVisible(mEditorFragment, mSite)) {</span>
                    // let's finish this editing instance and start again, but let GB be used
<span class="nc" id="L1502">                    mRestartEditorOption = RestartEditorOptions.RESTART_DONT_SUPPRESS_GUTENBERG;</span>
<span class="nc" id="L1503">                    mPostEditorAnalyticsSession.switchEditor(Editor.GUTENBERG);</span>
<span class="nc" id="L1504">                    mPostEditorAnalyticsSession.setOutcome(Outcome.SAVE);</span>
<span class="nc" id="L1505">                    mViewModel.finish(ActivityFinishState.SAVED_LOCALLY);</span>
                } else {
<span class="nc" id="L1507">                    logWrongMenuState(&quot;Wrong state in menu_switch_to_gutenberg: menu should not be visible.&quot;);</span>
                }
<span class="nc bnc" id="L1509" title="All 2 branches missed.">            } else if (itemId == R.id.menu_editor_help) {</span>
                // Display the editor help page -- option should only be available in the GutenbergEditor
<span class="nc bnc" id="L1511" title="All 2 branches missed.">                if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L1512">                    mAnalyticsTrackerWrapper.track(Stat.EDITOR_HELP_SHOWN, mSite);</span>
<span class="nc" id="L1513">                    ((GutenbergEditorFragment) mEditorFragment).showEditorHelp();</span>
                }
            }
        }
<span class="nc" id="L1517">        return false;</span>
    }

    private void logWrongMenuState(String logMsg) {
<span class="nc" id="L1521">        AppLog.w(T.EDITOR, logMsg);</span>
<span class="nc" id="L1522">    }</span>

    private void showEmptyPostErrorForSecondaryAction() {
<span class="nc bnc" id="L1525" title="All 2 branches missed.">        String message = getString(mIsPage ? R.string.error_publish_empty_page : R.string.error_publish_empty_post);</span>
<span class="nc bnc" id="L1526" title="All 2 branches missed.">        if (getSecondaryAction() == SecondaryEditorAction.SAVE_AS_DRAFT</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">            || getSecondaryAction() == SecondaryEditorAction.SAVE) {</span>
<span class="nc" id="L1528">            message = getString(R.string.error_save_empty_draft);</span>
        }
<span class="nc" id="L1530">        ToastUtils.showToast(EditPostActivity.this, message, Duration.SHORT);</span>
<span class="nc" id="L1531">    }</span>

    private void saveAsDraft() {
<span class="nc" id="L1534">        mEditPostSettingsFragment.updatePostStatus(PostStatus.DRAFT);</span>
<span class="nc" id="L1535">        ToastUtils.showToast(EditPostActivity.this,</span>
<span class="nc" id="L1536">                getString(R.string.editor_post_converted_back_to_draft), Duration.SHORT);</span>
<span class="nc" id="L1537">        mUploadUtilsWrapper.showSnackbar(</span>
<span class="nc" id="L1538">                findViewById(R.id.editor_activity),</span>
                R.string.editor_uploading_post);
<span class="nc" id="L1540">        savePostAndOptionallyFinish(false, false);</span>
<span class="nc" id="L1541">    }</span>

    private boolean performSecondaryAction() {
<span class="nc bnc" id="L1544" title="All 2 branches missed.">        if (UploadService.hasInProgressMediaUploadsForPost(mEditPostRepository.getPost())) {</span>
<span class="nc" id="L1545">            ToastUtils.showToast(EditPostActivity.this,</span>
<span class="nc" id="L1546">                    getString(R.string.editor_toast_uploading_please_wait), Duration.SHORT);</span>
<span class="nc" id="L1547">            return false;</span>
        }

<span class="nc bnc" id="L1550" title="All 2 branches missed.">        if (isDiscardable()) {</span>
<span class="nc" id="L1551">            showEmptyPostErrorForSecondaryAction();</span>
<span class="nc" id="L1552">            return false;</span>
        }

<span class="nc bnc" id="L1555" title="All 5 branches missed.">        switch (getSecondaryAction()) {</span>
            case SAVE_AS_DRAFT:
                // Force the new Draft status
<span class="nc" id="L1558">                saveAsDraft();</span>
<span class="nc" id="L1559">                return true;</span>
            case SAVE:
<span class="nc" id="L1561">                uploadPost(false);</span>
<span class="nc" id="L1562">                return true;</span>
            case PUBLISH_NOW:
<span class="nc" id="L1564">                mAnalyticsTrackerWrapper.track(Stat.EDITOR_POST_PUBLISH_TAPPED);</span>
<span class="nc" id="L1565">                mPublishPostImmediatelyUseCase.updatePostToPublishImmediately(mEditPostRepository, mIsNewPost);</span>
<span class="nc" id="L1566">                checkNoStorySaveOperationInProgressAndShowPrepublishingNudgeBottomSheet();</span>
<span class="nc" id="L1567">                return true;</span>
            case NONE:
<span class="nc" id="L1569">                throw new IllegalStateException(&quot;Switch in `secondaryAction` shouldn't go through the NONE case&quot;);</span>
        }
<span class="nc" id="L1571">        return false;</span>
    }

    private void refreshEditorContent() {
<span class="nc" id="L1575">        mHasSetPostContent = false;</span>
<span class="nc" id="L1576">        fillContentEditorFields();</span>
<span class="nc" id="L1577">    }</span>

    private void setPreviewingInEditorSticky(boolean enable, @Nullable PostImmutableModel post) {
<span class="nc bnc" id="L1580" title="All 2 branches missed.">        if (enable) {</span>
<span class="nc bnc" id="L1581" title="All 2 branches missed.">            if (post != null) {</span>
<span class="nc" id="L1582">                EventBus.getDefault().postSticky(</span>
<span class="nc" id="L1583">                        new PostEvents.PostPreviewingInEditor(post.getLocalSiteId(), post.getId()));</span>
            }
        } else {
            PostEvents.PostPreviewingInEditor stickyEvent =
<span class="nc" id="L1587">                    EventBus.getDefault().getStickyEvent(PostEvents.PostPreviewingInEditor.class);</span>
<span class="nc bnc" id="L1588" title="All 2 branches missed.">            if (stickyEvent != null) {</span>
<span class="nc" id="L1589">                EventBus.getDefault().removeStickyEvent(stickyEvent);</span>
            }
        }
<span class="nc" id="L1592">    }</span>

    private void managePostLoadingStateTransitions(PostLoadingState postLoadingState,
                                                   @Nullable PostImmutableModel post) {
<span class="nc bnc" id="L1596" title="All 3 branches missed.">        switch (postLoadingState) {</span>
            case NONE:
<span class="nc" id="L1598">                setPreviewingInEditorSticky(false, post);</span>
<span class="nc" id="L1599">                break;</span>
            case UPLOADING_FOR_PREVIEW:
            case REMOTE_AUTO_SAVING_FOR_PREVIEW:
            case PREVIEWING:
            case REMOTE_AUTO_SAVE_PREVIEW_ERROR:
<span class="nc" id="L1604">                setPreviewingInEditorSticky(true, post);</span>
<span class="nc" id="L1605">                break;</span>
            case LOADING_REVISION:
                // nothing to do
                break;
        }
<span class="nc" id="L1610">    }</span>

    private void updatePostLoadingAndDialogState(PostLoadingState postLoadingState) {
<span class="nc" id="L1613">        updatePostLoadingAndDialogState(postLoadingState, null);</span>
<span class="nc" id="L1614">    }</span>

    private void updatePostLoadingAndDialogState(PostLoadingState postLoadingState, @Nullable PostImmutableModel post) {
        // We need only transitions, so...
<span class="nc bnc" id="L1618" title="All 2 branches missed.">        if (mPostLoadingState == postLoadingState) return;</span>

<span class="nc" id="L1620">        AppLog.d(</span>
                AppLog.T.POSTS,
                &quot;Editor post loading state machine: transition from &quot; + mPostLoadingState + &quot; to &quot; + postLoadingState
        );

        // update the state
<span class="nc" id="L1626">        mPostLoadingState = postLoadingState;</span>

        // take care of exit actions on state transition
<span class="nc" id="L1629">        managePostLoadingStateTransitions(postLoadingState, post);</span>

        // update the progress dialog state
<span class="nc" id="L1632">        mProgressDialog = mProgressDialogHelper.updateProgressDialogState(</span>
                this,
                mProgressDialog,
<span class="nc" id="L1635">                mPostLoadingState.getProgressDialogUiState(),</span>
                mUiHelpers);
<span class="nc" id="L1637">    }</span>

    private void toggleHtmlModeOnMenu() {
<span class="nc bnc" id="L1640" title="All 2 branches missed.">        mHtmlModeMenuStateOn = !mHtmlModeMenuStateOn;</span>
<span class="nc" id="L1641">        trackPostSessionEditorModeSwitch();</span>
<span class="nc" id="L1642">        invalidateOptionsMenu();</span>
<span class="nc" id="L1643">        showEditorModeSwitchedNotice();</span>
<span class="nc" id="L1644">    }</span>

    private void showEditorModeSwitchedNotice() {
<span class="nc bnc" id="L1647" title="All 2 branches missed.">        String message = getString(mHtmlModeMenuStateOn</span>
<span class="nc" id="L1648">                ? R.string.menu_html_mode_switched_notice</span>
<span class="nc" id="L1649">                : R.string.menu_visual_mode_switched_notice</span>
        );
<span class="nc" id="L1651">        mEditorFragment.showNotice(message);</span>
<span class="nc" id="L1652">    }</span>

    private void trackPostSessionEditorModeSwitch() {
<span class="nc" id="L1655">        boolean isGutenberg = mEditorFragment instanceof GutenbergEditorFragment;</span>
<span class="nc" id="L1656">        mPostEditorAnalyticsSession.switchEditor(</span>
<span class="nc bnc" id="L1657" title="All 4 branches missed.">                mHtmlModeMenuStateOn ? Editor.HTML : (isGutenberg ? Editor.GUTENBERG : Editor.CLASSIC));</span>
<span class="nc" id="L1658">    }</span>

    private void performPrimaryAction() {
<span class="nc bnc" id="L1661" title="All 4 branches missed.">        switch (getPrimaryAction()) {</span>
            case PUBLISH_NOW:
<span class="nc" id="L1663">                mAnalyticsTrackerWrapper.track(Stat.EDITOR_POST_PUBLISH_TAPPED);</span>
<span class="nc" id="L1664">                checkNoStorySaveOperationInProgressAndShowPrepublishingNudgeBottomSheet();</span>
<span class="nc" id="L1665">                return;</span>
            case UPDATE:
            case CONTINUE:
            case SCHEDULE:
            case SUBMIT_FOR_REVIEW:
<span class="nc" id="L1670">                checkNoStorySaveOperationInProgressAndShowPrepublishingNudgeBottomSheet();</span>
<span class="nc" id="L1671">                return;</span>
            case SAVE:
<span class="nc" id="L1673">                uploadPost(false);</span>
                break;
        }
<span class="nc" id="L1676">    }</span>

    private void showGutenbergInformativeDialog() {
        // We are no longer showing the dialog, but we are leaving all the surrounding logic because
        // this is going in shortly before release, and we're going to remove all this logic in the
        // very near future.

<span class="nc" id="L1683">        AppPrefs.setGutenbergInfoPopupDisplayed(mSite.getUrl(), true);</span>
<span class="nc" id="L1684">    }</span>

    private void showGutenbergRolloutV2InformativeDialog() {
        // We are no longer showing the dialog, but we are leaving all the surrounding logic because
        // this is going in shortly before release, and we're going to remove all this logic in the
        // very near future.

<span class="nc" id="L1691">        AppPrefs.setGutenbergInfoPopupDisplayed(mSite.getUrl(), true);</span>
<span class="nc" id="L1692">    }</span>

    private void setGutenbergEnabledIfNeeded() {
<span class="nc bnc" id="L1695" title="All 2 branches missed.">        if (AppPrefs.isGutenbergInfoPopupDisplayed(mSite.getUrl())) {</span>
<span class="nc" id="L1696">            return;</span>
        }

<span class="nc" id="L1699">        boolean showPopup = AppPrefs.shouldShowGutenbergInfoPopupForTheNewPosts(mSite.getUrl());</span>
<span class="nc" id="L1700">        boolean showRolloutPopupPhase2 = AppPrefs.shouldShowGutenbergInfoPopupPhase2ForNewPosts(mSite.getUrl());</span>

<span class="nc bnc" id="L1702" title="All 4 branches missed.">        if (TextUtils.isEmpty(mSite.getMobileEditor()) &amp;&amp; !mIsNewPost) {</span>
<span class="nc" id="L1703">            SiteUtils.enableBlockEditor(mDispatcher, mSite);</span>
<span class="nc" id="L1704">            AnalyticsUtils.trackWithSiteDetails(Stat.EDITOR_GUTENBERG_ENABLED, mSite,</span>
<span class="nc" id="L1705">                    BlockEditorEnabledSource.ON_BLOCK_POST_OPENING.asPropertyMap());</span>
        }

<span class="nc bnc" id="L1708" title="All 2 branches missed.">        if (showPopup) {</span>
<span class="nc" id="L1709">            showGutenbergInformativeDialog();</span>
<span class="nc bnc" id="L1710" title="All 2 branches missed.">        } else if (showRolloutPopupPhase2) {</span>
<span class="nc" id="L1711">            showGutenbergRolloutV2InformativeDialog();</span>
        }
<span class="nc" id="L1713">    }</span>

    private ActivityFinishState savePostOnline(boolean isFirstTimePublish) {
<span class="nc" id="L1716">        return mViewModel.savePostOnline(isFirstTimePublish, this, mEditPostRepository, mSite);</span>
    }

    private void onUploadSuccess(MediaModel media) {
<span class="nc bnc" id="L1720" title="All 2 branches missed.">        if (media != null) {</span>
            // TODO Should this statement check media.getLocalPostId() == mEditPostRepository.getId()?
<span class="nc bnc" id="L1722" title="All 4 branches missed.">            if (!media.getMarkedLocallyAsFeatured() &amp;&amp; mEditorMediaUploadListener != null) {</span>
<span class="nc" id="L1723">                mEditorMediaUploadListener.onMediaUploadSucceeded(String.valueOf(media.getId()),</span>
<span class="nc" id="L1724">                        FluxCUtils.mediaFileFromMediaModel(media));</span>
<span class="nc bnc" id="L1725" title="All 2 branches missed.">                if (PostUtils.contentContainsWPStoryGutenbergBlocks(mEditPostRepository.getContent())) {</span>
                    // make sure to sync the local post object with the UI and save
                    // then post the event for StoriesEventListener to process
<span class="nc" id="L1728">                    updateAndSavePostAsync(</span>
<span class="nc" id="L1729">                            updatePostResult -&gt; mStoriesEventListener.postStoryMediaUploadedEvent(media)</span>
                    );
                }
<span class="nc bnc" id="L1732" title="All 2 branches missed.">            } else if (media.getMarkedLocallyAsFeatured() &amp;&amp; media.getLocalPostId() == mEditPostRepository</span>
<span class="nc bnc" id="L1733" title="All 2 branches missed.">                    .getId()) {</span>
<span class="nc" id="L1734">                setFeaturedImageId(media.getMediaId(), false, false);</span>
            }
        }
<span class="nc" id="L1737">    }</span>

    private void onUploadProgress(MediaModel media, float progress) {
<span class="nc" id="L1740">        String localMediaId = String.valueOf(media.getId());</span>
<span class="nc bnc" id="L1741" title="All 2 branches missed.">        if (mEditorMediaUploadListener != null) {</span>
<span class="nc" id="L1742">            mEditorMediaUploadListener.onMediaUploadProgress(localMediaId, progress);</span>
        }
<span class="nc" id="L1744">    }</span>

    private void launchPictureLibrary() {
<span class="nc" id="L1747">        WPMediaUtils.launchPictureLibrary(this, mEditorPhotoPicker.getAllowMultipleSelection());</span>
<span class="nc" id="L1748">    }</span>

    private void launchVideoLibrary() {
<span class="nc" id="L1751">        WPMediaUtils.launchVideoLibrary(this, mEditorPhotoPicker.getAllowMultipleSelection());</span>
<span class="nc" id="L1752">    }</span>

    private void launchVideoCamera() {
<span class="nc" id="L1755">        WPMediaUtils.launchVideoCamera(this);</span>
<span class="nc" id="L1756">    }</span>

    private void showErrorAndFinish(int errorMessageId) {
<span class="nc" id="L1759">        ToastUtils.showToast(this, errorMessageId, ToastUtils.Duration.LONG);</span>
<span class="nc" id="L1760">        finish();</span>
<span class="nc" id="L1761">    }</span>

    private void updateAndSavePostAsync() {
<span class="nc bnc" id="L1764" title="All 2 branches missed.">        if (mEditorFragment == null) {</span>
<span class="nc" id="L1765">            AppLog.e(AppLog.T.POSTS, &quot;Fragment not initialized&quot;);</span>
<span class="nc" id="L1766">            return;</span>
        }
<span class="nc" id="L1768">        mViewModel.updatePostObjectWithUIAsync(mEditPostRepository, this::updateFromEditor, null);</span>
<span class="nc" id="L1769">    }</span>

    private void updateAndSavePostAsync(final OnPostUpdatedFromUIListener listener) {
<span class="nc bnc" id="L1772" title="All 2 branches missed.">        if (mEditorFragment == null) {</span>
<span class="nc" id="L1773">            AppLog.e(AppLog.T.POSTS, &quot;Fragment not initialized&quot;);</span>
<span class="nc" id="L1774">            return;</span>
        }
<span class="nc" id="L1776">        mViewModel.updatePostObjectWithUIAsync(mEditPostRepository,</span>
                this::updateFromEditor,
                (post, result) -&gt; {
<span class="nc" id="L1779">                    mViewModel.setSavingPostOnEditorExit(false);</span>
                    // Ignore the result as we want to invoke the listener even when the PostModel was up-to-date
<span class="nc bnc" id="L1781" title="All 2 branches missed.">                    if (listener != null) {</span>
<span class="nc" id="L1782">                        listener.onPostUpdatedFromUI(result);</span>
                    }
<span class="nc" id="L1784">                    return null;</span>
                });
<span class="nc" id="L1786">    }</span>

    /**
     * This method:
     *   1. Shows and hides the editor's progress dialog;
     *   2. Saves the post via {@link EditPostActivity#updateAndSavePostAsync(OnPostUpdatedFromUIListener)};
     *   3. Invokes the listener method parameter
     */
    private void updateAndSavePostAsyncOnEditorExit(@NonNull final OnPostUpdatedFromUIListener listener) {
<span class="nc bnc" id="L1795" title="All 2 branches missed.">        if (mEditorFragment == null) {</span>
<span class="nc" id="L1796">            return;</span>
        }
<span class="nc" id="L1798">        mViewModel.setSavingPostOnEditorExit(true);</span>
<span class="nc" id="L1799">        mViewModel.showSavingProgressDialog();</span>
<span class="nc" id="L1800">        updateAndSavePostAsync((result) -&gt; listener.onPostUpdatedFromUI(result));</span>
<span class="nc" id="L1801">    }</span>

    private UpdateFromEditor updateFromEditor(String oldContent) {
        try {
            // To reduce redundant bridge events emitted to the Gutenberg editor, we get title and content at once
<span class="nc" id="L1806">            Pair&lt;CharSequence, CharSequence&gt; titleAndContent = mEditorFragment.getTitleAndContent(oldContent);</span>
<span class="nc" id="L1807">            String title = (String) titleAndContent.first;</span>
<span class="nc" id="L1808">            String content = (String) titleAndContent.second;</span>
<span class="nc" id="L1809">            return new PostFields(title, content);</span>
<span class="nc" id="L1810">        } catch (EditorFragmentNotAddedException e) {</span>
<span class="nc" id="L1811">            AppLog.e(T.EDITOR, &quot;Impossible to save the post, we weren't able to update it.&quot;);</span>
<span class="nc" id="L1812">            return new UpdateFromEditor.Failed(e);</span>
        }
    }

    @Override
    public void initializeEditorFragment() {
<span class="nc bnc" id="L1818" title="All 2 branches missed.">        if (mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L1819">            AztecEditorFragment aztecEditorFragment = (AztecEditorFragment) mEditorFragment;</span>
<span class="nc" id="L1820">            aztecEditorFragment.setEditorImageSettingsListener(EditPostActivity.this);</span>
<span class="nc" id="L1821">            aztecEditorFragment.setMediaToolbarButtonClickListener(mEditorPhotoPicker);</span>

            // Here we should set the max width for media, but the default size is already OK. No need
            // to customize it further

<span class="nc" id="L1826">            Drawable loadingImagePlaceholder = EditorMediaUtils.getAztecPlaceholderDrawableFromResID(</span>
                    this,
                    org.wordpress.android.editor.R.drawable.ic_gridicons_image,
<span class="nc" id="L1829">                    aztecEditorFragment.getMaxMediaSize()</span>
            );
<span class="nc" id="L1831">            mAztecImageLoader = new AztecImageLoader(getBaseContext(), mImageManager, loadingImagePlaceholder);</span>
<span class="nc" id="L1832">            aztecEditorFragment.setAztecImageLoader(mAztecImageLoader);</span>
<span class="nc" id="L1833">            aztecEditorFragment.setLoadingImagePlaceholder(loadingImagePlaceholder);</span>

<span class="nc" id="L1835">            Drawable loadingVideoPlaceholder = EditorMediaUtils.getAztecPlaceholderDrawableFromResID(</span>
                    this,
                    org.wordpress.android.editor.R.drawable.ic_gridicons_video_camera,
<span class="nc" id="L1838">                    aztecEditorFragment.getMaxMediaSize()</span>
            );
<span class="nc" id="L1840">            aztecEditorFragment.setAztecVideoLoader(new AztecVideoLoader(getBaseContext(), loadingVideoPlaceholder));</span>
<span class="nc" id="L1841">            aztecEditorFragment.setLoadingVideoPlaceholder(loadingVideoPlaceholder);</span>

<span class="nc bnc" id="L1843" title="All 6 branches missed.">            if (getSite() != null &amp;&amp; getSite().isWPCom() &amp;&amp; !getSite().isPrivate()) {</span>
                // Add the content reporting for wpcom blogs that are not private
<span class="nc" id="L1845">                aztecEditorFragment.enableContentLogOnCrashes(</span>
                        throwable -&gt; {
                            // Do not log private or password protected post
<span class="nc bnc" id="L1848" title="All 4 branches missed.">                            return mEditPostRepository.hasPost() &amp;&amp; TextUtils.isEmpty(mEditPostRepository.getPassword())</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">                                   &amp;&amp; !mEditPostRepository.hasStatus(PostStatus.PRIVATE);</span>
                        }
                );
            }

<span class="nc bnc" id="L1854" title="All 2 branches missed.">            if (mEditPostRepository.hasPost() &amp;&amp; AppPrefs</span>
<span class="nc bnc" id="L1855" title="All 2 branches missed.">                    .isPostWithHWAccelerationOff(mEditPostRepository.getLocalSiteId(), mEditPostRepository.getId())) {</span>
                // We need to disable HW Acc. on this post
<span class="nc" id="L1857">                aztecEditorFragment.disableHWAcceleration();</span>
            }
<span class="nc" id="L1859">            aztecEditorFragment.setExternalLogger(new AztecLog.ExternalLogger() {</span>
                // This method handles the custom Exception thrown by Aztec to notify the parent app of the error #8828
                // We don't need to log the error, since it was already logged by Aztec, instead we need to write the
                // prefs to disable HW acceleration for it.
                private boolean isError8828(@NotNull Throwable throwable) {
<span class="nc bnc" id="L1864" title="All 2 branches missed.">                    if (!(throwable instanceof DynamicLayoutGetBlockIndexOutOfBoundsException)) {</span>
<span class="nc" id="L1865">                        return false;</span>
                    }
<span class="nc bnc" id="L1867" title="All 2 branches missed.">                    if (!mEditPostRepository.hasPost()) {</span>
<span class="nc" id="L1868">                        return false;</span>
                    }
<span class="nc" id="L1870">                    AppPrefs.addPostWithHWAccelerationOff(mEditPostRepository.getLocalSiteId(),</span>
<span class="nc" id="L1871">                            mEditPostRepository.getId());</span>
<span class="nc" id="L1872">                    return true;</span>
                }

                @Override
                public void log(@NotNull String s) {
<span class="nc" id="L1877">                    AppLog.e(T.EDITOR, s);</span>
<span class="nc" id="L1878">                }</span>

                @Override
                public void logException(@NotNull Throwable throwable) {
<span class="nc bnc" id="L1882" title="All 2 branches missed.">                    if (isError8828(throwable)) {</span>
<span class="nc" id="L1883">                        return;</span>
                    }
<span class="nc" id="L1885">                    AppLog.e(T.EDITOR, throwable);</span>
<span class="nc" id="L1886">                }</span>

                @Override
                public void logException(@NotNull Throwable throwable, String s) {
<span class="nc bnc" id="L1890" title="All 2 branches missed.">                    if (isError8828(throwable)) {</span>
<span class="nc" id="L1891">                        return;</span>
                    }
<span class="nc" id="L1893">                    AppLog.e(T.EDITOR, s);</span>
<span class="nc" id="L1894">                }</span>
            });
        }
<span class="nc" id="L1897">    }</span>

    @Override
    public void onImageSettingsRequested(EditorImageMetaData editorImageMetaData) {
<span class="nc" id="L1901">        MediaSettingsActivity.showForResult(this, mSite, editorImageMetaData);</span>
<span class="nc" id="L1902">    }</span>


    @Override public void onImagePreviewRequested(String mediaUrl) {
<span class="nc" id="L1906">        MediaPreviewActivity.showPreview(this, mSite, mediaUrl);</span>
<span class="nc" id="L1907">    }</span>

    @Override public void onMediaEditorRequested(String mediaUrl) {
<span class="nc" id="L1910">        String imageUrl = UrlUtils.removeQuery(StringUtils.notNullStr(mediaUrl));</span>

        // We're using a separate cache in WPAndroid and RN's Gutenberg editor so we need to reload the image
        // in the preview screen using WPAndroid's image loader. We create a resized url using Photon service and
        // device's max width to display a smaller image that can load faster and act as a placeholder.
<span class="nc" id="L1915">        int displayWidth = Math.max(DisplayUtils.getWindowPixelWidth(getBaseContext()),</span>
<span class="nc" id="L1916">                DisplayUtils.getWindowPixelHeight(getBaseContext()));</span>

<span class="nc" id="L1918">        int margin = getResources().getDimensionPixelSize(R.dimen.preview_image_view_margin);</span>
<span class="nc" id="L1919">        int maxWidth = displayWidth - (margin * 2);</span>

<span class="nc" id="L1921">        int reducedSizeWidth = (int) (maxWidth * PREVIEW_IMAGE_REDUCED_SIZE_FACTOR);</span>
<span class="nc" id="L1922">        String resizedImageUrl = mReaderUtilsWrapper.getResizedImageUrl(</span>
                mediaUrl,
                reducedSizeWidth,
                0,
<span class="nc bnc" id="L1926" title="All 2 branches missed.">                !SiteUtils.isPhotonCapable(mSite),</span>
<span class="nc" id="L1927">                mSite.isWPComAtomic()</span>
        );

<span class="nc" id="L1930">        String outputFileExtension = MimeTypeMap.getFileExtensionFromUrl(imageUrl);</span>

<span class="nc" id="L1932">        ArrayList&lt;EditImageData.InputData&gt; inputData = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L1933">        inputData.add(new EditImageData.InputData(</span>
                imageUrl,
<span class="nc" id="L1935">                StringUtils.notNullStr(resizedImageUrl),</span>
                outputFileExtension
        ));
<span class="nc" id="L1938">        ActivityLauncher.openImageEditor(this, inputData);</span>
<span class="nc" id="L1939">    }</span>

    /*
     * user clicked OK on a settings list dialog displayed from the settings fragment - pass the event
     * along to the settings fragment
     */
    @Override
    public void onPostSettingsFragmentPositiveButtonClicked(@NonNull PostSettingsListDialogFragment dialog) {
<span class="nc bnc" id="L1947" title="All 2 branches missed.">        if (mEditPostSettingsFragment != null) {</span>
<span class="nc" id="L1948">            mEditPostSettingsFragment.onPostSettingsFragmentPositiveButtonClicked(dialog);</span>
        }
<span class="nc" id="L1950">    }</span>

    public interface OnPostUpdatedFromUIListener {
        void onPostUpdatedFromUI(@Nullable UpdatePostResult updatePostResult);
    }

    @Override
    public void onBackPressed() {
<span class="nc" id="L1958">        handleBackPressed();</span>
<span class="nc" id="L1959">    }</span>

    @Override
    public void onHistoryItemClicked(@NonNull Revision revision, @NonNull List&lt;Revision&gt; revisions) {
<span class="nc" id="L1963">        AnalyticsTracker.track(Stat.REVISIONS_DETAIL_VIEWED_FROM_LIST);</span>
<span class="nc" id="L1964">        mRevision = revision;</span>
<span class="nc" id="L1965">        final long postId = mEditPostRepository.getRemotePostId();</span>
<span class="nc" id="L1966">        ActivityLauncher.viewHistoryDetailForResult(</span>
<span class="nc" id="L1967">                this, mRevision, getRevisionsIds(revisions), postId, mSite.getSiteId()</span>
        );
<span class="nc" id="L1969">    }</span>

    private long[] getRevisionsIds(@NonNull final List&lt;Revision&gt; revisions) {
<span class="nc" id="L1972">        final long[] idsArray = new long[revisions.size()];</span>
<span class="nc bnc" id="L1973" title="All 2 branches missed.">        for (int i = 0; i &lt; revisions.size(); i++) {</span>
<span class="nc" id="L1974">            final Revision current = revisions.get(i);</span>
<span class="nc" id="L1975">            idsArray[i] = current.getRevisionId();</span>
        }
<span class="nc" id="L1977">        return idsArray;</span>
    }

    private void loadRevision() {
<span class="nc" id="L1981">        updatePostLoadingAndDialogState(PostLoadingState.LOADING_REVISION);</span>
<span class="nc" id="L1982">        mEditPostRepository.saveForUndo();</span>
<span class="nc" id="L1983">        mEditPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L1984">            postModel.setTitle(Objects.requireNonNull(mRevision.getPostTitle()));</span>
<span class="nc" id="L1985">            postModel.setContent(Objects.requireNonNull(mRevision.getPostContent()));</span>
<span class="nc" id="L1986">            return true;</span>
        }, (postModel, result) -&gt; {
<span class="nc bnc" id="L1988" title="All 2 branches missed.">            if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L1989">                refreshEditorContent();</span>
<span class="nc" id="L1990">                WPSnackbar.make(mViewPager, getString(R.string.history_loaded_revision), 4000)</span>
<span class="nc" id="L1991">                          .setAction(getString(R.string.undo), view -&gt; {</span>
<span class="nc" id="L1992">                              AnalyticsTracker.track(Stat.REVISIONS_LOAD_UNDONE);</span>
<span class="nc" id="L1993">                              RemotePostPayload payload =</span>
<span class="nc" id="L1994">                                      new RemotePostPayload(mEditPostRepository.getPostForUndo(), mSite);</span>
<span class="nc" id="L1995">                              mDispatcher.dispatch(PostActionBuilder.newFetchPostAction(payload));</span>
<span class="nc" id="L1996">                              mEditPostRepository.undo();</span>
<span class="nc" id="L1997">                              refreshEditorContent();</span>
<span class="nc" id="L1998">                          })</span>
<span class="nc" id="L1999">                          .show();</span>

<span class="nc" id="L2001">                updatePostLoadingAndDialogState(PostLoadingState.NONE);</span>
            }
<span class="nc" id="L2003">            return null;</span>
        });
<span class="nc" id="L2005">    }</span>

    private boolean isNewPost() {
<span class="nc" id="L2008">        return mIsNewPost;</span>
    }

    private void saveResult(boolean saved, boolean uploadNotStarted) {
<span class="nc" id="L2012">        Intent i = getIntent();</span>
<span class="nc" id="L2013">        i.putExtra(EXTRA_UPLOAD_NOT_STARTED, uploadNotStarted);</span>
<span class="nc" id="L2014">        i.putExtra(EXTRA_HAS_FAILED_MEDIA, hasFailedMedia());</span>
<span class="nc" id="L2015">        i.putExtra(EXTRA_IS_PAGE, mIsPage);</span>
<span class="nc" id="L2016">        i.putExtra(EXTRA_IS_LANDING_EDITOR, mIsLandingEditor);</span>
<span class="nc" id="L2017">        i.putExtra(EXTRA_HAS_CHANGES, saved);</span>
<span class="nc" id="L2018">        i.putExtra(EXTRA_POST_LOCAL_ID, mEditPostRepository.getId());</span>
<span class="nc" id="L2019">        i.putExtra(EXTRA_POST_REMOTE_ID, mEditPostRepository.getRemotePostId());</span>
<span class="nc" id="L2020">        i.putExtra(EXTRA_RESTART_EDITOR, mRestartEditorOption.name());</span>
<span class="nc" id="L2021">        i.putExtra(STATE_KEY_EDITOR_SESSION_DATA, mPostEditorAnalyticsSession);</span>
<span class="nc" id="L2022">        i.putExtra(EXTRA_IS_NEW_POST, mIsNewPost);</span>
<span class="nc" id="L2023">        setResult(RESULT_OK, i);</span>
<span class="nc" id="L2024">    }</span>

    private void setupPrepublishingBottomSheetRunnable() {
<span class="nc" id="L2027">        mShowPrepublishingBottomSheetHandler = new Handler();</span>
<span class="nc" id="L2028">        mShowPrepublishingBottomSheetRunnable = () -&gt; {</span>
<span class="nc" id="L2029">            Fragment fragment = getSupportFragmentManager().findFragmentByTag(</span>
                    PrepublishingBottomSheetFragment.TAG);
<span class="nc bnc" id="L2031" title="All 2 branches missed.">            if (fragment == null) {</span>
<span class="nc" id="L2032">                PrepublishingBottomSheetFragment prepublishingFragment =</span>
<span class="nc" id="L2033">                        PrepublishingBottomSheetFragment.newInstance(getSite(), mIsPage, false);</span>
<span class="nc" id="L2034">                prepublishingFragment.show(getSupportFragmentManager(), PrepublishingBottomSheetFragment.TAG);</span>
            }
<span class="nc" id="L2036">        };</span>
<span class="nc" id="L2037">    }</span>

    private void checkNoStorySaveOperationInProgressAndShowPrepublishingNudgeBottomSheet() {
<span class="nc" id="L2040">        performWhenNoStoriesBeingSaved(new DoWhenNoStoriesBeingSavedCallback() {</span>
            @Override public void doWhenNoStoriesBeingSaved() {
<span class="nc" id="L2042">                showPrepublishingNudgeBottomSheet();</span>
<span class="nc" id="L2043">            }</span>
        });
<span class="nc" id="L2045">    }</span>

    private void showPrepublishingNudgeBottomSheet() {
<span class="nc" id="L2048">        mViewPager.setCurrentItem(PAGE_CONTENT);</span>
<span class="nc" id="L2049">        ActivityUtils.hideKeyboard(this);</span>
<span class="nc" id="L2050">        long delayMs = 100;</span>
<span class="nc" id="L2051">        mShowPrepublishingBottomSheetHandler.postDelayed(mShowPrepublishingBottomSheetRunnable, delayMs);</span>
<span class="nc" id="L2052">    }</span>

    @Override public void onSubmitButtonClicked(boolean publishPost) {
<span class="nc" id="L2055">        uploadPost(publishPost);</span>
<span class="nc bnc" id="L2056" title="All 2 branches missed.">        if (publishPost) {</span>
<span class="nc" id="L2057">            AppRatingDialog.INSTANCE</span>
<span class="nc" id="L2058">                    .incrementInteractions(APP_REVIEWS_EVENT_INCREMENTED_BY_PUBLISHING_POST_OR_PAGE);</span>
        }
<span class="nc" id="L2060">    }</span>

    private void uploadPost(final boolean publishPost) {
<span class="nc" id="L2063">        updateAndSavePostAsyncOnEditorExit(((updatePostResult) -&gt; {</span>
<span class="nc" id="L2064">            AccountModel account = mAccountStore.getAccount();</span>
            // prompt user to verify e-mail before publishing
<span class="nc bnc" id="L2066" title="All 2 branches missed.">            if (!account.getEmailVerified()) {</span>
<span class="nc" id="L2067">                mViewModel.hideSavingProgressDialog();</span>
<span class="nc bnc" id="L2068" title="All 2 branches missed.">                String message = TextUtils.isEmpty(account.getEmail())</span>
<span class="nc" id="L2069">                        ? getString(R.string.editor_confirm_email_prompt_message)</span>
<span class="nc" id="L2070">                        : String.format(getString(R.string.editor_confirm_email_prompt_message_with_email),</span>
<span class="nc" id="L2071">                                account.getEmail());</span>

<span class="nc" id="L2073">                AlertDialog.Builder builder = new MaterialAlertDialogBuilder(this);</span>
<span class="nc" id="L2074">                builder.setTitle(R.string.editor_confirm_email_prompt_title)</span>
<span class="nc" id="L2075">                       .setMessage(message)</span>
<span class="nc" id="L2076">                       .setPositiveButton(android.R.string.ok,</span>
                               (dialog, id) -&gt; {
<span class="nc" id="L2078">                                   ToastUtils.showToast(EditPostActivity.this,</span>
<span class="nc" id="L2079">                                           getString(R.string.toast_saving_post_as_draft));</span>
<span class="nc" id="L2080">                                   savePostAndOptionallyFinish(true, false);</span>
<span class="nc" id="L2081">                               })</span>
<span class="nc" id="L2082">                       .setNegativeButton(R.string.editor_confirm_email_prompt_negative,</span>
<span class="nc" id="L2083">                               (dialog, id) -&gt; mDispatcher</span>
<span class="nc" id="L2084">                                       .dispatch(AccountActionBuilder.newSendVerificationEmailAction()));</span>
<span class="nc" id="L2085">                builder.create().show();</span>
<span class="nc" id="L2086">                return;</span>
            }
<span class="nc bnc" id="L2088" title="All 2 branches missed.">            if (!mPostUtils.isPublishable(mEditPostRepository.getPost())) {</span>
<span class="nc" id="L2089">                mViewModel.hideSavingProgressDialog();</span>
                // TODO we don't want to show &quot;publish&quot; message when the user clicked on eg. save
<span class="nc" id="L2091">                mEditPostRepository.updateStatusFromPostSnapshotWhenEditorOpened();</span>
<span class="nc" id="L2092">                EditPostActivity.this.runOnUiThread(() -&gt; {</span>
<span class="nc" id="L2093">                    String message = getString(</span>
<span class="nc bnc" id="L2094" title="All 2 branches missed.">                            mIsPage ? R.string.error_publish_empty_page : R.string.error_publish_empty_post);</span>
<span class="nc" id="L2095">                    ToastUtils.showToast(EditPostActivity.this, message, Duration.SHORT);</span>
<span class="nc" id="L2096">                });</span>
<span class="nc" id="L2097">                return;</span>
            }

<span class="nc" id="L2100">            mViewModel.showSavingProgressDialog();</span>

<span class="nc" id="L2102">            boolean isFirstTimePublish = isFirstTimePublish(publishPost);</span>
<span class="nc" id="L2103">            mEditPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc bnc" id="L2104" title="All 2 branches missed.">                if (publishPost) {</span>
                    // now set status to PUBLISHED - only do this AFTER we have run the isFirstTimePublish() check,
                    // otherwise we'd have an incorrect value
                    // also re-set the published date in case it was SCHEDULED and they want to publish NOW
<span class="nc bnc" id="L2108" title="All 2 branches missed.">                    if (postModel.getStatus().equals(PostStatus.SCHEDULED.toString())) {</span>
<span class="nc" id="L2109">                        postModel.setDateCreated(mDateTimeUtils.currentTimeInIso8601());</span>
                    }

<span class="nc bnc" id="L2112" title="All 2 branches missed.">                    if (mUploadUtilsWrapper.userCanPublish(getSite())) {</span>
<span class="nc" id="L2113">                        postModel.setStatus(PostStatus.PUBLISHED.toString());</span>
                    } else {
<span class="nc" id="L2115">                        postModel.setStatus(PostStatus.PENDING.toString());</span>
                    }

<span class="nc" id="L2118">                    mPostEditorAnalyticsSession.setOutcome(Outcome.PUBLISH);</span>
                } else {
<span class="nc" id="L2120">                    mPostEditorAnalyticsSession.setOutcome(Outcome.SAVE);</span>
                }

<span class="nc" id="L2123">                AppLog.d(T.POSTS, &quot;User explicitly confirmed changes. Post Title: &quot; + postModel.getTitle());</span>
                // the user explicitly confirmed an intention to upload the post
<span class="nc" id="L2125">                postModel.setChangesConfirmedContentHashcode(postModel.contentHashcode());</span>

<span class="nc" id="L2127">                return true;</span>
            }, (postModel, result) -&gt; {
<span class="nc bnc" id="L2129" title="All 2 branches missed.">                if (result == Updated.INSTANCE) {</span>
<span class="nc" id="L2130">                    ActivityFinishState activityFinishState = savePostOnline(isFirstTimePublish);</span>
<span class="nc" id="L2131">                    mViewModel.finish(activityFinishState);</span>
                }
<span class="nc" id="L2133">                return null;</span>
            });
<span class="nc" id="L2135">        }));</span>
<span class="nc" id="L2136">    }</span>

    private void savePostAndOptionallyFinish(final boolean doFinish, final boolean forceSave) {
<span class="nc bnc" id="L2139" title="All 4 branches missed.">        if (mEditorFragment == null || !mEditorFragment.isAdded()) {</span>
<span class="nc" id="L2140">            AppLog.e(AppLog.T.POSTS, &quot;Fragment not initialized&quot;);</span>
<span class="nc" id="L2141">            return;</span>
        }

<span class="nc" id="L2144">        updateAndSavePostAsyncOnEditorExit(((updatePostResult) -&gt; {</span>
            // check if the opened post had some unsaved local changes
<span class="nc" id="L2146">            boolean isFirstTimePublish = isFirstTimePublish(false);</span>

            // if post was modified during this editing session, save it
<span class="nc bnc" id="L2149" title="All 4 branches missed.">            boolean shouldSave = shouldSavePost() || forceSave;</span>

<span class="nc" id="L2151">            mPostEditorAnalyticsSession.setOutcome(Outcome.SAVE);</span>
<span class="nc" id="L2152">            ActivityFinishState activityFinishState = ActivityFinishState.CANCELLED;</span>
<span class="nc bnc" id="L2153" title="All 2 branches missed.">            if (shouldSave) {</span>
                /*
                 * Remote-auto-save isn't supported on self-hosted sites. We can save the post online (as draft)
                 * only when it doesn't exist in the remote yet. When it does exist in the remote, we can upload
                 * it only when the user explicitly confirms the changes - eg. clicks on save/publish/submit. The
                 * user didn't confirm the changes in this code path.
                 */
<span class="nc bnc" id="L2160" title="All 4 branches missed.">                boolean isWpComOrIsLocalDraft = mSite.isUsingWpComRestApi() || mEditPostRepository.isLocalDraft();</span>
<span class="nc bnc" id="L2161" title="All 2 branches missed.">                if (isWpComOrIsLocalDraft) {</span>
<span class="nc" id="L2162">                    activityFinishState = savePostOnline(isFirstTimePublish);</span>
<span class="nc bnc" id="L2163" title="All 2 branches missed.">                } else if (forceSave) {</span>
<span class="nc" id="L2164">                    activityFinishState = savePostOnline(false);</span>
                } else {
<span class="nc" id="L2166">                    activityFinishState = ActivityFinishState.SAVED_LOCALLY;</span>
                }
            }
            // discard post if new &amp; empty
<span class="nc bnc" id="L2170" title="All 2 branches missed.">            if (isDiscardable()) {</span>
<span class="nc" id="L2171">                mDispatcher.dispatch(PostActionBuilder.newRemovePostAction(mEditPostRepository.getEditablePost()));</span>
<span class="nc" id="L2172">                mPostEditorAnalyticsSession.setOutcome(Outcome.CANCEL);</span>
<span class="nc" id="L2173">                activityFinishState = ActivityFinishState.CANCELLED;</span>
            }
<span class="nc bnc" id="L2175" title="All 2 branches missed.">            if (doFinish) {</span>
<span class="nc" id="L2176">                mViewModel.finish(activityFinishState);</span>
            }
<span class="nc" id="L2178">        }));</span>
<span class="nc" id="L2179">    }</span>

    private boolean shouldSavePost() {
<span class="nc" id="L2182">        boolean hasChanges = mEditPostRepository.postWasChangedInCurrentSession();</span>
<span class="nc" id="L2183">        boolean isPublishable = mEditPostRepository.isPostPublishable();</span>

<span class="nc bnc" id="L2185" title="All 4 branches missed.">        boolean existingPostWithChanges = mEditPostRepository.hasPostSnapshotWhenEditorOpened() &amp;&amp; hasChanges;</span>
        // if post was modified during this editing session, save it
<span class="nc bnc" id="L2187" title="All 6 branches missed.">        return isPublishable &amp;&amp; (existingPostWithChanges || isNewPost());</span>
    }


    private boolean isDiscardable() {
<span class="nc bnc" id="L2192" title="All 4 branches missed.">        return !mEditPostRepository.isPostPublishable() &amp;&amp; isNewPost();</span>
    }

    private boolean isFirstTimePublish(final boolean publishPost) {
<span class="nc" id="L2196">        final PostStatus originalStatus = mEditPostRepository.getStatus();</span>
<span class="nc bnc" id="L2197" title="All 12 branches missed.">        return ((originalStatus == PostStatus.DRAFT || originalStatus == PostStatus.UNKNOWN) &amp;&amp; publishPost)</span>
               || (originalStatus == PostStatus.SCHEDULED &amp;&amp; publishPost)
<span class="nc bnc" id="L2199" title="All 4 branches missed.">               || (originalStatus == PostStatus.PUBLISHED &amp;&amp; mEditPostRepository.isLocalDraft())</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">               || (originalStatus == PostStatus.PUBLISHED &amp;&amp; mEditPostRepository.getRemotePostId() == 0);</span>
    }

    /**
     * Can be dropped and replaced by mEditorFragment.hasFailedMediaUploads() when we drop the visual editor.
     * mEditorFragment.isActionInProgress() was added to address a timing issue when adding media and immediately
     * publishing or exiting the visual editor. It's not safe to upload the post in this state.
     * See https://github.com/wordpress-mobile/WordPress-Editor-Android/issues/294
     */
    private boolean hasFailedMedia() {
<span class="nc bnc" id="L2210" title="All 4 branches missed.">        return mEditorFragment.hasFailedMediaUploads() || mEditorFragment.isActionInProgress();</span>
    }

    /**
     * A {@link FragmentPagerAdapter} that returns a fragment corresponding to
     * one of the sections/tabs/pages.
     */
    public class SectionsPagerAdapter extends FragmentPagerAdapter {
        private static final int NUM_PAGES_EDITOR = 4;
<span class="nc" id="L2219">        SectionsPagerAdapter(FragmentManager fm) {</span>
<span class="nc" id="L2220">            super(fm, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT);</span>
<span class="nc" id="L2221">        }</span>

        @Override
        public Fragment getItem(int position) {
            // getItem is called to instantiate the fragment for the given page.
<span class="nc bnc" id="L2226" title="All 5 branches missed.">            switch (position) {</span>
                case PAGE_CONTENT:
<span class="nc bnc" id="L2228" title="All 2 branches missed.">                    if (mShowGutenbergEditor) {</span>
                        // Enable gutenberg on the site &amp; show the informative popup upon opening
                        // the GB editor the first time when the remote setting value is still null
<span class="nc" id="L2231">                        setGutenbergEnabledIfNeeded();</span>
<span class="nc" id="L2232">                        mXpostsCapabilityChecker.retrieveCapability(mSite,</span>
<span class="nc" id="L2233">                                EditPostActivity.this::onXpostsSettingsCapability);</span>

<span class="nc bnc" id="L2235" title="All 6 branches missed.">                        boolean isWpCom = getSite().isWPCom() || mSite.isPrivateWPComAtomic() || mSite.isWPComAtomic();</span>
<span class="nc" id="L2236">                        GutenbergPropsBuilder gutenbergPropsBuilder = getGutenbergPropsBuilder();</span>

<span class="nc" id="L2238">                        GutenbergWebViewAuthorizationData gutenbergWebViewAuthorizationData =</span>
                                new GutenbergWebViewAuthorizationData(
<span class="nc" id="L2240">                                        mSite.getUrl(),</span>
                                        isWpCom,
<span class="nc" id="L2242">                                        mAccountStore.getAccount().getUserId(),</span>
<span class="nc" id="L2243">                                        mAccountStore.getAccount().getUserName(),</span>
<span class="nc" id="L2244">                                        mAccountStore.getAccessToken(),</span>
<span class="nc" id="L2245">                                        mSite.getSelfHostedSiteId(),</span>
<span class="nc" id="L2246">                                        mSite.getUsername(),</span>
<span class="nc" id="L2247">                                        mSite.getPassword(),</span>
<span class="nc" id="L2248">                                        mSite.isUsingWpComRestApi(),</span>
<span class="nc" id="L2249">                                        mSite.getWebEditor(),</span>
<span class="nc" id="L2250">                                        WordPress.getUserAgent(),</span>
<span class="nc" id="L2251">                                        mIsJetpackSsoEnabled);</span>

<span class="nc" id="L2253">                        return GutenbergEditorFragment.newInstance(</span>
                                &quot;&quot;,
                                &quot;&quot;,
<span class="nc" id="L2256">                                mIsNewPost,</span>
                                gutenbergWebViewAuthorizationData,
                                gutenbergPropsBuilder,
                                RequestCodes.EDIT_STORY
                        );
                    } else {
                        // If gutenberg editor is not selected, default to Aztec.
<span class="nc" id="L2263">                        return AztecEditorFragment.newInstance(&quot;&quot;, &quot;&quot;, AppPrefs.isAztecEditorToolbarExpanded());</span>
                    }
                case PAGE_SETTINGS:
<span class="nc" id="L2266">                    return EditPostSettingsFragment.newInstance();</span>
                case PAGE_PUBLISH_SETTINGS:
<span class="nc" id="L2268">                    return EditPostPublishSettingsFragment.Companion.newInstance();</span>
                case PAGE_HISTORY:
<span class="nc" id="L2270">                    return HistoryListFragment.Companion.newInstance(mEditPostRepository.getId(), mSite);</span>
                default:
<span class="nc" id="L2272">                    throw new IllegalArgumentException(&quot;Unexpected page type&quot;);</span>
            }
        }

        @Override
        public @NotNull Object instantiateItem(@NotNull ViewGroup container, int position) {
<span class="nc" id="L2278">            Fragment fragment = (Fragment) super.instantiateItem(container, position);</span>
<span class="nc bnc" id="L2279" title="All 3 branches missed.">            switch (position) {</span>
                case PAGE_CONTENT:
<span class="nc" id="L2281">                    mEditorFragment = (EditorFragmentAbstract) fragment;</span>
<span class="nc" id="L2282">                    mEditorFragment.setImageLoader(mImageLoader);</span>

<span class="nc" id="L2284">                    mEditorFragment.getTitleOrContentChanged().observe(EditPostActivity.this, editable -&gt; {</span>
<span class="nc" id="L2285">                        mViewModel.savePostWithDelay();</span>
<span class="nc" id="L2286">                    });</span>

<span class="nc bnc" id="L2288" title="All 2 branches missed.">                    if (mEditorFragment instanceof EditorMediaUploadListener) {</span>
<span class="nc" id="L2289">                        mEditorMediaUploadListener = (EditorMediaUploadListener) mEditorFragment;</span>

                        // Set up custom headers for the visual editor's internal WebView
<span class="nc" id="L2292">                        mEditorFragment.setCustomHttpHeader(&quot;User-Agent&quot;, WordPress.getUserAgent());</span>

<span class="nc" id="L2294">                        reattachUploadingMediaForAztec();</span>
                    }

<span class="nc bnc" id="L2297" title="All 2 branches missed.">                    if (mEditorFragment instanceof StorySaveMediaListener) {</span>
<span class="nc" id="L2298">                        mStoriesEventListener.setSaveMediaListener((StorySaveMediaListener) mEditorFragment);</span>
                    }
                    break;
                case PAGE_SETTINGS:
<span class="nc" id="L2302">                    mEditPostSettingsFragment = (EditPostSettingsFragment) fragment;</span>
                    break;
            }
<span class="nc" id="L2305">            return fragment;</span>
        }

        @Override
        public int getCount() {
<span class="nc" id="L2310">            return NUM_PAGES_EDITOR;</span>
        }
    }

    private void onXpostsSettingsCapability(boolean isXpostsCapable) {
<span class="nc" id="L2315">        mIsXPostsCapable = isXpostsCapable;</span>
<span class="nc bnc" id="L2316" title="All 2 branches missed.">        if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L2317">            ((GutenbergEditorFragment) mEditorFragment).updateCapabilities(getGutenbergPropsBuilder());</span>
        }
<span class="nc" id="L2319">    }</span>

    private GutenbergPropsBuilder getGutenbergPropsBuilder() {
<span class="nc bnc" id="L2322" title="All 2 branches missed.">        String postType = mIsPage ? &quot;page&quot; : &quot;post&quot;;</span>
<span class="nc" id="L2323">        int featuredImageId = (int) mEditPostRepository.getFeaturedImageId();</span>
<span class="nc" id="L2324">        String languageString = LocaleManager.getLanguage(EditPostActivity.this);</span>
<span class="nc" id="L2325">        String wpcomLocaleSlug = languageString.replace(&quot;_&quot;, &quot;-&quot;).toLowerCase(Locale.ENGLISH);</span>

        // this.mIsXPostsCapable may return true for non-WP.com sites, but the app only supports xPosts for P2-based
        // WP.com sites so, gate with `isUsingWpComRestApi()`
        // If this.mIsXPostsCapable has not been set, default to allowing xPosts.
<span class="nc bnc" id="L2330" title="All 6 branches missed.">        boolean enableXPosts = mSite.isUsingWpComRestApi() &amp;&amp; (mIsXPostsCapable == null || mIsXPostsCapable);</span>

<span class="nc" id="L2332">        EditorTheme editorTheme = mEditorThemeStore.getEditorThemeForSite(mSite);</span>
<span class="nc bnc" id="L2333" title="All 2 branches missed.">        Bundle themeBundle = (editorTheme != null) ? editorTheme.getThemeSupport().toBundle() : null;</span>

<span class="nc" id="L2335">        boolean isUnsupportedBlockEditorEnabled =</span>
<span class="nc bnc" id="L2336" title="All 4 branches missed.">                mSite.isWPCom() || mIsJetpackSsoEnabled;</span>

<span class="nc bnc" id="L2338" title="All 4 branches missed.">        boolean unsupportedBlockEditorSwitch = mSite.isJetpackConnected() &amp;&amp; !mIsJetpackSsoEnabled;</span>

<span class="nc bnc" id="L2340" title="All 4 branches missed.">        boolean isFreeWPCom = mSite.isWPCom() &amp;&amp; SiteUtils.onFreePlan(mSite);</span>
<span class="nc bnc" id="L2341" title="All 4 branches missed.">        boolean isWPComSite = mSite.isWPCom() || mSite.isWPComAtomic();</span>

<span class="nc" id="L2343">        return new GutenbergPropsBuilder(</span>
<span class="nc" id="L2344">                SiteUtils.supportsContactInfoFeature(mSite),</span>
<span class="nc" id="L2345">                SiteUtils.supportsLayoutGridFeature(mSite),</span>
<span class="nc" id="L2346">                SiteUtils.supportsTiledGalleryFeature(mSite),</span>
<span class="nc" id="L2347">                SiteUtils.supportsEmbedVariationFeature(mSite, SiteUtils.WP_FACEBOOK_EMBED_JETPACK_VERSION),</span>
<span class="nc" id="L2348">                SiteUtils.supportsEmbedVariationFeature(mSite, SiteUtils.WP_INSTAGRAM_EMBED_JETPACK_VERSION),</span>
<span class="nc" id="L2349">                SiteUtils.supportsEmbedVariationFeature(mSite, SiteUtils.WP_LOOM_EMBED_JETPACK_VERSION),</span>
<span class="nc" id="L2350">                SiteUtils.supportsEmbedVariationFeature(mSite, SiteUtils.WP_SMARTFRAME_EMBED_JETPACK_VERSION),</span>
<span class="nc" id="L2351">                SiteUtils.supportsStoriesFeature(mSite),</span>
<span class="nc bnc" id="L2352" title="All 2 branches missed.">                mSite.isUsingWpComRestApi(),</span>
                enableXPosts,
                isUnsupportedBlockEditorEnabled,
                unsupportedBlockEditorSwitch,
                !isFreeWPCom,
                isWPComSite,
                wpcomLocaleSlug,
                postType,
                featuredImageId,
                themeBundle
        );
    }

    /**
     * Checks if the theme supports the new gallery block with image blocks.
     * Note that if the editor theme has not been initialized (usually on the first app run)
     * the value returned is null and the `unstable_gallery_with_image_blocks` analytics property will not be reported.
     * @return true if the the supports the new gallery block with image blocks or null if the theme is not initialized.
     */
    private Boolean themeSupportsGalleryWithImageBlocks() {
<span class="nc" id="L2372">        EditorTheme editorTheme = mEditorThemeStore.getEditorThemeForSite(mSite);</span>
<span class="nc bnc" id="L2373" title="All 2 branches missed.">        if (editorTheme == null) {</span>
<span class="nc" id="L2374">            return null;</span>
        }
<span class="nc" id="L2376">        return editorTheme.getThemeSupport().getGalleryWithImageBlocks();</span>
    }

    // Moved from EditPostContentFragment
    public static final String NEW_MEDIA_POST = &quot;NEW_MEDIA_POST&quot;;
    public static final String NEW_MEDIA_POST_EXTRA_IDS = &quot;NEW_MEDIA_POST_EXTRA_IDS&quot;;
<span class="nc" id="L2382">    private String mMediaCapturePath = &quot;&quot;;</span>

    private String getUploadErrorHtml(String mediaId, String path) {
<span class="nc" id="L2385">        return String.format(Locale.US,</span>
                &quot;&lt;span id=\&quot;img_container_%s\&quot; class=\&quot;img_container failed\&quot; data-failed=\&quot;%s\&quot;&gt;&quot;
                + &quot;&lt;progress id=\&quot;progress_%s\&quot; value=\&quot;0\&quot; class=\&quot;wp_media_indicator failed\&quot; &quot;
                + &quot;contenteditable=\&quot;false\&quot;&gt;&lt;/progress&gt;&quot;
                + &quot;&lt;img data-wpid=\&quot;%s\&quot; src=\&quot;%s\&quot; alt=\&quot;\&quot; class=\&quot;failed\&quot;&gt;&lt;/span&gt;&quot;,
<span class="nc" id="L2390">                mediaId, getString(R.string.tap_to_try_again), mediaId, mediaId, path);</span>
    }

    private String migrateLegacyDraft(String content) {
<span class="nc bnc" id="L2394" title="All 2 branches missed.">        if (content.contains(&quot;&lt;img src=\&quot;null\&quot; android-uri=\&quot;&quot;)) {</span>
            // We must replace image tags specific to the legacy editor local drafts:
            // &lt;img src=&quot;null&quot; android-uri=&quot;file:///...&quot; /&gt;
            // And trigger an upload action for the specific image / video
<span class="nc" id="L2398">            Pattern pattern = Pattern.compile(&quot;&lt;img src=\&quot;null\&quot; android-uri=\&quot;([^\&quot;]*)\&quot;.*&gt;&quot;);</span>
<span class="nc" id="L2399">            Matcher matcher = pattern.matcher(content);</span>
<span class="nc" id="L2400">            StringBuffer stringBuffer = new StringBuffer();</span>
<span class="nc bnc" id="L2401" title="All 2 branches missed.">            while (matcher.find()) {</span>
<span class="nc" id="L2402">                String stringUri = matcher.group(1);</span>
<span class="nc" id="L2403">                Uri uri = Uri.parse(stringUri);</span>
<span class="nc" id="L2404">                MediaFile mediaFile = FluxCUtils.mediaFileFromMediaModel(mEditorMedia</span>
<span class="nc" id="L2405">                        .updateMediaUploadStateBlocking(uri, MediaUploadState.FAILED));</span>
<span class="nc bnc" id="L2406" title="All 2 branches missed.">                if (mediaFile == null) {</span>
<span class="nc" id="L2407">                    continue;</span>
                }
<span class="nc" id="L2409">                String replacement = getUploadErrorHtml(String.valueOf(mediaFile.getId()), mediaFile.getFilePath());</span>
<span class="nc" id="L2410">                matcher.appendReplacement(stringBuffer, replacement);</span>
<span class="nc" id="L2411">            }</span>
<span class="nc" id="L2412">            matcher.appendTail(stringBuffer);</span>
<span class="nc" id="L2413">            content = stringBuffer.toString();</span>
        }
<span class="nc bnc" id="L2415" title="All 2 branches missed.">        if (content.contains(&quot;[caption&quot;)) {</span>
            // Convert old legacy post caption formatting to new format, to avoid being stripped by the visual editor
<span class="nc" id="L2417">            Pattern pattern = Pattern.compile(&quot;(\\[caption[^]]*caption=\&quot;([^\&quot;]*)\&quot;[^]]*].+?)(\\[\\/caption])&quot;);</span>
<span class="nc" id="L2418">            Matcher matcher = pattern.matcher(content);</span>
<span class="nc" id="L2419">            StringBuffer stringBuffer = new StringBuffer();</span>
<span class="nc bnc" id="L2420" title="All 2 branches missed.">            while (matcher.find()) {</span>
<span class="nc" id="L2421">                String replacement = matcher.group(1) + matcher.group(2) + matcher.group(3);</span>
<span class="nc" id="L2422">                matcher.appendReplacement(stringBuffer, replacement);</span>
<span class="nc" id="L2423">            }</span>
<span class="nc" id="L2424">            matcher.appendTail(stringBuffer);</span>
<span class="nc" id="L2425">            content = stringBuffer.toString();</span>
        }
<span class="nc" id="L2427">        return content;</span>
    }

    private String migrateToGutenbergEditor(String content) {
<span class="nc" id="L2431">        return &quot;&lt;!-- wp:paragraph --&gt;&lt;p&gt;&quot; + content + &quot;&lt;/p&gt;&lt;!-- /wp:paragraph --&gt;&quot;;</span>
    }

    private void fillContentEditorFields() {
        // Needed blog settings needed by the editor
<span class="nc" id="L2436">        mEditorFragment.setFeaturedImageSupported(mSite.isFeaturedImageSupported());</span>

        // Special actions - these only make sense for empty posts that are going to be populated now
<span class="nc bnc" id="L2439" title="All 2 branches missed.">        if (TextUtils.isEmpty(mEditPostRepository.getContent())) {</span>
<span class="nc" id="L2440">            String action = getIntent().getAction();</span>
<span class="nc bnc" id="L2441" title="All 2 branches missed.">            if (Intent.ACTION_SEND_MULTIPLE.equals(action)) {</span>
<span class="nc" id="L2442">                setPostContentFromShareAction();</span>
<span class="nc bnc" id="L2443" title="All 2 branches missed.">            } else if (NEW_MEDIA_POST.equals(action)) {</span>
<span class="nc" id="L2444">                mEditorMedia.addExistingMediaToEditorAsync(AddExistingMediaSource.WP_MEDIA_LIBRARY,</span>
<span class="nc" id="L2445">                        getIntent().getLongArrayExtra(NEW_MEDIA_POST_EXTRA_IDS));</span>
            }
        }

<span class="nc bnc" id="L2449" title="All 2 branches missed.">        if (mIsPage) {</span>
<span class="nc" id="L2450">            setPageContent();</span>
        }

        // Set post title and content
<span class="nc bnc" id="L2454" title="All 2 branches missed.">        if (mEditPostRepository.hasPost()) {</span>
            // don't avoid calling setContent() for GutenbergEditorFragment so RN gets initialized
<span class="nc bnc" id="L2456" title="All 6 branches missed.">            if ((!TextUtils.isEmpty(mEditPostRepository.getContent())</span>
                 || mEditorFragment instanceof GutenbergEditorFragment)
                &amp;&amp; !mHasSetPostContent) {
<span class="nc" id="L2459">                mHasSetPostContent = true;</span>
                // TODO: Might be able to drop .replaceAll() when legacy editor is removed
<span class="nc" id="L2461">                String content = mEditPostRepository.getContent().replaceAll(&quot;\uFFFC&quot;, &quot;&quot;);</span>
                // Prepare eventual legacy editor local draft for the new editor
<span class="nc" id="L2463">                content = migrateLegacyDraft(content);</span>
<span class="nc" id="L2464">                mEditorFragment.setContent(content);</span>
            }
<span class="nc bnc" id="L2466" title="All 2 branches missed.">            if (!TextUtils.isEmpty(mEditPostRepository.getTitle())) {</span>
<span class="nc" id="L2467">                mEditorFragment.setTitle(mEditPostRepository.getTitle());</span>
<span class="nc bnc" id="L2468" title="All 2 branches missed.">            } else if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
                // don't avoid calling setTitle() for GutenbergEditorFragment so RN gets initialized
<span class="nc" id="L2470">                final String title = getIntent().getStringExtra(EXTRA_PAGE_TITLE);</span>
<span class="nc bnc" id="L2471" title="All 2 branches missed.">                if (title != null) {</span>
<span class="nc" id="L2472">                    mEditorFragment.setTitle(title);</span>
                } else {
<span class="nc" id="L2474">                    mEditorFragment.setTitle(&quot;&quot;);</span>
                }
            }

            // TODO: postSettingsButton.setText(post.isPage() ? R.string.page_settings : R.string.post_settings);
<span class="nc" id="L2479">            mEditorFragment.setFeaturedImageId(mEditPostRepository.getFeaturedImageId());</span>
        }
<span class="nc" id="L2481">    }</span>

    private void launchCamera() {
<span class="nc" id="L2484">        WPMediaUtils.launchCamera(this, BuildConfig.APPLICATION_ID,</span>
<span class="nc" id="L2485">                mediaCapturePath -&gt; mMediaCapturePath = mediaCapturePath);</span>
<span class="nc" id="L2486">    }</span>

    protected void setPostContentFromShareAction() {
<span class="nc" id="L2489">        Intent intent = getIntent();</span>

        // Check for shared text
<span class="nc" id="L2492">        final String text = intent.getStringExtra(Intent.EXTRA_TEXT);</span>
<span class="nc" id="L2493">        final String title = intent.getStringExtra(Intent.EXTRA_SUBJECT);</span>
<span class="nc bnc" id="L2494" title="All 2 branches missed.">        if (text != null) {</span>
<span class="nc" id="L2495">            mHasSetPostContent = true;</span>
<span class="nc" id="L2496">            mEditPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc bnc" id="L2497" title="All 2 branches missed.">                if (title != null) {</span>
<span class="nc" id="L2498">                    postModel.setTitle(title);</span>
                }
                // Create an &lt;a href&gt; element around links
<span class="nc" id="L2501">                String updatedContent = AutolinkUtils.autoCreateLinks(text);</span>

                // If editor is Gutenberg, add Gutenberg block around content
<span class="nc bnc" id="L2504" title="All 2 branches missed.">                if (mShowGutenbergEditor) {</span>
<span class="nc" id="L2505">                    updatedContent = migrateToGutenbergEditor(updatedContent);</span>
                }

                // update PostModel
<span class="nc" id="L2509">                postModel.setContent(updatedContent);</span>
<span class="nc" id="L2510">                mEditPostRepository.updatePublishDateIfShouldBePublishedImmediately(postModel);</span>
<span class="nc" id="L2511">                return true;</span>
            }, (postModel, result) -&gt; {
<span class="nc bnc" id="L2513" title="All 2 branches missed.">                if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L2514">                    mEditorFragment.setTitle(postModel.getTitle());</span>
<span class="nc" id="L2515">                    mEditorFragment.setContent(postModel.getContent());</span>
                }
<span class="nc" id="L2517">                return null;</span>
            });
        }
<span class="nc" id="L2520">        setPostMediaFromShareAction();</span>
<span class="nc" id="L2521">    }</span>

    private void setPostMediaFromShareAction() {
<span class="nc" id="L2524">        Intent intent = getIntent();</span>

        // Check for shared media
<span class="nc bnc" id="L2527" title="All 2 branches missed.">        if (intent.hasExtra(Intent.EXTRA_STREAM)) {</span>
<span class="nc" id="L2528">            String action = intent.getAction();</span>
            ArrayList&lt;Uri&gt; sharedUris;

<span class="nc bnc" id="L2531" title="All 2 branches missed.">            if (Intent.ACTION_SEND_MULTIPLE.equals(action)) {</span>
<span class="nc" id="L2532">                sharedUris = intent.getParcelableArrayListExtra((Intent.EXTRA_STREAM));</span>
            } else {
                // For a single media share, we only allow images and video types
<span class="nc bnc" id="L2535" title="All 2 branches missed.">                if (isMediaTypeIntent(intent)) {</span>
<span class="nc" id="L2536">                    sharedUris = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2537">                    sharedUris.add(intent.getParcelableExtra(Intent.EXTRA_STREAM));</span>
                } else {
<span class="nc" id="L2539">                    sharedUris = null;</span>
                }
            }

<span class="nc bnc" id="L2543" title="All 2 branches missed.">            if (sharedUris != null) {</span>
                // removing this from the intent so it doesn't insert the media items again on each Activity re-creation
<span class="nc" id="L2545">                getIntent().removeExtra(Intent.EXTRA_STREAM);</span>
<span class="nc" id="L2546">                mEditorMedia.addNewMediaItemsToEditorAsync(sharedUris, false);</span>
            }
        }
<span class="nc" id="L2549">    }</span>

    private boolean isMediaTypeIntent(Intent intent) {
<span class="nc" id="L2552">        String type = intent.getType();</span>
<span class="nc bnc" id="L2553" title="All 6 branches missed.">        return type != null &amp;&amp; (type.startsWith(&quot;image&quot;) || type.startsWith(&quot;video&quot;));</span>
    }

    private void setFeaturedImageId(final long mediaId, final boolean imagePicked, final boolean isGutenbergEditor) {
<span class="nc bnc" id="L2557" title="All 2 branches missed.">        if (isGutenbergEditor) {</span>
<span class="nc" id="L2558">            EditPostRepository postRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L2559" title="All 2 branches missed.">            if (postRepository == null) {</span>
<span class="nc" id="L2560">                return;</span>
            }

<span class="nc" id="L2563">            int postId = getEditPostRepository().getId();</span>
<span class="nc bnc" id="L2564" title="All 2 branches missed.">            if (mediaId == MEDIA_ID_NO_FEATURED_IMAGE_SET) {</span>
<span class="nc" id="L2565">                mFeaturedImageHelper.trackFeaturedImageEvent(</span>
                        FeaturedImageHelper.TrackableEvent.IMAGE_REMOVED_GUTENBERG_EDITOR,
                        postId
                );
            } else {
<span class="nc" id="L2570">                mFeaturedImageHelper.trackFeaturedImageEvent(</span>
                        FeaturedImageHelper.TrackableEvent.IMAGE_PICKED_GUTENBERG_EDITOR,
                        postId
                );
            }
<span class="nc" id="L2575">            mUpdateFeaturedImageUseCase.updateFeaturedImage(mediaId, postRepository,</span>
<span class="nc" id="L2576">                    postModel -&gt; null);</span>
<span class="nc bnc" id="L2577" title="All 2 branches missed.">        } else if (mEditPostSettingsFragment != null) {</span>
<span class="nc" id="L2578">            mEditPostSettingsFragment.updateFeaturedImage(mediaId, imagePicked);</span>
        }
<span class="nc bnc" id="L2580" title="All 2 branches missed.">        if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L2581">            ((GutenbergEditorFragment) mEditorFragment).sendToJSFeaturedImageId((int) mediaId);</span>
        }
<span class="nc" id="L2583">    }</span>

    /**
     * Sets the page content
     */
    private void setPageContent() {
<span class="nc" id="L2589">        Intent intent = getIntent();</span>
<span class="nc" id="L2590">        final String content = intent.getStringExtra(EXTRA_PAGE_CONTENT);</span>
<span class="nc bnc" id="L2591" title="All 4 branches missed.">        if (content != null &amp;&amp; !content.isEmpty()) {</span>
<span class="nc" id="L2592">            mHasSetPostContent = true;</span>
<span class="nc" id="L2593">            mEditPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L2594">                postModel.setContent(content);</span>
<span class="nc" id="L2595">                mEditPostRepository.updatePublishDateIfShouldBePublishedImmediately(postModel);</span>
<span class="nc" id="L2596">                return true;</span>
            }, (postModel, result) -&gt; {
<span class="nc bnc" id="L2598" title="All 2 branches missed.">                if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L2599">                    mEditorFragment.setContent(postModel.getContent());</span>
                }
<span class="nc" id="L2601">                return null;</span>
            });
        }
<span class="nc" id="L2604">    }</span>

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L2608">        super.onActivityResult(requestCode, resultCode, data);</span>

        // In case of Remote Preview we need to change state even if (resultCode != Activity.RESULT_OK)
        // so placing this here before the check
<span class="nc bnc" id="L2612" title="All 2 branches missed.">        if (requestCode == RequestCodes.REMOTE_PREVIEW_POST) {</span>
<span class="nc" id="L2613">            updatePostLoadingAndDialogState(PostLoadingState.NONE);</span>
<span class="nc" id="L2614">            return;</span>
        }

<span class="nc bnc" id="L2617" title="All 2 branches missed.">        if (resultCode != Activity.RESULT_OK) {</span>
            // for all media related intents, let editor fragment know about cancellation
<span class="nc bnc" id="L2619" title="All 3 branches missed.">            switch (requestCode) {</span>
                case RequestCodes.MULTI_SELECT_MEDIA_PICKER:
                case RequestCodes.SINGLE_SELECT_MEDIA_PICKER:
                case RequestCodes.PHOTO_PICKER:
                case RequestCodes.STORIES_PHOTO_PICKER:
                case RequestCodes.STOCK_MEDIA_PICKER_SINGLE_SELECT:
                case RequestCodes.MEDIA_LIBRARY:
                case RequestCodes.PICTURE_LIBRARY:
                case RequestCodes.TAKE_PHOTO:
                case RequestCodes.VIDEO_LIBRARY:
                case RequestCodes.TAKE_VIDEO:
                case RequestCodes.STOCK_MEDIA_PICKER_MULTI_SELECT:
                case RequestCodes.STOCK_MEDIA_PICKER_SINGLE_SELECT_FOR_GUTENBERG_BLOCK:
<span class="nc" id="L2632">                    mEditorFragment.mediaSelectionCancelled();</span>
<span class="nc" id="L2633">                    return;</span>
                case RequestCodes.EDIT_STORY:
<span class="nc" id="L2635">                    mStoryEditingCancelled = true;</span>
<span class="nc" id="L2636">                    return;</span>
                default:
                    // noop
<span class="nc" id="L2639">                    return;</span>
            }
        }

<span class="nc bnc" id="L2643" title="All 2 branches missed.">        if (requestCode == RequestCodes.EDIT_STORY) {</span>
<span class="nc" id="L2644">            mStoryEditingCancelled = false;</span>
<span class="nc bnc" id="L2645" title="All 2 branches missed.">            if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L2646">                mEditorFragment.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc" id="L2647">                return;</span>
            }
        }

<span class="nc bnc" id="L2651" title="All 8 branches missed.">        if (data != null || ((requestCode == RequestCodes.TAKE_PHOTO || requestCode == RequestCodes.TAKE_VIDEO</span>
                              || requestCode == RequestCodes.PHOTO_PICKER))) {
<span class="nc bnc" id="L2653" title="All 15 branches missed.">            switch (requestCode) {</span>
                case RequestCodes.MULTI_SELECT_MEDIA_PICKER:
                case RequestCodes.SINGLE_SELECT_MEDIA_PICKER:
<span class="nc" id="L2656">                    handleMediaPickerResult(data);</span>
                    // No need to bump analytics here. Bumped later in
                    // handleMediaPickerResult -&gt; addExistingMediaToEditorAndSave
<span class="nc" id="L2659">                    break;</span>
                case RequestCodes.PHOTO_PICKER:
                case RequestCodes.STOCK_MEDIA_PICKER_SINGLE_SELECT:
                    // user chose a featured image
<span class="nc bnc" id="L2663" title="All 2 branches missed.">                    if (data.hasExtra(MediaPickerConstants.EXTRA_MEDIA_ID)) {</span>
<span class="nc" id="L2664">                        long mediaId = data.getLongExtra(MediaPickerConstants.EXTRA_MEDIA_ID, 0);</span>
<span class="nc" id="L2665">                        setFeaturedImageId(mediaId, true, false);</span>
<span class="nc bnc" id="L2666" title="All 2 branches missed.">                    } else if (data.hasExtra(MediaPickerConstants.EXTRA_MEDIA_QUEUED_URIS)) {</span>
<span class="nc" id="L2667">                        List&lt;Uri&gt; uris = convertStringArrayIntoUrisList(</span>
<span class="nc" id="L2668">                                data.getStringArrayExtra(MediaPickerConstants.EXTRA_MEDIA_QUEUED_URIS));</span>
<span class="nc" id="L2669">                        int postId = getImmutablePost().getId();</span>
<span class="nc" id="L2670">                        mFeaturedImageHelper.trackFeaturedImageEvent(</span>
                                FeaturedImageHelper.TrackableEvent.IMAGE_PICKED_POST_SETTINGS,
                                postId
                        );
<span class="nc bnc" id="L2674" title="All 2 branches missed.">                        for (Uri mediaUri : uris) {</span>
<span class="nc" id="L2675">                            String mimeType = getContentResolver().getType(mediaUri);</span>
<span class="nc" id="L2676">                            EnqueueFeaturedImageResult queueImageResult = mFeaturedImageHelper</span>
<span class="nc" id="L2677">                                    .queueFeaturedImageForUpload(</span>
<span class="nc" id="L2678">                                            postId, getSite(), mediaUri,</span>
                                            mimeType
                                    );
<span class="nc bnc" id="L2681" title="All 2 branches missed.">                            if (queueImageResult == EnqueueFeaturedImageResult.FILE_NOT_FOUND) {</span>
<span class="nc" id="L2682">                                Toast.makeText(</span>
                                        this,
                                        R.string.file_not_found, Toast.LENGTH_SHORT
<span class="nc" id="L2685">                                ).show();</span>
<span class="nc bnc" id="L2686" title="All 2 branches missed.">                            } else if (queueImageResult == EnqueueFeaturedImageResult.INVALID_POST_ID) {</span>
<span class="nc" id="L2687">                                Toast.makeText(</span>
                                        this,
                                        R.string.error_generic, Toast.LENGTH_SHORT
<span class="nc" id="L2690">                                ).show();</span>
                            }
<span class="nc" id="L2692">                        }</span>
<span class="nc bnc" id="L2693" title="All 2 branches missed.">                        if (mEditPostSettingsFragment != null) {</span>
<span class="nc" id="L2694">                            mEditPostSettingsFragment.refreshViews();</span>
                        }
<span class="nc bnc" id="L2696" title="All 2 branches missed.">                    } else if (data.hasExtra(MediaPickerConstants.EXTRA_MEDIA_URIS)) {</span>
<span class="nc" id="L2697">                        List&lt;Uri&gt; uris = convertStringArrayIntoUrisList(</span>
<span class="nc" id="L2698">                                data.getStringArrayExtra(MediaPickerConstants.EXTRA_MEDIA_URIS));</span>
<span class="nc" id="L2699">                        mEditorMedia.addNewMediaItemsToEditorAsync(uris, false);</span>
<span class="nc bnc" id="L2700" title="All 2 branches missed.">                    } else if (data.hasExtra(MediaPickerConstants.EXTRA_SAVED_MEDIA_MODEL_LOCAL_IDS)) {</span>
<span class="nc" id="L2701">                        int[] localIds = data.getIntArrayExtra(MediaPickerConstants.EXTRA_SAVED_MEDIA_MODEL_LOCAL_IDS);</span>
<span class="nc" id="L2702">                        int postId = getImmutablePost().getId();</span>
<span class="nc bnc" id="L2703" title="All 2 branches missed.">                        for (int localId : localIds) {</span>
<span class="nc" id="L2704">                            MediaModel media = mMediaStore.getMediaWithLocalId(localId);</span>
<span class="nc" id="L2705">                            mFeaturedImageHelper.queueFeaturedImageForUpload(postId, media);</span>
                        }
<span class="nc bnc" id="L2707" title="All 2 branches missed.">                        if (mEditPostSettingsFragment != null) {</span>
<span class="nc" id="L2708">                            mEditPostSettingsFragment.refreshViews();</span>
                        }
<span class="nc" id="L2710">                    }</span>
                    break;
                case RequestCodes.STOCK_MEDIA_PICKER_SINGLE_SELECT_FOR_GUTENBERG_BLOCK:
<span class="nc bnc" id="L2713" title="All 2 branches missed.">                    if (data.hasExtra(MediaPickerConstants.EXTRA_MEDIA_ID)) {</span>
                        // pass array with single item
<span class="nc" id="L2715">                        long[] mediaIds = {data.getLongExtra(MediaPickerConstants.EXTRA_MEDIA_ID, 0)};</span>
<span class="nc" id="L2716">                        mEditorMedia</span>
<span class="nc" id="L2717">                                .addExistingMediaToEditorAsync(AddExistingMediaSource.STOCK_PHOTO_LIBRARY, mediaIds);</span>
<span class="nc" id="L2718">                    }</span>
                    break;
                case RequestCodes.MEDIA_LIBRARY:
                case RequestCodes.PICTURE_LIBRARY:
<span class="nc" id="L2722">                    mEditorMedia.advertiseImageOptimisationAndAddMedia(WPMediaUtils.retrieveMediaUris(data));</span>
<span class="nc" id="L2723">                    break;</span>
                case RequestCodes.TAKE_PHOTO:
<span class="nc bnc" id="L2725" title="All 2 branches missed.">                    if (WPMediaUtils.shouldAdvertiseImageOptimization(this)) {</span>
<span class="nc" id="L2726">                        WPMediaUtils.advertiseImageOptimization(this, this::addLastTakenPicture);</span>
                    } else {
<span class="nc" id="L2728">                        addLastTakenPicture();</span>
                    }
<span class="nc" id="L2730">                    break;</span>
                case RequestCodes.VIDEO_LIBRARY:
<span class="nc" id="L2732">                    mEditorMedia.addNewMediaItemsToEditorAsync(WPMediaUtils.retrieveMediaUris(data), false);</span>
<span class="nc" id="L2733">                    break;</span>
                case RequestCodes.TAKE_VIDEO:
<span class="nc" id="L2735">                    mEditorMedia.addFreshlyTakenVideoToEditor();</span>
<span class="nc" id="L2736">                    break;</span>
                case RequestCodes.MEDIA_SETTINGS:
<span class="nc bnc" id="L2738" title="All 2 branches missed.">                    if (mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L2739">                        mEditorFragment.onActivityResult(AztecEditorFragment.EDITOR_MEDIA_SETTINGS,</span>
                                Activity.RESULT_OK, data);
                    }
                    break;
                case RequestCodes.STOCK_MEDIA_PICKER_MULTI_SELECT:
<span class="nc" id="L2744">                    String key = MediaBrowserActivity.RESULT_IDS;</span>
<span class="nc bnc" id="L2745" title="All 2 branches missed.">                    if (data.hasExtra(key)) {</span>
<span class="nc" id="L2746">                        long[] mediaIds = data.getLongArrayExtra(key);</span>
<span class="nc" id="L2747">                        mEditorMedia</span>
<span class="nc" id="L2748">                                .addExistingMediaToEditorAsync(AddExistingMediaSource.STOCK_PHOTO_LIBRARY, mediaIds);</span>
<span class="nc" id="L2749">                    }</span>
                    break;
                case RequestCodes.GIF_PICKER_SINGLE_SELECT:
                case RequestCodes.GIF_PICKER_MULTI_SELECT:
<span class="nc bnc" id="L2753" title="All 2 branches missed.">                    if (data.hasExtra(MediaPickerConstants.EXTRA_SAVED_MEDIA_MODEL_LOCAL_IDS)) {</span>
<span class="nc" id="L2754">                        int[] localIds = data.getIntArrayExtra(MediaPickerConstants.EXTRA_SAVED_MEDIA_MODEL_LOCAL_IDS);</span>
<span class="nc" id="L2755">                        mEditorMedia.addGifMediaToPostAsync(localIds);</span>
<span class="nc" id="L2756">                    }</span>
                    break;
                case RequestCodes.HISTORY_DETAIL:
<span class="nc bnc" id="L2759" title="All 2 branches missed.">                    if (data.hasExtra(KEY_REVISION)) {</span>
<span class="nc" id="L2760">                        mViewPager.setCurrentItem(PAGE_CONTENT);</span>

<span class="nc" id="L2762">                        mRevision = data.getParcelableExtra(KEY_REVISION);</span>
<span class="nc" id="L2763">                        new Handler().postDelayed(this::loadRevision,</span>
<span class="nc" id="L2764">                                getResources().getInteger(R.integer.full_screen_dialog_animation_duration));</span>
                    }
                    break;
                case RequestCodes.IMAGE_EDITOR_EDIT_IMAGE:
<span class="nc" id="L2768">                    List&lt;Uri&gt; uris = WPMediaUtils.retrieveImageEditorResult(data);</span>
<span class="nc" id="L2769">                    mImageEditorTracker.trackAddPhoto(uris);</span>
<span class="nc bnc" id="L2770" title="All 2 branches missed.">                    for (Uri item : uris) {</span>
<span class="nc" id="L2771">                        mEditorMedia.addNewMediaToEditorAsync(item, false);</span>
<span class="nc" id="L2772">                    }</span>
<span class="nc" id="L2773">                    break;</span>
                case RequestCodes.SELECTED_USER_MENTION:
<span class="nc bnc" id="L2775" title="All 2 branches missed.">                    if (mOnGetSuggestionResult != null) {</span>
<span class="nc" id="L2776">                        String selectedMention = data.getStringExtra(SuggestionActivity.SELECTED_VALUE);</span>
<span class="nc" id="L2777">                        mOnGetSuggestionResult.accept(selectedMention);</span>
                        // Clear the callback once we have gotten a result
<span class="nc" id="L2779">                        mOnGetSuggestionResult = null;</span>
<span class="nc" id="L2780">                    }</span>
                    break;
                case RequestCodes.FILE_LIBRARY:
                case RequestCodes.AUDIO_LIBRARY:
<span class="nc bnc" id="L2784" title="All 2 branches missed.">                    if (data.hasExtra(MediaPickerConstants.EXTRA_MEDIA_URIS)) {</span>
<span class="nc" id="L2785">                        List&lt;Uri&gt; uriResults = convertStringArrayIntoUrisList(</span>
<span class="nc" id="L2786">                                Objects.requireNonNull(</span>
<span class="nc" id="L2787">                                        data.getStringArrayExtra(MediaPickerConstants.EXTRA_MEDIA_URIS)));</span>
<span class="nc bnc" id="L2788" title="All 2 branches missed.">                        for (Uri uri : uriResults) {</span>
<span class="nc" id="L2789">                            mEditorMedia.addNewMediaToEditorAsync(uri, false);</span>
<span class="nc" id="L2790">                        }</span>
                    }
                    break;
            }
        }

<span class="nc bnc" id="L2796" title="All 2 branches missed.">        if (requestCode == JetpackSecuritySettingsActivity.JETPACK_SECURITY_SETTINGS_REQUEST_CODE) {</span>
<span class="nc" id="L2797">            fetchSiteSettings();</span>
        }
<span class="nc" id="L2799">    }</span>

    private List&lt;Uri&gt; convertStringArrayIntoUrisList(String[] stringArray) {
<span class="nc" id="L2802">        List&lt;Uri&gt; uris = new ArrayList&lt;&gt;(stringArray.length);</span>
<span class="nc bnc" id="L2803" title="All 2 branches missed.">        for (String stringUri : stringArray) {</span>
<span class="nc" id="L2804">            uris.add(Uri.parse(stringUri));</span>
        }
<span class="nc" id="L2806">        return uris;</span>
    }

    private void addLastTakenPicture() {
        try {
            // TODO why do we scan the file twice? Also how come it can result in OOM?
<span class="nc" id="L2812">            WPMediaUtils.scanMediaFile(this, mMediaCapturePath);</span>
<span class="nc" id="L2813">            File f = new File(mMediaCapturePath);</span>
<span class="nc" id="L2814">            Uri capturedImageUri = Uri.fromFile(f);</span>
<span class="nc bnc" id="L2815" title="All 2 branches missed.">            if (capturedImageUri != null) {</span>
<span class="nc" id="L2816">                mEditorMedia.addNewMediaToEditorAsync(capturedImageUri, true);</span>
<span class="nc" id="L2817">                final Intent scanIntent = new Intent(Intent.ACTION_MEDIA_SCANNER_SCAN_FILE);</span>
<span class="nc" id="L2818">                scanIntent.setData(capturedImageUri);</span>
<span class="nc" id="L2819">                sendBroadcast(scanIntent);</span>
<span class="nc" id="L2820">            } else {</span>
<span class="nc" id="L2821">                ToastUtils.showToast(this, R.string.gallery_error, Duration.SHORT);</span>
            }
<span class="nc" id="L2823">        } catch (RuntimeException | OutOfMemoryError e) {</span>
<span class="nc" id="L2824">            AppLog.e(T.EDITOR, e);</span>
<span class="nc" id="L2825">        }</span>
<span class="nc" id="L2826">    }</span>

    private void handleMediaPickerResult(Intent data) {
        // TODO move this to EditorMedia
<span class="nc" id="L2830">        ArrayList&lt;Long&gt; ids = ListUtils.fromLongArray(data.getLongArrayExtra(MediaBrowserActivity.RESULT_IDS));</span>
<span class="nc bnc" id="L2831" title="All 4 branches missed.">        if (ids == null || ids.size() == 0) {</span>
<span class="nc bnc" id="L2832" title="All 2 branches missed.">            if (data.hasExtra(MediaPickerConstants.EXTRA_MEDIA_ID)) {</span>
<span class="nc" id="L2833">                long mediaId = data.getLongExtra(MediaPickerConstants.EXTRA_MEDIA_ID, 0);</span>
<span class="nc" id="L2834">                ids = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2835">                ids.add(mediaId);</span>
<span class="nc" id="L2836">            } else {</span>
<span class="nc" id="L2837">                return;</span>
            }
        }

<span class="nc" id="L2841">        boolean allAreImages = true;</span>
<span class="nc bnc" id="L2842" title="All 2 branches missed.">        for (Long id : ids) {</span>
<span class="nc" id="L2843">            MediaModel media = mMediaStore.getSiteMediaWithId(mSite, id);</span>
<span class="nc bnc" id="L2844" title="All 4 branches missed.">            if (media != null &amp;&amp; !MediaUtils.isValidImage(media.getUrl())) {</span>
<span class="nc" id="L2845">                allAreImages = false;</span>
<span class="nc" id="L2846">                break;</span>
            }
<span class="nc" id="L2848">        }</span>

        // if the user selected multiple items and they're all images, show the insert media
        // dialog so the user can choose whether to insert them individually or as a gallery
<span class="nc bnc" id="L2852" title="All 6 branches missed.">        if (ids.size() &gt; 1 &amp;&amp; allAreImages &amp;&amp; !mShowGutenbergEditor) {</span>
<span class="nc" id="L2853">            showInsertMediaDialog(ids);</span>
        } else {
            // if allowMultipleSelection and gutenberg editor, pass all ids to addExistingMediaToEditor at once
<span class="nc" id="L2856">            mEditorMedia.addExistingMediaToEditorAsync(AddExistingMediaSource.WP_MEDIA_LIBRARY, ids);</span>
<span class="nc bnc" id="L2857" title="All 4 branches missed.">            if (mShowGutenbergEditor &amp;&amp; mEditorPhotoPicker.getAllowMultipleSelection()) {</span>
<span class="nc" id="L2858">                mEditorPhotoPicker.setAllowMultipleSelection(false);</span>
            }
        }
<span class="nc" id="L2861">    }</span>

    /*
     * called after user selects multiple photos from WP media library
     */
    private void showInsertMediaDialog(final ArrayList&lt;Long&gt; mediaIds) {
<span class="nc" id="L2867">        InsertMediaCallback callback = dialog -&gt; {</span>
<span class="nc bnc" id="L2868" title="All 3 branches missed.">            switch (dialog.getInsertType()) {</span>
                case GALLERY:
<span class="nc" id="L2870">                    MediaGallery gallery = new MediaGallery();</span>
<span class="nc" id="L2871">                    gallery.setType(dialog.getGalleryType().toString());</span>
<span class="nc" id="L2872">                    gallery.setNumColumns(dialog.getNumColumns());</span>
<span class="nc" id="L2873">                    gallery.setIds(mediaIds);</span>
<span class="nc" id="L2874">                    mEditorFragment.appendGallery(gallery);</span>
<span class="nc" id="L2875">                    break;</span>
                case INDIVIDUALLY:
<span class="nc" id="L2877">                    mEditorMedia.addExistingMediaToEditorAsync(AddExistingMediaSource.WP_MEDIA_LIBRARY, mediaIds);</span>
                    break;
            }
<span class="nc" id="L2880">        };</span>
<span class="nc" id="L2881">        InsertMediaDialog dialog = InsertMediaDialog.newInstance(callback, mSite);</span>
<span class="nc" id="L2882">        FragmentTransaction ft = getSupportFragmentManager().beginTransaction();</span>
<span class="nc" id="L2883">        ft.add(dialog, &quot;insert_media&quot;);</span>
<span class="nc" id="L2884">        ft.commitAllowingStateLoss();</span>
<span class="nc" id="L2885">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAccountChanged(OnAccountChanged event) {
<span class="nc bnc" id="L2890" title="All 2 branches missed.">        if (event.causeOfChange == AccountAction.SEND_VERIFICATION_EMAIL) {</span>
<span class="nc bnc" id="L2891" title="All 2 branches missed.">            if (!event.isError()) {</span>
<span class="nc" id="L2892">                ToastUtils.showToast(this, getString(R.string.toast_verification_email_sent));</span>
            } else {
<span class="nc" id="L2894">                ToastUtils.showToast(this, getString(R.string.toast_verification_email_send_error));</span>
            }
        }
<span class="nc" id="L2897">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onMediaChanged(OnMediaChanged event) {
<span class="nc bnc" id="L2902" title="All 2 branches missed.">        if (event.isError()) {</span>
            final String errorMessage;
<span class="nc bnc" id="L2904" title="All 5 branches missed.">            switch (event.error.type) {</span>
                case FS_READ_PERMISSION_DENIED:
<span class="nc" id="L2906">                    errorMessage = getString(R.string.error_media_insufficient_fs_permissions);</span>
<span class="nc" id="L2907">                    break;</span>
                case NOT_FOUND:
<span class="nc" id="L2909">                    errorMessage = getString(R.string.error_media_not_found);</span>
<span class="nc" id="L2910">                    break;</span>
                case AUTHORIZATION_REQUIRED:
<span class="nc" id="L2912">                    errorMessage = getString(R.string.error_media_unauthorized);</span>
<span class="nc" id="L2913">                    break;</span>
                case PARSE_ERROR:
<span class="nc" id="L2915">                    errorMessage = getString(R.string.error_media_parse_error);</span>
<span class="nc" id="L2916">                    break;</span>
                case MALFORMED_MEDIA_ARG:
                case NULL_MEDIA_ARG:
                case GENERIC_ERROR:
                default:
<span class="nc" id="L2921">                    errorMessage = getString(R.string.error_refresh_media);</span>
                    break;
            }
<span class="nc bnc" id="L2924" title="All 2 branches missed.">            if (!TextUtils.isEmpty(errorMessage)) {</span>
<span class="nc" id="L2925">                ToastUtils.showToast(EditPostActivity.this, errorMessage, ToastUtils.Duration.SHORT);</span>
            }
<span class="nc" id="L2927">        } else {</span>
<span class="nc bnc" id="L2928" title="All 4 branches missed.">            if (mPendingVideoPressInfoRequests != null &amp;&amp; !mPendingVideoPressInfoRequests.isEmpty()) {</span>
                // If there are pending requests for video URLs from VideoPress ids, query the DB for
                // them again and notify the editor
<span class="nc bnc" id="L2931" title="All 2 branches missed.">                for (String videoId : mPendingVideoPressInfoRequests) {</span>
<span class="nc" id="L2932">                    String videoUrl = mMediaStore.</span>
<span class="nc" id="L2933">                                                         getUrlForSiteVideoWithVideoPressGuid(mSite, videoId);</span>
<span class="nc" id="L2934">                    String posterUrl = WPMediaUtils.getVideoPressVideoPosterFromURL(videoUrl);</span>

<span class="nc" id="L2936">                    mEditorFragment.setUrlForVideoPressId(videoId, videoUrl, posterUrl);</span>
<span class="nc" id="L2937">                }</span>

<span class="nc" id="L2939">                mPendingVideoPressInfoRequests.clear();</span>
            }
        }
<span class="nc" id="L2942">    }</span>

    @Override
    public void onEditPostPublishedSettingsClick() {
<span class="nc" id="L2946">        mViewPager.setCurrentItem(PAGE_PUBLISH_SETTINGS);</span>
<span class="nc" id="L2947">    }</span>

    /**
     * EditorFragmentListener methods
     */

    @Override public void clearFeaturedImage() {
<span class="nc bnc" id="L2954" title="All 2 branches missed.">        if (mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L2955">            ((GutenbergEditorFragment) mEditorFragment).sendToJSFeaturedImageId(0);</span>
        }
<span class="nc" id="L2957">    }</span>

    @Override
    public void updateFeaturedImage(final long mediaId, final boolean imagePicked) {
<span class="nc" id="L2961">        setFeaturedImageId(mediaId, imagePicked, true);</span>
<span class="nc" id="L2962">    }</span>

    @Override
    public void onAddMediaClicked() {
<span class="nc bnc" id="L2966" title="All 2 branches missed.">        if (mEditorPhotoPicker.isPhotoPickerShowing()) {</span>
<span class="nc" id="L2967">            mEditorPhotoPicker.hidePhotoPicker();</span>
<span class="nc bnc" id="L2968" title="All 2 branches missed.">        } else if (WPMediaUtils.currentUserCanUploadMedia(mSite)) {</span>
<span class="nc" id="L2969">            mEditorPhotoPicker.showPhotoPicker(mSite);</span>
        } else {
            // show the WP media library instead of the photo picker if the user doesn't have upload permission
<span class="nc" id="L2972">            mMediaPickerLauncher.viewWPMediaLibraryPickerForResult(this, mSite, MediaBrowserType.EDITOR_PICKER);</span>
        }
<span class="nc" id="L2974">    }</span>

    @Override
    public void onAddMediaImageClicked(boolean allowMultipleSelection) {
<span class="nc" id="L2978">        mEditorPhotoPicker.setAllowMultipleSelection(allowMultipleSelection);</span>
<span class="nc" id="L2979">        mMediaPickerLauncher.viewWPMediaLibraryPickerForResult(this, mSite, MediaBrowserType.GUTENBERG_IMAGE_PICKER);</span>
<span class="nc" id="L2980">    }</span>

    @Override
    public void onAddMediaVideoClicked(boolean allowMultipleSelection) {
<span class="nc" id="L2984">        mEditorPhotoPicker.setAllowMultipleSelection(allowMultipleSelection);</span>
<span class="nc" id="L2985">        mMediaPickerLauncher.viewWPMediaLibraryPickerForResult(this, mSite, MediaBrowserType.GUTENBERG_VIDEO_PICKER);</span>
<span class="nc" id="L2986">    }</span>

    @Override
    public void onAddLibraryMediaClicked(boolean allowMultipleSelection) {
<span class="nc" id="L2990">        mEditorPhotoPicker.setAllowMultipleSelection(allowMultipleSelection);</span>
<span class="nc bnc" id="L2991" title="All 2 branches missed.">        if (allowMultipleSelection) {</span>
<span class="nc" id="L2992">            mMediaPickerLauncher.viewWPMediaLibraryPickerForResult(this, mSite, MediaBrowserType.EDITOR_PICKER);</span>
        } else {
<span class="nc" id="L2994">            mMediaPickerLauncher</span>
<span class="nc" id="L2995">                    .viewWPMediaLibraryPickerForResult(this, mSite, MediaBrowserType.GUTENBERG_SINGLE_MEDIA_PICKER);</span>
        }
<span class="nc" id="L2997">    }</span>

    @Override public void onAddLibraryFileClicked(boolean allowMultipleSelection) {
<span class="nc" id="L3000">        mEditorPhotoPicker.setAllowMultipleSelection(allowMultipleSelection);</span>
<span class="nc" id="L3001">        mMediaPickerLauncher</span>
<span class="nc" id="L3002">                .viewWPMediaLibraryPickerForResult(this, mSite, MediaBrowserType.GUTENBERG_SINGLE_FILE_PICKER);</span>
<span class="nc" id="L3003">    }</span>

    @Override public void onAddLibraryAudioFileClicked(boolean allowMultipleSelection) {
<span class="nc" id="L3006">        mMediaPickerLauncher</span>
<span class="nc" id="L3007">                .viewWPMediaLibraryPickerForResult(this, mSite, MediaBrowserType.GUTENBERG_SINGLE_AUDIO_FILE_PICKER);</span>
<span class="nc" id="L3008">    }</span>

    @Override
    public void onAddPhotoClicked(boolean allowMultipleSelection) {
<span class="nc bnc" id="L3012" title="All 2 branches missed.">        if (allowMultipleSelection) {</span>
<span class="nc" id="L3013">            mMediaPickerLauncher.showPhotoPickerForResult(this, MediaBrowserType.GUTENBERG_IMAGE_PICKER, mSite,</span>
<span class="nc" id="L3014">                    mEditPostRepository.getId());</span>
        } else {
<span class="nc" id="L3016">            mMediaPickerLauncher.showPhotoPickerForResult(this, MediaBrowserType.GUTENBERG_SINGLE_IMAGE_PICKER, mSite,</span>
<span class="nc" id="L3017">                    mEditPostRepository.getId());</span>
        }
<span class="nc" id="L3019">    }</span>

    @Override
    public void onCapturePhotoClicked() {
<span class="nc" id="L3023">        onPhotoPickerIconClicked(PhotoPickerIcon.ANDROID_CAPTURE_PHOTO, false);</span>
<span class="nc" id="L3024">    }</span>

    @Override
    public void onAddVideoClicked(boolean allowMultipleSelection) {
<span class="nc bnc" id="L3028" title="All 2 branches missed.">        if (allowMultipleSelection) {</span>
<span class="nc" id="L3029">            mMediaPickerLauncher.showPhotoPickerForResult(this, MediaBrowserType.GUTENBERG_VIDEO_PICKER, mSite,</span>
<span class="nc" id="L3030">                    mEditPostRepository.getId());</span>
        } else {
<span class="nc" id="L3032">            mMediaPickerLauncher.showPhotoPickerForResult(this, MediaBrowserType.GUTENBERG_SINGLE_VIDEO_PICKER, mSite,</span>
<span class="nc" id="L3033">                    mEditPostRepository.getId());</span>
        }
<span class="nc" id="L3035">    }</span>

    @Override
    public void onAddDeviceMediaClicked(boolean allowMultipleSelection) {
<span class="nc bnc" id="L3039" title="All 2 branches missed.">        if (allowMultipleSelection) {</span>
<span class="nc" id="L3040">            mMediaPickerLauncher.showPhotoPickerForResult(this, MediaBrowserType.GUTENBERG_MEDIA_PICKER, mSite,</span>
<span class="nc" id="L3041">                    mEditPostRepository.getId());</span>
        } else {
<span class="nc" id="L3043">            mMediaPickerLauncher.showPhotoPickerForResult(this, MediaBrowserType.GUTENBERG_SINGLE_MEDIA_PICKER, mSite,</span>
<span class="nc" id="L3044">                    mEditPostRepository.getId());</span>
        }
<span class="nc" id="L3046">    }</span>

    @Override
    public void onAddStockMediaClicked(boolean allowMultipleSelection) {
<span class="nc" id="L3050">        onPhotoPickerIconClicked(PhotoPickerIcon.STOCK_MEDIA, allowMultipleSelection);</span>
<span class="nc" id="L3051">    }</span>

    @Override
    public void onAddGifClicked(boolean allowMultipleSelection) {
<span class="nc" id="L3055">        onPhotoPickerIconClicked(PhotoPickerIcon.GIF, allowMultipleSelection);</span>
<span class="nc" id="L3056">    }</span>

    @Override
    public void onAddFileClicked(boolean allowMultipleSelection) {
<span class="nc" id="L3060">        mMediaPickerLauncher.showFilePicker(this, allowMultipleSelection, getSite());</span>
<span class="nc" id="L3061">    }</span>

    @Override public void onAddAudioFileClicked(boolean allowMultipleSelection) {
<span class="nc" id="L3064">        mMediaPickerLauncher.showAudioFilePicker(this, allowMultipleSelection, getSite());</span>
<span class="nc" id="L3065">    }</span>

    @Override public void onPerformFetch(
            String path,
            boolean enableCaching,
            Consumer&lt;String&gt; onResult,
            Consumer&lt;Bundle&gt; onError
    ) {
<span class="nc bnc" id="L3073" title="All 2 branches missed.">        if (mSite != null) {</span>
<span class="nc" id="L3074">            mReactNativeRequestHandler.performGetRequest(path, mSite, enableCaching, onResult, onError);</span>
        }
<span class="nc" id="L3076">    }</span>

    @Override
    public void onCaptureVideoClicked() {
<span class="nc" id="L3080">        onPhotoPickerIconClicked(PhotoPickerIcon.ANDROID_CAPTURE_VIDEO, false);</span>
<span class="nc" id="L3081">    }</span>

    @Override
    public void onMediaDropped(final ArrayList&lt;Uri&gt; mediaUris) {
<span class="nc" id="L3085">        mEditorMedia.setDroppedMediaUris(mediaUris);</span>
<span class="nc" id="L3086">        if (PermissionUtils</span>
<span class="nc bnc" id="L3087" title="All 2 branches missed.">                .checkAndRequestStoragePermission(this, WPPermissionUtils.EDITOR_DRAG_DROP_PERMISSION_REQUEST_CODE)) {</span>
<span class="nc" id="L3088">            mEditorMedia.addNewMediaItemsToEditorAsync(mEditorMedia.getDroppedMediaUris(), false);</span>
<span class="nc" id="L3089">            mEditorMedia.getDroppedMediaUris().clear();</span>
        }
<span class="nc" id="L3091">    }</span>

    @Override
    public void onRequestDragAndDropPermissions(DragEvent dragEvent) {
<span class="nc" id="L3095">        requestDragAndDropPermissions(dragEvent);</span>
<span class="nc" id="L3096">    }</span>

    @Override
    public void onMediaRetryAllClicked(Set&lt;String&gt; failedMediaIds) {
<span class="nc" id="L3100">        UploadService.cancelFinalNotification(this, mEditPostRepository.getPost());</span>
<span class="nc" id="L3101">        UploadService.cancelFinalNotificationForMedia(this, mSite);</span>
<span class="nc" id="L3102">        ArrayList&lt;Integer&gt; localMediaIds = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L3103" title="All 2 branches missed.">        for (String idString : failedMediaIds) {</span>
<span class="nc" id="L3104">            localMediaIds.add(Integer.valueOf(idString));</span>
<span class="nc" id="L3105">        }</span>
<span class="nc" id="L3106">        mEditorMedia.retryFailedMediaAsync(localMediaIds);</span>
<span class="nc" id="L3107">    }</span>

    @Override
    public boolean onMediaRetryClicked(final String mediaId) {
<span class="nc bnc" id="L3111" title="All 2 branches missed.">        if (TextUtils.isEmpty(mediaId)) {</span>
<span class="nc" id="L3112">            AppLog.e(T.MEDIA, &quot;Invalid media id passed to onMediaRetryClicked&quot;);</span>
<span class="nc" id="L3113">            return false;</span>
        }
<span class="nc" id="L3115">        MediaModel media = mMediaStore.getMediaWithLocalId(StringUtils.stringToInt(mediaId));</span>
<span class="nc bnc" id="L3116" title="All 2 branches missed.">        if (media == null) {</span>
<span class="nc" id="L3117">            AppLog.e(T.MEDIA, &quot;Can't find media with local id: &quot; + mediaId);</span>
<span class="nc" id="L3118">            AlertDialog.Builder builder = new MaterialAlertDialogBuilder(this);</span>
<span class="nc" id="L3119">            builder.setTitle(getString(R.string.cannot_retry_deleted_media_item));</span>
<span class="nc" id="L3120">            builder.setPositiveButton(R.string.yes, (dialog, id) -&gt; {</span>
<span class="nc" id="L3121">                runOnUiThread(() -&gt; mEditorFragment.removeMedia(mediaId));</span>
<span class="nc" id="L3122">                dialog.dismiss();</span>
<span class="nc" id="L3123">            });</span>

<span class="nc" id="L3125">            builder.setNegativeButton(getString(R.string.no), (dialog, id) -&gt; dialog.dismiss());</span>

<span class="nc" id="L3127">            AlertDialog dialog = builder.create();</span>
<span class="nc" id="L3128">            dialog.show();</span>

<span class="nc" id="L3130">            return false;</span>
        }

<span class="nc bnc" id="L3133" title="All 4 branches missed.">        if (media.getUrl() != null &amp;&amp; media.getUploadState().equals(MediaUploadState.UPLOADED.toString())) {</span>
            // Note: we should actually do this when the editor fragment starts instead of waiting for user input.
            // Notify the editor fragment upload was successful and it should replace the local url by the remote url.
<span class="nc bnc" id="L3136" title="All 2 branches missed.">            if (mEditorMediaUploadListener != null) {</span>
<span class="nc" id="L3137">                mEditorMediaUploadListener.onMediaUploadSucceeded(String.valueOf(media.getId()),</span>
<span class="nc" id="L3138">                        FluxCUtils.mediaFileFromMediaModel(media));</span>
            }
        } else {
<span class="nc" id="L3141">            UploadService.cancelFinalNotification(this, mEditPostRepository.getPost());</span>
<span class="nc" id="L3142">            UploadService.cancelFinalNotificationForMedia(this, mSite);</span>
<span class="nc" id="L3143">            mEditorMedia.retryFailedMediaAsync(Collections.singletonList(media.getId()));</span>
        }

<span class="nc" id="L3146">        AnalyticsTracker.track(Stat.EDITOR_UPLOAD_MEDIA_RETRIED);</span>
<span class="nc" id="L3147">        return true;</span>
    }

    @Override
    public void onMediaUploadCancelClicked(String localMediaId) {
<span class="nc bnc" id="L3152" title="All 2 branches missed.">        if (!TextUtils.isEmpty(localMediaId)) {</span>
<span class="nc" id="L3153">            mEditorMedia.cancelMediaUploadAsync(StringUtils.stringToInt(localMediaId), true);</span>
        } else {
            // Passed mediaId is incorrect: cancel all uploads for this post
<span class="nc" id="L3156">            ToastUtils.showToast(this, getString(R.string.error_all_media_upload_canceled));</span>
<span class="nc" id="L3157">            EventBus.getDefault().post(new PostEvents.PostMediaCanceled(mEditPostRepository.getEditablePost()));</span>
        }
<span class="nc" id="L3159">    }</span>

    @Override
    public void onMediaDeleted(String localMediaId) {
<span class="nc bnc" id="L3163" title="All 2 branches missed.">        if (!TextUtils.isEmpty(localMediaId)) {</span>
<span class="nc" id="L3164">            mEditorMedia.onMediaDeleted(mShowAztecEditor, mShowGutenbergEditor, localMediaId);</span>
        }
<span class="nc" id="L3166">    }</span>

    @Override
    public void onUndoMediaCheck(final String undoedContent) {
        // here we check which elements tagged UPLOADING are there in undoedContent,
        // and check for the ones that ARE NOT being uploaded or queued in the UploadService.
        // These are the CANCELED ONES, so mark them FAILED now to retry.

<span class="nc" id="L3174">        List&lt;MediaModel&gt; currentlyUploadingMedia =</span>
<span class="nc" id="L3175">                UploadService.getPendingOrInProgressMediaUploadsForPost(mEditPostRepository.getPost());</span>
<span class="nc" id="L3176">        List&lt;String&gt; mediaMarkedUploading =</span>
<span class="nc" id="L3177">                AztecEditorFragment.getMediaMarkedUploadingInPostContent(EditPostActivity.this, undoedContent);</span>

        // go through the list of items marked UPLOADING within the Post content, and look in the UploadService
        // to see whether they're really being uploaded or not. If an item is not really being uploaded,
        // mark that item failed
<span class="nc bnc" id="L3182" title="All 2 branches missed.">        for (String mediaId : mediaMarkedUploading) {</span>
<span class="nc" id="L3183">            boolean found = false;</span>
<span class="nc bnc" id="L3184" title="All 2 branches missed.">            for (MediaModel media : currentlyUploadingMedia) {</span>
<span class="nc bnc" id="L3185" title="All 2 branches missed.">                if (StringUtils.stringToInt(mediaId) == media.getId()) {</span>
<span class="nc" id="L3186">                    found = true;</span>
<span class="nc" id="L3187">                    break;</span>
                }
<span class="nc" id="L3189">            }</span>

<span class="nc bnc" id="L3191" title="All 2 branches missed.">            if (!found) {</span>
<span class="nc bnc" id="L3192" title="All 2 branches missed.">                if (mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L3193">                    mEditorMedia.updateDeletedMediaItemIds(mediaId);</span>
<span class="nc" id="L3194">                    ((AztecEditorFragment) mEditorFragment).setMediaToFailed(mediaId);</span>
                }
            }
<span class="nc" id="L3197">        }</span>
<span class="nc" id="L3198">    }</span>

    @Override
    public void onVideoPressInfoRequested(final String videoId) {
<span class="nc" id="L3202">        String videoUrl = mMediaStore.getUrlForSiteVideoWithVideoPressGuid(mSite, videoId);</span>

<span class="nc bnc" id="L3204" title="All 2 branches missed.">        if (videoUrl == null) {</span>
<span class="nc" id="L3205">            AppLog.w(T.EDITOR, &quot;The editor wants more info about the following VideoPress code: &quot; + videoId</span>
<span class="nc" id="L3206">                               + &quot; but it's not available in the current site &quot; + mSite.getUrl()</span>
                               + &quot; Maybe it's from another site?&quot;);
<span class="nc" id="L3208">            return;</span>
        }

<span class="nc bnc" id="L3211" title="All 2 branches missed.">        if (videoUrl.isEmpty()) {</span>
<span class="nc bnc" id="L3212" title="All 2 branches missed.">            if (PermissionUtils.checkAndRequestCameraAndStoragePermissions(</span>
                    this, WPPermissionUtils.EDITOR_MEDIA_PERMISSION_REQUEST_CODE)) {
<span class="nc" id="L3214">                runOnUiThread(() -&gt; {</span>
<span class="nc bnc" id="L3215" title="All 2 branches missed.">                    if (mPendingVideoPressInfoRequests == null) {</span>
<span class="nc" id="L3216">                        mPendingVideoPressInfoRequests = new ArrayList&lt;&gt;();</span>
                    }
<span class="nc" id="L3218">                    mPendingVideoPressInfoRequests.add(videoId);</span>
<span class="nc" id="L3219">                    mEditorMedia.refreshBlogMedia();</span>
<span class="nc" id="L3220">                });</span>
            }
        }

<span class="nc" id="L3224">        String posterUrl = WPMediaUtils.getVideoPressVideoPosterFromURL(videoUrl);</span>

<span class="nc" id="L3226">        mEditorFragment.setUrlForVideoPressId(videoId, videoUrl, posterUrl);</span>
<span class="nc" id="L3227">    }</span>

    @Override
    public Map&lt;String, String&gt; onAuthHeaderRequested(String url) {
<span class="nc" id="L3231">        Map&lt;String, String&gt; authHeaders = new HashMap&lt;&gt;();</span>
<span class="nc" id="L3232">        String token = mAccountStore.getAccessToken();</span>
<span class="nc bnc" id="L3233" title="All 4 branches missed.">        if (mSite.isPrivate() &amp;&amp; WPUrlUtils.safeToAddWordPressComAuthToken(url)</span>
<span class="nc bnc" id="L3234" title="All 2 branches missed.">            &amp;&amp; !TextUtils.isEmpty(token)) {</span>
<span class="nc" id="L3235">            authHeaders.put(AuthenticationUtils.AUTHORIZATION_HEADER_NAME, &quot;Bearer &quot; + token);</span>
        }

<span class="nc bnc" id="L3238" title="All 4 branches missed.">        if (mSite.isPrivateWPComAtomic() &amp;&amp; mPrivateAtomicCookie.exists() &amp;&amp; WPUrlUtils</span>
<span class="nc bnc" id="L3239" title="All 2 branches missed.">                .safeToAddPrivateAtCookie(url, mPrivateAtomicCookie.getDomain())) {</span>
<span class="nc" id="L3240">            authHeaders.put(AuthenticationUtils.COOKIE_HEADER_NAME, mPrivateAtomicCookie.getCookieContent());</span>
        }
<span class="nc" id="L3242">        return authHeaders;</span>
    }

    @Override
    public void onEditorFragmentInitialized() {
        // now that we have the Post object initialized,
        // check whether we have media items to insert from the WRITE POST with media functionality
<span class="nc bnc" id="L3249" title="All 2 branches missed.">        if (getIntent().hasExtra(EXTRA_INSERT_MEDIA)) {</span>
            // Bump analytics
<span class="nc" id="L3251">            AnalyticsTracker.track(Stat.NOTIFICATION_UPLOAD_MEDIA_SUCCESS_WRITE_POST);</span>

<span class="nc" id="L3253">            List&lt;MediaModel&gt; mediaList = (List&lt;MediaModel&gt;) getIntent().getSerializableExtra(EXTRA_INSERT_MEDIA);</span>
            // removing this from the intent so it doesn't insert the media items again on each Activity re-creation
<span class="nc" id="L3255">            getIntent().removeExtra(EXTRA_INSERT_MEDIA);</span>
<span class="nc bnc" id="L3256" title="All 4 branches missed.">            if (mediaList != null &amp;&amp; !mediaList.isEmpty()) {</span>
<span class="nc" id="L3257">                mEditorMedia.addExistingMediaToEditorAsync(mediaList, AddExistingMediaSource.WP_MEDIA_LIBRARY);</span>
            }
        }
<span class="nc" id="L3260">        onEditorFinalTouchesBeforeShowing();</span>
<span class="nc" id="L3261">    }</span>

    private void onEditorFinalTouchesBeforeShowing() {
<span class="nc" id="L3264">        refreshEditorContent();</span>
        // probably here is best for Gutenberg to start interacting with
<span class="nc bnc" id="L3266" title="All 4 branches missed.">        if (mShowGutenbergEditor &amp;&amp; mEditorFragment instanceof GutenbergEditorFragment) {</span>
<span class="nc" id="L3267">            refreshEditorTheme();</span>
<span class="nc" id="L3268">            List&lt;MediaModel&gt; failedMedia =</span>
<span class="nc" id="L3269">                    mMediaStore.getMediaForPostWithState(mEditPostRepository.getPost(), MediaUploadState.FAILED);</span>
<span class="nc bnc" id="L3270" title="All 4 branches missed.">            if (failedMedia != null &amp;&amp; !failedMedia.isEmpty()) {</span>
<span class="nc" id="L3271">                HashSet&lt;Integer&gt; mediaIds = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L3272" title="All 2 branches missed.">                for (MediaModel media : failedMedia) {</span>
                    // featured image isn't in the editor but in the Post Settings fragment, so we want to skip it
<span class="nc bnc" id="L3274" title="All 2 branches missed.">                    if (!media.getMarkedLocallyAsFeatured()) {</span>
<span class="nc" id="L3275">                        mediaIds.add(media.getId());</span>
                    }
<span class="nc" id="L3277">                }</span>
<span class="nc" id="L3278">                ((GutenbergEditorFragment) mEditorFragment).resetUploadingMediaToFailed(mediaIds);</span>
            }
<span class="nc bnc" id="L3280" title="All 4 branches missed.">        } else if (mShowAztecEditor &amp;&amp; mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L3281">            final EntryPoint entryPoint = (EntryPoint) getIntent().getSerializableExtra(EXTRA_ENTRY_POINT);</span>
<span class="nc" id="L3282">            mPostEditorAnalyticsSession.start(null, themeSupportsGalleryWithImageBlocks(), entryPoint);</span>
        }
<span class="nc" id="L3284">    }</span>

    @Override
    public void onEditorFragmentContentReady(
            ArrayList&lt;Object&gt; unsupportedBlocksList,
            boolean replaceBlockActionWaiting
    ) {
<span class="nc" id="L3291">        final EntryPoint entryPoint = (EntryPoint) getIntent().getSerializableExtra(EXTRA_ENTRY_POINT);</span>

        // Note that this method is also used to track startup performance
        // It assumes this is being called when the editor has finished loading
        // If you need to refactor this, please ensure that the startup_time_ms property
        // is still reflecting the actual startup time of the editor
<span class="nc" id="L3297">        mPostEditorAnalyticsSession.start(unsupportedBlocksList, themeSupportsGalleryWithImageBlocks(), entryPoint);</span>
<span class="nc" id="L3298">        presentNewPageNoticeIfNeeded();</span>

        // don't start listening for Story events just now if we're waiting for a block to be replaced,
        // unless the user cancelled editing in which case we should continue as normal and attach the listener
<span class="nc bnc" id="L3302" title="All 4 branches missed.">        if (!replaceBlockActionWaiting || mStoryEditingCancelled) {</span>
<span class="nc" id="L3303">            mStoriesEventListener.startListening();</span>
        }

        // Start VM, load prompt and populate Editor with content after edit IS ready.
<span class="nc" id="L3307">        final int promptId = getIntent().getIntExtra(EXTRA_PROMPT_ID, -1);</span>
<span class="nc" id="L3308">        mEditorBloggingPromptsViewModel.start(mSite, promptId);</span>
<span class="nc" id="L3309">    }</span>

    @Override
    public void onReplaceStoryEditedBlockActionSent() {
        // when a replaceBlock signal has been sent, it uses the DeferredEventEmitter so we have to wait for
        // the block replacement to be completed before we can start throwing block-related events at it
        // otherwise these events will miss their target
<span class="nc" id="L3316">        mStoriesEventListener.pauseListening();</span>
<span class="nc" id="L3317">    }</span>

    @Override
    public void onReplaceStoryEditedBlockActionReceived() {
<span class="nc" id="L3321">        mStoriesEventListener.startListening();</span>
<span class="nc" id="L3322">    }</span>

    private void logTemplateSelection() {
<span class="nc" id="L3325">        final String template = getIntent().getStringExtra(EXTRA_PAGE_TEMPLATE);</span>
<span class="nc bnc" id="L3326" title="All 2 branches missed.">        if (template == null) {</span>
<span class="nc" id="L3327">            return;</span>
        }
<span class="nc" id="L3329">        mPostEditorAnalyticsSession.applyTemplate(template);</span>
<span class="nc" id="L3330">    }</span>

    @Override public void showUserSuggestions(Consumer&lt;String&gt; onResult) {
<span class="nc" id="L3333">        showSuggestions(SuggestionType.Users, onResult);</span>
<span class="nc" id="L3334">    }</span>

    @Override public void showXpostSuggestions(Consumer&lt;String&gt; onResult) {
<span class="nc" id="L3337">        showSuggestions(SuggestionType.XPosts, onResult);</span>
<span class="nc" id="L3338">    }</span>

    private void showSuggestions(SuggestionType type, Consumer&lt;String&gt; onResult) {
<span class="nc" id="L3341">        mOnGetSuggestionResult = onResult;</span>
<span class="nc" id="L3342">        ActivityLauncher.viewSuggestionsForResult(this, mSite, type);</span>
<span class="nc" id="L3343">    }</span>

    @Override public void onGutenbergEditorSetFocalPointPickerTooltipShown(boolean tooltipShown) {
<span class="nc" id="L3346">        AppPrefs.setGutenbergFocalPointPickerTooltipShown(tooltipShown);</span>
<span class="nc" id="L3347">    }</span>

    @Override public boolean onGutenbergEditorRequestFocalPointPickerTooltipShown() {
<span class="nc" id="L3350">        return AppPrefs.getGutenbergFocalPointPickerTooltipShown();</span>
    }

    @Override
    public void onHtmlModeToggledInToolbar() {
<span class="nc" id="L3355">        toggleHtmlModeOnMenu();</span>
<span class="nc" id="L3356">    }</span>

    @Override
    public void onTrackableEvent(TrackableEvent event) throws IllegalArgumentException {
<span class="nc" id="L3360">        mEditorTracker.trackEditorEvent(event, mEditorFragment.getEditorName());</span>
<span class="nc bnc" id="L3361" title="All 4 branches missed.">        switch (event) {</span>
            case ELLIPSIS_COLLAPSE_BUTTON_TAPPED:
<span class="nc" id="L3363">                AppPrefs.setAztecEditorToolbarExpanded(false);</span>
<span class="nc" id="L3364">                break;</span>
            case ELLIPSIS_EXPAND_BUTTON_TAPPED:
<span class="nc" id="L3366">                AppPrefs.setAztecEditorToolbarExpanded(true);</span>
<span class="nc" id="L3367">                break;</span>
            case HTML_BUTTON_TAPPED:
            case LINK_ADDED_BUTTON_TAPPED:
<span class="nc" id="L3370">                mEditorPhotoPicker.hidePhotoPicker();</span>
                break;
        }
<span class="nc" id="L3373">    }</span>

    @Override
    public void onTrackableEvent(TrackableEvent event, Map&lt;String, String&gt; properties) {
<span class="nc" id="L3377">        mEditorTracker.trackEditorEvent(event, mEditorFragment.getEditorName(), properties);</span>
<span class="nc" id="L3378">    }</span>

    @Override public void onStoryComposerLoadRequested(ArrayList&lt;Object&gt; mediaFiles, String blockId) {
        // we need to save the latest before editing
<span class="nc" id="L3382">        updateAndSavePostAsync(updatePostResult -&gt; {</span>
<span class="nc" id="L3383">            boolean noSlidesLoaded = mStoriesEventListener.onRequestMediaFilesEditorLoad(</span>
                    EditPostActivity.this,
<span class="nc" id="L3385">                    new LocalId(mEditPostRepository.getId()),</span>
                    mNetworkErrorOnLastMediaFetchAttempt,
                    mediaFiles,
                    blockId
            );

<span class="nc bnc" id="L3391" title="All 4 branches missed.">            if (mNetworkErrorOnLastMediaFetchAttempt &amp;&amp; noSlidesLoaded) {</span>
                // try another fetchMedia request
<span class="nc" id="L3393">                fetchMediaList();</span>
            }
<span class="nc" id="L3395">        });</span>
<span class="nc" id="L3396">    }</span>

    @Override public void onRetryUploadForMediaCollection(ArrayList&lt;Object&gt; mediaFiles) {
<span class="nc" id="L3399">        mStoriesEventListener.onRetryUploadForMediaCollection(this, mediaFiles, mEditorMediaUploadListener);</span>
<span class="nc" id="L3400">    }</span>

    @Override public void onCancelUploadForMediaCollection(ArrayList&lt;Object&gt; mediaFiles) {
<span class="nc" id="L3403">        mStoriesEventListener.onCancelUploadForMediaCollection(mediaFiles);</span>
<span class="nc" id="L3404">    }</span>

    @Override public void onCancelSaveForMediaCollection(ArrayList&lt;Object&gt; mediaFiles) {
<span class="nc" id="L3407">        mStoriesEventListener.onCancelSaveForMediaCollection(mediaFiles);</span>
<span class="nc" id="L3408">    }</span>

    @Override public boolean showPreview() {
<span class="nc" id="L3411">        PreviewLogicOperationResult opResult = mRemotePreviewLogicHelper.runPostPreviewLogic(</span>
                this,
                mSite,
<span class="nc" id="L3414">                Objects.requireNonNull(mEditPostRepository.getPost()),</span>
<span class="nc" id="L3415">                getEditPostActivityStrategyFunctions());</span>
<span class="nc bnc" id="L3416" title="All 6 branches missed.">        if (opResult == PreviewLogicOperationResult.MEDIA_UPLOAD_IN_PROGRESS</span>
            || opResult == PreviewLogicOperationResult.CANNOT_SAVE_EMPTY_DRAFT
            || opResult == PreviewLogicOperationResult.CANNOT_REMOTE_AUTO_SAVE_EMPTY_POST
        ) {
<span class="nc" id="L3420">            return false;</span>
<span class="nc bnc" id="L3421" title="All 2 branches missed.">        } else if (opResult == PreviewLogicOperationResult.OPENING_PREVIEW) {</span>
<span class="nc" id="L3422">            updatePostLoadingAndDialogState(PostLoadingState.PREVIEWING, mEditPostRepository.getPost());</span>
        }
<span class="nc" id="L3424">        return true;</span>
    }

    @Override public Map&lt;String, Double&gt; onRequestBlockTypeImpressions() {
<span class="nc" id="L3428">        return AppPrefs.getGutenbergBlockTypeImpressions();</span>
    }

    @Override public void onSetBlockTypeImpressions(Map&lt;String, Double&gt; impressions) {
<span class="nc" id="L3432">        AppPrefs.setGutenbergBlockTypeImpressions(impressions);</span>
<span class="nc" id="L3433">    }</span>

    @Override public void onContactCustomerSupport() {
<span class="nc" id="L3436">        EditPostCustomerSupportHelper.INSTANCE.onContactCustomerSupport(mZendeskHelper, this, getSite());</span>
<span class="nc" id="L3437">    }</span>

    @Override public void onGotoCustomerSupportOptions() {
<span class="nc" id="L3440">        EditPostCustomerSupportHelper.INSTANCE.onGotoCustomerSupportOptions(this, getSite());</span>
<span class="nc" id="L3441">    }</span>

    @Override public void onSendEventToHost(String eventName, Map&lt;String, Object&gt; properties) {
<span class="nc" id="L3444">        AnalyticsUtils.trackBlockEditorEvent(eventName, mSite, properties);</span>
<span class="nc" id="L3445">    }</span>

    // FluxC events

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onMediaUploaded(OnMediaUploaded event) {
<span class="nc bnc" id="L3452" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L3453">            return;</span>
        }

        // event for unknown media, ignoring
<span class="nc bnc" id="L3457" title="All 2 branches missed.">        if (event.media == null) {</span>
<span class="nc" id="L3458">            AppLog.w(AppLog.T.MEDIA, &quot;Media event carries null media object, not recognized&quot;);</span>
<span class="nc" id="L3459">            return;</span>
        }

<span class="nc bnc" id="L3462" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L3463">            View view = mEditorFragment.getView();</span>
<span class="nc bnc" id="L3464" title="All 2 branches missed.">            if (view != null) {</span>
<span class="nc" id="L3465">                mUploadUtilsWrapper.showSnackbarError(</span>
                        view,
<span class="nc" id="L3467">                        getString(R.string.error_media_upload_failed_for_reason,</span>
<span class="nc" id="L3468">                                UploadUtils.getErrorMessageFromMedia(this, event.media))</span>
                );
            }
<span class="nc" id="L3471">            mEditorMedia.onMediaUploadError(mEditorMediaUploadListener, event.media, event.error);</span>
<span class="nc bnc" id="L3472" title="All 2 branches missed.">        } else if (event.completed) {</span>
            // if the remote url on completed is null, we consider this upload wasn't successful
<span class="nc bnc" id="L3474" title="All 2 branches missed.">            if (event.media.getUrl() == null) {</span>
<span class="nc" id="L3475">                MediaError error = new MediaError(MediaErrorType.GENERIC_ERROR);</span>
<span class="nc" id="L3476">                mEditorMedia.onMediaUploadError(mEditorMediaUploadListener, event.media, error);</span>
<span class="nc" id="L3477">            } else {</span>
<span class="nc" id="L3478">                onUploadSuccess(event.media);</span>
            }
        } else {
<span class="nc" id="L3481">            onUploadProgress(event.media, event.progress);</span>
        }
<span class="nc" id="L3483">    }</span>

    // FluxC events

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onMediaListFetched(OnMediaListFetched event) {
<span class="nc bnc" id="L3490" title="All 2 branches missed.">        if (event != null) {</span>
<span class="nc" id="L3491">            mNetworkErrorOnLastMediaFetchAttempt = event.isError();</span>
        }
<span class="nc" id="L3493">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPostChanged(OnPostChanged event) {
<span class="nc bnc" id="L3498" title="All 2 branches missed.">        if (event.causeOfChange instanceof CauseOfOnPostChanged.UpdatePost) {</span>
<span class="nc bnc" id="L3499" title="All 2 branches missed.">            if (!event.isError()) {</span>
                // here update the menu if it's not a draft anymore
<span class="nc" id="L3501">                invalidateOptionsMenu();</span>
            } else {
<span class="nc" id="L3503">                updatePostLoadingAndDialogState(PostLoadingState.NONE);</span>
<span class="nc" id="L3504">                AppLog.e(AppLog.T.POSTS, &quot;UPDATE_POST failed: &quot; + event.error.type + &quot; - &quot; + event.error.message);</span>
            }
<span class="nc bnc" id="L3506" title="All 2 branches missed.">        } else if (event.causeOfChange instanceof CauseOfOnPostChanged.RemoteAutoSavePost) {</span>
<span class="nc bnc" id="L3507" title="All 2 branches missed.">            if (!mEditPostRepository.hasPost() || (mEditPostRepository.getId()</span>
<span class="nc bnc" id="L3508" title="All 2 branches missed.">                                                   != ((RemoteAutoSavePost) event.causeOfChange).getLocalPostId())) {</span>
<span class="nc" id="L3509">                AppLog.e(T.POSTS,</span>
                        &quot;Ignoring REMOTE_AUTO_SAVE_POST in EditPostActivity as mPost is null or id of the opened post&quot;
                        + &quot; doesn't match the event.&quot;);
<span class="nc" id="L3512">                return;</span>
            }
<span class="nc bnc" id="L3514" title="All 2 branches missed.">            if (event.isError()) {</span>
<span class="nc" id="L3515">                AppLog.e(T.POSTS, &quot;REMOTE_AUTO_SAVE_POST failed: &quot; + event.error.type + &quot; - &quot; + event.error.message);</span>
            }
<span class="nc" id="L3517">            mEditPostRepository.loadPostByLocalPostId(mEditPostRepository.getId());</span>
<span class="nc bnc" id="L3518" title="All 2 branches missed.">            if (isRemotePreviewingFromEditor()) {</span>
<span class="nc" id="L3519">                handleRemotePreviewUploadResult(event.isError(),</span>
                        RemotePreviewType.REMOTE_PREVIEW_WITH_REMOTE_AUTO_SAVE);
            }
        }
<span class="nc" id="L3523">    }</span>

    private boolean isRemotePreviewingFromEditor() {
<span class="nc bnc" id="L3526" title="All 8 branches missed.">        return mPostLoadingState == PostLoadingState.UPLOADING_FOR_PREVIEW</span>
               || mPostLoadingState == PostLoadingState.REMOTE_AUTO_SAVING_FOR_PREVIEW
               || mPostLoadingState == PostLoadingState.PREVIEWING
               || mPostLoadingState == PostLoadingState.REMOTE_AUTO_SAVE_PREVIEW_ERROR;
    }

    private boolean isUploadingPostForPreview() {
<span class="nc bnc" id="L3533" title="All 4 branches missed.">        return mPostLoadingState == PostLoadingState.UPLOADING_FOR_PREVIEW</span>
               || mPostLoadingState == PostLoadingState.REMOTE_AUTO_SAVING_FOR_PREVIEW;
    }

    private void updateOnSuccessfulUpload() {
<span class="nc" id="L3538">        mIsNewPost = false;</span>
<span class="nc" id="L3539">        invalidateOptionsMenu();</span>
<span class="nc" id="L3540">    }</span>

    private boolean isRemoteAutoSaveError() {
<span class="nc bnc" id="L3543" title="All 2 branches missed.">        return mPostLoadingState == PostLoadingState.REMOTE_AUTO_SAVE_PREVIEW_ERROR;</span>
    }

    @Nullable
    private void handleRemotePreviewUploadResult(boolean isError, RemotePreviewLogicHelper.RemotePreviewType param) {
        // We are in the process of remote previewing a post from the editor
<span class="nc bnc" id="L3549" title="All 4 branches missed.">        if (!isError &amp;&amp; isUploadingPostForPreview()) {</span>
            // We were uploading post for preview and we got no error:
            // update post status and preview it in the internal browser
<span class="nc" id="L3552">            updateOnSuccessfulUpload();</span>
<span class="nc" id="L3553">            ActivityLauncher.previewPostOrPageForResult(</span>
                    EditPostActivity.this,
                    mSite,
<span class="nc" id="L3556">                    mEditPostRepository.getPost(),</span>
                    param
            );
<span class="nc" id="L3559">            updatePostLoadingAndDialogState(PostLoadingState.PREVIEWING, mEditPostRepository.getPost());</span>
<span class="nc bnc" id="L3560" title="All 4 branches missed.">        } else if (isError || isRemoteAutoSaveError()) {</span>
            // We got an error from the uploading or from the remote auto save of a post: show snackbar error
<span class="nc" id="L3562">            updatePostLoadingAndDialogState(PostLoadingState.NONE);</span>
<span class="nc" id="L3563">            mUploadUtilsWrapper.showSnackbarError(findViewById(R.id.editor_activity),</span>
<span class="nc" id="L3564">                    getString(R.string.remote_preview_operation_error));</span>
        }
<span class="nc" id="L3566">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPostUploaded(OnPostUploaded event) {
<span class="nc" id="L3571">        final PostModel post = event.post;</span>
<span class="nc bnc" id="L3572" title="All 4 branches missed.">        if (post != null &amp;&amp; post.getId() == mEditPostRepository.getId()) {</span>
<span class="nc bnc" id="L3573" title="All 2 branches missed.">            if (!isRemotePreviewingFromEditor()) {</span>
                // We are not remote previewing a post: show snackbar and update post status if needed
<span class="nc" id="L3575">                View snackbarAttachView = findViewById(R.id.editor_activity);</span>
<span class="nc" id="L3576">                mUploadUtilsWrapper.onPostUploadedSnackbarHandler(this, snackbarAttachView, event.isError(),</span>
<span class="nc bnc" id="L3577" title="All 2 branches missed.">                        event.isFirstTimePublish, post, event.isError() ? event.error.message : null, getSite());</span>
<span class="nc bnc" id="L3578" title="All 2 branches missed.">                if (!event.isError()) {</span>
<span class="nc" id="L3579">                    mEditPostRepository.set(() -&gt; {</span>
<span class="nc" id="L3580">                        updateOnSuccessfulUpload();</span>
<span class="nc" id="L3581">                        return post;</span>
                    });
                }
<span class="nc" id="L3584">            } else {</span>
<span class="nc" id="L3585">                mEditPostRepository.set(() -&gt; post);</span>
<span class="nc" id="L3586">                handleRemotePreviewUploadResult(event.isError(), RemotePreviewType.REMOTE_PREVIEW);</span>
            }
        }
<span class="nc" id="L3589">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ProgressEvent event) {
<span class="nc bnc" id="L3594" title="All 2 branches missed.">        if (!isFinishing()) {</span>
            // use upload progress rather than optimizer progress since the former includes upload+optimization
<span class="nc" id="L3596">            float progress = UploadService.getUploadProgressForMedia(event.media);</span>
<span class="nc" id="L3597">            onUploadProgress(event.media, progress);</span>
        }
<span class="nc" id="L3599">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(UploadService.UploadMediaRetryEvent event) {
<span class="nc bnc" id="L3604" title="All 6 branches missed.">        if (!isFinishing()</span>
            &amp;&amp; event.mediaModelList != null
            &amp;&amp; mEditorMediaUploadListener != null) {
<span class="nc bnc" id="L3607" title="All 2 branches missed.">            for (MediaModel media : event.mediaModelList) {</span>
<span class="nc" id="L3608">                String localMediaId = String.valueOf(media.getId());</span>
<span class="nc bnc" id="L3609" title="All 2 branches missed.">                EditorFragmentAbstract.MediaType mediaType = media.isVideo()</span>
<span class="nc" id="L3610">                        ? EditorFragmentAbstract.MediaType.VIDEO : EditorFragmentAbstract.MediaType.IMAGE;</span>
<span class="nc" id="L3611">                mEditorMediaUploadListener.onMediaUploadRetry(localMediaId, mediaType);</span>
<span class="nc" id="L3612">            }</span>
        }
<span class="nc" id="L3614">    }</span>

    private void refreshEditorTheme() {
<span class="nc" id="L3617">        FetchEditorThemePayload payload =</span>
<span class="nc" id="L3618">                new FetchEditorThemePayload(mSite, mGlobalStyleSupportFeatureConfig.isEnabled());</span>
<span class="nc" id="L3619">        mDispatcher.dispatch(EditorThemeActionBuilder.newFetchEditorThemeAction(payload));</span>
<span class="nc" id="L3620">    }</span>

    private void fetchMediaList() {
        // do not refresh if there is no network
<span class="nc bnc" id="L3624" title="All 2 branches missed.">        if (!NetworkUtils.isNetworkAvailable(this)) {</span>
<span class="nc" id="L3625">            mNetworkErrorOnLastMediaFetchAttempt = true;</span>
<span class="nc" id="L3626">            return;</span>
        }
<span class="nc" id="L3628">        FetchMediaListPayload payload =</span>
                new FetchMediaListPayload(mSite, MediaStore.DEFAULT_NUM_MEDIA_PER_FETCH, false);
<span class="nc" id="L3630">        mDispatcher.dispatch(MediaActionBuilder.newFetchMediaListAction(payload));</span>
<span class="nc" id="L3631">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN_ORDERED)
    public void onEditorThemeChanged(OnEditorThemeChanged event) {
<span class="nc bnc" id="L3636" title="All 2 branches missed.">        if (!(mEditorFragment instanceof EditorThemeUpdateListener)) return;</span>

<span class="nc bnc" id="L3638" title="All 2 branches missed.">        if (mSite.getId() != event.getSiteId()) return;</span>
<span class="nc" id="L3639">        EditorTheme editorTheme = event.getEditorTheme();</span>

<span class="nc bnc" id="L3641" title="All 2 branches missed.">        if (editorTheme == null) return;</span>
<span class="nc" id="L3642">        EditorThemeSupport editorThemeSupport = editorTheme.getThemeSupport();</span>
<span class="nc" id="L3643">        ((EditorThemeUpdateListener) mEditorFragment)</span>
<span class="nc" id="L3644">                    .onEditorThemeUpdated(editorThemeSupport.toBundle());</span>

<span class="nc" id="L3646">        mPostEditorAnalyticsSession</span>
<span class="nc" id="L3647">                .editorSettingsFetched(editorThemeSupport.isFSETheme(), event.getEndpoint().getValue());</span>
<span class="nc" id="L3648">    }</span>
    // EditPostActivityHook methods

    @Override
    public EditPostRepository getEditPostRepository() {
<span class="nc" id="L3653">        return mEditPostRepository;</span>
    }

    @Override
    public SiteModel getSite() {
<span class="nc" id="L3658">        return mSite;</span>
    }


    // External Access to the Image Loader
    public AztecImageLoader getAztecImageLoader() {
<span class="nc" id="L3664">        return mAztecImageLoader;</span>
    }

    @Override
    public boolean onMenuOpened(int featureId, Menu menu) {
        // This is a workaround for bag discovered on Chromebooks, where Enter key will not work in the toolbar menu
        // Editor fragments are messing with window focus, which causes keyboard events to get ignored

        // this fixes issue with GB editor
<span class="nc" id="L3673">        View editorFragmentView = mEditorFragment.getView();</span>
<span class="nc bnc" id="L3674" title="All 2 branches missed.">        if (editorFragmentView != null) {</span>
<span class="nc" id="L3675">            editorFragmentView.requestFocus();</span>
        }

        // this fixes issue with Aztec editor
<span class="nc bnc" id="L3679" title="All 2 branches missed.">        if (mEditorFragment instanceof AztecEditorFragment) {</span>
<span class="nc" id="L3680">            ((AztecEditorFragment) mEditorFragment).requestContentAreaFocus();</span>
        }
<span class="nc" id="L3682">        return super.onMenuOpened(featureId, menu);</span>
    }

    // EditorMediaListener
    @Override
    public void appendMediaFiles(@NotNull Map&lt;String, ? extends MediaFile&gt; mediaFiles) {
<span class="nc" id="L3688">        mEditorFragment.appendMediaFiles((Map&lt;String, MediaFile&gt;) mediaFiles);</span>
<span class="nc" id="L3689">    }</span>

    @NotNull @Override
    public PostImmutableModel getImmutablePost() {
<span class="nc" id="L3693">        return Objects.requireNonNull(mEditPostRepository.getPost());</span>
    }

    @Override
    public void syncPostObjectWithUiAndSaveIt(@Nullable OnPostUpdatedFromUIListener listener) {
<span class="nc" id="L3698">        updateAndSavePostAsync(listener);</span>
<span class="nc" id="L3699">    }</span>

    @Override public void advertiseImageOptimization(@NotNull Function0&lt;Unit&gt; listener) {
<span class="nc" id="L3702">        WPMediaUtils.advertiseImageOptimization(this, listener::invoke);</span>
<span class="nc" id="L3703">    }</span>

    @Override
    public void onMediaModelsCreatedFromOptimizedUris(@NotNull Map&lt;Uri, ? extends MediaModel&gt; oldUriToMediaModels) {
        // no op - we're not doing any special handling on MediaModels in EditPostActivity
<span class="nc" id="L3708">    }</span>

    @Override public void showVideoDurationLimitWarning(@NonNull String fileName) {
<span class="nc" id="L3711">        ToastUtils.showToast(this, R.string.error_media_video_duration_exceeds_limit, ToastUtils.Duration.LONG);</span>
<span class="nc" id="L3712">    }</span>

    @Override
    public Consumer&lt;Exception&gt; getExceptionLogger() {
<span class="nc" id="L3716">        return (Exception e) -&gt; AppLog.e(T.EDITOR, e);</span>
    }

    @Override
    public Consumer&lt;String&gt; getBreadcrumbLogger() {
<span class="nc" id="L3721">        return (String s) -&gt; AppLog.e(T.EDITOR, s);</span>
    }

    private void updateAddingMediaToEditorProgressDialogState(ProgressDialogUiState uiState) {
<span class="nc" id="L3725">        mAddingMediaToEditorProgressDialog = mProgressDialogHelper</span>
<span class="nc" id="L3726">                .updateProgressDialogState(this, mAddingMediaToEditorProgressDialog, uiState, mUiHelpers);</span>
<span class="nc" id="L3727">    }</span>

    @Override
    public String getErrorMessageFromMedia(int mediaId) {
<span class="nc" id="L3731">        MediaModel media = mMediaStore.getMediaWithLocalId(mediaId);</span>

<span class="nc bnc" id="L3733" title="All 2 branches missed.">        if (media != null) {</span>
<span class="nc" id="L3734">            return UploadUtils.getErrorMessageFromMedia(this, media);</span>
        }

<span class="nc" id="L3737">        return &quot;&quot;;</span>
    }

    @Override
    public void showJetpackSettings() {
<span class="nc" id="L3742">        ActivityLauncher.viewJetpackSecuritySettingsForResult(this, mSite);</span>
<span class="nc" id="L3743">    }</span>

    @Override
    public LiveData&lt;DialogVisibility&gt; getSavingInProgressDialogVisibility() {
<span class="nc" id="L3747">        return mViewModel.getSavingInProgressDialogVisibility();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>