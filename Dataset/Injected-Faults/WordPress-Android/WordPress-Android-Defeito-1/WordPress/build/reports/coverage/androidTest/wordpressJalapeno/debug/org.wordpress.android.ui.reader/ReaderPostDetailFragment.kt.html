<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderPostDetailFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader</a> &gt; <span class="el_source">ReaderPostDetailFragment.kt</span></div><h1>ReaderPostDetailFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader

import android.app.Activity
import android.app.DownloadManager
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.content.pm.PackageManager
import android.content.res.Resources
import android.graphics.Rect
import android.graphics.drawable.Drawable
import android.net.Uri
import android.os.Bundle
import android.os.Parcelable
import android.view.Gravity
import android.view.LayoutInflater
import android.view.Menu
import android.view.MenuInflater
import android.view.MenuItem
import android.view.View
import android.view.ViewGroup
import android.webkit.CookieManager
import android.webkit.WebView
import android.widget.ImageView.ScaleType.CENTER_CROP
import android.widget.ProgressBar
import android.widget.TextView
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.widget.ListPopupWindow
import androidx.appcompat.widget.Toolbar
import androidx.core.content.ContextCompat
import androidx.core.graphics.BlendModeColorFilterCompat
import androidx.core.graphics.BlendModeCompat
import androidx.core.view.ViewCompat
import androidx.core.view.WindowInsetsCompat
import androidx.fragment.app.FragmentManager
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.ViewModelProvider.Factory
import androidx.recyclerview.widget.DefaultItemAnimator
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.facebook.shimmer.ShimmerFrameLayout
import com.google.android.material.appbar.AppBarLayout
import com.google.android.material.appbar.CollapsingToolbarLayout
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import com.google.android.material.elevation.ElevationOverlayProvider
import com.google.android.material.snackbar.Snackbar
import org.greenrobot.eventbus.EventBus
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.analytics.AnalyticsTracker
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.databinding.ReaderFragmentPostDetailBinding
import org.wordpress.android.datasets.ReaderPostTable
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.generated.SiteActionBuilder
import org.wordpress.android.fluxc.network.rest.wpcom.site.PrivateAtomicCookie
import org.wordpress.android.fluxc.store.AccountStore
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.fluxc.store.SiteStore.FetchPrivateAtomicCookiePayload
import org.wordpress.android.fluxc.store.SiteStore.OnPrivateAtomicCookieFetched
import org.wordpress.android.models.ReaderPost
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.PrivateAtCookieRefreshProgressDialog
import org.wordpress.android.ui.PrivateAtCookieRefreshProgressDialog.PrivateAtCookieProgressDialogOnDismissListener
import org.wordpress.android.ui.RequestCodes
import org.wordpress.android.ui.ViewPagerFragment
import org.wordpress.android.ui.avatars.AVATAR_LEFT_OFFSET_DIMEN
import org.wordpress.android.ui.avatars.AvatarItemDecorator
import org.wordpress.android.ui.avatars.TrainOfAvatarsAdapter
import org.wordpress.android.ui.avatars.TrainOfAvatarsItem
import org.wordpress.android.ui.engagement.EngagementNavigationSource
import org.wordpress.android.ui.main.SitePickerActivity
import org.wordpress.android.ui.main.WPMainActivity
import org.wordpress.android.ui.media.MediaPreviewActivity
import org.wordpress.android.ui.mysite.SelectedSiteRepository
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.reader.ReaderActivityLauncher.OpenUrlType
import org.wordpress.android.ui.reader.ReaderActivityLauncher.PhotoViewerOption
import org.wordpress.android.ui.reader.ReaderPostPagerActivity.DirectOperation
import org.wordpress.android.ui.reader.ReaderTypes.ReaderPostListType
import org.wordpress.android.ui.reader.actions.ReaderActions
import org.wordpress.android.ui.reader.actions.ReaderPostActions
import org.wordpress.android.ui.reader.adapters.CommentSnippetAdapter
import org.wordpress.android.ui.reader.adapters.ReaderMenuAdapter
import org.wordpress.android.ui.reader.comments.ThreadedCommentsActionSource.DIRECT_OPERATION
import org.wordpress.android.ui.reader.comments.ThreadedCommentsActionSource.READER_POST_DETAILS_COMMENTS
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents
import org.wordpress.android.ui.reader.discover.ReaderPostCardAction
import org.wordpress.android.ui.reader.discover.ReaderPostCardAction.PrimaryAction
import org.wordpress.android.ui.reader.discover.ReaderPostCardActionType
import org.wordpress.android.ui.reader.models.ReaderBlogIdPostId
import org.wordpress.android.ui.reader.tracker.ReaderTracker
import org.wordpress.android.ui.reader.utils.ReaderUtils
import org.wordpress.android.ui.reader.utils.ReaderUtilsWrapper
import org.wordpress.android.ui.reader.utils.ReaderVideoUtils
import org.wordpress.android.ui.reader.viewmodels.ConversationNotificationsViewModel
import org.wordpress.android.ui.reader.viewmodels.ReaderPostDetailViewModel
import org.wordpress.android.ui.reader.viewmodels.ReaderPostDetailViewModel.CommentSnippetUiState
import org.wordpress.android.ui.reader.viewmodels.ReaderPostDetailViewModel.TrainOfFacesUiState
import org.wordpress.android.ui.reader.viewmodels.ReaderPostDetailViewModel.UiState.ErrorUiState
import org.wordpress.android.ui.reader.viewmodels.ReaderPostDetailViewModel.UiState.LoadingUiState
import org.wordpress.android.ui.reader.viewmodels.ReaderPostDetailViewModel.UiState.ReaderPostDetailsUiState
import org.wordpress.android.ui.reader.views.ReaderIconCountView
import org.wordpress.android.ui.reader.views.ReaderPostDetailsHeaderViewUiStateBuilder
import org.wordpress.android.ui.reader.views.ReaderSimplePostContainerView
import org.wordpress.android.ui.reader.views.ReaderWebView
import org.wordpress.android.ui.reader.views.ReaderWebView.ReaderCustomViewListener
import org.wordpress.android.ui.reader.views.ReaderWebView.ReaderWebViewPageFinishedListener
import org.wordpress.android.ui.reader.views.ReaderWebView.ReaderWebViewUrlClickListener
import org.wordpress.android.ui.reader.views.uistates.CommentSnippetItemState
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.AniUtils
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import org.wordpress.android.util.NetworkUtils
import org.wordpress.android.util.PermissionUtils
import org.wordpress.android.util.RtlUtils
import org.wordpress.android.util.StringUtils
import org.wordpress.android.util.ToastUtils
import org.wordpress.android.util.UrlUtils
import org.wordpress.android.util.WPPermissionUtils.READER_FILE_DOWNLOAD_PERMISSION_REQUEST_CODE
import org.wordpress.android.util.WPSwipeToRefreshHelper.buildSwipeToRefreshHelper
import org.wordpress.android.util.config.CommentsSnippetFeatureConfig
import org.wordpress.android.util.config.LikesEnhancementsFeatureConfig
import org.wordpress.android.util.extensions.getColorFromAttribute
import org.wordpress.android.util.extensions.isDarkTheme
import org.wordpress.android.util.extensions.setVisible
import org.wordpress.android.util.helpers.SwipeToRefreshHelper
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.util.image.ImageType.PHOTO
import org.wordpress.android.util.widgets.CustomSwipeRefreshLayout
import org.wordpress.android.viewmodel.ContextProvider
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.widgets.WPScrollView
import org.wordpress.android.widgets.WPScrollView.ScrollDirectionListener
import org.wordpress.android.widgets.WPSnackbar
import org.wordpress.android.widgets.WPTextView
import java.net.HttpURLConnection
import java.util.EnumSet
import javax.inject.Inject

<span class="nc" id="L145">class ReaderPostDetailFragment : ViewPagerFragment(),</span>
        WPMainActivity.OnActivityBackPressedListener,
        ScrollDirectionListener,
        ReaderCustomViewListener,
        ReaderWebViewPageFinishedListener,
        ReaderWebViewUrlClickListener,
        PrivateAtCookieProgressDialogOnDismissListener,
        ReaderInterfaces.AutoHideToolbarListener {
    private var postId: Long = 0
    private var blogId: Long = 0
    private var directOperation: DirectOperation? = null
    private var commentId: Int = 0
    private var interceptedUri: String? = null
    private var renderer: ReaderPostRenderer? = null
<span class="nc" id="L159">    private var postListType: ReaderPostListType = ReaderTypes.DEFAULT_POST_LIST_TYPE</span>

<span class="nc" id="L161">    private val postHistory = ReaderPostHistory()</span>

    private var bookmarksSavedLocallyDialog: AlertDialog? = null
    private var moreMenuPopup: ListPopupWindow? = null
    private lateinit var swipeToRefreshHelper: SwipeToRefreshHelper
    private lateinit var scrollView: WPScrollView
    private lateinit var layoutFooter: ViewGroup
    private lateinit var readerWebView: ReaderWebView

    private lateinit var likeFacesTrain: View
    private lateinit var likeProgressBar: ProgressBar
    private lateinit var likeEmptyStateText: TextView
    private lateinit var likeFacesRecycler: RecyclerView

    private lateinit var commentsSnippetContainer: View
    private lateinit var followConversationContainer: View
    private lateinit var commentsNumTitle: TextView
    private lateinit var commentSnippetRecycler: RecyclerView

    private lateinit var excerptFooter: ViewGroup
    private lateinit var textExcerptFooter: TextView

    private lateinit var signInButton: WPTextView

    private lateinit var appBar: AppBarLayout
    private lateinit var toolBar: Toolbar

    private lateinit var globalRelatedPostsView: ReaderSimplePostContainerView
    private lateinit var localRelatedPostsView: ReaderSimplePostContainerView

    private var postSlugsResolutionUnderway: Boolean = false
    private var hasAlreadyUpdatedPost: Boolean = false
    private var isWebViewPaused: Boolean = false

    private var isRelatedPost: Boolean = false

    private var hasTrackedGlobalRelatedPosts: Boolean = false
    private var hasTrackedLocalRelatedPosts: Boolean = false

    private var errorMessage: String? = null

    private var fileForDownload: String? = null

    private lateinit var viewModel: ReaderPostDetailViewModel
    private lateinit var conversationViewModel: ConversationNotificationsViewModel

<span class="nc bnc" id="L207" title="All 2 branches missed.">    @Inject internal lateinit var accountStore: AccountStore</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">    @Inject internal lateinit var siteStore: SiteStore</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">    @Inject internal lateinit var dispatcher: Dispatcher</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">    @Inject internal lateinit var readerFileDownloadManager: ReaderFileDownloadManager</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">    @Inject internal lateinit var privateAtomicCookie: PrivateAtomicCookie</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">    @Inject internal lateinit var readerCssProvider: ReaderCssProvider</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">    @Inject internal lateinit var imageManager: ImageManager</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">    @Inject lateinit var postDetailsHeaderViewUiStateBuilder: ReaderPostDetailsHeaderViewUiStateBuilder</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">    @Inject lateinit var readerUtilsWrapper: ReaderUtilsWrapper</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: Factory</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">    @Inject lateinit var readerTracker: ReaderTracker</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">    @Inject lateinit var likesEnhancementsFeatureConfig: LikesEnhancementsFeatureConfig</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">    @Inject lateinit var contextProvider: ContextProvider</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">    @Inject lateinit var commentsSnippetFeatureConfig: CommentsSnippetFeatureConfig</span>

<span class="nc" id="L223">    private val mSignInClickListener = View.OnClickListener {</span>
<span class="nc" id="L224">        EventBus.getDefault()</span>
<span class="nc" id="L225">                .post(ReaderEvents.DoSignIn())</span>
<span class="nc" id="L226">    }</span>

    val isCustomViewShowing: Boolean
<span class="nc bnc" id="L229" title="All 6 branches missed.">        get() = view != null &amp;&amp; readerWebView.isCustomViewShowing</span>

    private val appBarLayoutOffsetChangedListener =
<span class="nc" id="L232">            AppBarLayout.OnOffsetChangedListener { appBarLayout, verticalOffset -&gt;</span>
<span class="nc" id="L233">                val collapsingToolbarLayout = appBarLayout</span>
<span class="nc" id="L234">                        .findViewById&lt;CollapsingToolbarLayout&gt;(R.id.collapsing_toolbar)</span>
<span class="nc" id="L235">                val toolbar = appBarLayout.findViewById&lt;Toolbar&gt;(R.id.toolbar_main)</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">                context?.let { context -&gt;</span>
<span class="nc" id="L238">                    val menu: Menu = toolbar.menu</span>
<span class="nc" id="L239">                    val menuBrowse: MenuItem? = menu.findItem(R.id.menu_browse)</span>
<span class="nc" id="L240">                    val menuShare: MenuItem? = menu.findItem(R.id.menu_share)</span>
<span class="nc" id="L241">                    val menuMore: MenuItem? = menu.findItem(R.id.menu_more)</span>

<span class="nc" id="L243">                    val collapsingToolbarHeight = collapsingToolbarLayout.height</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                    val isCollapsed = (collapsingToolbarHeight + verticalOffset) &lt;=</span>
<span class="nc" id="L245">                            collapsingToolbarLayout.scrimVisibleHeightTrigger</span>
<span class="nc" id="L246">                    val isDarkTheme = context.resources.configuration.isDarkTheme()</span>

<span class="nc bnc" id="L248" title="All 4 branches missed.">                    val colorAttr = if (isCollapsed || isDarkTheme) {</span>
<span class="nc" id="L249">                        R.attr.colorOnSurface</span>
                    } else {
<span class="nc" id="L251">                        R.attr.colorSurface</span>
                    }
<span class="nc" id="L253">                    val color = context.getColorFromAttribute(colorAttr)</span>
<span class="nc" id="L254">                    val colorFilter = BlendModeColorFilterCompat</span>
<span class="nc" id="L255">                            .createBlendModeColorFilterCompat(color, BlendModeCompat.SRC_ATOP)</span>

<span class="nc" id="L257">                    toolbar.setTitleTextColor(color)</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                    toolbar.navigationIcon?.colorFilter = colorFilter</span>

<span class="nc bnc" id="L260" title="All 4 branches missed.">                    menuBrowse?.icon?.colorFilter = colorFilter</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">                    menuShare?.icon?.colorFilter = colorFilter</span>
<span class="nc bnc" id="L262" title="All 4 branches missed.">                    menuMore?.icon?.colorFilter = colorFilter</span>
<span class="nc" id="L263">                }</span>
<span class="nc" id="L264">            }</span>

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L267">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L270">            postHistory.restoreInstance(savedInstanceState)</span>
        }
<span class="nc" id="L272">    }</span>

    override fun setArguments(args: Bundle?) {
<span class="nc" id="L275">        super.setArguments(args)</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (args != null) {</span>
<span class="nc" id="L277">            blogId = args.getLong(ReaderConstants.ARG_BLOG_ID)</span>
<span class="nc" id="L278">            postId = args.getLong(ReaderConstants.ARG_POST_ID)</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            directOperation = args.getSerializable(ReaderConstants.ARG_DIRECT_OPERATION) as? DirectOperation</span>
<span class="nc" id="L280">            commentId = args.getInt(ReaderConstants.ARG_COMMENT_ID)</span>
<span class="nc" id="L281">            isRelatedPost = args.getBoolean(ReaderConstants.ARG_IS_RELATED_POST)</span>
<span class="nc" id="L282">            interceptedUri = args.getString(ReaderConstants.ARG_INTERCEPTED_URI)</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (args.containsKey(ReaderConstants.ARG_POST_LIST_TYPE)) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                this.postListType = args.getSerializable(ReaderConstants.ARG_POST_LIST_TYPE) as ReaderPostListType</span>
            }
<span class="nc" id="L286">            postSlugsResolutionUnderway = args.getBoolean(ReaderConstants.KEY_POST_SLUGS_RESOLUTION_UNDERWAY)</span>
        }
<span class="nc" id="L288">    }</span>

    override fun getScrollableViewForUniqueIdProvision(): View? {
<span class="nc bnc" id="L291" title="All 2 branches missed.">        return scrollView</span>
    }

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
<span class="nc" id="L299">        val view = inflater.inflate(R.layout.reader_fragment_post_detail, container, false)</span>

<span class="nc" id="L301">        initSwipeRefreshLayout(view)</span>
<span class="nc" id="L302">        initAppBar(view)</span>
<span class="nc" id="L303">        initScrollView(view)</span>
<span class="nc" id="L304">        initWebView(view)</span>
<span class="nc" id="L305">        initLikeFacesTrain(view)</span>
<span class="nc" id="L306">        initCommentSnippetView(view)</span>
<span class="nc" id="L307">        initExcerptFooter(view)</span>
<span class="nc" id="L308">        initRelatedPostsView(view)</span>
<span class="nc" id="L309">        initLayoutFooter(view)</span>
<span class="nc" id="L310">        initSignInButton(view)</span>
<span class="nc" id="L311">        initProgressView(view)</span>

<span class="nc" id="L313">        return view</span>
    }

    private fun initSwipeRefreshLayout(view: View) {
<span class="nc" id="L317">        val swipeRefreshLayout = view.findViewById&lt;CustomSwipeRefreshLayout&gt;(R.id.swipe_to_refresh)</span>

        // this fragment hides/shows toolbar with scrolling, which messes up ptr animation position
        // so we have to set it manually
<span class="nc" id="L321">        val swipeToRefreshOffset = resources.getDimensionPixelSize(R.dimen.toolbar_content_offset)</span>
<span class="nc" id="L322">        swipeRefreshLayout.setProgressViewOffset(false, 0, swipeToRefreshOffset)</span>

<span class="nc" id="L324">        swipeToRefreshHelper = buildSwipeToRefreshHelper(swipeRefreshLayout) {</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            if (isAdded) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                if (commentsSnippetFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                    conversationViewModel.onRefresh()</span>
                }
<span class="nc" id="L329">                updatePost()</span>
            }
<span class="nc" id="L331">        }</span>
<span class="nc" id="L332">    }</span>

    private fun initAppBar(view: View) {
<span class="nc" id="L335">        appBar = view.findViewById(R.id.appbar_with_collapsing_toolbar_layout)</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        toolBar = appBar.findViewById(R.id.toolbar_main)</span>

<span class="nc bnc" id="L338" title="All 2 branches missed.">        toolBar.setVisible(true)</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        appBar.addOnOffsetChangedListener(appBarLayoutOffsetChangedListener)</span>

        // Fixes collapsing toolbar layout being obscured by the status bar when drawn behind it
<span class="nc bnc" id="L342" title="All 2 branches missed.">        ViewCompat.setOnApplyWindowInsetsListener(appBar) { v: View, insets: WindowInsetsCompat -&gt;</span>
<span class="nc" id="L343">            val insetTop = insets.systemWindowInsetTop</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (insetTop &gt; 0) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                toolBar.setPadding(0, insetTop, 0, 0)</span>
            }
<span class="nc" id="L347">            insets.consumeSystemWindowInsets()</span>
        }

        // Fixes viewpager not displaying menu items for first fragment
<span class="nc bnc" id="L351" title="All 2 branches missed.">        toolBar.inflateMenu(R.menu.reader_detail)</span>

        // for related posts, show an X in the toolbar which closes the activity
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (isRelatedPost) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            toolBar.setNavigationIcon(R.drawable.ic_cross_white_24dp)</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">            toolBar.setNavigationOnClickListener { requireActivity().finish() }</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            toolBar.setTitle(R.string.reader_title_related_post_detail)</span>
        } else {
<span class="nc bnc" id="L359" title="All 2 branches missed.">            toolBar.setNavigationIcon(R.drawable.ic_arrow_back_white_24dp)</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            toolBar.setNavigationOnClickListener { requireActivity().onBackPressed() }</span>
        }
<span class="nc" id="L362">    }</span>

    private fun initScrollView(view: View) {
<span class="nc" id="L365">        scrollView = view.findViewById(R.id.scroll_view_reader)</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">        scrollView.setScrollDirectionListener(this)</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        scrollView.visibility = View.INVISIBLE</span>
<span class="nc" id="L368">    }</span>

    private fun initWebView(view: View) {
        // setup the ReaderWebView
<span class="nc" id="L372">        readerWebView = view.findViewById(R.id.reader_webview)</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        readerWebView.setCustomViewListener(this)</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        readerWebView.setUrlClickListener(this)</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        readerWebView.setPageFinishedListener(this)</span>
<span class="nc" id="L376">    }</span>

    private fun initLikeFacesTrain(view: View) {
<span class="nc" id="L379">        likeFacesTrain = view.findViewById(R.id.liker_faces_container)</span>
<span class="nc" id="L380">        likeFacesRecycler = view.findViewById(R.id.likes_recycler)</span>
<span class="nc" id="L381">        likeProgressBar = view.findViewById(R.id.progress_bar)</span>
<span class="nc" id="L382">        likeEmptyStateText = view.findViewById(R.id.empty_state_text)</span>
<span class="nc" id="L383">    }</span>

    private fun initCommentSnippetView(view: View) {
<span class="nc" id="L386">        commentsSnippetContainer = view.findViewById(R.id.comments_snippet)</span>
<span class="nc" id="L387">        commentsNumTitle = view.findViewById(R.id.comments_number_title)</span>
<span class="nc" id="L388">        followConversationContainer = view.findViewById(R.id.follow_conversation_container)</span>
<span class="nc" id="L389">        commentSnippetRecycler = view.findViewById(R.id.comments_recycler)</span>
<span class="nc" id="L390">    }</span>

    private fun initExcerptFooter(view: View) {
<span class="nc" id="L393">        excerptFooter = view.findViewById(R.id.excerpt_footer)</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">        textExcerptFooter = excerptFooter.findViewById(R.id.text_excerpt_footer)</span>
<span class="nc" id="L395">    }</span>

    private fun initRelatedPostsView(view: View) {
<span class="nc" id="L398">        val relatedPostsContainer = view.findViewById&lt;View&gt;(R.id.container_related_posts)</span>
<span class="nc" id="L399">        globalRelatedPostsView = relatedPostsContainer.findViewById(R.id.related_posts_view_global)</span>
<span class="nc" id="L400">        localRelatedPostsView = relatedPostsContainer.findViewById(R.id.related_posts_view_local)</span>
<span class="nc" id="L401">    }</span>

    private fun initLayoutFooter(view: View) {
<span class="nc" id="L404">        layoutFooter = view.findViewById(R.id.layout_post_detail_footer)</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">        val elevationOverlayProvider = ElevationOverlayProvider(layoutFooter.context)</span>
<span class="nc" id="L406">        val appbarElevation = resources.getDimension(R.dimen.appbar_elevation)</span>
<span class="nc" id="L407">        val elevatedSurfaceColor = elevationOverlayProvider.compositeOverlayWithThemeSurfaceColorIfNeeded(</span>
<span class="nc" id="L408">                appbarElevation</span>
        )
<span class="nc bnc" id="L410" title="All 2 branches missed.">        layoutFooter.setBackgroundColor(elevatedSurfaceColor)</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">        layoutFooter.visibility = View.INVISIBLE</span>
<span class="nc" id="L412">    }</span>

    private fun initSignInButton(view: View) {
<span class="nc" id="L415">        signInButton = view.findViewById(R.id.nux_sign_in_button)</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">        signInButton.setOnClickListener(mSignInClickListener)</span>
<span class="nc" id="L417">    }</span>

    private fun initProgressView(view: View) {
<span class="nc" id="L420">        val progress = view.findViewById&lt;ProgressBar&gt;(R.id.progress_loading)</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (postSlugsResolutionUnderway) {</span>
<span class="nc" id="L422">            progress.visibility = View.VISIBLE</span>
        }
<span class="nc" id="L424">    }</span>

    override fun onResume() {
<span class="nc" id="L427">        super.onResume()</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (isVisible) {</span>
<span class="nc" id="L429">            replaceActivityToolbarWithCollapsingToolbar()</span>
        }
<span class="nc" id="L431">    }</span>

    private fun replaceActivityToolbarWithCollapsingToolbar() {
<span class="nc bnc" id="L434" title="All 2 branches missed.">        val activity = activity as? AppCompatActivity</span>
<span class="nc bnc" id="L435" title="All 4 branches missed.">        activity?.supportActionBar?.hide()</span>

<span class="nc bnc" id="L437" title="All 2 branches missed.">        toolBar.setVisible(true)</span>
<span class="nc bnc" id="L438" title="All 4 branches missed.">        activity?.setSupportActionBar(toolBar)</span>

<span class="nc bnc" id="L440" title="All 4 branches missed.">        activity?.supportActionBar?.setDisplayShowTitleEnabled(isRelatedPost)</span>
<span class="nc" id="L441">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L444">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L445">        val binding = ReaderFragmentPostDetailBinding.bind(view)</span>

<span class="nc" id="L447">        initLikeFacesRecycler(savedInstanceState)</span>
<span class="nc" id="L448">        initCommentSnippetRecycler(savedInstanceState)</span>
<span class="nc" id="L449">        initViewModel(binding, savedInstanceState)</span>
<span class="nc" id="L450">        restoreState(savedInstanceState)</span>
<span class="nc" id="L451">        setHasOptionsMenu(true)</span>

<span class="nc" id="L453">        showPost()</span>
<span class="nc" id="L454">    }</span>

    private fun initLikeFacesRecycler(savedInstanceState: Bundle?) {
<span class="nc bnc" id="L457" title="All 2 branches missed.">        if (!likesEnhancementsFeatureConfig.isEnabled()) return</span>
<span class="nc" id="L458">        val layoutManager = LinearLayoutManager(activity, LinearLayoutManager.HORIZONTAL, false)</span>
<span class="nc bnc" id="L459" title="All 4 branches missed.">        savedInstanceState?.getParcelable&lt;Parcelable&gt;(ReaderPostDetailFragment.KEY_LIKERS_LIST_STATE)?.let {</span>
<span class="nc" id="L460">            layoutManager.onRestoreInstanceState(it)</span>
<span class="nc" id="L461">        }</span>

<span class="nc bnc" id="L463" title="All 2 branches missed.">        likeFacesRecycler.addItemDecoration(</span>
<span class="nc" id="L464">                AvatarItemDecorator(</span>
<span class="nc" id="L465">                RtlUtils.isRtl(activity),</span>
<span class="nc" id="L466">                contextProvider.getContext(),</span>
<span class="nc" id="L467">                AVATAR_LEFT_OFFSET_DIMEN)</span>
        )

<span class="nc bnc" id="L470" title="All 2 branches missed.">        likeFacesRecycler.layoutManager = layoutManager</span>
<span class="nc" id="L471">    }</span>

    private fun initCommentSnippetRecycler(savedInstanceState: Bundle?) {
<span class="nc bnc" id="L474" title="All 2 branches missed.">        if (!commentsSnippetFeatureConfig.isEnabled()) return</span>
<span class="nc" id="L475">        val layoutManager = LinearLayoutManager(activity)</span>

<span class="nc bnc" id="L477" title="All 4 branches missed.">        savedInstanceState?.getParcelable&lt;Parcelable&gt;(ReaderPostDetailFragment.KEY_COMMENTS_SNIPPET_LIST_STATE)?.let {</span>
<span class="nc" id="L478">            layoutManager.onRestoreInstanceState(it)</span>
<span class="nc" id="L479">        }</span>

<span class="nc bnc" id="L481" title="All 2 branches missed.">        commentSnippetRecycler.layoutManager = layoutManager</span>
<span class="nc" id="L482">    }</span>

    private fun initViewModel(binding: ReaderFragmentPostDetailBinding, savedInstanceState: Bundle?) {
<span class="nc" id="L485">        viewModel = ViewModelProvider(this, viewModelFactory).get(ReaderPostDetailViewModel::class.java)</span>
<span class="nc" id="L486">        conversationViewModel = ViewModelProvider(this, viewModelFactory).get(</span>
                ConversationNotificationsViewModel::class.java
        )

<span class="nc" id="L490">        initObservers(binding)</span>

<span class="nc bnc" id="L492" title="All 2 branches missed.">        val bundle = savedInstanceState ?: arguments</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">        val isFeed = bundle?.getBoolean(ReaderConstants.ARG_IS_FEED) ?: false</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">        val interceptedUri = bundle?.getString(ReaderConstants.ARG_INTERCEPTED_URI)</span>

<span class="nc bnc" id="L496" title="All 2 branches missed.">        if (commentsSnippetFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">            conversationViewModel.start(blogId, postId, READER_POST_DETAILS_COMMENTS)</span>
        }
<span class="nc bnc" id="L499" title="All 2 branches missed.">        viewModel.start(isRelatedPost = isRelatedPost, isFeed = isFeed, interceptedUri = interceptedUri)</span>
<span class="nc" id="L500">    }</span>

    private fun initObservers(binding: ReaderFragmentPostDetailBinding) {
<span class="nc bnc" id="L503" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner, {</span>
<span class="nc" id="L504">            uiHelpers.updateVisibility(binding.textError, it.errorVisible)</span>
<span class="nc" id="L505">            uiHelpers.updateVisibility(binding.progressLoading, it.loadingVisible)</span>
<span class="nc" id="L506">            when (it) {</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                is LoadingUiState -&gt; Unit // Do Nothing</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                is ReaderPostDetailsUiState -&gt; renderUiState(it, binding)</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                is ErrorUiState -&gt; {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                    uiHelpers.updateVisibility(signInButton, it.signInButtonVisibility)</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">                    val message = it.message?.let { msg -&gt; uiHelpers.getTextOfUiString(requireContext(), msg) }</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">                    showError(message?.toString())</span>
                }
            }
<span class="nc" id="L515">        })</span>

<span class="nc bnc" id="L517" title="All 2 branches missed.">        if (likesEnhancementsFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">            viewModel.likesUiState.observe(viewLifecycleOwner, { state -&gt;</span>
<span class="nc" id="L519">                manageLikesUiState(state)</span>
<span class="nc" id="L520">            })</span>
        }

<span class="nc bnc" id="L523" title="All 2 branches missed.">        viewModel.refreshPost.observeEvent(viewLifecycleOwner, {} /* Do nothing */)</span>

<span class="nc bnc" id="L525" title="All 2 branches missed.">        viewModel.snackbarEvents.observeEvent(viewLifecycleOwner, { it.showSnackbar(binding) })</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">        viewModel.navigationEvents.observeEvent(viewLifecycleOwner, { it.handleNavigationEvent() })</span>

<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (commentsSnippetFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">            conversationViewModel.snackbarEvents.observe(viewLifecycleOwner, { event -&gt;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">                if (!isAdded) return@observe</span>

<span class="nc" id="L533">                val fm: FragmentManager = childFragmentManager</span>
<span class="nc" id="L534">                val bottomSheet =</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                        fm.findFragmentByTag(NOTIFICATIONS_BOTTOM_SHEET_TAG) as? CommentNotificationsBottomSheetFragment</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                if (bottomSheet != null) return@observe</span>
<span class="nc" id="L537">                event.applyIfNotHandled {</span>
<span class="nc" id="L538">                    this.showSnackbar(binding)</span>
<span class="nc" id="L539">                }</span>
<span class="nc" id="L540">            })</span>

<span class="nc bnc" id="L542" title="All 2 branches missed.">            conversationViewModel.showBottomSheetEvent.observeEvent(viewLifecycleOwner, { showBottomSheetData -&gt;</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">                if (!isAdded) return@observeEvent</span>

<span class="nc" id="L545">                val fm: FragmentManager = childFragmentManager</span>
<span class="nc" id="L546">                var bottomSheet =</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                        fm.findFragmentByTag(NOTIFICATIONS_BOTTOM_SHEET_TAG) as? CommentNotificationsBottomSheetFragment</span>
<span class="nc bnc" id="L548" title="All 4 branches missed.">                if (showBottomSheetData.show &amp;&amp; bottomSheet == null) {</span>
<span class="nc" id="L549">                    bottomSheet = CommentNotificationsBottomSheetFragment.newInstance(</span>
<span class="nc" id="L550">                            showBottomSheetData.isReceivingNotifications,</span>
<span class="nc" id="L551">                            true</span>
                    )
<span class="nc" id="L553">                    bottomSheet.show(fm, NOTIFICATIONS_BOTTOM_SHEET_TAG)</span>
<span class="nc bnc" id="L554" title="All 4 branches missed.">                } else if (!showBottomSheetData.show &amp;&amp; bottomSheet != null) {</span>
<span class="nc" id="L555">                    bottomSheet.dismiss()</span>
                }
<span class="nc" id="L557">            })</span>

<span class="nc bnc" id="L559" title="All 2 branches missed.">            conversationViewModel.updateFollowUiState.observe(viewLifecycleOwner, { uiState -&gt;</span>
<span class="nc" id="L560">                manageFollowConversationUiState(uiState, binding)</span>
<span class="nc" id="L561">            })</span>

<span class="nc bnc" id="L563" title="All 2 branches missed.">            viewModel.commentSnippetState.observe(viewLifecycleOwner, { state -&gt;</span>
<span class="nc" id="L564">                manageCommentSnippetUiState(state)</span>
<span class="nc" id="L565">            })</span>
        }
<span class="nc" id="L567">    }</span>

    private fun manageFollowConversationUiState(
        uiState: FollowConversationUiState,
        binding: ReaderFragmentPostDetailBinding
    ) {
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (!isAdded) return</span>

<span class="nc" id="L575">        with(binding) {</span>
<span class="nc" id="L576">            val bellItem = commentsSnippet.bellIcon</span>
<span class="nc" id="L577">            val followContainer = commentsSnippet.followConversationContainer</span>

<span class="nc" id="L579">            val shimmerView: ShimmerFrameLayout = commentsSnippet.shimmerViewContainer</span>
<span class="nc" id="L580">            val followText = commentsSnippet.followConversation</span>
<span class="nc" id="L581">            followText.setOnClickListener(</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">                    if (uiState.onFollowTapped != null) {</span>
<span class="nc" id="L583">                        View.OnClickListener { uiState.onFollowTapped.invoke() }</span>
                    } else {
<span class="nc" id="L585">                        null</span>
                    }
            )
<span class="nc" id="L588">            bellItem.setOnClickListener {</span>
<span class="nc" id="L589">                uiState.onManageNotificationsTapped.invoke()</span>
<span class="nc" id="L590">            }</span>
<span class="nc" id="L591">            followContainer.isEnabled = uiState.flags.isMenuEnabled</span>
<span class="nc" id="L592">            followText.isEnabled = uiState.flags.isMenuEnabled</span>
<span class="nc" id="L593">            bellItem.isEnabled = uiState.flags.isMenuEnabled</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">            if (uiState.flags.showMenuShimmer) {</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                if (!shimmerView.isShimmerVisible) {</span>
<span class="nc" id="L596">                    shimmerView.showShimmer(true)</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                } else if (!shimmerView.isShimmerStarted) {</span>
<span class="nc" id="L598">                    shimmerView.startShimmer()</span>
                }
            } else {
<span class="nc" id="L601">                shimmerView.hideShimmer()</span>
            }
<span class="nc bnc" id="L603" title="All 2 branches missed.">            shimmerView.visibility = if (uiState.flags.isFollowMenuVisible) View.VISIBLE else View.GONE</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">            bellItem.visibility = if (uiState.flags.isBellMenuVisible) View.VISIBLE else View.GONE</span>
<span class="nc" id="L605">        }</span>
<span class="nc" id="L606">    }</span>

    private fun manageLikesUiState(state: TrainOfFacesUiState) {
<span class="nc bnc" id="L609" title="All 2 branches missed.">        if (!isAdded) return</span>

<span class="nc" id="L611">        with(requireActivity()) {</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">            if (this.isFinishing) return@with</span>

<span class="nc bnc" id="L614" title="All 6 branches missed.">            val shouldSkipAnimation = likeFacesTrain.visibility == View.GONE &amp;&amp; state.goingToShowFaces</span>

<span class="nc" id="L616">            setupLikeFacesTrain(</span>
<span class="nc" id="L617">                    state.engageItemsList,</span>
<span class="nc" id="L618">                    state.showLoading,</span>
<span class="nc" id="L619">                    shouldSkipAnimation</span>
            )

<span class="nc bnc" id="L622" title="All 4 branches missed.">            likeProgressBar.visibility = if (state.showLoading) View.VISIBLE else View.GONE</span>
<span class="nc bnc" id="L623" title="All 4 branches missed.">            likeFacesTrain.visibility = if (state.showLikeFacesTrainContainer) View.VISIBLE else View.GONE</span>

<span class="nc bnc" id="L625" title="All 2 branches missed.">            if (state.showEmptyState) {</span>
<span class="nc bnc" id="L626" title="All 4 branches missed.">                uiHelpers.setTextOrHide(likeEmptyStateText, state.emptyStateTitle?.let {</span>
<span class="nc" id="L627">                    getString(R.string.like_faces_error_loading_message, uiHelpers.getTextOfUiString(this, it))</span>
                })
<span class="nc bnc" id="L629" title="All 2 branches missed.">                likeEmptyStateText.visibility = View.VISIBLE</span>
            } else {
<span class="nc bnc" id="L631" title="All 2 branches missed.">                likeEmptyStateText.visibility = View.GONE</span>
            }

<span class="nc bnc" id="L634" title="All 2 branches missed.">            likeFacesTrain.contentDescription = uiHelpers.getTextOfUiString(</span>
<span class="nc" id="L635">                    contextProvider.getContext(),</span>
<span class="nc" id="L636">                    state.contentDescription</span>
            )

<span class="nc bnc" id="L639" title="All 2 branches missed.">            likeFacesTrain.setOnClickListener {</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">                if (!isAdded) return@setOnClickListener</span>

<span class="nc bnc" id="L642" title="All 2 branches missed.">                viewModel.onLikeFacesClicked()</span>
<span class="nc" id="L643">            }</span>
<span class="nc" id="L644">        }</span>
<span class="nc" id="L645">    }</span>

    private fun manageCommentSnippetUiState(state: CommentSnippetUiState) {
<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (!isAdded) return</span>

<span class="nc" id="L650">        with(requireActivity()) {</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            if (this.isFinishing) return@with</span>

<span class="nc bnc" id="L653" title="All 2 branches missed.">            uiHelpers.updateVisibility(commentsSnippetContainer, commentsSnippetFeatureConfig.isEnabled())</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">            uiHelpers.updateVisibility(followConversationContainer, state.showFollowConversation)</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">            commentsNumTitle.text = readerUtilsWrapper.getTextForCommentSnippet(state.commentsNumber)</span>

<span class="nc" id="L657">            setupCommentSnippetAdapter(this, state.snippetItems)</span>
<span class="nc" id="L658">        }</span>
<span class="nc" id="L659">    }</span>

    private fun setupCommentSnippetAdapter(context: Context, items: List&lt;CommentSnippetItemState&gt;) {
<span class="nc bnc" id="L662" title="All 6 branches missed.">        val adapter = commentSnippetRecycler.adapter as? CommentSnippetAdapter ?: CommentSnippetAdapter(</span>
<span class="nc" id="L663">                context,</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">                viewModel.post</span>
<span class="nc" id="L665">        ).also {</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">            commentSnippetRecycler.adapter = it</span>
<span class="nc" id="L667">        }</span>

<span class="nc bnc" id="L669" title="All 4 branches missed.">        val recyclerViewState = commentSnippetRecycler.layoutManager?.onSaveInstanceState()</span>
<span class="nc" id="L670">        adapter.loadData(items)</span>
<span class="nc bnc" id="L671" title="All 4 branches missed.">        commentSnippetRecycler.layoutManager?.onRestoreInstanceState(recyclerViewState)</span>
<span class="nc" id="L672">    }</span>

    private fun setupLikeFacesTrain(items: List&lt;TrainOfAvatarsItem&gt;, loading: Boolean, shouldSkipAnimation: Boolean) {
<span class="nc bnc" id="L675" title="All 4 branches missed.">        likeFacesRecycler.visibility = if (loading) View.GONE else View.VISIBLE</span>

<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (shouldSkipAnimation) {</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">            likeFacesRecycler.itemAnimator = null</span>
<span class="nc bnc" id="L679" title="All 4 branches missed.">        } else if (likeFacesRecycler.itemAnimator == null) {</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">            likeFacesRecycler.itemAnimator = DefaultItemAnimator()</span>
        }

<span class="nc bnc" id="L683" title="All 4 branches missed.">        var adapter = likeFacesRecycler.adapter as? TrainOfAvatarsAdapter</span>

<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (adapter == null) {</span>
<span class="nc" id="L686">            adapter = TrainOfAvatarsAdapter(</span>
<span class="nc" id="L687">                    imageManager,</span>
<span class="nc" id="L688">                    uiHelpers</span>
            )

<span class="nc bnc" id="L691" title="All 2 branches missed.">            likeFacesRecycler.adapter = adapter</span>
        }

<span class="nc bnc" id="L694" title="All 4 branches missed.">        val recyclerViewState = likeFacesRecycler.layoutManager?.onSaveInstanceState()</span>
<span class="nc" id="L695">        adapter.loadData(items)</span>
<span class="nc bnc" id="L696" title="All 4 branches missed.">        likeFacesRecycler.layoutManager?.onRestoreInstanceState(recyclerViewState)</span>
<span class="nc" id="L697">    }</span>

    private fun renderUiState(state: ReaderPostDetailsUiState, binding: ReaderFragmentPostDetailBinding) {
<span class="nc" id="L700">        onPostExecuteShowPost()</span>
<span class="nc" id="L701">        binding.headerView.updatePost(state.headerUiState)</span>
<span class="nc" id="L702">        showOrHideMoreMenu(state)</span>

<span class="nc" id="L704">        updateFeaturedImage(state.featuredImageUiState, binding)</span>
<span class="nc" id="L705">        updateExcerptFooter(state.excerptFooterUiState)</span>

<span class="nc" id="L707">        with(binding.layoutPostDetailFooter) {</span>
<span class="nc" id="L708">            updateActionButton(state.postId, state.blogId, state.actions.likeAction, countLikes)</span>
<span class="nc" id="L709">            updateActionButton(state.postId, state.blogId, state.actions.reblogAction, reblog)</span>
<span class="nc" id="L710">            updateActionButton(state.postId, state.blogId, state.actions.commentsAction, countComments)</span>
<span class="nc" id="L711">            updateActionButton(state.postId, state.blogId, state.actions.bookmarkAction, bookmark)</span>
<span class="nc" id="L712">        }</span>

<span class="nc bnc" id="L714" title="All 2 branches missed.">        state.localRelatedPosts?.let { showRelatedPosts(it) }</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">        state.globalRelatedPosts?.let { showRelatedPosts(it) }</span>
<span class="nc" id="L716">    }</span>

    // TODO: Update using UiState/ NavigationEvent
    private fun onPostExecuteShowPost() {
        // make sure options menu reflects whether we now have a post
<span class="nc bnc" id="L721" title="All 2 branches missed.">        activity?.invalidateOptionsMenu()</span>

<span class="nc bnc" id="L723" title="All 4 branches missed.">        viewModel.post?.let {</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">            if (handleDirectOperation()) return</span>

<span class="nc bnc" id="L726" title="All 2 branches missed.">            scrollView.visibility = View.VISIBLE</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">            layoutFooter.visibility = View.VISIBLE</span>
<span class="nc" id="L728">        }</span>
<span class="nc" id="L729">    }</span>

    private fun ReaderNavigationEvents.handleNavigationEvent() {
<span class="nc" id="L732">        when (this) {</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowMediaPreview -&gt; MediaPreviewActivity</span>
<span class="nc" id="L734">                    .showPreview(requireContext(), site, featuredImage)</span>

<span class="nc bnc" id="L736" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowPostsByTag -&gt; ReaderActivityLauncher.showReaderTagPreview(</span>
<span class="nc" id="L737">                    context,</span>
<span class="nc" id="L738">                    this.tag,</span>
<span class="nc" id="L739">                    ReaderTracker.SOURCE_POST_DETAIL,</span>
<span class="nc" id="L740">                    readerTracker</span>
            )

<span class="nc bnc" id="L743" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowBlogPreview -&gt; ReaderActivityLauncher.showReaderBlogOrFeedPreview(</span>
<span class="nc" id="L744">                    context,</span>
<span class="nc" id="L745">                    this.siteId,</span>
<span class="nc" id="L746">                    this.feedId,</span>
<span class="nc" id="L747">                    this.isFollowed,</span>
<span class="nc" id="L748">                    ReaderTracker.SOURCE_POST_DETAIL,</span>
<span class="nc" id="L749">                    readerTracker</span>
            )

<span class="nc bnc" id="L752" title="All 2 branches missed.">            is ReaderNavigationEvents.SharePost -&gt; ReaderActivityLauncher.sharePost(context, post)</span>

<span class="nc bnc" id="L754" title="All 2 branches missed.">            is ReaderNavigationEvents.OpenPost -&gt; ReaderActivityLauncher.openPost(context, post)</span>

<span class="nc bnc" id="L756" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowReportPost -&gt;</span>
<span class="nc" id="L757">                ReaderActivityLauncher.openUrl(context, readerUtilsWrapper.getReportPostUrl(url), OpenUrlType.INTERNAL)</span>

<span class="nc bnc" id="L759" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowReaderComments -&gt; ReaderActivityLauncher.showReaderCommentsForResult(</span>
<span class="nc" id="L760">                    this@ReaderPostDetailFragment,</span>
<span class="nc" id="L761">                    blogId,</span>
<span class="nc" id="L762">                    postId,</span>
<span class="nc" id="L763">                    this.source.sourceDescription</span>
            )

<span class="nc bnc" id="L766" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowNoSitesToReblog -&gt; ReaderActivityLauncher.showNoSiteToReblog(activity)</span>

<span class="nc bnc" id="L768" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowSitePickerForResult -&gt;</span>
                ActivityLauncher
<span class="nc" id="L770">                        .showSitePickerForResult(this@ReaderPostDetailFragment, this.preselectedSite, this.mode)</span>

<span class="nc bnc" id="L772" title="All 2 branches missed.">            is ReaderNavigationEvents.OpenEditorForReblog -&gt;</span>
<span class="nc" id="L773">                ActivityLauncher.openEditorForReblog(activity, this.site, this.post, this.source)</span>

<span class="nc bnc" id="L775" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowBookmarkedTab -&gt; ActivityLauncher.viewSavedPostsListInReader(activity)</span>

<span class="nc bnc" id="L777" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowBookmarkedSavedOnlyLocallyDialog -&gt; showBookmarkSavedLocallyDialog(this)</span>

<span class="nc bnc" id="L779" title="All 2 branches missed.">            is ReaderNavigationEvents.OpenUrl -&gt; ReaderActivityLauncher.openUrl(requireContext(), url)</span>

<span class="nc bnc" id="L781" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowRelatedPostDetails -&gt;</span>
<span class="nc" id="L782">                showRelatedPostDetail(postId = this.postId, blogId = this.blogId)</span>

<span class="nc bnc" id="L784" title="All 2 branches missed.">            is ReaderNavigationEvents.ReplaceRelatedPostDetailsWithHistory -&gt;</span>
<span class="nc" id="L785">                replaceRelatedPostDetailWithHistory(postId = this.postId, blogId = this.blogId)</span>

<span class="nc bnc" id="L787" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowPostInWebView -&gt; showPostInWebView(post)</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowEngagedPeopleList -&gt; {</span>
<span class="nc" id="L789">                ActivityLauncher.viewPostLikesListActivity(</span>
<span class="nc" id="L790">                        activity,</span>
<span class="nc" id="L791">                        this.siteId,</span>
<span class="nc" id="L792">                        this.postId,</span>
<span class="nc" id="L793">                        this.headerData,</span>
<span class="nc" id="L794">                        EngagementNavigationSource.LIKE_READER_LIST</span>
                )
            }
<span class="nc bnc" id="L797" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowPostDetail,</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowVideoViewer,</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">            is ReaderNavigationEvents.ShowReaderSubs -&gt; Unit // Do Nothing</span>
        }
<span class="nc" id="L801">    }</span>

    private fun updateFeaturedImage(
        state: ReaderPostDetailsUiState.ReaderPostFeaturedImageUiState?,
        binding: ReaderFragmentPostDetailBinding
    ) {
<span class="nc" id="L807">        val featuredImage = binding.appbarWithCollapsingToolbarLayout.featuredImage</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">        featuredImage.setVisible(state != null)</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">        state?.let {</span>
<span class="nc" id="L810">            featuredImage.layoutParams.height = it.height</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">            it.url?.let { url -&gt;</span>
<span class="nc" id="L812">                imageManager.load(featuredImage, PHOTO, url, CENTER_CROP)</span>
<span class="nc" id="L813">                featuredImage.setOnClickListener {</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">                    viewModel.onFeaturedImageClicked(blogId = state.blogId, featuredImageUrl = url)</span>
<span class="nc" id="L815">                }</span>
<span class="nc" id="L816">            }</span>
        }
<span class="nc" id="L818">    }</span>

    private fun updateExcerptFooter(state: ReaderPostDetailsUiState.ExcerptFooterUiState?) {
        // if we're showing just the excerpt, show a footer which links to the full post
<span class="nc bnc" id="L822" title="All 4 branches missed.">        excerptFooter.setVisible(state != null)</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">        state?.let {</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">            uiHelpers.setTextOrHide(textExcerptFooter, state.visitPostExcerptFooterLinkText)</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">            textExcerptFooter.setOnClickListener {</span>
<span class="nc bnc" id="L826" title="All 4 branches missed.">                state.postLink?.let { link -&gt; viewModel.onVisitPostExcerptFooterClicked(postLink = link) }</span>
<span class="nc" id="L827">            }</span>
<span class="nc" id="L828">        }</span>
<span class="nc" id="L829">    }</span>

    private fun updateActionButton(postId: Long, blogId: Long, state: PrimaryAction, view: View) {
<span class="nc bnc" id="L832" title="All 2 branches missed.">        if (view is ReaderIconCountView) {</span>
<span class="nc" id="L833">            view.setCount(state.count)</span>
        }
<span class="nc" id="L835">        view.isEnabled = state.isEnabled</span>
<span class="nc" id="L836">        view.isSelected = state.isSelected</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">        view.contentDescription = state.contentDescription?.let { uiHelpers.getTextOfUiString(view.context, it) }</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">        view.setOnClickListener { state.onClicked?.invoke(postId, blogId, state.type) }</span>
<span class="nc" id="L839">    }</span>

    private fun showBookmarkSavedLocallyDialog(
        bookmarkDialog: ReaderNavigationEvents.ShowBookmarkedSavedOnlyLocallyDialog
    ) {
<span class="nc bnc" id="L844" title="All 2 branches missed.">        if (bookmarksSavedLocallyDialog == null) {</span>
<span class="nc" id="L845">            MaterialAlertDialogBuilder(requireActivity())</span>
<span class="nc" id="L846">                    .setTitle(getString(bookmarkDialog.title))</span>
<span class="nc" id="L847">                    .setMessage(getString(bookmarkDialog.message))</span>
<span class="nc" id="L848">                    .setPositiveButton(getString(bookmarkDialog.buttonLabel)) { _, _ -&gt;</span>
<span class="nc" id="L849">                        bookmarkDialog.okButtonAction.invoke()</span>
<span class="nc" id="L850">                    }</span>
<span class="nc" id="L851">                    .setOnDismissListener {</span>
<span class="nc" id="L852">                        bookmarksSavedLocallyDialog = null</span>
<span class="nc" id="L853">                    }</span>
<span class="nc" id="L854">                    .setCancelable(false)</span>
<span class="nc" id="L855">                    .create()</span>
<span class="nc" id="L856">                    .let {</span>
<span class="nc" id="L857">                        bookmarksSavedLocallyDialog = it</span>
<span class="nc" id="L858">                        it.show()</span>
<span class="nc" id="L859">                    }</span>
        }
<span class="nc" id="L861">    }</span>

    private fun showOrHideMoreMenu(
        state: ReaderPostDetailsUiState
    ) {
<span class="nc bnc" id="L866" title="All 2 branches missed.">        val moreMenu: View? = toolBar.findViewById(R.id.menu_more)</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">        moreMenu?.let {</span>
<span class="nc bnc" id="L868" title="All 4 branches missed.">            state.moreMenuItems?.let {</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">                if (moreMenuPopup == null) {</span>
<span class="nc" id="L870">                    createMoreMenuPopup(it, moreMenu)</span>
                }
<span class="nc bnc" id="L872" title="All 2 branches missed.">                moreMenuPopup?.show()</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">            } ?: moreMenuPopup?.dismiss()</span>
        }
<span class="nc" id="L875">    }</span>

    private fun createMoreMenuPopup(actions: List&lt;ReaderPostCardAction&gt;, v: View) {
<span class="nc" id="L878">        readerTracker.track(AnalyticsTracker.Stat.READER_ARTICLE_DETAIL_MORE_TAPPED)</span>
<span class="nc" id="L879">        moreMenuPopup = ListPopupWindow(v.context)</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">        moreMenuPopup?.let {</span>
<span class="nc" id="L881">            it.width = v.context.resources.getDimensionPixelSize(R.dimen.menu_item_width)</span>
<span class="nc" id="L882">            it.setAdapter(ReaderMenuAdapter(v.context, uiHelpers, actions))</span>
<span class="nc" id="L883">            it.setDropDownGravity(Gravity.END)</span>
<span class="nc" id="L884">            it.anchorView = v</span>
<span class="nc" id="L885">            it.isModal = true</span>
<span class="nc" id="L886">            it.setOnItemClickListener { _, _, position, _ -&gt;</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">                viewModel.onMoreMenuItemClicked(actions[position].type)</span>
<span class="nc" id="L888">            }</span>
<span class="nc" id="L889">            it.setOnDismissListener {</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">                viewModel.onMoreMenuDismissed()</span>
<span class="nc" id="L891">                moreMenuPopup = null</span>
<span class="nc" id="L892">            }</span>
<span class="nc" id="L893">        }</span>
<span class="nc" id="L894">    }</span>

    private fun SnackbarMessageHolder.showSnackbar(binding: ReaderFragmentPostDetailBinding) {
<span class="nc" id="L897">        val snackbar = WPSnackbar.make(</span>
<span class="nc" id="L898">                binding.layoutPostDetailContainer,</span>
<span class="nc" id="L899">                uiHelpers.getTextOfUiString(requireContext(), this.message),</span>
<span class="nc" id="L900">                Snackbar.LENGTH_LONG</span>
        )
<span class="nc bnc" id="L902" title="All 2 branches missed.">        if (this.buttonTitle != null) {</span>
<span class="nc" id="L903">            snackbar.setAction(uiHelpers.getTextOfUiString(requireContext(), this.buttonTitle)) {</span>
<span class="nc" id="L904">                this.buttonAction.invoke()</span>
<span class="nc" id="L905">            }</span>
        }
<span class="nc" id="L907">        snackbar.show()</span>
<span class="nc" id="L908">    }</span>

    override fun onDestroy() {
<span class="nc" id="L911">        super.onDestroy()</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">        if (view != null) {</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">            readerWebView.destroy()</span>
        }
<span class="nc bnc" id="L915" title="All 2 branches missed.">        bookmarksSavedLocallyDialog?.dismiss()</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">        moreMenuPopup?.dismiss()</span>
<span class="nc" id="L917">    }</span>

    override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
<span class="nc" id="L920">        super.onCreateOptionsMenu(menu, inflater)</span>
<span class="nc" id="L921">        menu.clear()</span>
<span class="nc" id="L922">        inflater.inflate(R.menu.reader_detail, menu)</span>
<span class="nc" id="L923">    }</span>

    override fun onPrepareOptionsMenu(menu: Menu) {
<span class="nc" id="L926">        super.onPrepareOptionsMenu(menu)</span>

        // browse &amp; share require the post to have a URL (some feed-based posts don't have one)
<span class="nc bnc" id="L929" title="All 6 branches missed.">        val postHasUrl = viewModel.post?.hasUrl() == true</span>
<span class="nc" id="L930">        val mnuBrowse = menu.findItem(R.id.menu_browse)</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">        if (mnuBrowse != null) {</span>
<span class="nc bnc" id="L932" title="All 6 branches missed.">            mnuBrowse.isVisible = postHasUrl || viewModel.interceptedUri != null</span>
        }
<span class="nc" id="L934">        val mnuShare = menu.findItem(R.id.menu_share)</span>
<span class="nc bnc" id="L935" title="All 2 branches missed.">        if (mnuShare != null) {</span>
<span class="nc" id="L936">            mnuShare.isVisible = postHasUrl</span>
        }
<span class="nc" id="L938">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L941" title="All 4 branches missed.">        when (item.itemId) {</span>
            R.id.menu_browse -&gt; {
<span class="nc bnc" id="L943" title="All 4 branches missed.">                if (viewModel.hasPost) {</span>
<span class="nc" id="L944">                    readerTracker.track(AnalyticsTracker.Stat.READER_ARTICLE_VISITED)</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">                    ReaderActivityLauncher.openPost(context, viewModel.post)</span>
<span class="nc bnc" id="L946" title="All 4 branches missed.">                } else if (viewModel.interceptedUri != null) {</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">                    readerTracker.trackUri(AnalyticsTracker.Stat.DEEP_LINKED_FALLBACK, viewModel.interceptedUri!!)</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">                    ReaderActivityLauncher.openUrl(activity, viewModel.interceptedUri, OpenUrlType.EXTERNAL)</span>
<span class="nc" id="L949">                    requireActivity().finish()</span>
                }
<span class="nc" id="L951">                return true</span>
            }
            R.id.menu_share -&gt; {
<span class="nc" id="L954">                readerTracker.track(AnalyticsTracker.Stat.SHARED_ITEM)</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">                ReaderActivityLauncher.sharePost(context, viewModel.post)</span>
<span class="nc" id="L956">                return true</span>
            }
            R.id.menu_more -&gt; {
<span class="nc bnc" id="L959" title="All 2 branches missed.">                viewModel.onMoreButtonClicked()</span>
<span class="nc" id="L960">                return true</span>
            }
<span class="nc" id="L962">            else -&gt; return super.onOptionsItemSelected(item)</span>
        }
    }

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc bnc" id="L967" title="All 2 branches missed.">        outState.putBoolean(ReaderConstants.ARG_IS_FEED, viewModel.isFeed)</span>
<span class="nc" id="L968">        outState.putLong(ReaderConstants.ARG_BLOG_ID, blogId)</span>
<span class="nc" id="L969">        outState.putLong(ReaderConstants.ARG_POST_ID, postId)</span>
<span class="nc" id="L970">        outState.putSerializable(ReaderConstants.ARG_DIRECT_OPERATION, directOperation)</span>
<span class="nc" id="L971">        outState.putInt(ReaderConstants.ARG_COMMENT_ID, commentId)</span>

<span class="nc" id="L973">        outState.putBoolean(ReaderConstants.ARG_IS_RELATED_POST, isRelatedPost)</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">        outState.putString(ReaderConstants.ARG_INTERCEPTED_URI, viewModel.interceptedUri)</span>
<span class="nc" id="L975">        outState.putBoolean(</span>
<span class="nc" id="L976">                ReaderConstants.KEY_POST_SLUGS_RESOLUTION_UNDERWAY,</span>
<span class="nc" id="L977">                postSlugsResolutionUnderway</span>
        )
<span class="nc" id="L979">        outState.putBoolean(ReaderConstants.KEY_ALREADY_UPDATED, hasAlreadyUpdatedPost)</span>

<span class="nc" id="L981">        outState.putBoolean(</span>
<span class="nc" id="L982">                ReaderConstants.KEY_ALREADY_TRACKED_GLOBAL_RELATED_POSTS,</span>
<span class="nc" id="L983">                hasTrackedGlobalRelatedPosts</span>
        )
<span class="nc" id="L985">        outState.putBoolean(</span>
<span class="nc" id="L986">                ReaderConstants.KEY_ALREADY_TRACKED_LOCAL_RELATED_POSTS,</span>
<span class="nc" id="L987">                hasTrackedLocalRelatedPosts</span>
        )

<span class="nc" id="L990">        outState.putSerializable(</span>
<span class="nc" id="L991">                ReaderConstants.ARG_POST_LIST_TYPE,</span>
<span class="nc" id="L992">                this.postListType</span>
        )

<span class="nc" id="L995">        postHistory.saveInstance(outState)</span>

<span class="nc bnc" id="L997" title="All 6 branches missed.">        if (!errorMessage.isNullOrEmpty()) {</span>
<span class="nc" id="L998">            outState.putString(ReaderConstants.KEY_ERROR_MESSAGE, errorMessage)</span>
        }

<span class="nc bnc" id="L1001" title="All 2 branches missed.">        if (commentsSnippetFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L1002" title="All 4 branches missed.">            commentSnippetRecycler?.layoutManager?.let {</span>
<span class="nc" id="L1003">                outState.putParcelable(KEY_COMMENTS_SNIPPET_LIST_STATE, it.onSaveInstanceState())</span>
<span class="nc" id="L1004">            }</span>
        }

<span class="nc" id="L1007">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L1008">    }</span>

    private fun restoreState(savedInstanceState: Bundle?) {
<span class="nc bnc" id="L1011" title="All 2 branches missed.">        savedInstanceState?.let {</span>
<span class="nc" id="L1012">            blogId = it.getLong(ReaderConstants.ARG_BLOG_ID)</span>
<span class="nc" id="L1013">            postId = it.getLong(ReaderConstants.ARG_POST_ID)</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">            directOperation = it</span>
<span class="nc" id="L1015">                    .getSerializable(ReaderConstants.ARG_DIRECT_OPERATION) as? DirectOperation</span>
<span class="nc" id="L1016">            commentId = it.getInt(ReaderConstants.ARG_COMMENT_ID)</span>
<span class="nc" id="L1017">            isRelatedPost = it.getBoolean(ReaderConstants.ARG_IS_RELATED_POST)</span>
<span class="nc" id="L1018">            interceptedUri = it.getString(ReaderConstants.ARG_INTERCEPTED_URI)</span>
<span class="nc" id="L1019">            postSlugsResolutionUnderway = it.getBoolean(ReaderConstants.KEY_POST_SLUGS_RESOLUTION_UNDERWAY)</span>
<span class="nc" id="L1020">            hasAlreadyUpdatedPost = it.getBoolean(ReaderConstants.KEY_ALREADY_UPDATED)</span>
<span class="nc" id="L1021">            hasTrackedGlobalRelatedPosts = it.getBoolean(ReaderConstants.KEY_ALREADY_TRACKED_GLOBAL_RELATED_POSTS)</span>
<span class="nc" id="L1022">            hasTrackedLocalRelatedPosts = it.getBoolean(ReaderConstants.KEY_ALREADY_TRACKED_LOCAL_RELATED_POSTS)</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">            if (it.containsKey(ReaderConstants.ARG_POST_LIST_TYPE)) {</span>
<span class="nc bnc" id="L1024" title="All 2 branches missed.">                this.postListType = it.getSerializable(ReaderConstants.ARG_POST_LIST_TYPE) as ReaderPostListType</span>
            }
<span class="nc bnc" id="L1026" title="All 2 branches missed.">            if (it.containsKey(ReaderConstants.KEY_ERROR_MESSAGE)) {</span>
<span class="nc" id="L1027">                errorMessage = it.getString(ReaderConstants.KEY_ERROR_MESSAGE)</span>
            }
<span class="nc" id="L1029">        }</span>
<span class="nc" id="L1030">    }</span>

    override fun onStart() {
<span class="nc" id="L1033">        super.onStart()</span>
<span class="nc" id="L1034">        dispatcher.register(this)</span>
<span class="nc" id="L1035">        EventBus.getDefault().register(this)</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">        activity?.registerReceiver(</span>
<span class="nc" id="L1037">                readerFileDownloadManager,</span>
<span class="nc" id="L1038">                IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE)</span>
        )
<span class="nc" id="L1040">    }</span>

    override fun onStop() {
<span class="nc" id="L1043">        super.onStop()</span>
<span class="nc" id="L1044">        dispatcher.unregister(this)</span>
<span class="nc" id="L1045">        EventBus.getDefault().unregister(this)</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">        activity?.unregisterReceiver(readerFileDownloadManager)</span>
<span class="nc" id="L1047">    }</span>

    /*
     * called by the activity when user hits the back button - returns true if the back button
     * is handled here and should be ignored by the activity
     */
    override fun onActivityBackPressed(): Boolean {
<span class="nc" id="L1054">        return goBackInPostHistory()</span>
    }

    /*
     * replace the current post with the passed one
     */
    private fun replacePost(blogId: Long, postId: Long, clearCommentOperation: Boolean) {
<span class="nc bnc" id="L1061" title="All 2 branches missed.">        viewModel.isFeed = false</span>
<span class="nc" id="L1062">        this.blogId = blogId</span>
<span class="nc" id="L1063">        this.postId = postId</span>

<span class="nc bnc" id="L1065" title="All 2 branches missed.">        if (clearCommentOperation) {</span>
<span class="nc" id="L1066">            directOperation = null</span>
<span class="nc" id="L1067">            commentId = 0</span>
        }

<span class="nc" id="L1070">        hasAlreadyUpdatedPost = false</span>
<span class="nc" id="L1071">        hasTrackedGlobalRelatedPosts = false</span>
<span class="nc" id="L1072">        hasTrackedLocalRelatedPosts = false</span>

        // hide views that would show info for the previous post - these will be re-displayed
        // with the correct info once the new post loads
<span class="nc bnc" id="L1076" title="All 2 branches missed.">        globalRelatedPostsView.visibility = View.GONE</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">        localRelatedPostsView.visibility = View.GONE</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">        if (likesEnhancementsFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">            likeFacesTrain.visibility = View.GONE</span>
        }
<span class="nc bnc" id="L1081" title="All 2 branches missed.">        if (commentsSnippetFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">            commentsSnippetContainer.visibility = View.GONE</span>
        }

        // clear the webView - otherwise it will remain scrolled to where the user scrolled to
<span class="nc bnc" id="L1086" title="All 2 branches missed.">        readerWebView.clearContent()</span>

        // now show the passed post
<span class="nc" id="L1089">        showPost()</span>
<span class="nc" id="L1090">    }</span>

    /*
     * show the passed list of related posts - can be either global (related posts from
     * across wp.com) or local (related posts from the same site as the current post)
     */
    private fun showRelatedPosts(state: ReaderPostDetailsUiState.RelatedPostsUiState) {
        // different container views for global/local related posts
<span class="nc bnc" id="L1098" title="All 6 branches missed.">        val relatedPostsView = if (state.isGlobal) globalRelatedPostsView else localRelatedPostsView</span>
<span class="nc" id="L1099">        relatedPostsView.showPosts(state)</span>

        // fade in this related posts view
<span class="nc bnc" id="L1102" title="All 2 branches missed.">        if (relatedPostsView.visibility != View.VISIBLE) {</span>
<span class="nc" id="L1103">            AniUtils.fadeIn(relatedPostsView, AniUtils.Duration.MEDIUM)</span>
        }

<span class="nc" id="L1106">        trackRelatedPostsIfShowing()</span>
<span class="nc" id="L1107">    }</span>

    /*
     * track that related posts have loaded and are scrolled into view if we haven't
     * already tracked it
     */
    private fun trackRelatedPostsIfShowing() {
<span class="nc bnc" id="L1114" title="All 6 branches missed.">        if (!hasTrackedGlobalRelatedPosts &amp;&amp; isVisibleAndScrolledIntoView(globalRelatedPostsView)) {</span>
<span class="nc" id="L1115">            hasTrackedGlobalRelatedPosts = true</span>
<span class="nc" id="L1116">            AppLog.d(T.READER, &quot;reader post detail &gt; global related posts rendered&quot;)</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">            globalRelatedPostsView.trackRailcarRender()</span>
        }

<span class="nc bnc" id="L1120" title="All 6 branches missed.">        if (!hasTrackedLocalRelatedPosts &amp;&amp; isVisibleAndScrolledIntoView(localRelatedPostsView)) {</span>
<span class="nc" id="L1121">            hasTrackedLocalRelatedPosts = true</span>
<span class="nc" id="L1122">            AppLog.d(T.READER, &quot;reader post detail &gt; local related posts rendered&quot;)</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">            localRelatedPostsView.trackRailcarRender()</span>
        }
<span class="nc" id="L1125">    }</span>

    /*
     * returns True if the passed view is visible and has been scrolled into view - assumes
     * that the view is a child of mScrollView
     */
    private fun isVisibleAndScrolledIntoView(view: View?): Boolean {
<span class="nc bnc" id="L1132" title="All 4 branches missed.">        if (view != null &amp;&amp; view.visibility == View.VISIBLE) {</span>
<span class="nc" id="L1133">            val scrollBounds = Rect()</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">            scrollView.getHitRect(scrollBounds)</span>
<span class="nc" id="L1135">            return view.getLocalVisibleRect(scrollBounds)</span>
        }
<span class="nc" id="L1137">        return false</span>
    }

    private fun showRelatedPostDetail(postId: Long, blogId: Long) {
<span class="nc" id="L1141">        ReaderActivityLauncher.showReaderPostDetail(</span>
<span class="nc" id="L1142">                activity,</span>
<span class="nc" id="L1143">                false,</span>
<span class="nc" id="L1144">                blogId,</span>
<span class="nc" id="L1145">                postId, null,</span>
<span class="nc" id="L1146">                0,</span>
<span class="nc" id="L1147">                true, null</span>
        )
<span class="nc" id="L1149">    }</span>

    private fun replaceRelatedPostDetailWithHistory(postId: Long, blogId: Long) {
<span class="nc bnc" id="L1152" title="All 4 branches missed.">        viewModel.post?.let {</span>
<span class="nc" id="L1153">            postHistory.push(ReaderBlogIdPostId(it.blogId, it.postId))</span>
<span class="nc" id="L1154">            replacePost(blogId, postId, true)</span>
<span class="nc" id="L1155">        }</span>
<span class="nc" id="L1156">    }</span>

    /*
     * if the fragment is maintaining a backstack of posts, navigate to the previous one
     */
    fun goBackInPostHistory(): Boolean {
<span class="nc bnc" id="L1162" title="All 2 branches missed.">        return if (!postHistory.isEmpty()) {</span>
<span class="nc" id="L1163">            val ids = postHistory.pop()</span>
<span class="nc" id="L1164">            replacePost(ids.blogId, ids.postId, true)</span>
<span class="nc" id="L1165">            true</span>
        } else {
<span class="nc" id="L1167">            false</span>
        }
    }

    /*
     * get the latest version of this post
     */
    private fun updatePost() {
<span class="nc bnc" id="L1175" title="All 12 branches missed.">        if (!viewModel.hasPost || viewModel.post?.isWP == false) {</span>
<span class="nc" id="L1176">            setRefreshing(false)</span>
<span class="nc" id="L1177">            return</span>
        }

<span class="nc" id="L1180">        val resultListener = ReaderActions.UpdateResultListener { result -&gt;</span>
<span class="nc bnc" id="L1181" title="All 2 branches missed.">            val post = viewModel.post</span>
<span class="nc bnc" id="L1182" title="All 4 branches missed.">            if (isAdded &amp;&amp; post != null) {</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">                if (commentsSnippetFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">                    conversationViewModel.onUpdatePost(post.blogId, post.postId)</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">                    viewModel.onRefreshCommentsData(post.blogId, post.postId)</span>
                }

                // if the post has changed, reload it from the db and update the like/comment counts
<span class="nc bnc" id="L1189" title="All 2 branches missed.">                if (result.isNewOrChanged) {</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">                    viewModel.post = ReaderPostTable.getBlogPost(post.blogId, post.postId, false)</span>
<span class="nc bnc" id="L1191" title="All 4 branches missed.">                    viewModel.post?.let {</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">                        if (likesEnhancementsFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">                            viewModel.onRefreshLikersData(it)</span>
                        }
<span class="nc bnc" id="L1195" title="All 2 branches missed.">                        viewModel.onUpdatePost(it)</span>
<span class="nc" id="L1196">                    }</span>
                }

<span class="nc" id="L1199">                setRefreshing(false)</span>

<span class="nc bnc" id="L1201" title="All 4 branches missed.">                if (directOperation != null &amp;&amp; directOperation == DirectOperation.POST_LIKE) {</span>
<span class="nc" id="L1202">                    doLikePost()</span>
                }
            }
<span class="nc" id="L1205">        }</span>
<span class="nc bnc" id="L1206" title="All 4 branches missed.">        viewModel.post?.let { ReaderPostActions.updatePost(it, resultListener) }</span>
<span class="nc" id="L1207">    }</span>

    private fun doLikePost() {
<span class="nc bnc" id="L1210" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L1211">            return</span>
        }

<span class="nc bnc" id="L1214" title="All 2 branches missed.">        if (!accountStore.hasAccessToken()) {</span>
<span class="nc" id="L1215">            WPSnackbar.make(</span>
<span class="nc" id="L1216">                    requireView(), R.string.reader_snackbar_err_cannot_like_post_logged_out,</span>
<span class="nc" id="L1217">                    Snackbar.LENGTH_INDEFINITE</span>
<span class="nc" id="L1218">            ).setAction(R.string.sign_in, mSignInClickListener).show()</span>
<span class="nc" id="L1219">            return</span>
        }

<span class="nc bnc" id="L1222" title="All 4 branches missed.">        viewModel.post?.let {</span>
<span class="nc bnc" id="L1223" title="All 2 branches missed.">            if (!it.canLikePost()) {</span>
<span class="nc" id="L1224">                ToastUtils.showToast(activity, R.string.reader_toast_err_cannot_like_post)</span>
<span class="nc" id="L1225">                return</span>
            }

<span class="nc bnc" id="L1228" title="All 2 branches missed.">            if (!it.isLikedByCurrentUser) {</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">                viewModel.onButtonClicked(it.postId, it.blogId, ReaderPostCardActionType.LIKE)</span>
            }
<span class="nc" id="L1231">        }</span>
<span class="nc" id="L1232">    }</span>

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
<span class="nc" id="L1235">        super.onActivityResult(requestCode, resultCode, data)</span>
<span class="nc bnc" id="L1236" title="All 3 branches missed.">        when (requestCode) {</span>
            RequestCodes.SITE_PICKER -&gt; {
<span class="nc bnc" id="L1238" title="All 2 branches missed.">                if (resultCode == Activity.RESULT_OK) {</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">                    val siteLocalId = data?.getIntExtra(</span>
<span class="nc" id="L1240">                            SitePickerActivity.KEY_SITE_LOCAL_ID,</span>
<span class="nc" id="L1241">                            SelectedSiteRepository.UNAVAILABLE</span>
<span class="nc" id="L1242">                    ) ?: SelectedSiteRepository.UNAVAILABLE</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">                    viewModel.onReblogSiteSelected(siteLocalId)</span>
                }
            }
            RequestCodes.READER_FOLLOW_CONVERSATION -&gt; {
<span class="nc bnc" id="L1247" title="All 6 branches missed.">                if (resultCode == Activity.RESULT_OK &amp;&amp; commentsSnippetFeatureConfig.isEnabled() &amp;&amp; data != null) {</span>
<span class="nc" id="L1248">                    val flags = data.getParcelableExtra&lt;FollowConversationStatusFlags&gt;(</span>
<span class="nc" id="L1249">                            FOLLOW_CONVERSATION_UI_STATE_FLAGS_KEY</span>
                    )
<span class="nc bnc" id="L1251" title="All 2 branches missed.">                    flags?.let {</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">                        conversationViewModel.onUserNavigateFromComments(it)</span>
<span class="nc" id="L1253">                    }</span>
                }
<span class="nc bnc" id="L1255" title="All 2 branches missed.">                viewModel.onUserNavigateFromComments()</span>
            }
        }
<span class="nc" id="L1258">    }</span>

    private fun showPhotoViewer(
        imageUrl: String,
        sourceView: View,
        startX: Int,
        startY: Int
    ): Boolean {
<span class="nc bnc" id="L1266" title="All 6 branches missed.">        if (!isAdded || imageUrl.isEmpty()) {</span>
<span class="nc" id="L1267">            return false</span>
        }

        // make sure this is a valid web image (could be file: or data:)
<span class="nc bnc" id="L1271" title="All 2 branches missed.">        if (!imageUrl.startsWith(&quot;http&quot;)) {</span>
<span class="nc" id="L1272">            return false</span>
        }

<span class="nc bnc" id="L1275" title="All 4 branches missed.">        val postContent = viewModel.post?.text</span>
<span class="nc bnc" id="L1276" title="All 6 branches missed.">        val isPrivatePost = viewModel.post?.isPrivate == true</span>
<span class="nc" id="L1277">        val options = EnumSet.noneOf(PhotoViewerOption::class.java)</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">        if (isPrivatePost) {</span>
<span class="nc" id="L1279">            options.add(PhotoViewerOption.IS_PRIVATE_IMAGE)</span>
        }

<span class="nc" id="L1282">        ReaderActivityLauncher.showReaderPhotoViewer(</span>
<span class="nc" id="L1283">                activity,</span>
<span class="nc" id="L1284">                imageUrl,</span>
<span class="nc" id="L1285">                postContent,</span>
<span class="nc" id="L1286">                sourceView,</span>
<span class="nc" id="L1287">                options,</span>
<span class="nc" id="L1288">                startX,</span>
<span class="nc" id="L1289">                startY</span>
        )

<span class="nc" id="L1292">        return true</span>
    }

    /*
     * post slugs resolution to IDs has completed
     */
    @Subscribe(threadMode = ThreadMode.MAIN)
    fun onEventMainThread(event: ReaderEvents.PostSlugsRequestCompleted) {
<span class="nc" id="L1300">        postSlugsResolutionUnderway = false</span>

<span class="nc bnc" id="L1302" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L1303">            return</span>
        }

<span class="nc" id="L1306">        val progress = requireView().findViewById&lt;ProgressBar&gt;(R.id.progress_loading)</span>
<span class="nc" id="L1307">        progress.visibility = View.GONE</span>

<span class="nc bnc" id="L1309" title="All 2 branches missed.">        if (event.statusCode == HttpURLConnection.HTTP_OK) {</span>
<span class="nc" id="L1310">            replacePost(event.blogId, event.postId, false)</span>
        } else {
<span class="nc" id="L1312">            onRequestFailure(event.statusCode)</span>
        }
<span class="nc" id="L1314">    }</span>

    private fun onRequestFailure(statusCode: Int) {
<span class="nc bnc" id="L1317" title="All 2 branches missed.">        if (!NetworkUtils.isNetworkAvailable(activity)) {</span>
<span class="nc" id="L1318">            showError(getString(R.string.no_network_message))</span>
        } else {
<span class="nc bnc" id="L1320" title="All 3 branches missed.">            when (statusCode) {</span>
                HttpURLConnection.HTTP_UNAUTHORIZED, HttpURLConnection.HTTP_FORBIDDEN -&gt;
<span class="nc bnc" id="L1322" title="All 2 branches missed.">                    viewModel.onNotAuthorisedRequestFailure()</span>

<span class="nc" id="L1324">                HttpURLConnection.HTTP_NOT_FOUND -&gt; showError(getString(R.string.reader_err_get_post_not_found))</span>
<span class="nc" id="L1325">                else -&gt; showError(getString(R.string.reader_err_get_post_generic))</span>
            }
        }
<span class="nc" id="L1328">    }</span>

    /*
     * shows an error message in the middle of the screen - used when requesting post fails
     */
    private fun showError(errorMessage: String?) {
<span class="nc bnc" id="L1334" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L1335">            return</span>
        }

<span class="nc" id="L1338">        val txtError = requireView().findViewById&lt;TextView&gt;(R.id.text_error)</span>
<span class="nc" id="L1339">        txtError.text = errorMessage</span>

<span class="nc bnc" id="L1341" title="All 2 branches missed.">        context?.let {</span>
<span class="nc" id="L1342">            val icon: Drawable? = try {</span>
<span class="nc" id="L1343">                ContextCompat.getDrawable(it, R.drawable.ic_notice_48dp)</span>
<span class="nc" id="L1344">            } catch (e: Resources.NotFoundException) {</span>
<span class="nc" id="L1345">                AppLog.e(T.READER, &quot;Drawable not found. See issue #11576&quot;, e)</span>
<span class="nc" id="L1346">                null</span>
            }
<span class="nc bnc" id="L1348" title="All 2 branches missed.">            icon?.let {</span>
<span class="nc" id="L1349">                txtError.setCompoundDrawablesRelativeWithIntrinsicBounds(null, icon, null, null)</span>
<span class="nc" id="L1350">            }</span>
        }

<span class="nc bnc" id="L1353" title="All 2 branches missed.">        if (errorMessage == null) {</span>
<span class="nc" id="L1354">            txtError.visibility = View.GONE</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">        } else if (txtError.visibility != View.VISIBLE) {</span>
<span class="nc" id="L1356">            AniUtils.fadeIn(txtError, AniUtils.Duration.MEDIUM)</span>
        }
<span class="nc" id="L1358">        this.errorMessage = errorMessage</span>
<span class="nc" id="L1359">    }</span>

    private fun showPost() {
<span class="nc bnc" id="L1362" title="All 2 branches missed.">        if (postSlugsResolutionUnderway) {</span>
<span class="nc" id="L1363">            AppLog.w(T.READER, &quot;reader post detail &gt; post request already running&quot;)</span>
<span class="nc" id="L1364">            return</span>
        }

<span class="nc bnc" id="L1367" title="All 2 branches missed.">        if (commentsSnippetFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">            conversationViewModel.onUpdatePost(blogId, postId)</span>
        }

<span class="nc bnc" id="L1371" title="All 2 branches missed.">        viewModel.onShowPost(blogId = blogId, postId = postId)</span>
<span class="nc" id="L1372">    }</span>

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    fun onPrivateAtomicCookieFetched(event: OnPrivateAtomicCookieFetched) {
<span class="nc bnc" id="L1377" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L1378">            return</span>
        }

<span class="nc bnc" id="L1381" title="All 2 branches missed.">        if (event.isError) {</span>
<span class="nc" id="L1382">            AppLog.e(T.READER, &quot;Failed to load private AT cookie. $event.error.type - $event.error.message&quot;)</span>
<span class="nc" id="L1383">            WPSnackbar.make(</span>
<span class="nc" id="L1384">                    requireView(),</span>
<span class="nc" id="L1385">                    R.string.media_accessing_failed,</span>
<span class="nc" id="L1386">                    Snackbar.LENGTH_LONG</span>
<span class="nc" id="L1387">            ).show()</span>
        } else {
<span class="nc" id="L1389">            CookieManager.getInstance().setCookie(</span>
<span class="nc" id="L1390">                    privateAtomicCookie.getDomain(), privateAtomicCookie.getCookieContent()</span>
            )
        }

<span class="nc" id="L1394">        PrivateAtCookieRefreshProgressDialog.dismissIfNecessary(fragmentManager)</span>
<span class="nc bnc" id="L1395" title="All 2 branches missed.">        renderer?.beginRender()</span>
<span class="nc" id="L1396">    }</span>

    override fun onCookieProgressDialogCancelled() {
<span class="nc bnc" id="L1399" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L1400">            return</span>
        }

<span class="nc" id="L1403">        WPSnackbar.make(</span>
<span class="nc" id="L1404">                requireView(),</span>
<span class="nc" id="L1405">                R.string.media_accessing_failed,</span>
<span class="nc" id="L1406">                Snackbar.LENGTH_LONG</span>
<span class="nc" id="L1407">        ).show()</span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">        renderer?.beginRender()</span>
<span class="nc" id="L1409">    }</span>

    private fun handleDirectOperation(): Boolean {
<span class="nc bnc" id="L1412" title="All 2 branches missed.">        if (directOperation != null) {</span>
<span class="nc bnc" id="L1413" title="All 4 branches missed.">            when (directOperation) {</span>
                DirectOperation.COMMENT_JUMP, DirectOperation.COMMENT_REPLY, DirectOperation.COMMENT_LIKE -&gt; {
<span class="nc bnc" id="L1415" title="All 4 branches missed.">                    viewModel.post?.let {</span>
<span class="nc" id="L1416">                        ReaderActivityLauncher.showReaderComments(</span>
<span class="nc" id="L1417">                                activity, it.blogId, it.postId,</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">                                directOperation, commentId.toLong(), viewModel.interceptedUri,</span>
<span class="nc" id="L1419">                                DIRECT_OPERATION.sourceDescription</span>
                        )
<span class="nc" id="L1421">                    }</span>

<span class="nc bnc" id="L1423" title="All 2 branches missed.">                    activity?.finish()</span>
<span class="nc bnc" id="L1424" title="All 2 branches missed.">                    activity?.overridePendingTransition(0, 0)</span>
<span class="nc" id="L1425">                    return true</span>
                }
                DirectOperation.POST_LIKE -&gt; {
                }
            }
            // Liking needs to be handled &quot;later&quot; after the post has been updated from the server so,
            // nothing special to do here
        }
<span class="nc" id="L1433">        return false</span>
    }

    private fun ReaderPostDetailFragment.showPostInWebView(post: ReaderPost) {
<span class="nc bnc" id="L1437" title="All 2 branches missed.">        readerWebView.setIsPrivatePost(post.isPrivate)</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">        readerWebView.setBlogSchemeIsHttps(UrlUtils.isHttps(post.blogUrl))</span>
<span class="nc bnc" id="L1439" title="All 4 branches missed.">        renderer = ReaderPostRenderer(readerWebView, viewModel.post, readerCssProvider)</span>

        // if the post is from private atomic site postpone render until we have a special access cookie
<span class="nc bnc" id="L1442" title="All 4 branches missed.">        if (post.isPrivateAtomic &amp;&amp; privateAtomicCookie.isCookieRefreshRequired()) {</span>
<span class="nc" id="L1443">            PrivateAtCookieRefreshProgressDialog.showIfNecessary(fragmentManager, this@ReaderPostDetailFragment)</span>
<span class="nc" id="L1444">            requestPrivateAtomicCookie()</span>
<span class="nc bnc" id="L1445" title="All 4 branches missed.">        } else if (post.isPrivateAtomic &amp;&amp; privateAtomicCookie.exists()) {</span>
            // make sure we add cookie to the cookie manager if it exists before starting render
<span class="nc" id="L1447">            CookieManager.getInstance().setCookie(</span>
<span class="nc" id="L1448">                    privateAtomicCookie.getDomain(), privateAtomicCookie.getCookieContent()</span>
            )
<span class="nc bnc" id="L1450" title="All 2 branches missed.">            renderer?.beginRender()</span>
        } else {
<span class="nc bnc" id="L1452" title="All 2 branches missed.">            renderer?.beginRender()</span>
        }
<span class="nc" id="L1454">    }</span>

    private fun requestPrivateAtomicCookie() {
<span class="nc" id="L1457">        dispatcher.dispatch(</span>
<span class="nc bnc" id="L1458" title="All 4 branches missed.">                viewModel.post?.let {</span>
<span class="nc" id="L1459">                    SiteActionBuilder.newFetchPrivateAtomicCookieAction(FetchPrivateAtomicCookiePayload(it.blogId))</span>
                }
        )
<span class="nc" id="L1462">    }</span>

    /*
     * called by the web view when the content finishes loading - related posts aren't displayed
     * until this is triggered, to avoid having them appear before the webView content
     */
    override fun onPageFinished(view: WebView, url: String?) {
<span class="nc bnc" id="L1469" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L1470">            return</span>
        }

<span class="nc bnc" id="L1473" title="All 4 branches missed.">        if (url != null &amp;&amp; url == &quot;about:blank&quot;) {</span>
            // brief delay before showing related posts to give page time to render
<span class="nc" id="L1475">            view.postDelayed(Runnable {</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">                if (!isAdded) {</span>
<span class="nc" id="L1477">                    return@Runnable</span>
                }
<span class="nc bnc" id="L1479" title="All 2 branches missed.">                if (!hasAlreadyUpdatedPost) {</span>
<span class="nc" id="L1480">                    hasAlreadyUpdatedPost = true</span>
<span class="nc" id="L1481">                    updatePost()</span>
                }
<span class="nc bnc" id="L1483" title="All 4 branches missed.">                viewModel.post?.let {</span>
<span class="nc bnc" id="L1484" title="All 2 branches missed.">                    if (likesEnhancementsFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L1485" title="All 2 branches missed.">                        viewModel.onRefreshLikersData(it)</span>
                    }
<span class="nc bnc" id="L1487" title="All 2 branches missed.">                    if (commentsSnippetFeatureConfig.isEnabled()) {</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">                        viewModel.onRefreshCommentsData(it.blogId, it.postId)</span>
                    }
<span class="nc bnc" id="L1490" title="All 2 branches missed.">                    viewModel.onRelatedPostsRequested(it)</span>
<span class="nc" id="L1491">                }</span>
<span class="nc" id="L1492">            }, 300)</span>
        } else {
<span class="nc bnc" id="L1494" title="All 2 branches missed.">            url?.let { AppLog.w(T.READER, &quot;reader post detail &gt; page finished - $it&quot;) }</span>
        }
<span class="nc" id="L1496">    }</span>

    /*
     * return the container view that should host the full screen video
     */
    override fun onRequestCustomView(): ViewGroup? {
<span class="nc bnc" id="L1502" title="All 2 branches missed.">        return if (isAdded) {</span>
<span class="nc bnc" id="L1503" title="All 2 branches missed.">            requireView().findViewById&lt;View&gt;(R.id.layout_custom_view_container) as ViewGroup</span>
        } else {
<span class="nc" id="L1505">            null</span>
        }
    }

    /*
     * return the container view that should be hidden when full screen video is shown
     */
    override fun onRequestContentView(): ViewGroup? {
<span class="nc bnc" id="L1513" title="All 2 branches missed.">        return if (isAdded) {</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">            requireView().findViewById&lt;View&gt;(R.id.layout_post_detail_container) as ViewGroup</span>
        } else {
<span class="nc" id="L1516">            null</span>
        }
    }

    override fun onCustomViewShown() {
        // full screen video has just been shown so hide the AppBar
<span class="nc" id="L1522">        readerTracker.track(Stat.READER_ARTICLE_CUSTOM_VIEW_SHOWN)</span>
<span class="nc" id="L1523">        onShowHideToolbar(false)</span>
<span class="nc" id="L1524">    }</span>

    override fun onCustomViewHidden() {
        // user returned from full screen video so re-display the AppBar
<span class="nc" id="L1528">        readerTracker.track(Stat.READER_ARTICLE_CUSTOM_VIEW_HIDDEN)</span>
<span class="nc" id="L1529">        onShowHideToolbar(true)</span>
<span class="nc" id="L1530">    }</span>

    fun hideCustomView() {
<span class="nc bnc" id="L1533" title="All 2 branches missed.">        if (view != null) {</span>
<span class="nc bnc" id="L1534" title="All 2 branches missed.">            readerWebView.hideCustomView()</span>
        }
<span class="nc" id="L1536">    }</span>

    override fun onUrlClick(url: String): Boolean {
<span class="nc" id="L1539">        readerTracker.track(Stat.READER_ARTICLE_LINK_TAPPED)</span>
        // if this is a &quot;wordpress://blogpreview?&quot; link, show blog preview for the blog - this is
        // used for Discover posts that highlight a blog
<span class="nc bnc" id="L1542" title="All 2 branches missed.">        if (ReaderUtils.isBlogPreviewUrl(url)) {</span>
<span class="nc" id="L1543">            val siteId = ReaderUtils.getBlogIdFromBlogPreviewUrl(url)</span>
<span class="nc bnc" id="L1544" title="All 2 branches missed.">            if (siteId != 0L) {</span>
<span class="nc" id="L1545">                ReaderActivityLauncher.showReaderBlogPreview(</span>
<span class="nc" id="L1546">                        activity,</span>
<span class="nc" id="L1547">                        siteId,</span>
<span class="nc bnc" id="L1548" title="All 4 branches missed.">                        viewModel.post?.isFollowedByCurrentUser,</span>
<span class="nc" id="L1549">                        ReaderTracker.SOURCE_POST_DETAIL,</span>
<span class="nc" id="L1550">                        readerTracker</span>
                )
            }
<span class="nc" id="L1553">            return true</span>
        }

<span class="nc bnc" id="L1556" title="All 2 branches missed.">        if (isFile(url)) {</span>
<span class="nc" id="L1557">            onFileDownloadClick(url)</span>
        } else {
<span class="nc bnc" id="L1559" title="All 2 branches missed.">            val openUrlType = if (shouldOpenExternal(url)) OpenUrlType.EXTERNAL else OpenUrlType.INTERNAL</span>
<span class="nc" id="L1560">            ReaderActivityLauncher.openUrl(activity, url, openUrlType)</span>
        }
<span class="nc" id="L1562">        return true</span>
    }

    override fun onPageJumpClick(pageJump: String?): Boolean {
<span class="nc" id="L1566">        readerTracker.track(Stat.READER_ARTICLE_PAGE_JUMP_TAPPED)</span>
<span class="nc bnc" id="L1567" title="All 2 branches missed.">        val wasJsEnabled = readerWebView.settings.javaScriptEnabled</span>

<span class="nc bnc" id="L1569" title="All 2 branches missed.">        readerWebView.settings.javaScriptEnabled = true</span>

<span class="nc bnc" id="L1571" title="All 2 branches missed.">        readerWebView.evaluateJavascript(&quot;document.getElementById('$pageJump').offsetTop&quot;) { result -&gt;</span>
            // Note that 'result' can be the string 'null' in case the page jump identifier is not found on page
<span class="nc" id="L1573">            val offsetTop = StringUtils.stringToInt(result, -1)</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">            if (offsetTop &gt;= 0) {</span>
<span class="nc" id="L1575">                val yOffset = (resources.displayMetrics.density * offsetTop).toInt()</span>
<span class="nc bnc" id="L1576" title="All 2 branches missed.">                scrollView.smoothScrollTo(0, yOffset)</span>
            } else {
<span class="nc" id="L1578">                ToastUtils.showToast(activity, R.string.reader_toast_err_page_jump_not_found)</span>
            }
<span class="nc" id="L1580">        }</span>

<span class="nc bnc" id="L1582" title="All 2 branches missed.">        readerWebView.settings.javaScriptEnabled = wasJsEnabled</span>
<span class="nc" id="L1583">        return true</span>
    }

    /*
     * returns True if the passed URL should be opened in the external browser app
     */
    private fun shouldOpenExternal(url: String): Boolean {
        // open YouTube videos in external app so they launch the YouTube player
<span class="nc bnc" id="L1591" title="All 2 branches missed.">        if (ReaderVideoUtils.isYouTubeVideoLink(url)) {</span>
<span class="nc" id="L1592">            return true</span>
        }

        // Open Stories links in external browser so they have more fullscreen play real estate
<span class="nc bnc" id="L1596" title="All 4 branches missed.">        if (Uri.parse(url).queryParameterNames.any { it.contains(&quot;wp-story&quot;) }) {</span>
<span class="nc" id="L1597">            return true</span>
        }

        // if the mime type starts with &quot;application&quot; open it externally - this will either
        // open it in the associated app or the default browser (which will enable the user
        // to download it)
<span class="nc" id="L1603">        return isFile(url)</span>

        // open all other urls using an AuthenticatedWebViewActivity
    }

    private fun isFile(url: String): Boolean {
<span class="nc" id="L1609">        val mimeType = UrlUtils.getUrlMimeType(url)</span>
<span class="nc bnc" id="L1610" title="All 4 branches missed.">        return mimeType != null &amp;&amp; mimeType.startsWith(&quot;application&quot;)</span>
    }

    override fun onImageUrlClick(imageUrl: String, view: View, x: Int, y: Int): Boolean {
<span class="nc" id="L1614">        readerTracker.track(Stat.READER_ARTICLE_IMAGE_TAPPED)</span>
<span class="nc" id="L1615">        return showPhotoViewer(imageUrl, view, x, y)</span>
    }

    override fun onFileDownloadClick(fileUrl: String?): Boolean {
<span class="nc" id="L1619">        readerTracker.track(Stat.READER_ARTICLE_FILE_DOWNLOAD_TAPPED)</span>
<span class="nc bnc" id="L1620" title="All 2 branches missed.">        return if (activity != null &amp;&amp;</span>
<span class="nc bnc" id="L1621" title="All 2 branches missed.">                fileUrl != null &amp;&amp;</span>
<span class="nc bnc" id="L1622" title="All 2 branches missed.">                PermissionUtils.checkAndRequestStoragePermission(</span>
<span class="nc" id="L1623">                        this,</span>
<span class="nc" id="L1624">                        READER_FILE_DOWNLOAD_PERMISSION_REQUEST_CODE</span>
                )) {
<span class="nc" id="L1626">            readerFileDownloadManager.downloadFile(fileUrl)</span>
<span class="nc" id="L1627">            true</span>
        } else {
<span class="nc" id="L1629">            fileForDownload = fileUrl</span>
<span class="nc" id="L1630">            false</span>
        }
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array&lt;String&gt;,
        grantResults: IntArray
    ) {
<span class="nc" id="L1639">        val activity = activity</span>
<span class="nc bnc" id="L1640" title="All 2 branches missed.">        if (activity != null &amp;&amp;</span>
<span class="nc bnc" id="L1641" title="All 2 branches missed.">                requestCode == READER_FILE_DOWNLOAD_PERMISSION_REQUEST_CODE &amp;&amp;</span>
<span class="nc bnc" id="L1642" title="All 6 branches missed.">                grantResults.isNotEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L1643" title="All 2 branches missed.">                grantResults[0] == PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc bnc" id="L1644" title="All 2 branches missed.">            fileForDownload?.let { readerFileDownloadManager.downloadFile(it) }</span>
        }
<span class="nc" id="L1646">        fileForDownload = null</span>
<span class="nc" id="L1647">    }</span>

    fun pauseWebView() {
<span class="nc bnc" id="L1650" title="All 2 branches missed.">        if (view == null) {</span>
<span class="nc" id="L1651">            AppLog.w(T.READER, &quot;reader post detail &gt; attempt to pause null webView&quot;)</span>
<span class="nc bnc" id="L1652" title="All 2 branches missed.">        } else if (!isWebViewPaused) {</span>
<span class="nc" id="L1653">            AppLog.d(T.READER, &quot;reader post detail &gt; pausing webView&quot;)</span>
<span class="nc bnc" id="L1654" title="All 2 branches missed.">            readerWebView.hideCustomView()</span>
<span class="nc bnc" id="L1655" title="All 2 branches missed.">            readerWebView.onPause()</span>
<span class="nc" id="L1656">            isWebViewPaused = true</span>
        }
<span class="nc" id="L1658">    }</span>

    fun resumeWebViewIfPaused() {
<span class="nc bnc" id="L1661" title="All 2 branches missed.">        if (view == null) {</span>
<span class="nc" id="L1662">            AppLog.w(T.READER, &quot;reader post detail &gt; attempt to resume null webView&quot;)</span>
<span class="nc bnc" id="L1663" title="All 2 branches missed.">        } else if (isWebViewPaused) {</span>
<span class="nc" id="L1664">            AppLog.d(T.READER, &quot;reader post detail &gt; resuming paused webView&quot;)</span>
<span class="nc bnc" id="L1665" title="All 2 branches missed.">            readerWebView.onResume()</span>
<span class="nc" id="L1666">            isWebViewPaused = false</span>
        }
<span class="nc" id="L1668">    }</span>

    override fun onScrollUp(distanceY: Float) {
<span class="nc" id="L1671">    }</span>

    override fun onScrollDown(distanceY: Float) {
<span class="nc" id="L1674">    }</span>

    override fun onScrollCompleted() {
<span class="nc" id="L1677">        trackRelatedPostsIfShowing()</span>
<span class="nc" id="L1678">    }</span>

    private fun setRefreshing(refreshing: Boolean) {
<span class="nc bnc" id="L1681" title="All 2 branches missed.">        swipeToRefreshHelper.isRefreshing = refreshing</span>
<span class="nc" id="L1682">    }</span>

    override fun onShowHideToolbar(show: Boolean) {
<span class="nc bnc" id="L1685" title="All 2 branches missed.">        if (isAdded) {</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">            AniUtils.animateTopBar(appBar, show)</span>
        }
<span class="nc" id="L1688">    }</span>

    companion object {
        private const val KEY_LIKERS_LIST_STATE = &quot;likers_list_state&quot;
        private const val KEY_COMMENTS_SNIPPET_LIST_STATE = &quot;comments_snippet_list_state&quot;
        private const val NOTIFICATIONS_BOTTOM_SHEET_TAG = &quot;NOTIFICATIONS_BOTTOM_SHEET_TAG&quot;

        fun newInstance(blogId: Long, postId: Long): ReaderPostDetailFragment {
<span class="nc" id="L1696">            return newInstance(false, blogId, postId, null, 0, false, null, null, false)</span>
        }

        fun newInstance(
            isFeed: Boolean,
            blogId: Long,
            postId: Long,
            directOperation: DirectOperation?,
            commentId: Int,
            isRelatedPost: Boolean,
            interceptedUri: String?,
            postListType: ReaderPostListType?,
            postSlugsResolutionUnderway: Boolean
        ): ReaderPostDetailFragment {
<span class="nc" id="L1710">            AppLog.d(T.READER, &quot;reader post detail &gt; newInstance&quot;)</span>

<span class="nc" id="L1712">            val args = Bundle()</span>
<span class="nc" id="L1713">            args.putBoolean(ReaderConstants.ARG_IS_FEED, isFeed)</span>
<span class="nc" id="L1714">            args.putLong(ReaderConstants.ARG_BLOG_ID, blogId)</span>
<span class="nc" id="L1715">            args.putLong(ReaderConstants.ARG_POST_ID, postId)</span>
<span class="nc" id="L1716">            args.putBoolean(ReaderConstants.ARG_IS_RELATED_POST, isRelatedPost)</span>
<span class="nc" id="L1717">            args.putSerializable(ReaderConstants.ARG_DIRECT_OPERATION, directOperation)</span>
<span class="nc" id="L1718">            args.putInt(ReaderConstants.ARG_COMMENT_ID, commentId)</span>
<span class="nc" id="L1719">            args.putString(ReaderConstants.ARG_INTERCEPTED_URI, interceptedUri)</span>
<span class="nc bnc" id="L1720" title="All 2 branches missed.">            if (postListType != null) {</span>
<span class="nc" id="L1721">                args.putSerializable(ReaderConstants.ARG_POST_LIST_TYPE, postListType)</span>
            }
<span class="nc" id="L1723">            args.putBoolean(</span>
<span class="nc" id="L1724">                    ReaderConstants.KEY_POST_SLUGS_RESOLUTION_UNDERWAY,</span>
<span class="nc" id="L1725">                    postSlugsResolutionUnderway</span>
            )

<span class="nc" id="L1728">            val fragment = ReaderPostDetailFragment()</span>
<span class="nc" id="L1729">            fragment.arguments = args</span>

<span class="nc" id="L1731">            return fragment</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>