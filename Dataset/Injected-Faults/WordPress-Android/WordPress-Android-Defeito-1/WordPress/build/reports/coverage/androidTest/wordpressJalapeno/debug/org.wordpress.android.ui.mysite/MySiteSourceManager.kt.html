<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySiteSourceManager.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.mysite</a> &gt; <span class="el_source">MySiteSourceManager.kt</span></div><h1>MySiteSourceManager.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.mysite

import androidx.lifecycle.LiveData
import kotlinx.coroutines.CoroutineScope
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.ui.mysite.MySiteSource.MySiteRefreshSource
import org.wordpress.android.ui.mysite.MySiteSource.SiteIndependentSource
import org.wordpress.android.ui.mysite.MySiteUiState.PartialState
import org.wordpress.android.ui.mysite.cards.dashboard.CardsSource
import org.wordpress.android.ui.mysite.cards.dashboard.bloggingprompts.BloggingPromptCardSource
import org.wordpress.android.ui.mysite.cards.domainregistration.DomainRegistrationSource
import org.wordpress.android.ui.mysite.cards.quickstart.QuickStartCardSource
import org.wordpress.android.ui.mysite.dynamiccards.DynamicCardMenuViewModel.DynamicCardMenuInteraction
import org.wordpress.android.ui.mysite.dynamiccards.DynamicCardMenuViewModel.DynamicCardMenuInteraction.Hide
import org.wordpress.android.ui.mysite.dynamiccards.DynamicCardMenuViewModel.DynamicCardMenuInteraction.Pin
import org.wordpress.android.ui.mysite.dynamiccards.DynamicCardMenuViewModel.DynamicCardMenuInteraction.Unpin
import org.wordpress.android.ui.mysite.dynamiccards.DynamicCardsSource
import org.wordpress.android.ui.quickstart.QuickStartTracker
import javax.inject.Inject

<span class="nc" id="L21">class MySiteSourceManager @Inject constructor(</span>
<span class="nc" id="L22">    private val quickStartTracker: QuickStartTracker,</span>
<span class="nc" id="L23">    private val currentAvatarSource: CurrentAvatarSource,</span>
<span class="nc" id="L24">    private val domainRegistrationSource: DomainRegistrationSource,</span>
<span class="nc" id="L25">    private val dynamicCardsSource: DynamicCardsSource,</span>
<span class="nc" id="L26">    private val quickStartCardSource: QuickStartCardSource,</span>
<span class="nc" id="L27">    private val scanAndBackupSource: ScanAndBackupSource,</span>
<span class="nc" id="L28">    private val selectedSiteSource: SelectedSiteSource,</span>
    cardsSource: CardsSource,
    siteIconProgressSource: SiteIconProgressSource,
<span class="nc" id="L31">    private val bloggingPromptCardSource: BloggingPromptCardSource,</span>
<span class="nc" id="L32">    private val selectedSiteRepository: SelectedSiteRepository</span>
) {
<span class="nc" id="L34">    private val mySiteSources: List&lt;MySiteSource&lt;*&gt;&gt; = listOf(</span>
<span class="nc" id="L35">            selectedSiteSource,</span>
<span class="nc" id="L36">            siteIconProgressSource,</span>
<span class="nc" id="L37">            quickStartCardSource,</span>
<span class="nc" id="L38">            currentAvatarSource,</span>
<span class="nc" id="L39">            domainRegistrationSource,</span>
<span class="nc" id="L40">            scanAndBackupSource,</span>
<span class="nc" id="L41">            dynamicCardsSource,</span>
<span class="nc" id="L42">            cardsSource,</span>
<span class="nc" id="L43">            bloggingPromptCardSource</span>
    )

    private val showDashboardCards: Boolean
<span class="nc bnc" id="L47" title="All 4 branches missed.">        get() = selectedSiteRepository.getSelectedSite()?.isUsingWpComRestApi == true</span>

    private val allSupportedMySiteSources: List&lt;MySiteSource&lt;*&gt;&gt;
<span class="nc bnc" id="L50" title="All 2 branches missed.">        get() = if (showDashboardCards) {</span>
<span class="nc" id="L51">            mySiteSources</span>
        } else {
<span class="nc bnc" id="L53" title="All 2 branches missed.">            mySiteSources.filterNot(CardsSource::class.java::isInstance)</span>
<span class="nc" id="L54">        }</span>

    private val siteIndependentSources: List&lt;SiteIndependentSource&lt;*&gt;&gt;
<span class="nc" id="L57">        get() = mySiteSources.filterIsInstance(SiteIndependentSource::class.java)</span>

    fun build(coroutineScope: CoroutineScope, siteLocalId: Int?): List&lt;LiveData&lt;out PartialState&gt;&gt; {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        return if (siteLocalId != null) {</span>
<span class="nc" id="L61">            allSupportedMySiteSources.map { source -&gt; source.build(coroutineScope, siteLocalId) }</span>
        } else {
<span class="nc" id="L63">            siteIndependentSources.map { source -&gt; source.build(coroutineScope) }</span>
        }
    }

    fun isRefreshing(): Boolean {
<span class="nc bnc" id="L68" title="All 2 branches missed.">        val source = if (selectedSiteRepository.hasSelectedSite()) {</span>
<span class="nc" id="L69">            allSupportedMySiteSources</span>
        } else {
<span class="nc" id="L71">            siteIndependentSources</span>
        }
<span class="nc" id="L73">        source.filterIsInstance(MySiteRefreshSource::class.java).forEach {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            if (it.isRefreshing() == true) {</span>
<span class="nc" id="L75">                return true</span>
            }
<span class="nc" id="L77">        }</span>
<span class="nc" id="L78">        return false</span>
    }

    fun refresh() {
<span class="nc" id="L82">        allSupportedMySiteSources.filterIsInstance(MySiteRefreshSource::class.java).forEach {</span>
<span class="nc bnc" id="L83" title="All 4 branches missed.">            if (it is SiteIndependentSource || selectedSiteRepository.hasSelectedSite()) it.refresh()</span>
<span class="nc" id="L84">        }</span>
<span class="nc" id="L85">    }</span>

    fun onResume(isSiteSelected: Boolean) {
<span class="nc" id="L88">        when (isSiteSelected) {</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            true -&gt; refreshSubsetOfAllSources()</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            false -&gt; refresh()</span>
        }
<span class="nc" id="L92">    }</span>

    fun clear() {
<span class="nc" id="L95">        domainRegistrationSource.clear()</span>
<span class="nc" id="L96">        scanAndBackupSource.clear()</span>
<span class="nc" id="L97">        selectedSiteSource.clear()</span>
<span class="nc" id="L98">    }</span>

    private fun refreshSubsetOfAllSources() {
<span class="nc" id="L101">        selectedSiteSource.updateSiteSettingsIfNecessary()</span>
<span class="nc" id="L102">        currentAvatarSource.refresh()</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (selectedSiteRepository.hasSelectedSite()) quickStartCardSource.refresh()</span>
<span class="nc" id="L104">    }</span>

    fun refreshBloggingPrompts(onlyCurrentPrompt: Boolean) {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (onlyCurrentPrompt) {</span>
<span class="nc" id="L108">            bloggingPromptCardSource.refreshTodayPrompt()</span>
        } else {
<span class="nc" id="L110">            bloggingPromptCardSource.refresh()</span>
        }
<span class="nc" id="L112">    }</span>

    /* QUICK START */

    fun refreshQuickStart() {
<span class="nc" id="L117">        quickStartCardSource.refresh()</span>
<span class="nc" id="L118">    }</span>

    suspend fun onQuickStartMenuInteraction(interaction: DynamicCardMenuInteraction) {
<span class="nc" id="L121">        when (interaction) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            is DynamicCardMenuInteraction.Remove -&gt; {</span>
<span class="nc" id="L123">                quickStartTracker.track(Stat.QUICK_START_REMOVE_CARD_TAPPED)</span>
<span class="nc" id="L124">                dynamicCardsSource.removeItem(interaction.cardType)</span>
<span class="nc" id="L125">                quickStartCardSource.refresh()</span>
            }
<span class="nc bnc" id="L127" title="All 2 branches missed.">            is Pin -&gt; dynamicCardsSource.pinItem(interaction.cardType)</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            is Unpin -&gt; dynamicCardsSource.unpinItem()</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">            is Hide -&gt; {</span>
<span class="nc" id="L130">                quickStartTracker.track(Stat.QUICK_START_HIDE_CARD_TAPPED)</span>
<span class="nc" id="L131">                dynamicCardsSource.hideItem(interaction.cardType)</span>
<span class="nc" id="L132">                quickStartCardSource.refresh()</span>
            }
        }
<span class="nc" id="L135">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>