<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StockMediaPickerActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stockmedia</a> &gt; <span class="el_source">StockMediaPickerActivity.java</span></div><h1>StockMediaPickerActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stockmedia;

import android.app.ProgressDialog;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.text.Html;
import android.text.Spanned;
import android.text.TextUtils;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.ImageView.ScaleType;
import android.widget.RelativeLayout;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.widget.SearchView;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.FragmentManager;
import androidx.recyclerview.widget.GridLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.generated.MediaActionBuilder;
import org.wordpress.android.fluxc.generated.StockMediaActionBuilder;
import org.wordpress.android.fluxc.model.MediaModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.model.StockMediaModel;
import org.wordpress.android.fluxc.store.MediaStore.OnStockMediaUploaded;
import org.wordpress.android.fluxc.store.MediaStore.UploadStockMediaPayload;
import org.wordpress.android.fluxc.store.StockMediaStore;
import org.wordpress.android.fluxc.store.StockMediaStore.FetchStockMediaListPayload;
import org.wordpress.android.fluxc.store.StockMediaStore.OnStockMediaListFetched;
import org.wordpress.android.ui.ActionableEmptyView;
import org.wordpress.android.ui.LocaleAwareActivity;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.media.MediaPreviewActivity;
import org.wordpress.android.ui.photopicker.MediaPickerConstants;
import org.wordpress.android.ui.stockmedia.StockMediaRetainedFragment.StockMediaRetainedData;
import org.wordpress.android.util.AccessibilityUtils;
import org.wordpress.android.util.ActivityUtils;
import org.wordpress.android.util.AniUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.DisplayUtils;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.PhotoPickerUtils;
import org.wordpress.android.util.PhotonUtils;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.extensions.ViewExtensionsKt;
import org.wordpress.android.util.WPLinkMovementMethod;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageType;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.inject.Inject;

<span class="nc" id="L71">public class StockMediaPickerActivity extends LocaleAwareActivity implements SearchView.OnQueryTextListener {</span>
    private static final int MIN_SEARCH_QUERY_SIZE = 3;
    private static final String TAG_RETAINED_FRAGMENT = &quot;retained_fragment&quot;;

    private static final String KEY_SEARCH_QUERY = &quot;search_query&quot;;
    private static final String KEY_IS_SHOWING_EMPTY_VIEW = &quot;is_showing_empty_view&quot;;
    private static final String KEY_IS_UPLOADING = &quot;is_uploading&quot;;
    public static final String KEY_REQUEST_CODE = &quot;request_code&quot;;
    public static final String KEY_UPLOADED_MEDIA_IDS = &quot;uploaded_media_ids&quot;;

    private SiteModel mSite;

    private StockMediaAdapter mAdapter;
    private StockMediaRetainedFragment mRetainedFragment;
    private ProgressDialog mProgressDialog;

    private RecyclerView mRecycler;
    private ViewGroup mSelectionBar;
    private TextView mTextAdd;
    private TextView mTextPreview;

    private SearchView mSearchView;
    private String mSearchQuery;
<span class="nc" id="L94">    private final Handler mHandler = new Handler();</span>

    private int mThumbWidth;
    private int mThumbHeight;

    private boolean mIsFetching;
    private boolean mIsShowingEmptyView;
    private boolean mIsUploading;
    private boolean mCanLoadMore;

    private int mNextPage;
    private int mRequestCode;

    @SuppressWarnings(&quot;unused&quot;)
    @Inject StockMediaStore mStockMediaStore;
    @Inject Dispatcher mDispatcher;
    @Inject ImageManager mImageManager;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L114">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L115">        ((WordPress) getApplication()).component().inject(this);</span>
<span class="nc" id="L116">        setContentView(R.layout.media_picker_activity);</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L119">            mSite = (SiteModel) getIntent().getSerializableExtra(WordPress.SITE);</span>
        } else {
<span class="nc" id="L121">            mSite = (SiteModel) savedInstanceState.getSerializable(WordPress.SITE);</span>
        }
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (mSite == null) {</span>
<span class="nc" id="L124">            ToastUtils.showToast(this, R.string.blog_not_found, ToastUtils.Duration.SHORT);</span>
<span class="nc" id="L125">            finish();</span>
<span class="nc" id="L126">            return;</span>
        }

<span class="nc" id="L129">        FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L130">        mRetainedFragment = (StockMediaRetainedFragment) fm.findFragmentByTag(TAG_RETAINED_FRAGMENT);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (mRetainedFragment == null) {</span>
<span class="nc" id="L132">            mRetainedFragment = StockMediaRetainedFragment.newInstance();</span>
<span class="nc" id="L133">            fm.beginTransaction().add(mRetainedFragment, TAG_RETAINED_FRAGMENT).commit();</span>
        }

<span class="nc" id="L136">        int displayWidth = DisplayUtils.getWindowPixelWidth(this);</span>
<span class="nc" id="L137">        mThumbWidth = displayWidth / getColumnCount();</span>
<span class="nc" id="L138">        mThumbHeight = (int) (mThumbWidth * 0.75f);</span>

<span class="nc" id="L140">        Toolbar toolbar = findViewById(R.id.toolbar_main);</span>
<span class="nc" id="L141">        setSupportActionBar(toolbar);</span>
<span class="nc" id="L142">        ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L144">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L145">            actionBar.setDisplayShowTitleEnabled(true);</span>
        }

<span class="nc" id="L148">        mRecycler = findViewById(R.id.recycler);</span>
<span class="nc" id="L149">        mRecycler.setLayoutManager(new GridLayoutManager(this, getColumnCount()));</span>

<span class="nc" id="L151">        mAdapter = new StockMediaAdapter();</span>
<span class="nc" id="L152">        mRecycler.setAdapter(mAdapter);</span>

<span class="nc" id="L154">        mSelectionBar = findViewById(R.id.container_selection_bar);</span>
<span class="nc" id="L155">        mTextAdd = findViewById(R.id.text_add);</span>
<span class="nc" id="L156">        mTextPreview = findViewById(R.id.text_preview);</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L159">            showEmptyView(true);</span>
<span class="nc" id="L160">            mRequestCode = getIntent().getIntExtra(KEY_REQUEST_CODE, 0);</span>
        } else {
<span class="nc" id="L162">            mSearchQuery = savedInstanceState.getString(KEY_SEARCH_QUERY);</span>
<span class="nc" id="L163">            mIsUploading = savedInstanceState.getBoolean(KEY_IS_UPLOADING);</span>
<span class="nc" id="L164">            mIsShowingEmptyView = savedInstanceState.getBoolean(KEY_IS_SHOWING_EMPTY_VIEW);</span>
<span class="nc" id="L165">            mRequestCode = savedInstanceState.getInt(KEY_REQUEST_CODE);</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (mIsShowingEmptyView) {</span>
<span class="nc" id="L168">                showEmptyView(true);</span>
            }

<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (mIsUploading) {</span>
<span class="nc" id="L172">                showUploadProgressDialog(true);</span>
            }

<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (!TextUtils.isEmpty(mSearchQuery)) {</span>
<span class="nc" id="L176">                StockMediaRetainedData data = mRetainedFragment.getData();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                if (data != null) {</span>
<span class="nc" id="L178">                    mCanLoadMore = data.canLoadMore();</span>
<span class="nc" id="L179">                    mNextPage = data.getNextPage();</span>
<span class="nc" id="L180">                    mAdapter.setMediaList(data.getStockMediaList());</span>
<span class="nc" id="L181">                    mAdapter.setSelectedItems(data.getSelectedItems());</span>
                } else {
<span class="nc" id="L183">                    submitSearch(mSearchQuery, true);</span>
                }
            }
        }

<span class="nc" id="L188">        mTextAdd.setOnClickListener(new View.OnClickListener() {</span>
            @Override public void onClick(View v) {
<span class="nc bnc" id="L190" title="All 6 branches missed.">                if (null != mSite &amp;&amp; mSite.hasDiskSpaceQuotaInformation() &amp;&amp; mSite.getSpaceAvailable() &lt;= 0) {</span>
<span class="nc" id="L191">                    ToastUtils.showToast(StockMediaPickerActivity.this, R.string.error_media_quota_exceeded_toast);</span>
<span class="nc" id="L192">                    return;</span>
                }
<span class="nc" id="L194">                uploadSelection();</span>
<span class="nc" id="L195">            }</span>
        });

<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (isMultiSelectEnabled()) {</span>
<span class="nc" id="L199">            mTextPreview.setOnClickListener(new View.OnClickListener() {</span>
                @Override public void onClick(View v) {
<span class="nc" id="L201">                    previewSelection();</span>
<span class="nc" id="L202">                }</span>
            });
        } else {
<span class="nc" id="L205">            mTextAdd.setText(R.string.photo_picker_use_photo);</span>
<span class="nc" id="L206">            mTextPreview.setVisibility(View.GONE);</span>
        }

<span class="nc" id="L209">        configureSearchView();</span>
<span class="nc" id="L210">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (mSearchView != null) {</span>
<span class="nc" id="L215">            mSearchView.setOnQueryTextListener(null);</span>
<span class="nc" id="L216">            mSearchView.setOnCloseListener(null);</span>
        }
<span class="nc" id="L218">        showUploadProgressDialog(false);</span>
<span class="nc" id="L219">        super.onDestroy();</span>
<span class="nc" id="L220">    }</span>

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L224">        super.onSaveInstanceState(outState);</span>

<span class="nc" id="L226">        outState.putBoolean(KEY_IS_SHOWING_EMPTY_VIEW, mIsShowingEmptyView);</span>
<span class="nc" id="L227">        outState.putBoolean(KEY_IS_UPLOADING, mIsUploading);</span>
<span class="nc" id="L228">        outState.putInt(KEY_REQUEST_CODE, mRequestCode);</span>

<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (mSite != null) {</span>
<span class="nc" id="L231">            outState.putSerializable(WordPress.SITE, mSite);</span>
        }

<span class="nc bnc" id="L234" title="All 2 branches missed.">        String query = mSearchView != null ? mSearchView.getQuery().toString() : null;</span>
<span class="nc" id="L235">        outState.putString(KEY_SEARCH_QUERY, query);</span>

<span class="nc" id="L237">        StockMediaRetainedData data = new StockMediaRetainedData(mAdapter.mItems,</span>
<span class="nc" id="L238">                mAdapter.mSelectedItems,</span>
                mCanLoadMore,
                mNextPage);
<span class="nc" id="L241">        mRetainedFragment.setData(data);</span>
<span class="nc" id="L242">    }</span>

    @Override
    public void onStart() {
<span class="nc" id="L246">        super.onStart();</span>
<span class="nc" id="L247">        mDispatcher.register(this);</span>
<span class="nc" id="L248">    }</span>

    @Override
    public void onStop() {
<span class="nc" id="L252">        mDispatcher.unregister(this);</span>
<span class="nc" id="L253">        super.onStop();</span>
<span class="nc" id="L254">    }</span>

    @Override
    public void onPause() {
<span class="nc bnc" id="L258" title="All 4 branches missed.">        if (isFinishing() &amp;&amp; mRetainedFragment != null) {</span>
<span class="nc" id="L259">            getSupportFragmentManager().beginTransaction().remove(mRetainedFragment).commit();</span>
        }
<span class="nc" id="L261">        super.onPause();</span>
<span class="nc" id="L262">    }</span>

    @Override
    public boolean onOptionsItemSelected(final MenuItem item) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (item.getItemId() == android.R.id.home) {</span>
<span class="nc" id="L267">            setResult(RESULT_CANCELED);</span>
<span class="nc" id="L268">            finish();</span>
<span class="nc" id="L269">            return true;</span>
        }
<span class="nc" id="L271">        return super.onOptionsItemSelected(item);</span>
    }

    private boolean isMultiSelectEnabled() {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        return mRequestCode == RequestCodes.STOCK_MEDIA_PICKER_MULTI_SELECT;</span>
    }

    @Override
    public boolean onQueryTextSubmit(String query) {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (mSearchView != null) {</span>
<span class="nc" id="L281">            mSearchView.clearFocus();</span>
        }
<span class="nc" id="L283">        ActivityUtils.hideKeyboard(this);</span>
<span class="nc" id="L284">        return true;</span>
    }

    @Override
    public boolean onQueryTextChange(String query) {
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (!StringUtils.equals(query, mSearchQuery)) {</span>
<span class="nc" id="L290">            submitSearch(query, true);</span>
        }
<span class="nc" id="L292">        return true;</span>
    }

    private void configureSearchView() {
<span class="nc" id="L296">        mSearchView = findViewById(R.id.search_view);</span>

        // don't allow the SearchView to be closed
<span class="nc" id="L299">        mSearchView.setOnCloseListener(new SearchView.OnCloseListener() {</span>
            @Override public boolean onClose() {
<span class="nc" id="L301">                return true;</span>
            }
        });

<span class="nc" id="L305">        mSearchView.setOnQueryTextListener(this);</span>
<span class="nc" id="L306">    }</span>

    private void showEmptyView(boolean show) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (!isFinishing()) {</span>
<span class="nc" id="L310">            mIsShowingEmptyView = show;</span>
<span class="nc" id="L311">            ActionableEmptyView actionableEmptyView = findViewById(R.id.actionable_empty_view);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            actionableEmptyView.setVisibility(show ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L313">            actionableEmptyView.updateLayoutForSearch(true, 0);</span>

<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (show) {</span>
<span class="nc bnc" id="L316" title="All 4 branches missed.">                boolean isEmpty = mSearchQuery == null || mSearchQuery.length() &lt; MIN_SEARCH_QUERY_SIZE;</span>

<span class="nc bnc" id="L318" title="All 2 branches missed.">                if (isEmpty) {</span>
<span class="nc" id="L319">                    actionableEmptyView.title.setText(R.string.stock_media_picker_initial_empty_text);</span>
<span class="nc" id="L320">                    String link = &quot;&lt;a href='https://pexels.com/'&gt;Pexels&lt;/a&gt;&quot;;</span>
<span class="nc" id="L321">                    Spanned html = Html.fromHtml(getString(R.string.stock_media_picker_initial_empty_subtext, link));</span>
<span class="nc" id="L322">                    actionableEmptyView.subtitle.setText(html);</span>
<span class="nc" id="L323">                    actionableEmptyView.getSubtitle().setMovementMethod(WPLinkMovementMethod.getInstance());</span>
<span class="nc" id="L324">                    actionableEmptyView.subtitle.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L325">                } else {</span>
<span class="nc" id="L326">                    actionableEmptyView.title.setText(R.string.media_empty_search_list);</span>
<span class="nc" id="L327">                    actionableEmptyView.subtitle.setVisibility(View.GONE);</span>
                }
            }
        }
<span class="nc" id="L331">    }</span>

    private void showProgress(boolean show) {
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (!isFinishing()) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            findViewById(R.id.progress).setVisibility(show ? View.VISIBLE : View.GONE);</span>
        }
<span class="nc" id="L337">    }</span>

    private void showUploadProgressDialog(boolean show) {
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (show) {</span>
<span class="nc" id="L341">            mProgressDialog = new ProgressDialog(this);</span>
<span class="nc" id="L342">            mProgressDialog.setCancelable(false);</span>
<span class="nc" id="L343">            mProgressDialog.setIndeterminate(true);</span>
<span class="nc" id="L344">            mProgressDialog.setMessage(getString(R.string.uploading_media));</span>
<span class="nc" id="L345">            mProgressDialog.show();</span>
<span class="nc bnc" id="L346" title="All 4 branches missed.">        } else if (mProgressDialog != null &amp;&amp; mProgressDialog.isShowing()) {</span>
<span class="nc" id="L347">            mProgressDialog.dismiss();</span>
        }
<span class="nc" id="L349">    }</span>

    private void submitSearch(@Nullable final String query, boolean delayed) {
<span class="nc" id="L352">        mSearchQuery = query;</span>

<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (delayed) {</span>
<span class="nc" id="L355">            mHandler.postDelayed(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc bnc" id="L358" title="All 2 branches missed.">                    if (StringUtils.equals(query, mSearchQuery)) {</span>
<span class="nc" id="L359">                        submitSearch(query, false);</span>
                    }
<span class="nc" id="L361">                }</span>
            }, 500);
        } else {
<span class="nc" id="L364">            fetchStockMedia(query, 1);</span>
        }
<span class="nc" id="L366">    }</span>

    private void fetchStockMedia(@Nullable String searchQuery, int page) {
        // We should always fetch the first page, but We should only load more pages if we are not
        // already fetching anything
<span class="nc bnc" id="L371" title="All 6 branches missed.">        if ((mIsFetching &amp;&amp; page != 1) || !NetworkUtils.checkConnection(this)) {</span>
<span class="nc" id="L372">            return;</span>
        }

<span class="nc" id="L375">        mSearchQuery = searchQuery;</span>

<span class="nc bnc" id="L377" title="All 4 branches missed.">        if (mSearchQuery == null || mSearchQuery.length() &lt; MIN_SEARCH_QUERY_SIZE) {</span>
<span class="nc" id="L378">            mIsFetching = false;</span>
<span class="nc" id="L379">            showProgress(false);</span>
<span class="nc" id="L380">            mAdapter.clear();</span>
<span class="nc" id="L381">            showEmptyView(true);</span>
<span class="nc" id="L382">            return;</span>
        }

<span class="nc bnc" id="L385" title="All 2 branches missed.">        if (page == 1) {</span>
<span class="nc" id="L386">            mAdapter.clear();</span>
        }

<span class="nc" id="L389">        showProgress(true);</span>
<span class="nc" id="L390">        mIsFetching = true;</span>
<span class="nc" id="L391">        showEmptyView(false);</span>

<span class="nc" id="L393">        AppLog.d(AppLog.T.MEDIA, &quot;Fetching stock media page &quot; + page);</span>

<span class="nc" id="L395">        FetchStockMediaListPayload payload = new FetchStockMediaListPayload(searchQuery, page);</span>
<span class="nc" id="L396">        mDispatcher.dispatch(StockMediaActionBuilder.newFetchStockMediaAction(payload));</span>
<span class="nc" id="L397">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onStockMediaListFetched(OnStockMediaListFetched event) {
        // make sure these results are for the same query
<span class="nc bnc" id="L403" title="All 4 branches missed.">        if (mSearchQuery == null || !mSearchQuery.equals(event.searchTerm)) {</span>
<span class="nc" id="L404">            return;</span>
        }

<span class="nc" id="L407">        mIsFetching = false;</span>
<span class="nc" id="L408">        showProgress(false);</span>

<span class="nc bnc" id="L410" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L411">            AppLog.e(AppLog.T.MEDIA, &quot;An error occurred while searching stock media&quot;);</span>
<span class="nc" id="L412">            ToastUtils.showToast(this, R.string.media_generic_error);</span>
<span class="nc" id="L413">            mCanLoadMore = false;</span>
<span class="nc" id="L414">            return;</span>
        }

<span class="nc" id="L417">        AnalyticsTracker.track(AnalyticsTracker.Stat.STOCK_MEDIA_SEARCHED);</span>

<span class="nc" id="L419">        mNextPage = event.nextPage;</span>
<span class="nc" id="L420">        mCanLoadMore = event.canLoadMore;</span>

        // set the results to the event's mediaList if this is the first page, otherwise add to the existing results
<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (event.nextPage == 2) {</span>
<span class="nc" id="L424">            mAdapter.setMediaList(event.mediaList);</span>
        } else {
<span class="nc" id="L426">            mAdapter.addMediaList(event.mediaList);</span>
        }

<span class="nc bnc" id="L429" title="All 4 branches missed.">        showEmptyView(mAdapter.isEmpty() &amp;&amp; !TextUtils.isEmpty(mSearchQuery));</span>
<span class="nc" id="L430">    }</span>


    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onStockMediaUploaded(OnStockMediaUploaded event) {
<span class="nc" id="L436">        mIsUploading = false;</span>
<span class="nc" id="L437">        showUploadProgressDialog(false);</span>

<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L440">            ToastUtils.showToast(this, R.string.media_upload_error);</span>
<span class="nc" id="L441">            AppLog.e(AppLog.T.MEDIA, &quot;An error occurred while uploading stock media&quot;);</span>
        } else {
<span class="nc" id="L443">            trackUploadedStockMediaEvent(event.mediaList);</span>
<span class="nc" id="L444">            int count = event.mediaList.size();</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">            if (count == 0) {</span>
<span class="nc" id="L446">                AppLog.w(AppLog.T.MEDIA, &quot;No stock media chosen&quot;);</span>
<span class="nc" id="L447">                return;</span>
            }

<span class="nc" id="L450">            Intent intent = new Intent();</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">            if (isMultiSelectEnabled()) {</span>
<span class="nc" id="L452">                long[] idArray = new long[count];</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                for (int i = 0; i &lt; count; i++) {</span>
<span class="nc" id="L454">                    idArray[i] = event.mediaList.get(i).getMediaId();</span>
                }
<span class="nc" id="L456">                intent.putExtra(KEY_UPLOADED_MEDIA_IDS, idArray);</span>
<span class="nc" id="L457">            } else {</span>
<span class="nc" id="L458">                intent.putExtra(MediaPickerConstants.EXTRA_MEDIA_ID, event.mediaList.get(0).getMediaId());</span>
            }

<span class="nc" id="L461">            setResult(RESULT_OK, intent);</span>
<span class="nc" id="L462">            finish();</span>
        }
<span class="nc" id="L464">    }</span>

    private void trackUploadedStockMediaEvent(@NonNull List&lt;MediaModel&gt; mediaList) {
<span class="nc bnc" id="L467" title="All 2 branches missed.">        if (mediaList.size() == 0) {</span>
<span class="nc" id="L468">            AppLog.e(AppLog.T.MEDIA, &quot;Cannot track uploaded stock media event if mediaList is empty&quot;);</span>
<span class="nc" id="L469">            return;</span>
        }

<span class="nc bnc" id="L472" title="All 2 branches missed.">        boolean isMultiselect = mediaList.size() &gt; 1;</span>
<span class="nc" id="L473">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L474">        properties.put(&quot;is_part_of_multiselection&quot;, isMultiselect);</span>
<span class="nc" id="L475">        properties.put(&quot;number_of_media_selected&quot;, mediaList.size());</span>
<span class="nc" id="L476">        AnalyticsTracker.track(AnalyticsTracker.Stat.STOCK_MEDIA_UPLOADED, properties);</span>
<span class="nc" id="L477">    }</span>

    private void showSelectionBar(final boolean show) {
<span class="nc bnc" id="L480" title="All 4 branches missed.">        if (show &amp;&amp; mSelectionBar.getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L481">            AniUtils.animateBottomBar(mSelectionBar, true);</span>
<span class="nc bnc" id="L482" title="All 4 branches missed.">        } else if (!show &amp;&amp; mSelectionBar.getVisibility() == View.VISIBLE) {</span>
<span class="nc" id="L483">            AniUtils.animateBottomBar(mSelectionBar, false);</span>
        } else {
<span class="nc" id="L485">            return;</span>
        }

        // when the animation completes, adjust the relative layout params of the recycler to make
        // sure the bar doesn't overlap the bottom row when showing
<span class="nc" id="L490">        long msDelay = AniUtils.Duration.SHORT.toMillis(this);</span>
<span class="nc" id="L491">        mHandler.postDelayed(new Runnable() {</span>
            @Override public void run() {
<span class="nc bnc" id="L493" title="All 2 branches missed.">                if (!isFinishing()) {</span>
<span class="nc" id="L494">                    RelativeLayout.LayoutParams params = (RelativeLayout.LayoutParams) mRecycler.getLayoutParams();</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">                    if (show) {</span>
<span class="nc" id="L496">                        params.addRule(RelativeLayout.ABOVE, R.id.container_selection_bar);</span>
                    } else {
<span class="nc" id="L498">                        params.addRule(RelativeLayout.ABOVE, 0);</span>
                    }
                }
<span class="nc" id="L501">            }</span>
        }, msDelay);
<span class="nc" id="L503">    }</span>

    private void notifySelectionCountChanged() {
<span class="nc" id="L506">        int numSelected = mAdapter.getSelectionCount();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        if (numSelected &gt; 0) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">            if (isMultiSelectEnabled()) {</span>
<span class="nc" id="L509">                String labelAdd = String.format(getString(R.string.add_count), numSelected);</span>
<span class="nc" id="L510">                mTextAdd.setText(labelAdd);</span>

<span class="nc" id="L512">                String labelPreview = String.format(getString(R.string.preview_count), numSelected);</span>
<span class="nc" id="L513">                mTextPreview.setText(labelPreview);</span>
            }
<span class="nc" id="L515">            showSelectionBar(true);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">            if (numSelected == 1) {</span>
<span class="nc" id="L517">                ActivityUtils.hideKeyboardForced(mSearchView);</span>
            }
        } else {
<span class="nc" id="L520">            showSelectionBar(false);</span>
        }
<span class="nc" id="L522">    }</span>

    private void previewSelection() {
<span class="nc" id="L525">        List&lt;StockMediaModel&gt; items = mAdapter.getSelectedStockMedia();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (items.size() == 0) return;</span>

<span class="nc" id="L528">        ArrayList&lt;String&gt; imageUrlList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        for (StockMediaModel media : items) {</span>
<span class="nc" id="L530">            imageUrlList.add(media.getUrl());</span>
<span class="nc" id="L531">        }</span>
<span class="nc" id="L532">        MediaPreviewActivity.showPreview(this, null, imageUrlList, imageUrlList.get(0));</span>
<span class="nc" id="L533">    }</span>

    private void uploadSelection() {
<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(this)) return;</span>

<span class="nc" id="L538">        mIsUploading = true;</span>
<span class="nc" id="L539">        showUploadProgressDialog(true);</span>
<span class="nc" id="L540">        List&lt;StockMediaModel&gt; items = mAdapter.getSelectedStockMedia();</span>
<span class="nc" id="L541">        UploadStockMediaPayload payload = new UploadStockMediaPayload(mSite, items);</span>
<span class="nc" id="L542">        mDispatcher.dispatch(MediaActionBuilder.newUploadStockMediaAction(payload));</span>
<span class="nc" id="L543">    }</span>

    class StockMediaAdapter extends RecyclerView.Adapter&lt;StockViewHolder&gt; {
        private static final float SCALE_NORMAL = 1.0f;
        private static final float SCALE_SELECTED = .8f;

<span class="nc" id="L549">        private final List&lt;StockMediaModel&gt; mItems = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L550">        private final ArrayList&lt;Integer&gt; mSelectedItems = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L552">        StockMediaAdapter() {</span>
<span class="nc" id="L553">            setHasStableIds(true);</span>
<span class="nc" id="L554">        }</span>

        void setMediaList(@NonNull List&lt;StockMediaModel&gt; mediaList) {
<span class="nc" id="L557">            mItems.clear();</span>
<span class="nc" id="L558">            mItems.addAll(mediaList);</span>
<span class="nc" id="L559">            notifyDataSetChanged();</span>
<span class="nc" id="L560">        }</span>

        void addMediaList(@NonNull List&lt;StockMediaModel&gt; mediaList) {
<span class="nc" id="L563">            mItems.addAll(mediaList);</span>
<span class="nc" id="L564">            notifyDataSetChanged();</span>
<span class="nc" id="L565">        }</span>

        void clear() {
<span class="nc" id="L568">            mItems.clear();</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">            if (mSelectedItems.size() &gt; 0) {</span>
<span class="nc" id="L570">                mSelectedItems.clear();</span>
<span class="nc" id="L571">                notifySelectionCountChanged();</span>
            }
<span class="nc" id="L573">            notifyDataSetChanged();</span>
<span class="nc" id="L574">        }</span>

        @Override
        public long getItemId(int position) {
<span class="nc" id="L578">            return mItems.get(position).getId().hashCode();</span>
        }

        @Override
        public int getItemCount() {
<span class="nc" id="L583">            return mItems.size();</span>
        }

        boolean isEmpty() {
<span class="nc bnc" id="L587" title="All 2 branches missed.">            return getItemCount() == 0;</span>
        }

        @NonNull
        @Override
        public StockViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
<span class="nc" id="L593">            View view = getLayoutInflater().inflate(R.layout.media_picker_thumbnail, parent, false);</span>
<span class="nc" id="L594">            return new StockViewHolder(view);</span>
        }

        @Override
        public void onBindViewHolder(@NonNull StockViewHolder holder, int position) {
<span class="nc" id="L599">            StockMediaModel media = mItems.get(position);</span>
<span class="nc" id="L600">            String imageUrl = PhotonUtils.getPhotonImageUrl(media.getThumbnail(), mThumbWidth, mThumbHeight);</span>
<span class="nc" id="L601">            mImageManager.load(holder.mImageView, ImageType.PHOTO, imageUrl, ScaleType.CENTER_CROP);</span>

<span class="nc" id="L603">            holder.mImageView.setContentDescription(media.getTitle());</span>


<span class="nc" id="L606">            boolean isSelected = isItemSelected(position);</span>
<span class="nc" id="L607">            holder.mSelectionCountTextView.setSelected(isSelected);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">            if (isMultiSelectEnabled()) {</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">                if (isSelected) {</span>
<span class="nc" id="L610">                    int count = mSelectedItems.indexOf(position) + 1;</span>
<span class="nc" id="L611">                    String label = Integer.toString(count);</span>
<span class="nc" id="L612">                    holder.mSelectionCountTextView.setText(label);</span>
<span class="nc" id="L613">                } else {</span>
<span class="nc" id="L614">                    holder.mSelectionCountTextView.setText(null);</span>
                }
            } else {
<span class="nc" id="L617">                holder.mSelectionCountTextView.setVisibility(</span>
<span class="nc bnc" id="L618" title="All 4 branches missed.">                        isSelected || isMultiSelectEnabled() ? View.VISIBLE : View.GONE);</span>
            }

<span class="nc bnc" id="L621" title="All 2 branches missed.">            float scale = isSelected ? SCALE_SELECTED : SCALE_NORMAL;</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">            if (holder.mImageView.getScaleX() != scale) {</span>
<span class="nc" id="L623">                holder.mImageView.setScaleX(scale);</span>
<span class="nc" id="L624">                holder.mImageView.setScaleY(scale);</span>
            }

<span class="nc bnc" id="L627" title="All 4 branches missed.">            if (mCanLoadMore &amp;&amp; position == getItemCount() - 1) {</span>
<span class="nc" id="L628">                fetchStockMedia(mSearchQuery, mNextPage);</span>
            }
<span class="nc" id="L630">            addImageSelectedToAccessibilityFocusedEvent(holder.mImageView, position);</span>
<span class="nc" id="L631">        }</span>

        private void addImageSelectedToAccessibilityFocusedEvent(ImageView imageView, int position) {
<span class="nc" id="L634">            AccessibilityUtils.addPopulateAccessibilityEventFocusedListener(imageView, event -&gt; {</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">                if (isValidPosition(position)) {</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                    if (isItemSelected(position)) {</span>
<span class="nc" id="L637">                        final String imageSelectedText = imageView.getContext().getString(</span>
                                R.string.photo_picker_image_selected);
<span class="nc bnc" id="L639" title="All 2 branches missed.">                        if (!imageView.getContentDescription().toString().contains(imageSelectedText)) {</span>
<span class="nc" id="L640">                            imageView.setContentDescription(</span>
<span class="nc" id="L641">                                    imageView.getContentDescription() + &quot; &quot;</span>
                                    + imageSelectedText);
                        }
                    }
                }
<span class="nc" id="L646">            });</span>
<span class="nc" id="L647">        }</span>

        boolean isValidPosition(int position) {
<span class="nc bnc" id="L650" title="All 4 branches missed.">            return position &gt;= 0 &amp;&amp; position &lt; getItemCount();</span>
        }

        boolean isItemSelected(int position) {
<span class="nc" id="L654">            return mSelectedItems.contains(position);</span>
        }

        void setItemSelected(StockViewHolder holder, int position, boolean selected) {
<span class="nc bnc" id="L658" title="All 2 branches missed.">            if (!isValidPosition(position)) return;</span>

            // if this is single select, make sure to deselect any existing selection
<span class="nc bnc" id="L661" title="All 6 branches missed.">            if (selected &amp;&amp; !isMultiSelectEnabled() &amp;&amp; !mSelectedItems.isEmpty()) {</span>
<span class="nc" id="L662">                int prevPosition = mSelectedItems.get(0);</span>
<span class="nc" id="L663">                StockViewHolder prevHolder = (StockViewHolder) mRecycler.findViewHolderForAdapterPosition(prevPosition);</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">                if (prevHolder != null) {</span>
<span class="nc" id="L665">                    setItemSelected(prevHolder, prevPosition, false);</span>
                } else {
                    // holder may be null if not laid out
<span class="nc" id="L668">                    mSelectedItems.clear();</span>
                }
            }

<span class="nc bnc" id="L672" title="All 2 branches missed.">            if (selected) {</span>
<span class="nc" id="L673">                mSelectedItems.add(position);</span>
            } else {
<span class="nc" id="L675">                int index = mSelectedItems.indexOf(position);</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">                if (index == -1) {</span>
<span class="nc" id="L677">                    return;</span>
                }
<span class="nc" id="L679">                mSelectedItems.remove(index);</span>
            }

            // show and animate the count bubble
<span class="nc bnc" id="L683" title="All 2 branches missed.">            if (isMultiSelectEnabled()) {</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">                if (selected) {</span>
<span class="nc" id="L685">                    String label = Integer.toString(mSelectedItems.indexOf(position) + 1);</span>
<span class="nc" id="L686">                    holder.mSelectionCountTextView.setText(label);</span>
<span class="nc" id="L687">                } else {</span>
<span class="nc" id="L688">                    holder.mSelectionCountTextView.setText(null);</span>
                }
<span class="nc" id="L690">                AniUtils.startAnimation(holder.mSelectionCountTextView, R.anim.pop);</span>
            } else {
<span class="nc bnc" id="L692" title="All 2 branches missed.">                if (selected) {</span>
<span class="nc" id="L693">                    AniUtils.scaleIn(holder.mSelectionCountTextView, AniUtils.Duration.MEDIUM);</span>
                } else {
<span class="nc" id="L695">                    AniUtils.scaleOut(holder.mSelectionCountTextView, AniUtils.Duration.MEDIUM);</span>
                }
            }

            // scale the thumbnail
<span class="nc bnc" id="L700" title="All 2 branches missed.">            if (selected) {</span>
<span class="nc" id="L701">                AniUtils.scale(holder.mImageView, SCALE_NORMAL, SCALE_SELECTED, AniUtils.Duration.SHORT);</span>
            } else {
<span class="nc" id="L703">                AniUtils.scale(holder.mImageView, SCALE_SELECTED, SCALE_NORMAL, AniUtils.Duration.SHORT);</span>
            }

            // redraw after the scale animation completes
<span class="nc" id="L707">            long delayMs = AniUtils.Duration.SHORT.toMillis(StockMediaPickerActivity.this);</span>
<span class="nc" id="L708">            new Handler().postDelayed(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc" id="L711">                    notifyDataSetChanged();</span>
<span class="nc" id="L712">                }</span>
            }, delayMs);
<span class="nc" id="L714">        }</span>

        private void toggleItemSelected(StockViewHolder holder, int position) {
<span class="nc bnc" id="L717" title="All 2 branches missed.">            if (!isValidPosition(position)) return;</span>

<span class="nc" id="L719">            boolean isSelected = isItemSelected(position);</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">            setItemSelected(holder, position, !isSelected);</span>
<span class="nc" id="L721">            notifySelectionCountChanged();</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">            PhotoPickerUtils.announceSelectedMediaForAccessibility(holder.mImageView, false, !isSelected);</span>
<span class="nc" id="L723">        }</span>

        @SuppressWarnings(&quot;unused&quot;)
        private List&lt;StockMediaModel&gt; getSelectedStockMedia() {
<span class="nc" id="L727">            List&lt;StockMediaModel&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">            for (int i : mSelectedItems) {</span>
<span class="nc" id="L729">                items.add(mItems.get(i));</span>
<span class="nc" id="L730">            }</span>
<span class="nc" id="L731">            return items;</span>
        }

        private void setSelectedItems(@NonNull List&lt;Integer&gt; selectedItems) {
<span class="nc bnc" id="L735" title="All 4 branches missed.">            if (mSelectedItems.isEmpty() &amp;&amp; selectedItems.isEmpty()) {</span>
<span class="nc" id="L736">                return;</span>
            }

<span class="nc" id="L739">            mSelectedItems.clear();</span>
<span class="nc" id="L740">            mSelectedItems.addAll(selectedItems);</span>
<span class="nc" id="L741">            notifyDataSetChanged();</span>
<span class="nc" id="L742">            notifySelectionCountChanged();</span>
<span class="nc" id="L743">        }</span>

        int getSelectionCount() {
<span class="nc" id="L746">            return mSelectedItems.size();</span>
        }
    }

    class StockViewHolder extends RecyclerView.ViewHolder {
        private final ImageView mImageView;
        private final TextView mSelectionCountTextView;

<span class="nc" id="L754">        StockViewHolder(View view) {</span>
<span class="nc" id="L755">            super(view);</span>

<span class="nc" id="L757">            mImageView = view.findViewById(R.id.image_thumbnail);</span>
<span class="nc" id="L758">            mSelectionCountTextView = view.findViewById(R.id.text_selection_count);</span>

<span class="nc" id="L760">            mImageView.getLayoutParams().width = mThumbWidth;</span>
<span class="nc" id="L761">            mImageView.getLayoutParams().height = mThumbHeight;</span>

<span class="nc" id="L763">            mImageView.setOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View v) {
<span class="nc" id="L766">                    int position = getAdapterPosition();</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">                    if (mAdapter.isValidPosition(position)) {</span>
<span class="nc" id="L768">                        mAdapter.toggleItemSelected(StockViewHolder.this, position);</span>
                    }
<span class="nc" id="L770">                }</span>
            });

<span class="nc" id="L773">            mImageView.setOnLongClickListener(new View.OnLongClickListener() {</span>
                @Override
                public boolean onLongClick(View v) {
<span class="nc" id="L776">                    int position = getAdapterPosition();</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                    if (mAdapter.isValidPosition(position)) {</span>
<span class="nc" id="L778">                        MediaPreviewActivity.showPreview(v.getContext(), mSite, mAdapter.mItems.get(position).getUrl());</span>
                    }
<span class="nc" id="L780">                    return true;</span>
                }
            });
<span class="nc" id="L783">            ViewExtensionsKt.redirectContextClickToLongPressListener(mImageView);</span>
<span class="nc" id="L784">        }</span>
    }

    private int getColumnCount() {
<span class="nc bnc" id="L788" title="All 2 branches missed.">        return DisplayUtils.isLandscape(this) ? 4 : 3;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>