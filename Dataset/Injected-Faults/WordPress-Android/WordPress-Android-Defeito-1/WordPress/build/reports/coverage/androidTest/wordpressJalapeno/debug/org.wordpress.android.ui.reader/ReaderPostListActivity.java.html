<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderPostListActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader</a> &gt; <span class="el_source">ReaderPostListActivity.java</span></div><h1>ReaderPostListActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader;

import android.app.Activity;
import android.content.ActivityNotFoundException;
import android.content.Intent;
import android.os.Bundle;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;

import androidx.annotation.NonNull;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.widget.Toolbar;
import androidx.coordinatorlayout.widget.CoordinatorLayout;
import androidx.fragment.app.Fragment;

import com.google.android.material.appbar.AppBarLayout;

import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.datasets.ReaderBlogTable;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.model.PostModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.PostStore;
import org.wordpress.android.fluxc.store.PostStore.OnPostUploaded;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.models.ReaderBlog;
import org.wordpress.android.models.ReaderTag;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.LocaleAwareActivity;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.mysite.SelectedSiteRepository;
import org.wordpress.android.ui.posts.EditPostActivity;
import org.wordpress.android.ui.reader.ReaderTypes.ReaderPostListType;
import org.wordpress.android.ui.reader.tracker.ReaderTracker;
import org.wordpress.android.ui.uploads.UploadActionUseCase;
import org.wordpress.android.ui.uploads.UploadUtils;
import org.wordpress.android.ui.uploads.UploadUtilsWrapper;
import org.wordpress.android.util.ToastUtils;

import javax.inject.Inject;

/*
 * serves as the host for ReaderPostListFragment when showing blog preview &amp; tag preview
 */
<span class="nc" id="L50">public class ReaderPostListActivity extends LocaleAwareActivity {</span>
    private String mSource;
    private ReaderPostListType mPostListType;
    private long mSiteId;

    @Inject SiteStore mSiteStore;
    @Inject PostStore mPostStore;
    @Inject Dispatcher mDispatcher;
    @Inject UploadActionUseCase mUploadActionUseCase;
    @Inject UploadUtilsWrapper mUploadUtilsWrapper;
    @Inject ReaderTracker mReaderTracker;
    @Inject SelectedSiteRepository mSelectedSiteRepository;

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L65">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L66">        ((WordPress) getApplication()).component().inject(this);</span>

<span class="nc" id="L68">        setContentView(R.layout.reader_activity_post_list);</span>

<span class="nc" id="L70">        Toolbar toolbar = findViewById(R.id.toolbar_main);</span>
<span class="nc" id="L71">        setSupportActionBar(toolbar);</span>
<span class="nc" id="L72">        ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L74">            actionBar.setDisplayShowTitleEnabled(true);</span>
<span class="nc" id="L75">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
        }

<span class="nc" id="L78">        mSource = getIntent().getStringExtra(ReaderConstants.ARG_SOURCE);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (getIntent().hasExtra(ReaderConstants.ARG_POST_LIST_TYPE)) {</span>
<span class="nc" id="L80">            mPostListType = (ReaderPostListType) getIntent().getSerializableExtra(ReaderConstants.ARG_POST_LIST_TYPE);</span>
        } else {
<span class="nc" id="L82">            mPostListType = ReaderTypes.DEFAULT_POST_LIST_TYPE;</span>
        }

<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (getPostListType() == ReaderPostListType.TAG_PREVIEW</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            || getPostListType() == ReaderPostListType.BLOG_PREVIEW) {</span>
            // show an X in the toolbar which closes the activity - if this is blog preview
<span class="nc bnc" id="L88" title="All 2 branches missed.">            boolean showCrossButton = getPostListType() == ReaderPostListType.BLOG_PREVIEW;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            if (showCrossButton) {</span>
<span class="nc" id="L90">                toolbar.setNavigationIcon(R.drawable.ic_cross_white_24dp);</span>
            }
<span class="nc" id="L92">            toolbar.setNavigationOnClickListener(new View.OnClickListener() {</span>
                @Override
                public void onClick(View view) {
<span class="nc" id="L95">                    finish();</span>
<span class="nc" id="L96">                }</span>
            });

<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (getPostListType() == ReaderPostListType.BLOG_PREVIEW) {</span>
<span class="nc" id="L100">                setTitle(R.string.reader_title_blog_preview);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                if (savedInstanceState == null) {</span>
<span class="nc" id="L102">                    long blogId = getIntent().getLongExtra(ReaderConstants.ARG_BLOG_ID, 0);</span>
<span class="nc" id="L103">                    long feedId = getIntent().getLongExtra(ReaderConstants.ARG_FEED_ID, 0);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                    if (feedId != 0) {</span>
<span class="nc" id="L105">                        showListFragmentForFeed(feedId);</span>
<span class="nc" id="L106">                        mSiteId = feedId;</span>
                    } else {
<span class="nc" id="L108">                        showListFragmentForBlog(blogId);</span>
<span class="nc" id="L109">                        mSiteId = blogId;</span>
                    }
<span class="nc" id="L111">                } else {</span>
<span class="nc" id="L112">                    mSiteId = savedInstanceState.getLong(ReaderConstants.KEY_SITE_ID);</span>
                }
<span class="nc bnc" id="L114" title="All 2 branches missed.">            } else if (getPostListType() == ReaderPostListType.TAG_PREVIEW) {</span>
<span class="nc" id="L115">                setTitle(R.string.reader_title_tag_preview);</span>
<span class="nc" id="L116">                ReaderTag tag = (ReaderTag) getIntent().getSerializableExtra(ReaderConstants.ARG_TAG);</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">                if (tag != null &amp;&amp; savedInstanceState == null) {</span>
<span class="nc" id="L118">                    showListFragmentForTag(tag, mPostListType);</span>
                }
            }
        }

        // restore the activity title
<span class="nc bnc" id="L124" title="All 4 branches missed.">        if (savedInstanceState != null &amp;&amp; savedInstanceState.containsKey(ReaderConstants.KEY_ACTIVITY_TITLE)) {</span>
<span class="nc" id="L125">            setTitle(savedInstanceState.getString(ReaderConstants.KEY_ACTIVITY_TITLE));</span>
        }
<span class="nc" id="L127">    }</span>

    @Override
    protected void onResumeFragments() {
<span class="nc" id="L131">        super.onResumeFragments();</span>
        // this particular Activity doesn't show filtering, so we'll disable the FilteredRecyclerView toolbar here
<span class="nc" id="L133">        disableFilteredRecyclerViewToolbar();</span>
<span class="nc" id="L134">    }</span>

    @Override
    protected void onResume() {
<span class="nc" id="L138">        super.onResume();</span>
        // We register the dispatcher in order to receive the OnPostUploaded event and show the snackbar
<span class="nc" id="L140">        mDispatcher.register(this);</span>
<span class="nc" id="L141">    }</span>

    @Override
    protected void onPause() {
<span class="nc" id="L145">        super.onPause();</span>
<span class="nc" id="L146">        mDispatcher.unregister(this);</span>
<span class="nc" id="L147">    }</span>

    /*
     * This method hides the FilteredRecyclerView toolbar with spinner so to disable content filtering, for reusability
     */
    private void disableFilteredRecyclerViewToolbar() {
        // make it invisible - setting height to zero here because setting visibility to View.GONE wouldn't take the
        // occupied space, as otherwise expected
<span class="nc" id="L155">        AppBarLayout appBarLayout = findViewById(R.id.app_bar_layout);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (appBarLayout != null) {</span>
<span class="nc" id="L157">            CoordinatorLayout.LayoutParams lp = (CoordinatorLayout.LayoutParams) appBarLayout.getLayoutParams();</span>
<span class="nc" id="L158">            lp.height = 0;</span>
<span class="nc" id="L159">            appBarLayout.setLayoutParams(lp);</span>
        }

        // disabling any CoordinatorLayout behavior for scrolling
<span class="nc" id="L163">        Toolbar toolbarWithSpinner = findViewById(R.id.toolbar_with_spinner);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (toolbarWithSpinner != null) {</span>
<span class="nc" id="L165">            AppBarLayout.LayoutParams p = (AppBarLayout.LayoutParams) toolbarWithSpinner.getLayoutParams();</span>
<span class="nc" id="L166">            p.setScrollFlags(0);</span>
<span class="nc" id="L167">            toolbarWithSpinner.setLayoutParams(p);</span>
        }
<span class="nc" id="L169">    }</span>

    private ReaderPostListType getPostListType() {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        return (mPostListType != null ? mPostListType : ReaderTypes.DEFAULT_POST_LIST_TYPE);</span>
    }

    @Override
    public void onSaveInstanceState(@NonNull Bundle outState) {
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (outState.isEmpty()) {</span>
<span class="nc" id="L178">            outState.putBoolean(&quot;bug_19917_fix&quot;, true);</span>
        }

        // store the title for blog/tag preview so we can restore it upon recreation
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (getPostListType() == ReaderPostListType.BLOG_PREVIEW</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            || getPostListType() == ReaderPostListType.TAG_PREVIEW) {</span>
<span class="nc" id="L184">            outState.putString(ReaderConstants.KEY_ACTIVITY_TITLE, getTitle().toString());</span>
<span class="nc" id="L185">            outState.putLong(ReaderConstants.KEY_SITE_ID, mSiteId);</span>
        }

<span class="nc" id="L188">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L189">    }</span>

    @Override
    public void onBackPressed() {
<span class="nc" id="L193">        ReaderPostListFragment fragment = getListFragment();</span>
<span class="nc bnc" id="L194" title="All 4 branches missed.">        if (fragment == null || !fragment.onActivityBackPressed()) {</span>
<span class="nc" id="L195">            super.onBackPressed();</span>
        }
<span class="nc" id="L197">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (getPostListType() == ReaderPostListType.BLOG_PREVIEW) {</span>
<span class="nc" id="L202">            getMenuInflater().inflate(R.menu.share, menu);</span>
        }

<span class="nc" id="L205">        return super.onCreateOptionsMenu(menu);</span>
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L210" title="All 3 branches missed.">        switch (item.getItemId()) {</span>
            case android.R.id.home:
<span class="nc" id="L212">                onBackPressed();</span>
<span class="nc" id="L213">                return true;</span>
            case R.id.menu_share:
<span class="nc" id="L215">                shareSite();</span>
<span class="nc" id="L216">                return true;</span>
        }

<span class="nc" id="L219">        return super.onOptionsItemSelected(item);</span>
    }

    private void shareSite() {
<span class="nc" id="L223">        ReaderBlog blog = ReaderBlogTable.getBlogInfo(mSiteId);</span>

<span class="nc bnc" id="L225" title="All 4 branches missed.">        if (blog != null &amp;&amp; blog.hasUrl()) {</span>
<span class="nc" id="L226">            Intent intent = new Intent(Intent.ACTION_SEND);</span>
<span class="nc" id="L227">            intent.setType(&quot;text/plain&quot;);</span>
<span class="nc" id="L228">            intent.putExtra(Intent.EXTRA_TEXT, blog.getUrl());</span>

<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (blog.hasName()) {</span>
<span class="nc" id="L231">                intent.putExtra(Intent.EXTRA_SUBJECT, blog.getName());</span>
            }

            try {
<span class="nc" id="L235">                mReaderTracker.trackBlog(</span>
                        AnalyticsTracker.Stat.READER_SITE_SHARED,
                        blog.blogId,
                        blog.feedId,
<span class="nc" id="L239">                        blog.isFollowing,</span>
                        mSource
                );
<span class="nc" id="L242">                startActivity(Intent.createChooser(intent, getString(R.string.share_link)));</span>
<span class="nc" id="L243">            } catch (ActivityNotFoundException exception) {</span>
<span class="nc" id="L244">                ToastUtils.showToast(ReaderPostListActivity.this, R.string.reader_toast_err_share_intent);</span>
<span class="nc" id="L245">            }</span>
<span class="nc" id="L246">        } else {</span>
<span class="nc" id="L247">            ToastUtils.showToast(ReaderPostListActivity.this, R.string.reader_toast_err_share_intent);</span>
        }
<span class="nc" id="L249">    }</span>

    /*
     * show fragment containing list of latest posts for a specific tag
     */
    private void showListFragmentForTag(@NonNull final ReaderTag tag, ReaderPostListType listType) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L256">            return;</span>
        }
<span class="nc" id="L258">        Fragment fragment = ReaderPostListFragment.newInstanceForTag(tag, listType);</span>
<span class="nc" id="L259">        getSupportFragmentManager()</span>
<span class="nc" id="L260">                .beginTransaction()</span>
<span class="nc" id="L261">                .replace(R.id.fragment_container, fragment, getString(R.string.fragment_tag_reader_post_list))</span>
<span class="nc" id="L262">                .commit();</span>
<span class="nc" id="L263">    }</span>

    /*
     * show fragment containing list of latest posts in a specific blog
     */
    private void showListFragmentForBlog(long blogId) {
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L270">            return;</span>
        }
<span class="nc" id="L272">        Fragment fragment = ReaderPostListFragment.newInstanceForBlog(blogId);</span>
<span class="nc" id="L273">        getSupportFragmentManager()</span>
<span class="nc" id="L274">                .beginTransaction()</span>
<span class="nc" id="L275">                .replace(R.id.fragment_container, fragment, getString(R.string.fragment_tag_reader_post_list))</span>
<span class="nc" id="L276">                .commit();</span>

<span class="nc" id="L278">        String title = ReaderBlogTable.getBlogName(blogId);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (title.isEmpty()) {</span>
<span class="nc" id="L280">            title = getString(R.string.reader_title_blog_preview);</span>
        }
<span class="nc" id="L282">        setTitle(title);</span>
<span class="nc" id="L283">    }</span>

    private void showListFragmentForFeed(long feedId) {
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L287">            return;</span>
        }
<span class="nc" id="L289">        Fragment fragment = ReaderPostListFragment.newInstanceForFeed(feedId);</span>
<span class="nc" id="L290">        getSupportFragmentManager()</span>
<span class="nc" id="L291">                .beginTransaction()</span>
<span class="nc" id="L292">                .replace(R.id.fragment_container, fragment, getString(R.string.fragment_tag_reader_post_list))</span>
<span class="nc" id="L293">                .commit();</span>

<span class="nc" id="L295">        String title = ReaderBlogTable.getFeedName(feedId);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (title.isEmpty()) {</span>
<span class="nc" id="L297">            title = getString(R.string.reader_title_blog_preview);</span>
        }
<span class="nc" id="L299">        setTitle(title);</span>
<span class="nc" id="L300">    }</span>

    private ReaderPostListFragment getListFragment() {
<span class="nc" id="L303">        Fragment fragment =</span>
<span class="nc" id="L304">                getSupportFragmentManager().findFragmentByTag(getString(R.string.fragment_tag_reader_post_list));</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (fragment == null) {</span>
<span class="nc" id="L306">            return null;</span>
        }
<span class="nc" id="L308">        return ((ReaderPostListFragment) fragment);</span>
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L313">        super.onActivityResult(requestCode, resultCode, data);</span>

<span class="nc bnc" id="L315" title="All 3 branches missed.">        switch (requestCode) {</span>
            case RequestCodes.NO_REBLOG_SITE:
<span class="nc bnc" id="L317" title="All 2 branches missed.">                if (resultCode == Activity.RESULT_OK) {</span>
<span class="nc" id="L318">                    finish(); // Finish activity to make My Site page visible</span>
                }
                break;
            case RequestCodes.EDIT_POST:
<span class="nc bnc" id="L322" title="All 6 branches missed.">                if (resultCode == Activity.RESULT_OK &amp;&amp; data != null &amp;&amp; !isFinishing()) {</span>
<span class="nc" id="L323">                    int localId = data.getIntExtra(EditPostActivity.EXTRA_POST_LOCAL_ID, 0);</span>
<span class="nc" id="L324">                    final SiteModel site = (SiteModel) data.getSerializableExtra(WordPress.SITE);</span>
<span class="nc" id="L325">                    final PostModel post = mPostStore.getPostByLocalPostId(localId);</span>

<span class="nc bnc" id="L327" title="All 2 branches missed.">                    if (EditPostActivity.checkToRestart(data)) {</span>
<span class="nc" id="L328">                        ActivityLauncher.editPostOrPageForResult(data, ReaderPostListActivity.this, site,</span>
<span class="nc" id="L329">                                data.getIntExtra(EditPostActivity.EXTRA_POST_LOCAL_ID, 0));</span>
                        // a restart will happen so, no need to continue here
<span class="nc" id="L331">                        return;</span>
                    }

<span class="nc bnc" id="L334" title="All 4 branches missed.">                    if (site != null &amp;&amp; post != null) {</span>
<span class="nc" id="L335">                        mUploadUtilsWrapper.handleEditPostResultSnackbars(</span>
                                this,
<span class="nc" id="L337">                                findViewById(R.id.coordinator),</span>
                                data,
                                post,
                                site,
<span class="nc" id="L341">                                mUploadActionUseCase.getUploadAction(post),</span>
<span class="nc" id="L342">                                new View.OnClickListener() {</span>
                                    @Override
                                    public void onClick(View v) {
<span class="nc" id="L345">                                        UploadUtils.publishPost(</span>
                                                ReaderPostListActivity.this,
                                                post,
                                                site,
                                                mDispatcher
                                        );
<span class="nc" id="L351">                                    }</span>
                                });
                    }
                }
                break;
        }
<span class="nc" id="L357">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPostUploaded(OnPostUploaded event) {
<span class="nc" id="L362">        SiteModel site = mSiteStore.getSiteByLocalId(mSelectedSiteRepository.getSelectedSiteLocalId());</span>
<span class="nc bnc" id="L363" title="All 4 branches missed.">        if (site != null &amp;&amp; event.post != null) {</span>
<span class="nc" id="L364">            mUploadUtilsWrapper.onPostUploadedSnackbarHandler(</span>
                    this,
<span class="nc" id="L366">                    findViewById(R.id.coordinator),</span>
<span class="nc" id="L367">                    event.isError(),</span>
                    event.isFirstTimePublish,
                    event.post,
                    null,
                    site);
        }
<span class="nc" id="L373">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>