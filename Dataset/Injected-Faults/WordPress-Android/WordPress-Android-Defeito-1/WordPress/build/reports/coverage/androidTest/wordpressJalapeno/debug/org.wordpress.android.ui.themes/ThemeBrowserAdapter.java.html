<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThemeBrowserAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.themes</a> &gt; <span class="el_source">ThemeBrowserAdapter.java</span></div><h1>ThemeBrowserAdapter.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.themes;

import android.content.Context;
import android.content.res.ColorStateList;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.BaseAdapter;
import android.widget.Filter;
import android.widget.Filterable;
import android.widget.FrameLayout;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.ImageView.ScaleType;
import android.widget.PopupMenu;
import android.widget.RelativeLayout;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.cardview.widget.CardView;
import androidx.core.widget.ImageViewCompat;

import com.google.android.material.elevation.ElevationOverlayProvider;

import org.wordpress.android.R;
import org.wordpress.android.fluxc.model.ThemeModel;
import org.wordpress.android.ui.plans.PlansConstants;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.themes.ThemeBrowserFragment.ThemeBrowserFragmentCallback;
import org.wordpress.android.util.extensions.ContextExtensionsKt;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageType;
import org.wordpress.android.widgets.HeaderGridView;

import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

class ThemeBrowserAdapter extends BaseAdapter implements Filterable {
    private static final String THEME_IMAGE_PARAMETER = &quot;w=&quot;;

    private final Context mContext;
    private final long mSitePlanId;
    private final LayoutInflater mInflater;
    private final ThemeBrowserFragmentCallback mCallback;
    private final ImageManager mImageManager;

    private int mViewWidth;
    private String mQuery;

    private int mElevatedSurfaceColor;

<span class="nc" id="L56">    private final List&lt;ThemeModel&gt; mAllThemes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L57">    private final List&lt;ThemeModel&gt; mFilteredThemes = new ArrayList&lt;&gt;();</span>

    ThemeBrowserAdapter(Context context, long sitePlanId, ThemeBrowserFragmentCallback callback,
<span class="nc" id="L60">                        ImageManager imageManager) {</span>
<span class="nc" id="L61">        mContext = context;</span>
<span class="nc" id="L62">        mSitePlanId = sitePlanId;</span>
<span class="nc" id="L63">        mInflater = LayoutInflater.from(context);</span>
<span class="nc" id="L64">        mCallback = callback;</span>
<span class="nc" id="L65">        mViewWidth = AppPrefs.getThemeImageSizeWidth();</span>
<span class="nc" id="L66">        mImageManager = imageManager;</span>

<span class="nc" id="L68">        ElevationOverlayProvider elevationOverlayProvider = new ElevationOverlayProvider(mContext);</span>
<span class="nc" id="L69">        float cardElevation = mContext.getResources().getDimension(R.dimen.card_elevation);</span>
<span class="nc" id="L70">        mElevatedSurfaceColor =</span>
<span class="nc" id="L71">                elevationOverlayProvider.compositeOverlayWithThemeSurfaceColorIfNeeded(cardElevation);</span>
<span class="nc" id="L72">    }</span>

    private static class ThemeViewHolder {
        private final CardView mCardView;
        private final ImageView mImageView;
        private final TextView mNameView;
        private final TextView mActiveView;
        private final TextView mPriceView;
        private final ImageButton mImageButton;
        private final FrameLayout mFrameLayout;
        private final RelativeLayout mDetailsView;

<span class="nc" id="L84">        ThemeViewHolder(View view) {</span>
<span class="nc" id="L85">            mCardView = view.findViewById(R.id.theme_grid_card);</span>
<span class="nc" id="L86">            mImageView = view.findViewById(R.id.theme_grid_item_image);</span>
<span class="nc" id="L87">            mNameView = view.findViewById(R.id.theme_grid_item_name);</span>
<span class="nc" id="L88">            mPriceView = view.findViewById(R.id.theme_grid_item_price);</span>
<span class="nc" id="L89">            mActiveView = view.findViewById(R.id.theme_grid_item_active);</span>
<span class="nc" id="L90">            mImageButton = view.findViewById(R.id.theme_grid_item_image_button);</span>
<span class="nc" id="L91">            mFrameLayout = view.findViewById(R.id.theme_grid_item_image_layout);</span>
<span class="nc" id="L92">            mDetailsView = view.findViewById(R.id.theme_grid_item_details);</span>
<span class="nc" id="L93">        }</span>
    }

    @Override
    public int getCount() {
<span class="nc" id="L98">        return mFilteredThemes.size();</span>
    }

    public int getUnfilteredCount() {
<span class="nc" id="L102">        return mAllThemes.size();</span>
    }

    @Override
    public Object getItem(int position) {
<span class="nc" id="L107">        return mFilteredThemes.get(position);</span>
    }

    @Override
    public long getItemId(int position) {
<span class="nc" id="L112">        return position;</span>
    }

    void setThemeList(@NonNull List&lt;ThemeModel&gt; themes) {
<span class="nc" id="L116">        mAllThemes.clear();</span>
<span class="nc" id="L117">        mAllThemes.addAll(themes);</span>

<span class="nc" id="L119">        mFilteredThemes.clear();</span>
<span class="nc" id="L120">        mFilteredThemes.addAll(themes);</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (!TextUtils.isEmpty(mQuery)) {</span>
<span class="nc" id="L123">            getFilter().filter(mQuery);</span>
        } else {
<span class="nc" id="L125">            notifyDataSetChanged();</span>
        }
<span class="nc" id="L127">    }</span>

    @Override
    public View getView(int position, View convertView, ViewGroup parent) {
        ThemeViewHolder holder;
<span class="nc bnc" id="L132" title="All 4 branches missed.">        if (convertView == null || convertView.getTag() == null) {</span>
<span class="nc" id="L133">            convertView = mInflater.inflate(R.layout.theme_grid_item, parent, false);</span>
<span class="nc" id="L134">            holder = new ThemeViewHolder(convertView);</span>
<span class="nc" id="L135">            convertView.setTag(holder);</span>
        } else {
<span class="nc" id="L137">            holder = (ThemeViewHolder) convertView.getTag();</span>
        }

<span class="nc" id="L140">        configureThemeImageSize(parent);</span>
<span class="nc" id="L141">        ThemeModel theme = mFilteredThemes.get(position);</span>

<span class="nc" id="L143">        String screenshotURL = theme.getScreenshotUrl();</span>
<span class="nc" id="L144">        String themeId = theme.getThemeId();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        boolean isPremium = !theme.isFree();</span>
<span class="nc" id="L146">        boolean isCurrent = theme.getActive();</span>

<span class="nc" id="L148">        holder.mNameView.setText(theme.getName());</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (isPremium) {</span>
<span class="nc" id="L150">            holder.mPriceView.setText(theme.getPriceText());</span>
<span class="nc" id="L151">            holder.mPriceView.setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L153">            holder.mPriceView.setVisibility(View.GONE);</span>
        }

        // catch the case where a URL has no protocol
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!screenshotURL.startsWith(ThemeWebActivity.THEME_HTTP_PREFIX)) {</span>
            // some APIs return a URL starting with // so the protocol can be supplied by the client
            // strip // before adding the protocol
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (screenshotURL.startsWith(&quot;//&quot;)) {</span>
<span class="nc" id="L161">                screenshotURL = screenshotURL.substring(2);</span>
            }
<span class="nc" id="L163">            screenshotURL = ThemeWebActivity.THEME_HTTPS_PROTOCOL + screenshotURL;</span>
        }

<span class="nc" id="L166">        configureImageView(holder, screenshotURL, themeId, isCurrent);</span>
<span class="nc" id="L167">        configureImageButton(holder, themeId, isPremium, isCurrent);</span>
<span class="nc" id="L168">        configureCardView(holder, isCurrent);</span>
<span class="nc" id="L169">        return convertView;</span>
    }

    @SuppressWarnings(&quot;deprecation&quot;)
    private void configureCardView(ThemeViewHolder themeViewHolder, boolean isCurrent) {
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (isCurrent) {</span>
<span class="nc" id="L175">            ColorStateList color =</span>
<span class="nc" id="L176">                    ContextExtensionsKt.getColorStateListFromAttribute(mContext, R.attr.colorOnPrimarySurface);</span>
<span class="nc" id="L177">            themeViewHolder.mDetailsView</span>
<span class="nc" id="L178">                    .setBackgroundColor(</span>
<span class="nc" id="L179">                            ContextExtensionsKt.getColorFromAttribute(mContext, R.attr.colorPrimary));</span>
<span class="nc" id="L180">            themeViewHolder.mNameView.setTextColor(color);</span>
<span class="nc" id="L181">            themeViewHolder.mActiveView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L182">            themeViewHolder.mCardView</span>
<span class="nc" id="L183">                    .setCardBackgroundColor(</span>
<span class="nc" id="L184">                            ContextExtensionsKt.getColorFromAttribute(mContext, R.attr.colorPrimary));</span>
<span class="nc" id="L185">            ImageViewCompat.setImageTintList(themeViewHolder.mImageButton, color);</span>
<span class="nc" id="L186">        } else {</span>
<span class="nc" id="L187">            ColorStateList color = ContextExtensionsKt.getColorStateListFromAttribute(mContext, R.attr.colorOnSurface);</span>
<span class="nc" id="L188">            themeViewHolder.mDetailsView</span>
<span class="nc" id="L189">                    .setBackgroundColor(mElevatedSurfaceColor);</span>
<span class="nc" id="L190">            themeViewHolder.mNameView.setTextColor(color);</span>
<span class="nc" id="L191">            themeViewHolder.mActiveView.setVisibility(View.GONE);</span>
<span class="nc" id="L192">            themeViewHolder.mCardView</span>
<span class="nc" id="L193">                    .setCardBackgroundColor(mElevatedSurfaceColor);</span>
<span class="nc" id="L194">            ImageViewCompat.setImageTintList(themeViewHolder.mImageButton, color);</span>
        }
<span class="nc" id="L196">    }</span>

    private void configureImageView(ThemeViewHolder themeViewHolder, String screenshotURL, final String themeId,
                                    final boolean isCurrent) {
<span class="nc" id="L200">        mImageManager.load(themeViewHolder.mImageView, ImageType.THEME, getUrlWithWidth(screenshotURL),</span>
                ScaleType.FIT_CENTER);

<span class="nc" id="L203">        themeViewHolder.mCardView.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc bnc" id="L206" title="All 2 branches missed.">                if (isCurrent) {</span>
<span class="nc" id="L207">                    mCallback.onTryAndCustomizeSelected(themeId);</span>
                } else {
<span class="nc" id="L209">                    mCallback.onViewSelected(themeId);</span>
                }
<span class="nc" id="L211">            }</span>
        });
<span class="nc" id="L213">    }</span>

    private String getUrlWithWidth(String screenshotURL) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (screenshotURL.contains(&quot;?&quot;)) {</span>
<span class="nc" id="L217">            return screenshotURL + &quot;&amp;&quot; + THEME_IMAGE_PARAMETER + mViewWidth;</span>
        } else {
<span class="nc" id="L219">            return screenshotURL + &quot;?&quot; + THEME_IMAGE_PARAMETER + mViewWidth;</span>
        }
    }

    private void configureImageButton(ThemeViewHolder themeViewHolder, final String themeId, final boolean isPremium,
                                      boolean isCurrent) {
<span class="nc" id="L225">        final PopupMenu popupMenu = new PopupMenu(mContext, themeViewHolder.mImageButton);</span>
<span class="nc" id="L226">        popupMenu.getMenuInflater().inflate(R.menu.theme_more, popupMenu.getMenu());</span>

<span class="nc" id="L228">        configureMenuForTheme(popupMenu.getMenu(), isCurrent);</span>

<span class="nc" id="L230">        popupMenu.setOnMenuItemClickListener(new PopupMenu.OnMenuItemClickListener() {</span>
            @Override
            public boolean onMenuItemClick(MenuItem item) {
<span class="nc" id="L233">                int i = item.getItemId();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (i == R.id.menu_activate) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                    if (canActivateThemeDirectly(isPremium, mSitePlanId)) {</span>
<span class="nc" id="L236">                        mCallback.onActivateSelected(themeId);</span>
                    } else {
                        // forward the user online to complete the activation
<span class="nc" id="L239">                        mCallback.onDetailsSelected(themeId);</span>
                    }
<span class="nc bnc" id="L241" title="All 2 branches missed.">                } else if (i == R.id.menu_try_and_customize) {</span>
<span class="nc" id="L242">                    mCallback.onTryAndCustomizeSelected(themeId);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                } else if (i == R.id.menu_view) {</span>
<span class="nc" id="L244">                    mCallback.onViewSelected(themeId);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                } else if (i == R.id.menu_details) {</span>
<span class="nc" id="L246">                    mCallback.onDetailsSelected(themeId);</span>
                } else {
<span class="nc" id="L248">                    mCallback.onSupportSelected(themeId);</span>
                }

<span class="nc" id="L251">                return true;</span>
            }
        });
<span class="nc" id="L254">        themeViewHolder.mImageButton.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L257">                popupMenu.show();</span>
<span class="nc" id="L258">            }</span>
        });
<span class="nc" id="L260">    }</span>

    private boolean canActivateThemeDirectly(final boolean isPremiumTheme, final long sitePlanId) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (!isPremiumTheme) {</span>
            // It's a free theme so, can always activate directly
<span class="nc" id="L265">            return true;</span>
        }

<span class="nc bnc" id="L268" title="All 4 branches missed.">        if (sitePlanId == PlansConstants.PREMIUM_PLAN_ID || mSitePlanId == PlansConstants.BUSINESS_PLAN_ID) {</span>
            // Can activate any theme on a Premium and Business site plan
<span class="nc" id="L270">            return true;</span>
        }

        // Theme cannot be activated directly and needs to be purchased
<span class="nc" id="L274">        return false;</span>
    }

    private void configureMenuForTheme(Menu menu, boolean isCurrent) {
<span class="nc" id="L278">        MenuItem activate = menu.findItem(R.id.menu_activate);</span>
<span class="nc" id="L279">        MenuItem customize = menu.findItem(R.id.menu_try_and_customize);</span>
<span class="nc" id="L280">        MenuItem view = menu.findItem(R.id.menu_view);</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (activate != null) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            activate.setVisible(!isCurrent);</span>
        }
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (customize != null) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (isCurrent) {</span>
<span class="nc" id="L287">                customize.setTitle(R.string.customize);</span>
            } else {
<span class="nc" id="L289">                customize.setTitle(R.string.theme_try_and_customize);</span>
            }
        }
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (view != null) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            view.setVisible(!isCurrent);</span>
        }
<span class="nc" id="L295">    }</span>

    private void configureThemeImageSize(ViewGroup parent) {
<span class="nc" id="L298">        HeaderGridView gridView = parent.findViewById(R.id.theme_listview);</span>
<span class="nc" id="L299">        int numColumns = gridView.getNumColumns();</span>
<span class="nc" id="L300">        int screenWidth = gridView.getWidth();</span>
<span class="nc" id="L301">        int imageWidth = screenWidth / numColumns;</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (imageWidth &gt; mViewWidth) {</span>
<span class="nc" id="L303">            mViewWidth = imageWidth;</span>
<span class="nc" id="L304">            AppPrefs.setThemeImageSizeWidth(mViewWidth);</span>
        }
<span class="nc" id="L306">    }</span>

    @Override
    public Filter getFilter() {
<span class="nc" id="L310">        return new Filter() {</span>
            @SuppressWarnings(&quot;unchecked&quot;)
            @Override
            protected void publishResults(CharSequence constraint, FilterResults results) {
<span class="nc" id="L314">                mFilteredThemes.clear();</span>
<span class="nc" id="L315">                mFilteredThemes.addAll((List&lt;ThemeModel&gt;) results.values);</span>
<span class="nc" id="L316">                ThemeBrowserAdapter.this.notifyDataSetChanged();</span>
<span class="nc" id="L317">            }</span>

            @Override
            protected FilterResults performFiltering(CharSequence constraint) {
<span class="nc" id="L321">                List&lt;ThemeModel&gt; filtered = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                if (TextUtils.isEmpty(constraint)) {</span>
<span class="nc" id="L323">                    mQuery = null;</span>
<span class="nc" id="L324">                    filtered.addAll(mAllThemes);</span>
                } else {
<span class="nc" id="L326">                    mQuery = constraint.toString();</span>
                    // Locale.ROOT is used on user input for convenience as all the theme names are in english
<span class="nc" id="L328">                    String lcConstraint = constraint.toString().toLowerCase(Locale.ROOT);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                    for (ThemeModel theme : mAllThemes) {</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">                        if (theme.getName().toLowerCase(Locale.ROOT).contains(lcConstraint)) {</span>
<span class="nc" id="L331">                            filtered.add(theme);</span>
                        }
<span class="nc" id="L333">                    }</span>
                }

<span class="nc" id="L336">                FilterResults results = new FilterResults();</span>
<span class="nc" id="L337">                results.values = filtered;</span>

<span class="nc" id="L339">                return results;</span>
            }
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>