<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ActivityLogTypeFilterViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.activitylog.list.filter</a> &gt; <span class="el_source">ActivityLogTypeFilterViewModel.kt</span></div><h1>ActivityLogTypeFilterViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.activitylog.list.filter

import androidx.annotation.DrawableRes
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.LocalOrRemoteId.RemoteId
import org.wordpress.android.fluxc.model.activity.ActivityTypeModel
import org.wordpress.android.fluxc.store.ActivityLogStore
import org.wordpress.android.fluxc.store.ActivityLogStore.FetchActivityTypesPayload
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.activitylog.list.filter.ActivityLogTypeFilterViewModel.UiState.Content
import org.wordpress.android.ui.activitylog.list.filter.ActivityLogTypeFilterViewModel.UiState.Error
import org.wordpress.android.ui.activitylog.list.filter.ActivityLogTypeFilterViewModel.UiState.FullscreenLoading
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ScopedViewModel
import org.wordpress.android.viewmodel.activitylog.ActivityLogViewModel
import org.wordpress.android.viewmodel.activitylog.DateRange
import java.util.Date
import javax.inject.Inject
import javax.inject.Named

<span class="nc" id="L30">class ActivityLogTypeFilterViewModel @Inject constructor(</span>
<span class="nc" id="L31">    private val activityLogStore: ActivityLogStore,</span>
<span class="nc" id="L32">    @Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L33">    @Named(UI_THREAD) private val mainDispatcher: CoroutineDispatcher</span>
<span class="nc" id="L34">) : ScopedViewModel(mainDispatcher) {</span>
    private var isStarted = false
    private lateinit var remoteSiteId: RemoteId
    private lateinit var parentViewModel: ActivityLogViewModel
    private lateinit var initialSelection: List&lt;String&gt;
    private var dateRange: DateRange? = null

<span class="nc" id="L41">    private val _uiState = MutableLiveData&lt;UiState&gt;()</span>
<span class="nc" id="L42">    val uiState: LiveData&lt;UiState&gt; = _uiState</span>

<span class="nc" id="L44">    private val _dismissDialog = MutableLiveData&lt;Event&lt;Unit&gt;&gt;()</span>
<span class="nc" id="L45">    val dismissDialog: LiveData&lt;Event&lt;Unit&gt;&gt; = _dismissDialog</span>

    fun start(
        remoteSiteId: RemoteId,
        parentViewModel: ActivityLogViewModel,
        dateRange: DateRange?,
        initialSelection: List&lt;String&gt;
    ) {
<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (isStarted) return</span>
<span class="nc" id="L54">        isStarted = true</span>
<span class="nc" id="L55">        this.remoteSiteId = remoteSiteId</span>
<span class="nc" id="L56">        this.parentViewModel = parentViewModel</span>
<span class="nc" id="L57">        this.initialSelection = initialSelection</span>
<span class="nc" id="L58">        this.dateRange = dateRange</span>
<span class="nc" id="L59">        fetchAvailableActivityTypes()</span>
<span class="nc" id="L60">    }</span>

    private fun fetchAvailableActivityTypes() {
<span class="nc" id="L63">        launch {</span>
<span class="nc" id="L64">            _uiState.value = FullscreenLoading</span>
<span class="nc" id="L65">            val response = activityLogStore.fetchActivityTypes(</span>
<span class="nc" id="L66">                    FetchActivityTypesPayload(</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                            remoteSiteId.value,</span>
<span class="nc bnc" id="L68" title="All 4 branches missed.">                            dateRange?.first?.let { Date(it) },</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">                            dateRange?.second?.let { Date(it) }</span>
                    )
            )
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (response.isError) {</span>
<span class="nc" id="L73">                _uiState.value = buildErrorUiState()</span>
            } else {
<span class="nc" id="L75">                _uiState.value = buildContentUiState(response.activityTypeModels)</span>
            }
<span class="nc" id="L77">        }</span>
<span class="nc" id="L78">    }</span>

    private fun buildErrorUiState() =
<span class="nc" id="L81">            Error.ConnectionError(Action(UiStringRes(R.string.retry)).apply { action = ::onRetryClicked })</span>

    private suspend fun buildContentUiState(activityTypes: List&lt;ActivityTypeModel&gt;): UiState {
<span class="nc bnc" id="L84" title="All 2 branches missed.">        return withContext(bgDispatcher) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (activityTypes.isEmpty()) { return@withContext Error.NoActivitiesError }</span>

<span class="nc" id="L87">            val headerListItem = ListItemUiState.SectionHeader(</span>
<span class="nc" id="L88">                    UiStringRes(R.string.activity_log_activity_type_filter_header)</span>
            )
<span class="nc" id="L90">            val activityTypeListItems: List&lt;ListItemUiState.ActivityType&gt; = activityTypes</span>
<span class="nc" id="L91">                    .map {</span>
<span class="nc" id="L92">                        ListItemUiState.ActivityType(</span>
<span class="nc" id="L93">                                id = it.key,</span>
<span class="nc" id="L94">                                title = UiStringText(&quot;${it.name} (${it.count})&quot;),</span>
<span class="nc" id="L95">                                onClick = { onItemClicked(it.key) },</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">                                checked = initialSelection.contains(it.key)</span>
                        )
                    }
<span class="nc" id="L99">            Content(</span>
<span class="nc" id="L100">                    listOf(headerListItem) + activityTypeListItems,</span>
<span class="nc" id="L101">                    primaryAction = Action(label = UiStringRes(R.string.activity_log_activity_type_filter_apply))</span>
<span class="nc" id="L102">                            .apply { action = { onApplyClicked(activityTypes) } },</span>
<span class="nc" id="L103">                    secondaryAction = Action(label = UiStringRes(R.string.activity_log_activity_type_filter_clear))</span>
<span class="nc" id="L104">                            .apply { action = ::onClearClicked }</span>
            )
        }
    }

    private fun onItemClicked(itemId: String) {
<span class="nc bnc" id="L110" title="All 4 branches missed.">        (_uiState.value as? Content)?.let { content -&gt;</span>
<span class="nc" id="L111">            val updatedList = content.items.map { itemUiState -&gt;</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">                if (itemUiState is ListItemUiState.ActivityType &amp;&amp; itemUiState.id == itemId) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                    itemUiState.copy(checked = !itemUiState.checked)</span>
                } else {
<span class="nc" id="L115">                    itemUiState</span>
                }
            }
<span class="nc" id="L118">            _uiState.postValue(content.copy(items = updatedList))</span>
<span class="nc" id="L119">        }</span>
<span class="nc" id="L120">    }</span>

    private fun onApplyClicked(activityTypes: List&lt;ActivityTypeModel&gt;) {
<span class="nc" id="L123">        val selectedModels = getSelectedActivityTypeIds().mapNotNull { key -&gt;</span>
<span class="nc bnc" id="L124" title="All 6 branches missed.">            activityTypes.find { model -&gt; model.key == key }</span>
        }
<span class="nc bnc" id="L126" title="All 2 branches missed.">        parentViewModel.onActivityTypesSelected(selectedModels)</span>
<span class="nc" id="L127">        _dismissDialog.value = Event(Unit)</span>
<span class="nc" id="L128">    }</span>

    private fun onRetryClicked() {
<span class="nc" id="L131">        fetchAvailableActivityTypes()</span>
<span class="nc" id="L132">    }</span>

    private fun onClearClicked() {
<span class="nc bnc" id="L135" title="All 4 branches missed.">        (_uiState.value as? Content)?.let { it -&gt;</span>
<span class="nc" id="L136">            _uiState.value = it.copy(items = getAllActivityTypeItemsUnchecked(it.items))</span>
<span class="nc" id="L137">        }</span>
<span class="nc" id="L138">    }</span>

    private fun getAllActivityTypeItemsUnchecked(listItemUiStates: List&lt;ListItemUiState&gt;): List&lt;ListItemUiState&gt; =
<span class="nc" id="L141">            listItemUiStates.map { item -&gt;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                if (item is ListItemUiState.ActivityType) {</span>
<span class="nc" id="L143">                    item.copy(checked = false)</span>
                } else {
<span class="nc" id="L145">                    item</span>
                }
<span class="nc" id="L147">            }</span>

    private fun getSelectedActivityTypeIds(): List&lt;String&gt; =
<span class="nc bnc" id="L150" title="All 2 branches missed.">            (_uiState.value as Content).items</span>
<span class="nc" id="L151">                    .filterIsInstance(ListItemUiState.ActivityType::class.java)</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                    .filter { it.checked }</span>
<span class="nc" id="L153">                    .map { it.id }</span>

    sealed class UiState {
<span class="nc" id="L156">        open val contentVisibility = false</span>
<span class="nc" id="L157">        open val loadingVisibility = false</span>
<span class="nc" id="L158">        open val errorVisibility = false</span>

<span class="nc" id="L160">        object FullscreenLoading : UiState() {</span>
<span class="nc" id="L161">            override val loadingVisibility: Boolean = true</span>
<span class="nc" id="L162">            val loadingText: UiString = UiStringRes(R.string.loading)</span>
        }

<span class="nc" id="L165">        sealed class Error : UiState() {</span>
<span class="nc" id="L166">            override val errorVisibility = true</span>
            abstract val image: Int
            abstract val title: UiString
            abstract val subtitle: UiString
<span class="nc" id="L170">            open val buttonText: UiString? = null</span>
<span class="nc" id="L171">            open val retryAction: Action? = null</span>

<span class="nc" id="L173">            data class ConnectionError(override val retryAction: Action) : Error() {</span>
<span class="nc" id="L174">                @DrawableRes override val image = R.drawable.img_illustration_cloud_off_152dp</span>
<span class="nc" id="L175">                override val title: UiString = UiStringRes(R.string.activity_log_activity_type_error_title)</span>
<span class="nc" id="L176">                override val subtitle: UiString = UiStringRes(R.string.activity_log_activity_type_error_subtitle)</span>
<span class="nc" id="L177">                override val buttonText: UiString = UiStringRes(R.string.retry)</span>
            }

<span class="nc" id="L180">            object NoActivitiesError : Error() {</span>
<span class="nc" id="L181">                @DrawableRes override val image = R.drawable.img_illustration_empty_results_216dp</span>
<span class="nc" id="L182">                override val title = UiStringRes(R.string.activity_log_activity_type_empty_title)</span>
<span class="nc" id="L183">                override val subtitle = UiStringRes(R.string.activity_log_activity_type_empty_subtitle)</span>
            }
        }

<span class="nc" id="L187">        data class Content(</span>
<span class="nc" id="L188">            val items: List&lt;ListItemUiState&gt;,</span>
<span class="nc" id="L189">            val primaryAction: Action,</span>
<span class="nc" id="L190">            val secondaryAction: Action</span>
<span class="nc" id="L191">        ) : UiState() {</span>
<span class="nc" id="L192">            override val contentVisibility = true</span>
        }
    }

    sealed class ListItemUiState {
<span class="nc" id="L197">        data class SectionHeader(</span>
<span class="nc" id="L198">            val title: UiString</span>
<span class="nc" id="L199">        ) : ListItemUiState()</span>

<span class="nc" id="L201">        data class ActivityType(</span>
<span class="nc" id="L202">            val id: String,</span>
<span class="nc" id="L203">            val title: UiString,</span>
<span class="nc" id="L204">            val checked: Boolean = false,</span>
<span class="nc" id="L205">            val onClick: (() -&gt; Unit)</span>
<span class="nc" id="L206">        ) : ListItemUiState()</span>
    }

<span class="nc" id="L209">    data class Action(val label: UiString) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        lateinit var action: (() -&gt; Unit)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>