<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WPMeShortlinks.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">WPMeShortlinks.java</span></div><h1>WPMeShortlinks.java</h1><pre class="source lang-java linenums">package org.wordpress.android.util;

/**
 * Enable WP.me-powered shortlinks for Posts, Pages, and Blogs on WordPress.com or Jetpack powered sites.
 * &lt;p/&gt;
 * Shortlinks are a quick way to get short and simple links to your posts, pages, and blogs.
 * They use the wp.me domain so you can have more space to write on social media sites.
 * &lt;p/&gt;
 * See: https://git.io/JqUEl
 */

import android.text.TextUtils;

import org.wordpress.android.fluxc.model.PostImmutableModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.model.post.PostStatus;
import org.wordpress.android.util.AppLog.T;

<span class="nc" id="L19">public class WPMeShortlinks {</span>
    /**
     * Converts a base-10 number to base-62
     *
     * @param num base-10 number
     * @return String base-62 number
     */
    public static String wpme_dec2sixtwo(double num) {
<span class="nc bnc" id="L27" title="All 2 branches missed.">        if (num == 0) {</span>
<span class="nc" id="L28">            return &quot;0&quot;;</span>
        }

        StringBuilder out;
        try {
<span class="nc" id="L33">            String index = &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;</span>
<span class="nc" id="L34">            out = new StringBuilder();</span>

<span class="nc bnc" id="L36" title="All 2 branches missed.">            if (num &lt; 0) {</span>
<span class="nc" id="L37">                out.append('-');</span>
<span class="nc" id="L38">                num = Math.abs(num);</span>
            }

<span class="nc" id="L41">            double t = Math.floor(Math.log10(num) / Math.log10(62));</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">            for (; t &gt;= 0; t--) {</span>
<span class="nc" id="L43">                int a = (int) Math.floor(num / Math.pow(62, t));</span>
<span class="nc" id="L44">                out.append(index.substring(a, a + 1));</span>
<span class="nc" id="L45">                num = num - (a * Math.pow(62, t));</span>
            }
<span class="nc" id="L47">            return out.toString();</span>
<span class="nc" id="L48">        } catch (IndexOutOfBoundsException e) {</span>
<span class="nc" id="L49">            AppLog.e(T.UTILS, &quot;Cannot convert number &quot; + num + &quot; to base 62&quot;, e);</span>
        }
<span class="nc" id="L51">        return null;</span>
    }

    /**
     * Returns The post shortlink
     *
     * @param site Blog that contains the post or the page
     * @param post Post or page we want calculate the shortlink
     * @return String The blog shortlink or null (null is returned if the blog object is empty, or it's not a
     * wpcom/jetpack blog, or in case of errors).
     */
    public static String getPostShortlink(SiteModel site, PostImmutableModel post) {
<span class="nc bnc" id="L63" title="All 4 branches missed.">        if (post == null || site == null) {</span>
<span class="nc" id="L64">            return null;</span>
        }

<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (!SiteUtils.isAccessedViaWPComRest(site)) {</span>
<span class="nc" id="L68">            return null;</span>
        }

<span class="nc" id="L71">        long postId = post.getRemotePostId();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (postId == 0) {</span>
<span class="nc" id="L73">            return null;</span>
        }

        String id;
        String type;

<span class="nc" id="L79">        String postName = StringUtils.notNullStr(post.getSlug());</span>
<span class="nc bnc" id="L80" title="All 6 branches missed.">        if (PostStatus.fromPost(post) == PostStatus.PUBLISHED &amp;&amp; postName.length() &gt; 0 &amp;&amp; postName.length() &lt;= 8</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">            &amp;&amp; !postName.contains(&quot;%&quot;) &amp;&amp; !postName.contains(&quot;-&quot;)) {</span>
<span class="nc" id="L82">            id = postName;</span>
<span class="nc" id="L83">            type = &quot;s&quot;;</span>
        } else {
<span class="nc" id="L85">            id = wpme_dec2sixtwo(postId);</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (post.isPage()) {</span>
<span class="nc" id="L88">                type = &quot;P&quot;;</span>
            } else {
<span class="nc" id="L90">                type = &quot;p&quot;;</span>
            }
        }

        // Calculate the blog shortlink
        String blogShortlink;
        try {
<span class="nc" id="L97">            blogShortlink = wpme_dec2sixtwo(site.getSiteId());</span>
<span class="nc" id="L98">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L99">            AppLog.e(T.UTILS, &quot;Remote Blog ID cannot be converted to double&quot;, e);</span>
<span class="nc" id="L100">            return null;</span>
<span class="nc" id="L101">        }</span>

<span class="nc bnc" id="L103" title="All 6 branches missed.">        if (TextUtils.isEmpty(type) || TextUtils.isEmpty(id) || TextUtils.isEmpty(blogShortlink)) {</span>
<span class="nc" id="L104">            return null;</span>
        }

<span class="nc" id="L107">        return &quot;http://wp.me/&quot; + type + blogShortlink + &quot;-&quot; + id;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>