<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ModerateCommentWithUndoUseCase.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.models.usecases</a> &gt; <span class="el_source">ModerateCommentWithUndoUseCase.kt</span></div><h1>ModerateCommentWithUndoUseCase.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.models.usecases

import kotlinx.coroutines.flow.MutableSharedFlow
import org.wordpress.android.fluxc.model.CommentStatus
import org.wordpress.android.fluxc.model.CommentStatus.DELETED
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.CommentStore.CommentError
import org.wordpress.android.fluxc.store.CommentStore.CommentErrorType.INVALID_INPUT
import org.wordpress.android.fluxc.store.CommentsStore.CommentsData.DoNotCare
import org.wordpress.android.models.usecases.CommentsUseCaseType.MODERATE_USE_CASE
import org.wordpress.android.models.usecases.ModerateCommentWithUndoUseCase.ModerateCommentsAction
import org.wordpress.android.models.usecases.ModerateCommentWithUndoUseCase.ModerateCommentsAction.OnModerateComment
import org.wordpress.android.models.usecases.ModerateCommentWithUndoUseCase.ModerateCommentsAction.OnPushComment
import org.wordpress.android.models.usecases.ModerateCommentWithUndoUseCase.ModerateCommentsAction.OnUndoModerateComment
import org.wordpress.android.models.usecases.ModerateCommentWithUndoUseCase.ModerateCommentsState.Idle
import org.wordpress.android.models.usecases.ModerateCommentWithUndoUseCase.Parameters.ModerateCommentParameters
import org.wordpress.android.models.usecases.ModerateCommentWithUndoUseCase.Parameters.ModerateWithFallbackParameters
import org.wordpress.android.usecase.FlowFSMUseCase
import org.wordpress.android.usecase.UseCaseResult
import org.wordpress.android.usecase.UseCaseResult.Failure
import org.wordpress.android.usecase.UseCaseResult.Success
import javax.inject.Inject

<span class="nc" id="L24">class ModerateCommentWithUndoUseCase @Inject constructor(</span>
    moderateCommentsResourceProvider: ModerateCommentsResourceProvider
<span class="nc" id="L26">) : FlowFSMUseCase&lt;ModerateCommentsResourceProvider, ModerateCommentsAction, Any,</span>
        CommentsUseCaseType, CommentError&gt;(
<span class="nc" id="L28">        resourceProvider = moderateCommentsResourceProvider,</span>
<span class="nc" id="L29">        initialState = Idle</span>
) {
    @Suppress(&quot;LongMethod&quot;) // temporary, until we came up with a different use case layout
    sealed class ModerateCommentsState : StateInterface&lt;ModerateCommentsResourceProvider, ModerateCommentsAction,
            Any, CommentsUseCaseType,
            CommentError&gt; {
<span class="nc" id="L35">        object Idle : ModerateCommentsState() {</span>
<span class="nc" id="L36">            override suspend fun runAction(</span>
                resourceProvider: ModerateCommentsResourceProvider,
                action: ModerateCommentsAction,
                flowChannel: MutableSharedFlow&lt;UseCaseResult&lt;CommentsUseCaseType, CommentError, Any&gt;&gt;
            ): StateInterface&lt;ModerateCommentsResourceProvider, ModerateCommentsAction, Any, CommentsUseCaseType,
                    CommentError&gt; {
<span class="nc" id="L42">                val commentsStore = resourceProvider.commentsStore</span>
<span class="nc" id="L43">                return when (action) {</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">                    is OnModerateComment -&gt; {</span>
<span class="nc" id="L45">                        val parameters = action.parameters</span>
<span class="nc" id="L46">                        val commentBeforeModeration = commentsStore.getCommentByLocalSiteAndRemoteId(</span>
<span class="nc" id="L47">                                parameters.site.id,</span>
<span class="nc" id="L48">                                parameters.remoteCommentId</span>
<span class="nc" id="L49">                        ).firstOrNull()</span>

<span class="nc bnc" id="L51" title="All 2 branches missed.">                        if (commentBeforeModeration == null) {</span>
<span class="nc" id="L52">                            flowChannel.emit(</span>
<span class="nc" id="L53">                                    Failure(</span>
<span class="nc" id="L54">                                            MODERATE_USE_CASE,</span>
<span class="nc" id="L55">                                            CommentError(INVALID_INPUT, &quot;Comment cannot be null!&quot;),</span>
<span class="nc" id="L56">                                            DoNotCare</span>
                                    )
                            )
<span class="nc" id="L59">                            Idle</span>
                        }

<span class="nc" id="L62">                        val localModerationResult = commentsStore.moderateCommentLocally(</span>
<span class="nc" id="L63">                                site = parameters.site,</span>
<span class="nc" id="L64">                                remoteCommentId = parameters.remoteCommentId,</span>
<span class="nc" id="L65">                                newStatus = parameters.newStatus</span>
                        )

<span class="nc bnc" id="L68" title="All 2 branches missed.">                        if (localModerationResult.isError) {</span>
<span class="nc" id="L69">                            flowChannel.emit(Failure(MODERATE_USE_CASE, localModerationResult.error, DoNotCare))</span>
                        } else {
<span class="nc" id="L71">                            flowChannel.emit(</span>
<span class="nc" id="L72">                                    Success(</span>
<span class="nc" id="L73">                                            MODERATE_USE_CASE,</span>
<span class="nc" id="L74">                                            SingleCommentModerationResult(</span>
<span class="nc" id="L75">                                                    parameters.remoteCommentId,</span>
<span class="nc" id="L76">                                                    parameters.newStatus,</span>
<span class="nc" id="L77">                                                    CommentStatus.fromString(commentBeforeModeration!!.status)</span>
                                            )
                                    )
                            )
<span class="nc" id="L81">                            resourceProvider.localCommentCacheUpdateHandler.requestCommentsUpdate()</span>
                        }
<span class="nc" id="L83">                        Idle</span>
                    }
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    is OnPushComment -&gt; {</span>
<span class="nc" id="L86">                        val parameters = action.parameters</span>

                        // we need to try and moderate comment locally again, since user might have refresh the list
                        // while moderation was not finalized yet
<span class="nc" id="L90">                        commentsStore.moderateCommentLocally(</span>
<span class="nc" id="L91">                                site = parameters.site,</span>
<span class="nc" id="L92">                                remoteCommentId = parameters.remoteCommentId,</span>
<span class="nc" id="L93">                                newStatus = parameters.newStatus</span>
                        )
<span class="nc" id="L95">                        resourceProvider.localCommentCacheUpdateHandler.requestCommentsUpdate()</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">                        val result = if (parameters.newStatus == DELETED) {</span>
<span class="nc" id="L98">                            commentsStore.deleteComment(</span>
<span class="nc" id="L99">                                    site = parameters.site,</span>
<span class="nc" id="L100">                                    remoteCommentId = parameters.remoteCommentId,</span>
<span class="nc" id="L101">                                    null</span>
                            )
                        } else {
<span class="nc" id="L104">                            commentsStore.pushLocalCommentByRemoteId(</span>
<span class="nc" id="L105">                                    site = parameters.site,</span>
<span class="nc" id="L106">                                    remoteCommentId = parameters.remoteCommentId</span>
                            )
                        }

<span class="nc bnc" id="L110" title="All 2 branches missed.">                        if (result.isError) {</span>
                            // revert local moderation
<span class="nc" id="L112">                            commentsStore.moderateCommentLocally(</span>
<span class="nc" id="L113">                                    site = parameters.site,</span>
<span class="nc" id="L114">                                    remoteCommentId = parameters.remoteCommentId,</span>
<span class="nc" id="L115">                                    newStatus = parameters.fallbackStatus</span>
                            )
<span class="nc" id="L117">                            flowChannel.emit(Failure(MODERATE_USE_CASE, result.error, DoNotCare))</span>
                        } else {
<span class="nc" id="L119">                            flowChannel.emit(Success(MODERATE_USE_CASE, DoNotCare))</span>
                        }
<span class="nc" id="L121">                        resourceProvider.localCommentCacheUpdateHandler.requestCommentsUpdate()</span>
<span class="nc" id="L122">                        Idle</span>
                    }
<span class="nc" id="L124">                    is OnUndoModerateComment -&gt; {</span>
<span class="nc" id="L125">                        val parameters = action.parameters</span>
<span class="nc" id="L126">                        commentsStore.moderateCommentLocally(</span>
<span class="nc" id="L127">                                site = parameters.site,</span>
<span class="nc" id="L128">                                remoteCommentId = parameters.remoteCommentId,</span>
<span class="nc" id="L129">                                newStatus = parameters.fallbackStatus</span>
                        )
<span class="nc" id="L131">                        flowChannel.emit(Success(MODERATE_USE_CASE, DoNotCare))</span>
<span class="nc" id="L132">                        resourceProvider.localCommentCacheUpdateHandler.requestCommentsUpdate()</span>
<span class="nc" id="L133">                        Idle</span>
                    }
                }
            }
        }
    }

<span class="nc" id="L140">    data class SingleCommentModerationResult(</span>
<span class="nc" id="L141">        val remoteCommentId: Long,</span>
<span class="nc" id="L142">        val newStatus: CommentStatus,</span>
<span class="nc" id="L143">        val oldStatus: CommentStatus</span>
    )

    sealed class ModerateCommentsAction {
<span class="nc" id="L147">        data class OnModerateComment(</span>
<span class="nc" id="L148">            val parameters: ModerateCommentParameters</span>
<span class="nc" id="L149">        ) : ModerateCommentsAction()</span>

<span class="nc" id="L151">        data class OnPushComment(</span>
<span class="nc" id="L152">            val parameters: ModerateWithFallbackParameters</span>
<span class="nc" id="L153">        ) : ModerateCommentsAction()</span>

<span class="nc" id="L155">        data class OnUndoModerateComment(</span>
<span class="nc" id="L156">            val parameters: ModerateWithFallbackParameters</span>
<span class="nc" id="L157">        ) : ModerateCommentsAction()</span>
    }

    sealed class Parameters {
<span class="nc" id="L161">        data class ModerateCommentParameters(</span>
<span class="nc" id="L162">            val site: SiteModel,</span>
<span class="nc" id="L163">            val remoteCommentId: Long,</span>
<span class="nc" id="L164">            val newStatus: CommentStatus</span>
        )

<span class="nc" id="L167">        data class ModerateWithFallbackParameters(</span>
<span class="nc" id="L168">            val site: SiteModel,</span>
<span class="nc" id="L169">            val remoteCommentId: Long,</span>
<span class="nc" id="L170">            val newStatus: CommentStatus,</span>
<span class="nc" id="L171">            val fallbackStatus: CommentStatus</span>
        )
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>