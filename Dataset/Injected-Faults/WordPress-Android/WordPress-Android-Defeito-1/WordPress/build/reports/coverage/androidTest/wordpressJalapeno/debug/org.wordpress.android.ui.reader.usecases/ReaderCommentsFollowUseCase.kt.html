<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderCommentsFollowUseCase.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.usecases</a> &gt; <span class="el_source">ReaderCommentsFollowUseCase.kt</span></div><h1>ReaderCommentsFollowUseCase.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.usecases

import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.datasets.wrappers.ReaderPostTableWrapper
import org.wordpress.android.fluxc.store.AccountStore
import org.wordpress.android.ui.reader.FollowConversationStatusFlags
import org.wordpress.android.ui.reader.comments.ThreadedCommentsActionSource
import org.wordpress.android.ui.reader.tracker.ReaderTracker
import org.wordpress.android.ui.reader.usecases.ReaderCommentsFollowUseCase.AnalyticsFollowCommentsAction.DISABLE_PUSH_NOTIFICATION
import org.wordpress.android.ui.reader.usecases.ReaderCommentsFollowUseCase.AnalyticsFollowCommentsAction.ENABLE_PUSH_NOTIFICATION
import org.wordpress.android.ui.reader.usecases.ReaderCommentsFollowUseCase.AnalyticsFollowCommentsAction.FOLLOW_COMMENTS
import org.wordpress.android.ui.reader.usecases.ReaderCommentsFollowUseCase.AnalyticsFollowCommentsAction.UNFOLLOW_COMMENTS
import org.wordpress.android.ui.reader.usecases.ReaderCommentsFollowUseCase.AnalyticsFollowCommentsActionResult.ERROR
import org.wordpress.android.ui.reader.usecases.ReaderCommentsFollowUseCase.AnalyticsFollowCommentsActionResult.SUCCEEDED
import org.wordpress.android.ui.reader.usecases.ReaderCommentsFollowUseCase.AnalyticsFollowCommentsGenericError.NO_NETWORK
import org.wordpress.android.ui.reader.usecases.ReaderCommentsFollowUseCase.FollowCommentsState.UserNotAuthenticated
import org.wordpress.android.ui.reader.utils.PostSubscribersApiCallsProvider
import org.wordpress.android.ui.reader.utils.PostSubscribersApiCallsProvider.PostSubscribersCallResult.Failure
import org.wordpress.android.ui.reader.utils.PostSubscribersApiCallsProvider.PostSubscribersCallResult.Success
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.NetworkUtilsWrapper
import javax.inject.Inject

<span class="nc" id="L29">class ReaderCommentsFollowUseCase @Inject constructor(</span>
<span class="nc" id="L30">    private val networkUtilsWrapper: NetworkUtilsWrapper,</span>
<span class="nc" id="L31">    private val postSubscribersApiCallsProvider: PostSubscribersApiCallsProvider,</span>
<span class="nc" id="L32">    private val accountStore: AccountStore,</span>
<span class="nc" id="L33">    private val readerTracker: ReaderTracker,</span>
<span class="nc" id="L34">    private val readerPostTableWrapper: ReaderPostTableWrapper</span>
) {
<span class="nc" id="L36">    suspend fun getMySubscriptionToPost(blogId: Long, postId: Long, isInit: Boolean) = flow {</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">        if (!accountStore.hasAccessToken()) {</span>
<span class="nc" id="L38">            emit(UserNotAuthenticated)</span>
        } else {
<span class="nc" id="L40">            emit(FollowCommentsState.Loading)</span>

<span class="nc bnc" id="L42" title="All 2 branches missed.">            if (!networkUtilsWrapper.isNetworkAvailable()) {</span>
<span class="nc" id="L43">                emit(FollowCommentsState.Failure(blogId, postId, UiStringRes(R.string.error_network_connection)))</span>
            } else {
<span class="nc" id="L45">                val canFollowComments = postSubscribersApiCallsProvider.getCanFollowComments(blogId)</span>

<span class="nc bnc" id="L47" title="All 2 branches missed.">                if (!canFollowComments) {</span>
<span class="nc" id="L48">                    emit(FollowCommentsState.FollowCommentsNotAllowed)</span>
                } else {
<span class="nc" id="L50">                    val status = postSubscribersApiCallsProvider.getMySubscriptionToPost(blogId, postId)</span>

<span class="nc" id="L52">                    when (status) {</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">                        is Success -&gt; {</span>
<span class="nc" id="L54">                            emit(</span>
<span class="nc" id="L55">                                    FollowCommentsState.FollowStateChanged(</span>
<span class="nc" id="L56">                                            blogId = blogId,</span>
<span class="nc" id="L57">                                            postId = postId,</span>
<span class="nc" id="L58">                                            isFollowing = status.isFollowing,</span>
<span class="nc" id="L59">                                            isReceivingNotifications = status.isReceivingNotifications,</span>
<span class="nc" id="L60">                                            isInit = isInit</span>
                                    )
                            )
                        }
<span class="nc bnc" id="L64" title="All 2 branches missed.">                        is Failure -&gt; {</span>
<span class="nc" id="L65">                            emit(FollowCommentsState.Failure(blogId, postId, UiStringText(status.error)))</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L71">    }</span>

    suspend fun setMySubscriptionToPost(
        blogId: Long,
        postId: Long,
        subscribe: Boolean,
        source: ThreadedCommentsActionSource
<span class="nc" id="L78">    ): Flow&lt;FollowCommentsState&gt; = flow {</span>
<span class="nc" id="L79">        val properties = mutableMapOf&lt;String, Any?&gt;()</span>

<span class="nc" id="L81">        properties.addFollowAction(subscribe)</span>
<span class="nc" id="L82">        properties.addFollowActionSource(source)</span>

<span class="nc" id="L84">        emit(FollowCommentsState.Loading)</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!networkUtilsWrapper.isNetworkAvailable()) {</span>
<span class="nc" id="L87">            emit(FollowCommentsState.Failure(blogId, postId, UiStringRes(R.string.error_network_connection)))</span>
<span class="nc" id="L88">            properties.addFollowActionResult(ERROR, NO_NETWORK.errorMessage)</span>
        } else {
<span class="nc bnc" id="L90" title="All 2 branches missed.">            val status = if (subscribe) {</span>
<span class="nc" id="L91">                postSubscribersApiCallsProvider.subscribeMeToPost(blogId, postId)</span>
            } else {
<span class="nc" id="L93">                postSubscribersApiCallsProvider.unsubscribeMeFromPost(blogId, postId)</span>
            }

<span class="nc" id="L96">            when (status) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                is Success -&gt; {</span>
<span class="nc" id="L98">                    emit(</span>
<span class="nc" id="L99">                            FollowCommentsState.FollowStateChanged(</span>
<span class="nc" id="L100">                                    blogId = blogId,</span>
<span class="nc" id="L101">                                    postId = postId,</span>
<span class="nc" id="L102">                                    isFollowing = status.isFollowing,</span>
<span class="nc" id="L103">                                    isReceivingNotifications = status.isReceivingNotifications,</span>
<span class="nc" id="L104">                                    false,</span>
<span class="nc" id="L105">                                    userMessage = UiStringRes(</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                                            if (status.isFollowing) {</span>
<span class="nc" id="L107">                                                R.string.reader_follow_comments_subscribe_success_enable_push</span>
                                            } else {
<span class="nc" id="L109">                                                R.string.reader_follow_comments_unsubscribe_from_all_success</span>
                                            }
                                    )
                            )
                    )
<span class="nc" id="L114">                    properties.addFollowActionResult(SUCCEEDED)</span>
                }
<span class="nc bnc" id="L116" title="All 2 branches missed.">                is Failure -&gt; {</span>
<span class="nc" id="L117">                    emit(FollowCommentsState.Failure(blogId, postId, UiStringText(status.error)))</span>
<span class="nc" id="L118">                    properties.addFollowActionResult(ERROR, status.error)</span>
                }
            }
        }

<span class="nc" id="L123">        val post = readerPostTableWrapper.getBlogPost(blogId, postId, true)</span>

<span class="nc" id="L125">        readerTracker.trackPostComments(</span>
<span class="nc" id="L126">                Stat.COMMENT_FOLLOW_CONVERSATION,</span>
<span class="nc" id="L127">                blogId,</span>
<span class="nc" id="L128">                postId,</span>
<span class="nc" id="L129">                post,</span>
<span class="nc" id="L130">                properties</span>
        )
<span class="nc" id="L132">    }</span>

    suspend fun setEnableByPushNotifications(
        blogId: Long,
        postId: Long,
        enable: Boolean,
        source: ThreadedCommentsActionSource
<span class="nc" id="L139">    ): Flow&lt;FollowCommentsState&gt; = flow {</span>
<span class="nc" id="L140">        val properties = mutableMapOf&lt;String, Any?&gt;()</span>
<span class="nc" id="L141">        properties.addEnablePushNotificationAction(enable)</span>
<span class="nc" id="L142">        properties.addFollowActionSource(source)</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (!networkUtilsWrapper.isNetworkAvailable()) {</span>
<span class="nc" id="L145">            emit(FollowCommentsState.FollowStateChanged(</span>
<span class="nc" id="L146">                    blogId = blogId,</span>
<span class="nc" id="L147">                    postId = postId,</span>
<span class="nc" id="L148">                    isFollowing = true,</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                    isReceivingNotifications = !enable,</span>
<span class="nc" id="L150">                    false,</span>
<span class="nc" id="L151">                    userMessage = UiStringRes(R.string.error_network_connection),</span>
<span class="nc" id="L152">                    true</span>
            ))
<span class="nc" id="L154">            properties.addFollowActionResult(ERROR, NO_NETWORK.errorMessage)</span>
        } else {
<span class="nc" id="L156">            when (val status = postSubscribersApiCallsProvider.managePushNotificationsForPost(blogId, postId, enable)) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                is Success -&gt; {</span>
<span class="nc" id="L158">                    emit(FollowCommentsState.FollowStateChanged(</span>
<span class="nc" id="L159">                                    blogId = blogId,</span>
<span class="nc" id="L160">                                    postId = postId,</span>
<span class="nc" id="L161">                                    isFollowing = status.isFollowing,</span>
<span class="nc" id="L162">                                    isReceivingNotifications = status.isReceivingNotifications,</span>
<span class="nc" id="L163">                                    false,</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                                    userMessage = UiStringRes(if (enable) {</span>
<span class="nc" id="L165">                                                R.string.reader_follow_comments_subscribe_to_push_success</span>
                                            } else {
<span class="nc" id="L167">                                                R.string.reader_follow_comments_unsubscribe_from_push_success</span>
                                            }),
<span class="nc" id="L169">                                    false</span>
                    ))
<span class="nc" id="L171">                    properties.addFollowActionResult(SUCCEEDED)</span>
                }
<span class="nc bnc" id="L173" title="All 2 branches missed.">                is Failure -&gt; {</span>
<span class="nc" id="L174">                    emit(FollowCommentsState.FollowStateChanged(</span>
<span class="nc" id="L175">                            blogId = blogId,</span>
<span class="nc" id="L176">                            postId = postId,</span>
<span class="nc" id="L177">                            isFollowing = true,</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                            isReceivingNotifications = !enable,</span>
<span class="nc" id="L179">                            false,</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                            userMessage = UiStringRes(if (enable) {</span>
<span class="nc" id="L181">                                        R.string.reader_follow_comments_could_not_subscribe_to_push_error</span>
                                    } else {
<span class="nc" id="L183">                                        R.string.reader_follow_comments_could_not_unsubscribe_from_push_error</span>
                                    }),
<span class="nc" id="L185">                            true</span>
                    ))
<span class="nc" id="L187">                    properties.addFollowActionResult(ERROR, status.error)</span>
                }
            }
        }
<span class="nc" id="L191">        readerTracker.trackPostComments(</span>
<span class="nc" id="L192">                Stat.COMMENT_FOLLOW_CONVERSATION,</span>
<span class="nc" id="L193">                blogId,</span>
<span class="nc" id="L194">                postId,</span>
<span class="nc" id="L195">                readerPostTableWrapper.getBlogPost(blogId, postId, true),</span>
<span class="nc" id="L196">                properties</span>
        )
<span class="nc" id="L198">    }</span>

<span class="nc" id="L200">    sealed class FollowCommentsState(open val forcePushNotificationsUpdate: Boolean = false) {</span>
<span class="nc" id="L201">        object Loading : FollowCommentsState()</span>

<span class="nc" id="L203">        data class FollowStateChanged(</span>
<span class="nc" id="L204">            val blogId: Long,</span>
<span class="nc" id="L205">            val postId: Long,</span>
<span class="nc" id="L206">            val isFollowing: Boolean,</span>
<span class="nc" id="L207">            val isReceivingNotifications: Boolean,</span>
<span class="nc" id="L208">            val isInit: Boolean = false,</span>
<span class="nc" id="L209">            val userMessage: UiString? = null,</span>
<span class="nc" id="L210">            override val forcePushNotificationsUpdate: Boolean = false</span>
<span class="nc" id="L211">        ) : FollowCommentsState()</span>

<span class="nc" id="L213">        data class Failure(</span>
<span class="nc" id="L214">            val blogId: Long,</span>
<span class="nc" id="L215">            val postId: Long,</span>
<span class="nc" id="L216">            val error: UiString</span>
<span class="nc" id="L217">        ) : FollowCommentsState()</span>

<span class="nc" id="L219">        object FollowCommentsNotAllowed : FollowCommentsState()</span>

<span class="nc" id="L221">        object UserNotAuthenticated : FollowCommentsState()</span>

<span class="nc" id="L223">        data class FlagsMappedState(</span>
<span class="nc" id="L224">            val flags: FollowConversationStatusFlags</span>
<span class="nc" id="L225">        ) : FollowCommentsState()</span>
<span class="nc" id="L226">    }</span>

<span class="nc" id="L228">    private enum class AnalyticsFollowCommentsAction(val action: String) {</span>
<span class="nc" id="L229">        FOLLOW_COMMENTS(&quot;followed&quot;),</span>
<span class="nc" id="L230">        UNFOLLOW_COMMENTS(&quot;unfollowed&quot;),</span>
<span class="nc" id="L231">        ENABLE_PUSH_NOTIFICATION(&quot;enable_push_notifications&quot;),</span>
<span class="nc" id="L232">        DISABLE_PUSH_NOTIFICATION(&quot;disable_push_notifications&quot;)</span>
    }

<span class="nc" id="L235">    private enum class AnalyticsFollowCommentsActionResult(val actionResult: String) {</span>
<span class="nc" id="L236">        SUCCEEDED(&quot;succeeded&quot;),</span>
<span class="nc" id="L237">        ERROR(&quot;error&quot;)</span>
    }

<span class="nc" id="L240">    private enum class AnalyticsFollowCommentsGenericError(val errorMessage: String) {</span>
<span class="nc" id="L241">        NO_NETWORK(&quot;no_network&quot;)</span>
    }

    private fun MutableMap&lt;String, Any?&gt;.addFollowAction(subscribe: Boolean): MutableMap&lt;String, Any?&gt; {
<span class="nc bnc" id="L245" title="All 2 branches missed.">        this[FOLLOW_COMMENT_ACTION] = if (subscribe) {</span>
<span class="nc" id="L246">            FOLLOW_COMMENTS.action</span>
        } else {
<span class="nc" id="L248">            UNFOLLOW_COMMENTS.action</span>
        }
<span class="nc" id="L250">        return this</span>
    }

    private fun MutableMap&lt;String, Any?&gt;.addEnablePushNotificationAction(enable: Boolean): MutableMap&lt;String, Any?&gt; {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        this[FOLLOW_COMMENT_ACTION] = if (enable) {</span>
<span class="nc" id="L255">            ENABLE_PUSH_NOTIFICATION.action</span>
        } else {
<span class="nc" id="L257">            DISABLE_PUSH_NOTIFICATION.action</span>
        }
<span class="nc" id="L259">        return this</span>
    }

<span class="nc" id="L262">    private fun MutableMap&lt;String, Any?&gt;.addFollowActionResult(</span>
        result: AnalyticsFollowCommentsActionResult,
<span class="nc" id="L264">        errorMessage: String? = null</span>
    ): MutableMap&lt;String, Any?&gt; {
<span class="nc" id="L266">        this[FOLLOW_COMMENT_ACTION_RESULT] = result.actionResult</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">        errorMessage?.also {</span>
<span class="nc" id="L268">            this[FOLLOW_COMMENT_ACTION_ERROR] = errorMessage</span>
<span class="nc" id="L269">        }</span>
<span class="nc" id="L270">        return this</span>
    }

    private fun MutableMap&lt;String, Any?&gt;.addFollowActionSource(
        source: ThreadedCommentsActionSource
    ): MutableMap&lt;String, Any?&gt; {
<span class="nc" id="L276">        this[FOLLOW_COMMENT_ACTION_SOURCE] = source.sourceDescription</span>
<span class="nc" id="L277">        return this</span>
    }

    companion object {
        private const val FOLLOW_COMMENT_ACTION = &quot;follow_action&quot;
        private const val FOLLOW_COMMENT_ACTION_RESULT = &quot;follow_action_result&quot;
        private const val FOLLOW_COMMENT_ACTION_ERROR = &quot;follow_action_error&quot;
        private const val FOLLOW_COMMENT_ACTION_SOURCE = &quot;source&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>