<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ActivityLogTypeFilterFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.activitylog.list.filter</a> &gt; <span class="el_source">ActivityLogTypeFilterFragment.kt</span></div><h1>ActivityLogTypeFilterFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.activitylog.list.filter

import android.content.Context
import android.os.Bundle
import android.view.LayoutInflater
import android.view.Menu
import android.view.MenuItem
import android.view.View
import android.view.ViewGroup
import androidx.core.util.Pair
import androidx.fragment.app.DialogFragment
import androidx.lifecycle.ViewModelProvider
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.ActivityLogTypeFilterFragmentBinding
import org.wordpress.android.databinding.ProgressLayoutBinding
import org.wordpress.android.fluxc.model.LocalOrRemoteId.RemoteId
import org.wordpress.android.ui.activitylog.list.filter.ActivityLogTypeFilterViewModel.UiState.Content
import org.wordpress.android.ui.activitylog.list.filter.ActivityLogTypeFilterViewModel.UiState.Error
import org.wordpress.android.ui.activitylog.list.filter.ActivityLogTypeFilterViewModel.UiState.FullscreenLoading
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.ColorUtils
import org.wordpress.android.util.extensions.getColorResIdFromAttribute
import org.wordpress.android.viewmodel.activitylog.ActivityLogViewModel
import org.wordpress.android.viewmodel.activitylog.DateRange
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

private const val ARG_INITIAL_SELECTION = &quot;arg_initial_selection&quot;
private const val ARG_DATE_RANGE_AFTER = &quot;arg_date_range_after&quot;
private const val ARG_DATE_RANGE_BEFORE = &quot;arg_date_range_before&quot;
private const val ACTIONS_MENU_GROUP = 1

/**
 * Show the primary action closer to user's finger.
 */
private const val PRIMARY_ACTION_ORDER = 2
private const val SECONDARY_ACTION_ORDER = 1

/**
 * Always show the primary action no matter the screen size.
 */
private const val PRIMARY_ACTION_SHOW_ALWAYS = true
private const val SECONDARY_ACTION_SHOW_ALWAYS = false

<span class="nc" id="L48">class ActivityLogTypeFilterFragment : DialogFragment() {</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>

    private lateinit var viewModel: ActivityLogTypeFilterViewModel

<span class="nc" id="L54">    override fun getTheme(): Int = R.style.WordPress_FullscreenDialog</span>

    override fun onAttach(context: Context) {
<span class="nc" id="L57">        super.onAttach(context)</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        (requireActivity().applicationContext as WordPress).component().inject(this)</span>
<span class="nc" id="L59">    }</span>

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
<span class="nc" id="L62">        return inflater.inflate(R.layout.activity_log_type_filter_fragment, container, false)</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L66">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L67">        with(ActivityLogTypeFilterFragmentBinding.bind(view)) {</span>
<span class="nc" id="L68">            initToolbar()</span>
<span class="nc" id="L69">            initRecyclerView()</span>
<span class="nc" id="L70">            initViewModel()</span>
<span class="nc" id="L71">        }</span>
<span class="nc" id="L72">    }</span>

    private fun ActivityLogTypeFilterFragmentBinding.initToolbar() {
<span class="nc" id="L75">        toolbarMain.navigationIcon = ColorUtils.applyTintToDrawable(</span>
<span class="nc" id="L76">                toolbarMain.context, R.drawable.ic_close_white_24dp,</span>
<span class="nc" id="L77">                toolbarMain.context.getColorResIdFromAttribute(R.attr.colorOnSurface)</span>
        )
<span class="nc" id="L79">        toolbarMain.setNavigationContentDescription(R.string.close_dialog_button_desc)</span>
<span class="nc" id="L80">        toolbarMain.setNavigationOnClickListener { dismiss() }</span>
<span class="nc" id="L81">    }</span>

    private fun ActivityLogTypeFilterFragmentBinding.initRecyclerView() {
<span class="nc" id="L84">        recyclerView.layoutManager = LinearLayoutManager(context, RecyclerView.VERTICAL, false)</span>
<span class="nc" id="L85">        initAdapter()</span>
<span class="nc" id="L86">    }</span>

    private fun ActivityLogTypeFilterFragmentBinding.initViewModel() {
<span class="nc" id="L89">        viewModel = ViewModelProvider(this@ActivityLogTypeFilterFragment, viewModelFactory)</span>
<span class="nc" id="L90">                .get(ActivityLogTypeFilterViewModel::class.java)</span>

<span class="nc" id="L92">        val parentViewModel = ViewModelProvider(requireParentFragment(), viewModelFactory)</span>
<span class="nc" id="L93">                .get(ActivityLogViewModel::class.java)</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner, { uiState -&gt;</span>
<span class="nc" id="L96">            uiHelpers.updateVisibility(actionableEmptyView, uiState.errorVisibility)</span>
<span class="nc" id="L97">            uiHelpers.updateVisibility(recyclerView, uiState.contentVisibility)</span>
<span class="nc" id="L98">            uiHelpers.updateVisibility(progress.root, uiState.loadingVisibility)</span>
<span class="nc" id="L99">            refreshMenuItems(uiState)</span>
<span class="nc" id="L100">            when (uiState) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                is FullscreenLoading -&gt; progress.refreshLoadingScreen(uiState)</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                is Error -&gt; refreshErrorScreen(uiState)</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                is Content -&gt; refreshContentScreen(uiState)</span>
            }
<span class="nc" id="L105">        })</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        viewModel.dismissDialog.observeEvent(viewLifecycleOwner, {</span>
<span class="nc" id="L107">            dismiss()</span>
<span class="nc" id="L108">        })</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">        val afterDateRangeAvailable = requireNotNull(arguments).containsKey(ARG_DATE_RANGE_AFTER)</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        val beforeDateRangeAvailable = requireNotNull(arguments).containsKey(ARG_DATE_RANGE_BEFORE)</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">        val dateRange: DateRange? = if (afterDateRangeAvailable &amp;&amp; beforeDateRangeAvailable) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            val after = requireNotNull(arguments).getLong(ARG_DATE_RANGE_AFTER)</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            val before = requireNotNull(arguments).getLong(ARG_DATE_RANGE_BEFORE)</span>
<span class="nc" id="L115">            Pair(after, before)</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">        } else if (afterDateRangeAvailable || beforeDateRangeAvailable) {</span>
<span class="nc" id="L117">            throw IllegalStateException(&quot;DateRange is missing after or before date&quot;)</span>
        } else {
<span class="nc" id="L119">            null</span>
        }
<span class="nc bnc" id="L121" title="All 2 branches missed.">        viewModel.start(</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                remoteSiteId = RemoteId(requireNotNull(arguments).getLong(WordPress.REMOTE_SITE_ID)),</span>
<span class="nc bnc" id="L123" title="All 6 branches missed.">                initialSelection = requireNotNull(arguments).getStringArray(ARG_INITIAL_SELECTION)?.toList()</span>
<span class="nc" id="L124">                        ?: listOf(),</span>
<span class="nc" id="L125">                dateRange = dateRange,</span>
<span class="nc" id="L126">                parentViewModel = parentViewModel</span>
        )
<span class="nc" id="L128">    }</span>

    private fun ProgressLayoutBinding.refreshLoadingScreen(uiState: FullscreenLoading) {
<span class="nc" id="L131">        uiHelpers.setTextOrHide(progressText, uiState.loadingText)</span>
<span class="nc" id="L132">    }</span>

    private fun ActivityLogTypeFilterFragmentBinding.refreshErrorScreen(uiState: Error) {
<span class="nc" id="L135">        actionableEmptyView.image.setImageResource(uiState.image)</span>
<span class="nc" id="L136">        uiHelpers.setTextOrHide(actionableEmptyView.title, uiState.title)</span>
<span class="nc" id="L137">        uiHelpers.setTextOrHide(actionableEmptyView.subtitle, uiState.subtitle)</span>
<span class="nc" id="L138">        uiHelpers.setTextOrHide(actionableEmptyView.button, uiState.buttonText)</span>
<span class="nc bnc" id="L139" title="All 4 branches missed.">        actionableEmptyView.button.setOnClickListener { uiState.retryAction?.action?.invoke() }</span>
<span class="nc" id="L140">    }</span>

    private fun ActivityLogTypeFilterFragmentBinding.refreshContentScreen(uiState: Content) {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        (recyclerView.adapter as ActivityLogTypeFilterAdapter).update(uiState.items)</span>
<span class="nc" id="L144">    }</span>

    private fun ActivityLogTypeFilterFragmentBinding.refreshMenuItems(uiState: ActivityLogTypeFilterViewModel.UiState) {
<span class="nc" id="L147">        val menu = toolbarMain.menu</span>
<span class="nc" id="L148">        menu.removeGroup(ACTIONS_MENU_GROUP)</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (uiState is Content) {</span>
<span class="nc" id="L151">            addMenuItem(uiState.primaryAction, PRIMARY_ACTION_ORDER, showAlways = PRIMARY_ACTION_SHOW_ALWAYS)</span>
<span class="nc" id="L152">            addMenuItem(uiState.secondaryAction, SECONDARY_ACTION_ORDER, showAlways = SECONDARY_ACTION_SHOW_ALWAYS)</span>
        }
<span class="nc" id="L154">    }</span>

    private fun ActivityLogTypeFilterFragmentBinding.addMenuItem(
        action: ActivityLogTypeFilterViewModel.Action,
        order: Int,
        showAlways: Boolean
    ) {
<span class="nc" id="L161">        val actionLabel = uiHelpers.getTextOfUiString(requireContext(), action.label)</span>
<span class="nc" id="L162">        toolbarMain.menu.add(ACTIONS_MENU_GROUP, Menu.NONE, order, actionLabel).let {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (showAlways) {</span>
<span class="nc" id="L164">                it.setShowAsAction(MenuItem.SHOW_AS_ACTION_ALWAYS)</span>
            } else {
<span class="nc" id="L166">                it.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM)</span>
            }
<span class="nc" id="L168">            it.setOnMenuItemClickListener {</span>
<span class="nc" id="L169">                action.action.invoke()</span>
<span class="nc" id="L170">                true</span>
            }
        }
<span class="nc" id="L173">    }</span>

    private fun ActivityLogTypeFilterFragmentBinding.initAdapter() {
<span class="nc" id="L176">        recyclerView.adapter = ActivityLogTypeFilterAdapter(uiHelpers)</span>
<span class="nc" id="L177">    }</span>

    companion object {
        @JvmStatic
        fun newInstance(
            remoteSiteId: RemoteId,
            initialSelection: List&lt;String&gt;,
            dateRange: DateRange?
        ): ActivityLogTypeFilterFragment {
<span class="nc" id="L186">            val args = Bundle()</span>
<span class="nc" id="L187">            args.putStringArray(ARG_INITIAL_SELECTION, initialSelection.toTypedArray())</span>
<span class="nc bnc" id="L188" title="All 4 branches missed.">            dateRange?.first?.let { args.putLong(ARG_DATE_RANGE_AFTER, it) }</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">            dateRange?.second?.let { args.putLong(ARG_DATE_RANGE_BEFORE, it) }</span>
<span class="nc" id="L190">            args.putLong(WordPress.REMOTE_SITE_ID, remoteSiteId.value)</span>
<span class="nc" id="L191">            return ActivityLogTypeFilterFragment().apply { arguments = args }</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>