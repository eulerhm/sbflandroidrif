<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatsFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stats.refresh</a> &gt; <span class="el_source">StatsFragment.kt</span></div><h1>StatsFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stats.refresh

import android.annotation.SuppressLint
import android.os.Bundle
import android.view.MotionEvent
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentActivity
import androidx.fragment.app.activityViewModels
import androidx.viewpager2.adapter.FragmentStateAdapter
import androidx.viewpager2.widget.MarginPageTransformer
import com.google.android.material.snackbar.Snackbar
import com.google.android.material.tabs.TabLayout.OnTabSelectedListener
import com.google.android.material.tabs.TabLayout.Tab
import com.google.android.material.tabs.TabLayoutMediator
import dagger.hilt.android.AndroidEntryPoint
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.StatsFragmentBinding
import org.wordpress.android.ui.ScrollableViewInitializedListener
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.stats.refresh.StatsViewModel.StatsModuleUiModel
import org.wordpress.android.ui.stats.refresh.lists.StatsListFragment
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.ANNUAL_STATS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.DAYS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.DETAIL
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.INSIGHTS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.INSIGHT_DETAIL
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.MONTHS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.TOTAL_COMMENTS_DETAIL
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.TOTAL_FOLLOWERS_DETAIL
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.TOTAL_LIKES_DETAIL
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.WEEKS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.YEARS
import org.wordpress.android.ui.stats.refresh.utils.StatsSiteProvider.SiteUpdateResult
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.WPSwipeToRefreshHelper
import org.wordpress.android.util.helpers.SwipeToRefreshHelper
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.widgets.WPSnackbar
import javax.inject.Inject

<span class="nc" id="L45">private val statsSections = listOf(INSIGHTS, DAYS, WEEKS, MONTHS, YEARS)</span>

@AndroidEntryPoint
<span class="nc" id="L48">class StatsFragment : Fragment(R.layout.stats_fragment), ScrollableViewInitializedListener {</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc" id="L50">    private val viewModel: StatsViewModel by activityViewModels()</span>
    private lateinit var swipeToRefreshHelper: SwipeToRefreshHelper
    private lateinit var selectedTabListener: SelectedTabListener

    private var restorePreviousSearch = false

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L57">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L58">        setHasOptionsMenu(true)</span>
<span class="nc" id="L59">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L62">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc" id="L64">        val nonNullActivity = requireActivity()</span>
<span class="nc" id="L65">        with(StatsFragmentBinding.bind(view)) {</span>
<span class="nc" id="L66">            with(nonNullActivity as AppCompatActivity) {</span>
<span class="nc" id="L67">                setSupportActionBar(toolbar)</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                supportActionBar?.let {</span>
<span class="nc" id="L69">                    it.setHomeButtonEnabled(true)</span>
<span class="nc" id="L70">                    it.setDisplayHomeAsUpEnabled(true)</span>
<span class="nc" id="L71">                }</span>
            }
<span class="nc bnc" id="L73" title="All 2 branches missed.">            initializeViewModels(nonNullActivity, savedInstanceState == null, savedInstanceState)</span>
<span class="nc" id="L74">            initializeViews(nonNullActivity)</span>
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc bnc" id="L79" title="All 4 branches missed.">        outState.putInt(WordPress.LOCAL_SITE_ID, activity?.intent?.getIntExtra(WordPress.LOCAL_SITE_ID, 0) ?: 0)</span>
<span class="nc" id="L80">        viewModel.onSaveInstanceState(outState)</span>
<span class="nc" id="L81">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L82">    }</span>

    private fun StatsFragmentBinding.initializeViews(activity: FragmentActivity) {
<span class="nc" id="L85">        val adapter = StatsPagerAdapter(activity)</span>
<span class="nc" id="L86">        statsPager.adapter = adapter</span>
<span class="nc" id="L87">        statsPager.setPageTransformer(</span>
<span class="nc" id="L88">                MarginPageTransformer(resources.getDimensionPixelSize(R.dimen.margin_extra_large))</span>
        )
<span class="nc" id="L90">        selectedTabListener = SelectedTabListener(viewModel)</span>
<span class="nc" id="L91">        TabLayoutMediator(tabLayout, statsPager) { tab, position -&gt;</span>
<span class="nc" id="L92">            tab.text = adapter.getTabTitle(position)</span>
<span class="nc" id="L93">        }.attach()</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        tabLayout.addOnTabSelectedListener(selectedTabListener)</span>

<span class="nc" id="L96">        swipeToRefreshHelper = WPSwipeToRefreshHelper.buildSwipeToRefreshHelper(pullToRefresh) {</span>
<span class="nc" id="L97">            viewModel.onPullToRefresh()</span>
<span class="nc" id="L98">        }</span>
<span class="nc" id="L99">        disabledView.statsDisabledView.button.setOnClickListener {</span>
<span class="nc" id="L100">            viewModel.onEnableStatsModuleClick()</span>
<span class="nc" id="L101">        }</span>
<span class="nc" id="L102">    }</span>

    @SuppressLint(&quot;ClickableViewAccessibility&quot;)
    private fun StatsFragmentBinding.initializeViewModels(
        activity: FragmentActivity,
        isFirstStart: Boolean,
        savedInstanceState: Bundle?
    ) {
<span class="nc" id="L110">        viewModel.onRestoreInstanceState(savedInstanceState)</span>

<span class="nc" id="L112">        setupObservers(activity)</span>

<span class="nc" id="L114">        viewModel.start(activity.intent)</span>

<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (!isFirstStart) {</span>
<span class="nc" id="L117">            restorePreviousSearch = true</span>
        }

<span class="nc" id="L120">        statsPager.setOnTouchListener { _, event -&gt;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            swipeToRefreshHelper.setEnabled(false)</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (event.action == MotionEvent.ACTION_UP) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                swipeToRefreshHelper.setEnabled(true)</span>
            }
<span class="nc" id="L125">            return@setOnTouchListener false</span>
        }
<span class="nc" id="L127">    }</span>

    private fun StatsFragmentBinding.setupObservers(activity: FragmentActivity) {
<span class="nc" id="L130">        viewModel.isRefreshing.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            it?.let { isRefreshing -&gt;</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                swipeToRefreshHelper.isRefreshing = isRefreshing</span>
<span class="nc" id="L133">            }</span>
<span class="nc" id="L134">        })</span>

<span class="nc" id="L136">        viewModel.showSnackbarMessage.observe(viewLifecycleOwner, { holder -&gt;</span>
<span class="nc" id="L137">            showSnackbar(activity, holder)</span>
<span class="nc" id="L138">        })</span>

<span class="nc" id="L140">        viewModel.toolbarHasShadow.observe(viewLifecycleOwner, { hasShadow -&gt;</span>
<span class="nc" id="L141">            appBarLayout.showShadow(hasShadow == true)</span>
<span class="nc" id="L142">        })</span>

<span class="nc" id="L144">        viewModel.siteChanged.observeEvent(viewLifecycleOwner, { siteUpdateResult -&gt;</span>
<span class="nc" id="L145">            when (siteUpdateResult) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                is SiteUpdateResult.SiteConnected -&gt; viewModel.onSiteChanged()</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">                is SiteUpdateResult.NotConnectedJetpackSite -&gt; getActivity()?.finish()</span>
            }
<span class="nc" id="L149">        })</span>

<span class="nc" id="L151">        viewModel.hideToolbar.observeEvent(viewLifecycleOwner, { hideToolbar -&gt;</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            appBarLayout.setExpanded(!hideToolbar, true)</span>
<span class="nc" id="L153">        })</span>

<span class="nc" id="L155">        viewModel.selectedSection.observe(viewLifecycleOwner, { selectedSection -&gt;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            selectedSection?.let {</span>
<span class="nc" id="L157">                handleSelectedSection(selectedSection)</span>
<span class="nc" id="L158">            }</span>
<span class="nc" id="L159">        })</span>

<span class="nc" id="L161">        viewModel.statsModuleUiModel.observeEvent(viewLifecycleOwner, { event -&gt;</span>
<span class="nc" id="L162">            updateUi(event)</span>
<span class="nc" id="L163">        })</span>
<span class="nc" id="L164">    }</span>

    private fun StatsFragmentBinding.updateUi(statsModuleUiModel: StatsModuleUiModel) {
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (statsModuleUiModel.disabledStatsViewVisible) {</span>
<span class="nc" id="L168">            disabledView.statsDisabledView.visibility = View.VISIBLE</span>
<span class="nc" id="L169">            tabLayout.visibility = View.GONE</span>
<span class="nc" id="L170">            pullToRefresh.visibility = View.GONE</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (statsModuleUiModel.disabledStatsProgressVisible) {</span>
<span class="nc" id="L173">                disabledView.statsDisabledView.progressBar.visibility = View.VISIBLE</span>
<span class="nc" id="L174">                disabledView.statsDisabledView.button.visibility = View.GONE</span>
            } else {
<span class="nc" id="L176">                disabledView.statsDisabledView.progressBar.visibility = View.GONE</span>
<span class="nc" id="L177">                disabledView.statsDisabledView.button.visibility = View.VISIBLE</span>
            }
        } else {
<span class="nc" id="L180">            disabledView.statsDisabledView.visibility = View.GONE</span>
<span class="nc" id="L181">            tabLayout.visibility = View.VISIBLE</span>
<span class="nc" id="L182">            pullToRefresh.visibility = View.VISIBLE</span>
        }
<span class="nc" id="L184">    }</span>

    private fun StatsFragmentBinding.handleSelectedSection(
        selectedSection: StatsSection
    ) {
<span class="nc bnc" id="L189" title="All 6 branches missed.">        val position = when (selectedSection) {</span>
<span class="nc" id="L190">            INSIGHTS -&gt; 0</span>
<span class="nc" id="L191">            DAYS -&gt; 1</span>
<span class="nc" id="L192">            WEEKS -&gt; 2</span>
<span class="nc" id="L193">            MONTHS -&gt; 3</span>
<span class="nc" id="L194">            YEARS -&gt; 4</span>
            DETAIL,
            INSIGHT_DETAIL,
            TOTAL_LIKES_DETAIL,
            TOTAL_COMMENTS_DETAIL,
            TOTAL_FOLLOWERS_DETAIL,
<span class="nc" id="L200">            ANNUAL_STATS -&gt; null</span>
        }
<span class="nc bnc" id="L202" title="All 2 branches missed.">        position?.let {</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">            if (statsPager.currentItem != position) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                tabLayout.removeOnTabSelectedListener(selectedTabListener)</span>
<span class="nc" id="L205">                statsPager.setCurrentItem(position, false)</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                tabLayout.addOnTabSelectedListener(selectedTabListener)</span>
            }
<span class="nc" id="L208">        }</span>
<span class="nc" id="L209">    }</span>

    private fun showSnackbar(
        activity: FragmentActivity,
        holder: SnackbarMessageHolder?
    ) {
<span class="nc" id="L215">        val parent = activity.findViewById&lt;View&gt;(R.id.coordinatorLayout)</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">        if (holder != null &amp;&amp; parent != null) {</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (holder.buttonTitle == null) {</span>
<span class="nc" id="L218">                WPSnackbar.make(</span>
<span class="nc" id="L219">                        parent,</span>
<span class="nc" id="L220">                        uiHelpers.getTextOfUiString(requireContext(), holder.message),</span>
<span class="nc" id="L221">                        Snackbar.LENGTH_LONG</span>
<span class="nc" id="L222">                ).show()</span>
            } else {
<span class="nc" id="L224">                val snackbar = WPSnackbar.make(</span>
<span class="nc" id="L225">                        parent,</span>
<span class="nc" id="L226">                        uiHelpers.getTextOfUiString(requireContext(), holder.message),</span>
<span class="nc" id="L227">                        Snackbar.LENGTH_LONG</span>
                )
<span class="nc" id="L229">                snackbar.setAction(uiHelpers.getTextOfUiString(requireContext(), holder.buttonTitle)) {</span>
<span class="nc" id="L230">                    holder.buttonAction()</span>
<span class="nc" id="L231">                }</span>
<span class="nc" id="L232">                snackbar.show()</span>
            }
        }
<span class="nc" id="L235">    }</span>

    override fun onScrollableViewInitialized(containerId: Int) {
<span class="nc" id="L238">        StatsFragmentBinding.bind(requireView()).appBarLayout.liftOnScrollTargetViewId = containerId</span>
<span class="nc" id="L239">    }</span>
}

<span class="nc" id="L242">class StatsPagerAdapter(val activity: FragmentActivity) : FragmentStateAdapter(activity) {</span>
<span class="nc" id="L243">    override fun getItemCount(): Int = statsSections.size</span>

    override fun createFragment(position: Int): Fragment {
<span class="nc" id="L246">        return StatsListFragment.newInstance(statsSections[position])</span>
    }

    fun getTabTitle(position: Int): CharSequence {
<span class="nc" id="L250">        return activity.getString(statsSections[position].titleRes)</span>
    }
}

<span class="nc" id="L254">private class SelectedTabListener(val viewModel: StatsViewModel) : OnTabSelectedListener {</span>
    override fun onTabReselected(tab: Tab?) {
<span class="nc" id="L256">    }</span>

    override fun onTabUnselected(tab: Tab?) {
<span class="nc" id="L259">    }</span>

    override fun onTabSelected(tab: Tab) {
<span class="nc" id="L262">        viewModel.onSectionSelected(statsSections[tab.position])</span>
<span class="nc" id="L263">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>