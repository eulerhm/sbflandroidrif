<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DomainRegistrationDetailsFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.domains</a> &gt; <span class="el_source">DomainRegistrationDetailsFragment.kt</span></div><h1>DomainRegistrationDetailsFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.domains

import android.app.Dialog
import android.app.ProgressDialog
import android.content.Context
import android.os.Bundle
import android.text.Editable
import android.text.Html
import android.text.TextUtils
import android.text.TextWatcher
import android.text.method.LinkMovementMethod
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.EditText
import androidx.fragment.app.DialogFragment
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import com.google.android.material.textfield.TextInputEditText
import com.google.android.material.textfield.TextInputLayout
import dagger.android.support.AndroidSupportInjection
import org.apache.commons.lang3.StringEscapeUtils
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.DomainRegistrationDetailsFragmentBinding
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.network.rest.wpcom.site.SupportedStateResponse
import org.wordpress.android.fluxc.network.rest.wpcom.transactions.SupportedDomainCountry
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.ADDRESS_1
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.ADDRESS_2
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.CITY
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.COUNTRY_CODE
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.EMAIL
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.FIRST_NAME
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.LAST_NAME
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.ORGANIZATION
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.PHONE
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.POSTAL_CODE
import org.wordpress.android.fluxc.store.TransactionsStore.TransactionErrorType.STATE
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.ScrollableViewInitializedListener
import org.wordpress.android.ui.domains.DomainRegistrationDetailsViewModel.DomainContactFormModel
import org.wordpress.android.ui.domains.DomainRegistrationDetailsViewModel.DomainRegistrationDetailsUiState
import org.wordpress.android.util.StringUtils
import org.wordpress.android.util.ToastUtils
import org.wordpress.android.util.WPUrlUtils
import javax.inject.Inject

<span class="nc" id="L50">class DomainRegistrationDetailsFragment : Fragment() {</span>
    companion object {
        private const val EXTRA_DOMAIN_PRODUCT_DETAILS = &quot;EXTRA_DOMAIN_PRODUCT_DETAILS&quot;
        const val TAG = &quot;DOMAIN_REGISTRATION_DETAILS&quot;

        fun newInstance(domainProductDetails: DomainProductDetails): DomainRegistrationDetailsFragment {
<span class="nc" id="L56">            val fragment = DomainRegistrationDetailsFragment()</span>
<span class="nc" id="L57">            val bundle = Bundle()</span>
<span class="nc" id="L58">            bundle.putParcelable(EXTRA_DOMAIN_PRODUCT_DETAILS, domainProductDetails)</span>
<span class="nc" id="L59">            fragment.arguments = bundle</span>
<span class="nc" id="L60">            return fragment</span>
        }
    }

<span class="nc bnc" id="L64" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
    private lateinit var viewModel: DomainRegistrationDetailsViewModel
    private lateinit var mainViewModel: DomainRegistrationMainViewModel

    private var loadingProgressDialog: ProgressDialog? = null
    private var binding: DomainRegistrationDetailsFragmentBinding? = null

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L72">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L73">        val nonNullActivity = requireActivity()</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">        (nonNullActivity.application as WordPress).component()?.inject(this)</span>
<span class="nc" id="L75">    }</span>

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
<span class="nc" id="L82">        return inflater.inflate(R.layout.domain_registration_details_fragment, container, false)</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L86">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc" id="L88">        mainViewModel = ViewModelProvider(requireActivity(), viewModelFactory)</span>
<span class="nc" id="L89">                .get(DomainRegistrationMainViewModel::class.java)</span>
<span class="nc" id="L90">        viewModel = ViewModelProvider(this, viewModelFactory)</span>
<span class="nc" id="L91">                .get(DomainRegistrationDetailsViewModel::class.java)</span>
<span class="nc" id="L92">        with(DomainRegistrationDetailsFragmentBinding.bind(view)) {</span>
<span class="nc" id="L93">            binding = this</span>
<span class="nc" id="L94">            setupObservers()</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">            val domainProductDetails = requireNotNull(</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                    arguments?.getParcelable&lt;DomainProductDetails?&gt;(EXTRA_DOMAIN_PRODUCT_DETAILS)</span>
            )
<span class="nc bnc" id="L99" title="All 4 branches missed.">            val site = requireActivity().intent?.getSerializableExtra(WordPress.SITE) as SiteModel</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">            viewModel.start(site, domainProductDetails)</span>

<span class="nc" id="L103">            domainPrivacyOnRadioButton.setOnClickListener {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                viewModel.togglePrivacyProtection(true)</span>
<span class="nc" id="L105">            }</span>

<span class="nc" id="L107">            domainPrivacyOffRadioButton.setOnClickListener {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                viewModel.togglePrivacyProtection(false)</span>
<span class="nc" id="L109">            }</span>

            // Country and State input could only be populated from the dialog
<span class="nc" id="L112">            countryInput.inputType = 0</span>
<span class="nc" id="L113">            countryInput.setOnClickListener {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                viewModel.onCountrySelectorClicked()</span>
<span class="nc" id="L115">            }</span>

<span class="nc" id="L117">            stateInput.inputType = 0</span>
<span class="nc" id="L118">            stateInput.setOnClickListener {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                viewModel.onStateSelectorClicked()</span>
<span class="nc" id="L120">            }</span>

<span class="nc" id="L122">            registerDomainButton.setOnClickListener {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (validateForm()) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">                    viewModel.onRegisterDomainButtonClicked()</span>
                }
<span class="nc" id="L126">            }</span>

<span class="nc" id="L128">            setupTosLink()</span>
<span class="nc" id="L129">            setupInputFieldTextWatchers()</span>
<span class="nc" id="L130">        }</span>
<span class="nc" id="L131">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L134">        super.onDestroyView()</span>
<span class="nc" id="L135">        binding = null</span>
<span class="nc" id="L136">    }</span>

    private fun DomainRegistrationDetailsFragmentBinding.setupInputFieldTextWatchers() {
        arrayOf(
<span class="nc" id="L140">                firstNameInput,</span>
<span class="nc" id="L141">                lastNameInput,</span>
<span class="nc" id="L142">                organizationInput,</span>
<span class="nc" id="L143">                emailInput,</span>
<span class="nc" id="L144">                countryCodeInput,</span>
<span class="nc" id="L145">                phoneNumberInput,</span>
<span class="nc" id="L146">                addressFirstLineInput,</span>
<span class="nc" id="L147">                addressSecondLineInput,</span>
<span class="nc" id="L148">                cityInput,</span>
<span class="nc" id="L149">                postalCodeInput</span>
<span class="nc" id="L150">        ).forEach {</span>
<span class="nc" id="L151">            it.addTextChangedListener(object : TextWatcher {</span>
                override fun afterTextChanged(p0: Editable?) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">                    viewModel.onDomainContactDetailsChanged(getDomainContactFormModel())</span>
<span class="nc" id="L154">                }</span>

                override fun beforeTextChanged(p0: CharSequence?, p1: Int, p2: Int, p3: Int) {
<span class="nc" id="L157">                }</span>

                override fun onTextChanged(p0: CharSequence?, p1: Int, p2: Int, p3: Int) {
<span class="nc" id="L160">                }</span>
            })
<span class="nc" id="L162">        }</span>
<span class="nc" id="L163">    }</span>

    // make link to ToS clickable
    private fun DomainRegistrationDetailsFragmentBinding.setupTosLink() {
<span class="nc" id="L167">        tosExplanation.text = Html.fromHtml(</span>
<span class="nc" id="L168">                String.format(</span>
<span class="nc" id="L169">                        resources.getString(R.string.domain_registration_privacy_protection_tos),</span>
<span class="nc" id="L170">                        &quot;&lt;u&gt;&quot;,</span>
<span class="nc" id="L171">                        &quot;&lt;/u&gt;&quot;</span>
                )
        )
<span class="nc" id="L174">        tosExplanation.movementMethod = LinkMovementMethod.getInstance()</span>
<span class="nc" id="L175">        tosExplanation.setOnClickListener {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            viewModel.onTosLinkClicked()</span>
<span class="nc" id="L177">        }</span>
<span class="nc" id="L178">    }</span>

    private fun DomainRegistrationDetailsFragmentBinding.setupObservers() {
<span class="nc bnc" id="L181" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner,</span>
                {
<span class="nc bnc" id="L183" title="All 2 branches missed.">                    it?.let { uiState -&gt; loadState(uiState) }</span>
<span class="nc" id="L184">                })</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">        viewModel.domainContactForm.observe(</span>
<span class="nc" id="L187">                viewLifecycleOwner,</span>
                { domainContactFormModel -&gt;
<span class="nc" id="L189">                    val currentModel = getDomainContactFormModel()</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                    if (currentModel != domainContactFormModel) {</span>
<span class="nc" id="L191">                        populateContactForm(domainContactFormModel!!)</span>
                    }
<span class="nc" id="L193">                })</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">        viewModel.showCountryPickerDialog.observe(viewLifecycleOwner,</span>
                {
<span class="nc bnc" id="L197" title="All 6 branches missed.">                    if (it != null &amp;&amp; it.isNotEmpty()) {</span>
<span class="nc" id="L198">                        showCountryPicker(it)</span>
                    }
<span class="nc" id="L200">                })</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">        viewModel.showStatePickerDialog.observe(viewLifecycleOwner,</span>
                {
<span class="nc bnc" id="L204" title="All 6 branches missed.">                    if (it != null &amp;&amp; it.isNotEmpty()) {</span>
<span class="nc" id="L205">                        showStatePicker(it)</span>
                    }
<span class="nc" id="L207">                })</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">        observeFormError(viewModel)</span>

<span class="nc bnc" id="L211" title="All 2 branches missed.">        viewModel.showErrorMessage.observe(viewLifecycleOwner,</span>
                { errorMessage -&gt;
<span class="nc" id="L213">                    ToastUtils.showToast(context, errorMessage)</span>
<span class="nc" id="L214">                })</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">        viewModel.handleCompletedDomainRegistration.observe(viewLifecycleOwner,</span>
                { domainRegisteredEvent -&gt;
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    mainViewModel.completeDomainRegistration(domainRegisteredEvent)</span>
<span class="nc" id="L219">                })</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">        viewModel.showTos.observe(viewLifecycleOwner,</span>
                {
<span class="nc" id="L223">                    ActivityLauncher.openUrlExternal(</span>
<span class="nc" id="L224">                            context,</span>
<span class="nc" id="L225">                            WPUrlUtils.buildTermsOfServiceUrl(context)</span>
                    )
<span class="nc" id="L227">                })</span>
<span class="nc" id="L228">    }</span>

    private fun DomainRegistrationDetailsFragmentBinding.loadState(uiState: DomainRegistrationDetailsUiState) {
<span class="nc" id="L231">        toggleFormProgressIndictor(uiState.isFormProgressIndicatorVisible)</span>
<span class="nc" id="L232">        toggleStateProgressIndicator(uiState.isStateProgressIndicatorVisible)</span>
<span class="nc" id="L233">        toggleStateInputEnabledState(uiState.isStateInputEnabled)</span>

<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (uiState.isRegistrationProgressIndicatorVisible) {</span>
<span class="nc" id="L236">            showDomainRegistrationProgressDialog()</span>
        } else {
<span class="nc" id="L238">            hideDomainRegistrationProgressDialog()</span>
        }

<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (uiState.isPrivacyProtectionEnabled) {</span>
<span class="nc" id="L242">            domainPrivacyOptionsRadiogroup.check(R.id.domain_privacy_on_radio_button)</span>
        } else {
<span class="nc" id="L244">            domainPrivacyOptionsRadiogroup.check(R.id.domain_privacy_off_radio_button)</span>
        }

<span class="nc" id="L247">        registerDomainButton.isEnabled = uiState.isDomainRegistrationButtonEnabled</span>

        // Country and State fields treated as UI state, since we only use them for display purpose
<span class="nc bnc" id="L250" title="All 2 branches missed.">        countryInput.setText(uiState.selectedCountry?.name)</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        stateInput.setText(uiState.selectedState?.name)</span>
<span class="nc" id="L252">    }</span>

    private fun DomainRegistrationDetailsFragmentBinding.observeFormError(
        viewModel: DomainRegistrationDetailsViewModel
    ) {
<span class="nc" id="L257">        viewModel.formError.observe(viewLifecycleOwner,</span>
                { error -&gt;
<span class="nc" id="L259">                    var affectedInputFields: Array&lt;TextInputEditText&gt;? = null</span>

<span class="nc bnc" id="L261" title="All 16 branches missed.">                    when (error?.type) {</span>
<span class="nc" id="L262">                        FIRST_NAME -&gt; affectedInputFields = arrayOf(firstNameInput)</span>
<span class="nc" id="L263">                        LAST_NAME -&gt; affectedInputFields = arrayOf(lastNameInput)</span>
<span class="nc" id="L264">                        ORGANIZATION -&gt; affectedInputFields = arrayOf(organizationInput)</span>
<span class="nc" id="L265">                        ADDRESS_1 -&gt; affectedInputFields = arrayOf(addressFirstLineInput)</span>
<span class="nc" id="L266">                        ADDRESS_2 -&gt; affectedInputFields = arrayOf(addressSecondLineInput)</span>
<span class="nc" id="L267">                        POSTAL_CODE -&gt; affectedInputFields = arrayOf(postalCodeInput)</span>
<span class="nc" id="L268">                        CITY -&gt; affectedInputFields = arrayOf(cityInput)</span>
<span class="nc" id="L269">                        STATE -&gt; affectedInputFields = arrayOf(stateInput)</span>
<span class="nc" id="L270">                        COUNTRY_CODE -&gt; affectedInputFields = arrayOf(countryInput)</span>
<span class="nc" id="L271">                        EMAIL -&gt; affectedInputFields = arrayOf(emailInput)</span>
<span class="nc" id="L272">                        PHONE -&gt; affectedInputFields = arrayOf(</span>
<span class="nc" id="L273">                                countryCodeInput,</span>
<span class="nc" id="L274">                                phoneNumberInput</span>
                        )
                        else -&gt; {
                        } // Something else, will just show a Toast with an error message
                    }
<span class="nc bnc" id="L279" title="All 2 branches missed.">                    affectedInputFields?.forEach {</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">                        showFieldError(it, StringEscapeUtils.unescapeHtml4(error?.message))</span>
<span class="nc" id="L281">                    }</span>
<span class="nc bnc" id="L282" title="All 4 branches missed.">                    affectedInputFields?.firstOrNull { it.requestFocus() }</span>
<span class="nc" id="L283">                })</span>
<span class="nc" id="L284">    }</span>

    private fun DomainRegistrationDetailsFragmentBinding.populateContactForm(formModel: DomainContactFormModel) {
<span class="nc" id="L287">        firstNameInput.setText(formModel.firstName)</span>
<span class="nc" id="L288">        lastNameInput.setText(formModel.lastName)</span>
<span class="nc" id="L289">        organizationInput.setText(formModel.organization)</span>
<span class="nc" id="L290">        emailInput.setText(formModel.email)</span>
<span class="nc" id="L291">        countryCodeInput.setText(formModel.phoneNumberPrefix)</span>
<span class="nc" id="L292">        phoneNumberInput.setText(formModel.phoneNumber)</span>
<span class="nc" id="L293">        addressFirstLineInput.setText(formModel.addressLine1)</span>
<span class="nc" id="L294">        addressSecondLineInput.setText(formModel.addressLine2)</span>
<span class="nc" id="L295">        cityInput.setText(formModel.city)</span>
<span class="nc" id="L296">        postalCodeInput.setText(formModel.postalCode)</span>
<span class="nc" id="L297">    }</span>

    // local validation
    private fun DomainRegistrationDetailsFragmentBinding.validateForm(): Boolean {
<span class="nc" id="L301">        var formIsCompleted = true</span>

<span class="nc" id="L303">        val requiredFields = arrayOf(</span>
<span class="nc" id="L304">                firstNameInput,</span>
<span class="nc" id="L305">                lastNameInput,</span>
<span class="nc" id="L306">                emailInput,</span>
<span class="nc" id="L307">                countryCodeInput,</span>
<span class="nc" id="L308">                phoneNumberInput,</span>
<span class="nc" id="L309">                countryInput,</span>
<span class="nc" id="L310">                addressFirstLineInput,</span>
<span class="nc" id="L311">                cityInput,</span>
<span class="nc" id="L312">                postalCodeInput</span>
        )

<span class="nc" id="L315">        var fieldToFocusOn: TextInputEditText? = null</span>

<span class="nc" id="L317">        requiredFields.forEach {</span>
<span class="nc" id="L318">            clearEmptyFieldError(it)</span>

<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (TextUtils.isEmpty(it.text)) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                if (fieldToFocusOn == null) {</span>
<span class="nc" id="L322">                    fieldToFocusOn = it</span>
                }
<span class="nc" id="L324">                showEmptyFieldError(it)</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if (formIsCompleted) {</span>
<span class="nc" id="L326">                    formIsCompleted = false</span>
                }
            }
<span class="nc" id="L329">        }</span>

        // focusing on first empty field
<span class="nc bnc" id="L332" title="All 2 branches missed.">        fieldToFocusOn?.requestFocus()</span>

<span class="nc" id="L334">        return formIsCompleted</span>
    }

    private fun showEmptyFieldError(editText: EditText) {
<span class="nc" id="L338">        val parent = editText.parent.parent</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (parent is TextInputLayout) {</span>
<span class="nc" id="L340">            showFieldError(</span>
<span class="nc" id="L341">                    editText,</span>
<span class="nc" id="L342">                    getString(R.string.domain_registration_contact_form_input_error, parent.hint)</span>
            )
        }
<span class="nc" id="L345">    }</span>

    private fun clearEmptyFieldError(editText: EditText) {
<span class="nc" id="L348">        val parent = editText.parent.parent</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (parent is TextInputLayout) {</span>
<span class="nc" id="L350">            showFieldError(editText, null)</span>
        }
<span class="nc" id="L352">    }</span>

    private fun showFieldError(editText: EditText, errorMessage: String?) {
<span class="nc" id="L355">        editText.error = errorMessage</span>
<span class="nc" id="L356">    }</span>

<span class="nc" id="L358">    private fun getDomainContactFormModel(): DomainContactFormModel = with(binding!!) {</span>
<span class="nc" id="L359">        return DomainContactFormModel(</span>
<span class="nc" id="L360">                firstNameInput.text.toString(),</span>
<span class="nc" id="L361">                lastNameInput.text.toString(),</span>
<span class="nc" id="L362">                StringUtils.notNullStr(organizationInput.text.toString()),</span>
<span class="nc" id="L363">                addressFirstLineInput.text.toString(),</span>
<span class="nc" id="L364">                addressSecondLineInput.text.toString(),</span>
<span class="nc" id="L365">                postalCodeInput.text.toString(),</span>
<span class="nc" id="L366">                cityInput.text.toString(),</span>
<span class="nc" id="L367">                null, // state code will be added in ViewModel</span>
<span class="nc" id="L368">                null, // country code will be added in ViewModel</span>
<span class="nc" id="L369">                emailInput.text.toString(),</span>
<span class="nc" id="L370">                countryCodeInput.text.toString(),</span>
<span class="nc" id="L371">                phoneNumberInput.text.toString()</span>
        )
    }

    private fun showStatePicker(states: List&lt;SupportedStateResponse&gt;) {
<span class="nc" id="L376">        val dialogFragment = StatePickerDialogFragment.newInstance(states.toCollection(ArrayList()))</span>
<span class="nc" id="L377">        dialogFragment.setTargetFragment(this, 0)</span>
<span class="nc" id="L378">        dialogFragment.show(requireFragmentManager(), StatePickerDialogFragment.TAG)</span>
<span class="nc" id="L379">    }</span>

    private fun showCountryPicker(countries: List&lt;SupportedDomainCountry&gt;) {
<span class="nc" id="L382">        val dialogFragment = CountryPickerDialogFragment.newInstance(</span>
<span class="nc" id="L383">                countries.toCollection(</span>
<span class="nc" id="L384">                        ArrayList()</span>
                )
        )
<span class="nc" id="L387">        dialogFragment.setTargetFragment(this, 0)</span>
<span class="nc" id="L388">        dialogFragment.show(requireFragmentManager(), CountryPickerDialogFragment.TAG)</span>
<span class="nc" id="L389">    }</span>

    private fun DomainRegistrationDetailsFragmentBinding.toggleFormProgressIndictor(visible: Boolean) {
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (visible) {</span>
<span class="nc" id="L393">            formProgressIndicator.visibility = View.VISIBLE</span>
        } else {
<span class="nc" id="L395">            formProgressIndicator.visibility = View.GONE</span>
        }
<span class="nc" id="L397">    }</span>

    private fun DomainRegistrationDetailsFragmentBinding.toggleStateProgressIndicator(visible: Boolean) {
<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (visible) {</span>
<span class="nc" id="L401">            statesLoadingProgressIndicator.visibility = View.VISIBLE</span>
        } else {
<span class="nc" id="L403">            statesLoadingProgressIndicator.visibility = View.GONE</span>
        }

<span class="nc bnc" id="L406" title="All 2 branches missed.">        stateInputContainer.isEnabled = !visible</span>
<span class="nc" id="L407">    }</span>

    private fun DomainRegistrationDetailsFragmentBinding.toggleStateInputEnabledState(enabled: Boolean) {
<span class="nc" id="L410">        stateInputContainer.isEnabled = enabled</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">        if (enabled) {</span>
<span class="nc" id="L412">            stateInputContainer.hint = getString(R.string.domain_contact_information_state_hint)</span>
        } else {
<span class="nc" id="L414">            stateInputContainer.hint = getString(R.string.domain_contact_information_state_not_available_hint)</span>
        }
<span class="nc" id="L416">    }</span>

    private fun showDomainRegistrationProgressDialog() {
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (loadingProgressDialog == null) {</span>
<span class="nc" id="L420">            loadingProgressDialog = ProgressDialog(context)</span>
<span class="nc" id="L421">            loadingProgressDialog!!.isIndeterminate = true</span>
<span class="nc" id="L422">            loadingProgressDialog!!.setCancelable(false)</span>

<span class="nc" id="L424">            loadingProgressDialog!!</span>
<span class="nc" id="L425">                    .setMessage(getString(R.string.domain_registration_registering_domain_name_progress_dialog_message))</span>
        }
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (!loadingProgressDialog!!.isShowing) {</span>
<span class="nc" id="L428">            loadingProgressDialog!!.show()</span>
        }
<span class="nc" id="L430">    }</span>

    private fun hideDomainRegistrationProgressDialog() {
<span class="nc bnc" id="L433" title="All 4 branches missed.">        if (loadingProgressDialog != null &amp;&amp; loadingProgressDialog!!.isShowing) {</span>
<span class="nc" id="L434">            loadingProgressDialog!!.cancel()</span>
        }
<span class="nc" id="L436">    }</span>

<span class="nc" id="L438">    class StatePickerDialogFragment : DialogFragment() {</span>
        private lateinit var states: ArrayList&lt;SupportedStateResponse&gt;
<span class="nc bnc" id="L440" title="All 2 branches missed.">        @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
        private lateinit var viewModel: DomainRegistrationDetailsViewModel

        companion object {
            private const val EXTRA_STATES = &quot;EXTRA_STATES&quot;
            const val TAG = &quot;STATE_PICKER_DIALOG_FRAGMENT&quot;

            fun newInstance(states: ArrayList&lt;SupportedStateResponse&gt;): StatePickerDialogFragment {
<span class="nc" id="L448">                val fragment = StatePickerDialogFragment()</span>
<span class="nc" id="L449">                val bundle = Bundle()</span>
<span class="nc" id="L450">                bundle.putParcelableArrayList(EXTRA_STATES, states)</span>
<span class="nc" id="L451">                fragment.arguments = bundle</span>
<span class="nc" id="L452">                return fragment</span>
            }
        }

        override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L457">            super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">            states = requireArguments().getParcelableArrayList&lt;SupportedStateResponse&gt;(EXTRA_STATES)</span>
                    as ArrayList&lt;SupportedStateResponse&gt;
<span class="nc" id="L460">        }</span>

        override fun onCreateDialog(savedInstanceState: Bundle?): Dialog {
<span class="nc bnc" id="L463" title="All 2 branches missed.">            if (targetFragment == null) {</span>
<span class="nc" id="L464">                throw IllegalStateException(&quot;StatePickerDialogFragment is missing a targetFragment &quot;)</span>
            }

<span class="nc" id="L467">            viewModel = ViewModelProvider(targetFragment!!, viewModelFactory)</span>
<span class="nc" id="L468">                    .get(DomainRegistrationDetailsViewModel::class.java)</span>
<span class="nc" id="L469">            val builder = MaterialAlertDialogBuilder(requireContext())</span>
<span class="nc" id="L470">            builder.setTitle(R.string.domain_registration_state_picker_dialog_title)</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">            builder.setItems(states.map { it.name }.toTypedArray()) { _, which -&gt;</span>
<span class="nc bnc" id="L472" title="All 4 branches missed.">                viewModel.onStateSelected(states[which])</span>
<span class="nc" id="L473">            }</span>

<span class="nc" id="L475">            builder.setPositiveButton(R.string.dialog_button_cancel) { dialog, _ -&gt;</span>
<span class="nc" id="L476">                dialog.dismiss()</span>
<span class="nc" id="L477">            }</span>

<span class="nc" id="L479">            return builder.create()</span>
        }

        override fun onAttach(context: Context) {
<span class="nc" id="L483">            super.onAttach(context)</span>
<span class="nc" id="L484">            AndroidSupportInjection.inject(this)</span>
<span class="nc" id="L485">        }</span>
    }

<span class="nc" id="L488">    class CountryPickerDialogFragment : DialogFragment() {</span>
        private lateinit var countries: ArrayList&lt;SupportedDomainCountry&gt;
<span class="nc bnc" id="L490" title="All 2 branches missed.">        @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
        private lateinit var viewModel: DomainRegistrationDetailsViewModel

        companion object {
            private const val EXTRA_COUNTRIES = &quot;EXTRA_COUNTRIES&quot;
            const val TAG = &quot;COUNTRY_PICKER_DIALOG_FRAGMENT&quot;

            fun newInstance(countries: ArrayList&lt;SupportedDomainCountry&gt;): CountryPickerDialogFragment {
<span class="nc" id="L498">                val fragment = CountryPickerDialogFragment()</span>
<span class="nc" id="L499">                val bundle = Bundle()</span>
<span class="nc" id="L500">                bundle.putParcelableArrayList(EXTRA_COUNTRIES, countries)</span>
<span class="nc" id="L501">                fragment.arguments = bundle</span>
<span class="nc" id="L502">                return fragment</span>
            }
        }

        override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L507">            super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L508" title="All 4 branches missed.">            countries = arguments?.getParcelableArrayList&lt;SupportedDomainCountry&gt;(EXTRA_COUNTRIES)</span>
                    as ArrayList&lt;SupportedDomainCountry&gt;
<span class="nc" id="L510">        }</span>

        override fun onCreateDialog(savedInstanceState: Bundle?): Dialog {
<span class="nc bnc" id="L513" title="All 2 branches missed.">            if (targetFragment == null) {</span>
<span class="nc" id="L514">                throw IllegalStateException(&quot;CountryPickerDialogFragment is missing a targetFragment &quot;)</span>
            }

<span class="nc" id="L517">            viewModel = ViewModelProvider(targetFragment!!, viewModelFactory)</span>
<span class="nc" id="L518">                    .get(DomainRegistrationDetailsViewModel::class.java)</span>
<span class="nc" id="L519">            val builder = MaterialAlertDialogBuilder(requireContext())</span>
<span class="nc" id="L520">            builder.setTitle(R.string.domain_registration_country_picker_dialog_title)</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">            builder.setItems(countries.map { it.name }.toTypedArray()) { _, which -&gt;</span>
<span class="nc bnc" id="L522" title="All 4 branches missed.">                viewModel.onCountrySelected(countries[which])</span>
<span class="nc" id="L523">            }</span>

<span class="nc" id="L525">            builder.setPositiveButton(R.string.dialog_button_cancel) { dialog, _ -&gt;</span>
<span class="nc" id="L526">                dialog.dismiss()</span>
<span class="nc" id="L527">            }</span>

<span class="nc" id="L529">            return builder.create()</span>
        }

        override fun onAttach(context: Context) {
<span class="nc" id="L533">            super.onAttach(context)</span>
<span class="nc" id="L534">            AndroidSupportInjection.inject(this)</span>
<span class="nc" id="L535">        }</span>
    }

    override fun onResume() {
<span class="nc" id="L539">        super.onResume()</span>
<span class="nc bnc" id="L540" title="All 4 branches missed.">        (activity as? ScrollableViewInitializedListener)?.onScrollableViewInitialized(</span>
<span class="nc" id="L541">                R.id.domain_registration_details_container</span>
        )
<span class="nc" id="L543">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>