<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SiteSettingsTimezoneViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs.timezone</a> &gt; <span class="el_source">SiteSettingsTimezoneViewModel.kt</span></div><h1>SiteSettingsTimezoneViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs.timezone

import android.content.Context
import android.text.TextUtils
import androidx.annotation.VisibleForTesting
import androidx.lifecycle.LiveData
import androidx.lifecycle.MediatorLiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.Transformations
import androidx.lifecycle.ViewModel
import androidx.lifecycle.distinctUntilChanged
import com.android.volley.Response
import com.android.volley.VolleyError
import com.android.volley.toolbox.StringRequest
import com.android.volley.toolbox.Volley
import org.json.JSONArray
import org.json.JSONException
import org.json.JSONObject
import org.wordpress.android.Constants
import org.wordpress.android.R
import org.wordpress.android.networking.RestClientUtils
import org.wordpress.android.ui.prefs.timezone.TimezonesList.TimezoneHeader
import org.wordpress.android.ui.prefs.timezone.TimezonesList.TimezoneItem
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T.SETTINGS
import org.wordpress.android.viewmodel.ResourceProvider
import org.wordpress.android.viewmodel.SingleLiveEvent
import java.text.SimpleDateFormat
import java.util.Calendar
import java.util.Locale
import java.util.TimeZone
import javax.inject.Inject

<span class="nc" id="L34">class SiteSettingsTimezoneViewModel @Inject constructor(</span>
<span class="nc" id="L35">    private val resourceProvider: ResourceProvider</span>
<span class="nc" id="L36">) : ViewModel() {</span>
<span class="nc" id="L37">    private val timezonesList = mutableListOf&lt;TimezonesList&gt;()</span>

<span class="nc" id="L39">    private val _showEmptyView = SingleLiveEvent&lt;Boolean&gt;()</span>
<span class="nc" id="L40">    val showEmptyView: LiveData&lt;Boolean&gt; = _showEmptyView</span>

<span class="nc" id="L42">    private val _showProgressView = SingleLiveEvent&lt;Boolean&gt;()</span>
<span class="nc" id="L43">    val showProgressView: LiveData&lt;Boolean&gt; = _showProgressView</span>

<span class="nc" id="L45">    private val _dismissWithError = SingleLiveEvent&lt;Unit&gt;()</span>
<span class="nc" id="L46">    val dismissWithError: LiveData&lt;Unit&gt; = _dismissWithError</span>

<span class="nc" id="L48">    private val _dismissBottomSheet = SingleLiveEvent&lt;Unit&gt;()</span>
<span class="nc" id="L49">    val dismissBottomSheet: LiveData&lt;Unit&gt; = _dismissBottomSheet</span>

<span class="nc" id="L51">    private val _suggestedTimezone = MutableLiveData&lt;String&gt;()</span>
<span class="nc" id="L52">    val suggestedTimezone = _suggestedTimezone</span>

<span class="nc" id="L54">    private val _selectedTimezone = SingleLiveEvent&lt;String&gt;()</span>
<span class="nc" id="L55">    val selectedTimezone = _selectedTimezone</span>

<span class="nc" id="L57">    private val _timezones = MutableLiveData&lt;List&lt;TimezonesList&gt;&gt;()</span>

<span class="nc" id="L59">    private val searchInput = MutableLiveData&lt;String&gt;()</span>
<span class="nc" id="L60">    private val timezoneSearch: LiveData&lt;List&lt;TimezonesList&gt;&gt; = Transformations.switchMap(searchInput) { term -&gt;</span>
<span class="nc" id="L61">        filterTimezones(term)</span>
    }

<span class="nc" id="L64">    val timezones = MediatorLiveData&lt;List&lt;TimezonesList&gt;&gt;().apply {</span>
<span class="nc" id="L65">        addSource(_timezones) {</span>
<span class="nc" id="L66">            value = it</span>
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">        addSource(timezoneSearch) {</span>
<span class="nc" id="L69">            value = it</span>
<span class="nc" id="L70">        }</span>
<span class="nc" id="L71">    }.distinctUntilChanged()</span>

    fun searchTimezones(query: CharSequence) {
<span class="nc" id="L74">        searchInput.value = query.toString()</span>
<span class="nc" id="L75">    }</span>

    fun onTimezoneSelected(timezone: String) {
<span class="nc" id="L78">        _selectedTimezone.value = timezone</span>
<span class="nc" id="L79">        _dismissBottomSheet.asyncCall()</span>
<span class="nc" id="L80">    }</span>

    @VisibleForTesting
    fun filterTimezones(query: String): LiveData&lt;List&lt;TimezonesList&gt;&gt; {
<span class="nc" id="L84">        val filteredTimezones = MutableLiveData&lt;List&lt;TimezonesList&gt;&gt;()</span>

<span class="nc" id="L86">        timezonesList.filter { timezone -&gt;</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            when (timezone) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                is TimezoneItem -&gt; {</span>
<span class="nc" id="L89">                    timezone.label.contains(query, true) or timezone.offset.contains(query, true)</span>
                }
<span class="nc" id="L91">                else -&gt; false</span>
            }
<span class="nc" id="L93">        }.also {</span>
<span class="nc" id="L94">            _showEmptyView.value = it.isEmpty()</span>
<span class="nc" id="L95">            filteredTimezones.value = it</span>
<span class="nc" id="L96">        }</span>

<span class="nc" id="L98">        return filteredTimezones</span>
    }

    fun onSearchCancelled() {
<span class="nc" id="L102">        _showEmptyView.value = false</span>
<span class="nc" id="L103">        _timezones.postValue(timezonesList)</span>
<span class="nc" id="L104">    }</span>

    fun getTimezones(context: Context) {
<span class="nc" id="L107">        _suggestedTimezone.postValue(TimeZone.getDefault().id)</span>

<span class="nc" id="L109">        requestTimezones(context)</span>
<span class="nc" id="L110">    }</span>

    private fun requestTimezones(context: Context) {
<span class="nc" id="L113">        val listener = Response.Listener { response: String? -&gt;</span>
<span class="nc" id="L114">            AppLog.d(SETTINGS, &quot;timezones requested&quot;)</span>
<span class="nc" id="L115">            _showProgressView.postValue(false)</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">            if (!TextUtils.isEmpty(response)) {</span>
<span class="nc" id="L118">                timezonesList.clear()</span>
<span class="nc" id="L119">                loadTimezones(response)</span>
            } else {
<span class="nc" id="L121">                AppLog.w(SETTINGS, &quot;empty response requesting timezones&quot;)</span>
<span class="nc" id="L122">                _dismissWithError.call()</span>
            }
<span class="nc" id="L124">        }</span>

<span class="nc" id="L126">        val errorListener = Response.ErrorListener { error: VolleyError? -&gt;</span>
<span class="nc" id="L127">            AppLog.e(SETTINGS, &quot;Error requesting timezones&quot;, error)</span>
<span class="nc" id="L128">            _dismissWithError.call()</span>
<span class="nc" id="L129">        }</span>

<span class="nc" id="L131">        val request: StringRequest = object : StringRequest(Constants.URL_TIMEZONE_ENDPOINT, listener, errorListener) {</span>
            override fun getParams(): Map&lt;String, String&gt; {
<span class="nc" id="L133">                return RestClientUtils.getRestLocaleParams(context)</span>
            }
        }

<span class="nc" id="L137">        _showProgressView.postValue(true)</span>
<span class="nc" id="L138">        val queue = Volley.newRequestQueue(context)</span>
<span class="nc" id="L139">        queue.add(request)</span>
<span class="nc" id="L140">    }</span>

    private fun loadTimezones(responseJson: String?) {
<span class="nc" id="L143">        try {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            val jsonResponse = JSONObject(responseJson.orEmpty())</span>
<span class="nc" id="L145">            val jsonTimezonesByContinent = jsonResponse.getJSONObject(&quot;timezones_by_continent&quot;)</span>
<span class="nc" id="L146">            val jsonTimezonesManualOffsets = jsonResponse.getJSONArray(&quot;manual_utc_offsets&quot;)</span>

<span class="nc" id="L148">            jsonTimezonesByContinent.keys().forEach {</span>
<span class="nc" id="L149">                timezonesList.add(TimezoneHeader(it))</span>
<span class="nc" id="L150">                addTimezoneItems(jsonTimezonesByContinent.getJSONArray(it))</span>
<span class="nc" id="L151">            }</span>

<span class="nc" id="L153">            timezonesList.add(TimezoneHeader(</span>
<span class="nc" id="L154">                    resourceProvider.getString(R.string.site_settings_timezones_manual_offsets)</span>
            ))
<span class="nc bnc" id="L156" title="All 2 branches missed.">            for (i in 0 until jsonTimezonesManualOffsets.length()) {</span>
<span class="nc" id="L157">                val timezone = jsonTimezonesManualOffsets.getJSONObject(i)</span>
<span class="nc" id="L158">                timezonesList.add(TimezoneItem(timezone.getString(&quot;label&quot;), timezone.getString(&quot;value&quot;)))</span>
            }

<span class="nc" id="L161">            AppLog.d(SETTINGS, timezonesList.toString())</span>
<span class="nc" id="L162">            _timezones.postValue(timezonesList)</span>
<span class="nc" id="L163">        } catch (e: JSONException) {</span>
<span class="nc" id="L164">            AppLog.e(SETTINGS, &quot;Error parsing timezones&quot;, e)</span>
<span class="nc" id="L165">            _dismissWithError.call()</span>
        }
<span class="nc" id="L167">    }</span>

    private fun addTimezoneItems(jsonTimezones: JSONArray) {
<span class="nc bnc" id="L170" title="All 2 branches missed.">        for (i in 0 until jsonTimezones.length()) {</span>
<span class="nc" id="L171">            val timezone = jsonTimezones.getJSONObject(i)</span>
<span class="nc" id="L172">            val city = timezone.getString(&quot;label&quot;)</span>
<span class="nc" id="L173">            val zone = timezone.getString(&quot;value&quot;)</span>
<span class="nc" id="L174">            val zoneOffset = getZoneOffset(zone)</span>
<span class="nc" id="L175">            val zoneTime = getTimeAtZone(zone)</span>
<span class="nc" id="L176">            timezonesList.add(TimezoneItem(city, zone, zoneOffset, zoneTime))</span>
        }
<span class="nc" id="L178">    }</span>

    private fun getZoneOffset(zone: String): String {
<span class="nc" id="L181">        val timezone = TimeZone.getTimeZone(zone)</span>

<span class="nc" id="L183">        val cal = Calendar.getInstance(timezone)</span>
<span class="nc" id="L184">        val sdf = SimpleDateFormat(&quot;z&quot;, Locale.getDefault())</span>
<span class="nc" id="L185">        sdf.timeZone = timezone</span>
<span class="nc" id="L186">        val offset = sdf.format(cal.time)</span>

<span class="nc" id="L188">        return &quot;${timezone.displayName} ($offset)&quot;</span>
    }

    private fun getTimeAtZone(zone: String): String {
<span class="nc" id="L192">        val timezone = TimeZone.getTimeZone(zone)</span>

<span class="nc" id="L194">        val cal = Calendar.getInstance(timezone)</span>
<span class="nc" id="L195">        val sdf = SimpleDateFormat(&quot;h:mm a&quot;, Locale.getDefault())</span>
<span class="nc" id="L196">        sdf.timeZone = timezone</span>

<span class="nc" id="L198">        return sdf.format(cal.time)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>