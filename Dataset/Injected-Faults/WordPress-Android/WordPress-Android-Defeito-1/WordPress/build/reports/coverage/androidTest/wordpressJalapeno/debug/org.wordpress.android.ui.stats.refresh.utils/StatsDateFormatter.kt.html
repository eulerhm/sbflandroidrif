<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatsDateFormatter.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stats.refresh.utils</a> &gt; <span class="el_source">StatsDateFormatter.kt</span></div><h1>StatsDateFormatter.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stats.refresh.utils

import org.apache.commons.text.WordUtils
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.network.utils.StatsGranularity
import org.wordpress.android.fluxc.network.utils.StatsGranularity.DAYS
import org.wordpress.android.fluxc.network.utils.StatsGranularity.MONTHS
import org.wordpress.android.fluxc.network.utils.StatsGranularity.WEEKS
import org.wordpress.android.fluxc.network.utils.StatsGranularity.YEARS
import org.wordpress.android.fluxc.utils.SiteUtils
import org.wordpress.android.util.LocaleManagerWrapper
import org.wordpress.android.viewmodel.ResourceProvider
import java.text.DateFormat
import java.text.ParseException
import java.text.SimpleDateFormat
import java.util.Calendar
import java.util.Date
import java.util.Locale
import java.util.concurrent.TimeUnit.MILLISECONDS
import javax.inject.Inject
import kotlin.math.abs

private const val STATS_INPUT_FORMAT = &quot;yyyy-MM-dd&quot;
private const val MONTH_FORMAT = &quot;MMM, yyyy&quot;
private const val YEAR_FORMAT = &quot;yyyy&quot;
@Suppress(&quot;CheckStyle&quot;)
private const val REMOVE_YEAR = &quot;([^\\p{Alpha}']|('[\\p{Alpha}]+'))*y+([^\\p{Alpha}']|('[\\p{Alpha}]+'))*&quot;

<span class="nc" id="L30">class StatsDateFormatter</span>
<span class="nc" id="L31">@Inject constructor(private val localeManagerWrapper: LocaleManagerWrapper, val resourceProvider: ResourceProvider) {</span>
    private val inputFormat: SimpleDateFormat
        get() {
<span class="nc" id="L34">            return SimpleDateFormat(STATS_INPUT_FORMAT, localeManagerWrapper.getLocale())</span>
        }
    private val outputMonthFormat: SimpleDateFormat
        get() {
<span class="nc" id="L38">            return SimpleDateFormat(MONTH_FORMAT, localeManagerWrapper.getLocale())</span>
        }
    private val outputYearFormat: SimpleDateFormat
        get() {
<span class="nc" id="L42">            return SimpleDateFormat(YEAR_FORMAT, localeManagerWrapper.getLocale())</span>
        }
    private val outputFormat: DateFormat
        get() {
<span class="nc" id="L46">            return DateFormat.getDateInstance(DateFormat.MEDIUM, localeManagerWrapper.getLocale())</span>
        }
    private val outputFormatWithoutYear: SimpleDateFormat
        get() {
<span class="nc" id="L50">            val sdf = outputFormat as SimpleDateFormat</span>
<span class="nc" id="L51">            sdf.applyPattern(sdf.toPattern().replace(REMOVE_YEAR.toRegex(), &quot;&quot;))</span>
<span class="nc" id="L52">            return sdf</span>
        }

    /**
     * Parses the stats date and prints it in localizes readable format.
     * @param period in this format yyyy-MM-dd
     * @return localized date in the medium format, in English - Jan 5, 2019
     */
    fun printDate(period: String): String {
<span class="nc" id="L61">        return printDate(inputFormat.parse(period))</span>
    }

    /**
     * Prints a date in the stats format - yyyy-MM-dd
     * @param date
     * @return date in stats string format
     */
    fun printStatsDate(date: Date): String {
<span class="nc" id="L70">        return inputFormat.format(date)</span>
    }

    private fun printDate(date: Date): String {
<span class="nc" id="L74">        try {</span>
<span class="nc" id="L75">            return outputFormat.format(date)</span>
<span class="nc" id="L76">        } catch (e: ParseException) {</span>
<span class="nc" id="L77">            throw RuntimeException(&quot;Unexpected date format&quot;)</span>
        }
    }

    /**
     * Prints the given date in a localized format according to the StatsGranularity:
     * DAYS - returns Jan 1, 2019
     * WEEKS - returns Jan 1 - Jan 8
     * MONTHS - returns Jan 2019
     * YEARS - returns 2019
     * @param date to be printed
     * @param granularity defines the output format
     * @return printed date
     */
    fun printGranularDate(date: Date, granularity: StatsGranularity): String {
<span class="nc bnc" id="L92" title="All 4 branches missed.">        return when (granularity) {</span>
<span class="nc" id="L93">            DAYS -&gt; outputFormat.format(date)</span>
            WEEKS -&gt; {
<span class="nc" id="L95">                val endCalendar = Calendar.getInstance()</span>
<span class="nc" id="L96">                endCalendar.time = date</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                if (endCalendar.get(Calendar.DAY_OF_WEEK) != Calendar.SUNDAY) {</span>
<span class="nc" id="L98">                    endCalendar.time = dateToWeekDate(date)</span>
                }
<span class="nc" id="L100">                val startCalendar = Calendar.getInstance()</span>
<span class="nc" id="L101">                startCalendar.time = endCalendar.time</span>
<span class="nc" id="L102">                startCalendar.add(Calendar.DAY_OF_WEEK, -6)</span>
<span class="nc" id="L103">                return printWeek(startCalendar, endCalendar)</span>
            }
<span class="nc" id="L105">            MONTHS -&gt; WordUtils.capitalize(outputMonthFormat.format(date))</span>
<span class="nc" id="L106">            YEARS -&gt; outputYearFormat.format(date)</span>
        }
    }

    /**
     * Prints a date in the Medium format but strips the year. For example prints only Jan 1 instead of Jan 1, 2019
     * @param date
     * @return printed date
     */
    fun printDayWithoutYear(date: Date): String {
<span class="nc" id="L116">        return outputFormatWithoutYear.format(date)</span>
    }

    /**
     * Prints a week with a start and end date in the week format - Jan 1 - Jan 8, 2019.
     * It also adds both years when the week is overlapping - Dec 31, 2018 - Jan 7, 2019
     * @param startPeriod First day of the week
     * @param endPeriod Last day of the week
     * @return printed week
     */
    fun printWeek(startPeriod: Date, endPeriod: Date): String {
<span class="nc" id="L127">        val startCalendar = Calendar.getInstance()</span>
<span class="nc" id="L128">        startCalendar.time = startPeriod</span>
<span class="nc" id="L129">        val endCalendar = Calendar.getInstance()</span>
<span class="nc" id="L130">        endCalendar.time = endPeriod</span>
<span class="nc" id="L131">        return printWeek(startCalendar, endCalendar, showSecondYear = true)</span>
    }

<span class="nc" id="L134">    private fun printWeek(startCalendar: Calendar, endCalendar: Calendar, showSecondYear: Boolean = false): String {</span>
        // Always show both years when the first and the last day of a week are in different years
<span class="nc bnc" id="L136" title="All 2 branches missed.">        return if (startCalendar.get(Calendar.YEAR) != endCalendar.get(Calendar.YEAR)) {</span>
<span class="nc" id="L137">            printWeek(startCalendar, endCalendar, showFirstYear = true, showSecondYear = true)</span>
        } else {
<span class="nc" id="L139">            printWeek(startCalendar, endCalendar, showFirstYear = false, showSecondYear = showSecondYear)</span>
        }
    }

    private fun printWeek(
        startCalendar: Calendar,
        endCalendar: Calendar,
        showFirstYear: Boolean,
        showSecondYear: Boolean
    ): String {
<span class="nc" id="L149">        return resourceProvider.getString(</span>
<span class="nc" id="L150">                R.string.stats_from_to_dates_in_week_label,</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                if (showFirstYear) outputFormat.format(startCalendar.time) else outputFormatWithoutYear.format(</span>
<span class="nc" id="L152">                        startCalendar.time</span>
                ),
<span class="nc bnc" id="L154" title="All 2 branches missed.">                if (showSecondYear) outputFormat.format(endCalendar.time) else outputFormatWithoutYear.format(</span>
<span class="nc" id="L155">                        endCalendar.time</span>
                )
        )
    }

    /**
     * Parses the date coming from an endpoint and print the granular result.
     */
    fun printGranularDate(date: String, granularity: StatsGranularity): String {
<span class="nc" id="L164">        val parsedDate = parseStatsDate(granularity, date)</span>
<span class="nc" id="L165">        return printGranularDate(parsedDate, granularity)</span>
    }

    /**
     * Parses date coming from the endpoint in format specific for the stats granularity
     * DAYS -&gt; the input format is yyyy-MM-dd, output is the selected date
     * WEEKS -&gt; the input format is yyyy'W'MM'W'dd, output is the last day of the week
     * MONTHS -&gt; the input format is yyyy-MM, output is the last day of the month
     * YEARS -&gt; the input format is yyyy-MM-dd, output is the last day of the year
     * @param granularity selected granularity
     * @param date string date coming from the endpoints
     * @return parsed Date
     */
    fun parseStatsDate(
        granularity: StatsGranularity,
        date: String
    ): Date {
<span class="nc bnc" id="L182" title="All 4 branches missed.">        return when (granularity) {</span>
<span class="nc" id="L183">            DAYS -&gt; inputFormat.parse(date)</span>
            WEEKS -&gt; {
                // first four digits are the year
                // followed by Wxx where xx is the month
                // followed by Wxx where xx is the day of the month
                // ex: 2013W07W22 = July 22, 2013
<span class="nc" id="L189">                val sdf = SimpleDateFormat(&quot;yyyy'W'MM'W'dd&quot;, Locale.ROOT)</span>
                // Calculate the end of the week
<span class="nc" id="L191">                val parsedDate = sdf.parse(date)</span>
<span class="nc" id="L192">                dateToWeekDate(parsedDate)</span>
            }
<span class="nc" id="L194">            MONTHS -&gt; {</span>
<span class="nc" id="L195">                val sdf = SimpleDateFormat(&quot;yyyy-MM&quot;, Locale.ROOT)</span>
                // Calculate the end of the month
<span class="nc" id="L197">                val parsedDate = sdf.parse(date)</span>
<span class="nc" id="L198">                val calendar: Calendar = Calendar.getInstance()</span>
<span class="nc" id="L199">                calendar.time = parsedDate</span>
                // last day of this month
<span class="nc" id="L201">                calendar.set(Calendar.DAY_OF_MONTH, calendar.getActualMaximum(Calendar.DAY_OF_MONTH))</span>
<span class="nc" id="L202">                calendar.set(Calendar.HOUR_OF_DAY, calendar.getActualMaximum(Calendar.HOUR_OF_DAY))</span>
<span class="nc" id="L203">                calendar.set(Calendar.MINUTE, calendar.getActualMaximum(Calendar.MINUTE))</span>
<span class="nc" id="L204">                calendar.time</span>
            }
<span class="nc" id="L206">            YEARS -&gt; {</span>
<span class="nc" id="L207">                val sdf = SimpleDateFormat(STATS_INPUT_FORMAT, Locale.ROOT)</span>
                // Calculate the end of the week
<span class="nc" id="L209">                val parsedDate = sdf.parse(date)</span>
<span class="nc" id="L210">                val calendar: Calendar = Calendar.getInstance()</span>
<span class="nc" id="L211">                calendar.time = parsedDate</span>
<span class="nc" id="L212">                calendar.set(Calendar.MONTH, Calendar.DECEMBER)</span>
<span class="nc" id="L213">                calendar.set(Calendar.DAY_OF_MONTH, 31)</span>
<span class="nc" id="L214">                calendar.time</span>
            }
        }
    }

    private fun dateToWeekDate(parsedDate: Date): Date {
<span class="nc" id="L220">        val calendar: Calendar = Calendar.getInstance()</span>
<span class="nc" id="L221">        calendar.time = parsedDate</span>
        // first day of this week
<span class="nc" id="L223">        calendar.set(Calendar.DAY_OF_WEEK, Calendar.MONDAY)</span>
        // last day of this week
<span class="nc" id="L225">        calendar.add(Calendar.DAY_OF_WEEK, +6)</span>
<span class="nc" id="L226">        calendar.set(Calendar.HOUR_OF_DAY, calendar.getActualMaximum(Calendar.HOUR_OF_DAY))</span>
<span class="nc" id="L227">        calendar.set(Calendar.MINUTE, calendar.getActualMaximum(Calendar.MINUTE))</span>
<span class="nc" id="L228">        return calendar.time</span>
    }

    fun printTimeZone(site: SiteModel): String? {
<span class="nc" id="L232">        val siteTimeZone = SiteUtils.getNormalizedTimezone(site.timezone)</span>
<span class="nc" id="L233">        val currentTimeZone = localeManagerWrapper.getTimeZone()</span>
<span class="nc" id="L234">        val currentDate = Calendar.getInstance(localeManagerWrapper.getLocale())</span>
<span class="nc" id="L235">        val siteOffset = siteTimeZone.getOffset(currentDate.timeInMillis)</span>
<span class="nc" id="L236">        val currentTimeZoneOffset = currentTimeZone.getOffset(currentDate.timeInMillis)</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        return if (siteOffset != currentTimeZoneOffset) {</span>
<span class="nc" id="L238">            val hourOffset = MILLISECONDS.toHours(siteOffset.toLong())</span>
<span class="nc" id="L239">            val minuteOffset = MILLISECONDS.toMinutes(siteOffset.toLong())</span>
<span class="nc" id="L240">            val timeZoneResource = when {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                minuteOffset &gt; 0L -&gt; R.string.stats_site_positive_utc</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                minuteOffset &lt; 0L -&gt; R.string.stats_site_negative_utc</span>
<span class="nc" id="L243">                else -&gt; R.string.stats_site_neutral_utc</span>
            }
<span class="nc" id="L245">            val minuteRemain = minuteOffset % 60</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            val utcTime = if (minuteRemain == 0L) {</span>
<span class="nc" id="L247">                &quot;${abs(hourOffset)}&quot;</span>
            } else {
<span class="nc" id="L249">                &quot;${abs(hourOffset)}:${abs(minuteRemain)}&quot;</span>
            }
<span class="nc" id="L251">            resourceProvider.getString(</span>
<span class="nc" id="L252">                    timeZoneResource,</span>
<span class="nc" id="L253">                    utcTime</span>
            )
<span class="nc" id="L255">        } else null</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>