<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EditorPhotoPicker.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts.editor</a> &gt; <span class="el_source">EditorPhotoPicker.kt</span></div><h1>EditorPhotoPicker.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts.editor

import android.content.res.Configuration
import android.view.View
import android.view.ViewGroup
import androidx.appcompat.app.AppCompatActivity
import androidx.recyclerview.widget.RecyclerView.Orientation
import org.wordpress.android.R
import org.wordpress.android.editor.MediaToolbarAction
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.ui.media.MediaBrowserType
import org.wordpress.android.ui.photopicker.PhotoPickerFragment
import org.wordpress.android.ui.photopicker.PhotoPickerFragment.PhotoPickerIcon
import org.wordpress.android.ui.photopicker.PhotoPickerFragment.PhotoPickerListener
import org.wordpress.android.util.ActivityUtils
import org.wordpress.android.util.AniUtils
import org.wordpress.android.util.DisplayUtils

private const val PHOTO_PICKER_TAG = &quot;photo_picker&quot;

interface EditorPhotoPickerListener {
    fun onPhotoPickerShown()
    fun onPhotoPickerHidden()
}

/**
 * This class is extracted from EditPostActivity as part of a huge refactor. Although some effort was made to improve
 * the code, it still contains the full logic from EditPostActivity to make the refactor less error-prone. As such,
 * it is heavily coupled with the `EditPostActivity` and contains logic and dependencies it shouldn't and in dire need
 * of further refactoring.
 */
<span class="nc" id="L32">class EditorPhotoPicker(</span>
<span class="nc" id="L33">    private val activity: AppCompatActivity,</span>
<span class="nc" id="L34">    private val photoPickerListener: PhotoPickerListener,</span>
<span class="nc" id="L35">    private val editorPhotoPickerListener: EditorPhotoPickerListener,</span>
<span class="nc" id="L36">    private val showAztecEditor: Boolean</span>
) : MediaToolbarAction.MediaToolbarButtonClickListener {
    private var photoPickerContainer: View? = null
    private var photoPickerFragment: PhotoPickerFragment? = null
    private var photoPickerOrientation = Configuration.ORIENTATION_UNDEFINED
<span class="nc" id="L41">    var allowMultipleSelection: Boolean = false</span>

    /*
     * loads the photo picker fragment, which is hidden until the user taps the media icon
     */
    private fun initPhotoPicker(site: SiteModel) {
<span class="nc" id="L47">        photoPickerContainer = activity.findViewById(R.id.photo_fragment_container)</span>

        // size the picker before creating the fragment to avoid having it load media now
<span class="nc" id="L50">        resizePhotoPicker()</span>

<span class="nc bnc" id="L52" title="All 2 branches missed.">        photoPickerFragment = activity.supportFragmentManager.findFragmentByTag(PHOTO_PICKER_TAG)</span>
                as? PhotoPickerFragment
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (photoPickerFragment == null) {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">            val mediaBrowserType = if (showAztecEditor) {</span>
<span class="nc" id="L56">                MediaBrowserType.AZTEC_EDITOR_PICKER</span>
<span class="nc" id="L57">            } else MediaBrowserType.EDITOR_PICKER</span>

<span class="nc" id="L59">            PhotoPickerFragment.newInstance(</span>
<span class="nc" id="L60">                    photoPickerListener,</span>
<span class="nc" id="L61">                    mediaBrowserType,</span>
<span class="nc" id="L62">                    site</span>
<span class="nc" id="L63">            ).let {</span>
<span class="nc" id="L64">                photoPickerFragment = it</span>
<span class="nc" id="L65">                activity.supportFragmentManager</span>
<span class="nc" id="L66">                        .beginTransaction()</span>
<span class="nc" id="L67">                        .add(R.id.photo_fragment_container, it, PHOTO_PICKER_TAG)</span>
<span class="nc" id="L68">                        .commit()</span>
            }
        }
<span class="nc" id="L71">    }</span>

    fun isPhotoPickerShowing(): Boolean {
<span class="nc bnc" id="L74" title="All 8 branches missed.">        return photoPickerContainer != null &amp;&amp; photoPickerContainer?.visibility == View.VISIBLE</span>
    }

    /*
     * user has requested to show the photo picker
     */
    fun showPhotoPicker(site: SiteModel) {
<span class="nc" id="L81">        val isAlreadyShowing = isPhotoPickerShowing()</span>

        // make sure we initialized the photo picker
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (photoPickerFragment == null) {</span>
<span class="nc" id="L85">            initPhotoPicker(site)</span>
        }

        // hide soft keyboard
<span class="nc" id="L89">        ActivityUtils.hideKeyboard(activity)</span>

        // slide in the photo picker
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (!isAlreadyShowing) {</span>
<span class="nc" id="L93">            AniUtils.animateBottomBar(photoPickerContainer, true, AniUtils.Duration.MEDIUM)</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            photoPickerFragment?.refresh()</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            photoPickerFragment?.setPhotoPickerListener(photoPickerListener)</span>
        }

<span class="nc" id="L98">        editorPhotoPickerListener.onPhotoPickerShown()</span>
<span class="nc" id="L99">    }</span>

    fun hidePhotoPicker() {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (isPhotoPickerShowing()) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            photoPickerFragment?.finishActionMode()</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            photoPickerFragment?.setPhotoPickerListener(null)</span>
<span class="nc" id="L105">            AniUtils.animateBottomBar(photoPickerContainer, false)</span>
        }
<span class="nc" id="L107">        editorPhotoPickerListener.onPhotoPickerHidden()</span>
<span class="nc" id="L108">    }</span>

    /*
     * resizes the photo picker based on device orientation - full height in landscape, half
     * height in portrait
     */
    private fun resizePhotoPicker() {
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (photoPickerContainer == null) {</span>
<span class="nc" id="L116">            return</span>
        }

<span class="nc" id="L119">        val updatePickerContainerHeight = { newHeight: Int -&gt;</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            photoPickerContainer?.let {</span>
<span class="nc" id="L121">                it.layoutParams.height = newHeight</span>
<span class="nc" id="L122">            }</span>
        }

<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (DisplayUtils.isLandscape(activity)) {</span>
<span class="nc" id="L126">            photoPickerOrientation = Configuration.ORIENTATION_LANDSCAPE</span>
<span class="nc" id="L127">            updatePickerContainerHeight(ViewGroup.LayoutParams.MATCH_PARENT)</span>
        } else {
<span class="nc" id="L129">            photoPickerOrientation = Configuration.ORIENTATION_PORTRAIT</span>
<span class="nc" id="L130">            val displayHeight = DisplayUtils.getWindowPixelHeight(activity)</span>
<span class="nc" id="L131">            updatePickerContainerHeight((displayHeight * 0.5f).toInt())</span>
        }
<span class="nc" id="L133">    }</span>

    override fun onMediaToolbarButtonClicked(action: MediaToolbarAction?) {
<span class="nc bnc" id="L136" title="All 4 branches missed.">        if (action == null || !isPhotoPickerShowing()) {</span>
<span class="nc" id="L137">            return</span>
        }

<span class="nc bnc" id="L140" title="All 2 branches missed.">        photoPickerFragment?.let { photoPickerFragment -&gt;</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">            when (action) {</span>
<span class="nc" id="L142">                MediaToolbarAction.CAMERA -&gt; photoPickerFragment.showCameraPopupMenu(</span>
<span class="nc" id="L143">                        activity.findViewById(action.buttonId)</span>
                )
<span class="nc" id="L145">                MediaToolbarAction.GALLERY -&gt; photoPickerFragment.performActionOrShowPopup(</span>
<span class="nc" id="L146">                        activity.findViewById(action.buttonId)</span>
                )
<span class="nc" id="L148">                MediaToolbarAction.LIBRARY -&gt; photoPickerFragment.doIconClicked(PhotoPickerIcon.WP_MEDIA)</span>
            }
<span class="nc" id="L150">        }</span>
<span class="nc" id="L151">    }</span>

    fun onOrientationChanged(@Orientation newOrientation: Int) {
        // resize the photo picker if the user rotated the device
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (newOrientation != photoPickerOrientation) {</span>
<span class="nc" id="L156">            resizePhotoPicker()</span>
        }
<span class="nc" id="L158">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>