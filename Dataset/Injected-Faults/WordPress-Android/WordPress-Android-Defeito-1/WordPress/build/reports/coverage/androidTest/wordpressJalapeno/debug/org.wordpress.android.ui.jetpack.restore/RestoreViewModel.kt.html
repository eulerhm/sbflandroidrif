<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestoreViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.jetpack.restore</a> &gt; <span class="el_source">RestoreViewModel.kt</span></div><h1>RestoreViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.jetpack.restore

import android.annotation.SuppressLint
import android.os.Bundle
import android.os.Parcelable
import androidx.annotation.VisibleForTesting
import androidx.lifecycle.LiveData
import androidx.lifecycle.MediatorLiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.Observer
import kotlinx.parcelize.Parcelize
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.flow.collect
import org.json.JSONObject
import org.wordpress.android.Constants
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker
import org.wordpress.android.analytics.AnalyticsTracker.Stat.JETPACK_RESTORE_CONFIRMED
import org.wordpress.android.analytics.AnalyticsTracker.Stat.JETPACK_RESTORE_ERROR
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.ActivityLogStore.RewindRequestTypes
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.jetpack.common.JetpackListItemState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.CheckboxState
import org.wordpress.android.ui.jetpack.common.ViewType
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType.CONTENTS
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType.MEDIA_UPLOADS
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType.PLUGINS
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType.ROOTS
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType.SQLS
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType.THEMES
import org.wordpress.android.ui.jetpack.restore.RestoreErrorTypes.GenericFailure
import org.wordpress.android.ui.jetpack.restore.RestoreNavigationEvents.ShowJetpackSettings
import org.wordpress.android.ui.jetpack.restore.RestoreNavigationEvents.VisitSite
import org.wordpress.android.ui.jetpack.restore.RestoreRequestState.AwaitingCredentials
import org.wordpress.android.ui.jetpack.restore.RestoreRequestState.Complete
import org.wordpress.android.ui.jetpack.restore.RestoreRequestState.Empty
import org.wordpress.android.ui.jetpack.restore.RestoreRequestState.Failure.NetworkUnavailable
import org.wordpress.android.ui.jetpack.restore.RestoreRequestState.Failure.OtherRequestRunning
import org.wordpress.android.ui.jetpack.restore.RestoreRequestState.Failure.RemoteRequestFailure
import org.wordpress.android.ui.jetpack.restore.RestoreRequestState.Progress
import org.wordpress.android.ui.jetpack.restore.RestoreRequestState.Success
import org.wordpress.android.ui.jetpack.restore.RestoreStep.COMPLETE
import org.wordpress.android.ui.jetpack.restore.RestoreStep.DETAILS
import org.wordpress.android.ui.jetpack.restore.RestoreStep.ERROR
import org.wordpress.android.ui.jetpack.restore.RestoreStep.PROGRESS
import org.wordpress.android.ui.jetpack.restore.RestoreStep.WARNING
import org.wordpress.android.ui.jetpack.restore.RestoreUiState.ContentState.CompleteState
import org.wordpress.android.ui.jetpack.restore.RestoreUiState.ContentState.DetailsState
import org.wordpress.android.ui.jetpack.restore.RestoreUiState.ContentState.ProgressState
import org.wordpress.android.ui.jetpack.restore.RestoreUiState.ContentState.WarningState
import org.wordpress.android.ui.jetpack.restore.RestoreUiState.ErrorState
import org.wordpress.android.ui.jetpack.restore.RestoreViewModel.RestoreWizardState.RestoreCanceled
import org.wordpress.android.ui.jetpack.restore.RestoreViewModel.RestoreWizardState.RestoreCompleted
import org.wordpress.android.ui.jetpack.restore.RestoreViewModel.RestoreWizardState.RestoreInProgress
import org.wordpress.android.ui.jetpack.restore.builders.RestoreStateListItemBuilder
import org.wordpress.android.ui.jetpack.restore.usecases.GetRestoreStatusUseCase
import org.wordpress.android.ui.jetpack.restore.usecases.PostRestoreUseCase
import org.wordpress.android.ui.jetpack.usecases.GetActivityLogItemUseCase
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringResWithParams
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.wizard.WizardManager
import org.wordpress.android.util.wizard.WizardNavigationTarget
import org.wordpress.android.util.wizard.WizardState
import org.wordpress.android.util.wizard.WizardStep
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ScopedViewModel
import java.util.Date
import java.util.HashMap
import javax.inject.Inject
import javax.inject.Named

const val KEY_RESTORE_ACTIVITY_ID_KEY = &quot;key_restore_activity_id_key&quot;
const val KEY_RESTORE_CURRENT_STEP = &quot;key_restore_current_step&quot;
const val KEY_RESTORE_STATE = &quot;key_restore_state&quot;
private const val TRACKING_ERROR_CAUSE_OFFLINE = &quot;offline&quot;
private const val TRACKING_ERROR_CAUSE_REMOTE = &quot;remote&quot;
private const val TRACKING_ERROR_CAUSE_OTHER = &quot;other&quot;

<span class="nc" id="L84">@Parcelize</span>
@SuppressLint(&quot;ParcelCreator&quot;)
<span class="nc" id="L86">data class RestoreState(</span>
<span class="nc" id="L87">    val rewindId: String? = null,</span>
<span class="nc" id="L88">    val optionsSelected: List&lt;Pair&lt;Int, Boolean&gt;&gt;? = null,</span>
<span class="nc" id="L89">    val restoreId: Long? = null,</span>
<span class="nc" id="L90">    val published: Date? = null,</span>
<span class="nc" id="L91">    val errorType: Int? = null,</span>
<span class="nc" id="L92">    val shouldInitProgress: Boolean = true,</span>
<span class="nc" id="L93">    val shouldInitDetails: Boolean = true</span>
<span class="nc" id="L94">) : WizardState, Parcelable</span>

typealias NavigationTarget = WizardNavigationTarget&lt;RestoreStep, RestoreState&gt;

<span class="nc" id="L98">class RestoreViewModel @Inject constructor(</span>
<span class="nc" id="L99">    private val wizardManager: WizardManager&lt;RestoreStep&gt;,</span>
<span class="nc" id="L100">    private val availableItemsProvider: JetpackAvailableItemsProvider,</span>
<span class="nc" id="L101">    private val getActivityLogItemUseCase: GetActivityLogItemUseCase,</span>
<span class="nc" id="L102">    private val stateListItemBuilder: RestoreStateListItemBuilder,</span>
<span class="nc" id="L103">    private val postRestoreUseCase: PostRestoreUseCase,</span>
<span class="nc" id="L104">    private val getRestoreStatusUseCase: GetRestoreStatusUseCase,</span>
<span class="nc" id="L105">    @Named(UI_THREAD) private val mainDispatcher: CoroutineDispatcher</span>
<span class="nc" id="L106">) : ScopedViewModel(mainDispatcher) {</span>
    private var isStarted = false
    private lateinit var site: SiteModel
    private lateinit var activityId: String
    private lateinit var restoreState: RestoreState
    private val progressStart = 0

<span class="nc" id="L113">    private val _wizardFinishedObservable = MutableLiveData&lt;Event&lt;RestoreWizardState&gt;&gt;()</span>
<span class="nc" id="L114">    val wizardFinishedObservable: LiveData&lt;Event&lt;RestoreWizardState&gt;&gt; = _wizardFinishedObservable</span>

<span class="nc" id="L116">    private val _snackbarEvents = MediatorLiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt;()</span>
<span class="nc" id="L117">    val snackbarEvents: LiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt; = _snackbarEvents</span>

<span class="nc" id="L119">    private val _navigationEvents = MediatorLiveData&lt;Event&lt;RestoreNavigationEvents&gt;&gt;()</span>
<span class="nc" id="L120">    val navigationEvents: LiveData&lt;Event&lt;RestoreNavigationEvents&gt;&gt; = _navigationEvents</span>

<span class="nc" id="L122">    private val _uiState = MutableLiveData&lt;RestoreUiState&gt;()</span>
<span class="nc" id="L123">    val uiState: LiveData&lt;RestoreUiState&gt; = _uiState</span>

<span class="nc" id="L125">    private val wizardObserver = Observer { data: RestoreStep? -&gt;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        data?.let {</span>
<span class="nc" id="L127">            clearOldRestoreState(it)</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            showStep(NavigationTarget(it, restoreState))</span>
<span class="nc" id="L129">        }</span>
<span class="nc" id="L130">    }</span>

    fun start(site: SiteModel, activityId: String, savedInstanceState: Bundle?) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (isStarted) return</span>
<span class="nc" id="L134">        isStarted = true</span>

<span class="nc" id="L136">        this.site = site</span>
<span class="nc" id="L137">        this.activityId = activityId</span>

<span class="nc" id="L139">        wizardManager.navigatorLiveData.observeForever(wizardObserver)</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L142">            restoreState = RestoreState()</span>
            // Show the next step only if it's a fresh activity so we can handle the navigation
<span class="nc" id="L144">            wizardManager.showNextStep()</span>
        } else {
<span class="nc bnc" id="L146" title="All 2 branches missed.">            restoreState = requireNotNull(savedInstanceState.getParcelable(KEY_RESTORE_STATE))</span>
<span class="nc" id="L147">            val currentStepIndex = savedInstanceState.getInt(KEY_RESTORE_CURRENT_STEP)</span>
<span class="nc" id="L148">            wizardManager.setCurrentStepIndex(currentStepIndex)</span>
        }
<span class="nc" id="L150">    }</span>

    fun onBackPressed() {
<span class="nc" id="L153">        when (wizardManager.currentStep) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            DETAILS.id -&gt; _wizardFinishedObservable.value = Event(RestoreCanceled)</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            WARNING.id -&gt; _wizardFinishedObservable.value = Event(RestoreCanceled)</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            PROGRESS.id -&gt; _wizardFinishedObservable.value = constructProgressEvent()</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            COMPLETE.id -&gt; _wizardFinishedObservable.value = Event(RestoreCompleted)</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            ERROR.id -&gt; _wizardFinishedObservable.value = Event(RestoreCanceled)</span>
        }
<span class="nc" id="L160">    }</span>

<span class="nc bnc" id="L162" title="All 4 branches missed.">    private fun constructProgressEvent() = if (restoreState.restoreId != null) {</span>
<span class="nc" id="L163">        Event(</span>
<span class="nc" id="L164">                RestoreInProgress(</span>
<span class="nc bnc" id="L165" title="All 4 branches missed.">                        restoreState.rewindId as String,</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">                        restoreState.restoreId as Long</span>
                )
        )
    } else {
<span class="nc" id="L170">        Event(RestoreCanceled)</span>
<span class="nc" id="L171">    }</span>

    fun writeToBundle(outState: Bundle) {
<span class="nc" id="L174">        outState.putInt(KEY_RESTORE_CURRENT_STEP, wizardManager.currentStep)</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        outState.putParcelable(KEY_RESTORE_STATE, restoreState)</span>
<span class="nc" id="L176">    }</span>

<span class="nc" id="L178">    private fun buildDetails(isAwaitingCredentials: Boolean = false) {</span>
<span class="nc" id="L179">        launch {</span>
<span class="nc" id="L180">            val availableItems = availableItemsProvider.getAvailableItems()</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            val activityLogModel = getActivityLogItemUseCase.get(activityId)</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (activityLogModel != null) {</span>
<span class="nc bnc" id="L183" title="All 4 branches missed.">                if (restoreState.shouldInitDetails) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                    restoreState = restoreState.copy(shouldInitDetails = false)</span>
<span class="nc" id="L185">                    queryRestoreStatus(checkIfAwaitingCredentials = true)</span>
                } else {
<span class="nc" id="L187">                    _uiState.value = DetailsState(</span>
<span class="nc" id="L188">                            activityLogModel = activityLogModel,</span>
<span class="nc" id="L189">                            items = stateListItemBuilder.buildDetailsListStateItems(</span>
<span class="nc" id="L190">                                    availableItems = availableItems,</span>
<span class="nc" id="L191">                                    published = activityLogModel.published,</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                                    siteId = site.siteId,</span>
<span class="nc" id="L193">                                    isAwaitingCredentials = isAwaitingCredentials,</span>
<span class="nc" id="L194">                                    onCreateDownloadClick = this@RestoreViewModel::onRestoreSiteClick,</span>
<span class="nc" id="L195">                                    onCheckboxItemClicked = this@RestoreViewModel::onCheckboxItemClicked,</span>
<span class="nc" id="L196">                                    onEnterServerCredsIconClicked = this@RestoreViewModel::onEnterServerCredsIconClicked</span>
                            ),
<span class="nc" id="L198">                            type = StateType.DETAILS</span>
                    )
                }
            } else {
<span class="nc" id="L202">                trackError(TRACKING_ERROR_CAUSE_OTHER)</span>
<span class="nc" id="L203">                transitionToError(GenericFailure)</span>
            }
<span class="nc" id="L205">        }</span>
<span class="nc" id="L206">    }</span>

    private fun buildWarning() {
<span class="nc" id="L209">        _uiState.value = WarningState(</span>
<span class="nc" id="L210">                items = stateListItemBuilder.buildWarningListStateItems(</span>
<span class="nc bnc" id="L211" title="All 4 branches missed.">                        published = restoreState.published as Date,</span>
<span class="nc" id="L212">                        onConfirmRestoreClick = this@RestoreViewModel::onConfirmRestoreClick,</span>
<span class="nc" id="L213">                        onCancelClick = this@RestoreViewModel::onCancelClick</span>
                ),
<span class="nc" id="L215">                type = StateType.WARNING</span>
        )
<span class="nc" id="L217">    }</span>

    private fun buildProgress() {
<span class="nc" id="L220">        _uiState.value = ProgressState(</span>
<span class="nc" id="L221">                items = stateListItemBuilder.buildProgressListStateItems(</span>
<span class="nc" id="L222">                        progress = progressStart,</span>
<span class="nc bnc" id="L223" title="All 4 branches missed.">                        published = restoreState.published as Date,</span>
<span class="nc" id="L224">                        isIndeterminate = true</span>
                ),
<span class="nc" id="L226">                type = StateType.PROGRESS</span>
        )
<span class="nc bnc" id="L228" title="All 4 branches missed.">        if (restoreState.shouldInitProgress) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">            restoreState = restoreState.copy(shouldInitProgress = false)</span>
<span class="nc" id="L230">            launch {</span>
<span class="nc" id="L231">                val result = postRestoreUseCase.postRestoreRequest(</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">                        restoreState.rewindId as String,</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                        site,</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                        buildRewindRequestTypes(restoreState.optionsSelected)</span>
                )
<span class="nc" id="L236">                handleRestoreRequestResult(result)</span>
<span class="nc" id="L237">            }</span>
        } else {
<span class="nc" id="L239">            queryRestoreStatus()</span>
        }
<span class="nc" id="L241">    }</span>

    private fun buildComplete() {
<span class="nc" id="L244">        _uiState.value = CompleteState(</span>
<span class="nc" id="L245">                items = stateListItemBuilder.buildCompleteListStateItems(</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">                        published = restoreState.published as Date,</span>
<span class="nc" id="L247">                        onDoneClick = this@RestoreViewModel::onDoneClick,</span>
<span class="nc" id="L248">                        onVisitSiteClick = this@RestoreViewModel::onVisitSiteClick</span>
                ),
<span class="nc" id="L250">                type = StateType.COMPLETE</span>
        )
<span class="nc" id="L252">    }</span>

    private fun buildError(errorType: RestoreErrorTypes) {
<span class="nc" id="L255">        _uiState.value = ErrorState(</span>
<span class="nc" id="L256">                items = stateListItemBuilder.buildErrorListStateErrorItems(</span>
<span class="nc" id="L257">                        errorType = errorType,</span>
<span class="nc" id="L258">                        onDoneClick = this@RestoreViewModel::onDoneClick</span>
                ),
<span class="nc" id="L260">                errorType = errorType</span>
        )
<span class="nc" id="L262">    }</span>

    @VisibleForTesting(otherwise = VisibleForTesting.PRIVATE)
    fun showStep(target: WizardNavigationTarget&lt;RestoreStep, RestoreState&gt;) {
<span class="nc bnc" id="L266" title="All 6 branches missed.">        when (target.wizardStep) {</span>
<span class="nc" id="L267">            DETAILS -&gt; buildDetails()</span>
<span class="nc" id="L268">            WARNING -&gt; buildWarning()</span>
<span class="nc" id="L269">            PROGRESS -&gt; buildProgress()</span>
<span class="nc" id="L270">            COMPLETE -&gt; buildComplete()</span>
<span class="nc" id="L271">            ERROR -&gt; buildError(</span>
<span class="nc" id="L272">                    RestoreErrorTypes.fromInt(</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                            target.wizardState.errorType ?: GenericFailure.id</span>
                    )
            )
        }
<span class="nc" id="L277">    }</span>

    private fun transitionToError(errorType: RestoreErrorTypes) {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        restoreState = restoreState.copy(errorType = errorType.id)</span>
<span class="nc" id="L281">        wizardManager.setCurrentStepIndex(RestoreStep.indexForErrorTransition())</span>
<span class="nc" id="L282">        wizardManager.showNextStep()</span>
<span class="nc" id="L283">    }</span>

    private fun getParams(): Pair&lt;String?, List&lt;Pair&lt;Int, Boolean&gt;&gt;&gt; {
<span class="nc bnc" id="L286" title="All 6 branches missed.">        val rewindId = (_uiState.value as? DetailsState)?.activityLogModel?.rewindID</span>
<span class="nc bnc" id="L287" title="All 4 branches missed.">        val items = _uiState.value?.items ?: mutableListOf()</span>
<span class="nc" id="L288">        val options = buildOptionsSelected(items)</span>
<span class="nc" id="L289">        return rewindId to options</span>
    }

    private fun buildOptionsSelected(items: List&lt;JetpackListItemState&gt;): List&lt;Pair&lt;Int, Boolean&gt;&gt; {
<span class="nc" id="L293">        val checkboxes = items.filterIsInstance(CheckboxState::class.java)</span>
<span class="nc" id="L294">        return listOf(</span>
<span class="nc" id="L295">                Pair(</span>
<span class="nc" id="L296">                        THEMES.id,</span>
<span class="nc bnc" id="L297" title="All 6 branches missed.">                        checkboxes.firstOrNull { it.availableItemType == THEMES }?.checked ?: true</span>
                ),
<span class="nc" id="L299">                Pair(</span>
<span class="nc" id="L300">                        PLUGINS.id,</span>
<span class="nc bnc" id="L301" title="All 6 branches missed.">                        checkboxes.firstOrNull { it.availableItemType == PLUGINS }?.checked ?: true</span>
                ),
<span class="nc" id="L303">                Pair(</span>
<span class="nc" id="L304">                        MEDIA_UPLOADS.id,</span>
<span class="nc bnc" id="L305" title="All 6 branches missed.">                        checkboxes.firstOrNull { it.availableItemType == MEDIA_UPLOADS }?.checked</span>
<span class="nc" id="L306">                                ?: true</span>
                ),
<span class="nc" id="L308">                Pair(</span>
<span class="nc" id="L309">                        SQLS.id,</span>
<span class="nc bnc" id="L310" title="All 6 branches missed.">                        checkboxes.firstOrNull { it.availableItemType == SQLS }?.checked ?: true</span>
                ),
<span class="nc" id="L312">                Pair(</span>
<span class="nc" id="L313">                        ROOTS.id,</span>
<span class="nc bnc" id="L314" title="All 6 branches missed.">                        checkboxes.firstOrNull { it.availableItemType == ROOTS }?.checked ?: true</span>
                ),
<span class="nc" id="L316">                Pair(</span>
<span class="nc" id="L317">                        CONTENTS.id,</span>
<span class="nc bnc" id="L318" title="All 6 branches missed.">                        checkboxes.firstOrNull { it.availableItemType == CONTENTS }?.checked ?: true</span>
                )
        )
    }

    private fun buildRewindRequestTypes(optionsSelected: List&lt;Pair&lt;Int, Boolean&gt;&gt;?) =
<span class="nc" id="L324">            RewindRequestTypes(</span>
<span class="nc bnc" id="L325" title="All 10 branches missed.">                    themes = optionsSelected?.firstOrNull { it.first == THEMES.id }?.second ?: true,</span>
<span class="nc bnc" id="L326" title="All 10 branches missed.">                    plugins = optionsSelected?.firstOrNull { it.first == PLUGINS.id }?.second</span>
<span class="nc" id="L327">                            ?: true,</span>
<span class="nc bnc" id="L328" title="All 10 branches missed.">                    uploads = optionsSelected?.firstOrNull { it.first == MEDIA_UPLOADS.id }?.second</span>
<span class="nc" id="L329">                            ?: true,</span>
<span class="nc bnc" id="L330" title="All 10 branches missed.">                    sqls = optionsSelected?.firstOrNull { it.first == SQLS.id }?.second ?: true,</span>
<span class="nc bnc" id="L331" title="All 10 branches missed.">                    roots = optionsSelected?.firstOrNull { it.first == ROOTS.id }?.second ?: true,</span>
<span class="nc bnc" id="L332" title="All 10 branches missed.">                    contents = optionsSelected?.firstOrNull { it.first == CONTENTS.id }?.second</span>
<span class="nc" id="L333">                            ?: true</span>
<span class="nc" id="L334">            )</span>

    private fun handleRestoreRequestResult(result: RestoreRequestState) {
<span class="nc" id="L337">        when (result) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            is NetworkUnavailable -&gt; {</span>
<span class="nc" id="L339">                trackError(TRACKING_ERROR_CAUSE_OFFLINE)</span>
<span class="nc" id="L340">                handleRestoreRequestError(NetworkUnavailableMsg)</span>
            }
<span class="nc bnc" id="L342" title="All 2 branches missed.">            is RemoteRequestFailure -&gt; {</span>
<span class="nc" id="L343">                trackError(TRACKING_ERROR_CAUSE_REMOTE)</span>
<span class="nc" id="L344">                handleRestoreRequestError(GenericFailureMsg)</span>
            }
<span class="nc bnc" id="L346" title="All 2 branches missed.">            is Success -&gt; handleRestoreRequestSuccess(result)</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            is OtherRequestRunning -&gt; {</span>
<span class="nc" id="L348">                trackError(TRACKING_ERROR_CAUSE_OTHER)</span>
<span class="nc" id="L349">                handleRestoreRequestError(OtherRequestRunningMsg)</span>
            }
<span class="nc" id="L351">            else -&gt; throw Throwable(&quot;Unexpected restoreRequestResult ${this.javaClass.simpleName}&quot;)</span>
        }
<span class="nc" id="L353">    }</span>

    private fun handleRestoreRequestSuccess(result: Success) {
<span class="nc bnc" id="L356" title="All 2 branches missed.">        restoreState = restoreState.copy(</span>
<span class="nc" id="L357">                rewindId = result.rewindId,</span>
<span class="nc" id="L358">                restoreId = result.restoreId</span>
        )
<span class="nc bnc" id="L360" title="All 4 branches missed.">        (_uiState.value as? ProgressState)?.let {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">            val updatedItems = stateListItemBuilder.updateProgressActionButtonState(it, result.restoreId != null)</span>
<span class="nc" id="L362">            _uiState.postValue(it.copy(items = updatedItems))</span>
<span class="nc" id="L363">        }</span>
<span class="nc" id="L364">        queryRestoreStatus()</span>
<span class="nc" id="L365">    }</span>

    private fun handleRestoreRequestError(snackbarMessageHolder: SnackbarMessageHolder) {
<span class="nc" id="L368">        _snackbarEvents.postValue((Event(snackbarMessageHolder)))</span>
<span class="nc" id="L369">        resetWizardIndex(DETAILS)</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        showStep(NavigationTarget(DETAILS, restoreState))</span>
<span class="nc" id="L371">    }</span>

    private fun resetWizardIndex(targetStep: WizardStep) {
<span class="nc" id="L374">        val currentIndex = wizardManager.currentStep</span>
<span class="nc" id="L375">        val targetIndex = wizardManager.stepPosition(targetStep)</span>

<span class="nc bnc" id="L377" title="All 4 branches missed.">        for (i in currentIndex downTo targetIndex) {</span>
<span class="nc" id="L378">            wizardManager.onBackPressed()</span>
        }
<span class="nc" id="L380">    }</span>

    private fun extractPublishedDate(): Date {
<span class="nc bnc" id="L383" title="All 8 branches missed.">        return (_uiState.value as? DetailsState)?.activityLogModel?.published as Date</span>
    }

<span class="nc" id="L386">    private fun queryRestoreStatus(checkIfAwaitingCredentials: Boolean = false) {</span>
<span class="nc" id="L387">        launch {</span>
<span class="nc bnc" id="L388" title="All 4 branches missed.">            getRestoreStatusUseCase.getRestoreStatus(site, restoreState.restoreId, checkIfAwaitingCredentials)</span>
<span class="nc" id="L389">                    .collect { state -&gt; handleQueryStatus(state) }</span>
<span class="nc" id="L390">        }</span>
<span class="nc" id="L391">    }</span>

    private fun handleQueryStatus(restoreStatus: RestoreRequestState) {
<span class="nc" id="L394">        when (restoreStatus) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">            is NetworkUnavailable -&gt; {</span>
<span class="nc" id="L396">                trackError(TRACKING_ERROR_CAUSE_OFFLINE)</span>
<span class="nc" id="L397">                transitionToError(RestoreErrorTypes.RemoteRequestFailure)</span>
            }
<span class="nc bnc" id="L399" title="All 2 branches missed.">            is RemoteRequestFailure -&gt; {</span>
<span class="nc" id="L400">                trackError(TRACKING_ERROR_CAUSE_REMOTE)</span>
<span class="nc" id="L401">                transitionToError(RestoreErrorTypes.RemoteRequestFailure)</span>
            }
<span class="nc bnc" id="L403" title="All 2 branches missed.">            is AwaitingCredentials -&gt; buildDetails(isAwaitingCredentials = restoreStatus.isAwaitingCredentials)</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            is Progress -&gt; transitionToProgress(restoreStatus)</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">            is Complete -&gt; wizardManager.showNextStep()</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">            is Empty -&gt; transitionToError(RestoreErrorTypes.RemoteRequestFailure)</span>
<span class="nc" id="L407">            else -&gt; Unit // Do nothing</span>
        }
<span class="nc" id="L409">    }</span>

    private fun transitionToProgress(restoreStatus: Progress) {
<span class="nc bnc" id="L412" title="All 4 branches missed.">        (_uiState.value as? ProgressState)?.let { content -&gt;</span>
<span class="nc" id="L413">            val updatedList = content.items.map { contentState -&gt;</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">                if (contentState.type == ViewType.PROGRESS) {</span>
<span class="nc" id="L415">                    contentState as JetpackListItemState.ProgressState</span>
<span class="nc" id="L416">                    contentState.copy(</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                            progress = restoreStatus.progress ?: 0,</span>
<span class="nc" id="L418">                            progressLabel = UiStringResWithParams(</span>
<span class="nc" id="L419">                                    R.string.restore_progress_label,</span>
<span class="nc bnc" id="L420" title="All 4 branches missed.">                                    listOf(UiStringText(restoreStatus.progress?.toString() ?: &quot;0&quot;))</span>
                            ),
<span class="nc bnc" id="L422" title="All 2 branches missed.">                            progressInfoLabel = if (restoreStatus.currentEntry != null) {</span>
<span class="nc" id="L423">                                UiStringText(&quot;${restoreStatus.currentEntry}&quot;)</span>
                            } else {
<span class="nc" id="L425">                                null</span>
                            },
<span class="nc bnc" id="L427" title="All 2 branches missed.">                            progressStateLabel = if (restoreStatus.message != null) {</span>
<span class="nc" id="L428">                                UiStringText(&quot;${restoreStatus.message}&quot;)</span>
                            } else {
<span class="nc" id="L430">                                null</span>
                            },
<span class="nc bnc" id="L432" title="All 4 branches missed.">                            isIndeterminate = (restoreStatus.progress ?: 0) &lt;= 0</span>
                    )
                } else {
<span class="nc" id="L435">                    contentState</span>
                }
            }
<span class="nc" id="L438">            _uiState.postValue(content.copy(items = updatedList))</span>
<span class="nc" id="L439">        }</span>
<span class="nc" id="L440">    }</span>

    private fun clearOldRestoreState(wizardStep: RestoreStep) {
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (wizardStep == DETAILS) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            restoreState = restoreState.copy(</span>
<span class="nc" id="L445">                    rewindId = null,</span>
<span class="nc" id="L446">                    restoreId = null,</span>
<span class="nc" id="L447">                    errorType = null,</span>
<span class="nc" id="L448">                    optionsSelected = null,</span>
<span class="nc" id="L449">                    published = null,</span>
<span class="nc" id="L450">                    shouldInitProgress = true,</span>
<span class="nc" id="L451">                    shouldInitDetails = true</span>
            )
        }
<span class="nc" id="L454">    }</span>

    private fun onCheckboxItemClicked(itemType: JetpackAvailableItemType) {
<span class="nc bnc" id="L457" title="All 4 branches missed.">        (_uiState.value as? DetailsState)?.let {</span>
<span class="nc" id="L458">            val updatedItems = stateListItemBuilder.updateCheckboxes(it, itemType)</span>
<span class="nc" id="L459">            _uiState.postValue(it.copy(items = updatedItems))</span>
<span class="nc" id="L460">        }</span>
<span class="nc" id="L461">    }</span>

    private fun onEnterServerCredsIconClicked() {
<span class="nc bnc" id="L464" title="All 2 branches missed.">        _navigationEvents.postValue(Event(ShowJetpackSettings(&quot;${Constants.URL_JETPACK_SETTINGS}/${site.siteId}&quot;)))</span>
<span class="nc" id="L465">    }</span>

    private fun onRestoreSiteClick() {
<span class="nc" id="L468">        val (rewindId, optionsSelected) = getParams()</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">        if (rewindId == null) {</span>
<span class="nc" id="L470">            trackError(TRACKING_ERROR_CAUSE_OTHER)</span>
<span class="nc" id="L471">            transitionToError(GenericFailure)</span>
        } else {
<span class="nc bnc" id="L473" title="All 2 branches missed.">            restoreState = restoreState.copy(</span>
<span class="nc" id="L474">                    rewindId = rewindId,</span>
<span class="nc" id="L475">                    optionsSelected = optionsSelected,</span>
<span class="nc" id="L476">                    published = extractPublishedDate(),</span>
<span class="nc" id="L477">                    shouldInitProgress = true</span>
            )
<span class="nc" id="L479">            wizardManager.showNextStep()</span>
        }
<span class="nc" id="L481">    }</span>

    private fun onConfirmRestoreClick() {
<span class="nc bnc" id="L484" title="All 4 branches missed.">        if (restoreState.rewindId == null) {</span>
<span class="nc" id="L485">            trackError(TRACKING_ERROR_CAUSE_OTHER)</span>
<span class="nc" id="L486">            transitionToError(GenericFailure)</span>
        } else {
<span class="nc" id="L488">            trackRestoreConfirmed()</span>
<span class="nc" id="L489">            wizardManager.showNextStep()</span>
        }
<span class="nc" id="L491">    }</span>

    private fun onCancelClick() {
<span class="nc" id="L494">        wizardManager.onBackPressed()</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">        showStep(NavigationTarget(DETAILS, restoreState))</span>
<span class="nc" id="L496">    }</span>

    private fun onVisitSiteClick() {
<span class="nc bnc" id="L499" title="All 6 branches missed.">        site.url?.let { _navigationEvents.postValue(Event(VisitSite(site.url))) }</span>
<span class="nc" id="L500">    }</span>

    private fun onDoneClick() {
<span class="nc" id="L503">        _wizardFinishedObservable.value = Event(RestoreCanceled)</span>
<span class="nc" id="L504">    }</span>

    override fun onCleared() {
<span class="nc" id="L507">        super.onCleared()</span>
<span class="nc" id="L508">        wizardManager.navigatorLiveData.removeObserver(wizardObserver)</span>
<span class="nc" id="L509">    }</span>

    private fun trackRestoreConfirmed() {
<span class="nc bnc" id="L512" title="All 2 branches missed.">        val types = buildRewindRequestTypes(restoreState.optionsSelected)</span>
<span class="nc" id="L513">        val propertiesSetup = mapOf(</span>
<span class="nc" id="L514">                &quot;themes&quot; to types.themes,</span>
<span class="nc" id="L515">                &quot;plugins&quot; to types.plugins,</span>
<span class="nc" id="L516">                &quot;uploads&quot; to types.uploads,</span>
<span class="nc" id="L517">                &quot;sqls&quot; to types.sqls,</span>
<span class="nc" id="L518">                &quot;roots&quot; to types.roots,</span>
<span class="nc" id="L519">                &quot;contents&quot; to types.contents</span>
        )
<span class="nc" id="L521">        val map = mapOf(&quot;restore_types&quot; to JSONObject(propertiesSetup))</span>
<span class="nc" id="L522">        AnalyticsTracker.track(JETPACK_RESTORE_CONFIRMED, map)</span>
<span class="nc" id="L523">    }</span>

    private fun trackError(cause: String) {
<span class="nc" id="L526">        val properties: MutableMap&lt;String, String?&gt; = HashMap()</span>
<span class="nc" id="L527">        properties[&quot;cause&quot;] = cause</span>
<span class="nc" id="L528">        AnalyticsTracker.track(JETPACK_RESTORE_ERROR, properties)</span>
<span class="nc" id="L529">    }</span>

    companion object {
<span class="nc" id="L532">        private val NetworkUnavailableMsg = SnackbarMessageHolder(UiStringRes(R.string.error_network_connection))</span>
<span class="nc" id="L533">        private val GenericFailureMsg = SnackbarMessageHolder(UiStringRes(R.string.restore_generic_failure))</span>
        private val OtherRequestRunningMsg =
<span class="nc" id="L535">                SnackbarMessageHolder(UiStringRes(R.string.restore_another_process_running))</span>
    }

    @SuppressLint(&quot;ParcelCreator&quot;)
    sealed class RestoreWizardState : Parcelable {
<span class="nc" id="L540">        @Parcelize</span>
<span class="nc" id="L541">        object RestoreCanceled : RestoreWizardState()</span>

        @Parcelize
<span class="nc" id="L544">        data class RestoreInProgress(</span>
<span class="nc" id="L545">            val rewindId: String,</span>
<span class="nc" id="L546">            val restoreId: Long</span>
<span class="nc" id="L547">        ) : RestoreWizardState()</span>

<span class="nc" id="L549">        @Parcelize</span>
<span class="nc" id="L550">        object RestoreCompleted : RestoreWizardState()</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>