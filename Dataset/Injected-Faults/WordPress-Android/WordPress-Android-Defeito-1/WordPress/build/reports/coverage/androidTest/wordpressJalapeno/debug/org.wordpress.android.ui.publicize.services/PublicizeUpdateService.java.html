<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PublicizeUpdateService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.publicize.services</a> &gt; <span class="el_source">PublicizeUpdateService.java</span></div><h1>PublicizeUpdateService.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.publicize.services;

import android.content.Context;
import android.content.Intent;

import androidx.annotation.NonNull;
import androidx.core.app.JobIntentService;

import com.android.volley.VolleyError;
import com.wordpress.rest.RestRequest;

import org.greenrobot.eventbus.EventBus;
import org.json.JSONObject;
import org.wordpress.android.WordPress;
import org.wordpress.android.datasets.PublicizeTable;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.models.PublicizeConnectionList;
import org.wordpress.android.models.PublicizeServiceList;
import org.wordpress.android.ui.publicize.PublicizeEvents;
import org.wordpress.android.util.AppLog;

import java.util.Locale;

import static org.wordpress.android.JobServiceId.JOB_PUBLICIZE_UPDATE_SERVICE_ID;

/**
 * service which requests the user's available sharing services and publicize connections
 */

<span class="nc" id="L30">public class PublicizeUpdateService extends JobIntentService {</span>
    private static boolean mHasUpdatedServices;

    /*
     * update the publicize connections for the passed site
     */
    public static void updateConnectionsForSite(Context context, @NonNull SiteModel site) {
<span class="nc" id="L37">        Intent intent = new Intent(context, PublicizeUpdateService.class);</span>
<span class="nc" id="L38">        intent.putExtra(WordPress.SITE, site);</span>
<span class="nc" id="L39">        enqueueWork(context, intent);</span>
<span class="nc" id="L40">    }</span>

    public static void enqueueWork(Context context, Intent work) {
<span class="nc" id="L43">        enqueueWork(context, PublicizeUpdateService.class, JOB_PUBLICIZE_UPDATE_SERVICE_ID, work);</span>
<span class="nc" id="L44">    }</span>

    @Override
    public void onCreate() {
<span class="nc" id="L48">        super.onCreate();</span>
<span class="nc" id="L49">        AppLog.i(AppLog.T.SHARING, &quot;publicize service &gt; created&quot;);</span>
<span class="nc" id="L50">    }</span>

    @Override
    public void onDestroy() {
<span class="nc" id="L54">        AppLog.i(AppLog.T.SHARING, &quot;publicize service &gt; destroyed&quot;);</span>
<span class="nc" id="L55">        super.onDestroy();</span>
<span class="nc" id="L56">    }</span>

    @Override
    protected void onHandleWork(@NonNull Intent intent) {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (intent == null) {</span>
<span class="nc" id="L61">            return;</span>
        }

        // update list of services if we haven't done so yet - only done once per session
        // since it rarely changes
<span class="nc bnc" id="L66" title="All 4 branches missed.">        if (!mHasUpdatedServices || PublicizeTable.getNumServices() == 0) {</span>
<span class="nc" id="L67">            updateServices();</span>
<span class="nc" id="L68">            AppLog.d(AppLog.T.SHARING, &quot;publicize service &gt; updating services&quot;);</span>
<span class="nc" id="L69">            mHasUpdatedServices = true;</span>
        }

<span class="nc" id="L72">        SiteModel site = (SiteModel) intent.getSerializableExtra(WordPress.SITE);</span>
<span class="nc" id="L73">        updateConnections(site.getSiteId());</span>
<span class="nc" id="L74">    }</span>

    @Override
    public boolean onStopCurrentWork() {
        // this Service was failing silently if it couldn't get to update its data, so
        // that hints us that we shouldn't really care about rescheduling this job
        // in the case something failed.
<span class="nc" id="L81">        return false;</span>
    }

    /*
     * update the list of publicize services
     */
    private void updateServices() {
<span class="nc" id="L88">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L91">                PublicizeServiceList serverList = PublicizeServiceList.fromJson(jsonObject);</span>
<span class="nc" id="L92">                PublicizeServiceList localList = PublicizeTable.getServiceList();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                if (!serverList.isSameAs(localList)) {</span>
<span class="nc" id="L94">                    PublicizeTable.setServiceList(serverList);</span>
<span class="nc" id="L95">                    EventBus.getDefault().post(new PublicizeEvents.ConnectionsChanged());</span>
                }
<span class="nc" id="L97">            }</span>
        };
<span class="nc" id="L99">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L102">                AppLog.e(AppLog.T.SHARING, volleyError);</span>
<span class="nc" id="L103">            }</span>
        };

<span class="nc" id="L106">        String path = &quot;/meta/external-services?type=publicize&quot;;</span>
<span class="nc" id="L107">        WordPress.getRestClientUtilsV1_1().get(path, null, null, listener, errorListener);</span>
<span class="nc" id="L108">    }</span>

    /*
     * update the connections for the passed blog
     */
    private void updateConnections(final long siteId) {
<span class="nc" id="L114">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L117">                PublicizeConnectionList serverList = PublicizeConnectionList.fromJson(jsonObject);</span>
<span class="nc" id="L118">                PublicizeConnectionList localList = PublicizeTable.getConnectionsForSite(siteId);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (!serverList.isSameAs(localList)) {</span>
<span class="nc" id="L120">                    PublicizeTable.setConnectionsForSite(siteId, serverList);</span>
<span class="nc" id="L121">                    EventBus.getDefault().post(new PublicizeEvents.ConnectionsChanged());</span>
                }
<span class="nc" id="L123">            }</span>
        };
<span class="nc" id="L125">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L128">                AppLog.e(AppLog.T.SHARING, volleyError);</span>
<span class="nc" id="L129">            }</span>
        };

<span class="nc" id="L132">        String path = String.format(Locale.ROOT, &quot;sites/%d/publicize-connections&quot;, siteId);</span>
<span class="nc" id="L133">        WordPress.getRestClientUtilsV1_1().get(path, null, null, listener, errorListener);</span>
<span class="nc" id="L134">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>