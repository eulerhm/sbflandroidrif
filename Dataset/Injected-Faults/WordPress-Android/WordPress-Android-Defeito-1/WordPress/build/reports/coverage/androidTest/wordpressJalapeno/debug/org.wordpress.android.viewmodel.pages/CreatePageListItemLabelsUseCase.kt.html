<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CreatePageListItemLabelsUseCase.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.viewmodel.pages</a> &gt; <span class="el_source">CreatePageListItemLabelsUseCase.kt</span></div><h1>CreatePageListItemLabelsUseCase.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.viewmodel.pages

import org.wordpress.android.BuildConfig
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.PostModel
import org.wordpress.android.fluxc.model.post.PostStatus
import org.wordpress.android.fluxc.model.post.PostStatus.DRAFT
import org.wordpress.android.fluxc.model.post.PostStatus.PENDING
import org.wordpress.android.fluxc.model.post.PostStatus.PRIVATE
import org.wordpress.android.fluxc.model.post.PostStatus.PUBLISHED
import org.wordpress.android.fluxc.model.post.PostStatus.SCHEDULED
import org.wordpress.android.fluxc.model.post.PostStatus.TRASHED
import org.wordpress.android.fluxc.model.post.PostStatus.UNKNOWN
import org.wordpress.android.ui.uploads.UploadUtilsWrapper
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T.PAGES
import org.wordpress.android.viewmodel.pages.PostModelUploadUiStateUseCase.PostUploadUiState
import org.wordpress.android.viewmodel.pages.PostModelUploadUiStateUseCase.PostUploadUiState.UploadFailed
import org.wordpress.android.viewmodel.pages.PostModelUploadUiStateUseCase.PostUploadUiState.UploadQueued
import org.wordpress.android.viewmodel.pages.PostModelUploadUiStateUseCase.PostUploadUiState.UploadWaitingForConnection
import org.wordpress.android.viewmodel.pages.PostModelUploadUiStateUseCase.PostUploadUiState.UploadingMedia
import org.wordpress.android.viewmodel.pages.PostModelUploadUiStateUseCase.PostUploadUiState.UploadingPost
import javax.inject.Inject

typealias LabelColor = Int?
/**
 * Most of this code has been copied from PostListItemUIStateHelper.
 */
<span class="nc" id="L31">class CreatePageListItemLabelsUseCase @Inject constructor(</span>
<span class="nc" id="L32">    private val autoSaveConflictResolver: AutoSaveConflictResolver,</span>
<span class="nc" id="L33">    private val labelColorUseCase: PostPageListLabelColorUseCase,</span>
<span class="nc" id="L34">    private val uploadUtilsWrapper: UploadUtilsWrapper</span>
) {
    fun createLabels(postModel: PostModel, uploadUiState: PostUploadUiState): Pair&lt;List&lt;UiString&gt;, LabelColor&gt; {
<span class="nc" id="L37">        val hasUnhandledAutoSave = autoSaveConflictResolver.hasUnhandledAutoSave(postModel)</span>
<span class="nc" id="L38">        val hasUnhandledConflicts = false // version conflicts aren't currently supported on page list</span>
<span class="nc" id="L39">        val labels = getLabels(</span>
<span class="nc" id="L40">                PostStatus.fromPost(postModel),</span>
<span class="nc" id="L41">                postModel.isLocalDraft,</span>
<span class="nc" id="L42">                postModel.isLocallyChanged,</span>
<span class="nc" id="L43">                uploadUiState,</span>
<span class="nc" id="L44">                hasUnhandledConflicts,</span>
<span class="nc" id="L45">                hasUnhandledAutoSave</span>
        )
<span class="nc" id="L47">        val labelColor = labelColorUseCase.getLabelsColor(</span>
<span class="nc" id="L48">                postModel,</span>
<span class="nc" id="L49">                uploadUiState,</span>
<span class="nc" id="L50">                hasUnhandledConflicts,</span>
<span class="nc" id="L51">                hasUnhandledAutoSave</span>
        )
<span class="nc" id="L53">        return Pair(labels, labelColor)</span>
    }

    private fun getLabels(
        postStatus: PostStatus,
        isLocalDraft: Boolean,
        isLocallyChanged: Boolean,
        uploadUiState: PostUploadUiState,
        hasUnhandledConflicts: Boolean,
        hasAutoSave: Boolean
    ): List&lt;UiString&gt; {
<span class="nc" id="L64">        val labels: MutableList&lt;UiString&gt; = ArrayList()</span>
<span class="nc" id="L65">        when {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            uploadUiState is UploadFailed -&gt; {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                getErrorLabel(uploadUiState, postStatus)?.let { labels.add(it) }</span>
            }
<span class="nc bnc" id="L69" title="All 4 branches missed.">            uploadUiState is UploadingPost -&gt; if (uploadUiState.isDraft) {</span>
<span class="nc" id="L70">                labels.add(UiStringRes(R.string.page_uploading_draft))</span>
            } else {
<span class="nc" id="L72">                labels.add(UiStringRes(R.string.page_uploading))</span>
            }
<span class="nc bnc" id="L74" title="All 2 branches missed.">            uploadUiState is UploadingMedia -&gt; labels.add(UiStringRes(R.string.uploading_media))</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">            uploadUiState is UploadQueued -&gt; labels.add(UiStringRes(R.string.page_queued))</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            uploadUiState is UploadWaitingForConnection -&gt; {</span>
<span class="nc bnc" id="L77" title="All 7 branches missed.">                when (uploadUiState.postStatus) {</span>
<span class="nc" id="L78">                    UNKNOWN, PUBLISHED -&gt; labels.add(UiStringRes(R.string.page_waiting_for_connection_publish))</span>
<span class="nc" id="L79">                    PRIVATE -&gt; labels.add(UiStringRes(R.string.page_waiting_for_connection_private))</span>
<span class="nc" id="L80">                    PENDING -&gt; labels.add(UiStringRes(R.string.page_waiting_for_connection_pending))</span>
<span class="nc" id="L81">                    SCHEDULED -&gt; labels.add(UiStringRes(R.string.page_waiting_for_connection_scheduled))</span>
<span class="nc" id="L82">                    DRAFT -&gt; labels.add(UiStringRes(R.string.page_waiting_for_connection_draft))</span>
<span class="nc" id="L83">                    TRASHED -&gt; AppLog.e(</span>
<span class="nc" id="L84">                            PAGES,</span>
<span class="nc" id="L85">                            &quot;Developer error: This state shouldn't happen. Trashed pages is in &quot; +</span>
                                    &quot;UploadWaitingForConnection state.&quot;
                    )
                }
            }
<span class="nc bnc" id="L90" title="All 2 branches missed.">            hasUnhandledConflicts -&gt; labels.add(UiStringRes(R.string.local_page_is_conflicted))</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            hasAutoSave -&gt; labels.add(UiStringRes(R.string.local_page_autosave_revision_available))</span>
        }

        // we want to show either single error/progress label or 0-n info labels.
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (labels.isEmpty()) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (isLocalDraft) {</span>
<span class="nc" id="L97">                labels.add(UiStringRes(R.string.page_local_draft))</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            } else if (isLocallyChanged) {</span>
<span class="nc" id="L99">                labels.add(UiStringRes(R.string.page_local_changes))</span>
            }
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (postStatus == PRIVATE) {</span>
<span class="nc" id="L102">                labels.add(UiStringRes(R.string.page_status_page_private))</span>
            }
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (postStatus == PENDING) {</span>
<span class="nc" id="L105">                labels.add(UiStringRes(R.string.page_status_pending_review))</span>
            }
        }
<span class="nc" id="L108">        return labels</span>
    }

    private fun getErrorLabel(uploadUiState: UploadFailed, postStatus: PostStatus): UiString? {
<span class="nc" id="L112">        return when {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            uploadUiState.error.mediaError != null -&gt; getMediaUploadErrorLabel(</span>
<span class="nc" id="L114">                    uploadUiState,</span>
<span class="nc" id="L115">                    postStatus</span>
            )
<span class="nc bnc" id="L117" title="All 2 branches missed.">            uploadUiState.error.postError != null -&gt; uploadUtilsWrapper.getErrorMessageResIdFromPostError(</span>
<span class="nc" id="L118">                    postStatus,</span>
<span class="nc" id="L119">                    true,</span>
<span class="nc" id="L120">                    uploadUiState.error.postError,</span>
<span class="nc" id="L121">                    uploadUiState.isEligibleForAutoUpload</span>
            )
            else -&gt; {
<span class="nc" id="L124">                val errorMsg = &quot;MediaError and postError are both null.&quot;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                if (BuildConfig.DEBUG) {</span>
<span class="nc" id="L126">                    throw IllegalStateException(errorMsg)</span>
                } else {
<span class="nc" id="L128">                    AppLog.e(PAGES, errorMsg)</span>
                }
<span class="nc" id="L130">                UiStringRes(R.string.error_generic)</span>
            }
        }
    }

    private fun getMediaUploadErrorLabel(
        uploadUiState: UploadFailed,
        postStatus: PostStatus
    ): UiStringRes {
<span class="nc" id="L139">        return when {</span>
<span class="nc bnc" id="L140" title="All 7 branches missed.">            uploadUiState.isEligibleForAutoUpload -&gt; when (postStatus) {</span>
<span class="nc" id="L141">                PUBLISHED -&gt; UiStringRes(R.string.error_media_recover_page_not_published_retrying)</span>
<span class="nc" id="L142">                PRIVATE -&gt; UiStringRes(R.string.error_media_recover_page_not_published_retrying_private)</span>
<span class="nc" id="L143">                SCHEDULED -&gt; UiStringRes(R.string.error_media_recover_page_not_scheduled_retrying)</span>
<span class="nc" id="L144">                PENDING -&gt; UiStringRes(R.string.error_media_recover_page_not_submitted_retrying)</span>
<span class="nc" id="L145">                DRAFT, TRASHED, UNKNOWN -&gt; UiStringRes(R.string.error_generic_error_retrying)</span>
            }
<span class="nc bnc" id="L147" title="All 7 branches missed.">            uploadUiState.retryWillPushChanges -&gt; when (postStatus) {</span>
<span class="nc" id="L148">                PUBLISHED -&gt; UiStringRes(R.string.error_media_recover_page_not_published)</span>
<span class="nc" id="L149">                PRIVATE -&gt; UiStringRes(R.string.error_media_recover_page_not_published_private)</span>
<span class="nc" id="L150">                SCHEDULED -&gt; UiStringRes(R.string.error_media_recover_page_not_scheduled)</span>
<span class="nc" id="L151">                PENDING -&gt; UiStringRes(R.string.error_media_recover_page_not_submitted)</span>
<span class="nc" id="L152">                DRAFT, TRASHED, UNKNOWN -&gt; UiStringRes(R.string.error_media_recover_page)</span>
            }
<span class="nc" id="L154">            else -&gt; UiStringRes(R.string.error_media_recover_page)</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>