<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SelectedDateProvider.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stats.refresh.lists.sections.granular</a> &gt; <span class="el_source">SelectedDateProvider.kt</span></div><h1>SelectedDateProvider.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stats.refresh.lists.sections.granular

import android.annotation.SuppressLint
import android.os.Bundle
import android.os.Parcel
import android.os.Parcelable
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.parcelize.Parceler
import kotlinx.parcelize.Parcelize
import org.wordpress.android.analytics.AnalyticsTracker.Stat.STATS_NEXT_DATE_TAPPED
import org.wordpress.android.analytics.AnalyticsTracker.Stat.STATS_PREVIOUS_DATE_TAPPED
import org.wordpress.android.fluxc.network.utils.StatsGranularity
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.DAYS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.MONTHS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.WEEKS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.YEARS
import org.wordpress.android.ui.stats.refresh.utils.StatsDateFormatter
import org.wordpress.android.ui.stats.refresh.utils.toStatsSection
import org.wordpress.android.ui.stats.refresh.utils.trackWithSection
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.util.filter
import java.util.Date
import javax.inject.Inject
import javax.inject.Singleton

private const val SELECTED_DATE_STATE_KEY = &quot;selected_date_key&quot;

<span class="nc" id="L30">@Singleton</span>
class SelectedDateProvider
<span class="nc" id="L32">@Inject constructor(</span>
<span class="nc" id="L33">    private val statsDateFormatter: StatsDateFormatter,</span>
<span class="nc" id="L34">    private val analyticsTrackerWrapper: AnalyticsTrackerWrapper</span>
) {
<span class="nc" id="L36">    private val mutableDates = mutableMapOf(</span>
<span class="nc" id="L37">            DAYS to SelectedDate(loading = true),</span>
<span class="nc" id="L38">            WEEKS to SelectedDate(loading = true),</span>
<span class="nc" id="L39">            MONTHS to SelectedDate(loading = true),</span>
<span class="nc" id="L40">            YEARS to SelectedDate(loading = true)</span>
    )

<span class="nc" id="L43">    private val selectedDateChanged = MutableLiveData&lt;SectionChange?&gt;()</span>

    fun granularSelectedDateChanged(statsSection: StatsSection): LiveData&lt;SectionChange?&gt; {
<span class="nc bnc" id="L46" title="All 4 branches missed.">        return selectedDateChanged.filter { it?.selectedSection == statsSection }</span>
    }

    fun selectDate(date: Date, statsSection: StatsSection) {
<span class="nc" id="L50">        val selectedDate = getSelectedDateState(statsSection)</span>
<span class="nc" id="L51">        updateSelectedDate(selectedDate.copy(dateValue = date), statsSection)</span>
<span class="nc" id="L52">    }</span>

    fun selectDate(date: Date, statsGranularity: StatsGranularity) {
<span class="nc" id="L55">        selectDate(date, statsGranularity.toStatsSection())</span>
<span class="nc" id="L56">    }</span>

    fun selectDate(updatedDate: Date, availableDates: List&lt;Date&gt;, statsSection: StatsSection) {
<span class="nc" id="L59">        val selectedDate = getSelectedDateState(statsSection)</span>
<span class="nc bnc" id="L60" title="All 4 branches missed.">        if (selectedDate.dateValue != updatedDate || selectedDate.availableDates != availableDates) {</span>
<span class="nc" id="L61">            updateSelectedDate(</span>
<span class="nc" id="L62">                    selectedDate.copy(dateValue = updatedDate, availableDates = availableDates),</span>
<span class="nc" id="L63">                    statsSection</span>
            )
        }
<span class="nc" id="L66">    }</span>

    fun selectDate(updatedDate: Date, availableDates: List&lt;Date&gt;, statsGranularity: StatsGranularity) {
<span class="nc" id="L69">        selectDate(updatedDate, availableDates, statsGranularity.toStatsSection())</span>
<span class="nc" id="L70">    }</span>

    fun updateSelectedDate(selectedDate: SelectedDate, statsSection: StatsSection) {
<span class="nc" id="L73">        val currentDate = mutableDates[statsSection]</span>
<span class="nc" id="L74">        mutableDates[statsSection] = selectedDate</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (selectedDate != currentDate) {</span>
<span class="nc" id="L76">            selectedDateChanged.postValue(SectionChange(statsSection))</span>
        }
<span class="nc" id="L78">    }</span>

    fun setInitialSelectedPeriod(statsGranularity: StatsGranularity, period: String) {
<span class="nc" id="L81">        val updatedDate = statsDateFormatter.parseStatsDate(statsGranularity, period)</span>
<span class="nc" id="L82">        val selectedDate = getSelectedDateState(statsGranularity)</span>
<span class="nc" id="L83">        updateSelectedDate(selectedDate.copy(dateValue = updatedDate), statsGranularity.toStatsSection())</span>
<span class="nc" id="L84">    }</span>

    fun getSelectedDate(statsGranularity: StatsGranularity): Date? {
<span class="nc" id="L87">        return getSelectedDate(statsGranularity.toStatsSection())</span>
    }

    fun getSelectedDate(statsSection: StatsSection): Date? {
<span class="nc" id="L91">        return getSelectedDateState(statsSection).dateValue</span>
    }

    fun getSelectedDateState(statsGranularity: StatsGranularity): SelectedDate {
<span class="nc" id="L95">        return getSelectedDateState(statsGranularity.toStatsSection())</span>
    }

    fun getSelectedDateState(statsSection: StatsSection): SelectedDate {
<span class="nc bnc" id="L99" title="All 2 branches missed.">        return mutableDates[statsSection] ?: SelectedDate(loading = true)</span>
    }

    fun hasPreviousDate(statsSection: StatsSection): Boolean {
<span class="nc" id="L103">        val selectedDate = getSelectedDateState(statsSection)</span>
<span class="nc bnc" id="L104" title="All 4 branches missed.">        return selectedDate.hasData() &amp;&amp; selectedDate.getDateIndex() &gt; 0</span>
    }

    fun hasNextDate(statsSection: StatsSection): Boolean {
<span class="nc" id="L108">        val selectedDate = getSelectedDateState(statsSection)</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        return selectedDate.hasData() &amp;&amp;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                selectedDate.getDateIndex() &lt; selectedDate.availableDates.size - 1</span>
    }

    fun selectPreviousDate(statsSection: StatsSection) {
<span class="nc" id="L114">        val selectedDateState = getSelectedDateState(statsSection)</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (selectedDateState.hasData()) {</span>
<span class="nc" id="L116">            analyticsTrackerWrapper.trackWithSection(STATS_PREVIOUS_DATE_TAPPED, statsSection)</span>
<span class="nc" id="L117">            updateSelectedDate(selectedDateState.copy(dateValue = selectedDateState.getPreviousDate()), statsSection)</span>
        }
<span class="nc" id="L119">    }</span>

    fun selectNextDate(statsSection: StatsSection) {
<span class="nc" id="L122">        val selectedDateState = getSelectedDateState(statsSection)</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (selectedDateState.hasData()) {</span>
<span class="nc" id="L124">            analyticsTrackerWrapper.trackWithSection(STATS_NEXT_DATE_TAPPED, statsSection)</span>
<span class="nc" id="L125">            updateSelectedDate(selectedDateState.copy(dateValue = selectedDateState.getNextDate()), statsSection)</span>
        }
<span class="nc" id="L127">    }</span>

    fun onDateLoadingFailed(statsGranularity: StatsGranularity) {
<span class="nc" id="L130">        onDateLoadingFailed(statsGranularity.toStatsSection())</span>
<span class="nc" id="L131">    }</span>

    fun onDateLoadingFailed(statsSection: StatsSection) {
<span class="nc" id="L134">        val selectedDate = getSelectedDateState(statsSection)</span>
<span class="nc bnc" id="L135" title="All 4 branches missed.">        if (selectedDate.dateValue != null &amp;&amp; !selectedDate.error) {</span>
<span class="nc" id="L136">            updateSelectedDate(selectedDate.copy(error = true, loading = false), statsSection)</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        } else if (selectedDate.dateValue == null) {</span>
<span class="nc" id="L138">            updateSelectedDate(SelectedDate(error = true, loading = false), statsSection)</span>
        }
<span class="nc" id="L140">    }</span>

    fun onDateLoadingSucceeded(statsGranularity: StatsGranularity) {
<span class="nc" id="L143">        onDateLoadingSucceeded(statsGranularity.toStatsSection())</span>
<span class="nc" id="L144">    }</span>

    fun onDateLoadingSucceeded(statsSection: StatsSection) {
<span class="nc" id="L147">        val selectedDate = getSelectedDateState(statsSection)</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">        if (selectedDate.dateValue != null &amp;&amp; selectedDate.error) {</span>
<span class="nc" id="L149">            updateSelectedDate(selectedDate.copy(error = false, loading = false), statsSection)</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        } else if (selectedDate.dateValue == null) {</span>
<span class="nc" id="L151">            updateSelectedDate(SelectedDate(error = false, loading = false), statsSection)</span>
        }
<span class="nc" id="L153">    }</span>

<span class="nc" id="L155">    fun getCurrentDate() = Date()</span>

    fun clear() {
<span class="nc" id="L158">        mutableDates.clear()</span>
<span class="nc" id="L159">        selectedDateChanged.value = null</span>
<span class="nc" id="L160">    }</span>

    fun clear(statsSection: StatsSection) {
<span class="nc" id="L163">        mutableDates[statsSection] = SelectedDate(loading = true)</span>
<span class="nc" id="L164">        selectedDateChanged.value = null</span>
<span class="nc" id="L165">    }</span>

    fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L168">        mutableDates.entries.forEach { (key, value) -&gt;</span>
<span class="nc" id="L169">            outState.putParcelable(buildStateKey(key), value)</span>
<span class="nc" id="L170">        }</span>
<span class="nc" id="L171">    }</span>

    fun onRestoreInstanceState(savedState: Bundle) {
<span class="nc bnc" id="L174" title="All 2 branches missed.">        for (period in listOf(DAYS, WEEKS, MONTHS, YEARS)) {</span>
<span class="nc" id="L175">            val selectedDate: SelectedDate? = savedState.getParcelable(buildStateKey(period)) as SelectedDate?</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (selectedDate != null) {</span>
<span class="nc" id="L177">                mutableDates[period] = selectedDate</span>
            }
        }
<span class="nc" id="L180">    }</span>

<span class="nc" id="L182">    private fun buildStateKey(key: StatsSection) = SELECTED_DATE_STATE_KEY + key</span>

<span class="nc" id="L184">    @Parcelize</span>
    @SuppressLint(&quot;ParcelCreator&quot;)
<span class="nc" id="L186">    data class SelectedDate(</span>
<span class="nc" id="L187">        val dateValue: Date? = null,</span>
<span class="nc" id="L188">        val availableDates: List&lt;Date&gt; = listOf(),</span>
<span class="nc" id="L189">        val loading: Boolean = false,</span>
<span class="nc" id="L190">        val error: Boolean = false</span>
    ) : Parcelable {
<span class="nc bnc" id="L192" title="All 4 branches missed.">        fun hasData(): Boolean = dateValue != null &amp;&amp; availableDates.contains(dateValue)</span>
<span class="nc" id="L193">        fun getDate() = dateValue!!</span>
        fun getDateIndex(): Int {
<span class="nc" id="L195">            return availableDates.indexOf(dateValue)</span>
        }

        fun getPreviousDate(): Date? {
<span class="nc" id="L199">            val dateIndex = getDateIndex()</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            return if (dateIndex &gt; 0) {</span>
<span class="nc" id="L201">                availableDates[dateIndex - 1]</span>
            } else {
<span class="nc" id="L203">                null</span>
            }
        }

        fun getNextDate(): Date? {
<span class="nc" id="L208">            val dateIndex = getDateIndex()</span>
<span class="nc bnc" id="L209" title="All 4 branches missed.">            return if (dateIndex &gt; -1 &amp;&amp; dateIndex &lt; availableDates.size - 1) {</span>
<span class="nc" id="L210">                availableDates[dateIndex + 1]</span>
            } else {
<span class="nc" id="L212">                null</span>
            }
        }

<span class="nc" id="L216">        companion object : Parceler&lt;SelectedDate&gt; {</span>
            @SuppressLint(&quot;ParcelClassLoader&quot;)
            override fun create(parcel: Parcel): SelectedDate {
<span class="nc" id="L219">                val dateTimeStamp = parcel.readLong()</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                val date = if (dateTimeStamp &gt; -1) {</span>
<span class="nc" id="L221">                    Date(dateTimeStamp)</span>
                } else {
<span class="nc" id="L223">                    null</span>
                }
<span class="nc" id="L225">                val availableTimeStamps = mutableListOf&lt;Any?&gt;()</span>
<span class="nc" id="L226">                parcel.readList(availableTimeStamps, null)</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                val availableDates = availableTimeStamps.map { Date(it as Long) }</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                val loading = parcel.readValue(null) as Boolean</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                val error = parcel.readValue(null) as Boolean</span>
<span class="nc" id="L230">                return SelectedDate(date, availableDates, loading, error)</span>
            }

            override fun SelectedDate.write(parcel: Parcel, flags: Int) {
<span class="nc bnc" id="L234" title="All 2 branches missed.">                parcel.writeLong(dateValue?.time ?: -1)</span>
<span class="nc" id="L235">                parcel.writeList(availableDates.map { it.time })</span>
<span class="nc" id="L236">                parcel.writeValue(loading)</span>
<span class="nc" id="L237">                parcel.writeValue(error)</span>
<span class="nc" id="L238">            }</span>
        }
<span class="nc" id="L240">    }</span>

<span class="nc" id="L242">    data class SectionChange(val selectedSection: StatsSection)</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>