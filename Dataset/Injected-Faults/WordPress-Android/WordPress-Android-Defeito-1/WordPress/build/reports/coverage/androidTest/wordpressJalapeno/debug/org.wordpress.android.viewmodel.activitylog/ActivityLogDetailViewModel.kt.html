<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ActivityLogDetailViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.viewmodel.activitylog</a> &gt; <span class="el_source">ActivityLogDetailViewModel.kt</span></div><h1>ActivityLogDetailViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.viewmodel.activitylog

import android.text.SpannableString
import android.text.Spanned
import android.text.style.ClickableSpan
import android.view.View
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import org.wordpress.android.R
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.model.activity.ActivityLogModel.ActivityActor
import org.wordpress.android.fluxc.store.ActivityLogStore
import org.wordpress.android.fluxc.tools.FormattableRange
import org.wordpress.android.ui.activitylog.detail.ActivityLogDetailModel
import org.wordpress.android.ui.activitylog.detail.ActivityLogDetailNavigationEvents
import org.wordpress.android.ui.activitylog.detail.ActivityLogDetailNavigationEvents.ShowDocumentationPage
import org.wordpress.android.ui.utils.HtmlMessageUtils
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T.ACTIVITY_LOG
import org.wordpress.android.util.extensions.toFormattedDateString
import org.wordpress.android.util.extensions.toFormattedTimeString
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ResourceProvider
import org.wordpress.android.viewmodel.SingleLiveEvent
import javax.inject.Inject

const val ACTIVITY_LOG_ID_KEY: String = &quot;activity_log_id_key&quot;
const val ACTIVITY_LOG_ARE_BUTTONS_VISIBLE_KEY: String = &quot;activity_log_are_buttons_visible_key&quot;
const val ACTIVITY_LOG_IS_RESTORE_HIDDEN_KEY: String = &quot;activity_log_is_restore_hidden_key&quot;

<span class="nc" id="L33">class ActivityLogDetailViewModel @Inject constructor(</span>
<span class="nc" id="L34">    val dispatcher: Dispatcher,</span>
<span class="nc" id="L35">    private val activityLogStore: ActivityLogStore,</span>
<span class="nc" id="L36">    private val resourceProvider: ResourceProvider,</span>
<span class="nc" id="L37">    private val htmlMessageUtils: HtmlMessageUtils</span>
<span class="nc" id="L38">) : ViewModel() {</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">    lateinit var site: SiteModel</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">    lateinit var activityLogId: String</span>
<span class="nc" id="L41">    var areButtonsVisible = false</span>
<span class="nc" id="L42">    var isRestoreHidden = false</span>

<span class="nc" id="L44">    private val _navigationEvents = MutableLiveData&lt;Event&lt;ActivityLogDetailNavigationEvents&gt;&gt;()</span>
    val navigationEvents: LiveData&lt;Event&lt;ActivityLogDetailNavigationEvents&gt;&gt;
<span class="nc" id="L46">        get() = _navigationEvents</span>

<span class="nc" id="L48">    private val _handleFormattableRangeClick = SingleLiveEvent&lt;FormattableRange&gt;()</span>
    val handleFormattableRangeClick: LiveData&lt;FormattableRange&gt;
<span class="nc" id="L50">        get() = _handleFormattableRangeClick</span>

<span class="nc" id="L52">    private val _item = MutableLiveData&lt;ActivityLogDetailModel&gt;()</span>
    val activityLogItem: LiveData&lt;ActivityLogDetailModel&gt;
<span class="nc" id="L54">        get() = _item</span>

<span class="nc" id="L56">    private val _restoreVisible = MutableLiveData&lt;Boolean&gt;()</span>
    val restoreVisible: LiveData&lt;Boolean&gt;
<span class="nc" id="L58">        get() = _restoreVisible</span>

<span class="nc" id="L60">    private val _downloadBackupVisible = MutableLiveData&lt;Boolean&gt;()</span>
    val downloadBackupVisible: LiveData&lt;Boolean&gt;
<span class="nc" id="L62">        get() = _downloadBackupVisible</span>

<span class="nc" id="L64">    private val _multisiteVisible = MutableLiveData&lt;Pair&lt;Boolean, SpannableString?&gt;&gt;()</span>
    val multisiteVisible: LiveData&lt;Pair&lt;Boolean, SpannableString?&gt;&gt;
<span class="nc" id="L66">        get() = _multisiteVisible</span>

    fun start(
        site: SiteModel,
        activityLogId: String,
        areButtonsVisible: Boolean,
        isRestoreHidden: Boolean
    ) {
<span class="nc" id="L74">        this.site = site</span>
<span class="nc" id="L75">        this.activityLogId = activityLogId</span>
<span class="nc" id="L76">        this.areButtonsVisible = areButtonsVisible</span>
<span class="nc" id="L77">        this.isRestoreHidden = isRestoreHidden</span>

<span class="nc bnc" id="L79" title="All 4 branches missed.">        _restoreVisible.value = areButtonsVisible &amp;&amp; !isRestoreHidden</span>
<span class="nc" id="L80">        _downloadBackupVisible.value = areButtonsVisible</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        _multisiteVisible.value = if (isRestoreHidden) Pair(true, getMultisiteMessage()) else Pair(false, null)</span>

<span class="nc bnc" id="L83" title="All 4 branches missed.">        if (activityLogId != _item.value?.activityID) {</span>
<span class="nc" id="L84">            _item.value = activityLogStore</span>
<span class="nc" id="L85">                    .getActivityLogForSite(site)</span>
<span class="nc bnc" id="L86" title="All 6 branches missed.">                    .find { it.activityID == activityLogId }</span>
<span class="nc" id="L87">                    ?.let {</span>
<span class="nc" id="L88">                        ActivityLogDetailModel(</span>
<span class="nc" id="L89">                                activityID = it.activityID,</span>
<span class="nc" id="L90">                                rewindId = it.rewindID,</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                                actorIconUrl = it.actor?.avatarURL,</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                                showJetpackIcon = it.actor?.showJetpackIcon(),</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                                isRewindButtonVisible = it.rewindable ?: false,</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">                                actorName = it.actor?.displayName,</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                                actorRole = it.actor?.role,</span>
<span class="nc" id="L96">                                content = it.content,</span>
<span class="nc" id="L97">                                summary = it.summary,</span>
<span class="nc" id="L98">                                createdDate = it.published.toFormattedDateString(),</span>
<span class="nc" id="L99">                                createdTime = it.published.toFormattedTimeString()</span>
                        )
                    }
        }
<span class="nc" id="L103">    }</span>

    private fun getMultisiteMessage(): SpannableString {
<span class="nc" id="L106">        val clickableText = resourceProvider.getString(R.string.activity_log_visit_our_documentation_page)</span>
<span class="nc" id="L107">        val multisiteMessage = htmlMessageUtils.getHtmlMessageFromStringFormatResId(</span>
<span class="nc" id="L108">                R.string.activity_log_multisite_message,</span>
<span class="nc" id="L109">                clickableText</span>
        )
<span class="nc" id="L111">        return constructMultisiteSpan(multisiteMessage, clickableText)</span>
    }

    private fun constructMultisiteSpan(
        multisiteMessage: CharSequence,
        clickableText: String
    ): SpannableString {
<span class="nc" id="L118">        val clickableSpan = object : ClickableSpan() {</span>
            override fun onClick(widget: View) {
<span class="nc" id="L120">                _navigationEvents.postValue(Event(ShowDocumentationPage()))</span>
<span class="nc" id="L121">            }</span>
        }
<span class="nc" id="L123">        val clickableStartIndex = multisiteMessage.indexOf(clickableText)</span>
<span class="nc" id="L124">        val clickableEndIndex = clickableStartIndex + clickableText.length</span>
<span class="nc" id="L125">        val multisiteSpan = SpannableString(multisiteMessage)</span>
<span class="nc" id="L126">        multisiteSpan.setSpan(clickableSpan, clickableStartIndex, clickableEndIndex, Spanned.SPAN_EXCLUSIVE_EXCLUSIVE)</span>
<span class="nc" id="L127">        return multisiteSpan</span>
    }

    fun onRangeClicked(range: FormattableRange) {
<span class="nc" id="L131">        _handleFormattableRangeClick.value = range</span>
<span class="nc" id="L132">    }</span>

    fun onRestoreClicked(model: ActivityLogDetailModel) {
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (model.rewindId != null) {</span>
<span class="nc" id="L136">            _navigationEvents.value = Event(ActivityLogDetailNavigationEvents.ShowRestore(model))</span>
        } else {
<span class="nc" id="L138">            AppLog.e(ACTIVITY_LOG, &quot;Trying to restore activity without rewind ID&quot;)</span>
        }
<span class="nc" id="L140">    }</span>

    fun onDownloadBackupClicked(model: ActivityLogDetailModel) {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (model.rewindId != null) {</span>
<span class="nc" id="L144">            _navigationEvents.value = Event(ActivityLogDetailNavigationEvents.ShowBackupDownload(model))</span>
        } else {
<span class="nc" id="L146">            AppLog.e(ACTIVITY_LOG, &quot;Trying to download backup activity without rewind ID&quot;)</span>
        }
<span class="nc" id="L148">    }</span>

    private fun ActivityActor.showJetpackIcon(): Boolean {
<span class="nc bnc" id="L151" title="All 4 branches missed.">        return displayName == &quot;Jetpack&quot; &amp;&amp; type == &quot;Application&quot; ||</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">                displayName == &quot;Happiness Engineer&quot; &amp;&amp; type == &quot;Happiness Engineer&quot;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>