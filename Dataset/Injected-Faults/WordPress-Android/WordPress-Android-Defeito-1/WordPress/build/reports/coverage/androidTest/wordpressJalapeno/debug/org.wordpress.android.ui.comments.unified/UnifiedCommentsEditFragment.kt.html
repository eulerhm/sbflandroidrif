<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UnifiedCommentsEditFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.comments.unified</a> &gt; <span class="el_source">UnifiedCommentsEditFragment.kt</span></div><h1>UnifiedCommentsEditFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.comments.unified

import android.app.Activity.RESULT_OK
import android.os.Bundle
import android.view.Menu
import android.view.MenuInflater
import android.view.MenuItem
import android.view.View
import androidx.activity.OnBackPressedCallback
import androidx.appcompat.app.AppCompatActivity
import androidx.core.widget.doAfterTextChanged
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.UnifiedCommentsEditFragmentBinding
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.ui.ActivityId
import org.wordpress.android.ui.ActivityId.COMMENT_EDITOR
import org.wordpress.android.ui.comments.unified.EditCancelDialogFragment.Companion.EDIT_CANCEL_DIALOG_TAG
import org.wordpress.android.ui.comments.unified.UnifiedCommentsEditViewModel.EditCommentActionEvent.CANCEL_EDIT_CONFIRM
import org.wordpress.android.ui.comments.unified.UnifiedCommentsEditViewModel.EditCommentActionEvent.CLOSE
import org.wordpress.android.ui.comments.unified.UnifiedCommentsEditViewModel.EditCommentActionEvent.DONE
import org.wordpress.android.ui.comments.unified.UnifiedCommentsEditViewModel.FieldType.COMMENT
import org.wordpress.android.ui.comments.unified.UnifiedCommentsEditViewModel.FieldType.USER_EMAIL
import org.wordpress.android.ui.comments.unified.UnifiedCommentsEditViewModel.FieldType.USER_NAME
import org.wordpress.android.ui.comments.unified.UnifiedCommentsEditViewModel.FieldType.WEB_ADDRESS
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.ActivityUtils
import org.wordpress.android.util.SnackbarItem
import org.wordpress.android.util.SnackbarItem.Action
import org.wordpress.android.util.SnackbarItem.Info
import org.wordpress.android.util.SnackbarSequencer
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

<span class="nc" id="L39">class UnifiedCommentsEditFragment : Fragment(R.layout.unified_comments_edit_fragment) {</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">    @Inject lateinit var snackbarSequencer: SnackbarSequencer</span>

    private lateinit var viewModel: UnifiedCommentsEditViewModel

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L47">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc" id="L49">        viewModel = ViewModelProvider(this, viewModelFactory).get(UnifiedCommentsEditViewModel::class.java)</span>

<span class="nc" id="L51">        ActivityId.trackLastActivity(COMMENT_EDITOR)</span>
<span class="nc" id="L52">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L55">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc bnc" id="L57" title="All 2 branches missed.">        val site = requireArguments().getSerializable(WordPress.SITE) as SiteModel</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        val commentIdentifier = requireNotNull(</span>
<span class="nc" id="L59">                requireArguments().getParcelable&lt;CommentIdentifier&gt;(</span>
<span class="nc" id="L60">                        KEY_COMMENT_IDENTIFIER</span>
                )
        )

<span class="nc" id="L64">        UnifiedCommentsEditFragmentBinding.bind(view).apply {</span>
<span class="nc" id="L65">            setupToolbar()</span>
<span class="nc" id="L66">            setupObservers(site, commentIdentifier)</span>
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">    }</span>

    private fun UnifiedCommentsEditFragmentBinding.setupToolbar() {
<span class="nc" id="L71">        setHasOptionsMenu(true)</span>

<span class="nc" id="L73">        val activity = (requireActivity() as AppCompatActivity)</span>
<span class="nc" id="L74">        activity.setSupportActionBar(toolbarMain)</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        activity.supportActionBar?.let {</span>
<span class="nc" id="L76">            it.setHomeButtonEnabled(true)</span>
<span class="nc" id="L77">            it.setDisplayHomeAsUpEnabled(true)</span>
<span class="nc" id="L78">            it.setHomeAsUpIndicator(R.drawable.ic_cross_white_24dp)</span>
<span class="nc" id="L79">        }</span>
<span class="nc" id="L80">        activity.onBackPressedDispatcher.addCallback(</span>
<span class="nc" id="L81">                viewLifecycleOwner,</span>
<span class="nc" id="L82">                object : OnBackPressedCallback(</span>
<span class="nc" id="L83">                        true</span>
                ) {
                    override fun handleOnBackPressed() {
<span class="nc bnc" id="L86" title="All 2 branches missed.">                        viewModel.onBackPressed()</span>
<span class="nc" id="L87">                    }</span>
                })
<span class="nc" id="L89">    }</span>

    private fun hideKeyboard() {
<span class="nc bnc" id="L92" title="All 4 branches missed.">        if (!isAdded || view == null) return</span>
<span class="nc" id="L93">        ActivityUtils.hideKeyboardForced(view)</span>
<span class="nc" id="L94">    }</span>

    private fun UnifiedCommentsEditFragmentBinding.setupObservers(
        site: SiteModel,
        commentIdentifier: CommentIdentifier
    ) {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        viewModel.uiActionEvent.observeEvent(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L101" title="All 4 branches missed.">            when (it) {</span>
                CLOSE -&gt; {
<span class="nc" id="L103">                    requireActivity().finish()</span>
                }
                DONE -&gt; {
<span class="nc" id="L106">                    requireActivity().apply {</span>
<span class="nc" id="L107">                        setResult(RESULT_OK)</span>
<span class="nc" id="L108">                        finish()</span>
<span class="nc" id="L109">                    }</span>
                }
                CANCEL_EDIT_CONFIRM -&gt; {
<span class="nc" id="L112">                    EditCancelDialogFragment.newInstance().show(childFragmentManager, EDIT_CANCEL_DIALOG_TAG)</span>
                }
            }
<span class="nc" id="L115">        })</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">        viewModel.onSnackbarMessage.observeEvent(viewLifecycleOwner, { messageHolder -&gt;</span>
<span class="nc" id="L118">            showSnackbar(messageHolder)</span>
<span class="nc" id="L119">        })</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner, { uiState -&gt;</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (uiState.showProgress) {</span>
<span class="nc" id="L123">                loadingView.visibility = View.VISIBLE</span>
<span class="nc" id="L124">                scrollView.visibility = View.GONE</span>
<span class="nc" id="L125">                uiHelpers.setTextOrHide(progressText, uiState.progressText)</span>

<span class="nc" id="L127">                hideKeyboard()</span>
            } else {
<span class="nc" id="L129">                loadingView.visibility = View.GONE</span>
<span class="nc" id="L130">                scrollView.visibility = View.VISIBLE</span>
            }

<span class="nc bnc" id="L133" title="All 2 branches missed.">            if (uiState.shouldInitComment) {</span>
<span class="nc" id="L134">                uiState.originalComment.let {</span>
<span class="nc" id="L135">                    userName.setText(it.userName)</span>
<span class="nc" id="L136">                    commentEditWebAddress.setText(it.userUrl)</span>
<span class="nc" id="L137">                    commentEditEmailAddress.setText(it.userEmail)</span>
<span class="nc" id="L138">                    commentEditComment.setText(it.commentText)</span>
<span class="nc" id="L139">                }</span>
            }

<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (uiState.shouldInitWatchers) {</span>
<span class="nc" id="L143">                initTextWatchers()</span>
            }

<span class="nc" id="L146">            uiState.editErrorStrings.let { errors -&gt;</span>
<span class="nc" id="L147">                userName.error = errors.userNameError</span>
<span class="nc" id="L148">                commentEditWebAddress.error = errors.userUrlError</span>
<span class="nc" id="L149">                commentEditEmailAddress.error = errors.userEmailError</span>
<span class="nc" id="L150">                commentEditComment.error = errors.commentTextError</span>
<span class="nc" id="L151">            }</span>

<span class="nc" id="L153">            with(uiState.inputSettings) {</span>
<span class="nc" id="L154">                commentEditComment.isEnabled = enableEditComment</span>
<span class="nc" id="L155">                commentEditWebAddress.isEnabled = enableEditUrl</span>
<span class="nc" id="L156">                commentEditEmailAddress.isEnabled = enableEditEmail</span>
<span class="nc" id="L157">                userName.isEnabled = enableEditName</span>
<span class="nc" id="L158">            }</span>
<span class="nc" id="L159">        })</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        viewModel.start(site, commentIdentifier)</span>
<span class="nc" id="L162">    }</span>

    private fun UnifiedCommentsEditFragmentBinding.showSnackbar(holder: SnackbarMessageHolder) {
<span class="nc" id="L165">        snackbarSequencer.enqueue(</span>
<span class="nc" id="L166">                SnackbarItem(</span>
<span class="nc" id="L167">                        Info(</span>
<span class="nc" id="L168">                                view = coordinator,</span>
<span class="nc" id="L169">                                textRes = holder.message,</span>
<span class="nc" id="L170">                                duration = Snackbar.LENGTH_LONG</span>
                        ),
<span class="nc bnc" id="L172" title="All 2 branches missed.">                        holder.buttonTitle?.let {</span>
<span class="nc" id="L173">                            Action(</span>
<span class="nc" id="L174">                                    textRes = holder.buttonTitle,</span>
<span class="nc" id="L175">                                    clickListener = { holder.buttonAction() }</span>
                            )
                        },
<span class="nc" id="L178">                        dismissCallback = { _, event -&gt; holder.onDismissAction(event) }</span>
                )
        )
<span class="nc" id="L181">    }</span>

    private fun UnifiedCommentsEditFragmentBinding.initTextWatchers() {
<span class="nc" id="L184">        userName.doAfterTextChanged {</span>
            viewModel.onValidateField(it?.let { StringBuffer(it).toString() } ?: &quot;&quot;, USER_NAME)
        }

<span class="nc" id="L188">        commentEditWebAddress.doAfterTextChanged {</span>
            viewModel.onValidateField(it?.let { StringBuffer(it).toString() } ?: &quot;&quot;, WEB_ADDRESS)
        }

<span class="nc" id="L192">        commentEditEmailAddress.doAfterTextChanged {</span>
            viewModel.onValidateField(it?.let { StringBuffer(it).toString() } ?: &quot;&quot;, USER_EMAIL)
        }

<span class="nc" id="L196">        commentEditComment.doAfterTextChanged {</span>
            viewModel.onValidateField(it?.let { StringBuffer(it).toString() } ?: &quot;&quot;, COMMENT)
        }
<span class="nc" id="L199">    }</span>

    override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
<span class="nc" id="L202">        super.onCreateOptionsMenu(menu, inflater)</span>
<span class="nc" id="L203">        inflater.inflate(R.menu.edit_comment_menu, menu)</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">        menu.findItem(R.id.action_item)?.let { actionMenu -&gt;</span>
<span class="nc" id="L206">            actionMenu.setOnMenuItemClickListener {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                viewModel.onActionMenuClicked()</span>
<span class="nc" id="L208">                true</span>
            }

<span class="nc bnc" id="L211" title="All 2 branches missed.">            viewModel.uiState.observe(viewLifecycleOwner, { uiState -&gt;</span>
<span class="nc" id="L212">                actionMenu.isEnabled = uiState.canSaveChanges</span>
<span class="nc" id="L213">            })</span>
<span class="nc" id="L214">        }</span>
<span class="nc" id="L215">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc" id="L218">        when (item.itemId) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            android.R.id.home -&gt; {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                viewModel.onBackPressed()</span>
            }
        }
<span class="nc" id="L223">        return true</span>
    }

    companion object {
        private const val KEY_COMMENT_IDENTIFIER = &quot;key_comment_identifier&quot;

        fun newInstance(site: SiteModel, commentIdentifier: CommentIdentifier): UnifiedCommentsEditFragment {
<span class="nc" id="L230">            val args = Bundle()</span>

<span class="nc" id="L232">            args.putSerializable(WordPress.SITE, site)</span>
<span class="nc" id="L233">            args.putParcelable(KEY_COMMENT_IDENTIFIER, commentIdentifier)</span>

<span class="nc" id="L235">            val fragment = UnifiedCommentsEditFragment()</span>

<span class="nc" id="L237">            fragment.arguments = args</span>

<span class="nc" id="L239">            return fragment</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>