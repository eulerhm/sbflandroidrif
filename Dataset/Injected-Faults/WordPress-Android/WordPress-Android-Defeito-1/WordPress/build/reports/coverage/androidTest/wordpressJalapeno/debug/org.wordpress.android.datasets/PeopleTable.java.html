<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PeopleTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.datasets</a> &gt; <span class="el_source">PeopleTable.java</span></div><h1>PeopleTable.java</h1><pre class="source lang-java linenums">package org.wordpress.android.datasets;

import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteQueryBuilder;

import androidx.annotation.Nullable;

import org.wordpress.android.WordPress;
import org.wordpress.android.models.Person;
import org.wordpress.android.ui.people.utils.PeopleUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.SqlUtils;

import java.util.ArrayList;
import java.util.List;

<span class="nc" id="L19">public class PeopleTable {</span>
    private static final String TEAM_TABLE = &quot;people_team&quot;;
    private static final String FOLLOWERS_TABLE = &quot;people_followers&quot;;
    private static final String EMAIL_FOLLOWERS_TABLE = &quot;people_email_followers&quot;;
    private static final String VIEWERS_TABLE = &quot;people_viewers&quot;;

    private static SQLiteDatabase getReadableDb() {
<span class="nc" id="L26">        return WordPress.wpDB.getDatabase();</span>
    }

    private static SQLiteDatabase getWritableDb() {
<span class="nc" id="L30">        return WordPress.wpDB.getDatabase();</span>
    }

    public static void createTables(SQLiteDatabase db) {
<span class="nc" id="L34">        db.execSQL(&quot;CREATE TABLE &quot; + TEAM_TABLE + &quot; (&quot;</span>
                   + &quot;person_id INTEGER DEFAULT 0,&quot;
                   + &quot;local_blog_id INTEGER DEFAULT 0,&quot;
                   + &quot;user_name TEXT,&quot;
                   + &quot;display_name TEXT,&quot;
                   + &quot;avatar_url TEXT,&quot;
                   + &quot;role TEXT,&quot;
                   + &quot;PRIMARY KEY (person_id, local_blog_id)&quot;
                   + &quot;);&quot;);

<span class="nc" id="L44">        db.execSQL(&quot;CREATE TABLE &quot; + FOLLOWERS_TABLE + &quot; (&quot;</span>
                   + &quot;person_id INTEGER DEFAULT 0,&quot;
                   + &quot;local_blog_id INTEGER DEFAULT 0,&quot;
                   + &quot;user_name TEXT,&quot;
                   + &quot;display_name TEXT,&quot;
                   + &quot;avatar_url TEXT,&quot;
                   + &quot;subscribed TEXT,&quot;
                   + &quot;PRIMARY KEY (person_id, local_blog_id)&quot;
                   + &quot;);&quot;);

<span class="nc" id="L54">        db.execSQL(&quot;CREATE TABLE &quot; + EMAIL_FOLLOWERS_TABLE + &quot; (&quot;</span>
                   + &quot;person_id INTEGER DEFAULT 0,&quot;
                   + &quot;local_blog_id INTEGER DEFAULT 0,&quot;
                   + &quot;display_name TEXT,&quot;
                   + &quot;avatar_url TEXT,&quot;
                   + &quot;subscribed TEXT,&quot;
                   + &quot;PRIMARY KEY (person_id, local_blog_id)&quot;
                   + &quot;);&quot;);
<span class="nc" id="L62">    }</span>

    public static void createViewersTable(SQLiteDatabase db) {
<span class="nc" id="L65">        db.execSQL(&quot;CREATE TABLE &quot; + VIEWERS_TABLE + &quot; (&quot;</span>
                   + &quot;person_id INTEGER DEFAULT 0,&quot;
                   + &quot;local_blog_id INTEGER DEFAULT 0,&quot;
                   + &quot;user_name TEXT,&quot;
                   + &quot;display_name TEXT,&quot;
                   + &quot;avatar_url TEXT,&quot;
                   + &quot;PRIMARY KEY (person_id, local_blog_id)&quot;
                   + &quot;);&quot;);
<span class="nc" id="L73">    }</span>

    private static void dropTables(SQLiteDatabase db) {
        // People table is not used anymore, each filter now has it's own table
<span class="nc" id="L77">        db.execSQL(&quot;DROP TABLE IF EXISTS people&quot;);</span>

<span class="nc" id="L79">        db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + TEAM_TABLE);</span>
<span class="nc" id="L80">        db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + FOLLOWERS_TABLE);</span>
<span class="nc" id="L81">        db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + EMAIL_FOLLOWERS_TABLE);</span>
<span class="nc" id="L82">        db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + VIEWERS_TABLE);</span>
<span class="nc" id="L83">    }</span>

    public static void reset(SQLiteDatabase db) {
<span class="nc" id="L86">        AppLog.i(AppLog.T.PEOPLE, &quot;resetting people table&quot;);</span>
<span class="nc" id="L87">        dropTables(db);</span>
<span class="nc" id="L88">        createTables(db);</span>
<span class="nc" id="L89">    }</span>

    public static void saveUser(Person person) {
<span class="nc" id="L92">        save(TEAM_TABLE, person, getWritableDb());</span>
<span class="nc" id="L93">    }</span>

    private static void save(String table, Person person, SQLiteDatabase database) {
<span class="nc" id="L96">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L97">        values.put(&quot;person_id&quot;, person.getPersonID());</span>
<span class="nc" id="L98">        values.put(&quot;local_blog_id&quot;, person.getLocalTableBlogId());</span>
<span class="nc" id="L99">        values.put(&quot;display_name&quot;, person.getDisplayName());</span>
<span class="nc" id="L100">        values.put(&quot;avatar_url&quot;, person.getAvatarUrl());</span>

<span class="nc bnc" id="L102" title="All 5 branches missed.">        switch (table) {</span>
            case TEAM_TABLE:
<span class="nc" id="L104">                values.put(&quot;user_name&quot;, person.getUsername());</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                if (person.getRole() != null) {</span>
<span class="nc" id="L106">                    values.put(&quot;role&quot;, person.getRole());</span>
                }
                break;
            case FOLLOWERS_TABLE:
<span class="nc" id="L110">                values.put(&quot;user_name&quot;, person.getUsername());</span>
<span class="nc" id="L111">                values.put(&quot;subscribed&quot;, person.getSubscribed());</span>
<span class="nc" id="L112">                break;</span>
            case EMAIL_FOLLOWERS_TABLE:
<span class="nc" id="L114">                values.put(&quot;subscribed&quot;, person.getSubscribed());</span>
<span class="nc" id="L115">                break;</span>
            case VIEWERS_TABLE:
<span class="nc" id="L117">                values.put(&quot;user_name&quot;, person.getUsername());</span>
                break;
        }

<span class="nc" id="L121">        database.insertWithOnConflict(table, null, values, SQLiteDatabase.CONFLICT_REPLACE);</span>
<span class="nc" id="L122">    }</span>

    public static void saveUsers(List&lt;Person&gt; peopleList, int localTableBlogId, boolean isFreshList) {
<span class="nc" id="L125">        savePeople(TEAM_TABLE, peopleList, localTableBlogId, isFreshList);</span>
<span class="nc" id="L126">    }</span>

    public static void saveFollowers(List&lt;Person&gt; peopleList, int localTableBlogId, boolean isFreshList) {
<span class="nc" id="L129">        savePeople(FOLLOWERS_TABLE, peopleList, localTableBlogId, isFreshList);</span>
<span class="nc" id="L130">    }</span>

    public static void saveEmailFollowers(List&lt;Person&gt; peopleList, int localTableBlogId, boolean isFreshList) {
<span class="nc" id="L133">        savePeople(EMAIL_FOLLOWERS_TABLE, peopleList, localTableBlogId, isFreshList);</span>
<span class="nc" id="L134">    }</span>

    public static void saveViewers(List&lt;Person&gt; peopleList, int localTableBlogId, boolean isFreshList) {
<span class="nc" id="L137">        savePeople(VIEWERS_TABLE, peopleList, localTableBlogId, isFreshList);</span>
<span class="nc" id="L138">    }</span>

    private static void savePeople(String table, List&lt;Person&gt; peopleList, int localTableBlogId, boolean isFreshList) {
<span class="nc" id="L141">        getWritableDb().beginTransaction();</span>
        try {
            // We have a fresh list, remove the previous list of people in case it was deleted on remote
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if (isFreshList) {</span>
<span class="nc" id="L145">                PeopleTable.deletePeople(table, localTableBlogId);</span>
            }

<span class="nc bnc" id="L148" title="All 2 branches missed.">            for (Person person : peopleList) {</span>
<span class="nc" id="L149">                PeopleTable.save(table, person, getWritableDb());</span>
<span class="nc" id="L150">            }</span>
<span class="nc" id="L151">            getWritableDb().setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L153">            getWritableDb().endTransaction();</span>
        }
<span class="nc" id="L155">    }</span>

    public static void deletePeopleForLocalBlogId(int localTableBlogId) {
<span class="nc" id="L158">        deletePeople(TEAM_TABLE, localTableBlogId);</span>
<span class="nc" id="L159">        deletePeople(FOLLOWERS_TABLE, localTableBlogId);</span>
<span class="nc" id="L160">        deletePeople(EMAIL_FOLLOWERS_TABLE, localTableBlogId);</span>
<span class="nc" id="L161">        deletePeople(VIEWERS_TABLE, localTableBlogId);</span>
<span class="nc" id="L162">    }</span>

    private static void deletePeople(String table, int localTableBlogId) {
<span class="nc" id="L165">        String[] args = new String[]{Integer.toString(localTableBlogId)};</span>
<span class="nc" id="L166">        getWritableDb().delete(table, &quot;local_blog_id=?1&quot;, args);</span>
<span class="nc" id="L167">    }</span>

    /**
     * In order to avoid syncing issues, this method will be called when People page is created. We only keep
     * the first page of users, so we don't show an empty screen. When fresh data is received, it'll replace
     * the existing page.
     *
     * @param localTableBlogId - the local blog id people will be deleted from
     */
    public static void deletePeopleExceptForFirstPage(int localTableBlogId) {
<span class="nc" id="L177">        int fetchLimit = PeopleUtils.FETCH_LIMIT;</span>
<span class="nc" id="L178">        String[] tables = {TEAM_TABLE, FOLLOWERS_TABLE, EMAIL_FOLLOWERS_TABLE, VIEWERS_TABLE};</span>

<span class="nc" id="L180">        getWritableDb().beginTransaction();</span>
        try {
<span class="nc bnc" id="L182" title="All 2 branches missed.">            for (String table : tables) {</span>
<span class="nc" id="L183">                int size = getPeopleCountForLocalBlogId(table, localTableBlogId);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                if (size &gt; fetchLimit) {</span>
<span class="nc" id="L185">                    String where = &quot;local_blog_id=&quot; + localTableBlogId;</span>
<span class="nc" id="L186">                    String[] columns = {&quot;person_id&quot;};</span>
<span class="nc" id="L187">                    String limit = Integer.toString(size - fetchLimit);</span>
                    String orderBy;
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    if (shouldOrderAlphabetically(table)) {</span>
<span class="nc" id="L190">                        orderBy = &quot;lower(display_name) DESC, lower(user_name) DESC&quot;;</span>
                    } else {
<span class="nc" id="L192">                        orderBy = &quot;ROWID DESC&quot;;</span>
                    }
<span class="nc" id="L194">                    String inQuery = SQLiteQueryBuilder.buildQueryString(false, table, columns, where, null, null,</span>
                                                                         orderBy, limit);

<span class="nc" id="L197">                    String[] args = new String[]{Integer.toString(localTableBlogId)};</span>
<span class="nc" id="L198">                    getWritableDb().delete(table, &quot;local_blog_id=?1 AND person_id IN (&quot; + inQuery + &quot;)&quot;, args);</span>
                }
            }
<span class="nc" id="L201">            getWritableDb().setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L203">            getWritableDb().endTransaction();</span>
        }
<span class="nc" id="L205">    }</span>

    public static int getUsersCountForLocalBlogId(int localTableBlogId) {
<span class="nc" id="L208">        return getPeopleCountForLocalBlogId(TEAM_TABLE, localTableBlogId);</span>
    }

    public static int getViewersCountForLocalBlogId(int localTableBlogId) {
<span class="nc" id="L212">        return getPeopleCountForLocalBlogId(VIEWERS_TABLE, localTableBlogId);</span>
    }

    private static int getPeopleCountForLocalBlogId(String table, int localTableBlogId) {
<span class="nc" id="L216">        String[] args = new String[]{Integer.toString(localTableBlogId)};</span>
<span class="nc" id="L217">        String sql = &quot;SELECT COUNT(*) FROM &quot; + table + &quot; WHERE local_blog_id=?&quot;;</span>
<span class="nc" id="L218">        return SqlUtils.intForQuery(getReadableDb(), sql, args);</span>
    }

    public static void deletePerson(long personID, int localTableBlogId, Person.PersonType personType) {
<span class="nc" id="L222">        String table = getTableForPersonType(personType);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (table != null) {</span>
<span class="nc" id="L224">            deletePerson(table, personID, localTableBlogId);</span>
        }
<span class="nc" id="L226">    }</span>

    private static void deletePerson(String table, long personID, int localTableBlogId) {
<span class="nc" id="L229">        String[] args = new String[]{Long.toString(personID), Integer.toString(localTableBlogId)};</span>
<span class="nc" id="L230">        getWritableDb().delete(table, &quot;person_id=? AND local_blog_id=?&quot;, args);</span>
<span class="nc" id="L231">    }</span>

    public static List&lt;Person&gt; getUsers(int localTableBlogId) {
<span class="nc" id="L234">        return PeopleTable.getPeople(TEAM_TABLE, localTableBlogId);</span>
    }

    public static List&lt;Person&gt; getFollowers(int localTableBlogId) {
<span class="nc" id="L238">        return PeopleTable.getPeople(FOLLOWERS_TABLE, localTableBlogId);</span>
    }

    public static List&lt;Person&gt; getEmailFollowers(int localTableBlogId) {
<span class="nc" id="L242">        return PeopleTable.getPeople(EMAIL_FOLLOWERS_TABLE, localTableBlogId);</span>
    }

    public static List&lt;Person&gt; getViewers(int localTableBlogId) {
<span class="nc" id="L246">        return PeopleTable.getPeople(VIEWERS_TABLE, localTableBlogId);</span>
    }

    private static List&lt;Person&gt; getPeople(String table, int localTableBlogId) {
<span class="nc" id="L250">        String[] args = {Integer.toString(localTableBlogId)};</span>
        String orderBy;
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (shouldOrderAlphabetically(table)) {</span>
<span class="nc" id="L253">            orderBy = &quot; ORDER BY lower(display_name), lower(user_name)&quot;;</span>
        } else {
            // we want the server-side order for followers &amp; viewers
<span class="nc" id="L256">            orderBy = &quot; ORDER BY ROWID&quot;;</span>
        }
<span class="nc" id="L258">        Cursor c = getReadableDb().rawQuery(&quot;SELECT * FROM &quot; + table + &quot; WHERE local_blog_id=?&quot; + orderBy, args);</span>

<span class="nc" id="L260">        List&lt;Person&gt; people = new ArrayList&lt;&gt;();</span>
        try {
<span class="nc bnc" id="L262" title="All 2 branches missed.">            while (c.moveToNext()) {</span>
<span class="nc" id="L263">                Person person = getPersonFromCursor(c, table, localTableBlogId);</span>
<span class="nc" id="L264">                people.add(person);</span>
<span class="nc" id="L265">            }</span>
        } finally {
<span class="nc" id="L267">            SqlUtils.closeCursor(c);</span>
        }
<span class="nc" id="L269">        return people;</span>
    }

    @Nullable
    public static Person getPerson(long personId, int localTableBlogId, Person.PersonType personType) {
<span class="nc" id="L274">        String table = getTableForPersonType(personType);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (table != null) {</span>
<span class="nc" id="L276">            return getPerson(table, personId, localTableBlogId);</span>
        }
<span class="nc" id="L278">        return null;</span>
    }

    public static Person getUser(long personId, int localTableBlogId) {
<span class="nc" id="L282">        return getPerson(TEAM_TABLE, personId, localTableBlogId);</span>
    }

    /**
     * retrieve a person
     *
     * @param table - sql table the person record is in
     * @param personId - id of a person in a particular blog
     * @param localTableBlogId - the local blog id the user belongs to
     * @return Person if found, null otherwise
     */
    private static Person getPerson(String table, long personId, int localTableBlogId) {
<span class="nc" id="L294">        String[] args = {Long.toString(personId), Integer.toString(localTableBlogId)};</span>
<span class="nc" id="L295">        Cursor c = getReadableDb().rawQuery(&quot;SELECT * FROM &quot; + table</span>
                                            + &quot; WHERE person_id=? AND local_blog_id=?&quot;, args);
        try {
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (!c.moveToFirst()) {</span>
<span class="nc" id="L299">                return null;</span>
            }
<span class="nc" id="L301">            return getPersonFromCursor(c, table, localTableBlogId);</span>
        } finally {
<span class="nc" id="L303">            SqlUtils.closeCursor(c);</span>
        }
    }

    private static Person getPersonFromCursor(Cursor c, String table, int localTableBlogId) {
<span class="nc" id="L308">        long personId = c.getInt(c.getColumnIndexOrThrow(&quot;person_id&quot;));</span>

<span class="nc" id="L310">        Person person = new Person(personId, localTableBlogId);</span>
<span class="nc" id="L311">        person.setDisplayName(c.getString(c.getColumnIndexOrThrow(&quot;display_name&quot;)));</span>
<span class="nc" id="L312">        person.setAvatarUrl(c.getString(c.getColumnIndexOrThrow(&quot;avatar_url&quot;)));</span>
<span class="nc bnc" id="L313" title="All 5 branches missed.">        switch (table) {</span>
            case TEAM_TABLE:
<span class="nc" id="L315">                person.setUsername(c.getString(c.getColumnIndexOrThrow(&quot;user_name&quot;)));</span>
<span class="nc" id="L316">                String role = c.getString(c.getColumnIndexOrThrow(&quot;role&quot;));</span>
<span class="nc" id="L317">                person.setRole(role);</span>
<span class="nc" id="L318">                person.setPersonType(Person.PersonType.USER);</span>
<span class="nc" id="L319">                break;</span>
            case FOLLOWERS_TABLE:
<span class="nc" id="L321">                person.setUsername(c.getString(c.getColumnIndexOrThrow(&quot;user_name&quot;)));</span>
<span class="nc" id="L322">                person.setSubscribed(c.getString(c.getColumnIndexOrThrow(&quot;subscribed&quot;)));</span>
<span class="nc" id="L323">                person.setPersonType(Person.PersonType.FOLLOWER);</span>
<span class="nc" id="L324">                break;</span>
            case EMAIL_FOLLOWERS_TABLE:
<span class="nc" id="L326">                person.setSubscribed(c.getString(c.getColumnIndexOrThrow(&quot;subscribed&quot;)));</span>
<span class="nc" id="L327">                person.setPersonType(Person.PersonType.EMAIL_FOLLOWER);</span>
<span class="nc" id="L328">                break;</span>
            case VIEWERS_TABLE:
<span class="nc" id="L330">                person.setUsername(c.getString(c.getColumnIndexOrThrow(&quot;user_name&quot;)));</span>
<span class="nc" id="L331">                person.setPersonType(Person.PersonType.VIEWER);</span>
                break;
        }

<span class="nc" id="L335">        return person;</span>
    }

    // order is disabled for followers &amp; viewers for now since the API is not supporting it
    private static boolean shouldOrderAlphabetically(String table) {
<span class="nc" id="L340">        return table.equals(TEAM_TABLE);</span>
    }

    @Nullable
    private static String getTableForPersonType(Person.PersonType personType) {
<span class="nc bnc" id="L345" title="All 5 branches missed.">        switch (personType) {</span>
            case USER:
<span class="nc" id="L347">                return TEAM_TABLE;</span>
            case FOLLOWER:
<span class="nc" id="L349">                return FOLLOWERS_TABLE;</span>
            case EMAIL_FOLLOWER:
<span class="nc" id="L351">                return EMAIL_FOLLOWERS_TABLE;</span>
            case VIEWER:
<span class="nc" id="L353">                return VIEWERS_TABLE;</span>
        }
<span class="nc" id="L355">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>