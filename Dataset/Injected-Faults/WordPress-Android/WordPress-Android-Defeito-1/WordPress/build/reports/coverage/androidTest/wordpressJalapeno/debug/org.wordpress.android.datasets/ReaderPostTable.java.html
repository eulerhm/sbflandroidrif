<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderPostTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.datasets</a> &gt; <span class="el_source">ReaderPostTable.java</span></div><h1>ReaderPostTable.java</h1><pre class="source lang-java linenums">package org.wordpress.android.datasets;

import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteStatement;
import android.text.TextUtils;
import android.util.Pair;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;

import org.greenrobot.eventbus.EventBus;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.models.ReaderCardType;
import org.wordpress.android.models.ReaderPost;
import org.wordpress.android.models.ReaderPostList;
import org.wordpress.android.models.ReaderTag;
import org.wordpress.android.models.ReaderTagList;
import org.wordpress.android.models.ReaderTagType;
import org.wordpress.android.ui.reader.ReaderConstants;
import org.wordpress.android.ui.reader.actions.ReaderActions;
import org.wordpress.android.ui.reader.models.ReaderBlogIdPostId;
import org.wordpress.android.ui.reader.models.ReaderBlogIdPostIdList;
import org.wordpress.android.ui.reader.repository.ReaderRepositoryEvent.ReaderPostTableActionEnded;
import org.wordpress.android.ui.reader.utils.ReaderUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.SqlUtils;

import java.util.LinkedHashMap;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;

/**
 * tbl_posts contains all reader posts - the primary key is pseudo_id + tag_name + tag_type,
 * which allows the same post to appear in multiple streams (ex: it can exist in followed
 * sites, liked posts, and tag streams). note that posts in a specific blog or feed are
 * stored here with an empty tag_name.
 */
<span class="nc" id="L42">public class ReaderPostTable {</span>
    private static final String COLUMN_NAMES =
            &quot;post_id,&quot; // 1
            + &quot;blog_id,&quot; // 2
            + &quot;feed_id,&quot; // 3
            + &quot;feed_item_id,&quot; // 4
            + &quot;pseudo_id,&quot; // 5
            + &quot;author_name,&quot; // 6
            + &quot;author_first_name,&quot; // 7
            + &quot;author_id,&quot; // 8
            + &quot;title,&quot; // 9
            + &quot;text,&quot; // 10
            + &quot;excerpt,&quot; // 11
            + &quot;format,&quot; // 12
            + &quot;url,&quot; // 13
            + &quot;short_url,&quot; // 14
            + &quot;blog_name,&quot; // 15
            + &quot;blog_url,&quot; // 16
            + &quot;blog_image_url,&quot; // 17
            + &quot;featured_image,&quot; // 18
            + &quot;featured_video,&quot; // 19
            + &quot;post_avatar,&quot; // 20
            + &quot;score,&quot; // 21
            + &quot;date_published,&quot; // 22
            + &quot;date_liked,&quot; // 23
            + &quot;date_tagged,&quot; // 24
            + &quot;num_replies,&quot; // 25
            + &quot;num_likes,&quot; // 26
            + &quot;is_liked,&quot; // 27
            + &quot;is_followed,&quot; // 28
            + &quot;is_comments_open,&quot; // 29
            + &quot;is_external,&quot; // 30
            + &quot;is_private,&quot; // 31
            + &quot;is_videopress,&quot; // 32
            + &quot;is_jetpack,&quot; // 33
            + &quot;primary_tag,&quot; // 34
            + &quot;secondary_tag,&quot; // 35
            + &quot;attachments_json,&quot; // 36
            + &quot;discover_json,&quot; // 37
            + &quot;xpost_post_id,&quot; // 38
            + &quot;xpost_blog_id,&quot; // 39
            + &quot;railcar_json,&quot; // 40
            + &quot;tag_name,&quot; // 41
            + &quot;tag_type,&quot; // 42
            + &quot;has_gap_marker,&quot; // 43
            + &quot;card_type,&quot; // 44
            + &quot;use_excerpt,&quot; // 45
            + &quot;is_bookmarked,&quot; // 46
            + &quot;is_private_atomic,&quot; // 47
            + &quot;tags,&quot; // 48
            + &quot;organization_id,&quot; // 49
            + &quot;is_seen,&quot; // 50
            + &quot;is_seen_supported,&quot; // 51
            + &quot;author_blog_id,&quot; // 52
            + &quot;author_blog_url&quot;; // 53

    // used when querying multiple rows and skipping text column
    private static final String COLUMN_NAMES_NO_TEXT =
            &quot;post_id,&quot; // 1
            + &quot;blog_id,&quot; // 2
            + &quot;feed_id,&quot; // 3
            + &quot;feed_item_id,&quot; // 4
            + &quot;author_id,&quot; // 5
            + &quot;pseudo_id,&quot; // 6
            + &quot;author_name,&quot; // 7
            + &quot;author_first_name,&quot; // 8
            + &quot;blog_name,&quot; // 9
            + &quot;blog_url,&quot; // 10
            + &quot;blog_image_url,&quot; // 11
            + &quot;excerpt,&quot; // 12
            + &quot;format,&quot; // 13
            + &quot;featured_image,&quot; // 14
            + &quot;featured_video,&quot; // 15
            + &quot;title,&quot; // 16
            + &quot;url,&quot; // 17
            + &quot;short_url,&quot; // 18
            + &quot;post_avatar,&quot; // 19
            + &quot;score,&quot; // 20
            + &quot;date_published,&quot; // 21
            + &quot;date_liked,&quot; // 22
            + &quot;date_tagged,&quot; // 23
            + &quot;num_replies,&quot; // 24
            + &quot;num_likes,&quot; // 25
            + &quot;is_liked,&quot; // 26
            + &quot;is_followed,&quot; // 27
            + &quot;is_comments_open,&quot; // 28
            + &quot;is_external,&quot; // 29
            + &quot;is_private,&quot; // 30
            + &quot;is_videopress,&quot; // 31
            + &quot;is_jetpack,&quot; // 32
            + &quot;primary_tag,&quot; // 33
            + &quot;secondary_tag,&quot; // 34
            + &quot;attachments_json,&quot; // 35
            + &quot;discover_json,&quot; // 36
            + &quot;xpost_post_id,&quot; // 37
            + &quot;xpost_blog_id,&quot; // 38
            + &quot;railcar_json,&quot; // 39
            + &quot;tag_name,&quot; // 40
            + &quot;tag_type,&quot; // 41
            + &quot;has_gap_marker,&quot; // 42
            + &quot;card_type,&quot; // 43
            + &quot;use_excerpt,&quot; // 44
            + &quot;is_bookmarked,&quot; // 45
            + &quot;is_private_atomic,&quot; // 46
            + &quot;tags,&quot; // 47
            + &quot;organization_id,&quot; // 48
            + &quot;is_seen,&quot; // 49
            + &quot;is_seen_supported,&quot; // 50
            + &quot;author_blog_id,&quot; // 51
            + &quot;author_blog_url&quot;; // 52

    protected static void createTables(SQLiteDatabase db) {
<span class="nc" id="L154">        db.execSQL(&quot;CREATE TABLE tbl_posts (&quot;</span>
                   + &quot; post_id INTEGER DEFAULT 0,&quot;
                   + &quot; blog_id INTEGER DEFAULT 0,&quot;
                   + &quot; feed_id INTEGER DEFAULT 0,&quot;
                   + &quot; feed_item_id INTEGER DEFAULT 0,&quot;
                   + &quot; pseudo_id TEXT NOT NULL,&quot;
                   + &quot; author_name TEXT,&quot;
                   + &quot; author_first_name TEXT,&quot;
                   + &quot; author_id INTEGER DEFAULT 0,&quot;
                   + &quot; title  TEXT,&quot;
                   + &quot; text TEXT,&quot;
                   + &quot; excerpt TEXT,&quot;
                   + &quot; format TEXT,&quot;
                   + &quot; url TEXT,&quot;
                   + &quot; short_url TEXT,&quot;
                   + &quot; blog_name TEXT,&quot;
                   + &quot; blog_url TEXT,&quot;
                   + &quot; blog_image_url TEXT,&quot;
                   + &quot; featured_image TEXT,&quot;
                   + &quot; featured_video TEXT,&quot;
                   + &quot; post_avatar TEXT,&quot;
                   + &quot; score REAL DEFAULT 0,&quot;
                   + &quot; date_published TEXT,&quot;
                   + &quot; date_liked TEXT,&quot;
                   + &quot; date_tagged TEXT,&quot;
                   + &quot; num_replies INTEGER DEFAULT 0,&quot;
                   + &quot; num_likes INTEGER DEFAULT 0,&quot;
                   + &quot; is_liked INTEGER DEFAULT 0,&quot;
                   + &quot; is_followed INTEGER DEFAULT 0,&quot;
                   + &quot; is_comments_open INTEGER DEFAULT 0,&quot;
                   + &quot; is_external INTEGER DEFAULT 0,&quot;
                   + &quot; is_private INTEGER DEFAULT 0,&quot;
                   + &quot; is_videopress INTEGER DEFAULT 0,&quot;
                   + &quot; is_jetpack INTEGER DEFAULT 0,&quot;
                   + &quot; primary_tag TEXT,&quot;
                   + &quot; secondary_tag TEXT,&quot;
                   + &quot; attachments_json TEXT,&quot;
                   + &quot; discover_json TEXT,&quot;
                   + &quot; xpost_post_id INTEGER DEFAULT 0,&quot;
                   + &quot; xpost_blog_id INTEGER DEFAULT 0,&quot;
                   + &quot; railcar_json TEXT,&quot;
                   + &quot; tag_name TEXT NOT NULL COLLATE NOCASE,&quot;
                   + &quot; tag_type INTEGER DEFAULT 0,&quot;
                   + &quot; has_gap_marker INTEGER DEFAULT 0,&quot;
                   + &quot; card_type TEXT,&quot;
                   + &quot; use_excerpt INTEGER DEFAULT 0,&quot;
                   + &quot; is_bookmarked INTEGER DEFAULT 0,&quot;
                   + &quot; is_private_atomic INTEGER DEFAULT 0,&quot;
                   + &quot; tags TEXT,&quot;
                   + &quot; organization_id INTEGER DEFAULT 0,&quot;
                   + &quot; is_seen INTEGER DEFAULT 0,&quot;
                   + &quot; is_seen_supported INTEGER DEFAULT 0,&quot;
                   + &quot; author_blog_id INTEGER DEFAULT 0,&quot;
                   + &quot; author_blog_url TEXT,&quot;
                   + &quot; PRIMARY KEY (pseudo_id, tag_name, tag_type)&quot;
                   + &quot;)&quot;);

<span class="nc" id="L211">        db.execSQL(&quot;CREATE INDEX idx_posts_post_id_blog_id ON tbl_posts(post_id, blog_id)&quot;);</span>
<span class="nc" id="L212">        db.execSQL(&quot;CREATE INDEX idx_posts_date_published ON tbl_posts(date_published)&quot;);</span>
<span class="nc" id="L213">        db.execSQL(&quot;CREATE INDEX idx_posts_date_tagged ON tbl_posts(date_tagged)&quot;);</span>
<span class="nc" id="L214">        db.execSQL(&quot;CREATE INDEX idx_posts_tag_name ON tbl_posts(tag_name)&quot;);</span>
<span class="nc" id="L215">    }</span>

    protected static void dropTables(SQLiteDatabase db) {
<span class="nc" id="L218">        db.execSQL(&quot;DROP TABLE IF EXISTS tbl_posts&quot;);</span>
<span class="nc" id="L219">    }</span>

    protected static void reset(SQLiteDatabase db) {
<span class="nc" id="L222">        dropTables(db);</span>
<span class="nc" id="L223">        createTables(db);</span>
<span class="nc" id="L224">    }</span>

    /*
     * purge table of unattached/older posts - no need to wrap this in a transaction since it's
     * only called from ReaderDatabase.purge() which already creates a transaction
     */
    protected static int purge(SQLiteDatabase db) {
        // delete posts attached to tags that no longer exist
<span class="nc" id="L232">        int numDeleted = db.delete(&quot;tbl_posts&quot;, &quot;tag_name NOT IN (SELECT DISTINCT tag_name FROM tbl_tags)&quot;, null);</span>

        // delete excess posts on a per-tag basis
<span class="nc" id="L235">        ReaderTagList tags = ReaderTagTable.getAllTags();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        for (ReaderTag tag : tags) {</span>
<span class="nc" id="L237">            numDeleted += purgePostsForTag(db, tag);</span>
<span class="nc" id="L238">        }</span>

<span class="nc" id="L240">        numDeleted += purgeUnbookmarkedPostsWithBookmarkTag();</span>

        // delete search results
<span class="nc" id="L243">        numDeleted += purgeSearchResults(db);</span>
<span class="nc" id="L244">        return numDeleted;</span>
    }

    /**
     * When the user unbookmarks a post, we keep the row in the database, but we just change the is_bookmarked flag
     * to false, so we can show &quot;undo&quot; items in the saved posts list. This method purges database from such rows.
     */
    public static int purgeUnbookmarkedPostsWithBookmarkTag() {
<span class="nc" id="L252">        int numDeleted = 0;</span>
<span class="nc" id="L253">        ReaderTagList tags = ReaderTagTable.getAllTags();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        for (ReaderTag tag : tags) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">            if (tag.isBookmarked()) {</span>
                // delete posts which has a bookmark tag but is_bookmarked flag is false
<span class="nc" id="L257">                String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L258">                numDeleted += ReaderDatabase.getWritableDb()</span>
<span class="nc" id="L259">                                            .delete(&quot;tbl_posts&quot;, &quot;tag_name=? AND tag_type=? AND is_bookmarked=0&quot;, args);</span>
            }
<span class="nc" id="L261">        }</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (numDeleted &gt; 0) {</span>
<span class="nc" id="L263">            EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
        }
<span class="nc" id="L265">        return numDeleted;</span>
    }

    /*
     * purge excess posts in the passed tag
     */
    private static final int MAX_POSTS_PER_TAG = ReaderConstants.READER_MAX_POSTS_TO_DISPLAY;

    private static int purgePostsForTag(SQLiteDatabase db, ReaderTag tag) {
<span class="nc" id="L274">        int numPosts = getNumPostsWithTag(tag);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (numPosts &lt;= MAX_POSTS_PER_TAG) {</span>
<span class="nc" id="L276">            return 0;</span>
        }
<span class="nc" id="L278">        String tagName = tag.getTagSlug();</span>
<span class="nc" id="L279">        String tagType = Integer.toString(tag.tagType.toInt());</span>
<span class="nc" id="L280">        String[] args = {tagName, tagType, tagName, tagType, Integer.toString(MAX_POSTS_PER_TAG)};</span>
<span class="nc" id="L281">        String where = &quot;tag_name=? AND tag_type=? AND pseudo_id NOT IN (SELECT DISTINCT pseudo_id FROM tbl_posts WHERE &quot;</span>
<span class="nc" id="L282">                       + &quot;tag_name=? AND tag_type=? ORDER BY &quot; + getSortColumnForTag(tag) + &quot; DESC LIMIT ?)&quot;;</span>
<span class="nc" id="L283">        int numDeleted = db.delete(&quot;tbl_posts&quot;, where, args);</span>
<span class="nc" id="L284">        AppLog.d(AppLog.T.READER,</span>
<span class="nc" id="L285">                String.format(Locale.ENGLISH, &quot;reader post table &gt; purged %d posts in tag %s&quot;, numDeleted,</span>
<span class="nc" id="L286">                        tag.getTagNameForLog()));</span>
<span class="nc" id="L287">        return numDeleted;</span>
    }

    /*
     * purge all posts that were retained from previous searches
     */
    private static int purgeSearchResults(SQLiteDatabase db) {
<span class="nc" id="L294">        String[] args = {Integer.toString(ReaderTagType.SEARCH.toInt())};</span>
<span class="nc" id="L295">        return db.delete(&quot;tbl_posts&quot;, &quot;tag_type=?&quot;, args);</span>
    }

    public static int getNumPostsInBlog(long blogId) {
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (blogId == 0) {</span>
<span class="nc" id="L300">            return 0;</span>
        }
<span class="nc" id="L302">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT count(*) FROM tbl_posts WHERE blog_id=? AND tag_name='' AND tag_type=0&quot;,
<span class="nc" id="L304">                new String[]{Long.toString(blogId)});</span>
    }

    public static int getNumPostsInFeed(long feedId) {
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (feedId == 0) {</span>
<span class="nc" id="L309">            return 0;</span>
        }
<span class="nc" id="L311">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT count(*) FROM tbl_posts WHERE feed_id=? AND tag_name='' AND tag_type=0&quot;,
<span class="nc" id="L313">                new String[]{Long.toString(feedId)});</span>
    }

    public static int getNumPostsWithTag(ReaderTag tag) {
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L318">            return 0;</span>
        }
<span class="nc" id="L320">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L321">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT count(*) FROM tbl_posts WHERE tag_name=? AND tag_type=?&quot;,
                args);
    }

    public static void updatePost(@NonNull ReaderPost post) {
        // we need to update a few important fields across all instances of this post - this is
        // necessary because a post can exist multiple times in the table with different tags
<span class="nc" id="L329">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L330">        values.put(&quot;title&quot;, post.getTitle());</span>
<span class="nc" id="L331">        values.put(&quot;text&quot;, post.getText());</span>
<span class="nc" id="L332">        values.put(&quot;excerpt&quot;, post.getExcerpt());</span>
<span class="nc" id="L333">        values.put(&quot;num_replies&quot;, post.numReplies);</span>
<span class="nc" id="L334">        values.put(&quot;num_likes&quot;, post.numLikes);</span>
<span class="nc" id="L335">        values.put(&quot;is_liked&quot;, post.isLikedByCurrentUser);</span>
<span class="nc" id="L336">        values.put(&quot;is_followed&quot;, post.isFollowedByCurrentUser);</span>
<span class="nc" id="L337">        values.put(&quot;is_comments_open&quot;, post.isCommentsOpen);</span>
<span class="nc" id="L338">        values.put(&quot;use_excerpt&quot;, post.useExcerpt);</span>
<span class="nc" id="L339">        ReaderDatabase.getWritableDb().update(</span>
<span class="nc" id="L340">                &quot;tbl_posts&quot;, values, &quot;pseudo_id=?&quot;, new String[]{post.getPseudoId()});</span>

<span class="nc" id="L342">        ReaderPostList posts = new ReaderPostList();</span>
<span class="nc" id="L343">        posts.add(post);</span>
<span class="nc" id="L344">        addOrUpdatePosts(null, posts);</span>
<span class="nc" id="L345">    }</span>

    public static void addPost(@NonNull ReaderPost post) {
<span class="nc" id="L348">        ReaderPostList posts = new ReaderPostList();</span>
<span class="nc" id="L349">        posts.add(post);</span>
<span class="nc" id="L350">        addOrUpdatePosts(null, posts);</span>
<span class="nc" id="L351">    }</span>

    @Nullable
    public static ReaderPost getBlogPost(long blogId, long postId, boolean excludeTextColumn) {
<span class="nc" id="L355">        return getPost(&quot;blog_id=? AND post_id=?&quot;, new String[]{Long.toString(blogId), Long.toString(postId)},</span>
                excludeTextColumn);
    }

    @Nullable
    public static ReaderPost getBlogPost(String blogSlug, String postSlug, boolean excludeTextColumn) {
<span class="nc" id="L361">        return getPost(&quot;blog_url LIKE ? AND url LIKE ?&quot;, new String[]{&quot;%//&quot; + blogSlug, &quot;%/&quot; + postSlug + &quot;/&quot;},</span>
                excludeTextColumn);
    }

    @Nullable
    public static ReaderPost getFeedPost(long feedId, long feedItemId, boolean excludeTextColumn) {
<span class="nc" id="L367">        return getPost(&quot;feed_id=? AND feed_item_id=?&quot;, new String[]{Long.toString(feedId), Long.toString(feedItemId)},</span>
                excludeTextColumn);
    }

    @Nullable
    private static ReaderPost getPost(String where, String[] args, boolean excludeTextColumn) {
<span class="nc bnc" id="L373" title="All 2 branches missed.">        String columns = (excludeTextColumn ? COLUMN_NAMES_NO_TEXT : &quot;*&quot;);</span>
<span class="nc" id="L374">        String sql = &quot;SELECT &quot; + columns + &quot; FROM tbl_posts WHERE &quot; + where + &quot; LIMIT 1&quot;;</span>

<span class="nc" id="L376">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(sql, args);</span>
        try {
<span class="nc bnc" id="L378" title="All 2 branches missed.">            if (!c.moveToFirst()) {</span>
<span class="nc" id="L379">                return null;</span>
            }
<span class="nc" id="L381">            return getPostFromCursor(c);</span>
        } finally {
<span class="nc" id="L383">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static String getPostTitle(long blogId, long postId) {
<span class="nc" id="L388">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L389">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT title FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    public static String getPostBlogName(long blogId, long postId) {
<span class="nc" id="L395">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L396">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT blog_name FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    public static String getPostText(long blogId, long postId) {
<span class="nc" id="L402">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L403">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT text FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    public static boolean postExists(long blogId, long postId) {
<span class="nc" id="L409">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L410">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT 1 FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    private static boolean postExistsForReaderTag(long blogId, long postId, ReaderTag readerTag) {
<span class="nc" id="L416">        String[] args = {Long.toString(blogId), Long.toString(postId), readerTag.getTagSlug(),</span>
<span class="nc" id="L417">                Integer.toString(readerTag.tagType.toInt())};</span>
<span class="nc" id="L418">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT 1 FROM tbl_posts WHERE blog_id=? AND post_id=? AND tag_name=? AND tag_type=?&quot;,
                args);
    }

    /*
     * returns whether any of the passed posts are new or changed - used after posts are retrieved
     */
    public static ReaderActions.UpdateResult comparePosts(ReaderPostList posts) {
<span class="nc bnc" id="L427" title="All 4 branches missed.">        if (posts == null || posts.size() == 0) {</span>
<span class="nc" id="L428">            return ReaderActions.UpdateResult.UNCHANGED;</span>
        }

<span class="nc" id="L431">        boolean hasChanges = false;</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        for (ReaderPost post : posts) {</span>
<span class="nc" id="L433">            ReaderPost existingPost = getBlogPost(post.blogId, post.postId, true);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            if (existingPost == null) {</span>
<span class="nc" id="L435">                return ReaderActions.UpdateResult.HAS_NEW;</span>
<span class="nc bnc" id="L436" title="All 4 branches missed.">            } else if (!hasChanges &amp;&amp; !post.isSamePost(existingPost)) {</span>
<span class="nc" id="L437">                hasChanges = true;</span>
            }
<span class="nc" id="L439">        }</span>

<span class="nc bnc" id="L441" title="All 2 branches missed.">        return (hasChanges ? ReaderActions.UpdateResult.CHANGED : ReaderActions.UpdateResult.UNCHANGED);</span>
    }

    /*
     * returns true if any posts in the passed list exist in this list for the given tag
     */
    public static boolean hasOverlap(ReaderPostList posts, ReaderTag tag) {
<span class="nc bnc" id="L448" title="All 2 branches missed.">        for (ReaderPost post : posts) {</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">            if (postExistsForReaderTag(post.blogId, post.postId, tag)) {</span>
<span class="nc" id="L450">                return true;</span>
            }
<span class="nc" id="L452">        }</span>
<span class="nc" id="L453">        return false;</span>
    }

    /*
     * returns the #comments known to exist for this post (ie: #comments the server says this post has), which
     * may differ from ReaderCommentTable.getNumCommentsForPost (which returns # local comments for this post)
     */
    public static int getNumCommentsForPost(ReaderPost post) {
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L462">            return 0;</span>
        }
<span class="nc" id="L464">        return getNumCommentsForPost(post.blogId, post.postId);</span>
    }

    public static int getNumCommentsForPost(long blogId, long postId) {
<span class="nc" id="L468">        String[] args = new String[]{Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L469">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT num_replies FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    public static void setNumCommentsForPost(long blogId, long postId, int numComments) {
<span class="nc" id="L475">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L476">        values.put(&quot;num_replies&quot;, numComments);</span>

<span class="nc" id="L478">        update(blogId, postId, values);</span>
<span class="nc" id="L479">    }</span>

    public static void incNumCommentsForPost(long blogId, long postId) {
<span class="nc" id="L482">        int numComments = getNumCommentsForPost(blogId, postId);</span>
<span class="nc" id="L483">        numComments++;</span>
<span class="nc" id="L484">        setNumCommentsForPost(blogId, postId, numComments);</span>
<span class="nc" id="L485">    }</span>

    public static void decrementNumCommentsForPost(long blogId, long postId) {
<span class="nc" id="L488">        int numComments = getNumCommentsForPost(blogId, postId);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (numComments &gt; 0) {</span>
<span class="nc" id="L490">            numComments--;</span>
<span class="nc" id="L491">            setNumCommentsForPost(blogId, postId, numComments);</span>
        } else {
<span class="nc" id="L493">            AppLog.d(AppLog.T.READER, &quot;Failed to decrement the number of post comments because they are 0&quot;);</span>
        }
<span class="nc" id="L495">    }</span>

    /*
     * returns the #likes known to exist for this post (ie: #likes the server says this post has), which
     * may differ from ReaderPostTable.getNumLikesForPost (which returns # local likes for this post)
     */
    public static int getNumLikesForPost(long blogId, long postId) {
<span class="nc" id="L502">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L503">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT num_likes FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    public static boolean isPostLikedByCurrentUser(ReaderPost post) {
<span class="nc bnc" id="L509" title="All 4 branches missed.">        return post != null &amp;&amp; isPostLikedByCurrentUser(post.blogId, post.postId);</span>
    }

    public static boolean isPostLikedByCurrentUser(long blogId, long postId) {
<span class="nc" id="L513">        String[] args = new String[]{Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L514">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT is_liked FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    /*
     * updates both the like count for a post and whether it's liked by the current user
     */
    public static void setLikesForPost(ReaderPost post, int numLikes, boolean isLikedByCurrentUser) {
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L524">            return;</span>
        }
<span class="nc" id="L526">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L527">        values.put(&quot;num_likes&quot;, numLikes);</span>
<span class="nc" id="L528">        values.put(&quot;is_liked&quot;, SqlUtils.boolToSql(isLikedByCurrentUser));</span>

<span class="nc" id="L530">        update(post.blogId, post.postId, values);</span>
<span class="nc" id="L531">    }</span>


    public static void setBookmarkFlag(long blogId, long postId, boolean bookmark) {
<span class="nc" id="L535">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L536">        values.put(&quot;is_bookmarked&quot;, SqlUtils.boolToSql(bookmark));</span>

<span class="nc" id="L538">        update(blogId, postId, values);</span>
<span class="nc" id="L539">    }</span>

    public static boolean hasBookmarkedPosts() {
<span class="nc" id="L542">        String sql = &quot;SELECT 1 FROM tbl_posts WHERE is_bookmarked != 0 LIMIT 1&quot;;</span>
<span class="nc" id="L543">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(), sql, null);</span>
    }

    private static void update(long blogId, long postId, ContentValues values) {
<span class="nc" id="L547">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L548">        ReaderDatabase.getWritableDb().update(</span>
                &quot;tbl_posts&quot;,
                values,
                &quot;blog_id=? AND post_id=?&quot;,
                args);
<span class="nc" id="L553">        EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
<span class="nc" id="L554">    }</span>


    public static boolean isPostFollowed(ReaderPost post) {
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L559">            return false;</span>
        }
<span class="nc" id="L561">        String[] args = new String[]{Long.toString(post.blogId), Long.toString(post.postId)};</span>
<span class="nc" id="L562">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT is_followed FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    public static boolean isPostSeen(ReaderPost post) {
<span class="nc" id="L568">        String[] args = new String[]{Long.toString(post.blogId), Long.toString(post.postId)};</span>
<span class="nc" id="L569">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                &quot;SELECT is_seen FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;,
                args);
    }

    public static void setPostSeenStatus(ReaderPost post, boolean isSeen) {
<span class="nc" id="L575">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L576">        db.beginTransaction();</span>
        try {
<span class="nc" id="L578">            String sql = &quot;UPDATE tbl_posts SET is_seen=&quot; + SqlUtils.boolToSql(isSeen)</span>
                         + &quot; WHERE blog_id=? AND post_id=?&quot;;
<span class="nc" id="L580">            db.execSQL(sql, new String[]{Long.toString(post.blogId), Long.toString(post.postId)});</span>

<span class="nc" id="L582">            db.setTransactionSuccessful();</span>
<span class="nc" id="L583">            EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
        } finally {
<span class="nc" id="L585">            db.endTransaction();</span>
        }
<span class="nc" id="L587">    }</span>

    public static int deletePostsWithTag(final ReaderTag tag) {
<span class="nc bnc" id="L590" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L591">            return 0;</span>
        }

<span class="nc" id="L594">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L595">        int rowsDeleted = ReaderDatabase.getWritableDb().delete(</span>
                &quot;tbl_posts&quot;,
                &quot;tag_name=? AND tag_type=?&quot;,
                args);

<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (rowsDeleted &gt; 0) {</span>
<span class="nc" id="L601">            EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
        }
<span class="nc" id="L603">        return rowsDeleted;</span>
    }

    public static int removeTagsFromPost(long blogId, long postId, final ReaderTagType tagType) {
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (tagType == null) {</span>
<span class="nc" id="L608">            return 0;</span>
        }

<span class="nc" id="L611">        String[] args = {Integer.toString(tagType.toInt()), Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L612">        int rowsDeleted = ReaderDatabase.getWritableDb().delete(</span>
                &quot;tbl_posts&quot;,
                &quot;tag_type=? AND blog_id=? AND post_id=?&quot;,
                args);

<span class="nc bnc" id="L617" title="All 2 branches missed.">        if (rowsDeleted &gt; 0) {</span>
<span class="nc" id="L618">            EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
        }
<span class="nc" id="L620">        return rowsDeleted;</span>
    }

    public static int deletePostsInBlog(long blogId) {
<span class="nc" id="L624">        String[] args = {Long.toString(blogId)};</span>
<span class="nc" id="L625">        int rowsDeleted = ReaderDatabase.getWritableDb().delete(&quot;tbl_posts&quot;, &quot;blog_id = ?&quot;, args);</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">        if (rowsDeleted &gt; 0) {</span>
<span class="nc" id="L627">            EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
        }
<span class="nc" id="L629">        return rowsDeleted;</span>
    }

    public static void deletePost(long blogId, long postId) {
<span class="nc" id="L633">        String[] args = new String[]{Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L634">        ReaderDatabase.getWritableDb().delete(&quot;tbl_posts&quot;, &quot;blog_id=? AND post_id=?&quot;, args);</span>
<span class="nc" id="L635">        EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
<span class="nc" id="L636">    }</span>

    /*
     * ensure that posts in blogs that are no longer followed don't have their followed status
     * set to true
     */
    public static void updateFollowedStatus() {
<span class="nc" id="L643">        SQLiteStatement statement = ReaderDatabase.getWritableDb().compileStatement(</span>
                &quot;UPDATE tbl_posts SET is_followed = 0&quot;
                + &quot; WHERE is_followed != 0&quot;
                + &quot; AND blog_id NOT IN (SELECT DISTINCT blog_id FROM tbl_blog_info WHERE is_followed != 0)&quot;);
        try {
<span class="nc" id="L648">            int count = statement.executeUpdateDelete();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (count &gt; 0) {</span>
<span class="nc" id="L650">                AppLog.d(AppLog.T.READER, String.format(Locale.ENGLISH,</span>
<span class="nc" id="L651">                        &quot;reader post table &gt; marked %d posts unfollowed&quot;, count));</span>
<span class="nc" id="L652">                EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
            }
        } finally {
<span class="nc" id="L655">            statement.close();</span>
        }
<span class="nc" id="L657">    }</span>

    /*
     * returns the iso8601 date of the oldest post with the passed tag
     */
    public static String getOldestDateWithTag(final ReaderTag tag) {
<span class="nc bnc" id="L663" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L664">            return &quot;&quot;;</span>
        }

        // date field depends on the tag
<span class="nc" id="L668">        String dateColumn = getSortColumnForTag(tag);</span>
<span class="nc" id="L669">        String sql = &quot;SELECT &quot; + dateColumn + &quot; FROM tbl_posts&quot;</span>
                     + &quot; WHERE tag_name=? AND tag_type=?&quot;
                     + &quot; ORDER BY &quot; + dateColumn + &quot; LIMIT 1&quot;;
<span class="nc" id="L672">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L673">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(), sql, args);</span>
    }

    /*
     * returns the iso8601 pub date of the oldest post in the passed blog
     */
    public static String getOldestPubDateInBlog(long blogId) {
<span class="nc" id="L680">        String sql = &quot;SELECT date_published FROM tbl_posts&quot;</span>
                     + &quot; WHERE blog_id=? AND tag_name='' AND tag_type=0&quot;
                     + &quot; ORDER BY date_published LIMIT 1&quot;;
<span class="nc" id="L683">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(), sql, new String[]{Long.toString(blogId)});</span>
    }

    public static String getOldestPubDateInFeed(long feedId) {
<span class="nc" id="L687">        String sql = &quot;SELECT date_published FROM tbl_posts&quot;</span>
                     + &quot; WHERE feed_id=? AND tag_name='' AND tag_type=0&quot;
                     + &quot; ORDER BY date_published LIMIT 1&quot;;
<span class="nc" id="L690">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(), sql, new String[]{Long.toString(feedId)});</span>
    }

    public static void removeGapMarkerForTag(final ReaderTag tag) {
<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L695">            return;</span>
        }

<span class="nc" id="L698">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L699">        String sql = &quot;UPDATE tbl_posts SET has_gap_marker=0 WHERE has_gap_marker!=0 AND tag_name=? AND tag_type=?&quot;;</span>
<span class="nc" id="L700">        ReaderDatabase.getWritableDb().execSQL(sql, args);</span>
<span class="nc" id="L701">        EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
<span class="nc" id="L702">    }</span>

    /*
     * returns the blogId/postId of the post with the passed tag that has a gap marker, or null if none exists
     */
    public static ReaderBlogIdPostId getGapMarkerIdsForTag(final ReaderTag tag) {
<span class="nc bnc" id="L708" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L709">            return null;</span>
        }

<span class="nc" id="L712">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L713">        String sql = &quot;SELECT blog_id, post_id FROM tbl_posts WHERE has_gap_marker!=0 AND tag_name=? AND tag_type=?&quot;;</span>
<span class="nc" id="L714">        Cursor cursor = ReaderDatabase.getReadableDb().rawQuery(sql, args);</span>
        try {
<span class="nc bnc" id="L716" title="All 2 branches missed.">            if (cursor.moveToFirst()) {</span>
<span class="nc" id="L717">                long blogId = cursor.getLong(0);</span>
<span class="nc" id="L718">                long postId = cursor.getLong(1);</span>
<span class="nc" id="L719">                return new ReaderBlogIdPostId(blogId, postId);</span>
            } else {
<span class="nc" id="L721">                return null;</span>
            }
        } finally {
<span class="nc" id="L724">            SqlUtils.closeCursor(cursor);</span>
        }
    }

    public static void setGapMarkerForTag(long blogId, long postId, ReaderTag tag) {
<span class="nc bnc" id="L729" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L730">            return;</span>
        }

<span class="nc" id="L733">        String[] args = {</span>
<span class="nc" id="L734">                Long.toString(blogId),</span>
<span class="nc" id="L735">                Long.toString(postId),</span>
<span class="nc" id="L736">                tag.getTagSlug(),</span>
<span class="nc" id="L737">                Integer.toString(tag.tagType.toInt())</span>
        };
<span class="nc" id="L739">        String sql =</span>
                &quot;UPDATE tbl_posts SET has_gap_marker=1 WHERE blog_id=? AND post_id=? AND tag_name=? AND tag_type=?&quot;;
<span class="nc" id="L741">        ReaderDatabase.getWritableDb().execSQL(sql, args);</span>
<span class="nc" id="L742">        EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
<span class="nc" id="L743">    }</span>

    public static String getGapMarkerDateForTag(ReaderTag tag) {
<span class="nc" id="L746">        ReaderBlogIdPostId ids = getGapMarkerIdsForTag(tag);</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">        if (ids == null) {</span>
<span class="nc" id="L748">            return null;</span>
        }

<span class="nc" id="L751">        String dateColumn = getSortColumnForTag(tag);</span>
<span class="nc" id="L752">        String[] args = {Long.toString(ids.getBlogId()), Long.toString(ids.getPostId())};</span>
<span class="nc" id="L753">        String sql = &quot;SELECT &quot; + dateColumn + &quot; FROM tbl_posts WHERE blog_id=? AND post_id=?&quot;;</span>
<span class="nc" id="L754">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(), sql, args);</span>
    }

    /*
     * the column posts are sorted by depends on the type of tag stream being displayed:
     *
     * liked posts sort by the date the post was liked
     * followed posts sort by the date the post was published
     * search results sort by score
     * tagged posts sort by the date the post was tagged
     */
    private static String getSortColumnForTag(ReaderTag tag) {
<span class="nc bnc" id="L766" title="All 2 branches missed.">        if (tag.isPostsILike()) {</span>
<span class="nc" id="L767">            return &quot;date_liked&quot;;</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        } else if (tag.isFollowedSites()) {</span>
<span class="nc" id="L769">            return &quot;date_published&quot;;</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">        } else if (tag.tagType == ReaderTagType.SEARCH) {</span>
<span class="nc" id="L771">            return &quot;score&quot;;</span>
<span class="nc bnc" id="L772" title="All 4 branches missed.">        } else if (tag.isTagTopic() || tag.isBookmarked()) {</span>
<span class="nc" id="L773">            return &quot;date_tagged&quot;;</span>
        } else {
<span class="nc" id="L775">            return &quot;date_published&quot;;</span>
        }
    }

    /*
     * delete posts with the passed tag that come before the one with the gap marker for
     * this tag - note this may leave some stray posts in tbl_posts, but these will
     * be cleaned up by the next purge
     */
    public static void deletePostsBeforeGapMarkerForTag(ReaderTag tag) {
<span class="nc" id="L785">        String gapMarkerDate = getGapMarkerDateForTag(tag);</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">        if (TextUtils.isEmpty(gapMarkerDate)) {</span>
<span class="nc" id="L787">            return;</span>
        }

<span class="nc" id="L790">        String dateColumn = getSortColumnForTag(tag);</span>
<span class="nc" id="L791">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt()), gapMarkerDate};</span>
<span class="nc" id="L792">        String where = &quot;tag_name=? AND tag_type=? AND &quot; + dateColumn + &quot; &lt; ?&quot;;</span>
<span class="nc" id="L793">        int numDeleted = ReaderDatabase.getWritableDb().delete(&quot;tbl_posts&quot;, where, args);</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">        if (numDeleted &gt; 0) {</span>
<span class="nc" id="L795">            AppLog.d(AppLog.T.READER, &quot;removed &quot; + numDeleted + &quot; posts older than gap marker&quot;);</span>
<span class="nc" id="L796">            EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
        }
<span class="nc" id="L798">    }</span>

    public static void setFollowStatusForPostsInBlog(long blogId, boolean isFollowed) {
<span class="nc" id="L801">        setFollowStatusForPosts(blogId, 0, isFollowed);</span>
<span class="nc" id="L802">    }</span>

    public static void setFollowStatusForPostsInFeed(long feedId, boolean isFollowed) {
<span class="nc" id="L805">        setFollowStatusForPosts(0, feedId, isFollowed);</span>
<span class="nc" id="L806">    }</span>

    private static void setFollowStatusForPosts(long blogId, long feedId, boolean isFollowed) {
<span class="nc bnc" id="L809" title="All 4 branches missed.">        if (blogId == 0 &amp;&amp; feedId == 0) {</span>
<span class="nc" id="L810">            return;</span>
        }

<span class="nc" id="L813">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L814">        db.beginTransaction();</span>
        try {
<span class="nc bnc" id="L816" title="All 2 branches missed.">            if (blogId != 0) {</span>
<span class="nc" id="L817">                String sql = &quot;UPDATE tbl_posts SET is_followed=&quot; + SqlUtils.boolToSql(isFollowed)</span>
                             + &quot; WHERE blog_id=?&quot;;
<span class="nc" id="L819">                db.execSQL(sql, new String[]{Long.toString(blogId)});</span>
<span class="nc" id="L820">            } else {</span>
<span class="nc" id="L821">                String sql = &quot;UPDATE tbl_posts SET is_followed=&quot; + SqlUtils.boolToSql(isFollowed)</span>
                             + &quot; WHERE feed_id=?&quot;;
<span class="nc" id="L823">                db.execSQL(sql, new String[]{Long.toString(feedId)});</span>
            }


            // if blog/feed is no longer followed, remove its posts tagged with &quot;Followed Sites&quot; or &quot;P2&quot;
<span class="nc bnc" id="L828" title="All 2 branches missed.">            if (!isFollowed) {</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                if (blogId != 0) {</span>
<span class="nc" id="L830">                    db.delete(&quot;tbl_posts&quot;, &quot;blog_id=? AND (tag_name=? OR tag_name=?)&quot;,</span>
<span class="nc" id="L831">                            new String[]{Long.toString(blogId), ReaderTag.TAG_TITLE_FOLLOWED_SITES,</span>
                                    ReaderTag.TAG_SLUG_P2});
                } else {
<span class="nc" id="L834">                    db.delete(&quot;tbl_posts&quot;, &quot;feed_id=? AND (tag_name=? OR tag_name=?)&quot;,</span>
<span class="nc" id="L835">                            new String[]{Long.toString(feedId), ReaderTag.TAG_TITLE_FOLLOWED_SITES,</span>
                                    ReaderTag.TAG_SLUG_P2});
                }
            }

<span class="nc" id="L840">            db.setTransactionSuccessful();</span>
<span class="nc" id="L841">            EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
        } finally {
<span class="nc" id="L843">            db.endTransaction();</span>
        }
<span class="nc" id="L845">    }</span>

    /**
     * Android's CursorWindow has a max size of 2MB per row which can be exceeded
     * with a very large text column, causing an IllegalStateException when the
     * row is read - prevent this by limiting the amount of text that's stored in
     * the text column - note that this situation very rarely occurs
     * http://bit.ly/2Fs7B78
     * http://bit.ly/2oOKCJc
     */
    private static final int MAX_TEXT_LEN = (1024 * 1024) / 2;

    private static String maxText(final ReaderPost post) {
<span class="nc bnc" id="L858" title="All 2 branches missed.">        if (post.getText().length() &lt;= MAX_TEXT_LEN) {</span>
<span class="nc" id="L859">            return post.getText();</span>
        }
        // if the post has an excerpt (which should always be the case), store it as the full text
        // with a link to the full article
<span class="nc bnc" id="L863" title="All 2 branches missed.">        if (post.hasExcerpt()) {</span>
<span class="nc" id="L864">            AppLog.w(AppLog.T.READER, &quot;reader post table &gt; max text exceeded, storing excerpt&quot;);</span>
<span class="nc" id="L865">            return &quot;&lt;p&gt;&quot; + post.getExcerpt() + &quot;&lt;/p&gt;&quot;</span>
<span class="nc" id="L866">                   + String.format(&quot;&lt;p style='text-align:center'&gt;&lt;a href='%s'&gt;%s&lt;/a&gt;&lt;/p&gt;&quot;,</span>
<span class="nc" id="L867">                    post.getUrl(),</span>
<span class="nc" id="L868">                    WordPress.getContext().getString(R.string.reader_label_view_original));</span>
        } else {
<span class="nc" id="L870">            AppLog.w(AppLog.T.READER, &quot;reader post table &gt; max text exceeded, storing truncated text&quot;);</span>
<span class="nc" id="L871">            return post.getText().substring(0, MAX_TEXT_LEN);</span>
        }
    }

    public static void addOrUpdatePosts(final ReaderTag tag, ReaderPostList posts) {
<span class="nc bnc" id="L876" title="All 4 branches missed.">        if (posts == null || posts.size() == 0) {</span>
<span class="nc" id="L877">            return;</span>
        }

<span class="nc" id="L880">        updateIsBookmarkedField(posts);</span>

<span class="nc" id="L882">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L883">        SQLiteStatement stmtPosts = db.compileStatement(</span>
                &quot;INSERT OR REPLACE INTO tbl_posts (&quot;
                + COLUMN_NAMES
                + &quot;) VALUES (?1,?2,?3,?4,?5,?6,?7,?8,?9,?10,?11,?12,?13,?14,?15,?16,?17,?18,?19,?20,?21,?22,?23,?24,&quot;
                + &quot;?25,?26,?27,?28,?29,?30,?31,?32,?33,?34,?35,?36,?37,?38,?39,?40,?41,?42,?43,?44, ?45, ?46, ?47,&quot;
                + &quot;?48,?49,?50,?51,?52,?53)&quot;);

<span class="nc" id="L890">        db.beginTransaction();</span>
        try {
<span class="nc bnc" id="L892" title="All 2 branches missed.">            String tagName = (tag != null ? tag.getTagSlug() : &quot;&quot;);</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">            int tagType = (tag != null ? tag.tagType.toInt() : 0);</span>

<span class="nc" id="L895">            ReaderBlogIdPostId postWithGapMarker = getGapMarkerIdsForTag(tag);</span>

<span class="nc bnc" id="L897" title="All 2 branches missed.">            for (ReaderPost post : posts) {</span>
                // keep the gapMarker flag
<span class="nc bnc" id="L899" title="All 4 branches missed.">                boolean hasGapMarker = postWithGapMarker != null &amp;&amp; postWithGapMarker.getPostId() == post.postId</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">                                       &amp;&amp; postWithGapMarker.getBlogId() == post.blogId;</span>
<span class="nc" id="L901">                stmtPosts.bindLong(1, post.postId);</span>
<span class="nc" id="L902">                stmtPosts.bindLong(2, post.blogId);</span>
<span class="nc" id="L903">                stmtPosts.bindLong(3, post.feedId);</span>
<span class="nc" id="L904">                stmtPosts.bindLong(4, post.feedItemId);</span>
<span class="nc" id="L905">                stmtPosts.bindString(5, post.getPseudoId());</span>
<span class="nc" id="L906">                stmtPosts.bindString(6, post.getAuthorName());</span>
<span class="nc" id="L907">                stmtPosts.bindString(7, post.getAuthorFirstName());</span>
<span class="nc" id="L908">                stmtPosts.bindLong(8, post.authorId);</span>
<span class="nc" id="L909">                stmtPosts.bindString(9, post.getTitle());</span>
<span class="nc" id="L910">                stmtPosts.bindString(10, maxText(post));</span>
<span class="nc" id="L911">                stmtPosts.bindString(11, post.getExcerpt());</span>
<span class="nc" id="L912">                stmtPosts.bindString(12, post.getFormat());</span>
<span class="nc" id="L913">                stmtPosts.bindString(13, post.getUrl());</span>
<span class="nc" id="L914">                stmtPosts.bindString(14, post.getShortUrl());</span>
<span class="nc" id="L915">                stmtPosts.bindString(15, post.getBlogName());</span>
<span class="nc" id="L916">                stmtPosts.bindString(16, post.getBlogUrl());</span>
<span class="nc" id="L917">                stmtPosts.bindString(17, post.getBlogImageUrl());</span>
<span class="nc" id="L918">                stmtPosts.bindString(18, post.getFeaturedImage());</span>
<span class="nc" id="L919">                stmtPosts.bindString(19, post.getFeaturedVideo());</span>
<span class="nc" id="L920">                stmtPosts.bindString(20, post.getPostAvatar());</span>
<span class="nc" id="L921">                stmtPosts.bindDouble(21, post.score);</span>
<span class="nc" id="L922">                stmtPosts.bindString(22, post.getDatePublished());</span>
<span class="nc" id="L923">                stmtPosts.bindString(23, post.getDateLiked());</span>
<span class="nc" id="L924">                stmtPosts.bindString(24, post.getDateTagged());</span>
<span class="nc" id="L925">                stmtPosts.bindLong(25, post.numReplies);</span>
<span class="nc" id="L926">                stmtPosts.bindLong(26, post.numLikes);</span>
<span class="nc" id="L927">                stmtPosts.bindLong(27, SqlUtils.boolToSql(post.isLikedByCurrentUser));</span>
<span class="nc" id="L928">                stmtPosts.bindLong(28, SqlUtils.boolToSql(post.isFollowedByCurrentUser));</span>
<span class="nc" id="L929">                stmtPosts.bindLong(29, SqlUtils.boolToSql(post.isCommentsOpen));</span>
<span class="nc" id="L930">                stmtPosts.bindLong(30, SqlUtils.boolToSql(post.isExternal));</span>
<span class="nc" id="L931">                stmtPosts.bindLong(31, SqlUtils.boolToSql(post.isPrivate));</span>
<span class="nc" id="L932">                stmtPosts.bindLong(32, SqlUtils.boolToSql(post.isVideoPress));</span>
<span class="nc" id="L933">                stmtPosts.bindLong(33, SqlUtils.boolToSql(post.isJetpack));</span>
<span class="nc" id="L934">                stmtPosts.bindString(34, post.getPrimaryTag());</span>
<span class="nc" id="L935">                stmtPosts.bindString(35, post.getSecondaryTag());</span>
<span class="nc" id="L936">                stmtPosts.bindString(36, post.getAttachmentsJson());</span>
<span class="nc" id="L937">                stmtPosts.bindString(37, post.getDiscoverJson());</span>
<span class="nc" id="L938">                stmtPosts.bindLong(38, post.xpostPostId);</span>
<span class="nc" id="L939">                stmtPosts.bindLong(39, post.xpostBlogId);</span>
<span class="nc" id="L940">                stmtPosts.bindString(40, post.getRailcarJson());</span>
<span class="nc" id="L941">                stmtPosts.bindString(41, tagName);</span>
<span class="nc" id="L942">                stmtPosts.bindLong(42, tagType);</span>
<span class="nc" id="L943">                stmtPosts.bindLong(43, SqlUtils.boolToSql(hasGapMarker));</span>
<span class="nc" id="L944">                stmtPosts.bindString(44, ReaderCardType.toString(post.getCardType()));</span>
<span class="nc" id="L945">                stmtPosts.bindLong(45, SqlUtils.boolToSql(post.useExcerpt));</span>
<span class="nc" id="L946">                stmtPosts.bindLong(46, SqlUtils.boolToSql(post.isBookmarked));</span>
<span class="nc" id="L947">                stmtPosts.bindLong(47, SqlUtils.boolToSql(post.isPrivateAtomic));</span>
<span class="nc" id="L948">                stmtPosts.bindString(48, ReaderUtils.getCommaSeparatedTagSlugs(post.getTags()));</span>
<span class="nc" id="L949">                stmtPosts.bindLong(49, post.organizationId);</span>
<span class="nc" id="L950">                stmtPosts.bindLong(50, SqlUtils.boolToSql(post.isSeen));</span>
<span class="nc" id="L951">                stmtPosts.bindLong(51, SqlUtils.boolToSql(post.isSeenSupported));</span>
<span class="nc" id="L952">                stmtPosts.bindLong(52, post.authorBlogId);</span>
<span class="nc" id="L953">                stmtPosts.bindString(53, post.getAuthorBlogUrl());</span>
<span class="nc" id="L954">                stmtPosts.execute();</span>
<span class="nc" id="L955">            }</span>

<span class="nc" id="L957">            db.setTransactionSuccessful();</span>
<span class="nc" id="L958">            EventBus.getDefault().post(ReaderPostTableActionEnded.INSTANCE);</span>
        } finally {
<span class="nc" id="L960">            db.endTransaction();</span>
<span class="nc" id="L961">            SqlUtils.closeStatement(stmtPosts);</span>
        }
<span class="nc" id="L963">    }</span>

    public static ReaderPostList getPostsWithTag(ReaderTag tag, int maxPosts, boolean excludeTextColumn) {
<span class="nc bnc" id="L966" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L967">            return new ReaderPostList();</span>
        }

<span class="nc bnc" id="L970" title="All 2 branches missed.">        String columns = (excludeTextColumn ? COLUMN_NAMES_NO_TEXT : &quot;*&quot;);</span>
<span class="nc" id="L971">        String sql = &quot;SELECT &quot; + columns + &quot; FROM tbl_posts WHERE tag_name=? AND tag_type=?&quot;;</span>

<span class="nc bnc" id="L973" title="All 2 branches missed.">        if (tag.tagType == ReaderTagType.DEFAULT) {</span>
            // skip posts that are no longer liked if this is &quot;Posts I Like&quot;, skip posts that are no
            // longer followed if this is &quot;Followed Sites&quot;
<span class="nc bnc" id="L976" title="All 2 branches missed.">            if (tag.isPostsILike()) {</span>
<span class="nc" id="L977">                sql += &quot; AND is_liked != 0&quot;;</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">            } else if (tag.isFollowedSites()) {</span>
<span class="nc" id="L979">                sql += &quot; AND is_followed != 0&quot;;</span>
            }
        }

<span class="nc" id="L983">        sql += &quot; ORDER BY &quot; + getSortColumnForTag(tag) + &quot; DESC&quot;;</span>

<span class="nc bnc" id="L985" title="All 2 branches missed.">        if (maxPosts &gt; 0) {</span>
<span class="nc" id="L986">            sql += &quot; LIMIT &quot; + maxPosts;</span>
        }

<span class="nc" id="L989">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L990">        Cursor cursor = ReaderDatabase.getReadableDb().rawQuery(sql, args);</span>
        try {
<span class="nc" id="L992">            return getPostListFromCursor(cursor);</span>
        } finally {
<span class="nc" id="L994">            SqlUtils.closeCursor(cursor);</span>
        }
    }

    public static ReaderPostList getPostsInBlog(long blogId, int maxPosts, boolean excludeTextColumn) {
<span class="nc bnc" id="L999" title="All 2 branches missed.">        String columns = (excludeTextColumn ? COLUMN_NAMES_NO_TEXT : &quot;*&quot;);</span>
<span class="nc" id="L1000">        String sql =</span>
                &quot;SELECT &quot; + columns + &quot; FROM tbl_posts WHERE blog_id=? AND tag_name='' AND tag_type=0&quot;
                + &quot; ORDER BY date_published DESC&quot;;

<span class="nc bnc" id="L1004" title="All 2 branches missed.">        if (maxPosts &gt; 0) {</span>
<span class="nc" id="L1005">            sql += &quot; LIMIT &quot; + maxPosts;</span>
        }

<span class="nc" id="L1008">        Cursor cursor = ReaderDatabase.getReadableDb().rawQuery(sql, new String[]{Long.toString(blogId)});</span>
        try {
<span class="nc" id="L1010">            return getPostListFromCursor(cursor);</span>
        } finally {
<span class="nc" id="L1012">            SqlUtils.closeCursor(cursor);</span>
        }
    }

    public static Map&lt;Pair&lt;String, ReaderTagType&gt;, ReaderPostList&gt; getTagPostMap(long blogId) {
<span class="nc" id="L1017">        String sql = &quot;SELECT * FROM tbl_posts WHERE blog_id=?&quot;;</span>
<span class="nc" id="L1018">        Cursor cursor = ReaderDatabase.getReadableDb().rawQuery(sql, new String[]{Long.toString(blogId)});</span>
        try {
<span class="nc" id="L1020">            return getTagPostMapFromCursor(cursor);</span>
        } finally {
<span class="nc" id="L1022">            SqlUtils.closeCursor(cursor);</span>
        }
    }

    public static ReaderPostList getPostsInFeed(long feedId, int maxPosts, boolean excludeTextColumn) {
<span class="nc bnc" id="L1027" title="All 2 branches missed.">        String columns = (excludeTextColumn ? COLUMN_NAMES_NO_TEXT : &quot;*&quot;);</span>
<span class="nc" id="L1028">        String sql =</span>
                &quot;SELECT &quot; + columns + &quot; FROM tbl_posts WHERE feed_id=? AND tag_name='' AND tag_type=0&quot;
                + &quot; ORDER BY date_published DESC&quot;;

<span class="nc bnc" id="L1032" title="All 2 branches missed.">        if (maxPosts &gt; 0) {</span>
<span class="nc" id="L1033">            sql += &quot; LIMIT &quot; + maxPosts;</span>
        }

<span class="nc" id="L1036">        Cursor cursor = ReaderDatabase.getReadableDb().rawQuery(sql, new String[]{Long.toString(feedId)});</span>
        try {
<span class="nc" id="L1038">            return getPostListFromCursor(cursor);</span>
        } finally {
<span class="nc" id="L1040">            SqlUtils.closeCursor(cursor);</span>
        }
    }

    /*
     * same as getPostsWithTag() but only returns the blogId/postId pairs
     */
    public static ReaderBlogIdPostIdList getBlogIdPostIdsWithTag(ReaderTag tag, int maxPosts) {
<span class="nc bnc" id="L1048" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L1049">            return new ReaderBlogIdPostIdList();</span>
        }

<span class="nc" id="L1052">        String sql = &quot;SELECT blog_id, post_id FROM tbl_posts WHERE tag_name=? AND tag_type=?&quot;;</span>

<span class="nc bnc" id="L1054" title="All 2 branches missed.">        if (tag.tagType == ReaderTagType.DEFAULT) {</span>
<span class="nc bnc" id="L1055" title="All 2 branches missed.">            if (tag.isPostsILike()) {</span>
<span class="nc" id="L1056">                sql += &quot; AND is_liked != 0&quot;;</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">            } else if (tag.isFollowedSites()) {</span>
<span class="nc" id="L1058">                sql += &quot; AND is_followed != 0&quot;;</span>
            }
        }

<span class="nc" id="L1062">        sql += &quot; ORDER BY &quot; + getSortColumnForTag(tag) + &quot; DESC&quot;;</span>

<span class="nc bnc" id="L1064" title="All 2 branches missed.">        if (maxPosts &gt; 0) {</span>
<span class="nc" id="L1065">            sql += &quot; LIMIT &quot; + maxPosts;</span>
        }

<span class="nc" id="L1068">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L1069">        return getBlogIdPostIds(sql, args);</span>
    }

    private static ReaderBlogIdPostIdList getBlogIdPostIdsWithTagType(ReaderTagType tagType, int maxPosts) {
<span class="nc bnc" id="L1073" title="All 2 branches missed.">        if (tagType == null) {</span>
<span class="nc" id="L1074">            return new ReaderBlogIdPostIdList();</span>
        }

<span class="nc" id="L1077">        String sql = &quot;SELECT blog_id, post_id FROM tbl_posts WHERE tag_type=?&quot;;</span>

<span class="nc bnc" id="L1079" title="All 2 branches missed.">        if (maxPosts &gt; 0) {</span>
<span class="nc" id="L1080">            sql += &quot; LIMIT &quot; + maxPosts;</span>
        }

<span class="nc" id="L1083">        String[] args = {Integer.toString(tagType.toInt())};</span>
<span class="nc" id="L1084">        return getBlogIdPostIds(sql, args);</span>
    }

    private static ReaderBlogIdPostIdList getBlogIdPostIds(@NonNull String sql, @NonNull String[] args) {
<span class="nc" id="L1088">        ReaderBlogIdPostIdList idList = new ReaderBlogIdPostIdList();</span>
<span class="nc" id="L1089">        Cursor cursor = ReaderDatabase.getReadableDb().rawQuery(sql, args);</span>
        try {
<span class="nc bnc" id="L1091" title="All 4 branches missed.">            if (cursor != null &amp;&amp; cursor.moveToFirst()) {</span>
                do {
<span class="nc" id="L1093">                    idList.add(new ReaderBlogIdPostId(cursor.getLong(0), cursor.getLong(1)));</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">                } while (cursor.moveToNext());</span>
            }
<span class="nc" id="L1096">            return idList;</span>
        } finally {
<span class="nc" id="L1098">            SqlUtils.closeCursor(cursor);</span>
        }
    }

    /*
     * same as getPostsInBlog() but only returns the blogId/postId pairs
     */
    public static ReaderBlogIdPostIdList getBlogIdPostIdsInBlog(long blogId, int maxPosts) {
<span class="nc" id="L1106">        String sql = &quot;SELECT post_id FROM tbl_posts WHERE blog_id=? AND tag_name='' AND tag_type=0&quot;</span>
                     + &quot; ORDER BY date_published DESC&quot;;

<span class="nc bnc" id="L1109" title="All 2 branches missed.">        if (maxPosts &gt; 0) {</span>
<span class="nc" id="L1110">            sql += &quot; LIMIT &quot; + maxPosts;</span>
        }

<span class="nc" id="L1113">        Cursor cursor = ReaderDatabase.getReadableDb().rawQuery(sql, new String[]{Long.toString(blogId)});</span>
        try {
<span class="nc" id="L1115">            ReaderBlogIdPostIdList idList = new ReaderBlogIdPostIdList();</span>
<span class="nc bnc" id="L1116" title="All 4 branches missed.">            if (cursor != null &amp;&amp; cursor.moveToFirst()) {</span>
                do {
<span class="nc" id="L1118">                    idList.add(new ReaderBlogIdPostId(blogId, cursor.getLong(0)));</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">                } while (cursor.moveToNext());</span>
            }

<span class="nc" id="L1122">            return idList;</span>
        } finally {
<span class="nc" id="L1124">            SqlUtils.closeCursor(cursor);</span>
        }
    }

    private static Pair&lt;String, ReaderTagType&gt; getTagNameAndTypeFromCursor(Cursor c) {
<span class="nc bnc" id="L1129" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L1130">            throw new IllegalArgumentException(&quot;getPostFromCursor &gt; null cursor&quot;);</span>
        }
<span class="nc" id="L1132">        return new Pair&lt;&gt;(</span>
<span class="nc" id="L1133">                c.getString(c.getColumnIndexOrThrow(&quot;tag_name&quot;)),</span>
<span class="nc" id="L1134">                ReaderTagType.fromInt(c.getInt(c.getColumnIndexOrThrow(&quot;tag_type&quot;)))</span>
        );
    }

    private static ReaderPost getPostFromCursor(Cursor c) {
<span class="nc bnc" id="L1139" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L1140">            throw new IllegalArgumentException(&quot;getPostFromCursor &gt; null cursor&quot;);</span>
        }

<span class="nc" id="L1143">        ReaderPost post = new ReaderPost();</span>

        // text column is skipped when retrieving multiple rows
<span class="nc" id="L1146">        int idxText = c.getColumnIndex(&quot;text&quot;);</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">        if (idxText &gt; -1) {</span>
<span class="nc" id="L1148">            post.setText(c.getString(idxText));</span>
        }

<span class="nc" id="L1151">        post.postId = c.getLong(c.getColumnIndexOrThrow(&quot;post_id&quot;));</span>
<span class="nc" id="L1152">        post.blogId = c.getLong(c.getColumnIndexOrThrow(&quot;blog_id&quot;));</span>
<span class="nc" id="L1153">        post.feedId = c.getLong(c.getColumnIndexOrThrow(&quot;feed_id&quot;));</span>
<span class="nc" id="L1154">        post.feedItemId = c.getLong(c.getColumnIndexOrThrow(&quot;feed_item_id&quot;));</span>
<span class="nc" id="L1155">        post.authorId = c.getLong(c.getColumnIndexOrThrow(&quot;author_id&quot;));</span>
<span class="nc" id="L1156">        post.setPseudoId(c.getString(c.getColumnIndexOrThrow(&quot;pseudo_id&quot;)));</span>

<span class="nc" id="L1158">        post.setAuthorName(c.getString(c.getColumnIndexOrThrow(&quot;author_name&quot;)));</span>
<span class="nc" id="L1159">        post.setAuthorFirstName(c.getString(c.getColumnIndexOrThrow(&quot;author_first_name&quot;)));</span>
<span class="nc" id="L1160">        post.setBlogName(c.getString(c.getColumnIndexOrThrow(&quot;blog_name&quot;)));</span>
<span class="nc" id="L1161">        post.setBlogUrl(c.getString(c.getColumnIndexOrThrow(&quot;blog_url&quot;)));</span>
<span class="nc" id="L1162">        post.setBlogImageUrl(c.getString(c.getColumnIndexOrThrow(&quot;blog_image_url&quot;)));</span>
<span class="nc" id="L1163">        post.setExcerpt(c.getString(c.getColumnIndexOrThrow(&quot;excerpt&quot;)));</span>
<span class="nc" id="L1164">        post.setFormat(c.getString(c.getColumnIndexOrThrow(&quot;format&quot;)));</span>
<span class="nc" id="L1165">        post.setFeaturedImage(c.getString(c.getColumnIndexOrThrow(&quot;featured_image&quot;)));</span>
<span class="nc" id="L1166">        post.setFeaturedVideo(c.getString(c.getColumnIndexOrThrow(&quot;featured_video&quot;)));</span>

<span class="nc" id="L1168">        post.setTitle(c.getString(c.getColumnIndexOrThrow(&quot;title&quot;)));</span>
<span class="nc" id="L1169">        post.setUrl(c.getString(c.getColumnIndexOrThrow(&quot;url&quot;)));</span>
<span class="nc" id="L1170">        post.setShortUrl(c.getString(c.getColumnIndexOrThrow(&quot;short_url&quot;)));</span>
<span class="nc" id="L1171">        post.setPostAvatar(c.getString(c.getColumnIndexOrThrow(&quot;post_avatar&quot;)));</span>

<span class="nc" id="L1173">        post.setDatePublished(c.getString(c.getColumnIndexOrThrow(&quot;date_published&quot;)));</span>
<span class="nc" id="L1174">        post.setDateLiked(c.getString(c.getColumnIndexOrThrow(&quot;date_liked&quot;)));</span>
<span class="nc" id="L1175">        post.setDateTagged(c.getString(c.getColumnIndexOrThrow(&quot;date_tagged&quot;)));</span>

<span class="nc" id="L1177">        post.score = c.getDouble(c.getColumnIndexOrThrow(&quot;score&quot;));</span>
<span class="nc" id="L1178">        post.numReplies = c.getInt(c.getColumnIndexOrThrow(&quot;num_replies&quot;));</span>
<span class="nc" id="L1179">        post.numLikes = c.getInt(c.getColumnIndexOrThrow(&quot;num_likes&quot;));</span>

<span class="nc" id="L1181">        post.isLikedByCurrentUser = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_liked&quot;)));</span>
<span class="nc" id="L1182">        post.isFollowedByCurrentUser = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_followed&quot;)));</span>
<span class="nc" id="L1183">        post.isCommentsOpen = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_comments_open&quot;)));</span>
<span class="nc" id="L1184">        post.isExternal = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_external&quot;)));</span>
<span class="nc" id="L1185">        post.isPrivate = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_private&quot;)));</span>
<span class="nc" id="L1186">        post.isPrivateAtomic = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_private_atomic&quot;)));</span>
<span class="nc" id="L1187">        post.isVideoPress = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_videopress&quot;)));</span>
<span class="nc" id="L1188">        post.isJetpack = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_jetpack&quot;)));</span>
<span class="nc" id="L1189">        post.isBookmarked = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_bookmarked&quot;)));</span>

<span class="nc" id="L1191">        post.setPrimaryTag(c.getString(c.getColumnIndexOrThrow(&quot;primary_tag&quot;)));</span>
<span class="nc" id="L1192">        post.setSecondaryTag(c.getString(c.getColumnIndexOrThrow(&quot;secondary_tag&quot;)));</span>

<span class="nc" id="L1194">        post.setAttachmentsJson(c.getString(c.getColumnIndexOrThrow(&quot;attachments_json&quot;)));</span>
<span class="nc" id="L1195">        post.setDiscoverJson(c.getString(c.getColumnIndexOrThrow(&quot;discover_json&quot;)));</span>

<span class="nc" id="L1197">        post.xpostPostId = c.getLong(c.getColumnIndexOrThrow(&quot;xpost_post_id&quot;));</span>
<span class="nc" id="L1198">        post.xpostBlogId = c.getLong(c.getColumnIndexOrThrow(&quot;xpost_blog_id&quot;));</span>

<span class="nc" id="L1200">        post.setRailcarJson(c.getString(c.getColumnIndexOrThrow(&quot;railcar_json&quot;)));</span>
<span class="nc" id="L1201">        post.setCardType(ReaderCardType.fromString(c.getString(c.getColumnIndexOrThrow(&quot;card_type&quot;))));</span>

<span class="nc" id="L1203">        post.useExcerpt = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;use_excerpt&quot;)));</span>

<span class="nc" id="L1205">        post.isSeen = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_seen&quot;)));</span>
<span class="nc" id="L1206">        post.isSeenSupported = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_seen_supported&quot;)));</span>

<span class="nc" id="L1208">        String commaSeparatedTags = (c.getString(c.getColumnIndexOrThrow(&quot;tags&quot;)));</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">        if (commaSeparatedTags != null) {</span>
<span class="nc" id="L1210">            post.setTags(ReaderUtils.getTagsFromCommaSeparatedSlugs(commaSeparatedTags));</span>
        }

<span class="nc" id="L1213">        post.organizationId = c.getInt(c.getColumnIndexOrThrow(&quot;organization_id&quot;));</span>
<span class="nc" id="L1214">        post.authorBlogId = c.getLong(c.getColumnIndexOrThrow(&quot;author_blog_id&quot;));</span>
<span class="nc" id="L1215">        post.setAuthorBlogUrl(c.getString(c.getColumnIndexOrThrow(&quot;author_blog_url&quot;)));</span>

<span class="nc" id="L1217">        return post;</span>
    }

    private static ReaderPostList getPostListFromCursor(Cursor cursor) {
<span class="nc" id="L1221">        ReaderPostList posts = new ReaderPostList();</span>
        try {
<span class="nc bnc" id="L1223" title="All 4 branches missed.">            if (cursor != null &amp;&amp; cursor.moveToFirst()) {</span>
                do {
<span class="nc" id="L1225">                    posts.add(getPostFromCursor(cursor));</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">                } while (cursor.moveToNext());</span>
            }
<span class="nc" id="L1228">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L1229">            AppLog.e(AppLog.T.READER, e);</span>
<span class="nc" id="L1230">        }</span>
<span class="nc" id="L1231">        return posts;</span>
    }

    private static Map&lt;Pair&lt;String, ReaderTagType&gt;, ReaderPostList&gt; getTagPostMapFromCursor(Cursor cursor) {
<span class="nc" id="L1235">        Map&lt;Pair&lt;String, ReaderTagType&gt;, ReaderPostList&gt; posts = new LinkedHashMap&lt;&gt;();</span>
        try {
<span class="nc bnc" id="L1237" title="All 4 branches missed.">            if (cursor != null &amp;&amp; cursor.moveToFirst()) {</span>
                do {
<span class="nc" id="L1239">                    ReaderPost post = getPostFromCursor(cursor);</span>
<span class="nc" id="L1240">                    Pair&lt;String, ReaderTagType&gt; tagNameAndType = getTagNameAndTypeFromCursor(cursor);</span>
<span class="nc bnc" id="L1241" title="All 2 branches missed.">                    if (!posts.containsKey(tagNameAndType)) {</span>
<span class="nc" id="L1242">                        posts.put(tagNameAndType, new ReaderPostList());</span>
                    }
<span class="nc" id="L1244">                    Objects.requireNonNull(posts.get(tagNameAndType)).add(post);</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">                } while (cursor.moveToNext());</span>
            }
<span class="nc" id="L1247">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L1248">            AppLog.e(AppLog.T.READER, e);</span>
<span class="nc" id="L1249">        }</span>
<span class="nc" id="L1250">        return posts;</span>
    }

    /**
     * Currently &quot;is_bookmarked&quot; field is not supported by the server, therefore posts from the server have always
     * is_bookmarked set to false. This method is a workaround which makes sure, that the field is always up to date
     * and synced across all instances(rows) of each post.
     */
    private static void updateIsBookmarkedField(final ReaderPostList posts) {
<span class="nc" id="L1259">        ReaderBlogIdPostIdList bookmarkedPosts = getBookmarkedPostIds();</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">        for (ReaderPost post : posts) {</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">            for (ReaderBlogIdPostId bookmarkedPostId : bookmarkedPosts) {</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">                if (isBookmarkedPost(post, bookmarkedPostId)) post.isBookmarked = true;</span>
<span class="nc" id="L1263">            }</span>
<span class="nc" id="L1264">        }</span>
<span class="nc" id="L1265">    }</span>

    private static boolean isBookmarkedPost(ReaderPost post, ReaderBlogIdPostId bookmarkedPostId) {
<span class="nc bnc" id="L1268" title="All 4 branches missed.">        return post.blogId == bookmarkedPostId.getBlogId() &amp;&amp; post.postId == bookmarkedPostId.getPostId();</span>
    }

    public static void updateBookmarkedPostPseudoId(final ReaderPostList posts) {
<span class="nc" id="L1272">        ReaderBlogIdPostIdList bookmarkedPosts = getBookmarkedPostIds();</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">        for (ReaderPost post : posts) {</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">            for (ReaderBlogIdPostId bookmarkedPostId : bookmarkedPosts) {</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">                if (isBookmarkedPost(post, bookmarkedPostId)) updateBookmarkedPostPseudoId(post, bookmarkedPostId);</span>
<span class="nc" id="L1276">            }</span>
<span class="nc" id="L1277">        }</span>
<span class="nc" id="L1278">    }</span>

    public static void updateBookmarkedPostPseudoId(ReaderPost post, ReaderBlogIdPostId bookmarkedPostIds) {
<span class="nc" id="L1281">        ReaderPost bookmarkedPost = getBlogPost(bookmarkedPostIds.getBlogId(), bookmarkedPostIds.getPostId(), true);</span>
<span class="nc bnc" id="L1282" title="All 4 branches missed.">        if (bookmarkedPost != null &amp;&amp; !bookmarkedPost.getPseudoId().equals(post.getPseudoId())) {</span>
<span class="nc" id="L1283">            SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L1284">            db.beginTransaction();</span>
            try {
<span class="nc" id="L1286">                String sql = &quot;UPDATE tbl_posts SET pseudo_id=? WHERE blog_id=? AND post_id=? AND tag_type=?&quot;;</span>
<span class="nc" id="L1287">                db.execSQL(sql, new String[]{</span>
<span class="nc" id="L1288">                        post.getPseudoId(),</span>
<span class="nc" id="L1289">                        Long.toString(post.blogId),</span>
<span class="nc" id="L1290">                        Long.toString(post.postId),</span>
<span class="nc" id="L1291">                        Integer.toString(ReaderTagType.BOOKMARKED.toInt())});</span>
<span class="nc" id="L1292">                db.setTransactionSuccessful();</span>
            } finally {
<span class="nc" id="L1294">                db.endTransaction();</span>
            }
        }
<span class="nc" id="L1297">    }</span>

    private static ReaderBlogIdPostIdList getBookmarkedPostIds() {
<span class="nc" id="L1300">        return getBlogIdPostIdsWithTagType(ReaderTagType.BOOKMARKED, 99999);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>