<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HeaderGridView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.widgets</a> &gt; <span class="el_source">HeaderGridView.java</span></div><h1>HeaderGridView.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2013 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.wordpress.android.widgets;

import android.content.Context;
import android.database.DataSetObservable;
import android.database.DataSetObserver;
import android.util.AttributeSet;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.Filter;
import android.widget.Filterable;
import android.widget.FrameLayout;
import android.widget.GridView;
import android.widget.ListAdapter;
import android.widget.ListView;
import android.widget.WrapperListAdapter;

import androidx.core.view.ViewCompat;

import java.util.ArrayList;

/**
 * A {@link GridView} that supports adding header rows in a
 * very similar way to {@link ListView}.
 * See {@link HeaderGridView#addHeaderView(View, Object, boolean)}
 */
public class HeaderGridView extends GridView {
    private static final String TAG = &quot;HeaderGridView&quot;;

    /**
     * A class that represents a fixed view in a list, for example a header at the top
     * or a footer at the bottom.
     */
    private static class FixedViewInfo {
        /** The view to add to the grid */
        public View view;
        public ViewGroup viewContainer;
        /** The data backing the view. This is returned from {@link ListAdapter#getItem(int)}. */
        public Object data;
        /** &lt;code&gt;true&lt;/code&gt; if the fixed view should be selectable in the grid */
        public boolean isSelectable;
    }

<span class="nc" id="L60">    private ArrayList&lt;FixedViewInfo&gt; mHeaderViewInfos = new ArrayList&lt;FixedViewInfo&gt;();</span>

    private void initHeaderGridView() {
<span class="nc" id="L63">        super.setClipChildren(false);</span>
<span class="nc" id="L64">    }</span>

    public HeaderGridView(Context context) {
<span class="nc" id="L67">        super(context);</span>
<span class="nc" id="L68">        initHeaderGridView();</span>
<span class="nc" id="L69">    }</span>

    public HeaderGridView(Context context, AttributeSet attrs) {
<span class="nc" id="L72">        super(context, attrs);</span>
<span class="nc" id="L73">        initHeaderGridView();</span>
<span class="nc" id="L74">    }</span>

    public HeaderGridView(Context context, AttributeSet attrs, int defStyle) {
<span class="nc" id="L77">        super(context, attrs, defStyle);</span>
<span class="nc" id="L78">        initHeaderGridView();</span>
<span class="nc" id="L79">    }</span>

    @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
<span class="nc" id="L83">        super.onMeasure(widthMeasureSpec, heightMeasureSpec);</span>
<span class="nc" id="L84">        ListAdapter adapter = getAdapter();</span>
<span class="nc bnc" id="L85" title="All 4 branches missed.">        if (adapter != null &amp;&amp; adapter instanceof HeaderViewGridAdapter) {</span>
<span class="nc" id="L86">            ((HeaderViewGridAdapter) adapter).setNumColumns(getNumColumns());</span>
        }
<span class="nc" id="L88">    }</span>

    @Override
    public void setClipChildren(boolean clipChildren) {
        // Ignore, since the header rows depend on not being clipped
<span class="nc" id="L93">    }</span>

    /**
     * Add a fixed view to appear at the top of the grid. If addHeaderView is
     * called more than once, the views will appear in the order they were
     * added. Views added using this call can take focus if they want.
     * &lt;p&gt;
     * NOTE: Call this before calling setAdapter. This is so HeaderGridView can wrap
     * the supplied cursor with one that will also account for header views.
     *
     * @param v The view to add.
     * @param data Data to associate with this view
     * @param isSelectable whether the item is selectable
     */
    public void addHeaderView(View v, Object data, boolean isSelectable) {
<span class="nc" id="L108">        ListAdapter adapter = getAdapter();</span>

<span class="nc bnc" id="L110" title="All 4 branches missed.">        if (adapter != null &amp;&amp; !(adapter instanceof HeaderViewGridAdapter)) {</span>
<span class="nc" id="L111">            throw new IllegalStateException(</span>
                    &quot;Cannot add header view to grid -- setAdapter has already been called.&quot;);
        }

<span class="nc" id="L115">        FixedViewInfo info = new FixedViewInfo();</span>
<span class="nc" id="L116">        FrameLayout fl = new FullWidthFixedViewLayout(getContext());</span>
<span class="nc" id="L117">        fl.addView(v);</span>
<span class="nc" id="L118">        info.view = v;</span>
<span class="nc" id="L119">        info.viewContainer = fl;</span>
<span class="nc" id="L120">        info.data = data;</span>
<span class="nc" id="L121">        info.isSelectable = isSelectable;</span>
<span class="nc" id="L122">        mHeaderViewInfos.add(info);</span>

        // in the case of re-adding a header view, or adding one later on,
        // we need to notify the observer
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (adapter != null) {</span>
<span class="nc" id="L127">            ((HeaderViewGridAdapter) adapter).notifyDataSetChanged();</span>
        }
<span class="nc" id="L129">    }</span>

    /**
     * Add a fixed view to appear at the top of the grid. If addHeaderView is
     * called more than once, the views will appear in the order they were
     * added. Views added using this call can take focus if they want.
     * &lt;p&gt;
     * NOTE: Call this before calling setAdapter. This is so HeaderGridView can wrap
     * the supplied cursor with one that will also account for header views.
     *
     * @param v The view to add.
     */
    public void addHeaderView(View v) {
<span class="nc" id="L142">        addHeaderView(v, null, true);</span>
<span class="nc" id="L143">    }</span>

    public int getHeaderViewCount() {
<span class="nc" id="L146">        return mHeaderViewInfos.size();</span>
    }

    /**
     * Removes a previously-added header view.
     *
     * @param v The view to remove
     * @return true if the view was removed, false if the view was not a header
     * view
     */
    public boolean removeHeaderView(View v) {
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (mHeaderViewInfos.size() &gt; 0) {</span>
<span class="nc" id="L158">            boolean result = false;</span>
<span class="nc" id="L159">            ListAdapter adapter = getAdapter();</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">            if (adapter != null &amp;&amp; ((HeaderViewGridAdapter) adapter).removeHeader(v)) {</span>
<span class="nc" id="L161">                result = true;</span>
            }
<span class="nc" id="L163">            removeFixedViewInfo(v, mHeaderViewInfos);</span>
<span class="nc" id="L164">            return result;</span>
        }
<span class="nc" id="L166">        return false;</span>
    }

    private void removeFixedViewInfo(View v, ArrayList&lt;FixedViewInfo&gt; where) {
<span class="nc" id="L170">        int len = where.size();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        for (int i = 0; i &lt; len; ++i) {</span>
<span class="nc" id="L172">            FixedViewInfo info = where.get(i);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (info.view == v) {</span>
<span class="nc" id="L174">                where.remove(i);</span>
<span class="nc" id="L175">                break;</span>
            }
        }
<span class="nc" id="L178">    }</span>

    @Override
    public void setAdapter(ListAdapter adapter) {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (mHeaderViewInfos.size() &gt; 0) {</span>
<span class="nc" id="L183">            HeaderViewGridAdapter hadapter = new HeaderViewGridAdapter(mHeaderViewInfos, adapter);</span>
<span class="nc" id="L184">            int numColumns = getNumColumns();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (numColumns &gt; 1) {</span>
<span class="nc" id="L186">                hadapter.setNumColumns(numColumns);</span>
            }
<span class="nc" id="L188">            super.setAdapter(hadapter);</span>
<span class="nc" id="L189">        } else {</span>
<span class="nc" id="L190">            super.setAdapter(adapter);</span>
        }
<span class="nc" id="L192">    }</span>

    private class FullWidthFixedViewLayout extends FrameLayout {
<span class="nc" id="L195">        FullWidthFixedViewLayout(Context context) {</span>
<span class="nc" id="L196">            super(context);</span>
<span class="nc" id="L197">        }</span>

        @Override
        protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
<span class="nc" id="L201">            int targetWidth = HeaderGridView.this.getMeasuredWidth()</span>
<span class="nc" id="L202">                    - ViewCompat.getPaddingStart(HeaderGridView.this)</span>
<span class="nc" id="L203">                    - ViewCompat.getPaddingEnd(HeaderGridView.this);</span>
<span class="nc" id="L204">            widthMeasureSpec = MeasureSpec.makeMeasureSpec(targetWidth,</span>
<span class="nc" id="L205">                    MeasureSpec.getMode(widthMeasureSpec));</span>
<span class="nc" id="L206">            super.onMeasure(widthMeasureSpec, heightMeasureSpec);</span>
<span class="nc" id="L207">        }</span>
    }

    /**
     * ListAdapter used when a HeaderGridView has header views. This ListAdapter
     * wraps another one and also keeps track of the header views and their
     * associated data objects.
     *&lt;p&gt;This is intended as a base class; you will probably not need to
     * use this class directly in your own code.
     */
    private static class HeaderViewGridAdapter implements WrapperListAdapter, Filterable {
        // This is used to notify the container of updates relating to number of columns
        // or headers changing, which changes the number of placeholders needed
<span class="nc" id="L220">        private final DataSetObservable mDataSetObservable = new DataSetObservable();</span>

        private final ListAdapter mAdapter;
<span class="nc" id="L223">        private int mNumColumns = 1;</span>

        // This ArrayList is assumed to NOT be null.
        ArrayList&lt;FixedViewInfo&gt; mHeaderViewInfos;

        boolean mAreAllFixedViewsSelectable;

        private final boolean mIsFilterable;

<span class="nc" id="L232">        HeaderViewGridAdapter(ArrayList&lt;FixedViewInfo&gt; headerViewInfos, ListAdapter adapter) {</span>
<span class="nc" id="L233">            mAdapter = adapter;</span>
<span class="nc" id="L234">            mIsFilterable = adapter instanceof Filterable;</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (headerViewInfos == null) {</span>
<span class="nc" id="L237">                throw new IllegalArgumentException(&quot;headerViewInfos cannot be null&quot;);</span>
            }
<span class="nc" id="L239">            mHeaderViewInfos = headerViewInfos;</span>

<span class="nc" id="L241">            mAreAllFixedViewsSelectable = areAllListInfosSelectable(mHeaderViewInfos);</span>
<span class="nc" id="L242">        }</span>

        public int getHeadersCount() {
<span class="nc" id="L245">            return mHeaderViewInfos.size();</span>
        }

        @Override
        public boolean isEmpty() {
<span class="nc bnc" id="L250" title="All 6 branches missed.">            return (mAdapter == null || mAdapter.isEmpty()) &amp;&amp; getHeadersCount() == 0;</span>
        }

        public void setNumColumns(int numColumns) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (numColumns &lt; 1) {</span>
<span class="nc" id="L255">                throw new IllegalArgumentException(&quot;Number of columns must be 1 or more&quot;);</span>
            }
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if (mNumColumns != numColumns) {</span>
<span class="nc" id="L258">                mNumColumns = numColumns;</span>
<span class="nc" id="L259">                notifyDataSetChanged();</span>
            }
<span class="nc" id="L261">        }</span>

        private boolean areAllListInfosSelectable(ArrayList&lt;FixedViewInfo&gt; infos) {
<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (infos != null) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                for (FixedViewInfo info : infos) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                    if (!info.isSelectable) {</span>
<span class="nc" id="L267">                        return false;</span>
                    }
<span class="nc" id="L269">                }</span>
            }
<span class="nc" id="L271">            return true;</span>
        }

        public boolean removeHeader(View v) {
<span class="nc bnc" id="L275" title="All 2 branches missed.">            for (int i = 0; i &lt; mHeaderViewInfos.size(); i++) {</span>
<span class="nc" id="L276">                FixedViewInfo info = mHeaderViewInfos.get(i);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                if (info.view == v) {</span>
<span class="nc" id="L278">                    mHeaderViewInfos.remove(i);</span>

<span class="nc" id="L280">                    mAreAllFixedViewsSelectable = areAllListInfosSelectable(mHeaderViewInfos);</span>

<span class="nc" id="L282">                    mDataSetObservable.notifyChanged();</span>
<span class="nc" id="L283">                    return true;</span>
                }
            }

<span class="nc" id="L287">            return false;</span>
        }

        @Override
        public int getCount() {
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc" id="L293">                return getHeadersCount() * mNumColumns + mAdapter.getCount();</span>
            } else {
<span class="nc" id="L295">                return getHeadersCount() * mNumColumns;</span>
            }
        }

        @Override
        public boolean areAllItemsEnabled() {
<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc bnc" id="L302" title="All 4 branches missed.">                return mAreAllFixedViewsSelectable &amp;&amp; mAdapter.areAllItemsEnabled();</span>
            } else {
<span class="nc" id="L304">                return true;</span>
            }
        }

        @Override
        public boolean isEnabled(int position) {
            // Header (negative positions will throw an ArrayIndexOutOfBoundsException)
<span class="nc" id="L311">            int numHeadersAndPlaceholders = getHeadersCount() * mNumColumns;</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (position &lt; numHeadersAndPlaceholders) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                return (position % mNumColumns == 0)</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                        &amp;&amp; mHeaderViewInfos.get(position / mNumColumns).isSelectable;</span>
            }

            // Adapter
<span class="nc" id="L318">            final int adjPosition = position - numHeadersAndPlaceholders;</span>
<span class="nc" id="L319">            int adapterCount = 0;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc" id="L321">                adapterCount = mAdapter.getCount();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                if (adjPosition &lt; adapterCount) {</span>
<span class="nc" id="L323">                    return mAdapter.isEnabled(adjPosition);</span>
                }
            }

<span class="nc" id="L327">            throw new ArrayIndexOutOfBoundsException(position);</span>
        }

        @Override
        public Object getItem(int position) {
            // Header (negative positions will throw an ArrayIndexOutOfBoundsException)
<span class="nc" id="L333">            int numHeadersAndPlaceholders = getHeadersCount() * mNumColumns;</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            if (position &lt; numHeadersAndPlaceholders) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">                if (position % mNumColumns == 0) {</span>
<span class="nc" id="L336">                    return mHeaderViewInfos.get(position / mNumColumns).data;</span>
                }
<span class="nc" id="L338">                return null;</span>
            }

            // Adapter
<span class="nc" id="L342">            final int adjPosition = position - numHeadersAndPlaceholders;</span>
<span class="nc" id="L343">            int adapterCount = 0;</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc" id="L345">                adapterCount = mAdapter.getCount();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                if (adjPosition &lt; adapterCount) {</span>
<span class="nc" id="L347">                    return mAdapter.getItem(adjPosition);</span>
                }
            }

<span class="nc" id="L351">            throw new ArrayIndexOutOfBoundsException(position);</span>
        }

        @Override
        public long getItemId(int position) {
<span class="nc" id="L356">            int numHeadersAndPlaceholders = getHeadersCount() * mNumColumns;</span>
<span class="nc bnc" id="L357" title="All 4 branches missed.">            if (mAdapter != null &amp;&amp; position &gt;= numHeadersAndPlaceholders) {</span>
<span class="nc" id="L358">                int adjPosition = position - numHeadersAndPlaceholders;</span>
<span class="nc" id="L359">                int adapterCount = mAdapter.getCount();</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                if (adjPosition &lt; adapterCount) {</span>
<span class="nc" id="L361">                    return mAdapter.getItemId(adjPosition);</span>
                }
            }
<span class="nc" id="L364">            return -1;</span>
        }

        @Override
        public boolean hasStableIds() {
<span class="nc bnc" id="L369" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc" id="L370">                return mAdapter.hasStableIds();</span>
            }
<span class="nc" id="L372">            return false;</span>
        }

        @Override
        public View getView(int position, View convertView, ViewGroup parent) {
            // Header (negative positions will throw an ArrayIndexOutOfBoundsException)
<span class="nc" id="L378">            int numHeadersAndPlaceholders = getHeadersCount() * mNumColumns;</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">            if (position &lt; numHeadersAndPlaceholders) {</span>
<span class="nc" id="L380">                View headerViewContainer = mHeaderViewInfos</span>
<span class="nc" id="L381">                        .get(position / mNumColumns).viewContainer;</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                if (position % mNumColumns == 0) {</span>
<span class="nc" id="L383">                    return headerViewContainer;</span>
                } else {
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    if (convertView == null) {</span>
<span class="nc" id="L386">                        convertView = new View(parent.getContext());</span>
                    }
                    // We need to do this because GridView uses the height of the last item
                    // in a row to determine the height for the entire row.
<span class="nc" id="L390">                    convertView.setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L391">                    convertView.setMinimumHeight(headerViewContainer.getHeight());</span>
<span class="nc" id="L392">                    return convertView;</span>
                }
            }

            // Adapter
<span class="nc" id="L397">            final int adjPosition = position - numHeadersAndPlaceholders;</span>
<span class="nc" id="L398">            int adapterCount = 0;</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc" id="L400">                adapterCount = mAdapter.getCount();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                if (adjPosition &lt; adapterCount) {</span>
<span class="nc" id="L402">                    return mAdapter.getView(adjPosition, convertView, parent);</span>
                }
            }

<span class="nc" id="L406">            throw new ArrayIndexOutOfBoundsException(position);</span>
        }

        @Override
        public int getItemViewType(int position) {
<span class="nc" id="L411">            int numHeadersAndPlaceholders = getHeadersCount() * mNumColumns;</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">            if (position &lt; numHeadersAndPlaceholders &amp;&amp; (position % mNumColumns != 0)) {</span>
                // Placeholders get the last view type number
<span class="nc bnc" id="L414" title="All 2 branches missed.">                return mAdapter != null ? mAdapter.getViewTypeCount() : 1;</span>
            }
<span class="nc bnc" id="L416" title="All 4 branches missed.">            if (mAdapter != null &amp;&amp; position &gt;= numHeadersAndPlaceholders) {</span>
<span class="nc" id="L417">                int adjPosition = position - numHeadersAndPlaceholders;</span>
<span class="nc" id="L418">                int adapterCount = mAdapter.getCount();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                if (adjPosition &lt; adapterCount) {</span>
<span class="nc" id="L420">                    return mAdapter.getItemViewType(adjPosition);</span>
                }
            }

<span class="nc" id="L424">            return AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER;</span>
        }

        @Override
        public int getViewTypeCount() {
<span class="nc bnc" id="L429" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc" id="L430">                return mAdapter.getViewTypeCount() + 1;</span>
            }
<span class="nc" id="L432">            return 2;</span>
        }

        @Override
        public void registerDataSetObserver(DataSetObserver observer) {
<span class="nc" id="L437">            mDataSetObservable.registerObserver(observer);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc" id="L439">                mAdapter.registerDataSetObserver(observer);</span>
            }
<span class="nc" id="L441">        }</span>

        @Override
        public void unregisterDataSetObserver(DataSetObserver observer) {
<span class="nc" id="L445">            mDataSetObservable.unregisterObserver(observer);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (mAdapter != null) {</span>
<span class="nc" id="L447">                mAdapter.unregisterDataSetObserver(observer);</span>
            }
<span class="nc" id="L449">        }</span>

        @Override
        public Filter getFilter() {
<span class="nc bnc" id="L453" title="All 2 branches missed.">            if (mIsFilterable) {</span>
<span class="nc" id="L454">                return ((Filterable) mAdapter).getFilter();</span>
            }
<span class="nc" id="L456">            return null;</span>
        }

        @Override
        public ListAdapter getWrappedAdapter() {
<span class="nc" id="L461">            return mAdapter;</span>
        }

        public void notifyDataSetChanged() {
<span class="nc" id="L465">            mDataSetObservable.notifyChanged();</span>
<span class="nc" id="L466">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>