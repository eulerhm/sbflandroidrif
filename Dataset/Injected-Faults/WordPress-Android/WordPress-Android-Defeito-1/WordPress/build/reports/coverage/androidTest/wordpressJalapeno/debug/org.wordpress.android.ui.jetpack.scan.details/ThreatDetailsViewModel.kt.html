<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThreatDetailsViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.jetpack.scan.details</a> &gt; <span class="el_source">ThreatDetailsViewModel.kt</span></div><h1>ThreatDetailsViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.jetpack.scan.details

import androidx.lifecycle.LiveData
import androidx.lifecycle.MediatorLiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import kotlinx.coroutines.launch
import org.wordpress.android.Constants
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.model.scan.threat.ThreatModel
import org.wordpress.android.fluxc.store.ScanStore
import org.wordpress.android.ui.jetpack.common.JetpackListItemState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.ActionButtonState
import org.wordpress.android.ui.jetpack.scan.details.ThreatDetailsNavigationEvents.OpenThreatActionDialog
import org.wordpress.android.ui.jetpack.scan.details.ThreatDetailsNavigationEvents.ShowJetpackSettings
import org.wordpress.android.ui.jetpack.scan.details.ThreatDetailsNavigationEvents.ShowUpdatedFixState
import org.wordpress.android.ui.jetpack.scan.details.ThreatDetailsNavigationEvents.ShowUpdatedScanStateWithMessage
import org.wordpress.android.ui.jetpack.scan.details.ThreatDetailsViewModel.UiState.Content
import org.wordpress.android.ui.jetpack.scan.details.usecases.GetThreatModelUseCase
import org.wordpress.android.ui.jetpack.scan.details.usecases.IgnoreThreatUseCase
import org.wordpress.android.ui.jetpack.scan.details.usecases.IgnoreThreatUseCase.IgnoreThreatState
import org.wordpress.android.ui.jetpack.scan.usecases.FixThreatsUseCase
import org.wordpress.android.ui.jetpack.scan.usecases.FixThreatsUseCase.FixThreatsState
import org.wordpress.android.ui.mysite.SelectedSiteRepository
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.utils.HtmlMessageUtils
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.analytics.ScanTracker
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ResourceProvider
import javax.inject.Inject

<span class="nc" id="L37">class ThreatDetailsViewModel @Inject constructor(</span>
<span class="nc" id="L38">    private val getThreatModelUseCase: GetThreatModelUseCase,</span>
<span class="nc" id="L39">    private val ignoreThreatUseCase: IgnoreThreatUseCase,</span>
<span class="nc" id="L40">    private val fixThreatsUseCase: FixThreatsUseCase,</span>
<span class="nc" id="L41">    private val selectedSiteRepository: SelectedSiteRepository,</span>
<span class="nc" id="L42">    private val scanStore: ScanStore,</span>
<span class="nc" id="L43">    private val builder: ThreatDetailsListItemsBuilder,</span>
<span class="nc" id="L44">    private val htmlMessageUtils: HtmlMessageUtils,</span>
<span class="nc" id="L45">    private val resourceProvider: ResourceProvider,</span>
<span class="nc" id="L46">    private val scanTracker: ScanTracker</span>
<span class="nc" id="L47">) : ViewModel() {</span>
    private lateinit var site: SiteModel
    private lateinit var threatModel: ThreatModel
    private var isStarted = false

<span class="nc" id="L52">    private val _uiState: MutableLiveData&lt;UiState&gt; = MutableLiveData()</span>
<span class="nc" id="L53">    val uiState: LiveData&lt;UiState&gt; = _uiState</span>

<span class="nc" id="L55">    private val _snackbarEvents = MediatorLiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt;()</span>
<span class="nc" id="L56">    val snackbarEvents: LiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt; = _snackbarEvents</span>

<span class="nc" id="L58">    private val _navigationEvents = MediatorLiveData&lt;Event&lt;ThreatDetailsNavigationEvents&gt;&gt;()</span>
<span class="nc" id="L59">    val navigationEvents: LiveData&lt;Event&lt;ThreatDetailsNavigationEvents&gt;&gt; = _navigationEvents</span>

    fun start(threatId: Long) {
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (isStarted) {</span>
<span class="nc" id="L63">            return</span>
        }
<span class="nc" id="L65">        isStarted = true</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        site = requireNotNull(selectedSiteRepository.getSelectedSite())</span>
<span class="nc" id="L67">        getData(threatId)</span>
<span class="nc" id="L68">    }</span>

    private fun getData(threatId: Long) {
<span class="nc" id="L71">        viewModelScope.launch {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            threatModel = requireNotNull(getThreatModelUseCase.get(threatId))</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            val scanStateHasValidCredentials = scanStore.hasValidCredentials(site)</span>
<span class="nc bnc" id="L74" title="All 6 branches missed.">            updateUiState(buildContentUiState(threatModel, site.siteId, scanStateHasValidCredentials))</span>
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">    }</span>

    private fun fixThreat() {
<span class="nc bnc" id="L79" title="All 2 branches missed.">        scanTracker.trackOnFixThreatConfirmed(threatModel.baseThreatModel.signature)</span>
<span class="nc" id="L80">        viewModelScope.launch {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            val threatId = threatModel.baseThreatModel.id</span>
<span class="nc" id="L82">            updateThreatActionButtons(isEnabled = false)</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            when (fixThreatsUseCase.fixThreats(remoteSiteId = site.siteId, fixableThreatIds = listOf(threatId))) {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                is FixThreatsState.Success -&gt; {</span>
<span class="nc" id="L85">                    updateNavigationEvent(ShowUpdatedFixState(threatId))</span>
                }
<span class="nc bnc" id="L87" title="All 2 branches missed.">                is FixThreatsState.Failure.NetworkUnavailable -&gt; {</span>
<span class="nc" id="L88">                    scanTracker.trackOnError(ScanTracker.ErrorAction.FIX, ScanTracker.ErrorCause.OFFLINE)</span>
<span class="nc" id="L89">                    updateThreatActionButtons(isEnabled = true)</span>
<span class="nc" id="L90">                    updateSnackbarMessageEvent(UiStringRes(R.string.error_generic_network))</span>
                }
<span class="nc bnc" id="L92" title="All 2 branches missed.">                is FixThreatsState.Failure.RemoteRequestFailure -&gt; {</span>
<span class="nc" id="L93">                    scanTracker.trackOnError(ScanTracker.ErrorAction.FIX, ScanTracker.ErrorCause.REMOTE)</span>
<span class="nc" id="L94">                    updateThreatActionButtons(isEnabled = true)</span>
<span class="nc" id="L95">                    updateSnackbarMessageEvent(UiStringRes(R.string.threat_fix_error_message))</span>
                }
            }
<span class="nc" id="L98">        }</span>
<span class="nc" id="L99">    }</span>

    private fun ignoreThreat() {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        scanTracker.trackOnIgnoreThreatConfirmed(threatModel.baseThreatModel.signature)</span>
<span class="nc" id="L103">        viewModelScope.launch {</span>
<span class="nc" id="L104">            updateThreatActionButtons(isEnabled = false)</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">            when (ignoreThreatUseCase.ignoreThreat(site.siteId, threatModel.baseThreatModel.id)) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                is IgnoreThreatState.Success -&gt; updateNavigationEvent(</span>
<span class="nc" id="L107">                        ShowUpdatedScanStateWithMessage(R.string.threat_ignore_success_message)</span>
                )

<span class="nc bnc" id="L110" title="All 2 branches missed.">                is IgnoreThreatState.Failure.NetworkUnavailable -&gt; {</span>
<span class="nc" id="L111">                    scanTracker.trackOnError(ScanTracker.ErrorAction.IGNORE, ScanTracker.ErrorCause.OFFLINE)</span>
<span class="nc" id="L112">                    updateThreatActionButtons(isEnabled = true)</span>
<span class="nc" id="L113">                    updateSnackbarMessageEvent(UiStringRes(R.string.error_generic_network))</span>
                }
<span class="nc bnc" id="L115" title="All 2 branches missed.">                is IgnoreThreatState.Failure.RemoteRequestFailure -&gt; {</span>
<span class="nc" id="L116">                    scanTracker.trackOnError(ScanTracker.ErrorAction.IGNORE, ScanTracker.ErrorCause.REMOTE)</span>
<span class="nc" id="L117">                    updateThreatActionButtons(isEnabled = true)</span>
<span class="nc" id="L118">                    updateSnackbarMessageEvent(UiStringRes(R.string.threat_ignore_error_message))</span>
                }
            }
<span class="nc" id="L121">        }</span>
<span class="nc" id="L122">    }</span>

    private fun onFixThreatButtonClicked() {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        scanTracker.trackOnFixThreatButtonClicked(threatModel.baseThreatModel.signature)</span>
<span class="nc bnc" id="L126" title="All 4 branches missed.">        val fixable = requireNotNull(threatModel.baseThreatModel.fixable)</span>
<span class="nc" id="L127">        updateNavigationEvent(</span>
<span class="nc" id="L128">                OpenThreatActionDialog(</span>
<span class="nc" id="L129">                        title = UiStringRes(R.string.threat_fix),</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                        message = requireNotNull(builder.buildFixableThreatDescription(fixable).text),</span>
<span class="nc" id="L131">                        okButtonAction = this@ThreatDetailsViewModel::fixThreat</span>
                )
        )
<span class="nc" id="L134">    }</span>

    private fun onIgnoreThreatButtonClicked() {
<span class="nc bnc" id="L137" title="All 2 branches missed.">        scanTracker.trackOnIgnoreThreatButtonClicked(threatModel.baseThreatModel.signature)</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">        val siteName = site.name ?: resourceProvider.getString(R.string.scan_this_site)</span>
<span class="nc" id="L139">        updateNavigationEvent(</span>
<span class="nc" id="L140">                OpenThreatActionDialog(</span>
<span class="nc" id="L141">                        title = UiStringRes(R.string.threat_ignore),</span>
<span class="nc" id="L142">                        message = UiStringText(</span>
<span class="nc" id="L143">                                htmlMessageUtils</span>
<span class="nc" id="L144">                                        .getHtmlMessageFromStringFormatResId(</span>
<span class="nc" id="L145">                                                R.string.threat_ignore_warning,</span>
<span class="nc" id="L146">                                                &quot;&lt;b&gt;$siteName&lt;/b&gt;&quot;</span>
                                        )
                        ),
<span class="nc" id="L149">                        okButtonAction = this@ThreatDetailsViewModel::ignoreThreat</span>
                )
        )
<span class="nc" id="L152">    }</span>

    private fun onGetFreeEstimateButtonClicked() {
<span class="nc" id="L155">        scanTracker.trackOnGetFreeEstimateButtonClicked()</span>
<span class="nc" id="L156">        updateNavigationEvent(ThreatDetailsNavigationEvents.ShowGetFreeEstimate)</span>
<span class="nc" id="L157">    }</span>

    private fun onEnterServerCredsIconClicked() {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        updateNavigationEvent(ShowJetpackSettings(&quot;${Constants.URL_JETPACK_SETTINGS}/${site.siteId}&quot;))</span>
<span class="nc" id="L161">    }</span>

    private fun updateThreatActionButtons(isEnabled: Boolean) {
<span class="nc bnc" id="L164" title="All 4 branches missed.">        (_uiState.value as? Content)?.let { content -&gt;</span>
<span class="nc" id="L165">            val updatesContentItems = content.items.map { contentItem -&gt;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                if (contentItem is ActionButtonState) {</span>
<span class="nc" id="L167">                    contentItem.copy(isEnabled = isEnabled)</span>
                } else {
<span class="nc" id="L169">                    contentItem</span>
                }
            }
<span class="nc" id="L172">            updateUiState(content.copy(items = updatesContentItems))</span>
<span class="nc" id="L173">        }</span>
<span class="nc" id="L174">    }</span>

    private fun updateSnackbarMessageEvent(message: UiString) {
<span class="nc" id="L177">        _snackbarEvents.value = Event(SnackbarMessageHolder((message)))</span>
<span class="nc" id="L178">    }</span>

    private fun updateNavigationEvent(navigationEvent: ThreatDetailsNavigationEvents) {
<span class="nc" id="L181">        _navigationEvents.value = Event(navigationEvent)</span>
<span class="nc" id="L182">    }</span>

    private fun updateUiState(state: UiState) {
<span class="nc" id="L185">        _uiState.value = state</span>
<span class="nc" id="L186">    }</span>

<span class="nc" id="L188">    private fun buildContentUiState(model: ThreatModel, siteId: Long, scanStateHasValidCredentials: Boolean) = Content(</span>
<span class="nc" id="L189">            builder.buildThreatDetailsListItems(</span>
<span class="nc" id="L190">                    model,</span>
<span class="nc" id="L191">                    scanStateHasValidCredentials,</span>
<span class="nc" id="L192">                    siteId,</span>
<span class="nc" id="L193">                    this@ThreatDetailsViewModel::onFixThreatButtonClicked,</span>
<span class="nc" id="L194">                    this@ThreatDetailsViewModel::onGetFreeEstimateButtonClicked,</span>
<span class="nc" id="L195">                    this@ThreatDetailsViewModel::onIgnoreThreatButtonClicked,</span>
<span class="nc" id="L196">                    this@ThreatDetailsViewModel::onEnterServerCredsIconClicked</span>
            )
<span class="nc" id="L198">    )</span>

    sealed class UiState { // TODO: ashiagr add states for loading, error as needed
<span class="nc" id="L201">        data class Content(val items: List&lt;JetpackListItemState&gt;) : UiState()</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>