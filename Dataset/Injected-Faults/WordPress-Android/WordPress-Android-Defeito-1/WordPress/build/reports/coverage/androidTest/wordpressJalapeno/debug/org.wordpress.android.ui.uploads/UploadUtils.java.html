<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.uploads</a> &gt; <span class="el_source">UploadUtils.java</span></div><h1>UploadUtils.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.uploads;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.text.TextUtils;
import android.view.View;
import android.view.View.OnClickListener;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.StringRes;

import com.google.android.material.snackbar.Snackbar;

import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.generated.PostActionBuilder;
import org.wordpress.android.fluxc.model.MediaModel;
import org.wordpress.android.fluxc.model.MediaUploadModel;
import org.wordpress.android.fluxc.model.PostImmutableModel;
import org.wordpress.android.fluxc.model.PostModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.model.post.PostStatus;
import org.wordpress.android.fluxc.persistence.UploadSqlUtils;
import org.wordpress.android.fluxc.store.MediaStore.MediaError;
import org.wordpress.android.fluxc.store.MediaStore.MediaErrorType;
import org.wordpress.android.fluxc.store.PostStore.PostError;
import org.wordpress.android.fluxc.store.UploadStore.UploadError;
import org.wordpress.android.fluxc.utils.MimeTypes;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.posts.EditPostActivity;
import org.wordpress.android.ui.posts.PostUtils;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.uploads.UploadActionUseCase.UploadAction;
import org.wordpress.android.ui.utils.UiString;
import org.wordpress.android.ui.utils.UiString.UiStringRes;
import org.wordpress.android.ui.utils.UiString.UiStringText;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.DateTimeUtils;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.SnackbarItem;
import org.wordpress.android.util.SnackbarItem.Action;
import org.wordpress.android.util.SnackbarItem.Info;
import org.wordpress.android.util.SnackbarSequencer;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.UploadWorkerKt;
import org.wordpress.android.util.WPMediaUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

<span class="nc" id="L57">public class UploadUtils {</span>
    private static final int K_SNACKBAR_WAIT_TIME_MS = 5000;
<span class="nc" id="L59">    private static final MimeTypes MIME_TYPES = new MimeTypes();</span>

    /**
     * Returns a post-type specific error message string.
     */
    static @NonNull
    String getErrorMessage(Context context, boolean isPage, String errorMessage,
                           boolean isMediaError) {
        String baseErrorString;
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (isPage) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (isMediaError) {</span>
<span class="nc" id="L70">                baseErrorString = context.getString(R.string.error_upload_page_media_param);</span>
            } else {
<span class="nc" id="L72">                baseErrorString = context.getString(R.string.error_upload_page_param);</span>
            }
        } else {
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (isMediaError) {</span>
<span class="nc" id="L76">                baseErrorString = context.getString(R.string.error_upload_post_media_param);</span>
            } else {
<span class="nc" id="L78">                baseErrorString = context.getString(R.string.error_upload_post_param);</span>
            }
        }
<span class="nc" id="L81">        return String.format(baseErrorString, errorMessage);</span>
    }

    /**
     * Returns an error message string for a failed post upload.
     */
    public static @NonNull
    UiString getErrorMessageResIdFromPostError(PostStatus postStatus, boolean isPage, PostError error,
                                               boolean eligibleForAutoUpload) {
<span class="nc bnc" id="L90" title="All 4 branches missed.">        switch (error.type) {</span>
            case UNKNOWN_POST:
<span class="nc bnc" id="L92" title="All 2 branches missed.">                return isPage ? new UiStringRes(R.string.error_unknown_page)</span>
<span class="nc" id="L93">                        : new UiStringRes(R.string.error_unknown_post);</span>
            case UNKNOWN_POST_TYPE:
<span class="nc bnc" id="L95" title="All 2 branches missed.">                return isPage ? new UiStringRes(R.string.error_unknown_page_type)</span>
<span class="nc" id="L96">                        : new UiStringRes(R.string.error_unknown_post_type);</span>
            case UNAUTHORIZED:
<span class="nc bnc" id="L98" title="All 2 branches missed.">                return isPage ? new UiStringRes(R.string.error_refresh_unauthorized_pages)</span>
<span class="nc" id="L99">                        : new UiStringRes(R.string.error_refresh_unauthorized_posts);</span>
            case UNSUPPORTED_ACTION:
            case INVALID_RESPONSE:
            case GENERIC_ERROR:
            default:
<span class="nc" id="L104">                AppLog.w(T.MAIN, &quot;Error message: &quot; + error.message + &quot; ,Error Type: &quot; + error.type);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                if (eligibleForAutoUpload) {</span>
<span class="nc bnc" id="L106" title="All 6 branches missed.">                    switch (postStatus) {</span>
                        case PRIVATE:
<span class="nc bnc" id="L108" title="All 2 branches missed.">                            return isPage ? new UiStringRes(R.string.error_page_not_published_retrying_private)</span>
<span class="nc" id="L109">                                    : new UiStringRes(R.string.error_post_not_published_retrying_private);</span>
                        case PUBLISHED:
<span class="nc bnc" id="L111" title="All 2 branches missed.">                            return isPage ? new UiStringRes(R.string.error_page_not_published_retrying)</span>
<span class="nc" id="L112">                                    : new UiStringRes(R.string.error_post_not_published_retrying);</span>
                        case SCHEDULED:
<span class="nc bnc" id="L114" title="All 2 branches missed.">                            return isPage ? new UiStringRes(R.string.error_page_not_scheduled_retrying)</span>
<span class="nc" id="L115">                                    : new UiStringRes(R.string.error_post_not_scheduled_retrying);</span>
                        case PENDING:
<span class="nc bnc" id="L117" title="All 2 branches missed.">                            return isPage ? new UiStringRes(R.string.error_page_not_submitted_retrying)</span>
<span class="nc" id="L118">                                    : new UiStringRes(R.string.error_post_not_submitted_retrying);</span>
                        case UNKNOWN:
                        case DRAFT:
                        case TRASHED:
<span class="nc" id="L122">                            return new UiStringRes(R.string.error_generic_error_retrying);</span>
                    }
                } else {
<span class="nc bnc" id="L125" title="All 6 branches missed.">                    switch (postStatus) {</span>
                        case PRIVATE:
<span class="nc bnc" id="L127" title="All 2 branches missed.">                            return isPage ? new UiStringRes(R.string.error_page_not_published_private)</span>
<span class="nc" id="L128">                                    : new UiStringRes(R.string.error_post_not_published_private);</span>
                        case PUBLISHED:
<span class="nc bnc" id="L130" title="All 2 branches missed.">                            return isPage ? new UiStringRes(R.string.error_page_not_published)</span>
<span class="nc" id="L131">                                    : new UiStringRes(R.string.error_post_not_published);</span>
                        case SCHEDULED:
<span class="nc bnc" id="L133" title="All 2 branches missed.">                            return isPage ? new UiStringRes(R.string.error_page_not_scheduled)</span>
<span class="nc" id="L134">                                    : new UiStringRes(R.string.error_post_not_scheduled);</span>
                        case PENDING:
<span class="nc bnc" id="L136" title="All 2 branches missed.">                            return isPage ? new UiStringRes(R.string.error_page_not_submitted)</span>
<span class="nc" id="L137">                                    : new UiStringRes(R.string.error_post_not_submitted);</span>
                        case UNKNOWN:
                        case DRAFT:
                        case TRASHED:
<span class="nc" id="L141">                            return new UiStringRes(R.string.error_generic_error);</span>
                    }
                }
<span class="nc" id="L144">                return new UiStringRes(R.string.error_generic_error);</span>
        }
    }

    /**
     * Returns an error message string for a failed media upload.
     */
    public static @NonNull
    String getErrorMessageFromMediaError(Context context, MediaModel media, MediaError error) {
<span class="nc" id="L153">        String errorMessage = WPMediaUtils.getErrorMessage(context, media, error);</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (errorMessage == null) {</span>
            // In case of a generic or uncaught error, return the message from the API response or the error type
<span class="nc" id="L157">            String msg = error.getApiUserMessageIfAvailable();</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            errorMessage = TextUtils.isEmpty(msg) ? error.type.toString() : msg;</span>
        }

        // Capitalize message first letter; this is done since some messages
        // (like a few got from FluxC) are not capitalized.
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (errorMessage.length() &gt; 0) {</span>
<span class="nc" id="L164">            String firstLetter = errorMessage.substring(0, 1);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            String restOfMessage = errorMessage.length() &gt; 1 ? errorMessage.substring(1) : &quot;&quot;;</span>
<span class="nc" id="L166">            errorMessage = firstLetter.toUpperCase(Locale.getDefault()) + restOfMessage;</span>
        }

<span class="nc" id="L169">        return errorMessage;</span>
    }

    public static @NonNull
    String getErrorMessageFromMedia(Context context, @NonNull MediaModel media) {
<span class="nc" id="L174">        MediaUploadModel uploadModel = UploadSqlUtils.getMediaUploadModelForLocalId(media.getId());</span>

<span class="nc" id="L176">        MediaError error = new MediaError(MediaErrorType.GENERIC_ERROR, null, null);</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (uploadModel != null) {</span>
<span class="nc" id="L179">            MediaError errorFromUploadModel = uploadModel.getMediaError();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (errorFromUploadModel != null) {</span>
<span class="nc" id="L181">                error = errorFromUploadModel;</span>
            }
        }

<span class="nc" id="L185">        return getErrorMessageFromMediaError(context, media, error);</span>
    }

    public static boolean isMediaError(UploadError uploadError) {
<span class="nc bnc" id="L189" title="All 4 branches missed.">        return uploadError != null &amp;&amp; uploadError.mediaError != null;</span>
    }

    public static void handleEditPostModelResultSnackbars(@NonNull final Activity activity,
                                                          @NonNull final Dispatcher dispatcher,
                                                          @NonNull View snackbarAttachView,
                                                          @NonNull Intent data,
                                                          @NonNull final PostModel post,
                                                          @NonNull final SiteModel site,
                                                          @NonNull final UploadAction uploadAction,
                                                          SnackbarSequencer sequencer,
                                                          View.OnClickListener publishPostListener,
                                                          @Nullable OnPublishingCallback onPublishingCallback) {
<span class="nc" id="L202">        boolean hasChanges = data.getBooleanExtra(EditPostActivity.EXTRA_HAS_CHANGES, false);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (!hasChanges) {</span>
            // if there are no changes, we don't need to do anything
<span class="nc" id="L205">            return;</span>
        }

<span class="nc" id="L208">        boolean uploadNotStarted = data.getBooleanExtra(EditPostActivity.EXTRA_UPLOAD_NOT_STARTED, false);</span>
<span class="nc bnc" id="L209" title="All 4 branches missed.">        if (uploadNotStarted &amp;&amp; !NetworkUtils.isNetworkAvailable(activity)) {</span>
            // The network is not available, we can enqueue a request to upload local changes later
<span class="nc" id="L211">            UploadWorkerKt.enqueueUploadWorkRequestForSite(site);</span>
            // And tell the user about it
<span class="nc" id="L213">            showSnackbar(snackbarAttachView, getDeviceOfflinePostModelNotUploadedMessage(post, uploadAction),</span>
                    R.string.cancel,
                    v -&gt; {
<span class="nc" id="L216">                        int msgRes = cancelPendingAutoUpload(post, dispatcher);</span>
<span class="nc" id="L217">                        showSnackbar(snackbarAttachView, msgRes, sequencer);</span>
<span class="nc" id="L218">                    }, sequencer);</span>
<span class="nc" id="L219">            return;</span>
        }

<span class="nc" id="L222">        boolean hasFailedMedia = data.getBooleanExtra(EditPostActivity.EXTRA_HAS_FAILED_MEDIA, false);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (hasFailedMedia) {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            showSnackbar(snackbarAttachView, post.isPage() ? R.string.editor_page_saved_locally_failed_media</span>
<span class="nc" id="L225">                            : R.string.editor_post_saved_locally_failed_media, R.string.button_edit,</span>
<span class="nc" id="L226">                         new View.OnClickListener() {</span>
                             @Override
                             public void onClick(View v) {
<span class="nc" id="L229">                                 ActivityLauncher.editPostOrPageForResult(activity, site, post);</span>
<span class="nc" id="L230">                             }</span>
                         }, sequencer);
<span class="nc" id="L232">            return;</span>
        }

<span class="nc" id="L235">        PostStatus postStatus = PostStatus.fromPost(post);</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">        boolean isScheduledPost = postStatus == PostStatus.SCHEDULED;</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (isScheduledPost) {</span>
            // if it's a scheduled post, we only want to show a &quot;Sync&quot; button if it's locally saved
<span class="nc bnc" id="L240" title="All 2 branches missed.">            if (uploadNotStarted) {</span>
<span class="nc" id="L241">                showSnackbar(snackbarAttachView,</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                        post.isPage() ? R.string.editor_page_saved_locally : R.string.editor_post_saved_locally,</span>
                        R.string.button_sync,
                        publishPostListener, sequencer);
            }
<span class="nc" id="L246">            return;</span>
        }

<span class="nc bnc" id="L249" title="All 2 branches missed.">        boolean isPublished = postStatus == PostStatus.PUBLISHED;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (isPublished) {</span>
            // if it's a published post, we only want to show a &quot;Sync&quot; button if it's locally saved
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (uploadNotStarted) {</span>
<span class="nc" id="L253">                showSnackbar(snackbarAttachView,</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                        post.isPage() ? R.string.editor_page_saved_locally : R.string.editor_post_saved_locally,</span>
                        R.string.button_sync,
                        publishPostListener, sequencer);
            } else {
<span class="nc" id="L258">                showSnackbar(snackbarAttachView,</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                        post.isPage() ? R.string.editor_uploading_page : R.string.editor_uploading_post, sequencer);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                if (onPublishingCallback != null) {</span>
<span class="nc" id="L261">                    onPublishingCallback.onPublishing(PostUtils.isFirstTimePublish(post));</span>
                }
            }
<span class="nc" id="L264">            return;</span>
        }

<span class="nc bnc" id="L267" title="All 2 branches missed.">        boolean isDraft = postStatus == PostStatus.DRAFT;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (isDraft) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (PostUtils.isPublishable(post)) {</span>
                // if the post is publishable, we offer the PUBLISH button
<span class="nc bnc" id="L271" title="All 2 branches missed.">                if (uploadNotStarted) {</span>
<span class="nc" id="L272">                    showSnackbarSuccessAction(snackbarAttachView, R.string.editor_draft_saved_locally,</span>
                                              R.string.button_publish,
                                              publishPostListener, sequencer);
                } else {
<span class="nc bnc" id="L276" title="All 2 branches missed.">                    if (UploadService.hasPendingOrInProgressMediaUploadsForPost(post)</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                        || UploadService.isPostUploadingOrQueued(post)) {</span>
<span class="nc" id="L278">                        showSnackbar(snackbarAttachView, R.string.editor_uploading_draft, sequencer);</span>
                    } else {
<span class="nc" id="L280">                        showSnackbarSuccessAction(snackbarAttachView, R.string.editor_draft_saved_online,</span>
                                                  R.string.button_publish,
                                                  publishPostListener, sequencer);
                    }
                }
            } else {
<span class="nc" id="L286">                showSnackbar(snackbarAttachView, R.string.editor_draft_saved_locally, sequencer);</span>
            }
        } else {
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (uploadNotStarted) {</span>
<span class="nc" id="L290">                showSnackbar(snackbarAttachView,</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">                        post.isPage() ? R.string.editor_page_saved_locally : R.string.editor_post_saved_locally,</span>
                        R.string.button_publish,
                             publishPostListener, sequencer);
            } else {
<span class="nc bnc" id="L295" title="All 2 branches missed.">                if (UploadService.hasPendingOrInProgressMediaUploadsForPost(post)</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                    || UploadService.isPostUploadingOrQueued(post)) {</span>
<span class="nc" id="L297">                    showSnackbar(snackbarAttachView,</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                            post.isPage() ? R.string.editor_uploading_page : R.string.editor_uploading_post, sequencer);</span>
                } else {
<span class="nc" id="L300">                    showSnackbarSuccessAction(snackbarAttachView,</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                            post.isPage() ? R.string.editor_page_saved_online : R.string.editor_post_saved_online,</span>
                                              R.string.button_publish,
                                              publishPostListener, sequencer);
                }
            }
        }
<span class="nc" id="L307">    }</span>

    public static void showSnackbarError(View view, String message, int buttonTitleRes,
                                          OnClickListener onClickListener, SnackbarSequencer sequencer) {
<span class="nc" id="L311">        sequencer.enqueue(</span>
                new SnackbarItem(
                        new Info(
                             view,
                             new UiStringText(message),
                             K_SNACKBAR_WAIT_TIME_MS,
                             true
                        ),
                        new Action(
                             new UiStringRes(buttonTitleRes),
                             onClickListener
                        ),
                        null,
                        null
                )
        );
<span class="nc" id="L327">    }</span>

    public static void showSnackbarError(View view, String message, SnackbarSequencer sequencer) {
<span class="nc" id="L330">        sequencer.enqueue(</span>
                new SnackbarItem(
                        new Info(
                                view,
                                new UiStringText(message),
                                K_SNACKBAR_WAIT_TIME_MS,
                                true
                        ),
                        null,
                        null,
                        null
                )
        );
<span class="nc" id="L343">    }</span>

    private static void showSnackbar(View view, int messageRes, int buttonTitleRes,
                                     OnClickListener onClickListener, SnackbarSequencer sequencer) {
<span class="nc" id="L347">        sequencer.enqueue(</span>
                new SnackbarItem(
                        new Info(
                                view,
                                new UiStringRes(messageRes),
                                K_SNACKBAR_WAIT_TIME_MS,
                                true
                        ),
                        new Action(
                                new UiStringRes(buttonTitleRes),
                                onClickListener
                        ),
                        null,
                        null
                )
        );
<span class="nc" id="L363">    }</span>

    public static void showSnackbarSuccessAction(View view, int messageRes, int buttonTitleRes,
                                                 OnClickListener onClickListener, SnackbarSequencer sequencer) {
<span class="nc" id="L367">        sequencer.enqueue(</span>
                new SnackbarItem(
                        new Info(
                                view,
                                new UiStringRes(messageRes),
                                K_SNACKBAR_WAIT_TIME_MS,
                                true
                        ),
                        new Action(
                                new UiStringRes(buttonTitleRes),
                                onClickListener
                        ),
                        null,
                        null
                )
        );
<span class="nc" id="L383">    }</span>

    private static void showSnackbarSuccessAction(View view, String message, int buttonTitleRes,
                                                  OnClickListener onClickListener, SnackbarSequencer sequencer) {
<span class="nc" id="L387">        sequencer.enqueue(</span>
                new SnackbarItem(
                        new Info(
                                view,
                                new UiStringText(message),
                                K_SNACKBAR_WAIT_TIME_MS,
                                true
                        ),
                        new Action(
                                new UiStringRes(buttonTitleRes),
                                onClickListener
                        ),
                        null,
                        null
                )
        );
<span class="nc" id="L403">    }</span>

    public static void showSnackbar(View view, int messageRes, SnackbarSequencer sequencer) {
<span class="nc" id="L406">        sequencer.enqueue(</span>
                new SnackbarItem(
                        new Info(
                                view,
                                new UiStringRes(messageRes),
                                Snackbar.LENGTH_LONG,
                                true
                        ),
                        null,
                        null,
                        null
                )
        );
<span class="nc" id="L419">    }</span>

    public static void showSnackbar(View view, String messageText, SnackbarSequencer sequencer) {
<span class="nc" id="L422">        sequencer.enqueue(</span>
                new SnackbarItem(
                        new Info(
                                view,
                                new UiStringText(messageText),
                                Snackbar.LENGTH_LONG,
                                true
                        ),
                        null,
                        null,
                        null
                )
        );
<span class="nc" id="L435">    }</span>

    public static void publishPost(Activity activity, final PostModel post, SiteModel site, Dispatcher dispatcher) {
<span class="nc" id="L438">        publishPost(activity, post, site, dispatcher, null);</span>
<span class="nc" id="L439">    }</span>

    public static void publishPost(Activity activity, final PostModel post, SiteModel site, Dispatcher dispatcher,
                                   @Nullable OnPublishingCallback onPublishingCallback) {
        // If the post is empty, don't publish
<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (!PostUtils.isPublishable(post)) {</span>
<span class="nc" id="L445">            String message = activity.getString(</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                    post.isPage() ? R.string.error_publish_empty_page : R.string.error_publish_empty_post);</span>
<span class="nc" id="L447">            ToastUtils.showToast(activity, message, ToastUtils.Duration.SHORT);</span>
<span class="nc" id="L448">            return;</span>
        }

<span class="nc" id="L451">        boolean isFirstTimePublish = PostUtils.isFirstTimePublish(post);</span>

<span class="nc" id="L453">        PostUtils.preparePostForPublish(post, site);</span>

        // save the post in the DB so the UploadService will get the latest change
<span class="nc" id="L456">        dispatcher.dispatch(PostActionBuilder.newUpdatePostAction(post));</span>

<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (NetworkUtils.isNetworkAvailable(activity)) {</span>
<span class="nc" id="L459">            UploadService.uploadPost(activity, post.getId(), isFirstTimePublish);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            if (onPublishingCallback != null) {</span>
<span class="nc" id="L461">                onPublishingCallback.onPublishing(isFirstTimePublish);</span>
            }
        }
<span class="nc" id="L464">        PostUtils.trackSavePostAnalytics(post, site);</span>
<span class="nc" id="L465">    }</span>

    /*
     * returns true if the user has permission to publish the post - assumed to be true for
     * dot.org sites because we can't retrieve their capabilities
     */
    public static boolean userCanPublish(SiteModel site) {
<span class="nc bnc" id="L472" title="All 4 branches missed.">        return !SiteUtils.isAccessedViaWPComRest(site) || site.getHasCapabilityPublishPosts();</span>
    }

    public static void onPostUploadedSnackbarHandler(final Activity activity, View snackbarAttachView,
                                                     boolean isError,
                                                     boolean isFirstTimePublish,
                                                     final PostModel post,
                                                     final String errorMessage,
                                                     final SiteModel site, final Dispatcher dispatcher,
                                                     SnackbarSequencer sequencer,
                                                     @Nullable OnPublishingCallback onPublishingCallback) {
<span class="nc" id="L483">        boolean userCanPublish = userCanPublish(site);</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (isError) {</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">            if (errorMessage != null) {</span>
                // RETRY only available for Aztec
<span class="nc bnc" id="L487" title="All 2 branches missed.">                if (AppPrefs.isAztecEditorEnabled()) {</span>
<span class="nc" id="L488">                    UploadUtils.showSnackbarError(snackbarAttachView, errorMessage, R.string.retry,</span>
<span class="nc" id="L489">                                                  new View.OnClickListener() {</span>
                                                      @Override
                                                      public void onClick(View view) {
<span class="nc" id="L492">                                                          Intent intent = UploadService.getRetryUploadServiceIntent(</span>
                                                                  activity, post, false);
<span class="nc" id="L494">                                                          activity.startService(intent);</span>
<span class="nc" id="L495">                                                      }</span>
                                                  }, sequencer);
                } else {
<span class="nc" id="L498">                    UploadUtils.showSnackbarError(snackbarAttachView, errorMessage, sequencer);</span>
                }
            } else {
<span class="nc" id="L501">                UploadUtils.showSnackbar(snackbarAttachView, R.string.editor_draft_saved_locally, sequencer);</span>
            }
        } else {
<span class="nc bnc" id="L504" title="All 2 branches missed.">            if (post != null) {</span>
<span class="nc" id="L505">                PostStatus status = PostStatus.fromPost(post);</span>
                int snackbarMessageRes;
<span class="nc" id="L507">                int snackbarButtonRes = 0;</span>
<span class="nc" id="L508">                View.OnClickListener publishPostListener = new View.OnClickListener() {</span>
                    @Override
                    public void onClick(View view) {
                        // jump to Editor Preview mode to show this Post
<span class="nc" id="L512">                        ActivityLauncher.browsePostOrPage(activity, site, post);</span>
<span class="nc" id="L513">                    }</span>
                };

<span class="nc bnc" id="L516" title="All 4 branches missed.">                switch (status) {</span>
                    case DRAFT:
<span class="nc" id="L518">                        snackbarMessageRes = R.string.editor_draft_saved_online;</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">                        if (userCanPublish) {</span>
<span class="nc" id="L520">                            publishPostListener = new View.OnClickListener() {</span>
                                @Override
                                public void onClick(View v) {
<span class="nc" id="L523">                                    UploadUtils.publishPost(activity, post, site, dispatcher, onPublishingCallback);</span>
<span class="nc" id="L524">                                }</span>
                            };
<span class="nc" id="L526">                            snackbarButtonRes = R.string.button_publish;</span>
                        }
                        break;
                    case PUBLISHED:
<span class="nc" id="L530">                        snackbarButtonRes = R.string.button_view;</span>

<span class="nc bnc" id="L532" title="All 2 branches missed.">                        if (post.isPage()) {</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                            snackbarMessageRes = isFirstTimePublish ? R.string.page_published : R.string.page_updated;</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                        } else if (userCanPublish) {</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                            snackbarMessageRes = isFirstTimePublish ? R.string.post_published : R.string.post_updated;</span>
                        } else {
<span class="nc" id="L537">                            snackbarMessageRes = R.string.post_submitted;</span>
                        }
<span class="nc" id="L539">                        break;</span>
                    case SCHEDULED:
<span class="nc" id="L541">                        snackbarButtonRes = R.string.button_view;</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                        snackbarMessageRes = post.isPage() ? R.string.page_scheduled : R.string.post_scheduled;</span>
<span class="nc" id="L543">                        break;</span>
                    default:
<span class="nc" id="L545">                        snackbarButtonRes = R.string.button_view;</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                        snackbarMessageRes = post.isPage() ? R.string.page_updated : R.string.post_updated;</span>
                        break;
                }

<span class="nc bnc" id="L550" title="All 2 branches missed.">                if (snackbarButtonRes &gt; 0) {</span>
<span class="nc" id="L551">                    UploadUtils.showSnackbarSuccessAction(snackbarAttachView, snackbarMessageRes, snackbarButtonRes,</span>
                            publishPostListener, sequencer);
                } else {
<span class="nc" id="L554">                    UploadUtils.showSnackbar(snackbarAttachView, snackbarMessageRes, sequencer);</span>
                }
            }
        }
<span class="nc" id="L558">    }</span>

    public static void onMediaUploadedSnackbarHandler(final Activity activity, View snackbarAttachView,
                                                      boolean isError,
                                                      final List&lt;MediaModel&gt; mediaList, final SiteModel site,
                                                      final String messageForUser,
                                                      SnackbarSequencer sequencer) {
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (isError) {</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">            if (messageForUser != null) {</span>
                // RETRY only available for Aztec
<span class="nc bnc" id="L568" title="All 4 branches missed.">                if (mediaList != null &amp;&amp; !mediaList.isEmpty()) {</span>
<span class="nc" id="L569">                    UploadUtils.showSnackbarError(snackbarAttachView, messageForUser, R.string.retry,</span>
<span class="nc" id="L570">                                                  new View.OnClickListener() {</span>
                                                      @Override
                                                      public void onClick(View view) {
<span class="nc" id="L573">                                                          ArrayList&lt;MediaModel&gt; mediaListToRetry = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L574">                                                          mediaListToRetry.addAll(mediaList);</span>
<span class="nc" id="L575">                                                          Intent retryIntent = UploadService</span>
<span class="nc" id="L576">                                                                  .getUploadMediaServiceIntent(activity,</span>
                                                                                               mediaListToRetry, true);
<span class="nc" id="L578">                                                          activity.startService(retryIntent);</span>
<span class="nc" id="L579">                                                      }</span>
                                                  }, sequencer);
                } else {
<span class="nc" id="L582">                    UploadUtils.showSnackbarError(snackbarAttachView, messageForUser, sequencer);</span>
                }
            } else {
<span class="nc" id="L585">                UploadUtils.showSnackbarError(</span>
                        snackbarAttachView,
<span class="nc" id="L587">                        activity.getString(R.string.error_media_upload),</span>
                        sequencer
                );
            }
        } else {
<span class="nc bnc" id="L592" title="All 4 branches missed.">            if (mediaList == null || mediaList.isEmpty()) {</span>
<span class="nc" id="L593">                return;</span>
            }
<span class="nc" id="L595">            boolean showPostAction = false;</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">            for (MediaModel mediaModel : mediaList) {</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                showPostAction |= MIME_TYPES.isImageType(mediaModel.getMimeType()) || MIME_TYPES</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                        .isVideoType(mediaModel.getMimeType());</span>
<span class="nc" id="L599">            }</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">            if (showPostAction) {</span>
                // show success snackbar for media only items and offer the WRITE POST functionality)
<span class="nc" id="L602">                UploadUtils.showSnackbarSuccessAction(snackbarAttachView, messageForUser,</span>
<span class="nc" id="L603">                        R.string.media_files_uploaded_write_post, new View.OnClickListener() {</span>
                            @Override
                            public void onClick(View view) {
                                // WRITE POST functionality: show pre-populated Post
<span class="nc" id="L607">                                ArrayList&lt;MediaModel&gt; mediaListToInsertInPost = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L608">                                mediaListToInsertInPost.addAll(mediaList);</span>

<span class="nc" id="L610">                                Intent writePostIntent = new Intent(activity, EditPostActivity.class);</span>
<span class="nc" id="L611">                                writePostIntent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);</span>
<span class="nc" id="L612">                                writePostIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L613">                                writePostIntent.putExtra(WordPress.SITE, site);</span>
<span class="nc" id="L614">                                writePostIntent.putExtra(EditPostActivity.EXTRA_IS_PAGE, false);</span>
<span class="nc" id="L615">                                writePostIntent.putExtra(EditPostActivity.EXTRA_INSERT_MEDIA, mediaListToInsertInPost);</span>
<span class="nc" id="L616">                                activity.startActivity(writePostIntent);</span>
<span class="nc" id="L617">                            }</span>
                        }, sequencer);
            } else {
                // Do not show action for audio/document files until there is a block handling them in GB
<span class="nc" id="L621">                UploadUtils.showSnackbar(snackbarAttachView, messageForUser, sequencer);</span>
            }
        }
<span class="nc" id="L624">    }</span>

    @StringRes
    private static int getDeviceOfflinePostModelNotUploadedMessage(@NonNull final PostModel post,
                                                                   @NonNull final UploadAction uploadAction) {
<span class="nc bnc" id="L629" title="All 2 branches missed.">        if (uploadAction != UploadAction.UPLOAD) {</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">            return post.isPage() ? R.string.error_publish_page_no_network : R.string.error_publish_no_network;</span>
        } else {
<span class="nc bnc" id="L632" title="All 7 branches missed.">            switch (PostStatus.fromPost(post)) {</span>
                case PUBLISHED:
                case UNKNOWN:
<span class="nc bnc" id="L635" title="All 2 branches missed.">                    return post.isPage() ? R.string.page_waiting_for_connection_publish</span>
<span class="nc" id="L636">                            : R.string.post_waiting_for_connection_publish;</span>
                case DRAFT:
<span class="nc bnc" id="L638" title="All 2 branches missed.">                    return post.isPage() ? R.string.page_waiting_for_connection_draft</span>
<span class="nc" id="L639">                            : R.string.post_waiting_for_connection_draft;</span>
                case PRIVATE:
<span class="nc bnc" id="L641" title="All 2 branches missed.">                    return post.isPage() ? R.string.page_waiting_for_connection_private</span>
<span class="nc" id="L642">                            : R.string.post_waiting_for_connection_private;</span>
                case PENDING:
<span class="nc bnc" id="L644" title="All 2 branches missed.">                    return post.isPage() ? R.string.page_waiting_for_connection_pending</span>
<span class="nc" id="L645">                            : R.string.post_waiting_for_connection_pending;</span>
                case SCHEDULED:
<span class="nc bnc" id="L647" title="All 2 branches missed.">                    return post.isPage() ? R.string.page_waiting_for_connection_scheduled</span>
<span class="nc" id="L648">                            : R.string.post_waiting_for_connection_scheduled;</span>
                case TRASHED:
<span class="nc" id="L650">                    throw new IllegalArgumentException(&quot;Trashing posts should be handled in a different code path.&quot;);</span>
            }
        }
<span class="nc" id="L653">        throw new RuntimeException(&quot;This code should be unreachable. Missing case in switch statement.&quot;);</span>
    }

    public static boolean postLocalChangesAlreadyRemoteAutoSaved(PostImmutableModel post) {
<span class="nc bnc" id="L657" title="All 2 branches missed.">        return !TextUtils.isEmpty(post.getAutoSaveModified())</span>
<span class="nc" id="L658">               &amp;&amp; DateTimeUtils.dateFromIso8601(post.getDateLocallyChanged())</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">                               .before(DateTimeUtils.dateFromIso8601(post.getAutoSaveModified()));</span>
    }

    public static int cancelPendingAutoUpload(PostModel post, Dispatcher dispatcher) {
        /*
         * `changesConfirmedContentHashcode` field holds a hashcode of the post content at the time when user pressed
         * updated/publish/sync/submit/.. buttons. Clearing the hashcode will prevent the PostUploadHandler to
         * auto-upload the changes - it'll only remote-auto-save them -&gt; which is exactly what the cancel action is
         * supposed to do.
         */
<span class="nc" id="L669">        post.setChangesConfirmedContentHashcode(0);</span>
<span class="nc" id="L670">        dispatcher.dispatch(PostActionBuilder.newUpdatePostAction(post));</span>

<span class="nc" id="L672">        int messageRes = 0;</span>
<span class="nc bnc" id="L673" title="All 6 branches missed.">        switch (PostStatus.fromPost(post)) {</span>
            case UNKNOWN:
            case PUBLISHED:
            case PRIVATE:
<span class="nc" id="L677">                messageRes = R.string.post_waiting_for_connection_publish_cancel;</span>
<span class="nc" id="L678">                break;</span>
            case PENDING:
<span class="nc" id="L680">                messageRes = R.string.post_waiting_for_connection_pending_cancel;</span>
<span class="nc" id="L681">                break;</span>
            case SCHEDULED:
<span class="nc" id="L683">                messageRes = R.string.post_waiting_for_connection_scheduled_cancel;</span>
<span class="nc" id="L684">                break;</span>
            case DRAFT:
<span class="nc" id="L686">                messageRes = R.string.post_waiting_for_connection_draft_cancel;</span>
<span class="nc" id="L687">                break;</span>
            case TRASHED:
<span class="nc" id="L689">                AppLog.e(T.POSTS,</span>
                        &quot;This code should be unreachable. Canceling pending auto-upload on Trashed and Draft posts &quot;
                        + &quot;isn't supported.&quot;);
                break;
        }
<span class="nc" id="L694">        return messageRes;</span>
    }

    public interface OnPublishingCallback {
        void onPublishing(boolean isFirstTimePublish);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>