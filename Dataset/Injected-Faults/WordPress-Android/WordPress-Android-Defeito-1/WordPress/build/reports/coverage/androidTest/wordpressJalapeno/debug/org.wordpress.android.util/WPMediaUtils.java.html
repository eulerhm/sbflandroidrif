<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WPMediaUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">WPMediaUtils.java</span></div><h1>WPMediaUtils.java</h1><pre class="source lang-java linenums">package org.wordpress.android.util;

import android.app.Activity;
import android.content.ClipData;
import android.content.ContentResolver;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.media.MediaScannerConnection;
import android.net.Uri;
import android.os.Environment;
import android.provider.MediaStore;
import android.view.ViewConfiguration;
import android.webkit.MimeTypeMap;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.StringRes;
import androidx.appcompat.app.AlertDialog;
import androidx.core.content.ContextCompat;
import androidx.core.content.FileProvider;

import com.google.android.material.dialog.MaterialAlertDialogBuilder;

import org.wordpress.android.R;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.fluxc.model.MediaModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.MediaStore.MediaError;
import org.wordpress.android.fluxc.store.media.MediaErrorSubType;
import org.wordpress.android.fluxc.store.media.MediaErrorSubType.MalformedMediaArgSubType;
import org.wordpress.android.fluxc.utils.MimeTypes;
import org.wordpress.android.fluxc.utils.MimeTypes.Plan;
import org.wordpress.android.imageeditor.preview.PreviewImageFragment;
import org.wordpress.android.imageeditor.preview.PreviewImageFragment.Companion.EditImageData;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.ChooserContext;
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerAction.OpenSystemPicker;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.utils.UiHelpers;
import org.wordpress.android.util.AppLog.T;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

<span class="nc" id="L50">public class WPMediaUtils {</span>
    public interface LaunchCameraCallback {
        void onMediaCapturePathReady(String mediaCapturePath);
    }

    // Max picture size will be 3000px wide. That's the maximum resolution you can set in the current picker.
    public static final int OPTIMIZE_IMAGE_MAX_SIZE = 3000;
    public static final int OPTIMIZE_IMAGE_ENCODER_QUALITY = 85;
    public static final int OPTIMIZE_VIDEO_MAX_WIDTH = 1280;
    public static final int OPTIMIZE_VIDEO_ENCODER_BITRATE_KB = 3000;

    public static Uri getOptimizedMedia(Context context, String path, boolean isVideo) {
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (isVideo) {</span>
<span class="nc" id="L63">            return null;</span>
        }
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!AppPrefs.isImageOptimize()) {</span>
<span class="nc" id="L66">            return null;</span>
        }

        int resizeDimension =
<span class="nc bnc" id="L70" title="All 2 branches missed.">                AppPrefs.getImageOptimizeMaxSize() &gt; 1 ? AppPrefs.getImageOptimizeMaxSize() : Integer.MAX_VALUE;</span>
<span class="nc" id="L71">        int quality = AppPrefs.getImageOptimizeQuality();</span>
        // do not optimize if original-size and 100% quality are set.
<span class="nc bnc" id="L73" title="All 4 branches missed.">        if (resizeDimension == Integer.MAX_VALUE &amp;&amp; quality == 100) {</span>
<span class="nc" id="L74">            return null;</span>
        }

<span class="nc" id="L77">        String optimizedPath = ImageUtils.optimizeImage(context, path, resizeDimension, quality);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (optimizedPath == null) {</span>
<span class="nc" id="L79">            AppLog.e(AppLog.T.EDITOR, &quot;Optimized picture was null!&quot;);</span>
<span class="nc" id="L80">            AnalyticsTracker.track(AnalyticsTracker.Stat.MEDIA_PHOTO_OPTIMIZE_ERROR);</span>
        } else {
<span class="nc" id="L82">            AnalyticsTracker.track(AnalyticsTracker.Stat.MEDIA_PHOTO_OPTIMIZED);</span>
<span class="nc" id="L83">            return Uri.parse(optimizedPath);</span>
        }
<span class="nc" id="L85">        return null;</span>
    }

    public static Uri fixOrientationIssue(Context context, String path, boolean isVideo) {
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (isVideo) {</span>
<span class="nc" id="L90">            return null;</span>
        }

<span class="nc" id="L93">        String rotatedPath = ImageUtils.rotateImageIfNecessary(context, path);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (rotatedPath != null) {</span>
<span class="nc" id="L95">            return Uri.parse(rotatedPath);</span>
        }

<span class="nc" id="L98">        return null;</span>
    }

    public static boolean isVideoOptimizationEnabled() {
<span class="nc" id="L102">        return AppPrefs.isVideoOptimize();</span>
    }

    /**
     * Check if we should advertise image optimization feature for the current site.
     * &lt;p&gt;
     * The following condition need to be all true:
     * 1) Image optimization is OFF on the site.
     * 2) Didn't already ask to enable the feature.
     * 3) The user has granted storage access to the app.
     * This is because we don't want to ask so much things to users the first time they try to add a picture to the app.
     *
     * @param context The context
     * @return true if we should advertise the feature, false otherwise.
     */
    public static boolean shouldAdvertiseImageOptimization(final Context context) {
<span class="nc" id="L118">        boolean isPromoRequired = AppPrefs.isImageOptimizePromoRequired();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!isPromoRequired) {</span>
<span class="nc" id="L120">            return false;</span>
        }

        // Check we can access storage before asking for optimizing image
<span class="nc bnc" id="L124" title="All 2 branches missed.">        boolean hasStoreAccess = ContextCompat.checkSelfPermission(</span>
                context, android.Manifest.permission.WRITE_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED;
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (!hasStoreAccess) {</span>
<span class="nc" id="L127">            return false;</span>
        }

        // Check whether image optimization is already available for the site
<span class="nc bnc" id="L131" title="All 2 branches missed.">        return !AppPrefs.isImageOptimize();</span>
    }

    public interface OnAdvertiseImageOptimizationListener {
        void done();
    }

    public static void advertiseImageOptimization(final Context context,
                                                  final OnAdvertiseImageOptimizationListener listener) {
<span class="nc" id="L140">        DialogInterface.OnClickListener onClickListener = new DialogInterface.OnClickListener() {</span>
            @Override
            public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L143" title="All 2 branches missed.">                if (which == DialogInterface.BUTTON_POSITIVE) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                    if (AppPrefs.isImageOptimize()) {</span>
                        // null or image optimization already ON. We should not be here though.
                    } else {
<span class="nc" id="L147">                        AppPrefs.setImageOptimize(true);</span>
                    }
                }

<span class="nc" id="L151">                listener.done();</span>
<span class="nc" id="L152">            }</span>
        };

<span class="nc" id="L155">        DialogInterface.OnCancelListener onCancelListener = new DialogInterface.OnCancelListener() {</span>
            @Override
            public void onCancel(DialogInterface dialog) {
<span class="nc" id="L158">                listener.done();</span>
<span class="nc" id="L159">            }</span>
        };

<span class="nc" id="L162">        AlertDialog.Builder builder = new MaterialAlertDialogBuilder(context);</span>
<span class="nc" id="L163">        builder.setTitle(org.wordpress.android.R.string.image_optimization_promo_title);</span>
<span class="nc" id="L164">        builder.setMessage(org.wordpress.android.R.string.image_optimization_promo_desc);</span>
<span class="nc" id="L165">        builder.setPositiveButton(R.string.turn_on, onClickListener);</span>
<span class="nc" id="L166">        builder.setNegativeButton(R.string.leave_off, onClickListener);</span>
<span class="nc" id="L167">        builder.setOnCancelListener(onCancelListener);</span>
<span class="nc" id="L168">        builder.show();</span>
        // Do not ask again
<span class="nc" id="L170">        AppPrefs.setImageOptimizePromoRequired(false);</span>
<span class="nc" id="L171">    }</span>

    /**
     * Given a media error returns the error message to display on the UI.
     *
     * @param error The media error occurred
     * @return String The associated error message.
     */
    public static @Nullable
    String getErrorMessage(final Context context, final MediaModel media, final MediaError error) {
<span class="nc bnc" id="L181" title="All 4 branches missed.">        if (context == null || error == null) {</span>
<span class="nc" id="L182">            return null;</span>
        }

<span class="nc bnc" id="L185" title="All 16 branches missed.">        switch (error.type) {</span>
            case FS_READ_PERMISSION_DENIED:
<span class="nc" id="L187">                return context.getString(R.string.error_media_insufficient_fs_permissions);</span>
            case NOT_FOUND:
<span class="nc" id="L189">                return context.getString(R.string.error_media_not_found);</span>
            case AUTHORIZATION_REQUIRED:
<span class="nc" id="L191">                return context.getString(R.string.media_error_no_permission_upload);</span>
            case REQUEST_TOO_LARGE:
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if (media == null) {</span>
<span class="nc" id="L194">                    return null;</span>
                }

<span class="nc bnc" id="L197" title="All 2 branches missed.">                if (media.isVideo()) {</span>
<span class="nc" id="L198">                    return context.getString(R.string.media_error_http_too_large_video_upload);</span>
                } else {
<span class="nc" id="L200">                    return context.getString(R.string.media_error_http_too_large_photo_upload);</span>
                }
            case SERVER_ERROR:
<span class="nc" id="L203">                return context.getString(R.string.media_error_internal_server_error);</span>
            case TIMEOUT:
<span class="nc" id="L205">                return context.getString(R.string.media_error_timeout);</span>
            case CONNECTION_ERROR:
<span class="nc" id="L207">                return context.getString(R.string.connection_to_server_lost);</span>
            case EXCEEDS_FILESIZE_LIMIT:
<span class="nc" id="L209">                return context.getString(R.string.media_error_exceeds_php_filesize);</span>
            case EXCEEDS_MEMORY_LIMIT:
<span class="nc" id="L211">                return context.getString(R.string.media_error_exceeds_memory_limit);</span>
            case PARSE_ERROR:
<span class="nc" id="L213">                return context.getString(R.string.error_media_parse_error);</span>
            case GENERIC_ERROR:
<span class="nc" id="L215">                return context.getString(R.string.error_generic_error);</span>
            case EXCEEDS_SITE_SPACE_QUOTA_LIMIT:
<span class="nc" id="L217">                return context.getString(R.string.error_media_not_enough_storage);</span>
            case XMLRPC_OPERATION_NOT_ALLOWED:
<span class="nc" id="L219">                return context.getString(R.string.error_media_xmlrpc_not_allowed);</span>
            case XMLRPC_UPLOAD_ERROR:
<span class="nc" id="L221">                return context.getString(R.string.error_media_xmlrcp_server_error);</span>
            case MALFORMED_MEDIA_ARG:
<span class="nc" id="L223">                return getMalformedMediaArgErrorMessage(context, error.mErrorSubType);</span>
        }
<span class="nc" id="L225">        return null;</span>
    }

    private static @Nullable String getMalformedMediaArgErrorMessage(
            final Context context,
            @Nullable final MediaErrorSubType errorSubType
    ) {
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (!(errorSubType instanceof MalformedMediaArgSubType)) return null;</span>

<span class="nc" id="L234">        String errorMessage = null;</span>

<span class="nc bnc" id="L236" title="All 7 branches missed.">        switch (((MalformedMediaArgSubType) errorSubType).getType()) {</span>
            case MEDIA_WAS_NULL:
<span class="nc" id="L238">                errorMessage = context.getString(R.string.error_media_unexpected_null_value);</span>
<span class="nc" id="L239">                break;</span>
            case UNSUPPORTED_MIME_TYPE:
<span class="nc" id="L241">                errorMessage = context.getString(R.string.error_media_file_type_not_allowed);</span>
<span class="nc" id="L242">                break;</span>
            case NOT_VALID_LOCAL_FILE_PATH:
<span class="nc" id="L244">                errorMessage = context.getString(R.string.error_media_unexpected_empty_media_file_path);</span>
<span class="nc" id="L245">                break;</span>
            case MEDIA_FILE_NOT_FOUND_LOCALLY:
<span class="nc" id="L247">                errorMessage = context.getString(R.string.error_media_could_not_find_media_in_path);</span>
<span class="nc" id="L248">                break;</span>
            case DIRECTORY_PATH_SUPPLIED_FILE_NEEDED:
<span class="nc" id="L250">                errorMessage = context.getString(R.string.error_media_path_is_directory);</span>
<span class="nc" id="L251">                break;</span>
            case NO_ERROR:
<span class="nc" id="L253">                errorMessage = null;</span>
                break;
        }
<span class="nc" id="L256">        return errorMessage;</span>
    }

    private static void showSDCardRequiredDialog(Context context) {
<span class="nc" id="L260">        AlertDialog.Builder dialogBuilder = new MaterialAlertDialogBuilder(context);</span>
<span class="nc" id="L261">        dialogBuilder.setTitle(context.getResources().getText(R.string.sdcard_title));</span>
<span class="nc" id="L262">        dialogBuilder.setMessage(context.getResources().getText(R.string.sdcard_message));</span>
<span class="nc" id="L263">        dialogBuilder.setPositiveButton(context.getString(android.R.string.ok), new DialogInterface.OnClickListener() {</span>
            public void onClick(DialogInterface dialog, int whichButton) {
<span class="nc" id="L265">                dialog.dismiss();</span>
<span class="nc" id="L266">            }</span>
        });
<span class="nc" id="L268">        dialogBuilder.setCancelable(true);</span>
<span class="nc" id="L269">        dialogBuilder.create().show();</span>
<span class="nc" id="L270">    }</span>

    public static void launchVideoLibrary(Activity activity, boolean multiSelect) {
<span class="nc" id="L273">        activity.startActivityForResult(prepareVideoLibraryIntent(activity, multiSelect),</span>
                                        RequestCodes.VIDEO_LIBRARY);
<span class="nc" id="L275">    }</span>

    public static void launchMediaLibrary(Activity activity, boolean multiSelect) {
<span class="nc" id="L278">        activity.startActivityForResult(prepareMediaLibraryIntent(activity, multiSelect),</span>
                RequestCodes.MEDIA_LIBRARY);
<span class="nc" id="L280">    }</span>

    public static Plan getSitePlanForMimeTypes(SiteModel site) {
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (site.isWPCom()) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (SiteUtils.onFreePlan(site)) {</span>
<span class="nc" id="L285">                return Plan.WP_COM_FREE;</span>
            } else {
<span class="nc" id="L287">                return Plan.WP_COM_PAID;</span>
            }
        } else {
<span class="nc" id="L290">            return Plan.SELF_HOSTED;</span>
        }
    }

    public static boolean isMimeTypeSupportedBySitePlan(SiteModel site, String mimeType) {
<span class="nc" id="L295">        return Arrays.asList(new MimeTypes().getAllTypes(getSitePlanForMimeTypes(site))).contains(mimeType);</span>
    }

    public static void launchChooserWithContext(
            Activity activity,
            OpenSystemPicker openSystemPicker,
            UiHelpers uiHelpers,
            int requestCode
    ) {
<span class="nc" id="L304">        activity.startActivityForResult(prepareChooserIntent(activity, openSystemPicker, uiHelpers),</span>
                requestCode);
<span class="nc" id="L306">    }</span>

    private static Intent preparePictureLibraryIntent(Context context, boolean multiSelect) {
<span class="nc" id="L309">        return prepareIntent(context, multiSelect, Intent.ACTION_GET_CONTENT, &quot;image/*&quot;,</span>
<span class="nc" id="L310">                new MimeTypes().getImageTypesOnly(), R.string.pick_photo);</span>
    }

    private static Intent prepareVideoLibraryIntent(Context context, boolean multiSelect) {
<span class="nc" id="L314">        return prepareIntent(context, multiSelect, Intent.ACTION_GET_CONTENT, &quot;video/*&quot;,</span>
<span class="nc" id="L315">                new MimeTypes().getVideoTypesOnly(), R.string.pick_video);</span>
    }

    private static Intent prepareMediaLibraryIntent(Context context, boolean multiSelect) {
<span class="nc" id="L319">        return prepareIntent(context, multiSelect, Intent.ACTION_GET_CONTENT, &quot;*/*&quot;,</span>
<span class="nc" id="L320">                new MimeTypes().getVideoAndImageTypesOnly(), R.string.pick_media);</span>
    }

    private static Intent prepareIntent(Context context, boolean multiSelect, String action, String intentType,
                                        String[] mimeTypes, @StringRes int title) {
<span class="nc" id="L325">        Intent intent = new Intent(action);</span>
<span class="nc" id="L326">        intent.setType(intentType);</span>
<span class="nc" id="L327">        intent.putExtra(Intent.EXTRA_MIME_TYPES, mimeTypes);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (multiSelect) {</span>
<span class="nc" id="L329">            intent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true);</span>
        }
<span class="nc" id="L331">        return Intent.createChooser(intent, context.getString(title));</span>
    }

    private static Intent prepareChooserIntent(
            Context context,
            OpenSystemPicker openSystemPicker,
            UiHelpers uiHelpers
    ) {
<span class="nc" id="L339">        ChooserContext chooserContext = openSystemPicker.getChooserContext();</span>
<span class="nc" id="L340">        Intent intent = new Intent(chooserContext.getIntentAction());</span>
<span class="nc" id="L341">        intent.setType(chooserContext.getMediaTypeFilter());</span>
<span class="nc" id="L342">        intent.putExtra(Intent.EXTRA_MIME_TYPES, openSystemPicker.getMimeTypes().toArray(new String[0]));</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (openSystemPicker.getAllowMultipleSelection()) {</span>
<span class="nc" id="L344">            intent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true);</span>
        }
<span class="nc" id="L346">        return Intent.createChooser(intent, uiHelpers.getTextOfUiString(context, chooserContext.getTitle()));</span>
    }

    public static void launchVideoCamera(Activity activity) {
<span class="nc" id="L350">        activity.startActivityForResult(prepareVideoCameraIntent(), RequestCodes.TAKE_VIDEO);</span>
<span class="nc" id="L351">    }</span>

    private static Intent prepareVideoCameraIntent() {
<span class="nc" id="L354">        return new Intent(MediaStore.ACTION_VIDEO_CAPTURE);</span>
    }

    public static void launchPictureLibrary(Activity activity, boolean multiSelect) {
<span class="nc" id="L358">        activity.startActivityForResult(</span>
<span class="nc" id="L359">                preparePictureLibraryIntent(activity, multiSelect),</span>
                RequestCodes.PICTURE_LIBRARY);
<span class="nc" id="L361">    }</span>

    private static Intent prepareGalleryIntent(String title) {
<span class="nc" id="L364">        Intent intent = new Intent(Intent.ACTION_PICK);</span>
<span class="nc" id="L365">        intent.setType(&quot;image/*&quot;);</span>
<span class="nc" id="L366">        intent.putExtra(Intent.EXTRA_MIME_TYPES, new MimeTypes().getImageTypesOnly());</span>
<span class="nc" id="L367">        return Intent.createChooser(intent, title);</span>
    }

    public static void launchCamera(Activity activity, String applicationId, LaunchCameraCallback callback) {
<span class="nc" id="L371">        Intent intent = prepareLaunchCamera(activity, applicationId, callback);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (intent != null) {</span>
<span class="nc" id="L373">            activity.startActivityForResult(intent, RequestCodes.TAKE_PHOTO);</span>
        }
<span class="nc" id="L375">    }</span>

    private static Intent prepareLaunchCamera(Context context, String applicationId, LaunchCameraCallback callback) {
<span class="nc" id="L378">        String state = android.os.Environment.getExternalStorageState();</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">        if (!state.equals(android.os.Environment.MEDIA_MOUNTED)) {</span>
<span class="nc" id="L380">            showSDCardRequiredDialog(context);</span>
<span class="nc" id="L381">            return null;</span>
        } else {
            try {
<span class="nc" id="L384">                return getLaunchCameraIntent(context, applicationId, callback);</span>
<span class="nc" id="L385">            } catch (IOException e) {</span>
                // No need to write log here
<span class="nc" id="L387">                return null;</span>
            }
        }
    }

    private static Intent getLaunchCameraIntent(Context context, String applicationId, LaunchCameraCallback callback)
            throws IOException {
<span class="nc" id="L394">        File externalStoragePublicDirectory = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DCIM);</span>
<span class="nc" id="L395">        String mediaCapturePath =</span>
                externalStoragePublicDirectory + File.separator + &quot;Camera&quot; + File.separator + &quot;wp-&quot; + System
<span class="nc" id="L397">                        .currentTimeMillis() + &quot;.jpg&quot;;</span>

        // make sure the directory we plan to store the recording in exists
<span class="nc" id="L400">        File directory = new File(mediaCapturePath).getParentFile();</span>
<span class="nc bnc" id="L401" title="All 6 branches missed.">        if (directory == null || (!directory.exists() &amp;&amp; !directory.mkdirs())) {</span>
            try {
<span class="nc" id="L403">                throw new IOException(&quot;Path to file could not be created: &quot; + mediaCapturePath);</span>
<span class="nc" id="L404">            } catch (IOException e) {</span>
<span class="nc" id="L405">                AppLog.e(T.MEDIA, e);</span>
<span class="nc" id="L406">                throw e;</span>
            }
        }

        Uri fileUri;
        try {
<span class="nc" id="L412">            fileUri = FileProvider.getUriForFile(context, applicationId + &quot;.provider&quot;, new File(mediaCapturePath));</span>
<span class="nc" id="L413">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L414">            AppLog.e(T.MEDIA, &quot;Cannot access the file planned to store the new media&quot;, e);</span>
<span class="nc" id="L415">            throw new IOException(&quot;Cannot access the file planned to store the new media&quot;);</span>
<span class="nc" id="L416">        } catch (NullPointerException e) {</span>
<span class="nc" id="L417">            AppLog.e(T.MEDIA, &quot;Cannot access the file planned to store the new media - &quot;</span>
                              + &quot;FileProvider.getUriForFile cannot find a valid provider for the authority: &quot;
                              + applicationId + &quot;.provider&quot;, e);
<span class="nc" id="L420">            throw new IOException(&quot;Cannot access the file planned to store the new media&quot;);</span>
<span class="nc" id="L421">        }</span>

<span class="nc" id="L423">        Intent intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span>
<span class="nc" id="L424">        intent.putExtra(android.provider.MediaStore.EXTRA_OUTPUT, fileUri);</span>

<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (callback != null) {</span>
<span class="nc" id="L427">            callback.onMediaCapturePathReady(mediaCapturePath);</span>
        }
<span class="nc" id="L429">        return intent;</span>
    }

    private static Intent makePickOrCaptureIntent(Context context, String applicationId,
                                                  LaunchCameraCallback callback) {
<span class="nc" id="L434">        Intent pickPhotoIntent = prepareGalleryIntent(context.getString(R.string.capture_or_pick_photo));</span>

<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (DeviceUtils.getInstance().hasCamera(context)) {</span>
            try {
<span class="nc" id="L438">                Intent cameraIntent = getLaunchCameraIntent(context, applicationId, callback);</span>
<span class="nc" id="L439">                pickPhotoIntent.putExtra(</span>
                        Intent.EXTRA_INITIAL_INTENTS,
                        new Intent[]{cameraIntent});
<span class="nc" id="L442">            } catch (IOException e) {</span>
                // No need to write log here
<span class="nc" id="L444">            }</span>
        }

<span class="nc" id="L447">        return pickPhotoIntent;</span>
    }

    public static int getPlaceholder(String url) {
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (MediaUtils.isValidImage(url)) {</span>
<span class="nc" id="L452">            return R.drawable.ic_image_white_24dp;</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        } else if (MediaUtils.isDocument(url)) {</span>
<span class="nc" id="L454">            return R.drawable.ic_pages_white_24dp;</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        } else if (MediaUtils.isPowerpoint(url)) {</span>
<span class="nc" id="L456">            return R.drawable.media_powerpoint;</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">        } else if (MediaUtils.isSpreadsheet(url)) {</span>
<span class="nc" id="L458">            return R.drawable.media_spreadsheet;</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        } else if (MediaUtils.isVideo(url)) {</span>
<span class="nc" id="L460">            return R.drawable.ic_video_camera_white_24dp;</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">        } else if (MediaUtils.isAudio(url)) {</span>
<span class="nc" id="L462">            return R.drawable.ic_audio_white_24dp;</span>
        } else {
<span class="nc" id="L464">            return R.drawable.ic_image_multiple_white_24dp;</span>
        }
    }

    public static boolean canDeleteMedia(MediaModel mediaModel) {
<span class="nc" id="L469">        String state = mediaModel.getUploadState();</span>
<span class="nc bnc" id="L470" title="All 6 branches missed.">        return state == null || (!state.equalsIgnoreCase(&quot;uploading&quot;) &amp;&amp; !state.equalsIgnoreCase(&quot;deleted&quot;));</span>
    }

    /**
     * Returns a poster (thumbnail) URL given a VideoPress video URL
     *
     * @param videoUrl the remote URL to the VideoPress video
     */
    public static String getVideoPressVideoPosterFromURL(String videoUrl) {
<span class="nc" id="L479">        String posterUrl = &quot;&quot;;</span>

<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (videoUrl != null) {</span>
<span class="nc" id="L482">            int fileTypeLocation = videoUrl.lastIndexOf(&quot;.&quot;);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (fileTypeLocation &gt; 0) {</span>
<span class="nc" id="L484">                posterUrl = videoUrl.substring(0, fileTypeLocation) + &quot;_std.original.jpg&quot;;</span>
            }
        }

<span class="nc" id="L488">        return posterUrl;</span>
    }

    /*
     * passes a newly-created media file to the media scanner service so it's available to
     * the media content provider - use this after capturing or downloading media to ensure
     * that it appears in the stock Gallery app
     */
    public static void scanMediaFile(@NonNull Context context, @NonNull String localMediaPath) {
<span class="nc" id="L497">        MediaScannerConnection.scanFile(context,</span>
                                        new String[]{localMediaPath}, null,
<span class="nc" id="L499">                                        new MediaScannerConnection.OnScanCompletedListener() {</span>
                                            public void onScanCompleted(String path, Uri uri) {
<span class="nc" id="L501">                                                AppLog.d(T.MEDIA, &quot;Media scanner finished scanning &quot; + path);</span>
<span class="nc" id="L502">                                            }</span>
                                        });
<span class="nc" id="L504">    }</span>

    /*
     * returns true if the current user has permission to upload new media to the passed site
     */
    public static boolean currentUserCanUploadMedia(@NonNull SiteModel site) {
<span class="nc bnc" id="L510" title="All 2 branches missed.">        boolean isSelfHosted = !site.isUsingWpComRestApi();</span>
        // self-hosted sites don't have capabilities so always return true
<span class="nc bnc" id="L512" title="All 4 branches missed.">        return isSelfHosted || site.getHasCapabilityUploadFiles();</span>
    }

    public static boolean currentUserCanDeleteMedia(@NonNull SiteModel site) {
<span class="nc" id="L516">        return currentUserCanUploadMedia(site);</span>
    }

    /*
     * returns the minimum distance for a fling which determines whether to disable loading
     * thumbnails in the media grid or photo picker - used to conserve memory usage during
     * a reasonably-sized fling
     */
    public static int getFlingDistanceToDisableThumbLoading(@NonNull Context context) {
<span class="nc" id="L525">        return ViewConfiguration.get(context).getScaledMaximumFlingVelocity() / 2;</span>
    }


    public interface MediaFetchDoNext {
        void doNext(Uri uri);
    }

    /**
     * Downloads the {@code mediaUri} and returns the {@link Uri} for the downloaded file
     * &lt;p&gt;
     * If the {@code mediaUri} is already in the the local store, no download will be done and the given
     * {@code mediaUri} will be returned instead. This may return null if the download fails.
     * &lt;p&gt;
     * The current thread is blocked until the download is finished.
     *
     * @return A local {@link Uri} or null if the download failed
     */
    public static @Nullable Uri fetchMedia(@NonNull Context context, @NonNull Uri mediaUri) {
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (MediaUtils.isInMediaStore(mediaUri)) {</span>
<span class="nc" id="L545">            return mediaUri;</span>
        }

        try {
            // Do not download the file in async task. See
            // https://github.com/wordpress-mobile/WordPress-Android/issues/5818
<span class="nc" id="L551">            return MediaUtils.downloadExternalMedia(context, mediaUri);</span>
<span class="nc" id="L552">        } catch (IllegalStateException e) {</span>
            // Ref: https://github.com/wordpress-mobile/WordPress-Android/issues/5823
<span class="nc" id="L554">            AppLog.e(AppLog.T.UTILS, &quot;Can't download the image at: &quot; + mediaUri.toString()</span>
                                     + &quot; See issue #5823&quot;, e);

<span class="nc" id="L557">            return null;</span>
        }
    }

    /**
     * Downloads the given {@code mediaUri} and calls {@code listener} if successful
     * &lt;p&gt;
     * If the download fails, a {@link android.widget.Toast} will be shown.
     *
     * @return A {@link Boolean} indicating whether the download was successful
     */
    public static boolean fetchMediaAndDoNext(Context context, Uri mediaUri, MediaFetchDoNext listener) {
<span class="nc" id="L569">        final Uri downloadedUri = fetchMedia(context, mediaUri);</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (downloadedUri != null) {</span>
<span class="nc" id="L571">            listener.doNext(downloadedUri);</span>
<span class="nc" id="L572">            return true;</span>
        } else {
<span class="nc" id="L574">            ToastUtils.showToast(context, R.string.error_downloading_image,</span>
                    ToastUtils.Duration.SHORT);
<span class="nc" id="L576">            return false;</span>
        }
    }

    public static List&lt;Uri&gt; retrieveImageEditorResult(Intent data) {
<span class="nc bnc" id="L581" title="All 4 branches missed.">        if (data != null &amp;&amp; data.hasExtra(PreviewImageFragment.ARG_EDIT_IMAGE_DATA)) {</span>
<span class="nc" id="L582">            return convertEditImageOutputToListOfUris(data.getParcelableArrayListExtra(</span>
                    PreviewImageFragment.ARG_EDIT_IMAGE_DATA));
        } else {
<span class="nc" id="L585">            return new ArrayList&lt;Uri&gt;();</span>
        }
    }

    private static List&lt;Uri&gt; convertEditImageOutputToListOfUris(List&lt;EditImageData.OutputData&gt; data) {
<span class="nc" id="L590">        List&lt;Uri&gt; uris = new ArrayList&lt;&gt;(data.size());</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">        for (EditImageData.OutputData item : data) {</span>
<span class="nc" id="L592">            uris.add(Uri.parse(item.getOutputFilePath()));</span>
<span class="nc" id="L593">        }</span>
<span class="nc" id="L594">        return uris;</span>
    }

    public static List&lt;Uri&gt; retrieveMediaUris(Intent data) {
<span class="nc" id="L598">        ClipData clipData = data.getClipData();</span>
<span class="nc" id="L599">        ArrayList&lt;Uri&gt; uriList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (clipData != null) {</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">            for (int i = 0; i &lt; clipData.getItemCount(); i++) {</span>
<span class="nc" id="L602">                ClipData.Item item = clipData.getItemAt(i);</span>
<span class="nc" id="L603">                uriList.add(item.getUri());</span>
            }
        } else {
<span class="nc" id="L606">            uriList.add(data.getData());</span>
        }
<span class="nc" id="L608">        return uriList;</span>
    }

    public static ArrayList&lt;EditImageData.InputData&gt; createListOfEditImageInputData(Context ctx, List&lt;Uri&gt; uris) {
<span class="nc" id="L612">        ArrayList&lt;EditImageData.InputData&gt; inputData = new ArrayList&lt;&gt;(uris.size());</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">        for (Uri uri : uris) {</span>
<span class="nc" id="L614">            String outputFileExtension = getFileExtension(ctx, uri);</span>
<span class="nc" id="L615">            inputData.add(new EditImageData.InputData(uri.toString(), null, outputFileExtension));</span>
<span class="nc" id="L616">        }</span>
<span class="nc" id="L617">        return inputData;</span>
    }

    public static String getFileExtension(Context ctx, Uri uri) {
        String fileExtension;
<span class="nc bnc" id="L622" title="All 4 branches missed.">        if (uri.getScheme() != null &amp;&amp; uri.getScheme().equals(ContentResolver.SCHEME_CONTENT)) {</span>
<span class="nc" id="L623">            ContentResolver cr = ctx.getContentResolver();</span>
<span class="nc" id="L624">            String mimeType = cr.getType(uri);</span>
<span class="nc" id="L625">            fileExtension = MimeTypeMap.getSingleton().getExtensionFromMimeType(mimeType);</span>
<span class="nc" id="L626">        } else {</span>
<span class="nc" id="L627">            fileExtension = MimeTypeMap.getFileExtensionFromUrl(uri.toString());</span>
        }
<span class="nc" id="L629">        return fileExtension;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>