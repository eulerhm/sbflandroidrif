<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationsUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.notifications.utils</a> &gt; <span class="el_source">NotificationsUtils.java</span></div><h1>NotificationsUtils.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.notifications.utils;

import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.graphics.Typeface;
import android.graphics.drawable.Drawable;
import android.os.Build;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.text.Layout;
import android.text.Spannable;
import android.text.SpannableStringBuilder;
import android.text.Spanned;
import android.text.TextUtils;
import android.text.style.AlignmentSpan;
import android.text.style.ImageSpan;
import android.text.style.StyleSpan;
import android.view.View;
import android.widget.TextView;

import androidx.appcompat.app.AlertDialog;
import androidx.core.app.NotificationManagerCompat;

import com.android.volley.VolleyError;
import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.wordpress.rest.RestRequest;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.wordpress.android.BuildConfig;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.datasets.NotificationsTable;
import org.wordpress.android.fluxc.tools.FormattableContent;
import org.wordpress.android.fluxc.tools.FormattableContentMapper;
import org.wordpress.android.fluxc.tools.FormattableMedia;
import org.wordpress.android.fluxc.tools.FormattableRange;
import org.wordpress.android.models.Note;
import org.wordpress.android.push.GCMMessageService;
import org.wordpress.android.ui.notifications.blocks.NoteBlock;
import org.wordpress.android.ui.notifications.blocks.NoteBlockClickableSpan;
import org.wordpress.android.ui.notifications.blocks.NoteBlockLinkMovementMethod;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.DeviceUtils;
import org.wordpress.android.util.PackageUtils;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.image.getters.WPCustomImageGetter;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import kotlin.Unit;
import kotlin.jvm.functions.Function1;

<span class="nc" id="L61">public class NotificationsUtils {</span>
    public static final String ARG_PUSH_AUTH_TOKEN = &quot;arg_push_auth_token&quot;;
    public static final String ARG_PUSH_AUTH_TITLE = &quot;arg_push_auth_title&quot;;
    public static final String ARG_PUSH_AUTH_MESSAGE = &quot;arg_push_auth_message&quot;;
    public static final String ARG_PUSH_AUTH_EXPIRES = &quot;arg_push_auth_expires&quot;;

    public static final String WPCOM_PUSH_DEVICE_NOTIFICATION_SETTINGS = &quot;wp_pref_notification_settings&quot;;
    public static final String WPCOM_PUSH_DEVICE_UUID = &quot;wp_pref_notifications_uuid&quot;;
    public static final String WPCOM_PUSH_DEVICE_TOKEN = &quot;wp_pref_notifications_token&quot;;

    public static final String WPCOM_PUSH_DEVICE_SERVER_ID = &quot;wp_pref_notifications_server_id&quot;;
    public static final String PUSH_AUTH_ENDPOINT = &quot;me/two-step/push-authentication&quot;;

    private static final String CHECK_OP_NO_THROW = &quot;checkOpNoThrow&quot;;
    private static final String OP_POST_NOTIFICATION = &quot;OP_POST_NOTIFICATION&quot;;

    private static final String WPCOM_SETTINGS_ENDPOINT = &quot;/me/notifications/settings/&quot;;

    public interface TwoFactorAuthCallback {
        void onTokenValid(String token, String title, String message);

        void onTokenInvalid();
    }

    public static void getPushNotificationSettings(Context context, RestRequest.Listener listener,
                                                   RestRequest.ErrorListener errorListener) {
<span class="nc" id="L87">        SharedPreferences settings = PreferenceManager.getDefaultSharedPreferences(context);</span>
<span class="nc" id="L88">        String deviceID = settings.getString(WPCOM_PUSH_DEVICE_SERVER_ID, null);</span>
<span class="nc" id="L89">        String settingsEndpoint = WPCOM_SETTINGS_ENDPOINT;</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (!TextUtils.isEmpty(deviceID)) {</span>
<span class="nc" id="L91">            settingsEndpoint += &quot;?device_id=&quot; + deviceID;</span>
        }
<span class="nc" id="L93">        WordPress.getRestClientUtilsV1_1().get(settingsEndpoint, listener, errorListener);</span>
<span class="nc" id="L94">    }</span>

    public static void registerDeviceForPushNotifications(final Context ctx, String token) {
<span class="nc" id="L97">        SharedPreferences settings = PreferenceManager.getDefaultSharedPreferences(ctx);</span>
<span class="nc" id="L98">        String uuid = settings.getString(WPCOM_PUSH_DEVICE_UUID, null);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (uuid == null) {</span>
<span class="nc" id="L100">            return;</span>
        }

<span class="nc" id="L103">        String deviceName = DeviceUtils.getInstance().getDeviceName(ctx);</span>
<span class="nc" id="L104">        Map&lt;String, String&gt; contentStruct = new HashMap&lt;&gt;();</span>
<span class="nc" id="L105">        contentStruct.put(&quot;app_secret_key&quot;, BuildConfig.PUSH_NOTIFICATIONS_APP_KEY);</span>
<span class="nc" id="L106">        contentStruct.put(&quot;device_token&quot;, token);</span>
<span class="nc" id="L107">        contentStruct.put(&quot;device_family&quot;, &quot;android&quot;);</span>
<span class="nc" id="L108">        contentStruct.put(&quot;device_name&quot;, deviceName);</span>
<span class="nc" id="L109">        contentStruct.put(&quot;device_model&quot;, Build.MANUFACTURER + &quot; &quot; + Build.MODEL);</span>
<span class="nc" id="L110">        contentStruct.put(&quot;app_version&quot;, WordPress.versionName);</span>
<span class="nc" id="L111">        contentStruct.put(&quot;version_code&quot;, String.valueOf(PackageUtils.getVersionCode(ctx)));</span>
<span class="nc" id="L112">        contentStruct.put(&quot;os_version&quot;, Build.VERSION.RELEASE);</span>
<span class="nc" id="L113">        contentStruct.put(&quot;device_uuid&quot;, uuid);</span>
<span class="nc" id="L114">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L117">                AppLog.d(T.NOTIFS, &quot;Register token action succeeded&quot;);</span>
                try {
<span class="nc" id="L119">                    String deviceID = jsonObject.getString(&quot;ID&quot;);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                    if (deviceID == null) {</span>
<span class="nc" id="L121">                        AppLog.e(T.NOTIFS, &quot;Server response is missing of the device_id. Registration skipped!!&quot;);</span>
<span class="nc" id="L122">                        return;</span>
                    }
<span class="nc" id="L124">                    SharedPreferences settings = PreferenceManager.getDefaultSharedPreferences(ctx);</span>
<span class="nc" id="L125">                    SharedPreferences.Editor editor = settings.edit();</span>
<span class="nc" id="L126">                    editor.putString(WPCOM_PUSH_DEVICE_SERVER_ID, deviceID);</span>
<span class="nc" id="L127">                    editor.apply();</span>
<span class="nc" id="L128">                    AppLog.d(T.NOTIFS, &quot;Server response OK. The device_id: &quot; + deviceID);</span>
<span class="nc" id="L129">                } catch (JSONException e1) {</span>
<span class="nc" id="L130">                    AppLog.e(T.NOTIFS, &quot;Server response is NOT ok, registration skipped.&quot;, e1);</span>
<span class="nc" id="L131">                }</span>
<span class="nc" id="L132">            }</span>
        };
<span class="nc" id="L134">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L137">                AppLog.e(T.NOTIFS, &quot;Register token action failed&quot;, volleyError);</span>
<span class="nc" id="L138">            }</span>
        };

<span class="nc" id="L141">        WordPress.getRestClientUtils().post(&quot;/devices/new&quot;, contentStruct, null, listener, errorListener);</span>
<span class="nc" id="L142">    }</span>

    public static void unregisterDevicePushNotifications(final Context ctx) {
<span class="nc" id="L145">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc" id="L148">                AppLog.d(T.NOTIFS, &quot;Unregister token action succeeded&quot;);</span>
<span class="nc" id="L149">                SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(ctx).edit();</span>
<span class="nc" id="L150">                editor.remove(WPCOM_PUSH_DEVICE_SERVER_ID);</span>
<span class="nc" id="L151">                editor.remove(WPCOM_PUSH_DEVICE_UUID);</span>
<span class="nc" id="L152">                editor.remove(WPCOM_PUSH_DEVICE_TOKEN);</span>
<span class="nc" id="L153">                editor.apply();</span>
<span class="nc" id="L154">            }</span>
        };
<span class="nc" id="L156">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L159">                AppLog.e(T.NOTIFS, &quot;Unregister token action failed&quot;, volleyError);</span>
<span class="nc" id="L160">            }</span>
        };

<span class="nc" id="L163">        SharedPreferences settings = PreferenceManager.getDefaultSharedPreferences(ctx);</span>
<span class="nc" id="L164">        String deviceID = settings.getString(WPCOM_PUSH_DEVICE_SERVER_ID, null);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (TextUtils.isEmpty(deviceID)) {</span>
<span class="nc" id="L166">            return;</span>
        }
<span class="nc" id="L168">        WordPress.getRestClientUtils().post(&quot;/devices/&quot; + deviceID + &quot;/delete&quot;, listener, errorListener);</span>
<span class="nc" id="L169">    }</span>

    static FormattableContent mapJsonToFormattableContent(FormattableContentMapper mapper, JSONObject blockObject) {
<span class="nc" id="L172">        return mapper.mapToFormattableContent(blockObject.toString());</span>
    }

    public static void cancelAllNotifications(Context context) {
<span class="nc" id="L176">        NotificationManagerCompat.from(context).cancelAll();</span>
<span class="nc" id="L177">    }</span>

    static SpannableStringBuilder getSpannableContentForRanges(
            FormattableContentMapper formattableContentMapper,
            JSONObject blockObject, TextView textView,
            final NoteBlock.OnNoteBlockTextClickListener onNoteBlockTextClickListener,
            boolean isFooter) {
<span class="nc" id="L184">        return getSpannableContentForRanges(mapJsonToFormattableContent(formattableContentMapper, blockObject),</span>
                textView, onNoteBlockTextClickListener, isFooter);
    }

    /**
     * Returns a spannable with formatted content based on WP.com note content 'range' data
     *
     * @param formattableContent the data
     * @param textView the TextView that will display the spannnable
     * @param onNoteBlockTextClickListener - click listener for ClickableSpans in the spannable
     * @param isFooter - Set if spannable should apply special formatting
     * @return Spannable string with formatted content
     */
    static SpannableStringBuilder getSpannableContentForRanges(FormattableContent formattableContent, TextView textView,
                                                  final NoteBlock.OnNoteBlockTextClickListener
                                                          onNoteBlockTextClickListener,
                                                  boolean isFooter) {
        Function1&lt;NoteBlockClickableSpan, Unit&gt; clickListener =
<span class="nc bnc" id="L202" title="All 2 branches missed.">                onNoteBlockTextClickListener != null ? new Function1&lt;NoteBlockClickableSpan, Unit&gt;() {</span>
                    @Override public Unit invoke(NoteBlockClickableSpan noteBlockClickableSpan) {
<span class="nc" id="L204">                        onNoteBlockTextClickListener.onNoteBlockTextClicked(noteBlockClickableSpan);</span>
<span class="nc" id="L205">                        return null;</span>
                    }
<span class="nc" id="L207">                } : null;</span>
<span class="nc" id="L208">        return getSpannableContentForRanges(formattableContent,</span>
                textView,
                isFooter,
                clickListener);
    }

    /**
     * Returns a spannable with formatted content based on WP.com note content 'range' data
     *
     * @param formattableContent the data
     * @param textView the TextView that will display the spannnable
     * @param clickHandler - click listener for ClickableSpans in the spannable
     * @param isFooter - Set if spannable should apply special formatting
     * @return Spannable string with formatted content
     */
    static SpannableStringBuilder getSpannableContentForRanges(FormattableContent formattableContent,
                                                  TextView textView,
                                                  final Function1&lt;FormattableRange, Unit&gt; clickHandler,
                                                  boolean isFooter) {
        Function1&lt;NoteBlockClickableSpan, Unit&gt; clickListener =
<span class="nc bnc" id="L228" title="All 2 branches missed.">                clickHandler != null ? new Function1&lt;NoteBlockClickableSpan, Unit&gt;() {</span>
                    @Override public Unit invoke(NoteBlockClickableSpan noteBlockClickableSpan) {
<span class="nc" id="L230">                        clickHandler.invoke(noteBlockClickableSpan.getFormattableRange());</span>
<span class="nc" id="L231">                        return null;</span>
                    }
<span class="nc" id="L233">                } : null;</span>
<span class="nc" id="L234">        return getSpannableContentForRanges(formattableContent,</span>
                textView,
                isFooter,
                clickListener);
    }

    /**
     * Returns a spannable with formatted content based on WP.com note content 'range' data
     *
     * @param formattableContent the data
     * @param textView the TextView that will display the spannnable
     * @param onNoteBlockTextClickListener - click listener for ClickableSpans in the spannable
     * @param isFooter - Set if spannable should apply special formatting
     * @return Spannable string with formatted content
     */
    private static SpannableStringBuilder getSpannableContentForRanges(FormattableContent formattableContent,
                                                          TextView textView,
                                                          boolean isFooter,
                                                          final Function1&lt;NoteBlockClickableSpan, Unit&gt;
                                                                  onNoteBlockTextClickListener) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (formattableContent == null) {</span>
<span class="nc" id="L255">            return new SpannableStringBuilder();</span>
        }

<span class="nc" id="L258">        String text = formattableContent.getText();</span>
<span class="nc" id="L259">        SpannableStringBuilder spannableStringBuilder = new SpannableStringBuilder(text);</span>

<span class="nc bnc" id="L261" title="All 2 branches missed.">        boolean shouldLink = onNoteBlockTextClickListener != null;</span>

        // Add ImageSpans for note media
<span class="nc" id="L264">        addImageSpansForBlockMedia(textView, formattableContent, spannableStringBuilder);</span>

        // Process Ranges to add links and text formatting
<span class="nc" id="L267">        List&lt;FormattableRange&gt; rangesArray = formattableContent.getRanges();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (rangesArray != null) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            for (FormattableRange range : rangesArray) {</span>
<span class="nc" id="L270">                NoteBlockClickableSpan clickableSpan =</span>
<span class="nc" id="L271">                        new NoteBlockClickableSpan(range, shouldLink, isFooter) {</span>
                    @Override
                    public void onClick(View widget) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">                        if (onNoteBlockTextClickListener != null) {</span>
<span class="nc" id="L275">                            onNoteBlockTextClickListener.invoke(this);</span>
                        }
<span class="nc" id="L277">                    }</span>
                };

<span class="nc" id="L280">                List&lt;Integer&gt; indices = clickableSpan.getIndices();</span>
<span class="nc bnc" id="L281" title="All 6 branches missed.">                if (indices != null &amp;&amp; indices.size() == 2 &amp;&amp; indices.get(0) &lt;= spannableStringBuilder.length()</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                    &amp;&amp; indices.get(1) &lt;= spannableStringBuilder.length()) {</span>
<span class="nc" id="L283">                    spannableStringBuilder</span>
<span class="nc" id="L284">                            .setSpan(clickableSpan, indices.get(0), indices.get(1), Spanned.SPAN_INCLUSIVE_INCLUSIVE);</span>

                    // Add additional styling if the range wants it
<span class="nc bnc" id="L287" title="All 2 branches missed.">                    if (clickableSpan.getSpanStyle() != Typeface.NORMAL) {</span>
<span class="nc" id="L288">                        StyleSpan styleSpan = new StyleSpan(clickableSpan.getSpanStyle());</span>
<span class="nc" id="L289">                        spannableStringBuilder</span>
<span class="nc" id="L290">                                .setSpan(styleSpan, indices.get(0), indices.get(1), Spanned.SPAN_INCLUSIVE_INCLUSIVE);</span>
                    }

<span class="nc bnc" id="L293" title="All 4 branches missed.">                    if (onNoteBlockTextClickListener != null &amp;&amp; textView != null) {</span>
<span class="nc" id="L294">                        textView.setLinksClickable(true);</span>
<span class="nc" id="L295">                        textView.setMovementMethod(new NoteBlockLinkMovementMethod());</span>
                    }
                }
<span class="nc" id="L298">            }</span>
        }

<span class="nc" id="L301">        return spannableStringBuilder;</span>
    }

    public static int[] getIndicesForRange(JSONObject rangeObject) {
<span class="nc" id="L305">        int[] indices = new int[]{0, 0};</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (rangeObject == null) {</span>
<span class="nc" id="L307">            return indices;</span>
        }

<span class="nc" id="L310">        JSONArray indicesArray = rangeObject.optJSONArray(&quot;indices&quot;);</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">        if (indicesArray != null &amp;&amp; indicesArray.length() &gt;= 2) {</span>
<span class="nc" id="L312">            indices[0] = indicesArray.optInt(0);</span>
<span class="nc" id="L313">            indices[1] = indicesArray.optInt(1);</span>
        }

<span class="nc" id="L316">        return indices;</span>
    }

    /**
     * Adds ImageSpans to the passed SpannableStringBuilder
     */
    private static void addImageSpansForBlockMedia(TextView textView, FormattableContent subject,
                                                   SpannableStringBuilder spannableStringBuilder) {
<span class="nc bnc" id="L324" title="All 6 branches missed.">        if (textView == null || subject == null || spannableStringBuilder == null) {</span>
<span class="nc" id="L325">            return;</span>
        }

<span class="nc" id="L328">        Context context = textView.getContext();</span>
<span class="nc" id="L329">        List&lt;FormattableMedia&gt; mediaArray = subject.getMedia();</span>
<span class="nc bnc" id="L330" title="All 4 branches missed.">        if (context == null || mediaArray == null) {</span>
<span class="nc" id="L331">            return;</span>
        }

        // Note: notifications_max_image_size seems to be the max size an ImageSpan can handle,
        // otherwise it would load blank white
<span class="nc" id="L336">        WPCustomImageGetter imageGetter = new WPCustomImageGetter(textView,</span>
<span class="nc" id="L337">                context.getResources().getDimensionPixelSize(R.dimen.notifications_max_image_size),</span>
<span class="nc" id="L338">                textView.getLineHeight());</span>

<span class="nc" id="L340">        int indexAdjustment = 0;</span>
        String imagePlaceholder;
<span class="nc bnc" id="L342" title="All 2 branches missed.">        for (FormattableMedia mediaObject : mediaArray) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if (mediaObject == null) {</span>
<span class="nc" id="L344">                continue;</span>
            }

<span class="nc" id="L347">            final Drawable remoteDrawable = imageGetter.getDrawable(StringUtils.notNullStr(mediaObject.getUrl()));</span>
<span class="nc" id="L348">            ImageSpan noteImageSpan = new ImageSpan(remoteDrawable, StringUtils.notNullStr(mediaObject.getUrl()));</span>
<span class="nc" id="L349">            int startIndex = -1;</span>
<span class="nc" id="L350">            int endIndex = -1;</span>
            List&lt;Integer&gt; indices =
<span class="nc bnc" id="L352" title="All 4 branches missed.">                    (mediaObject.getIndices() != null &amp;&amp; mediaObject.getIndices().size() == 2) ? mediaObject</span>
<span class="nc" id="L353">                            .getIndices() : null;</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (indices != null) {</span>
<span class="nc" id="L355">                startIndex = indices.get(0);</span>
<span class="nc" id="L356">                endIndex = indices.get(1);</span>
            }
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (startIndex &gt;= 0) {</span>
<span class="nc" id="L359">                startIndex += indexAdjustment;</span>
<span class="nc" id="L360">                endIndex += indexAdjustment;</span>

<span class="nc bnc" id="L362" title="All 2 branches missed.">                if (startIndex &gt; spannableStringBuilder.length()) {</span>
<span class="nc" id="L363">                    continue;</span>
                }

                // If we have a range, it means there is alt text that should be removed
<span class="nc bnc" id="L367" title="All 4 branches missed.">                if (endIndex &gt; startIndex &amp;&amp; endIndex &lt;= spannableStringBuilder.length()) {</span>
<span class="nc" id="L368">                    spannableStringBuilder.replace(startIndex, endIndex, &quot;&quot;);</span>
                }

                // We need an empty space to insert the ImageSpan into
<span class="nc" id="L372">                imagePlaceholder = &quot; &quot;;</span>

                // Move the image to a new line if needed
<span class="nc bnc" id="L375" title="All 2 branches missed.">                int previousCharIndex = (startIndex &gt; 0) ? startIndex - 1 : 0;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                if (!spannableHasCharacterAtIndex(spannableStringBuilder, '\n', previousCharIndex)</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                    || spannableStringBuilder.getSpans(startIndex, startIndex, ImageSpan.class).length &gt; 0) {</span>
<span class="nc" id="L378">                    imagePlaceholder = &quot;\n &quot;;</span>
                }

<span class="nc" id="L381">                int spanIndex = startIndex + imagePlaceholder.length() - 1;</span>

                // Add a newline after the image if needed
<span class="nc bnc" id="L384" title="All 2 branches missed.">                if (!spannableHasCharacterAtIndex(spannableStringBuilder, '\n', startIndex)</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    &amp;&amp; !spannableHasCharacterAtIndex(spannableStringBuilder, '\r', startIndex)) {</span>
<span class="nc" id="L386">                    imagePlaceholder += &quot;\n&quot;;</span>
                }

<span class="nc" id="L389">                spannableStringBuilder.insert(startIndex, imagePlaceholder);</span>

                // Add the image span
<span class="nc" id="L392">                spannableStringBuilder.setSpan(</span>
                        noteImageSpan,
                        spanIndex,
                        spanIndex + 1,
                        Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
                );

                // Add an AlignmentSpan to center the image
<span class="nc" id="L400">                spannableStringBuilder.setSpan(</span>
                        new AlignmentSpan.Standard(Layout.Alignment.ALIGN_CENTER),
                        spanIndex,
                        spanIndex + 1,
                        Spannable.SPAN_EXCLUSIVE_EXCLUSIVE
                );

<span class="nc" id="L407">                indexAdjustment += imagePlaceholder.length();</span>
            }
<span class="nc" id="L409">        }</span>
<span class="nc" id="L410">    }</span>

    public static boolean spannableHasCharacterAtIndex(Spannable spannable, char character, int index) {
<span class="nc bnc" id="L413" title="All 6 branches missed.">        return spannable != null &amp;&amp; index &lt; spannable.length() &amp;&amp; spannable.charAt(index) == character;</span>
    }

    public static boolean validate2FAuthorizationTokenFromIntentExtras(Intent intent, TwoFactorAuthCallback callback) {
        // Check for push authorization request
<span class="nc bnc" id="L418" title="All 4 branches missed.">        if (intent != null &amp;&amp; intent.hasExtra(NotificationsUtils.ARG_PUSH_AUTH_TOKEN)) {</span>
<span class="nc" id="L419">            Bundle extras = intent.getExtras();</span>
<span class="nc" id="L420">            String token = extras.getString(NotificationsUtils.ARG_PUSH_AUTH_TOKEN, &quot;&quot;);</span>
<span class="nc" id="L421">            String title = extras.getString(NotificationsUtils.ARG_PUSH_AUTH_TITLE, &quot;&quot;);</span>
<span class="nc" id="L422">            String message = extras.getString(NotificationsUtils.ARG_PUSH_AUTH_MESSAGE, &quot;&quot;);</span>
<span class="nc" id="L423">            long expires = extras.getLong(NotificationsUtils.ARG_PUSH_AUTH_EXPIRES, 0);</span>

<span class="nc" id="L425">            long now = System.currentTimeMillis() / 1000;</span>
<span class="nc bnc" id="L426" title="All 4 branches missed.">            if (expires &gt; 0 &amp;&amp; now &gt; expires) {</span>
<span class="nc" id="L427">                callback.onTokenInvalid();</span>
<span class="nc" id="L428">                return false;</span>
            } else {
<span class="nc" id="L430">                callback.onTokenValid(token, title, message);</span>
<span class="nc" id="L431">                return true;</span>
            }
        }
<span class="nc" id="L434">        return false;</span>
    }


    public static void showPushAuthAlert(Context context, final String token, String title, String message) {
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (context == null</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">            || TextUtils.isEmpty(token)</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            || TextUtils.isEmpty(title)</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            || TextUtils.isEmpty(message)) {</span>
<span class="nc" id="L443">            return;</span>
        }

<span class="nc" id="L446">        AlertDialog.Builder builder = new MaterialAlertDialogBuilder(context);</span>
<span class="nc" id="L447">        builder.setTitle(title).setMessage(message);</span>

<span class="nc" id="L449">        builder.setPositiveButton(R.string.mnu_comment_approve, new DialogInterface.OnClickListener() {</span>
            @Override
            public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L452">                sendTwoFactorAuthToken(token);</span>
<span class="nc" id="L453">            }</span>
        });

<span class="nc" id="L456">        builder.setNegativeButton(R.string.ignore, new DialogInterface.OnClickListener() {</span>
            @Override
            public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L459">                AnalyticsTracker.track(AnalyticsTracker.Stat.PUSH_AUTHENTICATION_IGNORED);</span>
<span class="nc" id="L460">            }</span>
        });

<span class="nc" id="L463">        AlertDialog dialog = builder.create();</span>
<span class="nc" id="L464">        dialog.show();</span>
<span class="nc" id="L465">    }</span>

    public static void sendTwoFactorAuthToken(String token) {
        // ping the push auth endpoint with the token, wp.com will take care of the rest!
<span class="nc" id="L469">        Map&lt;String, String&gt; tokenMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L470">        tokenMap.put(&quot;action&quot;, &quot;authorize_login&quot;);</span>
<span class="nc" id="L471">        tokenMap.put(&quot;push_token&quot;, token);</span>
<span class="nc" id="L472">        WordPress.getRestClientUtilsV1_1().post(</span>
                PUSH_AUTH_ENDPOINT, tokenMap, null, null,
<span class="nc" id="L474">                new RestRequest.ErrorListener() {</span>
                    @Override
                    public void onErrorResponse(VolleyError error) {
<span class="nc" id="L477">                        AnalyticsTracker.track(AnalyticsTracker.Stat.PUSH_AUTHENTICATION_FAILED);</span>
<span class="nc" id="L478">                    }</span>
                });

<span class="nc" id="L481">        AnalyticsTracker.track(AnalyticsTracker.Stat.PUSH_AUTHENTICATION_APPROVED);</span>
<span class="nc" id="L482">    }</span>

    /**
     * Checks if global notifications toggle is enabled in the Android app settings
     */
    public static boolean isNotificationsEnabled(Context context) {
<span class="nc" id="L488">        return NotificationManagerCompat.from(context.getApplicationContext()).areNotificationsEnabled();</span>
    }

    public static boolean buildNoteObjectFromBundleAndSaveIt(Bundle data) {
<span class="nc" id="L492">        Note note = buildNoteObjectFromBundle(data);</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">        if (note != null) {</span>
<span class="nc" id="L494">            return NotificationsTable.saveNote(note);</span>
        }

<span class="nc" id="L497">        return false;</span>
    }

    public static Note buildNoteObjectFromBundle(Bundle data) {
<span class="nc bnc" id="L501" title="All 2 branches missed.">        if (data == null) {</span>
<span class="nc" id="L502">            AppLog.e(T.NOTIFS, &quot;Bundle is null! Cannot read '&quot; + GCMMessageService.PUSH_ARG_NOTE_ID + &quot;'.&quot;);</span>
<span class="nc" id="L503">            return null;</span>
        }

        Note note;
<span class="nc" id="L507">        String noteId = data.getString(GCMMessageService.PUSH_ARG_NOTE_ID, &quot;&quot;);</span>
<span class="nc" id="L508">        String base64FullData = data.getString(GCMMessageService.PUSH_ARG_NOTE_FULL_DATA);</span>
<span class="nc" id="L509">        note = Note.buildFromBase64EncodedData(noteId, base64FullData);</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (note == null) {</span>
            // At this point we don't have the note :(
<span class="nc" id="L512">            AppLog.w(T.NOTIFS, &quot;Cannot build the Note object by using info available in the PN payload. Please see &quot;</span>
                               + &quot;previous log messages for detailed information about the error.&quot;);
        }

<span class="nc" id="L516">        return note;</span>
    }

    public static int findNoteInNoteArray(List&lt;Note&gt; notes, String noteIdToSearchFor) {
<span class="nc bnc" id="L520" title="All 4 branches missed.">        if (notes == null || TextUtils.isEmpty(noteIdToSearchFor)) {</span>
<span class="nc" id="L521">            return -1;</span>
        }

<span class="nc bnc" id="L524" title="All 2 branches missed.">        for (int i = 0; i &lt; notes.size(); i++) {</span>
<span class="nc" id="L525">            Note note = notes.get(i);</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">            if (noteIdToSearchFor.equals(note.getId())) {</span>
<span class="nc" id="L527">                return i;</span>
            }
        }
<span class="nc" id="L530">        return -1;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>