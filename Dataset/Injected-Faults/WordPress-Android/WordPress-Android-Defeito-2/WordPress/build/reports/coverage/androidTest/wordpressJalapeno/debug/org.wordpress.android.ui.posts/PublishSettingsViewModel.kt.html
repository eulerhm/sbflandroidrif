<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PublishSettingsViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PublishSettingsViewModel.kt</span></div><h1>PublishSettingsViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import android.text.TextUtils
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.PostImmutableModel
import org.wordpress.android.fluxc.model.post.PostStatus
import org.wordpress.android.fluxc.model.post.PostStatus.DRAFT
import org.wordpress.android.fluxc.model.post.PostStatus.PUBLISHED
import org.wordpress.android.fluxc.model.post.PostStatus.SCHEDULED
import org.wordpress.android.fluxc.store.PostSchedulingNotificationStore
import org.wordpress.android.fluxc.store.PostSchedulingNotificationStore.SchedulingReminderModel.Period
import org.wordpress.android.fluxc.store.PostSchedulingNotificationStore.SchedulingReminderModel.Period.OFF
import org.wordpress.android.fluxc.store.PostSchedulingNotificationStore.SchedulingReminderModel.Period.ONE_HOUR
import org.wordpress.android.fluxc.store.PostSchedulingNotificationStore.SchedulingReminderModel.Period.TEN_MINUTES
import org.wordpress.android.fluxc.store.PostSchedulingNotificationStore.SchedulingReminderModel.Period.WHEN_PUBLISHED
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.ui.posts.EditPostRepository.UpdatePostResult
import org.wordpress.android.util.DateTimeUtils
import org.wordpress.android.util.LocaleManagerWrapper
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ResourceProvider
import java.util.Calendar

abstract class PublishSettingsViewModel
<span class="nc" id="L28">constructor(</span>
<span class="nc" id="L29">    private val resourceProvider: ResourceProvider,</span>
<span class="nc" id="L30">    private val postSettingsUtils: PostSettingsUtils,</span>
<span class="nc" id="L31">    private val localeManagerWrapper: LocaleManagerWrapper,</span>
<span class="nc" id="L32">    private val postSchedulingNotificationStore: PostSchedulingNotificationStore,</span>
<span class="nc" id="L33">    private val siteStore: SiteStore</span>
<span class="nc" id="L34">) : ViewModel() {</span>
<span class="nc" id="L35">    var canPublishImmediately: Boolean = false</span>

<span class="nc" id="L37">    var year: Int? = null</span>
        private set
<span class="nc" id="L39">    var month: Int? = null</span>
        private set
<span class="nc" id="L41">    var day: Int? = null</span>
        private set
<span class="nc" id="L43">    var hour: Int? = null</span>
        private set
<span class="nc" id="L45">    var minute: Int? = null</span>
        private set

<span class="nc" id="L48">    private val _onDatePicked = MutableLiveData&lt;Event&lt;Unit&gt;&gt;()</span>
<span class="nc" id="L49">    val onDatePicked: LiveData&lt;Event&lt;Unit&gt;&gt; = _onDatePicked</span>
<span class="nc" id="L50">    private val _onPublishedDateChanged = MutableLiveData&lt;Event&lt;Calendar&gt;&gt;()</span>
<span class="nc" id="L51">    val onPublishedDateChanged: LiveData&lt;Event&lt;Calendar&gt;&gt; = _onPublishedDateChanged</span>
<span class="nc" id="L52">    private val _onPostStatusChanged = MutableLiveData&lt;PostStatus&gt;()</span>
<span class="nc" id="L53">    val onPostStatusChanged: LiveData&lt;PostStatus&gt; = _onPostStatusChanged</span>
<span class="nc" id="L54">    private val _onUiModel = MutableLiveData&lt;PublishUiModel&gt;()</span>
<span class="nc" id="L55">    val onUiModel: LiveData&lt;PublishUiModel&gt; = _onUiModel</span>
<span class="nc" id="L56">    private val _onToast = MutableLiveData&lt;Event&lt;String&gt;&gt;()</span>
<span class="nc" id="L57">    val onToast: LiveData&lt;Event&lt;String&gt;&gt; = _onToast</span>
<span class="nc" id="L58">    private val _onShowNotificationDialog = MutableLiveData&lt;Event&lt;Period?&gt;&gt;()</span>
<span class="nc" id="L59">    val onShowNotificationDialog: LiveData&lt;Event&lt;Period?&gt;&gt; = _onShowNotificationDialog</span>
<span class="nc" id="L60">    private val _onNotificationTime = MutableLiveData&lt;Period?&gt;()</span>
<span class="nc" id="L61">    val onNotificationTime: LiveData&lt;Period?&gt; = _onNotificationTime</span>
<span class="nc" id="L62">    private val _onNotificationAdded = MutableLiveData&lt;Event&lt;Notification&gt;&gt;()</span>
<span class="nc" id="L63">    val onNotificationAdded: LiveData&lt;Event&lt;Notification&gt;&gt; = _onNotificationAdded</span>
<span class="nc" id="L64">    private val _onAddToCalendar = MutableLiveData&lt;Event&lt;CalendarEvent&gt;&gt;()</span>
<span class="nc" id="L65">    val onAddToCalendar: LiveData&lt;Event&lt;CalendarEvent&gt;&gt; = _onAddToCalendar</span>

    open fun start(postRepository: EditPostRepository?) {
<span class="nc bnc" id="L68" title="All 4 branches missed.">        val startCalendar = postRepository?.let { getCurrentPublishDateAsCalendar(it) }</span>
<span class="nc" id="L69">                ?: localeManagerWrapper.getCurrentCalendar()</span>
<span class="nc" id="L70">        updateDateAndTimeFromCalendar(startCalendar)</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">        onPostStatusChanged(postRepository?.getPost())</span>
<span class="nc" id="L72">    }</span>

    fun onPostStatusChanged(postModel: PostImmutableModel?) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        canPublishImmediately = postModel?.let {</span>
<span class="nc" id="L76">            PostUtils.shouldPublishImmediatelyOptionBeAvailable(</span>
<span class="nc" id="L77">                    it.status</span>
            )
<span class="nc" id="L79">        } ?: false</span>
<span class="nc" id="L80">        updateUiModel(postModel = postModel)</span>
<span class="nc" id="L81">    }</span>

    fun publishNow() {
<span class="nc" id="L84">        val currentCalendar = localeManagerWrapper.getCurrentCalendar()</span>
<span class="nc" id="L85">        updateDateAndTimeFromCalendar(currentCalendar)</span>
<span class="nc" id="L86">        _onPublishedDateChanged.postValue(Event(currentCalendar))</span>
<span class="nc" id="L87">    }</span>

    fun onTimeSelected(selectedHour: Int, selectedMinute: Int) {
<span class="nc" id="L90">        this.hour = selectedHour</span>
<span class="nc" id="L91">        this.minute = selectedMinute</span>
<span class="nc" id="L92">        val calendar = localeManagerWrapper.getCurrentCalendar()</span>
<span class="nc" id="L93">        calendar.set(year!!, month!!, day!!, hour!!, minute!!)</span>
<span class="nc" id="L94">        _onPublishedDateChanged.postValue(Event(calendar))</span>
<span class="nc" id="L95">    }</span>

    fun onDateSelected(year: Int, month: Int, dayOfMonth: Int) {
<span class="nc" id="L98">        this.year = year</span>
<span class="nc" id="L99">        this.month = month</span>
<span class="nc" id="L100">        this.day = dayOfMonth</span>
<span class="nc" id="L101">        _onDatePicked.postValue(Event(Unit))</span>
<span class="nc" id="L102">    }</span>

    fun onShowDialog(postModel: PostImmutableModel) {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (areNotificationsEnabled(postModel)) {</span>
<span class="nc" id="L106">            val currentPeriod = postSchedulingNotificationStore.getSchedulingReminderPeriod(postModel.id)</span>
<span class="nc" id="L107">            _onShowNotificationDialog.postValue(Event(currentPeriod))</span>
        } else {
<span class="nc" id="L109">            _onToast.postValue(Event(resourceProvider.getString(R.string.post_notification_error)))</span>
        }
<span class="nc" id="L111">    }</span>

    fun updatePost(updatedDate: Calendar, postRepository: EditPostRepository?) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        postRepository?.updateAsync({ postModel -&gt;</span>
<span class="nc" id="L115">            val dateCreated = DateTimeUtils.iso8601FromDate(updatedDate.time)</span>
<span class="nc" id="L116">            postModel.setDateCreated(dateCreated)</span>
<span class="nc" id="L117">            val initialPostStatus = postRepository.status</span>
<span class="nc" id="L118">            val isPublishDateInTheFuture = PostUtils.isPublishDateInTheFuture(dateCreated)</span>
<span class="nc" id="L119">            var finalPostStatus = initialPostStatus</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">            if (initialPostStatus == DRAFT &amp;&amp; isPublishDateInTheFuture) {</span>
                // The previous logic was setting the status twice, once from draft to published and when the user
                // picked the time, it set it from published to scheduled. This is now done in one step.
<span class="nc" id="L123">                finalPostStatus = SCHEDULED</span>
<span class="nc bnc" id="L124" title="All 4 branches missed.">            } else if (initialPostStatus == PUBLISHED &amp;&amp; postRepository.isLocalDraft) {</span>
                // if user was changing dates for a local draft (not saved yet), only way to have it set to PUBLISH
                // is by running into the if case above. So, if they're updating the date again by calling
                // `updatePublishDate()`, get it back to DRAFT.
<span class="nc" id="L128">                finalPostStatus = DRAFT</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">            } else if (initialPostStatus == SCHEDULED &amp;&amp; !isPublishDateInTheFuture) {</span>
                // if this is a SCHEDULED post and the user is trying to Back-date it now, let's update it to DRAFT.
                // The other option was to make it published immediately but, let the user actively do that rather than
                // having the app be smart about it - we don't want to accidentally publish a post.
<span class="nc" id="L133">                finalPostStatus = DRAFT</span>
                // show toast only once, when time is shown
<span class="nc" id="L135">                _onToast.postValue(Event(resourceProvider.getString(R.string.editor_post_converted_back_to_draft)))</span>
            }
<span class="nc" id="L137">            postModel.setStatus(finalPostStatus.toString())</span>
<span class="nc" id="L138">            _onPostStatusChanged.postValue(finalPostStatus)</span>
<span class="nc" id="L139">            val scheduledTime = postSchedulingNotificationStore.getSchedulingReminderPeriod(postRepository.id)</span>
<span class="nc" id="L140">            updateNotifications(postRepository, scheduledTime)</span>
<span class="nc" id="L141">            true</span>
        }, onCompleted = { postModel, result -&gt;
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (result == UpdatePostResult.Updated) {</span>
<span class="nc" id="L144">                updateUiModel(postModel = postModel)</span>
            }
<span class="nc" id="L146">        })</span>
<span class="nc" id="L147">    }</span>

    fun updateUiModel(postModel: PostImmutableModel?) {
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (postModel != null) {</span>
<span class="nc" id="L151">            val notificationTime = postSchedulingNotificationStore.getSchedulingReminderPeriod(postModel.id)</span>
<span class="nc" id="L152">            val publishDateLabel = postSettingsUtils.getPublishDateLabel(postModel)</span>
<span class="nc" id="L153">            val now = localeManagerWrapper.getCurrentCalendar().timeInMillis - 10000</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            val dateCreated = (DateTimeUtils.dateFromIso8601(postModel.dateCreated)</span>
<span class="nc" id="L155">                    ?: localeManagerWrapper.getCurrentCalendar().time).time</span>
<span class="nc" id="L156">            val enableNotification = areNotificationsEnabled(postModel)</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            val showNotification = dateCreated &gt; now</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">            val notificationLabel = if (enableNotification &amp;&amp; showNotification) {</span>
<span class="nc" id="L159">                notificationTime.toLabel()</span>
            } else {
<span class="nc" id="L161">                R.string.post_notification_off</span>
            }
<span class="nc" id="L163">            _onUiModel.value = PublishUiModel(</span>
<span class="nc" id="L164">                    publishDateLabel,</span>
<span class="nc" id="L165">                    notificationLabel = notificationLabel,</span>
<span class="nc" id="L166">                    notificationEnabled = enableNotification,</span>
<span class="nc" id="L167">                    notificationVisible = showNotification</span>
            )
        } else {
<span class="nc" id="L170">            _onUiModel.value = PublishUiModel(resourceProvider.getString(R.string.immediately))</span>
        }
<span class="nc" id="L172">    }</span>

    fun onNotificationCreated(scheduleTime: Period?) {
<span class="nc" id="L175">        _onNotificationTime.value = scheduleTime</span>
<span class="nc" id="L176">    }</span>

    fun scheduleNotification(postRepository: EditPostRepository, notificationTime: Period) {
<span class="nc" id="L179">        updateNotifications(postRepository, notificationTime)</span>
<span class="nc" id="L180">        updateUiModel(postRepository.getPost())</span>
<span class="nc" id="L181">    }</span>

    fun onAddToCalendar(postRepository: EditPostRepository) {
<span class="nc" id="L184">        val startTime = DateTimeUtils.dateFromIso8601(postRepository.dateCreated).time</span>
<span class="nc" id="L185">        val site = siteStore.getSiteByLocalId(postRepository.localSiteId)</span>
<span class="nc" id="L186">        val title = resourceProvider.getString(</span>
<span class="nc" id="L187">                R.string.calendar_scheduled_post_title,</span>
<span class="nc" id="L188">                postRepository.title</span>
        )
<span class="nc" id="L190">        val description = resourceProvider.getString(</span>
<span class="nc" id="L191">                R.string.calendar_scheduled_post_description,</span>
<span class="nc" id="L192">                postRepository.title,</span>
<span class="nc bnc" id="L193" title="All 8 branches missed.">                site?.name ?: site?.url ?: &quot;&quot;,</span>
<span class="nc" id="L194">                postRepository.link</span>
        )
<span class="nc" id="L196">        _onAddToCalendar.value = Event(CalendarEvent(title, description, startTime))</span>
<span class="nc" id="L197">    }</span>

    private fun getCurrentPublishDateAsCalendar(postRepository: EditPostRepository): Calendar {
<span class="nc" id="L200">        val calendar = localeManagerWrapper.getCurrentCalendar()</span>
<span class="nc" id="L201">        val dateCreated = postRepository.dateCreated</span>
        // Set the currently selected time if available
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (!TextUtils.isEmpty(dateCreated)) {</span>
<span class="nc" id="L204">            calendar.time = DateTimeUtils.dateFromIso8601(dateCreated)</span>
<span class="nc" id="L205">            calendar.timeZone = localeManagerWrapper.getTimeZone()</span>
        }
<span class="nc" id="L207">        return calendar</span>
    }

<span class="nc" id="L210">    private fun updateNotifications(</span>
        postRepository: EditPostRepository,
<span class="nc" id="L212">        schedulingReminderPeriod: Period = OFF</span>
    ) {
<span class="nc" id="L214">        postSchedulingNotificationStore.deleteSchedulingReminders(postRepository.id)</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (schedulingReminderPeriod != OFF) {</span>
<span class="nc" id="L216">            val notificationId = postSchedulingNotificationStore.schedule(postRepository.id, schedulingReminderPeriod)</span>
<span class="nc" id="L217">            val scheduledCalendar = localeManagerWrapper.getCurrentCalendar().apply {</span>
<span class="nc" id="L218">                timeInMillis = System.currentTimeMillis()</span>
<span class="nc" id="L219">                time = DateTimeUtils.dateFromIso8601(postRepository.dateCreated)</span>
<span class="nc bnc" id="L220" title="All 4 branches missed.">                val scheduledMinutes = when (schedulingReminderPeriod) {</span>
<span class="nc" id="L221">                    ONE_HOUR -&gt; -60</span>
<span class="nc" id="L222">                    TEN_MINUTES -&gt; -10</span>
<span class="nc" id="L223">                    WHEN_PUBLISHED -&gt; 0</span>
<span class="nc" id="L224">                    OFF -&gt; return</span>
                }
<span class="nc" id="L226">                add(Calendar.MINUTE, scheduledMinutes)</span>
<span class="nc" id="L227">            }</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (scheduledCalendar.after(localeManagerWrapper.getCurrentCalendar())) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                notificationId?.let {</span>
<span class="nc" id="L230">                    _onNotificationAdded.postValue(Event(Notification(notificationId, scheduledCalendar.timeInMillis)))</span>
<span class="nc" id="L231">                }</span>
            }
        }
<span class="nc" id="L234">    }</span>

    private fun areNotificationsEnabled(postModel: PostImmutableModel): Boolean {
<span class="nc" id="L237">        val futureTime = localeManagerWrapper.getCurrentCalendar().timeInMillis + 6000</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        val dateCreated = (DateTimeUtils.dateFromIso8601(postModel.dateCreated)</span>
<span class="nc" id="L239">                ?: localeManagerWrapper.getCurrentCalendar().time).time</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        return dateCreated &gt; futureTime</span>
    }

    private fun Period.toLabel(): Int {
<span class="nc bnc" id="L244" title="All 4 branches missed.">        return when (this) {</span>
<span class="nc" id="L245">            OFF -&gt; R.string.post_notification_off</span>
<span class="nc" id="L246">            ONE_HOUR -&gt; R.string.post_notification_one_hour_before</span>
<span class="nc" id="L247">            TEN_MINUTES -&gt; R.string.post_notification_ten_minutes_before</span>
<span class="nc" id="L248">            WHEN_PUBLISHED -&gt; R.string.post_notification_when_published</span>
        }
    }

    private fun updateDateAndTimeFromCalendar(startCalendar: Calendar) {
<span class="nc" id="L253">        year = startCalendar.get(Calendar.YEAR)</span>
<span class="nc" id="L254">        month = startCalendar.get(Calendar.MONTH)</span>
<span class="nc" id="L255">        day = startCalendar.get(Calendar.DAY_OF_MONTH)</span>
<span class="nc" id="L256">        hour = startCalendar.get(Calendar.HOUR_OF_DAY)</span>
<span class="nc" id="L257">        minute = startCalendar.get(Calendar.MINUTE)</span>
<span class="nc" id="L258">    }</span>

<span class="nc" id="L260">    data class PublishUiModel(</span>
<span class="nc" id="L261">        val publishDateLabel: String,</span>
<span class="nc" id="L262">        val notificationLabel: Int = R.string.post_notification_off,</span>
<span class="nc" id="L263">        val notificationEnabled: Boolean = false,</span>
<span class="nc" id="L264">        val notificationVisible: Boolean = true</span>
<span class="nc" id="L265">    )</span>

<span class="nc" id="L267">    data class Notification(val id: Int, val scheduledTime: Long)</span>

<span class="nc" id="L269">    data class CalendarEvent(val title: String, val description: String, val startTime: Long)</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>