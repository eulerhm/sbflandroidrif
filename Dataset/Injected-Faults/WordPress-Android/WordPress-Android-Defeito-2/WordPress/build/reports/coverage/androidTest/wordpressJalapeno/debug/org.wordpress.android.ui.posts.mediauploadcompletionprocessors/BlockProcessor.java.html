<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BlockProcessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts.mediauploadcompletionprocessors</a> &gt; <span class="el_source">BlockProcessor.java</span></div><h1>BlockProcessor.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts.mediauploadcompletionprocessors;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Document.OutputSettings;
import org.wordpress.android.editor.Utils;
import org.wordpress.android.util.helpers.MediaFile;

import java.util.regex.Matcher;

import static org.wordpress.android.ui.posts.mediauploadcompletionprocessors.MediaUploadCompletionProcessorPatterns.PATTERN_BLOCK_CAPTURES;

/**
 * Abstract class to be extended for each enumerated {@link MediaBlockType}.
 */
public abstract class BlockProcessor {
    /**
     * HTML output used by the parser
     */
<span class="nc" id="L23">    @SuppressWarnings(&quot;checkstyle:LineLength&quot;) static final OutputSettings OUTPUT_SETTINGS = new OutputSettings()</span>
<span class="nc" id="L24">            .outline(false)</span>
//          .syntax(Syntax.xml)
//            Do we want xml or html here (e.g. self closing tags, boolean attributes)?
//            https://stackoverflow.com/questions/26584974/keeping-html-boolean-attributes-in-their-original-form-when-parsing-with-jsoup
<span class="nc" id="L28">            .prettyPrint(false);</span>

    String mLocalId;
    String mRemoteId;
    String mRemoteUrl;

    private String mBlockName;
    private JsonObject mJsonAttributes;
    private Document mBlockContentDocument;
    private String mClosingComment;


    /**
     * @param localId The local media id that needs replacement
     * @param mediaFile The mediaFile containing the remote id and remote url
     */
<span class="nc" id="L44">    BlockProcessor(String localId, MediaFile mediaFile) {</span>
<span class="nc" id="L45">        mLocalId = localId;</span>
<span class="nc" id="L46">        mRemoteId = mediaFile.getMediaId();</span>
<span class="nc" id="L47">        mRemoteUrl = org.wordpress.android.util.StringUtils.notNullStr(Utils.escapeQuotes(mediaFile.getFileURL()));</span>
<span class="nc" id="L48">    }</span>

    private JsonObject parseJson(String blockJson) {
<span class="nc" id="L51">        JsonParser parser = new JsonParser();</span>
<span class="nc" id="L52">        return parser.parse(blockJson).getAsJsonObject();</span>
    }

    private Document parseHTML(String blockContent) {
        // create document from block content
<span class="nc" id="L57">        Document document = Jsoup.parse(blockContent);</span>
<span class="nc" id="L58">        document.outputSettings(OUTPUT_SETTINGS);</span>
<span class="nc" id="L59">        return document;</span>
    }

    private boolean splitBlock(String block) {
<span class="nc" id="L63">        Matcher captures = PATTERN_BLOCK_CAPTURES.matcher(block);</span>

<span class="nc" id="L65">        boolean capturesFound = captures.find();</span>

<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (capturesFound) {</span>
<span class="nc" id="L68">            mBlockName = captures.group(1);</span>
<span class="nc" id="L69">            mJsonAttributes = parseJson(captures.group(2));</span>
<span class="nc" id="L70">            mBlockContentDocument = parseHTML(captures.group(3));</span>
<span class="nc" id="L71">            mClosingComment = captures.group(4);</span>
<span class="nc" id="L72">            return true;</span>
        } else {
<span class="nc" id="L74">            mBlockName = null;</span>
<span class="nc" id="L75">            mJsonAttributes = null;</span>
<span class="nc" id="L76">            mBlockContentDocument = null;</span>
<span class="nc" id="L77">            mClosingComment = null;</span>
<span class="nc" id="L78">            return false;</span>
        }
    }

    /**
     * Processes a block returning a raw content replacement string. If a match is not found for the block content, this
     * method should return the original block contents unchanged.
     *
     * @param block The raw block contents
     * @return A string containing content with ids and urls replaced
     */
    String processBlock(String block) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (splitBlock(block)) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if (processBlockJsonAttributes(mJsonAttributes)) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                if (processBlockContentDocument(mBlockContentDocument)) {</span>
                    // return injected block
<span class="nc" id="L94">                    return new StringBuilder()</span>
<span class="nc" id="L95">                            .append(&quot;&lt;!-- wp:&quot;)</span>
<span class="nc" id="L96">                            .append(mBlockName)</span>
<span class="nc" id="L97">                            .append(&quot; &quot;)</span>
<span class="nc" id="L98">                            .append(mJsonAttributes) // json parser output</span>
<span class="nc" id="L99">                            .append(&quot; --&gt;\n&quot;)</span>
<span class="nc" id="L100">                            .append(mBlockContentDocument.body().html()) // HTML parser output</span>
<span class="nc" id="L101">                            .append(mClosingComment)</span>
<span class="nc" id="L102">                            .toString();</span>
                }
            } else {
<span class="nc" id="L105">                return processInnerBlock(block); // delegate to inner blocks if needed</span>
            }
        }
        // leave block unchanged
<span class="nc" id="L109">        return block;</span>
    }

    /**
     * All concrete implementations must implement this method for the particular block type. The document represents
     * the html contents of the block to be processed, and is to be mutated in place.&lt;br&gt;
     * &lt;br&gt;
     * This method should return true to indicate success. Returning false will result in the block contents being
     * unmodified.
     *
     * @param document The document to be mutated to make the necessary replacements
     * @return A boolean value indicating whether or not the block contents should be replaced
     */
    abstract boolean processBlockContentDocument(Document document);

    /**
     * All concrete implementations must implement this method for the particular block type. The jsonAttributes object
     * is a {@link JsonObject} parsed from the block header attributes. This object can be used to check for a match,
     * and can be directly mutated if necessary.&lt;br&gt;
     * &lt;br&gt;
     * This method should return true to indicate success. Returning false will result in the block contents being
     * unmodified.
     *
     * @param jsonAttributes the attributes object used to check for a match with the local id, and mutated if necessary
     * @return
     */
    abstract boolean processBlockJsonAttributes(JsonObject jsonAttributes);

    /**
     * This method can be optionally overriden by concrete implementations to delegate further processing via recursion
     * when {@link BlockProcessor#processBlockJsonAttributes(JsonObject)} returns false (i.e. the block did not match
     * the local id being replaced). This is useful for implementing mutual recursion with
     * {@link MediaUploadCompletionProcessor#processContent(String)} for block types that have media-containing blocks
     * within their inner content.&lt;br&gt;
     * &lt;br&gt;
     * The default implementation provided is a NOOP that leaves the content of the block unchanged.
     *
     * @param block The raw block contents
     * @return A string containing content with ids and urls replaced
     */
    String processInnerBlock(String block) {
<span class="nc" id="L150">        return block;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>