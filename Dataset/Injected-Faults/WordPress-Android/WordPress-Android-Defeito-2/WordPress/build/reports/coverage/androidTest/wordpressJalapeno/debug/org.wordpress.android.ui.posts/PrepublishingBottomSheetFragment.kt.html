<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrepublishingBottomSheetFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PrepublishingBottomSheetFragment.kt</span></div><h1>PrepublishingBottomSheetFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import android.content.Context
import android.content.DialogInterface
import android.os.Bundle
import android.view.KeyEvent
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.FrameLayout
import androidx.annotation.NonNull
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import com.google.android.material.bottomsheet.BottomSheetBehavior
import com.google.android.material.bottomsheet.BottomSheetDialog
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.databinding.PostPrepublishingBottomSheetBinding
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.ui.WPBottomSheetDialogFragment
import org.wordpress.android.ui.posts.PrepublishingHomeItemUiState.ActionType
import org.wordpress.android.ui.posts.PrepublishingScreen.ADD_CATEGORY
import org.wordpress.android.ui.posts.PrepublishingScreen.CATEGORIES
import org.wordpress.android.ui.posts.PrepublishingScreen.HOME
import org.wordpress.android.ui.posts.prepublishing.PrepublishingBottomSheetListener
import org.wordpress.android.ui.posts.prepublishing.PrepublishingPublishSettingsFragment
import org.wordpress.android.util.ActivityUtils
import org.wordpress.android.util.KeyboardResizeViewUtil
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

<span class="nc" id="L34">class PrepublishingBottomSheetFragment : WPBottomSheetDialogFragment(),</span>
        PrepublishingScreenClosedListener, PrepublishingActionClickedListener {
<span class="nc bnc" id="L36" title="All 2 branches missed.">    @Inject internal lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">    @Inject internal lateinit var analyticsTrackerWrapper: AnalyticsTrackerWrapper</span>
    private lateinit var viewModel: PrepublishingViewModel
    private lateinit var keyboardResizeViewUtil: KeyboardResizeViewUtil

    private var prepublishingBottomSheetListener: PrepublishingBottomSheetListener? = null

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L44">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L45" title="All 4 branches missed.">        (requireNotNull(activity).application as WordPress).component().inject(this)</span>
<span class="nc" id="L46">    }</span>

    override fun onAttach(context: Context) {
<span class="nc" id="L49">        super.onAttach(context)</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        prepublishingBottomSheetListener = if (context is PrepublishingBottomSheetListener) {</span>
<span class="nc" id="L51">            context</span>
        } else {
<span class="nc" id="L53">            throw RuntimeException(&quot;$context must implement PrepublishingBottomSheetListener&quot;)</span>
        }
<span class="nc" id="L55">    }</span>

    override fun onDetach() {
<span class="nc" id="L58">        super.onDetach()</span>
<span class="nc" id="L59">        prepublishingBottomSheetListener = null</span>
<span class="nc" id="L60">    }</span>

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
<span class="nc" id="L67">        val view = inflater.inflate(R.layout.post_prepublishing_bottom_sheet, container)</span>
<span class="nc" id="L68">        keyboardResizeViewUtil = KeyboardResizeViewUtil(requireActivity(), view)</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        keyboardResizeViewUtil.enable()</span>
<span class="nc" id="L70">        return view</span>
    }

    override fun onResume() {
<span class="nc" id="L74">        super.onResume()</span>
        /**
         * The back button normally closes the bottom sheet so now instead of doing that it goes back to
         * the home screen with the actions and only if pressed again will it close the bottom sheet.
         */
<span class="nc bnc" id="L79" title="All 2 branches missed.">        dialog?.setOnKeyListener { _, keyCode, event -&gt;</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (keyCode == KeyEvent.KEYCODE_BACK) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (event.action != KeyEvent.ACTION_DOWN) {</span>
<span class="nc" id="L82">                    true</span>
                } else {
<span class="nc bnc" id="L84" title="All 2 branches missed.">                    viewModel.onDeviceBackPressed()</span>
<span class="nc" id="L85">                    true</span>
                }
            } else {
<span class="nc" id="L88">                false</span>
            }
        }
<span class="nc" id="L91">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L94">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L95">        with(PostPrepublishingBottomSheetBinding.bind(view)) {</span>
<span class="nc" id="L96">            initViewModel(savedInstanceState)</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            dialog?.setOnShowListener { dialogInterface -&gt;</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                val sheetDialog = dialogInterface as? BottomSheetDialog</span>

<span class="nc bnc" id="L100" title="All 4 branches missed.">                val bottomSheet = sheetDialog?.findViewById&lt;View&gt;(</span>
<span class="nc" id="L101">                        com.google.android.material.R.id.design_bottom_sheet</span>
                ) as? FrameLayout

<span class="nc bnc" id="L104" title="All 2 branches missed.">                bottomSheet?.let {</span>
<span class="nc" id="L105">                    val behavior = BottomSheetBehavior.from(it)</span>
<span class="nc" id="L106">                    behavior.state = BottomSheetBehavior.STATE_EXPANDED</span>
<span class="nc" id="L107">                }</span>
<span class="nc" id="L108">            }</span>
<span class="nc" id="L109">            setupMinimumHeightForFragmentContainer()</span>
<span class="nc" id="L110">        }</span>
<span class="nc" id="L111">    }</span>

    override fun onDismiss(dialog: DialogInterface) {
<span class="nc" id="L114">        analyticsTrackerWrapper.track(Stat.PREPUBLISHING_BOTTOM_SHEET_DISMISSED)</span>
<span class="nc" id="L115">        super.onDismiss(dialog)</span>
<span class="nc" id="L116">    }</span>

    private fun PostPrepublishingBottomSheetBinding.setupMinimumHeightForFragmentContainer() {
<span class="nc bnc" id="L119" title="All 4 branches missed.">        val isPage = checkNotNull(arguments?.getBoolean(IS_PAGE)) {</span>
<span class="nc" id="L120">            &quot;arguments can't be null.&quot;</span>
        }

<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (isPage) {</span>
<span class="nc" id="L124">            prepublishingContentFragment.minimumHeight =</span>
<span class="nc" id="L125">                    resources.getDimensionPixelSize(R.dimen.prepublishing_fragment_container_min_height_for_page)</span>
        } else {
<span class="nc" id="L127">            prepublishingContentFragment.minimumHeight =</span>
<span class="nc" id="L128">                    resources.getDimensionPixelSize(R.dimen.prepublishing_fragment_container_min_height)</span>
        }
<span class="nc" id="L130">    }</span>

    private fun initViewModel(savedInstanceState: Bundle?) {
<span class="nc" id="L133">        viewModel = ViewModelProvider(this, viewModelFactory)</span>
<span class="nc" id="L134">                .get(PrepublishingViewModel::class.java)</span>

<span class="nc bnc" id="L136" title="All 2 branches missed.">        viewModel.navigationTarget.observeEvent(this, { navigationState -&gt;</span>
<span class="nc" id="L137">            navigateToScreen(navigationState)</span>
<span class="nc" id="L138">        })</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">        viewModel.dismissBottomSheet.observeEvent(this, {</span>
<span class="nc" id="L141">            dismiss()</span>
<span class="nc" id="L142">        })</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">        viewModel.triggerOnSubmitButtonClickedListener.observeEvent(this, { publishPost -&gt;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            prepublishingBottomSheetListener?.onSubmitButtonClicked(publishPost)</span>
<span class="nc" id="L146">        })</span>

<span class="nc bnc" id="L148" title="All 2 branches missed.">        viewModel.dismissKeyboard.observeEvent(this, {</span>
<span class="nc" id="L149">            ActivityUtils.hideKeyboardForced(view)</span>
<span class="nc" id="L150">        })</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">        val prepublishingScreenState = savedInstanceState?.getParcelable&lt;PrepublishingScreen&gt;(</span>
<span class="nc" id="L153">                KEY_SCREEN_STATE</span>
        )
<span class="nc bnc" id="L155" title="All 4 branches missed.">        val site = arguments?.getSerializable(SITE) as SiteModel</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">        viewModel.start(site, prepublishingScreenState)</span>
<span class="nc" id="L158">    }</span>

    private fun navigateToScreen(navigationTarget: PrepublishingNavigationTarget) {
<span class="nc bnc" id="L161" title="All 5 branches missed.">        val (fragment, tag) = when (navigationTarget.targetScreen) {</span>
            HOME -&gt; {
<span class="nc bnc" id="L163" title="All 4 branches missed.">                val isStoryPost = checkNotNull(arguments?.getBoolean(IS_STORY_POST)) {</span>
<span class="nc" id="L164">                    &quot;arguments can't be null.&quot;</span>
                }
<span class="nc" id="L166">                Pair(</span>
<span class="nc" id="L167">                        PrepublishingHomeFragment.newInstance(isStoryPost),</span>
<span class="nc" id="L168">                        PrepublishingHomeFragment.TAG</span>
                )
            }
<span class="nc" id="L171">            PrepublishingScreen.PUBLISH -&gt; Pair(</span>
<span class="nc" id="L172">                    PrepublishingPublishSettingsFragment.newInstance(),</span>
<span class="nc" id="L173">                    PrepublishingPublishSettingsFragment.TAG</span>
            )
            PrepublishingScreen.TAGS -&gt; {
<span class="nc bnc" id="L176" title="All 4 branches missed.">                val isStoryPost = checkNotNull(arguments?.getBoolean(IS_STORY_POST)) {</span>
<span class="nc" id="L177">                    &quot;arguments can't be null.&quot;</span>
                }
<span class="nc" id="L179">                Pair(</span>
<span class="nc" id="L180">                        PrepublishingTagsFragment.newInstance(navigationTarget.site, isStoryPost),</span>
<span class="nc" id="L181">                        PrepublishingTagsFragment.TAG</span>
                )
            }
            CATEGORIES -&gt; {
<span class="nc bnc" id="L185" title="All 4 branches missed.">                val isStoryPost = checkNotNull(arguments?.getBoolean(IS_STORY_POST)) {</span>
<span class="nc" id="L186">                    &quot;arguments can't be null.&quot;</span>
                }
<span class="nc" id="L188">                Pair(</span>
<span class="nc" id="L189">                        PrepublishingCategoriesFragment.newInstance(</span>
<span class="nc" id="L190">                                navigationTarget.site,</span>
<span class="nc" id="L191">                                isStoryPost,</span>
<span class="nc" id="L192">                                navigationTarget.bundle</span>
                        ),
<span class="nc" id="L194">                        PrepublishingCategoriesFragment.TAG</span>
                )
            }
            ADD_CATEGORY -&gt; {
<span class="nc bnc" id="L198" title="All 4 branches missed.">                val isStoryPost = checkNotNull(arguments?.getBoolean(IS_STORY_POST)) {</span>
<span class="nc" id="L199">                    &quot;arguments can't be null.&quot;</span>
                }
<span class="nc" id="L201">                Pair(</span>
<span class="nc" id="L202">                        PrepublishingAddCategoryFragment.newInstance(</span>
<span class="nc" id="L203">                                navigationTarget.site,</span>
<span class="nc" id="L204">                                isStoryPost,</span>
<span class="nc" id="L205">                                navigationTarget.bundle</span>
                        ),
<span class="nc" id="L207">                        PrepublishingAddCategoryFragment.TAG</span>
                )
            }
        }

<span class="nc" id="L212">        fadeInFragment(fragment, tag)</span>
<span class="nc" id="L213">    }</span>

    private fun fadeInFragment(fragment: Fragment, tag: String) {
<span class="nc" id="L216">        childFragmentManager.let { fragmentManager -&gt;</span>
<span class="nc" id="L217">            val fragmentTransaction = fragmentManager.beginTransaction()</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            fragmentManager.findFragmentById(R.id.prepublishing_content_fragment)?.run {</span>
<span class="nc" id="L219">                fragmentTransaction.addToBackStack(null).setCustomAnimations(</span>
<span class="nc" id="L220">                        R.anim.prepublishing_fragment_fade_in,</span>
<span class="nc" id="L221">                        R.anim.prepublishing_fragment_fade_out,</span>
<span class="nc" id="L222">                        R.anim.prepublishing_fragment_fade_in,</span>
<span class="nc" id="L223">                        R.anim.prepublishing_fragment_fade_out</span>
                )
            }
<span class="nc" id="L226">            fragmentTransaction.replace(R.id.prepublishing_content_fragment, fragment, tag)</span>
<span class="nc" id="L227">            fragmentTransaction.commit()</span>
        }
<span class="nc" id="L229">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L232">        super.onSaveInstanceState(outState)</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        viewModel.writeToBundle(outState)</span>
<span class="nc" id="L234">    }</span>

    override fun onBackClicked(bundle: Bundle?) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        viewModel.onBackClicked(bundle)</span>
<span class="nc" id="L238">    }</span>

    override fun onActionClicked(actionType: ActionType, bundle: Bundle?) {
<span class="nc bnc" id="L241" title="All 2 branches missed.">        viewModel.onActionClicked(actionType, bundle)</span>
<span class="nc" id="L242">    }</span>

    override fun onSubmitButtonClicked(publishPost: PublishPost) {
<span class="nc bnc" id="L245" title="All 2 branches missed.">        viewModel.onSubmitButtonClicked(publishPost)</span>
<span class="nc" id="L246">    }</span>

    companion object {
        const val TAG = &quot;prepublishing_bottom_sheet_fragment_tag&quot;
        const val SITE = &quot;prepublishing_bottom_sheet_site_model&quot;
        const val IS_PAGE = &quot;prepublishing_bottom_sheet_is_page&quot;
        const val IS_STORY_POST = &quot;prepublishing_bottom_sheet_is_story_post&quot;

        @JvmStatic
        fun newInstance(@NonNull site: SiteModel, isPage: Boolean, isStoryPost: Boolean) =
<span class="nc" id="L256">                PrepublishingBottomSheetFragment().apply {</span>
<span class="nc" id="L257">                    arguments = Bundle().apply {</span>
<span class="nc" id="L258">                        putSerializable(SITE, site)</span>
<span class="nc" id="L259">                        putBoolean(IS_PAGE, isPage)</span>
<span class="nc" id="L260">                        putBoolean(IS_STORY_POST, isStoryPost)</span>
<span class="nc" id="L261">                    }</span>
<span class="nc" id="L262">                }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>