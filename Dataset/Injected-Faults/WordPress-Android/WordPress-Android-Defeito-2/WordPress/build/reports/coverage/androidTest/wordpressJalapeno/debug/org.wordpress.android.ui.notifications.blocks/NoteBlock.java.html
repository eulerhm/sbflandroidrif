<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NoteBlock.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.notifications.blocks</a> &gt; <span class="el_source">NoteBlock.java</span></div><h1>NoteBlock.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.notifications.blocks;

import android.graphics.drawable.Drawable;
import android.media.MediaPlayer;
import android.net.Uri;
import android.text.Spannable;
import android.text.TextUtils;
import android.text.style.TypefaceSpan;
import android.view.Gravity;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.Animation;
import android.view.animation.AnimationUtils;
import android.widget.Button;
import android.widget.FrameLayout;
import android.widget.ImageView;
import android.widget.ImageView.ScaleType;
import android.widget.LinearLayout;
import android.widget.MediaController;
import android.widget.VideoView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;

import org.wordpress.android.R;
import org.wordpress.android.fluxc.tools.FormattableContent;
import org.wordpress.android.fluxc.tools.FormattableMedia;
import org.wordpress.android.fluxc.tools.FormattableRange;
import org.wordpress.android.ui.notifications.utils.NotificationsUtilsWrapper;
import org.wordpress.android.util.AccessibilityUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.DisplayUtils;
import org.wordpress.android.util.FormattableContentUtilsKt;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageType;
import org.wordpress.android.widgets.WPTextView;

/**
 * A block of data displayed in a notification.
 * This basic block can support a media item (image/video) and/or text.
 */
public class NoteBlock {
    private final FormattableContent mNoteData;
    private final OnNoteBlockTextClickListener mOnNoteBlockTextClickListener;
    protected final ImageManager mImageManager;
    protected final NotificationsUtilsWrapper mNotificationsUtilsWrapper;
    private boolean mIsBadge;
    private boolean mIsPingback;
    private boolean mHasAnimatedBadge;
    private boolean mIsViewMilestone;

    public interface OnNoteBlockTextClickListener {
        void onNoteBlockTextClicked(NoteBlockClickableSpan clickedSpan);

        void showDetailForNoteIds();

        void showReaderPostComments();

        void showSitePreview(long siteId, String siteUrl);
    }

    public NoteBlock(FormattableContent noteObject, ImageManager imageManager,
                     NotificationsUtilsWrapper notificationsUtilsWrapper,
<span class="nc" id="L66">                     OnNoteBlockTextClickListener onNoteBlockTextClickListener) {</span>
<span class="nc" id="L67">        mNoteData = noteObject;</span>
<span class="nc" id="L68">        mOnNoteBlockTextClickListener = onNoteBlockTextClickListener;</span>
<span class="nc" id="L69">        mImageManager = imageManager;</span>
<span class="nc" id="L70">        mNotificationsUtilsWrapper = notificationsUtilsWrapper;</span>
<span class="nc" id="L71">    }</span>

    OnNoteBlockTextClickListener getOnNoteBlockTextClickListener() {
<span class="nc" id="L74">        return mOnNoteBlockTextClickListener;</span>
    }

    public BlockType getBlockType() {
<span class="nc" id="L78">        return BlockType.BASIC;</span>
    }

    FormattableContent getNoteData() {
<span class="nc" id="L82">        return mNoteData;</span>
    }

    Spannable getNoteText() {
<span class="nc" id="L86">        return mNotificationsUtilsWrapper.getSpannableContentForRanges(mNoteData, null,</span>
                mOnNoteBlockTextClickListener, false);
    }

    String getMetaHomeTitle() {
<span class="nc" id="L91">        return FormattableContentUtilsKt.getMetaTitlesHomeOrEmpty(mNoteData);</span>
    }

    long getMetaSiteId() {
<span class="nc" id="L95">        return FormattableContentUtilsKt.getMetaIdsSiteIdOrZero(mNoteData);</span>
    }

    public String getMetaSiteUrl() {
<span class="nc" id="L99">        return FormattableContentUtilsKt.getMetaLinksHomeOrEmpty(mNoteData);</span>
    }

    private boolean isPingBack() {
<span class="nc" id="L103">        return mIsPingback;</span>
    }

    public void setIsPingback() {
<span class="nc" id="L107">        mIsPingback = true;</span>
<span class="nc" id="L108">    }</span>

    FormattableMedia getNoteMediaItem() {
<span class="nc" id="L111">        return FormattableContentUtilsKt.getMediaOrNull(mNoteData, 0);</span>
    }

    public void setIsBadge() {
<span class="nc" id="L115">        mIsBadge = true;</span>
<span class="nc" id="L116">    }</span>

    public void setIsViewMilestone() {
<span class="nc" id="L119">        mIsViewMilestone = true;</span>
<span class="nc" id="L120">    }</span>

    public int getLayoutResourceId() {
<span class="nc" id="L123">        return R.layout.note_block_basic;</span>
    }

    private boolean hasMediaArray() {
<span class="nc bnc" id="L127" title="All 4 branches missed.">        return mNoteData.getMedia() != null &amp;&amp; !mNoteData.getMedia().isEmpty();</span>
    }

    boolean hasImageMediaItem() {
<span class="nc bnc" id="L131" title="All 2 branches missed.">        return hasMediaArray()</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">               &amp;&amp; getNoteMediaItem() != null</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">               &amp;&amp; !TextUtils.isEmpty(getNoteMediaItem().getType())</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">               &amp;&amp; (getNoteMediaItem().getType().startsWith(&quot;image&quot;) || getNoteMediaItem().getType().equals(&quot;badge&quot;))</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">               &amp;&amp; !TextUtils.isEmpty(getNoteMediaItem().getUrl());</span>
    }

    private boolean hasVideoMediaItem() {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        return hasMediaArray()</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">               &amp;&amp; getNoteMediaItem() != null</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">               &amp;&amp; !TextUtils.isEmpty(getNoteMediaItem().getType())</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">               &amp;&amp; getNoteMediaItem().getType().startsWith(&quot;video&quot;)</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">               &amp;&amp; !TextUtils.isEmpty(getNoteMediaItem().getUrl());</span>
    }

    public boolean containsBadgeMediaType() {
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (mNoteData.getMedia() != null) {</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            for (FormattableMedia mediaObject : mNoteData.getMedia()) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                if (&quot;badge&quot;.equals(mediaObject.getType())) {</span>
<span class="nc" id="L150">                    return true;</span>
                }
<span class="nc" id="L152">            }</span>
        }
<span class="nc" id="L154">        return false;</span>
    }

    public View configureView(final View view) {
<span class="nc" id="L158">        final BasicNoteBlockHolder noteBlockHolder = (BasicNoteBlockHolder) view.getTag();</span>

        // Note image
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (hasImageMediaItem()) {</span>
<span class="nc" id="L162">            noteBlockHolder.getImageView().setVisibility(View.VISIBLE);</span>
            // Request image, and animate it when loaded
<span class="nc" id="L164">            mImageManager</span>
<span class="nc" id="L165">                    .loadWithResultListener(noteBlockHolder.getImageView(), ImageType.IMAGE,</span>
<span class="nc" id="L166">                            StringUtils.notNullStr(getNoteMediaItem().getUrl()), ScaleType.CENTER, null,</span>
<span class="nc" id="L167">                            new ImageManager.RequestListener&lt;Drawable&gt;() {</span>
                                @Override
                                public void onLoadFailed(@Nullable Exception e, @Nullable Object model) {
<span class="nc bnc" id="L170" title="All 2 branches missed.">                                    if (e != null) {</span>
<span class="nc" id="L171">                                        AppLog.e(T.NOTIFS, e);</span>
                                    }
<span class="nc" id="L173">                                    noteBlockHolder.hideImageView();</span>
<span class="nc" id="L174">                                }</span>

                                @Override
                                public void onResourceReady(@NonNull Drawable resource, @Nullable Object model) {
<span class="nc bnc" id="L178" title="All 4 branches missed.">                                    if (!mHasAnimatedBadge &amp;&amp; view.getContext() != null) {</span>
<span class="nc" id="L179">                                        mHasAnimatedBadge = true;</span>
<span class="nc" id="L180">                                        Animation pop = AnimationUtils.loadAnimation(view.getContext(), R.anim.pop);</span>
<span class="nc" id="L181">                                        noteBlockHolder.getImageView().startAnimation(pop);</span>
                                    }
<span class="nc" id="L183">                                }</span>
                            });

<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (mIsBadge) {</span>
<span class="nc" id="L187">                noteBlockHolder.getImageView().setImportantForAccessibility(View.IMPORTANT_FOR_ACCESSIBILITY_NO);</span>
            }
        } else {
<span class="nc" id="L190">            mImageManager.cancelRequestAndClearImageView(noteBlockHolder.getImageView());</span>
<span class="nc" id="L191">            noteBlockHolder.hideImageView();</span>
        }

        // Note video
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (hasVideoMediaItem()) {</span>
<span class="nc" id="L196">            noteBlockHolder.getVideoView().setVideoURI(Uri.parse(StringUtils.notNullStr(getNoteMediaItem().getUrl())));</span>
<span class="nc" id="L197">            noteBlockHolder.getVideoView().setVisibility(View.VISIBLE);</span>
        } else {
<span class="nc" id="L199">            noteBlockHolder.hideVideoView();</span>
        }

        // Note text
<span class="nc" id="L203">        Spannable noteText = getNoteText();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (!TextUtils.isEmpty(noteText)) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">            if (isPingBack()) {</span>
<span class="nc" id="L206">                noteBlockHolder.getTextView().setVisibility(View.GONE);</span>
<span class="nc" id="L207">                noteBlockHolder.getMaterialButton().setVisibility(View.GONE);</span>
<span class="nc" id="L208">                noteBlockHolder.getDivider().setVisibility(View.VISIBLE);</span>
<span class="nc" id="L209">                noteBlockHolder.getButton().setVisibility(View.VISIBLE);</span>
<span class="nc" id="L210">                noteBlockHolder.getButton().setText(noteText.toString());</span>
<span class="nc" id="L211">                noteBlockHolder.getButton().setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                    if (getOnNoteBlockTextClickListener() != null) {</span>
<span class="nc" id="L213">                        getOnNoteBlockTextClickListener().showSitePreview(0, getMetaSiteUrl());</span>
                    }
<span class="nc" id="L215">                });</span>
            } else {
<span class="nc" id="L217">                int textViewVisibility = View.VISIBLE;</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                if (mIsBadge) {</span>
<span class="nc" id="L219">                    LinearLayout.LayoutParams params =</span>
                            new LinearLayout.LayoutParams(LinearLayout.LayoutParams.WRAP_CONTENT,
                                    LinearLayout.LayoutParams.MATCH_PARENT);
<span class="nc" id="L222">                    params.gravity = Gravity.CENTER_HORIZONTAL;</span>
<span class="nc" id="L223">                    noteBlockHolder.getTextView().setLayoutParams(params);</span>
<span class="nc" id="L224">                    noteBlockHolder.getTextView().setGravity(Gravity.CENTER_HORIZONTAL);</span>
                    int padding;
<span class="nc bnc" id="L226" title="All 2 branches missed.">                    if (mIsViewMilestone) {</span>
<span class="nc" id="L227">                        padding = 40;</span>
                    } else {
<span class="nc" id="L229">                        padding = 8;</span>
                    }
<span class="nc" id="L231">                    noteBlockHolder.getTextView().setPadding(0, DisplayUtils.dpToPx(view.getContext(), padding), 0, 0);</span>

<span class="nc bnc" id="L233" title="All 2 branches missed.">                    if (AccessibilityUtils.isAccessibilityEnabled(noteBlockHolder.getTextView().getContext())) {</span>
<span class="nc" id="L234">                        noteBlockHolder.getTextView().setClickable(false);</span>
<span class="nc" id="L235">                        noteBlockHolder.getTextView().setLongClickable(false);</span>
                    }
<span class="nc bnc" id="L237" title="All 2 branches missed.">                    if (mIsViewMilestone) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                        if (FormattableContentUtilsKt.isMobileButton(mNoteData)) {</span>
<span class="nc" id="L239">                            textViewVisibility = View.GONE;</span>
<span class="nc" id="L240">                            noteBlockHolder.getButton().setVisibility(View.GONE);</span>
<span class="nc" id="L241">                            noteBlockHolder.getMaterialButton().setVisibility(View.VISIBLE);</span>
<span class="nc" id="L242">                            noteBlockHolder.getMaterialButton().setText(noteText.toString());</span>
<span class="nc" id="L243">                            noteBlockHolder.getMaterialButton().setOnClickListener(v -&gt; {</span>
<span class="nc" id="L244">                                FormattableRange buttonRange =</span>
<span class="nc" id="L245">                                        FormattableContentUtilsKt.getMobileButtonRange(mNoteData);</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">                                if (getOnNoteBlockTextClickListener() != null &amp;&amp; buttonRange != null) {</span>
<span class="nc" id="L247">                                    NoteBlockClickableSpan clickableSpan =</span>
                                            new NoteBlockClickableSpan(buttonRange, true, false);
<span class="nc" id="L249">                                    getOnNoteBlockTextClickListener().onNoteBlockTextClicked(clickableSpan);</span>
                                }
<span class="nc" id="L251">                            });</span>
                        } else {
<span class="nc" id="L253">                            noteBlockHolder.getTextView().setTextSize(28);</span>
<span class="nc" id="L254">                            TypefaceSpan typefaceSpan = new TypefaceSpan(&quot;serif&quot;);</span>
<span class="nc" id="L255">                            noteText.setSpan(typefaceSpan, 0, noteText.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span>
                        }
                    }
<span class="nc" id="L258">                } else {</span>
<span class="nc" id="L259">                    noteBlockHolder.getTextView().setGravity(Gravity.NO_GRAVITY);</span>
<span class="nc" id="L260">                    noteBlockHolder.getTextView().setPadding(0, 0, 0, 0);</span>
                }

<span class="nc" id="L263">                NoteBlockClickableSpan[] spans = noteText.getSpans(0, noteText.length(), NoteBlockClickableSpan.class);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                for (NoteBlockClickableSpan span : spans) {</span>
<span class="nc" id="L265">                    span.enableColors(view.getContext());</span>
                }
<span class="nc" id="L267">                noteBlockHolder.getTextView().setText(noteText);</span>
<span class="nc" id="L268">                noteBlockHolder.getTextView().setVisibility(textViewVisibility);</span>
<span class="nc" id="L269">            }</span>
        } else {
<span class="nc" id="L271">            noteBlockHolder.getButton().setVisibility(View.GONE);</span>
<span class="nc" id="L272">            noteBlockHolder.getDivider().setVisibility(View.GONE);</span>
<span class="nc" id="L273">            noteBlockHolder.getMaterialButton().setVisibility(View.GONE);</span>
<span class="nc" id="L274">            noteBlockHolder.getTextView().setVisibility(View.GONE);</span>
        }

<span class="nc" id="L277">        return view;</span>
    }

    public Object getViewHolder(View view) {
<span class="nc" id="L281">        return new BasicNoteBlockHolder(view);</span>
    }

    static class BasicNoteBlockHolder {
        private final LinearLayout mRootLayout;
        private final WPTextView mTextView;
        private final Button mButton;
        private final Button mMaterialButton;
        private final View mDivider;

        private ImageView mImageView;
        private VideoView mVideoView;

<span class="nc" id="L294">        BasicNoteBlockHolder(View view) {</span>
<span class="nc" id="L295">            mRootLayout = (LinearLayout) view;</span>
<span class="nc" id="L296">            mTextView = view.findViewById(R.id.note_text);</span>
<span class="nc" id="L297">            mTextView.setMovementMethod(new NoteBlockLinkMovementMethod());</span>
<span class="nc" id="L298">            mButton = view.findViewById(R.id.note_button);</span>
<span class="nc" id="L299">            mMaterialButton = view.findViewById(R.id.note_material_button);</span>
<span class="nc" id="L300">            mDivider = view.findViewById(R.id.divider_view);</span>
<span class="nc" id="L301">        }</span>

        public WPTextView getTextView() {
<span class="nc" id="L304">            return mTextView;</span>
        }

        public Button getButton() {
<span class="nc" id="L308">            return mButton;</span>
        }

        public Button getMaterialButton() {
<span class="nc" id="L312">            return mMaterialButton;</span>
        }

        public View getDivider() {
<span class="nc" id="L316">            return mDivider;</span>
        }

        public ImageView getImageView() {
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (mImageView == null) {</span>
<span class="nc" id="L321">                mImageView = new ImageView(mRootLayout.getContext());</span>
<span class="nc" id="L322">                int imageSize = DisplayUtils.dpToPx(mRootLayout.getContext(), 180);</span>
<span class="nc" id="L323">                int imagePadding = mRootLayout.getContext().getResources().getDimensionPixelSize(R.dimen.margin_large);</span>
<span class="nc" id="L324">                LinearLayout.LayoutParams layoutParams = new LinearLayout.LayoutParams(imageSize, imageSize);</span>
<span class="nc" id="L325">                layoutParams.gravity = Gravity.CENTER_HORIZONTAL;</span>
<span class="nc" id="L326">                mImageView.setLayoutParams(layoutParams);</span>
<span class="nc" id="L327">                mImageView.setPadding(0, imagePadding, 0, 0);</span>
<span class="nc" id="L328">                mRootLayout.addView(mImageView, 0);</span>
            }

<span class="nc" id="L331">            return mImageView;</span>
        }

        public VideoView getVideoView() {
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (mVideoView == null) {</span>
<span class="nc" id="L336">                mVideoView = new VideoView(mRootLayout.getContext());</span>
<span class="nc" id="L337">                FrameLayout.LayoutParams layoutParams =</span>
                        new FrameLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,
<span class="nc" id="L339">                                DisplayUtils.dpToPx(mRootLayout.getContext(), 220));</span>
<span class="nc" id="L340">                mVideoView.setLayoutParams(layoutParams);</span>
<span class="nc" id="L341">                mRootLayout.addView(mVideoView, 0);</span>

                // Attach a mediaController if we are displaying a video.
<span class="nc" id="L344">                final MediaController mediaController = new MediaController(mRootLayout.getContext());</span>
<span class="nc" id="L345">                mediaController.setMediaPlayer(mVideoView);</span>

<span class="nc" id="L347">                mVideoView.setMediaController(mediaController);</span>
<span class="nc" id="L348">                mediaController.requestFocus();</span>
<span class="nc" id="L349">                mVideoView.setOnPreparedListener(new MediaPlayer.OnPreparedListener() {</span>
                    @Override
                    public void onPrepared(MediaPlayer mp) {
                        // Show the media controls when the video is ready to be played.
<span class="nc" id="L353">                        mediaController.show(0);</span>
<span class="nc" id="L354">                    }</span>
                });
            }

<span class="nc" id="L358">            return mVideoView;</span>
        }

        public void hideImageView() {
<span class="nc bnc" id="L362" title="All 2 branches missed.">            if (mImageView != null) {</span>
<span class="nc" id="L363">                mImageView.setVisibility(View.GONE);</span>
            }
<span class="nc" id="L365">        }</span>

        public void hideVideoView() {
<span class="nc bnc" id="L368" title="All 2 branches missed.">            if (mVideoView != null) {</span>
<span class="nc" id="L369">                mVideoView.setVisibility(View.GONE);</span>
            }
<span class="nc" id="L371">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>