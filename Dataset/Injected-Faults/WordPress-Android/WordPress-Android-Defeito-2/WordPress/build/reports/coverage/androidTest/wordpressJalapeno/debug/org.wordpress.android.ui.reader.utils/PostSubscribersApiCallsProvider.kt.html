<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostSubscribersApiCallsProvider.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.utils</a> &gt; <span class="el_source">PostSubscribersApiCallsProvider.kt</span></div><h1>PostSubscribersApiCallsProvider.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.utils

import com.android.volley.VolleyError
import com.wordpress.rest.RestRequest.ErrorListener
import com.wordpress.rest.RestRequest.Listener
import org.json.JSONObject
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.ui.reader.utils.PostSubscribersApiCallsProvider.PostSubscribersCallResult.Failure
import org.wordpress.android.ui.reader.utils.PostSubscribersApiCallsProvider.PostSubscribersCallResult.Success
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import org.wordpress.android.util.VolleyUtils
import org.wordpress.android.viewmodel.ContextProvider
import javax.inject.Inject
import kotlin.coroutines.resume
import kotlin.coroutines.suspendCoroutine

<span class="nc" id="L19">@Suppress(&quot;TooManyFunctions&quot;)</span>
<span class="nc" id="L20">class PostSubscribersApiCallsProvider @Inject constructor(</span>
<span class="nc" id="L21">    private val contextProvider: ContextProvider</span>
) {
<span class="nc bnc" id="L23" title="All 2 branches missed.">    suspend fun getCanFollowComments(blogId: Long): Boolean = suspendCoroutine { cont -&gt;</span>
<span class="nc" id="L24">        val endPointPath = &quot;/sites/$blogId/&quot;</span>

<span class="nc" id="L26">        val listener = Listener { jsonObject -&gt;</span>
<span class="nc" id="L27">            val result = canFollowComments(blogId, jsonObject)</span>
<span class="nc" id="L28">            AppLog.d(</span>
<span class="nc" id="L29">                    T.READER,</span>
<span class="nc" id="L30">                    &quot;getCanFollowComments &gt; Succeeded [blogId=$blogId - result = $result]&quot;</span>
            )
<span class="nc" id="L32">            cont.resume(result is Success)</span>
<span class="nc" id="L33">        }</span>
<span class="nc" id="L34">        val errorListener = ErrorListener { volleyError -&gt;</span>
<span class="nc" id="L35">            AppLog.d(</span>
<span class="nc" id="L36">                    T.READER,</span>
<span class="nc" id="L37">                    &quot;getCanFollowComments &gt; Failed [blogId=$blogId - volleyError = $volleyError]&quot;</span>
            )
<span class="nc" id="L39">            cont.resume(false)</span>
<span class="nc" id="L40">        }</span>

<span class="nc" id="L42">        WordPress.getRestClientUtilsV1_1().get(</span>
<span class="nc" id="L43">                endPointPath,</span>
<span class="nc" id="L44">                listener,</span>
<span class="nc" id="L45">                errorListener</span>
        )
<span class="nc" id="L47">    }</span>

    suspend fun getMySubscriptionToPost(
        blogId: Long,
        postId: Long
<span class="nc bnc" id="L52" title="All 2 branches missed.">    ): PostSubscribersCallResult = suspendCoroutine { cont -&gt;</span>
<span class="nc" id="L53">        val endPointPath = &quot;/sites/$blogId/posts/$postId/subscribers/mine&quot;</span>

<span class="nc" id="L55">        val listener = Listener { jsonObject -&gt;</span>
<span class="nc" id="L56">            val result = getFollowingStateResult(jsonObject)</span>
<span class="nc" id="L57">            AppLog.d(</span>
<span class="nc" id="L58">                    T.READER,</span>
<span class="nc" id="L59">                    &quot;getMySubscriptionToPost &gt; Succeeded [blogId=$blogId - postId=$postId - result = $result]&quot;</span>
            )
<span class="nc" id="L61">            cont.resume(result)</span>
<span class="nc" id="L62">        }</span>
<span class="nc" id="L63">        val errorListener = ErrorListener { volleyError -&gt;</span>
<span class="nc" id="L64">            val error = getErrorStringAndLog(&quot;getMySubscriptionToPost&quot;, blogId, postId, volleyError)</span>
<span class="nc" id="L65">            cont.resume(Failure(error))</span>
<span class="nc" id="L66">        }</span>

<span class="nc" id="L68">        WordPress.getRestClientUtilsV1_1().get(</span>
<span class="nc" id="L69">                endPointPath,</span>
<span class="nc" id="L70">                listener,</span>
<span class="nc" id="L71">                errorListener</span>
        )
<span class="nc" id="L73">    }</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">    suspend fun subscribeMeToPost(blogId: Long, postId: Long): PostSubscribersCallResult = suspendCoroutine { cont -&gt;</span>
<span class="nc" id="L76">        val endPointPath = &quot;/sites/$blogId/posts/$postId/subscribers/new&quot;</span>

<span class="nc" id="L78">        val listener = Listener { jsonObject -&gt;</span>
<span class="nc" id="L79">            val result = wasSubscribed(jsonObject)</span>
<span class="nc" id="L80">            AppLog.d(</span>
<span class="nc" id="L81">                    T.READER,</span>
<span class="nc" id="L82">                    &quot;subscribeMeToPost &gt; Succeeded [blogId=$blogId - postId=$postId - result = $result]&quot;</span>
            )
<span class="nc" id="L84">            cont.resume(result)</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">        val errorListener = ErrorListener { volleyError -&gt;</span>
<span class="nc" id="L87">            val error = getErrorStringAndLog(&quot;subscribeMeToPost&quot;, blogId, postId, volleyError)</span>
<span class="nc" id="L88">            cont.resume(Failure(error))</span>
<span class="nc" id="L89">        }</span>

<span class="nc" id="L91">        WordPress.getRestClientUtilsV1_1().post(</span>
<span class="nc" id="L92">                endPointPath,</span>
<span class="nc" id="L93">                listener,</span>
<span class="nc" id="L94">                errorListener</span>
        )
<span class="nc" id="L96">    }</span>

    suspend fun unsubscribeMeFromPost(
        blogId: Long,
        postId: Long
<span class="nc bnc" id="L101" title="All 2 branches missed.">    ): PostSubscribersCallResult = suspendCoroutine { cont -&gt;</span>
<span class="nc" id="L102">        val endPointPath = &quot;/sites/$blogId/posts/$postId/subscribers/mine/delete&quot;</span>

<span class="nc" id="L104">        val listener = Listener { jsonObject -&gt;</span>
<span class="nc" id="L105">            val result = wasUnsubscribed(jsonObject)</span>
<span class="nc" id="L106">            AppLog.d(</span>
<span class="nc" id="L107">                    T.READER,</span>
<span class="nc" id="L108">                    &quot;unsubscribeMeFromPost &gt; Succeeded [blogId=$blogId - postId=$postId - result = $result]&quot;</span>
            )
<span class="nc" id="L110">            cont.resume(result)</span>
<span class="nc" id="L111">        }</span>
<span class="nc" id="L112">        val errorListener = ErrorListener { volleyError -&gt;</span>
<span class="nc" id="L113">            val error = getErrorStringAndLog(&quot;unsubscribeMeFromPost&quot;, blogId, postId, volleyError)</span>
<span class="nc" id="L114">            cont.resume(Failure(error))</span>
<span class="nc" id="L115">        }</span>

<span class="nc" id="L117">        WordPress.getRestClientUtilsV1_1().post(</span>
<span class="nc" id="L118">                endPointPath,</span>
<span class="nc" id="L119">                listener,</span>
<span class="nc" id="L120">                errorListener</span>
        )
<span class="nc" id="L122">    }</span>

    suspend fun managePushNotificationsForPost(
        blogId: Long,
        postId: Long,
        activate: Boolean
<span class="nc bnc" id="L128" title="All 2 branches missed.">    ): PostSubscribersCallResult = suspendCoroutine { cont -&gt;</span>
<span class="nc" id="L129">        val endPointPath = &quot;/sites/$blogId/posts/$postId/subscribers/mine/update&quot;</span>

<span class="nc" id="L131">        val listener = Listener { jsonObject -&gt;</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            val result = if (activate) {</span>
<span class="nc" id="L133">                wasSubscribedForPushNotifications(jsonObject)</span>
            } else {
<span class="nc" id="L135">                wasUnsubscribedFromPushNotifications(jsonObject)</span>
            }
<span class="nc" id="L137">            AppLog.d(</span>
<span class="nc" id="L138">                    T.READER,</span>
<span class="nc" id="L139">                    &quot;managePushNotificationsForPost &gt; Succeeded [blogId=$blogId - postId=$postId - result = $result]&quot;</span>
            )
<span class="nc" id="L141">            cont.resume(result)</span>
<span class="nc" id="L142">        }</span>
<span class="nc" id="L143">        val errorListener = ErrorListener { volleyError -&gt;</span>
<span class="nc" id="L144">            val error = getErrorStringAndLog(&quot;managePushNotificationsForPost&quot;, blogId, postId, volleyError)</span>
<span class="nc" id="L145">            cont.resume(Failure(error))</span>
<span class="nc" id="L146">        }</span>

<span class="nc" id="L148">        val params = mutableMapOf&lt;String, String&gt;()</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        params[&quot;receive_notifications&quot;] = if (activate) &quot;true&quot; else &quot;false&quot;</span>

<span class="nc" id="L151">        WordPress.getRestClientUtilsV1_1().post(</span>
<span class="nc" id="L152">                endPointPath,</span>
<span class="nc" id="L153">                params,</span>
<span class="nc" id="L154">                null,</span>
<span class="nc" id="L155">                listener,</span>
<span class="nc" id="L156">                errorListener</span>
        )
<span class="nc" id="L158">    }</span>

    private fun getErrorStringAndLog(
        functionName: String,
        blogId: Long,
        postId: Long,
        volleyError: VolleyError?
    ): String {
<span class="nc" id="L166">        var error = VolleyUtils.errStringFromVolleyError(volleyError)</span>
<span class="nc bnc" id="L167" title="All 6 branches missed.">        return if (error.isNullOrEmpty()) {</span>
<span class="nc" id="L168">            AppLog.d(</span>
<span class="nc" id="L169">                    T.READER,</span>
<span class="nc" id="L170">                    &quot;$functionName &gt; Failed with empty string &quot; +</span>
<span class="nc" id="L171">                            &quot;[blogId=$blogId - postId=$postId - volleyError = $volleyError]&quot;</span>
            )
<span class="nc" id="L173">            contextProvider.getContext().getString(R.string.reader_follow_comments_get_status_error)</span>
<span class="nc" id="L174">        } else {</span>
<span class="nc" id="L175">            AppLog.d(</span>
<span class="nc" id="L176">                    T.READER,</span>
<span class="nc" id="L177">                    &quot;$functionName &gt; Failed [blogId=$blogId - postId=$postId - error = $error]&quot;</span>
            )
<span class="nc" id="L179">            error</span>
        }
    }

    private fun getFollowingStateResult(json: JSONObject?): PostSubscribersCallResult {
<span class="nc bnc" id="L184" title="All 4 branches missed.">        return json?.let {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (it.has(KEY_I_SUBSCRIBE) &amp;&amp;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                    (it.has(KEY_RECEIVES_NOTIFICATIONS))) {</span>
<span class="nc" id="L187">                Success(</span>
<span class="nc" id="L188">                        isFollowing = it.optBoolean(KEY_I_SUBSCRIBE, false),</span>
<span class="nc" id="L189">                        isReceivingNotifications = it.optBoolean(KEY_RECEIVES_NOTIFICATIONS, false)</span>
                )
            } else {
<span class="nc" id="L192">                Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_bad_format_response))</span>
            }
<span class="nc" id="L194">        } ?: Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_null_response))</span>
    }

    private fun canFollowComments(blogId: Long, json: JSONObject?): PostSubscribersCallResult {
<span class="nc bnc" id="L198" title="All 4 branches missed.">        return json?.let {</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">            if (it.has(&quot;ID&quot;) &amp;&amp; it.optLong(&quot;ID&quot;, -1) == blogId) {</span>
<span class="nc" id="L200">                Success(isFollowing = false, isReceivingNotifications = false)</span>
            } else {
<span class="nc" id="L202">                Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_bad_format_response))</span>
            }
<span class="nc" id="L204">        } ?: Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_null_response))</span>
    }

    private fun wasSubscribed(json: JSONObject?): PostSubscribersCallResult {
<span class="nc bnc" id="L208" title="All 4 branches missed.">        return json?.let {</span>
<span class="nc" id="L209">            val success = it.optBoolean(KEY_SUCCESS, false)</span>
<span class="nc" id="L210">            val subscribed = it.optBoolean(KEY_I_SUBSCRIBE, false)</span>
<span class="nc" id="L211">            val receivingNotifications = it.optBoolean(KEY_RECEIVES_NOTIFICATIONS, false)</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (success) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (subscribed) {</span>
<span class="nc" id="L215">                    Success(isFollowing = true, isReceivingNotifications = receivingNotifications)</span>
                } else {
<span class="nc" id="L217">                    Failure(contextProvider.getContext().getString(</span>
<span class="nc" id="L218">                            R.string.reader_follow_comments_could_not_subscribe_error</span>
                    ))
                }
            } else {
<span class="nc" id="L222">                Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_bad_format_response))</span>
            }
<span class="nc" id="L224">        } ?: Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_null_response))</span>
    }

    private fun wasUnsubscribed(json: JSONObject?): PostSubscribersCallResult {
<span class="nc bnc" id="L228" title="All 4 branches missed.">        return json?.let {</span>
<span class="nc" id="L229">            val success = it.optBoolean(KEY_SUCCESS, false)</span>
<span class="nc" id="L230">            val subscribed = it.optBoolean(KEY_I_SUBSCRIBE, true)</span>
<span class="nc" id="L231">            val receivingNotifications = it.optBoolean(KEY_RECEIVES_NOTIFICATIONS, false)</span>

<span class="nc bnc" id="L233" title="All 2 branches missed.">            if (success) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (!subscribed) {</span>
<span class="nc" id="L235">                    Success(isFollowing = false, isReceivingNotifications = receivingNotifications)</span>
                } else {
<span class="nc" id="L237">                    Failure(contextProvider.getContext().getString(</span>
<span class="nc" id="L238">                            R.string.reader_follow_comments_could_not_unsubscribe_error</span>
                    ))
                }
            } else {
<span class="nc" id="L242">                Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_bad_format_response))</span>
            }
<span class="nc" id="L244">        } ?: Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_null_response))</span>
    }

    private fun wasSubscribedForPushNotifications(json: JSONObject?): PostSubscribersCallResult {
<span class="nc bnc" id="L248" title="All 4 branches missed.">        return json?.let {</span>
<span class="nc" id="L249">            val subscribed = it.optBoolean(KEY_I_SUBSCRIBE, false)</span>
<span class="nc" id="L250">            val receivingNotifications = it.optBoolean(KEY_RECEIVES_NOTIFICATIONS, false)</span>

<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (subscribed) {</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                if (receivingNotifications) {</span>
<span class="nc" id="L254">                    Success(isFollowing = subscribed, isReceivingNotifications = receivingNotifications)</span>
                } else {
<span class="nc" id="L256">                    Failure(contextProvider.getContext().getString(</span>
<span class="nc" id="L257">                            R.string.reader_follow_comments_could_not_unsubscribe_error</span>
                    ))
                }
            } else {
<span class="nc" id="L261">                Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_bad_format_response))</span>
            }
<span class="nc" id="L263">        } ?: Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_null_response))</span>
    }

    private fun wasUnsubscribedFromPushNotifications(json: JSONObject?): PostSubscribersCallResult {
<span class="nc bnc" id="L267" title="All 4 branches missed.">        return json?.let {</span>
<span class="nc" id="L268">            val subscribed = it.optBoolean(KEY_I_SUBSCRIBE, false)</span>
<span class="nc" id="L269">            val receivingNotifications = it.optBoolean(KEY_RECEIVES_NOTIFICATIONS, true)</span>

<span class="nc bnc" id="L271" title="All 2 branches missed.">            if (subscribed) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                if (!receivingNotifications) {</span>
<span class="nc" id="L273">                    Success(isFollowing = subscribed, isReceivingNotifications = receivingNotifications)</span>
                } else {
<span class="nc" id="L275">                    Failure(contextProvider.getContext().getString(</span>
<span class="nc" id="L276">                            R.string.reader_follow_comments_could_not_unsubscribe_error</span>
                    ))
                }
            } else {
<span class="nc" id="L280">                Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_bad_format_response))</span>
            }
<span class="nc" id="L282">        } ?: Failure(contextProvider.getContext().getString(R.string.reader_follow_comments_null_response))</span>
    }

    sealed class PostSubscribersCallResult {
<span class="nc" id="L286">        data class Success(</span>
<span class="nc" id="L287">            val isFollowing: Boolean,</span>
<span class="nc" id="L288">            val isReceivingNotifications: Boolean</span>
<span class="nc" id="L289">        ) : PostSubscribersCallResult()</span>
<span class="nc" id="L290">        data class Failure(val error: String) : PostSubscribersCallResult()</span>
    }

    companion object {
        private const val KEY_I_SUBSCRIBE = &quot;i_subscribe&quot;
        private const val KEY_RECEIVES_NOTIFICATIONS = &quot;receives_notifications&quot;
        private const val KEY_SUCCESS = &quot;success&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>