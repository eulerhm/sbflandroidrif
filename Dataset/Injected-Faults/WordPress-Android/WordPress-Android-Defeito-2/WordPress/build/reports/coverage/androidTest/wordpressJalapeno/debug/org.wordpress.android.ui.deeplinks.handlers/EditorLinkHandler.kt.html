<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EditorLinkHandler.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.deeplinks.handlers</a> &gt; <span class="el_source">EditorLinkHandler.kt</span></div><h1>EditorLinkHandler.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.deeplinks.handlers

import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.PostModel
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.PostStore
import org.wordpress.android.ui.deeplinks.DeepLinkNavigator.NavigateAction
import org.wordpress.android.ui.deeplinks.DeepLinkNavigator.NavigateAction.OpenEditor
import org.wordpress.android.ui.deeplinks.DeepLinkNavigator.NavigateAction.OpenEditorForPost
import org.wordpress.android.ui.deeplinks.DeepLinkNavigator.NavigateAction.OpenEditorForSite
import org.wordpress.android.ui.deeplinks.DeepLinkUriUtils
import org.wordpress.android.ui.deeplinks.DeepLinkingIntentReceiverViewModel
import org.wordpress.android.ui.deeplinks.DeepLinkingIntentReceiverViewModel.Companion.APPLINK_SCHEME
import org.wordpress.android.util.UriWrapper
import org.wordpress.android.viewmodel.Event
import javax.inject.Inject

<span class="nc" id="L20">class EditorLinkHandler</span>
<span class="nc" id="L21">@Inject constructor(</span>
<span class="nc" id="L22">    private val deepLinkUriUtils: DeepLinkUriUtils,</span>
<span class="nc" id="L23">    private val postStore: PostStore</span>
) : DeepLinkHandler {
<span class="nc" id="L25">    private val _toast = MutableLiveData&lt;Event&lt;Int&gt;&gt;()</span>

    override fun toast(): LiveData&lt;Event&lt;Int&gt;&gt; {
<span class="nc" id="L28">        return _toast</span>
    }

    /**
     * Builds navigate action from URL like:
     * https://wordpress.com/post/siteNameOrUrl/postId
     * where siteNameOrUrl and postID are optional
     * or App links like wordpress://post?blogId=798&amp;postId=1231
     */
    override fun buildNavigateAction(uri: UriWrapper): NavigateAction {
<span class="nc" id="L38">        var hasSiteParam = false</span>
<span class="nc" id="L39">        var hasPostParam = false</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">        val (targetSite, targetPost) = if (uri.host == POST_PATH) {</span>
            // Handles wordpress://post?blogId=798&amp;postId=1231
<span class="nc bnc" id="L42" title="All 4 branches missed.">            val targetSite = uri.getQueryParameter(BLOG_ID).also { hasSiteParam = it != null }?.blogIdToSite()</span>
<span class="nc bnc" id="L43" title="All 4 branches missed.">            val targetPost = uri.getQueryParameter(POST_ID).also { hasPostParam = it != null }?.toPost(targetSite)</span>
<span class="nc" id="L44">            targetSite to targetPost</span>
        } else {
            // Handles https://wordpress.com/post/siteNameOrUrl/postId
<span class="nc" id="L47">            val pathSegments = uri.pathSegments</span>
<span class="nc bnc" id="L48" title="All 4 branches missed.">            val targetSite = pathSegments.getOrNull(1).also { hasSiteParam = it != null }?.hostNameToSite()</span>
<span class="nc bnc" id="L49" title="All 4 branches missed.">            val targetPost = pathSegments.getOrNull(2).also { hasPostParam = it != null }?.toPost(targetSite)</span>
<span class="nc" id="L50">            targetSite to targetPost</span>
        }
<span class="nc" id="L52">        return openEditorForSiteAndPost(hasSiteParam, hasPostParam, targetSite, targetPost)</span>
    }

    /**
     * Returns true if the URI should be handled by EditorLinkHandler.
     * The handled links are `wordpress.com/post...1
     */
    override fun shouldHandleUrl(uri: UriWrapper): Boolean {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        return (uri.host == DeepLinkingIntentReceiverViewModel.HOST_WORDPRESS_COM &amp;&amp;</span>
<span class="nc bnc" id="L61" title="All 4 branches missed.">                uri.pathSegments.firstOrNull() == POST_PATH) || uri.host == POST_PATH</span>
    }

    override fun stripUrl(uri: UriWrapper): String {
<span class="nc bnc" id="L65" title="All 2 branches missed.">        return if (uri.host == POST_PATH) {</span>
            // Transforms wordpress://post?blogId=798&amp;postId=1231 to wordpress://post?blogId=blogId&amp;postId=postId
<span class="nc" id="L67">            buildString {</span>
<span class="nc" id="L68">                append(&quot;$APPLINK_SCHEME$POST_PATH&quot;)</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                val hasBlogIdParameter = uri.getQueryParameter(BLOG_ID) != null</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                val hasPostIdParameter = uri.getQueryParameter(POST_ID) != null</span>
<span class="nc bnc" id="L71" title="All 4 branches missed.">                if (hasBlogIdParameter || hasPostIdParameter) {</span>
<span class="nc" id="L72">                    append(&quot;?&quot;)</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">                    if (hasBlogIdParameter) {</span>
<span class="nc" id="L74">                        append(&quot;$BLOG_ID=$BLOG_ID&quot;)</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                        if (hasPostIdParameter) {</span>
<span class="nc" id="L76">                            append(&quot;&amp;&quot;)</span>
                        }
                    }
<span class="nc bnc" id="L79" title="All 2 branches missed.">                    if (hasPostIdParameter) {</span>
<span class="nc" id="L80">                        append(&quot;$POST_ID=$POST_ID&quot;)</span>
                    }
                }
<span class="nc" id="L83">            }</span>
        } else {
            // Transforms https://wordpress.com/post/example.com/1231 to https://wordpress.com/post/siteNameOrUrl/postId
<span class="nc" id="L86">            buildString {</span>
<span class="nc" id="L87">                append(&quot;${DeepLinkingIntentReceiverViewModel.HOST_WORDPRESS_COM}/$POST_PATH/&quot;)</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (uri.pathSegments.size &gt; 2) {</span>
<span class="nc" id="L89">                    append(&quot;${DeepLinkingIntentReceiverViewModel.SITE_DOMAIN}/$POST_ID&quot;)</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">                } else if (uri.pathSegments.size &gt; 1) {</span>
<span class="nc" id="L91">                    append(DeepLinkingIntentReceiverViewModel.SITE_DOMAIN)</span>
                }
<span class="nc" id="L93">            }</span>
        }
    }

    /**
     * Converts BlogID if long or Site URL for other cases to a SiteModel
     */
    private fun String.blogIdToSite(): SiteModel? {
<span class="nc bnc" id="L101" title="All 2 branches missed.">        return deepLinkUriUtils.blogIdToSite(this) ?: this.hostNameToSite()</span>
    }

    /**
     * Converts HOST name of a site to SiteModel. It finds the Site in the current local sites and matches the name
     * to the host.
     */
    private fun String.hostNameToSite(): SiteModel? {
<span class="nc" id="L109">        return deepLinkUriUtils.hostToSite(this)</span>
    }

    /**
     * Converts the post ID in String to the local PostModel (if available).
     */
    private fun String.toPost(site: SiteModel?): PostModel? {
<span class="nc" id="L116">        val remotePostId: Long? = toLongOrNull()</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">        return if (site != null &amp;&amp; remotePostId != null) {</span>
<span class="nc" id="L118">            val post = postStore.getPostByRemotePostId(remotePostId, site)</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (post == null) {</span>
<span class="nc" id="L120">                _toast.value = Event(R.string.post_not_found)</span>
            }
<span class="nc" id="L122">            post</span>
        } else {
<span class="nc" id="L124">            null</span>
        }
    }

    private fun openEditorForSiteAndPost(
        hasSiteParam: Boolean,
        hasPostParam: Boolean,
        site: SiteModel?,
        post: PostModel?
    ): NavigateAction {
<span class="nc" id="L134">        return when {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            site == null -&gt; {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                if (hasSiteParam) {</span>
                    // Site not found, or host of site doesn't match the host in url
<span class="nc" id="L138">                    _toast.value = Event(R.string.blog_not_found)</span>
                }
                // Open a new post editor with current selected site
<span class="nc" id="L141">                OpenEditor</span>
            }
<span class="nc bnc" id="L143" title="All 2 branches missed.">            post == null -&gt; {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if (hasPostParam) {</span>
                    // Post not found. Open new post editor for given site.
<span class="nc" id="L146">                    _toast.value = Event(R.string.post_not_found)</span>
                }
                // Open new post editor for given site
<span class="nc" id="L149">                OpenEditorForSite(site)</span>
            }
<span class="nc" id="L151">            else -&gt; OpenEditorForPost(site, post.id)</span>
        }
    }

    companion object {
        private const val POST_PATH = &quot;post&quot;
        private const val BLOG_ID = &quot;blogId&quot;
        private const val POST_ID = &quot;postId&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>