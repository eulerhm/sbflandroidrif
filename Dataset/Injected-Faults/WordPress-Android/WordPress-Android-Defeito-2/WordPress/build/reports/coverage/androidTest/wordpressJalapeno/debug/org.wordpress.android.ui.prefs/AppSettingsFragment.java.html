<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppSettingsFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs</a> &gt; <span class="el_source">AppSettingsFragment.java</span></div><h1>AppSettingsFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs;

import android.app.Dialog;
import android.content.ActivityNotFoundException;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.preference.ListPreference;
import android.preference.Preference;
import android.preference.Preference.OnPreferenceClickListener;
import android.preference.PreferenceCategory;
import android.preference.PreferenceFragment;
import android.preference.PreferenceScreen;
import android.preference.SwitchPreference;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ListView;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.view.ViewCompat;

import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.jetbrains.annotations.NotNull;
import org.wordpress.android.BuildConfig;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.action.AccountAction;
import org.wordpress.android.fluxc.generated.AccountActionBuilder;
import org.wordpress.android.fluxc.generated.WhatsNewActionBuilder;
import org.wordpress.android.fluxc.model.whatsnew.WhatsNewAnnouncementModel;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.AccountStore.OnAccountChanged;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.store.WhatsNewStore.OnWhatsNewFetched;
import org.wordpress.android.fluxc.store.WhatsNewStore.WhatsNewAppId;
import org.wordpress.android.fluxc.store.WhatsNewStore.WhatsNewFetchPayload;
import org.wordpress.android.ui.prefs.language.LocalePickerBottomSheet;
import org.wordpress.android.ui.prefs.language.LocalePickerBottomSheet.LocalePickerCallback;
import org.wordpress.android.ui.about.UnifiedAboutActivity;
import org.wordpress.android.ui.debug.DebugSettingsActivity;
import org.wordpress.android.ui.mysite.tabs.MySiteDefaultTabExperiment;
import org.wordpress.android.ui.mysite.tabs.MySiteTabType;
import org.wordpress.android.ui.reader.services.update.ReaderUpdateLogic;
import org.wordpress.android.ui.reader.services.update.ReaderUpdateServiceStarter;
import org.wordpress.android.ui.whatsnew.FeatureAnnouncementDialogFragment;
import org.wordpress.android.ui.whatsnew.FeatureAnnouncementProvider;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppThemeUtils;
import org.wordpress.android.util.BuildConfigWrapper;
import org.wordpress.android.util.LocaleManager;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.WPActivityUtils;
import org.wordpress.android.util.WPPrefUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.util.config.MySiteDashboardTabsFeatureConfig;
import org.wordpress.android.util.config.UnifiedAboutFeatureConfig;
import org.wordpress.android.viewmodel.ContextProvider;

import java.util.Collections;
import java.util.EnumSet;
import java.util.HashMap;
import java.util.Locale;
import java.util.Map;

import javax.inject.Inject;

<span class="nc" id="L76">public class AppSettingsFragment extends PreferenceFragment</span>
        implements OnPreferenceClickListener, Preference.OnPreferenceChangeListener, LocalePickerCallback {
    public static final int LANGUAGE_CHANGED = 1000;

    private WPPreference mLanguagePreference;
    private ListPreference mAppThemePreference;
    private ListPreference mInitialScreenPreference;

    // This Device settings
    private WPSwitchPreference mOptimizedImage;
    private DetailListPreference mImageMaxSizePref;
    private DetailListPreference mImageQualityPref;
    private WPSwitchPreference mOptimizedVideo;
    private DetailListPreference mVideoWidthPref;
    private DetailListPreference mVideoEncorderBitratePref;
    private PreferenceScreen mPrivacySettings;
    private WPSwitchPreference mStripImageLocation;
    private WPSwitchPreference mReportCrashPref;

    private Preference mWhatsNew;

    @Inject SiteStore mSiteStore;
    @Inject AccountStore mAccountStore;
    @Inject Dispatcher mDispatcher;
    @Inject ContextProvider mContextProvider;
    @Inject FeatureAnnouncementProvider mFeatureAnnouncementProvider;
    @Inject BuildConfigWrapper mBuildConfigWrapper;
    @Inject UnifiedAboutFeatureConfig mUnifiedAboutFeatureConfig;
    @Inject MySiteDashboardTabsFeatureConfig mMySiteDashboardTabsFeatureConfig;
    @Inject MySiteDefaultTabExperiment mMySiteDefaultTabExperiment;

    private static final String TRACK_STYLE = &quot;style&quot;;
    private static final String TRACK_ENABLED = &quot;enabled&quot;;

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L112">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L113">        ((WordPress) getActivity().getApplication()).component().inject(this);</span>
<span class="nc" id="L114">        mDispatcher.register(this);</span>

<span class="nc" id="L116">        setRetainInstance(true);</span>

<span class="nc" id="L118">        addPreferencesFromResource(R.xml.app_settings);</span>

<span class="nc" id="L120">        findPreference(getString(R.string.pref_key_send_usage)).setOnPreferenceChangeListener(</span>
<span class="nc" id="L121">                new Preference.OnPreferenceChangeListener() {</span>
                    @Override
                    public boolean onPreferenceChange(Preference preference, Object newValue) {
<span class="nc bnc" id="L124" title="All 2 branches missed.">                        if (newValue == null) {</span>
<span class="nc" id="L125">                            return false;</span>
                        }

<span class="nc bnc" id="L128" title="All 2 branches missed.">                        boolean hasUserOptedOut = !(boolean) newValue;</span>
<span class="nc" id="L129">                        AnalyticsUtils.updateAnalyticsPreference(</span>
<span class="nc" id="L130">                                getActivity(),</span>
                                mDispatcher,
                                mAccountStore,
                                hasUserOptedOut);

<span class="nc" id="L135">                        return true;</span>
                    }
                }
        );
<span class="nc" id="L139">        updateAnalyticsSyncUI();</span>

<span class="nc" id="L141">        mLanguagePreference = (WPPreference) findPreference(getString(R.string.pref_key_language));</span>
<span class="nc" id="L142">        mLanguagePreference.setOnPreferenceChangeListener(this);</span>
<span class="nc" id="L143">        mLanguagePreference.setOnPreferenceClickListener(this);</span>

<span class="nc" id="L145">        mAppThemePreference = (ListPreference) findPreference(getString(R.string.pref_key_app_theme));</span>
<span class="nc" id="L146">        mAppThemePreference.setOnPreferenceChangeListener(this);</span>

<span class="nc" id="L148">        mInitialScreenPreference = (ListPreference) findPreference(getString(R.string.pref_key_initial_screen));</span>
<span class="nc" id="L149">        mInitialScreenPreference.setOnPreferenceChangeListener(this);</span>

<span class="nc" id="L151">        findPreference(getString(R.string.pref_key_language))</span>
<span class="nc" id="L152">                .setOnPreferenceClickListener(this);</span>
<span class="nc" id="L153">        findPreference(getString(R.string.pref_key_device_settings))</span>
<span class="nc" id="L154">                .setOnPreferenceClickListener(this);</span>
<span class="nc" id="L155">        findPreference(getString(R.string.pref_key_debug_settings))</span>
<span class="nc" id="L156">                .setOnPreferenceClickListener(this);</span>
<span class="nc" id="L157">        findPreference(getString(R.string.pref_key_app_about))</span>
<span class="nc" id="L158">                .setOnPreferenceClickListener(this);</span>
<span class="nc" id="L159">        findPreference(getString(R.string.pref_key_oss_licenses))</span>
<span class="nc" id="L160">                .setOnPreferenceClickListener(this);</span>

<span class="nc" id="L162">        mOptimizedImage =</span>
                (WPSwitchPreference) WPPrefUtils
<span class="nc" id="L164">                        .getPrefAndSetChangeListener(this, R.string.pref_key_optimize_image, this);</span>
<span class="nc" id="L165">        mImageMaxSizePref = (DetailListPreference) WPPrefUtils</span>
<span class="nc" id="L166">                .getPrefAndSetChangeListener(this, R.string.pref_key_site_image_width, this);</span>
<span class="nc" id="L167">        mImageQualityPref =</span>
                (DetailListPreference) WPPrefUtils
<span class="nc" id="L169">                        .getPrefAndSetChangeListener(this, R.string.pref_key_site_image_quality, this);</span>
<span class="nc" id="L170">        mOptimizedVideo =</span>
                (WPSwitchPreference) WPPrefUtils
<span class="nc" id="L172">                        .getPrefAndSetChangeListener(this, R.string.pref_key_optimize_video, this);</span>

<span class="nc" id="L174">        mVideoWidthPref =</span>
                (DetailListPreference) WPPrefUtils
<span class="nc" id="L176">                        .getPrefAndSetChangeListener(this, R.string.pref_key_site_video_width, this);</span>
<span class="nc" id="L177">        mVideoEncorderBitratePref =</span>
                (DetailListPreference) WPPrefUtils
<span class="nc" id="L179">                        .getPrefAndSetChangeListener(this, R.string.pref_key_site_video_encoder_bitrate, this);</span>
<span class="nc" id="L180">        mPrivacySettings = (PreferenceScreen) WPPrefUtils</span>
<span class="nc" id="L181">                .getPrefAndSetClickListener(this, R.string.pref_key_privacy_settings, this);</span>

<span class="nc" id="L183">        mStripImageLocation =</span>
                (WPSwitchPreference) WPPrefUtils
<span class="nc" id="L185">                        .getPrefAndSetChangeListener(this, R.string.pref_key_strip_image_location, this);</span>
<span class="nc" id="L186">        mReportCrashPref = (WPSwitchPreference) WPPrefUtils</span>
<span class="nc" id="L187">                .getPrefAndSetChangeListener(this, R.string.pref_key_send_crash, this);</span>

        // Set Local settings
<span class="nc" id="L190">        mOptimizedImage.setChecked(AppPrefs.isImageOptimize());</span>
<span class="nc" id="L191">        setDetailListPreferenceValue(mImageMaxSizePref,</span>
<span class="nc" id="L192">                String.valueOf(AppPrefs.getImageOptimizeMaxSize()),</span>
<span class="nc" id="L193">                getLabelForImageMaxSizeValue(AppPrefs.getImageOptimizeMaxSize()));</span>
<span class="nc" id="L194">        setDetailListPreferenceValue(mImageQualityPref,</span>
<span class="nc" id="L195">                String.valueOf(AppPrefs.getImageOptimizeQuality()),</span>
<span class="nc" id="L196">                getLabelForImageQualityValue(AppPrefs.getImageOptimizeQuality()));</span>

<span class="nc" id="L198">        mOptimizedVideo.setChecked(AppPrefs.isVideoOptimize());</span>
<span class="nc" id="L199">        setDetailListPreferenceValue(mVideoWidthPref,</span>
<span class="nc" id="L200">                String.valueOf(AppPrefs.getVideoOptimizeWidth()),</span>
<span class="nc" id="L201">                getLabelForVideoMaxWidthValue(AppPrefs.getVideoOptimizeWidth()));</span>
<span class="nc" id="L202">        setDetailListPreferenceValue(mVideoEncorderBitratePref,</span>
<span class="nc" id="L203">                String.valueOf(AppPrefs.getVideoOptimizeQuality()),</span>
<span class="nc" id="L204">                getLabelForVideoEncoderBitrateValue(AppPrefs.getVideoOptimizeQuality()));</span>

<span class="nc" id="L206">        mStripImageLocation.setChecked(AppPrefs.isStripImageLocation());</span>

<span class="nc" id="L208">        mWhatsNew = findPreference(getString(R.string.pref_key_whats_new));</span>

<span class="nc" id="L210">        removeWhatsNewPreference();</span>
<span class="nc" id="L211">        mDispatcher.dispatch(WhatsNewActionBuilder.newFetchCachedAnnouncementAction());</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (mUnifiedAboutFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L214">            removeAboutCategory();</span>
        }

        if (!BuildConfig.OFFER_GUTENBERG) {
            removeExperimentalCategory();
        }

        if (!BuildConfig.ENABLE_DEBUG_SETTINGS) {
            removeDebugSettingsCategory();
        }

<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (!mMySiteDashboardTabsFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L226">            removeInitialScreen();</span>
        }
<span class="nc" id="L228">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container,
                             @Nullable Bundle savedInstanceState) {
<span class="nc" id="L233">        View view = super.onCreateView(inflater, container, savedInstanceState);</span>

<span class="nc" id="L235">        final ListView listOfPreferences = view.findViewById(android.R.id.list);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (listOfPreferences != null) {</span>
<span class="nc" id="L237">            ViewCompat.setNestedScrollingEnabled(listOfPreferences, true);</span>
        }
<span class="nc" id="L239">        return view;</span>
    }

    private void removeExperimentalCategory() {
<span class="nc" id="L243">        PreferenceCategory experimentalPreferenceCategory =</span>
<span class="nc" id="L244">                (PreferenceCategory) findPreference(getString(R.string.pref_key_experimental_section));</span>
<span class="nc" id="L245">        PreferenceScreen preferenceScreen =</span>
<span class="nc" id="L246">                (PreferenceScreen) findPreference(getString(R.string.pref_key_app_settings_root));</span>
<span class="nc" id="L247">        preferenceScreen.removePreference(experimentalPreferenceCategory);</span>
<span class="nc" id="L248">    }</span>

    private void removeDebugSettingsCategory() {
<span class="nc" id="L251">        Preference experimentalPreference =</span>
<span class="nc" id="L252">                findPreference(getString(R.string.pref_key_debug_settings));</span>
<span class="nc" id="L253">        PreferenceScreen preferenceScreen =</span>
<span class="nc" id="L254">                (PreferenceScreen) findPreference(getString(R.string.pref_key_app_settings_root));</span>
<span class="nc" id="L255">        preferenceScreen.removePreference(experimentalPreference);</span>
<span class="nc" id="L256">    }</span>

    private void removeAboutCategory() {
<span class="nc" id="L259">        PreferenceCategory aboutPreferenceCategory =</span>
<span class="nc" id="L260">                (PreferenceCategory) findPreference(getString(R.string.pref_key_about_section));</span>
<span class="nc" id="L261">        PreferenceScreen preferenceScreen =</span>
<span class="nc" id="L262">                (PreferenceScreen) findPreference(getString(R.string.pref_key_app_settings_root));</span>
<span class="nc" id="L263">        preferenceScreen.removePreference(aboutPreferenceCategory);</span>
<span class="nc" id="L264">    }</span>

    private void removeWhatsNewPreference() {
<span class="nc" id="L267">        PreferenceScreen preferenceScreen =</span>
<span class="nc" id="L268">                (PreferenceScreen) findPreference(getString(R.string.pref_key_app_settings_root));</span>
<span class="nc" id="L269">        preferenceScreen.removePreference(mWhatsNew);</span>
<span class="nc" id="L270">    }</span>

    private void addWhatsNewPreference() {
<span class="nc" id="L273">        PreferenceScreen preferenceScreen =</span>
<span class="nc" id="L274">                (PreferenceScreen) findPreference(getString(R.string.pref_key_app_settings_root));</span>
<span class="nc" id="L275">        preferenceScreen.addPreference(mWhatsNew);</span>
<span class="nc" id="L276">    }</span>

    private void removeInitialScreen() {
<span class="nc" id="L279">        Preference initialScreenPreference =</span>
<span class="nc" id="L280">                findPreference(getString(R.string.pref_key_initial_screen));</span>
<span class="nc" id="L281">        PreferenceScreen preferenceScreen =</span>
<span class="nc" id="L282">                (PreferenceScreen) findPreference(getString(R.string.pref_key_app_settings_root));</span>
<span class="nc" id="L283">        preferenceScreen.removePreference(initialScreenPreference);</span>
<span class="nc" id="L284">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L288">        super.onResume();</span>
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if (mAccountStore.hasAccessToken() &amp;&amp; NetworkUtils.isNetworkAvailable(getActivity())) {</span>
<span class="nc" id="L290">            mDispatcher.dispatch(AccountActionBuilder.newFetchSettingsAction());</span>
        }
<span class="nc" id="L292">    }</span>

    @Override
    public void onStart() {
<span class="nc" id="L296">        super.onStart();</span>
<span class="nc" id="L297">    }</span>

    @Override
    public void onStop() {
<span class="nc" id="L301">        mDispatcher.unregister(this);</span>
<span class="nc" id="L302">        super.onStop();</span>
<span class="nc" id="L303">    }</span>

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L307">        super.onActivityCreated(savedInstanceState);</span>
<span class="nc" id="L308">        reattachLocalePickerCallback();</span>
        // flush gathered events (if any)
<span class="nc" id="L310">        AnalyticsTracker.flush();</span>
<span class="nc" id="L311">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onWhatsNewFetched(OnWhatsNewFetched event) {
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (event.isFromCache()) {</span>
<span class="nc" id="L317">            mDispatcher.dispatch(WhatsNewActionBuilder</span>
<span class="nc" id="L318">                    .newFetchRemoteAnnouncementAction(</span>
<span class="nc" id="L319">                            new WhatsNewFetchPayload(mBuildConfigWrapper.getAppVersionName(),</span>
                                    WhatsNewAppId.WP_ANDROID)));
        }

<span class="nc bnc" id="L323" title="All 6 branches missed.">        if (event.error != null || event.getWhatsNewItems() == null || event.getWhatsNewItems().isEmpty()) {</span>
<span class="nc" id="L324">            return;</span>
        }

<span class="nc" id="L327">        WhatsNewAnnouncementModel latestAnnouncement = event.getWhatsNewItems().get(0);</span>
<span class="nc" id="L328">        mWhatsNew.setSummary(getString(R.string.version_with_name_param, latestAnnouncement.getAppVersionName()));</span>
<span class="nc" id="L329">        mWhatsNew.setOnPreferenceClickListener(this);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (mBuildConfigWrapper.isWhatsNewFeatureEnabled()) {</span>
<span class="nc" id="L331">            addWhatsNewPreference();</span>
        }
<span class="nc" id="L333">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAccountChanged(OnAccountChanged event) {
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L339">            return;</span>
        }

<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc bnc" id="L343" title="All 4 branches missed.">            switch (event.error.type) {</span>
                case SETTINGS_FETCH_GENERIC_ERROR:
<span class="nc" id="L345">                    ToastUtils</span>
<span class="nc" id="L346">                            .showToast(getActivity(), R.string.error_fetch_account_settings, ToastUtils.Duration.LONG);</span>
<span class="nc" id="L347">                    break;</span>
                case SETTINGS_FETCH_REAUTHORIZATION_REQUIRED_ERROR:
<span class="nc" id="L349">                    ToastUtils.showToast(getActivity(), R.string.error_disabled_apis,</span>
                            ToastUtils.Duration.LONG);
<span class="nc" id="L351">                    break;</span>
                case SETTINGS_POST_ERROR:
<span class="nc" id="L353">                    ToastUtils.showToast(getActivity(), R.string.error_post_account_settings, ToastUtils.Duration.LONG);</span>
<span class="nc" id="L354">                    break;</span>
            }
<span class="nc bnc" id="L356" title="All 2 branches missed.">        } else if (event.causeOfChange == AccountAction.FETCH_SETTINGS) {</span>
            // no need to sync with remote here, or do anything else here, since the logic is already in WordPress.java
<span class="nc" id="L358">            updateAnalyticsSyncUI();</span>
        }
<span class="nc" id="L360">    }</span>

    /* Make sure the UI is synced with the backend value */
    private void updateAnalyticsSyncUI() {
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L365">            return;</span>
        }
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (mAccountStore.hasAccessToken()) {</span>
<span class="nc" id="L368">            SwitchPreference tracksOptOutPreference =</span>
<span class="nc" id="L369">                    (SwitchPreference) findPreference(getString(R.string.pref_key_send_usage));</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">            tracksOptOutPreference.setChecked(!mAccountStore.getAccount().getTracksOptOut());</span>
        }
<span class="nc" id="L372">    }</span>

    @Override
    public boolean onPreferenceClick(Preference preference) {
<span class="nc bnc" id="L376" title="All 2 branches missed.">        String preferenceKey = preference != null ? preference.getKey() : &quot;&quot;;</span>

<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (preferenceKey.equals(getString(R.string.pref_key_device_settings))) {</span>
<span class="nc" id="L379">            return handleDevicePreferenceClick();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">        } else if (preferenceKey.equals(getString(R.string.pref_key_debug_settings))) {</span>
<span class="nc" id="L381">            return handleDebugSettingsPreferenceClick();</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">        } else if (preferenceKey.equals(getString(R.string.pref_key_app_about))) {</span>
<span class="nc" id="L383">            return handleAboutPreferenceClick();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">        } else if (preferenceKey.equals(getString(R.string.pref_key_oss_licenses))) {</span>
<span class="nc" id="L385">            return handleOssPreferenceClick();</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">        } else if (preference == mPrivacySettings) {</span>
<span class="nc" id="L387">            return handlePrivacyClick();</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">        } else if (preference == mWhatsNew) {</span>
<span class="nc" id="L389">            return handleFeatureAnnouncementClick();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">        } else if (preference == mLanguagePreference) {</span>
<span class="nc" id="L391">            return handleAppLocalePickerClick();</span>
        }

<span class="nc" id="L394">        return false;</span>
    }

    @Override
    public boolean onPreferenceChange(Preference preference, Object newValue) {
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (newValue == null) {</span>
<span class="nc" id="L400">            return false;</span>
        }

<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (preference == mLanguagePreference) {</span>
<span class="nc" id="L404">            changeLanguage(newValue.toString());</span>
<span class="nc" id="L405">            return false;</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">        } else if (preference == mOptimizedImage) {</span>
<span class="nc" id="L407">            AppPrefs.setImageOptimize((Boolean) newValue);</span>
<span class="nc" id="L408">            mImageMaxSizePref.setEnabled((Boolean) newValue);</span>
<span class="nc" id="L409">            Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L410">            properties.put(&quot;enabled&quot;, newValue);</span>
<span class="nc" id="L411">            AnalyticsTracker.track(AnalyticsTracker.Stat.SITE_SETTINGS_OPTIMIZE_IMAGES_CHANGED, properties);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">        } else if (preference == mImageMaxSizePref) {</span>
<span class="nc" id="L413">            int newWidth = Integer.parseInt(newValue.toString());</span>
<span class="nc" id="L414">            AppPrefs.setImageOptimizeMaxSize(newWidth);</span>
<span class="nc" id="L415">            setDetailListPreferenceValue(mImageMaxSizePref,</span>
<span class="nc" id="L416">                    newValue.toString(),</span>
<span class="nc" id="L417">                    getLabelForImageMaxSizeValue(AppPrefs.getImageOptimizeMaxSize()));</span>
<span class="nc" id="L418">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_SETTINGS_MAX_IMAGE_SIZE_CHANGED);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        } else if (preference == mImageQualityPref) {</span>
<span class="nc" id="L420">            AppPrefs.setImageOptimizeQuality(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L421">            setDetailListPreferenceValue(mImageQualityPref,</span>
<span class="nc" id="L422">                    newValue.toString(),</span>
<span class="nc" id="L423">                    getLabelForImageQualityValue(AppPrefs.getImageOptimizeQuality()));</span>
<span class="nc" id="L424">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_SETTINGS_IMAGE_QUALITY_CHANGED);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">        } else if (preference == mOptimizedVideo) {</span>
<span class="nc" id="L426">            AppPrefs.setVideoOptimize((Boolean) newValue);</span>
<span class="nc" id="L427">            mVideoEncorderBitratePref.setEnabled((Boolean) newValue);</span>
<span class="nc" id="L428">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_SETTINGS_VIDEO_OPTIMIZATION_CHANGED, Collections</span>
<span class="nc" id="L429">                    .singletonMap(TRACK_ENABLED, newValue));</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        } else if (preference == mVideoWidthPref) {</span>
<span class="nc" id="L431">            int newWidth = Integer.parseInt(newValue.toString());</span>
<span class="nc" id="L432">            AppPrefs.setVideoOptimizeWidth(newWidth);</span>
<span class="nc" id="L433">            setDetailListPreferenceValue(mVideoWidthPref,</span>
<span class="nc" id="L434">                    newValue.toString(),</span>
<span class="nc" id="L435">                    getLabelForVideoMaxWidthValue(AppPrefs.getVideoOptimizeWidth()));</span>
<span class="nc" id="L436">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_SETTINGS_MAX_VIDEO_SIZE_CHANGED);</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">        } else if (preference == mVideoEncorderBitratePref) {</span>
<span class="nc" id="L438">            AppPrefs.setVideoOptimizeQuality(Integer.parseInt(newValue.toString()));</span>
<span class="nc" id="L439">            setDetailListPreferenceValue(mVideoEncorderBitratePref,</span>
<span class="nc" id="L440">                    newValue.toString(),</span>
<span class="nc" id="L441">                    getLabelForVideoEncoderBitrateValue(AppPrefs.getVideoOptimizeQuality()));</span>
<span class="nc" id="L442">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_SETTINGS_VIDEO_QUALITY_CHANGED);</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">        } else if (preference == mStripImageLocation) {</span>
<span class="nc" id="L444">            AppPrefs.setStripImageLocation((Boolean) newValue);</span>
<span class="nc" id="L445">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_SETTINGS_REMOVE_LOCATION_FROM_MEDIA_CHANGED, Collections</span>
<span class="nc" id="L446">                    .singletonMap(TRACK_ENABLED, newValue));</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">        } else if (preference == mAppThemePreference) {</span>
<span class="nc" id="L448">            AppThemeUtils.Companion.setAppTheme(getActivity(), (String) newValue);</span>
<span class="nc" id="L449">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_SETTINGS_APPEARANCE_CHANGED, Collections</span>
<span class="nc" id="L450">                    .singletonMap(TRACK_STYLE, (String) newValue));</span>
            // restart activity to make sure changes are applied to PreferenceScreen
<span class="nc" id="L452">            getActivity().recreate();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        } else if (preference == mInitialScreenPreference) {</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            String trackValue = newValue.equals(MySiteTabType.SITE_MENU.getLabel())</span>
<span class="nc" id="L455">                    ? MySiteTabType.SITE_MENU.getTrackingLabel()</span>
<span class="nc" id="L456">                    : MySiteTabType.DASHBOARD.getTrackingLabel();</span>
<span class="nc" id="L457">            Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L458">            properties.put(&quot;selected&quot;, trackValue);</span>
<span class="nc" id="L459">            AnalyticsTracker.track(Stat.APP_SETTINGS_INITIAL_SCREEN_CHANGED, properties);</span>
<span class="nc" id="L460">            mMySiteDefaultTabExperiment.changeExperimentVariantAssignmentIfNeeded(trackValue);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">        } else if (preference == mReportCrashPref) {</span>
<span class="nc" id="L462">            AnalyticsTracker.track(Stat.PRIVACY_SETTINGS_REPORT_CRASHES_TOGGLED, Collections</span>
<span class="nc" id="L463">                    .singletonMap(TRACK_ENABLED, newValue));</span>
        }
<span class="nc" id="L465">        return true;</span>
    }

    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L469" title="All 2 branches missed.">        switch (item.getItemId()) {</span>
            case android.R.id.home:
<span class="nc" id="L471">                getActivity().finish();</span>
        }
<span class="nc" id="L473">        return super.onOptionsItemSelected(item);</span>
    }

    private void changeLanguage(String languageCode) {
<span class="nc bnc" id="L477" title="All 4 branches missed.">        if (mLanguagePreference == null || TextUtils.isEmpty(languageCode)) {</span>
<span class="nc" id="L478">            return;</span>
        }

<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (LocaleManager.isSameLanguage(languageCode)) {</span>
<span class="nc" id="L482">            return;</span>
        }

<span class="nc" id="L485">        LocaleManager.setNewLocale(WordPress.getContext(), languageCode);</span>
<span class="nc" id="L486">        WordPress.updateContextLocale();</span>
<span class="nc" id="L487">        mContextProvider.refreshContext();</span>

        // Track language change on Analytics because we have both the device language and app selected language
        // data in Tracks metadata.
<span class="nc" id="L491">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L492">        properties.put(&quot;app_locale&quot;, Locale.getDefault());</span>
<span class="nc" id="L493">        AnalyticsTracker.track(Stat.ACCOUNT_SETTINGS_LANGUAGE_CHANGED, properties);</span>

        // Language is now part of metadata, so we need to refresh them
<span class="nc" id="L496">        AnalyticsUtils.refreshMetadata(mAccountStore, mSiteStore);</span>

        // Refresh the app
<span class="nc" id="L499">        Intent refresh = new Intent(getActivity(), getActivity().getClass());</span>
<span class="nc" id="L500">        startActivity(refresh);</span>
<span class="nc" id="L501">        getActivity().setResult(LANGUAGE_CHANGED);</span>
<span class="nc" id="L502">        getActivity().overridePendingTransition(android.R.anim.fade_in, android.R.anim.fade_out);</span>
<span class="nc" id="L503">        getActivity().finish();</span>

        // update Reader tags as they need be localized
<span class="nc" id="L506">        ReaderUpdateServiceStarter.startService(WordPress.getContext(), EnumSet.of(ReaderUpdateLogic.UpdateTask.TAGS));</span>
<span class="nc" id="L507">    }</span>

    private boolean handleAboutPreferenceClick() {
        // Temporarily limiting this feature to the WordPress app
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (mUnifiedAboutFeatureConfig.isEnabled() &amp;&amp; !BuildConfig.IS_JETPACK_APP) {</span>
<span class="nc" id="L512">            startActivity(new Intent(getActivity(), UnifiedAboutActivity.class));</span>
        } else {
<span class="nc" id="L514">            startActivity(new Intent(getActivity(), AboutActivity.class));</span>
        }
<span class="nc" id="L516">        return true;</span>
    }

    private boolean handleDebugSettingsPreferenceClick() {
<span class="nc" id="L520">        startActivity(new Intent(getActivity(), DebugSettingsActivity.class));</span>
<span class="nc" id="L521">        return true;</span>
    }

    private boolean handleDevicePreferenceClick() {
        try {
            // open specific app info screen
<span class="nc" id="L527">            Intent intent = new Intent(android.provider.Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span>
<span class="nc" id="L528">            intent.setData(Uri.parse(&quot;package:&quot; + getActivity().getPackageName()));</span>
<span class="nc" id="L529">            startActivity(intent);</span>
<span class="nc" id="L530">        } catch (ActivityNotFoundException exception) {</span>
<span class="nc" id="L531">            AppLog.w(AppLog.T.SETTINGS, exception.getMessage());</span>
            // open generic apps screen
<span class="nc" id="L533">            Intent intent = new Intent(android.provider.Settings.ACTION_MANAGE_APPLICATIONS_SETTINGS);</span>
<span class="nc" id="L534">            startActivity(intent);</span>
<span class="nc" id="L535">        }</span>

<span class="nc" id="L537">        AnalyticsTracker.track(Stat.APP_SETTINGS_OPEN_DEVICE_SETTINGS_TAPPED);</span>
<span class="nc" id="L538">        return true;</span>
    }

    private boolean handleOssPreferenceClick() {
<span class="nc" id="L542">        startActivity(new Intent(getActivity(), LicensesActivity.class));</span>
<span class="nc" id="L543">        return true;</span>
    }

    private String getLabelForImageMaxSizeValue(int newValue) {
<span class="nc" id="L547">        String[] values = getActivity().getResources().getStringArray(R.array.site_settings_image_max_size_values);</span>
<span class="nc" id="L548">        String[] entries = getActivity().getResources().getStringArray(R.array.site_settings_image_max_size_entries);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; i++) {</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">            if (values[i].equals(String.valueOf(newValue))) {</span>
<span class="nc" id="L551">                return entries[i];</span>
            }
        }

<span class="nc" id="L555">        return entries[0];</span>
    }

    private String getLabelForImageQualityValue(int newValue) {
<span class="nc" id="L559">        String[] values = getActivity().getResources().getStringArray(R.array.site_settings_image_quality_values);</span>
<span class="nc" id="L560">        String[] entries = getActivity().getResources().getStringArray(R.array.site_settings_image_quality_entries);</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; i++) {</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">            if (values[i].equals(String.valueOf(newValue))) {</span>
<span class="nc" id="L563">                return entries[i];</span>
            }
        }

<span class="nc" id="L567">        return entries[0];</span>
    }

    private String getLabelForVideoMaxWidthValue(int newValue) {
<span class="nc" id="L571">        String[] values = getActivity().getResources().getStringArray(R.array.site_settings_video_width_values);</span>
<span class="nc" id="L572">        String[] entries = getActivity().getResources().getStringArray(R.array.site_settings_video_width_entries);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; i++) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">            if (values[i].equals(String.valueOf(newValue))) {</span>
<span class="nc" id="L575">                return entries[i];</span>
            }
        }

<span class="nc" id="L579">        return entries[0];</span>
    }

    private String getLabelForVideoEncoderBitrateValue(int newValue) {
<span class="nc" id="L583">        String[] values = getActivity().getResources().getStringArray(R.array.site_settings_video_bitrate_values);</span>
<span class="nc" id="L584">        String[] entries = getActivity().getResources().getStringArray(R.array.site_settings_video_bitrate_entries);</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; i++) {</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">            if (values[i].equals(String.valueOf(newValue))) {</span>
<span class="nc" id="L587">                return entries[i];</span>
            }
        }

<span class="nc" id="L591">        return entries[0];</span>
    }

    private void setDetailListPreferenceValue(DetailListPreference pref, String value, String summary) {
<span class="nc" id="L595">        pref.setValue(value);</span>
<span class="nc" id="L596">        pref.setSummary(summary);</span>
<span class="nc" id="L597">        pref.refreshAdapter();</span>
<span class="nc" id="L598">    }</span>

    private boolean handlePrivacyClick() {
<span class="nc" id="L601">        AnalyticsTracker.track(Stat.APP_SETTINGS_PRIVACY_SETTINGS_TAPPED);</span>

<span class="nc bnc" id="L603" title="All 4 branches missed.">        if (mPrivacySettings == null || !isAdded()) {</span>
<span class="nc" id="L604">            return false;</span>
        }

<span class="nc" id="L607">        String title = getString(R.string.preference_privacy_settings);</span>
<span class="nc" id="L608">        Dialog dialog = mPrivacySettings.getDialog();</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">        if (dialog != null) {</span>
<span class="nc" id="L610">            WPActivityUtils.addToolbarToDialog(this, dialog, title);</span>
        }

<span class="nc" id="L613">        AnalyticsTracker.track(Stat.PRIVACY_SETTINGS_OPENED);</span>
<span class="nc" id="L614">        return true;</span>
    }

    private boolean handleFeatureAnnouncementClick() {
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (getActivity() instanceof AppCompatActivity) {</span>
<span class="nc" id="L619">            AnalyticsTracker.track(Stat.FEATURE_ANNOUNCEMENT_SHOWN_FROM_APP_SETTINGS);</span>
<span class="nc" id="L620">            new FeatureAnnouncementDialogFragment()</span>
<span class="nc" id="L621">                    .show(((AppCompatActivity) getActivity()).getSupportFragmentManager(),</span>
                            FeatureAnnouncementDialogFragment.TAG);
<span class="nc" id="L623">            return true;</span>
        } else {
<span class="nc" id="L625">            throw new IllegalArgumentException(</span>
                    &quot;Parent activity is not AppCompatActivity. FeatureAnnouncementDialogFragment must be called &quot;
                    + &quot;using support fragment manager from AppCompatActivity.&quot;);
        }
    }

    private boolean handleAppLocalePickerClick() {
<span class="nc bnc" id="L632" title="All 2 branches missed.">        if (getActivity() instanceof AppCompatActivity) {</span>
<span class="nc" id="L633">            LocalePickerBottomSheet bottomSheet = LocalePickerBottomSheet.newInstance();</span>
<span class="nc" id="L634">            bottomSheet.setLocalePickerCallback(this);</span>
<span class="nc" id="L635">            bottomSheet.show(((AppCompatActivity) getActivity()).getSupportFragmentManager(),</span>
                    LocalePickerBottomSheet.TAG);
<span class="nc" id="L637">            return true;</span>
        } else {
<span class="nc" id="L639">            throw new IllegalArgumentException(</span>
                    &quot;Parent activity is not AppCompatActivity. LocalePickerBottomSheet must be called &quot;
                    + &quot;using support fragment manager from AppCompatActivity.&quot;);
        }
    }

    private void reattachLocalePickerCallback() {
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (getActivity() instanceof AppCompatActivity) {</span>
<span class="nc" id="L647">            LocalePickerBottomSheet bottomSheet = (LocalePickerBottomSheet) (((AppCompatActivity) getActivity()))</span>
<span class="nc" id="L648">                    .getSupportFragmentManager().findFragmentByTag(LocalePickerBottomSheet.TAG);</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (bottomSheet != null) {</span>
<span class="nc" id="L650">                bottomSheet.setLocalePickerCallback(this);</span>
            }
        }
<span class="nc" id="L653">    }</span>

    @Override
    public void onLocaleSelected(@NotNull String languageCode) {
<span class="nc" id="L657">        onPreferenceChange(mLanguagePreference, languageCode);</span>
<span class="nc" id="L658">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>