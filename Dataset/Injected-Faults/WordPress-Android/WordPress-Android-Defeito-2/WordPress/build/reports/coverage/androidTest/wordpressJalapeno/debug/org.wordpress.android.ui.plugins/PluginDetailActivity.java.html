<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PluginDetailActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.plugins</a> &gt; <span class="el_source">PluginDetailActivity.java</span></div><h1>PluginDetailActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.plugins;

import android.animation.ObjectAnimator;
import android.app.Activity;
import android.app.Dialog;
import android.app.ProgressDialog;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.text.Html;
import android.text.TextUtils;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.ImageView.ScaleType;
import android.widget.ProgressBar;
import android.widget.RatingBar;
import android.widget.RelativeLayout;
import android.widget.SimpleAdapter;
import android.widget.TextView;

import androidx.annotation.IdRes;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.widget.AppCompatButton;
import androidx.appcompat.widget.SwitchCompat;
import androidx.appcompat.widget.Toolbar;
import androidx.cardview.widget.CardView;
import androidx.fragment.app.DialogFragment;
import androidx.fragment.app.FragmentTransaction;

import com.google.android.material.appbar.CollapsingToolbarLayout;
import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.google.android.material.elevation.ElevationOverlayProvider;
import com.google.android.material.snackbar.Snackbar;

import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.jetbrains.annotations.NotNull;
import org.wordpress.android.BuildConfig;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.generated.PluginActionBuilder;
import org.wordpress.android.fluxc.generated.SiteActionBuilder;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.model.plugin.ImmutablePluginModel;
import org.wordpress.android.fluxc.model.plugin.PluginDirectoryType;
import org.wordpress.android.fluxc.store.PluginStore;
import org.wordpress.android.fluxc.store.PluginStore.ConfigureSitePluginPayload;
import org.wordpress.android.fluxc.store.PluginStore.DeleteSitePluginPayload;
import org.wordpress.android.fluxc.store.PluginStore.InstallSitePluginPayload;
import org.wordpress.android.fluxc.store.PluginStore.OnPluginDirectoryFetched;
import org.wordpress.android.fluxc.store.PluginStore.OnSitePluginConfigured;
import org.wordpress.android.fluxc.store.PluginStore.OnSitePluginDeleted;
import org.wordpress.android.fluxc.store.PluginStore.OnSitePluginInstalled;
import org.wordpress.android.fluxc.store.PluginStore.OnSitePluginUpdated;
import org.wordpress.android.fluxc.store.PluginStore.OnWPOrgPluginFetched;
import org.wordpress.android.fluxc.store.PluginStore.UpdateSitePluginPayload;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.store.SiteStore.InitiateAutomatedTransferPayload;
import org.wordpress.android.fluxc.store.SiteStore.OnAutomatedTransferEligibilityChecked;
import org.wordpress.android.fluxc.store.SiteStore.OnAutomatedTransferInitiated;
import org.wordpress.android.fluxc.store.SiteStore.OnAutomatedTransferStatusChecked;
import org.wordpress.android.fluxc.store.SiteStore.OnPlansFetched;
import org.wordpress.android.fluxc.store.SiteStore.OnSiteChanged;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.LocaleAwareActivity;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.domains.DomainRegistrationActivity;
import org.wordpress.android.ui.domains.DomainRegistrationActivity.DomainRegistrationPurpose;
import org.wordpress.android.ui.posts.BasicFragmentDialog;
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogPositiveClickInterface;
import org.wordpress.android.util.AniUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.extensions.ContextExtensionsKt;
import org.wordpress.android.util.DateTimeUtils;
import org.wordpress.android.util.DisplayUtils;
import org.wordpress.android.util.FormatUtils;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.ToastUtils.Duration;
import org.wordpress.android.util.WPLinkMovementMethod;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageType;
import org.wordpress.android.widgets.WPSnackbar;

import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.TimeZone;

import javax.inject.Inject;

import static org.wordpress.android.ui.plans.PlanUtilsKt.isDomainCreditAvailable;
import static org.wordpress.android.util.DomainRegistrationUtilsKt.requestEmailValidation;

<span class="nc" id="L114">public class PluginDetailActivity extends LocaleAwareActivity implements OnDomainRegistrationRequestedListener,</span>
        BasicDialogPositiveClickInterface {
    public static final String KEY_PLUGIN_SLUG = &quot;KEY_PLUGIN_SLUG&quot;;
    private static final String KEY_IS_CONFIGURING_PLUGIN = &quot;KEY_IS_CONFIGURING_PLUGIN&quot;;
    private static final String KEY_IS_INSTALLING_PLUGIN = &quot;KEY_IS_INSTALLING_PLUGIN&quot;;
    private static final String KEY_IS_UPDATING_PLUGIN = &quot;KEY_IS_UPDATING_PLUGIN&quot;;
    private static final String KEY_IS_REMOVING_PLUGIN = &quot;KEY_IS_REMOVING_PLUGIN&quot;;
    private static final String KEY_IS_ACTIVE = &quot;KEY_IS_ACTIVE&quot;;
    private static final String KEY_IS_AUTO_UPDATE_ENABLED = &quot;KEY_IS_AUTO_UPDATE_ENABLED&quot;;
    private static final String KEY_IS_SHOWING_REMOVE_PLUGIN_CONFIRMATION_DIALOG
            = &quot;KEY_IS_SHOWING_REMOVE_PLUGIN_CONFIRMATION_DIALOG&quot;;
    private static final String KEY_IS_SHOWING_INSTALL_FIRST_PLUGIN_CONFIRMATION_DIALOG
            = &quot;KEY_IS_SHOWING_INSTALL_FIRST_PLUGIN_CONFIRMATION_DIALOG&quot;;
    private static final String KEY_IS_SHOWING_AUTOMATED_TRANSFER_PROGRESS
            = &quot;KEY_IS_SHOWING_AUTOMATED_TRANSFER_PROGRESS&quot;;
    private static final String KEY_IS_SHOWING_DOMAIN_CREDIT_CHECK_PROGRESS
            = &quot;KEY_IS_SHOWING_DOMAIN_CREDIT_CHECK_PROGRESS&quot;;
    private static final String KEY_PLUGIN_RECHECKED_TIMES = &quot;KEY_PLUGIN_RECHECKED_TIMES&quot;;
    private static final String TAG_ERROR_DIALOG = &quot;ERROR_DIALOG&quot;;

    private static final int MAX_PLUGIN_CHECK_TRIES = 10;
    private static final int DEFAULT_RETRY_DELAY_MS = 3000;
    private static final int PLUGIN_RETRY_DELAY_MS = 10000;

    private SiteModel mSite;
    private String mSlug;
    protected ImmutablePluginModel mPlugin;
    private Handler mHandler;

    private ViewGroup mContainer;
    private TextView mTitleTextView;
    private TextView mByLineTextView;
    private TextView mVersionTopTextView;
    private TextView mVersionBottomTextView;
    private TextView mInstalledText;
    private AppCompatButton mUpdateButton;
    private AppCompatButton mInstallButton;
    private SwitchCompat mSwitchActive;
    private SwitchCompat mSwitchAutoupdates;
    private ProgressDialog mRemovePluginProgressDialog;
    private ProgressDialog mAutomatedTransferProgressDialog;
    private ProgressDialog mCheckingDomainCreditsProgressDialog;

    private CardView mWPOrgPluginDetailsContainer;
    private RelativeLayout mRatingsSectionContainer;

    protected TextView mDescriptionTextView;
    protected ImageView mDescriptionChevron;
    protected TextView mInstallationTextView;
    protected ImageView mInstallationChevron;
    protected TextView mWhatsNewTextView;
    protected ImageView mWhatsNewChevron;
    protected TextView mFaqTextView;
    protected ImageView mFaqChevron;

    private ImageView mImageBanner;
    private ImageView mImageIcon;

    private boolean mIsConfiguringPlugin;
    private boolean mIsInstallingPlugin;
    private boolean mIsUpdatingPlugin;
    private boolean mIsRemovingPlugin;
    protected boolean mIsShowingRemovePluginConfirmationDialog;
    protected boolean mIsShowingInstallFirstPluginConfirmationDialog;
    protected boolean mIsShowingAutomatedTransferProgress;

<span class="nc" id="L180">    private int mPluginReCheckTimer = 0;</span>

    // These flags reflects the UI state
    protected boolean mIsActive;
    protected boolean mIsAutoUpdateEnabled;

    @Inject PluginStore mPluginStore;
    @Inject SiteStore mSiteStore;
    @Inject Dispatcher mDispatcher;
    @Inject ImageManager mImageManager;

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L193">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L194">        ((WordPress) getApplication()).component().inject(this);</span>
<span class="nc" id="L195">        mDispatcher.register(this);</span>

<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L198">            mSite = (SiteModel) getIntent().getSerializableExtra(WordPress.SITE);</span>
<span class="nc" id="L199">            mSlug = getIntent().getStringExtra(KEY_PLUGIN_SLUG);</span>
        } else {
<span class="nc" id="L201">            mSite = (SiteModel) savedInstanceState.getSerializable(WordPress.SITE);</span>
<span class="nc" id="L202">            mSlug = savedInstanceState.getString(KEY_PLUGIN_SLUG);</span>
        }

<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (mSite == null) {</span>
<span class="nc" id="L206">            ToastUtils.showToast(this, R.string.blog_not_found);</span>
<span class="nc" id="L207">            finish();</span>
<span class="nc" id="L208">            return;</span>
        }

<span class="nc" id="L211">        refreshPluginFromStore();</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (mPlugin == null) {</span>
<span class="nc" id="L214">            ToastUtils.showToast(this, R.string.plugin_not_found);</span>
<span class="nc" id="L215">            finish();</span>
<span class="nc" id="L216">            return;</span>
        }

<span class="nc" id="L219">        boolean isShowingDomainCreditCheckProgress = false;</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L222">            mIsActive = mPlugin.isActive();</span>
<span class="nc" id="L223">            mIsAutoUpdateEnabled = mPlugin.isAutoUpdateEnabled();</span>
            // Refresh the wporg plugin which should also fetch fields such as descriptionAsHtml if it's missing
<span class="nc" id="L225">            mDispatcher.dispatch(PluginActionBuilder.newFetchWporgPluginAction(mSlug));</span>
        } else {
<span class="nc" id="L227">            mIsConfiguringPlugin = savedInstanceState.getBoolean(KEY_IS_CONFIGURING_PLUGIN);</span>
<span class="nc" id="L228">            mIsInstallingPlugin = savedInstanceState.getBoolean(KEY_IS_INSTALLING_PLUGIN);</span>
<span class="nc" id="L229">            mIsUpdatingPlugin = savedInstanceState.getBoolean(KEY_IS_UPDATING_PLUGIN);</span>
<span class="nc" id="L230">            mIsRemovingPlugin = savedInstanceState.getBoolean(KEY_IS_REMOVING_PLUGIN);</span>
<span class="nc" id="L231">            mIsActive = savedInstanceState.getBoolean(KEY_IS_ACTIVE);</span>
<span class="nc" id="L232">            mIsAutoUpdateEnabled = savedInstanceState.getBoolean(KEY_IS_AUTO_UPDATE_ENABLED);</span>
<span class="nc" id="L233">            mIsShowingRemovePluginConfirmationDialog =</span>
<span class="nc" id="L234">                    savedInstanceState.getBoolean(KEY_IS_SHOWING_REMOVE_PLUGIN_CONFIRMATION_DIALOG);</span>
<span class="nc" id="L235">            mIsShowingInstallFirstPluginConfirmationDialog = savedInstanceState</span>
<span class="nc" id="L236">                    .getBoolean(KEY_IS_SHOWING_INSTALL_FIRST_PLUGIN_CONFIRMATION_DIALOG);</span>
<span class="nc" id="L237">            mIsShowingAutomatedTransferProgress = savedInstanceState</span>
<span class="nc" id="L238">                    .getBoolean(KEY_IS_SHOWING_AUTOMATED_TRANSFER_PROGRESS);</span>
<span class="nc" id="L239">            isShowingDomainCreditCheckProgress = savedInstanceState</span>
<span class="nc" id="L240">                    .getBoolean(KEY_IS_SHOWING_DOMAIN_CREDIT_CHECK_PROGRESS);</span>
<span class="nc" id="L241">            mPluginReCheckTimer = savedInstanceState.getInt(KEY_PLUGIN_RECHECKED_TIMES, 0);</span>
        }

<span class="nc" id="L244">        setContentView(R.layout.plugin_detail_activity);</span>

<span class="nc" id="L246">        Toolbar toolbar = findViewById(R.id.toolbar);</span>
<span class="nc" id="L247">        setSupportActionBar(toolbar);</span>
<span class="nc" id="L248">        ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L250">            actionBar.setTitle(null);</span>
<span class="nc" id="L251">            actionBar.setHomeButtonEnabled(true);</span>
<span class="nc" id="L252">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L253">            actionBar.setElevation(0);</span>
        }


<span class="nc" id="L257">        CollapsingToolbarLayout collapsingToolbarLayout = findViewById(R.id.collapsing_toolbar);</span>
<span class="nc" id="L258">        ElevationOverlayProvider elevationOverlayProvider = new ElevationOverlayProvider(this);</span>

<span class="nc" id="L260">        float appbarElevation = getResources().getDimension(R.dimen.appbar_elevation);</span>
<span class="nc" id="L261">        int elevatedColor = elevationOverlayProvider</span>
<span class="nc" id="L262">                .compositeOverlayIfNeeded(ContextExtensionsKt.getColorFromAttribute(this, R.attr.wpColorAppBar),</span>
                        appbarElevation);
<span class="nc" id="L264">        collapsingToolbarLayout.setContentScrimColor(elevatedColor);</span>

<span class="nc" id="L266">        mHandler = new Handler();</span>
<span class="nc" id="L267">        setupViews();</span>

<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (mIsShowingRemovePluginConfirmationDialog) {</span>
            // Show remove plugin confirmation dialog if it's dismissed while activity is re-created
<span class="nc" id="L271">            confirmRemovePlugin();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        } else if (mIsRemovingPlugin) {</span>
            // Show remove plugin progress dialog if it's dismissed while activity is re-created
<span class="nc" id="L274">            showRemovePluginProgressDialog();</span>
        }

<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (mIsShowingInstallFirstPluginConfirmationDialog) {</span>
<span class="nc" id="L278">            confirmInstallPluginForAutomatedTransfer();</span>
        }

<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (isShowingDomainCreditCheckProgress) {</span>
<span class="nc" id="L282">            showDomainCreditsCheckProgressDialog();</span>
        }

<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (mIsShowingAutomatedTransferProgress) {</span>
<span class="nc" id="L286">            showAutomatedTransferProgressDialog();</span>
        }
<span class="nc" id="L288">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPlansFetched(OnPlansFetched event) {
<span class="nc bnc" id="L293" title="All 4 branches missed.">        if (mCheckingDomainCreditsProgressDialog == null || !mCheckingDomainCreditsProgressDialog.isShowing()) {</span>
<span class="nc" id="L294">            AppLog.w(T.PLANS, &quot;User cancelled domain credit checking. Ignoring the result.&quot;);</span>
<span class="nc" id="L295">            return;</span>
        }

<span class="nc" id="L298">        cancelDomainCreditsCheckProgressDialog();</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L300">            AppLog.e(T.PLANS, PluginDetailActivity.class.getSimpleName() + &quot;.onPlansFetched: &quot;</span>
                              + event.error.type + &quot; - &quot; + event.error.message);
<span class="nc" id="L302">            WPSnackbar.make(mContainer, getString(R.string.plugin_check_domain_credit_error), Snackbar.LENGTH_LONG)</span>
<span class="nc" id="L303">                      .show();</span>
        } else {
            // This should not happen
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if (event.plans == null) {</span>
<span class="nc" id="L307">                String errorMessage = &quot;Failed to fetch user Plans. The result is null.&quot;;</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                if (BuildConfig.DEBUG) {</span>
<span class="nc" id="L309">                    throw new IllegalStateException(errorMessage);</span>
                }
<span class="nc" id="L311">                WPSnackbar.make(mContainer, getString(R.string.plugin_check_domain_credit_error), Snackbar.LENGTH_LONG)</span>
<span class="nc" id="L312">                          .show();</span>
<span class="nc" id="L313">                AppLog.e(T.PLANS, errorMessage);</span>
<span class="nc" id="L314">                return;</span>
            }

<span class="nc bnc" id="L317" title="All 2 branches missed.">            if (isDomainCreditAvailable(event.plans)) {</span>
<span class="nc" id="L318">                showDomainRegistrationDialog();</span>
            } else {
<span class="nc" id="L320">                dispatchInstallPluginAction();</span>
            }
        }
<span class="nc" id="L323">    }</span>

    @Override
    public void onDomainRegistrationRequested() {
<span class="nc" id="L327">        ActivityLauncher.viewDomainRegistrationActivityForResult(this, mSite,</span>
                DomainRegistrationPurpose.AUTOMATED_TRANSFER);
<span class="nc" id="L329">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
<span class="nc" id="L333">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (requestCode == RequestCodes.DOMAIN_REGISTRATION) {</span>
<span class="nc bnc" id="L335" title="All 4 branches missed.">            if (resultCode != Activity.RESULT_OK || isFinishing()) {</span>
<span class="nc" id="L336">                return;</span>
            }
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (data != null) {</span>
<span class="nc" id="L339">                String email = data.getStringExtra(DomainRegistrationActivity.RESULT_REGISTERED_DOMAIN_EMAIL);</span>
<span class="nc" id="L340">                requestEmailValidation(this, email);</span>
            }
<span class="nc" id="L342">            AnalyticsTracker.track(Stat.AUTOMATED_TRANSFER_CUSTOM_DOMAIN_PURCHASED);</span>
<span class="nc" id="L343">            confirmInstallPluginForAutomatedTransfer();</span>
        }
<span class="nc" id="L345">    }</span>

    @Override
    public void onPositiveClicked(@NotNull String instanceTag) {
        // do nothing
<span class="nc" id="L350">    }</span>

<span class="nc" id="L352">    public static class DomainRegistrationPromptDialog extends DialogFragment {</span>
        static final String DOMAIN_REGISTRATION_PROMPT_DIALOG_TAG = &quot;DOMAIN_REGISTRATION_PROMPT_DIALOG&quot;;

        @NonNull
        @Override
        public Dialog onCreateDialog(Bundle savedInstanceState) {
<span class="nc" id="L358">            AlertDialog.Builder builder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L359">            builder.setTitle(R.string.plugin_install_custom_domain_required_dialog_title);</span>
<span class="nc" id="L360">            builder.setMessage(R.string.plugin_install_custom_domain_required_dialog_message);</span>
<span class="nc" id="L361">            builder.setPositiveButton(R.string.plugin_install_custom_domain_required_dialog_register_btn,</span>
                    (dialogInterface, i) -&gt; {
<span class="nc bnc" id="L363" title="All 4 branches missed.">                        if (isAdded() &amp;&amp; getActivity() instanceof OnDomainRegistrationRequestedListener) {</span>
<span class="nc" id="L364">                            ((OnDomainRegistrationRequestedListener) getActivity()).onDomainRegistrationRequested();</span>
                        }
<span class="nc" id="L366">                    });</span>
<span class="nc" id="L367">            builder.setNegativeButton(R.string.cancel,</span>
                    (dialogInterface, i) -&gt; {
<span class="nc" id="L369">                    });</span>

<span class="nc" id="L371">            builder.setCancelable(true);</span>
<span class="nc" id="L372">            return builder.create();</span>
        }
    }

    private void showDomainRegistrationDialog() {
<span class="nc" id="L377">        DialogFragment dialogFragment = new DomainRegistrationPromptDialog();</span>
<span class="nc" id="L378">        FragmentTransaction ft = getSupportFragmentManager().beginTransaction();</span>
<span class="nc" id="L379">        ft.add(dialogFragment, DomainRegistrationPromptDialog.DOMAIN_REGISTRATION_PROMPT_DIALOG_TAG);</span>
<span class="nc" id="L380">        ft.commitAllowingStateLoss();</span>
<span class="nc" id="L381">    }</span>

    @Override
    protected void onDestroy() {
        // Even though the progress dialog will be destroyed, when it's re-created sometimes the spinner
        // would get stuck. This seems to be helping with that.
<span class="nc" id="L387">        cancelRemovePluginProgressDialog();</span>

<span class="nc" id="L389">        cancelDomainCreditsCheckProgressDialog();</span>

<span class="nc" id="L391">        mDispatcher.unregister(this);</span>
<span class="nc" id="L392">        super.onDestroy();</span>
<span class="nc" id="L393">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L397">        getMenuInflater().inflate(R.menu.plugin_detail, menu);</span>
<span class="nc" id="L398">        return super.onCreateOptionsMenu(menu);</span>
    }

    @Override
    public boolean onPrepareOptionsMenu(Menu menu) {
<span class="nc" id="L403">        boolean showTrash = canPluginBeDisabledOrRemoved();</span>
<span class="nc" id="L404">        menu.findItem(R.id.menu_trash).setVisible(showTrash);</span>
<span class="nc" id="L405">        return super.onPrepareOptionsMenu(menu);</span>
    }

    @Override
    public boolean onOptionsItemSelected(final MenuItem item) {
<span class="nc bnc" id="L410" title="All 2 branches missed.">        if (item.getItemId() == android.R.id.home) {</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">            if (isPluginStateChangedSinceLastConfigurationDispatch()) {</span>
                // It looks like we have some unsaved changes, we need to force a configuration dispatch since the
                // user is leaving the page
<span class="nc" id="L414">                dispatchConfigurePluginAction(true);</span>
            }
<span class="nc" id="L416">            onBackPressed();</span>
<span class="nc" id="L417">            return true;</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        } else if (item.getItemId() == R.id.menu_trash) {</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">            if (NetworkUtils.checkConnection(this)) {</span>
<span class="nc" id="L420">                confirmRemovePlugin();</span>
            }
<span class="nc" id="L422">            return true;</span>
        }
<span class="nc" id="L424">        return super.onOptionsItemSelected(item);</span>
    }

    @Override
    public void onSaveInstanceState(@NotNull Bundle outState) {
<span class="nc" id="L429">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L430">        outState.putSerializable(WordPress.SITE, mSite);</span>
<span class="nc" id="L431">        outState.putString(KEY_PLUGIN_SLUG, mSlug);</span>
<span class="nc" id="L432">        outState.putBoolean(KEY_IS_CONFIGURING_PLUGIN, mIsConfiguringPlugin);</span>
<span class="nc" id="L433">        outState.putBoolean(KEY_IS_INSTALLING_PLUGIN, mIsInstallingPlugin);</span>
<span class="nc" id="L434">        outState.putBoolean(KEY_IS_UPDATING_PLUGIN, mIsUpdatingPlugin);</span>
<span class="nc" id="L435">        outState.putBoolean(KEY_IS_REMOVING_PLUGIN, mIsRemovingPlugin);</span>
<span class="nc" id="L436">        outState.putBoolean(KEY_IS_ACTIVE, mIsActive);</span>
<span class="nc" id="L437">        outState.putBoolean(KEY_IS_AUTO_UPDATE_ENABLED, mIsAutoUpdateEnabled);</span>
<span class="nc" id="L438">        outState.putBoolean(KEY_IS_SHOWING_REMOVE_PLUGIN_CONFIRMATION_DIALOG, mIsShowingRemovePluginConfirmationDialog);</span>
<span class="nc" id="L439">        outState.putBoolean(KEY_IS_SHOWING_INSTALL_FIRST_PLUGIN_CONFIRMATION_DIALOG,</span>
                mIsShowingInstallFirstPluginConfirmationDialog);
<span class="nc" id="L441">        outState.putBoolean(KEY_IS_SHOWING_AUTOMATED_TRANSFER_PROGRESS, mIsShowingAutomatedTransferProgress);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">        outState.putBoolean(KEY_IS_SHOWING_DOMAIN_CREDIT_CHECK_PROGRESS,</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                mCheckingDomainCreditsProgressDialog != null &amp;&amp; mCheckingDomainCreditsProgressDialog.isShowing());</span>
<span class="nc" id="L444">        outState.putInt(KEY_PLUGIN_RECHECKED_TIMES, mPluginReCheckTimer);</span>
<span class="nc" id="L445">    }</span>

    // UI Helpers

    private void setupViews() {
<span class="nc" id="L450">        mContainer = findViewById(R.id.plugin_detail_container);</span>
<span class="nc" id="L451">        mTitleTextView = findViewById(R.id.text_title);</span>
<span class="nc" id="L452">        mByLineTextView = findViewById(R.id.text_byline);</span>
<span class="nc" id="L453">        mVersionTopTextView = findViewById(R.id.plugin_version_top);</span>
<span class="nc" id="L454">        mVersionBottomTextView = findViewById(R.id.plugin_version_bottom);</span>
<span class="nc" id="L455">        mInstalledText = findViewById(R.id.plugin_installed);</span>
<span class="nc" id="L456">        mUpdateButton = findViewById(R.id.plugin_btn_update);</span>
<span class="nc" id="L457">        mInstallButton = findViewById(R.id.plugin_btn_install);</span>
<span class="nc" id="L458">        mSwitchActive = findViewById(R.id.plugin_state_active);</span>
<span class="nc" id="L459">        mSwitchAutoupdates = findViewById(R.id.plugin_state_autoupdates);</span>
<span class="nc" id="L460">        mImageBanner = findViewById(R.id.image_banner);</span>
<span class="nc" id="L461">        mImageIcon = findViewById(R.id.image_icon);</span>

<span class="nc" id="L463">        mWPOrgPluginDetailsContainer = findViewById(R.id.plugin_wp_org_details_container);</span>
<span class="nc" id="L464">        mRatingsSectionContainer = findViewById(R.id.plugin_ratings_section_container);</span>

<span class="nc" id="L466">        mDescriptionTextView = findViewById(R.id.plugin_description_text);</span>
<span class="nc" id="L467">        mDescriptionChevron = findViewById(R.id.plugin_description_chevron);</span>
<span class="nc" id="L468">        findViewById(R.id.plugin_description_container).setOnClickListener(</span>
<span class="nc" id="L469">                v -&gt; toggleText(mDescriptionTextView, mDescriptionChevron));</span>

<span class="nc" id="L471">        mInstallationTextView = findViewById(R.id.plugin_installation_text);</span>
<span class="nc" id="L472">        mInstallationChevron = findViewById(R.id.plugin_installation_chevron);</span>
<span class="nc" id="L473">        findViewById(R.id.plugin_installation_container).setOnClickListener(</span>
<span class="nc" id="L474">                v -&gt; toggleText(mInstallationTextView, mInstallationChevron));</span>

<span class="nc" id="L476">        mWhatsNewTextView = findViewById(R.id.plugin_whatsnew_text);</span>
<span class="nc" id="L477">        mWhatsNewChevron = findViewById(R.id.plugin_whatsnew_chevron);</span>
<span class="nc" id="L478">        findViewById(R.id.plugin_whatsnew_container).setOnClickListener(</span>
<span class="nc" id="L479">                v -&gt; toggleText(mWhatsNewTextView, mWhatsNewChevron));</span>

        // expand description if this plugin isn't installed, otherwise expand &quot;what's new&quot; if
        // this is an installed plugin and there's an update available
<span class="nc bnc" id="L483" title="All 2 branches missed.">        if (mPlugin.isInstalled()) {</span>
<span class="nc" id="L484">            toggleText(mDescriptionTextView, mDescriptionChevron);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">        } else if (PluginUtils.isUpdateAvailable(mPlugin)) {</span>
<span class="nc" id="L486">            toggleText(mWhatsNewTextView, mWhatsNewChevron);</span>
        }

<span class="nc" id="L489">        mFaqTextView = findViewById(R.id.plugin_faq_text);</span>
<span class="nc" id="L490">        mFaqChevron = findViewById(R.id.plugin_faq_chevron);</span>
<span class="nc" id="L491">        findViewById(R.id.plugin_faq_container).setOnClickListener(v -&gt; toggleText(mFaqTextView, mFaqChevron));</span>

<span class="nc" id="L493">        findViewById(R.id.plugin_version_layout).setOnClickListener(v -&gt; showPluginInfoPopup());</span>

<span class="nc" id="L495">        mSwitchActive.setOnCheckedChangeListener((compoundButton, isChecked) -&gt; {</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">            if (compoundButton.isPressed()) {</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                if (NetworkUtils.checkConnection(PluginDetailActivity.this)) {</span>
<span class="nc" id="L498">                    mIsActive = isChecked;</span>
<span class="nc" id="L499">                    dispatchConfigurePluginAction(false);</span>
                } else {
<span class="nc" id="L501">                    compoundButton.setChecked(mIsActive);</span>
                }
            }
<span class="nc" id="L504">        });</span>

<span class="nc" id="L506">        mSwitchAutoupdates.setOnCheckedChangeListener((compoundButton, isChecked) -&gt; {</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            if (compoundButton.isPressed()) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                if (NetworkUtils.checkConnection(PluginDetailActivity.this)) {</span>
<span class="nc" id="L509">                    mIsAutoUpdateEnabled = isChecked;</span>
<span class="nc" id="L510">                    dispatchConfigurePluginAction(false);</span>
                } else {
<span class="nc" id="L512">                    compoundButton.setChecked(mIsAutoUpdateEnabled);</span>
                }
            }
<span class="nc" id="L515">        });</span>

<span class="nc" id="L517">        mUpdateButton.setOnClickListener(view -&gt; dispatchUpdatePluginAction());</span>

<span class="nc" id="L519">        mInstallButton.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">            if (isCustomDomainRequired()) {</span>
<span class="nc" id="L521">                showDomainCreditsCheckProgressDialog();</span>
<span class="nc" id="L522">                mDispatcher.dispatch(SiteActionBuilder.newFetchPlansAction(mSite));</span>
            } else {
<span class="nc" id="L524">                dispatchInstallPluginAction();</span>
            }
<span class="nc" id="L526">        });</span>

<span class="nc" id="L528">        View settingsView = findViewById(R.id.plugin_settings_page);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (canShowSettings()) {</span>
<span class="nc" id="L530">            settingsView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L531">            settingsView.setOnClickListener(v -&gt; openUrl(mPlugin.getSettingsUrl()));</span>
        } else {
<span class="nc" id="L533">            settingsView.setVisibility(View.GONE);</span>
        }

<span class="nc" id="L536">        findViewById(R.id.plugin_wp_org_page).setOnClickListener(view -&gt; openUrl(getWpOrgPluginUrl()));</span>

<span class="nc" id="L538">        findViewById(R.id.plugin_home_page).setOnClickListener(view -&gt; openUrl(mPlugin.getHomepageUrl()));</span>

<span class="nc" id="L540">        findViewById(R.id.read_reviews_container).setOnClickListener(view -&gt; openUrl(getWpOrgReviewsUrl()));</span>

        // set the height of the gradient scrim that appears atop the banner image
<span class="nc" id="L543">        int toolbarHeight = DisplayUtils.getActionBarHeight(this);</span>
<span class="nc" id="L544">        ImageView imgScrim = findViewById(R.id.image_gradient_scrim);</span>
<span class="nc" id="L545">        imgScrim.getLayoutParams().height = toolbarHeight * 2;</span>

<span class="nc" id="L547">        refreshViews();</span>
<span class="nc" id="L548">    }</span>

    private boolean isCustomDomainRequired() {
<span class="nc" id="L551">        return mSite.getUrl().contains(&quot;.wordpress.com&quot;);</span>
    }

    private void refreshViews() {
<span class="nc" id="L555">        View scrollView = findViewById(R.id.scroll_view);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (scrollView.getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L557">            AniUtils.fadeIn(scrollView, AniUtils.Duration.MEDIUM);</span>
        }

<span class="nc" id="L560">        mTitleTextView.setText(mPlugin.getDisplayName());</span>
<span class="nc" id="L561">        mImageManager.load(mImageBanner, ImageType.PHOTO, StringUtils.notNullStr(mPlugin.getBanner()),</span>
                ScaleType.CENTER_CROP);
<span class="nc" id="L563">        mImageManager.load(mImageIcon, ImageType.PLUGIN, StringUtils.notNullStr(mPlugin.getIcon()));</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">        if (mPlugin.doesHaveWPOrgPluginDetails()) {</span>
<span class="nc" id="L565">            mWPOrgPluginDetailsContainer.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L566">            setCollapsibleHtmlText(mDescriptionTextView, mPlugin.getDescriptionAsHtml());</span>
<span class="nc" id="L567">            setCollapsibleHtmlText(mInstallationTextView, mPlugin.getInstallationInstructionsAsHtml());</span>
<span class="nc" id="L568">            setCollapsibleHtmlText(mWhatsNewTextView, mPlugin.getWhatsNewAsHtml());</span>
<span class="nc" id="L569">            setCollapsibleHtmlText(mFaqTextView, mPlugin.getFaqAsHtml());</span>
        } else {
<span class="nc" id="L571">            mWPOrgPluginDetailsContainer.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L573">        mByLineTextView.setMovementMethod(WPLinkMovementMethod.getInstance());</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (!TextUtils.isEmpty(mPlugin.getAuthorAsHtml())) {</span>
<span class="nc" id="L575">            mByLineTextView.setText(Html.fromHtml(mPlugin.getAuthorAsHtml()));</span>
        } else {
<span class="nc" id="L577">            String authorName = mPlugin.getAuthorName();</span>
<span class="nc" id="L578">            String authorUrl = mPlugin.getAuthorUrl();</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">            if (TextUtils.isEmpty(authorUrl)) {</span>
<span class="nc" id="L580">                mByLineTextView.setText(String.format(getString(R.string.plugin_byline), authorName));</span>
            } else {
<span class="nc" id="L582">                String authorLink = &quot;&lt;a href='&quot; + authorUrl + &quot;'&gt;&quot; + authorName + &quot;&lt;/a&gt;&quot;;</span>
<span class="nc" id="L583">                String byline = String.format(getString(R.string.plugin_byline), authorLink);</span>
<span class="nc" id="L584">                mByLineTextView.setMovementMethod(WPLinkMovementMethod.getInstance());</span>
<span class="nc" id="L585">                mByLineTextView.setText(Html.fromHtml(byline));</span>
            }
        }

<span class="nc" id="L589">        findViewById(R.id.plugin_card_site)</span>
<span class="nc bnc" id="L590" title="All 4 branches missed.">                .setVisibility(mPlugin.isInstalled() &amp;&amp; isNotAutoManaged() ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L591">        findViewById(R.id.plugin_state_active_container)</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                .setVisibility(canPluginBeDisabledOrRemoved() ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L593">        findViewById(R.id.plugin_state_autoupdates_container)</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">                .setVisibility(mSite.isAutomatedTransfer() ? View.GONE : View.VISIBLE);</span>
<span class="nc" id="L595">        mSwitchActive.setChecked(mIsActive);</span>
<span class="nc" id="L596">        mSwitchAutoupdates.setChecked(mIsAutoUpdateEnabled);</span>

<span class="nc" id="L598">        refreshPluginVersionViews();</span>
<span class="nc" id="L599">        refreshRatingsViews();</span>
<span class="nc" id="L600">    }</span>

    private void setCollapsibleHtmlText(@NonNull TextView textView, @Nullable String htmlText) {
<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (!TextUtils.isEmpty(htmlText)) {</span>
<span class="nc" id="L604">            textView.setTextColor(ContextExtensionsKt.getColorFromAttribute(this, R.attr.colorOnSurface));</span>
<span class="nc" id="L605">            textView.setMovementMethod(WPLinkMovementMethod.getInstance());</span>
<span class="nc" id="L606">            textView.setText(Html.fromHtml(htmlText));</span>
        } else {
<span class="nc" id="L608">            textView.setTextColor(</span>
<span class="nc" id="L609">                    ContextExtensionsKt.getColorStateListFromAttribute(this, R.attr.wpColorOnSurfaceMedium));</span>
<span class="nc" id="L610">            textView.setText(R.string.plugin_empty_text);</span>
        }
<span class="nc" id="L612">    }</span>

    private void refreshPluginVersionViews() {
<span class="nc bnc" id="L615" title="All 2 branches missed.">        String pluginVersion = TextUtils.isEmpty(mPlugin.getInstalledVersion()) ? &quot;?&quot; : mPlugin.getInstalledVersion();</span>
<span class="nc" id="L616">        String availableVersion = mPlugin.getWPOrgPluginVersion();</span>
<span class="nc" id="L617">        String versionTopText = &quot;&quot;;</span>
<span class="nc" id="L618">        String versionBottomText = &quot;&quot;;</span>
<span class="nc bnc" id="L619" title="All 4 branches missed.">        if (mPlugin.isInstalled() &amp;&amp; isNotAutoManaged()) {</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">            if (PluginUtils.isUpdateAvailable(mPlugin)) {</span>
<span class="nc" id="L621">                versionTopText = String.format(getString(R.string.plugin_available_version), availableVersion);</span>
<span class="nc" id="L622">                versionBottomText = String.format(getString(R.string.plugin_installed_version), pluginVersion);</span>
            } else {
<span class="nc" id="L624">                versionTopText = String.format(getString(R.string.plugin_version), pluginVersion);</span>
            }
<span class="nc bnc" id="L626" title="All 2 branches missed.">        } else if (!TextUtils.isEmpty(availableVersion)) {</span>
<span class="nc" id="L627">            versionTopText = String.format(getString(R.string.plugin_version), availableVersion);</span>
        }
<span class="nc" id="L629">        mVersionTopTextView.setText(versionTopText);</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">        mVersionBottomTextView.setVisibility(TextUtils.isEmpty(versionBottomText) ? View.GONE : View.VISIBLE);</span>
<span class="nc" id="L631">        mVersionBottomTextView.setText(versionBottomText);</span>

<span class="nc" id="L633">        refreshUpdateVersionViews();</span>
<span class="nc" id="L634">    }</span>

    private void refreshUpdateVersionViews() {
<span class="nc bnc" id="L637" title="All 2 branches missed.">        if (mPlugin.isInstalled()) {</span>
<span class="nc" id="L638">            mInstallButton.setVisibility(View.GONE);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">            if (isNotAutoManaged()) {</span>
<span class="nc" id="L640">                boolean isUpdateAvailable = PluginUtils.isUpdateAvailable(mPlugin);</span>
<span class="nc bnc" id="L641" title="All 4 branches missed.">                boolean canUpdate = isUpdateAvailable &amp;&amp; !mIsUpdatingPlugin;</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">                mUpdateButton.setVisibility(canUpdate ? View.VISIBLE : View.GONE);</span>
<span class="nc bnc" id="L643" title="All 4 branches missed.">                mInstalledText.setVisibility(isUpdateAvailable || mIsUpdatingPlugin ? View.GONE : View.VISIBLE);</span>
<span class="nc" id="L644">            } else {</span>
<span class="nc" id="L645">                mUpdateButton.setVisibility(View.GONE);</span>
<span class="nc" id="L646">                mInstalledText.setVisibility(View.GONE);</span>
            }
        } else {
<span class="nc" id="L649">            mUpdateButton.setVisibility(View.GONE);</span>
<span class="nc" id="L650">            mInstalledText.setVisibility(View.GONE);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            mInstallButton.setVisibility(mIsInstallingPlugin ? View.GONE : View.VISIBLE);</span>
        }

<span class="nc bnc" id="L654" title="All 4 branches missed.">        findViewById(R.id.plugin_update_progress_bar).setVisibility(mIsUpdatingPlugin || mIsInstallingPlugin</span>
<span class="nc" id="L655">                ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L656">    }</span>

    private void refreshRatingsViews() {
<span class="nc bnc" id="L659" title="All 2 branches missed.">        if (!mPlugin.doesHaveWPOrgPluginDetails()) {</span>
<span class="nc" id="L660">            mRatingsSectionContainer.setVisibility(View.GONE);</span>
<span class="nc" id="L661">            return;</span>
        }
<span class="nc" id="L663">        mRatingsSectionContainer.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L664">        int numRatingsTotal = mPlugin.getNumberOfRatings();</span>

<span class="nc" id="L666">        TextView txtNumRatings = findViewById(R.id.text_num_ratings);</span>
<span class="nc" id="L667">        String numRatings = FormatUtils.formatInt(numRatingsTotal);</span>
<span class="nc" id="L668">        txtNumRatings.setText(String.format(getString(R.string.plugin_num_ratings), numRatings));</span>

<span class="nc" id="L670">        TextView txtNumDownloads = findViewById(R.id.text_num_downloads);</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">        if (mPlugin.getDownloadCount() &gt; 0) {</span>
<span class="nc" id="L672">            String numDownloads = FormatUtils.formatInt(mPlugin.getDownloadCount());</span>
<span class="nc" id="L673">            txtNumDownloads.setText(String.format(getString(R.string.plugin_num_downloads), numDownloads));</span>
<span class="nc" id="L674">        } else {</span>
<span class="nc" id="L675">            txtNumDownloads.setText(&quot;&quot;);</span>
        }

<span class="nc" id="L678">        setRatingsProgressBar(R.id.progress5, mPlugin.getNumberOfRatingsOfFive(), numRatingsTotal);</span>
<span class="nc" id="L679">        setRatingsProgressBar(R.id.progress4, mPlugin.getNumberOfRatingsOfFour(), numRatingsTotal);</span>
<span class="nc" id="L680">        setRatingsProgressBar(R.id.progress3, mPlugin.getNumberOfRatingsOfThree(), numRatingsTotal);</span>
<span class="nc" id="L681">        setRatingsProgressBar(R.id.progress2, mPlugin.getNumberOfRatingsOfTwo(), numRatingsTotal);</span>
<span class="nc" id="L682">        setRatingsProgressBar(R.id.progress1, mPlugin.getNumberOfRatingsOfOne(), numRatingsTotal);</span>

<span class="nc" id="L684">        RatingBar ratingBar = findViewById(R.id.rating_bar);</span>
<span class="nc" id="L685">        ratingBar.setRating(mPlugin.getAverageStarRating());</span>
<span class="nc" id="L686">    }</span>

    private void setRatingsProgressBar(@IdRes int progressResId, int numRatingsForStar, int numRatingsTotal) {
<span class="nc" id="L689">        ProgressBar bar = findViewById(progressResId);</span>
<span class="nc" id="L690">        bar.setMax(numRatingsTotal);</span>
<span class="nc" id="L691">        bar.setProgress(numRatingsForStar);</span>
<span class="nc" id="L692">    }</span>

    private static final String KEY_LABEL = &quot;label&quot;;
    private static final String KEY_TEXT = &quot;text&quot;;

    private String timespanFromUpdateDate(@NonNull String lastUpdated) {
        // ex: 2017-12-13 2:55pm GMT
<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (lastUpdated.endsWith(&quot; GMT&quot;)) {</span>
<span class="nc" id="L700">            lastUpdated = lastUpdated.substring(0, lastUpdated.length() - 4);</span>
        }
<span class="nc" id="L702">        DateFormat formatter = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm&quot;, Locale.US);</span>
        try {
<span class="nc" id="L704">            formatter.setTimeZone(TimeZone.getTimeZone(&quot;UTC&quot;));</span>
<span class="nc" id="L705">            Date date = formatter.parse(lastUpdated);</span>
<span class="nc" id="L706">            return DateTimeUtils.javaDateToTimeSpan(date, this);</span>
<span class="nc" id="L707">        } catch (ParseException var2) {</span>
<span class="nc" id="L708">            return &quot;?&quot;;</span>
        }
    }

    protected void showPluginInfoPopup() {
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if (!mPlugin.doesHaveWPOrgPluginDetails()) {</span>
<span class="nc" id="L714">            return;</span>
        }

<span class="nc" id="L717">        List&lt;Map&lt;String, String&gt;&gt; data = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L718">        int[] to = {R.id.text1, R.id.text2};</span>
<span class="nc" id="L719">        String[] from = {KEY_LABEL, KEY_TEXT};</span>
<span class="nc" id="L720">        String[] labels = {</span>
<span class="nc" id="L721">                getString(R.string.plugin_info_version),</span>
<span class="nc" id="L722">                getString(R.string.plugin_info_lastupdated),</span>
<span class="nc" id="L723">                getString(R.string.plugin_info_requires_version),</span>
<span class="nc" id="L724">                getString(R.string.plugin_info_your_version)</span>
        };

<span class="nc" id="L727">        Map&lt;String, String&gt; mapVersion = new HashMap&lt;&gt;();</span>
<span class="nc" id="L728">        mapVersion.put(KEY_LABEL, labels[0]);</span>
<span class="nc" id="L729">        mapVersion.put(KEY_TEXT, StringUtils.notNullStr(mPlugin.getWPOrgPluginVersion()));</span>
<span class="nc" id="L730">        data.add(mapVersion);</span>

<span class="nc" id="L732">        Map&lt;String, String&gt; mapUpdated = new HashMap&lt;&gt;();</span>
<span class="nc" id="L733">        mapUpdated.put(KEY_LABEL, labels[1]);</span>
<span class="nc" id="L734">        mapUpdated</span>
<span class="nc" id="L735">                .put(KEY_TEXT, timespanFromUpdateDate(StringUtils.notNullStr(mPlugin.getLastUpdatedForWPOrgPlugin())));</span>
<span class="nc" id="L736">        data.add(mapUpdated);</span>

<span class="nc" id="L738">        Map&lt;String, String&gt; mapRequiredVer = new HashMap&lt;&gt;();</span>
<span class="nc" id="L739">        mapRequiredVer.put(KEY_LABEL, labels[2]);</span>
<span class="nc" id="L740">        mapRequiredVer.put(KEY_TEXT, StringUtils.notNullStr(mPlugin.getRequiredWordPressVersion()));</span>
<span class="nc" id="L741">        data.add(mapRequiredVer);</span>

<span class="nc" id="L743">        Map&lt;String, String&gt; mapThisVer = new HashMap&lt;&gt;();</span>
<span class="nc" id="L744">        mapThisVer.put(KEY_LABEL, labels[3]);</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">        mapThisVer.put(KEY_TEXT, !TextUtils.isEmpty(mSite.getSoftwareVersion()) ? mSite.getSoftwareVersion() : &quot;?&quot;);</span>
<span class="nc" id="L746">        data.add(mapThisVer);</span>

<span class="nc" id="L748">        SimpleAdapter adapter = new SimpleAdapter(this,</span>
                data,
                R.layout.plugin_info_row,
                from,
                to);

<span class="nc" id="L754">        AlertDialog.Builder builder = new MaterialAlertDialogBuilder(this);</span>
<span class="nc" id="L755">        builder.setCancelable(true);</span>
<span class="nc" id="L756">        builder.setAdapter(adapter, (dialog, which) -&gt; dialog.dismiss());</span>
<span class="nc" id="L757">        builder.show();</span>
<span class="nc" id="L758">    }</span>

    protected void toggleText(@NonNull final TextView textView, @NonNull ImageView chevron) {
<span class="nc" id="L761">        AniUtils.Duration duration = AniUtils.Duration.SHORT;</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">        boolean isExpanded = textView.getVisibility() == View.VISIBLE;</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">        if (isExpanded) {</span>
<span class="nc" id="L764">            AniUtils.fadeOut(textView, duration);</span>
        } else {
<span class="nc" id="L766">            AniUtils.fadeIn(textView, duration);</span>
        }

<span class="nc bnc" id="L769" title="All 2 branches missed.">        float startRotate = isExpanded ? -180f : 0f;</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">        float endRotate = isExpanded ? 0f : -180f;</span>
<span class="nc" id="L771">        ObjectAnimator animRotate = ObjectAnimator.ofFloat(chevron, View.ROTATION, startRotate, endRotate);</span>
<span class="nc" id="L772">        animRotate.setDuration(duration.toMillis(this));</span>
<span class="nc" id="L773">        animRotate.start();</span>
<span class="nc" id="L774">    }</span>

    protected void openUrl(@Nullable String url) {
<span class="nc bnc" id="L777" title="All 2 branches missed.">        if (url != null) {</span>
<span class="nc" id="L778">            ActivityLauncher.openUrlExternal(this, url);</span>
        }
<span class="nc" id="L780">    }</span>

    private void confirmRemovePlugin() {
<span class="nc" id="L783">        AlertDialog.Builder builder = new MaterialAlertDialogBuilder(this);</span>
<span class="nc" id="L784">        builder.setTitle(getResources().getText(R.string.plugin_remove_dialog_title));</span>
<span class="nc" id="L785">        String confirmationMessage = getString(R.string.plugin_remove_dialog_message,</span>
<span class="nc" id="L786">                mPlugin.getDisplayName(),</span>
<span class="nc" id="L787">                SiteUtils.getSiteNameOrHomeURL(mSite));</span>
<span class="nc" id="L788">        builder.setMessage(confirmationMessage);</span>
<span class="nc" id="L789">        builder.setPositiveButton(R.string.remove, (dialogInterface, i) -&gt; {</span>
<span class="nc" id="L790">            mIsShowingRemovePluginConfirmationDialog = false;</span>
<span class="nc" id="L791">            disableAndRemovePlugin();</span>
<span class="nc" id="L792">        });</span>
<span class="nc" id="L793">        builder.setNegativeButton(R.string.cancel,</span>
<span class="nc" id="L794">                (dialogInterface, i) -&gt; mIsShowingRemovePluginConfirmationDialog = false);</span>
<span class="nc" id="L795">        builder.setOnCancelListener(dialogInterface -&gt; mIsShowingRemovePluginConfirmationDialog = false);</span>
<span class="nc" id="L796">        builder.setCancelable(true);</span>
<span class="nc" id="L797">        builder.create();</span>
<span class="nc" id="L798">        mIsShowingRemovePluginConfirmationDialog = true;</span>
<span class="nc" id="L799">        builder.show();</span>
<span class="nc" id="L800">    }</span>

    private void showSuccessfulUpdateSnackbar() {
<span class="nc" id="L803">        WPSnackbar.make(mContainer,</span>
<span class="nc" id="L804">                getString(R.string.plugin_updated_successfully, mPlugin.getDisplayName()),</span>
                Snackbar.LENGTH_LONG)
<span class="nc" id="L806">                  .show();</span>
<span class="nc" id="L807">    }</span>

    private void showSuccessfulInstallSnackbar() {
<span class="nc" id="L810">        WPSnackbar.make(mContainer,</span>
<span class="nc" id="L811">                getString(R.string.plugin_installed_successfully, mPlugin.getDisplayName()),</span>
                Snackbar.LENGTH_LONG)
<span class="nc" id="L813">                  .show();</span>
<span class="nc" id="L814">    }</span>

    private void showSuccessfulPluginRemovedSnackbar(String pluginDisplayName) {
<span class="nc" id="L817">        WPSnackbar.make(mContainer,</span>
<span class="nc" id="L818">                getString(R.string.plugin_removed_successfully, pluginDisplayName),</span>
                Snackbar.LENGTH_LONG)
<span class="nc" id="L820">                  .show();</span>
<span class="nc" id="L821">    }</span>

    private void showUpdateFailedSnackbar() {
<span class="nc" id="L824">        WPSnackbar.make(mContainer,</span>
<span class="nc" id="L825">                getString(R.string.plugin_updated_failed, mPlugin.getDisplayName()), Snackbar.LENGTH_LONG)</span>
<span class="nc" id="L826">                  .setAction(R.string.retry, view -&gt; dispatchUpdatePluginAction())</span>
<span class="nc" id="L827">                  .show();</span>
<span class="nc" id="L828">    }</span>

    private void showInstallFailedSnackbar() {
<span class="nc" id="L831">        WPSnackbar.make(mContainer,</span>
<span class="nc" id="L832">                getString(R.string.plugin_installed_failed, mPlugin.getDisplayName()), Snackbar.LENGTH_LONG)</span>
<span class="nc" id="L833">                  .setAction(R.string.retry, view -&gt; dispatchInstallPluginAction())</span>
<span class="nc" id="L834">                  .show();</span>
<span class="nc" id="L835">    }</span>

    private void showPluginRemoveFailedSnackbar() {
<span class="nc" id="L838">        WPSnackbar.make(mContainer,</span>
<span class="nc" id="L839">                getString(R.string.plugin_remove_failed, mPlugin.getDisplayName()),</span>
                Snackbar.LENGTH_LONG)
<span class="nc" id="L841">                  .show();</span>
<span class="nc" id="L842">    }</span>

    private void showDomainCreditsCheckProgressDialog() {
<span class="nc bnc" id="L845" title="All 2 branches missed.">        if (mCheckingDomainCreditsProgressDialog == null) {</span>
<span class="nc" id="L846">            mCheckingDomainCreditsProgressDialog = new ProgressDialog(this);</span>
<span class="nc" id="L847">            mCheckingDomainCreditsProgressDialog.setCancelable(true);</span>
<span class="nc" id="L848">            mCheckingDomainCreditsProgressDialog.setIndeterminate(true);</span>

<span class="nc" id="L850">            mCheckingDomainCreditsProgressDialog</span>
<span class="nc" id="L851">                    .setMessage(getString(R.string.plugin_check_domain_credits_progress_dialog_message));</span>
        }
<span class="nc bnc" id="L853" title="All 2 branches missed.">        if (!mCheckingDomainCreditsProgressDialog.isShowing()) {</span>
<span class="nc" id="L854">            mCheckingDomainCreditsProgressDialog.show();</span>
        }
<span class="nc" id="L856">    }</span>

    private void cancelDomainCreditsCheckProgressDialog() {
<span class="nc bnc" id="L859" title="All 4 branches missed.">        if (mCheckingDomainCreditsProgressDialog != null &amp;&amp; mCheckingDomainCreditsProgressDialog.isShowing()) {</span>
<span class="nc" id="L860">            mCheckingDomainCreditsProgressDialog.cancel();</span>
        }
<span class="nc" id="L862">    }</span>

    private void showRemovePluginProgressDialog() {
<span class="nc bnc" id="L865" title="All 2 branches missed.">        if (mRemovePluginProgressDialog == null) {</span>
<span class="nc" id="L866">            mRemovePluginProgressDialog = new ProgressDialog(this);</span>
<span class="nc" id="L867">            mRemovePluginProgressDialog.setCancelable(false);</span>
<span class="nc" id="L868">            mRemovePluginProgressDialog.setIndeterminate(true);</span>
            // Even though we are deactivating the plugin to make sure it's disabled on the server side, since the user
            // sees that the plugin is disabled, it'd be confusing to say we are disabling the plugin
<span class="nc bnc" id="L871" title="All 2 branches missed.">            String message = mIsActive</span>
<span class="nc" id="L872">                    ? getString(R.string.plugin_disable_progress_dialog_message, mPlugin.getDisplayName())</span>
<span class="nc" id="L873">                    : getRemovingPluginMessage();</span>
<span class="nc" id="L874">            mRemovePluginProgressDialog.setMessage(message);</span>
        }
<span class="nc bnc" id="L876" title="All 2 branches missed.">        if (!mRemovePluginProgressDialog.isShowing()) {</span>
<span class="nc" id="L877">            mRemovePluginProgressDialog.show();</span>
        }
<span class="nc" id="L879">    }</span>

    private void cancelRemovePluginProgressDialog() {
<span class="nc bnc" id="L882" title="All 4 branches missed.">        if (mRemovePluginProgressDialog != null &amp;&amp; mRemovePluginProgressDialog.isShowing()) {</span>
<span class="nc" id="L883">            mRemovePluginProgressDialog.cancel();</span>
        }
<span class="nc" id="L885">    }</span>

    // Network Helpers

    protected void dispatchConfigurePluginAction(boolean forceUpdate) {
<span class="nc bnc" id="L890" title="All 2 branches missed.">        if (!NetworkUtils.isNetworkAvailable(this)) {</span>
<span class="nc" id="L891">            return;</span>
        }
<span class="nc bnc" id="L893" title="All 4 branches missed.">        if (!forceUpdate &amp;&amp; mIsConfiguringPlugin) {</span>
<span class="nc" id="L894">            return;</span>
        }
<span class="nc bnc" id="L896" title="All 2 branches missed.">        if (!mPlugin.isInstalled()) {</span>
<span class="nc" id="L897">            return;</span>
        }
<span class="nc" id="L899">        mIsConfiguringPlugin = true;</span>
<span class="nc" id="L900">        mDispatcher.dispatch(PluginActionBuilder.newConfigureSitePluginAction(</span>
<span class="nc" id="L901">                new ConfigureSitePluginPayload(mSite, mPlugin.getName(), mPlugin.getSlug(),</span>
                        mIsActive, mIsAutoUpdateEnabled)));
<span class="nc" id="L903">    }</span>

    protected void dispatchUpdatePluginAction() {
<span class="nc bnc" id="L906" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(this)) {</span>
<span class="nc" id="L907">            return;</span>
        }
<span class="nc bnc" id="L909" title="All 4 branches missed.">        if (!PluginUtils.isUpdateAvailable(mPlugin) || mIsUpdatingPlugin) {</span>
<span class="nc" id="L910">            return;</span>
        }

<span class="nc" id="L913">        mIsUpdatingPlugin = true;</span>
<span class="nc" id="L914">        refreshUpdateVersionViews();</span>
<span class="nc" id="L915">        UpdateSitePluginPayload payload = new UpdateSitePluginPayload(mSite, mPlugin.getName(), mPlugin.getSlug());</span>
<span class="nc" id="L916">        mDispatcher.dispatch(PluginActionBuilder.newUpdateSitePluginAction(payload));</span>
<span class="nc" id="L917">    }</span>

    protected void dispatchInstallPluginAction() {
<span class="nc bnc" id="L920" title="All 6 branches missed.">        if (!NetworkUtils.checkConnection(this) || mPlugin.isInstalled() || mIsInstallingPlugin) {</span>
<span class="nc" id="L921">            return;</span>
        }

<span class="nc bnc" id="L924" title="All 2 branches missed.">        if (SiteUtils.isNonAtomicBusinessPlanSite(mSite)) {</span>
<span class="nc" id="L925">            confirmInstallPluginForAutomatedTransfer();</span>
        } else {
<span class="nc" id="L927">            mIsInstallingPlugin = true;</span>
<span class="nc" id="L928">            refreshUpdateVersionViews();</span>

<span class="nc" id="L930">            InstallSitePluginPayload payload = new InstallSitePluginPayload(mSite, mSlug);</span>
<span class="nc" id="L931">            mDispatcher.dispatch(PluginActionBuilder.newInstallSitePluginAction(payload));</span>
        }
<span class="nc" id="L933">    }</span>

    protected void dispatchRemovePluginAction() {
<span class="nc bnc" id="L936" title="All 2 branches missed.">        if (!NetworkUtils.checkConnection(this)) {</span>
<span class="nc" id="L937">            return;</span>
        }
<span class="nc" id="L939">        mRemovePluginProgressDialog.setMessage(getRemovingPluginMessage());</span>
<span class="nc" id="L940">        DeleteSitePluginPayload payload = new DeleteSitePluginPayload(mSite, mPlugin.getName(), mSlug);</span>
<span class="nc" id="L941">        mDispatcher.dispatch(PluginActionBuilder.newDeleteSitePluginAction(payload));</span>
<span class="nc" id="L942">    }</span>

    protected void disableAndRemovePlugin() {
        // This is only a sanity check as the remove button should not be visible. It's important to disable removing
        // plugins in certain cases, so we should still make this sanity check
<span class="nc bnc" id="L947" title="All 2 branches missed.">        if (!canPluginBeDisabledOrRemoved()) {</span>
<span class="nc" id="L948">            return;</span>
        }
        // We need to make sure that plugin is disabled before attempting to remove it
<span class="nc" id="L951">        mIsRemovingPlugin = true;</span>
<span class="nc" id="L952">        showRemovePluginProgressDialog();</span>
<span class="nc" id="L953">        mIsActive = false;</span>
<span class="nc" id="L954">        dispatchConfigurePluginAction(false);</span>
<span class="nc" id="L955">    }</span>

    // FluxC callbacks

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSitePluginConfigured(OnSitePluginConfigured event) {
<span class="nc bnc" id="L962" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L963">            return;</span>
        }

<span class="nc bnc" id="L966" title="All 2 branches missed.">        if (!shouldHandleFluxCSitePluginEvent(event.site, event.pluginName)) {</span>
<span class="nc" id="L967">            return;</span>
        }

<span class="nc" id="L970">        mIsConfiguringPlugin = false;</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">        if (event.isError()) {</span>
            // The plugin was already removed in remote, there is no need to show an error to the user
<span class="nc bnc" id="L973" title="All 4 branches missed.">            if (mIsRemovingPlugin</span>
                &amp;&amp; event.error.type == PluginStore.ConfigureSitePluginErrorType.UNKNOWN_PLUGIN) {
                // We still need to dispatch the remove plugin action to remove the local copy
                // and complete the flow gracefully. We can ignore `!mSitePlugin.isActive()` check here since the
                // plugin is not installed anymore on remote
<span class="nc" id="L978">                dispatchRemovePluginAction();</span>
<span class="nc" id="L979">                return;</span>
            }

<span class="nc" id="L982">            ToastUtils.showToast(this, getString(R.string.plugin_configuration_failed, event.error.message));</span>

            // Refresh the UI to plugin's last known state
<span class="nc" id="L985">            refreshPluginFromStore();</span>
<span class="nc" id="L986">            mIsActive = mPlugin.isActive();</span>
<span class="nc" id="L987">            mIsAutoUpdateEnabled = mPlugin.isAutoUpdateEnabled();</span>
<span class="nc" id="L988">            refreshViews();</span>

<span class="nc bnc" id="L990" title="All 2 branches missed.">            if (mIsRemovingPlugin) {</span>
<span class="nc" id="L991">                mIsRemovingPlugin = false;</span>
<span class="nc" id="L992">                cancelRemovePluginProgressDialog();</span>
<span class="nc" id="L993">                showPluginRemoveFailedSnackbar();</span>
            }
<span class="nc" id="L995">            return;</span>
        }

        // Sanity check
<span class="nc" id="L999">        ImmutablePluginModel configuredPlugin = mPluginStore.getImmutablePluginBySlug(mSite, mSlug);</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">        if (configuredPlugin == null) {</span>
<span class="nc" id="L1001">            ToastUtils.showToast(this, R.string.plugin_not_found);</span>
<span class="nc" id="L1002">            finish();</span>
<span class="nc" id="L1003">            return;</span>
        }
        // Before refreshing the plugin from store, check the changes and track them
<span class="nc bnc" id="L1006" title="All 2 branches missed.">        if (mPlugin.isActive() != configuredPlugin.isActive()) {</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">            Stat stat = configuredPlugin.isActive() ? Stat.PLUGIN_ACTIVATED : Stat.PLUGIN_DEACTIVATED;</span>
<span class="nc" id="L1008">            AnalyticsUtils.trackWithSiteDetails(stat, mSite);</span>
        }
<span class="nc bnc" id="L1010" title="All 2 branches missed.">        if (mPlugin.isAutoUpdateEnabled() != configuredPlugin.isAutoUpdateEnabled()) {</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">            Stat stat = configuredPlugin.isAutoUpdateEnabled()</span>
<span class="nc" id="L1012">                    ? Stat.PLUGIN_AUTOUPDATE_ENABLED</span>
<span class="nc" id="L1013">                    : Stat.PLUGIN_AUTOUPDATE_DISABLED;</span>
<span class="nc" id="L1014">            AnalyticsUtils.trackWithSiteDetails(stat, mSite);</span>
        }
        // Now we can update the plugin with the new one from store
<span class="nc" id="L1017">        mPlugin = configuredPlugin;</span>

        // The plugin state has been changed while a configuration network call is going on, we need to dispatch another
        // configure plugin action since we don't allow multiple configure actions to happen at the same time
        // This might happen either because user changed the state or a remove plugin action has started
<span class="nc bnc" id="L1022" title="All 2 branches missed.">        if (isPluginStateChangedSinceLastConfigurationDispatch()) {</span>
            // The plugin's state in UI has priority over the one in DB as we'll dispatch another configuration change
            // to make sure UI is reflected correctly in network and DB
<span class="nc" id="L1025">            dispatchConfigurePluginAction(false);</span>
<span class="nc bnc" id="L1026" title="All 4 branches missed.">        } else if (mIsRemovingPlugin &amp;&amp; !mPlugin.isActive()) {</span>
            // We don't want to trigger the remove plugin action before configuration changes are reflected in network
<span class="nc" id="L1028">            dispatchRemovePluginAction();</span>

            // The plugin should be disabled if it was active, we should show that to the user
<span class="nc" id="L1031">            mIsActive = mPlugin.isActive();</span>
<span class="nc" id="L1032">            mSwitchActive.setChecked(mIsActive);</span>
        }
<span class="nc" id="L1034">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onWPOrgPluginFetched(OnWPOrgPluginFetched event) {
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1040">            return;</span>
        }

<span class="nc bnc" id="L1043" title="All 2 branches missed.">        if (!mSlug.equals(event.pluginSlug)) {</span>
            // another plugin fetched, no need to handle it
<span class="nc" id="L1045">            return;</span>
        }

<span class="nc bnc" id="L1048" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1049">            AppLog.e(T.PLUGINS, &quot;An error occurred while fetching wporg plugin&quot; + event.pluginSlug</span>
                                + &quot; with type: &quot; + event.error.type);
        } else {
<span class="nc" id="L1052">            refreshPluginFromStore();</span>
<span class="nc" id="L1053">            refreshViews();</span>
        }
<span class="nc" id="L1055">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSitePluginUpdated(OnSitePluginUpdated event) {
<span class="nc bnc" id="L1060" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1061">            return;</span>
        }

<span class="nc bnc" id="L1064" title="All 2 branches missed.">        if (!shouldHandleFluxCSitePluginEvent(event.site, event.pluginName)) {</span>
<span class="nc" id="L1065">            return;</span>
        }

<span class="nc" id="L1068">        mIsUpdatingPlugin = false;</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1070">            AppLog.e(T.PLUGINS, &quot;An error occurred while updating the plugin with type: &quot;</span>
                                + event.error.type + &quot; and message: &quot; + event.error.message);
<span class="nc" id="L1072">            refreshPluginVersionViews();</span>
<span class="nc" id="L1073">            showUpdateFailedSnackbar();</span>
<span class="nc" id="L1074">            return;</span>
        }

<span class="nc" id="L1077">        refreshPluginFromStore();</span>
<span class="nc" id="L1078">        refreshViews();</span>
<span class="nc" id="L1079">        showSuccessfulUpdateSnackbar();</span>

<span class="nc" id="L1081">        AnalyticsUtils.trackWithSiteDetails(Stat.PLUGIN_UPDATED, mSite);</span>
<span class="nc" id="L1082">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSitePluginInstalled(OnSitePluginInstalled event) {
<span class="nc bnc" id="L1087" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1088">            return;</span>
        }

<span class="nc bnc" id="L1091" title="All 4 branches missed.">        if (mSite.getId() != event.site.getId() || !mSlug.equals(event.slug)) {</span>
            // Not the event we are interested in
<span class="nc" id="L1093">            return;</span>
        }

<span class="nc" id="L1096">        mIsInstallingPlugin = false;</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1098">            AppLog.e(T.PLUGINS, &quot;An error occurred while installing the plugin with type: &quot;</span>
                                + event.error.type + &quot; and message: &quot; + event.error.message);
<span class="nc" id="L1100">            refreshPluginVersionViews();</span>
<span class="nc" id="L1101">            showInstallFailedSnackbar();</span>
<span class="nc" id="L1102">            return;</span>
        }

<span class="nc" id="L1105">        mIsInstallingPlugin = false;</span>

<span class="nc" id="L1107">        refreshPluginFromStore();</span>

        // TODO: Handle activation and enabling auto-updates for AT first plugin
        // FluxC will try to activate and enable autoupdates for the plugin after it's installed, let's assume that
        // it'll be successful.
<span class="nc" id="L1112">        mIsActive = true;</span>
<span class="nc" id="L1113">        mIsAutoUpdateEnabled = true;</span>

<span class="nc" id="L1115">        refreshViews();</span>
<span class="nc" id="L1116">        showSuccessfulInstallSnackbar();</span>
<span class="nc" id="L1117">        invalidateOptionsMenu();</span>

<span class="nc" id="L1119">        AnalyticsUtils.trackWithSiteDetails(Stat.PLUGIN_INSTALLED, mSite);</span>
<span class="nc" id="L1120">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSitePluginDeleted(OnSitePluginDeleted event) {
<span class="nc bnc" id="L1125" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1126">            return;</span>
        }

<span class="nc bnc" id="L1129" title="All 2 branches missed.">        if (!shouldHandleFluxCSitePluginEvent(event.site, event.pluginName)) {</span>
<span class="nc" id="L1130">            return;</span>
        }

<span class="nc" id="L1133">        String pluginDisplayName = mPlugin.getDisplayName();</span>
<span class="nc" id="L1134">        mIsRemovingPlugin = false;</span>
<span class="nc" id="L1135">        cancelRemovePluginProgressDialog();</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1137">            AppLog.e(T.PLUGINS, &quot;An error occurred while removing the plugin with type: &quot;</span>
                                + event.error.type + &quot; and message: &quot; + event.error.message);
<span class="nc" id="L1139">            String toastMessage = getString(R.string.plugin_updated_failed_detailed,</span>
                    pluginDisplayName, event.error.message);
<span class="nc" id="L1141">            ToastUtils.showToast(this, toastMessage, Duration.LONG);</span>
<span class="nc" id="L1142">            return;</span>
        }
<span class="nc" id="L1144">        AnalyticsUtils.trackWithSiteDetails(Stat.PLUGIN_REMOVED, mSite);</span>

<span class="nc" id="L1146">        refreshPluginFromStore();</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">        if (mPlugin == null) {</span>
            // A plugin that doesn't exist in the directory is removed, go back to plugin list
<span class="nc" id="L1149">            finish();</span>
        } else {
            // Refresh the views to show wporg plugin details
<span class="nc" id="L1152">            refreshViews();</span>
<span class="nc" id="L1153">            invalidateOptionsMenu();</span>
        }
<span class="nc" id="L1155">        showSuccessfulPluginRemovedSnackbar(pluginDisplayName);</span>
<span class="nc" id="L1156">    }</span>

    // This check should only handle events for already installed plugins - onSitePluginConfigured,
    // onSitePluginUpdated, onSitePluginDeleted
    private boolean shouldHandleFluxCSitePluginEvent(SiteModel eventSite, String eventPluginName) {
<span class="nc bnc" id="L1161" title="All 2 branches missed.">        return mSite.getId() == eventSite.getId() // correct site</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">               &amp;&amp; mPlugin.isInstalled() // needs plugin to be already installed</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">               &amp;&amp; mPlugin.getName() != null // sanity check for NPE since if plugin is installed it'll have the name</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">               &amp;&amp; mPlugin.getName().equals(eventPluginName); // event is for the plugin we are showing</span>
    }

    // Utils

    private void refreshPluginFromStore() {
<span class="nc" id="L1170">        mPlugin = mPluginStore.getImmutablePluginBySlug(mSite, mSlug);</span>
<span class="nc" id="L1171">    }</span>

    protected String getWpOrgPluginUrl() {
<span class="nc" id="L1174">        return &quot;https://wordpress.org/plugins/&quot; + mSlug;</span>
    }

    protected String getWpOrgReviewsUrl() {
<span class="nc" id="L1178">        return &quot;https://wordpress.org/plugins/&quot; + mSlug + &quot;/#reviews&quot;;</span>
    }

    private String getRemovingPluginMessage() {
<span class="nc" id="L1182">        return getString(R.string.plugin_remove_progress_dialog_message, mPlugin.getDisplayName());</span>
    }

    private boolean canPluginBeDisabledOrRemoved() {
<span class="nc bnc" id="L1186" title="All 2 branches missed.">        if (!mPlugin.isInstalled()) {</span>
<span class="nc" id="L1187">            return false;</span>
        }

        // Disable removing jetpack as the site will stop working in the client
<span class="nc bnc" id="L1191" title="All 2 branches missed.">        if (PluginUtils.isJetpack(mPlugin)) {</span>
<span class="nc" id="L1192">            return false;</span>
        }
        // Disable removing for auto-managed AT sites
<span class="nc" id="L1195">        return isNotAutoManaged();</span>
    }

    // only show settings for active plugins on .org sites
    private boolean canShowSettings() {
<span class="nc bnc" id="L1200" title="All 2 branches missed.">        return mPlugin.isInstalled()</span>
<span class="nc bnc" id="L1201" title="All 2 branches missed.">               &amp;&amp; isNotAutoManaged()</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">               &amp;&amp; mPlugin.isActive()</span>
<span class="nc bnc" id="L1203" title="All 2 branches missed.">               &amp;&amp; !TextUtils.isEmpty(mPlugin.getSettingsUrl());</span>
    }

    private boolean isPluginStateChangedSinceLastConfigurationDispatch() {
<span class="nc bnc" id="L1207" title="All 2 branches missed.">        if (!mPlugin.isInstalled()) {</span>
<span class="nc" id="L1208">            return false;</span>
        }
<span class="nc bnc" id="L1210" title="All 4 branches missed.">        return mPlugin.isActive() != mIsActive || mPlugin.isAutoUpdateEnabled() != mIsAutoUpdateEnabled;</span>
    }

    // Automated Transfer

    /**
     * Automated Transfer starts by confirming that the user will not be able to use their site. We'll need to block the
     * UI for it, so we get a confirmation first in this step.
     */
    private void confirmInstallPluginForAutomatedTransfer() {
<span class="nc" id="L1220">        AlertDialog.Builder builder = new MaterialAlertDialogBuilder(this);</span>
<span class="nc" id="L1221">        builder.setTitle(getResources().getText(R.string.plugin_install_first_plugin_confirmation_dialog_title));</span>
<span class="nc" id="L1222">        builder.setMessage(R.string.plugin_install_first_plugin_confirmation_dialog_message);</span>
<span class="nc" id="L1223">        builder.setPositiveButton(R.string.plugin_install_first_plugin_confirmation_dialog_install_btn,</span>
                (dialogInterface, i) -&gt; {
<span class="nc" id="L1225">                    mIsShowingInstallFirstPluginConfirmationDialog = false;</span>
<span class="nc" id="L1226">                    startAutomatedTransfer();</span>
<span class="nc" id="L1227">                });</span>
<span class="nc" id="L1228">        builder.setNegativeButton(R.string.cancel, (dialogInterface, i) -&gt; {</span>
<span class="nc" id="L1229">            AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_CONFIRM_DIALOG_CANCELLED, mSite);</span>
<span class="nc" id="L1230">            mIsShowingInstallFirstPluginConfirmationDialog = false;</span>
<span class="nc" id="L1231">        });</span>
<span class="nc" id="L1232">        builder.setOnCancelListener(dialogInterface -&gt; {</span>
<span class="nc" id="L1233">            AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_CONFIRM_DIALOG_CANCELLED, mSite);</span>
<span class="nc" id="L1234">            mIsShowingInstallFirstPluginConfirmationDialog = false;</span>
<span class="nc" id="L1235">        });</span>
<span class="nc" id="L1236">        builder.setCancelable(true);</span>
<span class="nc" id="L1237">        builder.create();</span>

<span class="nc" id="L1239">        AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_CONFIRM_DIALOG_SHOWN, mSite);</span>
<span class="nc" id="L1240">        mIsShowingInstallFirstPluginConfirmationDialog = true;</span>
<span class="nc" id="L1241">        builder.show();</span>
<span class="nc" id="L1242">    }</span>

    /**
     * We'll trigger an eligibility check for the site for Automated Transfer and show a determinate progress bar.
     * Check out `OnAutomatedTransferEligibilityChecked` for its callback.
     */
    private void startAutomatedTransfer() {
<span class="nc" id="L1249">        AppLog.v(T.PLUGINS, &quot;Starting the Automated Transfer for '&quot; + mSite.getDisplayName()</span>
                            + &quot;' by checking its eligibility&quot;);
<span class="nc" id="L1251">        showAutomatedTransferProgressDialog();</span>

<span class="nc" id="L1253">        AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_CHECK_ELIGIBILITY, mSite);</span>
<span class="nc" id="L1254">        mDispatcher.dispatch(SiteActionBuilder.newCheckAutomatedTransferEligibilityAction(mSite));</span>
<span class="nc" id="L1255">    }</span>

    /**
     * The reason we are using a blocking progress bar is that if the user changes anything about the site, adds a post,
     * updates site settings etc, it'll be lost when the Automated Transfer is completed. The process takes about 1 min
     * on average, and we'll be able to update the progress by checking the status of the transfer.
     */
    private void showAutomatedTransferProgressDialog() {
<span class="nc bnc" id="L1263" title="All 2 branches missed.">        if (mAutomatedTransferProgressDialog == null) {</span>
<span class="nc" id="L1264">            mAutomatedTransferProgressDialog = new ProgressDialog(this);</span>
<span class="nc" id="L1265">            mAutomatedTransferProgressDialog.setCancelable(false);</span>
<span class="nc" id="L1266">            mAutomatedTransferProgressDialog.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);</span>
<span class="nc" id="L1267">            mAutomatedTransferProgressDialog.setIndeterminate(false);</span>
<span class="nc" id="L1268">            String message = getString(R.string.plugin_install_first_plugin_progress_dialog_message);</span>
<span class="nc" id="L1269">            mAutomatedTransferProgressDialog.setMessage(message);</span>
        }
<span class="nc bnc" id="L1271" title="All 2 branches missed.">        if (!mAutomatedTransferProgressDialog.isShowing()) {</span>
<span class="nc" id="L1272">            mIsShowingAutomatedTransferProgress = true;</span>
<span class="nc" id="L1273">            mAutomatedTransferProgressDialog.show();</span>
        }
<span class="nc" id="L1275">    }</span>

    /**
     * Either Automated Transfer is completed or an error occurred.
     */
    private void cancelAutomatedTransferDialog() {
<span class="nc bnc" id="L1281" title="All 4 branches missed.">        if (mAutomatedTransferProgressDialog != null &amp;&amp; mAutomatedTransferProgressDialog.isShowing()) {</span>
<span class="nc" id="L1282">            mAutomatedTransferProgressDialog.cancel();</span>
<span class="nc" id="L1283">            mIsShowingAutomatedTransferProgress = false;</span>
        }
<span class="nc" id="L1285">    }</span>

    /**
     * Automated Transfer successfully completed, the site has been refreshed and site plugins has been fetched. We can
     * close the progress dialog, get the new version of the plugin from Store and refresh the views
     */
    private void automatedTransferCompleted() {
<span class="nc" id="L1292">        AppLog.v(T.PLUGINS, &quot;Automated Transfer successfully completed!&quot;);</span>
<span class="nc" id="L1293">        AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_FLOW_COMPLETE, mSite);</span>
<span class="nc" id="L1294">        cancelAutomatedTransferDialog();</span>
<span class="nc" id="L1295">        refreshPluginFromStore();</span>
<span class="nc" id="L1296">        dispatchConfigurePluginAction(true);</span>
<span class="nc" id="L1297">        refreshViews();</span>
<span class="nc" id="L1298">        showSuccessfulInstallSnackbar();</span>
<span class="nc" id="L1299">        invalidateOptionsMenu();</span>
<span class="nc" id="L1300">    }</span>

    /**
     * Helper for if any of the FluxC Automated Transfer events fail. We are using a Toast for now, but the only likely
     * error is the site missing a domain which will be implemented later on and will be handled differently.
     */
    private void handleAutomatedTransferFailed(String errorMessage) {
<span class="nc" id="L1307">        cancelAutomatedTransferDialog();</span>
<span class="nc" id="L1308">        BasicFragmentDialog errorDialog = new BasicFragmentDialog();</span>
<span class="nc" id="L1309">        errorDialog.initialize(TAG_ERROR_DIALOG, null, errorMessage,</span>
<span class="nc" id="L1310">                getString(R.string.dialog_button_ok), null, null);</span>
<span class="nc" id="L1311">        errorDialog.show(getSupportFragmentManager(), TAG_ERROR_DIALOG);</span>
<span class="nc" id="L1312">    }</span>

    /**
     * This is the first Automated Transfer FluxC event. It returns whether the site is eligible or not with a set of
     * errors for why it's not eligible. We are handling a single error at a time, but all the likely errors should be
     * pre-handled by preventing the access of plugins page.
     * &lt;p&gt;
     * If the site is eligible, we'll initiate the Automated Transfer. Check out `onAutomatedTransferInitiated` for next
     * step.
     */
    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAutomatedTransferEligibilityChecked(OnAutomatedTransferEligibilityChecked event) {
<span class="nc bnc" id="L1325" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1326">            return;</span>
        }
        // Checking isEligible handles `event.isError()` implicitly. In this case we won't have access to the specific
        // error code, so we'll show the generic error message.
<span class="nc bnc" id="L1330" title="All 2 branches missed.">        if (!event.isEligible) {</span>
<span class="nc" id="L1331">            AppLog.e(T.PLUGINS, &quot;Automated Transfer has failed because the site is not eligible!&quot;);</span>
<span class="nc" id="L1332">            AppLog.e(T.PLUGINS, &quot;Eligibility error codes: &quot; + event.eligibilityErrorCodes);</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">            if (event.isError()) {</span>
                // This error shouldn't happen under normal circumstances. Instead the call will succeed and return
                // error codes.
<span class="nc" id="L1336">                AppLog.e(T.PLUGINS, &quot;Eligibility API error with type: &quot; + event.error.type + &quot; and message: &quot;</span>
                                    + event.error.message);
            }
<span class="nc bnc" id="L1339" title="All 2 branches missed.">            String errorCode = event.eligibilityErrorCodes.isEmpty() ? &quot;&quot; : event.eligibilityErrorCodes.get(0);</span>
<span class="nc bnc" id="L1340" title="All 2 branches missed.">            if (errorCode.equalsIgnoreCase(&quot;transfer_already_exists&quot;)) {</span>
<span class="nc" id="L1341">                AppLog.v(T.PLUGINS, &quot;Automated Transfer eligibility check resulted in `transfer_already_exists` &quot;</span>
                                    + &quot;error, checking its status...&quot;);
<span class="nc" id="L1343">                mDispatcher.dispatch(SiteActionBuilder.newCheckAutomatedTransferStatusAction(mSite));</span>
            } else {
<span class="nc" id="L1345">                AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_NOT_ELIGIBLE, mSite);</span>
<span class="nc" id="L1346">                handleAutomatedTransferFailed(getEligibilityErrorMessage(errorCode));</span>
            }
<span class="nc" id="L1348">        } else {</span>
<span class="nc" id="L1349">            AppLog.v(T.PLUGINS, &quot;The site is eligible for Automated Transfer. Initiating the transfer...&quot;);</span>
<span class="nc" id="L1350">            AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_INITIATE, mSite);</span>
<span class="nc" id="L1351">            mDispatcher.dispatch(SiteActionBuilder</span>
<span class="nc" id="L1352">                    .newInitiateAutomatedTransferAction(new InitiateAutomatedTransferPayload(mSite, mSlug)));</span>
        }
<span class="nc" id="L1354">    }</span>

    /**
     * After we check the eligibility of a site, the Automated Transfer will be initiated. This is its callback and it
     * should be a fairly quick one, that's why we are not updating the progress bar. The event contains the plugin that
     * will be installed after Automated Transfer is completed, but we don't need to handle anything about that.
     * &lt;p&gt;
     * We don't know if there is any specific errors we might need to handle, so we are just showing a message about it
     * for now.
     * &lt;p&gt;
     * Once the transfer is initiated, we need to start checking the status of it. Check out
     * `onAutomatedTransferStatusChecked` for the callback.
     */
    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAutomatedTransferInitiated(OnAutomatedTransferInitiated event) {
<span class="nc bnc" id="L1370" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1371">            return;</span>
        }
<span class="nc bnc" id="L1373" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1374">            AppLog.e(T.PLUGINS, &quot;Automated Transfer failed during initiation with error type &quot; + event.error.type</span>
                                + &quot; and message: &quot; + event.error.message);
<span class="nc" id="L1376">            AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_INITIATION_FAILED, mSite);</span>
<span class="nc" id="L1377">            handleAutomatedTransferFailed(event.error.message);</span>
        } else {
<span class="nc" id="L1379">            AppLog.v(T.PLUGINS, &quot;Automated Transfer is successfully initiated. Checking the status of it...&quot;);</span>
<span class="nc" id="L1380">            AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_INITIATED, mSite);</span>
<span class="nc" id="L1381">            mDispatcher.dispatch(SiteActionBuilder.newCheckAutomatedTransferStatusAction(mSite));</span>
        }
<span class="nc" id="L1383">    }</span>

    /**
     * After Automated Transfer is initiated, we'll need to check for the status of it several times as the process
     * takes about 1 minute on average. We don't know if there are any specific errors we can handle, so for now we are
     * simply showing the message.
     * &lt;p&gt;
     * We'll get an `isCompleted` flag from the event and when that's `true` we'll need to re-fetch the site. It'll
     * become a Jetpack site at that point and we'll need the updated site to be able to fetch the plugins and refresh
     * this page. If the transfer is not completed, we use the current step and total steps to update the progress bar
     * and check the status again after waiting for a second.
     * &lt;p&gt;
     * Unfortunately we can't close the progress dialog until both the site and its plugins are fetched. Check out
     * `onSiteChanged` for the next step.
     */
    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAutomatedTransferStatusChecked(OnAutomatedTransferStatusChecked event) {
<span class="nc bnc" id="L1401" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1402">            return;</span>
        }
<span class="nc bnc" id="L1404" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1405">            AppLog.e(T.PLUGINS, &quot;Automated Transfer failed after initiation with error type &quot; + event.error.type</span>
                                + &quot; and message: &quot; + event.error.message);
<span class="nc" id="L1407">            AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_STATUS_FAILED, mSite);</span>
<span class="nc" id="L1408">            handleAutomatedTransferFailed(event.error.message);</span>
        } else {
<span class="nc bnc" id="L1410" title="All 2 branches missed.">            if (event.isCompleted) {</span>
<span class="nc" id="L1411">                AppLog.v(T.PLUGINS, &quot;Automated Transfer is successfully completed. Fetching the site...&quot;);</span>
                // The flow is almost complete, we can show 99% complete to give us a second or so to fetch the site
                // and its plugins
<span class="nc" id="L1414">                mAutomatedTransferProgressDialog.setProgress(99);</span>
<span class="nc" id="L1415">                mAutomatedTransferProgressDialog.setMessage(</span>
<span class="nc" id="L1416">                        getString(R.string.plugin_install_first_plugin_almost_finished_dialog_message));</span>
<span class="nc" id="L1417">                AnalyticsUtils.trackWithSiteDetails(Stat.AUTOMATED_TRANSFER_STATUS_COMPLETE, mSite);</span>
<span class="nc" id="L1418">                mDispatcher.dispatch(SiteActionBuilder.newFetchSiteAction(mSite));</span>
            } else {
<span class="nc" id="L1420">                AppLog.v(T.PLUGINS, &quot;Automated Transfer is still in progress: &quot; + event.currentStep + &quot;/&quot;</span>
                                    + event.totalSteps);
<span class="nc" id="L1422">                mAutomatedTransferProgressDialog.setProgress(event.currentStep * 100 / event.totalSteps);</span>
<span class="nc" id="L1423">                mHandler.postDelayed(() -&gt; {</span>
<span class="nc" id="L1424">                    AppLog.v(T.PLUGINS, &quot;Checking the Automated Transfer status...&quot;);</span>
                    // Wait 3 seconds before checking the status again
<span class="nc" id="L1426">                    mDispatcher.dispatch(SiteActionBuilder.newCheckAutomatedTransferStatusAction(mSite));</span>
<span class="nc" id="L1427">                }, DEFAULT_RETRY_DELAY_MS);</span>
            }
        }
<span class="nc" id="L1430">    }</span>

    /**
     * Once the Automated Transfer is completed, we'll trigger a fetch for the site since it'll become a Jetpack site.
     * Whenever the site is updated we update `mSite` property. If the Automated Transfer progress dialog is
     * showing and we make sure that the updated site has the correct `isAutomatedTransfer` flag, we fetch the site
     * plugins so we can refresh this page.
     * &lt;p&gt;
     * Check out `onPluginDirectoryFetched` for the last step of a successful Automated Transfer.
     */
    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSiteChanged(OnSiteChanged event) {
<span class="nc bnc" id="L1443" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1444">            return;</span>
        }

<span class="nc bnc" id="L1447" title="All 2 branches missed.">        if (!event.isError()) {</span>
<span class="nc" id="L1448">            mSite = mSiteStore.getSiteBySiteId(mSite.getSiteId());</span>
<span class="nc bnc" id="L1449" title="All 2 branches missed.">        } else if (mIsShowingAutomatedTransferProgress) {</span>
<span class="nc" id="L1450">            AppLog.e(T.PLUGINS, &quot;Fetching the site after Automated Transfer has failed with error type &quot;</span>
                                + event.error.type + &quot; and message: &quot; + event.error.message);
        }

<span class="nc bnc" id="L1454" title="All 2 branches missed.">        if (mIsShowingAutomatedTransferProgress) {</span>
            // We try to fetch the site after Automated Transfer is completed so that we can fetch its plugins. If
            // we are still showing the AT progress and the site is AT site, we can continue with plugins fetch
<span class="nc bnc" id="L1457" title="All 2 branches missed.">            if (mSite.isAutomatedTransfer()) {</span>
<span class="nc" id="L1458">                AppLog.v(T.PLUGINS, &quot;Site is successfully fetched after Automated Transfer, fetching&quot;</span>
                                    + &quot; the site plugins to complete the process...&quot;);
<span class="nc" id="L1460">                fetchPluginDirectory(0);</span>
            } else {
                // Either an error occurred while fetching the site or Automated Transfer is not yet reflected in the
                // API response. We need to keep fetching the site until we get the updated site. Otherwise, any changes
                // the user will make after this point will not be done on the correct `SiteModel`. If we don't get the
                // correct site information, it's actually safer if the user force quits the app, because they will
                // start from the my site page and the site will be refreshed.
<span class="nc" id="L1467">                mHandler.postDelayed(() -&gt; {</span>
<span class="nc" id="L1468">                    AppLog.v(T.PLUGINS, &quot;Fetching the site again after Automated Transfer since the changes &quot;</span>
                                        + &quot;are not yet reflected&quot;);
                    // Wait 3 seconds before fetching the site again
<span class="nc" id="L1471">                    mDispatcher.dispatch(SiteActionBuilder.newFetchSiteAction(mSite));</span>
<span class="nc" id="L1472">                }, DEFAULT_RETRY_DELAY_MS);</span>
            }
        }
<span class="nc" id="L1475">    }</span>

    /**
     * Completing an Automated Transfer will trigger a site fetch which then will trigger a fetch for the site plugins.
     * We'll complete the Automated Transfer if the progress dialog is showing and only update the plugin and the views
     * if it's not.
     * &lt;p&gt;
     * This event is unlikely to happen outside of Automated Transfer process, and it is even less likely that the views
     * will need to be updated because of it, but they are both still possible and we try to handle it with a refresh.
     */
    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPluginDirectoryFetched(OnPluginDirectoryFetched event) {
<span class="nc bnc" id="L1488" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L1489">            return;</span>
        }

<span class="nc" id="L1492">        refreshPluginFromStore();</span>

<span class="nc bnc" id="L1494" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">            if (mIsShowingAutomatedTransferProgress) {</span>
<span class="nc" id="L1496">                AppLog.e(T.PLUGINS, &quot;Fetching the plugin directory after Automated Transfer has failed with error type&quot;</span>
                                    + event.error.type + &quot; and message: &quot; + event.error.message);
                // Although unlikely, fetching the plugins after a successful Automated Transfer can result in an error.
                // This should hopefully be an edge case and fetching the plugins again should
<span class="nc" id="L1500">                AppLog.v(T.PLUGINS, &quot;Fetching the site plugins again after Automated Transfer since the&quot;</span>
                                    + &quot; changes are not yet reflected&quot;);
<span class="nc" id="L1502">                fetchPluginDirectory(PLUGIN_RETRY_DELAY_MS);</span>
            }
            // We are safe to ignore the errors for this event unless it's for Automated Transfer since that's the only
            // one triggered in this page and only one we care about.
<span class="nc" id="L1506">            return;</span>
<span class="nc bnc" id="L1507" title="All 2 branches missed.">        } else if (!mPlugin.isInstalled()) {</span>
            // it sometimes take a bit of time for plugin to get marked as installed, especially when
            // Automated Transfer is performed right after domain registration
<span class="nc bnc" id="L1510" title="All 2 branches missed.">            if (mIsShowingAutomatedTransferProgress) {</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">                if (mPluginReCheckTimer &lt; MAX_PLUGIN_CHECK_TRIES) {</span>
<span class="nc" id="L1512">                    AppLog.v(T.PLUGINS, &quot;Targeted plugin is not marked as installed after Automated Transfer.&quot;</span>
                                        + &quot; Fetching the site plugins to reflect the changes.&quot;);
<span class="nc" id="L1514">                    fetchPluginDirectory(PLUGIN_RETRY_DELAY_MS);</span>
<span class="nc" id="L1515">                    mPluginReCheckTimer++;</span>
<span class="nc" id="L1516">                    return;</span>
                } else {
                    // if plugin is still not marked as installed, we ask user to check back later, and proceed to
                    // finish Automated Transfer
<span class="nc" id="L1520">                    ToastUtils.showToast(this, R.string.plugin_fetching_error_after_at, Duration.LONG);</span>
                }
            }
        }
<span class="nc bnc" id="L1524" title="All 4 branches missed.">        if (event.type == PluginDirectoryType.SITE &amp;&amp; mIsShowingAutomatedTransferProgress) {</span>
            // After Automated Transfer flow is completed, we fetch the site and then it's plugins. The only way site's
            // plugins could be fetched without an error is if the AT is completed and now that we have it's plugins
            // we can finish the whole flow
<span class="nc" id="L1528">            automatedTransferCompleted();</span>
        } else {
            // Although it's unlikely that a directory might be fetched while we are in the plugin detail page, we
            // should be safe to refresh the plugin and the view in case the plugin we are showing has changed
<span class="nc" id="L1532">            refreshViews();</span>
        }
<span class="nc" id="L1534">    }</span>

    private void fetchPluginDirectory(int delay) {
<span class="nc" id="L1537">        mHandler.postDelayed(</span>
<span class="nc" id="L1538">                () -&gt; mDispatcher.dispatch(PluginActionBuilder.newFetchPluginDirectoryAction(new PluginStore</span>
                        .FetchPluginDirectoryPayload(PluginDirectoryType.SITE, mSite, false))), delay);
<span class="nc" id="L1540">    }</span>

    private String getEligibilityErrorMessage(String errorCode) {
        int errorMessageRes;
<span class="nc bnc" id="L1544" title="All 10 branches missed.">        switch (errorCode) {</span>
            case &quot;email_unverified&quot;:
<span class="nc" id="L1546">                errorMessageRes = R.string.plugin_install_site_ineligible_email_unverified;</span>
<span class="nc" id="L1547">                break;</span>
            case &quot;excessive_disk_space&quot;:
<span class="nc" id="L1549">                errorMessageRes = R.string.plugin_install_site_ineligible_excessive_disk_space;</span>
<span class="nc" id="L1550">                break;</span>
            case &quot;no_business_plan&quot;:
<span class="nc" id="L1552">                errorMessageRes = R.string.plugin_install_site_ineligible_no_business_plan;</span>
<span class="nc" id="L1553">                break;</span>
            case &quot;no_vip_sites&quot;:
<span class="nc" id="L1555">                errorMessageRes = R.string.plugin_install_site_ineligible_no_vip_sites;</span>
<span class="nc" id="L1556">                break;</span>
            case &quot;non_admin_user&quot;:
<span class="nc" id="L1558">                errorMessageRes = R.string.plugin_install_site_ineligible_non_admin_user;</span>
<span class="nc" id="L1559">                break;</span>
            case &quot;not_domain_owner&quot;:
<span class="nc" id="L1561">                errorMessageRes = R.string.plugin_install_site_ineligible_not_domain_owner;</span>
<span class="nc" id="L1562">                break;</span>
            case &quot;not_using_custom_domain&quot;:
<span class="nc" id="L1564">                errorMessageRes = R.string.plugin_install_site_ineligible_not_using_custom_domain;</span>
<span class="nc" id="L1565">                break;</span>
            case &quot;site_graylisted&quot;:
<span class="nc" id="L1567">                errorMessageRes = R.string.plugin_install_site_ineligible_site_graylisted;</span>
<span class="nc" id="L1568">                break;</span>
            case &quot;site_private&quot;:
<span class="nc" id="L1570">                errorMessageRes = R.string.plugin_install_site_ineligible_site_private;</span>
<span class="nc" id="L1571">                break;</span>
            default:
                // no_jetpack_sites, no_ssl_certificate, no_wpcom_nameservers, not_resolving_to_wpcom
<span class="nc" id="L1574">                errorMessageRes = R.string.plugin_install_site_ineligible_default_error;</span>
                break;
        }
<span class="nc" id="L1577">        return getString(errorMessageRes);</span>
    }

    private boolean isNotAutoManaged() {
<span class="nc bnc" id="L1581" title="All 2 branches missed.">        return !PluginUtils.isAutoManaged(mSite, mPlugin);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>