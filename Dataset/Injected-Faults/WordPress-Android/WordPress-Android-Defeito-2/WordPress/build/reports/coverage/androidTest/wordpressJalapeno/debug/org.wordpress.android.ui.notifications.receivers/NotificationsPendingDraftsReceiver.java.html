<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationsPendingDraftsReceiver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.notifications.receivers</a> &gt; <span class="el_source">NotificationsPendingDraftsReceiver.java</span></div><h1>NotificationsPendingDraftsReceiver.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.notifications.receivers;

import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.text.TextUtils;

import androidx.core.app.NotificationCompat;

import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.fluxc.model.PostModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.model.post.PostStatus;
import org.wordpress.android.fluxc.store.PostStore;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.push.NativeNotificationsUtils;
import org.wordpress.android.push.NotificationType;
import org.wordpress.android.push.NotificationsProcessingService;
import org.wordpress.android.ui.main.WPMainActivity;
import org.wordpress.android.ui.mysite.SelectedSiteRepository;
import org.wordpress.android.ui.notifications.SystemNotificationsTracker;
import org.wordpress.android.ui.notifications.utils.PendingDraftsNotificationsUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.DateTimeUtils;

import java.util.List;
import java.util.Random;

import javax.inject.Inject;

import static org.wordpress.android.push.NotificationsProcessingService.ARG_NOTIFICATION_TYPE;

<span class="nc" id="L35">public class NotificationsPendingDraftsReceiver extends BroadcastReceiver {</span>
    public static final String POST_ID_EXTRA = &quot;postId&quot;;
    public static final String IS_PAGE_EXTRA = &quot;isPage&quot;;

    public static final long ONE_DAY = 24 * 60 * 60 * 1000;
    public static final long ONE_WEEK = ONE_DAY * 7;
    public static final long ONE_MONTH = ONE_WEEK * 4;

    private static final long MAX_DAYS_TO_SHOW_DAYS_IN_MESSAGE = 40; // just over a month

    private static final int BASE_REQUEST_CODE = 100;

    @Inject PostStore mPostStore;
    @Inject SiteStore mSiteStore;
    @Inject SystemNotificationsTracker mSystemNotificationsTracker;
    @Inject SelectedSiteRepository mSelectedSiteRepository;

    @Override
    public void onReceive(Context context, Intent intent) {
<span class="nc" id="L54">        ((WordPress) context.getApplicationContext()).component().inject(this);</span>

        // for the case of being spanned after device restarts, get the latest drafts
        // and check the lastUpdated
<span class="nc" id="L58">        String action = intent.getAction();</span>
<span class="nc bnc" id="L59" title="All 4 branches missed.">        if (action != null &amp;&amp; action.equals(&quot;android.intent.action.BOOT_COMPLETED&quot;)) {</span>
<span class="nc" id="L60">            AppLog.i(AppLog.T.NOTIFS, &quot;entering Pending Drafts Receiver from BOOT_COMPLETED&quot;);</span>
            // build notifications for existing local drafts
<span class="nc" id="L62">            SiteModel site = mSiteStore.getSiteByLocalId(mSelectedSiteRepository.getSelectedSiteLocalId());</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (site != null) {</span>
<span class="nc" id="L64">                List&lt;PostModel&gt; draftPosts = mPostStore.getPostsForSite(site);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                for (PostModel post : draftPosts) {</span>
                    // reschedule next notifications for each local draft post we have, as we have
                    // just been rebooted
<span class="nc" id="L68">                    PendingDraftsNotificationsUtils.scheduleNextNotifications(context, post.getId(),</span>
<span class="nc" id="L69">                            post.getDateLocallyChanged());</span>
<span class="nc" id="L70">                }</span>
            }
<span class="nc" id="L72">        } else {</span>
<span class="nc" id="L73">            AppLog.i(AppLog.T.NOTIFS, &quot;entering Pending Drafts Receiver from alarm&quot;);</span>
            // get extras from intent in order to build notification
<span class="nc" id="L75">            buildNotificationForPostId(intent.getIntExtra(POST_ID_EXTRA, 0), context);</span>
        }
<span class="nc" id="L77">    }</span>

    private void buildNotificationForPostId(int postId, Context context) {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (postId != 0) {</span>
<span class="nc" id="L81">            PostModel post = mPostStore.getPostByLocalPostId(postId);</span>
<span class="nc bnc" id="L82" title="All 4 branches missed.">            if (post != null &amp;&amp; PostStatus.DRAFT.toString().equals(post.getStatus())) {</span>
<span class="nc" id="L83">                long now = System.currentTimeMillis();</span>
<span class="nc" id="L84">                long dateLastUpdated = DateTimeUtils.timestampFromIso8601(post.getDateLocallyChanged());</span>
<span class="nc" id="L85">                long daysInDraft = (now - dateLastUpdated) / ONE_DAY;</span>
<span class="nc" id="L86">                boolean isPage = post.isPage();</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (daysInDraft &lt; MAX_DAYS_TO_SHOW_DAYS_IN_MESSAGE) {</span>
<span class="nc" id="L89">                    String formattedString = context.getString(R.string.pending_draft_one_generic);</span>

<span class="nc" id="L91">                    long oneDayAgo = now - ONE_DAY;</span>
<span class="nc" id="L92">                    long oneWeekAgo = now - ONE_WEEK;</span>
<span class="nc" id="L93">                    long oneMonthAgo = now - ONE_MONTH;</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">                    if (dateLastUpdated &lt; oneMonthAgo) {</span>
<span class="nc" id="L96">                        formattedString = context.getString(R.string.pending_draft_one_month);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                    } else if (dateLastUpdated &lt; oneWeekAgo) {</span>
                        // use any of the available 2 string formats, randomly
<span class="nc" id="L99">                        Random randomNum = new Random();</span>
<span class="nc" id="L100">                        int result = randomNum.nextInt(2);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                        if (result == 0) {</span>
<span class="nc" id="L102">                            formattedString = context.getString(R.string.pending_draft_one_week_1);</span>
                        } else {
<span class="nc" id="L104">                            formattedString = context.getString(R.string.pending_draft_one_week_2);</span>
                        }
<span class="nc bnc" id="L106" title="All 2 branches missed.">                    } else if (dateLastUpdated &lt; oneDayAgo) {</span>
                        // use any of the available 2 string formats, randomly
<span class="nc" id="L108">                        Random randomNum = new Random();</span>
<span class="nc" id="L109">                        int result = randomNum.nextInt(2);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                        if (result == 0) {</span>
<span class="nc" id="L111">                            formattedString = context.getString(R.string.pending_draft_one_day_1);</span>
                        } else {
<span class="nc" id="L113">                            formattedString = context.getString(R.string.pending_draft_one_day_2);</span>
                        }
                    }

<span class="nc" id="L117">                    buildSinglePendingDraftNotification(context, post.getTitle(), formattedString, postId, isPage);</span>
<span class="nc" id="L118">                } else {</span>
                    // if it's been more than MAX_DAYS_TO_SHOW_DAYS_IN_MESSAGE days, or if we don't know
                    // (i.e. value for lastUpdated is zero) then just show a generic message
<span class="nc" id="L121">                    buildSinglePendingDraftNotificationGeneric(context, post.getTitle(), postId, isPage);</span>
                }
            }
        }
<span class="nc" id="L125">    }</span>

    private String getPostTitle(Context context, String postTitle) {
<span class="nc" id="L128">        String title = postTitle;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (TextUtils.isEmpty(postTitle)) {</span>
<span class="nc" id="L130">            title = &quot;(&quot; + context.getResources().getText(R.string.untitled) + &quot;)&quot;;</span>
        }
<span class="nc" id="L132">        return title;</span>
    }

    private void buildSinglePendingDraftNotification(Context context, String postTitle, String formattedMessage,
                                                     int postId, boolean isPage) {
<span class="nc" id="L137">        buildSinglePendingDraftNotification(context, getResultIntentForOnePost(context, postId, isPage),</span>
<span class="nc" id="L138">                String.format(formattedMessage, getPostTitle(context, postTitle)), postId, isPage);</span>
<span class="nc" id="L139">    }</span>

    private void buildSinglePendingDraftNotificationGeneric(Context context, String postTitle, int postId,
                                                            boolean isPage) {
<span class="nc" id="L143">        buildSinglePendingDraftNotification(context, getResultIntentForOnePost(context, postId, isPage),</span>
<span class="nc" id="L144">                String.format(context.getString(R.string.pending_draft_one_generic),</span>
<span class="nc" id="L145">                        getPostTitle(context, postTitle)),</span>
                postId, isPage);
<span class="nc" id="L147">    }</span>

    private PendingIntent getResultIntentForOnePost(Context context, int postId, boolean isPage) {
<span class="nc" id="L150">        Intent resultIntent = new Intent(context, WPMainActivity.class);</span>
<span class="nc" id="L151">        resultIntent.putExtra(WPMainActivity.ARG_OPENED_FROM_PUSH, true);</span>
<span class="nc" id="L152">        resultIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK</span>
                              | Intent.FLAG_ACTIVITY_CLEAR_TASK);
<span class="nc" id="L154">        resultIntent.setAction(&quot;android.intent.action.MAIN&quot;);</span>
<span class="nc" id="L155">        resultIntent.addCategory(&quot;android.intent.category.LAUNCHER&quot;);</span>
<span class="nc" id="L156">        resultIntent.putExtra(POST_ID_EXTRA, postId);</span>
<span class="nc" id="L157">        resultIntent.putExtra(IS_PAGE_EXTRA, isPage);</span>
<span class="nc" id="L158">        resultIntent.putExtra(ARG_NOTIFICATION_TYPE, NotificationType.PENDING_DRAFTS);</span>
<span class="nc" id="L159">        PendingIntent pendingIntent = PendingIntent.getActivity(</span>
                context,
<span class="nc" id="L161">                BASE_REQUEST_CODE + PendingDraftsNotificationsUtils.makePendingDraftNotificationId(postId),</span>
                resultIntent,
                PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
        );

<span class="nc" id="L166">        return pendingIntent;</span>
    }

    private void buildSinglePendingDraftNotification(Context context, PendingIntent intent, String message, int postId,
                                                     boolean isPage) {
<span class="nc" id="L171">        NotificationCompat.Builder builder = NativeNotificationsUtils.getBuilder(context,</span>
<span class="nc" id="L172">                context.getString(R.string.notification_channel_important_id));</span>
<span class="nc" id="L173">        builder.setContentText(message)</span>
<span class="nc" id="L174">               .setPriority(NotificationCompat.PRIORITY_MAX)</span>
<span class="nc" id="L175">               .setOnlyAlertOnce(true);</span>
<span class="nc" id="L176">        builder.setContentIntent(intent);</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (postId != 0) {</span>
<span class="nc" id="L179">            addOpenDraftActionForNotification(context, builder, postId, isPage);</span>
<span class="nc" id="L180">            addIgnoreActionForNotification(context, builder, postId, isPage);</span>
        }
<span class="nc" id="L182">        addDismissActionForNotification(context, builder, postId, isPage);</span>

<span class="nc" id="L184">        NativeNotificationsUtils.showMessageToUserWithBuilder(builder, message, false,</span>
<span class="nc" id="L185">                PendingDraftsNotificationsUtils.makePendingDraftNotificationId(postId), context);</span>
<span class="nc" id="L186">        mSystemNotificationsTracker.trackShownNotification(NotificationType.PENDING_DRAFTS);</span>
<span class="nc" id="L187">    }</span>

    private void addOpenDraftActionForNotification(Context context, NotificationCompat.Builder builder, int postId,
                                                   boolean isPage) {
        // adding open draft action
<span class="nc" id="L192">        Intent openDraftIntent = new Intent(context, WPMainActivity.class);</span>
<span class="nc" id="L193">        openDraftIntent.putExtra(WPMainActivity.ARG_OPENED_FROM_PUSH, true);</span>
<span class="nc" id="L194">        openDraftIntent.putExtra(POST_ID_EXTRA, postId);</span>
<span class="nc" id="L195">        openDraftIntent.putExtra(IS_PAGE_EXTRA, isPage);</span>
<span class="nc" id="L196">        openDraftIntent.putExtra(ARG_NOTIFICATION_TYPE, NotificationType.PENDING_DRAFTS);</span>

<span class="nc" id="L198">        PendingIntent pendingIntent = PendingIntent.getActivity(</span>
                context,
                // need to add + 1 so the request code is different, otherwise they overlap
<span class="nc" id="L201">                BASE_REQUEST_CODE + 1 + PendingDraftsNotificationsUtils.makePendingDraftNotificationId(postId),</span>
                openDraftIntent,
                PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
        );
<span class="nc" id="L205">        builder.addAction(R.drawable.ic_pencil_white_24dp, context.getText(R.string.edit), pendingIntent);</span>
<span class="nc" id="L206">    }</span>

    private void addIgnoreActionForNotification(Context context, NotificationCompat.Builder builder, int postId,
                                                boolean isPage) {
        // Call processing service when user taps on IGNORE - we should remember this decision for this post
<span class="nc" id="L211">        Intent ignoreIntent = new Intent(context, NotificationsProcessingService.class);</span>
<span class="nc" id="L212">        ignoreIntent.putExtra(NotificationsProcessingService.ARG_ACTION_TYPE,</span>
                NotificationsProcessingService.ARG_ACTION_DRAFT_PENDING_IGNORE);
<span class="nc" id="L214">        ignoreIntent.putExtra(POST_ID_EXTRA, postId);</span>
<span class="nc" id="L215">        ignoreIntent.putExtra(IS_PAGE_EXTRA, isPage);</span>
<span class="nc" id="L216">        ignoreIntent.putExtra(ARG_NOTIFICATION_TYPE, NotificationType.PENDING_DRAFTS);</span>
<span class="nc" id="L217">        PendingIntent ignorePendingIntent = PendingIntent.getService(</span>
                context,
                // need to add + 2 so the request code is different, otherwise they overlap
<span class="nc" id="L220">                BASE_REQUEST_CODE + 2 + PendingDraftsNotificationsUtils.makePendingDraftNotificationId(postId),</span>
                ignoreIntent,
                PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
        );
<span class="nc" id="L224">        builder.addAction(R.drawable.ic_close_white_24dp, context.getText(R.string.ignore), ignorePendingIntent);</span>
<span class="nc" id="L225">    }</span>

    private void addDismissActionForNotification(Context context, NotificationCompat.Builder builder, int postId,
                                                 boolean isPage) {
        // Call processing service when notification is dismissed
<span class="nc" id="L230">        Intent notificationDeletedIntent = new Intent(context, NotificationsProcessingService.class);</span>
<span class="nc" id="L231">        notificationDeletedIntent.putExtra(NotificationsProcessingService.ARG_ACTION_TYPE,</span>
                NotificationsProcessingService.ARG_ACTION_DRAFT_PENDING_DISMISS);
<span class="nc" id="L233">        notificationDeletedIntent.putExtra(POST_ID_EXTRA, postId);</span>
<span class="nc" id="L234">        notificationDeletedIntent.putExtra(IS_PAGE_EXTRA, isPage);</span>
<span class="nc" id="L235">        notificationDeletedIntent.putExtra(NotificationsProcessingService.ARG_NOTIFICATION_TYPE,</span>
                NotificationType.PENDING_DRAFTS);
<span class="nc" id="L237">        PendingIntent dismissPendingIntent = PendingIntent.getService(</span>
                context,
                // need to add + 3 so the request code is different, otherwise they overlap
<span class="nc" id="L240">                BASE_REQUEST_CODE + 3 + PendingDraftsNotificationsUtils.makePendingDraftNotificationId(postId),</span>
                notificationDeletedIntent,
                PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_IMMUTABLE
        );
<span class="nc" id="L244">        builder.setDeleteIntent(dismissPendingIntent);</span>
<span class="nc" id="L245">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>