<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatsDateSelector.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stats.refresh.utils</a> &gt; <span class="el_source">StatsDateSelector.kt</span></div><h1>StatsDateSelector.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stats.refresh.utils

import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import org.wordpress.android.fluxc.network.utils.StatsGranularity
import org.wordpress.android.fluxc.network.utils.StatsGranularity.DAYS
import org.wordpress.android.fluxc.network.utils.StatsGranularity.MONTHS
import org.wordpress.android.fluxc.network.utils.StatsGranularity.WEEKS
import org.wordpress.android.fluxc.network.utils.StatsGranularity.YEARS
import org.wordpress.android.ui.stats.refresh.StatsViewModel.DateSelectorUiModel
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.INSIGHTS
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.SelectedDateProvider
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.SelectedDateProvider.SelectedDate
import org.wordpress.android.util.perform
import javax.inject.Inject

<span class="nc" id="L18">class StatsDateSelector</span>
<span class="nc" id="L19">constructor(</span>
<span class="nc" id="L20">    private val selectedDateProvider: SelectedDateProvider,</span>
<span class="nc" id="L21">    private val statsDateFormatter: StatsDateFormatter,</span>
<span class="nc" id="L22">    private val siteProvider: StatsSiteProvider,</span>
<span class="nc" id="L23">    private val statsSection: StatsSection</span>
) {
<span class="nc" id="L25">    private val _dateSelectorUiModel = MutableLiveData&lt;DateSelectorUiModel&gt;()</span>
<span class="nc" id="L26">    val dateSelectorData: LiveData&lt;DateSelectorUiModel&gt; = _dateSelectorUiModel</span>

<span class="nc" id="L28">    val selectedDate = selectedDateProvider.granularSelectedDateChanged(this.statsSection)</span>
<span class="nc" id="L29">            .perform {</span>
<span class="nc" id="L30">                updateDateSelector()</span>
<span class="nc" id="L31">            }</span>

    fun start(startDate: SelectedDate) {
<span class="nc" id="L34">        selectedDateProvider.updateSelectedDate(startDate, statsSection)</span>
<span class="nc" id="L35">    }</span>

    fun updateDateSelector() {
<span class="nc bnc" id="L38" title="All 2 branches missed.">        val shouldShowDateSelection = this.statsSection != INSIGHTS</span>

<span class="nc" id="L40">        val updatedDate = getDateLabelForSection()</span>
<span class="nc" id="L41">        val currentState = dateSelectorData.value</span>
<span class="nc bnc" id="L42" title="All 8 branches missed.">        if (!shouldShowDateSelection &amp;&amp; currentState?.isVisible != false) {</span>
<span class="nc" id="L43">            emitValue(currentState, DateSelectorUiModel(false))</span>
        } else {
<span class="nc" id="L45">            val timeZone = statsDateFormatter.printTimeZone(siteProvider.siteModel)</span>
<span class="nc" id="L46">            val updatedState = DateSelectorUiModel(</span>
<span class="nc" id="L47">                    shouldShowDateSelection,</span>
<span class="nc" id="L48">                    updatedDate,</span>
<span class="nc" id="L49">                    enableSelectPrevious = selectedDateProvider.hasPreviousDate(statsSection),</span>
<span class="nc" id="L50">                    enableSelectNext = selectedDateProvider.hasNextDate(statsSection),</span>
<span class="nc" id="L51">                    timeZone = timeZone</span>
            )
<span class="nc" id="L53">            emitValue(currentState, updatedState)</span>
        }
<span class="nc" id="L55">    }</span>

    private fun emitValue(
        currentState: DateSelectorUiModel?,
        updatedState: DateSelectorUiModel
    ) {
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (currentState != updatedState) {</span>
<span class="nc" id="L62">            _dateSelectorUiModel.value = updatedState</span>
        }
<span class="nc" id="L64">    }</span>

    private fun getDateLabelForSection(): String? {
<span class="nc" id="L67">        return statsDateFormatter.printGranularDate(</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                selectedDateProvider.getSelectedDate(statsSection) ?: selectedDateProvider.getCurrentDate(),</span>
<span class="nc" id="L69">                toStatsGranularity()</span>
        )
    }

    private fun toStatsGranularity(): StatsGranularity {
<span class="nc bnc" id="L74" title="All 4 branches missed.">        return when (statsSection) {</span>
            StatsSection.DETAIL,
            StatsSection.TOTAL_LIKES_DETAIL,
            StatsSection.TOTAL_COMMENTS_DETAIL,
            StatsSection.TOTAL_FOLLOWERS_DETAIL,
            StatsSection.INSIGHTS,
            StatsSection.INSIGHT_DETAIL,
<span class="nc" id="L81">            StatsSection.DAYS -&gt; DAYS</span>
<span class="nc" id="L82">            StatsSection.WEEKS -&gt; WEEKS</span>
<span class="nc" id="L83">            StatsSection.MONTHS -&gt; MONTHS</span>
            StatsSection.ANNUAL_STATS,
<span class="nc" id="L85">            StatsSection.YEARS -&gt; YEARS</span>
        }
    }

    fun onNextDateSelected() {
<span class="nc" id="L90">        selectedDateProvider.selectNextDate(statsSection)</span>
<span class="nc" id="L91">    }</span>

    fun onPreviousDateSelected() {
<span class="nc" id="L94">        selectedDateProvider.selectPreviousDate(statsSection)</span>
<span class="nc" id="L95">    }</span>

    fun clear() {
<span class="nc" id="L98">        selectedDateProvider.clear(statsSection)</span>
<span class="nc" id="L99">    }</span>

    fun getSelectedDate(): SelectedDate {
<span class="nc" id="L102">        return selectedDateProvider.getSelectedDateState(statsSection)</span>
    }

<span class="nc" id="L105">    class Factory</span>
<span class="nc" id="L106">    @Inject constructor(</span>
<span class="nc" id="L107">        private val selectedDateProvider: SelectedDateProvider,</span>
<span class="nc" id="L108">        private val siteProvider: StatsSiteProvider,</span>
<span class="nc" id="L109">        private val statsDateFormatter: StatsDateFormatter</span>
    ) {
        fun build(statsSection: StatsSection): StatsDateSelector {
<span class="nc" id="L112">            return StatsDateSelector(</span>
<span class="nc" id="L113">                    selectedDateProvider,</span>
<span class="nc" id="L114">                    statsDateFormatter,</span>
<span class="nc" id="L115">                    siteProvider,</span>
<span class="nc" id="L116">                    statsSection</span>
            )
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>