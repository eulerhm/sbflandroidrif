<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaPickerActivity.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.mediapicker</a> &gt; <span class="el_source">MediaPickerActivity.kt</span></div><h1>MediaPickerActivity.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.mediapicker

import android.app.Activity
import android.content.Context
import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.text.TextUtils
import android.view.MenuItem
import androidx.fragment.app.FragmentTransaction
import org.wordpress.android.BuildConfig
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.PhotoPickerActivityBinding
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.MediaStore
import org.wordpress.android.ui.LocaleAwareActivity
import org.wordpress.android.ui.RequestCodes.IMAGE_EDITOR_EDIT_IMAGE
import org.wordpress.android.ui.RequestCodes.MEDIA_LIBRARY
import org.wordpress.android.ui.RequestCodes.PHOTO_PICKER
import org.wordpress.android.ui.RequestCodes.TAKE_PHOTO
import org.wordpress.android.ui.media.MediaBrowserActivity
import org.wordpress.android.ui.mediapicker.MediaItem.Identifier
import org.wordpress.android.ui.mediapicker.MediaPickerActivity.MediaPickerMediaSource.ANDROID_CAMERA
import org.wordpress.android.ui.mediapicker.MediaPickerActivity.MediaPickerMediaSource.APP_PICKER
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.Companion.newInstance
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerAction
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerAction.OpenCameraForPhotos
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerAction.OpenCameraForWPStories
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerAction.OpenSystemPicker
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerAction.SwitchMediaPicker
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerListener
import org.wordpress.android.ui.mediapicker.MediaPickerSetup.DataSource
import org.wordpress.android.ui.mediapicker.MediaPickerSetup.DataSource.DEVICE
import org.wordpress.android.ui.mediapicker.MediaPickerSetup.DataSource.GIF_LIBRARY
import org.wordpress.android.ui.mediapicker.MediaPickerSetup.DataSource.STOCK_LIBRARY
import org.wordpress.android.ui.mediapicker.MediaPickerSetup.DataSource.WP_LIBRARY
import org.wordpress.android.ui.photopicker.MediaPickerConstants
import org.wordpress.android.ui.photopicker.MediaPickerConstants.EXTRA_LAUNCH_WPSTORIES_CAMERA_REQUESTED
import org.wordpress.android.ui.photopicker.MediaPickerConstants.EXTRA_MEDIA_ID
import org.wordpress.android.ui.photopicker.MediaPickerConstants.EXTRA_MEDIA_QUEUED_URIS
import org.wordpress.android.ui.photopicker.MediaPickerConstants.EXTRA_MEDIA_SOURCE
import org.wordpress.android.ui.photopicker.MediaPickerConstants.EXTRA_MEDIA_URIS
import org.wordpress.android.ui.photopicker.MediaPickerConstants.LOCAL_POST_ID
import org.wordpress.android.ui.posts.EMPTY_LOCAL_POST_ID
import org.wordpress.android.ui.posts.FeaturedImageHelper
import org.wordpress.android.ui.posts.editor.ImageEditorTracker
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T.MEDIA
import org.wordpress.android.util.WPMediaUtils
import java.io.File
import javax.inject.Inject

<span class="nc" id="L56">class MediaPickerActivity : LocaleAwareActivity(), MediaPickerListener {</span>
    private var mediaCapturePath: String? = null
    private lateinit var mediaPickerSetup: MediaPickerSetup

    // note that the site isn't required and may be null
    private var site: SiteModel? = null

    // note that the local post id isn't required (default value is EMPTY_LOCAL_POST_ID)
<span class="nc" id="L64">    private var localPostId: Int = EMPTY_LOCAL_POST_ID</span>

<span class="nc bnc" id="L66" title="All 2 branches missed.">    @Inject lateinit var dispatcher: Dispatcher</span>

<span class="nc bnc" id="L68" title="All 2 branches missed.">    @Inject lateinit var mediaStore: MediaStore</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">    @Inject lateinit var featuredImageHelper: FeaturedImageHelper</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">    @Inject lateinit var imageEditorTracker: ImageEditorTracker</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>

    enum class MediaPickerMediaSource {
<span class="nc" id="L77">        ANDROID_CAMERA, ANDROID_PICKER, APP_PICKER, WP_MEDIA_PICKER, STOCK_MEDIA_PICKER;</span>

        companion object {
            fun fromString(strSource: String?): MediaPickerMediaSource? {
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (strSource != null) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    for (source in values()) {</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                        if (source.name.equals(strSource, ignoreCase = true)) {</span>
<span class="nc" id="L84">                            return source</span>
                        }
                    }
                }
<span class="nc" id="L88">                return null</span>
            }

            fun fromDataSource(dataSource: DataSource): MediaPickerMediaSource {
<span class="nc bnc" id="L92" title="All 4 branches missed.">                return when (dataSource) {</span>
<span class="nc" id="L93">                    DEVICE -&gt; APP_PICKER</span>
<span class="nc" id="L94">                    WP_LIBRARY -&gt; WP_MEDIA_PICKER</span>
<span class="nc" id="L95">                    STOCK_LIBRARY -&gt; STOCK_MEDIA_PICKER</span>
<span class="nc" id="L96">                    GIF_LIBRARY -&gt; APP_PICKER</span>
                }
            }
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L103">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        (application as WordPress).component().inject(this)</span>
<span class="nc" id="L105">        val binding = PhotoPickerActivityBinding.inflate(layoutInflater)</span>
<span class="nc" id="L106">        setContentView(binding.root)</span>
<span class="nc" id="L107">        binding.toolbarMain.setNavigationIcon(R.drawable.ic_close_white_24dp)</span>
<span class="nc" id="L108">        setSupportActionBar(binding.toolbarMain)</span>
<span class="nc" id="L109">        val actionBar = supportActionBar</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L111">            actionBar.setDisplayHomeAsUpEnabled(true)</span>
<span class="nc" id="L112">            actionBar.setDisplayShowTitleEnabled(true)</span>
        }
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L115">            mediaPickerSetup = MediaPickerSetup.fromIntent(intent)</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            site = intent.getSerializableExtra(WordPress.SITE) as? SiteModel</span>
<span class="nc" id="L117">            localPostId = intent.getIntExtra(LOCAL_POST_ID, EMPTY_LOCAL_POST_ID)</span>
        } else {
<span class="nc" id="L119">            mediaPickerSetup = MediaPickerSetup.fromBundle(savedInstanceState)</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            site = savedInstanceState.getSerializable(WordPress.SITE) as? SiteModel</span>
<span class="nc" id="L121">            localPostId = savedInstanceState.getInt(LOCAL_POST_ID, EMPTY_LOCAL_POST_ID)</span>
        }
<span class="nc" id="L123">        var fragment = pickerFragment</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (fragment == null) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            fragment = newInstance(this, mediaPickerSetup, site)</span>
<span class="nc" id="L126">            supportFragmentManager.beginTransaction()</span>
<span class="nc" id="L127">                    .replace(</span>
<span class="nc" id="L128">                            R.id.fragment_container,</span>
<span class="nc" id="L129">                            fragment,</span>
<span class="nc" id="L130">                            PICKER_FRAGMENT_TAG</span>
                    )
<span class="nc" id="L132">                    .setTransition(FragmentTransaction.TRANSIT_FRAGMENT_FADE)</span>
<span class="nc" id="L133">                    .commitAllowingStateLoss()</span>
        } else {
<span class="nc" id="L135">            fragment.setMediaPickerListener(this)</span>
        }
<span class="nc bnc" id="L137" title="All 4 branches missed.">        requireNotNull(actionBar).setTitle(mediaPickerSetup.title)</span>
<span class="nc" id="L138">    }</span>

    private val pickerFragment: MediaPickerFragment?
        get() {
<span class="nc" id="L142">            val fragment = supportFragmentManager.findFragmentByTag(</span>
<span class="nc" id="L143">                    PICKER_FRAGMENT_TAG</span>
            )
<span class="nc bnc" id="L145" title="All 2 branches missed.">            return if (fragment != null) {</span>
<span class="nc" id="L146">                fragment as MediaPickerFragment</span>
<span class="nc" id="L147">            } else null</span>
        }

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L151">        super.onSaveInstanceState(outState)</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        mediaPickerSetup.toBundle(outState)</span>
<span class="nc" id="L153">        outState.putInt(LOCAL_POST_ID, localPostId)</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (site != null) {</span>
<span class="nc" id="L155">            outState.putSerializable(WordPress.SITE, site)</span>
        }
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!TextUtils.isEmpty(mediaCapturePath)) {</span>
<span class="nc" id="L158">            outState.putString(KEY_MEDIA_CAPTURE_PATH, mediaCapturePath)</span>
        }
<span class="nc" id="L160">    }</span>

    override fun onRestoreInstanceState(savedInstanceState: Bundle) {
<span class="nc" id="L163">        super.onRestoreInstanceState(savedInstanceState)</span>
<span class="nc" id="L164">        mediaCapturePath = savedInstanceState.getString(KEY_MEDIA_CAPTURE_PATH)</span>
<span class="nc" id="L165">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (item.itemId == android.R.id.home) {</span>
<span class="nc" id="L169">            setResult(Activity.RESULT_CANCELED)</span>
<span class="nc" id="L170">            finish()</span>
<span class="nc" id="L171">            return true</span>
        }
<span class="nc" id="L173">        return super.onOptionsItemSelected(item)</span>
    }

    override fun onActivityResult(
        requestCode: Int,
        resultCode: Int,
        data: Intent?
    ) {
<span class="nc" id="L181">        super.onActivityResult(requestCode, resultCode, data)</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (resultCode != Activity.RESULT_OK) {</span>
<span class="nc" id="L183">            return</span>
        }
<span class="nc bnc" id="L185" title="All 4 branches missed.">        val intent: Intent? = when (requestCode) {</span>
            MEDIA_LIBRARY -&gt; {
<span class="nc bnc" id="L187" title="All 2 branches missed.">                data?.let {</span>
<span class="nc" id="L188">                    val uris = WPMediaUtils.retrieveMediaUris(data)</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    pickerFragment?.urisSelectedFromSystemPicker(uris)</span>
<span class="nc" id="L190">                    return</span>
                }
            }
            TAKE_PHOTO -&gt; {
<span class="nc" id="L194">                try {</span>
<span class="nc" id="L195">                    val intent = Intent()</span>
<span class="nc" id="L196">                    mediaCapturePath!!.let {</span>
<span class="nc" id="L197">                        WPMediaUtils.scanMediaFile(this, it)</span>
<span class="nc" id="L198">                        val f = File(it)</span>
<span class="nc" id="L199">                        val capturedImageUri = listOf(Uri.fromFile(f))</span>
<span class="nc bnc" id="L200" title="All 4 branches missed.">                        if (mediaPickerSetup.queueResults) {</span>
<span class="nc" id="L201">                            intent.putQueuedUris(capturedImageUri)</span>
                        } else {
<span class="nc" id="L203">                            intent.putUris(capturedImageUri)</span>
                        }
<span class="nc" id="L205">                        intent.putExtra(</span>
<span class="nc" id="L206">                                EXTRA_MEDIA_SOURCE,</span>
<span class="nc" id="L207">                                ANDROID_CAMERA.name</span>
                        )
                    }
<span class="nc" id="L210">                    intent</span>
<span class="nc" id="L211">                } catch (e: RuntimeException) {</span>
<span class="nc" id="L212">                    AppLog.e(MEDIA, e)</span>
<span class="nc" id="L213">                    null</span>
                }
            }
            IMAGE_EDITOR_EDIT_IMAGE -&gt; {
<span class="nc bnc" id="L217" title="All 2 branches missed.">                data?.let {</span>
<span class="nc" id="L218">                    val intent = Intent()</span>
<span class="nc" id="L219">                    val uris = WPMediaUtils.retrieveImageEditorResult(data)</span>
<span class="nc bnc" id="L220" title="All 4 branches missed.">                    if (mediaPickerSetup.queueResults) {</span>
<span class="nc" id="L221">                        intent.putQueuedUris(uris)</span>
                    } else {
<span class="nc" id="L223">                        intent.putUris(uris)</span>
                    }
<span class="nc" id="L225">                    intent.putExtra(</span>
<span class="nc" id="L226">                            EXTRA_MEDIA_SOURCE,</span>
<span class="nc" id="L227">                            APP_PICKER.name</span>
                    )
<span class="nc" id="L229">                    intent</span>
                }
            }
            else -&gt; {
<span class="nc" id="L233">                data</span>
            }
        }
<span class="nc bnc" id="L236" title="All 2 branches missed.">        intent?.let {</span>
<span class="nc" id="L237">            setResult(Activity.RESULT_OK, intent)</span>
<span class="nc" id="L238">            finish()</span>
<span class="nc" id="L239">        }</span>
<span class="nc" id="L240">    }</span>

    private fun launchChooserWithContext(openSystemPicker: OpenSystemPicker, uiHelpers: UiHelpers) {
<span class="nc" id="L243">        WPMediaUtils.launchChooserWithContext(this, openSystemPicker, uiHelpers, MEDIA_LIBRARY)</span>
<span class="nc" id="L244">    }</span>

    private fun launchWPStoriesCamera() {
<span class="nc" id="L247">        val intent = Intent()</span>
<span class="nc" id="L248">                .putExtra(EXTRA_LAUNCH_WPSTORIES_CAMERA_REQUESTED, true)</span>
<span class="nc" id="L249">        setResult(Activity.RESULT_OK, intent)</span>
<span class="nc" id="L250">        finish()</span>
<span class="nc" id="L251">    }</span>

    private fun Intent.putUris(
        mediaUris: List&lt;Uri&gt;
    ) {
<span class="nc" id="L256">        this.putExtra(EXTRA_MEDIA_URIS, mediaUris.toStringArray())</span>
<span class="nc" id="L257">    }</span>

    private fun Intent.putQueuedUris(
        mediaUris: List&lt;Uri&gt;
    ) {
<span class="nc" id="L262">        this.putExtra(EXTRA_MEDIA_QUEUED_URIS, mediaUris.toStringArray())</span>
<span class="nc" id="L263">    }</span>

    private fun Intent.putMediaIds(
        mediaIds: List&lt;Long&gt;
    ) {
<span class="nc" id="L268">        this.putExtra(MediaBrowserActivity.RESULT_IDS, mediaIds.toLongArray())</span>
<span class="nc" id="L269">        this.putExtra(EXTRA_MEDIA_ID, mediaIds[0])</span>
<span class="nc" id="L270">    }</span>

    private fun Intent.putLocalIds(
        mediaLocalIds: List&lt;Int&gt;
    ) {
<span class="nc" id="L275">        this.putExtra(</span>
<span class="nc" id="L276">                MediaPickerConstants.EXTRA_SAVED_MEDIA_MODEL_LOCAL_IDS,</span>
<span class="nc" id="L277">                mediaLocalIds.toIntArray()</span>
        )
<span class="nc" id="L279">    }</span>

    override fun onItemsChosen(identifiers: List&lt;Identifier&gt;) {
<span class="nc bnc" id="L282" title="All 4 branches missed.">        val chosenLocalUris = identifiers.mapNotNull { (it as? Identifier.LocalUri) }</span>
<span class="nc bnc" id="L283" title="All 4 branches missed.">        val chosenUris = chosenLocalUris.filter { !it.queued }.map { it.value.uri }</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        val queuedUris = chosenLocalUris.filter { it.queued }.map { it.value.uri }</span>
<span class="nc bnc" id="L285" title="All 6 branches missed.">        val chosenIds = identifiers.mapNotNull { (it as? Identifier.RemoteId)?.value }</span>
<span class="nc bnc" id="L286" title="All 6 branches missed.">        val chosenLocalIds = identifiers.mapNotNull { (it as? Identifier.LocalId)?.value }</span>

<span class="nc" id="L288">        val intent = Intent()</span>
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if (!chosenUris.isNullOrEmpty()) {</span>
<span class="nc" id="L290">            intent.putUris(chosenUris)</span>
        }
<span class="nc bnc" id="L292" title="All 4 branches missed.">        if (!queuedUris.isNullOrEmpty()) {</span>
<span class="nc" id="L293">            intent.putQueuedUris(queuedUris)</span>
        }
<span class="nc bnc" id="L295" title="All 4 branches missed.">        if (!chosenIds.isNullOrEmpty()) {</span>
<span class="nc" id="L296">            intent.putMediaIds(chosenIds)</span>
        }
<span class="nc bnc" id="L298" title="All 4 branches missed.">        if (!chosenLocalIds.isNullOrEmpty()) {</span>
<span class="nc" id="L299">            intent.putLocalIds(chosenLocalIds)</span>
        }
<span class="nc bnc" id="L301" title="All 2 branches missed.">        val source = MediaPickerMediaSource.fromDataSource(mediaPickerSetup.primaryDataSource)</span>
<span class="nc" id="L302">        intent.putExtra(</span>
<span class="nc" id="L303">                EXTRA_MEDIA_SOURCE,</span>
<span class="nc" id="L304">                source.name</span>
        )
<span class="nc" id="L306">        setResult(Activity.RESULT_OK, intent)</span>
<span class="nc" id="L307">        finish()</span>
<span class="nc" id="L308">    }</span>

    override fun onIconClicked(action: MediaPickerAction) {
<span class="nc" id="L311">        when (action) {</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            is OpenSystemPicker -&gt; {</span>
<span class="nc" id="L313">                launchChooserWithContext(action, uiHelpers)</span>
            }
<span class="nc bnc" id="L315" title="All 2 branches missed.">            is OpenCameraForWPStories -&gt; launchWPStoriesCamera()</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            is SwitchMediaPicker -&gt; {</span>
<span class="nc" id="L317">                startActivityForResult(buildIntent(this, action.mediaPickerSetup, site, localPostId), PHOTO_PICKER)</span>
            }
<span class="nc bnc" id="L319" title="All 2 branches missed.">            OpenCameraForPhotos -&gt; {</span>
<span class="nc" id="L320">                WPMediaUtils.launchCamera(this, BuildConfig.APPLICATION_ID) { mediaCapturePath = it }</span>
            }
        }
<span class="nc" id="L323">    }</span>

<span class="nc" id="L325">    private fun List&lt;Uri&gt;.toStringArray() = this.map { it.toString() }.toTypedArray()</span>

    companion object {
        private const val PICKER_FRAGMENT_TAG = &quot;picker_fragment_tag&quot;
        private const val KEY_MEDIA_CAPTURE_PATH = &quot;media_capture_path&quot;

<span class="nc" id="L331">        fun buildIntent(</span>
            context: Context,
            mediaPickerSetup: MediaPickerSetup,
<span class="nc" id="L334">            site: SiteModel? = null,</span>
<span class="nc" id="L335">            localPostId: Int? = null</span>
        ): Intent {
<span class="nc" id="L337">            val intent = Intent(context, MediaPickerActivity::class.java)</span>
<span class="nc" id="L338">            mediaPickerSetup.toIntent(intent)</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (site != null) {</span>
<span class="nc" id="L340">                intent.putExtra(WordPress.SITE, site)</span>
            }
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (localPostId != null) {</span>
<span class="nc" id="L343">                intent.putExtra(LOCAL_POST_ID, localPostId)</span>
            }
<span class="nc" id="L345">            return intent</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>