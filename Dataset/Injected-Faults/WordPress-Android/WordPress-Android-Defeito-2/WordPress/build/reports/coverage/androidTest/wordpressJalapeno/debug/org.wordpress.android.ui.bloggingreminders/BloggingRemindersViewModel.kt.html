<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BloggingRemindersViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.bloggingreminders</a> &gt; <span class="el_source">BloggingRemindersViewModel.kt</span></div><h1>BloggingRemindersViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.bloggingreminders

import android.os.Bundle
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.asLiveData
import androidx.lifecycle.distinctUntilChanged
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.flow.collect
import kotlinx.coroutines.flow.combine
import kotlinx.coroutines.flow.map
import org.wordpress.android.fluxc.store.BloggingRemindersStore
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersAnalyticsTracker.Source
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersAnalyticsTracker.Source.BLOGGING_PROMPTS_ONBOARDING
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersAnalyticsTracker.Source.BLOG_SETTINGS
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersAnalyticsTracker.Source.NOTIFICATION_SETTINGS
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersAnalyticsTracker.Source.PUBLISH_FLOW
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersViewModel.Screen.EPILOGUE
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersViewModel.Screen.PROLOGUE
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersViewModel.Screen.PROLOGUE_SETTINGS
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersViewModel.Screen.SELECTION
import org.wordpress.android.ui.utils.ListItemInteraction
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.util.merge
import org.wordpress.android.util.perform
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ScopedViewModel
import org.wordpress.android.workers.reminder.ReminderConfig.WeeklyReminder
import org.wordpress.android.workers.reminder.ReminderScheduler
import java.time.DayOfWeek
import javax.inject.Inject
import javax.inject.Named

@Suppress(&quot;TooManyFunctions&quot;)
<span class="nc" id="L37">class BloggingRemindersViewModel @Inject constructor(</span>
<span class="nc" id="L38">    @Named(UI_THREAD) private val mainDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L39">    private val bloggingRemindersManager: BloggingRemindersManager,</span>
<span class="nc" id="L40">    private val bloggingRemindersStore: BloggingRemindersStore,</span>
<span class="nc" id="L41">    private val prologueBuilder: PrologueBuilder,</span>
<span class="nc" id="L42">    private val daySelectionBuilder: DaySelectionBuilder,</span>
<span class="nc" id="L43">    private val epilogueBuilder: EpilogueBuilder,</span>
<span class="nc" id="L44">    private val dayLabelUtils: DayLabelUtils,</span>
<span class="nc" id="L45">    private val analyticsTracker: BloggingRemindersAnalyticsTracker,</span>
<span class="nc" id="L46">    private val reminderScheduler: ReminderScheduler,</span>
<span class="nc" id="L47">    private val mapper: BloggingRemindersModelMapper,</span>
<span class="nc" id="L48">    private val siteStore: SiteStore</span>
<span class="nc" id="L49">) : ScopedViewModel(mainDispatcher) {</span>
<span class="nc" id="L50">    private val _isBottomSheetShowing = MutableLiveData&lt;Event&lt;Boolean&gt;&gt;()</span>
<span class="nc" id="L51">    val isBottomSheetShowing = _isBottomSheetShowing as LiveData&lt;Event&lt;Boolean&gt;&gt;</span>

<span class="nc" id="L53">    private val _isTimePickerShowing = MutableLiveData&lt;Event&lt;Boolean&gt;&gt;()</span>
<span class="nc" id="L54">    val isTimePickerShowing = _isTimePickerShowing as LiveData&lt;Event&lt;Boolean&gt;&gt;</span>

<span class="nc" id="L56">    private val _showBloggingPromptHelpDialogVisible = MutableLiveData&lt;Event&lt;Boolean&gt;&gt;()</span>
<span class="nc" id="L57">    val showBloggingPromptHelpDialogVisible = _showBloggingPromptHelpDialogVisible as LiveData&lt;Event&lt;Boolean&gt;&gt;</span>

<span class="nc" id="L59">    private val _selectedScreen = MutableLiveData&lt;Screen&gt;()</span>
<span class="nc" id="L60">    private val selectedScreen = _selectedScreen.perform { onScreenChanged(it) }</span>

<span class="nc" id="L62">    private val _bloggingRemindersModel = MutableLiveData&lt;BloggingRemindersUiModel&gt;()</span>
<span class="nc" id="L63">    private val _isFirstTimeFlow = MutableLiveData&lt;Boolean&gt;()</span>

<span class="nc" id="L65">    val uiState: LiveData&lt;UiState&gt; = merge(</span>
<span class="nc" id="L66">            selectedScreen,</span>
<span class="nc" id="L67">            _bloggingRemindersModel,</span>
<span class="nc" id="L68">            _isFirstTimeFlow</span>
    ) { screen, bloggingRemindersModel, isFirstTimeFlow -&gt;
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (screen != null) {</span>
<span class="nc bnc" id="L71" title="All 4 branches missed.">            val uiItems = when (screen) {</span>
<span class="nc" id="L72">                PROLOGUE -&gt; prologueBuilder.buildUiItems()</span>
<span class="nc" id="L73">                PROLOGUE_SETTINGS -&gt; prologueBuilder.buildUiItemsForSettings()</span>
<span class="nc" id="L74">                SELECTION -&gt; daySelectionBuilder.buildSelection(</span>
<span class="nc" id="L75">                        bloggingRemindersModel,</span>
<span class="nc" id="L76">                        this::selectDay,</span>
<span class="nc" id="L77">                        this::selectTime,</span>
<span class="nc" id="L78">                        this::togglePromptSwitch,</span>
<span class="nc" id="L79">                        this::showBloggingPromptDialog</span>
                )
<span class="nc" id="L81">                EPILOGUE -&gt; epilogueBuilder.buildUiItems(bloggingRemindersModel)</span>
            }
<span class="nc bnc" id="L83" title="All 3 branches missed.">            val primaryButton = when (screen) {</span>
<span class="nc" id="L84">                PROLOGUE, PROLOGUE_SETTINGS -&gt; prologueBuilder.buildPrimaryButton(</span>
<span class="nc" id="L85">                        isFirstTimeFlow == true,</span>
<span class="nc" id="L86">                        startDaySelection</span>
                )
<span class="nc" id="L88">                SELECTION -&gt; daySelectionBuilder.buildPrimaryButton(</span>
<span class="nc" id="L89">                        bloggingRemindersModel,</span>
<span class="nc" id="L90">                        isFirstTimeFlow == true,</span>
<span class="nc" id="L91">                        this::showEpilogue</span>
                )
<span class="nc" id="L93">                EPILOGUE -&gt; epilogueBuilder.buildPrimaryButton(finish)</span>
            }
<span class="nc" id="L95">            UiState(uiItems, primaryButton)</span>
        } else {
<span class="nc" id="L97">            UiState(listOf())</span>
        }
<span class="nc" id="L99">    }.distinctUntilChanged()</span>

<span class="nc" id="L101">    private val startDaySelection: (isFirstTimeFlow: Boolean) -&gt; Unit = { isFirstTimeFlow -&gt;</span>
<span class="nc" id="L102">        analyticsTracker.trackPrimaryButtonPressed(PROLOGUE)</span>
<span class="nc" id="L103">        _isFirstTimeFlow.value = isFirstTimeFlow</span>
<span class="nc" id="L104">        _selectedScreen.value = SELECTION</span>
<span class="nc" id="L105">    }</span>

<span class="nc" id="L107">    private val finish: () -&gt; Unit = {</span>
<span class="nc" id="L108">        analyticsTracker.trackPrimaryButtonPressed(EPILOGUE)</span>
<span class="nc" id="L109">        _isBottomSheetShowing.value = Event(false)</span>
<span class="nc" id="L110">    }</span>

    private fun onScreenChanged(screen: Screen) {
<span class="nc" id="L113">        analyticsTracker.trackScreenShown(screen)</span>
<span class="nc" id="L114">    }</span>

<span class="nc" id="L116">    fun getBlogSettingsUiState(siteId: Int) = getUiModel(siteId)</span>
<span class="nc" id="L117">            .map { dayLabelUtils.buildSiteSettingsLabel(it) }</span>
<span class="nc" id="L118">            .asLiveData(mainDispatcher)</span>

<span class="nc" id="L120">    val notificationsSettingsUiState = combine(siteStore.sites.map { getUiModel(it.id) }) { models -&gt;</span>
        models.associate { siteStore.getSiteIdForLocalId(it.siteId) to dayLabelUtils.buildSiteSettingsLabel(it) }
<span class="nc" id="L122">    }.asLiveData(mainDispatcher)</span>

    private fun getUiModel(siteId: Int) =
<span class="nc" id="L125">            bloggingRemindersStore.bloggingRemindersModel(siteId).map { mapper.toUiModel(it) }</span>

    private fun showBottomSheet(siteId: Int, screen: Screen, source: Source) {
<span class="nc" id="L128">        analyticsTracker.setSite(siteId)</span>
<span class="nc" id="L129">        analyticsTracker.trackFlowStart(source)</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">        val isPrologueScreen = screen == PROLOGUE || screen == PROLOGUE_SETTINGS</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (isPrologueScreen) {</span>
<span class="nc" id="L132">            bloggingRemindersManager.bloggingRemindersShown(siteId)</span>
        }
<span class="nc" id="L134">        _isFirstTimeFlow.value = isPrologueScreen</span>
<span class="nc" id="L135">        _isBottomSheetShowing.value = Event(true)</span>
<span class="nc" id="L136">        _selectedScreen.value = screen</span>
<span class="nc" id="L137">        launch {</span>
<span class="nc" id="L138">            bloggingRemindersStore.bloggingRemindersModel(siteId).collect {</span>
                _bloggingRemindersModel.value = mapper.toUiModel(it)
            }
<span class="nc" id="L141">        }</span>
<span class="nc" id="L142">    }</span>

    fun selectDay(day: DayOfWeek) {
<span class="nc" id="L145">        val currentState = _bloggingRemindersModel.value!!</span>
<span class="nc" id="L146">        val enabledDays = currentState.enabledDays.toMutableSet()</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (enabledDays.contains(day)) {</span>
<span class="nc" id="L148">            enabledDays.remove(day)</span>
        } else {
<span class="nc" id="L150">            enabledDays.add(day)</span>
        }
<span class="nc" id="L152">        _bloggingRemindersModel.value = currentState.copy(enabledDays = enabledDays)</span>
<span class="nc" id="L153">    }</span>

    fun selectTime() {
<span class="nc" id="L156">        _isTimePickerShowing.value = Event(true)</span>
<span class="nc" id="L157">    }</span>

    private fun togglePromptSwitch() {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        _bloggingRemindersModel.value?.let { currentState -&gt;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            val newState = !currentState.isPromptIncluded</span>
<span class="nc" id="L162">            analyticsTracker.trackRemindersIncludePromptPressed(newState)</span>
<span class="nc" id="L163">            _bloggingRemindersModel.value = currentState.copy(isPromptIncluded = newState)</span>
<span class="nc" id="L164">        }</span>
<span class="nc" id="L165">    }</span>

    private fun showBloggingPromptDialog() {
<span class="nc" id="L168">        analyticsTracker.trackRemindersIncludePromptHelpPressed()</span>
<span class="nc" id="L169">        _showBloggingPromptHelpDialogVisible.value = Event(true)</span>
<span class="nc" id="L170">    }</span>

    fun onChangeTime(hour: Int, minute: Int) {
<span class="nc" id="L173">        _isTimePickerShowing.value = Event(false)</span>
<span class="nc" id="L174">        val currentState = _bloggingRemindersModel.value!!</span>
<span class="nc" id="L175">        _bloggingRemindersModel.value = currentState.copy(hour = hour, minute = minute)</span>
<span class="nc" id="L176">    }</span>

    fun getSelectedTime(): Pair&lt;Int, Int&gt; {
<span class="nc" id="L179">        val currentState = _bloggingRemindersModel.value!!</span>
<span class="nc" id="L180">        return Pair(currentState.hour, currentState.minute)</span>
    }

    private fun showEpilogue(bloggingRemindersModel: BloggingRemindersUiModel?) {
<span class="nc" id="L184">        analyticsTracker.trackPrimaryButtonPressed(SELECTION)</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (bloggingRemindersModel != null) {</span>
<span class="nc" id="L186">            launch {</span>
<span class="nc" id="L187">                bloggingRemindersStore.updateBloggingReminders(</span>
<span class="nc" id="L188">                        mapper.toDomainModel(</span>
<span class="nc" id="L189">                                bloggingRemindersModel</span>
                        )
                )
<span class="nc" id="L192">                val daysCount = bloggingRemindersModel.enabledDays.size</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if (daysCount &gt; 0) {</span>
<span class="nc" id="L194">                    reminderScheduler.schedule(</span>
<span class="nc" id="L195">                            bloggingRemindersModel.siteId,</span>
<span class="nc" id="L196">                            bloggingRemindersModel.hour,</span>
<span class="nc" id="L197">                            bloggingRemindersModel.minute,</span>
<span class="nc" id="L198">                            bloggingRemindersModel.toReminderConfig()</span>
                    )
<span class="nc" id="L200">                    analyticsTracker.trackRemindersScheduled(</span>
<span class="nc" id="L201">                            daysCount, bloggingRemindersModel.getNotificationTime24hour()</span>
                    )
                } else {
<span class="nc" id="L204">                    reminderScheduler.cancelBySiteId(bloggingRemindersModel.siteId)</span>
<span class="nc" id="L205">                    analyticsTracker.trackRemindersCancelled()</span>
                }
<span class="nc" id="L207">                _selectedScreen.value = EPILOGUE</span>
<span class="nc" id="L208">            }</span>
        }
<span class="nc" id="L210">    }</span>

    fun saveState(outState: Bundle) {
<span class="nc bnc" id="L213" title="All 2 branches missed.">        _selectedScreen.value?.let {</span>
<span class="nc" id="L214">            outState.putSerializable(SELECTED_SCREEN, it)</span>
<span class="nc" id="L215">        }</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        _bloggingRemindersModel.value?.let { model -&gt;</span>
<span class="nc" id="L217">            outState.putInt(SITE_ID, model.siteId)</span>
<span class="nc" id="L218">            outState.putStringArrayList(SELECTED_DAYS, ArrayList(model.enabledDays.map { it.name }))</span>
<span class="nc" id="L219">            outState.putInt(SELECTED_HOUR, model.hour)</span>
<span class="nc" id="L220">            outState.putInt(SELECTED_MINUTE, model.minute)</span>
<span class="nc" id="L221">            outState.putBoolean(IS_BLOGGING_PROMPT_INCLUDED, model.isPromptIncluded)</span>
<span class="nc" id="L222">        }</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        _isFirstTimeFlow.value?.let {</span>
<span class="nc" id="L224">            outState.putBoolean(IS_FIRST_TIME_FLOW, it)</span>
<span class="nc" id="L225">        }</span>
<span class="nc" id="L226">    }</span>

    fun restoreState(state: Bundle) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">        state.getSerializable(SELECTED_SCREEN)?.let {</span>
<span class="nc" id="L230">            _selectedScreen.value = it as Screen</span>
<span class="nc" id="L231">        }</span>
<span class="nc" id="L232">        val siteId = state.getInt(SITE_ID)</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (siteId != 0) {</span>
<span class="nc bnc" id="L234" title="All 4 branches missed.">            val enabledDays = state.getStringArrayList(SELECTED_DAYS)?.map { DayOfWeek.valueOf(it) }?.toSet() ?: setOf()</span>
<span class="nc" id="L235">            val selectedHour = state.getInt(SELECTED_HOUR)</span>
<span class="nc" id="L236">            val selectedMinute = state.getInt(SELECTED_MINUTE)</span>
<span class="nc" id="L237">            val isPromptIncluded = state.getBoolean(IS_BLOGGING_PROMPT_INCLUDED)</span>
<span class="nc" id="L238">            _bloggingRemindersModel.value = BloggingRemindersUiModel(</span>
<span class="nc" id="L239">                    siteId,</span>
<span class="nc" id="L240">                    enabledDays,</span>
<span class="nc" id="L241">                    selectedHour,</span>
<span class="nc" id="L242">                    selectedMinute,</span>
<span class="nc" id="L243">                    isPromptIncluded</span>
            )
        }
<span class="nc" id="L246">        _isFirstTimeFlow.value = state.getBoolean(IS_FIRST_TIME_FLOW)</span>
<span class="nc" id="L247">    }</span>

    fun onPublishingPost(siteId: Int, isFirstTimePublishing: Boolean?) {
<span class="nc bnc" id="L250" title="All 4 branches missed.">        if (isFirstTimePublishing == true &amp;&amp; bloggingRemindersManager.shouldShowBloggingRemindersPrompt(siteId)) {</span>
<span class="nc" id="L251">            showBottomSheet(siteId, PROLOGUE, PUBLISH_FLOW)</span>
        }
<span class="nc" id="L253">    }</span>

    fun onBlogSettingsItemClicked(siteId: Int) {
<span class="nc" id="L256">        onSettingsItemClicked(siteId, BLOG_SETTINGS)</span>
<span class="nc" id="L257">    }</span>

    fun onNotificationSettingsItemClicked(remoteSiteId: Long) {
<span class="nc" id="L260">        onSettingsItemClicked(siteStore.getLocalIdForRemoteSiteId(remoteSiteId), NOTIFICATION_SETTINGS)</span>
<span class="nc" id="L261">    }</span>

    fun onBloggingPromptSchedulingRequested(siteId: Int) {
<span class="nc" id="L264">        showBottomSheet(siteId, PROLOGUE, BLOGGING_PROMPTS_ONBOARDING)</span>
<span class="nc" id="L265">    }</span>

    private fun onSettingsItemClicked(siteId: Int, source: Source) {
<span class="nc" id="L268">        launch {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            val screen = if (bloggingRemindersStore.hasModifiedBloggingReminders(siteId)) {</span>
<span class="nc" id="L270">                SELECTION</span>
            } else {
<span class="nc" id="L272">                PROLOGUE_SETTINGS</span>
            }
<span class="nc" id="L274">            showBottomSheet(siteId, screen, source)</span>
<span class="nc" id="L275">        }</span>
<span class="nc" id="L276">    }</span>

    fun onBottomSheetDismissed() {
<span class="nc bnc" id="L279" title="All 5 branches missed.">        when (val screen = selectedScreen.value) {</span>
            PROLOGUE,
            PROLOGUE_SETTINGS,
<span class="nc" id="L282">            SELECTION -&gt; analyticsTracker.trackFlowDismissed(screen)</span>
<span class="nc" id="L283">            EPILOGUE -&gt; analyticsTracker.trackFlowCompleted()</span>
        }
<span class="nc" id="L285">    }</span>

    private fun BloggingRemindersUiModel.toReminderConfig() =
<span class="nc" id="L288">            WeeklyReminder(this.enabledDays)</span>

<span class="nc" id="L290">    enum class Screen(val trackingName: String) {</span>
<span class="nc" id="L291">        PROLOGUE(&quot;main&quot;), // displayed after post is published</span>
<span class="nc" id="L292">        PROLOGUE_SETTINGS(&quot;main&quot;), // displayed from Site Settings before showing cadence selector</span>
<span class="nc" id="L293">        SELECTION(&quot;day_picker&quot;), // cadence selector</span>
<span class="nc" id="L294">        EPILOGUE(&quot;all_set&quot;)</span>
    }

<span class="nc" id="L297">    data class UiState(</span>
<span class="nc" id="L298">        val uiItems: List&lt;BloggingRemindersItem&gt;,</span>
<span class="nc" id="L299">        val primaryButton: PrimaryButton? = null</span>
    ) {
<span class="nc" id="L301">        data class PrimaryButton(val text: UiString, val enabled: Boolean, val onClick: ListItemInteraction)</span>
<span class="nc" id="L302">    }</span>

    companion object {
        private const val SELECTED_SCREEN = &quot;key_shown_screen&quot;
        private const val SELECTED_DAYS = &quot;key_selected_days&quot;
        private const val SELECTED_HOUR = &quot;key_selected_hour&quot;
        private const val SELECTED_MINUTE = &quot;key_selected_minute&quot;
        private const val IS_BLOGGING_PROMPT_INCLUDED = &quot;key_is_blogging_prompt_included&quot;
        private const val IS_FIRST_TIME_FLOW = &quot;is_first_time_flow&quot;
        private const val SITE_ID = &quot;key_site_id&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>