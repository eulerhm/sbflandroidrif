<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderBlogFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader</a> &gt; <span class="el_source">ReaderBlogFragment.java</span></div><h1>ReaderBlogFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader;

import android.os.Bundle;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;

import androidx.annotation.NonNull;
import androidx.appcompat.widget.SearchView;
import androidx.fragment.app.Fragment;

import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.datasets.ReaderTagTable;
import org.wordpress.android.models.ReaderBlog;
import org.wordpress.android.models.ReaderTag;
import org.wordpress.android.ui.ActionableEmptyView;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.reader.adapters.ReaderBlogAdapter;
import org.wordpress.android.ui.reader.adapters.ReaderBlogAdapter.ReaderBlogType;
import org.wordpress.android.ui.reader.tracker.ReaderTracker;
import org.wordpress.android.ui.reader.utils.ReaderUtils;
import org.wordpress.android.ui.reader.views.ReaderRecyclerView;
import org.wordpress.android.util.AppLog;

import javax.inject.Inject;

/*
 * fragment hosted by ReaderSubsActivity which shows followed blogs
 */
<span class="nc" id="L36">public class ReaderBlogFragment extends Fragment</span>
        implements ReaderBlogAdapter.BlogClickListener {
    private ReaderRecyclerView mRecyclerView;
    private ReaderBlogAdapter mAdapter;
    private ReaderBlogType mBlogType;
    private String mSearchFilter;
    private boolean mIgnoreNextSearch;

    @Inject ReaderTracker mReaderTracker;

    private static final String ARG_BLOG_TYPE = &quot;blog_type&quot;;
    private static final String KEY_SEARCH_FILTER = &quot;search_filter&quot;;

    static ReaderBlogFragment newInstance(ReaderBlogType blogType) {
<span class="nc" id="L50">        AppLog.d(AppLog.T.READER, &quot;reader blog fragment &gt; newInstance&quot;);</span>
<span class="nc" id="L51">        Bundle args = new Bundle();</span>
<span class="nc" id="L52">        args.putSerializable(ARG_BLOG_TYPE, blogType);</span>
<span class="nc" id="L53">        ReaderBlogFragment fragment = new ReaderBlogFragment();</span>
<span class="nc" id="L54">        fragment.setArguments(args);</span>
<span class="nc" id="L55">        return fragment;</span>
    }

    @Override
    public void setArguments(Bundle args) {
<span class="nc" id="L60">        super.setArguments(args);</span>
<span class="nc" id="L61">        restoreState(args);</span>
<span class="nc" id="L62">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L66">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L67">        ((WordPress) getActivity().getApplication()).component().inject(this);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L69">            AppLog.d(AppLog.T.READER, &quot;reader blog fragment &gt; restoring instance state&quot;);</span>
<span class="nc" id="L70">            mIgnoreNextSearch = true;</span>
<span class="nc" id="L71">            restoreState(savedInstanceState);</span>
        }
<span class="nc" id="L73">    }</span>

    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L77">        View view = inflater.inflate(R.layout.reader_fragment_list, container, false);</span>
<span class="nc" id="L78">        mRecyclerView = view.findViewById(R.id.recycler_view);</span>

        // options menu (with search) only appears for followed blogs
<span class="nc bnc" id="L81" title="All 2 branches missed.">        setHasOptionsMenu(getBlogType() == ReaderBlogType.FOLLOWED);</span>

<span class="nc" id="L83">        return view;</span>
    }

    private void checkEmptyView() {
<span class="nc bnc" id="L87" title="All 4 branches missed.">        if (!isAdded() || getView() == null) {</span>
<span class="nc" id="L88">            return;</span>
        }

<span class="nc" id="L91">        ActionableEmptyView actionableEmptyView = getView().findViewById(R.id.actionable_empty_view);</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (actionableEmptyView == null) {</span>
<span class="nc" id="L94">            return;</span>
        }

<span class="nc bnc" id="L97" title="All 4 branches missed.">        if (hasBlogAdapter() &amp;&amp; getBlogAdapter().isEmpty()) {</span>
<span class="nc" id="L98">            actionableEmptyView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L99">            actionableEmptyView.image.setImageResource(R.drawable.img_illustration_following_empty_results_196dp);</span>
<span class="nc" id="L100">            actionableEmptyView.subtitle.setText(R.string.reader_empty_followed_blogs_description);</span>
<span class="nc" id="L101">            actionableEmptyView.button.setText(R.string.reader_empty_followed_blogs_button_discover);</span>
<span class="nc" id="L102">            actionableEmptyView.button.setOnClickListener(new OnClickListener() {</span>
                @Override public void onClick(View view) {
<span class="nc" id="L104">                    ReaderTag tag = ReaderUtils.getTagFromEndpoint(ReaderTag.DISCOVER_PATH);</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">                    if (!ReaderTagTable.tagExists(tag)) {</span>
<span class="nc" id="L107">                        tag = ReaderTagTable.getFirstTag();</span>
                    }

<span class="nc" id="L110">                    AppPrefs.setReaderTag(tag);</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">                    if (getActivity() != null) {</span>
<span class="nc" id="L113">                        getActivity().finish();</span>
                    }
<span class="nc" id="L115">                }</span>
            });

<span class="nc bnc" id="L118" title="All 2 branches missed.">            switch (getBlogType()) {</span>
                case FOLLOWED:
<span class="nc bnc" id="L120" title="All 2 branches missed.">                    if (getBlogAdapter().hasSearchFilter()) {</span>
<span class="nc" id="L121">                        actionableEmptyView.updateLayoutForSearch(true, 0);</span>
<span class="nc" id="L122">                        actionableEmptyView.title.setText(R.string.reader_empty_followed_blogs_search_title);</span>
<span class="nc" id="L123">                        actionableEmptyView.subtitle.setVisibility(View.GONE);</span>
<span class="nc" id="L124">                        actionableEmptyView.button.setVisibility(View.GONE);</span>
<span class="nc" id="L125">                        actionableEmptyView.image.setVisibility(View.GONE);</span>
                    } else {
<span class="nc" id="L127">                        actionableEmptyView.updateLayoutForSearch(false, 0);</span>
<span class="nc" id="L128">                        actionableEmptyView.title.setText(R.string.reader_empty_followed_blogs_title);</span>
<span class="nc" id="L129">                        actionableEmptyView.subtitle.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L130">                        actionableEmptyView.button.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L131">                        actionableEmptyView.image.setVisibility(View.VISIBLE);</span>
                    }
<span class="nc" id="L133">                    break;</span>
            }
        } else {
<span class="nc" id="L136">            actionableEmptyView.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L138">    }</span>

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L142">        super.onActivityCreated(savedInstanceState);</span>
<span class="nc" id="L143">        mRecyclerView.setAdapter(getBlogAdapter());</span>
<span class="nc" id="L144">    }</span>

    @Override
    public void onSaveInstanceState(@NonNull Bundle outState) {
<span class="nc" id="L148">        outState.putSerializable(ARG_BLOG_TYPE, getBlogType());</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (getBlogAdapter().hasSearchFilter()) {</span>
<span class="nc" id="L150">            outState.putString(KEY_SEARCH_FILTER, getBlogAdapter().getSearchFilter());</span>
        }
<span class="nc" id="L152">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L153">    }</span>

    private void restoreState(Bundle args) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (args != null) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (args.containsKey(ARG_BLOG_TYPE)) {</span>
<span class="nc" id="L158">                mBlogType = (ReaderBlogType) args.getSerializable(ARG_BLOG_TYPE);</span>
            }
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (args.containsKey(KEY_SEARCH_FILTER)) {</span>
<span class="nc" id="L161">                mSearchFilter = args.getString(KEY_SEARCH_FILTER);</span>
            }
        }
<span class="nc" id="L164">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L168">        super.onResume();</span>
<span class="nc" id="L169">        refresh();</span>
<span class="nc" id="L170">    }</span>

    /*
     * note this will only be called for followed blogs
     */
    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span class="nc" id="L177">        super.onCreateOptionsMenu(menu, inflater);</span>
<span class="nc" id="L178">        inflater.inflate(R.menu.reader_subs, menu);</span>

<span class="nc" id="L180">        MenuItem searchMenu = menu.findItem(R.id.menu_search);</span>
<span class="nc" id="L181">        SearchView searchView = (SearchView) searchMenu.getActionView();</span>
<span class="nc" id="L182">        searchView.setMaxWidth(Integer.MAX_VALUE);</span>
<span class="nc" id="L183">        searchView.setQueryHint(getString(R.string.reader_hint_search_followed_sites));</span>

<span class="nc" id="L185">        searchMenu.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {</span>
            @Override
            public boolean onMenuItemActionExpand(MenuItem item) {
<span class="nc" id="L188">                return true;</span>
            }

            @Override
            public boolean onMenuItemActionCollapse(MenuItem item) {
<span class="nc" id="L193">                return true;</span>
            }
        });

<span class="nc" id="L197">        searchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {</span>
            @Override
            public boolean onQueryTextSubmit(String query) {
<span class="nc" id="L200">                setSearchFilter(query);</span>
<span class="nc" id="L201">                return false;</span>
            }

            @Override
            public boolean onQueryTextChange(String newText) {
                // when the fragment is recreated this will be called with an empty query
                // string, causing the existing search query to be lost - work around this
                // by ignoring the next search performed after recreation
<span class="nc bnc" id="L209" title="All 2 branches missed.">                if (mIgnoreNextSearch) {</span>
<span class="nc" id="L210">                    mIgnoreNextSearch = false;</span>
<span class="nc" id="L211">                    AppLog.i(AppLog.T.READER, &quot;reader subs &gt; ignoring search&quot;);</span>
                } else {
<span class="nc" id="L213">                    setSearchFilter(newText);</span>
                }
<span class="nc" id="L215">                return false;</span>
            }
        });

        // make sure the search view is expanded and reflects the current filter
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (!TextUtils.isEmpty(mSearchFilter)) {</span>
<span class="nc" id="L221">            searchMenu.expandActionView();</span>
<span class="nc" id="L222">            searchView.clearFocus();</span>
<span class="nc" id="L223">            searchView.setQuery(mSearchFilter, false);</span>
        }
<span class="nc" id="L225">    }</span>

    void refresh() {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (hasBlogAdapter()) {</span>
<span class="nc" id="L229">            AppLog.d(AppLog.T.READER, &quot;reader subs &gt; refreshing blog fragment &quot; + getBlogType().name());</span>
<span class="nc" id="L230">            getBlogAdapter().refresh();</span>
        }
<span class="nc" id="L232">    }</span>

    private void setSearchFilter(String constraint) {
<span class="nc" id="L235">        mSearchFilter = constraint;</span>
<span class="nc" id="L236">        getBlogAdapter().setSearchFilter(constraint);</span>
<span class="nc" id="L237">    }</span>

    private boolean hasBlogAdapter() {
<span class="nc bnc" id="L240" title="All 2 branches missed.">        return (mAdapter != null);</span>
    }

    private ReaderBlogAdapter getBlogAdapter() {
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (mAdapter == null) {</span>
<span class="nc" id="L245">            mAdapter = new ReaderBlogAdapter(</span>
<span class="nc" id="L246">                    getActivity(),</span>
<span class="nc" id="L247">                    getBlogType(),</span>
                    mSearchFilter,
                    ReaderTracker.SOURCE_SETTINGS
            );
<span class="nc" id="L251">            mAdapter.setBlogClickListener(this);</span>
<span class="nc" id="L252">            mAdapter.setDataLoadedListener(new ReaderInterfaces.DataLoadedListener() {</span>
                @Override
                public void onDataLoaded(boolean isEmpty) {
<span class="nc" id="L255">                    checkEmptyView();</span>
<span class="nc" id="L256">                }</span>
            });
        }
<span class="nc" id="L259">        return mAdapter;</span>
    }

    public ReaderBlogType getBlogType() {
<span class="nc" id="L263">        return mBlogType;</span>
    }

    @Override
    public void onBlogClicked(Object item) {
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (item instanceof ReaderBlog) {</span>
<span class="nc" id="L269">            ReaderBlog blog = (ReaderBlog) item;</span>
<span class="nc" id="L270">            ReaderActivityLauncher.showReaderBlogOrFeedPreview(</span>
<span class="nc" id="L271">                    getActivity(),</span>
                    blog.blogId,
                    blog.feedId,
<span class="nc" id="L274">                    blog.isFollowing,</span>
                    ReaderTracker.SOURCE_SETTINGS,
                    mReaderTracker
            );
        }
<span class="nc" id="L279">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>