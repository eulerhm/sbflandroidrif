<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderInterestsViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.discover.interests</a> &gt; <span class="el_source">ReaderInterestsViewModel.kt</span></div><h1>ReaderInterestsViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.discover.interests

import androidx.annotation.StringRes
import androidx.lifecycle.LiveData
import androidx.lifecycle.MediatorLiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import kotlinx.coroutines.launch
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker
import org.wordpress.android.models.ReaderTag
import org.wordpress.android.models.ReaderTagList
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsFragment.EntryPoint
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsViewModel.DoneButtonUiState.DoneButtonDisabledUiState
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsViewModel.DoneButtonUiState.DoneButtonEnabledUiState
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsViewModel.DoneButtonUiState.DoneButtonHiddenUiState
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsViewModel.UiState.ContentUiState
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsViewModel.UiState.ErrorUiState.ConnectionErrorUiState
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsViewModel.UiState.ErrorUiState.RequestFailedErrorUiState
import org.wordpress.android.ui.reader.discover.interests.ReaderInterestsViewModel.UiState.InitialLoadingUiState
import org.wordpress.android.ui.reader.repository.ReaderRepositoryCommunication.Error
import org.wordpress.android.ui.reader.repository.ReaderRepositoryCommunication.Error.NetworkUnavailable
import org.wordpress.android.ui.reader.repository.ReaderRepositoryCommunication.Error.RemoteRequestFailure
import org.wordpress.android.ui.reader.repository.ReaderRepositoryCommunication.Success
import org.wordpress.android.ui.reader.repository.ReaderRepositoryCommunication.SuccessWithData
import org.wordpress.android.ui.reader.repository.ReaderTagRepository
import org.wordpress.android.ui.reader.tracker.ReaderTracker
import org.wordpress.android.ui.reader.viewmodels.ReaderViewModel
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.viewmodel.Event
import javax.inject.Inject

<span class="nc" id="L35">class ReaderInterestsViewModel @Inject constructor(</span>
<span class="nc" id="L36">    private val readerTagRepository: ReaderTagRepository,</span>
<span class="nc" id="L37">    private val readerTracker: ReaderTracker</span>
<span class="nc" id="L38">) : ViewModel() {</span>
    private var isStarted = false
    private lateinit var currentLanguage: String
    private var parentViewModel: ReaderViewModel? = null

<span class="nc" id="L43">    private var entryPoint = EntryPoint.DISCOVER</span>
<span class="nc" id="L44">    private var userTags = ReaderTagList()</span>

<span class="nc" id="L46">    private val _uiState: MutableLiveData&lt;UiState&gt; = MutableLiveData()</span>
<span class="nc" id="L47">    val uiState: LiveData&lt;UiState&gt; = _uiState</span>

<span class="nc" id="L49">    private val _snackbarEvents = MediatorLiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt;()</span>
<span class="nc" id="L50">    val snackbarEvents: LiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt; = _snackbarEvents</span>

<span class="nc" id="L52">    private val _closeReaderInterests = MutableLiveData&lt;Event&lt;Unit&gt;&gt;()</span>
<span class="nc" id="L53">    val closeReaderInterests: LiveData&lt;Event&lt;Unit&gt;&gt; = _closeReaderInterests</span>

    private var userTagsFetchedSuccessfully = false

    fun start(
        currentLanguage: String,
        parentViewModel: ReaderViewModel?,
        entryPoint: EntryPoint
    ) {
<span class="nc bnc" id="L62" title="All 6 branches missed.">        if (isStarted &amp;&amp; this.currentLanguage == currentLanguage) {</span>
<span class="nc" id="L63">            return</span>
        }
<span class="nc" id="L65">        isStarted = true</span>
<span class="nc" id="L66">        this.currentLanguage = currentLanguage</span>
<span class="nc" id="L67">        this.parentViewModel = parentViewModel</span>
<span class="nc" id="L68">        this.entryPoint = entryPoint</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        parentViewModel?.dismissQuickStartSnackbarIfNeeded()</span>
<span class="nc" id="L70">        loadUserTags()</span>
<span class="nc" id="L71">    }</span>

    private fun loadUserTags() {
<span class="nc" id="L74">        updateUiState(InitialLoadingUiState)</span>
<span class="nc" id="L75">        viewModelScope.launch {</span>
<span class="nc" id="L76">            when (val result = readerTagRepository.getUserTags()) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">                is SuccessWithData&lt;*&gt; -&gt; {</span>
<span class="nc" id="L78">                    userTagsFetchedSuccessfully = true</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                    userTags = result.data as ReaderTagList</span>
<span class="nc bnc" id="L80" title="All 3 branches missed.">                    when (entryPoint) {</span>
<span class="nc" id="L81">                        EntryPoint.DISCOVER -&gt; checkAndLoadInterests(userTags)</span>
<span class="nc" id="L82">                        EntryPoint.SETTINGS -&gt; loadInterests(userTags)</span>
                    }
                }
<span class="nc bnc" id="L85" title="All 2 branches missed.">                is Error -&gt; {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">                    if (result is NetworkUnavailable) {</span>
<span class="nc" id="L87">                        updateUiState(ConnectionErrorUiState)</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                    } else if (result is RemoteRequestFailure) {</span>
<span class="nc" id="L89">                        updateUiState(RequestFailedErrorUiState)</span>
                    }
                }
            }
<span class="nc" id="L93">        }</span>
<span class="nc" id="L94">    }</span>

    private fun checkAndLoadInterests(userTags: ReaderTagList) {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (userTags.isEmpty()) {</span>
<span class="nc" id="L98">            loadInterests(userTags)</span>
        } else {
<span class="nc bnc" id="L100" title="All 2 branches missed.">            parentViewModel?.onCloseReaderInterests()</span>
        }
<span class="nc" id="L102">    }</span>

    private fun loadInterests(userTags: ReaderTagList) {
<span class="nc" id="L105">        updateUiState(InitialLoadingUiState)</span>
<span class="nc" id="L106">        viewModelScope.launch {</span>
<span class="nc" id="L107">            val newUiState: UiState? = when (val result = readerTagRepository.getInterests()) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                is SuccessWithData&lt;*&gt; -&gt; {</span>
<span class="nc" id="L109">                    readerTracker.track(AnalyticsTracker.Stat.SELECT_INTERESTS_SHOWN)</span>

<span class="nc bnc" id="L111" title="All 4 branches missed.">                    val tags = (result.data as ReaderTagList).filter { checkAndExcludeTag(userTags, it) }</span>
<span class="nc" id="L112">                    val distinctTags = ReaderTagList().apply { addAll(tags.distinctBy { it.tagSlug }) }</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                    when (entryPoint) {</span>
<span class="nc" id="L114">                        EntryPoint.DISCOVER -&gt; ContentUiState(</span>
<span class="nc" id="L115">                                interestsUiState = transformToInterestsUiState(distinctTags),</span>
<span class="nc" id="L116">                                interests = distinctTags,</span>
<span class="nc" id="L117">                                doneButtonUiState = DoneButtonDisabledUiState(),</span>
<span class="nc" id="L118">                                titleVisible = true</span>
                        )
<span class="nc" id="L120">                        EntryPoint.SETTINGS -&gt; ContentUiState(</span>
<span class="nc" id="L121">                                interestsUiState = transformToInterestsUiState(distinctTags),</span>
<span class="nc" id="L122">                                interests = distinctTags,</span>
<span class="nc" id="L123">                                doneButtonUiState = DoneButtonDisabledUiState(R.string.reader_btn_done),</span>
<span class="nc" id="L124">                                titleVisible = false</span>
                        )
                    }
                }
<span class="nc bnc" id="L128" title="All 2 branches missed.">                is NetworkUnavailable -&gt; {</span>
<span class="nc" id="L129">                    ConnectionErrorUiState</span>
                }
<span class="nc bnc" id="L131" title="All 2 branches missed.">                is RemoteRequestFailure -&gt; {</span>
<span class="nc" id="L132">                    RequestFailedErrorUiState</span>
                }
                else -&gt; {
<span class="nc" id="L135">                    null</span>
                }
            }

<span class="nc bnc" id="L139" title="All 2 branches missed.">            newUiState?.let {</span>
<span class="nc" id="L140">                updateUiState(it)</span>
<span class="nc" id="L141">            }</span>
<span class="nc" id="L142">        }</span>
<span class="nc" id="L143">    }</span>

    private fun checkAndExcludeTag(userTags: ReaderTagList, tag: ReaderTag): Boolean {
<span class="nc" id="L146">        var contain = false</span>
<span class="nc" id="L147">        userTags.forEach { excludedTag -&gt;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            if (excludedTag.tagSlug.equals(tag.tagSlug)) {</span>
<span class="nc" id="L149">                contain = true</span>
<span class="nc" id="L150">                return@forEach</span>
            }
<span class="nc" id="L152">        }</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        return !contain</span>
    }

    fun onInterestAtIndexToggled(index: Int, isChecked: Boolean) {
<span class="nc bnc" id="L157" title="All 2 branches missed.">        uiState.value?.let {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            val currentUiState = uiState.value as ContentUiState</span>
<span class="nc" id="L159">            val updatedInterestsUiState = getUpdatedInterestsUiState(index, isChecked)</span>

<span class="nc" id="L161">            updateUiState(</span>
<span class="nc" id="L162">                    currentUiState.copy(</span>
<span class="nc" id="L163">                            interestsUiState = updatedInterestsUiState,</span>
<span class="nc" id="L164">                            doneButtonUiState = currentUiState.getDoneButtonState(</span>
<span class="nc" id="L165">                                    entryPoint = entryPoint,</span>
<span class="nc" id="L166">                                    isInterestChecked = isChecked</span>
                            )
                    )
            )

<span class="nc bnc" id="L171" title="All 2 branches missed.">            parentViewModel?.completeQuickStartFollowSiteTaskIfNeeded()</span>
        }
<span class="nc" id="L173">    }</span>

    fun onDoneButtonClick() {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        val contentUiState = uiState.value as ContentUiState</span>

<span class="nc" id="L178">        updateUiState(</span>
<span class="nc" id="L179">                contentUiState.copy(</span>
<span class="nc" id="L180">                        progressBarVisible = true,</span>
<span class="nc" id="L181">                        doneButtonUiState = DoneButtonDisabledUiState(R.string.reader_btn_done)</span>
                )
        )

<span class="nc" id="L185">        trackInterests(contentUiState.getSelectedInterests())</span>

<span class="nc" id="L187">        viewModelScope.launch {</span>
<span class="nc" id="L188">            readerTagRepository.clearTagLastUpdated(ReaderTag.createDiscoverPostCardsTag())</span>
<span class="nc" id="L189">            when (val result = readerTagRepository.saveInterests(contentUiState.getSelectedInterests())) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                is Success -&gt; {</span>
<span class="nc bnc" id="L191" title="All 3 branches missed.">                    when (entryPoint) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                        EntryPoint.DISCOVER -&gt; parentViewModel?.onCloseReaderInterests()</span>
<span class="nc" id="L193">                        EntryPoint.SETTINGS -&gt; _closeReaderInterests.value = Event(Unit)</span>
                    }
                }
<span class="nc bnc" id="L196" title="All 2 branches missed.">                is Error -&gt; {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                    if (result is NetworkUnavailable) {</span>
<span class="nc" id="L198">                        _snackbarEvents.postValue(</span>
<span class="nc" id="L199">                                Event(SnackbarMessageHolder(UiStringRes(R.string.no_network_message)))</span>
                        )
<span class="nc bnc" id="L201" title="All 2 branches missed.">                    } else if (result is RemoteRequestFailure) {</span>
<span class="nc" id="L202">                        _snackbarEvents.postValue(</span>
<span class="nc" id="L203">                                Event(SnackbarMessageHolder(UiStringRes(R.string.reader_error_request_failed_title)))</span>
                        )
                    }
<span class="nc" id="L206">                    updateUiState(</span>
<span class="nc" id="L207">                            contentUiState.copy(</span>
<span class="nc" id="L208">                                    progressBarVisible = false,</span>
<span class="nc" id="L209">                                    doneButtonUiState = DoneButtonEnabledUiState(R.string.reader_btn_done)</span>
                            )
                    )
                }
            }
<span class="nc" id="L214">        }</span>
<span class="nc" id="L215">    }</span>

    fun onRetryButtonClick() {
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (!userTagsFetchedSuccessfully) {</span>
<span class="nc" id="L219">            loadUserTags()</span>
        } else {
<span class="nc" id="L221">            loadInterests(userTags)</span>
        }
<span class="nc" id="L223">    }</span>

    private fun transformToInterestsUiState(interests: ReaderTagList) =
<span class="nc" id="L226">            interests.map { interest -&gt;</span>
<span class="nc" id="L227">                TagUiState(interest.tagTitle, interest.tagSlug)</span>
<span class="nc" id="L228">            }</span>

    private fun getUpdatedInterestsUiState(index: Int, isChecked: Boolean): List&lt;TagUiState&gt; {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        val currentUiState = uiState.value as ContentUiState</span>
<span class="nc" id="L232">        val newInterestsUiState = currentUiState.interestsUiState.toMutableList()</span>
<span class="nc" id="L233">        newInterestsUiState[index] = currentUiState.interestsUiState[index].copy(isChecked = isChecked)</span>
<span class="nc" id="L234">        return newInterestsUiState</span>
    }

    private fun updateUiState(uiState: UiState) {
<span class="nc" id="L238">        _uiState.value = uiState</span>
<span class="nc" id="L239">    }</span>

    private fun trackInterests(tags: List&lt;ReaderTag&gt;) {
<span class="nc" id="L242">        tags.forEach {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            val source = when (entryPoint) {</span>
<span class="nc" id="L244">                EntryPoint.DISCOVER -&gt; ReaderTracker.SOURCE_DISCOVER</span>
<span class="nc" id="L245">                EntryPoint.SETTINGS -&gt; ReaderTracker.SOURCE_SETTINGS</span>
            }
<span class="nc" id="L247">            readerTracker.trackTag(</span>
<span class="nc" id="L248">                    AnalyticsTracker.Stat.READER_TAG_FOLLOWED,</span>
<span class="nc" id="L249">                    it.tagSlug,</span>
<span class="nc" id="L250">                    source</span>
            )
<span class="nc" id="L252">        }</span>
<span class="nc" id="L253">        readerTracker.trackTagQuantity(AnalyticsTracker.Stat.SELECT_INTERESTS_PICKED, tags.size)</span>
<span class="nc" id="L254">    }</span>

    fun onBackButtonClick() {
<span class="nc bnc" id="L257" title="All 3 branches missed.">        when (entryPoint) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            EntryPoint.DISCOVER -&gt; parentViewModel?.onCloseReaderInterests()</span>
<span class="nc" id="L259">            EntryPoint.SETTINGS -&gt; _closeReaderInterests.value = Event(Unit)</span>
        }
<span class="nc" id="L261">    }</span>

<span class="nc" id="L263">    sealed class UiState(</span>
<span class="nc" id="L264">        open val doneButtonUiState: DoneButtonUiState = DoneButtonHiddenUiState,</span>
<span class="nc" id="L265">        open val progressBarVisible: Boolean = false,</span>
<span class="nc" id="L266">        open val titleVisible: Boolean = false,</span>
<span class="nc" id="L267">        val errorLayoutVisible: Boolean = false</span>
    ) {
<span class="nc" id="L269">        object InitialLoadingUiState : UiState(</span>
<span class="nc" id="L270">                progressBarVisible = true</span>
        )

<span class="nc" id="L273">        data class ContentUiState(</span>
<span class="nc" id="L274">            val interestsUiState: List&lt;TagUiState&gt;,</span>
<span class="nc" id="L275">            val interests: ReaderTagList,</span>
<span class="nc" id="L276">            override val progressBarVisible: Boolean = false,</span>
<span class="nc" id="L277">            override val doneButtonUiState: DoneButtonUiState,</span>
<span class="nc" id="L278">            override val titleVisible: Boolean</span>
<span class="nc" id="L279">        ) : UiState(</span>
<span class="nc" id="L280">                progressBarVisible = false,</span>
<span class="nc" id="L281">                titleVisible = titleVisible,</span>
<span class="nc" id="L282">                errorLayoutVisible = false</span>
<span class="nc" id="L283">        )</span>

<span class="nc" id="L285">        sealed class ErrorUiState constructor(</span>
<span class="nc" id="L286">            val titleRes: Int</span>
<span class="nc" id="L287">        ) : UiState(</span>
<span class="nc" id="L288">                progressBarVisible = false,</span>
<span class="nc" id="L289">                errorLayoutVisible = true</span>
        ) {
<span class="nc" id="L291">            object ConnectionErrorUiState : ErrorUiState(R.string.no_network_message)</span>

<span class="nc" id="L293">            object RequestFailedErrorUiState : ErrorUiState(R.string.reader_error_request_failed_title)</span>
        }

        private fun getCheckedInterestsUiState(): List&lt;TagUiState&gt; {
<span class="nc bnc" id="L297" title="All 2 branches missed.">            return if (this is ContentUiState) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                interestsUiState.filter { it.isChecked }</span>
            } else {
<span class="nc" id="L300">                emptyList()</span>
            }
        }

        fun getSelectedInterests(): List&lt;ReaderTag&gt; {
<span class="nc bnc" id="L305" title="All 2 branches missed.">            return if (this is ContentUiState) {</span>
<span class="nc" id="L306">                interests.filter {</span>
<span class="nc" id="L307">                    getCheckedInterestsUiState().map { checkedInterestUiState -&gt;</span>
<span class="nc" id="L308">                        checkedInterestUiState.slug</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                    }.contains(it.tagSlug)</span>
                }
            } else {
<span class="nc" id="L312">                emptyList()</span>
            }
        }

<span class="nc" id="L316">        fun getDoneButtonState(</span>
            entryPoint: EntryPoint,
<span class="nc" id="L318">            isInterestChecked: Boolean = false</span>
        ): DoneButtonUiState {
<span class="nc bnc" id="L320" title="All 2 branches missed.">            return if (this is ContentUiState) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                val disableDoneButton = interests.isEmpty() ||</span>
<span class="nc bnc" id="L322" title="All 4 branches missed.">                        (getCheckedInterestsUiState().size == 1 &amp;&amp; !isInterestChecked)</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                if (disableDoneButton) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                    when (entryPoint) {</span>
<span class="nc" id="L325">                        EntryPoint.DISCOVER -&gt; DoneButtonDisabledUiState()</span>
<span class="nc" id="L326">                        EntryPoint.SETTINGS -&gt; DoneButtonDisabledUiState(R.string.reader_btn_done)</span>
                    }
                } else {
<span class="nc" id="L329">                    DoneButtonEnabledUiState()</span>
                }
            } else {
<span class="nc" id="L332">                DoneButtonHiddenUiState</span>
            }
        }
<span class="nc" id="L335">    }</span>

<span class="nc" id="L337">    sealed class DoneButtonUiState(</span>
<span class="nc" id="L338">        @StringRes open val titleRes: Int = R.string.reader_btn_done,</span>
<span class="nc" id="L339">        val enabled: Boolean = false,</span>
<span class="nc" id="L340">        val visible: Boolean = true</span>
    ) {
<span class="nc" id="L342">        data class DoneButtonEnabledUiState(</span>
<span class="nc" id="L343">            @StringRes override val titleRes: Int = R.string.reader_btn_done</span>
<span class="nc" id="L344">        ) : DoneButtonUiState(</span>
<span class="nc" id="L345">                enabled = true</span>
<span class="nc" id="L346">        )</span>

<span class="nc" id="L348">        data class DoneButtonDisabledUiState(</span>
<span class="nc" id="L349">            @StringRes override val titleRes: Int = R.string.reader_btn_select_few_interests</span>
<span class="nc" id="L350">        ) : DoneButtonUiState(</span>
<span class="nc" id="L351">                enabled = false</span>
<span class="nc" id="L352">        )</span>

<span class="nc" id="L354">        object DoneButtonHiddenUiState : DoneButtonUiState(</span>
<span class="nc" id="L355">                visible = false</span>
        )
<span class="nc" id="L357">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>