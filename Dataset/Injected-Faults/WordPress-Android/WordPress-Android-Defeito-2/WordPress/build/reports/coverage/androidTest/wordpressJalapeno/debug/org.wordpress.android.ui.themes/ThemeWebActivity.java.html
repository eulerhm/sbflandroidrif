<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThemeWebActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.themes</a> &gt; <span class="el_source">ThemeWebActivity.java</span></div><h1>ThemeWebActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.themes;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.text.TextUtils;
import android.view.Menu;
import android.view.MenuItem;

import androidx.annotation.NonNull;

import org.wordpress.android.R;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.model.ThemeModel;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.WPWebViewActivity;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.UrlUtils;

<span class="nc" id="L21">public class ThemeWebActivity extends WPWebViewActivity {</span>
    public static final String IS_CURRENT_THEME = &quot;is_current_theme&quot;;
    public static final String IS_PREMIUM_THEME = &quot;is_premium_theme&quot;;
    public static final String THEME_NAME = &quot;theme_name&quot;;
    public static final String THEME_HTTP_PREFIX = &quot;http&quot;;
    public static final String THEME_HTTPS_PROTOCOL = &quot;https://&quot;;

    private static final String THEME_DOMAIN_PUBLIC = &quot;pub&quot;;
    private static final String THEME_DOMAIN_PREMIUM = &quot;premium&quot;;
    private static final String THEME_URL_PREVIEW = &quot;https://wordpress.com/customize/%s?theme=%s/%s&amp;hide_close=true&quot;;
    private static final String THEME_URL_SUPPORT = &quot;https://wordpress.com/theme/%s/support/?preview=true&amp;iframe=true&quot;;
    private static final String THEME_URL_DETAILS = &quot;https://wordpress.com/theme/%s/?preview=true&amp;iframe=true&quot;;
    private static final String THEME_URL_DEMO_PARAMETER = &quot;demo=true&amp;iframe=true&amp;theme_preview=true&quot;;

<span class="nc" id="L35">    enum ThemeWebActivityType {</span>
<span class="nc" id="L36">        PREVIEW,</span>
<span class="nc" id="L37">        DEMO,</span>
<span class="nc" id="L38">        DETAILS,</span>
<span class="nc" id="L39">        SUPPORT</span>
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L44">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L45">        setActionBarTitleToThemeName();</span>
<span class="nc" id="L46">        toggleNavbarVisibility(false);</span>
<span class="nc" id="L47">    }</span>

    public static String getSiteLoginUrl(SiteModel site) {
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (site.isJetpackConnected()) {</span>
<span class="nc" id="L51">            return WPCOM_LOGIN_URL;</span>
        }
<span class="nc" id="L53">        return WPWebViewActivity.getSiteLoginUrl(site);</span>
    }

    public static void openTheme(Activity activity, @NonNull SiteModel site, @NonNull ThemeModel theme,
                                 @NonNull ThemeWebActivityType type) {
<span class="nc bnc" id="L58" title="All 2 branches missed.">        String url = getUrl(site, theme, type, !theme.isFree());</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (TextUtils.isEmpty(url)) {</span>
<span class="nc" id="L60">            ToastUtils.showToast(activity, R.string.could_not_load_theme);</span>
<span class="nc" id="L61">            return;</span>
        }
<span class="nc bnc" id="L63" title="All 4 branches missed.">        if (type == ThemeWebActivityType.PREVIEW || !theme.isWpComTheme()) {</span>
            // Do not open the Customizer with the in-app browser.
            // Customizer may need to access local files (mostly pictures) on the device storage,
            // and our internal webview doesn't handle this feature yet.
            // Ref: https://github.com/wordpress-mobile/WordPress-Android/issues/4934
<span class="nc" id="L68">            ActivityLauncher.openUrlExternal(activity, url);</span>
        } else {
<span class="nc" id="L70">            openWPCOMURL(activity, url, theme, site);</span>
        }
<span class="nc" id="L72">    }</span>

    private static void openWPCOMURL(Activity activity, String url, ThemeModel theme, SiteModel site) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (activity == null) {</span>
<span class="nc" id="L76">            AppLog.e(AppLog.T.UTILS, &quot;ThemeWebActivity requires a non-null activity&quot;);</span>
<span class="nc" id="L77">            return;</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        } else if (TextUtils.isEmpty(url)) {</span>
<span class="nc" id="L79">            AppLog.e(AppLog.T.UTILS, &quot;ThemeWebActivity requires non-empty URL&quot;);</span>
<span class="nc" id="L80">            ToastUtils.showToast(activity, R.string.invalid_site_url_message, ToastUtils.Duration.SHORT);</span>
<span class="nc" id="L81">            return;</span>
        }

<span class="nc" id="L84">        String authURL = ThemeWebActivity.getSiteLoginUrl(site);</span>
<span class="nc" id="L85">        Intent intent = new Intent(activity, ThemeWebActivity.class);</span>
<span class="nc" id="L86">        intent.putExtra(WPWebViewActivity.URL_TO_LOAD, url);</span>
<span class="nc" id="L87">        intent.putExtra(WPWebViewActivity.AUTHENTICATION_URL, authURL);</span>
<span class="nc" id="L88">        intent.putExtra(WPWebViewActivity.LOCAL_BLOG_ID, site.getId());</span>
<span class="nc" id="L89">        intent.putExtra(WPWebViewActivity.USE_GLOBAL_WPCOM_USER, true);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        intent.putExtra(IS_PREMIUM_THEME, !theme.isFree());</span>
<span class="nc" id="L91">        intent.putExtra(IS_CURRENT_THEME, theme.getActive());</span>
<span class="nc" id="L92">        intent.putExtra(THEME_NAME, theme.getName());</span>
<span class="nc" id="L93">        intent.putExtra(ThemeBrowserActivity.THEME_ID, theme.getThemeId());</span>
<span class="nc" id="L94">        activity.startActivityForResult(intent, ThemeBrowserActivity.ACTIVATE_THEME);</span>
<span class="nc" id="L95">    }</span>

    public static String getIdentifierForCustomizer(@NonNull SiteModel site, @NonNull ThemeModel theme) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (site.isJetpackConnected()) {</span>
<span class="nc" id="L99">            return theme.getThemeId();</span>
        } else {
<span class="nc" id="L101">            return theme.getStylesheet();</span>
        }
    }

    public static String getUrl(@NonNull SiteModel site, @NonNull ThemeModel theme, @NonNull ThemeWebActivityType type,
                                boolean isPremium) {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (theme.isWpComTheme()) {</span>
<span class="nc bnc" id="L108" title="All 5 branches missed.">            switch (type) {</span>
                case PREVIEW:
<span class="nc bnc" id="L110" title="All 2 branches missed.">                    String domain = isPremium ? THEME_DOMAIN_PREMIUM : THEME_DOMAIN_PUBLIC;</span>
<span class="nc" id="L111">                    return String</span>
<span class="nc" id="L112">                            .format(THEME_URL_PREVIEW, UrlUtils.getHost(site.getUrl()), domain, theme.getThemeId());</span>
                case DEMO:
<span class="nc" id="L114">                    String url = theme.getDemoUrl();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                    if (url.contains(&quot;?&quot;)) {</span>
<span class="nc" id="L116">                        return url + &quot;&amp;&quot; + THEME_URL_DEMO_PARAMETER;</span>
                    } else {
<span class="nc" id="L118">                        return url + &quot;?&quot; + THEME_URL_DEMO_PARAMETER;</span>
                    }
                case DETAILS:
<span class="nc" id="L121">                    return String.format(THEME_URL_DETAILS, theme.getThemeId());</span>
                case SUPPORT:
<span class="nc" id="L123">                    return String.format(THEME_URL_SUPPORT, theme.getThemeId());</span>
            }
        } else {
<span class="nc bnc" id="L126" title="All 4 branches missed.">            switch (type) {</span>
                case PREVIEW:
<span class="nc" id="L128">                    return site.getAdminUrl() + &quot;customize.php?theme=&quot; + getIdentifierForCustomizer(site, theme);</span>
                case DEMO:
<span class="nc" id="L130">                    return site.getAdminUrl() + &quot;themes.php?theme=&quot; + theme.getThemeId();</span>
                case DETAILS:
                case SUPPORT:
<span class="nc" id="L133">                    return theme.getThemeUrl();</span>
            }
        }
<span class="nc" id="L136">        return &quot;&quot;;</span>
    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (shouldShowActivateMenuItem()) {</span>
<span class="nc" id="L142">            getMenuInflater().inflate(R.menu.theme_web, menu);</span>
        }
<span class="nc" id="L144">        return true;</span>
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (item.getItemId() == R.id.action_activate) {</span>
<span class="nc" id="L150">            Intent returnIntent = new Intent();</span>
<span class="nc" id="L151">            setResult(RESULT_OK, returnIntent);</span>
<span class="nc" id="L152">            returnIntent.putExtra(ThemeBrowserActivity.THEME_ID,</span>
<span class="nc" id="L153">                                  getIntent().getStringExtra(ThemeBrowserActivity.THEME_ID));</span>
<span class="nc" id="L154">            finish();</span>
<span class="nc" id="L155">            return true;</span>
        }
<span class="nc" id="L157">        return super.onOptionsItemSelected(item);</span>
    }

    private void setActionBarTitleToThemeName() {
<span class="nc" id="L161">        String themeName = getIntent().getStringExtra(THEME_NAME);</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">        if (getSupportActionBar() != null &amp;&amp; themeName != null) {</span>
<span class="nc" id="L163">            getSupportActionBar().setTitle(themeName);</span>
        }
<span class="nc" id="L165">    }</span>

    /**
     * Show Activate in the Action Bar menu if the theme is free and not the current theme.
     */
    private boolean shouldShowActivateMenuItem() {
<span class="nc" id="L171">        boolean isPremiumTheme = getIntent().getBooleanExtra(IS_PREMIUM_THEME, false);</span>
<span class="nc" id="L172">        boolean isCurrentTheme = getIntent().getBooleanExtra(IS_CURRENT_THEME, false);</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">        return !isCurrentTheme &amp;&amp; !isPremiumTheme;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>