<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HomepageSettingsDialog.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs.homepage</a> &gt; <span class="el_source">HomepageSettingsDialog.kt</span></div><h1>HomepageSettingsDialog.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs.homepage

import android.app.Dialog
import android.content.Context
import android.os.Bundle
import android.view.Gravity
import android.view.Menu
import android.view.View
import android.widget.Button
import android.widget.PopupMenu
import android.widget.RadioGroup
import android.widget.TextView
import androidx.appcompat.app.AlertDialog
import androidx.core.content.ContextCompat
import androidx.fragment.app.DialogFragment
import androidx.lifecycle.ViewModelProvider
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.SiteSettingsHomepageDialogBinding
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.extensions.getColorResIdFromAttribute
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

<span class="nc" id="L27">class HomepageSettingsDialog : DialogFragment() {</span>
<span class="nc bnc" id="L28" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L29" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
    private lateinit var viewModel: HomepageSettingsViewModel
    private var siteId: Int? = null

    override fun onCreateDialog(savedInstanceState: Bundle?): Dialog {
<span class="nc" id="L34">        var isClassicBlog: Boolean? = null</span>
<span class="nc" id="L35">        var pageOnFrontId: Long? = null</span>
<span class="nc" id="L36">        var pageForPostsId: Long? = null</span>
<span class="nc bnc" id="L37" title="All 6 branches missed.">        (arguments ?: savedInstanceState)?.let { bundle -&gt;</span>
<span class="nc" id="L38">            siteId = bundle.getInt(KEY_SITE_ID)</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">            isClassicBlog = bundle.get(KEY_IS_CLASSIC_BLOG)?.let { it as Boolean }</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">            pageOnFrontId = bundle.get(KEY_PAGE_ON_FRONT)?.let { it as Long }</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">            pageForPostsId = bundle.get(KEY_PAGE_FOR_POSTS)?.let { it as Long }</span>
<span class="nc" id="L42">        } ?: throw IllegalArgumentException(&quot;Site has to be initialized&quot;)</span>
<span class="nc" id="L43">        val builder = MaterialAlertDialogBuilder(requireActivity())</span>
<span class="nc" id="L44">        builder.setPositiveButton(R.string.site_settings_accept_homepage) { _, _ -&gt; }</span>
<span class="nc" id="L45">        builder.setNegativeButton(R.string.cancel) { _, _ -&gt; }</span>
<span class="nc" id="L46">        with(SiteSettingsHomepageDialogBinding.inflate(requireActivity().layoutInflater)) {</span>
<span class="nc" id="L47">            homepageSettingsRadioGroup.setOnCheckedChangeListener { _, checkedId -&gt;</span>
<span class="nc bnc" id="L48" title="All 3 branches missed.">                when (checkedId) {</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">                    R.id.classic_blog -&gt; viewModel.classicBlogSelected()</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">                    R.id.static_homepage -&gt; viewModel.staticHomepageSelected()</span>
                }
<span class="nc" id="L52">            }</span>
<span class="nc" id="L53">            builder.setView(root)</span>

<span class="nc" id="L55">            viewModel = ViewModelProvider(this@HomepageSettingsDialog, viewModelFactory)</span>
<span class="nc" id="L56">                    .get(HomepageSettingsViewModel::class.java)</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">            viewModel.uiState.observe(this@HomepageSettingsDialog, { uiState -&gt;</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">                uiState?.let {</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">                    loadingPages.visibility = if (uiState.isLoading) View.VISIBLE else View.GONE</span>
<span class="nc" id="L60">                    enablePositiveButton(uiState.isSaveEnabled)</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">                    if (uiState.error != null) {</span>
<span class="nc" id="L62">                        loadingError.visibility = View.VISIBLE</span>
<span class="nc" id="L63">                        loadingError.setText(uiState.error)</span>
                    } else {
<span class="nc" id="L65">                        loadingError.visibility = View.GONE</span>
<span class="nc" id="L66">                        loadingError.text = null</span>
                    }
<span class="nc" id="L68">                    when (uiState.isClassicBlogState) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                        true -&gt; {</span>
<span class="nc" id="L70">                            homepageSettingsRadioGroup.checkIfNotChecked(R.id.classic_blog)</span>
<span class="nc" id="L71">                            dropdownContainer.visibility = View.GONE</span>
                        }
<span class="nc bnc" id="L73" title="All 2 branches missed.">                        false -&gt; {</span>
<span class="nc" id="L74">                            homepageSettingsRadioGroup.checkIfNotChecked(R.id.static_homepage)</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">                            if (uiState.pageForPostsState != null &amp;&amp; uiState.pageOnFrontState != null) {</span>
<span class="nc" id="L76">                                dropdownContainer.visibility = View.VISIBLE</span>
<span class="nc" id="L77">                                setupDropdownItem(</span>
<span class="nc" id="L78">                                        uiState.pageOnFrontState,</span>
<span class="nc" id="L79">                                        selectedHomepage,</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                                        viewModel::onPageOnFrontDialogOpened,</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                                        viewModel::onPageOnFrontSelected</span>
                                )
<span class="nc" id="L83">                                setupDropdownItem(</span>
<span class="nc" id="L84">                                        uiState.pageForPostsState,</span>
<span class="nc" id="L85">                                        selectedPostsPage,</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">                                        viewModel::onPageForPostsDialogOpened,</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                                        viewModel::onPageForPostsSelected</span>
                                )
                            } else {
<span class="nc" id="L90">                                dropdownContainer.visibility = View.GONE</span>
                            }
                        }
                    }
<span class="nc" id="L94">                }</span>
<span class="nc" id="L95">            })</span>
<span class="nc" id="L96">        }</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        viewModel.dismissDialogEvent.observeEvent(this, {</span>
<span class="nc" id="L98">            requireDialog().dismiss()</span>
<span class="nc" id="L99">        })</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">        viewModel.start(requireNotNull(siteId), isClassicBlog, pageForPostsId, pageOnFrontId)</span>
<span class="nc" id="L101">        return builder.create()</span>
    }

    private fun enablePositiveButton(enabled: Boolean) {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        val button = (dialog as AlertDialog).getButton(AlertDialog.BUTTON_POSITIVE)</span>
<span class="nc" id="L106">        button.isEnabled = enabled</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        val textColor = if (enabled) {</span>
<span class="nc" id="L108">            requireContext().getColorResIdFromAttribute(R.attr.colorPrimary)</span>
        } else {
<span class="nc" id="L110">            R.color.material_on_surface_disabled</span>
        }
<span class="nc" id="L112">        button.setTextColor(ContextCompat.getColor(requireContext(), textColor))</span>
<span class="nc" id="L113">    }</span>

    override fun onResume() {
<span class="nc" id="L116">        super.onResume()</span>
<span class="nc" id="L117">        val d = dialog as AlertDialog?</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (d != null) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            val positiveButton = d.getButton(Dialog.BUTTON_POSITIVE) as Button</span>
<span class="nc" id="L120">            positiveButton.setOnClickListener {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                viewModel.onAcceptClicked()</span>
<span class="nc" id="L122">            }</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            val negativeButton = d.getButton(Dialog.BUTTON_NEGATIVE) as Button</span>
<span class="nc" id="L124">            negativeButton.setOnClickListener {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                viewModel.onDismissClicked()</span>
<span class="nc" id="L126">            }</span>
        }
<span class="nc" id="L128">    }</span>

    private fun setupDropdownItem(
        selectorUiModel: HomepageSettingsSelectorUiState,
        textView: TextView,
        onClickAction: () -&gt; Unit,
        onPageSelectedAction: (id: Int) -&gt; Boolean
    ) {
<span class="nc" id="L136">        uiHelpers.setTextOrHide(textView, selectorUiModel.selectedItem)</span>
<span class="nc" id="L137">        textView.isSelected = selectorUiModel.isHighlighted</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (selectorUiModel.isExpanded) {</span>
<span class="nc" id="L139">            val popupMenu = PopupMenu(requireContext(), textView, Gravity.END)</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            for (page in selectorUiModel.data) {</span>
<span class="nc" id="L141">                popupMenu.menu.add(Menu.NONE, page.id, Menu.NONE, page.title)</span>
            }
<span class="nc" id="L143">            popupMenu.setOnDismissListener {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                viewModel.onDialogHidden()</span>
<span class="nc" id="L145">            }</span>
<span class="nc" id="L146">            popupMenu.setOnMenuItemClickListener { menuItem -&gt;</span>
<span class="nc" id="L147">                onPageSelectedAction(menuItem.itemId)</span>
            }
<span class="nc" id="L149">            popupMenu.show()</span>
        } else {
<span class="nc" id="L151">            textView.setOnClickListener {</span>
<span class="nc" id="L152">                onClickAction()</span>
<span class="nc" id="L153">            }</span>
        }
<span class="nc" id="L155">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L158">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L159">        outState.putSerializable(KEY_SITE_ID, siteId)</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">        viewModel.isClassicBlog()?.let {</span>
<span class="nc" id="L161">            outState.putBoolean(KEY_IS_CLASSIC_BLOG, it)</span>
<span class="nc" id="L162">        }</span>
<span class="nc bnc" id="L163" title="All 4 branches missed.">        viewModel.getSelectedPageOnFrontId()?.let {</span>
<span class="nc" id="L164">            outState.putLong(KEY_PAGE_ON_FRONT, it)</span>
<span class="nc" id="L165">        }</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">        viewModel.getSelectedPageForPostsId()?.let {</span>
<span class="nc" id="L167">            outState.putLong(KEY_PAGE_FOR_POSTS, it)</span>
<span class="nc" id="L168">        }</span>
<span class="nc" id="L169">    }</span>

    private fun RadioGroup.checkIfNotChecked(id: Int) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (checkedRadioButtonId != id) {</span>
<span class="nc" id="L173">            check(id)</span>
        }
<span class="nc" id="L175">    }</span>

    override fun onAttach(context: Context) {
<span class="nc" id="L178">        super.onAttach(context)</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc" id="L180">    }</span>

    companion object {
        private const val KEY_SITE_ID = &quot;site_id&quot;
        private const val KEY_IS_CLASSIC_BLOG = &quot;is_classic_blog&quot;
        private const val KEY_PAGE_ON_FRONT = &quot;page_on_front&quot;
        private const val KEY_PAGE_FOR_POSTS = &quot;page_for_posts&quot;
        fun newInstance(siteModel: SiteModel): HomepageSettingsDialog {
<span class="nc" id="L188">            val args = Bundle()</span>
<span class="nc" id="L189">            args.putInt(KEY_SITE_ID, siteModel.id)</span>
<span class="nc" id="L190">            val dialog = HomepageSettingsDialog()</span>
<span class="nc" id="L191">            dialog.arguments = args</span>
<span class="nc" id="L192">            return dialog</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>