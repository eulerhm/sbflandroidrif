<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostListFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PostListFragment.kt</span></div><h1>PostListFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import android.os.Bundle
import android.text.TextUtils
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Button
import android.widget.ProgressBar
import androidx.fragment.app.FragmentActivity
import androidx.lifecycle.Observer
import androidx.lifecycle.ViewModelProvider
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.ui.ActionableEmptyView
import org.wordpress.android.ui.ViewPagerFragment
import org.wordpress.android.ui.posts.PostListType.SEARCH
import org.wordpress.android.ui.posts.PostListViewLayoutType.COMPACT
import org.wordpress.android.ui.posts.PostListViewLayoutType.STANDARD
import org.wordpress.android.ui.posts.adapters.PostListAdapter
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.util.DisplayUtils
import org.wordpress.android.util.NetworkUtils
import org.wordpress.android.util.ToastUtils
import org.wordpress.android.util.WPSwipeToRefreshHelper.buildSwipeToRefreshHelper
import org.wordpress.android.util.helpers.SwipeToRefreshHelper
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.util.widgets.CustomSwipeRefreshLayout
import org.wordpress.android.viewmodel.posts.PagedPostList
import org.wordpress.android.viewmodel.posts.PostListEmptyUiState
import org.wordpress.android.viewmodel.posts.PostListItemIdentifier.LocalPostId
import org.wordpress.android.viewmodel.posts.PostListViewModel
import org.wordpress.android.widgets.RecyclerItemDecoration
import javax.inject.Inject

private const val EXTRA_POST_LIST_TYPE = &quot;post_list_type&quot;
private const val MAX_INDEX_FOR_VISIBLE_ITEM_TO_KEEP_SCROLL_POSITION = 2

<span class="nc" id="L43">class PostListFragment : ViewPagerFragment() {</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">    @Inject internal lateinit var imageManager: ImageManager</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">    @Inject internal lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">    @Inject internal lateinit var uiHelpers: UiHelpers</span>
    private lateinit var viewModel: PostListViewModel
    private lateinit var mainViewModel: PostListMainViewModel

    private var swipeToRefreshHelper: SwipeToRefreshHelper? = null

    private var swipeRefreshLayout: CustomSwipeRefreshLayout? = null
    private var recyclerView: RecyclerView? = null
    private var actionableEmptyView: ActionableEmptyView? = null
    private var progressLoadMore: ProgressBar? = null

    private lateinit var itemDecorationCompactLayout: RecyclerItemDecoration
    private lateinit var itemDecorationStandardLayout: RecyclerItemDecoration

    private lateinit var postListType: PostListType

    private lateinit var nonNullActivity: FragmentActivity

<span class="nc" id="L64">    private val postListAdapter: PostListAdapter by lazy {</span>
<span class="nc" id="L65">        PostListAdapter(</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                context = nonNullActivity,</span>
<span class="nc" id="L67">                imageManager = imageManager,</span>
<span class="nc" id="L68">                uiHelpers = uiHelpers</span>
        )
    }

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L73">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L74">        nonNullActivity = requireActivity()</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">        (nonNullActivity.application as WordPress).component().inject(this)</span>

<span class="nc bnc" id="L77" title="All 4 branches missed.">        val nonNullIntent = checkNotNull(nonNullActivity.intent)</span>
<span class="nc" id="L78">        val site: SiteModel? = nonNullIntent.getSerializableExtra(WordPress.SITE) as SiteModel?</span>

<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (site == null) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            ToastUtils.showToast(nonNullActivity, R.string.blog_not_found, ToastUtils.Duration.SHORT)</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">            nonNullActivity.finish()</span>
        }
<span class="nc" id="L84">    }</span>

    override fun getScrollableViewForUniqueIdProvision(): View? {
<span class="nc bnc" id="L87" title="All 4 branches missed.">        if (postListType == SEARCH) {</span>
<span class="nc" id="L88">            return null</span>
        }
<span class="nc" id="L90">        return recyclerView</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L94">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">        postListType = requireNotNull(arguments).getSerializable(EXTRA_POST_LIST_TYPE) as PostListType</span>

<span class="nc bnc" id="L97" title="All 4 branches missed.">        if (postListType == SEARCH) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            recyclerView?.id = R.id.posts_search_recycler_view_id</span>
        }

<span class="nc bnc" id="L101" title="All 2 branches missed.">        mainViewModel = ViewModelProvider(nonNullActivity, viewModelFactory)</span>
<span class="nc" id="L102">                .get(PostListMainViewModel::class.java)</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">        mainViewModel.viewLayoutType.observe(viewLifecycleOwner, Observer { optionaLayoutType -&gt;</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            optionaLayoutType?.let { layoutType -&gt;</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">                recyclerView?.removeItemDecoration(itemDecorationCompactLayout)</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">                recyclerView?.removeItemDecoration(itemDecorationStandardLayout)</span>

<span class="nc bnc" id="L109" title="All 3 branches missed.">                when (layoutType) {</span>
                    STANDARD -&gt; {
<span class="nc bnc" id="L111" title="All 4 branches missed.">                        recyclerView?.addItemDecoration(itemDecorationStandardLayout)</span>
                    }
                    COMPACT -&gt; {
<span class="nc bnc" id="L114" title="All 4 branches missed.">                        recyclerView?.addItemDecoration(itemDecorationCompactLayout)</span>
                    }
                }

<span class="nc bnc" id="L118" title="All 2 branches missed.">                if (postListAdapter.updateItemLayoutType(layoutType)) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                    recyclerView?.scrollToPosition(0)</span>
                }
<span class="nc" id="L121">            }</span>
<span class="nc" id="L122">        })</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">        mainViewModel.authorSelectionUpdated.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (it != null) {</span>
<span class="nc bnc" id="L126" title="All 4 branches missed.">                if (viewModel.updateAuthorFilterIfNotSearch(it)) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                    recyclerView?.scrollToPosition(0)</span>
                }
            }
<span class="nc" id="L130">        })</span>

<span class="nc bnc" id="L132" title="All 6 branches missed.">        actionableEmptyView?.updateLayoutForSearch(postListType == SEARCH, 0)</span>

<span class="nc bnc" id="L134" title="All 4 branches missed.">        val postListViewModelConnector = mainViewModel.getPostListViewModelConnector(postListType)</span>

<span class="nc" id="L136">        viewModel = ViewModelProvider(this, viewModelFactory).get(PostListViewModel::class.java)</span>

<span class="nc" id="L138">        val displayWidth = DisplayUtils.getWindowPixelWidth(requireContext())</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        val contentSpacing = nonNullActivity.resources.getDimensionPixelSize(R.dimen.content_margin)</span>

        // since the MainViewModel has been already started, we need to manually update the authorFilterSelection value
<span class="nc bnc" id="L142" title="All 2 branches missed.">        viewModel.start(</span>
<span class="nc" id="L143">                postListViewModelConnector,</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                mainViewModel.authorSelectionUpdated.value!!,</span>
<span class="nc" id="L145">                photonWidth = displayWidth - contentSpacing * 2,</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                photonHeight = nonNullActivity.resources.getDimensionPixelSize(R.dimen.reader_featured_image_height)</span>
        )

<span class="nc" id="L149">        initObservers()</span>
<span class="nc" id="L150">    }</span>

    private fun initObservers() {
<span class="nc bnc" id="L153" title="All 4 branches missed.">        if (postListType == SEARCH) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            mainViewModel.searchQuery.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                if (TextUtils.isEmpty(it)) {</span>
<span class="nc" id="L156">                    postListAdapter.submitList(null)</span>
                }
<span class="nc bnc" id="L158" title="All 2 branches missed.">                viewModel.search(it)</span>
<span class="nc" id="L159">            })</span>
        }

<span class="nc bnc" id="L162" title="All 2 branches missed.">        viewModel.emptyViewState.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            it?.let { emptyViewState -&gt; updateEmptyViewForState(emptyViewState) }</span>
<span class="nc" id="L164">        })</span>

<span class="nc bnc" id="L166" title="All 2 branches missed.">        viewModel.isFetchingFirstPage.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            swipeRefreshLayout?.isRefreshing = it == true</span>
<span class="nc" id="L168">        })</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">        viewModel.pagedListData.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            it?.let { pagedListData -&gt; updatePagedListData(pagedListData) }</span>
<span class="nc" id="L172">        })</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">        viewModel.isLoadingMore.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">            progressLoadMore?.visibility = if (it == true) View.VISIBLE else View.GONE</span>
<span class="nc" id="L176">        })</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        viewModel.scrollToPosition.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            it?.let { index -&gt;</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                recyclerView?.scrollToPosition(index)</span>
<span class="nc" id="L180">            }</span>
<span class="nc" id="L181">        })</span>
<span class="nc" id="L182">    }</span>

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
<span class="nc" id="L185">        val view = inflater.inflate(R.layout.post_list_fragment, container, false)</span>

<span class="nc" id="L187">        swipeRefreshLayout = view.findViewById(R.id.ptr_layout)</span>
<span class="nc" id="L188">        recyclerView = view.findViewById(R.id.recycler_view)</span>
<span class="nc" id="L189">        progressLoadMore = view.findViewById(R.id.progress)</span>
<span class="nc" id="L190">        actionableEmptyView = view.findViewById(R.id.actionable_empty_view)</span>

<span class="nc bnc" id="L192" title="All 2 branches missed.">        val context = nonNullActivity</span>
<span class="nc" id="L193">        itemDecorationStandardLayout = RecyclerItemDecoration(</span>
<span class="nc" id="L194">                0,</span>
<span class="nc" id="L195">                context.resources.getDimensionPixelSize(R.dimen.margin_medium)</span>
        )
<span class="nc" id="L197">        itemDecorationCompactLayout = RecyclerItemDecoration(</span>
<span class="nc" id="L198">                0,</span>
<span class="nc" id="L199">                context.resources.getDimensionPixelSize(R.dimen.list_divider_height)</span>
        )
<span class="nc bnc" id="L201" title="All 2 branches missed.">        recyclerView?.layoutManager = LinearLayoutManager(context)</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        recyclerView?.adapter = postListAdapter</span>

<span class="nc" id="L204">        swipeToRefreshHelper = buildSwipeToRefreshHelper(swipeRefreshLayout) {</span>
<span class="nc bnc" id="L205" title="All 4 branches missed.">            if (!NetworkUtils.isNetworkAvailable(nonNullActivity)) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                swipeRefreshLayout?.isRefreshing = false</span>
            } else {
<span class="nc bnc" id="L208" title="All 2 branches missed.">                viewModel.swipeToRefresh()</span>
            }
<span class="nc" id="L210">        }</span>
<span class="nc" id="L211">        return view</span>
    }

    /**
     * Updates the data for the adapter while retaining visible item in certain cases.
     *
     * PagedList tries to keep the visible item by adding new items outside of the screen while modifying the scroll
     * position. In most cases, this works out great because it doesn't interrupt to the user. However, after a new
     * item is inserted at the top while the list is showing the very first items, it feels very weird to not have the
     * inserted item shown. For example, if a new draft is added there is no indication of it except for the flash
     * of the scroll bar which is not noticeable unless user is paying attention to it.
     *
     * In these cases, we try to keep the scroll position the same instead of keeping the visible item the same by
     * first saving the state and re-applying it after the data updates are completed. Since `PagedListAdapter` uses
     * bg thread to calculate the changes, we need to post the change in the bg thread as well so that it'll be applied
     * after changes are reflected.
     */
    private fun updatePagedListData(pagedListData: PagedPostList) {
<span class="nc bnc" id="L229" title="All 4 branches missed.">        val recyclerViewState = recyclerView?.layoutManager?.onSaveInstanceState()</span>
<span class="nc" id="L230">        postListAdapter.submitList(pagedListData)</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">        recyclerView?.post {</span>
<span class="nc bnc" id="L232" title="All 6 branches missed.">            (recyclerView?.layoutManager as? LinearLayoutManager)?.let { layoutManager -&gt;</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                if (layoutManager.findFirstVisibleItemPosition() &lt; MAX_INDEX_FOR_VISIBLE_ITEM_TO_KEEP_SCROLL_POSITION) {</span>
<span class="nc" id="L234">                    layoutManager.onRestoreInstanceState(recyclerViewState)</span>
                }
<span class="nc" id="L236">            }</span>
<span class="nc" id="L237">        }</span>
<span class="nc" id="L238">    }</span>

    private fun updateEmptyViewForState(state: PostListEmptyUiState) {
<span class="nc bnc" id="L241" title="All 2 branches missed.">        actionableEmptyView?.let { emptyView -&gt;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (state.emptyViewVisible) {</span>
<span class="nc" id="L243">                emptyView.visibility = View.VISIBLE</span>
<span class="nc" id="L244">                uiHelpers.setTextOrHide(emptyView.title, state.title)</span>
<span class="nc" id="L245">                uiHelpers.setImageOrHide(emptyView.image, state.imgResId)</span>
<span class="nc" id="L246">                setupButtonOrHide(emptyView.button, state.buttonText, state.onButtonClick)</span>
            } else {
<span class="nc" id="L248">                emptyView.visibility = View.GONE</span>
            }
<span class="nc" id="L250">        }</span>
<span class="nc" id="L251">    }</span>

    private fun setupButtonOrHide(
        buttonView: Button,
        text: UiString?,
        onButtonClick: (() -&gt; Unit)?
    ) {
<span class="nc" id="L258">        uiHelpers.setTextOrHide(buttonView, text)</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        buttonView.setOnClickListener { onButtonClick?.invoke() }</span>
<span class="nc" id="L260">    }</span>

    fun scrollToTargetPost(localPostId: LocalPostId) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">        viewModel.scrollToPost(localPostId)</span>
<span class="nc" id="L264">    }</span>

    companion object {
        const val TAG = &quot;post_list_fragment_tag&quot;

        @JvmStatic
        fun newInstance(
            site: SiteModel,
            postListType: PostListType
        ): PostListFragment {
<span class="nc" id="L274">            val fragment = PostListFragment()</span>
<span class="nc" id="L275">            val bundle = Bundle()</span>
<span class="nc" id="L276">            bundle.putSerializable(WordPress.SITE, site)</span>
<span class="nc" id="L277">            bundle.putSerializable(EXTRA_POST_LIST_TYPE, postListType)</span>
<span class="nc" id="L278">            fragment.arguments = bundle</span>
<span class="nc" id="L279">            return fragment</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>