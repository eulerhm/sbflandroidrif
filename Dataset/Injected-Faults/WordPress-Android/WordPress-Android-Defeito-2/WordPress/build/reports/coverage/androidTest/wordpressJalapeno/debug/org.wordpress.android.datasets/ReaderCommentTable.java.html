<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderCommentTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.datasets</a> &gt; <span class="el_source">ReaderCommentTable.java</span></div><h1>ReaderCommentTable.java</h1><pre class="source lang-java linenums">package org.wordpress.android.datasets;

import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteStatement;

import androidx.annotation.Nullable;

import org.wordpress.android.fluxc.model.CommentStatus;
import org.wordpress.android.models.ReaderComment;
import org.wordpress.android.models.ReaderCommentList;
import org.wordpress.android.models.ReaderPost;
import org.wordpress.android.util.SqlUtils;

/**
 * stores comments on reader posts
 */
<span class="nc" id="L19">public class ReaderCommentTable {</span>
    private static final String COLUMN_NAMES =
            &quot; blog_id,&quot;
            + &quot; post_id,&quot;
            + &quot; comment_id,&quot;
            + &quot; parent_id,&quot;
            + &quot; author_name,&quot;
            + &quot; author_avatar,&quot;
            + &quot; author_url,&quot;
            + &quot; author_id,&quot;
            + &quot; author_blog_id,&quot;
            + &quot; published,&quot;
            + &quot; timestamp,&quot;
            + &quot; status,&quot;
            + &quot; text,&quot;
            + &quot; num_likes,&quot;
            + &quot; is_liked,&quot;
            + &quot; page_number,&quot;
            + &quot; short_url,&quot;
            + &quot; author_email&quot;;


    protected static void createTables(SQLiteDatabase db) {
<span class="nc" id="L42">        db.execSQL(&quot;CREATE TABLE tbl_comments (&quot;</span>
                   + &quot; blog_id INTEGER DEFAULT 0,&quot;
                   + &quot; post_id INTEGER DEFAULT 0,&quot;
                   + &quot; comment_id INTEGER DEFAULT 0,&quot;
                   + &quot; parent_id INTEGER DEFAULT 0,&quot;
                   + &quot; author_name TEXT,&quot;
                   + &quot; author_avatar TEXT,&quot;
                   + &quot; author_url TEXT,&quot;
                   + &quot; author_id INTEGER DEFAULT 0,&quot;
                   + &quot; author_blog_id INTEGER DEFAULT 0,&quot;
                   + &quot; published TEXT,&quot;
                   + &quot; timestamp INTEGER DEFAULT 0,&quot;
                   + &quot; status TEXT,&quot;
                   + &quot; text TEXT,&quot;
                   + &quot; num_likes INTEGER DEFAULT 0,&quot;
                   + &quot; is_liked INTEGER DEFAULT 0,&quot;
                   + &quot; page_number INTEGER DEFAULT 0,&quot;
                   + &quot; short_url TEXT,&quot;
                   + &quot; author_email TEXT,&quot;
                   + &quot; PRIMARY KEY (blog_id, post_id, comment_id))&quot;);
<span class="nc" id="L62">        db.execSQL(&quot;CREATE INDEX idx_page_number ON tbl_comments(page_number)&quot;);</span>
<span class="nc" id="L63">    }</span>

    protected static void dropTables(SQLiteDatabase db) {
<span class="nc" id="L66">        db.execSQL(&quot;DROP TABLE IF EXISTS tbl_comments&quot;);</span>
<span class="nc" id="L67">    }</span>

    protected static void reset(SQLiteDatabase db) {
<span class="nc" id="L70">        dropTables(db);</span>
<span class="nc" id="L71">        createTables(db);</span>
<span class="nc" id="L72">    }</span>

    protected static int purge(SQLiteDatabase db) {
        // purge comments attached to posts that no longer exist
<span class="nc" id="L76">        int numDeleted = db.delete(&quot;tbl_comments&quot;, &quot;post_id NOT IN (SELECT DISTINCT post_id FROM tbl_posts)&quot;, null);</span>

        // purge all but the first page of comments
<span class="nc" id="L79">        numDeleted += db.delete(&quot;tbl_comments&quot;, &quot;page_number != 1&quot;, null);</span>

<span class="nc" id="L81">        return numDeleted;</span>
    }

    public static boolean isEmpty() {
<span class="nc bnc" id="L85" title="All 2 branches missed.">        return (getNumComments() == 0);</span>
    }

    private static int getNumComments() {
<span class="nc" id="L89">        long count = SqlUtils.getRowCount(ReaderDatabase.getReadableDb(), &quot;tbl_comments&quot;);</span>
<span class="nc" id="L90">        return (int) count;</span>
    }

    /*
     * returns the highest page_number for comments on the passed post
     */
    public static int getLastPageNumberForPost(long blogId, long postId) {
<span class="nc" id="L97">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L98">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                                    &quot;SELECT MAX(page_number) FROM tbl_comments WHERE blog_id=? AND post_id=?&quot;, args);
    }

    /*
     * returns the page number for a specific comment
     */
    public static int getPageNumberForComment(long blogId, long postId, long commentId) {
<span class="nc" id="L106">        String[] args = {Long.toString(blogId), Long.toString(postId), Long.toString(commentId)};</span>
<span class="nc" id="L107">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                                    &quot;SELECT page_number FROM tbl_comments &quot;
                                    + &quot; WHERE blog_id=? AND post_id=? AND comment_id=?&quot;,
                                    args);
    }

    /*
     * removes all comments for the passed post
     */
    public static void purgeCommentsForPost(long blogId, long postId) {
<span class="nc" id="L117">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L118">        ReaderDatabase.getWritableDb().delete(&quot;tbl_comments&quot;, &quot;blog_id=? AND post_id=?&quot;, args);</span>
<span class="nc" id="L119">    }</span>

    /*
     * returns the #comments stored locally for this post, which may differ from ReaderPostTable.getNumCommentsOnPost
     * (which is the #comments the server says exist for this post)
     */
    public static int getNumCommentsForPost(ReaderPost post) {
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L127">            return 0;</span>
        }
<span class="nc" id="L129">        return getNumCommentsForPost(post.blogId, post.postId);</span>
    }

    private static int getNumCommentsForPost(long blogId, long postId) {
<span class="nc" id="L133">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L134">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                                    &quot;SELECT count(*) FROM tbl_comments WHERE blog_id=? AND post_id=?&quot;, args);
    }

    public static ReaderCommentList getCommentsForPost(ReaderPost post) {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L140">            return new ReaderCommentList();</span>
        }

<span class="nc" id="L143">        String[] args = {Long.toString(post.blogId), Long.toString(post.postId), CommentStatus.APPROVED.toString()};</span>
<span class="nc" id="L144">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(</span>
                &quot;SELECT * FROM tbl_comments WHERE blog_id=? AND post_id=? AND status =? ORDER BY timestamp&quot;, args);
        try {
<span class="nc" id="L147">            ReaderCommentList comments = new ReaderCommentList();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L150">                    comments.add(getCommentFromCursor(c));</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }
<span class="nc" id="L153">            return comments;</span>
        } finally {
<span class="nc" id="L155">            SqlUtils.closeCursor(c);</span>
        }
    }

    @Nullable
    public static ReaderCommentList getCommentsForPostSnippet(ReaderPost post, int limit) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L162">            return new ReaderCommentList();</span>
        }

<span class="nc" id="L165">        String[] args = {Long.toString(post.blogId), Long.toString(post.postId), Integer.toString(limit)};</span>
<span class="nc" id="L166">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(</span>
                &quot;SELECT * FROM tbl_comments WHERE blog_id=? AND post_id=? AND parent_id=0 ORDER BY timestamp LIMIT ?&quot;,
                args
        );
        try {
<span class="nc" id="L171">            ReaderCommentList comments = new ReaderCommentList();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L174">                    comments.add(getCommentFromCursor(c));</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }
<span class="nc" id="L177">            return comments;</span>
        } finally {
<span class="nc" id="L179">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static void addOrUpdateComment(ReaderComment comment) {
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (comment == null) {</span>
<span class="nc" id="L185">            return;</span>
        }
<span class="nc" id="L187">        ReaderCommentList comments = new ReaderCommentList();</span>
<span class="nc" id="L188">        comments.add(comment);</span>
<span class="nc" id="L189">        addOrUpdateComments(comments);</span>
<span class="nc" id="L190">    }</span>

    public static void addOrUpdateComments(ReaderCommentList comments) {
<span class="nc bnc" id="L193" title="All 4 branches missed.">        if (comments == null || comments.size() == 0) {</span>
<span class="nc" id="L194">            return;</span>
        }

<span class="nc" id="L197">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L198">        db.beginTransaction();</span>
<span class="nc" id="L199">        SQLiteStatement stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO tbl_comments (&quot; + COLUMN_NAMES + &quot;) &quot;</span>
                                                   + &quot;VALUES (?1,?2,?3,?4,?5,?6,?7,?8,?9,?10,?11,?12,?13,?14,?15,?16,&quot;
                                                   + &quot;?17,?18)&quot;);
        try {
<span class="nc bnc" id="L203" title="All 2 branches missed.">            for (ReaderComment comment : comments) {</span>
<span class="nc" id="L204">                stmt.bindLong(1, comment.blogId);</span>
<span class="nc" id="L205">                stmt.bindLong(2, comment.postId);</span>
<span class="nc" id="L206">                stmt.bindLong(3, comment.commentId);</span>
<span class="nc" id="L207">                stmt.bindLong(4, comment.parentId);</span>
<span class="nc" id="L208">                stmt.bindString(5, comment.getAuthorName());</span>
<span class="nc" id="L209">                stmt.bindString(6, comment.getAuthorAvatar());</span>
<span class="nc" id="L210">                stmt.bindString(7, comment.getAuthorUrl());</span>
<span class="nc" id="L211">                stmt.bindLong(8, comment.authorId);</span>
<span class="nc" id="L212">                stmt.bindLong(9, comment.authorBlogId);</span>
<span class="nc" id="L213">                stmt.bindString(10, comment.getPublished());</span>
<span class="nc" id="L214">                stmt.bindLong(11, comment.timestamp);</span>
<span class="nc" id="L215">                stmt.bindString(12, comment.getStatus());</span>
<span class="nc" id="L216">                stmt.bindString(13, comment.getText());</span>
<span class="nc" id="L217">                stmt.bindLong(14, comment.numLikes);</span>
<span class="nc" id="L218">                stmt.bindLong(15, SqlUtils.boolToSql(comment.isLikedByCurrentUser));</span>
<span class="nc" id="L219">                stmt.bindLong(16, comment.pageNumber);</span>
<span class="nc" id="L220">                stmt.bindString(17, comment.getShortUrl());</span>
<span class="nc" id="L221">                stmt.bindString(18, comment.getAuthorEmail());</span>

<span class="nc" id="L223">                stmt.execute();</span>
<span class="nc" id="L224">            }</span>

<span class="nc" id="L226">            db.setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L228">            db.endTransaction();</span>
<span class="nc" id="L229">            SqlUtils.closeStatement(stmt);</span>
        }
<span class="nc" id="L231">    }</span>

    public static ReaderComment getComment(long blogId, long postId, long commentId) {
<span class="nc" id="L234">        String[] args = new String[]{Long.toString(blogId), Long.toString(postId), Long.toString(commentId)};</span>
<span class="nc" id="L235">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(</span>
                &quot;SELECT * FROM tbl_comments WHERE blog_id=? AND post_id=? AND comment_id=? LIMIT 1&quot;, args);
        try {
<span class="nc bnc" id="L238" title="All 2 branches missed.">            if (!c.moveToFirst()) {</span>
<span class="nc" id="L239">                return null;</span>
            }
<span class="nc" id="L241">            return getCommentFromCursor(c);</span>
        } finally {
<span class="nc" id="L243">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static void deleteComment(ReaderPost post, long commentId) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L249">            return;</span>
        }
<span class="nc" id="L251">        String[] args = {Long.toString(post.blogId), Long.toString(post.postId), Long.toString(commentId)};</span>
<span class="nc" id="L252">        ReaderDatabase.getWritableDb().delete(&quot;tbl_comments&quot;, &quot;blog_id=? AND post_id=? AND comment_id=?&quot;, args);</span>
<span class="nc" id="L253">    }</span>

    /*
     * returns true if any of the passed comments don't already exist
     * IMPORTANT: assumes passed comments are all for the same post
     */
    public static boolean hasNewComments(ReaderCommentList comments) {
<span class="nc bnc" id="L260" title="All 4 branches missed.">        if (comments == null || comments.size() == 0) {</span>
<span class="nc" id="L261">            return false;</span>
        }

<span class="nc" id="L264">        StringBuilder sb = new StringBuilder(</span>
                &quot;SELECT COUNT(*) FROM tbl_comments WHERE blog_id=? AND post_id=? AND comment_id IN (&quot;);
<span class="nc" id="L266">        boolean isFirst = true;</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">        for (ReaderComment comment : comments) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (isFirst) {</span>
<span class="nc" id="L269">                isFirst = false;</span>
            } else {
<span class="nc" id="L271">                sb.append(&quot;,&quot;);</span>
            }
<span class="nc" id="L273">            sb.append(comment.commentId);</span>
<span class="nc" id="L274">        }</span>
<span class="nc" id="L275">        sb.append(&quot;)&quot;);</span>

<span class="nc" id="L277">        String[] args = {Long.toString(comments.get(0).blogId),</span>
<span class="nc" id="L278">                Long.toString(comments.get(0).postId)};</span>
<span class="nc" id="L279">        int numExisting = SqlUtils.intForQuery(ReaderDatabase.getReadableDb(), sb.toString(), args);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        return numExisting != comments.size();</span>
    }

    /*
     * returns the #likes known to exist for this comment
     */
    public static int getNumLikesForComment(long blogId, long postId, long commentId) {
<span class="nc" id="L287">        String[] args = {Long.toString(blogId),</span>
<span class="nc" id="L288">                Long.toString(postId),</span>
<span class="nc" id="L289">                Long.toString(commentId)};</span>
<span class="nc" id="L290">        return SqlUtils.intForQuery(ReaderDatabase.getReadableDb(),</span>
                                    &quot;SELECT num_likes FROM tbl_comments WHERE blog_id=? AND post_id=? AND comment_id=?&quot;,
                                    args);
    }

    /*
     * updates both the like count for a comment and whether it's liked by the current user
     */
    public static void setLikesForComment(ReaderComment comment, int numLikes, boolean isLikedByCurrentUser) {
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (comment == null) {</span>
<span class="nc" id="L300">            return;</span>
        }

<span class="nc" id="L303">        String[] args =</span>
<span class="nc" id="L304">                {Long.toString(comment.blogId),</span>
<span class="nc" id="L305">                        Long.toString(comment.postId),</span>
<span class="nc" id="L306">                        Long.toString(comment.commentId)};</span>

<span class="nc" id="L308">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L309">        values.put(&quot;num_likes&quot;, numLikes);</span>
<span class="nc" id="L310">        values.put(&quot;is_liked&quot;, SqlUtils.boolToSql(isLikedByCurrentUser));</span>

<span class="nc" id="L312">        ReaderDatabase.getWritableDb().update(</span>
                &quot;tbl_comments&quot;,
                values,
                &quot;blog_id=? AND post_id=? AND comment_id=?&quot;,
                args);
<span class="nc" id="L317">    }</span>

    public static boolean isCommentLikedByCurrentUser(ReaderComment comment) {
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (comment == null) {</span>
<span class="nc" id="L321">            return false;</span>
        }
<span class="nc" id="L323">        return isCommentLikedByCurrentUser(comment.blogId, comment.postId, comment.commentId);</span>
    }

    public static boolean isCommentLikedByCurrentUser(long blogId, long postId, long commentId) {
<span class="nc" id="L327">        String[] args = {Long.toString(blogId),</span>
<span class="nc" id="L328">                Long.toString(postId),</span>
<span class="nc" id="L329">                Long.toString(commentId)};</span>
<span class="nc" id="L330">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                                     &quot;SELECT is_liked FROM tbl_comments WHERE blog_id=? AND post_id=? and comment_id=?&quot;,
                                     args);
    }

    public static boolean commentExists(long blogId, long postId, long commentId) {
<span class="nc" id="L336">        String[] args = {Long.toString(blogId),</span>
<span class="nc" id="L337">                Long.toString(postId),</span>
<span class="nc" id="L338">                Long.toString(commentId)};</span>

<span class="nc" id="L340">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                                     &quot;SELECT 1 FROM tbl_comments WHERE blog_id=? AND post_id=? AND comment_id=?&quot;, args);
    }

    private static ReaderComment getCommentFromCursor(Cursor c) {
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L346">            throw new IllegalArgumentException(&quot;null comment cursor&quot;);</span>
        }

<span class="nc" id="L349">        ReaderComment comment = new ReaderComment();</span>

<span class="nc" id="L351">        comment.commentId = c.getLong(c.getColumnIndexOrThrow(&quot;comment_id&quot;));</span>
<span class="nc" id="L352">        comment.blogId = c.getLong(c.getColumnIndexOrThrow(&quot;blog_id&quot;));</span>
<span class="nc" id="L353">        comment.postId = c.getLong(c.getColumnIndexOrThrow(&quot;post_id&quot;));</span>
<span class="nc" id="L354">        comment.parentId = c.getLong(c.getColumnIndexOrThrow(&quot;parent_id&quot;));</span>

<span class="nc" id="L356">        comment.setPublished(c.getString(c.getColumnIndexOrThrow(&quot;published&quot;)));</span>
<span class="nc" id="L357">        comment.timestamp = c.getLong(c.getColumnIndexOrThrow(&quot;timestamp&quot;));</span>

<span class="nc" id="L359">        comment.setAuthorAvatar(c.getString(c.getColumnIndexOrThrow(&quot;author_avatar&quot;)));</span>
<span class="nc" id="L360">        comment.setAuthorName(c.getString(c.getColumnIndexOrThrow(&quot;author_name&quot;)));</span>
<span class="nc" id="L361">        comment.setAuthorUrl(c.getString(c.getColumnIndexOrThrow(&quot;author_url&quot;)));</span>
<span class="nc" id="L362">        comment.authorId = c.getLong(c.getColumnIndexOrThrow(&quot;author_id&quot;));</span>
<span class="nc" id="L363">        comment.authorBlogId = c.getLong(c.getColumnIndexOrThrow(&quot;author_blog_id&quot;));</span>

<span class="nc" id="L365">        comment.setStatus(c.getString(c.getColumnIndexOrThrow(&quot;status&quot;)));</span>
<span class="nc" id="L366">        comment.setText(c.getString(c.getColumnIndexOrThrow(&quot;text&quot;)));</span>

<span class="nc" id="L368">        comment.numLikes = c.getInt(c.getColumnIndexOrThrow(&quot;num_likes&quot;));</span>
<span class="nc" id="L369">        comment.isLikedByCurrentUser = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_liked&quot;)));</span>
<span class="nc" id="L370">        comment.pageNumber = c.getInt(c.getColumnIndexOrThrow(&quot;page_number&quot;));</span>

<span class="nc" id="L372">        comment.setShortUrl(c.getString(c.getColumnIndexOrThrow(&quot;short_url&quot;)));</span>
<span class="nc" id="L373">        comment.setAuthorEmail(c.getString(c.getColumnIndexOrThrow(&quot;author_email&quot;)));</span>

<span class="nc" id="L375">        return comment;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>