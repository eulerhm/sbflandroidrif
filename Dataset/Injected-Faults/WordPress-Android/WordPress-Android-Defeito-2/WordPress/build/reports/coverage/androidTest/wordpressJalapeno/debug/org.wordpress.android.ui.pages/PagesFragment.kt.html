<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PagesFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.pages</a> &gt; <span class="el_source">PagesFragment.kt</span></div><h1>PagesFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.pages

import android.annotation.SuppressLint
import android.app.Activity
import android.app.ProgressDialog
import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.view.HapticFeedbackConstants
import android.view.Menu
import android.view.MenuInflater
import android.view.MenuItem
import android.view.MenuItem.OnActionExpandListener
import android.view.MotionEvent
import android.view.View
import android.widget.AdapterView
import android.widget.LinearLayout
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.widget.SearchView
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentActivity
import androidx.fragment.app.FragmentManager
import androidx.fragment.app.FragmentPagerAdapter
import androidx.lifecycle.Observer
import androidx.lifecycle.ViewModelProvider
import androidx.viewpager.widget.ViewPager.OnPageChangeListener
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.PagesFragmentBinding
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.model.PostModel
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.model.page.PageModel
import org.wordpress.android.fluxc.store.PostStore
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.PagePostCreationSourcesDetail.PAGE_FROM_PAGES_LIST
import org.wordpress.android.ui.RequestCodes
import org.wordpress.android.ui.ScrollableViewInitializedListener
import org.wordpress.android.ui.mlp.ModalLayoutPickerFragment
import org.wordpress.android.ui.mlp.ModalLayoutPickerFragment.Companion.MODAL_LAYOUT_PICKER_TAG
import org.wordpress.android.ui.posts.EditPostActivity
import org.wordpress.android.ui.posts.PostListAction.PreviewPost
import org.wordpress.android.ui.posts.PreviewStateHelper
import org.wordpress.android.ui.posts.ProgressDialogHelper
import org.wordpress.android.ui.posts.RemotePreviewLogicHelper
import org.wordpress.android.ui.posts.adapters.AuthorSelectionAdapter
import org.wordpress.android.ui.uploads.UploadActionUseCase
import org.wordpress.android.ui.uploads.UploadUtilsWrapper
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.DisplayUtils
import org.wordpress.android.util.ToastUtils.Duration
import org.wordpress.android.util.WPSwipeToRefreshHelper
import org.wordpress.android.util.helpers.SwipeToRefreshHelper
import org.wordpress.android.util.extensions.redirectContextClickToLongPressListener
import org.wordpress.android.util.extensions.setLiftOnScrollTargetViewIdAndRequestLayout
import org.wordpress.android.viewmodel.helpers.ToastMessageHolder
import org.wordpress.android.viewmodel.mlp.ModalLayoutPickerViewModel
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListState
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListState.FETCHING
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType.DRAFTS
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType.PUBLISHED
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType.SCHEDULED
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType.TRASHED
import org.wordpress.android.viewmodel.pages.PagesViewModel
import org.wordpress.android.widgets.WPSnackbar
import java.lang.ref.WeakReference
import javax.inject.Inject

<span class="nc" id="L73">class PagesFragment : Fragment(R.layout.pages_fragment), ScrollableViewInitializedListener {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
    private lateinit var viewModel: PagesViewModel
    private lateinit var mlpViewModel: ModalLayoutPickerViewModel
    private lateinit var swipeToRefreshHelper: SwipeToRefreshHelper
    private lateinit var actionMenuItem: MenuItem
    private var binding: PagesFragmentBinding? = null

    /**
     * PostStore needs to be injected here as otherwise FluxC doesn't accept emitted events.
     */
    @Suppress(&quot;unused&quot;)
<span class="nc bnc" id="L85" title="All 2 branches missed.">    @Inject lateinit var postStore: PostStore</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">    @Inject lateinit var dispatcher: Dispatcher</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">    @Inject lateinit var remotePreviewLogicHelper: RemotePreviewLogicHelper</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">    @Inject lateinit var previewStateHelper: PreviewStateHelper</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">    @Inject lateinit var progressDialogHelper: ProgressDialogHelper</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">    @Inject lateinit var uploadActionUseCase: UploadActionUseCase</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">    @Inject lateinit var uploadUtilsWrapper: UploadUtilsWrapper</span>

    private var progressDialog: ProgressDialog? = null

    private var restorePreviousSearch = false

    private lateinit var authorSelectionAdapter: AuthorSelectionAdapter

    companion object {
        fun newInstance(): PagesFragment {
<span class="nc" id="L102">            return PagesFragment()</span>
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L107">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L108">        setHasOptionsMenu(true)</span>

<span class="nc" id="L110">        val nonNullActivity = requireActivity()</span>
<span class="nc bnc" id="L111" title="All 6 branches missed.">        (nonNullActivity.application as? WordPress)?.component()?.inject(this)</span>

<span class="nc" id="L113">        viewModel = ViewModelProvider(nonNullActivity, viewModelFactory).get(PagesViewModel::class.java)</span>
<span class="nc" id="L114">        mlpViewModel = ViewModelProvider(nonNullActivity, viewModelFactory).get(ModalLayoutPickerViewModel::class.java)</span>
<span class="nc" id="L115">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L118">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc" id="L120">        val nonNullActivity = requireActivity()</span>
<span class="nc" id="L121">        with(PagesFragmentBinding.bind(view)) {</span>
<span class="nc" id="L122">            binding = this</span>
<span class="nc" id="L123">            with(nonNullActivity as AppCompatActivity) {</span>
<span class="nc" id="L124">                setSupportActionBar(toolbar)</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                supportActionBar?.let {</span>
<span class="nc" id="L126">                    it.setHomeButtonEnabled(true)</span>
<span class="nc" id="L127">                    it.setDisplayHomeAsUpEnabled(true)</span>
<span class="nc" id="L128">                }</span>
            }
<span class="nc" id="L130">            initializeViews(nonNullActivity)</span>
<span class="nc" id="L131">            initializeViewModelObservers(nonNullActivity, savedInstanceState)</span>
<span class="nc" id="L132">        }</span>
<span class="nc" id="L133">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L136">        super.onDestroyView()</span>
<span class="nc" id="L137">        binding = null</span>
<span class="nc" id="L138">    }</span>

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
<span class="nc bnc" id="L141" title="All 6 branches missed.">        if (requestCode == RequestCodes.EDIT_POST &amp;&amp; resultCode == Activity.RESULT_OK &amp;&amp; data != null) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (EditPostActivity.checkToRestart(data)) {</span>
<span class="nc" id="L143">                ActivityLauncher.editPageForResult(</span>
<span class="nc" id="L144">                        data,</span>
<span class="nc" id="L145">                        this@PagesFragment,</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                        viewModel.site,</span>
<span class="nc" id="L147">                        data.getIntExtra(EditPostActivity.EXTRA_POST_LOCAL_ID, 0),</span>
<span class="nc" id="L148">                        false</span>
                )

                // a restart will happen so, no need to continue here
<span class="nc" id="L152">                return</span>
            }
            // we need to work with local ids, since local drafts don't have remote ids
<span class="nc" id="L155">            val localPageId = data.getIntExtra(EditPostActivity.EXTRA_POST_LOCAL_ID, -1)</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (localPageId != -1) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                viewModel.onPageEditFinished(localPageId, data)</span>
            }
<span class="nc bnc" id="L159" title="All 6 branches missed.">        } else if (requestCode == RequestCodes.PAGE_PARENT &amp;&amp; resultCode == Activity.RESULT_OK &amp;&amp; data != null) {</span>
<span class="nc" id="L160">            val parentId = data.getLongExtra(EXTRA_PAGE_PARENT_ID_KEY, -1)</span>
<span class="nc" id="L161">            val pageId = data.getLongExtra(EXTRA_PAGE_REMOTE_ID_KEY, -1)</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">            if (pageId != -1L &amp;&amp; parentId != -1L) {</span>
<span class="nc" id="L163">                onPageParentSet(pageId, parentId)</span>
            }
        }
<span class="nc" id="L166">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc bnc" id="L169" title="All 2 branches missed.">        outState.putSerializable(WordPress.SITE, viewModel.site)</span>
<span class="nc" id="L170">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L171">    }</span>

    fun onSpecificPageRequested(remotePageId: Long) {
<span class="nc bnc" id="L174" title="All 2 branches missed.">        viewModel.onSpecificPageRequested(remotePageId)</span>
<span class="nc" id="L175">    }</span>

    private fun onPageParentSet(pageId: Long, parentId: Long) {
<span class="nc bnc" id="L178" title="All 2 branches missed.">        viewModel.onPageParentSet(pageId, parentId)</span>
<span class="nc" id="L179">    }</span>

    @SuppressLint(&quot;ClickableViewAccessibility&quot;)
    private fun PagesFragmentBinding.initializeViews(activity: FragmentActivity) {
<span class="nc" id="L183">        pagesPager.adapter = PagesPagerAdapter(activity, childFragmentManager)</span>
<span class="nc" id="L184">        tabLayout.setupWithViewPager(pagesPager)</span>

<span class="nc" id="L186">        swipeToRefreshHelper = WPSwipeToRefreshHelper.buildSwipeToRefreshHelper(pullToRefresh) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            viewModel.onPullToRefresh()</span>
<span class="nc" id="L188">        }</span>

<span class="nc" id="L190">        newPageButton.setOnClickListener {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            viewModel.onNewPageButtonTapped()</span>
<span class="nc" id="L192">        }</span>

<span class="nc" id="L194">        newPageButton.setOnLongClickListener {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (newPageButton.isHapticFeedbackEnabled) {</span>
<span class="nc" id="L196">                newPageButton.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS)</span>
            }

<span class="nc" id="L199">            Toast.makeText(newPageButton.context, R.string.create_page_fab_tooltip, Toast.LENGTH_SHORT).show()</span>
<span class="nc" id="L200">            return@setOnLongClickListener true</span>
        }
<span class="nc" id="L202">        newPageButton.redirectContextClickToLongPressListener()</span>

<span class="nc" id="L204">        pagesPager.addOnPageChangeListener(object : OnPageChangeListener {</span>
            override fun onPageScrollStateChanged(state: Int) {
<span class="nc" id="L206">            }</span>

            override fun onPageScrolled(position: Int, positionOffset: Float, positionOffsetPixels: Int) {
<span class="nc" id="L209">            }</span>

            override fun onPageSelected(position: Int) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">                viewModel.onPageTypeChanged(PagesPagerAdapter.pageTypes[position])</span>
<span class="nc" id="L213">            }</span>
        })

<span class="nc" id="L216">        val searchFragment = SearchListFragment.newInstance()</span>
<span class="nc" id="L217">        activity.supportFragmentManager</span>
<span class="nc" id="L218">                .beginTransaction()</span>
<span class="nc" id="L219">                .replace(R.id.searchFrame, searchFragment)</span>
<span class="nc" id="L220">                .commit()</span>

<span class="nc" id="L222">        pagesPager.setOnTouchListener { _, event -&gt;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            swipeToRefreshHelper.setEnabled(false)</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (event.action == MotionEvent.ACTION_UP) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                swipeToRefreshHelper.setEnabled(true)</span>
            }
<span class="nc" id="L227">            return@setOnTouchListener false</span>
        }

<span class="nc" id="L230">        authorSelectionAdapter = AuthorSelectionAdapter(activity)</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">        pagesAuthorSelection.adapter = authorSelectionAdapter</span>
<span class="nc" id="L232">        pagesAuthorSelection.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {</span>
<span class="nc" id="L233">            override fun onNothingSelected(parent: AdapterView&lt;*&gt;) {}</span>

            override fun onItemSelected(parent: AdapterView&lt;*&gt;, view: View?, position: Int, id: Long) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">                viewModel.updateAuthorFilterSelection(id)</span>
<span class="nc" id="L237">            }</span>
        }
<span class="nc" id="L239">    }</span>

    private fun PagesFragmentBinding.initializeSearchView() {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        actionMenuItem.setOnActionExpandListener(object : OnActionExpandListener {</span>
            override fun onMenuItemActionExpand(item: MenuItem?): Boolean {
<span class="nc bnc" id="L244" title="All 2 branches missed.">                viewModel.onSearchExpanded(restorePreviousSearch)</span>
<span class="nc" id="L245">                return true</span>
            }

            override fun onMenuItemActionCollapse(item: MenuItem?): Boolean {
<span class="nc bnc" id="L249" title="All 2 branches missed.">                viewModel.onSearchCollapsed()</span>
<span class="nc" id="L250">                return true</span>
            }
        })

<span class="nc bnc" id="L254" title="All 4 branches missed.">        val searchView = actionMenuItem.actionView as SearchView</span>
<span class="nc" id="L255">        searchView.setOnQueryTextListener(object : SearchView.OnQueryTextListener {</span>
            override fun onQueryTextSubmit(query: String): Boolean {
<span class="nc bnc" id="L257" title="All 2 branches missed.">                viewModel.onSearch(query)</span>
<span class="nc" id="L258">                return true</span>
            }

            override fun onQueryTextChange(newText: String): Boolean {
<span class="nc bnc" id="L262" title="All 2 branches missed.">                if (restorePreviousSearch) {</span>
<span class="nc" id="L263">                    restorePreviousSearch = false</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                    searchView.setQuery(viewModel.lastSearchQuery, false)</span>
                } else {
<span class="nc bnc" id="L266" title="All 2 branches missed.">                    viewModel.onSearch(newText)</span>
                }
<span class="nc" id="L268">                return true</span>
            }
        })

        // fix the search view margins to match the action bar
<span class="nc bnc" id="L273" title="All 2 branches missed.">        val searchEditFrame = actionMenuItem.actionView.findViewById&lt;LinearLayout&gt;(R.id.search_edit_frame)</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        (searchEditFrame.layoutParams as LinearLayout.LayoutParams)</span>
<span class="nc" id="L275">                .apply { this.leftMargin = DisplayUtils.dpToPx(activity, -8) }</span>

<span class="nc bnc" id="L277" title="All 2 branches missed.">        viewModel.isSearchExpanded.observe(this@PagesFragment, Observer {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">            if (it == true) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                showSearchList(actionMenuItem)</span>
            } else {
<span class="nc bnc" id="L281" title="All 2 branches missed.">                hideSearchList(actionMenuItem)</span>
            }
<span class="nc" id="L283">        })</span>
<span class="nc" id="L284">    }</span>

    private fun PagesFragmentBinding.initializeViewModelObservers(
        activity: FragmentActivity,
        savedInstanceState: Bundle?
    ) {
<span class="nc" id="L290">        setupObservers(activity)</span>
<span class="nc" id="L291">        setupActions(activity)</span>
<span class="nc" id="L292">        setupMlpObservers(activity)</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">        val site = if (savedInstanceState == null) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            val nonNullIntent = checkNotNull(activity.intent)</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">            nonNullIntent.getSerializableExtra(WordPress.SITE) as SiteModel</span>
        } else {
<span class="nc" id="L298">            restorePreviousSearch = true</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            savedInstanceState.getSerializable(WordPress.SITE) as SiteModel</span>
        }

<span class="nc bnc" id="L302" title="All 2 branches missed.">        viewModel.authorUIState.observe(activity, Observer { state -&gt;</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            state?.let {</span>
<span class="nc" id="L304">                uiHelpers.updateVisibility(pagesAuthorSelection, state.isAuthorFilterVisible)</span>
<span class="nc" id="L305">                uiHelpers.updateVisibility(pagesTabLayoutFadingEdge, state.isAuthorFilterVisible)</span>

<span class="nc" id="L307">                val tabLayoutPaddingStart =</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                        if (state.isAuthorFilterVisible) {</span>
<span class="nc" id="L309">                            resources.getDimensionPixelSize(R.dimen.posts_list_tab_layout_fading_edge_width)</span>
<span class="nc" id="L310">                        } else 0</span>
<span class="nc" id="L311">                tabLayout.setPaddingRelative(tabLayoutPaddingStart, 0, 0, 0)</span>

<span class="nc bnc" id="L313" title="All 2 branches missed.">                authorSelectionAdapter.updateItems(state.authorFilterItems)</span>

<span class="nc bnc" id="L315" title="All 4 branches missed.">                authorSelectionAdapter.getIndexOfSelection(state.authorFilterSelection)?.let { selectionIndex -&gt;</span>
<span class="nc" id="L316">                    pagesAuthorSelection.setSelection(selectionIndex)</span>
<span class="nc" id="L317">                }</span>
<span class="nc" id="L318">            }</span>
<span class="nc" id="L319">        })</span>

<span class="nc bnc" id="L321" title="All 2 branches missed.">        viewModel.start(site)</span>
<span class="nc" id="L322">    }</span>

    private fun showToast(toastMessageHolder: ToastMessageHolder) {
<span class="nc bnc" id="L325" title="All 2 branches missed.">        context?.let {</span>
<span class="nc" id="L326">            toastMessageHolder.show(it)</span>
<span class="nc" id="L327">        }</span>
<span class="nc" id="L328">    }</span>

    private fun previewPage(activity: FragmentActivity, post: PostModel) {
<span class="nc" id="L331">        val action = PreviewPost(</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                site = viewModel.site,</span>
<span class="nc" id="L333">                post = post,</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                triggerPreviewStateUpdate = viewModel::updatePreviewAndDialogState,</span>
<span class="nc" id="L335">                showToast = this::showToast,</span>
<span class="nc" id="L336">                messageMediaUploading = ToastMessageHolder(R.string.editor_toast_uploading_please_wait, Duration.SHORT)</span>
        )

<span class="nc" id="L339">        val helperFunctions = previewStateHelper.getUploadStrategyFunctions(activity, action)</span>
<span class="nc" id="L340">        remotePreviewLogicHelper.runPostPreviewLogic(</span>
<span class="nc" id="L341">                activity = activity,</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                site = viewModel.site,</span>
<span class="nc" id="L343">                post = post,</span>
<span class="nc" id="L344">                helperFunctions = helperFunctions</span>
        )
<span class="nc" id="L346">    }</span>

    private fun PagesFragmentBinding.setupObservers(activity: FragmentActivity) {
<span class="nc bnc" id="L349" title="All 2 branches missed.">        viewModel.listState.observe(viewLifecycleOwner, {</span>
<span class="nc" id="L350">            refreshProgressBars(it)</span>
<span class="nc" id="L351">        })</span>

<span class="nc bnc" id="L353" title="All 2 branches missed.">        viewModel.createNewPage.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L354" title="All 4 branches missed.">            if (mlpViewModel.canShowModalLayoutPicker()) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                mlpViewModel.createPageFlowTriggered()</span>
            } else {
<span class="nc" id="L357">                createNewPage()</span>
            }
<span class="nc" id="L359">        })</span>

<span class="nc bnc" id="L361" title="All 2 branches missed.">        viewModel.showSnackbarMessage.observe(viewLifecycleOwner, { holder -&gt;</span>
<span class="nc" id="L362">            showSnackbarInActivity(activity, holder)</span>
<span class="nc" id="L363">        })</span>

<span class="nc bnc" id="L365" title="All 2 branches missed.">        viewModel.editPage.observe(viewLifecycleOwner, { (site, page, loadAutoRevision) -&gt;</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">            page?.let {</span>
<span class="nc" id="L367">                ActivityLauncher.editPageForResult(this@PagesFragment, site, page.id, loadAutoRevision)</span>
<span class="nc" id="L368">            }</span>
<span class="nc" id="L369">        })</span>

<span class="nc bnc" id="L371" title="All 2 branches missed.">        viewModel.previewPage.observe(viewLifecycleOwner, { post -&gt;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            post?.let {</span>
<span class="nc" id="L373">                previewPage(activity, post)</span>
<span class="nc" id="L374">            }</span>
<span class="nc" id="L375">        })</span>

<span class="nc bnc" id="L377" title="All 2 branches missed.">        viewModel.browsePreview.observe(viewLifecycleOwner, { preview -&gt;</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            preview?.let {</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                ActivityLauncher.previewPostOrPageForResult(activity, viewModel.site, preview.post, preview.previewType)</span>
<span class="nc" id="L380">            }</span>
<span class="nc" id="L381">        })</span>

<span class="nc bnc" id="L383" title="All 2 branches missed.">        viewModel.previewState.observe(viewLifecycleOwner, {</span>
<span class="nc" id="L384">            progressDialog = progressDialogHelper.updateProgressDialogState(</span>
<span class="nc" id="L385">                    activity,</span>
<span class="nc" id="L386">                    progressDialog,</span>
<span class="nc" id="L387">                    it.progressDialogUiState,</span>
<span class="nc" id="L388">                    uiHelpers</span>
            )
<span class="nc" id="L390">        })</span>

<span class="nc bnc" id="L392" title="All 2 branches missed.">        viewModel.setPageParent.observe(viewLifecycleOwner, { page -&gt;</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">            page?.let { ActivityLauncher.viewPageParentForResult(this@PagesFragment, page) }</span>
<span class="nc" id="L394">        })</span>

<span class="nc bnc" id="L396" title="All 2 branches missed.">        viewModel.isNewPageButtonVisible.observe(viewLifecycleOwner, { isVisible -&gt;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">            isVisible?.let {</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">                if (isVisible) {</span>
<span class="nc" id="L399">                    newPageButton.show()</span>
                } else {
<span class="nc" id="L401">                    newPageButton.hide()</span>
                }
<span class="nc" id="L403">            }</span>
<span class="nc" id="L404">        })</span>

<span class="nc bnc" id="L406" title="All 2 branches missed.">        viewModel.scrollToPage.observe(viewLifecycleOwner, { requestedPage -&gt;</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">            requestedPage?.let { page -&gt;</span>
<span class="nc" id="L408">                val pagerIndex = PagesPagerAdapter.pageTypes.indexOf(PageListType.fromPageStatus(page.status))</span>
<span class="nc" id="L409">                pagesPager.currentItem = pagerIndex</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                (pagesPager.adapter as PagesPagerAdapter).scrollToPage(page)</span>
<span class="nc" id="L411">            }</span>
<span class="nc" id="L412">        })</span>
<span class="nc" id="L413">    }</span>

    private fun showSnackbarInActivity(
        activity: FragmentActivity,
        holder: SnackbarMessageHolder?
    ) {
<span class="nc" id="L419">        val parent = activity.findViewById&lt;View&gt;(R.id.coordinatorLayout)</span>
<span class="nc bnc" id="L420" title="All 4 branches missed.">        if (holder != null &amp;&amp; parent != null) {</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">            if (holder.buttonTitle == null) {</span>
<span class="nc" id="L422">                WPSnackbar.make(</span>
<span class="nc" id="L423">                        parent,</span>
<span class="nc" id="L424">                        uiHelpers.getTextOfUiString(requireContext(), holder.message),</span>
<span class="nc" id="L425">                        Snackbar.LENGTH_LONG</span>
<span class="nc" id="L426">                ).show()</span>
            } else {
<span class="nc" id="L428">                val snackbar = WPSnackbar.make(</span>
<span class="nc" id="L429">                        parent,</span>
<span class="nc" id="L430">                        uiHelpers.getTextOfUiString(requireContext(), holder.message),</span>
<span class="nc" id="L431">                        Snackbar.LENGTH_LONG</span>
                )
<span class="nc" id="L433">                snackbar.setAction(</span>
<span class="nc" id="L434">                        uiHelpers.getTextOfUiString(</span>
<span class="nc" id="L435">                                requireContext(),</span>
<span class="nc" id="L436">                                holder.buttonTitle</span>
                        )
                ) {
<span class="nc" id="L439">                    holder.buttonAction()</span>
<span class="nc" id="L440">                }</span>
<span class="nc" id="L441">                snackbar.show()</span>
            }
        }
<span class="nc" id="L444">    }</span>

    private fun setupActions(activity: FragmentActivity) {
<span class="nc bnc" id="L447" title="All 2 branches missed.">        viewModel.dialogAction.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">            it?.show(activity, activity.supportFragmentManager, uiHelpers)</span>
<span class="nc" id="L449">        })</span>

<span class="nc bnc" id="L451" title="All 2 branches missed.">        viewModel.postUploadAction.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">            it?.let { (post, site, data) -&gt;</span>
<span class="nc" id="L453">                uploadUtilsWrapper.handleEditPostResultSnackbars(</span>
<span class="nc" id="L454">                        activity,</span>
<span class="nc" id="L455">                        activity.findViewById(R.id.coordinator),</span>
<span class="nc" id="L456">                        data,</span>
<span class="nc" id="L457">                        post,</span>
<span class="nc" id="L458">                        site,</span>
<span class="nc" id="L459">                        uploadActionUseCase.getUploadAction(post),</span>
                        {
<span class="nc" id="L461">                            uploadUtilsWrapper.publishPost(</span>
<span class="nc" id="L462">                                    activity,</span>
<span class="nc" id="L463">                                    post,</span>
<span class="nc" id="L464">                                    site</span>
                            )
<span class="nc" id="L466">                        }</span>
                )
<span class="nc" id="L468">            }</span>
<span class="nc" id="L469">        })</span>

<span class="nc bnc" id="L471" title="All 2 branches missed.">        viewModel.publishAction.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            it?.let {</span>
<span class="nc" id="L473">                uploadUtilsWrapper.publishPost(activity, it.post, it.site)</span>
<span class="nc" id="L474">            }</span>
<span class="nc" id="L475">        })</span>

<span class="nc bnc" id="L477" title="All 2 branches missed.">        viewModel.uploadFinishedAction.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            it?.let { (page, isError, isFirstTimePublish) -&gt;</span>
<span class="nc" id="L479">                uploadUtilsWrapper.onPostUploadedSnackbarHandler(</span>
<span class="nc" id="L480">                        activity,</span>
<span class="nc" id="L481">                        activity.findViewById(R.id.coordinator),</span>
<span class="nc" id="L482">                        isError,</span>
<span class="nc" id="L483">                        isFirstTimePublish,</span>
<span class="nc" id="L484">                        page.post,</span>
<span class="nc" id="L485">                        null,</span>
<span class="nc" id="L486">                        page.site</span>
                )
<span class="nc" id="L488">            }</span>
<span class="nc" id="L489">        })</span>
<span class="nc" id="L490">    }</span>

    private fun setupMlpObservers(activity: FragmentActivity) {
<span class="nc bnc" id="L493" title="All 2 branches missed.">        mlpViewModel.onCreateNewPageRequested.observe(viewLifecycleOwner, { request -&gt;</span>
<span class="nc" id="L494">            createNewPage(request.title, &quot;&quot;, request.template)</span>
<span class="nc" id="L495">        })</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">        mlpViewModel.isModalLayoutPickerShowing.observeEvent(viewLifecycleOwner, { isShowing -&gt;</span>
<span class="nc" id="L497">            val fm = activity.supportFragmentManager</span>
<span class="nc" id="L498">            var mlpFragment = fm.findFragmentByTag(MODAL_LAYOUT_PICKER_TAG) as ModalLayoutPickerFragment?</span>
<span class="nc bnc" id="L499" title="All 4 branches missed.">            if (isShowing &amp;&amp; mlpFragment == null) {</span>
<span class="nc" id="L500">                mlpFragment = ModalLayoutPickerFragment()</span>
<span class="nc" id="L501">                mlpFragment.show(fm, MODAL_LAYOUT_PICKER_TAG)</span>
<span class="nc bnc" id="L502" title="All 4 branches missed.">            } else if (!isShowing &amp;&amp; mlpFragment != null) {</span>
<span class="nc" id="L503">                mlpFragment.dismiss()</span>
            }
<span class="nc" id="L505">        })</span>
<span class="nc" id="L506">    }</span>

    /**
     * Triggers new page creation
     * @param title the page title
     * @param content the page content
     * @param template the selected layout template
     */
<span class="nc" id="L514">    private fun createNewPage(title: String = &quot;&quot;, content: String = &quot;&quot;, template: String? = null) {</span>
<span class="nc" id="L515">        ActivityLauncher.addNewPageForResult(</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                this, viewModel.site, title, content, template,</span>
<span class="nc" id="L517">                PAGE_FROM_PAGES_LIST</span>
        )
<span class="nc" id="L519">    }</span>

    override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
<span class="nc" id="L522">        super.onCreateOptionsMenu(menu, inflater)</span>
<span class="nc" id="L523">        inflater.inflate(R.menu.menu_search, menu)</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">        actionMenuItem = checkNotNull(menu.findItem(R.id.action_search)) {</span>
<span class="nc" id="L525">            &quot;Menu does not contain mandatory search item&quot;</span>
        }

<span class="nc" id="L528">        binding!!.initializeSearchView()</span>
<span class="nc" id="L529">    }</span>

    private fun refreshProgressBars(listState: PageListState?) {
<span class="nc bnc" id="L532" title="All 4 branches missed.">        if (!isAdded || view == null) {</span>
<span class="nc" id="L533">            return</span>
        }
        // We want to show the swipe refresher for the initial fetch but not while loading more
<span class="nc bnc" id="L536" title="All 4 branches missed.">        swipeToRefreshHelper.isRefreshing = listState == FETCHING</span>
<span class="nc" id="L537">    }</span>

    private fun PagesFragmentBinding.hideSearchList(myActionMenuItem: MenuItem) {
<span class="nc" id="L540">        pagesPager.visibility = View.VISIBLE</span>
<span class="nc" id="L541">        tabLayout.visibility = View.VISIBLE</span>
<span class="nc" id="L542">        tabContainer.visibility = View.VISIBLE</span>
<span class="nc" id="L543">        searchFrame.visibility = View.GONE</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (myActionMenuItem.isActionViewExpanded) {</span>
<span class="nc" id="L545">            myActionMenuItem.collapseActionView()</span>
        }
<span class="nc bnc" id="L547" title="All 2 branches missed.">        appbarMain.getTag(R.id.pages_non_search_recycler_view_id_tag_key)?.let {</span>
<span class="nc" id="L548">            appbarMain.setLiftOnScrollTargetViewIdAndRequestLayout(it as Int)</span>
<span class="nc" id="L549">        }</span>
<span class="nc" id="L550">    }</span>

    private fun PagesFragmentBinding.showSearchList(myActionMenuItem: MenuItem) {
<span class="nc" id="L553">        pagesPager.visibility = View.GONE</span>
<span class="nc" id="L554">        tabLayout.visibility = View.GONE</span>
<span class="nc" id="L555">        tabContainer.visibility = View.GONE</span>
<span class="nc" id="L556">        searchFrame.visibility = View.VISIBLE</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">        if (!myActionMenuItem.isActionViewExpanded) {</span>
<span class="nc" id="L558">            myActionMenuItem.expandActionView()</span>
        }
<span class="nc" id="L560">        appbarMain.setLiftOnScrollTargetViewIdAndRequestLayout(R.id.pages_search_recycler_view_id)</span>
<span class="nc" id="L561">    }</span>

    fun onPositiveClickedForBasicDialog(instanceTag: String) {
<span class="nc bnc" id="L564" title="All 2 branches missed.">        viewModel.onPositiveClickedForBasicDialog(instanceTag)</span>
<span class="nc" id="L565">    }</span>

    fun onNegativeClickedForBasicDialog(instanceTag: String) {
<span class="nc bnc" id="L568" title="All 2 branches missed.">        viewModel.onNegativeClickedForBasicDialog(instanceTag)</span>
<span class="nc" id="L569">    }</span>

    override fun onScrollableViewInitialized(containerId: Int) {
<span class="nc" id="L572">        with(binding!!) {</span>
<span class="nc" id="L573">            appbarMain.setLiftOnScrollTargetViewIdAndRequestLayout(containerId)</span>
<span class="nc" id="L574">            appbarMain.setTag(R.id.pages_non_search_recycler_view_id_tag_key, containerId)</span>
<span class="nc" id="L575">        }</span>
<span class="nc" id="L576">    }</span>
}

<span class="nc" id="L579">class PagesPagerAdapter(val context: Context, val fm: FragmentManager) : FragmentPagerAdapter(</span>
<span class="nc" id="L580">        fm,</span>
<span class="nc" id="L581">        BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT</span>
) {
    companion object {
<span class="nc" id="L584">        val pageTypes = listOf(PUBLISHED, DRAFTS, SCHEDULED, TRASHED)</span>
    }

<span class="nc" id="L587">    private val listFragments = mutableMapOf&lt;PageListType, WeakReference&lt;PageListFragment&gt;&gt;()</span>

<span class="nc" id="L589">    override fun getCount(): Int = pageTypes.size</span>

    override fun getItem(position: Int): Fragment {
<span class="nc" id="L592">        val fragment = PageListFragment.newInstance(pageTypes[position])</span>
<span class="nc" id="L593">        listFragments[pageTypes[position]] = WeakReference(fragment)</span>
<span class="nc" id="L594">        return fragment</span>
    }

    override fun getPageTitle(position: Int): CharSequence? {
<span class="nc" id="L598">        return context.getString(pageTypes[position].title)</span>
    }

    fun scrollToPage(page: PageModel) {
<span class="nc bnc" id="L602" title="All 2 branches missed.">        val listFragment = listFragments[PageListType.fromPageStatus(page.status)]?.get()</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">        listFragment?.scrollToPage(page.pageId)</span>
<span class="nc" id="L604">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>