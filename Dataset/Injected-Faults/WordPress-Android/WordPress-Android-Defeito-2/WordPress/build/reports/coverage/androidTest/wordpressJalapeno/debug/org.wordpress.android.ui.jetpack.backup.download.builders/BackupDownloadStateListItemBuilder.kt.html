<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BackupDownloadStateListItemBuilder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.jetpack.backup.download.builders</a> &gt; <span class="el_source">BackupDownloadStateListItemBuilder.kt</span></div><h1>BackupDownloadStateListItemBuilder.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.jetpack.backup.download.builders

import androidx.annotation.ColorRes
import androidx.annotation.DimenRes
import androidx.annotation.DrawableRes
import androidx.annotation.StringRes
import dagger.Reusable
import org.wordpress.android.R
import org.wordpress.android.ui.jetpack.backup.download.BackupDownloadErrorTypes
import org.wordpress.android.ui.jetpack.backup.download.BackupDownloadErrorTypes.RemoteRequestFailure
import org.wordpress.android.ui.jetpack.backup.download.BackupDownloadUiState
import org.wordpress.android.ui.jetpack.common.CheckboxSpannableLabel
import org.wordpress.android.ui.jetpack.common.JetpackBackupRestoreListItemState.BulletState
import org.wordpress.android.ui.jetpack.common.JetpackBackupRestoreListItemState.FootnoteState
import org.wordpress.android.ui.jetpack.common.JetpackBackupRestoreListItemState.SubHeaderState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.ActionButtonState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.CheckboxState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.DescriptionState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.HeaderState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.IconState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.ProgressState
import org.wordpress.android.ui.jetpack.common.ViewType.CHECKBOX
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItem
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringResWithParams
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.extensions.toFormattedDateString
import org.wordpress.android.util.extensions.toFormattedTimeString
import java.util.Date
import javax.inject.Inject

<span class="nc" id="L34">@Reusable</span>
<span class="nc" id="L35">class BackupDownloadStateListItemBuilder @Inject constructor(</span>
<span class="nc" id="L36">    private val checkboxSpannableLabel: CheckboxSpannableLabel</span>
) {
    fun buildDetailsListStateItems(
        published: Date,
        availableItems: List&lt;JetpackAvailableItem&gt;,
        onCreateDownloadClick: () -&gt; Unit,
        onCheckboxItemClicked: (availableItemType: JetpackAvailableItemType) -&gt; Unit
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L44">        val items = mutableListOf(</span>
<span class="nc" id="L45">                buildIconState(</span>
<span class="nc" id="L46">                        R.drawable.ic_get_app_white_24dp,</span>
<span class="nc" id="L47">                        R.string.backup_download_details_icon_content_description,</span>
<span class="nc" id="L48">                        R.color.success</span>
                ),
<span class="nc" id="L50">                buildHeaderState(R.string.backup_download_details_header),</span>
<span class="nc" id="L51">                buildDescriptionState(published, R.string.backup_download_details_description_with_two_parameters),</span>
<span class="nc" id="L52">                buildActionButtonState(</span>
<span class="nc" id="L53">                        titleRes = R.string.backup_download_details_action_button,</span>
<span class="nc" id="L54">                        contentDescRes = R.string.backup_download_details_action_button_content_description,</span>
<span class="nc" id="L55">                        onClick = onCreateDownloadClick</span>
                ),
<span class="nc" id="L57">                buildSubHeaderState(R.string.backup_download_details_choose_items_header)</span>
        )

<span class="nc" id="L60">        val availableItemsListItems: List&lt;CheckboxState&gt; = availableItems.map {</span>
<span class="nc" id="L61">            CheckboxState(</span>
<span class="nc" id="L62">                    availableItemType = it.availableItemType,</span>
<span class="nc" id="L63">                    label = UiStringRes(it.labelResId),</span>
<span class="nc" id="L64">                    labelSpannable = checkboxSpannableLabel.buildSpannableLabel(it.labelResId, it.labelHintResId),</span>
<span class="nc" id="L65">                    checked = true,</span>
<span class="nc" id="L66">                    onClick = { onCheckboxItemClicked(it.availableItemType) }</span>
            )
        }
<span class="nc" id="L69">        items.addAll(availableItemsListItems)</span>
<span class="nc" id="L70">        return items</span>
    }

<span class="nc" id="L73">    fun buildProgressListStateItems(</span>
<span class="nc" id="L74">        progress: Int = 0,</span>
        published: Date
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L77">        return mutableListOf(</span>
<span class="nc" id="L78">                buildIconState(</span>
<span class="nc" id="L79">                        R.drawable.ic_get_app_white_24dp,</span>
<span class="nc" id="L80">                        R.string.backup_download_progress_icon_content_description,</span>
<span class="nc" id="L81">                        R.color.success</span>
                ),
<span class="nc" id="L83">                buildHeaderState(R.string.backup_download_progress_header),</span>
<span class="nc" id="L84">                buildDescriptionState(published, R.string.backup_download_progress_description_with_two_parameters),</span>
<span class="nc" id="L85">                buildProgressState(progress),</span>
<span class="nc" id="L86">                buildFootnoteState(</span>
<span class="nc" id="L87">                        iconRes = R.drawable.ic_info_outline_white_24dp,</span>
<span class="nc" id="L88">                        iconSizeResId = R.dimen.jetpack_backup_restore_footnote_icon_size,</span>
<span class="nc" id="L89">                        textRes = R.string.backup_download_progress_footnote,</span>
<span class="nc" id="L90">                        isVisible = true</span>
                )
        )
    }

    fun buildCompleteListStateItems(
        published: Date,
        onDownloadFileClick: () -&gt; Unit,
        onShareLinkClick: () -&gt; Unit
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L100">        return listOf(</span>
<span class="nc" id="L101">                buildIconState(</span>
<span class="nc" id="L102">                        R.drawable.ic_cloud_done_white_24dp,</span>
<span class="nc" id="L103">                        R.string.backup_download_complete_icon_content_description,</span>
<span class="nc" id="L104">                        R.color.success</span>
                ),
<span class="nc" id="L106">                buildHeaderState(R.string.backup_download_complete_header),</span>
<span class="nc" id="L107">                buildDescriptionState(published, R.string.backup_download_complete_description_with_two_parameters),</span>
<span class="nc" id="L108">                buildActionButtonState(</span>
<span class="nc" id="L109">                        titleRes = R.string.backup_download_complete_download_action_button,</span>
<span class="nc" id="L110">                        contentDescRes = R.string.backup_download_complete_download_action_button_content_description,</span>
<span class="nc" id="L111">                        onClick = onDownloadFileClick</span>
                ),
<span class="nc" id="L113">                buildActionButtonState(</span>
<span class="nc" id="L114">                        titleRes = R.string.backup_download_complete_download_share_action_button,</span>
                        contentDescRes =
<span class="nc" id="L116">                        R.string.backup_download_complete_download_share_action_button_content_description,</span>
<span class="nc" id="L117">                        isSecondary = true,</span>
<span class="nc" id="L118">                        iconRes = R.drawable.ic_share_white_24dp,</span>
<span class="nc" id="L119">                        onClick = onShareLinkClick</span>
                ),
<span class="nc" id="L121">                buildFootnoteState(</span>
<span class="nc" id="L122">                        textRes = R.string.backup_download_complete_info,</span>
<span class="nc" id="L123">                        textAlphaResId = R.dimen.material_emphasis_medium</span>
                )
        )
    }

    fun buildErrorListStateErrorItems(errorType: BackupDownloadErrorTypes, onDoneClick: () -&gt; Unit) = (
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (errorType == RemoteRequestFailure) buildStatusErrorListStateItems(onDoneClick)</span>
<span class="nc" id="L130">            else buildGenericErrorListStateItems(onDoneClick)</span>
            )

<span class="nc" id="L133">    private fun buildStatusErrorListStateItems(onDoneClick: () -&gt; Unit) = listOf(</span>
<span class="nc" id="L134">            buildHeaderState(R.string.backup_download_status_failure_heading),</span>
<span class="nc" id="L135">            buildBulletState(</span>
<span class="nc" id="L136">                    R.drawable.ic_query_builder_white_24dp,</span>
<span class="nc" id="L137">                    R.string.backup_download_status_bullet_clock_icon_content_desc,</span>
<span class="nc" id="L138">                    R.color.warning,</span>
<span class="nc" id="L139">                    R.string.backup_download_status_failure_bullet1</span>
            ),
<span class="nc" id="L141">            buildBulletState(</span>
<span class="nc" id="L142">                    R.drawable.ic_gridicons_checkmark_circle,</span>
<span class="nc" id="L143">                    R.string.backup_download_status_bullet_checkmark_icon_content_desc,</span>
<span class="nc" id="L144">                    R.color.success,</span>
<span class="nc" id="L145">                    R.string.backup_download_status_failure_bullet2</span>
            ),
<span class="nc" id="L147">            buildBulletState(</span>
<span class="nc" id="L148">                    R.drawable.ic_gridicons_checkmark_circle,</span>
<span class="nc" id="L149">                    R.string.backup_download_status_bullet_checkmark_icon_content_desc,</span>
<span class="nc" id="L150">                    R.color.success,</span>
<span class="nc" id="L151">                    R.string.backup_download_status_failure_bullet3,</span>
<span class="nc" id="L152">                    R.dimen.jetpack_backup_restore_last_bullet_bottom_margin</span>
            ),
<span class="nc" id="L154">            buildActionButtonState(</span>
<span class="nc" id="L155">                    titleRes = R.string.restore_complete_failed_action_button,</span>
<span class="nc" id="L156">                    contentDescRes = R.string.restore_complete_failed_action_button_content_description,</span>
<span class="nc" id="L157">                    onClick = onDoneClick</span>
            )
<span class="nc" id="L159">    )</span>

<span class="nc" id="L161">    private fun buildGenericErrorListStateItems(onDoneClick: () -&gt; Unit) = listOf(</span>
<span class="nc" id="L162">            buildIconState(</span>
<span class="nc" id="L163">                    R.drawable.ic_cloud_off_white_24dp,</span>
<span class="nc" id="L164">                    R.string.backup_download_complete_failed_icon_content_description,</span>
<span class="nc" id="L165">                    R.color.error</span>
            ),
<span class="nc" id="L167">            buildHeaderState(R.string.backup_download_complete_failed_description),</span>
<span class="nc" id="L168">            buildDescriptionState(descRes = R.string.request_failed_message),</span>
<span class="nc" id="L169">            buildActionButtonState(</span>
<span class="nc" id="L170">                    titleRes = R.string.backup_download_complete_failed_action_button,</span>
<span class="nc" id="L171">                    contentDescRes = R.string.backup_download_complete_failed_action_button_content_description,</span>
<span class="nc" id="L172">                    onClick = onDoneClick</span>
            )
<span class="nc" id="L174">    )</span>

    private fun buildIconState(
        @DrawableRes iconRes: Int,
        @StringRes contentDescRes: Int,
        @ColorRes colorRes: Int
<span class="nc" id="L180">    ) = IconState(</span>
<span class="nc" id="L181">            icon = iconRes,</span>
<span class="nc" id="L182">            contentDescription = UiStringRes(contentDescRes),</span>
<span class="nc" id="L183">            colorResId = colorRes</span>
<span class="nc" id="L184">    )</span>

<span class="nc" id="L186">    private fun buildHeaderState(@StringRes titleRes: Int) = HeaderState(UiStringRes(titleRes))</span>

<span class="nc" id="L188">    private fun buildDescriptionState(published: Date? = null, @StringRes descRes: Int) = DescriptionState(</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (published != null) {</span>
<span class="nc" id="L190">                UiStringResWithParams(</span>
<span class="nc" id="L191">                        descRes,</span>
<span class="nc" id="L192">                        listOf(</span>
<span class="nc" id="L193">                                UiStringText(published.toFormattedDateString()),</span>
<span class="nc" id="L194">                                UiStringText(published.toFormattedTimeString())</span>
                        )
                )
            } else {
<span class="nc" id="L198">                UiStringRes(descRes)</span>
            }
<span class="nc" id="L200">    )</span>

    @Suppress(&quot;LongMethod&quot;, &quot;LongParameterList&quot;)
<span class="nc" id="L203">    private fun buildActionButtonState(</span>
        @StringRes titleRes: Int,
        @StringRes contentDescRes: Int,
<span class="nc" id="L206">        isSecondary: Boolean = false,</span>
<span class="nc" id="L207">        @DrawableRes iconRes: Int? = null,</span>
<span class="nc" id="L208">        isVisible: Boolean = true,</span>
        onClick: () -&gt; Unit
<span class="nc" id="L210">    ) = ActionButtonState(</span>
<span class="nc" id="L211">            text = UiStringRes(titleRes),</span>
<span class="nc" id="L212">            contentDescription = UiStringRes(contentDescRes),</span>
<span class="nc" id="L213">            isSecondary = isSecondary,</span>
<span class="nc" id="L214">            iconRes = iconRes,</span>
<span class="nc" id="L215">            onClick = onClick,</span>
<span class="nc" id="L216">            isVisible = isVisible</span>
<span class="nc" id="L217">    )</span>

<span class="nc" id="L219">    private fun buildSubHeaderState(</span>
        @StringRes textResId: Int,
<span class="nc" id="L221">        @DimenRes topMarginResId: Int? = null,</span>
<span class="nc" id="L222">        @DimenRes bottomMarginResId: Int? = null</span>
<span class="nc" id="L223">    ) = SubHeaderState(</span>
<span class="nc" id="L224">            text = UiStringRes(textResId),</span>
<span class="nc" id="L225">            itemTopMarginResId = topMarginResId,</span>
<span class="nc" id="L226">            itemBottomMarginResId = bottomMarginResId</span>
<span class="nc" id="L227">    )</span>

<span class="nc" id="L229">    private fun buildFootnoteState(</span>
<span class="nc" id="L230">        @DrawableRes iconRes: Int? = null,</span>
<span class="nc" id="L231">        @DimenRes textAlphaResId: Int? = null,</span>
<span class="nc" id="L232">        @DimenRes iconSizeResId: Int? = null,</span>
        @StringRes textRes: Int,
<span class="nc" id="L234">        isVisible: Boolean = true</span>
<span class="nc" id="L235">    ) = FootnoteState(</span>
<span class="nc" id="L236">            iconRes = iconRes,</span>
<span class="nc" id="L237">            textAlphaResId = textAlphaResId,</span>
<span class="nc" id="L238">            iconSizeResId = iconSizeResId,</span>
<span class="nc" id="L239">            text = UiStringRes(textRes),</span>
<span class="nc" id="L240">            isVisible = isVisible</span>
<span class="nc" id="L241">    )</span>

<span class="nc" id="L243">    private fun buildProgressState(progress: Int) = ProgressState(</span>
<span class="nc" id="L244">            progress = progress,</span>
<span class="nc" id="L245">            progressLabel = UiStringResWithParams(</span>
<span class="nc" id="L246">                    R.string.backup_download_progress_label,</span>
<span class="nc" id="L247">                    listOf(UiStringText(progress.toString()))</span>
            )
<span class="nc" id="L249">    )</span>

<span class="nc" id="L251">    private fun buildBulletState(</span>
        @DrawableRes iconRes: Int,
        @StringRes contentDescRes: Int,
        @ColorRes colorRes: Int,
        @StringRes labelRes: Int,
<span class="nc" id="L256">        @DimenRes itemBottomMarginResId: Int? = null</span>
<span class="nc" id="L257">    ) = BulletState(</span>
<span class="nc" id="L258">            icon = iconRes,</span>
<span class="nc" id="L259">            contentDescription = UiStringRes(contentDescRes),</span>
<span class="nc" id="L260">            colorResId = colorRes,</span>
<span class="nc" id="L261">            label = UiStringRes(labelRes),</span>
<span class="nc" id="L262">            itemBottomMarginResId = itemBottomMarginResId</span>
<span class="nc" id="L263">    )</span>

    fun updateCheckboxes(
        uiState: BackupDownloadUiState,
        itemType: JetpackAvailableItemType
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L269">        val updatedCheckboxes = uiState.items.map { state -&gt;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (state.type == CHECKBOX) {</span>
<span class="nc" id="L271">                state as CheckboxState</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                if (state.availableItemType == itemType) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                    state.copy(checked = !state.checked)</span>
                } else {
<span class="nc" id="L275">                    state</span>
                }
            } else {
<span class="nc" id="L278">                state</span>
            }
        }
<span class="nc bnc" id="L281" title="All 6 branches missed.">        val atLeastOneChecked = updatedCheckboxes.filterIsInstance&lt;CheckboxState&gt;().find { it.checked } != null</span>
<span class="nc" id="L282">        return updateDetailsActionButtonState(updatedCheckboxes, atLeastOneChecked)</span>
    }

    private fun updateDetailsActionButtonState(
        details: List&lt;JetpackListItemState&gt;,
        enableActionButton: Boolean
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L289">        return details.map { state -&gt;</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">            if (state is ActionButtonState) {</span>
<span class="nc" id="L291">                state.copy(isEnabled = enableActionButton)</span>
            } else {
<span class="nc" id="L293">                state</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>