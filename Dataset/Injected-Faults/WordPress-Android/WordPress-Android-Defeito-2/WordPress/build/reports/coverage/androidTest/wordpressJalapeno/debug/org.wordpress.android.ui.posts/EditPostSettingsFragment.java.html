<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EditPostSettingsFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">EditPostSettingsFragment.java</span></div><h1>EditPostSettingsFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.graphics.drawable.Drawable;
import android.os.Bundle;
import android.text.TextUtils;
import android.view.ContextMenu;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.CompoundButton.OnCheckedChangeListener;
import android.widget.ImageView;
import android.widget.ImageView.ScaleType;
import android.widget.LinearLayout;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.widget.SwitchCompat;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentActivity;
import androidx.fragment.app.FragmentManager;
import androidx.lifecycle.Observer;
import androidx.lifecycle.ViewModelProvider;

import org.apache.commons.text.StringEscapeUtils;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.action.TaxonomyAction;
import org.wordpress.android.fluxc.generated.SiteActionBuilder;
import org.wordpress.android.fluxc.generated.TaxonomyActionBuilder;
import org.wordpress.android.fluxc.model.MediaModel;
import org.wordpress.android.fluxc.model.PostFormatModel;
import org.wordpress.android.fluxc.model.PostImmutableModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.model.TermModel;
import org.wordpress.android.fluxc.model.post.PostStatus;
import org.wordpress.android.fluxc.store.MediaStore.OnMediaUploaded;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.store.SiteStore.OnPostFormatsChanged;
import org.wordpress.android.fluxc.store.TaxonomyStore;
import org.wordpress.android.fluxc.store.TaxonomyStore.OnTaxonomyChanged;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.photopicker.MediaPickerLauncher;
import org.wordpress.android.ui.posts.EditPostRepository.UpdatePostResult;
import org.wordpress.android.ui.posts.FeaturedImageHelper.FeaturedImageData;
import org.wordpress.android.ui.posts.FeaturedImageHelper.FeaturedImageState;
import org.wordpress.android.ui.posts.FeaturedImageHelper.TrackableEvent;
import org.wordpress.android.ui.posts.PostSettingsListDialogFragment.DialogType;
import org.wordpress.android.ui.posts.PublishSettingsViewModel.PublishUiModel;
import org.wordpress.android.ui.posts.prepublishing.visibility.usecases.UpdatePostStatusUseCase;
import org.wordpress.android.ui.prefs.SiteSettingsInterface;
import org.wordpress.android.ui.prefs.SiteSettingsInterface.SiteSettingsListener;
import org.wordpress.android.ui.utils.UiHelpers;
import org.wordpress.android.util.AccessibilityUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.DateTimeUtils;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageManager.RequestListener;
import org.wordpress.android.util.image.ImageType;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Iterator;
import java.util.List;
import java.util.Objects;

import javax.inject.Inject;

import static android.app.Activity.RESULT_OK;
import static org.wordpress.android.ui.posts.EditPostActivity.EXTRA_POST_LOCAL_ID;
import static org.wordpress.android.ui.posts.SelectCategoriesActivity.KEY_SELECTED_CATEGORY_IDS;

<span class="nc" id="L87">public class EditPostSettingsFragment extends Fragment {</span>
    private static final String POST_FORMAT_STANDARD_KEY = &quot;standard&quot;;

    private static final int ACTIVITY_REQUEST_CODE_SELECT_CATEGORIES = 5;
    private static final int ACTIVITY_REQUEST_CODE_SELECT_TAGS = 6;

    private static final int CHOOSE_FEATURED_IMAGE_MENU_ID = 100;
    private static final int REMOVE_FEATURED_IMAGE_MENU_ID = 101;
    private static final int REMOVE_FEATURED_IMAGE_UPLOAD_MENU_ID = 102;
    private static final int RETRY_FEATURED_IMAGE_UPLOAD_MENU_ID = 103;

    private SiteSettingsInterface mSiteSettings;

    private LinearLayout mCategoriesContainer;
    private LinearLayout mExcerptContainer;
    private LinearLayout mFormatContainer;
    private LinearLayout mTagsContainer;
    private LinearLayout mPublishDateContainer;
    private TextView mExcerptTextView;
    private TextView mSlugTextView;
    private TextView mCategoriesTextView;
    private TextView mTagsTextView;
    private TextView mStatusTextView;
    private TextView mPostFormatTextView;
    private TextView mPasswordTextView;
    private TextView mPublishDateTextView;
    private TextView mPublishDateTitleTextView;
    private TextView mCategoriesTagsHeaderTextView;
    private TextView mFeaturedImageHeaderTextView;
    private TextView mMoreOptionsHeaderTextView;
    private TextView mPublishHeaderTextView;
    private ImageView mFeaturedImageView;
    private ImageView mLocalFeaturedImageView;
    private Button mFeaturedImageButton;
    private SwitchCompat mStickySwitch;
    private ViewGroup mFeaturedImageRetryOverlay;
    private ViewGroup mFeaturedImageProgressOverlay;

    private ArrayList&lt;String&gt; mDefaultPostFormatKeys;
    private ArrayList&lt;String&gt; mDefaultPostFormatNames;
    private ArrayList&lt;String&gt; mPostFormatKeys;
    private ArrayList&lt;String&gt; mPostFormatNames;

    @Inject SiteStore mSiteStore;
    @Inject TaxonomyStore mTaxonomyStore;
    @Inject Dispatcher mDispatcher;
    @Inject ImageManager mImageManager;
    @Inject FeaturedImageHelper mFeaturedImageHelper;
    @Inject UiHelpers mUiHelpers;
    @Inject PostSettingsUtils mPostSettingsUtils;
    @Inject AnalyticsTrackerWrapper mAnalyticsTrackerWrapper;
    @Inject UpdatePostStatusUseCase mUpdatePostStatusUseCase;
    @Inject MediaPickerLauncher mMediaPickerLauncher;
    @Inject UpdateFeaturedImageUseCase mUpdateFeaturedImageUseCase;

    @Inject ViewModelProvider.Factory mViewModelFactory;
    private EditPostPublishSettingsViewModel mPublishedViewModel;

<span class="nc" id="L145">    private final OnCheckedChangeListener mOnStickySwitchChangeListener =</span>
<span class="nc" id="L146">            (buttonView, isChecked) -&gt; onStickySwitchChanged(isChecked);</span>


    public interface EditPostActivityHook {
        EditPostRepository getEditPostRepository();

        SiteModel getSite();
    }

    public static EditPostSettingsFragment newInstance() {
<span class="nc" id="L156">        return new EditPostSettingsFragment();</span>
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L161">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L162">        ((WordPress) getActivity().getApplicationContext()).component().inject(this);</span>
<span class="nc" id="L163">        mDispatcher.register(this);</span>

        // Early load the default lists for post format keys and names.
        // Will use it later without needing to have access to the Resources.
<span class="nc" id="L167">        mDefaultPostFormatKeys =</span>
<span class="nc" id="L168">                new ArrayList&lt;&gt;(Arrays.asList(getResources().getStringArray(R.array.post_format_keys)));</span>
<span class="nc" id="L169">        mDefaultPostFormatNames = new ArrayList&lt;&gt;(Arrays.asList(getResources()</span>
<span class="nc" id="L170">                .getStringArray(R.array.post_format_display_names)));</span>
<span class="nc" id="L171">        mPublishedViewModel = new ViewModelProvider(getActivity(), mViewModelFactory)</span>
<span class="nc" id="L172">                .get(EditPostPublishSettingsViewModel.class);</span>
<span class="nc" id="L173">    }</span>

    @Override
    public void onActivityCreated(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L177">        super.onActivityCreated(savedInstanceState);</span>

<span class="nc" id="L179">        updatePostFormatKeysAndNames();</span>
<span class="nc" id="L180">        fetchSiteSettingsAndUpdateDefaultPostFormatIfNecessary();</span>

        // Update post formats and categories, in case anything changed.
<span class="nc" id="L183">        SiteModel siteModel = getSite();</span>
<span class="nc" id="L184">        mDispatcher.dispatch(SiteActionBuilder.newFetchPostFormatsAction(siteModel));</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (!getEditPostRepository().isPage()) {</span>
<span class="nc" id="L186">            mDispatcher.dispatch(TaxonomyActionBuilder.newFetchCategoriesAction(siteModel));</span>
        }

<span class="nc" id="L189">        refreshViews();</span>
<span class="nc" id="L190">    }</span>

    private void fetchSiteSettingsAndUpdateDefaultPostFormatIfNecessary() {
        // A format is already set for the post, no need to fetch the default post format
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (!TextUtils.isEmpty(getEditPostRepository().getPostFormat())) {</span>
<span class="nc" id="L195">            return;</span>
        }
        // we need to fetch site settings in order to get the latest default post format
<span class="nc" id="L198">        mSiteSettings = SiteSettingsInterface.getInterface(</span>
<span class="nc" id="L199">                getActivity(), getSite(), new SiteSettingsListener() {</span>
                    @Override
                    public void onSaveError(Exception error) {
                        // no-op
<span class="nc" id="L203">                    }</span>

                    @Override
                    public void onFetchError(Exception error) {
                        // no-op
<span class="nc" id="L208">                    }</span>

                    @Override
                    public void onSettingsUpdated() {
                        // mEditPostActivityHook will be null if the fragment is detached
<span class="nc bnc" id="L213" title="All 2 branches missed.">                        if (getEditPostActivityHook() != null) {</span>
<span class="nc" id="L214">                            updatePostFormat(</span>
<span class="nc" id="L215">                                    mSiteSettings.getDefaultPostFormat());</span>
                        }
<span class="nc" id="L217">                    }</span>

                    @Override
                    public void onSettingsSaved() {
                        // no-op
<span class="nc" id="L222">                    }</span>

                    @Override
                    public void onCredentialsValidated(Exception error) {
                        // no-op
<span class="nc" id="L227">                    }</span>
                });
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (mSiteSettings != null) {</span>
            // init will fetch remote settings for us
<span class="nc" id="L231">            mSiteSettings.init(true);</span>
        }
<span class="nc" id="L233">    }</span>

    @Override
    public void onDestroy() {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (mSiteSettings != null) {</span>
<span class="nc" id="L238">            mSiteSettings.clear();</span>
        }
<span class="nc" id="L240">        mDispatcher.unregister(this);</span>
<span class="nc" id="L241">        super.onDestroy();</span>
<span class="nc" id="L242">    }</span>

    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container,
                             @Nullable Bundle savedInstanceState) {
<span class="nc" id="L247">        ViewGroup rootView = (ViewGroup) inflater.inflate(R.layout.edit_post_settings_fragment, container, false);</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (rootView == null) {</span>
<span class="nc" id="L250">            return null;</span>
        }

<span class="nc" id="L253">        mExcerptTextView = rootView.findViewById(R.id.post_excerpt);</span>
<span class="nc" id="L254">        mSlugTextView = rootView.findViewById(R.id.post_slug);</span>
<span class="nc" id="L255">        mCategoriesTextView = rootView.findViewById(R.id.post_categories);</span>
<span class="nc" id="L256">        mTagsTextView = rootView.findViewById(R.id.post_tags);</span>
<span class="nc" id="L257">        mStatusTextView = rootView.findViewById(R.id.post_status);</span>
<span class="nc" id="L258">        mPostFormatTextView = rootView.findViewById(R.id.post_format);</span>
<span class="nc" id="L259">        mPasswordTextView = rootView.findViewById(R.id.post_password);</span>
<span class="nc" id="L260">        mPublishDateTextView = rootView.findViewById(R.id.publish_date);</span>
<span class="nc" id="L261">        mPublishDateTitleTextView = rootView.findViewById(R.id.publish_date_title);</span>
<span class="nc" id="L262">        mCategoriesTagsHeaderTextView = rootView.findViewById(R.id.post_settings_categories_and_tags_header);</span>
<span class="nc" id="L263">        mMoreOptionsHeaderTextView = rootView.findViewById(R.id.post_settings_more_options_header);</span>
<span class="nc" id="L264">        mFeaturedImageHeaderTextView = rootView.findViewById(R.id.post_settings_featured_image_header);</span>
<span class="nc" id="L265">        mPublishHeaderTextView = rootView.findViewById(R.id.post_settings_publish);</span>
<span class="nc" id="L266">        mPublishDateContainer = rootView.findViewById(R.id.publish_date_container);</span>
<span class="nc" id="L267">        mStickySwitch = rootView.findViewById(R.id.post_settings_sticky_switch);</span>

<span class="nc" id="L269">        mFeaturedImageView = rootView.findViewById(R.id.post_featured_image);</span>
<span class="nc" id="L270">        mLocalFeaturedImageView = rootView.findViewById(R.id.post_featured_image_local);</span>
<span class="nc" id="L271">        mFeaturedImageButton = rootView.findViewById(R.id.post_add_featured_image_button);</span>
<span class="nc" id="L272">        mFeaturedImageRetryOverlay = rootView.findViewById(R.id.post_featured_image_retry_overlay);</span>
<span class="nc" id="L273">        mFeaturedImageProgressOverlay = rootView.findViewById(R.id.post_featured_image_progress_overlay);</span>

<span class="nc" id="L275">        OnClickListener showContextMenuListener = new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L278">                view.showContextMenu();</span>
<span class="nc" id="L279">            }</span>
        };

<span class="nc" id="L282">        mFeaturedImageView.setOnClickListener(showContextMenuListener);</span>
<span class="nc" id="L283">        mLocalFeaturedImageView.setOnClickListener(showContextMenuListener);</span>
<span class="nc" id="L284">        mFeaturedImageRetryOverlay.setOnClickListener(showContextMenuListener);</span>
<span class="nc" id="L285">        mFeaturedImageProgressOverlay.setOnClickListener(showContextMenuListener);</span>

<span class="nc" id="L287">        registerForContextMenu(mFeaturedImageView);</span>
<span class="nc" id="L288">        registerForContextMenu(mLocalFeaturedImageView);</span>
<span class="nc" id="L289">        registerForContextMenu(mFeaturedImageRetryOverlay);</span>
<span class="nc" id="L290">        registerForContextMenu(mFeaturedImageProgressOverlay);</span>

<span class="nc" id="L292">        mFeaturedImageButton.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L295">                launchFeaturedMediaPicker();</span>
<span class="nc" id="L296">            }</span>
        });

<span class="nc" id="L299">        mExcerptContainer = rootView.findViewById(R.id.post_excerpt_container);</span>
<span class="nc" id="L300">        mExcerptContainer.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L303">                showPostExcerptDialog();</span>
<span class="nc" id="L304">            }</span>
        });

<span class="nc" id="L307">        final LinearLayout slugContainer = rootView.findViewById(R.id.post_slug_container);</span>
<span class="nc" id="L308">        slugContainer.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L311">                showSlugDialog();</span>
<span class="nc" id="L312">            }</span>
        });

<span class="nc" id="L315">        mCategoriesContainer = rootView.findViewById(R.id.post_categories_container);</span>
<span class="nc" id="L316">        mCategoriesContainer.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L319">                showCategoriesActivity();</span>
<span class="nc" id="L320">            }</span>
        });

<span class="nc" id="L323">        mTagsContainer = rootView.findViewById(R.id.post_tags_container);</span>
<span class="nc" id="L324">        mTagsContainer.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L327">                showTagsActivity();</span>
<span class="nc" id="L328">            }</span>
        });

<span class="nc" id="L331">        final LinearLayout statusContainer = rootView.findViewById(R.id.post_status_container);</span>
<span class="nc" id="L332">        statusContainer.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L335">                showStatusDialog();</span>
<span class="nc" id="L336">            }</span>
        });

<span class="nc" id="L339">        mFormatContainer = rootView.findViewById(R.id.post_format_container);</span>
<span class="nc" id="L340">        mFormatContainer.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L343">                showPostFormatDialog();</span>
<span class="nc" id="L344">            }</span>
        });

<span class="nc" id="L347">        final LinearLayout passwordContainer = rootView.findViewById(R.id.post_password_container);</span>
<span class="nc" id="L348">        passwordContainer.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L351">                showPostPasswordDialog();</span>
<span class="nc" id="L352">            }</span>
        });

<span class="nc" id="L355">        mPublishDateContainer.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="nc" id="L358">                FragmentActivity activity = getActivity();</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                if (activity instanceof EditPostSettingsCallback) {</span>
<span class="nc" id="L360">                    ((EditPostSettingsCallback) activity).onEditPostPublishedSettingsClick();</span>
                }
<span class="nc" id="L362">            }</span>
        });

<span class="nc" id="L365">        mStickySwitch.setOnCheckedChangeListener(mOnStickySwitchChangeListener);</span>


<span class="nc bnc" id="L368" title="All 4 branches missed.">        if (getEditPostRepository() != null &amp;&amp; getEditPostRepository().isPage()) { // remove post specific views</span>
<span class="nc" id="L369">            final View categoriesTagsContainer = rootView.findViewById(R.id.post_categories_and_tags_card);</span>
<span class="nc" id="L370">            final View formatBottomSeparator = rootView.findViewById(R.id.post_format_bottom_separator);</span>
<span class="nc" id="L371">            final View markAsStickyContainer = rootView.findViewById(R.id.post_settings_mark_as_sticky_container);</span>
<span class="nc" id="L372">            categoriesTagsContainer.setVisibility(View.GONE);</span>
<span class="nc" id="L373">            formatBottomSeparator.setVisibility(View.GONE);</span>
<span class="nc" id="L374">            mFormatContainer.setVisibility(View.GONE);</span>
<span class="nc" id="L375">            markAsStickyContainer.setVisibility(View.GONE);</span>
        }

<span class="nc" id="L378">        mPublishedViewModel.getOnUiModel().observe(getViewLifecycleOwner(), new Observer&lt;PublishUiModel&gt;() {</span>
            @Override public void onChanged(PublishUiModel uiModel) {
<span class="nc" id="L380">                updatePublishDateTextView(uiModel.getPublishDateLabel(),</span>
<span class="nc" id="L381">                        Objects.requireNonNull(getEditPostRepository().getPost()));</span>
<span class="nc" id="L382">            }</span>
        });
<span class="nc" id="L384">        mPublishedViewModel.getOnPostStatusChanged().observe(getViewLifecycleOwner(), new Observer&lt;PostStatus&gt;() {</span>
            @Override public void onChanged(PostStatus postStatus) {
<span class="nc" id="L386">                updatePostStatus(postStatus);</span>
<span class="nc" id="L387">            }</span>
        });

<span class="nc" id="L390">        setupSettingHintsForAccessibility();</span>
<span class="nc" id="L391">        applyAccessibilityHeadingToSettings();</span>

<span class="nc" id="L393">        return rootView;</span>
    }

    @Override
    public void onCreateContextMenu(ContextMenu menu, View v, ContextMenu.ContextMenuInfo menuInfo) {
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (mFeaturedImageRetryOverlay.getVisibility() == View.VISIBLE) {</span>
<span class="nc" id="L399">            menu.add(0, RETRY_FEATURED_IMAGE_UPLOAD_MENU_ID, 0,</span>
<span class="nc" id="L400">                    getString(R.string.post_settings_retry_featured_image));</span>
<span class="nc" id="L401">            menu.add(0, REMOVE_FEATURED_IMAGE_UPLOAD_MENU_ID, 0,</span>
<span class="nc" id="L402">                    getString(R.string.post_settings_remove_featured_image));</span>
        } else {
<span class="nc" id="L404">            menu.add(0, CHOOSE_FEATURED_IMAGE_MENU_ID, 0, getString(R.string.post_settings_choose_featured_image));</span>
<span class="nc" id="L405">            menu.add(0, REMOVE_FEATURED_IMAGE_MENU_ID, 0, getString(R.string.post_settings_remove_featured_image));</span>
        }
<span class="nc" id="L407">    }</span>

    @Override
    public boolean onContextItemSelected(MenuItem item) {
<span class="nc" id="L411">        SiteModel site = getSite();</span>
<span class="nc" id="L412">        PostImmutableModel post = getEditPostRepository().getPost();</span>
<span class="nc bnc" id="L413" title="All 4 branches missed.">        if (site == null || post == null) {</span>
<span class="nc" id="L414">            AppLog.w(T.POSTS, &quot;Unexpected state: Post or Site is null.&quot;);</span>
<span class="nc" id="L415">            return false;</span>
        }
<span class="nc bnc" id="L417" title="All 4 branches missed.">        switch (item.getItemId()) {</span>
            case CHOOSE_FEATURED_IMAGE_MENU_ID:
<span class="nc" id="L419">                mFeaturedImageHelper.cancelFeaturedImageUpload(site, post, false);</span>
<span class="nc" id="L420">                launchFeaturedMediaPicker();</span>
<span class="nc" id="L421">                return true;</span>
            case REMOVE_FEATURED_IMAGE_UPLOAD_MENU_ID:
            case REMOVE_FEATURED_IMAGE_MENU_ID:
<span class="nc" id="L424">                mFeaturedImageHelper.cancelFeaturedImageUpload(site, post, false);</span>
<span class="nc" id="L425">                clearFeaturedImage();</span>

<span class="nc" id="L427">                mFeaturedImageHelper.trackFeaturedImageEvent(TrackableEvent.IMAGE_REMOVE_CLICKED, post.getId());</span>

<span class="nc" id="L429">                return true;</span>
            case RETRY_FEATURED_IMAGE_UPLOAD_MENU_ID:
<span class="nc" id="L431">                retryFeaturedImageUpload(site, post);</span>
<span class="nc" id="L432">                return true;</span>
            default:
<span class="nc" id="L434">                return false;</span>
        }
    }

    private void setupSettingHintsForAccessibility() {
<span class="nc" id="L439">        AccessibilityUtils.disableHintAnnouncement(mPublishDateTextView);</span>
<span class="nc" id="L440">        AccessibilityUtils.disableHintAnnouncement(mCategoriesTextView);</span>
<span class="nc" id="L441">        AccessibilityUtils.disableHintAnnouncement(mTagsTextView);</span>
<span class="nc" id="L442">        AccessibilityUtils.disableHintAnnouncement(mPasswordTextView);</span>
<span class="nc" id="L443">        AccessibilityUtils.disableHintAnnouncement(mSlugTextView);</span>
<span class="nc" id="L444">        AccessibilityUtils.disableHintAnnouncement(mExcerptTextView);</span>
<span class="nc" id="L445">    }</span>

    private void applyAccessibilityHeadingToSettings() {
<span class="nc" id="L448">        AccessibilityUtils.enableAccessibilityHeading(mCategoriesTagsHeaderTextView);</span>
<span class="nc" id="L449">        AccessibilityUtils.enableAccessibilityHeading(mFeaturedImageHeaderTextView);</span>
<span class="nc" id="L450">        AccessibilityUtils.enableAccessibilityHeading(mMoreOptionsHeaderTextView);</span>
<span class="nc" id="L451">        AccessibilityUtils.enableAccessibilityHeading(mPublishHeaderTextView);</span>
<span class="nc" id="L452">    }</span>

    private void retryFeaturedImageUpload(@NonNull SiteModel site, @NonNull PostImmutableModel post) {
<span class="nc" id="L455">        MediaModel mediaModel = mFeaturedImageHelper.retryFeaturedImageUpload(site, post);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (mediaModel == null) {</span>
<span class="nc" id="L457">            clearFeaturedImage();</span>
        }
<span class="nc" id="L459">    }</span>

    public void refreshViews() {
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L463">            return;</span>
        }

<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (getEditPostRepository().isPage()) {</span>
            // remove post specific views
<span class="nc" id="L468">            mCategoriesContainer.setVisibility(View.GONE);</span>
<span class="nc" id="L469">            mExcerptContainer.setVisibility(View.GONE);</span>
<span class="nc" id="L470">            mFormatContainer.setVisibility(View.GONE);</span>
<span class="nc" id="L471">            mTagsContainer.setVisibility(View.GONE);</span>
        }
<span class="nc" id="L473">        mExcerptTextView.setText(getEditPostRepository().getExcerpt());</span>
<span class="nc" id="L474">        mSlugTextView.setText(getEditPostRepository().getSlug());</span>
<span class="nc" id="L475">        mPasswordTextView.setText(getEditPostRepository().getPassword());</span>
<span class="nc" id="L476">        PostImmutableModel postModel = getEditPostRepository().getPost();</span>
<span class="nc" id="L477">        updatePostFormatTextView(postModel);</span>
<span class="nc" id="L478">        updateTagsTextView(postModel);</span>
<span class="nc" id="L479">        updateStatusTextView();</span>
<span class="nc" id="L480">        updatePublishDateTextView(postModel);</span>
<span class="nc" id="L481">        mPublishedViewModel.start(getEditPostRepository());</span>
<span class="nc" id="L482">        updateCategoriesTextView(postModel);</span>
<span class="nc" id="L483">        updateFeaturedImageView(postModel);</span>
<span class="nc" id="L484">        updateStickySwitch(postModel);</span>
<span class="nc" id="L485">    }</span>

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L489">        super.onActivityResult(requestCode, resultCode, data);</span>

<span class="nc bnc" id="L491" title="All 6 branches missed.">        if (data != null || ((requestCode == RequestCodes.TAKE_PHOTO</span>
                              || requestCode == RequestCodes.TAKE_VIDEO))) {
            Bundle extras;

<span class="nc bnc" id="L495" title="All 3 branches missed.">            switch (requestCode) {</span>
                case ACTIVITY_REQUEST_CODE_SELECT_CATEGORIES:
<span class="nc" id="L497">                    extras = data.getExtras();</span>
<span class="nc bnc" id="L498" title="All 4 branches missed.">                    if (extras != null &amp;&amp; extras.containsKey(KEY_SELECTED_CATEGORY_IDS)) {</span>
                        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L500">                        List&lt;Long&gt; categoryList = (ArrayList&lt;Long&gt;) extras.getSerializable(KEY_SELECTED_CATEGORY_IDS);</span>
<span class="nc" id="L501">                        PostAnalyticsUtilsKt.trackPostSettings(</span>
                                mAnalyticsTrackerWrapper, Stat.EDITOR_POST_CATEGORIES_ADDED);
<span class="nc" id="L503">                        updateCategories(categoryList);</span>
<span class="nc" id="L504">                    }</span>
                    break;
                case ACTIVITY_REQUEST_CODE_SELECT_TAGS:
<span class="nc" id="L507">                    extras = data.getExtras();</span>
<span class="nc bnc" id="L508" title="All 4 branches missed.">                    if (resultCode == RESULT_OK &amp;&amp; extras != null) {</span>
<span class="nc" id="L509">                        String selectedTags = extras.getString(PostSettingsTagsActivity.KEY_SELECTED_TAGS);</span>
<span class="nc" id="L510">                        PostAnalyticsUtilsKt.trackPostSettings(mAnalyticsTrackerWrapper, Stat.EDITOR_POST_TAGS_CHANGED);</span>
<span class="nc" id="L511">                        updateTags(selectedTags);</span>
                    }
                    break;
            }
        }
<span class="nc" id="L516">    }</span>

    private void showPostExcerptDialog() {
<span class="nc bnc" id="L519" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L520">            return;</span>
        }
<span class="nc" id="L522">        PostSettingsInputDialogFragment dialog = PostSettingsInputDialogFragment.newInstance(</span>
<span class="nc" id="L523">                getEditPostRepository().getExcerpt(), getString(R.string.post_settings_excerpt),</span>
<span class="nc" id="L524">                getString(R.string.post_settings_excerpt_dialog_hint), false);</span>
<span class="nc" id="L525">        dialog.setPostSettingsInputDialogListener(</span>
<span class="nc" id="L526">                new PostSettingsInputDialogFragment.PostSettingsInputDialogListener() {</span>
                    @Override
                    public void onInputUpdated(String input) {
<span class="nc" id="L529">                        mAnalyticsTrackerWrapper.track(Stat.EDITOR_POST_EXCERPT_CHANGED);</span>
<span class="nc" id="L530">                        updateExcerpt(input);</span>
<span class="nc" id="L531">                    }</span>
                });
<span class="nc" id="L533">        dialog.show(getChildFragmentManager(), null);</span>
<span class="nc" id="L534">    }</span>

    private void showSlugDialog() {
<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L538">            return;</span>
        }
<span class="nc" id="L540">        PostSettingsInputDialogFragment dialog = PostSettingsInputDialogFragment.newInstance(</span>
<span class="nc" id="L541">                getEditPostRepository().getSlug(), getString(R.string.post_settings_slug),</span>
<span class="nc" id="L542">                getString(R.string.post_settings_slug_dialog_hint), true);</span>
<span class="nc" id="L543">        dialog.setPostSettingsInputDialogListener(</span>
<span class="nc" id="L544">                new PostSettingsInputDialogFragment.PostSettingsInputDialogListener() {</span>
                    @Override
                    public void onInputUpdated(String input) {
<span class="nc" id="L547">                        mAnalyticsTrackerWrapper.track(Stat.EDITOR_POST_SLUG_CHANGED);</span>
<span class="nc" id="L548">                        updateSlug(input);</span>
<span class="nc" id="L549">                    }</span>
                });
<span class="nc" id="L551">        dialog.show(getFragmentManager(), null);</span>
<span class="nc" id="L552">    }</span>

    private void showCategoriesActivity() {
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L556">            return;</span>
        }
<span class="nc" id="L558">        Intent categoriesIntent = new Intent(getActivity(), SelectCategoriesActivity.class);</span>
<span class="nc" id="L559">        categoriesIntent.putExtra(WordPress.SITE, getSite());</span>
<span class="nc" id="L560">        categoriesIntent.putExtra(EXTRA_POST_LOCAL_ID, getEditPostRepository().getId());</span>
<span class="nc" id="L561">        startActivityForResult(categoriesIntent, ACTIVITY_REQUEST_CODE_SELECT_CATEGORIES);</span>
<span class="nc" id="L562">    }</span>

    private void showTagsActivity() {
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L566">            return;</span>
        }
        // Fetch/refresh the tags in preparation for the PostSettingsTagsActivity
<span class="nc" id="L569">        SiteModel siteModel = getSite();</span>
<span class="nc" id="L570">        mDispatcher.dispatch(TaxonomyActionBuilder.newFetchTagsAction(siteModel));</span>

<span class="nc" id="L572">        Intent tagsIntent = new Intent(getActivity(), PostSettingsTagsActivity.class);</span>
<span class="nc" id="L573">        tagsIntent.putExtra(WordPress.SITE, siteModel);</span>
<span class="nc" id="L574">        String tags = TextUtils.join(&quot;,&quot;, getEditPostRepository().getTagNameList());</span>
<span class="nc" id="L575">        tagsIntent.putExtra(PostSettingsTagsActivity.KEY_TAGS, tags);</span>
<span class="nc" id="L576">        startActivityForResult(tagsIntent, ACTIVITY_REQUEST_CODE_SELECT_TAGS);</span>
<span class="nc" id="L577">    }</span>

    private void onStickySwitchChanged(boolean checked) {
<span class="nc" id="L580">        EditPostRepository editPostRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (editPostRepository != null) {</span>
<span class="nc" id="L582">            editPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L583">                postModel.setSticky(checked);</span>
<span class="nc" id="L584">                return true;</span>
            }, null);
        }
<span class="nc" id="L587">    }</span>

    /*
     * called by the activity when the user taps OK on a PostSettingsDialogFragment
     */
    public void onPostSettingsFragmentPositiveButtonClicked(@NonNull PostSettingsListDialogFragment fragment) {
        int index;
<span class="nc" id="L594">        PostStatus status = null;</span>
<span class="nc bnc" id="L595" title="All 4 branches missed.">        switch (fragment.getDialogType()) {</span>
            case HOMEPAGE_STATUS:
<span class="nc" id="L597">                index = fragment.getCheckedIndex();</span>
<span class="nc" id="L598">                status = getHomepageStatusAtIndex(index);</span>
<span class="nc" id="L599">                break;</span>
            case POST_STATUS:
<span class="nc" id="L601">                index = fragment.getCheckedIndex();</span>
<span class="nc" id="L602">                status = getPostStatusAtIndex(index);</span>
<span class="nc" id="L603">                break;</span>
            case POST_FORMAT:
<span class="nc" id="L605">                String formatName = fragment.getSelectedItem();</span>
<span class="nc" id="L606">                updatePostFormat(getPostFormatKeyFromName(formatName));</span>
<span class="nc" id="L607">                mAnalyticsTrackerWrapper.track(Stat.EDITOR_POST_FORMAT_CHANGED);</span>
                break;
        }

<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (status != null) {</span>
<span class="nc" id="L612">            updatePostStatus(status);</span>
<span class="nc" id="L613">            PostAnalyticsUtilsKt.trackPostSettings(mAnalyticsTrackerWrapper, Stat.EDITOR_POST_VISIBILITY_CHANGED);</span>
        }
<span class="nc" id="L615">    }</span>

    private void showStatusDialog() {
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L619">            return;</span>
        }

<span class="nc" id="L622">        boolean isSiteHomepage = isSiteHomepage();</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">        int index = isSiteHomepage ? getCurrentHomepageStatusIndex() : getCurrentPostStatusIndex();</span>
<span class="nc" id="L624">        FragmentManager fm = getActivity().getSupportFragmentManager();</span>

<span class="nc bnc" id="L626" title="All 2 branches missed.">        DialogType statusType = isSiteHomepage ? DialogType.HOMEPAGE_STATUS : DialogType.POST_STATUS;</span>
<span class="nc" id="L627">        PostSettingsListDialogFragment fragment =</span>
<span class="nc" id="L628">                PostSettingsListDialogFragment.newInstance(statusType, index);</span>
<span class="nc" id="L629">        fragment.show(fm, PostSettingsListDialogFragment.TAG);</span>
<span class="nc" id="L630">    }</span>

    private boolean isSiteHomepage() {
<span class="nc" id="L633">        EditPostRepository postRepository = getEditPostRepository();</span>
<span class="nc" id="L634">        boolean isPage = postRepository.isPage();</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">        boolean isPublishedPage = postRepository.getStatus() == PostStatus.PUBLISHED</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                                  || postRepository.getStatus() == PostStatus.PRIVATE;</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">        boolean isHomepage = postRepository.getRemotePostId() == getSite().getPageOnFront();</span>
<span class="nc bnc" id="L638" title="All 6 branches missed.">        return isPage &amp;&amp; isPublishedPage &amp;&amp; isHomepage;</span>
    }

    private void showPostFormatDialog() {
<span class="nc bnc" id="L642" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L643">            return;</span>
        }

<span class="nc" id="L646">        int checkedIndex = 0;</span>
<span class="nc" id="L647">        String postFormat = getEditPostRepository().getPostFormat();</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (!TextUtils.isEmpty(postFormat)) {</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            for (int i = 0; i &lt; mPostFormatKeys.size(); i++) {</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                if (postFormat.equals(mPostFormatKeys.get(i))) {</span>
<span class="nc" id="L651">                    checkedIndex = i;</span>
<span class="nc" id="L652">                    break;</span>
                }
            }
        }

<span class="nc" id="L657">        FragmentManager fm = getActivity().getSupportFragmentManager();</span>
<span class="nc" id="L658">        PostSettingsListDialogFragment fragment =</span>
<span class="nc" id="L659">                PostSettingsListDialogFragment.newInstance(DialogType.POST_FORMAT, checkedIndex);</span>
<span class="nc" id="L660">        fragment.show(fm, PostSettingsListDialogFragment.TAG);</span>
<span class="nc" id="L661">    }</span>

    private void showPostPasswordDialog() {
<span class="nc bnc" id="L664" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L665">            return;</span>
        }
<span class="nc" id="L667">        PostSettingsInputDialogFragment dialog = PostSettingsInputDialogFragment.newInstance(</span>
<span class="nc" id="L668">                getEditPostRepository().getPassword(), getString(R.string.password),</span>
<span class="nc" id="L669">                getString(R.string.post_settings_password_dialog_hint), false);</span>
<span class="nc" id="L670">        dialog.setPostSettingsInputDialogListener(</span>
<span class="nc" id="L671">                new PostSettingsInputDialogFragment.PostSettingsInputDialogListener() {</span>
                    @Override
                    public void onInputUpdated(String input) {
<span class="nc" id="L674">                        PostAnalyticsUtilsKt</span>
<span class="nc" id="L675">                                .trackPostSettings(mAnalyticsTrackerWrapper, Stat.EDITOR_POST_PASSWORD_CHANGED);</span>
<span class="nc" id="L676">                        updatePassword(input);</span>
<span class="nc" id="L677">                    }</span>
                });
<span class="nc" id="L679">        dialog.show(getFragmentManager(), null);</span>
<span class="nc" id="L680">    }</span>

    // Helpers

    private EditPostRepository getEditPostRepository() {
<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (getEditPostActivityHook() == null) {</span>
            // This can only happen during a callback while activity is re-created for some reason (config changes etc)
<span class="nc" id="L687">            return null;</span>
        }
<span class="nc" id="L689">        return getEditPostActivityHook().getEditPostRepository();</span>
    }

    private SiteModel getSite() {
<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (getEditPostActivityHook() == null) {</span>
            // This can only happen during a callback while activity is re-created for some reason (config changes etc)
<span class="nc" id="L695">            return null;</span>
        }
<span class="nc" id="L697">        return getEditPostActivityHook().getSite();</span>
    }

    private EditPostActivityHook getEditPostActivityHook() {
<span class="nc" id="L701">        Activity activity = getActivity();</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">        if (activity == null) {</span>
<span class="nc" id="L703">            return null;</span>
        }

<span class="nc bnc" id="L706" title="All 2 branches missed.">        if (activity instanceof EditPostActivityHook) {</span>
<span class="nc" id="L707">            return (EditPostActivityHook) activity;</span>
        } else {
<span class="nc" id="L709">            throw new RuntimeException(activity.toString() + &quot; must implement EditPostActivityHook&quot;);</span>
        }
    }

    private void updateSaveButton() {
<span class="nc bnc" id="L714" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L715">            getActivity().invalidateOptionsMenu();</span>
        }
<span class="nc" id="L717">    }</span>

    private void updateExcerpt(String excerpt) {
<span class="nc" id="L720">        EditPostRepository editPostRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (editPostRepository != null) {</span>
<span class="nc" id="L722">            editPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L723">                postModel.setExcerpt(excerpt);</span>
<span class="nc" id="L724">                return true;</span>
            }, (postModel, result) -&gt; {
<span class="nc bnc" id="L726" title="All 2 branches missed.">                if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L727">                    mExcerptTextView.setText(excerpt);</span>
                }
<span class="nc" id="L729">                return null;</span>
            });
        }
<span class="nc" id="L732">    }</span>

    private void updateSlug(String slug) {
<span class="nc" id="L735">        EditPostRepository editPostRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">        if (editPostRepository != null) {</span>
<span class="nc" id="L737">            editPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L738">                postModel.setSlug(slug);</span>
<span class="nc" id="L739">                return true;</span>
            }, (postModel, result) -&gt; {
<span class="nc bnc" id="L741" title="All 2 branches missed.">                if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L742">                    mSlugTextView.setText(slug);</span>
                }
<span class="nc" id="L744">                return null;</span>
            });
        }
<span class="nc" id="L747">    }</span>

    private void updatePassword(String password) {
<span class="nc" id="L750">        EditPostRepository editPostRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">        if (editPostRepository == null) return;</span>

<span class="nc" id="L753">        String trimmedPassword = password.trim();</span>
<span class="nc" id="L754">        Boolean isNewPasswordBlank = trimmedPassword.isEmpty();</span>
<span class="nc" id="L755">        String previousPassword = editPostRepository.getPassword();</span>
<span class="nc" id="L756">        Boolean isPreviousPasswordBlank = previousPassword.trim().isEmpty();</span>

        // Nothing to save
<span class="nc bnc" id="L759" title="All 4 branches missed.">        if (isNewPasswordBlank &amp;&amp; isPreviousPasswordBlank) return;</span>

        // Save untrimmed password if not blank, else save empty string
<span class="nc bnc" id="L762" title="All 2 branches missed.">        String newPassword = isNewPasswordBlank ? trimmedPassword : password;</span>

<span class="nc" id="L764">        editPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L765">            postModel.setPassword(newPassword);</span>
<span class="nc" id="L766">            return true;</span>
        }, (postModel, result) -&gt; {
<span class="nc bnc" id="L768" title="All 2 branches missed.">            if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L769">                mPasswordTextView.setText(newPassword);</span>
            }
<span class="nc" id="L771">            return null;</span>
        });
<span class="nc" id="L773">    }</span>

    private void updateCategories(List&lt;Long&gt; categoryList) {
<span class="nc bnc" id="L776" title="All 2 branches missed.">        if (categoryList == null) {</span>
<span class="nc" id="L777">            return;</span>
        }
<span class="nc" id="L779">        EditPostRepository editPostRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">        if (editPostRepository != null) {</span>
<span class="nc" id="L781">            editPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L782">                postModel.setCategoryIdList(categoryList);</span>
<span class="nc" id="L783">                return true;</span>
            }, (postModel, result) -&gt; {
<span class="nc bnc" id="L785" title="All 2 branches missed.">                if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L786">                    updateCategoriesTextView(postModel);</span>
                }
<span class="nc" id="L788">                return null;</span>
            });
        }
<span class="nc" id="L791">    }</span>

    void updatePostStatus(PostStatus postStatus) {
<span class="nc" id="L794">        EditPostRepository editPostRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (editPostRepository != null) {</span>
<span class="nc" id="L796">            mUpdatePostStatusUseCase.updatePostStatus(postStatus, editPostRepository,</span>
                    postImmutableModel -&gt; {
<span class="nc" id="L798">                        updatePostStatusRelatedViews(postImmutableModel);</span>
<span class="nc" id="L799">                        updateSaveButton();</span>
<span class="nc" id="L800">                        return null;</span>
                    });
        }
<span class="nc" id="L803">    }</span>

    private void updatePostFormat(String postFormat) {
<span class="nc" id="L806">        EditPostRepository editPostRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">        if (editPostRepository != null) {</span>
<span class="nc" id="L808">            editPostRepository.updateAsync(postModel -&gt; {</span>
<span class="nc" id="L809">                postModel.setPostFormat(postFormat);</span>
<span class="nc" id="L810">                return true;</span>
            }, (postModel, result) -&gt; {
<span class="nc bnc" id="L812" title="All 2 branches missed.">                if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L813">                    updatePostFormatTextView(postModel);</span>
                }
<span class="nc" id="L815">                return null;</span>
            });
        }
<span class="nc" id="L818">    }</span>

    public void updatePostStatusRelatedViews(PostImmutableModel postModel) {
<span class="nc" id="L821">        updateStatusTextView();</span>
<span class="nc" id="L822">        updatePublishDateTextView(postModel);</span>
<span class="nc" id="L823">        mPublishedViewModel.onPostStatusChanged(postModel);</span>
<span class="nc" id="L824">    }</span>

    private void updateStatusTextView() {
<span class="nc bnc" id="L827" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L828">            return;</span>
        }
<span class="nc" id="L830">        String[] statuses = getResources().getStringArray(R.array.post_settings_statuses);</span>
<span class="nc" id="L831">        int index = getCurrentPostStatusIndex();</span>
        // We should never get an OutOfBoundsException here, but if we do,
        // we should let it crash so we can fix the underlying issue
<span class="nc" id="L834">        mStatusTextView.setText(statuses[index]);</span>
<span class="nc" id="L835">    }</span>

    private void updateTags(String selectedTags) {
<span class="nc" id="L838">        EditPostRepository postRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">        if (postRepository == null) {</span>
<span class="nc" id="L840">            return;</span>
        }
<span class="nc" id="L842">        postRepository.updateAsync(postModel -&gt; {</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">            if (!TextUtils.isEmpty(selectedTags)) {</span>
<span class="nc" id="L844">                String tags = selectedTags.replace(&quot;\n&quot;, &quot; &quot;);</span>
<span class="nc" id="L845">                postModel.setTagNameList(Arrays.asList(TextUtils.split(tags, &quot;,&quot;)));</span>
<span class="nc" id="L846">            } else {</span>
<span class="nc" id="L847">                postModel.setTagNameList(new ArrayList&lt;&gt;());</span>
            }
<span class="nc" id="L849">            return true;</span>
        }, (postModel, result) -&gt; {
<span class="nc bnc" id="L851" title="All 2 branches missed.">            if (result == UpdatePostResult.Updated.INSTANCE) {</span>
<span class="nc" id="L852">                updateTagsTextView(postModel);</span>
            }
<span class="nc" id="L854">            return null;</span>
        });
<span class="nc" id="L856">    }</span>

    private void updateTagsTextView(PostImmutableModel postModel) {
<span class="nc" id="L859">        String tags = TextUtils.join(&quot;,&quot;, postModel.getTagNameList());</span>
        // If `tags` is empty, the hint &quot;Not Set&quot; will be shown instead
<span class="nc" id="L861">        tags = StringEscapeUtils.unescapeHtml4(tags);</span>
<span class="nc" id="L862">        mTagsTextView.setText(tags);</span>
<span class="nc" id="L863">    }</span>

    private void updateStickySwitch(PostImmutableModel postModel) {
<span class="nc bnc" id="L866" title="All 6 branches missed.">        if (!isAdded() || postModel == null || mStickySwitch == null) {</span>
<span class="nc" id="L867">            return;</span>
        }

        // We need to remove the listener first, otherwise the listener will be triggered
<span class="nc" id="L871">        mStickySwitch.setOnCheckedChangeListener(null);</span>
<span class="nc" id="L872">        mStickySwitch.setChecked(postModel.getSticky());</span>
<span class="nc" id="L873">        mStickySwitch.setOnCheckedChangeListener(mOnStickySwitchChangeListener);</span>
<span class="nc" id="L874">    }</span>

    private void updatePostFormatTextView(PostImmutableModel postModel) {
        // Post format can be updated due to a site settings fetch and the textView might not have been initialized yet
<span class="nc bnc" id="L878" title="All 2 branches missed.">        if (mPostFormatTextView == null) {</span>
<span class="nc" id="L879">            return;</span>
        }
<span class="nc" id="L881">        String postFormat = getPostFormatNameFromKey(postModel.getPostFormat());</span>
<span class="nc" id="L882">        mPostFormatTextView.setText(postFormat);</span>
<span class="nc" id="L883">    }</span>

    private void updatePublishDateTextView(PostImmutableModel postModel) {
<span class="nc bnc" id="L886" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L887">            return;</span>
        }
<span class="nc bnc" id="L889" title="All 2 branches missed.">        if (postModel != null) {</span>
<span class="nc" id="L890">            String labelToUse = mPostSettingsUtils.getPublishDateLabel(postModel);</span>
<span class="nc" id="L891">            updatePublishDateTextView(labelToUse, postModel);</span>
        }
<span class="nc" id="L893">    }</span>

    private void updatePublishDateTextView(String label, PostImmutableModel postImmutableModel) {
<span class="nc" id="L896">        mPublishDateTextView.setText(label);</span>

<span class="nc" id="L898">        boolean isPrivatePost = postImmutableModel.getStatus().equals(PostStatus.PRIVATE.toString());</span>

<span class="nc bnc" id="L900" title="All 2 branches missed.">        mPublishDateTextView.setEnabled(!isPrivatePost);</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">        mPublishDateTitleTextView.setEnabled(!isPrivatePost);</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">        mPublishDateContainer.setEnabled(!isPrivatePost);</span>
<span class="nc" id="L903">    }</span>

    private void updateCategoriesTextView(PostImmutableModel post) {
<span class="nc bnc" id="L906" title="All 4 branches missed.">        if (post == null || getSite() == null) {</span>
            // Since this method can get called after a callback, we have to make sure we have the post and site
<span class="nc" id="L908">            return;</span>
        }
<span class="nc" id="L910">        List&lt;TermModel&gt; categories = mTaxonomyStore.getCategoriesForPost(post, getSite());</span>
<span class="nc" id="L911">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L912">        Iterator&lt;TermModel&gt; it = categories.iterator();</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (it.hasNext()) {</span>
<span class="nc" id="L914">            sb.append(it.next().getName());</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">            while (it.hasNext()) {</span>
<span class="nc" id="L916">                sb.append(&quot;, &quot;);</span>
<span class="nc" id="L917">                sb.append(it.next().getName());</span>
            }
        }
        // If `sb` is empty, the hint &quot;Not Set&quot; will be shown instead
<span class="nc" id="L921">        mCategoriesTextView.setText(StringEscapeUtils.unescapeHtml4(sb.toString()));</span>
<span class="nc" id="L922">    }</span>

    // Post Status Helpers

    private PostStatus getPostStatusAtIndex(int index) {
<span class="nc bnc" id="L927" title="All 5 branches missed.">        switch (index) {</span>
            case 0:
<span class="nc" id="L929">                return PostStatus.PUBLISHED;</span>
            case 1:
<span class="nc" id="L931">                return PostStatus.DRAFT;</span>
            case 2:
<span class="nc" id="L933">                return PostStatus.PENDING;</span>
            case 3:
<span class="nc" id="L935">                return PostStatus.PRIVATE;</span>
            default:
<span class="nc" id="L937">                return PostStatus.UNKNOWN;</span>
        }
    }

    private int getCurrentPostStatusIndex() {
<span class="nc bnc" id="L942" title="All 5 branches missed.">        switch (getEditPostRepository().getStatus()) {</span>
            case DRAFT:
<span class="nc" id="L944">                return 1;</span>
            case PENDING:
<span class="nc" id="L946">                return 2;</span>
            case PRIVATE:
<span class="nc" id="L948">                return 3;</span>
            case TRASHED:
            case UNKNOWN:
            case PUBLISHED:
            case SCHEDULED:
<span class="nc" id="L953">                return 0;</span>
        }
<span class="nc" id="L955">        return 0;</span>
    }

    private PostStatus getHomepageStatusAtIndex(int index) {
<span class="nc bnc" id="L959" title="All 3 branches missed.">        switch (index) {</span>
            case 0:
<span class="nc" id="L961">                return PostStatus.PUBLISHED;</span>
            case 1:
<span class="nc" id="L963">                return PostStatus.PRIVATE;</span>
            default:
<span class="nc" id="L965">                return PostStatus.UNKNOWN;</span>
        }
    }

    private int getCurrentHomepageStatusIndex() {
<span class="nc bnc" id="L970" title="All 3 branches missed.">        switch (getEditPostRepository().getStatus()) {</span>
            case PRIVATE:
<span class="nc" id="L972">                return 1;</span>
            case DRAFT:
            case PENDING:
            case TRASHED:
            case UNKNOWN:
            case PUBLISHED:
            case SCHEDULED:
<span class="nc" id="L979">                return 0;</span>
        }
<span class="nc" id="L981">        return 0;</span>
    }

    // Post Format Helpers

    private void updatePostFormatKeysAndNames() {
<span class="nc" id="L987">        final SiteModel site = getSite();</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">        if (site == null) {</span>
            // Since this method can get called after a callback, we have to make sure we have the site
<span class="nc" id="L990">            return;</span>
        }

        // Initialize the lists from the defaults
<span class="nc" id="L994">        mPostFormatKeys = new ArrayList&lt;&gt;(mDefaultPostFormatKeys);</span>
<span class="nc" id="L995">        mPostFormatNames = new ArrayList&lt;&gt;(mDefaultPostFormatNames);</span>

        // If we have specific values for this site, use them
<span class="nc" id="L998">        List&lt;PostFormatModel&gt; postFormatModels = mSiteStore.getPostFormats(site);</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">        for (PostFormatModel postFormatModel : postFormatModels) {</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">            if (!mPostFormatKeys.contains(postFormatModel.getSlug())) {</span>
<span class="nc" id="L1001">                mPostFormatKeys.add(postFormatModel.getSlug());</span>
<span class="nc" id="L1002">                mPostFormatNames.add(postFormatModel.getDisplayName());</span>
            }
<span class="nc" id="L1004">        }</span>
<span class="nc" id="L1005">    }</span>

    private String getPostFormatKeyFromName(String postFormatName) {
<span class="nc bnc" id="L1008" title="All 2 branches missed.">        for (int i = 0; i &lt; mPostFormatNames.size(); i++) {</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">            if (postFormatName.equalsIgnoreCase(mPostFormatNames.get(i))) {</span>
<span class="nc" id="L1010">                return mPostFormatKeys.get(i);</span>
            }
        }
<span class="nc" id="L1013">        return POST_FORMAT_STANDARD_KEY;</span>
    }

    private String getPostFormatNameFromKey(String postFormatKey) {
<span class="nc bnc" id="L1017" title="All 2 branches missed.">        if (TextUtils.isEmpty(postFormatKey)) {</span>
<span class="nc" id="L1018">            postFormatKey = POST_FORMAT_STANDARD_KEY;</span>
        }

<span class="nc bnc" id="L1021" title="All 2 branches missed.">        for (int i = 0; i &lt; mPostFormatKeys.size(); i++) {</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">            if (postFormatKey.equalsIgnoreCase(mPostFormatKeys.get(i))) {</span>
<span class="nc" id="L1023">                return mPostFormatNames.get(i);</span>
            }
        }
        // Since this is only used as a display name, if we can't find the key, we should just
        // return the capitalized key as the name which should be better than returning `null`
<span class="nc" id="L1028">        return StringUtils.capitalize(postFormatKey);</span>
    }

    // Featured Image Helpers

    public void updateFeaturedImage(long featuredImageId, boolean imagePicked) {
<span class="nc bnc" id="L1034" title="All 4 branches missed.">        if (isAdded() &amp;&amp; imagePicked) {</span>
<span class="nc" id="L1035">            int postId = getEditPostRepository().getId();</span>
<span class="nc" id="L1036">            mFeaturedImageHelper.trackFeaturedImageEvent(</span>
                    TrackableEvent.IMAGE_PICKED_POST_SETTINGS,
                    postId
            );
        }

<span class="nc" id="L1042">        EditPostRepository postRepository = getEditPostRepository();</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">        if (postRepository == null) {</span>
<span class="nc" id="L1044">            return;</span>
        }

<span class="nc" id="L1047">        mUpdateFeaturedImageUseCase.updateFeaturedImage(featuredImageId, postRepository,</span>
                postModel -&gt; {
<span class="nc" id="L1049">                    updateFeaturedImageView(postModel);</span>
<span class="nc" id="L1050">                    return null;</span>
                });
<span class="nc" id="L1052">    }</span>

    private void clearFeaturedImage() {
<span class="nc" id="L1055">        updateFeaturedImage(0, false);</span>

<span class="nc bnc" id="L1057" title="All 2 branches missed.">        if (getActivity() instanceof EditPostSettingsCallback) {</span>
<span class="nc" id="L1058">            ((EditPostSettingsCallback) getActivity()).clearFeaturedImage();</span>
        }
<span class="nc" id="L1060">    }</span>

    private void updateFeaturedImageView(PostImmutableModel postModel) {
<span class="nc" id="L1063">        Context context = getContext();</span>
<span class="nc" id="L1064">        SiteModel site = getSite();</span>
<span class="nc bnc" id="L1065" title="All 8 branches missed.">        if (!isAdded() || postModel == null || site == null || context == null) {</span>
<span class="nc" id="L1066">            return;</span>
        }
<span class="nc" id="L1068">        final FeaturedImageData currentFeaturedImageState =</span>
<span class="nc" id="L1069">                mFeaturedImageHelper.createCurrentFeaturedImageState(site, postModel);</span>

<span class="nc" id="L1071">        FeaturedImageState uiState = currentFeaturedImageState.getUiState();</span>
<span class="nc" id="L1072">        updateFeaturedImageViews(currentFeaturedImageState.getUiState());</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">        if (currentFeaturedImageState.getMediaUri() != null) {</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            if (uiState == FeaturedImageState.REMOTE_IMAGE_LOADING) {</span>
                /*
                 *  Fetch the remote image, but keep showing the local image (when present) until &quot;onResourceReady&quot;
                 *  is invoked.  We use this hack to prevent showing an empty view when the local image is replaced
                 *  with a remote image.
                 */
<span class="nc" id="L1080">                mImageManager.loadWithResultListener(mFeaturedImageView, ImageType.IMAGE,</span>
<span class="nc" id="L1081">                        currentFeaturedImageState.getMediaUri(), ScaleType.FIT_CENTER,</span>
<span class="nc" id="L1082">                        null, new RequestListener&lt;Drawable&gt;() {</span>
                            @Override public void onLoadFailed(@Nullable Exception e, @Nullable Object model) {
<span class="nc" id="L1084">                            }</span>

                            @Override public void onResourceReady(@NonNull Drawable resource, @Nullable Object model) {
<span class="nc bnc" id="L1087" title="All 2 branches missed.">                                if (currentFeaturedImageState.getUiState() == FeaturedImageState.REMOTE_IMAGE_LOADING) {</span>
<span class="nc" id="L1088">                                    updateFeaturedImageViews(FeaturedImageState.REMOTE_IMAGE_SET);</span>
                                }
<span class="nc" id="L1090">                            }</span>
                        });
            } else {
<span class="nc" id="L1093">                mImageManager.load(mLocalFeaturedImageView, ImageType.IMAGE, currentFeaturedImageState.getMediaUri(),</span>
                        ScaleType.FIT_CENTER);
            }
        }
<span class="nc" id="L1097">    }</span>

    private void launchFeaturedMediaPicker() {
<span class="nc bnc" id="L1100" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L1101">            int postId = getEditPostRepository().getId();</span>
<span class="nc" id="L1102">            mFeaturedImageHelper.trackFeaturedImageEvent(TrackableEvent.IMAGE_SET_CLICKED, postId);</span>

<span class="nc" id="L1104">            mMediaPickerLauncher</span>
<span class="nc" id="L1105">                    .showFeaturedImagePicker(requireActivity(), getSite(),</span>
                            postId);
        }
<span class="nc" id="L1108">    }</span>

    // Publish Date Helpers

    private Calendar getCurrentPublishDateAsCalendar() {
<span class="nc" id="L1113">        Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L1114">        String dateCreated = getEditPostRepository().getDateCreated();</span>
        // Set the currently selected time if available
<span class="nc bnc" id="L1116" title="All 2 branches missed.">        if (!TextUtils.isEmpty(dateCreated)) {</span>
<span class="nc" id="L1117">            calendar.setTime(DateTimeUtils.dateFromIso8601(dateCreated));</span>
        }
<span class="nc" id="L1119">        return calendar;</span>
    }

    // FluxC events

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onTaxonomyChanged(OnTaxonomyChanged event) {
<span class="nc bnc" id="L1127" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1128">            AppLog.e(T.POSTS, &quot;An error occurred while updating taxonomy with type: &quot; + event.error.type);</span>
<span class="nc" id="L1129">            return;</span>
        }
<span class="nc bnc" id="L1131" title="All 2 branches missed.">        if (event.causeOfChange == TaxonomyAction.FETCH_CATEGORIES) {</span>
<span class="nc" id="L1132">            updateCategoriesTextView(getEditPostRepository().getPost());</span>
        }
<span class="nc" id="L1134">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe
    public void onPostFormatsChanged(OnPostFormatsChanged event) {
<span class="nc bnc" id="L1139" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1140">            AppLog.e(T.POSTS, &quot;An error occurred while updating the post formats with type: &quot; + event.error.type);</span>
<span class="nc" id="L1141">            return;</span>
        }
<span class="nc" id="L1143">        AppLog.v(T.POSTS, &quot;Post formats successfully fetched!&quot;);</span>
<span class="nc" id="L1144">        updatePostFormatKeysAndNames();</span>
<span class="nc" id="L1145">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onMediaUploaded(OnMediaUploaded event) {
<span class="nc bnc" id="L1149" title="All 2 branches missed.">        if (event.media.getMarkedLocallyAsFeatured()) {</span>
<span class="nc" id="L1150">            refreshViews();</span>
        }
<span class="nc" id="L1152">    }</span>

    private void updateFeaturedImageViews(FeaturedImageState state) {
<span class="nc" id="L1155">        mUiHelpers.updateVisibility(mFeaturedImageView, state.getImageViewVisible());</span>
<span class="nc" id="L1156">        mUiHelpers.updateVisibility(mLocalFeaturedImageView, state.getLocalImageViewVisible());</span>
<span class="nc" id="L1157">        mUiHelpers.updateVisibility(mFeaturedImageButton, state.getButtonVisible());</span>
<span class="nc" id="L1158">        mUiHelpers.updateVisibility(mFeaturedImageRetryOverlay, state.getRetryOverlayVisible());</span>
<span class="nc" id="L1159">        mUiHelpers.updateVisibility(mFeaturedImageProgressOverlay, state.getProgressOverlayVisible());</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">        if (!state.getLocalImageViewVisible()) {</span>
<span class="nc" id="L1161">            mImageManager.cancelRequestAndClearImageView(mLocalFeaturedImageView);</span>
        }
<span class="nc" id="L1163">    }</span>

    interface EditPostSettingsCallback {
        void onEditPostPublishedSettingsClick();
        void clearFeaturedImage();
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>