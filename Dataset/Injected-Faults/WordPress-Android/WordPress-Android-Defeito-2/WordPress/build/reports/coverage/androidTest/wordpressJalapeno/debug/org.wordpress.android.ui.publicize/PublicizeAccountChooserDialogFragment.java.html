<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PublicizeAccountChooserDialogFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.publicize</a> &gt; <span class="el_source">PublicizeAccountChooserDialogFragment.java</span></div><h1>PublicizeAccountChooserDialogFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.publicize;

import android.app.Activity;
import android.app.Dialog;
import android.content.DialogInterface;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.widget.LinearLayout;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AlertDialog;
import androidx.fragment.app.DialogFragment;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import com.google.android.material.dialog.MaterialAlertDialogBuilder;

import org.greenrobot.eventbus.EventBus;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.datasets.PublicizeTable;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.models.PublicizeConnection;
import org.wordpress.android.models.PublicizeService;
import org.wordpress.android.util.ToastUtils;

import java.util.ArrayList;

<span class="nc" id="L33">public class PublicizeAccountChooserDialogFragment extends DialogFragment</span>
        implements PublicizeAccountChooserListAdapter.OnPublicizeAccountChooserListener {
    public static final String TAG = &quot;publicize-account-chooser-dialog-fragment&quot;;
    private RecyclerView mNotConnectedRecyclerView;
    private ArrayList&lt;PublicizeConnection&gt; mNotConnectedAccounts;
    private ArrayList&lt;PublicizeConnection&gt; mConnectedAccounts;
<span class="nc" id="L39">    private String mConnectionName = &quot;&quot;;</span>
<span class="nc" id="L40">    private String mServiceId = &quot;&quot;;</span>
<span class="nc" id="L41">    private int mSelectedIndex = 0;</span>
    private SiteModel mSite;

    @NonNull
    @Override
    public Dialog onCreateDialog(Bundle savedInstanceState) {
<span class="nc" id="L47">        retrieveCurrentSiteFromArgs();</span>
<span class="nc" id="L48">        configureConnectionName();</span>

<span class="nc" id="L50">        LayoutInflater inflater = getActivity().getLayoutInflater();</span>
        //noinspection InflateParams
<span class="nc" id="L52">        View view = inflater.inflate(R.layout.publicize_account_chooser_dialog, null);</span>

<span class="nc" id="L54">        AlertDialog.Builder builder = new MaterialAlertDialogBuilder(getActivity());</span>
<span class="nc" id="L55">        configureAlertDialog(view, builder);</span>
<span class="nc" id="L56">        configureRecyclerViews(view);</span>

<span class="nc" id="L58">        return builder.create();</span>
    }

    @Override
    public void onDismiss(DialogInterface dialog) {
<span class="nc" id="L63">        super.onDismiss(dialog);</span>
<span class="nc" id="L64">        Activity activity = getActivity();</span>
<span class="nc bnc" id="L65" title="All 4 branches missed.">        if (activity != null &amp;&amp; activity instanceof DialogInterface.OnDismissListener) {</span>
<span class="nc" id="L66">            ((DialogInterface.OnDismissListener) activity).onDismiss(dialog);</span>
        }
<span class="nc" id="L68">    }</span>

    private void configureRecyclerViews(View view) {
<span class="nc" id="L71">        PublicizeAccountChooserListAdapter notConnectedAdapter =</span>
<span class="nc" id="L72">                new PublicizeAccountChooserListAdapter(getActivity(), mNotConnectedAccounts, this, false);</span>
<span class="nc" id="L73">        notConnectedAdapter.setHasStableIds(true);</span>
<span class="nc" id="L74">        mNotConnectedRecyclerView = view.findViewById(R.id.not_connected_recyclerview);</span>
<span class="nc" id="L75">        mNotConnectedRecyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));</span>
<span class="nc" id="L76">        mNotConnectedRecyclerView.setAdapter(notConnectedAdapter);</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (mConnectedAccounts.isEmpty()) {</span>
<span class="nc" id="L79">            hideConnectedView(view);</span>
        } else {
<span class="nc" id="L81">            populateConnectedListView(view);</span>
        }
<span class="nc" id="L83">    }</span>

    private void hideConnectedView(View view) {
<span class="nc" id="L86">        LinearLayout connectedHeader = view.findViewById(R.id.connected_header);</span>
<span class="nc" id="L87">        connectedHeader.setVisibility(View.GONE);</span>
<span class="nc" id="L88">    }</span>

    private void populateConnectedListView(View view) {
<span class="nc" id="L91">        RecyclerView listViewConnected = view.findViewById(R.id.connected_recyclerview);</span>
<span class="nc" id="L92">        PublicizeAccountChooserListAdapter connectedAdapter =</span>
<span class="nc" id="L93">                new PublicizeAccountChooserListAdapter(getActivity(), mConnectedAccounts, null, true);</span>

<span class="nc" id="L95">        listViewConnected.setLayoutManager(new LinearLayoutManager(getActivity()));</span>
<span class="nc" id="L96">        listViewConnected.setAdapter(connectedAdapter);</span>
<span class="nc" id="L97">    }</span>

    private void configureAlertDialog(View view, AlertDialog.Builder builder) {
<span class="nc" id="L100">        builder.setView(view);</span>
<span class="nc" id="L101">        builder.setTitle(getString(R.string.connecting_social_network, mConnectionName));</span>
<span class="nc" id="L102">        builder.setMessage(getString(R.string.connection_chooser_message));</span>
<span class="nc" id="L103">        builder.setPositiveButton(R.string.share_btn_connect, (dialogInterface, i) -&gt; {</span>
<span class="nc" id="L104">            dialogInterface.dismiss();</span>
<span class="nc" id="L105">            int keychainId = mNotConnectedAccounts.get(mSelectedIndex).connectionId;</span>
<span class="nc" id="L106">            String service = mNotConnectedAccounts.get(mSelectedIndex).getService();</span>
<span class="nc" id="L107">            String externalUserId = mNotConnectedAccounts.get(mSelectedIndex).getExternalId();</span>
<span class="nc" id="L108">            EventBus.getDefault().post(new PublicizeEvents.ActionAccountChosen(mSite.getSiteId(), keychainId,</span>
                    service, externalUserId));
<span class="nc" id="L110">        });</span>
<span class="nc" id="L111">        builder.setNegativeButton(R.string.cancel, (dialogInterface, i) -&gt; {</span>
<span class="nc" id="L112">            dialogInterface.cancel();</span>
<span class="nc" id="L113">            ToastUtils.showToast(getActivity(),</span>
<span class="nc" id="L114">                                 getActivity().getString(R.string.cannot_connect_account_error, mConnectionName));</span>
<span class="nc" id="L115">        });</span>
<span class="nc" id="L116">    }</span>

    private void retrieveCurrentSiteFromArgs() {
<span class="nc" id="L119">        Bundle args = getArguments();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (args != null) {</span>
<span class="nc" id="L121">            mSite = (SiteModel) args.getSerializable(WordPress.SITE);</span>
<span class="nc" id="L122">            mServiceId = args.getString(PublicizeConstants.ARG_SERVICE_ID);</span>
<span class="nc" id="L123">            String jsonString = args.getString(PublicizeConstants.ARG_CONNECTION_ARRAY_JSON);</span>
<span class="nc" id="L124">            addConnectionsToLists(jsonString);</span>
        }
<span class="nc" id="L126">    }</span>

    private void addConnectionsToLists(String jsonString) {
<span class="nc" id="L129">        mNotConnectedAccounts = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L130">        mConnectedAccounts = new ArrayList&lt;&gt;();</span>
        try {
<span class="nc" id="L132">            JSONObject jsonObject = new JSONObject(jsonString);</span>
<span class="nc" id="L133">            JSONArray jsonArray = jsonObject.getJSONArray(&quot;connections&quot;);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            for (int i = 0; i &lt; jsonArray.length(); i++) {</span>
<span class="nc" id="L135">                JSONObject currentConnectionJson = jsonArray.getJSONObject(i);</span>
<span class="nc" id="L136">                PublicizeConnection connection = PublicizeConnection.fromJson(currentConnectionJson);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if (connection.getService().equals(mServiceId)) {</span>
<span class="nc" id="L138">                    PublicizeService service = PublicizeTable.getService(mServiceId);</span>
<span class="nc bnc" id="L139" title="All 4 branches missed.">                    if (service != null &amp;&amp; !service.isExternalUsersOnly()) {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                        if (connection.isInSite(mSite.getSiteId())) {</span>
<span class="nc" id="L141">                            mConnectedAccounts.add(connection);</span>
                        } else {
<span class="nc" id="L143">                            mNotConnectedAccounts.add(connection);</span>
                        }
                    }

<span class="nc" id="L147">                    JSONArray externalJsonArray = currentConnectionJson.getJSONArray(&quot;additional_external_users&quot;);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                    for (int j = 0; j &lt; externalJsonArray.length(); j++) {</span>
<span class="nc" id="L149">                        JSONObject currentExternalConnectionJson = externalJsonArray.getJSONObject(j);</span>
<span class="nc" id="L150">                        PublicizeConnection.updateConnectionfromExternalJson(connection, currentExternalConnectionJson);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                        if (connection.isInSite(mSite.getSiteId())) {</span>
<span class="nc" id="L152">                            mConnectedAccounts.add(connection);</span>
                        } else {
<span class="nc" id="L154">                            mNotConnectedAccounts.add(connection);</span>
                        }
                    }
                }
            }
<span class="nc" id="L159">        } catch (JSONException e) {</span>
<span class="nc" id="L160">            e.printStackTrace();</span>
<span class="nc" id="L161">        }</span>
<span class="nc" id="L162">    }</span>

    private void configureConnectionName() {
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (mNotConnectedAccounts.isEmpty()) {</span>
<span class="nc" id="L166">            return;</span>
        }

<span class="nc" id="L169">        PublicizeConnection connection = mNotConnectedAccounts.get(0);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (connection != null) {</span>
<span class="nc" id="L171">            mConnectionName = connection.getLabel();</span>
        }
<span class="nc" id="L173">    }</span>

    @Override
    public void onAccountSelected(int selectedIndex) {
<span class="nc" id="L177">        mSelectedIndex = selectedIndex;</span>
<span class="nc" id="L178">        mNotConnectedRecyclerView.getAdapter().notifyDataSetChanged();</span>
<span class="nc" id="L179">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>