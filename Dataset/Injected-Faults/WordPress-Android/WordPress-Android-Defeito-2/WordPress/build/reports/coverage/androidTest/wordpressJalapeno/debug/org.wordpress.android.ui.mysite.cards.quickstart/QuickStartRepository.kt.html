<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuickStartRepository.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.mysite.cards.quickstart</a> &gt; <span class="el_source">QuickStartRepository.kt</span></div><h1>QuickStartRepository.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.mysite.cards.quickstart

import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import com.google.android.material.snackbar.Snackbar.Callback.DISMISS_EVENT_SWIPE
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.generated.SiteActionBuilder
import org.wordpress.android.fluxc.model.DynamicCardType
import org.wordpress.android.fluxc.model.DynamicCardType.CUSTOMIZE_QUICK_START
import org.wordpress.android.fluxc.model.DynamicCardType.GET_TO_KNOW_APP_QUICK_START
import org.wordpress.android.fluxc.model.DynamicCardType.GROW_QUICK_START
import org.wordpress.android.fluxc.store.DynamicCardStore
import org.wordpress.android.fluxc.store.QuickStartStore
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartNewSiteTask
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTask
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTaskType
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTaskType.CUSTOMIZE
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTaskType.GET_TO_KNOW_APP
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTaskType.GROW
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTaskType.UNKNOWN
import org.wordpress.android.fluxc.store.SiteStore.CompleteQuickStartPayload
import org.wordpress.android.fluxc.store.SiteStore.CompleteQuickStartVariant.NEXT_STEPS
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.ui.mysite.SelectedSiteRepository
import org.wordpress.android.ui.mysite.tabs.MySiteTabType
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.prefs.AppPrefsWrapper
import org.wordpress.android.ui.quickstart.QuickStartEvent
import org.wordpress.android.ui.quickstart.QuickStartMySitePrompts
import org.wordpress.android.ui.quickstart.QuickStartNoticeDetails
import org.wordpress.android.ui.quickstart.QuickStartTaskDetails
import org.wordpress.android.ui.quickstart.QuickStartTracker
import org.wordpress.android.ui.quickstart.QuickStartType
import org.wordpress.android.ui.quickstart.QuickStartType.ExistingSiteQuickStartType
import org.wordpress.android.ui.quickstart.QuickStartType.NewSiteQuickStartType
import org.wordpress.android.ui.utils.HtmlMessageUtils
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.BuildConfigWrapper
import org.wordpress.android.util.EventBusWrapper
import org.wordpress.android.util.HtmlCompatWrapper
import org.wordpress.android.util.QuickStartUtilsWrapper
import org.wordpress.android.util.SiteUtils
import org.wordpress.android.util.config.MySiteDashboardTabsFeatureConfig
import org.wordpress.android.util.config.QuickStartDynamicCardsFeatureConfig
import org.wordpress.android.util.config.QuickStartExistingUsersV2FeatureConfig
import org.wordpress.android.viewmodel.ContextProvider
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ResourceProvider
import javax.inject.Inject
import javax.inject.Named
import javax.inject.Singleton
import kotlin.coroutines.CoroutineContext

<span class="nc" id="L62">@Suppress(&quot;LongParameterList&quot;, &quot;TooManyFunctions&quot;)</span>
@Singleton
class QuickStartRepository
<span class="nc" id="L65">@Inject constructor(</span>
<span class="nc" id="L66">    @Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L67">    private val quickStartStore: QuickStartStore,</span>
<span class="nc" id="L68">    private val quickStartUtilsWrapper: QuickStartUtilsWrapper,</span>
<span class="nc" id="L69">    private val appPrefsWrapper: AppPrefsWrapper,</span>
<span class="nc" id="L70">    private val selectedSiteRepository: SelectedSiteRepository,</span>
<span class="nc" id="L71">    private val resourceProvider: ResourceProvider,</span>
<span class="nc" id="L72">    private val dispatcher: Dispatcher,</span>
<span class="nc" id="L73">    private val eventBus: EventBusWrapper,</span>
<span class="nc" id="L74">    private val dynamicCardStore: DynamicCardStore,</span>
<span class="nc" id="L75">    private val htmlCompat: HtmlCompatWrapper,</span>
<span class="nc" id="L76">    private val quickStartDynamicCardsFeatureConfig: QuickStartDynamicCardsFeatureConfig,</span>
<span class="nc" id="L77">    private val contextProvider: ContextProvider,</span>
<span class="nc" id="L78">    private val htmlMessageUtils: HtmlMessageUtils,</span>
<span class="nc" id="L79">    private val quickStartTracker: QuickStartTracker,</span>
    buildConfigWrapper: BuildConfigWrapper,
    mySiteDashboardTabsFeatureConfig: MySiteDashboardTabsFeatureConfig,
    quickStartForExistingUsersV2FeatureConfig: QuickStartExistingUsersV2FeatureConfig
) : CoroutineScope {
<span class="nc" id="L84">    private val job: Job = Job()</span>
    override val coroutineContext: CoroutineContext
<span class="nc" id="L86">        get() = bgDispatcher + job</span>

<span class="nc" id="L88">    private val detailsMap: Map&lt;String, QuickStartTaskDetails&gt; = QuickStartTaskDetails.values()</span>
<span class="nc" id="L89">            .associateBy { it.taskString }</span>
<span class="nc" id="L90">    private val _activeTask = MutableLiveData&lt;QuickStartTask?&gt;()</span>
<span class="nc" id="L91">    private val _onSnackbar = MutableLiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt;()</span>
<span class="nc" id="L92">    private val _onQuickStartMySitePrompts = MutableLiveData&lt;Event&lt;QuickStartMySitePrompts&gt;&gt;()</span>
<span class="nc" id="L93">    private val _onQuickStartTabStep = MutableLiveData&lt;QuickStartTabStep?&gt;()</span>
    private var _isQuickStartNoticeShown: Boolean = false
<span class="nc bnc" id="L95" title="All 2 branches missed.">    private val isMySiteTabsEnabled = mySiteDashboardTabsFeatureConfig.isEnabled() &amp;&amp;</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            buildConfigWrapper.isMySiteTabsEnabled &amp;&amp;</span>
<span class="nc bnc" id="L97" title="All 4 branches missed.">            selectedSiteRepository.getSelectedSite()?.isUsingWpComRestApi ?: true</span>
<span class="nc" id="L98">    val onSnackbar = _onSnackbar as LiveData&lt;Event&lt;SnackbarMessageHolder&gt;&gt;</span>
<span class="nc" id="L99">    val onQuickStartMySitePrompts = _onQuickStartMySitePrompts as LiveData&lt;Event&lt;QuickStartMySitePrompts&gt;&gt;</span>
<span class="nc" id="L100">    val onQuickStartTabStep = _onQuickStartTabStep as LiveData&lt;QuickStartTabStep?&gt;</span>
<span class="nc" id="L101">    val activeTask = _activeTask as LiveData&lt;QuickStartTask?&gt;</span>
<span class="nc" id="L102">    val isQuickStartNoticeShown = _isQuickStartNoticeShown</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">    var currentTab = if (isMySiteTabsEnabled) MySiteTabType.DASHBOARD else MySiteTabType.ALL</span>
<span class="nc" id="L104">    val isQuickStartForExistingUsersV2FeatureEnabled = quickStartForExistingUsersV2FeatureConfig.isEnabled()</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">    var quickStartTaskOriginTab = if (isMySiteTabsEnabled) MySiteTabType.DASHBOARD else MySiteTabType.ALL</span>
    val quickStartType: QuickStartType
<span class="nc bnc" id="L107" title="All 4 branches missed.">        get() = selectedSiteRepository.getSelectedSite()?.let {</span>
<span class="nc" id="L108">            val siteLocalId = it.id.toLong()</span>
<span class="nc" id="L109">            appPrefsWrapper.getLastSelectedQuickStartTypeForSite(siteLocalId)</span>
<span class="nc" id="L110">        } ?: NewSiteQuickStartType</span>
    private var pendingTask: QuickStartTask? = null

<span class="nc" id="L113">    fun buildQuickStartCategory(siteLocalId: Int, quickStartTaskType: QuickStartTaskType) = QuickStartCategory(</span>
<span class="nc" id="L114">            quickStartTaskType,</span>
<span class="nc" id="L115">            uncompletedTasks = quickStartStore.getUncompletedTasksByType(siteLocalId.toLong(), quickStartTaskType)</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                    .mapNotNull { detailsMap[it.string] },</span>
<span class="nc" id="L117">            completedTasks = quickStartStore.getCompletedTasksByType(siteLocalId.toLong(), quickStartTaskType)</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    .mapNotNull { detailsMap[it.string] })</span>

    fun resetTask() {
<span class="nc" id="L121">        clearActiveTask()</span>
<span class="nc" id="L122">        clearPendingTask()</span>
<span class="nc" id="L123">        clearTabStep()</span>
<span class="nc" id="L124">    }</span>

    fun clearActiveTask() {
<span class="nc" id="L127">        _activeTask.value = null</span>
<span class="nc" id="L128">    }</span>

    fun clearPendingTask() {
<span class="nc" id="L131">        pendingTask = null</span>
<span class="nc" id="L132">    }</span>

    fun clearTabStep() {
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (_onQuickStartTabStep.value != null) {</span>
<span class="nc" id="L136">            _onQuickStartTabStep.value = null</span>
        }
<span class="nc" id="L138">    }</span>

    fun checkAndSetQuickStartType(isNewSite: Boolean) {
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (!isQuickStartForExistingUsersV2FeatureEnabled) return</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        selectedSiteRepository.getSelectedSite()?.let { selectedSite -&gt;</span>
<span class="nc" id="L143">            val siteLocalId = selectedSite.id.toLong()</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            val quickStartType = if (isNewSite) NewSiteQuickStartType else ExistingSiteQuickStartType</span>
<span class="nc" id="L145">            appPrefsWrapper.setLastSelectedQuickStartTypeForSite(quickStartType, siteLocalId)</span>
<span class="nc" id="L146">        }</span>
<span class="nc" id="L147">    }</span>

    suspend fun getQuickStartTaskTypes(siteLocalId: Int): List&lt;QuickStartTaskType&gt; {
<span class="nc bnc" id="L150" title="All 4 branches missed.">        val taskTypes = quickStartType.taskTypes.filterNot { it == UNKNOWN }</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        return if (quickStartDynamicCardsFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L152">            dynamicCardStore.getCards(siteLocalId).dynamicCardTypes</span>
<span class="nc" id="L153">                    .filter { dynamicCardType -&gt;</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                        dynamicCardType in taskTypes.map { it.toDynamicCardType() }</span>
                    }
<span class="nc" id="L156">                    .map { it.toQuickStartTaskType() }</span>
        } else {
<span class="nc" id="L158">            taskTypes</span>
        }
    }

    fun skipQuickStart() {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        selectedSiteRepository.getSelectedSite()?.let { selectedSite -&gt;</span>
<span class="nc" id="L164">            val selectedSiteLocalId = selectedSite.id.toLong()</span>
<span class="nc" id="L165">            QuickStartTask.getAllTasks().forEach { quickStartStore.setDoneTask(selectedSiteLocalId, it, true) }</span>
<span class="nc" id="L166">            quickStartStore.setQuickStartCompleted(selectedSiteLocalId, true)</span>
            // skipping all tasks means no achievement notification, so we mark it as received
<span class="nc" id="L168">            quickStartStore.setQuickStartNotificationReceived(selectedSiteLocalId, true)</span>
<span class="nc" id="L169">        }</span>
<span class="nc" id="L170">    }</span>

    fun setActiveTask(task: QuickStartTask) {
<span class="nc" id="L173">        _activeTask.postValue(task)</span>
<span class="nc" id="L174">        clearPendingTask()</span>
<span class="nc" id="L175">        clearTabStep()</span>
<span class="nc" id="L176">        when {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            isSiteMenuStepRequiredForTask(task) -&gt; requestTabStepForTask(task, MySiteTabType.SITE_MENU)</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            isHomeStepRequiredForTask(task) -&gt; requestTabStepForTask(task, MySiteTabType.DASHBOARD)</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            task == QuickStartNewSiteTask.UPDATE_SITE_TITLE -&gt; {</span>
<span class="nc" id="L180">                val shortQuickStartMessage = resourceProvider.getString(</span>
<span class="nc" id="L181">                        R.string.quick_start_dialog_update_site_title_message_short,</span>
<span class="nc" id="L182">                        SiteUtils.getSiteNameOrHomeURL(selectedSiteRepository.getSelectedSite())</span>
                )
<span class="nc" id="L184">                _onSnackbar.postValue(Event(SnackbarMessageHolder(UiStringText(shortQuickStartMessage.asHtml()))))</span>
            }
<span class="nc bnc" id="L186" title="All 2 branches missed.">            task == quickStartType.getTaskFromString(QuickStartStore.QUICK_START_VIEW_SITE_LABEL) -&gt; {</span>
<span class="nc" id="L187">                val shortQuickStartMessage = resourceProvider.getString(</span>
<span class="nc" id="L188">                        R.string.quick_start_dialog_view_your_site_message_short,</span>
<span class="nc" id="L189">                        SiteUtils.getHomeURLOrHostName(selectedSiteRepository.getSelectedSite())</span>
                )
<span class="nc" id="L191">                _onSnackbar.postValue(Event(SnackbarMessageHolder(UiStringText(shortQuickStartMessage.asHtml()))))</span>
            }
            else -&gt; {
<span class="nc bnc" id="L194" title="All 2 branches missed.">                QuickStartMySitePrompts.getPromptDetailsForTask(task)?.let { activeTutorialPrompt -&gt;</span>
<span class="nc" id="L195">                    _onQuickStartMySitePrompts.postValue(Event(activeTutorialPrompt))</span>
<span class="nc" id="L196">                }</span>
            }
        }
<span class="nc" id="L199">    }</span>

<span class="nc" id="L201">    fun isPendingTask(task: QuickStartTask) = task == pendingTask</span>

    fun completeTask(task: QuickStartTask) {
<span class="nc bnc" id="L204" title="All 2 branches missed.">        selectedSiteRepository.getSelectedSite()?.let { selectedSite -&gt;</span>
<span class="nc bnc" id="L205" title="All 4 branches missed.">            if (task != activeTask.value &amp;&amp; task != pendingTask) return</span>
<span class="nc" id="L206">            resetTask()</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (quickStartStore.hasDoneTask(selectedSite.id.toLong(), task)) return</span>
<span class="nc" id="L208">            quickStartUtilsWrapper.completeTaskAndRemindNextOne(</span>
<span class="nc" id="L209">                    task,</span>
<span class="nc" id="L210">                    selectedSite,</span>
<span class="nc" id="L211">                    QuickStartEvent(task),</span>
<span class="nc" id="L212">                    contextProvider.getContext(),</span>
<span class="nc" id="L213">                    quickStartType</span>
            )
<span class="nc" id="L215">            setTaskDoneAndTrack(task, selectedSite.id)</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">            if (quickStartType.isEveryQuickStartTaskDone(quickStartStore, selectedSite.id.toLong())) {</span>
<span class="nc" id="L217">                quickStartStore.setQuickStartCompleted(selectedSite.id.toLong(), true)</span>
<span class="nc" id="L218">                quickStartTracker.track(Stat.QUICK_START_ALL_TASKS_COMPLETED)</span>
<span class="nc" id="L219">                val payload = CompleteQuickStartPayload(selectedSite, NEXT_STEPS.toString())</span>
<span class="nc" id="L220">                dispatcher.dispatch(SiteActionBuilder.newCompleteQuickStartAction(payload))</span>
<span class="nc" id="L221">                showCompletedQuickStartNotice()</span>
            }
<span class="nc" id="L223">        }</span>
<span class="nc" id="L224">    }</span>

    fun setTaskDoneAndTrack(
        task: QuickStartTask,
        siteLocalId: Int
    ) {
<span class="nc" id="L230">        quickStartStore.setDoneTask(siteLocalId.toLong(), task, true)</span>
<span class="nc" id="L231">        quickStartTracker.track(quickStartUtilsWrapper.getTaskCompletedTracker(task))</span>
<span class="nc" id="L232">    }</span>

    private fun requestTabStepForTask(task: QuickStartTask, tabType: MySiteTabType) {
<span class="nc" id="L235">        clearActiveTask()</span>
<span class="nc" id="L236">        pendingTask = task</span>
<span class="nc" id="L237">        val shortQuickStartMessage = resourceProvider.getString(</span>
<span class="nc" id="L238">                R.string.quick_start_site_menu_tab_message_short,</span>
<span class="nc" id="L239">                resourceProvider.getString(tabType.stringResId)</span>
        )
<span class="nc" id="L241">        _onSnackbar.postValue(Event(SnackbarMessageHolder(UiStringText(htmlCompat.fromHtml(shortQuickStartMessage)))))</span>
<span class="nc" id="L242">        _onQuickStartTabStep.postValue(QuickStartTabStep(true, task, tabType))</span>
<span class="nc" id="L243">    }</span>

    fun requestNextStepOfTask(task: QuickStartTask) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (task != activeTask.value) return</span>
<span class="nc" id="L247">        clearActiveTask()</span>
<span class="nc" id="L248">        pendingTask = task</span>
<span class="nc" id="L249">        eventBus.postSticky(QuickStartEvent(task))</span>
<span class="nc" id="L250">    }</span>

    fun clear() {
<span class="nc" id="L253">        job.cancel()</span>
<span class="nc" id="L254">    }</span>

    suspend fun onCategoryCompleted(siteLocalId: Int, categoryType: QuickStartTaskType) {
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (quickStartDynamicCardsFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L258">            val completionMessage = getCategoryCompletionMessage(categoryType)</span>
<span class="nc" id="L259">            _onSnackbar.postValue(Event(SnackbarMessageHolder(UiStringText(completionMessage.asHtml()))))</span>
<span class="nc" id="L260">            dynamicCardStore.removeCard(siteLocalId, categoryType.toDynamicCardType())</span>
        }
<span class="nc" id="L262">    }</span>

<span class="nc bnc" id="L264" title="All 4 branches missed.">    private fun getCategoryCompletionMessage(taskType: QuickStartTaskType) = when (taskType) {</span>
<span class="nc" id="L265">        CUSTOMIZE -&gt; R.string.quick_start_completed_type_customize_message</span>
<span class="nc" id="L266">        GROW -&gt; R.string.quick_start_completed_type_grow_message</span>
        // TODO: ashiagr GET_TO_KNOW_APP add message
<span class="nc" id="L268">        GET_TO_KNOW_APP -&gt; R.string.quick_start_completed_type_grow_message</span>
<span class="nc" id="L269">        UNKNOWN -&gt; throw IllegalArgumentException(&quot;Unexpected quick start type&quot;)</span>
<span class="nc" id="L270">    }.let { resourceProvider.getString(it) }</span>

<span class="nc" id="L272">    private fun String.asHtml() = htmlCompat.fromHtml(this)</span>

    private fun DynamicCardType.toQuickStartTaskType(): QuickStartTaskType {
<span class="nc bnc" id="L275" title="All 3 branches missed.">        return when (this) {</span>
<span class="nc" id="L276">            CUSTOMIZE_QUICK_START -&gt; CUSTOMIZE</span>
<span class="nc" id="L277">            GROW_QUICK_START -&gt; GROW</span>
<span class="nc" id="L278">            GET_TO_KNOW_APP_QUICK_START -&gt; GET_TO_KNOW_APP</span>
        }
    }

    private fun QuickStartTaskType.toDynamicCardType(): DynamicCardType {
<span class="nc bnc" id="L283" title="All 4 branches missed.">        return when (this) {</span>
<span class="nc" id="L284">            CUSTOMIZE -&gt; CUSTOMIZE_QUICK_START</span>
<span class="nc" id="L285">            GROW -&gt; GROW_QUICK_START</span>
<span class="nc" id="L286">            GET_TO_KNOW_APP -&gt; GET_TO_KNOW_APP_QUICK_START</span>
<span class="nc" id="L287">            UNKNOWN -&gt; throw IllegalArgumentException(&quot;Unexpected quick start type&quot;)</span>
        }
    }

    fun checkAndShowQuickStartNotice() {
<span class="nc bnc" id="L292" title="All 2 branches missed.">        val selectedSiteLocalId = selectedSiteRepository.getSelectedSite()?.id ?: -1</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (quickStartType.isQuickStartInProgress(quickStartStore, selectedSiteLocalId.toLong()) &amp;&amp;</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                appPrefsWrapper.isQuickStartNoticeRequired()) {</span>
<span class="nc" id="L295">            showQuickStartNotice(selectedSiteLocalId)</span>
        }
<span class="nc" id="L297">    }</span>

    fun showCompletedQuickStartNotice() {
<span class="nc" id="L300">        launch {</span>
<span class="nc" id="L301">            delay(QUICK_START_COMPLETED_NOTICE_DELAY)</span>
<span class="nc" id="L302">            val message = htmlMessageUtils.getHtmlMessageFromStringFormat(</span>
<span class="nc" id="L303">                    &quot;&lt;b&gt;${resourceProvider.getString(R.string.quick_start_completed_tour_title)}&lt;/b&gt;&quot; +</span>
<span class="nc" id="L304">                            &quot; ${resourceProvider.getString(R.string.quick_start_completed_tour_subtitle)}&quot;</span>
            )
<span class="nc" id="L306">            _onSnackbar.postValue(Event(</span>
<span class="nc" id="L307">                    SnackbarMessageHolder(</span>
<span class="nc" id="L308">                            message = UiStringText(message),</span>
<span class="nc" id="L309">                            duration = QUICK_START_NOTICE_DURATION,</span>
<span class="nc" id="L310">                            isImportant = false</span>
                    )
            ))
<span class="nc" id="L313">        }</span>
<span class="nc" id="L314">    }</span>

    private fun showQuickStartNotice(selectedSiteLocalId: Int) {
<span class="nc" id="L317">        val taskToPrompt = quickStartUtilsWrapper</span>
<span class="nc" id="L318">                .getNextUncompletedQuickStartTask(quickStartType, selectedSiteLocalId.toLong())</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (taskToPrompt != null) {</span>
<span class="nc" id="L320">            quickStartTracker.track(Stat.QUICK_START_TASK_DIALOG_VIEWED)</span>
<span class="nc" id="L321">            appPrefsWrapper.setQuickStartNoticeRequired(false)</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            val taskNoticeDetails = QuickStartNoticeDetails.getNoticeForTask(taskToPrompt) ?: return</span>
<span class="nc" id="L323">            val message = htmlMessageUtils.getHtmlMessageFromStringFormat(</span>
<span class="nc" id="L324">                    &quot;&lt;b&gt;${resourceProvider.getString(taskNoticeDetails.titleResId)}&lt;/b&gt;:&quot; +</span>
<span class="nc" id="L325">                            &quot; ${resourceProvider.getString(taskNoticeDetails.messageResId)}&quot;</span>
            )
<span class="nc" id="L327">            _isQuickStartNoticeShown = true</span>
<span class="nc" id="L328">            _onSnackbar.value = Event(</span>
<span class="nc" id="L329">                    SnackbarMessageHolder(</span>
<span class="nc" id="L330">                            message = UiStringText(message),</span>
<span class="nc" id="L331">                            buttonTitle = UiStringRes(R.string.quick_start_button_positive),</span>
<span class="nc" id="L332">                            buttonAction = { onQuickStartNoticeButtonAction(taskToPrompt) },</span>
                            onDismissAction = { event -&gt;
<span class="nc" id="L334">                                _isQuickStartNoticeShown = false</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">                                if (event == DISMISS_EVENT_SWIPE) onQuickStartNoticeNegativeAction(taskToPrompt)</span>
<span class="nc" id="L336">                            },</span>
<span class="nc" id="L337">                            duration = QUICK_START_NOTICE_DURATION,</span>
<span class="nc" id="L338">                            isImportant = false</span>
                    )
            )
        }
<span class="nc" id="L342">    }</span>

    private fun onQuickStartNoticeButtonAction(task: QuickStartTask) {
<span class="nc" id="L345">        quickStartTracker.track(Stat.QUICK_START_TASK_DIALOG_POSITIVE_TAPPED)</span>
<span class="nc" id="L346">        setActiveTask(task)</span>
<span class="nc" id="L347">    }</span>

    private fun onQuickStartNoticeNegativeAction(task: QuickStartTask) {
<span class="nc" id="L350">        quickStartTracker.track(Stat.QUICK_START_TASK_DIALOG_NEGATIVE_TAPPED)</span>
<span class="nc" id="L351">        appPrefsWrapper.setLastSkippedQuickStartTask(task)</span>
<span class="nc" id="L352">    }</span>

    private fun isSiteMenuStepRequiredForTask(task: QuickStartTask) =
<span class="nc bnc" id="L355" title="All 4 branches missed.">            currentTab == MySiteTabType.DASHBOARD &amp;&amp; task.isShownInSiteMenuTab()</span>

    private fun isHomeStepRequiredForTask(task: QuickStartTask) =
<span class="nc bnc" id="L358" title="All 2 branches missed.">            quickStartTaskOriginTab == MySiteTabType.DASHBOARD &amp;&amp;</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                    currentTab == MySiteTabType.SITE_MENU &amp;&amp;</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                    task.isShownInHomeTab()</span>

    // the quick start focus point shown in case of when the default tab is site menu or dashboard varies
    // this function checks whether the passed tasks is shown in site menu
    private fun QuickStartTask.isShownInSiteMenuTab() =
<span class="nc bnc" id="L365" title="All 3 branches missed.">            when (quickStartTaskOriginTab) {</span>
                MySiteTabType.DASHBOARD -&gt;
<span class="nc" id="L367">                    when (this) {</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">                        QuickStartNewSiteTask.ENABLE_POST_SHARING -&gt; true</span>
<span class="nc" id="L369">                        else -&gt; false</span>
                    }
                MySiteTabType.SITE_MENU -&gt;
<span class="nc" id="L372">                    when (this) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                        quickStartType.getTaskFromString(QuickStartStore.QUICK_START_CHECK_STATS_LABEL),</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                        quickStartType.getTaskFromString(QuickStartStore.QUICK_START_UPLOAD_MEDIA_LABEL),</span>
<span class="nc bnc" id="L375" title="All 4 branches missed.">                        QuickStartNewSiteTask.REVIEW_PAGES,</span>
<span class="nc bnc" id="L376" title="All 4 branches missed.">                        QuickStartNewSiteTask.ENABLE_POST_SHARING -&gt; true</span>
<span class="nc" id="L377">                        else -&gt; false</span>
                    }
<span class="nc" id="L379">                else -&gt; false</span>
<span class="nc" id="L380">            }</span>

<span class="nc" id="L382">    private fun QuickStartTask.isShownInHomeTab() = when (this) {</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">        quickStartType.getTaskFromString(QuickStartStore.QUICK_START_CHECK_STATS_LABEL),</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">        quickStartType.getTaskFromString(QuickStartStore.QUICK_START_UPLOAD_MEDIA_LABEL),</span>
<span class="nc bnc" id="L385" title="All 4 branches missed.">        QuickStartNewSiteTask.REVIEW_PAGES -&gt; true</span>
<span class="nc" id="L386">        else -&gt; false</span>
<span class="nc" id="L387">    }</span>

<span class="nc" id="L389">    data class QuickStartTabStep(</span>
<span class="nc" id="L390">        val isStarted: Boolean,</span>
<span class="nc" id="L391">        val task: QuickStartTask? = null,</span>
<span class="nc" id="L392">        val mySiteTabType: MySiteTabType</span>
<span class="nc" id="L393">    )</span>

<span class="nc" id="L395">    data class QuickStartCategory(</span>
<span class="nc" id="L396">        val taskType: QuickStartTaskType,</span>
<span class="nc" id="L397">        val uncompletedTasks: List&lt;QuickStartTaskDetails&gt;,</span>
<span class="nc" id="L398">        val completedTasks: List&lt;QuickStartTaskDetails&gt;</span>
    )

    companion object {
        private const val QUICK_START_NOTICE_DURATION = 7000
        private const val QUICK_START_COMPLETED_NOTICE_DELAY = 5000L
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>