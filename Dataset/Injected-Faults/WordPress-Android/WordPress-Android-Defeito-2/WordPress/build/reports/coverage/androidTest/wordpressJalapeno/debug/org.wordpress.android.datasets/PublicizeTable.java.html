<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PublicizeTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.datasets</a> &gt; <span class="el_source">PublicizeTable.java</span></div><h1>PublicizeTable.java</h1><pre class="source lang-java linenums">package org.wordpress.android.datasets;

import android.content.ContentValues;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteStatement;
import android.text.TextUtils;

import org.wordpress.android.WordPress;
import org.wordpress.android.models.PublicizeConnection;
import org.wordpress.android.models.PublicizeConnectionList;
import org.wordpress.android.models.PublicizeService;
import org.wordpress.android.models.PublicizeServiceList;
import org.wordpress.android.util.SqlUtils;

<span class="nc" id="L16">public class PublicizeTable {</span>
    private static final String SERVICES_TABLE = &quot;tbl_publicize_services&quot;;
    private static final String CONNECTIONS_TABLE = &quot;tbl_publicize_connections&quot;;

    public static void createTables(SQLiteDatabase db) {
<span class="nc" id="L21">        db.execSQL(&quot;CREATE TABLE IF NOT EXISTS &quot; + SERVICES_TABLE + &quot; (&quot;</span>
                   + &quot; id TEXT NOT NULL COLLATE NOCASE,&quot;
                   + &quot; label TEXT NOT NULL COLLATE NOCASE,&quot;
                   + &quot; description TEXT NOT NULL,&quot;
                   + &quot; genericon TEXT NOT NULL,&quot;
                   + &quot; icon_url TEXT NOT NULL,&quot;
                   + &quot; connect_url TEXT NOT NULL,&quot;
                   + &quot; is_jetpack_supported INTEGER DEFAULT 0,&quot;
                   + &quot; is_multi_user_id_supported INTEGER DEFAULT 0,&quot;
                   + &quot; is_external_users_only INTEGER DEFAULT 0,&quot;
                   + &quot; PRIMARY KEY (id))&quot;);

<span class="nc" id="L33">        db.execSQL(&quot;CREATE TABLE IF NOT EXISTS &quot; + CONNECTIONS_TABLE + &quot; (&quot;</span>
                   + &quot; id INTEGER DEFAULT 0,&quot;
                   + &quot; site_id INTEGER DEFAULT 0,&quot;
                   + &quot; user_id INTEGER DEFAULT 0,&quot;
                   + &quot; keyring_connection_id INTEGER DEFAULT 0,&quot;
                   + &quot; keyring_connection_user_id INTEGER DEFAULT 0,&quot;
                   + &quot; is_shared INTEGER DEFAULT 0,&quot;
                   + &quot; service TEXT NOT NULL COLLATE NOCASE,&quot;
                   + &quot; label TEXT NOT NULL COLLATE NOCASE,&quot;
                   + &quot; external_id TEXT NOT NULL,&quot;
                   + &quot; external_name TEXT NOT NULL,&quot;
                   + &quot; external_display TEXT NOT NULL,&quot;
                   + &quot; external_profile_picture TEXT NOT NULL,&quot;
                   + &quot; refresh_url TEXT NOT NULL,&quot;
                   + &quot; status TEXT NOT NULL,&quot;
                   + &quot; PRIMARY KEY (id))&quot;);
<span class="nc" id="L49">    }</span>

    private static SQLiteDatabase getReadableDb() {
<span class="nc" id="L52">        return WordPress.wpDB.getDatabase();</span>
    }

    private static SQLiteDatabase getWritableDb() {
<span class="nc" id="L56">        return WordPress.wpDB.getDatabase();</span>
    }

    public static void resetServicesTable(SQLiteDatabase db) {
<span class="nc" id="L60">        db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + SERVICES_TABLE);</span>
<span class="nc" id="L61">    }</span>

    public static PublicizeService getService(String serviceId) {
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (TextUtils.isEmpty(serviceId)) {</span>
<span class="nc" id="L65">            return null;</span>
        }

<span class="nc" id="L68">        String[] args = {serviceId};</span>
<span class="nc" id="L69">        Cursor c = getReadableDb().rawQuery(&quot;SELECT * FROM &quot; + SERVICES_TABLE + &quot; WHERE id=?&quot;, args);</span>
        try {
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
<span class="nc" id="L72">                return getServiceFromCursor(c);</span>
            } else {
<span class="nc" id="L74">                return null;</span>
            }
        } finally {
<span class="nc" id="L77">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static PublicizeServiceList getServiceList() {
<span class="nc" id="L82">        PublicizeServiceList serviceList = new PublicizeServiceList();</span>
<span class="nc" id="L83">        Cursor c = getReadableDb().rawQuery(&quot;SELECT * FROM &quot; + SERVICES_TABLE + &quot; ORDER BY label&quot;, null);</span>
        try {
<span class="nc bnc" id="L85" title="All 2 branches missed.">            while (c.moveToNext()) {</span>
<span class="nc" id="L86">                serviceList.add(getServiceFromCursor(c));</span>
            }
<span class="nc" id="L88">            return serviceList;</span>
        } finally {
<span class="nc" id="L90">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static void setServiceList(final PublicizeServiceList serviceList) {
<span class="nc" id="L95">        SQLiteStatement stmt = null;</span>
<span class="nc" id="L96">        SQLiteDatabase db = getWritableDb();</span>
<span class="nc" id="L97">        db.beginTransaction();</span>
        try {
<span class="nc" id="L99">            db.delete(SERVICES_TABLE, null, null);</span>

<span class="nc" id="L101">            stmt = db.compileStatement(</span>
                    &quot;INSERT INTO &quot; + SERVICES_TABLE
                    + &quot; (id,&quot; // 1
                    + &quot; label,&quot; // 2
                    + &quot; description,&quot; // 3
                    + &quot; genericon,&quot; // 4
                    + &quot; icon_url,&quot; // 5
                    + &quot; connect_url,&quot; // 6
                    + &quot; is_jetpack_supported,&quot; // 7
                    + &quot; is_multi_user_id_supported,&quot; // 8
                    + &quot; is_external_users_only)&quot; // 9
                    + &quot; VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9)&quot;);
<span class="nc bnc" id="L113" title="All 2 branches missed.">            for (PublicizeService service : serviceList) {</span>
<span class="nc" id="L114">                stmt.bindString(1, service.getId());</span>
<span class="nc" id="L115">                stmt.bindString(2, service.getLabel());</span>
<span class="nc" id="L116">                stmt.bindString(3, service.getDescription());</span>
<span class="nc" id="L117">                stmt.bindString(4, service.getGenericon());</span>
<span class="nc" id="L118">                stmt.bindString(5, service.getIconUrl());</span>
<span class="nc" id="L119">                stmt.bindString(6, service.getConnectUrl());</span>
<span class="nc" id="L120">                stmt.bindLong(7, SqlUtils.boolToSql(service.isJetpackSupported()));</span>
<span class="nc" id="L121">                stmt.bindLong(8, SqlUtils.boolToSql(service.isMultiExternalUserIdSupported()));</span>
<span class="nc" id="L122">                stmt.bindLong(9, SqlUtils.boolToSql(service.isExternalUsersOnly()));</span>
<span class="nc" id="L123">                stmt.executeInsert();</span>
<span class="nc" id="L124">            }</span>

<span class="nc" id="L126">            db.setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L128">            db.endTransaction();</span>
<span class="nc" id="L129">            SqlUtils.closeStatement(stmt);</span>
        }
<span class="nc" id="L131">    }</span>

    private static boolean getBooleanFromCursor(Cursor cursor, String columnName) {
<span class="nc" id="L134">        int columnIndex = cursor.getColumnIndex(columnName);</span>
<span class="nc bnc" id="L135" title="All 4 branches missed.">        return columnIndex != -1 &amp;&amp; cursor.getInt(columnIndex) != 0;</span>
    }

    private static PublicizeService getServiceFromCursor(Cursor c) {
<span class="nc" id="L139">        PublicizeService service = new PublicizeService();</span>

<span class="nc" id="L141">        service.setId(c.getString(c.getColumnIndexOrThrow(&quot;id&quot;)));</span>
<span class="nc" id="L142">        service.setLabel(c.getString(c.getColumnIndexOrThrow(&quot;label&quot;)));</span>
<span class="nc" id="L143">        service.setDescription(c.getString(c.getColumnIndexOrThrow(&quot;description&quot;)));</span>
<span class="nc" id="L144">        service.setGenericon(c.getString(c.getColumnIndexOrThrow(&quot;genericon&quot;)));</span>
<span class="nc" id="L145">        service.setIconUrl(c.getString(c.getColumnIndexOrThrow(&quot;icon_url&quot;)));</span>
<span class="nc" id="L146">        service.setConnectUrl(c.getString(c.getColumnIndexOrThrow(&quot;connect_url&quot;)));</span>
<span class="nc" id="L147">        service.setIsJetpackSupported(getBooleanFromCursor(c, &quot;is_jetpack_supported&quot;));</span>
<span class="nc" id="L148">        service.setIsMultiExternalUserIdSupported(getBooleanFromCursor(c, &quot;is_multi_user_id_supported&quot;));</span>
<span class="nc" id="L149">        service.setIsExternalUsersOnly(getBooleanFromCursor(c, &quot;is_external_users_only&quot;));</span>

<span class="nc" id="L151">        return service;</span>
    }

    public static boolean onlyExternalConnections(String serviceId) {
<span class="nc bnc" id="L155" title="All 4 branches missed.">        if (serviceId == null &amp;&amp; serviceId.isEmpty()) {</span>
<span class="nc" id="L156">            return false;</span>
        }

<span class="nc" id="L159">        String sql = &quot;SELECT is_external_users_only FROM &quot; + SERVICES_TABLE + &quot; WHERE id=?&quot;;</span>
<span class="nc" id="L160">        String[] args = {serviceId};</span>
<span class="nc" id="L161">        return SqlUtils.boolForQuery(getReadableDb(), sql, args);</span>
    }

    public static String getConnectUrlForService(String serviceId) {
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (TextUtils.isEmpty(serviceId)) {</span>
<span class="nc" id="L166">            return &quot;&quot;;</span>
        }
<span class="nc" id="L168">        String sql = &quot;SELECT connect_url FROM &quot; + SERVICES_TABLE + &quot; WHERE id=?&quot;;</span>
<span class="nc" id="L169">        String[] args = {serviceId};</span>
<span class="nc" id="L170">        return SqlUtils.stringForQuery(getReadableDb(), sql, args);</span>
    }

    public static long getNumServices() {
<span class="nc" id="L174">        return SqlUtils.getRowCount(getReadableDb(), SERVICES_TABLE);</span>
    }

    // ********************************************************************************************

    public static PublicizeConnection getConnection(int connectionId) {
<span class="nc" id="L180">        String[] args = {Integer.toString(connectionId)};</span>
<span class="nc" id="L181">        Cursor c = getReadableDb().rawQuery(&quot;SELECT * FROM &quot; + CONNECTIONS_TABLE + &quot; WHERE id=?&quot;, args);</span>
        try {
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
<span class="nc" id="L184">                return getConnectionFromCursor(c);</span>
            } else {
<span class="nc" id="L186">                return null;</span>
            }
        } finally {
<span class="nc" id="L189">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static String getRefreshUrlForConnection(int connectionId) {
<span class="nc" id="L194">        String sql = &quot;SELECT refresh_url FROM &quot; + CONNECTIONS_TABLE + &quot; WHERE id=?&quot;;</span>
<span class="nc" id="L195">        String[] args = {Integer.toString(connectionId)};</span>
<span class="nc" id="L196">        return SqlUtils.stringForQuery(getReadableDb(), sql, args);</span>
    }

    public static boolean deleteConnection(int connectionId) {
<span class="nc" id="L200">        String[] args = {Integer.toString(connectionId)};</span>
<span class="nc" id="L201">        int numDeleted = getReadableDb().delete(CONNECTIONS_TABLE, &quot;id=?&quot;, args);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        return numDeleted &gt; 0;</span>
    }

    public static void addOrUpdateConnection(PublicizeConnection connection) {
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (connection == null) {</span>
<span class="nc" id="L207">            return;</span>
        }

<span class="nc" id="L210">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L211">        values.put(&quot;id&quot;, connection.connectionId);</span>
<span class="nc" id="L212">        values.put(&quot;site_id&quot;, connection.siteId);</span>
<span class="nc" id="L213">        values.put(&quot;user_id&quot;, connection.userId);</span>
<span class="nc" id="L214">        values.put(&quot;keyring_connection_id&quot;, connection.keyringConnectionId);</span>
<span class="nc" id="L215">        values.put(&quot;keyring_connection_user_id&quot;, connection.keyringConnectionUserId);</span>
<span class="nc" id="L216">        values.put(&quot;is_shared&quot;, connection.isShared);</span>
<span class="nc" id="L217">        values.put(&quot;service&quot;, connection.getService());</span>
<span class="nc" id="L218">        values.put(&quot;label&quot;, connection.getLabel());</span>
<span class="nc" id="L219">        values.put(&quot;external_id&quot;, connection.getExternalId());</span>
<span class="nc" id="L220">        values.put(&quot;external_name&quot;, connection.getExternalName());</span>
<span class="nc" id="L221">        values.put(&quot;external_display&quot;, connection.getExternalDisplayName());</span>
<span class="nc" id="L222">        values.put(&quot;external_profile_picture&quot;, connection.getExternalProfilePictureUrl());</span>
<span class="nc" id="L223">        values.put(&quot;refresh_url&quot;, connection.getRefreshUrl());</span>
<span class="nc" id="L224">        values.put(&quot;status&quot;, connection.getStatus());</span>

<span class="nc" id="L226">        getReadableDb().insertWithOnConflict(CONNECTIONS_TABLE, null, values, SQLiteDatabase.CONFLICT_REPLACE);</span>
<span class="nc" id="L227">    }</span>

    public static PublicizeConnectionList getConnectionsForSite(long siteId) {
<span class="nc" id="L230">        PublicizeConnectionList connectionList = new PublicizeConnectionList();</span>
<span class="nc" id="L231">        String[] args = {Long.toString(siteId)};</span>
<span class="nc" id="L232">        Cursor c = getReadableDb().rawQuery(&quot;SELECT * FROM &quot; + CONNECTIONS_TABLE + &quot; WHERE site_id=?&quot;, args);</span>
        try {
<span class="nc bnc" id="L234" title="All 2 branches missed.">            while (c.moveToNext()) {</span>
<span class="nc" id="L235">                connectionList.add(getConnectionFromCursor(c));</span>
            }
<span class="nc" id="L237">            return connectionList;</span>
        } finally {
<span class="nc" id="L239">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static void setConnectionsForSite(long siteId, PublicizeConnectionList connectionList) {
<span class="nc" id="L244">        SQLiteStatement stmt = null;</span>
<span class="nc" id="L245">        SQLiteDatabase db = getWritableDb();</span>
<span class="nc" id="L246">        db.beginTransaction();</span>
        try {
<span class="nc" id="L248">            db.delete(CONNECTIONS_TABLE, &quot;site_id=?&quot;, new String[]{Long.toString(siteId)});</span>

<span class="nc" id="L250">            stmt = db.compileStatement(</span>
                    &quot;INSERT INTO &quot; + CONNECTIONS_TABLE
                    + &quot; (id,&quot; // 1
                    + &quot; site_id,&quot; // 2
                    + &quot; user_id,&quot; // 3
                    + &quot; keyring_connection_id,&quot; // 4
                    + &quot; keyring_connection_user_id,&quot; // 5
                    + &quot; is_shared,&quot; // 6
                    + &quot; service,&quot; // 7
                    + &quot; label,&quot; // 8
                    + &quot; external_id,&quot; // 9
                    + &quot; external_name,&quot; // 10
                    + &quot; external_display,&quot; // 11
                    + &quot; external_profile_picture,&quot; // 12
                    + &quot; refresh_url,&quot; // 13
                    + &quot; status)&quot; // 14
                    + &quot; VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9, ?10, ?11, ?12, ?13, ?14)&quot;);
<span class="nc bnc" id="L267" title="All 2 branches missed.">            for (PublicizeConnection connection : connectionList) {</span>
<span class="nc" id="L268">                stmt.bindLong(1, connection.connectionId);</span>
<span class="nc" id="L269">                stmt.bindLong(2, connection.siteId);</span>
<span class="nc" id="L270">                stmt.bindLong(3, connection.userId);</span>
<span class="nc" id="L271">                stmt.bindLong(4, connection.keyringConnectionId);</span>
<span class="nc" id="L272">                stmt.bindLong(5, connection.keyringConnectionUserId);</span>

<span class="nc" id="L274">                stmt.bindLong(6, SqlUtils.boolToSql(connection.isShared));</span>

<span class="nc" id="L276">                stmt.bindString(7, connection.getService());</span>
<span class="nc" id="L277">                stmt.bindString(8, connection.getLabel());</span>
<span class="nc" id="L278">                stmt.bindString(9, connection.getExternalId());</span>
<span class="nc" id="L279">                stmt.bindString(10, connection.getExternalName());</span>
<span class="nc" id="L280">                stmt.bindString(11, connection.getExternalDisplayName());</span>
<span class="nc" id="L281">                stmt.bindString(12, connection.getExternalProfilePictureUrl());</span>
<span class="nc" id="L282">                stmt.bindString(13, connection.getRefreshUrl());</span>
<span class="nc" id="L283">                stmt.bindString(14, connection.getStatus());</span>

<span class="nc" id="L285">                stmt.executeInsert();</span>
<span class="nc" id="L286">            }</span>

<span class="nc" id="L288">            db.setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L290">            db.endTransaction();</span>
<span class="nc" id="L291">            SqlUtils.closeStatement(stmt);</span>
        }
<span class="nc" id="L293">    }</span>

    private static PublicizeConnection getConnectionFromCursor(Cursor c) {
<span class="nc" id="L296">        PublicizeConnection connection = new PublicizeConnection();</span>

<span class="nc" id="L298">        connection.siteId = c.getLong(c.getColumnIndexOrThrow(&quot;site_id&quot;));</span>
<span class="nc" id="L299">        connection.connectionId = c.getInt(c.getColumnIndexOrThrow(&quot;id&quot;));</span>
<span class="nc" id="L300">        connection.userId = c.getInt(c.getColumnIndexOrThrow(&quot;user_id&quot;));</span>
<span class="nc" id="L301">        connection.keyringConnectionId = c.getInt(c.getColumnIndexOrThrow(&quot;keyring_connection_id&quot;));</span>
<span class="nc" id="L302">        connection.keyringConnectionUserId = c.getInt(c.getColumnIndexOrThrow(&quot;keyring_connection_user_id&quot;));</span>

<span class="nc" id="L304">        connection.isShared = SqlUtils.sqlToBool(c.getInt(c.getColumnIndexOrThrow(&quot;is_shared&quot;)));</span>

<span class="nc" id="L306">        connection.setService(c.getString(c.getColumnIndexOrThrow(&quot;service&quot;)));</span>
<span class="nc" id="L307">        connection.setLabel(c.getString(c.getColumnIndexOrThrow(&quot;label&quot;)));</span>
<span class="nc" id="L308">        connection.setExternalId(c.getString(c.getColumnIndexOrThrow(&quot;external_id&quot;)));</span>
<span class="nc" id="L309">        connection.setExternalName(c.getString(c.getColumnIndexOrThrow(&quot;external_name&quot;)));</span>
<span class="nc" id="L310">        connection.setExternalDisplayName(c.getString(c.getColumnIndexOrThrow(&quot;external_display&quot;)));</span>
<span class="nc" id="L311">        connection.setExternalProfilePictureUrl(c.getString(c.getColumnIndexOrThrow(&quot;external_profile_picture&quot;)));</span>
<span class="nc" id="L312">        connection.setRefreshUrl(c.getString(c.getColumnIndexOrThrow(&quot;refresh_url&quot;)));</span>
<span class="nc" id="L313">        connection.setStatus(c.getString(c.getColumnIndexOrThrow(&quot;status&quot;)));</span>

<span class="nc" id="L315">        return connection;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>