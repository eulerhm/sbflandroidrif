<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SiteCreationActivity.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.sitecreation</a> &gt; <span class="el_source">SiteCreationActivity.kt</span></div><h1>SiteCreationActivity.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.sitecreation

import android.app.Activity
import android.content.Intent
import android.os.Bundle
import android.view.MenuItem
import androidx.activity.viewModels
import androidx.fragment.app.Fragment
import androidx.lifecycle.Observer
import kotlinx.coroutines.cancel
import dagger.hilt.android.AndroidEntryPoint
import org.wordpress.android.R
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.LocaleAwareActivity
import org.wordpress.android.ui.accounts.HelpActivity.Origin
import org.wordpress.android.ui.main.SitePickerActivity
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogNegativeClickInterface
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogPositiveClickInterface
import org.wordpress.android.ui.sitecreation.SiteCreationMainVM.SiteCreationScreenTitle.ScreenTitleEmpty
import org.wordpress.android.ui.sitecreation.SiteCreationMainVM.SiteCreationScreenTitle.ScreenTitleGeneral
import org.wordpress.android.ui.sitecreation.SiteCreationMainVM.SiteCreationScreenTitle.ScreenTitleStepCount
import org.wordpress.android.ui.sitecreation.SiteCreationStep.DOMAINS
import org.wordpress.android.ui.sitecreation.SiteCreationStep.INTENTS
import org.wordpress.android.ui.sitecreation.SiteCreationStep.SITE_DESIGNS
import org.wordpress.android.ui.sitecreation.SiteCreationStep.SITE_NAME
import org.wordpress.android.ui.sitecreation.SiteCreationStep.SITE_PREVIEW
import org.wordpress.android.ui.sitecreation.domains.DomainsScreenListener
import org.wordpress.android.ui.sitecreation.domains.SiteCreationDomainsFragment
import org.wordpress.android.ui.sitecreation.misc.OnHelpClickedListener
import org.wordpress.android.ui.sitecreation.misc.SiteCreationSource
import org.wordpress.android.ui.sitecreation.previews.SiteCreationPreviewFragment
import org.wordpress.android.ui.sitecreation.previews.SitePreviewScreenListener
import org.wordpress.android.ui.sitecreation.previews.SitePreviewViewModel.CreateSiteState
import org.wordpress.android.ui.sitecreation.previews.SitePreviewViewModel.CreateSiteState.SiteCreationCompleted
import org.wordpress.android.ui.sitecreation.previews.SitePreviewViewModel.CreateSiteState.SiteNotCreated
import org.wordpress.android.ui.sitecreation.previews.SitePreviewViewModel.CreateSiteState.SiteNotInLocalDb
import org.wordpress.android.ui.sitecreation.sitename.SiteCreationSiteNameFragment
import org.wordpress.android.ui.sitecreation.sitename.SiteCreationSiteNameViewModel
import org.wordpress.android.ui.sitecreation.sitename.SiteNameScreenListener
import org.wordpress.android.ui.sitecreation.theme.HomePagePickerFragment
import org.wordpress.android.ui.sitecreation.theme.HomePagePickerViewModel
import org.wordpress.android.ui.sitecreation.verticals.IntentsScreenListener
import org.wordpress.android.ui.sitecreation.verticals.SiteCreationIntentsFragment
import org.wordpress.android.ui.sitecreation.verticals.SiteCreationIntentsViewModel
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.ActivityUtils
import org.wordpress.android.util.config.SiteNameFeatureConfig
import org.wordpress.android.util.wizard.WizardNavigationTarget
import javax.inject.Inject

@Suppress(&quot;TooManyFunctions&quot;)
@AndroidEntryPoint
<span class="nc" id="L53">class SiteCreationActivity : LocaleAwareActivity(),</span>
        IntentsScreenListener,
        SiteNameScreenListener,
        DomainsScreenListener,
        SitePreviewScreenListener,
        OnHelpClickedListener,
        BasicDialogPositiveClickInterface,
        BasicDialogNegativeClickInterface {
<span class="nc bnc" id="L61" title="All 2 branches missed.">    @Inject internal lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">    @Inject internal lateinit var siteNameFeatureConfig: SiteNameFeatureConfig</span>
<span class="nc" id="L63">    private val mainViewModel: SiteCreationMainVM by viewModels()</span>
<span class="nc" id="L64">    private val hppViewModel: HomePagePickerViewModel by viewModels()</span>
<span class="nc" id="L65">    private val siteCreationIntentsViewModel: SiteCreationIntentsViewModel by viewModels()</span>
<span class="nc" id="L66">    private val siteCreationSiteNameViewModel: SiteCreationSiteNameViewModel by viewModels()</span>

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L69">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L70">        setContentView(R.layout.site_creation_activity)</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">        val siteCreationSource = intent.extras?.getString(ARG_CREATE_SITE_SOURCE)</span>
<span class="nc" id="L72">        mainViewModel.start(savedInstanceState, SiteCreationSource.fromString(siteCreationSource))</span>
<span class="nc" id="L73">        mainViewModel.preloadThumbnails(this)</span>

<span class="nc" id="L75">        observeVMState()</span>
<span class="nc" id="L76">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L79">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L80">        mainViewModel.writeToBundle(outState)</span>
<span class="nc" id="L81">    }</span>

    private fun observeVMState() {
<span class="nc" id="L84">        mainViewModel.navigationTargetObservable</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                .observe(this, Observer { target -&gt; target?.let { showStep(target) } })</span>
<span class="nc" id="L86">        mainViewModel.wizardFinishedObservable.observe(this, Observer { createSiteState -&gt;</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            createSiteState?.let {</span>
<span class="nc" id="L88">                val intent = Intent()</span>
<span class="nc" id="L89">                val (siteCreated, localSiteId, titleTaskComplete) = when (createSiteState) {</span>
                    // site creation flow was canceled
<span class="nc bnc" id="L91" title="All 2 branches missed.">                    is SiteNotCreated -&gt; Triple(false, null, false)</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                    is SiteNotInLocalDb -&gt; {</span>
                        // Site was created, but we haven't been able to fetch it, let `SitePickerActivity` handle
                        // this with a Snackbar message.
<span class="nc" id="L95">                        intent.putExtra(SitePickerActivity.KEY_SITE_CREATED_BUT_NOT_FETCHED, true)</span>
<span class="nc" id="L96">                        Triple(true, null, createSiteState.isSiteTitleTaskComplete)</span>
                    }
<span class="nc" id="L98">                    is SiteCreationCompleted -&gt; Triple(true, createSiteState.localSiteId,</span>
<span class="nc" id="L99">                            createSiteState.isSiteTitleTaskComplete)</span>
                }
<span class="nc" id="L101">                intent.putExtra(SitePickerActivity.KEY_SITE_LOCAL_ID, localSiteId)</span>
<span class="nc" id="L102">                intent.putExtra(SitePickerActivity.KEY_SITE_TITLE_TASK_COMPLETED, titleTaskComplete)</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">                setResult(if (siteCreated) Activity.RESULT_OK else Activity.RESULT_CANCELED, intent)</span>
<span class="nc" id="L104">                finish()</span>
<span class="nc" id="L105">            }</span>
<span class="nc" id="L106">        })</span>
<span class="nc" id="L107">        mainViewModel.dialogActionObservable.observe(this, Observer { dialogHolder -&gt;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            dialogHolder?.let {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                val supportFragmentManager = requireNotNull(supportFragmentManager) {</span>
<span class="nc" id="L110">                    &quot;FragmentManager can't be null at this point&quot;</span>
                }
<span class="nc" id="L112">                dialogHolder.show(this, supportFragmentManager, uiHelpers)</span>
<span class="nc" id="L113">            }</span>
<span class="nc" id="L114">        })</span>
<span class="nc" id="L115">        mainViewModel.exitFlowObservable.observe(this, Observer {</span>
<span class="nc" id="L116">            setResult(Activity.RESULT_CANCELED)</span>
<span class="nc" id="L117">            finish()</span>
<span class="nc" id="L118">        })</span>
<span class="nc" id="L119">        mainViewModel.onBackPressedObservable.observe(this, Observer {</span>
<span class="nc" id="L120">            ActivityUtils.hideKeyboard(this)</span>
<span class="nc" id="L121">            super.onBackPressed()</span>
<span class="nc" id="L122">        })</span>
<span class="nc" id="L123">        siteCreationIntentsViewModel.onBackButtonPressed.observe(this, Observer {</span>
<span class="nc" id="L124">            mainViewModel.onBackPressed()</span>
<span class="nc" id="L125">        })</span>
<span class="nc" id="L126">        siteCreationIntentsViewModel.onSkipButtonPressed.observe(this, Observer {</span>
<span class="nc" id="L127">            mainViewModel.onSiteIntentSkipped()</span>
<span class="nc" id="L128">        })</span>
<span class="nc" id="L129">        siteCreationSiteNameViewModel.onBackButtonPressed.observe(this, Observer {</span>
<span class="nc" id="L130">            mainViewModel.onBackPressed()</span>
<span class="nc" id="L131">            ActivityUtils.hideKeyboard(this)</span>
<span class="nc" id="L132">        })</span>
<span class="nc" id="L133">        siteCreationSiteNameViewModel.onSkipButtonPressed.observe(this, Observer {</span>
<span class="nc" id="L134">            ActivityUtils.hideKeyboard(this)</span>
<span class="nc" id="L135">            mainViewModel.onSiteNameSkipped()</span>
<span class="nc" id="L136">        })</span>
<span class="nc" id="L137">        hppViewModel.onBackButtonPressed.observe(this, Observer {</span>
<span class="nc" id="L138">            mainViewModel.onBackPressed()</span>
<span class="nc" id="L139">        })</span>
<span class="nc" id="L140">        hppViewModel.onDesignActionPressed.observe(this, Observer { design -&gt;</span>
<span class="nc" id="L141">            mainViewModel.onSiteDesignSelected(design.template)</span>
<span class="nc" id="L142">        })</span>
<span class="nc" id="L143">    }</span>

    override fun onIntentSelected(intent: String?) {
<span class="nc" id="L146">        mainViewModel.onSiteIntentSelected(intent)</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!siteNameFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L148">            ActivityUtils.hideKeyboard(this)</span>
        }
<span class="nc" id="L150">    }</span>

    override fun onSiteNameEntered(siteName: String) {
<span class="nc" id="L153">        mainViewModel.onSiteNameEntered(siteName)</span>
<span class="nc" id="L154">        ActivityUtils.hideKeyboard(this)</span>
<span class="nc" id="L155">    }</span>

    override fun onDomainSelected(domain: String) {
<span class="nc" id="L158">        mainViewModel.onDomainsScreenFinished(domain)</span>
<span class="nc" id="L159">    }</span>

    override fun onSiteCreationCompleted() {
<span class="nc" id="L162">        mainViewModel.onSiteCreationCompleted()</span>
<span class="nc" id="L163">    }</span>

    override fun onSitePreviewScreenDismissed(createSiteState: CreateSiteState) {
<span class="nc" id="L166">        mainViewModel.onSitePreviewScreenFinished(createSiteState)</span>
<span class="nc" id="L167">    }</span>

    override fun onHelpClicked(origin: Origin) {
<span class="nc" id="L170">        ActivityLauncher.viewHelpAndSupport(this, origin, null, null)</span>
<span class="nc" id="L171">    }</span>

    private fun showStep(target: WizardNavigationTarget&lt;SiteCreationStep, SiteCreationState&gt;) {
<span class="nc" id="L174">        val screenTitle = getScreenTitle(target.wizardStep)</span>
<span class="nc bnc" id="L175" title="All 5 branches missed.">        val fragment = when (target.wizardStep) {</span>
<span class="nc" id="L176">            INTENTS -&gt; SiteCreationIntentsFragment()</span>
<span class="nc" id="L177">            SITE_NAME -&gt; SiteCreationSiteNameFragment.newInstance(target.wizardState.siteIntent)</span>
            SITE_DESIGNS -&gt; {
                // Cancel preload job before displaying the theme picker.
<span class="nc bnc" id="L180" title="All 2 branches missed.">                mainViewModel.preloadingJob?.cancel(&quot;Preload did not complete before theme picker was shown.&quot;)</span>
<span class="nc" id="L181">                HomePagePickerFragment.newInstance(target.wizardState.siteIntent)</span>
            }
<span class="nc" id="L183">            DOMAINS -&gt; SiteCreationDomainsFragment.newInstance(</span>
<span class="nc" id="L184">                    screenTitle</span>
            )
<span class="nc" id="L186">            SITE_PREVIEW -&gt; SiteCreationPreviewFragment.newInstance(screenTitle, target.wizardState)</span>
        }
<span class="nc" id="L188">        slideInFragment(fragment, target.wizardStep.toString())</span>
<span class="nc" id="L189">    }</span>

    private fun getScreenTitle(step: SiteCreationStep): String {
<span class="nc" id="L192">        return when (val screenTitleData = mainViewModel.screenTitleForWizardStep(step)) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            is ScreenTitleStepCount -&gt; getString(</span>
<span class="nc" id="L194">                    screenTitleData.resId,</span>
<span class="nc" id="L195">                    screenTitleData.stepPosition,</span>
<span class="nc" id="L196">                    screenTitleData.stepsCount</span>
            )
<span class="nc bnc" id="L198" title="All 2 branches missed.">            is ScreenTitleGeneral -&gt; getString(screenTitleData.resId)</span>
<span class="nc" id="L199">            is ScreenTitleEmpty -&gt; screenTitleData.screenTitle</span>
        }
    }

    private fun slideInFragment(fragment: Fragment, tag: String) {
<span class="nc" id="L204">        val fragmentTransaction = supportFragmentManager.beginTransaction()</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (supportFragmentManager.findFragmentById(R.id.fragment_container) != null) {</span>
            // add to back stack and animate all screen except of the first one
<span class="nc" id="L207">            fragmentTransaction.addToBackStack(null).setCustomAnimations(</span>
<span class="nc" id="L208">                    R.anim.activity_slide_in_from_right, R.anim.activity_slide_out_to_left,</span>
<span class="nc" id="L209">                    R.anim.activity_slide_in_from_left, R.anim.activity_slide_out_to_right</span>
            )
        }
<span class="nc" id="L212">        fragmentTransaction.replace(R.id.fragment_container, fragment, tag)</span>
<span class="nc" id="L213">        fragmentTransaction.commit()</span>
<span class="nc" id="L214">    }</span>

    override fun onPositiveClicked(instanceTag: String) {
<span class="nc" id="L217">        mainViewModel.onPositiveDialogButtonClicked(instanceTag)</span>
<span class="nc" id="L218">    }</span>

    override fun onNegativeClicked(instanceTag: String) {
<span class="nc" id="L221">        mainViewModel.onNegativeDialogButtonClicked(instanceTag)</span>
<span class="nc" id="L222">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (item.itemId == android.R.id.home) {</span>
<span class="nc" id="L226">            onBackPressed()</span>
<span class="nc" id="L227">            return true</span>
        }
<span class="nc" id="L229">        return false</span>
    }

    override fun onBackPressed() {
<span class="nc" id="L233">        mainViewModel.onBackPressed()</span>
<span class="nc" id="L234">    }</span>

    companion object {
        const val ARG_CREATE_SITE_SOURCE = &quot;ARG_CREATE_SITE_SOURCE&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>