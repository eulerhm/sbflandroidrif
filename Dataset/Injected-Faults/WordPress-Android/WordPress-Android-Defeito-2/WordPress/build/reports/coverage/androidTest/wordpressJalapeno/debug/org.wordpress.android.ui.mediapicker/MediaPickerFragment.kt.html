<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaPickerFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.mediapicker</a> &gt; <span class="el_source">MediaPickerFragment.kt</span></div><h1>MediaPickerFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.mediapicker

import android.Manifest.permission
import android.app.Activity
import android.content.Intent.ACTION_GET_CONTENT
import android.content.Intent.ACTION_OPEN_DOCUMENT
import android.net.Uri
import android.os.Bundle
import android.os.Parcelable
import android.text.Html
import android.view.LayoutInflater
import android.view.Menu
import android.view.MenuInflater
import android.view.MenuItem
import android.view.MenuItem.OnActionExpandListener
import android.view.View
import android.view.ViewGroup
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AlertDialog.Builder
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.widget.SearchView
import androidx.fragment.app.Fragment
import androidx.lifecycle.Observer
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewModelScope
import androidx.recyclerview.widget.GridLayoutManager
import androidx.recyclerview.widget.GridLayoutManager.SpanSizeLookup
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.MediaPickerFragmentBinding
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.media.MediaPreviewActivity
import org.wordpress.android.ui.mediapicker.MediaItem.Identifier
import org.wordpress.android.ui.mediapicker.MediaNavigationEvent.EditMedia
import org.wordpress.android.ui.mediapicker.MediaNavigationEvent.Exit
import org.wordpress.android.ui.mediapicker.MediaNavigationEvent.IconClickEvent
import org.wordpress.android.ui.mediapicker.MediaNavigationEvent.InsertMedia
import org.wordpress.android.ui.mediapicker.MediaNavigationEvent.PreviewMedia
import org.wordpress.android.ui.mediapicker.MediaNavigationEvent.PreviewUrl
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerIconType.ANDROID_CHOOSE_FROM_DEVICE
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerIconType.CAPTURE_PHOTO
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerIconType.SWITCH_SOURCE
import org.wordpress.android.ui.mediapicker.MediaPickerFragment.MediaPickerIconType.WP_STORIES_CAPTURE
import org.wordpress.android.ui.mediapicker.MediaPickerSetup.DataSource
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.ActionModeUiModel
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.BrowseMenuUiModel.BrowseAction.DEVICE
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.BrowseMenuUiModel.BrowseAction.GIF_LIBRARY
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.BrowseMenuUiModel.BrowseAction.STOCK_LIBRARY
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.BrowseMenuUiModel.BrowseAction.SYSTEM_PICKER
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.BrowseMenuUiModel.BrowseAction.WP_MEDIA_LIBRARY
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.FabUiModel
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.PermissionsRequested.CAMERA
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.PermissionsRequested.STORAGE
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.PhotoListUiModel
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.ProgressDialogUiModel
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.ProgressDialogUiModel.Visible
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.SearchUiModel
import org.wordpress.android.ui.mediapicker.MediaPickerViewModel.SoftAskViewUiModel
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.util.AccessibilityUtils
import org.wordpress.android.util.AniUtils
import org.wordpress.android.util.AniUtils.Duration.MEDIUM
import org.wordpress.android.util.SnackbarItem
import org.wordpress.android.util.SnackbarItem.Action
import org.wordpress.android.util.SnackbarItem.Info
import org.wordpress.android.util.SnackbarSequencer
import org.wordpress.android.util.UriWrapper
import org.wordpress.android.util.WPLinkMovementMethod
import org.wordpress.android.util.WPMediaUtils
import org.wordpress.android.util.WPPermissionUtils
import org.wordpress.android.util.WPSwipeToRefreshHelper
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

<span class="nc" id="L81">class MediaPickerFragment : Fragment() {</span>
    enum class MediaPickerIconType {
<span class="nc" id="L83">        ANDROID_CHOOSE_FROM_DEVICE,</span>
<span class="nc" id="L84">        SWITCH_SOURCE,</span>
<span class="nc" id="L85">        WP_STORIES_CAPTURE,</span>
<span class="nc" id="L86">        CAPTURE_PHOTO;</span>

        companion object {
            @JvmStatic
            fun fromNameString(iconTypeName: String): MediaPickerIconType {
<span class="nc bnc" id="L91" title="All 4 branches missed.">                return values().firstOrNull { it.name == iconTypeName }</span>
<span class="nc" id="L92">                        ?: throw IllegalArgumentException(&quot;MediaPickerIconType not found with name $iconTypeName&quot;)</span>
            }
        }
    }

<span class="nc" id="L97">    enum class ChooserContext(</span>
<span class="nc" id="L98">        val intentAction: String,</span>
<span class="nc" id="L99">        val title: UiStringRes,</span>
<span class="nc" id="L100">        val mediaTypeFilter: String</span>
    ) {
<span class="nc" id="L102">        PHOTO(ACTION_GET_CONTENT, UiStringRes(R.string.pick_photo), &quot;image/*&quot;),</span>
<span class="nc" id="L103">        VIDEO(ACTION_GET_CONTENT, UiStringRes(R.string.pick_video), &quot;video/*&quot;),</span>
<span class="nc" id="L104">        PHOTO_OR_VIDEO(ACTION_GET_CONTENT, UiStringRes(R.string.pick_media), &quot;*/*&quot;),</span>
<span class="nc" id="L105">        AUDIO(ACTION_GET_CONTENT, UiStringRes(R.string.pick_audio), &quot;*/*&quot;),</span>
<span class="nc" id="L106">        MEDIA_FILE(ACTION_OPEN_DOCUMENT, UiStringRes(R.string.pick_file), &quot;*/*&quot;);</span>
    }

    sealed class MediaPickerAction {
<span class="nc" id="L110">        data class OpenSystemPicker(</span>
<span class="nc" id="L111">            val chooserContext: ChooserContext,</span>
<span class="nc" id="L112">            val mimeTypes: List&lt;String&gt;,</span>
<span class="nc" id="L113">            val allowMultipleSelection: Boolean</span>
<span class="nc" id="L114">        ) : MediaPickerAction()</span>

<span class="nc" id="L116">        data class OpenCameraForWPStories(val allowMultipleSelection: Boolean) : MediaPickerAction()</span>
<span class="nc" id="L117">        object OpenCameraForPhotos : MediaPickerAction()</span>
<span class="nc" id="L118">        data class SwitchMediaPicker(val mediaPickerSetup: MediaPickerSetup) : MediaPickerAction()</span>
    }

<span class="nc" id="L121">    sealed class MediaPickerIcon(val type: MediaPickerIconType) {</span>
<span class="nc" id="L122">        data class ChooseFromAndroidDevice(</span>
<span class="nc" id="L123">            val allowedTypes: Set&lt;MediaType&gt;</span>
<span class="nc" id="L124">        ) : MediaPickerIcon(ANDROID_CHOOSE_FROM_DEVICE)</span>

<span class="nc" id="L126">        data class SwitchSource(val dataSource: DataSource) : MediaPickerIcon(SWITCH_SOURCE)</span>

<span class="nc" id="L128">        object WpStoriesCapture : MediaPickerIcon(WP_STORIES_CAPTURE)</span>
<span class="nc" id="L129">        object CapturePhoto : MediaPickerIcon(CAPTURE_PHOTO)</span>

        fun toBundle(bundle: Bundle) {
<span class="nc" id="L132">            bundle.putString(KEY_LAST_TAPPED_ICON, type.name)</span>
<span class="nc" id="L133">            when (this) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">                is ChooseFromAndroidDevice -&gt; {</span>
<span class="nc" id="L135">                    bundle.putStringArrayList(</span>
<span class="nc" id="L136">                            KEY_LAST_TAPPED_ICON_ALLOWED_TYPES,</span>
<span class="nc" id="L137">                            ArrayList(allowedTypes.map { it.name })</span>
                    )
                }
<span class="nc bnc" id="L140" title="All 2 branches missed.">                is SwitchSource -&gt; {</span>
<span class="nc" id="L141">                    bundle.putInt(KEY_LAST_TAPPED_ICON_DATA_SOURCE, this.dataSource.ordinal)</span>
                }
            }
<span class="nc" id="L144">        }</span>

        companion object {
            @JvmStatic
            fun fromBundle(bundle: Bundle): MediaPickerIcon? {
<span class="nc bnc" id="L149" title="All 2 branches missed.">                val iconTypeName = bundle.getString(KEY_LAST_TAPPED_ICON) ?: return null</span>

<span class="nc bnc" id="L151" title="All 4 branches missed.">                return when (iconTypeName.let { MediaPickerIconType.fromNameString(iconTypeName) }) {</span>
                    ANDROID_CHOOSE_FROM_DEVICE -&gt; {
<span class="nc bnc" id="L153" title="All 2 branches missed.">                        val allowedTypes = (bundle.getStringArrayList(KEY_LAST_TAPPED_ICON_ALLOWED_TYPES)</span>
<span class="nc" id="L154">                                ?: listOf&lt;String&gt;()).map {</span>
<span class="nc" id="L155">                            MediaType.valueOf(</span>
<span class="nc" id="L156">                                    it</span>
                            )
<span class="nc" id="L158">                        }.toSet()</span>
<span class="nc" id="L159">                        ChooseFromAndroidDevice(allowedTypes)</span>
                    }
<span class="nc" id="L161">                    WP_STORIES_CAPTURE -&gt; WpStoriesCapture</span>
<span class="nc" id="L162">                    CAPTURE_PHOTO -&gt; CapturePhoto</span>
                    SWITCH_SOURCE -&gt; {
<span class="nc" id="L164">                        val ordinal = bundle.getInt(KEY_LAST_TAPPED_ICON_DATA_SOURCE, -1)</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                        if (ordinal != -1) {</span>
<span class="nc" id="L166">                            val dataSource = DataSource.values()[ordinal]</span>
<span class="nc" id="L167">                            SwitchSource(dataSource)</span>
                        } else {
<span class="nc" id="L169">                            null</span>
                        }
                    }
                }
            }
        }
    }

    /*
     * parent activity must implement this listener
     */
    interface MediaPickerListener {
        fun onItemsChosen(identifiers: List&lt;Identifier&gt;)
        fun onIconClicked(action: MediaPickerAction)
    }

    private var listener: MediaPickerListener? = null

<span class="nc bnc" id="L187" title="All 2 branches missed.">    @Inject lateinit var imageManager: ImageManager</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">    @Inject lateinit var snackbarSequencer: SnackbarSequencer</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
    private lateinit var viewModel: MediaPickerViewModel
    private var binding: MediaPickerFragmentBinding? = null

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L195">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc" id="L197">        viewModel = ViewModelProvider(this, viewModelFactory).get(MediaPickerViewModel::class.java)</span>
<span class="nc" id="L198">        setHasOptionsMenu(true)</span>
<span class="nc" id="L199">    }</span>

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
<span class="nc" id="L206">        return inflater.inflate(</span>
<span class="nc" id="L207">                R.layout.media_picker_fragment,</span>
<span class="nc" id="L208">                container,</span>
<span class="nc" id="L209">                false</span>
        )
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L214">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc" id="L216">        val mediaPickerSetup = MediaPickerSetup.fromBundle(requireArguments())</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        val site = requireArguments().getSerializable(WordPress.SITE) as? SiteModel</span>
<span class="nc" id="L218">        var selectedIds: List&lt;Identifier&gt;? = null</span>
<span class="nc" id="L219">        var lastTappedIcon: MediaPickerIcon? = null</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L221">            lastTappedIcon = MediaPickerIcon.fromBundle(savedInstanceState)</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (savedInstanceState.containsKey(KEY_SELECTED_IDS)) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                selectedIds = savedInstanceState.getParcelableArrayList&lt;Identifier&gt;(KEY_SELECTED_IDS)?.map { it }</span>
            }
        }

<span class="nc" id="L227">        val layoutManager = GridLayoutManager(</span>
<span class="nc" id="L228">                activity,</span>
<span class="nc" id="L229">                NUM_COLUMNS</span>
        )

<span class="nc bnc" id="L232" title="All 4 branches missed.">        savedInstanceState?.getParcelable&lt;Parcelable&gt;(KEY_LIST_STATE)?.let {</span>
<span class="nc" id="L233">            layoutManager.onRestoreInstanceState(it)</span>
<span class="nc" id="L234">        }</span>
<span class="nc" id="L235">        with(MediaPickerFragmentBinding.bind(view)) {</span>
<span class="nc" id="L236">            binding = this</span>
<span class="nc" id="L237">            recycler.layoutManager = layoutManager</span>
<span class="nc" id="L238">            recycler.setEmptyView(actionableEmptyView)</span>
<span class="nc" id="L239">            recycler.setHasFixedSize(true)</span>

<span class="nc" id="L241">            val swipeToRefreshHelper = WPSwipeToRefreshHelper.buildSwipeToRefreshHelper(pullToRefresh) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                viewModel.onPullToRefresh()</span>
<span class="nc" id="L243">            }</span>

<span class="nc" id="L245">            var isShowingActionMode = false</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            viewModel.uiState.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                it?.let { uiState -&gt;</span>
<span class="nc" id="L248">                    setupPhotoList(uiState.photoListUiModel)</span>
<span class="nc" id="L249">                    setupSoftAskView(uiState.softAskViewUiModel)</span>
<span class="nc bnc" id="L250" title="All 4 branches missed.">                    if (uiState.actionModeUiModel is ActionModeUiModel.Visible &amp;&amp; !isShowingActionMode) {</span>
<span class="nc" id="L251">                        isShowingActionMode = true</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                        (activity as AppCompatActivity).startSupportActionMode(</span>
<span class="nc" id="L253">                                MediaPickerActionModeCallback(</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                                        viewModel</span>
                                )
                        )
<span class="nc bnc" id="L257" title="All 4 branches missed.">                    } else if (uiState.actionModeUiModel is ActionModeUiModel.Hidden &amp;&amp; isShowingActionMode) {</span>
<span class="nc" id="L258">                        isShowingActionMode = false</span>
                    }
<span class="nc" id="L260">                    setupFab(uiState.fabUiModel)</span>
<span class="nc" id="L261">                    swipeToRefreshHelper.isRefreshing = uiState.isRefreshing</span>
<span class="nc" id="L262">                }</span>
<span class="nc" id="L263">            })</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">            viewModel.onNavigate.observeEvent(viewLifecycleOwner,</span>
                    { navigationEvent -&gt;
<span class="nc" id="L267">                        when (navigationEvent) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                            is PreviewUrl -&gt; {</span>
<span class="nc" id="L269">                                MediaPreviewActivity.showPreview(</span>
<span class="nc" id="L270">                                        requireContext(),</span>
<span class="nc" id="L271">                                        null,</span>
<span class="nc" id="L272">                                        navigationEvent.url</span>
                                )
<span class="nc" id="L274">                                AccessibilityUtils.setActionModeDoneButtonContentDescription(</span>
<span class="nc" id="L275">                                        activity,</span>
<span class="nc" id="L276">                                        getString(R.string.cancel)</span>
                                )
                            }
<span class="nc bnc" id="L279" title="All 2 branches missed.">                            is PreviewMedia -&gt; MediaPreviewActivity.showPreview(</span>
<span class="nc" id="L280">                                    requireContext(),</span>
<span class="nc" id="L281">                                    null,</span>
<span class="nc" id="L282">                                    navigationEvent.media,</span>
<span class="nc" id="L283">                                    null</span>
                            )
<span class="nc bnc" id="L285" title="All 2 branches missed.">                            is EditMedia -&gt; {</span>
<span class="nc" id="L286">                                val inputData = WPMediaUtils.createListOfEditImageInputData(</span>
<span class="nc" id="L287">                                        requireContext(),</span>
<span class="nc" id="L288">                                        navigationEvent.uris.map { wrapper -&gt; wrapper.uri }</span>
                                )
<span class="nc" id="L290">                                ActivityLauncher.openImageEditor(activity, inputData)</span>
                            }
<span class="nc bnc" id="L292" title="All 4 branches missed.">                            is InsertMedia -&gt; listener?.onItemsChosen(navigationEvent.identifiers)</span>
<span class="nc bnc" id="L293" title="All 4 branches missed.">                            is IconClickEvent -&gt; listener?.onIconClicked(navigationEvent.action)</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                            Exit -&gt; {</span>
<span class="nc" id="L295">                                val activity = requireActivity()</span>
<span class="nc" id="L296">                                activity.setResult(Activity.RESULT_CANCELED)</span>
<span class="nc" id="L297">                                activity.finish()</span>
                            }
                        }
<span class="nc" id="L300">                    })</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">            viewModel.onPermissionsRequested.observeEvent(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L303" title="All 3 branches missed.">                when (it) {</span>
<span class="nc" id="L304">                    CAMERA -&gt; requestCameraPermission()</span>
<span class="nc" id="L305">                    STORAGE -&gt; requestStoragePermission()</span>
                }
<span class="nc" id="L307">            })</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            viewModel.onSnackbarMessage.observeEvent(viewLifecycleOwner, { messageHolder -&gt;</span>
<span class="nc" id="L309">                showSnackbar(messageHolder)</span>
<span class="nc" id="L310">            })</span>

<span class="nc" id="L312">            setupProgressDialog()</span>

<span class="nc bnc" id="L314" title="All 2 branches missed.">            viewModel.start(selectedIds, mediaPickerSetup, lastTappedIcon, site)</span>
<span class="nc" id="L315">        }</span>
<span class="nc" id="L316">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L319">        super.onDestroyView()</span>
<span class="nc" id="L320">        binding = null</span>
<span class="nc" id="L321">    }</span>

    override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
<span class="nc" id="L324">        super.onCreateOptionsMenu(menu, inflater)</span>
<span class="nc" id="L325">        inflater.inflate(R.menu.menu_media_picker, menu)</span>

<span class="nc bnc" id="L327" title="All 2 branches missed.">        val searchMenuItem = checkNotNull(menu.findItem(R.id.action_search)) {</span>
<span class="nc" id="L328">            &quot;Menu does not contain mandatory search item&quot;</span>
        }
<span class="nc bnc" id="L330" title="All 2 branches missed.">        val browseMenuItem = checkNotNull(menu.findItem(R.id.mnu_browse_item)) {</span>
<span class="nc" id="L331">            &quot;Menu does not contain mandatory browse item&quot;</span>
        }
<span class="nc bnc" id="L333" title="All 2 branches missed.">        val mediaLibraryMenuItem = checkNotNull(menu.findItem(R.id.mnu_choose_from_media_library)) {</span>
<span class="nc" id="L334">            &quot;Menu does not contain mandatory media library item&quot;</span>
        }
<span class="nc bnc" id="L336" title="All 2 branches missed.">        val deviceMenuItem = checkNotNull(menu.findItem(R.id.mnu_choose_from_device)) {</span>
<span class="nc" id="L337">            &quot;Menu does not contain device library item&quot;</span>
        }
<span class="nc bnc" id="L339" title="All 2 branches missed.">        val stockLibraryMenuItem = checkNotNull(menu.findItem(R.id.mnu_choose_from_stock_library)) {</span>
<span class="nc" id="L340">            &quot;Menu does not contain mandatory stock library item&quot;</span>
        }
<span class="nc bnc" id="L342" title="All 2 branches missed.">        val tenorLibraryMenuItem = checkNotNull(menu.findItem(R.id.mnu_choose_from_tenor_library)) {</span>
<span class="nc" id="L343">            &quot;Menu does not contain mandatory tenor library item&quot;</span>
        }

<span class="nc" id="L346">        initializeSearchView(searchMenuItem)</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner, Observer { uiState -&gt;</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            val searchView = searchMenuItem.actionView as SearchView</span>

<span class="nc bnc" id="L350" title="All 4 branches missed.">            if (uiState.searchUiModel is SearchUiModel.Expanded &amp;&amp; !searchMenuItem.isActionViewExpanded) {</span>
<span class="nc" id="L351">                searchMenuItem.expandActionView()</span>
<span class="nc" id="L352">                searchView.maxWidth = Integer.MAX_VALUE</span>
<span class="nc" id="L353">                searchView.setQuery(uiState.searchUiModel.filter, true)</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                searchView.setOnCloseListener { !uiState.searchUiModel.closeable }</span>
<span class="nc bnc" id="L355" title="All 4 branches missed.">            } else if (uiState.searchUiModel is SearchUiModel.Collapsed &amp;&amp; searchMenuItem.isActionViewExpanded) {</span>
<span class="nc" id="L356">                searchMenuItem.collapseActionView()</span>
            }

<span class="nc bnc" id="L359" title="All 2 branches missed.">            searchMenuItem.isVisible = uiState.searchUiModel !is SearchUiModel.Hidden</span>

<span class="nc" id="L361">            val shownActions = uiState.browseMenuUiModel.shownActions</span>
<span class="nc" id="L362">            browseMenuItem.isVisible = shownActions.contains(SYSTEM_PICKER)</span>
<span class="nc" id="L363">            mediaLibraryMenuItem.isVisible = shownActions.contains(WP_MEDIA_LIBRARY)</span>
<span class="nc" id="L364">            deviceMenuItem.isVisible = shownActions.contains(DEVICE)</span>
<span class="nc" id="L365">            stockLibraryMenuItem.isVisible = shownActions.contains(STOCK_LIBRARY)</span>
<span class="nc" id="L366">            tenorLibraryMenuItem.isVisible = shownActions.contains(GIF_LIBRARY)</span>
<span class="nc" id="L367">        })</span>
<span class="nc" id="L368">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L371" title="All 6 branches missed.">        when (item.itemId) {</span>
            R.id.mnu_browse_item -&gt; {
<span class="nc bnc" id="L373" title="All 2 branches missed.">                viewModel.onMenuItemClicked(SYSTEM_PICKER)</span>
            }
            R.id.mnu_choose_from_media_library -&gt; {
<span class="nc bnc" id="L376" title="All 2 branches missed.">                viewModel.onMenuItemClicked(WP_MEDIA_LIBRARY)</span>
            }
            R.id.mnu_choose_from_device -&gt; {
<span class="nc bnc" id="L379" title="All 2 branches missed.">                viewModel.onMenuItemClicked(DEVICE)</span>
            }
            R.id.mnu_choose_from_stock_library -&gt; {
<span class="nc bnc" id="L382" title="All 2 branches missed.">                viewModel.onMenuItemClicked(STOCK_LIBRARY)</span>
            }
            R.id.mnu_choose_from_tenor_library -&gt; {
<span class="nc bnc" id="L385" title="All 2 branches missed.">                viewModel.onMenuItemClicked(GIF_LIBRARY)</span>
            }
        }
<span class="nc" id="L388">        return true</span>
    }

    fun urisSelectedFromSystemPicker(uris: List&lt;Uri&gt;) {
<span class="nc bnc" id="L392" title="All 2 branches missed.">        viewModel.urisSelectedFromSystemPicker(uris.map { UriWrapper(it) })</span>
<span class="nc" id="L393">    }</span>

    private fun initializeSearchView(actionMenuItem: MenuItem) {
<span class="nc" id="L396">        var isExpanding = false</span>
<span class="nc" id="L397">        actionMenuItem.setOnActionExpandListener(object : OnActionExpandListener {</span>
            override fun onMenuItemActionExpand(item: MenuItem?): Boolean {
<span class="nc bnc" id="L399" title="All 2 branches missed.">                viewModel.onSearchExpanded()</span>
<span class="nc" id="L400">                isExpanding = true</span>
<span class="nc" id="L401">                return true</span>
            }

            override fun onMenuItemActionCollapse(item: MenuItem?): Boolean {
<span class="nc bnc" id="L405" title="All 2 branches missed.">                viewModel.onSearchCollapsed()</span>
<span class="nc" id="L406">                return true</span>
            }
        })
<span class="nc bnc" id="L409" title="All 2 branches missed.">        val searchView = actionMenuItem.actionView as SearchView</span>
<span class="nc" id="L410">        searchView.setOnQueryTextListener(object : SearchView.OnQueryTextListener {</span>
            override fun onQueryTextSubmit(query: String): Boolean {
<span class="nc bnc" id="L412" title="All 2 branches missed.">                viewModel.onSearch(query)</span>
<span class="nc" id="L413">                return true</span>
            }

            override fun onQueryTextChange(query: String): Boolean {
<span class="nc bnc" id="L417" title="All 2 branches missed.">                if (!isExpanding) {</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                    viewModel.onSearch(query)</span>
                }
<span class="nc" id="L420">                isExpanding = false</span>
<span class="nc" id="L421">                return true</span>
            }
        })
<span class="nc" id="L424">    }</span>

    private fun MediaPickerFragmentBinding.setupSoftAskView(uiModel: SoftAskViewUiModel) {
<span class="nc" id="L427">        when (uiModel) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            is SoftAskViewUiModel.Visible -&gt; {</span>
<span class="nc" id="L429">                softAskView.title.text = Html.fromHtml(uiModel.label)</span>
<span class="nc" id="L430">                softAskView.button.setText(uiModel.allowId.stringRes)</span>
<span class="nc" id="L431">                softAskView.button.setOnClickListener {</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">                    if (uiModel.isAlwaysDenied) {</span>
<span class="nc" id="L433">                        WPPermissionUtils.showAppSettings(requireActivity())</span>
                    } else {
<span class="nc" id="L435">                        requestStoragePermission()</span>
                    }
<span class="nc" id="L437">                }</span>

<span class="nc" id="L439">                softAskView.visibility = View.VISIBLE</span>
            }
<span class="nc bnc" id="L441" title="All 2 branches missed.">            is SoftAskViewUiModel.Hidden -&gt; {</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">                if (softAskView.visibility == View.VISIBLE) {</span>
<span class="nc" id="L443">                    AniUtils.fadeOut(softAskView, MEDIUM)</span>
                }
            }
        }
<span class="nc" id="L447">    }</span>

    private fun MediaPickerFragmentBinding.setupPhotoList(uiModel: PhotoListUiModel) {
<span class="nc bnc" id="L450" title="All 2 branches missed.">        loadingView.visibility = if (uiModel == PhotoListUiModel.Loading) View.VISIBLE else View.GONE</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">        actionableEmptyView.visibility = if (uiModel is PhotoListUiModel.Empty) View.VISIBLE else View.GONE</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">        recycler.visibility = if (uiModel is PhotoListUiModel.Data) View.VISIBLE else View.INVISIBLE</span>
<span class="nc" id="L453">        when (uiModel) {</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            is PhotoListUiModel.Data -&gt; {</span>
<span class="nc" id="L455">                setupAdapter(uiModel.items)</span>
            }
<span class="nc bnc" id="L457" title="All 2 branches missed.">            is PhotoListUiModel.Empty -&gt; {</span>
<span class="nc" id="L458">                setupAdapter(listOf())</span>
<span class="nc" id="L459">                actionableEmptyView.updateLayoutForSearch(uiModel.isSearching, 0)</span>
<span class="nc" id="L460">                actionableEmptyView.title.text = uiHelpers.getTextOfUiString(requireContext(), uiModel.title)</span>

<span class="nc" id="L462">                actionableEmptyView.subtitle.applyOrHide(uiModel.htmlSubtitle) { htmlSubtitle -&gt;</span>
<span class="nc" id="L463">                    actionableEmptyView.subtitle.text = Html.fromHtml(</span>
<span class="nc" id="L464">                            uiHelpers.getTextOfUiString(</span>
<span class="nc" id="L465">                                    requireContext(),</span>
<span class="nc" id="L466">                                    htmlSubtitle</span>
<span class="nc" id="L467">                            ).toString()</span>
                    )
<span class="nc" id="L469">                    actionableEmptyView.subtitle.movementMethod = WPLinkMovementMethod.getInstance()</span>
<span class="nc" id="L470">                }</span>
<span class="nc" id="L471">                actionableEmptyView.image.applyOrHide(uiModel.image) { image -&gt;</span>
<span class="nc" id="L472">                    this.setImageResource(image)</span>
<span class="nc" id="L473">                }</span>
<span class="nc" id="L474">                actionableEmptyView.bottomImage.applyOrHide(uiModel.bottomImage) { bottomImage -&gt;</span>
<span class="nc" id="L475">                    this.setImageResource(bottomImage)</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                    if (uiModel.bottomImageDescription != null) {</span>
<span class="nc" id="L477">                        this.contentDescription = uiHelpers.getTextOfUiString(</span>
<span class="nc" id="L478">                                requireContext(),</span>
<span class="nc" id="L479">                                uiModel.bottomImageDescription</span>
<span class="nc" id="L480">                        ).toString()</span>
                    }
<span class="nc" id="L482">                }</span>
<span class="nc" id="L483">                actionableEmptyView.button.applyOrHide(uiModel.retryAction) { action -&gt;</span>
<span class="nc" id="L484">                    this.setOnClickListener {</span>
<span class="nc" id="L485">                        action()</span>
<span class="nc" id="L486">                    }</span>
<span class="nc" id="L487">                }</span>
            }
        }
<span class="nc" id="L490">    }</span>

    private fun &lt;T, U : View&gt; U.applyOrHide(item: T?, action: U.(T) -&gt; Unit) {
<span class="nc bnc" id="L493" title="All 2 branches missed.">        if (item != null) {</span>
<span class="nc" id="L494">            this.visibility = View.VISIBLE</span>
<span class="nc" id="L495">            this.action(item)</span>
        } else {
<span class="nc" id="L497">            this.visibility = View.GONE</span>
        }
<span class="nc" id="L499">    }</span>

    private fun MediaPickerFragmentBinding.setupAdapter(items: List&lt;MediaPickerUiItem&gt;) {
<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (recycler.adapter == null) {</span>
<span class="nc" id="L503">            recycler.adapter = MediaPickerAdapter(</span>
<span class="nc" id="L504">                    imageManager,</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                    viewModel.viewModelScope</span>
            )
        }
<span class="nc bnc" id="L508" title="All 2 branches missed.">        val adapter = recycler.adapter as MediaPickerAdapter</span>

<span class="nc bnc" id="L510" title="All 4 branches missed.">        (recycler.layoutManager as? GridLayoutManager)?.spanSizeLookup =</span>
<span class="nc" id="L511">                object : SpanSizeLookup() {</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">                    override fun getSpanSize(position: Int) = if (items[position].fullWidthItem) {</span>
<span class="nc" id="L513">                        NUM_COLUMNS</span>
                    } else {
<span class="nc" id="L515">                        1</span>
<span class="nc" id="L516">                    }</span>
                }
<span class="nc bnc" id="L518" title="All 2 branches missed.">        val recyclerViewState = recycler.layoutManager?.onSaveInstanceState()</span>
<span class="nc" id="L519">        adapter.loadData(items)</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">        recycler.layoutManager?.onRestoreInstanceState(recyclerViewState)</span>
<span class="nc" id="L521">    }</span>

    private fun MediaPickerFragmentBinding.setupFab(fabUiModel: FabUiModel) {
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (fabUiModel.show) {</span>
<span class="nc" id="L525">            fabTakePicture.show()</span>
<span class="nc" id="L526">            fabTakePicture.setOnClickListener {</span>
<span class="nc" id="L527">                fabUiModel.action()</span>
<span class="nc" id="L528">            }</span>
        } else {
<span class="nc" id="L530">            fabTakePicture.hide()</span>
        }
<span class="nc" id="L532">    }</span>

    private fun setupProgressDialog() {
<span class="nc" id="L535">        var progressDialog: AlertDialog? = null</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L537" title="All 4 branches missed.">            it?.progressDialogUiModel?.apply {</span>
<span class="nc" id="L538">                when (this) {</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">                    is Visible -&gt; {</span>
<span class="nc bnc" id="L540" title="All 8 branches missed.">                        if (progressDialog == null || progressDialog?.isShowing == false) {</span>
<span class="nc" id="L541">                            val builder: Builder = MaterialAlertDialogBuilder(requireContext())</span>
<span class="nc" id="L542">                            builder.setTitle(this.title)</span>
<span class="nc" id="L543">                            builder.setView(R.layout.media_picker_progress_dialog)</span>
<span class="nc" id="L544">                            builder.setNegativeButton(</span>
<span class="nc" id="L545">                                    R.string.cancel</span>
<span class="nc" id="L546">                            ) { _, _ -&gt; this.cancelAction() }</span>
<span class="nc" id="L547">                            builder.setOnCancelListener { this.cancelAction() }</span>
<span class="nc" id="L548">                            builder.setCancelable(true)</span>
<span class="nc" id="L549">                            progressDialog = builder.show()</span>
                        }
                    }
<span class="nc bnc" id="L552" title="All 2 branches missed.">                    ProgressDialogUiModel.Hidden -&gt; {</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">                        progressDialog?.let { dialog -&gt;</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">                            if (dialog.isShowing) {</span>
<span class="nc" id="L555">                                dialog.dismiss()</span>
                            }
<span class="nc" id="L557">                        }</span>
                    }
                }
<span class="nc" id="L560">            }</span>
<span class="nc" id="L561">        })</span>
<span class="nc" id="L562">    }</span>

    private fun MediaPickerFragmentBinding.showSnackbar(holder: SnackbarMessageHolder) {
<span class="nc" id="L565">        snackbarSequencer.enqueue(</span>
<span class="nc" id="L566">                SnackbarItem(</span>
<span class="nc" id="L567">                        Info(</span>
<span class="nc" id="L568">                                view = coordinator,</span>
<span class="nc" id="L569">                                textRes = holder.message,</span>
<span class="nc" id="L570">                                duration = Snackbar.LENGTH_LONG</span>
                        ),
<span class="nc bnc" id="L572" title="All 2 branches missed.">                        holder.buttonTitle?.let {</span>
<span class="nc" id="L573">                            Action(</span>
<span class="nc" id="L574">                                    textRes = holder.buttonTitle,</span>
<span class="nc" id="L575">                                    clickListener = View.OnClickListener { holder.buttonAction() }</span>
                            )
                        },
<span class="nc" id="L578">                        dismissCallback = { _, event -&gt; holder.onDismissAction(event) }</span>
                )
        )
<span class="nc" id="L581">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L584">        super.onSaveInstanceState(outState)</span>
<span class="nc bnc" id="L585" title="All 4 branches missed.">        viewModel.lastTappedIcon?.toBundle(outState)</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">        val selectedIds = viewModel.selectedIdentifiers()</span>
<span class="nc bnc" id="L587" title="All 4 branches missed.">        if (selectedIds.isNotEmpty()) {</span>
<span class="nc" id="L588">            outState.putParcelableArrayList(KEY_SELECTED_IDS, ArrayList&lt;Identifier&gt;(selectedIds))</span>
        }
<span class="nc bnc" id="L590" title="All 2 branches missed.">        binding!!.recycler.layoutManager?.let {</span>
<span class="nc" id="L591">            outState.putParcelable(KEY_LIST_STATE, it.onSaveInstanceState())</span>
<span class="nc" id="L592">        }</span>
<span class="nc" id="L593">    }</span>

    override fun onResume() {
<span class="nc" id="L596">        super.onResume()</span>
<span class="nc" id="L597">        checkStoragePermission()</span>
<span class="nc" id="L598">    }</span>

    fun setMediaPickerListener(listener: MediaPickerListener?) {
<span class="nc" id="L601">        this.listener = listener</span>
<span class="nc" id="L602">    }</span>

    private val isStoragePermissionAlwaysDenied: Boolean
<span class="nc" id="L605">        get() = WPPermissionUtils.isPermissionAlwaysDenied(</span>
<span class="nc" id="L606">                requireActivity(), permission.WRITE_EXTERNAL_STORAGE</span>
<span class="nc" id="L607">        )</span>

    /*
     * load the photos if we have the necessary permission, otherwise show the &quot;soft ask&quot; view
     * which asks the user to allow the permission
     */
    private fun checkStoragePermission() {
<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L615">            return</span>
        }
<span class="nc bnc" id="L617" title="All 2 branches missed.">        viewModel.checkStoragePermission(isStoragePermissionAlwaysDenied)</span>
<span class="nc" id="L618">    }</span>

    private fun requestStoragePermission() {
<span class="nc" id="L621">        val permissions = arrayOf(permission.WRITE_EXTERNAL_STORAGE, permission.READ_EXTERNAL_STORAGE)</span>
<span class="nc" id="L622">        requestPermissions(</span>
<span class="nc" id="L623">                permissions, WPPermissionUtils.PHOTO_PICKER_STORAGE_PERMISSION_REQUEST_CODE</span>
        )
<span class="nc" id="L625">    }</span>

    private fun requestCameraPermission() {
        // in addition to CAMERA permission we also need a storage permission, to store media from the camera
<span class="nc" id="L629">        val permissions = arrayOf(</span>
<span class="nc" id="L630">                permission.CAMERA,</span>
<span class="nc" id="L631">                permission.WRITE_EXTERNAL_STORAGE</span>
        )
<span class="nc" id="L633">        requestPermissions(permissions, WPPermissionUtils.PHOTO_PICKER_CAMERA_PERMISSION_REQUEST_CODE)</span>
<span class="nc" id="L634">    }</span>

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array&lt;String&gt;,
        grantResults: IntArray
    ) {
<span class="nc bnc" id="L641" title="All 2 branches missed.">        val checkForAlwaysDenied = requestCode == WPPermissionUtils.PHOTO_PICKER_CAMERA_PERMISSION_REQUEST_CODE</span>
<span class="nc" id="L642">        val allGranted = WPPermissionUtils.setPermissionListAsked(</span>
<span class="nc" id="L643">                requireActivity(), requestCode, permissions, grantResults, checkForAlwaysDenied</span>
        )
<span class="nc bnc" id="L645" title="All 3 branches missed.">        when (requestCode) {</span>
<span class="nc" id="L646">            WPPermissionUtils.PHOTO_PICKER_STORAGE_PERMISSION_REQUEST_CODE -&gt; checkStoragePermission()</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">            WPPermissionUtils.PHOTO_PICKER_CAMERA_PERMISSION_REQUEST_CODE -&gt; if (allGranted) {</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">                viewModel.clickOnLastTappedIcon()</span>
            }
        }
<span class="nc" id="L651">    }</span>

    companion object {
        private const val KEY_LAST_TAPPED_ICON = &quot;last_tapped_icon&quot;
        private const val KEY_LAST_TAPPED_ICON_ALLOWED_TYPES = &quot;last_tapped_icon_allowed_types&quot;
        private const val KEY_LAST_TAPPED_ICON_DATA_SOURCE = &quot;last_tapped_icon_data_source&quot;
        private const val KEY_SELECTED_IDS = &quot;selected_ids&quot;
        private const val KEY_LIST_STATE = &quot;list_state&quot;
        const val NUM_COLUMNS = 3
        @JvmStatic fun newInstance(
            listener: MediaPickerListener,
            mediaPickerSetup: MediaPickerSetup,
            site: SiteModel?
        ): MediaPickerFragment {
<span class="nc" id="L665">            val args = Bundle()</span>
<span class="nc" id="L666">            mediaPickerSetup.toBundle(args)</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (site != null) {</span>
<span class="nc" id="L668">                args.putSerializable(WordPress.SITE, site)</span>
            }
<span class="nc" id="L670">            val fragment = MediaPickerFragment()</span>
<span class="nc" id="L671">            fragment.setMediaPickerListener(listener)</span>
<span class="nc" id="L672">            fragment.arguments = args</span>
<span class="nc" id="L673">            return fragment</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>