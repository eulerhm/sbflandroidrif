<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WordPressDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android</a> &gt; <span class="el_source">WordPressDB.java</span></div><h1>WordPressDB.java</h1><pre class="source lang-java linenums">package org.wordpress.android;

import android.content.ContentValues;
import android.content.Context;
import android.database.sqlite.SQLiteDatabase;

import org.wordpress.android.datasets.NotificationsTable;
import org.wordpress.android.datasets.PeopleTable;
import org.wordpress.android.datasets.PublicizeTable;
import org.wordpress.android.datasets.SiteSettingsTable;
import org.wordpress.android.datasets.UserSuggestionTable;
import org.wordpress.android.models.SiteSettingsModel;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;

public class WordPressDB {
    private static final int DATABASE_VERSION = 67;


    // Warning renaming DATABASE_NAME could break previous App backups (see: xml/backup_scheme.xml)
    private static final String DATABASE_NAME = &quot;wordpress&quot;;
    private static final String NOTES_TABLE = &quot;notes&quot;;
    private static final String THEMES_TABLE = &quot;themes&quot;;

    // add new table for QuickPress homescreen shortcuts
    private static final String CREATE_TABLE_QUICKPRESS_SHORTCUTS =
            &quot;create table if not exists quickpress_shortcuts (id integer primary key autoincrement, &quot;
            + &quot;accountId text, name text);&quot;;
    private static final String QUICKPRESS_SHORTCUTS_TABLE = &quot;quickpress_shortcuts&quot;;

    private static final String DROP_TABLE_PREFIX = &quot;DROP TABLE IF EXISTS &quot;;

    private SQLiteDatabase mDb;

    @SuppressWarnings({&quot;FallThrough&quot;})
<span class="fc" id="L44">    public WordPressDB(Context ctx) {</span>
<span class="fc" id="L45">        mDb = ctx.openOrCreateDatabase(DATABASE_NAME, 0, null);</span>

        // Create tables if they don't exist
<span class="fc" id="L48">        mDb.execSQL(CREATE_TABLE_QUICKPRESS_SHORTCUTS);</span>
<span class="fc" id="L49">        SiteSettingsTable.createTable(mDb);</span>
<span class="fc" id="L50">        UserSuggestionTable.createTables(mDb);</span>
<span class="fc" id="L51">        NotificationsTable.createTables(mDb);</span>

        // Update tables for new installs and app updates
<span class="fc" id="L54">        int currentVersion = mDb.getVersion();</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        boolean isNewInstall = (currentVersion == 0);</span>

<span class="pc bpc" id="L57" title="2 of 4 branches missed.">        if (!isNewInstall &amp;&amp; currentVersion != DATABASE_VERSION) {</span>
<span class="nc" id="L58">            AppLog.d(T.DB, &quot;upgrading database from version &quot; + currentVersion + &quot; to &quot; + DATABASE_VERSION);</span>
        }

<span class="pc bpc" id="L61" title="19 of 20 branches missed.">        switch (currentVersion) {</span>
            case 0:
                // New install
            case 1:
            case 9:
            case 10:
            case 11:
            case 12:
            case 13:
            case 14:
            case 15:
                // No longer used (preferences migration)
            case 16:
            case 17:
            case 18:
            case 19:
                // revision 20: create table &quot;notes&quot;
            case 20:
            case 21:
                // version 23 added CommentTable.java, version 24 changed the comment table schema
            case 22:
            case 23:
            case 24:
            case 25:
                // ver 26 &quot;virtually&quot; remove columns 'lastCommentId' and 'runService' from the DB
                // SQLite supports a limited subset of ALTER TABLE.
                // The ALTER TABLE command in SQLite allows the user to rename a table or to add a new column to
                // an existing table. It is not possible to rename a column, remove a column, or add or remove
                // constraints from a table.
            case 26:
                // Drop the notes table, no longer needed with Simperium.
<span class="nc" id="L92">                mDb.execSQL(DROP_TABLE_PREFIX + NOTES_TABLE);</span>
            case 27:
            case 28:
                // Remove WordPress.com credentials
                // NOPE: removeWPComCredentials();
            case 29:
            case 30:
            case 31:
            case 32:
            case 33:
            case 34:
            case 35:
                // Delete simperium DB - from 4.6 to 4.6.1
                // Fix an issue when note id &gt; MAX_INT
<span class="nc" id="L106">                ctx.deleteDatabase(&quot;simperium-store&quot;);</span>
            case 36:
                // Delete simperium DB again - from 4.6.1 to 4.7
                // Fix a sync issue happening for users who have both wpios and wpandroid active clients
<span class="nc" id="L110">                ctx.deleteDatabase(&quot;simperium-store&quot;);</span>
            case 37:
            case 38:
            case 39:
            case 40:
            case 41:
            case 42:
            case 43:
            case 44:
<span class="nc" id="L119">                PeopleTable.createTables(mDb);</span>
            case 45:
            case 46:
            case 47:
<span class="nc" id="L123">                PeopleTable.reset(mDb);</span>
            case 48:
<span class="nc" id="L125">                PeopleTable.createViewersTable(mDb);</span>
            case 49:
                // Delete simperium DB since we're removing Simperium from the app.
<span class="nc" id="L128">                ctx.deleteDatabase(&quot;simperium-store&quot;);</span>
            case 50:
                // fix #5373 - no op
            case 51:
                // no op - was SiteSettingsTable.addOptimizedImageToSiteSettingsTable(db);
            case 52:
                // no op - was used for old image optimization settings
            case 53:
                // Clean up empty cache files caused by #5417
<span class="nc" id="L137">                clearEmptyCacheFiles(ctx);</span>
            case 54:
                // no op - was used for old image optimization settings
            case 55:
<span class="nc" id="L141">                SiteSettingsTable.addSharingColumnsToSiteSettingsTable(mDb);</span>
            case 56:
                // no op - was used for old video optimization settings
            case 57:
                // Migrate media optimization settings
<span class="nc" id="L146">                SiteSettingsTable.migrateMediaOptimizeSettings(mDb);</span>
            case 58:
                // ThemeStore merged, remove deprecated themes tables
<span class="nc" id="L149">                mDb.execSQL(DROP_TABLE_PREFIX + THEMES_TABLE);</span>
            case 59:
                // Enable Aztec for all users
<span class="nc" id="L152">                AppPrefs.setAztecEditorEnabled(true);</span>
            case 60:
                // add Start of Week site setting as part of #betterjetpackxp
<span class="nc" id="L155">                mDb.execSQL(SiteSettingsModel.ADD_START_OF_WEEK);</span>
            case 61:
                // add date &amp; time format site setting as part of #betterjetpackxp
<span class="nc" id="L158">                mDb.execSQL(SiteSettingsModel.ADD_TIME_FORMAT);</span>
<span class="nc" id="L159">                mDb.execSQL(SiteSettingsModel.ADD_DATE_FORMAT);</span>
            case 62:
                // add timezone and posts per page site setting as part of #betterjetpackxp
<span class="nc" id="L162">                mDb.execSQL(SiteSettingsModel.ADD_TIMEZONE);</span>
<span class="nc" id="L163">                mDb.execSQL(SiteSettingsModel.ADD_POSTS_PER_PAGE);</span>
            case 63:
                // add AMP site setting as part of #betterjetpackxp
<span class="nc" id="L166">                mDb.execSQL(SiteSettingsModel.ADD_AMP_SUPPORTED);</span>
<span class="nc" id="L167">                mDb.execSQL(SiteSettingsModel.ADD_AMP_ENABLED);</span>
            case 64:
                // add site icon
<span class="nc" id="L170">                mDb.execSQL(SiteSettingsModel.ADD_SITE_ICON);</span>
            case 65:
                // add external users only to publicize services table
<span class="nc" id="L173">                PublicizeTable.resetServicesTable(mDb);</span>
            case 66:
                // add Jetpack search site setting
<span class="nc" id="L176">                mDb.execSQL(SiteSettingsModel.ADD_JETPACK_SEARCH_SUPPORTED);</span>
<span class="nc" id="L177">                mDb.execSQL(SiteSettingsModel.ADD_JETPACK_SEARCH_ENABLED);</span>
        }
<span class="fc" id="L179">        mDb.setVersion(DATABASE_VERSION);</span>
<span class="fc" id="L180">    }</span>

    public SQLiteDatabase getDatabase() {
<span class="nc" id="L183">        return mDb;</span>
    }

    public static void deleteDatabase(Context ctx) {
<span class="nc" id="L187">        ctx.deleteDatabase(DATABASE_NAME);</span>
<span class="nc" id="L188">    }</span>

    public boolean addQuickPressShortcut(int blogId, String name) {
<span class="nc" id="L191">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L192">        values.put(&quot;accountId&quot;, blogId);</span>
<span class="nc" id="L193">        values.put(&quot;name&quot;, name);</span>
<span class="nc" id="L194">        boolean returnValue = false;</span>
<span class="nc" id="L195">        synchronized (this) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">            returnValue = mDb.insert(QUICKPRESS_SHORTCUTS_TABLE, null, values) &gt; 0;</span>
<span class="nc" id="L197">        }</span>

<span class="nc" id="L199">        return (returnValue);</span>
    }

    /*
     * used during development to copy database to SD card so we can access it via DDMS
     */
    protected void copyDatabase() {
<span class="nc" id="L206">        String copyFrom = mDb.getPath();</span>
<span class="nc" id="L207">        String copyTo =</span>
<span class="nc" id="L208">                WordPress.getContext().getExternalFilesDir(null).getAbsolutePath() + &quot;/&quot; + DATABASE_NAME + &quot;.db&quot;;</span>

        try {
<span class="nc" id="L211">            InputStream input = new FileInputStream(copyFrom);</span>
<span class="nc" id="L212">            OutputStream output = new FileOutputStream(copyTo);</span>

<span class="nc" id="L214">            byte[] buffer = new byte[1024];</span>
            int length;
<span class="nc bnc" id="L216" title="All 2 branches missed.">            while ((length = input.read(buffer)) &gt; 0) {</span>
<span class="nc" id="L217">                output.write(buffer, 0, length);</span>
            }

<span class="nc" id="L220">            output.flush();</span>
<span class="nc" id="L221">            output.close();</span>
<span class="nc" id="L222">            input.close();</span>
<span class="nc" id="L223">        } catch (IOException e) {</span>
<span class="nc" id="L224">            AppLog.e(T.DB, &quot;failed to copy database&quot;, e);</span>
<span class="nc" id="L225">        }</span>
<span class="nc" id="L226">    }</span>

    private void clearEmptyCacheFiles(Context context) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (android.os.Environment.getExternalStorageState().equals(android.os.Environment.MEDIA_MOUNTED)) {</span>
<span class="nc" id="L230">            File imageCacheDir = new File(android.os.Environment.getExternalStorageDirectory() + &quot;/WordPress/images&quot;);</span>
<span class="nc" id="L231">            File videoCacheDir = new File(android.os.Environment.getExternalStorageDirectory() + &quot;/WordPress/video&quot;);</span>

<span class="nc" id="L233">            deleteEmptyFilesInDirectory(imageCacheDir);</span>
<span class="nc" id="L234">            deleteEmptyFilesInDirectory(videoCacheDir);</span>
<span class="nc" id="L235">        } else {</span>
<span class="nc" id="L236">            File cacheDir = context.getApplicationContext().getCacheDir();</span>
<span class="nc" id="L237">            deleteEmptyFilesInDirectory(cacheDir);</span>
        }
<span class="nc" id="L239">    }</span>

    @SuppressWarnings(&quot;ResultOfMethodCallIgnored&quot;)
    private void deleteEmptyFilesInDirectory(File directory) {
<span class="nc bnc" id="L243" title="All 6 branches missed.">        if (directory == null || !directory.exists() || directory.listFiles() == null) {</span>
<span class="nc" id="L244">            return;</span>
        }

<span class="nc bnc" id="L247" title="All 2 branches missed.">        for (File file : directory.listFiles()) {</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() == 0) {</span>
<span class="nc" id="L249">                file.delete();</span>
            }
        }
<span class="nc" id="L252">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>