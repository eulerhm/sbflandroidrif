<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommentNotificationsBottomSheetFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader</a> &gt; <span class="el_source">CommentNotificationsBottomSheetFragment.kt</span></div><h1>CommentNotificationsBottomSheetFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader

import android.content.Context
import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.appcompat.widget.SwitchCompat
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.ViewModelStoreOwner
import com.google.android.material.bottomsheet.BottomSheetBehavior
import com.google.android.material.bottomsheet.BottomSheetDialog
import com.google.android.material.bottomsheet.BottomSheetDialogFragment
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.CommentNotificationsBottomSheetBinding
import org.wordpress.android.ui.reader.viewmodels.ConversationNotificationsViewModel
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.viewmodel.ContextProvider
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.widgets.WPSnackbar
import javax.inject.Inject

<span class="nc" id="L25">class CommentNotificationsBottomSheetFragment : BottomSheetDialogFragment() {</span>
<span class="nc bnc" id="L26" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L27" title="All 2 branches missed.">    @Inject lateinit var contextProvider: ContextProvider</span>
<span class="nc bnc" id="L28" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
    private lateinit var viewModel: ConversationNotificationsViewModel

    // this avoids a weird animation when opening this dialog from activity that is using
    // @style/WordPress.NoActionBar.TranslucentStatus
    override fun getTheme(): Int {
<span class="nc" id="L34">        return R.style.WordPress_BottomSheetDialogTheme_NonTranslucent</span>
    }

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
<span class="nc" id="L38">        return inflater.inflate(R.layout.comment_notifications_bottom_sheet, container)</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L42">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc" id="L44">        with(CommentNotificationsBottomSheetBinding.bind(view)) {</span>
<span class="nc" id="L45">            val isReceivingPushNotifications = requireArguments().getBoolean(ARG_IS_RECEIVING_PUSH_NOTIFICATIONS)</span>
<span class="nc" id="L46">            val isAttachedToFragment = requireArguments().getBoolean(ARG_IS_ATTACHED_TO_FRAGMENT)</span>

<span class="nc" id="L48">            initViewModel(isAttachedToFragment)</span>

<span class="nc bnc" id="L50" title="All 2 branches missed.">            if (savedInstanceState == null) {</span>
<span class="nc" id="L51">                enablePushNotifications.isChecked = isReceivingPushNotifications</span>
            }

<span class="nc" id="L54">            unfollowConversation.setOnClickListener {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">                viewModel.onUnfollowTapped()</span>
<span class="nc" id="L56">            }</span>

<span class="nc" id="L58">            enablePushNotifications.setOnClickListener {</span>
<span class="nc bnc" id="L59" title="All 4 branches missed.">                viewModel.onChangePushNotificationsRequest((it as SwitchCompat).isChecked)</span>
<span class="nc" id="L60">            }</span>

<span class="nc" id="L62">            initObservers()</span>
<span class="nc" id="L63">        }</span>

<span class="nc bnc" id="L65" title="All 4 branches missed.">        (dialog as? BottomSheetDialog)?.apply {</span>
<span class="nc" id="L66">            behavior.state = BottomSheetBehavior.STATE_EXPANDED</span>
<span class="nc" id="L67">            behavior.skipCollapsed = true</span>
<span class="nc" id="L68">        }</span>
<span class="nc" id="L69">    }</span>

    private fun initViewModel(isAttachedToFragment: Boolean) {
<span class="nc" id="L72">        viewModel = ViewModelProvider(</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">                if (isAttachedToFragment) {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">                    parentFragment as ViewModelStoreOwner</span>
<span class="nc" id="L75">                } else {</span>
<span class="nc" id="L76">                    requireActivity()</span>
                },
<span class="nc" id="L78">                viewModelFactory</span>
<span class="nc" id="L79">        ).get(ConversationNotificationsViewModel::class.java)</span>
<span class="nc" id="L80">    }</span>

    private fun CommentNotificationsBottomSheetBinding.initObservers() {
<span class="nc bnc" id="L83" title="All 2 branches missed.">        viewModel.snackbarEvents.observeEvent(viewLifecycleOwner, { messageHolder -&gt;</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (!isAdded) return@observeEvent</span>

<span class="nc" id="L86">            WPSnackbar.make(</span>
<span class="nc" id="L87">                    coordinator,</span>
<span class="nc" id="L88">                    uiHelpers.getTextOfUiString(contextProvider.getContext(), messageHolder.message),</span>
<span class="nc" id="L89">                    Snackbar.LENGTH_LONG</span>
<span class="nc" id="L90">            ).show()</span>
<span class="nc" id="L91">        })</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        viewModel.pushNotificationsStatusUpdate.observeEvent(viewLifecycleOwner, { isReceivingPushNotifications -&gt;</span>
<span class="nc" id="L94">            enablePushNotifications.isChecked = isReceivingPushNotifications</span>
<span class="nc" id="L95">        })</span>
<span class="nc" id="L96">    }</span>

    override fun onAttach(context: Context) {
<span class="nc" id="L99">        super.onAttach(context)</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        (requireActivity().applicationContext as WordPress).component().inject(this)</span>
<span class="nc" id="L101">    }</span>

    companion object {
        private const val ARG_IS_RECEIVING_PUSH_NOTIFICATIONS = &quot;ARG_IS_RECEIVING_PUSH_NOTIFICATIONS&quot;
        private const val ARG_IS_ATTACHED_TO_FRAGMENT = &quot;ARG_IS_ATTACHED_TO_FRAGMENT&quot;

        @JvmStatic
        fun newInstance(
            isReceivingPushNotifications: Boolean,
            isAttachedToFragment: Boolean
        ): CommentNotificationsBottomSheetFragment {
<span class="nc" id="L112">            val fragment = CommentNotificationsBottomSheetFragment()</span>
<span class="nc" id="L113">            val bundle = Bundle()</span>
<span class="nc" id="L114">            bundle.putBoolean(ARG_IS_RECEIVING_PUSH_NOTIFICATIONS, isReceivingPushNotifications)</span>
<span class="nc" id="L115">            bundle.putBoolean(ARG_IS_ATTACHED_TO_FRAGMENT, isAttachedToFragment)</span>
<span class="nc" id="L116">            fragment.arguments = bundle</span>
<span class="nc" id="L117">            return fragment</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>