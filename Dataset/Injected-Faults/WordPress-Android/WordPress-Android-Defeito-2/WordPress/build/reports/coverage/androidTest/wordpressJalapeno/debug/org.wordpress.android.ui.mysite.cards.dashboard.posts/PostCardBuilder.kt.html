<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostCardBuilder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.mysite.cards.dashboard.posts</a> &gt; <span class="el_source">PostCardBuilder.kt</span></div><h1>PostCardBuilder.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.mysite.cards.dashboard.posts

import org.wordpress.android.R
import org.wordpress.android.fluxc.model.dashboard.CardModel.PostsCardModel
import org.wordpress.android.fluxc.model.dashboard.CardModel.PostsCardModel.PostCardModel
import org.wordpress.android.fluxc.store.dashboard.CardsStore.PostCardError
import org.wordpress.android.fluxc.store.dashboard.CardsStore.PostCardErrorType
import org.wordpress.android.fluxc.utils.AppLogWrapper
import org.wordpress.android.ui.mysite.MySiteCardAndItem.Card.DashboardCards.DashboardCard.PostCard
import org.wordpress.android.ui.mysite.MySiteCardAndItem.Card.DashboardCards.DashboardCard.PostCard.FooterLink
import org.wordpress.android.ui.mysite.MySiteCardAndItem.Card.DashboardCards.DashboardCard.PostCard.PostCardWithPostItems
import org.wordpress.android.ui.mysite.MySiteCardAndItem.Card.DashboardCards.DashboardCard.PostCard.PostCardWithPostItems.PostItem
import org.wordpress.android.ui.mysite.MySiteCardAndItem.Card.DashboardCards.DashboardCard.PostCard.PostCardWithoutPostItems
import org.wordpress.android.ui.mysite.MySiteCardAndItemBuilderParams.PostCardBuilderParams
import org.wordpress.android.ui.mysite.MySiteCardAndItemBuilderParams.PostCardBuilderParams.PostItemClickParams
import org.wordpress.android.ui.utils.ListItemInteraction
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.LocaleManagerWrapper
import java.text.SimpleDateFormat
import java.util.Date
import javax.inject.Inject

<span class="nc" id="L25">@Suppress(&quot;TooManyFunctions&quot;)</span>
<span class="nc" id="L26">class PostCardBuilder @Inject constructor(</span>
<span class="nc" id="L27">    private val localeManagerWrapper: LocaleManagerWrapper,</span>
<span class="nc" id="L28">    private val appLogWrapper: AppLogWrapper</span>
) {
    fun build(params: PostCardBuilderParams): List&lt;PostCard&gt; {
<span class="nc bnc" id="L31" title="All 2 branches missed.">        val error = params.posts?.error</span>
<span class="nc bnc" id="L32" title="All 2 branches missed.">        return if (error != null) {</span>
<span class="nc" id="L33">            buildPostCardWithError(error)</span>
        } else {
<span class="nc" id="L35">            buildPostCardsWithData(params)</span>
        }
    }

    private fun buildPostCardWithError(error: PostCardError): List&lt;PostCard.Error&gt; {
<span class="nc bnc" id="L40" title="All 2 branches missed.">        error.message?.let { appLogWrapper.e(AppLog.T.MY_SITE_DASHBOARD, &quot;Post Card Error: $it&quot;) }</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">        return if (shouldShowError(error)) listOf(createPostErrorCard()) else emptyList()</span>
    }

    private fun buildPostCardsWithData(params: PostCardBuilderParams) =
<span class="nc" id="L45">            mutableListOf&lt;PostCard&gt;().apply {</span>
<span class="nc" id="L46">                val posts = params.posts</span>
<span class="nc bnc" id="L47" title="All 8 branches missed.">                posts?.hasPublished?.takeIf { !posts.hasDraftsOrScheduledPosts() }</span>
<span class="nc" id="L48">                        ?.let { hasPublished -&gt;</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">                            if (hasPublished) {</span>
<span class="nc" id="L50">                                add(createNextPostCard(params.onPostItemClick, params.onFooterLinkClick))</span>
                            } else {
<span class="nc" id="L52">                                add(createFirstPostCard(params.onPostItemClick, params.onFooterLinkClick))</span>
                            }
                        }
<span class="nc bnc" id="L55" title="All 10 branches missed.">                posts?.draft?.takeIf { it.isNotEmpty() }?.let { add(it.createDraftPostsCard(params)) }</span>
<span class="nc bnc" id="L56" title="All 10 branches missed.">                posts?.scheduled?.takeIf { it.isNotEmpty() }?.let { add(it.createScheduledPostsCard(params)) }</span>
<span class="nc" id="L57">            }.toList()</span>

<span class="nc" id="L59">    private fun createPostErrorCard() = PostCard.Error(</span>
<span class="nc" id="L60">            title = UiStringRes(R.string.posts)</span>
<span class="nc" id="L61">    )</span>

    private fun createFirstPostCard(
        onPostItemClick: (params: PostItemClickParams) -&gt; Unit,
        onFooterLinkClick: (postCardType: PostCardType) -&gt; Unit
<span class="nc" id="L66">    ) = PostCardWithoutPostItems(</span>
<span class="nc" id="L67">            postCardType = PostCardType.CREATE_FIRST,</span>
<span class="nc" id="L68">            title = UiStringRes(R.string.my_site_create_first_post_title),</span>
<span class="nc" id="L69">            excerpt = UiStringRes(R.string.my_site_create_first_post_excerpt),</span>
<span class="nc" id="L70">            imageRes = R.drawable.img_write_212dp,</span>
<span class="nc" id="L71">            footerLink = FooterLink(</span>
<span class="nc" id="L72">                    label = UiStringRes(R.string.my_site_post_card_link_create_post),</span>
<span class="nc" id="L73">                    onClick = onFooterLinkClick</span>
            ),
<span class="nc" id="L75">            onClick = ListItemInteraction.create(</span>
<span class="nc" id="L76">                    PostItemClickParams(postCardType = PostCardType.CREATE_FIRST, postId = NOT_SET),</span>
<span class="nc" id="L77">                    onPostItemClick</span>
            )
<span class="nc" id="L79">    )</span>

    private fun createNextPostCard(
        onPostItemClick: (params: PostItemClickParams) -&gt; Unit,
        onFooterLinkClick: (postCardType: PostCardType) -&gt; Unit
<span class="nc" id="L84">    ) = PostCardWithoutPostItems(</span>
<span class="nc" id="L85">            postCardType = PostCardType.CREATE_NEXT,</span>
<span class="nc" id="L86">            title = UiStringRes(R.string.my_site_create_next_post_title),</span>
<span class="nc" id="L87">            excerpt = UiStringRes(R.string.my_site_create_next_post_excerpt),</span>
<span class="nc" id="L88">            imageRes = R.drawable.img_write_212dp,</span>
<span class="nc" id="L89">            footerLink = FooterLink(</span>
<span class="nc" id="L90">                    label = UiStringRes(R.string.my_site_post_card_link_create_post),</span>
<span class="nc" id="L91">                    onClick = onFooterLinkClick</span>
            ),
<span class="nc" id="L93">            onClick = ListItemInteraction.create(</span>
<span class="nc" id="L94">                    PostItemClickParams(postCardType = PostCardType.CREATE_NEXT, postId = NOT_SET),</span>
<span class="nc" id="L95">                    onPostItemClick</span>
            )
<span class="nc" id="L97">    )</span>

    private fun List&lt;PostCardModel&gt;.createDraftPostsCard(params: PostCardBuilderParams) =
<span class="nc" id="L100">            PostCardWithPostItems(</span>
<span class="nc" id="L101">                    postCardType = PostCardType.DRAFT,</span>
<span class="nc" id="L102">                    title = UiStringRes(R.string.my_site_post_card_draft_title),</span>
<span class="nc" id="L103">                    postItems = mapToDraftPostItems(params.onPostItemClick),</span>
<span class="nc" id="L104">                    footerLink = FooterLink(</span>
<span class="nc" id="L105">                            label = UiStringRes(R.string.my_site_post_card_link_go_to_drafts),</span>
<span class="nc" id="L106">                            onClick = params.onFooterLinkClick</span>
                    )
<span class="nc" id="L108">            )</span>

    private fun List&lt;PostCardModel&gt;.createScheduledPostsCard(params: PostCardBuilderParams) =
<span class="nc" id="L111">            PostCardWithPostItems(</span>
<span class="nc" id="L112">                    postCardType = PostCardType.SCHEDULED,</span>
<span class="nc" id="L113">                    title = UiStringRes(R.string.my_site_post_card_scheduled_title),</span>
<span class="nc" id="L114">                    postItems = mapToScheduledPostItems(params.onPostItemClick),</span>
<span class="nc" id="L115">                    footerLink = FooterLink(</span>
<span class="nc" id="L116">                            label = UiStringRes(R.string.my_site_post_card_link_go_to_scheduled_posts),</span>
<span class="nc" id="L117">                            onClick = params.onFooterLinkClick</span>
                    )
<span class="nc" id="L119">            )</span>

<span class="nc bnc" id="L121" title="All 8 branches missed.">    private fun PostsCardModel.hasDraftsOrScheduledPosts() = draft.isNotEmpty() || scheduled.isNotEmpty()</span>

    private fun List&lt;PostCardModel&gt;.mapToDraftPostItems(
        onPostItemClick: (params: PostItemClickParams) -&gt; Unit
<span class="nc" id="L125">    ) = map { post -&gt;</span>
<span class="nc" id="L126">        PostItem(</span>
<span class="nc" id="L127">                title = constructPostTitle(post.title),</span>
<span class="nc" id="L128">                excerpt = constructPostContent(post.content),</span>
<span class="nc" id="L129">                featuredImageUrl = post.featuredImage,</span>
<span class="nc" id="L130">                onClick = ListItemInteraction.create(</span>
<span class="nc" id="L131">                        PostItemClickParams(PostCardType.DRAFT, post.id),</span>
<span class="nc" id="L132">                        onPostItemClick</span>
                )
        )
<span class="nc" id="L135">    }</span>

    private fun constructPostTitle(title: String) =
<span class="nc bnc" id="L138" title="All 4 branches missed.">            if (title.isEmpty()) UiStringRes(R.string.my_site_untitled_post) else UiStringText(title)</span>

    private fun constructPostContent(content: String) =
<span class="nc bnc" id="L141" title="All 6 branches missed.">            content.takeIf { it.isNotEmpty() }?.let { UiStringText(content) }</span>

    private fun List&lt;PostCardModel&gt;.mapToScheduledPostItems(
        onPostItemClick: (params: PostItemClickParams) -&gt; Unit
<span class="nc" id="L145">    ) = map { post -&gt;</span>
<span class="nc" id="L146">        PostItem(</span>
<span class="nc" id="L147">                title = constructPostTitle(post.title),</span>
<span class="nc" id="L148">                excerpt = UiStringText(constructPostDate(post.date)),</span>
<span class="nc" id="L149">                featuredImageUrl = post.featuredImage,</span>
<span class="nc" id="L150">                isTimeIconVisible = true,</span>
<span class="nc" id="L151">                onClick = ListItemInteraction.create(</span>
<span class="nc" id="L152">                        PostItemClickParams(PostCardType.SCHEDULED, post.id),</span>
<span class="nc" id="L153">                        onPostItemClick</span>
                )
        )
<span class="nc" id="L156">    }</span>

    private fun constructPostDate(date: Date) =
<span class="nc" id="L159">            SimpleDateFormat(MONTH_DAY_FORMAT, localeManagerWrapper.getLocale()).format(date)</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">    private fun shouldShowError(error: PostCardError) = error.type == PostCardErrorType.GENERIC_ERROR</span>

    companion object {
        private const val MONTH_DAY_FORMAT = &quot;MMM d&quot;
        const val NOT_SET = -1
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>