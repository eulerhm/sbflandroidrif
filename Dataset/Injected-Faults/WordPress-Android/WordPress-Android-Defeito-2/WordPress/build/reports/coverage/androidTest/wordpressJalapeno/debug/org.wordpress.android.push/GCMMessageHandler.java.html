<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GCMMessageHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.push</a> &gt; <span class="el_source">GCMMessageHandler.java</span></div><h1>GCMMessageHandler.java</h1><pre class="source lang-java linenums">package org.wordpress.android.push;

import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.graphics.Bitmap;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.text.TextUtils;

import androidx.annotation.NonNull;
import androidx.collection.ArrayMap;
import androidx.core.app.NotificationCompat;
import androidx.core.app.NotificationManagerCompat;
import androidx.core.app.RemoteInput;

import org.apache.commons.text.StringEscapeUtils;
import org.greenrobot.eventbus.EventBus;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.datasets.NotificationsTable;
import org.wordpress.android.fluxc.model.CommentStatus;
import org.wordpress.android.models.Note;
import org.wordpress.android.ui.main.WPMainActivity;
import org.wordpress.android.ui.notifications.NotificationEvents;
import org.wordpress.android.ui.notifications.NotificationsListFragment;
import org.wordpress.android.ui.notifications.SystemNotificationsTracker;
import org.wordpress.android.ui.notifications.utils.NotificationsActions;
import org.wordpress.android.ui.notifications.utils.NotificationsUtils;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.DateTimeUtils;
import org.wordpress.android.util.ImageUtils;
import org.wordpress.android.util.PhotonUtils;
import org.wordpress.android.util.StringUtils;

import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;
import java.util.concurrent.TimeUnit;

import javax.inject.Inject;
import javax.inject.Singleton;

import static org.wordpress.android.push.GCMMessageService.EXTRA_VOICE_OR_INLINE_REPLY;
import static org.wordpress.android.push.GCMMessageService.PUSH_ARG_NOTE_ID;
import static org.wordpress.android.push.NotificationPushIds.AUTH_PUSH_NOTIFICATION_ID;
import static org.wordpress.android.push.NotificationPushIds.GROUP_NOTIFICATION_ID;
import static org.wordpress.android.push.NotificationPushIds.PUSH_NOTIFICATION_ID;
import static org.wordpress.android.push.NotificationPushIds.ZENDESK_PUSH_NOTIFICATION_ID;
import static org.wordpress.android.push.NotificationType.UNKNOWN_NOTE;
import static org.wordpress.android.push.NotificationsProcessingService.ARG_NOTIFICATION_TYPE;
import static org.wordpress.android.ui.notifications.services.NotificationsUpdateServiceStarter.IS_TAPPED_ON_NOTIFICATION;

@Singleton
public class GCMMessageHandler {
    private static final String NOTIFICATION_GROUP_KEY = &quot;notification_group_key&quot;;
    private static final int AUTH_PUSH_REQUEST_CODE_APPROVE = 0;
    private static final int AUTH_PUSH_REQUEST_CODE_IGNORE = 1;
    private static final int AUTH_PUSH_REQUEST_CODE_OPEN_DIALOG = 2;

    private static final int MAX_INBOX_ITEMS = 5;

    private static final String PUSH_ARG_TYPE = &quot;type&quot;;
    private static final String PUSH_ARG_USER = &quot;user&quot;;
    private static final String PUSH_ARG_TITLE = &quot;title&quot;;
    private static final String PUSH_ARG_MSG = &quot;msg&quot;;

    private static final String PUSH_TYPE_COMMENT = &quot;c&quot;;
    private static final String PUSH_TYPE_LIKE = &quot;like&quot;;
    private static final String PUSH_TYPE_COMMENT_LIKE = &quot;comment_like&quot;;
    private static final String PUSH_TYPE_AUTOMATTCHER = &quot;automattcher&quot;;
    private static final String PUSH_TYPE_FOLLOW = &quot;follow&quot;;
    private static final String PUSH_TYPE_REBLOG = &quot;reblog&quot;;
    private static final String PUSH_TYPE_PUSH_AUTH = &quot;push_auth&quot;;
    private static final String PUSH_TYPE_BADGE_RESET = &quot;badge-reset&quot;;
    private static final String PUSH_TYPE_NOTE_DELETE = &quot;note-delete&quot;;
    private static final String PUSH_TYPE_TEST_NOTE = &quot;push_test&quot;;
    static final String PUSH_TYPE_ZENDESK = &quot;zendesk&quot;;

    private static final String KEY_CATEGORY_COMMENT_LIKE = &quot;comment-like&quot;;
    private static final String KEY_CATEGORY_COMMENT_REPLY = &quot;comment-reply&quot;;
    private static final String KEY_CATEGORY_COMMENT_MODERATE = &quot;comment-moderate&quot;;

    // Add to the analytics properties map a subset of the push notification payload.
<span class="nc" id="L97">    private static final String[] PROPERTIES_TO_COPY_INTO_ANALYTICS =</span>
            {PUSH_ARG_NOTE_ID, PUSH_ARG_TYPE, &quot;blog_id&quot;, &quot;post_id&quot;, &quot;comment_id&quot;};

    private final ArrayMap&lt;Integer, Bundle&gt; mActiveNotificationsMap;
    private final NotificationHelper mNotificationHelper;

<span class="nc" id="L103">    @Inject GCMMessageHandler(SystemNotificationsTracker systemNotificationsTracker) {</span>
<span class="nc" id="L104">        mActiveNotificationsMap = new ArrayMap&lt;&gt;();</span>
<span class="nc" id="L105">        mNotificationHelper = new NotificationHelper(this, systemNotificationsTracker);</span>
<span class="nc" id="L106">    }</span>

    synchronized void rebuildAndUpdateNotificationsOnSystemBarForThisNote(Context context,
                                                                          String noteId) {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (mActiveNotificationsMap.size() &gt; 0) {</span>
            // get the corresponding bundle for this noteId
            // using a copy of the ArrayMap to iterate over on, as we might need to modify the original array
<span class="nc" id="L113">            ArrayMap&lt;Integer, Bundle&gt; tmpMap = new ArrayMap(mActiveNotificationsMap);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            for (Bundle noteBundle : tmpMap.values()) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (noteBundle.getString(PUSH_ARG_NOTE_ID, &quot;&quot;).equals(noteId)) {</span>
<span class="nc" id="L116">                    mNotificationHelper.rebuildAndUpdateNotificationsOnSystemBar(context, noteBundle);</span>
<span class="nc" id="L117">                    return;</span>
                }
<span class="nc" id="L119">            }</span>
        }
<span class="nc" id="L121">    }</span>

    public synchronized void rebuildAndUpdateNotifsOnSystemBarForRemainingNote(Context context) {
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (mActiveNotificationsMap.size() &gt; 0) {</span>
<span class="nc" id="L125">            Bundle remainingNote = mActiveNotificationsMap.values().iterator().next();</span>
<span class="nc" id="L126">            mNotificationHelper.rebuildAndUpdateNotificationsOnSystemBar(context, remainingNote);</span>
        }
<span class="nc" id="L128">    }</span>

    private synchronized Bundle getCurrentNoteBundleForNoteId(String noteId) {
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (mActiveNotificationsMap.size() &gt; 0) {</span>
            // get the corresponding bundle for this noteId
<span class="nc bnc" id="L133" title="All 2 branches missed.">            for (Bundle noteBundle : mActiveNotificationsMap.values()) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">                if (noteBundle.getString(PUSH_ARG_NOTE_ID, &quot;&quot;).equals(noteId)) {</span>
<span class="nc" id="L135">                    return noteBundle;</span>
                }
<span class="nc" id="L137">            }</span>
        }
<span class="nc" id="L139">        return null;</span>
    }

    synchronized void clearNotifications() {
<span class="nc" id="L143">        List&lt;Integer&gt; removedNotifications = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        for (Integer pushId : mActiveNotificationsMap.keySet()) {</span>
            // don't cancel or remove the AUTH notification if it exists
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (!pushId.equals(AUTH_PUSH_NOTIFICATION_ID)) {</span>
<span class="nc" id="L147">                removedNotifications.add(pushId);</span>
            }
<span class="nc" id="L149">        }</span>
<span class="nc" id="L150">        mActiveNotificationsMap.removeAll(removedNotifications);</span>
<span class="nc" id="L151">    }</span>

    public synchronized int getNotificationsCount() {
<span class="nc" id="L154">        return mActiveNotificationsMap.size();</span>
    }

    synchronized boolean hasNotifications() {
<span class="nc bnc" id="L158" title="All 2 branches missed.">        return !mActiveNotificationsMap.isEmpty();</span>
    }

    // Removes a specific notification from the internal map - only use this when we know
    // the user has dismissed the app by swiping it off the screen
    synchronized void removeNotification(int notificationId) {
<span class="nc" id="L164">        mActiveNotificationsMap.remove(notificationId);</span>
<span class="nc" id="L165">    }</span>

    // Removes a specific notification from the system bar
    public synchronized void removeNotificationWithNoteIdFromSystemBar(Context context, String noteID) {
<span class="nc bnc" id="L169" title="All 6 branches missed.">        if (context == null || TextUtils.isEmpty(noteID) || !hasNotifications()) {</span>
<span class="nc" id="L170">            return;</span>
        }

<span class="nc" id="L173">        NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);</span>
<span class="nc" id="L174">        List&lt;Integer&gt; removedNotifications = new ArrayList&lt;&gt;();</span>
        // here we loop with an Iterator as there might be several Notifications with the same Note ID
        // (i.e. likes on the same Note) so we need to keep cancelling them and removing them from our
        // mActiveNotificationsMap as we find it suitable
<span class="nc bnc" id="L178" title="All 2 branches missed.">        for (Entry&lt;Integer, Bundle&gt; row : mActiveNotificationsMap.entrySet()) {</span>
<span class="nc" id="L179">            Integer pushId = row.getKey();</span>
<span class="nc" id="L180">            Bundle noteBundle = row.getValue();</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (noteBundle.getString(PUSH_ARG_NOTE_ID, &quot;&quot;).equals(noteID)) {</span>
<span class="nc" id="L182">                notificationManager.cancel(pushId);</span>
<span class="nc" id="L183">                removedNotifications.add(pushId);</span>
            }
<span class="nc" id="L185">        }</span>
<span class="nc" id="L186">        mActiveNotificationsMap.removeAll(removedNotifications);</span>

<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (mActiveNotificationsMap.size() == 0) {</span>
<span class="nc" id="L189">            notificationManager.cancel(GROUP_NOTIFICATION_ID);</span>
        }
<span class="nc" id="L191">    }</span>

    // Removes all app notifications from the system bar
    public synchronized void removeAllNotifications(Context context) {
<span class="nc bnc" id="L195" title="All 4 branches missed.">        if (context == null || !hasNotifications()) {</span>
<span class="nc" id="L196">            return;</span>
        }

<span class="nc" id="L199">        NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);</span>
<span class="nc" id="L200">        List&lt;Integer&gt; removedNotifications = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        for (Integer pushId : mActiveNotificationsMap.keySet()) {</span>
            // don't cancel or remove the AUTH notification if it exists
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (!pushId.equals(AUTH_PUSH_NOTIFICATION_ID)) {</span>
<span class="nc" id="L204">                notificationManager.cancel(pushId);</span>
<span class="nc" id="L205">                removedNotifications.add(pushId);</span>
            }
<span class="nc" id="L207">        }</span>
<span class="nc" id="L208">        mActiveNotificationsMap.removeAll(removedNotifications);</span>
<span class="nc" id="L209">        notificationManager.cancel(GROUP_NOTIFICATION_ID);</span>
<span class="nc" id="L210">    }</span>

    public synchronized void remove2FANotification(Context context) {
<span class="nc bnc" id="L213" title="All 4 branches missed.">        if (context == null || !hasNotifications()) {</span>
<span class="nc" id="L214">            return;</span>
        }

<span class="nc" id="L217">        NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);</span>
<span class="nc" id="L218">        notificationManager.cancel(AUTH_PUSH_NOTIFICATION_ID);</span>
<span class="nc" id="L219">        mActiveNotificationsMap.remove(AUTH_PUSH_NOTIFICATION_ID);</span>
<span class="nc" id="L220">    }</span>

    // NoteID is the ID if the note in WordPress
    public synchronized void bumpPushNotificationsTappedAnalytics(String noteID) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        for (Bundle noteBundle : mActiveNotificationsMap.values()) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (noteBundle.getString(PUSH_ARG_NOTE_ID, &quot;&quot;).equals(noteID)) {</span>
<span class="nc" id="L226">                bumpPushNotificationsAnalytics(Stat.PUSH_NOTIFICATION_TAPPED, noteBundle, null);</span>
<span class="nc" id="L227">                AnalyticsTracker.flush();</span>
<span class="nc" id="L228">                return;</span>
            }
<span class="nc" id="L230">        }</span>
<span class="nc" id="L231">    }</span>

    // Mark all notifications as tapped
    public synchronized void bumpPushNotificationsTappedAllAnalytics() {
<span class="nc bnc" id="L235" title="All 2 branches missed.">        for (Bundle noteBundle : mActiveNotificationsMap.values()) {</span>
<span class="nc" id="L236">            bumpPushNotificationsAnalytics(Stat.PUSH_NOTIFICATION_TAPPED, noteBundle, null);</span>
<span class="nc" id="L237">        }</span>
<span class="nc" id="L238">        AnalyticsTracker.flush();</span>
<span class="nc" id="L239">    }</span>

    private void bumpPushNotificationsAnalytics(Stat stat, Bundle noteBundle,
                                                Map&lt;String, Object&gt; properties) {
        // Bump Analytics for PNs if &quot;Show notifications&quot; setting is checked (default). Skip otherwise.
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (!NotificationsUtils.isNotificationsEnabled(WordPress.getContext())) {</span>
<span class="nc" id="L245">            return;</span>
        }
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L248">            properties = new HashMap&lt;&gt;();</span>
        }

<span class="nc" id="L251">        String notificationID = noteBundle.getString(PUSH_ARG_NOTE_ID, &quot;&quot;);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!TextUtils.isEmpty(notificationID)) {</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">            for (String currentPropertyToCopy : PROPERTIES_TO_COPY_INTO_ANALYTICS) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                if (noteBundle.containsKey(currentPropertyToCopy)) {</span>
<span class="nc" id="L255">                    properties.put(&quot;push_notification_&quot; + currentPropertyToCopy, noteBundle.get(currentPropertyToCopy));</span>
                }
            }
<span class="nc" id="L258">            SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(WordPress.getContext());</span>
<span class="nc" id="L259">            String lastRegisteredGCMToken = preferences.getString(NotificationsUtils.WPCOM_PUSH_DEVICE_TOKEN, null);</span>
<span class="nc" id="L260">            properties.put(&quot;push_notification_token&quot;, lastRegisteredGCMToken);</span>
<span class="nc" id="L261">            AnalyticsTracker.track(stat, properties);</span>
        }
<span class="nc" id="L263">    }</span>

    private void addAuthPushNotificationToNotificationMap(Bundle data) {
<span class="nc" id="L266">        mActiveNotificationsMap.put(AUTH_PUSH_NOTIFICATION_ID, data);</span>
<span class="nc" id="L267">    }</span>

    void handleDefaultPush(Context context, @NonNull Bundle data, long wpcomUserId) {
<span class="nc" id="L270">        mNotificationHelper.handleDefaultPush(context, data, wpcomUserId);</span>
<span class="nc" id="L271">    }</span>

    void handleZendeskNotification(Context context) {
<span class="nc" id="L274">        mNotificationHelper.handleZendeskNotification(context);</span>
<span class="nc" id="L275">    }</span>

    public static class NotificationHelper {
        private GCMMessageHandler mGCMMessageHandler;
        private SystemNotificationsTracker mSystemNotificationsTracker;

        NotificationHelper(GCMMessageHandler gCMMessageHandler,
<span class="nc" id="L282">                           SystemNotificationsTracker systemNotificationsTracker) {</span>
<span class="nc" id="L283">            mGCMMessageHandler = gCMMessageHandler;</span>
<span class="nc" id="L284">            mSystemNotificationsTracker = systemNotificationsTracker;</span>
<span class="nc" id="L285">        }</span>

        void handleDefaultPush(Context context, @NonNull Bundle data, long wpcomUserId) {
<span class="nc" id="L288">            String pushUserId = data.getString(PUSH_ARG_USER);</span>
            // pushUserId is always set server side, but better to double check it here.
<span class="nc bnc" id="L290" title="All 2 branches missed.">            if (!String.valueOf(wpcomUserId).equals(pushUserId)) {</span>
<span class="nc" id="L291">                AppLog.e(T.NOTIFS, &quot;wpcom userId found in the app doesn't match with the ID in the PN. Aborting.&quot;);</span>
<span class="nc" id="L292">                return;</span>
            }

<span class="nc" id="L295">            String noteType = StringUtils.notNullStr(data.getString(PUSH_ARG_TYPE));</span>

            // Check for wpcom auth push, if so we will process this push differently
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (noteType.equals(PUSH_TYPE_PUSH_AUTH)) {</span>
<span class="nc" id="L299">                mGCMMessageHandler.addAuthPushNotificationToNotificationMap(data);</span>
<span class="nc" id="L300">                handlePushAuth(context, data);</span>
<span class="nc" id="L301">                return;</span>
            }

<span class="nc bnc" id="L304" title="All 2 branches missed.">            if (noteType.equals(PUSH_TYPE_BADGE_RESET)) {</span>
<span class="nc" id="L305">                handleBadgeResetPN(context, data);</span>
<span class="nc" id="L306">                return;</span>
            }

<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (noteType.equals(PUSH_TYPE_NOTE_DELETE)) {</span>
<span class="nc" id="L310">                handleNoteDeletePN(context, data);</span>
<span class="nc" id="L311">                return;</span>
            }

<span class="nc bnc" id="L314" title="All 2 branches missed.">            if (noteType.equals(PUSH_TYPE_TEST_NOTE)) {</span>
<span class="nc" id="L315">                buildAndShowNotificationFromTestPushData(context, data);</span>
<span class="nc" id="L316">                return;</span>
            }

<span class="nc" id="L319">            buildAndShowNotificationFromNoteData(context, data);</span>
<span class="nc" id="L320">        }</span>

        private void buildAndShowNotificationFromTestPushData(Context context, Bundle data) {
<span class="nc bnc" id="L323" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L324">                AppLog.e(T.NOTIFS, &quot;Test push notification received without a valid Bundle!&quot;);</span>
<span class="nc" id="L325">                return;</span>
            }

<span class="nc" id="L328">            String title = context.getString(R.string.app_name);</span>
<span class="nc" id="L329">            String message = StringEscapeUtils.unescapeHtml4(data.getString(PUSH_ARG_MSG));</span>

<span class="nc" id="L331">            int pushId = PUSH_NOTIFICATION_ID + mGCMMessageHandler.mActiveNotificationsMap.size();</span>
<span class="nc" id="L332">            mGCMMessageHandler.mActiveNotificationsMap.put(pushId, data);</span>
<span class="nc" id="L333">            Intent resultIntent = new Intent(context, WPMainActivity.class);</span>
<span class="nc" id="L334">            resultIntent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);</span>
<span class="nc" id="L335">            showSimpleNotification(context, title, message, resultIntent, pushId, NotificationType.TEST_NOTE);</span>
<span class="nc" id="L336">        }</span>

        private void buildAndShowNotificationFromNoteData(Context context, Bundle data) {
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L340">                AppLog.e(T.NOTIFS, &quot;Push notification received without a valid Bundle!&quot;);</span>
<span class="nc" id="L341">                return;</span>
            }

<span class="nc" id="L344">            final String wpcomNoteID = data.getString(PUSH_ARG_NOTE_ID, &quot;&quot;);</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">            if (TextUtils.isEmpty(wpcomNoteID)) {</span>
                // At this point 'note_id' is always available in the notification bundle.
<span class="nc" id="L347">                AppLog.e(T.NOTIFS, &quot;Push notification received without a valid note_id in in payload!&quot;);</span>
<span class="nc" id="L348">                return;</span>
            }

            // Try to build the note object from the PN payload, and save it to the DB.
<span class="nc" id="L352">            NotificationsUtils.buildNoteObjectFromBundleAndSaveIt(data);</span>
<span class="nc" id="L353">            EventBus.getDefault().post(new NotificationEvents.NotificationsChanged(true));</span>

<span class="nc" id="L355">            String noteType = StringUtils.notNullStr(data.getString(PUSH_ARG_TYPE));</span>

<span class="nc" id="L357">            String title = StringEscapeUtils.unescapeHtml4(data.getString(PUSH_ARG_TITLE));</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (title == null) {</span>
<span class="nc" id="L359">                title = context.getString(R.string.app_name);</span>
            }
<span class="nc" id="L361">            String message = StringEscapeUtils.unescapeHtml4(data.getString(PUSH_ARG_MSG));</span>

            /*
             * if this has the same note_id as the previous notification, and the previous notification
             * was received within the last second, then skip showing it - this handles duplicate
             * notifications being shown due to the device being registered multiple times with different tokens.
             * (still investigating how this could happen - 21-Oct-13)
             *
             * this also handles the (rare) case where the user receives rapid-fire sub-second like notifications
             * due to sudden popularity (post gets added to FP and is liked by many people all at once, etc.),
             * which we also want to avoid since it would drain the battery and annoy the user
             *
             * NOTE: different comments on the same post will have a different note_id, but different likes
             * on the same post will have the same note_id, so don't assume that the note_id is unique
             */
<span class="nc" id="L376">            long thisTime = System.currentTimeMillis();</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            if (AppPrefs.getLastPushNotificationWpcomNoteId().equals(wpcomNoteID)) {</span>
<span class="nc" id="L378">                long seconds = TimeUnit.MILLISECONDS.toSeconds(thisTime - AppPrefs.getLastPushNotificationTime());</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                if (seconds &lt;= 1) {</span>
<span class="nc" id="L380">                    AppLog.w(T.NOTIFS, &quot;skipped potential duplicate notification&quot;);</span>
<span class="nc" id="L381">                    return;</span>
                }
            }

<span class="nc" id="L385">            AppPrefs.setLastPushNotificationTime(thisTime);</span>
<span class="nc" id="L386">            AppPrefs.setLastPushNotificationWpcomNoteId(wpcomNoteID);</span>

            // Update notification content for the same noteId if it is already showing
<span class="nc" id="L389">            int pushId = getPushIdForWpcomeNoteID(wpcomNoteID);</span>
<span class="nc" id="L390">            mGCMMessageHandler.mActiveNotificationsMap.put(pushId, data);</span>

            // Bump Analytics for PNs if &quot;Show notifications&quot; setting is checked (default). Skip otherwise.
<span class="nc bnc" id="L393" title="All 2 branches missed.">            if (NotificationsUtils.isNotificationsEnabled(context)) {</span>
<span class="nc" id="L394">                Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                if (!TextUtils.isEmpty(noteType)) {</span>
                    // 'comment' and 'comment_pingback' types are sent in PN as type = &quot;c&quot;
<span class="nc bnc" id="L397" title="All 2 branches missed.">                    if (noteType.equals(PUSH_TYPE_COMMENT)) {</span>
<span class="nc" id="L398">                        properties.put(&quot;notification_type&quot;, &quot;comment&quot;);</span>
                    } else {
<span class="nc" id="L400">                        properties.put(&quot;notification_type&quot;, noteType);</span>
                    }
                }

<span class="nc" id="L404">                mGCMMessageHandler.bumpPushNotificationsAnalytics(Stat.PUSH_NOTIFICATION_RECEIVED, data, properties);</span>
<span class="nc" id="L405">                AnalyticsTracker.flush();</span>
            }

            // Build the new notification, add group to support wearable stacking
<span class="nc" id="L409">            NotificationCompat.Builder builder = getNotificationBuilder(context, title, message);</span>
<span class="nc" id="L410">            Bitmap largeIconBitmap =</span>
<span class="nc" id="L411">                    getLargeIconBitmap(context, data.getString(&quot;icon&quot;), shouldCircularizeNoteIcon(noteType));</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">            if (largeIconBitmap != null) {</span>
<span class="nc" id="L413">                builder.setLargeIcon(largeIconBitmap);</span>
            }

            // Always do this, since a note can be updated on the server after a PN is sent
<span class="nc" id="L417">            NotificationsActions.downloadNoteAndUpdateDB(</span>
                    wpcomNoteID,
<span class="nc" id="L419">                    success -&gt; showNotificationForNoteData(context, data, builder),</span>
<span class="nc" id="L420">                    error -&gt; showNotificationForNoteData(context, data, builder)</span>
            );
<span class="nc" id="L422">        }</span>

        private void showNotificationForNoteData(Context context, Bundle noteData, NotificationCompat.Builder builder) {
<span class="nc" id="L425">            String noteType = StringUtils.notNullStr(noteData.getString(PUSH_ARG_TYPE));</span>
<span class="nc" id="L426">            String wpcomNoteID = noteData.getString(PUSH_ARG_NOTE_ID, &quot;&quot;);</span>
<span class="nc" id="L427">            String message = StringEscapeUtils.unescapeHtml4(noteData.getString(PUSH_ARG_MSG));</span>
<span class="nc" id="L428">            int pushId = getPushIdForWpcomeNoteID(wpcomNoteID);</span>

<span class="nc" id="L430">            showSingleNotificationForBuilder(context, builder, noteType, wpcomNoteID, pushId, true);</span>

            // Also add a group summary notification, which is required for non-wearable devices
            // Do not need to play the sound again. We've already played it in the individual builder.
<span class="nc" id="L434">            showGroupNotificationForBuilder(context, builder, wpcomNoteID, message);</span>
<span class="nc" id="L435">        }</span>

        private int getPushIdForWpcomeNoteID(String wpcomNoteID) {
<span class="nc" id="L438">            int pushId = 0;</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">            for (Integer id : mGCMMessageHandler.mActiveNotificationsMap.keySet()) {</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                if (id == null) {</span>
<span class="nc" id="L441">                    continue;</span>
                }
<span class="nc" id="L443">                Bundle noteBundle = mGCMMessageHandler.mActiveNotificationsMap.get(id);</span>
<span class="nc bnc" id="L444" title="All 4 branches missed.">                if (noteBundle != null &amp;&amp; noteBundle.getString(PUSH_ARG_NOTE_ID, &quot;&quot;).equals(wpcomNoteID)) {</span>
<span class="nc" id="L445">                    pushId = id;</span>
<span class="nc" id="L446">                    break;</span>
                }
<span class="nc" id="L448">            }</span>

<span class="nc bnc" id="L450" title="All 2 branches missed.">            if (pushId == 0) {</span>
<span class="nc" id="L451">                pushId = PUSH_NOTIFICATION_ID + mGCMMessageHandler.mActiveNotificationsMap.size();</span>
            }
<span class="nc" id="L453">            return pushId;</span>
        }

        private void showSimpleNotification(Context context, String title, String message, Intent resultIntent,
                                            int pushId, NotificationType notificationType) {
<span class="nc" id="L458">            NotificationCompat.Builder builder = getNotificationBuilder(context, title, message);</span>
<span class="nc" id="L459">            showNotificationForBuilder(builder, context, resultIntent, pushId, true, notificationType);</span>
<span class="nc" id="L460">        }</span>

        private void addActionsForCommentNotification(Context context, NotificationCompat.Builder builder,
                                                      String noteId) {
            // Add some actions if this is a comment notification
<span class="nc" id="L465">            boolean areActionsSet = false;</span>
<span class="nc" id="L466">            Note note = NotificationsTable.getNoteById(noteId);</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">            if (note != null) {</span>
                // if note can be replied to, we'll always add this action first
<span class="nc bnc" id="L469" title="All 2 branches missed.">                if (note.canReply()) {</span>
<span class="nc" id="L470">                    addCommentReplyActionForCommentNotification(context, builder, noteId);</span>
                }

                // if the comment is lacking approval, offer moderation actions
<span class="nc bnc" id="L474" title="All 2 branches missed.">                if (note.getCommentStatus() == CommentStatus.UNAPPROVED) {</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">                    if (note.canModerate()) {</span>
<span class="nc" id="L476">                        addCommentApproveActionForCommentNotification(context, builder, noteId);</span>
                    }
                } else {
                    // else offer REPLY / LIKE actions
                    // LIKE can only be enabled for wp.com sites, so if this is a Jetpack site don't enable LIKEs
<span class="nc bnc" id="L481" title="All 2 branches missed.">                    if (note.canLike()) {</span>
<span class="nc" id="L482">                        addCommentLikeActionForCommentNotification(context, builder, noteId);</span>
                    }
                }
<span class="nc" id="L485">                areActionsSet = true;</span>
            }

            // if we could not set the actions, set the default one REPLY as it's then only safe bet
            // we can make at this point
<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (!areActionsSet) {</span>
<span class="nc" id="L491">                addCommentReplyActionForCommentNotification(context, builder, noteId);</span>
            }
<span class="nc" id="L493">        }</span>

        private void addCommentReplyActionForCommentNotification(Context context, NotificationCompat.Builder builder,
                                                                 String noteId) {
            // adding comment reply action
<span class="nc" id="L498">            Intent commentReplyIntent = getCommentActionReplyIntent(context, noteId);</span>
<span class="nc" id="L499">            commentReplyIntent.addCategory(KEY_CATEGORY_COMMENT_REPLY);</span>
<span class="nc" id="L500">            commentReplyIntent.putExtra(NotificationsProcessingService.ARG_ACTION_TYPE,</span>
                    NotificationsProcessingService.ARG_ACTION_REPLY);
<span class="nc bnc" id="L502" title="All 2 branches missed.">            if (noteId != null) {</span>
<span class="nc" id="L503">                commentReplyIntent.putExtra(NotificationsProcessingService.ARG_NOTE_ID, noteId);</span>
            }
<span class="nc" id="L505">            commentReplyIntent</span>
<span class="nc" id="L506">                    .putExtra(NotificationsProcessingService.ARG_NOTE_BUNDLE,</span>
<span class="nc" id="L507">                            mGCMMessageHandler.getCurrentNoteBundleForNoteId(noteId));</span>


<span class="nc" id="L510">            PendingIntent commentReplyPendingIntent = getCommentActionPendingIntent(context, commentReplyIntent);</span>

            // The following code adds the behavior for Direct reply, available on Android N (7.0) and on.
            // Using backward compatibility with NotificationCompat.
<span class="nc" id="L514">            String replyLabel = context.getString(R.string.reply);</span>
<span class="nc" id="L515">            RemoteInput remoteInput = new RemoteInput.Builder(EXTRA_VOICE_OR_INLINE_REPLY)</span>
<span class="nc" id="L516">                    .setLabel(replyLabel)</span>
<span class="nc" id="L517">                    .build();</span>
<span class="nc" id="L518">            NotificationCompat.Action action = new NotificationCompat.Action.Builder(R.drawable.ic_reply_white_24dp,</span>
<span class="nc" id="L519">                    context.getString(R.string.reply), commentReplyPendingIntent).addRemoteInput(remoteInput).build();</span>
            // now add the action corresponding to direct-reply
<span class="nc" id="L521">            builder.addAction(action);</span>
<span class="nc" id="L522">        }</span>

        private void addCommentLikeActionForCommentNotification(Context context, NotificationCompat.Builder builder,
                                                                String noteId) {
            // adding comment like action
<span class="nc" id="L527">            Intent commentLikeIntent = getCommentActionIntent(context);</span>
<span class="nc" id="L528">            commentLikeIntent.addCategory(KEY_CATEGORY_COMMENT_LIKE);</span>
<span class="nc" id="L529">            commentLikeIntent.putExtra(NotificationsProcessingService.ARG_ACTION_TYPE,</span>
                    NotificationsProcessingService.ARG_ACTION_LIKE);
<span class="nc bnc" id="L531" title="All 2 branches missed.">            if (noteId != null) {</span>
<span class="nc" id="L532">                commentLikeIntent.putExtra(NotificationsProcessingService.ARG_NOTE_ID, noteId);</span>
            }
<span class="nc" id="L534">            commentLikeIntent.putExtra(NotificationsProcessingService.ARG_NOTE_BUNDLE,</span>
<span class="nc" id="L535">                    mGCMMessageHandler.getCurrentNoteBundleForNoteId(noteId));</span>

<span class="nc" id="L537">            PendingIntent commentLikePendingIntent = getCommentActionPendingIntentForService(context,</span>
                    commentLikeIntent);
<span class="nc" id="L539">            builder.addAction(R.drawable.ic_star_white_24dp, context.getText(R.string.like), commentLikePendingIntent);</span>
<span class="nc" id="L540">        }</span>

        private void addCommentApproveActionForCommentNotification(Context context, NotificationCompat.Builder builder,
                                                                   String noteId) {
            // adding comment approve action
<span class="nc" id="L545">            Intent commentApproveIntent = getCommentActionIntent(context);</span>
<span class="nc" id="L546">            commentApproveIntent.addCategory(KEY_CATEGORY_COMMENT_MODERATE);</span>
<span class="nc" id="L547">            commentApproveIntent.putExtra(NotificationsProcessingService.ARG_ACTION_TYPE,</span>
                    NotificationsProcessingService.ARG_ACTION_APPROVE);
<span class="nc bnc" id="L549" title="All 2 branches missed.">            if (noteId != null) {</span>
<span class="nc" id="L550">                commentApproveIntent.putExtra(NotificationsProcessingService.ARG_NOTE_ID, noteId);</span>
            }
<span class="nc" id="L552">            commentApproveIntent.putExtra(NotificationsProcessingService.ARG_NOTE_BUNDLE,</span>
<span class="nc" id="L553">                    mGCMMessageHandler.getCurrentNoteBundleForNoteId(noteId));</span>

<span class="nc" id="L555">            PendingIntent commentApprovePendingIntent = getCommentActionPendingIntentForService(context,</span>
                    commentApproveIntent);
<span class="nc" id="L557">            builder.addAction(R.drawable.ic_checkmark_white_24dp, context.getText(R.string.approve),</span>
                    commentApprovePendingIntent);
<span class="nc" id="L559">        }</span>

        private PendingIntent getCommentActionPendingIntent(Context context, Intent intent) {
<span class="nc" id="L562">            return getCommentActionPendingIntentForService(context, intent);</span>
        }

        private PendingIntent getCommentActionPendingIntentForService(Context context, Intent intent) {
<span class="nc" id="L566">            int flags = PendingIntent.FLAG_CANCEL_CURRENT;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if (Build.VERSION.SDK_INT &gt;= 31) flags |= PendingIntent.FLAG_MUTABLE;</span>

<span class="nc" id="L569">            return PendingIntent.getService(</span>
                    context,
                    0,
                    intent,
                    flags
            );
        }

        private Intent getCommentActionReplyIntent(Context context, String noteId) {
<span class="nc" id="L578">            return getCommentActionIntentForService(context);</span>
        }

        private Intent getCommentActionIntent(Context context) {
<span class="nc" id="L582">            return getCommentActionIntentForService(context);</span>
        }

        private Intent getCommentActionIntentForService(Context context) {
<span class="nc" id="L586">            return new Intent(context, NotificationsProcessingService.class);</span>
        }

        private Bitmap getLargeIconBitmap(Context context, String iconUrl, boolean shouldCircularizeIcon) {
<span class="nc" id="L590">            Bitmap largeIconBitmap = null;</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">            if (iconUrl != null) {</span>
                try {
<span class="nc" id="L593">                    iconUrl = URLDecoder.decode(iconUrl, &quot;UTF-8&quot;);</span>
<span class="nc" id="L594">                    int largeIconSize = context.getResources().getDimensionPixelSize(</span>
                            android.R.dimen.notification_large_icon_height);
<span class="nc" id="L596">                    String resizedUrl = PhotonUtils.getPhotonImageUrl(iconUrl, largeIconSize, largeIconSize);</span>
<span class="nc" id="L597">                    largeIconBitmap = ImageUtils.downloadBitmap(resizedUrl);</span>
<span class="nc bnc" id="L598" title="All 4 branches missed.">                    if (largeIconBitmap != null &amp;&amp; shouldCircularizeIcon) {</span>
<span class="nc" id="L599">                        largeIconBitmap = ImageUtils.getCircularBitmap(largeIconBitmap);</span>
                    }
<span class="nc" id="L601">                } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L602">                    AppLog.e(T.NOTIFS, e);</span>
<span class="nc" id="L603">                }</span>
            }
<span class="nc" id="L605">            return largeIconBitmap;</span>
        }

        private NotificationCompat.Builder getNotificationBuilder(Context context, String title, String message) {
            // Build the new notification, add group to support wearable stacking
<span class="nc" id="L610">            return new NotificationCompat.Builder(context,</span>
<span class="nc" id="L611">                    context.getString(R.string.notification_channel_normal_id))</span>
<span class="nc" id="L612">                    .setSmallIcon(R.drawable.ic_app_white_24dp)</span>
<span class="nc" id="L613">                    .setColor(context.getResources().getColor(R.color.primary_50))</span>
<span class="nc" id="L614">                    .setContentTitle(title)</span>
<span class="nc" id="L615">                    .setContentText(message)</span>
<span class="nc" id="L616">                    .setTicker(message)</span>
<span class="nc" id="L617">                    .setOnlyAlertOnce(true)</span>
<span class="nc" id="L618">                    .setAutoCancel(true)</span>
<span class="nc" id="L619">                    .setStyle(new NotificationCompat.BigTextStyle().bigText(message))</span>
<span class="nc" id="L620">                    .setGroup(NOTIFICATION_GROUP_KEY);</span>
        }

        private void showGroupNotificationForBuilder(Context context, NotificationCompat.Builder builder,
                                                     String wpcomNoteID, String message) {
<span class="nc bnc" id="L625" title="All 4 branches missed.">            if (builder == null || context == null) {</span>
<span class="nc" id="L626">                return;</span>
            }

            // using a copy of the map to avoid concurrency problems
<span class="nc" id="L630">            ArrayMap&lt;Integer, Bundle&gt; tmpMap = new ArrayMap&lt;&gt;(mGCMMessageHandler.mActiveNotificationsMap);</span>
            // first remove 2fa push from the map, so it's not shown in the inbox style group notif
<span class="nc" id="L632">            tmpMap.remove(AUTH_PUSH_NOTIFICATION_ID);</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">            if (tmpMap.size() &gt; 1) {</span>
<span class="nc" id="L634">                NotificationCompat.InboxStyle inboxStyle = new NotificationCompat.InboxStyle();</span>
<span class="nc" id="L635">                int noteCtr = 1;</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                for (Bundle pushBundle : tmpMap.values()) {</span>
                    // InboxStyle notification is limited to 5 lines
<span class="nc bnc" id="L638" title="All 2 branches missed.">                    if (noteCtr &gt; MAX_INBOX_ITEMS) {</span>
<span class="nc" id="L639">                        break;</span>
                    }
<span class="nc bnc" id="L641" title="All 4 branches missed.">                    if (pushBundle == null || pushBundle.getString(PUSH_ARG_MSG) == null) {</span>
<span class="nc" id="L642">                        continue;</span>
                    }

<span class="nc bnc" id="L645" title="All 2 branches missed.">                    if (pushBundle.getString(PUSH_ARG_TYPE, &quot;&quot;).equals(PUSH_TYPE_COMMENT)) {</span>
<span class="nc" id="L646">                        String pnTitle = StringEscapeUtils.unescapeHtml4((pushBundle.getString(PUSH_ARG_TITLE)));</span>
<span class="nc" id="L647">                        String pnMessage = StringEscapeUtils.unescapeHtml4((pushBundle.getString(PUSH_ARG_MSG)));</span>
<span class="nc" id="L648">                        inboxStyle.addLine(pnTitle + &quot;: &quot; + pnMessage);</span>
<span class="nc" id="L649">                    } else {</span>
<span class="nc" id="L650">                        String pnMessage = StringEscapeUtils.unescapeHtml4((pushBundle.getString(PUSH_ARG_MSG)));</span>
<span class="nc" id="L651">                        inboxStyle.addLine(pnMessage);</span>
                    }

<span class="nc" id="L654">                    noteCtr++;</span>
<span class="nc" id="L655">                }</span>

<span class="nc bnc" id="L657" title="All 2 branches missed.">                if (tmpMap.size() &gt; MAX_INBOX_ITEMS) {</span>
<span class="nc" id="L658">                    inboxStyle.setSummaryText(String.format(context.getString(R.string.more_notifications),</span>
<span class="nc" id="L659">                            tmpMap.size() - MAX_INBOX_ITEMS));</span>
                }

<span class="nc" id="L662">                String subject =</span>
<span class="nc" id="L663">                        String.format(context.getString(R.string.new_notifications), tmpMap.size());</span>
<span class="nc" id="L664">                NotificationCompat.Builder groupBuilder = new NotificationCompat.Builder(context,</span>
<span class="nc" id="L665">                        context.getString(R.string.notification_channel_normal_id))</span>
<span class="nc" id="L666">                        .setGroupAlertBehavior(NotificationCompat.GROUP_ALERT_CHILDREN)</span>
<span class="nc" id="L667">                        .setSmallIcon(R.drawable.ic_app_white_24dp)</span>
<span class="nc" id="L668">                        .setColor(context.getResources().getColor(R.color.primary_50))</span>
<span class="nc" id="L669">                        .setGroup(NOTIFICATION_GROUP_KEY)</span>
<span class="nc" id="L670">                        .setGroupSummary(true)</span>
<span class="nc" id="L671">                        .setAutoCancel(true)</span>
<span class="nc" id="L672">                        .setTicker(message)</span>
<span class="nc" id="L673">                        .setContentTitle(context.getString(R.string.app_name))</span>
<span class="nc" id="L674">                        .setContentText(subject)</span>
<span class="nc" id="L675">                        .setStyle(inboxStyle);</span>

<span class="nc" id="L677">                showWPComNotificationForBuilder(groupBuilder, context, wpcomNoteID, GROUP_NOTIFICATION_ID, false,</span>
                        NotificationType.GROUP_NOTIFICATION);
<span class="nc" id="L679">            } else {</span>
                // Set the individual notification we've already built as the group summary
<span class="nc" id="L681">                builder.setGroupSummary(true)</span>
<span class="nc" id="L682">                       .setGroupAlertBehavior(NotificationCompat.GROUP_ALERT_CHILDREN);</span>
<span class="nc" id="L683">                showWPComNotificationForBuilder(builder, context, wpcomNoteID, GROUP_NOTIFICATION_ID, false,</span>
                        NotificationType.GROUP_NOTIFICATION);
            }
<span class="nc" id="L686">        }</span>

        private void showSingleNotificationForBuilder(Context context, NotificationCompat.Builder builder,
                                                      String noteType, String wpcomNoteID, int pushId,
                                                      boolean notifyUser) {
<span class="nc bnc" id="L691" title="All 4 branches missed.">            if (builder == null || context == null) {</span>
<span class="nc" id="L692">                return;</span>
            }

<span class="nc bnc" id="L695" title="All 2 branches missed.">            if (noteType.equals(PUSH_TYPE_COMMENT)) {</span>
<span class="nc" id="L696">                addActionsForCommentNotification(context, builder, wpcomNoteID);</span>
            }

<span class="nc" id="L699">            showWPComNotificationForBuilder(builder, context, wpcomNoteID, pushId, notifyUser, fromNoteType(noteType));</span>
<span class="nc" id="L700">        }</span>

        private NotificationType fromNoteType(String noteType) {
<span class="nc bnc" id="L703" title="All 12 branches missed.">            switch (noteType) {</span>
                case PUSH_TYPE_COMMENT:
<span class="nc" id="L705">                    return NotificationType.COMMENT;</span>
                case PUSH_TYPE_LIKE:
<span class="nc" id="L707">                    return NotificationType.LIKE;</span>
                case PUSH_TYPE_COMMENT_LIKE:
<span class="nc" id="L709">                    return NotificationType.COMMENT_LIKE;</span>
                case PUSH_TYPE_AUTOMATTCHER:
<span class="nc" id="L711">                    return NotificationType.AUTOMATTCHER;</span>
                case PUSH_TYPE_FOLLOW:
<span class="nc" id="L713">                    return NotificationType.FOLLOW;</span>
                case PUSH_TYPE_REBLOG:
<span class="nc" id="L715">                    return NotificationType.REBLOG;</span>
                case PUSH_TYPE_PUSH_AUTH:
<span class="nc" id="L717">                    return NotificationType.AUTHENTICATION;</span>
                case PUSH_TYPE_BADGE_RESET:
<span class="nc" id="L719">                    return NotificationType.BADGE_RESET;</span>
                case PUSH_TYPE_NOTE_DELETE:
<span class="nc" id="L721">                    return NotificationType.NOTE_DELETE;</span>
                case PUSH_TYPE_TEST_NOTE:
<span class="nc" id="L723">                    return NotificationType.TEST_NOTE;</span>
                case PUSH_TYPE_ZENDESK:
<span class="nc" id="L725">                    return NotificationType.ZENDESK;</span>
                default:
<span class="nc" id="L727">                    return UNKNOWN_NOTE;</span>
            }
        }

        private void showWPComNotificationForBuilder(NotificationCompat.Builder builder, Context context,
                                                     String wpcomNoteID, int pushId, boolean notifyUser,
                                                     NotificationType notificationType) {
<span class="nc" id="L734">            Intent resultIntent = new Intent(context, WPMainActivity.class);</span>
<span class="nc" id="L735">            resultIntent.putExtra(WPMainActivity.ARG_OPENED_FROM_PUSH, true);</span>
<span class="nc" id="L736">            resultIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK</span>
                                  | Intent.FLAG_ACTIVITY_CLEAR_TASK);
<span class="nc" id="L738">            resultIntent.setAction(&quot;android.intent.action.MAIN&quot;);</span>
<span class="nc" id="L739">            resultIntent.addCategory(&quot;android.intent.category.LAUNCHER&quot;);</span>
<span class="nc" id="L740">            resultIntent.putExtra(NotificationsListFragment.NOTE_ID_EXTRA, wpcomNoteID);</span>
<span class="nc" id="L741">            resultIntent.putExtra(IS_TAPPED_ON_NOTIFICATION, true);</span>

<span class="nc" id="L743">            showNotificationForBuilder(builder, context, resultIntent, pushId, notifyUser, notificationType);</span>
<span class="nc" id="L744">        }</span>

        // Displays a notification to the user
        private void showNotificationForBuilder(NotificationCompat.Builder builder, Context context,
                                                Intent resultIntent, int pushId, boolean notifyUser,
                                                NotificationType notificationType) {
<span class="nc bnc" id="L750" title="All 6 branches missed.">            if (builder == null || context == null || resultIntent == null) {</span>
<span class="nc" id="L751">                return;</span>
            }

<span class="nc" id="L754">            SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span>
<span class="nc" id="L755">            boolean shouldReceiveNotifications =</span>
<span class="nc" id="L756">                    prefs.getBoolean(context.getString(R.string.wp_pref_notifications_main), true);</span>

<span class="nc bnc" id="L758" title="All 2 branches missed.">            if (shouldReceiveNotifications) {</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">                if (notifyUser) {</span>
<span class="nc" id="L760">                    boolean shouldVibrate = prefs.getBoolean(</span>
<span class="nc" id="L761">                            context.getString(R.string.wp_pref_notification_vibrate), false);</span>
<span class="nc" id="L762">                    boolean shouldBlinkLight = prefs.getBoolean(</span>
<span class="nc" id="L763">                            context.getString(R.string.wp_pref_notification_light), true);</span>
<span class="nc" id="L764">                    String notificationSound = prefs.getString(</span>
<span class="nc" id="L765">                            context.getString(R.string.wp_pref_custom_notification_sound),</span>
<span class="nc" id="L766">                            context.getString(</span>
                                    R.string.notification_settings_item_sights_and_sounds_choose_sound_default));

<span class="nc bnc" id="L769" title="All 2 branches missed.">                    if (!TextUtils.isEmpty(notificationSound)</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">                        &amp;&amp; !notificationSound.trim().toLowerCase(Locale.ROOT).startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L771">                        builder.setSound(Uri.parse(notificationSound));</span>
                    }

<span class="nc bnc" id="L774" title="All 2 branches missed.">                    if (shouldVibrate) {</span>
<span class="nc" id="L775">                        builder.setVibrate(new long[]{500, 500, 500});</span>
                    }
<span class="nc bnc" id="L777" title="All 2 branches missed.">                    if (shouldBlinkLight) {</span>
<span class="nc" id="L778">                        builder.setLights(0xff0000ff, 1000, 5000);</span>
                    }
<span class="nc" id="L780">                } else {</span>
<span class="nc" id="L781">                    builder.setVibrate(null);</span>
<span class="nc" id="L782">                    builder.setSound(null);</span>
                    // Do not turn the led off otherwise the previous (single) notification led is not shown.
                    // We're re-using the same builder for single and group.
                }

                // Call processing service when notification is dismissed
<span class="nc" id="L788">                PendingIntent pendingDeleteIntent =</span>
<span class="nc" id="L789">                        NotificationsProcessingService.getPendingIntentForNotificationDismiss(</span>
                                context,
                                pushId,
                                notificationType
                        );
<span class="nc" id="L794">                builder.setDeleteIntent(pendingDeleteIntent);</span>

<span class="nc" id="L796">                builder.setCategory(NotificationCompat.CATEGORY_SOCIAL);</span>

<span class="nc" id="L798">                resultIntent.putExtra(ARG_NOTIFICATION_TYPE, notificationType);</span>
<span class="nc" id="L799">                PendingIntent pendingIntent = PendingIntent.getActivity(</span>
                        context,
                        pushId,
                        resultIntent,
                        PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_UPDATE_CURRENT
                        | PendingIntent.FLAG_IMMUTABLE
                );
<span class="nc" id="L806">                builder.setContentIntent(pendingIntent);</span>
<span class="nc" id="L807">                NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);</span>
<span class="nc" id="L808">                notificationManager.notify(pushId, builder.build());</span>
<span class="nc" id="L809">                mSystemNotificationsTracker.trackShownNotification(notificationType);</span>
            }
<span class="nc" id="L811">        }</span>

        private void rebuildAndUpdateNotificationsOnSystemBar(Context context, Bundle data) {
<span class="nc" id="L814">            String noteType = StringUtils.notNullStr(data.getString(PUSH_ARG_TYPE));</span>

            // Check for wpcom auth push, if so we will process this push differently
            // and we'll remove the auth special notif out of the map while we re-build the remaining notifs
<span class="nc" id="L818">            ArrayMap&lt;Integer, Bundle&gt; tmpMap = new ArrayMap&lt;&gt;(mGCMMessageHandler.mActiveNotificationsMap);</span>
<span class="nc" id="L819">            Bundle authPNBundle = tmpMap.remove(AUTH_PUSH_NOTIFICATION_ID);</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">            if (authPNBundle != null) {</span>
<span class="nc" id="L821">                handlePushAuth(context, authPNBundle);</span>
<span class="nc bnc" id="L822" title="All 4 branches missed.">                if (tmpMap.size() &gt; 0 &amp;&amp; noteType.equals(PUSH_TYPE_PUSH_AUTH)) {</span>
                    // get the data for the next notification in map for re-build
                    // because otherwise we would be keeping the PUSH_AUTH type note in `data`
<span class="nc" id="L825">                    data = tmpMap.values().iterator().next();</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">                } else if (noteType.equals(PUSH_TYPE_PUSH_AUTH)) {</span>
                    // only note is the 2fa note, just return
<span class="nc" id="L828">                    return;</span>
                }
            }


<span class="nc" id="L833">            Bitmap largeIconBitmap = null;</span>
            // here notify the existing group notification by eliminating the line that is now gone
<span class="nc" id="L835">            String title = getNotificationTitleOrAppNameFromBundle(context, data);</span>
<span class="nc" id="L836">            String message = StringEscapeUtils.unescapeHtml4(data.getString(PUSH_ARG_MSG));</span>

<span class="nc" id="L838">            NotificationCompat.Builder builder = null;</span>
<span class="nc" id="L839">            String wpcomNoteID = null;</span>

<span class="nc bnc" id="L841" title="All 2 branches missed.">            if (tmpMap.size() == 1) {</span>
                // only one notification remains, so get the proper message for it and re-instate
                // in the system dashboard
<span class="nc" id="L844">                Bundle remainingNote = tmpMap.values().iterator().next();</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                if (remainingNote != null) {</span>
<span class="nc" id="L846">                    String remainingNoteTitle =</span>
<span class="nc" id="L847">                            StringEscapeUtils.unescapeHtml4(remainingNote.getString(PUSH_ARG_TITLE));</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">                    if (!TextUtils.isEmpty(remainingNoteTitle)) {</span>
<span class="nc" id="L849">                        title = remainingNoteTitle;</span>
                    }
<span class="nc" id="L851">                    String remainingNoteMessage =</span>
<span class="nc" id="L852">                            StringEscapeUtils.unescapeHtml4(remainingNote.getString(PUSH_ARG_MSG));</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                    if (!TextUtils.isEmpty(remainingNoteMessage)) {</span>
<span class="nc" id="L854">                        message = remainingNoteMessage;</span>
                    }
<span class="nc" id="L856">                    largeIconBitmap = getLargeIconBitmap(context, remainingNote.getString(&quot;icon&quot;),</span>
<span class="nc" id="L857">                            shouldCircularizeNoteIcon(</span>
<span class="nc" id="L858">                                    remainingNote.getString(PUSH_ARG_TYPE)));</span>

<span class="nc" id="L860">                    builder = getNotificationBuilder(context, title, message);</span>

                    // set timestamp for note: first try with the notification timestamp, then try google's sent time
                    // if not available; finally just set the system's current time if everything
                    // else fails (not likely)
<span class="nc" id="L865">                    long timeStampToShow =</span>
<span class="nc" id="L866">                            DateTimeUtils.timestampFromIso8601Millis(remainingNote.getString(&quot;note_timestamp&quot;));</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">                    timeStampToShow = timeStampToShow != 0 ? timeStampToShow</span>
<span class="nc" id="L868">                            : remainingNote.getLong(&quot;google.sent_time&quot;, System.currentTimeMillis());</span>
<span class="nc" id="L869">                    builder.setWhen(timeStampToShow);</span>

<span class="nc" id="L871">                    noteType = StringUtils.notNullStr(remainingNote.getString(PUSH_ARG_TYPE));</span>
<span class="nc" id="L872">                    wpcomNoteID = remainingNote.getString(PUSH_ARG_NOTE_ID, &quot;&quot;);</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">                    if (!tmpMap.isEmpty()) {</span>
<span class="nc" id="L874">                        showSingleNotificationForBuilder(context, builder, noteType, wpcomNoteID,</span>
<span class="nc" id="L875">                                tmpMap.keyAt(0), false);</span>
                    }
                }
            }

<span class="nc bnc" id="L880" title="All 2 branches missed.">            if (builder == null) {</span>
<span class="nc" id="L881">                builder = getNotificationBuilder(context, title, message);</span>
            }

<span class="nc bnc" id="L884" title="All 2 branches missed.">            if (largeIconBitmap == null) {</span>
<span class="nc" id="L885">                largeIconBitmap = getLargeIconBitmap(context, data.getString(&quot;icon&quot;),</span>
<span class="nc" id="L886">                        shouldCircularizeNoteIcon(PUSH_TYPE_BADGE_RESET));</span>
            }

<span class="nc bnc" id="L889" title="All 2 branches missed.">            if (wpcomNoteID == null) {</span>
<span class="nc" id="L890">                wpcomNoteID = AppPrefs.getLastPushNotificationWpcomNoteId();</span>
            }

<span class="nc bnc" id="L893" title="All 2 branches missed.">            if (largeIconBitmap != null) {</span>
<span class="nc" id="L894">                builder.setLargeIcon(largeIconBitmap);</span>
            }

<span class="nc" id="L897">            showGroupNotificationForBuilder(context, builder, wpcomNoteID, message);</span>
<span class="nc" id="L898">        }</span>

        private String getNotificationTitleOrAppNameFromBundle(Context context, Bundle data) {
<span class="nc" id="L901">            String title = StringEscapeUtils.unescapeHtml4(data.getString(PUSH_ARG_TITLE));</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">            if (title == null) {</span>
<span class="nc" id="L903">                title = context.getString(R.string.app_name);</span>
            }
<span class="nc" id="L905">            return title;</span>
        }

        // Clear all notifications
        private void handleBadgeResetPN(Context context, Bundle data) {
<span class="nc bnc" id="L910" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L911">                return;</span>
            }

<span class="nc" id="L914">            String noteID = data.getString(PUSH_ARG_NOTE_ID, &quot;&quot;);</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">            if (!TextUtils.isEmpty(noteID)) {</span>
<span class="nc" id="L916">                Note note = NotificationsTable.getNoteById(noteID);</span>
                // mark the note as read if it's unread and update the DB silently
<span class="nc bnc" id="L918" title="All 4 branches missed.">                if (note != null &amp;&amp; note.isUnread()) {</span>
<span class="nc" id="L919">                    note.setRead();</span>
<span class="nc" id="L920">                    NotificationsTable.saveNote(note);</span>
                }


<span class="nc" id="L924">                mGCMMessageHandler.removeNotificationWithNoteIdFromSystemBar(context, noteID);</span>
                // now that we cleared the specific notif, we can check and make any visual updates
<span class="nc bnc" id="L926" title="All 2 branches missed.">                if (mGCMMessageHandler.mActiveNotificationsMap.size() &gt; 0) {</span>
<span class="nc" id="L927">                    rebuildAndUpdateNotificationsOnSystemBar(context, data);</span>
                }
<span class="nc" id="L929">            } else {</span>
<span class="nc" id="L930">                mGCMMessageHandler.removeAllNotifications(context);</span>
            }

<span class="nc" id="L933">            EventBus.getDefault().post(new NotificationEvents.NotificationsChanged(</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">                    mGCMMessageHandler.mActiveNotificationsMap.size() &gt; 0));</span>
<span class="nc" id="L935">        }</span>

        private void handleNoteDeletePN(Context context, Bundle data) {
<span class="nc bnc" id="L938" title="All 4 branches missed.">            if (data == null || !data.containsKey(PUSH_ARG_NOTE_ID)) {</span>
<span class="nc" id="L939">                return;</span>
            }

<span class="nc" id="L942">            String noteID = data.getString(PUSH_ARG_NOTE_ID, &quot;&quot;);</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">            if (!TextUtils.isEmpty(noteID)) {</span>
<span class="nc" id="L944">                NotificationsTable.deleteNoteById(noteID);</span>
            }

<span class="nc" id="L947">            mGCMMessageHandler.removeNotificationWithNoteIdFromSystemBar(context, noteID);</span>
            // now that we cleared the specific notif, we can check and make any visual updates
<span class="nc bnc" id="L949" title="All 2 branches missed.">            if (mGCMMessageHandler.mActiveNotificationsMap.size() &gt; 0) {</span>
<span class="nc" id="L950">                rebuildAndUpdateNotificationsOnSystemBar(context, data);</span>
            }

<span class="nc" id="L953">            EventBus.getDefault().post(new NotificationEvents.NotificationsChanged(</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">                    mGCMMessageHandler.mActiveNotificationsMap.size() &gt; 0));</span>
<span class="nc" id="L955">        }</span>

        // Show a notification for two-step auth users who log in from a web browser
        private void handlePushAuth(Context context, Bundle data) {
<span class="nc bnc" id="L959" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L960">                return;</span>
            }

<span class="nc" id="L963">            String pushAuthToken = data.getString(&quot;push_auth_token&quot;, &quot;&quot;);</span>
<span class="nc" id="L964">            String title = data.getString(&quot;title&quot;, &quot;&quot;);</span>
<span class="nc" id="L965">            String message = data.getString(&quot;msg&quot;, &quot;&quot;);</span>
<span class="nc" id="L966">            long expirationTimestamp = Long.valueOf(data.getString(&quot;expires&quot;, &quot;0&quot;));</span>

            // No strings, no service
<span class="nc bnc" id="L969" title="All 6 branches missed.">            if (TextUtils.isEmpty(pushAuthToken) || TextUtils.isEmpty(title) || TextUtils.isEmpty(message)) {</span>
<span class="nc" id="L970">                return;</span>
            }

            // Show authorization intent
<span class="nc" id="L974">            Intent pushAuthIntent = new Intent(context, WPMainActivity.class);</span>
<span class="nc" id="L975">            pushAuthIntent.putExtra(WPMainActivity.ARG_OPENED_FROM_PUSH, true);</span>
<span class="nc" id="L976">            pushAuthIntent.putExtra(NotificationsUtils.ARG_PUSH_AUTH_TOKEN, pushAuthToken);</span>
<span class="nc" id="L977">            pushAuthIntent.putExtra(NotificationsUtils.ARG_PUSH_AUTH_TITLE, title);</span>
<span class="nc" id="L978">            pushAuthIntent.putExtra(NotificationsUtils.ARG_PUSH_AUTH_MESSAGE, message);</span>
<span class="nc" id="L979">            pushAuthIntent.putExtra(NotificationsUtils.ARG_PUSH_AUTH_EXPIRES, expirationTimestamp);</span>
<span class="nc" id="L980">            pushAuthIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK</span>
                                    | Intent.FLAG_ACTIVITY_CLEAR_TASK);
<span class="nc" id="L982">            pushAuthIntent.setAction(&quot;android.intent.action.MAIN&quot;);</span>
<span class="nc" id="L983">            pushAuthIntent.addCategory(&quot;android.intent.category.LAUNCHER&quot;);</span>
<span class="nc" id="L984">            NotificationType notificationType = NotificationType.AUTHENTICATION;</span>
<span class="nc" id="L985">            pushAuthIntent.putExtra(ARG_NOTIFICATION_TYPE, notificationType);</span>

<span class="nc" id="L987">            NotificationCompat.Builder builder = new NotificationCompat.Builder(context,</span>
<span class="nc" id="L988">                    context.getString(R.string.notification_channel_important_id))</span>
<span class="nc" id="L989">                    .setSmallIcon(R.drawable.ic_app_white_24dp)</span>
<span class="nc" id="L990">                    .setColor(context.getResources().getColor(R.color.primary_50))</span>
<span class="nc" id="L991">                    .setContentTitle(title)</span>
<span class="nc" id="L992">                    .setContentText(message)</span>
<span class="nc" id="L993">                    .setAutoCancel(true)</span>
<span class="nc" id="L994">                    .setStyle(new NotificationCompat.BigTextStyle().bigText(message))</span>
<span class="nc" id="L995">                    .setOnlyAlertOnce(true)</span>
<span class="nc" id="L996">                    .setPriority(NotificationCompat.PRIORITY_MAX);</span>

<span class="nc" id="L998">            PendingIntent pendingIntent = PendingIntent.getActivity(</span>
                    context,
                    AUTH_PUSH_REQUEST_CODE_OPEN_DIALOG,
                    pushAuthIntent,
                    PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
            );
<span class="nc" id="L1004">            builder.setContentIntent(pendingIntent);</span>


            // adding ignore / approve quick actions
<span class="nc" id="L1008">            Intent authApproveIntent = new Intent(context, WPMainActivity.class);</span>
<span class="nc" id="L1009">            authApproveIntent.putExtra(WPMainActivity.ARG_OPENED_FROM_PUSH, true);</span>
<span class="nc" id="L1010">            authApproveIntent.putExtra(NotificationsProcessingService.ARG_ACTION_TYPE,</span>
                    NotificationsProcessingService.ARG_ACTION_AUTH_APPROVE);
<span class="nc" id="L1012">            authApproveIntent.putExtra(NotificationsUtils.ARG_PUSH_AUTH_TOKEN, pushAuthToken);</span>
<span class="nc" id="L1013">            authApproveIntent.putExtra(NotificationsUtils.ARG_PUSH_AUTH_TITLE, title);</span>
<span class="nc" id="L1014">            authApproveIntent.putExtra(NotificationsUtils.ARG_PUSH_AUTH_MESSAGE, message);</span>
<span class="nc" id="L1015">            authApproveIntent.putExtra(NotificationsUtils.ARG_PUSH_AUTH_EXPIRES, expirationTimestamp);</span>

<span class="nc" id="L1017">            authApproveIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK</span>
                                       | Intent.FLAG_ACTIVITY_CLEAR_TASK);
<span class="nc" id="L1019">            authApproveIntent.setAction(&quot;android.intent.action.MAIN&quot;);</span>
<span class="nc" id="L1020">            authApproveIntent.addCategory(&quot;android.intent.category.LAUNCHER&quot;);</span>

<span class="nc" id="L1022">            PendingIntent authApprovePendingIntent = PendingIntent.getActivity(</span>
                    context,
                    AUTH_PUSH_REQUEST_CODE_APPROVE,
                    authApproveIntent,
                    PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
            );

<span class="nc" id="L1029">            builder.addAction(R.drawable.ic_checkmark_white_24dp, context.getText(R.string.approve),</span>
                    authApprovePendingIntent);


<span class="nc" id="L1033">            Intent authIgnoreIntent = new Intent(context, NotificationsProcessingService.class);</span>
<span class="nc" id="L1034">            authIgnoreIntent.putExtra(NotificationsProcessingService.ARG_ACTION_TYPE,</span>
                    NotificationsProcessingService.ARG_ACTION_AUTH_IGNORE);
<span class="nc" id="L1036">            PendingIntent authIgnorePendingIntent = PendingIntent.getService(</span>
                    context,
                    AUTH_PUSH_REQUEST_CODE_IGNORE,
                    authIgnoreIntent,
                    PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_IMMUTABLE
            );
<span class="nc" id="L1042">            builder.addAction(R.drawable.ic_close_white_24dp, context.getText(R.string.ignore),</span>
                    authIgnorePendingIntent);


            // Call processing service when notification is dismissed
<span class="nc" id="L1047">            PendingIntent pendingDeleteIntent =</span>
<span class="nc" id="L1048">                    NotificationsProcessingService.getPendingIntentForNotificationDismiss(</span>
                            context, AUTH_PUSH_NOTIFICATION_ID, notificationType);
<span class="nc" id="L1050">            builder.setDeleteIntent(pendingDeleteIntent);</span>

<span class="nc" id="L1052">            NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);</span>
<span class="nc" id="L1053">            notificationManager.notify(AUTH_PUSH_NOTIFICATION_ID, builder.build());</span>
<span class="nc" id="L1054">            mSystemNotificationsTracker.trackShownNotification(notificationType);</span>
<span class="nc" id="L1055">        }</span>

        // Returns true if the note type is known to have a gravatar
        private boolean shouldCircularizeNoteIcon(String noteType) {
<span class="nc bnc" id="L1059" title="All 2 branches missed.">            if (TextUtils.isEmpty(noteType)) {</span>
<span class="nc" id="L1060">                return false;</span>
            }

<span class="nc bnc" id="L1063" title="All 2 branches missed.">            switch (noteType) {</span>
                case PUSH_TYPE_COMMENT:
                case PUSH_TYPE_LIKE:
                case PUSH_TYPE_COMMENT_LIKE:
                case PUSH_TYPE_AUTOMATTCHER:
                case PUSH_TYPE_FOLLOW:
                case PUSH_TYPE_REBLOG:
<span class="nc" id="L1070">                    return true;</span>
                default:
<span class="nc" id="L1072">                    return false;</span>
            }
        }

        /**
         * Shows a notification stating that the user has a reply pending from Zendesk. Since Zendesk always sends a
         * notification with the same title and message, we use our own localized messaging. For the same reason,
         * we use a static push notification ID. Tapping on the notification will open the `ME` fragment.
         */
        void handleZendeskNotification(Context context) {
<span class="nc bnc" id="L1082" title="All 2 branches missed.">            if (context == null) {</span>
<span class="nc" id="L1083">                return;</span>
            }
<span class="nc" id="L1085">            String title = context.getString(R.string.support_push_notification_title);</span>
<span class="nc" id="L1086">            String message = context.getString(R.string.support_push_notification_message);</span>
<span class="nc" id="L1087">            Intent resultIntent = new Intent(context, WPMainActivity.class);</span>
<span class="nc" id="L1088">            resultIntent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);</span>
<span class="nc" id="L1089">            resultIntent.putExtra(WPMainActivity.ARG_SHOW_ZENDESK_NOTIFICATIONS, true);</span>
<span class="nc" id="L1090">            showSimpleNotification(context, title, message, resultIntent, ZENDESK_PUSH_NOTIFICATION_ID,</span>
                    NotificationType.ZENDESK);
<span class="nc" id="L1092">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>