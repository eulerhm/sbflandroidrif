<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostListEventListener.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PostListEventListener.kt</span></div><h1>PostListEventListener.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import androidx.lifecycle.Lifecycle
import androidx.lifecycle.LifecycleObserver
import androidx.lifecycle.OnLifecycleEvent
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Job
import kotlinx.coroutines.launch
import org.greenrobot.eventbus.EventBus
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode.BACKGROUND
import org.greenrobot.eventbus.ThreadMode.MAIN
import org.wordpress.android.R
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.model.CauseOfOnPostChanged
import org.wordpress.android.fluxc.model.CauseOfOnPostChanged.DeletePost
import org.wordpress.android.fluxc.model.CauseOfOnPostChanged.RemoteAutoSavePost
import org.wordpress.android.fluxc.model.CauseOfOnPostChanged.RemovePost
import org.wordpress.android.fluxc.model.CauseOfOnPostChanged.RestorePost
import org.wordpress.android.fluxc.model.LocalOrRemoteId.LocalId
import org.wordpress.android.fluxc.model.PostModel
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.MediaStore.OnMediaChanged
import org.wordpress.android.fluxc.store.MediaStore.OnMediaUploaded
import org.wordpress.android.fluxc.store.PostStore
import org.wordpress.android.fluxc.store.PostStore.OnPostChanged
import org.wordpress.android.fluxc.store.PostStore.OnPostUploaded
import org.wordpress.android.fluxc.store.PostStore.PostDeleteActionType.DELETE
import org.wordpress.android.fluxc.store.PostStore.PostDeleteActionType.TRASH
import org.wordpress.android.ui.posts.PostUploadAction.MediaUploadedSnackbar
import org.wordpress.android.ui.posts.PostUploadAction.PostRemotePreviewSnackbarError
import org.wordpress.android.ui.posts.PostUploadAction.PostUploadedSnackbar
import org.wordpress.android.ui.uploads.PostEvents
import org.wordpress.android.ui.uploads.ProgressEvent
import org.wordpress.android.ui.uploads.UploadService
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import javax.inject.Inject
import kotlin.coroutines.CoroutineContext

/**
 * This is a temporary class to make the PostListViewModel more manageable. Please feel free to refactor it any way
 * you see fit.
 */
<span class="nc" id="L46">class PostListEventListener(</span>
<span class="nc" id="L47">    private val lifecycle: Lifecycle,</span>
<span class="nc" id="L48">    private val dispatcher: Dispatcher,</span>
<span class="nc" id="L49">    private val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L50">    private val postStore: PostStore,</span>
<span class="nc" id="L51">    private val site: SiteModel,</span>
<span class="nc" id="L52">    private val postActionHandler: PostActionHandler,</span>
<span class="nc" id="L53">    private val handlePostUpdatedWithoutError: () -&gt; Unit,</span>
<span class="nc" id="L54">    private val handlePostUploadedWithoutError: (LocalId) -&gt; Unit,</span>
<span class="nc" id="L55">    private val triggerPostUploadAction: (PostUploadAction) -&gt; Unit,</span>
<span class="nc" id="L56">    private val invalidateUploadStatus: (List&lt;Int&gt;) -&gt; Unit,</span>
<span class="nc" id="L57">    private val invalidateFeaturedMedia: (List&lt;Long&gt;) -&gt; Unit,</span>
<span class="nc" id="L58">    private val triggerPreviewStateUpdate: (PostListRemotePreviewState, PostInfoType) -&gt; Unit,</span>
<span class="nc" id="L59">    private val isRemotePreviewingFromPostsList: () -&gt; Boolean,</span>
<span class="nc" id="L60">    private val hasRemoteAutoSavePreviewError: () -&gt; Boolean</span>
) : LifecycleObserver, CoroutineScope {
<span class="nc" id="L62">    init {</span>
<span class="nc" id="L63">        dispatcher.register(this)</span>
<span class="nc" id="L64">        EventBus.getDefault().register(this)</span>
<span class="nc" id="L65">        lifecycle.addObserver(this)</span>
<span class="nc" id="L66">    }</span>

<span class="nc" id="L68">    private var job: Job = Job()</span>

    override val coroutineContext: CoroutineContext
<span class="nc" id="L71">        get() = bgDispatcher + job</span>

    private fun handleRemoteAutoSave(post: PostModel, isError: Boolean) {
<span class="nc bnc" id="L74" title="All 4 branches missed.">        if (isError || hasRemoteAutoSavePreviewError.invoke()) {</span>
<span class="nc" id="L75">            triggerPreviewStateUpdate(</span>
<span class="nc" id="L76">                    PostListRemotePreviewState.REMOTE_AUTO_SAVE_PREVIEW_ERROR,</span>
<span class="nc" id="L77">                    PostInfoType.PostNoInfo</span>
            )
<span class="nc" id="L79">            triggerPostUploadAction.invoke(PostRemotePreviewSnackbarError(R.string.remote_preview_operation_error))</span>
        } else {
<span class="nc" id="L81">            triggerPreviewStateUpdate(</span>
<span class="nc" id="L82">                    PostListRemotePreviewState.PREVIEWING,</span>
<span class="nc" id="L83">                    PostInfoType.PostInfo(post = post, hasError = isError)</span>
            )
        }
<span class="nc" id="L86">        uploadStatusChanged(post.id)</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (!isError) {</span>
<span class="nc" id="L88">            handlePostUploadedWithoutError.invoke(LocalId(post.id))</span>
        }
<span class="nc" id="L90">    }</span>

    /**
     * Handles the [Lifecycle.Event.ON_DESTROY] event to cleanup the registration for dispatcher and removing the
     * observer for lifecycle.
     */
    @OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)
    private fun onDestroy() {
<span class="nc" id="L98">        job.cancel()</span>
<span class="nc" id="L99">        lifecycle.removeObserver(this)</span>
<span class="nc" id="L100">        dispatcher.unregister(this)</span>
<span class="nc" id="L101">        EventBus.getDefault().unregister(this)</span>
<span class="nc" id="L102">    }</span>

    /**
     * Has lower priority than the PostUploadHandler and UploadService, which ensures that they already processed this
     * OnPostChanged event. This means we can safely rely on their internal state being up to date.
     */
    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = MAIN, priority = 5)
    fun onPostChanged(event: OnPostChanged) {
        // We need to subscribe on the MAIN thread, in order to ensure the priority parameter is taken into account.
        // However, we want to perform the body of the method on a background thread.
<span class="nc bnc" id="L113" title="All 2 branches missed.">        launch {</span>
<span class="nc" id="L114">            when (event.causeOfChange) {</span>
                // Fetched post list event will be handled by OnListChanged
<span class="nc bnc" id="L116" title="All 2 branches missed.">                is CauseOfOnPostChanged.UpdatePost -&gt; {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    if (event.isError) {</span>
<span class="nc" id="L118">                        AppLog.e(</span>
<span class="nc" id="L119">                                T.POSTS,</span>
<span class="nc" id="L120">                                &quot;Error updating the post with type: ${event.error.type} and&quot; +</span>
<span class="nc" id="L121">                                        &quot; message: ${event.error.message}&quot;</span>
                        )
                    } else {
<span class="nc" id="L124">                        handlePostUpdatedWithoutError.invoke()</span>
<span class="nc" id="L125">                        invalidateUploadStatus.invoke(</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                                listOf((event.causeOfChange as CauseOfOnPostChanged.UpdatePost).localPostId)</span>
                        )
                    }
                }
<span class="nc bnc" id="L130" title="All 2 branches missed.">                is CauseOfOnPostChanged.DeletePost -&gt; {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                    val deletePostCauseOfChange = event.causeOfChange as DeletePost</span>
<span class="nc" id="L132">                    val localPostId = LocalId(deletePostCauseOfChange.localPostId)</span>
<span class="nc bnc" id="L133" title="All 3 branches missed.">                    when (deletePostCauseOfChange.postDeleteActionType) {</span>
<span class="nc" id="L134">                        TRASH -&gt; postActionHandler.handlePostTrashed(localPostId = localPostId, isError = event.isError)</span>
<span class="nc" id="L135">                        DELETE -&gt; postActionHandler.handlePostDeletedOrRemoved(</span>
<span class="nc" id="L136">                                localPostId = localPostId,</span>
<span class="nc" id="L137">                                isRemoved = false,</span>
<span class="nc" id="L138">                                isError = event.isError</span>
                        )
                    }
                }
<span class="nc bnc" id="L142" title="All 2 branches missed.">                is CauseOfOnPostChanged.RestorePost -&gt; {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                    val localPostId = LocalId((event.causeOfChange as RestorePost).localPostId)</span>
<span class="nc" id="L144">                    postActionHandler.handlePostRestored(localPostId = localPostId, isError = event.isError)</span>
                }
<span class="nc bnc" id="L146" title="All 2 branches missed.">                is CauseOfOnPostChanged.RemovePost -&gt; {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                    val localPostId = LocalId((event.causeOfChange as RemovePost).localPostId)</span>
<span class="nc" id="L148">                    postActionHandler.handlePostDeletedOrRemoved(</span>
<span class="nc" id="L149">                            localPostId = localPostId,</span>
<span class="nc" id="L150">                            isRemoved = true,</span>
<span class="nc" id="L151">                            isError = event.isError</span>
                    )
                }
<span class="nc bnc" id="L154" title="All 2 branches missed.">                is CauseOfOnPostChanged.RemoteAutoSavePost -&gt; {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                    val post = postStore.getPostByLocalPostId((event.causeOfChange as RemoteAutoSavePost).localPostId)</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                    if (isRemotePreviewingFromPostsList.invoke()) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                        if (event.isError) {</span>
<span class="nc" id="L158">                            AppLog.d(T.POSTS, &quot;REMOTE_AUTO_SAVE_POST failed: &quot; +</span>
<span class="nc" id="L159">                                    event.error.type + &quot; - &quot; + event.error.message)</span>
                        }
<span class="nc" id="L161">                        handleRemoteAutoSave(post, event.isError)</span>
                    } else {
<span class="nc" id="L163">                        uploadStatusChanged(post.id)</span>
                    }
                }
            }
<span class="nc" id="L167">        }</span>
<span class="nc" id="L168">    }</span>

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onMediaChanged(event: OnMediaChanged) {
<span class="nc bnc" id="L173" title="All 4 branches missed.">        if (!event.isError &amp;&amp; event.mediaList != null) {</span>
<span class="nc" id="L174">            featuredMediaChanged(*event.mediaList.map { it.mediaId }.toLongArray())</span>
<span class="nc" id="L175">            uploadStatusChanged(*event.mediaList.map { it.localPostId }.toIntArray())</span>
        }
<span class="nc" id="L177">    }</span>

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onPostUploaded(event: OnPostUploaded) {
<span class="nc bnc" id="L182" title="All 4 branches missed.">        if (event.post != null &amp;&amp; event.post.localSiteId == site.id) {</span>
<span class="nc bnc" id="L183" title="All 4 branches missed.">            if (!isRemotePreviewingFromPostsList.invoke() &amp;&amp; !isRemotePreviewingFromEditor(event.post)) {</span>
<span class="nc" id="L184">                triggerPostUploadAction.invoke(</span>
<span class="nc" id="L185">                        PostUploadedSnackbar(</span>
<span class="nc" id="L186">                                dispatcher,</span>
<span class="nc" id="L187">                                site,</span>
<span class="nc" id="L188">                                event.post,</span>
<span class="nc" id="L189">                                event.isError,</span>
<span class="nc" id="L190">                                event.isFirstTimePublish,</span>
<span class="nc" id="L191">                                null</span>
                        )
                )
            }

<span class="nc" id="L196">            uploadStatusChanged(event.post.id)</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (!event.isError) {</span>
<span class="nc" id="L198">                handlePostUploadedWithoutError.invoke(LocalId(event.post.id))</span>
            }

<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (isRemotePreviewingFromPostsList.invoke()) {</span>
<span class="nc" id="L202">                handleRemoteAutoSave(event.post, event.isError)</span>
            }
        }
<span class="nc" id="L205">    }</span>

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onMediaUploaded(event: OnMediaUploaded) {
<span class="nc bnc" id="L210" title="All 4 branches missed.">        if (event.isError || event.canceled) {</span>
<span class="nc" id="L211">            return</span>
        }
<span class="nc bnc" id="L213" title="All 6 branches missed.">        if (event.media == null || event.media.localPostId == 0 || site.id != event.media.localSiteId) {</span>
            // Not interested in media not attached to posts or not belonging to the current site
<span class="nc" id="L215">            return</span>
        }
<span class="nc" id="L217">        featuredMediaChanged(event.media.mediaId)</span>
<span class="nc" id="L218">        uploadStatusChanged(event.media.localPostId)</span>
<span class="nc" id="L219">    }</span>

    // EventBus Events

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onEventBackgroundThread(event: UploadService.UploadErrorEvent) {
<span class="nc" id="L226">        EventBus.getDefault().removeStickyEvent(event)</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (event.post != null) {</span>
<span class="nc" id="L228">            triggerPostUploadAction.invoke(</span>
<span class="nc" id="L229">                    PostUploadedSnackbar(</span>
<span class="nc" id="L230">                            dispatcher,</span>
<span class="nc" id="L231">                            site,</span>
<span class="nc" id="L232">                            event.post,</span>
<span class="nc" id="L233">                            true,</span>
<span class="nc" id="L234">                            false,</span>
<span class="nc" id="L235">                            event.errorMessage</span>
                    )
            )
<span class="nc bnc" id="L238" title="All 4 branches missed.">        } else if (event.mediaModelList != null &amp;&amp; !event.mediaModelList.isEmpty()) {</span>
<span class="nc" id="L239">            triggerPostUploadAction.invoke(MediaUploadedSnackbar(site, event.mediaModelList, true, event.errorMessage))</span>
        }
<span class="nc" id="L241">    }</span>

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onEventBackgroundThread(event: UploadService.UploadMediaSuccessEvent) {
<span class="nc" id="L246">        EventBus.getDefault().removeStickyEvent(event)</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">        if (event.mediaModelList != null &amp;&amp; !event.mediaModelList.isEmpty()) {</span>
<span class="nc" id="L248">            triggerPostUploadAction.invoke(</span>
<span class="nc" id="L249">                    MediaUploadedSnackbar(site, event.mediaModelList, false, event.successMessage)</span>
            )
        }
<span class="nc" id="L252">    }</span>

    /**
     * Upload started, reload so correct status on uploading post appears
     */
    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onEventBackgroundThread(event: PostEvents.PostUploadStarted) {
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (site.id == event.post.localSiteId) {</span>
<span class="nc" id="L261">            uploadStatusChanged(event.post.id)</span>
        }
<span class="nc" id="L263">    }</span>

    /**
     * Upload cancelled (probably due to failed media), reload so correct status on uploading post appears
     */
    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onEventBackgroundThread(event: PostEvents.PostUploadCanceled) {
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (site.id == event.post.localSiteId) {</span>
<span class="nc" id="L272">            uploadStatusChanged(event.post.id)</span>
        }
<span class="nc" id="L274">    }</span>

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onEventBackgroundThread(event: ProgressEvent) {
<span class="nc" id="L279">        uploadStatusChanged(event.media.localPostId)</span>
<span class="nc" id="L280">    }</span>

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = BACKGROUND)
    fun onEventBackgroundThread(event: UploadService.UploadMediaRetryEvent) {
<span class="nc bnc" id="L285" title="All 4 branches missed.">        if (event.mediaModelList != null &amp;&amp; !event.mediaModelList.isEmpty()) {</span>
            // if there' a Post to which the retried media belongs, clear their status
<span class="nc" id="L287">            val postsToRefresh = PostUtils.getPostsThatIncludeAnyOfTheseMedia(postStore, event.mediaModelList)</span>
<span class="nc" id="L288">            uploadStatusChanged(*postsToRefresh.map { it.id }.toIntArray())</span>
        }
<span class="nc" id="L290">    }</span>

    private fun isRemotePreviewingFromEditor(post: PostModel?): Boolean {
<span class="nc" id="L293">        val previewedPost = EventBus.getDefault().getStickyEvent(PostEvents.PostPreviewingInEditor::class.java)</span>
<span class="nc bnc" id="L294" title="All 4 branches missed.">        return previewedPost != null &amp;&amp; post != null &amp;&amp;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                post.localSiteId == previewedPost.localSiteId &amp;&amp;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                post.id == previewedPost.postId</span>
    }

    private fun uploadStatusChanged(vararg localPostIds: Int) {
<span class="nc" id="L300">        invalidateUploadStatus.invoke(localPostIds.toList())</span>
<span class="nc" id="L301">    }</span>

    private fun featuredMediaChanged(vararg featuredImageIds: Long) {
<span class="nc" id="L304">        invalidateFeaturedMedia.invoke(featuredImageIds.toList())</span>
<span class="nc" id="L305">    }</span>

<span class="nc" id="L307">    class Factory @Inject constructor() {</span>
        fun createAndStartListening(
            lifecycle: Lifecycle,
            dispatcher: Dispatcher,
            bgDispatcher: CoroutineDispatcher,
            postStore: PostStore,
            site: SiteModel,
            postActionHandler: PostActionHandler,
            handlePostUpdatedWithoutError: () -&gt; Unit,
            handlePostUploadedWithoutError: (LocalId) -&gt; Unit,
            triggerPostUploadAction: (PostUploadAction) -&gt; Unit,
            invalidateUploadStatus: (List&lt;Int&gt;) -&gt; Unit,
            invalidateFeaturedMedia: (List&lt;Long&gt;) -&gt; Unit,
            triggerPreviewStateUpdate: (PostListRemotePreviewState, PostInfoType) -&gt; Unit,
            isRemotePreviewingFromPostsList: () -&gt; Boolean,
            hasRemoteAutoSavePreviewError: () -&gt; Boolean
        ) {
<span class="nc" id="L324">            PostListEventListener(</span>
<span class="nc" id="L325">                    lifecycle = lifecycle,</span>
<span class="nc" id="L326">                    dispatcher = dispatcher,</span>
<span class="nc" id="L327">                    bgDispatcher = bgDispatcher,</span>
<span class="nc" id="L328">                    postStore = postStore,</span>
<span class="nc" id="L329">                    site = site,</span>
<span class="nc" id="L330">                    postActionHandler = postActionHandler,</span>
<span class="nc" id="L331">                    handlePostUpdatedWithoutError = handlePostUpdatedWithoutError,</span>
<span class="nc" id="L332">                    handlePostUploadedWithoutError = handlePostUploadedWithoutError,</span>
<span class="nc" id="L333">                    triggerPostUploadAction = triggerPostUploadAction,</span>
<span class="nc" id="L334">                    invalidateUploadStatus = invalidateUploadStatus,</span>
<span class="nc" id="L335">                    invalidateFeaturedMedia = invalidateFeaturedMedia,</span>
<span class="nc" id="L336">                    triggerPreviewStateUpdate = triggerPreviewStateUpdate,</span>
<span class="nc" id="L337">                    isRemotePreviewingFromPostsList = isRemotePreviewingFromPostsList,</span>
<span class="nc" id="L338">                    hasRemoteAutoSavePreviewError = hasRemoteAutoSavePreviewError)</span>
<span class="nc" id="L339">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>