<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WPMainActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.main</a> &gt; <span class="el_source">WPMainActivity.java</span></div><h1>WPMainActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.main;

import android.app.Activity;
import android.app.Dialog;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.content.pm.ResolveInfo;
import android.net.Uri;
import android.os.Bundle;
import android.os.Handler;
import android.os.Looper;
import android.text.TextUtils;
import android.view.HapticFeedbackConstants;
import android.view.View;
import android.view.ViewGroup;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.core.app.NotificationManagerCompat;
import androidx.core.app.RemoteInput;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.lifecycle.ViewModelProvider;

import com.google.android.gms.common.ConnectionResult;
import com.google.android.gms.common.GoogleApiAvailability;
import com.google.android.material.floatingactionbutton.FloatingActionButton;

import org.greenrobot.eventbus.EventBus;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.wordpress.android.BuildConfig;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.generated.AccountActionBuilder;
import org.wordpress.android.fluxc.generated.SiteActionBuilder;
import org.wordpress.android.fluxc.model.AccountModel;
import org.wordpress.android.fluxc.model.PostModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.network.rest.wpcom.site.PrivateAtomicCookie;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.AccountStore.AuthenticationErrorType;
import org.wordpress.android.fluxc.store.AccountStore.OnAccountChanged;
import org.wordpress.android.fluxc.store.AccountStore.OnAuthenticationChanged;
import org.wordpress.android.fluxc.store.AccountStore.UpdateTokenPayload;
import org.wordpress.android.fluxc.store.PostStore;
import org.wordpress.android.fluxc.store.PostStore.OnPostUploaded;
import org.wordpress.android.fluxc.store.QuickStartStore;
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartExistingSiteTask;
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartNewSiteTask;
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTask;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.store.SiteStore.CompleteQuickStartPayload;
import org.wordpress.android.fluxc.store.SiteStore.OnAllSitesMobileEditorChanged;
import org.wordpress.android.fluxc.store.SiteStore.OnQuickStartCompleted;
import org.wordpress.android.fluxc.store.SiteStore.OnSiteChanged;
import org.wordpress.android.fluxc.store.SiteStore.OnSiteEditorsChanged;
import org.wordpress.android.fluxc.store.SiteStore.OnSiteRemoved;
import org.wordpress.android.login.LoginAnalyticsListener;
import org.wordpress.android.networking.ConnectionChangeReceiver;
import org.wordpress.android.push.GCMMessageHandler;
import org.wordpress.android.push.GCMMessageService;
import org.wordpress.android.push.GCMRegistrationIntentService;
import org.wordpress.android.push.NativeNotificationsUtils;
import org.wordpress.android.push.NotificationType;
import org.wordpress.android.push.NotificationsProcessingService;
import org.wordpress.android.ui.ActivityId;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.JetpackConnectionSource;
import org.wordpress.android.ui.JetpackConnectionWebViewActivity;
import org.wordpress.android.ui.LocaleAwareActivity;
import org.wordpress.android.ui.PagePostCreationSourcesDetail;
import org.wordpress.android.ui.RequestCodes;
import org.wordpress.android.ui.ShortcutsNavigator;
import org.wordpress.android.ui.WPTooltipView;
import org.wordpress.android.ui.accounts.LoginActivity;
import org.wordpress.android.ui.accounts.SignupEpilogueActivity;
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingDialogFragment;
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingDialogFragment.DialogType;
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsReminderSchedulerListener;
import org.wordpress.android.ui.bloggingreminders.BloggingReminderUtils;
import org.wordpress.android.ui.bloggingreminders.BloggingRemindersViewModel;
import org.wordpress.android.ui.main.WPMainNavigationView.OnPageListener;
import org.wordpress.android.ui.main.WPMainNavigationView.PageType;
import org.wordpress.android.ui.mlp.ModalLayoutPickerFragment;
import org.wordpress.android.ui.mysite.MySiteFragment;
import org.wordpress.android.ui.mysite.MySiteViewModel;
import org.wordpress.android.ui.mysite.SelectedSiteRepository;
import org.wordpress.android.ui.mysite.cards.quickstart.QuickStartRepository;
import org.wordpress.android.ui.mysite.tabs.BloggingPromptsOnboardingListener;
import org.wordpress.android.ui.notifications.NotificationEvents;
import org.wordpress.android.ui.notifications.NotificationsListFragment;
import org.wordpress.android.ui.notifications.SystemNotificationsTracker;
import org.wordpress.android.ui.notifications.adapters.NotesAdapter;
import org.wordpress.android.ui.notifications.receivers.NotificationsPendingDraftsReceiver;
import org.wordpress.android.ui.notifications.utils.NotificationsActions;
import org.wordpress.android.ui.notifications.utils.NotificationsUtils;
import org.wordpress.android.ui.notifications.utils.PendingDraftsNotificationsUtils;
import org.wordpress.android.ui.photopicker.MediaPickerLauncher;
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogNegativeClickInterface;
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogPositiveClickInterface;
import org.wordpress.android.ui.posts.EditPostActivity;
import org.wordpress.android.ui.posts.PostUtils.EntryPoint;
import org.wordpress.android.ui.posts.QuickStartPromptDialogFragment.QuickStartPromptClickInterface;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.prefs.AppSettingsFragment;
import org.wordpress.android.ui.prefs.SiteSettingsFragment;
import org.wordpress.android.ui.quickstart.QuickStartMySitePrompts;
import org.wordpress.android.ui.quickstart.QuickStartTracker;
import org.wordpress.android.ui.reader.ReaderFragment;
import org.wordpress.android.ui.reader.services.update.ReaderUpdateLogic.UpdateTask;
import org.wordpress.android.ui.reader.services.update.ReaderUpdateServiceStarter;
import org.wordpress.android.ui.reader.tracker.ReaderTracker;
import org.wordpress.android.ui.sitecreation.misc.SiteCreationSource;
import org.wordpress.android.ui.stats.StatsTimeframe;
import org.wordpress.android.ui.stats.intro.StatsNewFeaturesIntroDialogFragment;
import org.wordpress.android.ui.stories.intro.StoriesIntroDialogFragment;
import org.wordpress.android.ui.uploads.UploadActionUseCase;
import org.wordpress.android.ui.uploads.UploadUtils;
import org.wordpress.android.ui.uploads.UploadUtilsWrapper;
import org.wordpress.android.ui.whatsnew.FeatureAnnouncementDialogFragment;
import org.wordpress.android.util.AniUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.AuthenticationDialogUtils;
import org.wordpress.android.util.BuildConfigWrapper;
import org.wordpress.android.util.DeviceUtils;
import org.wordpress.android.util.FluxCUtils;
import org.wordpress.android.util.NetworkUtils;
import org.wordpress.android.util.ProfilingUtils;
import org.wordpress.android.util.QuickStartUtils;
import org.wordpress.android.util.QuickStartUtilsWrapper;
import org.wordpress.android.util.ShortcutUtils;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.WPActivityUtils;
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.util.analytics.service.InstallationReferrerServiceStarter;
import org.wordpress.android.util.config.MySiteDashboardTodaysStatsCardFeatureConfig;
import org.wordpress.android.util.config.StatsRevampV2FeatureConfig;
import org.wordpress.android.util.extensions.ViewExtensionsKt;
import org.wordpress.android.viewmodel.main.WPMainActivityViewModel;
import org.wordpress.android.viewmodel.main.WPMainActivityViewModel.FocusPointInfo;
import org.wordpress.android.viewmodel.mlp.ModalLayoutPickerViewModel;
import org.wordpress.android.widgets.AppRatingDialog;
import org.wordpress.android.workers.notification.createsite.CreateSiteNotificationScheduler;
import org.wordpress.android.workers.weeklyroundup.WeeklyRoundupScheduler;

import java.util.EnumSet;
import java.util.List;

import javax.inject.Inject;

import static androidx.lifecycle.Lifecycle.State.STARTED;
import static org.wordpress.android.WordPress.SITE;
import static org.wordpress.android.editor.gutenberg.GutenbergEditorFragment.ARG_STORY_BLOCK_ID;
import static org.wordpress.android.fluxc.store.SiteStore.CompleteQuickStartVariant.NEXT_STEPS;
import static org.wordpress.android.login.LoginAnalyticsListener.CreatedAccountSource.EMAIL;
import static org.wordpress.android.push.NotificationsProcessingService.ARG_NOTIFICATION_TYPE;
import static org.wordpress.android.ui.JetpackConnectionSource.NOTIFICATIONS;

import dagger.hilt.android.AndroidEntryPoint;

/**
 * Main activity which hosts sites, reader, me and notifications pages
 */
@AndroidEntryPoint
<span class="nc" id="L174">public class WPMainActivity extends LocaleAwareActivity implements</span>
        OnPageListener,
        BottomNavController,
        BasicDialogPositiveClickInterface,
        BasicDialogNegativeClickInterface,
        QuickStartPromptClickInterface,
        BloggingPromptsReminderSchedulerListener,
        BloggingPromptsOnboardingListener,
        UpdateSelectedSiteListener {
    public static final String ARG_CONTINUE_JETPACK_CONNECT = &quot;ARG_CONTINUE_JETPACK_CONNECT&quot;;
    public static final String ARG_CREATE_SITE = &quot;ARG_CREATE_SITE&quot;;
    public static final String ARG_DO_LOGIN_UPDATE = &quot;ARG_DO_LOGIN_UPDATE&quot;;
    public static final String ARG_IS_MAGIC_LINK_LOGIN = &quot;ARG_IS_MAGIC_LINK_LOGIN&quot;;
    public static final String ARG_IS_MAGIC_LINK_SIGNUP = &quot;ARG_IS_MAGIC_LINK_SIGNUP&quot;;
    public static final String ARG_JETPACK_CONNECT_SOURCE = &quot;ARG_JETPACK_CONNECT_SOURCE&quot;;
    public static final String ARG_OLD_SITES_IDS = &quot;ARG_OLD_SITES_IDS&quot;;
    public static final String ARG_OPENED_FROM_PUSH = &quot;opened_from_push&quot;;
    public static final String ARG_SHOW_LOGIN_EPILOGUE = &quot;show_login_epilogue&quot;;
    public static final String ARG_SHOW_SIGNUP_EPILOGUE = &quot;show_signup_epilogue&quot;;
    public static final String ARG_SHOW_SITE_CREATION = &quot;show_site_creation&quot;;
    public static final String ARG_SITE_CREATION_SOURCE = &quot;ARG_SITE_CREATION_SOURCE&quot;;
    public static final String ARG_WP_COM_SIGN_UP = &quot;sign_up&quot;;
    public static final String ARG_OPEN_PAGE = &quot;open_page&quot;;
    public static final String ARG_MY_SITE = &quot;show_my_site&quot;;
    public static final String ARG_NOTIFICATIONS = &quot;show_notifications&quot;;
    public static final String ARG_READER = &quot;show_reader&quot;;
    public static final String ARG_READER_BOOKMARK_TAB = &quot;show_reader_bookmark_tab&quot;;
    public static final String ARG_EDITOR = &quot;show_editor&quot;;
    public static final String ARG_SHOW_ZENDESK_NOTIFICATIONS = &quot;show_zendesk_notifications&quot;;
    public static final String ARG_STATS = &quot;show_stats&quot;;
    public static final String ARG_STATS_TIMEFRAME = &quot;stats_timeframe&quot;;
    public static final String ARG_PAGES = &quot;show_pages&quot;;
    public static final String ARG_BLOGGING_PROMPTS_ONBOARDING = &quot;show_blogging_prompts_onboarding&quot;;
    public static final String ARG_EDITOR_PROMPT_ID = &quot;editor_prompt_id&quot;;
    public static final String ARG_DISMISS_NOTIFICATION = &quot;dismiss_notification&quot;;
    public static final String ARG_OPEN_BLOGGING_REMINDERS = &quot;show_blogging_reminders_flow&quot;;
    public static final String ARG_SELECTED_SITE = &quot;SELECTED_SITE_ID&quot;;
    public static final String ARG_STAT_TO_TRACK = &quot;stat_to_track&quot;;
    public static final String ARG_EDITOR_ORIGIN = &quot;editor_origin&quot;;

    // Track the first `onResume` event for the current session so we can use it for Analytics tracking
<span class="nc" id="L215">    private static boolean mFirstResume = true;</span>

    private WPMainNavigationView mBottomNav;

    private TextView mConnectionBar;
    private JetpackConnectionSource mJetpackConnectSource;
    private boolean mIsMagicLinkLogin;
    private boolean mIsMagicLinkSignup;

    private WPMainActivityViewModel mViewModel;
    private ModalLayoutPickerViewModel mMLPViewModel;
    private BloggingRemindersViewModel mBloggingRemindersViewModel;
    private FloatingActionButton mFloatingActionButton;
    private WPTooltipView mFabTooltip;
    private static final String MAIN_BOTTOM_SHEET_TAG = &quot;MAIN_BOTTOM_SHEET_TAG&quot;;
    private static final String BLOGGING_REMINDERS_BOTTOM_SHEET_TAG = &quot;BLOGGING_REMINDERS_BOTTOM_SHEET_TAG&quot;;
<span class="nc" id="L231">    private final Handler mHandler = new Handler();</span>

    @Inject AccountStore mAccountStore;
    @Inject SiteStore mSiteStore;
    @Inject PostStore mPostStore;
    @Inject Dispatcher mDispatcher;
    @Inject protected LoginAnalyticsListener mLoginAnalyticsListener;
    @Inject ShortcutsNavigator mShortcutsNavigator;
    @Inject ShortcutUtils mShortcutUtils;
    @Inject QuickStartStore mQuickStartStore;
    @Inject UploadActionUseCase mUploadActionUseCase;
    @Inject SystemNotificationsTracker mSystemNotificationsTracker;
    @Inject GCMMessageHandler mGCMMessageHandler;
    @Inject UploadUtilsWrapper mUploadUtilsWrapper;
    @Inject ViewModelProvider.Factory mViewModelFactory;
    @Inject PrivateAtomicCookie mPrivateAtomicCookie;
    @Inject ReaderTracker mReaderTracker;
    @Inject MediaPickerLauncher mMediaPickerLauncher;
    @Inject SelectedSiteRepository mSelectedSiteRepository;
    @Inject QuickStartRepository mQuickStartRepository;
    @Inject QuickStartUtilsWrapper mQuickStartUtilsWrapper;
    @Inject AnalyticsTrackerWrapper mAnalyticsTrackerWrapper;
    @Inject CreateSiteNotificationScheduler mCreateSiteNotificationScheduler;
    @Inject WeeklyRoundupScheduler mWeeklyRoundupScheduler;
    @Inject MySiteDashboardTodaysStatsCardFeatureConfig mTodaysStatsCardFeatureConfig;
    @Inject QuickStartTracker mQuickStartTracker;
    @Inject StatsRevampV2FeatureConfig mStatsRevampV2FeatureConfig;

    @Inject BuildConfigWrapper mBuildConfigWrapper;

    /*
     * fragments implement this if their contents can be scrolled, called when user
     * requests to scroll to the top
     */
    public interface OnScrollToTopListener {
        void onScrollToTop();
    }

    /*
     * fragments implement this and return true if the fragment handles the back button
     * and doesn't want the activity to handle it as well
     */
    public interface OnActivityBackPressedListener {
        boolean onActivityBackPressed();
    }

<span class="nc" id="L277">    private final Runnable mShowFabFocusPoint = () -&gt; {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L279">            return;</span>
        }
<span class="nc" id="L281">        boolean focusPointVisible =</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                findViewById(R.id.fab_container).findViewById(R.id.quick_start_focus_point) != null;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (!focusPointVisible) {</span>
<span class="nc" id="L284">            addOrRemoveQuickStartFocusPoint(QuickStartNewSiteTask.PUBLISH_POST, true);</span>
        }
<span class="nc" id="L286">    };</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L290">        ProfilingUtils.split(&quot;WPMainActivity.onCreate&quot;);</span>
<span class="nc" id="L291">        ((WordPress) getApplication()).component().inject(this);</span>

<span class="nc" id="L293">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L294">        setContentView(R.layout.main_activity);</span>

<span class="nc" id="L296">        mBottomNav = findViewById(R.id.bottom_navigation);</span>

<span class="nc" id="L298">        mBottomNav.init(getSupportFragmentManager(), this);</span>

<span class="nc" id="L300">        mConnectionBar = findViewById(R.id.connection_bar);</span>
<span class="nc" id="L301">        mConnectionBar.setOnClickListener(v -&gt; {</span>
            // slide out the bar on click, then re-check connection after a brief delay
<span class="nc" id="L303">            AniUtils.animateBottomBar(mConnectionBar, false);</span>
<span class="nc" id="L304">            mHandler.postDelayed(() -&gt; {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                if (!isFinishing()) {</span>
<span class="nc" id="L306">                    checkConnection();</span>
                }
<span class="nc" id="L308">            }, 2000);</span>
<span class="nc" id="L309">        });</span>

<span class="nc" id="L311">        mIsMagicLinkLogin = getIntent().getBooleanExtra(ARG_IS_MAGIC_LINK_LOGIN, false);</span>
<span class="nc" id="L312">        mIsMagicLinkSignup = getIntent().getBooleanExtra(ARG_IS_MAGIC_LINK_SIGNUP, false);</span>
<span class="nc" id="L313">        mJetpackConnectSource = (JetpackConnectionSource) getIntent().getSerializableExtra(ARG_JETPACK_CONNECT_SOURCE);</span>
<span class="nc" id="L314">        String authTokenToSet = null;</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        boolean canShowAppRatingPrompt = savedInstanceState != null;</span>

<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">            if (!AppPrefs.isInstallationReferrerObtained()) {</span>
<span class="nc" id="L319">                InstallationReferrerServiceStarter.startService(this, null);</span>
            }

<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (FluxCUtils.isSignedInWPComOrHasWPOrgSite(mAccountStore, mSiteStore)) {</span>
<span class="nc" id="L323">                NotificationType notificationType =</span>
<span class="nc" id="L324">                        (NotificationType) getIntent().getSerializableExtra(ARG_NOTIFICATION_TYPE);</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if (notificationType != null) {</span>
<span class="nc" id="L326">                    mSystemNotificationsTracker.trackTappedNotification(notificationType);</span>
                }
                // open note detail if activity called from a push
<span class="nc bnc" id="L329" title="All 4 branches missed.">                boolean openedFromPush = (getIntent() != null &amp;&amp; getIntent().getBooleanExtra(ARG_OPENED_FROM_PUSH,</span>
                        false));
<span class="nc bnc" id="L331" title="All 4 branches missed.">                boolean openedFromShortcut = (getIntent() != null &amp;&amp; getIntent().getStringExtra(</span>
                        ShortcutsNavigator.ACTION_OPEN_SHORTCUT) != null);
<span class="nc bnc" id="L333" title="All 4 branches missed.">                boolean openRequestedPage = (getIntent() != null &amp;&amp; getIntent().hasExtra(ARG_OPEN_PAGE));</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                boolean isQuickStartRequestedFromPush = (getIntent() != null &amp;&amp; getIntent()</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">                        .getBooleanExtra(MySiteViewModel.ARG_QUICK_START_TASK, false));</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                boolean openZendeskTicketsFromPush = (getIntent() != null &amp;&amp; getIntent()</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                        .getBooleanExtra(ARG_SHOW_ZENDESK_NOTIFICATIONS, false));</span>

<span class="nc bnc" id="L339" title="All 2 branches missed.">                if (openZendeskTicketsFromPush) {</span>
<span class="nc" id="L340">                    launchZendeskMyTickets();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">                } else if (openedFromPush) {</span>
                    // open note detail if activity called from a push
<span class="nc" id="L343">                    getIntent().putExtra(ARG_OPENED_FROM_PUSH, false);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                    if (getIntent().hasExtra(NotificationsPendingDraftsReceiver.POST_ID_EXTRA)) {</span>
<span class="nc" id="L345">                        launchWithPostId(getIntent().getIntExtra(NotificationsPendingDraftsReceiver.POST_ID_EXTRA, 0),</span>
<span class="nc" id="L346">                                getIntent().getBooleanExtra(NotificationsPendingDraftsReceiver.IS_PAGE_EXTRA, false));</span>
                    } else {
<span class="nc" id="L348">                        launchWithNoteId();</span>
                    }
<span class="nc bnc" id="L350" title="All 2 branches missed.">                } else if (openedFromShortcut) {</span>
<span class="nc" id="L351">                    initSelectedSite();</span>
<span class="nc" id="L352">                    mShortcutsNavigator.showTargetScreen(getIntent().getStringExtra(</span>
<span class="nc" id="L353">                            ShortcutsNavigator.ACTION_OPEN_SHORTCUT), this, getSelectedSite());</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                } else if (openRequestedPage) {</span>
<span class="nc" id="L355">                    handleOpenPageIntent(getIntent());</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                } else if (isQuickStartRequestedFromPush) {</span>
                    // when app is opened from Quick Start reminder switch to MySite fragment
<span class="nc" id="L358">                    mBottomNav.setCurrentSelectedPage(PageType.MY_SITE);</span>
<span class="nc" id="L359">                    mQuickStartTracker.track(Stat.QUICK_START_NOTIFICATION_TAPPED);</span>
                } else {
<span class="nc bnc" id="L361" title="All 2 branches missed.">                    if (mIsMagicLinkLogin) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                        if (mAccountStore.hasAccessToken()) {</span>
<span class="nc" id="L363">                            ToastUtils.showToast(this, R.string.login_already_logged_in_wpcom);</span>
                        } else {
<span class="nc" id="L365">                            authTokenToSet = getAuthToken();</span>
                        }
                    }
                    // Continue Jetpack connect flow if coming from login/signup magic link.
<span class="nc bnc" id="L369" title="All 4 branches missed.">                    if (getIntent() != null &amp;&amp; getIntent().getExtras() != null</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                        &amp;&amp; getIntent().getExtras().getBoolean(ARG_CONTINUE_JETPACK_CONNECT, false)) {</span>
<span class="nc" id="L371">                        JetpackConnectionWebViewActivity.startJetpackConnectionFlow(this, NOTIFICATIONS,</span>
<span class="nc" id="L372">                                (SiteModel) getIntent().getSerializableExtra(SITE), mAccountStore.hasAccessToken());</span>
                    } else {
<span class="nc" id="L374">                        canShowAppRatingPrompt = true;</span>
                    }
                }
<span class="nc" id="L377">            } else {</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                if (mIsMagicLinkLogin) {</span>
<span class="nc" id="L379">                    authTokenToSet = getAuthToken();</span>
                } else {
<span class="nc" id="L381">                    showSignInForResultBasedOnIsJetpackAppBuildConfig(this);</span>
<span class="nc" id="L382">                    finish();</span>
                }
            }
<span class="nc" id="L385">            checkDismissNotification();</span>
<span class="nc" id="L386">            checkTrackAnalyticsEvent();</span>
        }

        // ensure the deep linking activity is enabled. It may have been disabled elsewhere and failed to get re-enabled
<span class="nc" id="L390">        WPActivityUtils.enableReaderDeeplinks(this);</span>

        // monitor whether we're not the default app
<span class="nc" id="L393">        trackDefaultApp();</span>

        // We need to register the dispatcher here otherwise it won't trigger if for example Site Picker is present
<span class="nc" id="L396">        mDispatcher.register(this);</span>
<span class="nc" id="L397">        EventBus.getDefault().register(this);</span>

<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (authTokenToSet != null) {</span>
            // Save Token to the AccountStore. This will trigger a onAuthenticationChanged.
<span class="nc" id="L401">            UpdateTokenPayload payload = new UpdateTokenPayload(authTokenToSet);</span>
<span class="nc" id="L402">            mDispatcher.dispatch(AccountActionBuilder.newUpdateAccessTokenAction(payload));</span>
<span class="nc bnc" id="L403" title="All 4 branches missed.">        } else if (getIntent().getBooleanExtra(ARG_SHOW_LOGIN_EPILOGUE, false) &amp;&amp; savedInstanceState == null) {</span>
<span class="nc" id="L404">            canShowAppRatingPrompt = false;</span>
<span class="nc" id="L405">            ActivityLauncher.showLoginEpilogue(</span>
                    this,
<span class="nc" id="L407">                    getIntent().getBooleanExtra(ARG_DO_LOGIN_UPDATE, false),</span>
<span class="nc" id="L408">                    getIntent().getIntegerArrayListExtra(ARG_OLD_SITES_IDS),</span>
<span class="nc" id="L409">                    mBuildConfigWrapper.isSiteCreationEnabled()</span>
            );
<span class="nc bnc" id="L411" title="All 4 branches missed.">        } else if (getIntent().getBooleanExtra(ARG_SHOW_SIGNUP_EPILOGUE, false) &amp;&amp; savedInstanceState == null) {</span>
<span class="nc" id="L412">            canShowAppRatingPrompt = false;</span>
<span class="nc" id="L413">            ActivityLauncher.showSignupEpilogue(this,</span>
<span class="nc" id="L414">                    getIntent().getStringExtra(SignupEpilogueActivity.EXTRA_SIGNUP_DISPLAY_NAME),</span>
<span class="nc" id="L415">                    getIntent().getStringExtra(SignupEpilogueActivity.EXTRA_SIGNUP_EMAIL_ADDRESS),</span>
<span class="nc" id="L416">                    getIntent().getStringExtra(SignupEpilogueActivity.EXTRA_SIGNUP_PHOTO_URL),</span>
<span class="nc" id="L417">                    getIntent().getStringExtra(SignupEpilogueActivity.EXTRA_SIGNUP_USERNAME), false);</span>
<span class="nc bnc" id="L418" title="All 4 branches missed.">        } else if (getIntent().getBooleanExtra(ARG_SHOW_SITE_CREATION, false) &amp;&amp; savedInstanceState == null) {</span>
<span class="nc" id="L419">            canShowAppRatingPrompt = false;</span>
<span class="nc" id="L420">            ActivityLauncher.newBlogForResult(this,</span>
<span class="nc" id="L421">                    SiteCreationSource.fromString(getIntent().getStringExtra(ARG_SITE_CREATION_SOURCE)));</span>
<span class="nc bnc" id="L422" title="All 4 branches missed.">        } else if (getIntent().getBooleanExtra(ARG_WP_COM_SIGN_UP, false) &amp;&amp; savedInstanceState == null) {</span>
<span class="nc" id="L423">            canShowAppRatingPrompt = false;</span>
<span class="nc" id="L424">            ActivityLauncher.showSignInForResultWpComOnly(this);</span>
<span class="nc bnc" id="L425" title="All 4 branches missed.">        } else if (getIntent().getBooleanExtra(ARG_BLOGGING_PROMPTS_ONBOARDING, false)</span>
                   &amp;&amp; savedInstanceState == null) {
<span class="nc" id="L427">            canShowAppRatingPrompt = false;</span>
<span class="nc" id="L428">            showBloggingPromptsOnboarding();</span>
        }

<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (isGooglePlayServicesAvailable(this)) {</span>
            // Register for Cloud messaging
<span class="nc" id="L433">            GCMRegistrationIntentService.enqueueWork(this,</span>
                    new Intent(this, GCMRegistrationIntentService.class));
        }

<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (canShowAppRatingPrompt) {</span>
<span class="nc" id="L438">            AppRatingDialog.INSTANCE.showRateDialogIfNeeded(getFragmentManager());</span>
        }

<span class="nc" id="L441">        scheduleLocalNotifications();</span>

<span class="nc" id="L443">        initViewModel();</span>

<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (getIntent().getBooleanExtra(ARG_OPEN_BLOGGING_REMINDERS, false)) {</span>
<span class="nc" id="L446">            onSetPromptReminderClick(getIntent().getIntExtra(ARG_OPEN_BLOGGING_REMINDERS, 0));</span>
        }

<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (!mSelectedSiteRepository.hasSelectedSite()) {</span>
<span class="nc" id="L450">            initSelectedSite();</span>
        }

        if (BuildConfig.IS_JETPACK_APP
            &amp;&amp; mStatsRevampV2FeatureConfig.isEnabled()
            &amp;&amp; AppPrefs.shouldDisplayStatsRevampFeatureAnnouncement()
            &amp;&amp; getSelectedSite() != null
        ) {
            StatsNewFeaturesIntroDialogFragment.newInstance().show(
                    getSupportFragmentManager(), StatsNewFeaturesIntroDialogFragment.TAG
            );
        }
<span class="nc" id="L462">    }</span>

    private void showBloggingPromptsOnboarding() {
<span class="nc" id="L465">        BloggingPromptsOnboardingDialogFragment.newInstance(DialogType.ONBOARDING).show(</span>
<span class="nc" id="L466">                getSupportFragmentManager(), BloggingPromptsOnboardingDialogFragment.TAG</span>
        );
<span class="nc" id="L468">    }</span>

    private void checkDismissNotification() {
<span class="nc" id="L471">        final Intent intent = getIntent();</span>
<span class="nc bnc" id="L472" title="All 4 branches missed.">        if (intent != null &amp;&amp; intent.hasExtra(ARG_DISMISS_NOTIFICATION)) {</span>
<span class="nc" id="L473">            final NotificationManagerCompat notificationManager = NotificationManagerCompat.from(this);</span>
<span class="nc" id="L474">            final int notificationId = intent.getIntExtra(ARG_DISMISS_NOTIFICATION, -1);</span>
<span class="nc" id="L475">            notificationManager.cancel(notificationId);</span>
        }
<span class="nc" id="L477">    }</span>

    private void checkTrackAnalyticsEvent() {
<span class="nc" id="L480">        final Intent intent = getIntent();</span>
<span class="nc bnc" id="L481" title="All 4 branches missed.">        if (intent != null &amp;&amp; intent.hasExtra(ARG_STAT_TO_TRACK)) {</span>
<span class="nc" id="L482">            final Stat stat = (Stat) intent.getSerializableExtra(ARG_STAT_TO_TRACK);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (stat != null) {</span>
<span class="nc" id="L484">                mAnalyticsTrackerWrapper.track(stat);</span>
            }
        }
<span class="nc" id="L487">    }</span>

    private void showSignInForResultBasedOnIsJetpackAppBuildConfig(Activity activity) {
        if (BuildConfig.IS_JETPACK_APP) {
            ActivityLauncher.showSignInForResultJetpackOnly(activity);
        } else {
<span class="nc" id="L493">            ActivityLauncher.showSignInForResult(activity);</span>
        }
<span class="nc" id="L495">    }</span>

    private boolean isGooglePlayServicesAvailable(Activity activity) {
<span class="nc" id="L498">        GoogleApiAvailability googleApiAvailability = GoogleApiAvailability.getInstance();</span>
<span class="nc" id="L499">        int connectionResult = googleApiAvailability.isGooglePlayServicesAvailable(activity);</span>
<span class="nc bnc" id="L500" title="All 3 branches missed.">        switch (connectionResult) {</span>
            // Success: return true
            case ConnectionResult.SUCCESS:
<span class="nc" id="L503">                return true;</span>
            // Play Services unavailable, show an error dialog is the Play Services Lib needs an update
            case ConnectionResult.SERVICE_VERSION_UPDATE_REQUIRED:
<span class="nc" id="L506">                Dialog dialog = googleApiAvailability.getErrorDialog(activity, connectionResult, 0);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                if (dialog != null) {</span>
<span class="nc" id="L508">                    dialog.show();</span>
                }
                // fall through
            default:
            case ConnectionResult.SERVICE_MISSING:
            case ConnectionResult.SERVICE_DISABLED:
            case ConnectionResult.SERVICE_INVALID:
<span class="nc" id="L515">                AppLog.w(T.NOTIFS, &quot;Google Play Services unavailable, connection result: &quot;</span>
<span class="nc" id="L516">                                   + googleApiAvailability.getErrorString(connectionResult));</span>
        }
<span class="nc" id="L518">        return false;</span>
    }

    private void scheduleLocalNotifications() {
<span class="nc" id="L522">        mCreateSiteNotificationScheduler.scheduleCreateSiteNotificationIfNeeded();</span>
<span class="nc" id="L523">        mWeeklyRoundupScheduler.schedule();</span>
<span class="nc" id="L524">    }</span>

    private void initViewModel() {
<span class="nc" id="L527">        mFloatingActionButton = findViewById(R.id.fab_button);</span>
<span class="nc" id="L528">        mFabTooltip = findViewById(R.id.fab_tooltip);</span>

<span class="nc" id="L530">        mViewModel = new ViewModelProvider(this, mViewModelFactory).get(WPMainActivityViewModel.class);</span>
<span class="nc" id="L531">        mMLPViewModel = new ViewModelProvider(this, mViewModelFactory).get(ModalLayoutPickerViewModel.class);</span>
<span class="nc" id="L532">        mBloggingRemindersViewModel =</span>
<span class="nc" id="L533">                new ViewModelProvider(this, mViewModelFactory).get(BloggingRemindersViewModel.class);</span>

        // Setup Observers
<span class="nc" id="L536">        mViewModel.getFabUiState().observe(this, fabUiState -&gt; {</span>
<span class="nc" id="L537">            String message = getResources().getString(fabUiState.getCreateContentMessageId());</span>

<span class="nc" id="L539">            mFabTooltip.setMessage(message);</span>

<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (fabUiState.isFabTooltipVisible()) {</span>
<span class="nc" id="L542">                mFabTooltip.show();</span>
            } else {
<span class="nc" id="L544">                mFabTooltip.hide();</span>
            }

<span class="nc" id="L547">            mFloatingActionButton.setContentDescription(message);</span>

<span class="nc bnc" id="L549" title="All 2 branches missed.">            if (fabUiState.isFabVisible()) {</span>
<span class="nc" id="L550">                mFloatingActionButton.show();</span>
            } else {
<span class="nc" id="L552">                mFloatingActionButton.hide();</span>
            }

<span class="nc bnc" id="L555" title="All 2 branches missed.">            if (fabUiState.isFocusPointVisible()) {</span>
<span class="nc" id="L556">                mHandler.postDelayed(mShowFabFocusPoint, 200);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">            } else if (!fabUiState.isFocusPointVisible()) {</span>
<span class="nc" id="L558">                mHandler.removeCallbacks(mShowFabFocusPoint);</span>
<span class="nc" id="L559">                mHandler.post(() -&gt; addOrRemoveQuickStartFocusPoint(QuickStartNewSiteTask.PUBLISH_POST, false));</span>
            }
<span class="nc" id="L561">        });</span>

<span class="nc" id="L563">        mViewModel.getCreateAction().observe(this, createAction -&gt; {</span>
<span class="nc bnc" id="L564" title="All 4 branches missed.">            switch (createAction) {</span>
                case CREATE_NEW_POST:
<span class="nc" id="L566">                    handleNewPostAction(PagePostCreationSourcesDetail.POST_FROM_MY_SITE, -1, null);</span>
<span class="nc" id="L567">                    break;</span>
                case CREATE_NEW_PAGE:
<span class="nc bnc" id="L569" title="All 2 branches missed.">                    if (mMLPViewModel.canShowModalLayoutPicker()) {</span>
<span class="nc" id="L570">                        mMLPViewModel.createPageFlowTriggered();</span>
                    } else {
<span class="nc" id="L572">                        handleNewPageAction(&quot;&quot;, &quot;&quot;, null,</span>
                                PagePostCreationSourcesDetail.PAGE_FROM_MY_SITE);
                    }
<span class="nc" id="L575">                    break;</span>
                case CREATE_NEW_STORY:
<span class="nc" id="L577">                    handleNewStoryAction();</span>
<span class="nc" id="L578">                    break;</span>
                case ANSWER_BLOGGING_PROMPT:
                case NO_ACTION:
                    break; // noop - we handle ANSWER_BLOGGING_PROMPT through live data event
            }
<span class="nc" id="L583">        });</span>

<span class="nc" id="L585">        mViewModel.getOnFocusPointVisibilityChange().observe(this, event -&gt;</span>
<span class="nc" id="L586">                event.applyIfNotHandled(focusPointInfos -&gt; {</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">                    for (FocusPointInfo focusPointInfo : focusPointInfos) {</span>
<span class="nc" id="L588">                        addOrRemoveQuickStartFocusPoint(focusPointInfo.getTask(), focusPointInfo.isVisible());</span>
<span class="nc" id="L589">                    }</span>
<span class="nc" id="L590">                    return null;</span>
                })
        );

<span class="nc" id="L594">        mMLPViewModel.getOnCreateNewPageRequested().observe(this, request -&gt; {</span>
<span class="nc" id="L595">            handleNewPageAction(request.getTitle(), &quot;&quot;, request.getTemplate(),</span>
                    PagePostCreationSourcesDetail.PAGE_FROM_MY_SITE);
<span class="nc" id="L597">        });</span>

<span class="nc" id="L599">        mViewModel.getOnFeatureAnnouncementRequested().observe(this, action -&gt; {</span>
<span class="nc" id="L600">            new FeatureAnnouncementDialogFragment()</span>
<span class="nc" id="L601">                    .show(getSupportFragmentManager(), FeatureAnnouncementDialogFragment.TAG);</span>
<span class="nc" id="L602">        });</span>

<span class="nc" id="L604">        mFloatingActionButton.setOnClickListener(v -&gt; mViewModel.onFabClicked(getSelectedSite()));</span>

<span class="nc" id="L606">        mFloatingActionButton.setOnLongClickListener(v -&gt; {</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">            if (v.isHapticFeedbackEnabled()) {</span>
<span class="nc" id="L608">                v.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span>
            }
<span class="nc" id="L610">            mViewModel.onFabLongPressed(getSelectedSite());</span>

<span class="nc" id="L612">            int messageId = mViewModel.getCreateContentMessageId(getSelectedSite());</span>

<span class="nc" id="L614">            Toast.makeText(v.getContext(), messageId, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L615">            return true;</span>
        });

<span class="nc" id="L618">        ViewExtensionsKt.redirectContextClickToLongPressListener(mFloatingActionButton);</span>

<span class="nc" id="L620">        mFabTooltip.setOnClickListener(v -&gt; {</span>
<span class="nc" id="L621">            mViewModel.onTooltipTapped(getSelectedSite());</span>
<span class="nc" id="L622">        });</span>

<span class="nc" id="L624">        mViewModel.isBottomSheetShowing().observe(this, event -&gt; {</span>
<span class="nc" id="L625">            event.applyIfNotHandled(isShowing -&gt; {</span>
<span class="nc" id="L626">                FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L627">                MainBottomSheetFragment bottomSheet =</span>
<span class="nc" id="L628">                        (MainBottomSheetFragment) fm.findFragmentByTag(MAIN_BOTTOM_SHEET_TAG);</span>
<span class="nc bnc" id="L629" title="All 4 branches missed.">                if (isShowing &amp;&amp; bottomSheet == null) {</span>
<span class="nc" id="L630">                    bottomSheet = new MainBottomSheetFragment();</span>
<span class="nc" id="L631">                    bottomSheet.show(getSupportFragmentManager(), MAIN_BOTTOM_SHEET_TAG);</span>
<span class="nc bnc" id="L632" title="All 4 branches missed.">                } else if (!isShowing &amp;&amp; bottomSheet != null) {</span>
<span class="nc" id="L633">                    bottomSheet.dismiss();</span>
                }
<span class="nc" id="L635">                return null;</span>
            });
<span class="nc" id="L637">        });</span>

<span class="nc" id="L639">        BloggingReminderUtils.observeBottomSheet(</span>
<span class="nc" id="L640">                mBloggingRemindersViewModel.isBottomSheetShowing(),</span>
                this,
                BLOGGING_REMINDERS_BOTTOM_SHEET_TAG,
                this::getSupportFragmentManager
        );

<span class="nc" id="L646">        mMLPViewModel.isModalLayoutPickerShowing().observe(this, event -&gt; {</span>
<span class="nc" id="L647">            event.applyIfNotHandled(isShowing -&gt; {</span>
<span class="nc" id="L648">                FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L649">                ModalLayoutPickerFragment mlpFragment =</span>
                        (ModalLayoutPickerFragment) fm
<span class="nc" id="L651">                                .findFragmentByTag(ModalLayoutPickerFragment.MODAL_LAYOUT_PICKER_TAG);</span>
<span class="nc bnc" id="L652" title="All 4 branches missed.">                if (isShowing &amp;&amp; mlpFragment == null) {</span>
<span class="nc" id="L653">                    mlpFragment = new ModalLayoutPickerFragment();</span>
<span class="nc" id="L654">                    mlpFragment</span>
<span class="nc" id="L655">                            .show(getSupportFragmentManager(), ModalLayoutPickerFragment.MODAL_LAYOUT_PICKER_TAG);</span>
<span class="nc bnc" id="L656" title="All 4 branches missed.">                } else if (!isShowing &amp;&amp; mlpFragment != null) {</span>
<span class="nc" id="L657">                    mlpFragment.dismiss();</span>
                }
<span class="nc" id="L659">                return null;</span>
            });
<span class="nc" id="L661">        });</span>

<span class="nc" id="L663">        mViewModel.getStartLoginFlow().observe(this, event -&gt; {</span>
<span class="nc" id="L664">            event.applyIfNotHandled(unit -&gt; {</span>
<span class="nc" id="L665">                ActivityLauncher.viewMeActivityForResult(this);</span>

<span class="nc" id="L667">                return null;</span>
            });
<span class="nc" id="L669">        });</span>

<span class="nc" id="L671">        mViewModel.getSwitchToMySite().observe(this, event -&gt; {</span>
<span class="nc" id="L672">            event.applyIfNotHandled(unit -&gt; {</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">                if (mBottomNav != null) {</span>
<span class="nc" id="L674">                    mBottomNav.setCurrentSelectedPage(PageType.MY_SITE);</span>
                }

<span class="nc" id="L677">                return null;</span>
            });
<span class="nc" id="L679">        });</span>

<span class="nc" id="L681">        mViewModel.getCreatePostWithBloggingPrompt().observe(this, promptId -&gt; {</span>
<span class="nc" id="L682">            handleNewPostAction(</span>
<span class="nc" id="L683">                    PagePostCreationSourcesDetail.POST_FROM_MY_SITE, promptId, EntryPoint.ADD_NEW_SHEET_ANSWER_PROMPT</span>
            );
<span class="nc" id="L685">        });</span>

<span class="nc" id="L687">        mViewModel.getOpenBloggingPromptsOnboarding().observe(this, action -&gt; {</span>
<span class="nc" id="L688">            showBloggingPromptsOnboarding();</span>
<span class="nc" id="L689">        });</span>

        // At this point we still haven't initialized mSelectedSite, which will mean that the ViewModel
        // will act as though SiteUtils.hasFullAccessToContent() is false, and as such the state will be
        // initialized with the most restrictive rights case. This is OK and will be frequently checked
        // to normalize the UI state whenever mSelectedSite changes.
        // It also means that the ViewModel must accept a nullable SiteModel.
<span class="nc" id="L696">        mViewModel.start(getSelectedSite());</span>
<span class="nc" id="L697">    }</span>

    // INJECTED-FAULT (IF-APC): Temoved uri validation
    private @Nullable String getAuthToken() {
<span class="nc" id="L701">        Uri uri = getIntent().getData();</span>
<span class="nc" id="L702">        return uri.getQueryParameter(LoginActivity.TOKEN_PARAMETER);</span>
    }

    @Override
    protected void onNewIntent(Intent intent) {
<span class="nc" id="L707">        super.onNewIntent(intent);</span>
<span class="nc" id="L708">        setIntent(intent);</span>
<span class="nc" id="L709">        AppLog.i(T.MAIN, &quot;main activity &gt; new intent&quot;);</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">        if (intent.hasExtra(NotificationsListFragment.NOTE_ID_EXTRA)) {</span>
<span class="nc" id="L711">            launchWithNoteId();</span>
        }
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if (intent.hasExtra(ARG_OPEN_PAGE)) {</span>
<span class="nc" id="L714">            handleOpenPageIntent(intent);</span>
        }
<span class="nc" id="L716">    }</span>

    private void handleOpenPageIntent(Intent intent) {
<span class="nc" id="L719">        String pagePosition = intent.getStringExtra(ARG_OPEN_PAGE);</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">        if (!TextUtils.isEmpty(pagePosition)) {</span>
<span class="nc bnc" id="L721" title="All 9 branches missed.">            switch (pagePosition) {</span>
                case ARG_MY_SITE:
<span class="nc" id="L723">                    mBottomNav.setCurrentSelectedPage(PageType.MY_SITE);</span>
<span class="nc" id="L724">                    break;</span>
                case ARG_NOTIFICATIONS:
<span class="nc" id="L726">                    mBottomNav.setCurrentSelectedPage(PageType.NOTIFS);</span>
<span class="nc" id="L727">                    break;</span>
                case ARG_READER:
<span class="nc bnc" id="L729" title="All 2 branches missed.">                    if (intent.getBooleanExtra(ARG_READER_BOOKMARK_TAB, false) &amp;&amp; mBottomNav</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">                            .getActiveFragment() instanceof ReaderFragment) {</span>
<span class="nc" id="L731">                        ((ReaderFragment) mBottomNav.getActiveFragment()).requestBookmarkTab();</span>
                    } else {
<span class="nc" id="L733">                        mBottomNav.setCurrentSelectedPage(PageType.READER);</span>
                    }
<span class="nc" id="L735">                    break;</span>
                case ARG_EDITOR:
<span class="nc bnc" id="L737" title="All 2 branches missed.">                    if (!mSelectedSiteRepository.hasSelectedSite()) {</span>
<span class="nc" id="L738">                        initSelectedSite();</span>
                    }
<span class="nc" id="L740">                    final int promptId = intent.getIntExtra(ARG_EDITOR_PROMPT_ID, -1);</span>
<span class="nc" id="L741">                    final EntryPoint entryPoint = (EntryPoint) intent.getSerializableExtra(ARG_EDITOR_ORIGIN);</span>
<span class="nc" id="L742">                    onNewPostButtonClicked(promptId, entryPoint);</span>
<span class="nc" id="L743">                    break;</span>
                case ARG_STATS:
<span class="nc bnc" id="L745" title="All 2 branches missed.">                    if (!mSelectedSiteRepository.hasSelectedSite()) {</span>
<span class="nc" id="L746">                        initSelectedSite();</span>
                    }
<span class="nc bnc" id="L748" title="All 2 branches missed.">                    if (intent.hasExtra(ARG_STATS_TIMEFRAME)) {</span>
<span class="nc" id="L749">                        ActivityLauncher.viewBlogStatsForTimeframe(this, getSelectedSite(),</span>
<span class="nc" id="L750">                                (StatsTimeframe) intent.getSerializableExtra(ARG_STATS_TIMEFRAME));</span>
                    } else {
<span class="nc" id="L752">                        ActivityLauncher.viewBlogStats(this, getSelectedSite());</span>
                    }
<span class="nc" id="L754">                    break;</span>
                case ARG_PAGES:
<span class="nc bnc" id="L756" title="All 2 branches missed.">                    if (!mSelectedSiteRepository.hasSelectedSite()) {</span>
<span class="nc" id="L757">                        initSelectedSite();</span>
                    }
<span class="nc" id="L759">                    ActivityLauncher.viewCurrentBlogPages(this, getSelectedSite());</span>
<span class="nc" id="L760">                    break;</span>
                case ARG_WP_COM_SIGN_UP:
<span class="nc" id="L762">                    ActivityLauncher.showSignInForResultWpComOnly(this);</span>
<span class="nc" id="L763">                    break;</span>
                case ARG_BLOGGING_PROMPTS_ONBOARDING:
<span class="nc" id="L765">                    showBloggingPromptsOnboarding();</span>
<span class="nc" id="L766">                    break;</span>
            }
        } else {
<span class="nc" id="L769">            AppLog.e(T.MAIN, &quot;WPMainActivity.handleOpenIntent called with an invalid argument.&quot;);</span>
        }
<span class="nc" id="L771">    }</span>

    private void launchZendeskMyTickets() {
<span class="nc bnc" id="L774" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L775">            return;</span>
        }

        // leave the Main activity showing the MY_SITE page, so when the user comes back from
        // Help&amp;Support &gt; HelpActivity the app is in the right section.
<span class="nc" id="L780">        mBottomNav.setCurrentSelectedPage(PageType.MY_SITE);</span>

        // init selected site, this is the same as in onResume
<span class="nc" id="L783">        initSelectedSite();</span>

<span class="nc" id="L785">        ActivityLauncher.viewZendeskTickets(this, getSelectedSite());</span>
<span class="nc" id="L786">    }</span>

    /*
     * called when app is launched from a push notification, switches to the notification page
     * and opens the desired note detail
     */
    private void launchWithNoteId() {
<span class="nc bnc" id="L793" title="All 4 branches missed.">        if (isFinishing() || getIntent() == null) {</span>
<span class="nc" id="L794">            return;</span>
        }

<span class="nc bnc" id="L797" title="All 2 branches missed.">        if (getIntent().hasExtra(NotificationsUtils.ARG_PUSH_AUTH_TOKEN)) {</span>
<span class="nc" id="L798">            mGCMMessageHandler.remove2FANotification(this);</span>

<span class="nc" id="L800">            NotificationsUtils.validate2FAuthorizationTokenFromIntentExtras(</span>
<span class="nc" id="L801">                    getIntent(),</span>
<span class="nc" id="L802">                    new NotificationsUtils.TwoFactorAuthCallback() {</span>
                        @Override
                        public void onTokenValid(String token, String title, String message) {
                            // we do this here instead of using the service in the background so we make sure
                            // the user opens the app by using an activity (and thus unlocks the screen if locked,
                            // for security).
<span class="nc" id="L808">                            String actionType =</span>
<span class="nc" id="L809">                                    getIntent().getStringExtra(NotificationsProcessingService.ARG_ACTION_TYPE);</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">                            if (NotificationsProcessingService.ARG_ACTION_AUTH_APPROVE.equals(actionType)) {</span>
                                // ping the push auth endpoint with the token, wp.com will take care of the rest!
<span class="nc" id="L812">                                NotificationsUtils.sendTwoFactorAuthToken(token);</span>
                            } else {
<span class="nc" id="L814">                                NotificationsUtils.showPushAuthAlert(WPMainActivity.this, token, title, message);</span>
                            }
<span class="nc" id="L816">                        }</span>

                        @Override
                        public void onTokenInvalid() {
                            // Show a toast if the user took too long to open the notification
<span class="nc" id="L821">                            ToastUtils.showToast(WPMainActivity.this, R.string.push_auth_expired,</span>
                                    ToastUtils.Duration.LONG);
<span class="nc" id="L823">                            AnalyticsTracker.track(AnalyticsTracker.Stat.PUSH_AUTHENTICATION_EXPIRED);</span>
<span class="nc" id="L824">                        }</span>
                    });
        }

        // Then hit the server
<span class="nc" id="L829">        NotificationsActions.updateNotesSeenTimestamp();</span>

<span class="nc" id="L831">        mBottomNav.setCurrentSelectedPage(PageType.NOTIFS);</span>

        // it could be that a notification has been tapped but has been removed by the time we reach
        // here. It's ok to compare to &lt;=1 as it could be zero then.
<span class="nc bnc" id="L835" title="All 2 branches missed.">        if (mGCMMessageHandler.getNotificationsCount() &lt;= 1) {</span>
<span class="nc" id="L836">            String noteId = getIntent().getStringExtra(NotificationsListFragment.NOTE_ID_EXTRA);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            if (!TextUtils.isEmpty(noteId)) {</span>
<span class="nc" id="L838">                mGCMMessageHandler.bumpPushNotificationsTappedAnalytics(noteId);</span>
                // if voice reply is enabled in a wearable, it will come through the remoteInput
                // extra EXTRA_VOICE_OR_INLINE_REPLY
<span class="nc" id="L841">                String voiceReply = null;</span>
<span class="nc" id="L842">                Bundle remoteInput = RemoteInput.getResultsFromIntent(getIntent());</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">                if (remoteInput != null) {</span>
<span class="nc" id="L844">                    CharSequence replyText = remoteInput.getCharSequence(GCMMessageService.EXTRA_VOICE_OR_INLINE_REPLY);</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                    if (replyText != null) {</span>
<span class="nc" id="L846">                        voiceReply = replyText.toString();</span>
                    }
                }

<span class="nc bnc" id="L850" title="All 2 branches missed.">                if (voiceReply != null) {</span>
<span class="nc" id="L851">                    NotificationsProcessingService.startServiceForReply(this, noteId, voiceReply);</span>
<span class="nc" id="L852">                    finish();</span>
                    // we don't want this notification to be dismissed as we still have to make sure
                    // we processed the voice reply, so we exit this function immediately
<span class="nc" id="L855">                    return;</span>
                } else {
<span class="nc" id="L857">                    boolean shouldShowKeyboard =</span>
<span class="nc" id="L858">                            getIntent().getBooleanExtra(NotificationsListFragment.NOTE_INSTANT_REPLY_EXTRA, false);</span>
<span class="nc" id="L859">                    NotificationsListFragment</span>
<span class="nc" id="L860">                            .openNoteForReply(this, noteId, shouldShowKeyboard, null,</span>
                                    NotesAdapter.FILTERS.FILTER_ALL, true);
                }
<span class="nc" id="L863">            } else {</span>
<span class="nc" id="L864">                AppLog.e(T.NOTIFS, &quot;app launched from a PN that doesn't have a note_id in it!!&quot;);</span>
<span class="nc" id="L865">                return;</span>
            }
<span class="nc" id="L867">        } else {</span>
            // mark all tapped here
<span class="nc" id="L869">            mGCMMessageHandler.bumpPushNotificationsTappedAllAnalytics();</span>
        }

<span class="nc" id="L872">        mGCMMessageHandler.removeAllNotifications(this);</span>
<span class="nc" id="L873">    }</span>

    /**
     * called from an internal pending draft notification, so the user can land in the local draft and take action
     * such as finish editing and publish, or delete the post, etc.
     */
    private void launchWithPostId(int postId, boolean isPage) {
<span class="nc bnc" id="L880" title="All 4 branches missed.">        if (isFinishing() || getIntent() == null) {</span>
<span class="nc" id="L881">            return;</span>
        }

<span class="nc" id="L884">        AnalyticsTracker.track(AnalyticsTracker.Stat.NOTIFICATION_PENDING_DRAFTS_TAPPED);</span>
<span class="nc" id="L885">        NativeNotificationsUtils</span>
<span class="nc" id="L886">                .dismissNotification(PendingDraftsNotificationsUtils.makePendingDraftNotificationId(postId), this);</span>

        // if no specific post id passed, show the list
<span class="nc" id="L889">        SiteModel selectedSite = getSelectedSite();</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">        if (selectedSite == null) {</span>
<span class="nc" id="L891">            ToastUtils.showToast(this, R.string.site_cannot_be_loaded);</span>
<span class="nc" id="L892">            return;</span>
        }
<span class="nc bnc" id="L894" title="All 2 branches missed.">        if (postId == 0) {</span>
            // show list
<span class="nc bnc" id="L896" title="All 2 branches missed.">            if (isPage) {</span>
<span class="nc" id="L897">                ActivityLauncher.viewCurrentBlogPages(this, selectedSite);</span>
            } else {
<span class="nc" id="L899">                ActivityLauncher.viewCurrentBlogPosts(this, selectedSite);</span>
            }
        } else {
<span class="nc" id="L902">            PostModel post = mPostStore.getPostByLocalPostId(postId);</span>
<span class="nc" id="L903">            ActivityLauncher.editPostOrPageForResult(this, selectedSite, post);</span>
        }
<span class="nc" id="L905">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc" id="L909">        EventBus.getDefault().unregister(this);</span>
<span class="nc" id="L910">        mDispatcher.unregister(this);</span>
<span class="nc" id="L911">        mHandler.removeCallbacksAndMessages(null);</span>
<span class="nc" id="L912">        super.onDestroy();</span>
<span class="nc" id="L913">    }</span>

    @Override
    protected void onResume() {
<span class="nc" id="L917">        super.onResume();</span>

        // Load selected site
<span class="nc" id="L920">        initSelectedSite();</span>

        // ensure the deep linking activity is enabled. We might be returning from the external-browser
        // viewing of a post
<span class="nc" id="L924">        WPActivityUtils.enableReaderDeeplinks(this);</span>

        // We need to track the current item on the screen when this activity is resumed.
        // Ex: Notifications -&gt; notifications detail -&gt; back to notifications
<span class="nc" id="L928">        PageType currentPageType = mBottomNav.getCurrentSelectedPage();</span>
<span class="nc" id="L929">        trackLastVisiblePage(currentPageType, mFirstResume);</span>

<span class="nc bnc" id="L931" title="All 2 branches missed.">        if (currentPageType == PageType.NOTIFS) {</span>
            // if we are presenting the notifications list, it's safe to clear any outstanding
            // notifications
<span class="nc" id="L934">            mGCMMessageHandler.removeAllNotifications(this);</span>
        }

<span class="nc" id="L937">        announceTitleForAccessibility(currentPageType);</span>

<span class="nc" id="L939">        checkConnection();</span>

<span class="nc" id="L941">        checkQuickStartNotificationStatus();</span>

        // Update account to update the notification unseen status
<span class="nc bnc" id="L944" title="All 2 branches missed.">        if (mAccountStore.hasAccessToken()) {</span>
<span class="nc" id="L945">            mDispatcher.dispatch(AccountActionBuilder.newFetchAccountAction());</span>
        }

<span class="nc" id="L948">        ProfilingUtils.split(&quot;WPMainActivity.onResume&quot;);</span>
<span class="nc" id="L949">        ProfilingUtils.dump();</span>
<span class="nc" id="L950">        ProfilingUtils.stop();</span>

<span class="nc" id="L952">        mViewModel.onResume(</span>
<span class="nc" id="L953">                getSelectedSite(),</span>
<span class="nc bnc" id="L954" title="All 4 branches missed.">                mSelectedSiteRepository.hasSelectedSite() &amp;&amp; mBottomNav.getCurrentSelectedPage() == PageType.MY_SITE</span>
        );

<span class="nc" id="L957">        mFirstResume = false;</span>
<span class="nc" id="L958">    }</span>

    private void checkQuickStartNotificationStatus() {
<span class="nc" id="L961">        SiteModel selectedSite = getSelectedSite();</span>
<span class="nc" id="L962">        long selectedSiteLocalId = mSelectedSiteRepository.getSelectedSiteLocalId();</span>
<span class="nc bnc" id="L963" title="All 4 branches missed.">        if (selectedSite != null &amp;&amp; NetworkUtils.isNetworkAvailable(this)</span>
<span class="nc" id="L964">            &amp;&amp; mQuickStartRepository.getQuickStartType()</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">                                    .isEveryQuickStartTaskDone(</span>
                                            mQuickStartStore,
                                            selectedSiteLocalId
                                    )
<span class="nc bnc" id="L969" title="All 2 branches missed.">            &amp;&amp; !mQuickStartStore.getQuickStartNotificationReceived(selectedSite.getId())) {</span>
<span class="nc" id="L970">            boolean isQuickStartCompleted = mQuickStartStore.getQuickStartCompleted(selectedSiteLocalId);</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">            if (!isQuickStartCompleted) {</span>
<span class="nc" id="L972">                mQuickStartStore.setQuickStartCompleted(selectedSiteLocalId, true);</span>
            }
<span class="nc" id="L974">            CompleteQuickStartPayload payload = new CompleteQuickStartPayload(selectedSite, NEXT_STEPS.toString());</span>
<span class="nc" id="L975">            mDispatcher.dispatch(SiteActionBuilder.newCompleteQuickStartAction(payload));</span>
        }
<span class="nc" id="L977">    }</span>

    private void announceTitleForAccessibility(PageType pageType) {
<span class="nc" id="L980">        getWindow().getDecorView().announceForAccessibility(mBottomNav.getContentDescriptionForPageType(pageType));</span>
<span class="nc" id="L981">    }</span>

    @Override
    public void onBackPressed() {
        // let the fragment handle the back button if it implements our OnParentBackPressedListener
<span class="nc" id="L986">        Fragment fragment = mBottomNav.getActiveFragment();</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">        if (fragment instanceof OnActivityBackPressedListener) {</span>
<span class="nc" id="L988">            boolean handled = ((OnActivityBackPressedListener) fragment).onActivityBackPressed();</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">            if (handled) {</span>
<span class="nc" id="L990">                return;</span>
            }
        }

<span class="nc bnc" id="L994" title="All 4 branches missed.">        if (isTaskRoot() &amp;&amp; DeviceUtils.getInstance().isChromebook(this)) {</span>
<span class="nc" id="L995">            return; // don't close app in Main Activity</span>
        }
<span class="nc" id="L997">        super.onBackPressed();</span>
<span class="nc" id="L998">    }</span>

    @Override
    public void onRequestShowBottomNavigation() {
<span class="nc" id="L1002">        showBottomNav(true);</span>
<span class="nc" id="L1003">    }</span>

    @Override
    public void onRequestHideBottomNavigation() {
<span class="nc" id="L1007">        showBottomNav(false);</span>
<span class="nc" id="L1008">    }</span>

    private void showBottomNav(boolean show) {
<span class="nc bnc" id="L1011" title="All 2 branches missed.">        mBottomNav.setVisibility(show ? View.VISIBLE : View.GONE);</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">        findViewById(R.id.navbar_separator).setVisibility(show ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L1013">    }</span>

    // user switched pages in the bottom navbar
    @Override
    public void onPageChanged(int position) {
<span class="nc" id="L1018">        mReaderTracker.onBottomNavigationTabChanged();</span>
<span class="nc" id="L1019">        PageType pageType = WPMainNavigationView.getPageType(position);</span>
<span class="nc" id="L1020">        trackLastVisiblePage(pageType, true);</span>

<span class="nc bnc" id="L1022" title="All 2 branches missed.">        if (pageType == PageType.READER) {</span>
            // MySite fragment might not be attached to activity, so we need to remove focus point from here
<span class="nc" id="L1024">            QuickStartUtils.removeQuickStartFocusPoint(findViewById(R.id.root_view_main));</span>
<span class="nc" id="L1025">            QuickStartTask followSiteTask = mQuickStartRepository</span>
<span class="nc" id="L1026">                    .getQuickStartType().getTaskFromString(QuickStartStore.QUICK_START_FOLLOW_SITE_LABEL);</span>
<span class="nc" id="L1027">            mQuickStartRepository.requestNextStepOfTask(followSiteTask);</span>
        }

<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (pageType == PageType.NOTIFS) {</span>
            // MySite fragment might not be attached to activity, so we need to remove focus point from here
<span class="nc" id="L1032">            QuickStartUtils.removeQuickStartFocusPoint(findViewById(R.id.root_view_main));</span>
<span class="nc" id="L1033">            mQuickStartRepository.completeTask(QuickStartExistingSiteTask.CHECK_NOTIFICATIONS);</span>
        }

<span class="nc" id="L1036">        mViewModel.onPageChanged(</span>
<span class="nc bnc" id="L1037" title="All 4 branches missed.">                mSiteStore.hasSite() &amp;&amp; pageType == PageType.MY_SITE,</span>
<span class="nc" id="L1038">                getSelectedSite()</span>
        );
<span class="nc" id="L1040">    }</span>

    // user tapped the new post button in the bottom navbar
    @Override
    public void onNewPostButtonClicked(final int promptId, @NonNull final EntryPoint entryPoint) {
<span class="nc" id="L1045">        handleNewPostAction(PagePostCreationSourcesDetail.POST_FROM_NAV_BAR, promptId, entryPoint);</span>
<span class="nc" id="L1046">    }</span>

    private void handleNewPageAction(String title, String content, String template,
                                     PagePostCreationSourcesDetail source) {
<span class="nc bnc" id="L1050" title="All 2 branches missed.">        if (!mSiteStore.hasSite()) {</span>
            // No site yet - Move to My Sites fragment that shows the create new site screen
<span class="nc" id="L1052">            mBottomNav.setCurrentSelectedPage(PageType.MY_SITE);</span>
<span class="nc" id="L1053">            return;</span>
        }

<span class="nc" id="L1056">        SiteModel selectedSite = getSelectedSite();</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">        if (selectedSite != null) {</span>
            // TODO: evaluate to include the QuickStart logic like in the handleNewPostAction
<span class="nc" id="L1059">            ActivityLauncher.addNewPageForResult(this, selectedSite, title, content, template, source);</span>
        }
<span class="nc" id="L1061">    }</span>

    private void handleNewPostAction(PagePostCreationSourcesDetail source,
                                     final int promptId,
                                     final EntryPoint entryPoint) {
<span class="nc bnc" id="L1066" title="All 2 branches missed.">        if (!mSiteStore.hasSite()) {</span>
            // No site yet - Move to My Sites fragment that shows the create new site screen
<span class="nc" id="L1068">            mBottomNav.setCurrentSelectedPage(PageType.MY_SITE);</span>
<span class="nc" id="L1069">            return;</span>
        }

<span class="nc" id="L1072">        ActivityLauncher.addNewPostForResult(this, getSelectedSite(), false, source, promptId, entryPoint);</span>
<span class="nc" id="L1073">    }</span>

    private void handleNewStoryAction() {
<span class="nc bnc" id="L1076" title="All 2 branches missed.">        if (!mSiteStore.hasSite()) {</span>
            // No site yet - Move to My Sites fragment that shows the create new site screen
<span class="nc" id="L1078">            mBottomNav.setCurrentSelectedPage(PageType.MY_SITE);</span>
<span class="nc" id="L1079">            return;</span>
        }

<span class="nc" id="L1082">        SiteModel selectedSite = getSelectedSite();</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">        if (selectedSite != null) {</span>
            // TODO: evaluate to include the QuickStart logic like in the handleNewPostAction
<span class="nc bnc" id="L1085" title="All 2 branches missed.">            if (AppPrefs.shouldShowStoriesIntro()) {</span>
<span class="nc" id="L1086">                StoriesIntroDialogFragment.newInstance(selectedSite)</span>
<span class="nc" id="L1087">                                          .show(getSupportFragmentManager(), StoriesIntroDialogFragment.TAG);</span>
            } else {
<span class="nc" id="L1089">                mMediaPickerLauncher.showStoriesPhotoPickerForResultAndTrack(this, selectedSite);</span>
            }
        }
<span class="nc" id="L1092">    }</span>

    private void trackLastVisiblePage(PageType pageType, boolean trackAnalytics) {
<span class="nc bnc" id="L1095" title="All 4 branches missed.">        switch (pageType) {</span>
            case MY_SITE:
<span class="nc" id="L1097">                ActivityId.trackLastActivity(ActivityId.MY_SITE);</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">                if (trackAnalytics) {</span>
                    // Added today's stats feature config to check if my site tab is accessed more often in AB testing
<span class="nc" id="L1100">                    mAnalyticsTrackerWrapper.track(</span>
                            AnalyticsTracker.Stat.MY_SITE_ACCESSED,
<span class="nc" id="L1102">                            getSelectedSite(),</span>
                            mTodaysStatsCardFeatureConfig
                    );
                }
                break;
            case READER:
<span class="nc" id="L1108">                ActivityId.trackLastActivity(ActivityId.READER);</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">                if (trackAnalytics) {</span>
<span class="nc" id="L1110">                    AnalyticsTracker.track(AnalyticsTracker.Stat.READER_ACCESSED);</span>
                }
                break;
            case NOTIFS:
<span class="nc" id="L1114">                ActivityId.trackLastActivity(ActivityId.NOTIFICATIONS);</span>
<span class="nc bnc" id="L1115" title="All 2 branches missed.">                if (trackAnalytics) {</span>
<span class="nc" id="L1116">                    AnalyticsTracker.track(AnalyticsTracker.Stat.NOTIFICATIONS_ACCESSED);</span>
                }
                break;
            default:
                break;
        }
<span class="nc" id="L1122">    }</span>

    private void trackDefaultApp() {
<span class="nc" id="L1125">        Intent wpcomIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(getString(R.string.wordpresscom_sample_post)));</span>
<span class="nc" id="L1126">        ResolveInfo resolveInfo = getPackageManager().resolveActivity(wpcomIntent, PackageManager.MATCH_DEFAULT_ONLY);</span>
<span class="nc bnc" id="L1127" title="All 4 branches missed.">        if (resolveInfo != null &amp;&amp; !getPackageName().equals(resolveInfo.activityInfo.name)) {</span>
            // not set as default handler so, track this to evaluate. Note, a resolver/chooser might be the default.
<span class="nc" id="L1129">            AnalyticsUtils.trackWithDefaultInterceptor(AnalyticsTracker.Stat.DEEP_LINK_NOT_DEFAULT_HANDLER,</span>
                    resolveInfo.activityInfo.name);
        }
<span class="nc" id="L1132">    }</span>

    public void setReaderPageActive() {
<span class="nc" id="L1135">        mBottomNav.setCurrentSelectedPage(PageType.READER);</span>
<span class="nc" id="L1136">    }</span>

    private void setSite(Intent data) {
<span class="nc bnc" id="L1139" title="All 2 branches missed.">        if (data != null) {</span>
<span class="nc" id="L1140">            int siteLocalId = data.getIntExtra(</span>
                    SitePickerActivity.KEY_SITE_LOCAL_ID,
                    SelectedSiteRepository.UNAVAILABLE
            );
<span class="nc" id="L1144">            SiteModel site = mSiteStore.getSiteByLocalId(siteLocalId);</span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">            if (site != null) {</span>
<span class="nc" id="L1146">                setSelectedSite(site);</span>
            }
        }
<span class="nc" id="L1149">    }</span>

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L1153">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">        if (!mSelectedSiteRepository.hasSelectedSite()) {</span>
<span class="nc" id="L1155">            initSelectedSite();</span>
        }
<span class="nc bnc" id="L1157" title="All 12 branches missed.">        switch (requestCode) {</span>
            case RequestCodes.EDIT_POST:
            case RequestCodes.EDIT_LANDING_PAGE:
<span class="nc bnc" id="L1160" title="All 6 branches missed.">                if (resultCode != Activity.RESULT_OK || data == null || isFinishing()) {</span>
<span class="nc" id="L1161">                    return;</span>
                }
<span class="nc" id="L1163">                int localId = data.getIntExtra(EditPostActivity.EXTRA_POST_LOCAL_ID, 0);</span>
<span class="nc" id="L1164">                final SiteModel site = (SiteModel) data.getSerializableExtra(WordPress.SITE);</span>
<span class="nc" id="L1165">                final PostModel post = mPostStore.getPostByLocalPostId(localId);</span>

<span class="nc bnc" id="L1167" title="All 2 branches missed.">                if (EditPostActivity.checkToRestart(data)) {</span>
<span class="nc" id="L1168">                    ActivityLauncher.editPostOrPageForResult(data, WPMainActivity.this, site,</span>
<span class="nc" id="L1169">                            data.getIntExtra(EditPostActivity.EXTRA_POST_LOCAL_ID, 0));</span>

                    // a restart will happen so, no need to continue here
<span class="nc" id="L1172">                    break;</span>
                }

<span class="nc bnc" id="L1175" title="All 4 branches missed.">                if (site != null &amp;&amp; post != null) {</span>
<span class="nc" id="L1176">                    mUploadUtilsWrapper.handleEditPostResultSnackbars(</span>
                            this,
<span class="nc" id="L1178">                            findViewById(R.id.coordinator),</span>
                            data,
                            post,
                            site,
<span class="nc" id="L1182">                            mUploadActionUseCase.getUploadAction(post),</span>
<span class="nc" id="L1183">                            new View.OnClickListener() {</span>
                                @Override
                                public void onClick(View v) {
<span class="nc" id="L1186">                                    UploadUtils.publishPost(WPMainActivity.this, post, site, mDispatcher);</span>
<span class="nc" id="L1187">                                }</span>
                            },
<span class="nc" id="L1189">                            isFirstTimePublishing -&gt; mBloggingRemindersViewModel</span>
<span class="nc" id="L1190">                                    .onPublishingPost(site.getId(), isFirstTimePublishing)</span>
                    );
                }
                break;
            case RequestCodes.CREATE_STORY:
<span class="nc" id="L1195">                SiteModel selectedSite = getSelectedSite();</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">                if (selectedSite != null) {</span>
<span class="nc bnc" id="L1197" title="All 4 branches missed.">                    boolean isNewStory = data == null || data.getStringExtra(ARG_STORY_BLOCK_ID) == null;</span>
<span class="nc" id="L1198">                    mBloggingRemindersViewModel.onPublishingPost(</span>
<span class="nc" id="L1199">                            selectedSite.getId(),</span>
<span class="nc" id="L1200">                            isNewStory</span>
                    );
<span class="nc" id="L1202">                }</span>
                break;
            case RequestCodes.CREATE_SITE:
<span class="nc" id="L1205">                QuickStartUtils.cancelQuickStartReminder(this);</span>
<span class="nc" id="L1206">                AppPrefs.setQuickStartNoticeRequired(false);</span>
<span class="nc" id="L1207">                AppPrefs.setLastSkippedQuickStartTask(null);</span>

                // Enable the block editor on sites created on mobile
<span class="nc bnc" id="L1210" title="All 2 branches missed.">                if (data != null) {</span>
<span class="nc" id="L1211">                    int newSiteLocalID = data.getIntExtra(</span>
                            SitePickerActivity.KEY_SITE_LOCAL_ID,
                            SelectedSiteRepository.UNAVAILABLE
                    );
<span class="nc" id="L1215">                    SiteUtils.enableBlockEditorOnSiteCreation(mDispatcher, mSiteStore, newSiteLocalID);</span>
                }

<span class="nc" id="L1218">                setSite(data);</span>
<span class="nc" id="L1219">                passOnActivityResultToMySiteFragment(requestCode, resultCode, data);</span>
<span class="nc" id="L1220">                mPrivateAtomicCookie.clearCookie();</span>
<span class="nc" id="L1221">                break;</span>
            case RequestCodes.ADD_ACCOUNT:
<span class="nc bnc" id="L1223" title="All 2 branches missed.">                if (resultCode == RESULT_OK) {</span>
                    // Register for Cloud messaging
<span class="nc" id="L1225">                    startWithNewAccount();</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">                } else if (!FluxCUtils.isSignedInWPComOrHasWPOrgSite(mAccountStore, mSiteStore)) {</span>
                    // can't do anything if user isn't signed in (either to wp.com or self-hosted)
<span class="nc" id="L1228">                    finish();</span>
                }
                break;
            case RequestCodes.REAUTHENTICATE:
<span class="nc bnc" id="L1232" title="All 2 branches missed.">                if (resultCode == RESULT_OK) {</span>
                    // Register for Cloud messaging
<span class="nc" id="L1234">                    GCMRegistrationIntentService.enqueueWork(this,</span>
                            new Intent(this, GCMRegistrationIntentService.class));
                }
                break;
            case RequestCodes.LOGIN_EPILOGUE:
<span class="nc bnc" id="L1239" title="All 2 branches missed.">                if (resultCode == RESULT_OK) {</span>
<span class="nc" id="L1240">                    setSite(data);</span>
<span class="nc" id="L1241">                    passOnActivityResultToMySiteFragment(requestCode, resultCode, data);</span>
                }
                break;
            case RequestCodes.SITE_PICKER:
<span class="nc bnc" id="L1245" title="All 2 branches missed.">                boolean isSameSiteSelected = data != null</span>
<span class="nc" id="L1246">                                             &amp;&amp; data.getIntExtra(</span>
                        SitePickerActivity.KEY_SITE_LOCAL_ID,
                        SelectedSiteRepository.UNAVAILABLE
<span class="nc bnc" id="L1249" title="All 2 branches missed.">                ) == mSelectedSiteRepository.getSelectedSiteLocalId();</span>

<span class="nc bnc" id="L1251" title="All 2 branches missed.">                if (!isSameSiteSelected) {</span>
<span class="nc" id="L1252">                    QuickStartUtils.cancelQuickStartReminder(this);</span>
<span class="nc" id="L1253">                    AppPrefs.setQuickStartNoticeRequired(false);</span>
<span class="nc" id="L1254">                    AppPrefs.setLastSkippedQuickStartTask(null);</span>
<span class="nc" id="L1255">                    mPrivateAtomicCookie.clearCookie();</span>
                }
<span class="nc" id="L1257">                setSite(data);</span>
<span class="nc" id="L1258">                passOnActivityResultToMySiteFragment(requestCode, resultCode, data);</span>
<span class="nc" id="L1259">                break;</span>
            case RequestCodes.SITE_SETTINGS:
<span class="nc bnc" id="L1261" title="All 2 branches missed.">                if (resultCode == SiteSettingsFragment.RESULT_BLOG_REMOVED) {</span>
<span class="nc" id="L1262">                    handleSiteRemoved();</span>
                }
                break;
            case RequestCodes.APP_SETTINGS:
<span class="nc bnc" id="L1266" title="All 2 branches missed.">                if (resultCode == AppSettingsFragment.LANGUAGE_CHANGED) {</span>
<span class="nc" id="L1267">                    appLanguageChanged();</span>
                }
                break;
            case RequestCodes.NOTE_DETAIL:
<span class="nc bnc" id="L1271" title="All 2 branches missed.">                if (getNotificationsListFragment() != null) {</span>
<span class="nc" id="L1272">                    getNotificationsListFragment().onActivityResult(requestCode, resultCode, data);</span>
                }
                break;
            case RequestCodes.STORIES_PHOTO_PICKER:
            case RequestCodes.PHOTO_PICKER:
            case RequestCodes.DOMAIN_REGISTRATION:
<span class="nc" id="L1278">                passOnActivityResultToMySiteFragment(requestCode, resultCode, data);</span>
                break;
        }
<span class="nc" id="L1281">    }</span>

    private void appLanguageChanged() {
        // Recreate this activity (much like a configuration change)
        // We need to post this call to UI thread, since it's called from onActivityResult and the call interferes with
        // onResume that is called right afterwards.
<span class="nc" id="L1287">        new Handler(Looper.getMainLooper()).post(this::recreate);</span>

        // When language changed we need to reset the shared prefs reader tag since if we have it stored
        // it's fields can be in a different language and we can get odd behaviors since we will generally fail
        // to get the ReaderTag.equals method recognize the equality based on the ReaderTag.getLabel method.
<span class="nc" id="L1292">        AppPrefs.setReaderTag(null);</span>
<span class="nc" id="L1293">    }</span>

    private void startWithNewAccount() {
<span class="nc" id="L1296">        GCMRegistrationIntentService.enqueueWork(this,</span>
                new Intent(this, GCMRegistrationIntentService.class));
<span class="nc" id="L1298">        ReaderUpdateServiceStarter.startService(this, EnumSet.of(UpdateTask.TAGS, UpdateTask.FOLLOWED_BLOGS));</span>
<span class="nc" id="L1299">    }</span>

    private MySiteFragment getMySiteFragment() {
<span class="nc" id="L1302">        Fragment fragment = mBottomNav.getFragment(PageType.MY_SITE);</span>
<span class="nc bnc" id="L1303" title="All 2 branches missed.">        if (fragment instanceof MySiteFragment) {</span>
<span class="nc" id="L1304">            return (MySiteFragment) fragment;</span>
        }

<span class="nc" id="L1307">        return null;</span>
    }

    private void passOnActivityResultToMySiteFragment(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L1311">        Fragment fragment = mBottomNav.getFragment(PageType.MY_SITE);</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">        if (fragment != null) {</span>
<span class="nc" id="L1313">            fragment.onActivityResult(requestCode, resultCode, data);</span>
        }
<span class="nc" id="L1315">    }</span>

    private NotificationsListFragment getNotificationsListFragment() {
<span class="nc" id="L1318">        Fragment fragment = mBottomNav.getFragment(PageType.NOTIFS);</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">        if (fragment instanceof NotificationsListFragment) {</span>
<span class="nc" id="L1320">            return (NotificationsListFragment) fragment;</span>
        }
<span class="nc" id="L1322">        return null;</span>
    }

    // We only do this for Quick Start focus points that need to be shown on the activity level.
    private void addOrRemoveQuickStartFocusPoint(QuickStartTask activeTask, boolean shouldAdd) {
<span class="nc" id="L1327">        final QuickStartMySitePrompts prompts = QuickStartMySitePrompts.getPromptDetailsForTask(activeTask);</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">        if (prompts == null) return;</span>
<span class="nc" id="L1329">        final ViewGroup parentView = findViewById(prompts.getParentContainerId());</span>
<span class="nc" id="L1330">        final View targetView = findViewById(prompts.getFocusedContainerId());</span>
<span class="nc bnc" id="L1331" title="All 2 branches missed.">        if (parentView != null) {</span>
<span class="nc" id="L1332">            int size = getResources().getDimensionPixelOffset(R.dimen.quick_start_focus_point_size);</span>
            int horizontalOffset;
            int verticalOffset;
<span class="nc" id="L1335">            QuickStartTask followSiteTask = mQuickStartRepository</span>
<span class="nc" id="L1336">                    .getQuickStartType().getTaskFromString(QuickStartStore.QUICK_START_FOLLOW_SITE_LABEL);</span>
<span class="nc bnc" id="L1337" title="All 2 branches missed.">            if (followSiteTask.equals(activeTask)</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">                || QuickStartExistingSiteTask.CHECK_NOTIFICATIONS.equals(activeTask)) {</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">                horizontalOffset = targetView != null ? ((targetView.getWidth() / 2 - size + getResources()</span>
<span class="nc" id="L1340">                        .getDimensionPixelOffset(R.dimen.quick_start_focus_point_bottom_nav_offset))) : 0;</span>
<span class="nc" id="L1341">                verticalOffset = 0;</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">            } else if (QuickStartNewSiteTask.PUBLISH_POST.equals(activeTask)) {</span>
<span class="nc" id="L1343">                horizontalOffset = getResources()</span>
<span class="nc" id="L1344">                        .getDimensionPixelOffset(R.dimen.quick_start_focus_point_my_site_right_offset);</span>
<span class="nc bnc" id="L1345" title="All 2 branches missed.">                verticalOffset = targetView != null ? ((targetView.getHeight() - size) / 2) : 0;</span>
            } else {
<span class="nc" id="L1347">                horizontalOffset = 0;</span>
<span class="nc" id="L1348">                verticalOffset = 0;</span>
            }
<span class="nc bnc" id="L1350" title="All 4 branches missed.">            if (targetView != null &amp;&amp; shouldAdd) {</span>
<span class="nc" id="L1351">                QuickStartUtils.addQuickStartFocusPointAboveTheView(</span>
                        parentView,
                        targetView,
                        horizontalOffset,
                        verticalOffset
                );
            } else {
<span class="nc" id="L1358">                QuickStartUtils.removeQuickStartFocusPoint(parentView);</span>
            }
        }
<span class="nc" id="L1361">    }</span>

    // Events

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAuthenticationChanged(OnAuthenticationChanged event) {
<span class="nc bnc" id="L1368" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc bnc" id="L1369" title="All 4 branches missed.">            if (mSelectedSiteRepository.hasSelectedSite()</span>
                &amp;&amp; event.error.type == AuthenticationErrorType.INVALID_TOKEN) {
<span class="nc" id="L1371">                AuthenticationDialogUtils.showAuthErrorView(this, mSiteStore, getSelectedSite());</span>
            }

<span class="nc" id="L1374">            return;</span>
        }

<span class="nc bnc" id="L1377" title="All 2 branches missed.">        if (mAccountStore.hasAccessToken()) {</span>
<span class="nc bnc" id="L1378" title="All 2 branches missed.">            if (mIsMagicLinkLogin) {</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">                if (mIsMagicLinkSignup) {</span>
                    // Sets a flag that we need to track a magic link sign up.
                    // We'll handle it in onAccountChanged so we know we have
                    // updated account info.
<span class="nc" id="L1383">                    AppPrefs.setShouldTrackMagicLinkSignup(true);</span>
<span class="nc" id="L1384">                    mViewModel.checkAndSetVariantForMySiteDefaultTabExperiment();</span>
<span class="nc" id="L1385">                    mDispatcher.dispatch(AccountActionBuilder.newFetchAccountAction());</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">                    if (mJetpackConnectSource != null) {</span>
<span class="nc" id="L1387">                        ActivityLauncher.continueJetpackConnect(this, mJetpackConnectSource, getSelectedSite());</span>
                    } else {
<span class="nc" id="L1389">                        ActivityLauncher.showSignupEpilogue(this, null, null, null, null, true);</span>
                    }
                } else {
<span class="nc" id="L1392">                    mLoginAnalyticsListener.trackLoginMagicLinkSucceeded();</span>

<span class="nc bnc" id="L1394" title="All 2 branches missed.">                    if (mJetpackConnectSource != null) {</span>
<span class="nc" id="L1395">                        ActivityLauncher.continueJetpackConnect(this, mJetpackConnectSource, getSelectedSite());</span>
                    } else {
<span class="nc" id="L1397">                        ActivityLauncher.showLoginEpilogue(</span>
                                this,
                                true,
<span class="nc" id="L1400">                                getIntent().getIntegerArrayListExtra(ARG_OLD_SITES_IDS),</span>
<span class="nc" id="L1401">                                mBuildConfigWrapper.isSiteCreationEnabled()</span>
                        );
                    }
                }
            }
        }
<span class="nc" id="L1407">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onQuickStartCompleted(OnQuickStartCompleted event) {
<span class="nc bnc" id="L1412" title="All 4 branches missed.">        if (getSelectedSite() != null &amp;&amp; !event.isError()) {</span>
            // as long as we get any response that is not an error mark quick start notification as received
<span class="nc" id="L1414">            mQuickStartStore.setQuickStartNotificationReceived(event.site.getId(), true);</span>
        }
<span class="nc" id="L1416">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAccountChanged(OnAccountChanged event) {
        // Sign-out is handled in `handleSiteRemoved`, no need to show the signup flow here
<span class="nc bnc" id="L1422" title="All 2 branches missed.">        if (mAccountStore.hasAccessToken()) {</span>
<span class="nc" id="L1423">            mBottomNav.showNoteBadge(mAccountStore.getAccount().getHasUnseenNotes());</span>
<span class="nc bnc" id="L1424" title="All 2 branches missed.">            if (AppPrefs.getShouldTrackMagicLinkSignup()) {</span>
<span class="nc" id="L1425">                trackMagicLinkSignupIfNeeded();</span>
            }
        }
<span class="nc" id="L1428">    }</span>

    /**
     * Bumps stats related to a magic link sign up provided the account has been updated with
     * the username and email address needed to refresh analytics meta data.
     */
    private void trackMagicLinkSignupIfNeeded() {
<span class="nc" id="L1435">        AccountModel account = mAccountStore.getAccount();</span>
<span class="nc bnc" id="L1436" title="All 4 branches missed.">        if (!TextUtils.isEmpty(account.getUserName()) &amp;&amp; !TextUtils.isEmpty(account.getEmail())) {</span>
<span class="nc" id="L1437">            mLoginAnalyticsListener.trackCreatedAccount(account.getUserName(), account.getEmail(), EMAIL);</span>
<span class="nc" id="L1438">            mLoginAnalyticsListener.trackSignupMagicLinkSucceeded();</span>
<span class="nc" id="L1439">            mLoginAnalyticsListener.trackAnalyticsSignIn(true);</span>
<span class="nc" id="L1440">            AppPrefs.removeShouldTrackMagicLinkSignup();</span>
        }
<span class="nc" id="L1442">    }</span>


    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(NotificationEvents.NotificationsChanged event) {
<span class="nc" id="L1448">        mBottomNav.showNoteBadge(event.hasUnseenNotes);</span>
<span class="nc" id="L1449">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(NotificationEvents.NotificationsUnseenStatus event) {
<span class="nc" id="L1454">        mBottomNav.showNoteBadge(event.hasUnseenNotes);</span>
<span class="nc" id="L1455">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(ConnectionChangeReceiver.ConnectionChangeEvent event) {
<span class="nc" id="L1460">        updateConnectionBar(event.isConnected());</span>
<span class="nc" id="L1461">    }</span>

    private void checkConnection() {
<span class="nc" id="L1464">        updateConnectionBar(NetworkUtils.isNetworkAvailable(this));</span>
<span class="nc" id="L1465">    }</span>

    private void updateConnectionBar(boolean isConnected) {
<span class="nc bnc" id="L1468" title="All 4 branches missed.">        if (isConnected &amp;&amp; mConnectionBar.getVisibility() == View.VISIBLE) {</span>
<span class="nc" id="L1469">            AniUtils.animateBottomBar(mConnectionBar, false);</span>
<span class="nc bnc" id="L1470" title="All 4 branches missed.">        } else if (!isConnected &amp;&amp; mConnectionBar.getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L1471">            AniUtils.animateBottomBar(mConnectionBar, true);</span>
        }
<span class="nc" id="L1473">    }</span>

    private void handleSiteRemoved() {
<span class="nc" id="L1476">        mViewModel.handleSiteRemoved();</span>
<span class="nc bnc" id="L1477" title="All 2 branches missed.">        if (!mViewModel.isSignedInWPComOrHasWPOrgSite()) {</span>
<span class="nc" id="L1478">            showSignInForResultBasedOnIsJetpackAppBuildConfig(this);</span>
<span class="nc" id="L1479">            return;</span>
        }
<span class="nc bnc" id="L1481" title="All 2 branches missed.">        if (mViewModel.getHasMultipleSites()) {</span>
<span class="nc" id="L1482">            ActivityLauncher.showSitePickerForResult(this, mViewModel.getFirstSite());</span>
        }
<span class="nc" id="L1484">    }</span>

    /**
     * @return null if there is no site or if there is no selected site
     */
    @Nullable
    public SiteModel getSelectedSite() {
<span class="nc" id="L1491">        return mSelectedSiteRepository.getSelectedSite();</span>
    }

    private void setSelectedSite(@NonNull SiteModel selectedSite) {
        // Make selected site visible
<span class="nc" id="L1496">        selectedSite.setIsVisible(true);</span>
<span class="nc" id="L1497">        mSelectedSiteRepository.updateSite(selectedSite);</span>

        // When we select a site, we want to update its information or options
<span class="nc" id="L1500">        mDispatcher.dispatch(SiteActionBuilder.newFetchSiteAction(selectedSite));</span>
<span class="nc" id="L1501">    }</span>

    /**
     * This should not be moved to a SiteUtils.getSelectedSite() or similar static method. We don't want
     * this to be used globally like WordPress.getCurrentBlog() was used. The state is maintained by this
     * Activity and the selected site parameter is passed along to other activities / fragments.
     */
    private void initSelectedSite() {
<span class="nc" id="L1509">        int selectedSiteLocalId = mSelectedSiteRepository.getSelectedSiteLocalId(true);</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">        if (selectedSiteLocalId != SelectedSiteRepository.UNAVAILABLE) {</span>
            // Site previously selected, use it
<span class="nc" id="L1512">            SiteModel site = mSiteStore.getSiteByLocalId(selectedSiteLocalId);</span>
<span class="nc bnc" id="L1513" title="All 2 branches missed.">            if (site != null) {</span>
<span class="nc" id="L1514">                mSelectedSiteRepository.updateSite(site);</span>
            }
            // If saved site exist, then return, else (site has been removed?) try to select another site
<span class="nc bnc" id="L1517" title="All 2 branches missed.">            if (mSelectedSiteRepository.hasSelectedSite()) {</span>
<span class="nc" id="L1518">                return;</span>
            }
        }

        // Try to select the primary wpcom site
<span class="nc" id="L1523">        long siteId = mAccountStore.getAccount().getPrimarySiteId();</span>
<span class="nc" id="L1524">        SiteModel primarySite = mSiteStore.getSiteBySiteId(siteId);</span>
        // Primary site found, select it
<span class="nc bnc" id="L1526" title="All 2 branches missed.">        if (primarySite != null) {</span>
<span class="nc" id="L1527">            setSelectedSite(primarySite);</span>
<span class="nc" id="L1528">            return;</span>
        }

        // Else select the first visible site in the list
<span class="nc" id="L1532">        List&lt;SiteModel&gt; sites = mSiteStore.getVisibleSites();</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">        if (sites.size() != 0) {</span>
<span class="nc" id="L1534">            setSelectedSite(sites.get(0));</span>
<span class="nc" id="L1535">            return;</span>
        }

        // Else select the first in the list
<span class="nc" id="L1539">        sites = mSiteStore.getSites();</span>
<span class="nc bnc" id="L1540" title="All 2 branches missed.">        if (sites.size() != 0) {</span>
<span class="nc" id="L1541">            setSelectedSite(sites.get(0));</span>
        }

        // Else no site selected
<span class="nc" id="L1545">    }</span>

    // FluxC events
    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPostUploaded(OnPostUploaded event) {
        // WPMainActivity never stops listening for the Dispatcher events and as a result it tries to show the
        // SnackBar even when another activity is in the foreground. However, this has a tricky side effect, as if
        // the Activity in the foreground is showing a Snackbar the SnackBar is dismissed as soon as the
        // WPMainActivity invokes show(). This condition makes sure, the WPMainActivity invokes show() only when
        // it's visible. For more info see https://github.com/wordpress-mobile/WordPress-Android/issues/9604
<span class="nc bnc" id="L1556" title="All 2 branches missed.">        if (getLifecycle().getCurrentState().isAtLeast(STARTED)) {</span>
<span class="nc" id="L1557">            SiteModel selectedSite = getSelectedSite();</span>

<span class="nc bnc" id="L1559" title="All 4 branches missed.">            if (selectedSite != null &amp;&amp; event.post != null) {</span>
                SiteModel targetSite;

<span class="nc bnc" id="L1562" title="All 2 branches missed.">                if (event.post.getLocalSiteId() == selectedSite.getId()) {</span>
<span class="nc" id="L1563">                    targetSite = selectedSite;</span>
                } else {
<span class="nc" id="L1565">                    SiteModel postSite = mSiteStore.getSiteByLocalId(event.post.getLocalSiteId());</span>

<span class="nc bnc" id="L1567" title="All 2 branches missed.">                    if (postSite != null) {</span>
<span class="nc" id="L1568">                        targetSite = postSite;</span>
                    } else {
<span class="nc" id="L1570">                        AppLog.d(</span>
                                T.MAIN,
                                &quot;WPMainActivity &gt;  onPostUploaded: got an event from a not found site [&quot;
<span class="nc" id="L1573">                                + event.post.getLocalSiteId() + &quot;].&quot;</span>
                        );
<span class="nc" id="L1575">                        return;</span>
                    }
                }

<span class="nc" id="L1579">                mUploadUtilsWrapper.onPostUploadedSnackbarHandler(</span>
                        this,
<span class="nc" id="L1581">                        findViewById(R.id.coordinator),</span>
<span class="nc" id="L1582">                        event.isError(),</span>
                        event.isFirstTimePublish,
                        event.post,
                        null,
                        targetSite,
<span class="nc" id="L1587">                        isFirstTimePublishing -&gt; mBloggingRemindersViewModel</span>
<span class="nc" id="L1588">                                .onPublishingPost(targetSite.getId(), isFirstTimePublishing)</span>
                );
            }
        }
<span class="nc" id="L1592">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSiteChanged(OnSiteChanged event) {
        // &quot;Reload&quot; selected site from the db
        // It would be better if the OnSiteChanged provided the list of changed sites.
<span class="nc bnc" id="L1599" title="All 4 branches missed.">        if (getSelectedSite() == null &amp;&amp; mSiteStore.hasSite()) {</span>
<span class="nc" id="L1600">            setSelectedSite(mSiteStore.getSites().get(0));</span>
        }
<span class="nc" id="L1602">        SiteModel selectedSite = getSelectedSite();</span>
<span class="nc bnc" id="L1603" title="All 2 branches missed.">        if (selectedSite != null) {</span>
<span class="nc" id="L1604">            SiteModel site = mSiteStore.getSiteByLocalId(selectedSite.getId());</span>
<span class="nc bnc" id="L1605" title="All 2 branches missed.">            if (site != null) {</span>
<span class="nc" id="L1606">                mSelectedSiteRepository.updateSite(site);</span>
            }
        }
<span class="nc" id="L1609">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSiteEditorsChanged(OnSiteEditorsChanged event) {
        // When the site editor details are loaded from the remote backend, make sure to set a default if empty
<span class="nc bnc" id="L1615" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1616">            return;</span>
        }

<span class="nc" id="L1619">        refreshCurrentSelectedSiteAfterEditorChanges(false, event.site.getId());</span>
<span class="nc" id="L1620">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAllSitesMobileEditorChanged(OnAllSitesMobileEditorChanged event) {
<span class="nc bnc" id="L1625" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1626">            return;</span>
        }
<span class="nc bnc" id="L1628" title="All 2 branches missed.">        if (event.isNetworkResponse) {</span>
            // We can remove the global app setting now, since we're sure the migration ended with success.
<span class="nc" id="L1630">            AppPrefs.removeAppWideEditorPreference();</span>
        }
<span class="nc" id="L1632">        refreshCurrentSelectedSiteAfterEditorChanges(true, -1);</span>
<span class="nc" id="L1633">    }</span>

    private void refreshCurrentSelectedSiteAfterEditorChanges(boolean alwaysRefreshUI, int siteLocalId) {
        // Need to update the user property about GB enabled on any of the sites
<span class="nc" id="L1637">        AnalyticsUtils.refreshMetadata(mAccountStore, mSiteStore);</span>

        // &quot;Reload&quot; selected site from the db
        // It would be better if the OnSiteChanged provided the list of changed sites.
<span class="nc bnc" id="L1641" title="All 4 branches missed.">        if (getSelectedSite() == null &amp;&amp; mSiteStore.hasSite()) {</span>
<span class="nc" id="L1642">            setSelectedSite(mSiteStore.getSites().get(0));</span>
        }
<span class="nc" id="L1644">        SiteModel selectedSite = getSelectedSite();</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">        if (selectedSite != null) {</span>
            // When alwaysRefreshUI is `true` we need to refresh the UI regardless of the current site
<span class="nc bnc" id="L1647" title="All 2 branches missed.">            if (!alwaysRefreshUI) {</span>
                // we need to refresh the UI only when the site IDs matches
<span class="nc bnc" id="L1649" title="All 2 branches missed.">                if (selectedSite.getId() != siteLocalId) {</span>
                    // No need to refresh the UI, since the current selected site is another site
<span class="nc" id="L1651">                    return;</span>
                }
            }

<span class="nc" id="L1655">            SiteModel site = mSiteStore.getSiteByLocalId(selectedSite.getId());</span>
<span class="nc bnc" id="L1656" title="All 2 branches missed.">            if (site != null) {</span>
<span class="nc" id="L1657">                mSelectedSiteRepository.updateSite(site);</span>
            }
        }
<span class="nc" id="L1660">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSiteRemoved(OnSiteRemoved event) {
<span class="nc" id="L1665">        handleSiteRemoved();</span>
<span class="nc" id="L1666">    }</span>

    @Override
    public void onPositiveClicked(@NonNull String instanceTag) {
<span class="nc" id="L1670">        MySiteFragment mySiteFragment = getMySiteFragment();</span>
<span class="nc bnc" id="L1671" title="All 2 branches missed.">        if (mySiteFragment != null) {</span>
<span class="nc" id="L1672">            mySiteFragment.onPositiveClicked(instanceTag);</span>
        }
<span class="nc" id="L1674">    }</span>

    @Override
    public void onNegativeClicked(@NonNull String instanceTag) {
<span class="nc" id="L1678">        MySiteFragment mySiteFragment = getMySiteFragment();</span>
<span class="nc bnc" id="L1679" title="All 2 branches missed.">        if (mySiteFragment != null) {</span>
<span class="nc" id="L1680">            mySiteFragment.onNegativeClicked(instanceTag);</span>
        }
<span class="nc" id="L1682">    }</span>

    @Override
    public void onSetPromptReminderClick(final int siteId) {
<span class="nc" id="L1686">        mBloggingRemindersViewModel.onBloggingPromptSchedulingRequested(siteId);</span>
<span class="nc" id="L1687">    }</span>

    @Override public void onShowBloggingPromptsOnboarding() {
<span class="nc" id="L1690">        showBloggingPromptsOnboarding();</span>
<span class="nc" id="L1691">    }</span>

    @Override public void onUpdateSelectedSiteResult(int resultCode, @Nullable Intent data) {
<span class="nc" id="L1694">        onActivityResult(RequestCodes.SITE_PICKER, resultCode, data);</span>
<span class="nc" id="L1695">    }</span>

    // We dismiss the QuickStart SnackBar every time activity is paused because
    // SnackBar sometimes do not appear when another SnackBar is still visible, even in other activities (weird)
    @Override
    protected void onPause() {
<span class="nc" id="L1701">        super.onPause();</span>

<span class="nc" id="L1703">        QuickStartUtils.removeQuickStartFocusPoint(findViewById(R.id.root_view_main));</span>
<span class="nc" id="L1704">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>