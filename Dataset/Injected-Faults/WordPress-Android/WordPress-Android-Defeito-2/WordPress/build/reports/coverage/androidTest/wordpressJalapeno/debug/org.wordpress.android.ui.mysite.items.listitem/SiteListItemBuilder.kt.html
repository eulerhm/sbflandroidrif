<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SiteListItemBuilder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.mysite.items.listitem</a> &gt; <span class="el_source">SiteListItemBuilder.kt</span></div><h1>SiteListItemBuilder.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.mysite.items.listitem

import android.text.TextUtils
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.AccountStore
import org.wordpress.android.ui.mysite.MySiteCardAndItem
import org.wordpress.android.ui.mysite.MySiteCardAndItem.Item.ListItem
import org.wordpress.android.ui.mysite.MySiteViewModel
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.ACTIVITY_LOG
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.ADMIN
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.BACKUP
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.DOMAINS
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.JETPACK_SETTINGS
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.PAGES
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.PEOPLE
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.PLAN
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.PLUGINS
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.SCAN
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.SHARING
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.SITE_SETTINGS
import org.wordpress.android.ui.mysite.items.listitem.ListItemAction.THEMES
import org.wordpress.android.ui.plugins.PluginUtilsWrapper
import org.wordpress.android.ui.themes.ThemeBrowserUtils
import org.wordpress.android.ui.utils.ListItemInteraction
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.BuildConfigWrapper
import org.wordpress.android.util.DateTimeUtils
import org.wordpress.android.util.SiteUtilsWrapper
import org.wordpress.android.util.config.SiteDomainsFeatureConfig
import java.util.GregorianCalendar
import java.util.TimeZone
import javax.inject.Inject

<span class="nc" id="L36">@Suppress(&quot;TooManyFunctions&quot;)</span>
<span class="nc" id="L37">class SiteListItemBuilder @Inject constructor(</span>
<span class="nc" id="L38">    private val accountStore: AccountStore,</span>
<span class="nc" id="L39">    private val pluginUtilsWrapper: PluginUtilsWrapper,</span>
<span class="nc" id="L40">    private val siteUtilsWrapper: SiteUtilsWrapper,</span>
<span class="nc" id="L41">    private val buildConfigWrapper: BuildConfigWrapper,</span>
<span class="nc" id="L42">    private val themeBrowserUtils: ThemeBrowserUtils,</span>
<span class="nc" id="L43">    private val siteDomainsFeatureConfig: SiteDomainsFeatureConfig</span>
) {
    fun buildActivityLogItemIfAvailable(site: SiteModel, onClick: (ListItemAction) -&gt; Unit): ListItem? {
<span class="nc bnc" id="L46" title="All 2 branches missed.">        val isWpComOrJetpack = siteUtilsWrapper.isAccessedViaWPComRest(</span>
<span class="nc" id="L47">                site</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">        ) || site.isJetpackConnected</span>
<span class="nc bnc" id="L49" title="All 6 branches missed.">        return if (site.hasCapabilityManageOptions &amp;&amp; isWpComOrJetpack &amp;&amp; !site.isWpForTeamsSite) {</span>
<span class="nc" id="L50">            ListItem(</span>
<span class="nc" id="L51">                    R.drawable.ic_gridicons_clipboard_white_24dp,</span>
<span class="nc" id="L52">                    UiStringRes(R.string.activity_log),</span>
<span class="nc" id="L53">                    onClick = ListItemInteraction.create(ACTIVITY_LOG, onClick)</span>
            )
<span class="nc" id="L55">        } else null</span>
    }

<span class="nc" id="L58">    fun buildBackupItemIfAvailable(onClick: (ListItemAction) -&gt; Unit, isBackupAvailable: Boolean = false): ListItem? {</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">        return if (isBackupAvailable) {</span>
<span class="nc" id="L60">            ListItem(</span>
<span class="nc" id="L61">                    R.drawable.ic_gridicons_cloud_upload_white_24dp,</span>
<span class="nc" id="L62">                    UiStringRes(R.string.backup),</span>
<span class="nc" id="L63">                    onClick = ListItemInteraction.create(BACKUP, onClick)</span>
            )
<span class="nc" id="L65">        } else null</span>
    }

<span class="nc" id="L68">    fun buildScanItemIfAvailable(onClick: (ListItemAction) -&gt; Unit, isScanAvailable: Boolean = false): ListItem? {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        return if (isScanAvailable) {</span>
<span class="nc" id="L70">            ListItem(</span>
<span class="nc" id="L71">                    R.drawable.ic_baseline_security_white_24dp,</span>
<span class="nc" id="L72">                    UiStringRes(R.string.scan),</span>
<span class="nc" id="L73">                    onClick = ListItemInteraction.create(SCAN, onClick)</span>
            )
<span class="nc" id="L75">        } else null</span>
    }

    fun buildJetpackItemIfAvailable(site: SiteModel, onClick: (ListItemAction) -&gt; Unit): ListItem? {
<span class="nc bnc" id="L79" title="All 2 branches missed.">        val jetpackSettingsVisible = site.isJetpackConnected &amp;&amp; // jetpack is installed and connected</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                !site.isWPComAtomic &amp;&amp;</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                siteUtilsWrapper.isAccessedViaWPComRest(site) &amp;&amp; // is using .com login</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                site.hasCapabilityManageOptions // has permissions to manage the site</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        return if (jetpackSettingsVisible) {</span>
<span class="nc" id="L84">            ListItem(</span>
<span class="nc" id="L85">                    R.drawable.ic_cog_white_24dp,</span>
<span class="nc" id="L86">                    UiStringRes(R.string.my_site_btn_jetpack_settings),</span>
<span class="nc" id="L87">                    onClick = ListItemInteraction.create(JETPACK_SETTINGS, onClick)</span>
            )
<span class="nc" id="L89">        } else null</span>
    }

    @Suppress(&quot;ComplexCondition&quot;)
    fun buildPlanItemIfAvailable(
        site: SiteModel,
        showFocusPoint: Boolean,
        onClick: (ListItemAction) -&gt; Unit
    ): ListItem? {
<span class="nc" id="L98">        val planShortName = site.planShortName</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        return if (!TextUtils.isEmpty(planShortName) &amp;&amp;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                site.hasCapabilityManageOptions &amp;&amp;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                !site.isWpForTeamsSite &amp;&amp;</span>
<span class="nc bnc" id="L102" title="All 4 branches missed.">                (site.isWPCom || site.isAutomatedTransfer)) {</span>
<span class="nc" id="L103">            ListItem(</span>
<span class="nc" id="L104">                    R.drawable.ic_plans_white_24dp,</span>
<span class="nc" id="L105">                    UiStringRes(R.string.plan),</span>
<span class="nc" id="L106">                    secondaryText = UiStringText(planShortName),</span>
<span class="nc" id="L107">                    onClick = ListItemInteraction.create(PLAN, onClick),</span>
<span class="nc" id="L108">                    showFocusPoint = showFocusPoint</span>
            )
<span class="nc" id="L110">        } else null</span>
    }

    fun buildPagesItemIfAvailable(
        site: SiteModel,
        onClick: (ListItemAction) -&gt; Unit,
        showFocusPoint: Boolean
    ): ListItem? {
<span class="nc bnc" id="L118" title="All 4 branches missed.">        return if (site.isSelfHostedAdmin || site.hasCapabilityEditPages) {</span>
<span class="nc" id="L119">            ListItem(</span>
<span class="nc" id="L120">                    R.drawable.ic_pages_white_24dp,</span>
<span class="nc" id="L121">                    UiStringRes(R.string.my_site_btn_site_pages),</span>
<span class="nc" id="L122">                    onClick = ListItemInteraction.create(PAGES, onClick),</span>
<span class="nc" id="L123">                    showFocusPoint = showFocusPoint</span>
            )
<span class="nc" id="L125">        } else null</span>
    }

    fun buildAdminItemIfAvailable(site: SiteModel, onClick: (ListItemAction) -&gt; Unit): ListItem? {
<span class="nc bnc" id="L129" title="All 2 branches missed.">        return if (shouldShowWPAdmin(site)) {</span>
<span class="nc" id="L130">            ListItem(</span>
<span class="nc" id="L131">                    R.drawable.ic_wordpress_white_24dp,</span>
<span class="nc" id="L132">                    UiStringRes(R.string.my_site_btn_view_admin),</span>
<span class="nc" id="L133">                    secondaryIcon = R.drawable.ic_external_white_24dp,</span>
<span class="nc" id="L134">                    onClick = ListItemInteraction.create(ADMIN, onClick)</span>
            )
<span class="nc" id="L136">        } else null</span>
    }

    fun buildPeopleItemIfAvailable(site: SiteModel, onClick: (ListItemAction) -&gt; Unit): ListItem? {
<span class="nc bnc" id="L140" title="All 2 branches missed.">        return if (site.hasCapabilityListUsers) {</span>
<span class="nc" id="L141">            ListItem(</span>
<span class="nc" id="L142">                    R.drawable.ic_user_white_24dp,</span>
<span class="nc" id="L143">                    UiStringRes(R.string.people),</span>
<span class="nc" id="L144">                    onClick = ListItemInteraction.create(PEOPLE, onClick)</span>
            )
<span class="nc" id="L146">        } else null</span>
    }

    fun buildPluginItemIfAvailable(site: SiteModel, onClick: (ListItemAction) -&gt; Unit): ListItem? {
<span class="nc bnc" id="L150" title="All 2 branches missed.">        return if (pluginUtilsWrapper.isPluginFeatureAvailable(site)) {</span>
<span class="nc" id="L151">            ListItem(</span>
<span class="nc" id="L152">                    R.drawable.ic_plugins_white_24dp,</span>
<span class="nc" id="L153">                    UiStringRes(R.string.my_site_btn_plugins),</span>
<span class="nc" id="L154">                    onClick = ListItemInteraction.create(PLUGINS, onClick)</span>
            )
<span class="nc" id="L156">        } else null</span>
    }

<span class="nc" id="L159">    fun buildShareItemIfAvailable(</span>
        site: SiteModel,
        onClick: (ListItemAction) -&gt; Unit,
<span class="nc" id="L162">        showFocusPoint: Boolean = false</span>
    ): ListItem? {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        return if (site.supportsSharing()) {</span>
<span class="nc" id="L165">            ListItem(</span>
<span class="nc" id="L166">                    R.drawable.ic_share_white_24dp,</span>
<span class="nc" id="L167">                    UiStringRes(R.string.my_site_btn_sharing),</span>
<span class="nc" id="L168">                    showFocusPoint = showFocusPoint,</span>
<span class="nc" id="L169">                    onClick = ListItemInteraction.create(SHARING, onClick)</span>
            )
<span class="nc" id="L171">        } else null</span>
    }

    fun buildDomainsItemIfAvailable(site: SiteModel, onClick: (ListItemAction) -&gt; Unit): ListItem? {
<span class="nc" id="L175">        return if (</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                buildConfigWrapper.isJetpackApp &amp;&amp;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                siteDomainsFeatureConfig.isEnabled() &amp;&amp;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                site.hasCapabilityManageOptions</span>
        ) {
<span class="nc" id="L180">            ListItem(</span>
<span class="nc" id="L181">                    R.drawable.ic_domains_white_24dp,</span>
<span class="nc" id="L182">                    UiStringRes(R.string.my_site_btn_domains),</span>
<span class="nc" id="L183">                    onClick = ListItemInteraction.create(DOMAINS, onClick)</span>
            )
<span class="nc" id="L185">        } else null</span>
    }

    fun buildSiteSettingsItemIfAvailable(site: SiteModel, onClick: (ListItemAction) -&gt; Unit): ListItem? {
<span class="nc bnc" id="L189" title="All 4 branches missed.">        return if (site.hasCapabilityManageOptions || !siteUtilsWrapper.isAccessedViaWPComRest(site)) {</span>
<span class="nc" id="L190">            ListItem(</span>
<span class="nc" id="L191">                    R.drawable.ic_cog_white_24dp,</span>
<span class="nc" id="L192">                    UiStringRes(R.string.my_site_btn_site_settings),</span>
<span class="nc" id="L193">                    onClick = ListItemInteraction.create(SITE_SETTINGS, onClick)</span>
            )
<span class="nc" id="L195">        } else null</span>
    }

    private fun shouldShowWPAdmin(site: SiteModel): Boolean {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        return if (!site.isWPCom) {</span>
<span class="nc" id="L200">            true</span>
        } else {
<span class="nc" id="L202">            val dateCreated = DateTimeUtils.dateFromIso8601(</span>
<span class="nc" id="L203">                    accountStore.account</span>
<span class="nc" id="L204">                            .date</span>
            )
<span class="nc" id="L206">            val calendar = GregorianCalendar(HIDE_WP_ADMIN_YEAR, HIDE_WP_ADMIN_MONTH, HIDE_WP_ADMIN_DAY)</span>
<span class="nc" id="L207">            calendar.timeZone = TimeZone.getTimeZone(MySiteViewModel.HIDE_WP_ADMIN_GMT_TIME_ZONE)</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">            dateCreated == null || dateCreated.before(calendar.time)</span>
        }
    }

    fun buildThemesItemIfAvailable(site: SiteModel, onClick: (ListItemAction) -&gt; Unit): MySiteCardAndItem? {
<span class="nc bnc" id="L213" title="All 2 branches missed.">        return if (themeBrowserUtils.isAccessible(site)) {</span>
<span class="nc" id="L214">            ListItem(</span>
<span class="nc" id="L215">                    R.drawable.ic_themes_white_24dp,</span>
<span class="nc" id="L216">                    UiStringRes(R.string.themes),</span>
<span class="nc" id="L217">                    onClick = ListItemInteraction.create(THEMES, onClick)</span>
            )
<span class="nc" id="L219">        } else null</span>
    }

    companion object {
        const val HIDE_WP_ADMIN_YEAR = 2015
        const val HIDE_WP_ADMIN_MONTH = 9
        const val HIDE_WP_ADMIN_DAY = 7
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>