<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SubfilterPageFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.subfilter</a> &gt; <span class="el_source">SubfilterPageFragment.kt</span></div><h1>SubfilterPageFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.subfilter

import android.content.Context
import android.os.Bundle
import android.os.Parcel
import android.os.Parcelable
import android.os.Parcelable.Creator
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Button
import android.widget.LinearLayout
import androidx.annotation.StringRes
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentManager
import androidx.fragment.app.FragmentPagerAdapter
import androidx.lifecycle.Observer
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.ViewModelStoreOwner
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import dagger.android.support.DaggerFragment
import org.wordpress.android.R
import org.wordpress.android.ui.reader.subfilter.SubfilterBottomSheetEmptyUiState.HiddenEmptyUiState
import org.wordpress.android.ui.reader.subfilter.SubfilterBottomSheetEmptyUiState.VisibleEmptyUiState
import org.wordpress.android.ui.reader.subfilter.SubfilterListItem.ItemType
import org.wordpress.android.ui.reader.subfilter.SubfilterListItem.ItemType.SITE
import org.wordpress.android.ui.reader.subfilter.SubfilterListItem.ItemType.TAG
import org.wordpress.android.ui.reader.subfilter.SubfilterListItem.Site
import org.wordpress.android.ui.reader.subfilter.SubfilterListItem.Tag
import org.wordpress.android.ui.reader.subfilter.adapters.SubfilterListAdapter
import org.wordpress.android.ui.reader.viewmodels.SubfilterPageViewModel
import org.wordpress.android.ui.stats.refresh.utils.StatsUtils
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.config.SeenUnseenWithCounterFeatureConfig
import org.wordpress.android.widgets.WPTextView
import java.lang.ref.WeakReference
import javax.inject.Inject

<span class="nc" id="L40">class SubfilterPageFragment : DaggerFragment() {</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">    @Inject lateinit var seenUnseenWithCounterFeatureConfig: SeenUnseenWithCounterFeatureConfig</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">    @Inject lateinit var statsUtils: StatsUtils</span>

    private lateinit var subFilterViewModel: SubFilterViewModel
    private lateinit var viewModel: SubfilterPageViewModel
    private lateinit var recyclerView: RecyclerView
    private lateinit var emptyStateContainer: LinearLayout
    private lateinit var title: WPTextView
    private lateinit var actionButton: Button

    companion object {
        const val CATEGORY_KEY = &quot;category_key&quot;
        const val SUBFILTER_VIEW_MODEL_KEY = &quot;subfilter_view_model_key&quot;

        fun newInstance(category: SubfilterCategory, subfilterViewModelKey: String): SubfilterPageFragment {
<span class="nc" id="L58">            val fragment = SubfilterPageFragment()</span>
<span class="nc" id="L59">            val bundle = Bundle()</span>
<span class="nc" id="L60">            bundle.putSerializable(CATEGORY_KEY, category)</span>
<span class="nc" id="L61">            bundle.putString(SUBFILTER_VIEW_MODEL_KEY, subfilterViewModelKey)</span>
<span class="nc" id="L62">            fragment.arguments = bundle</span>
<span class="nc" id="L63">            return fragment</span>
        }
    }

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
<span class="nc" id="L68">        return inflater.inflate(R.layout.subfilter_page_fragment, container, false)</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L72">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">        val category = requireArguments().getSerializable(CATEGORY_KEY) as SubfilterCategory</span>
<span class="nc" id="L75">        val subfilterVmKey = requireArguments().getString(SUBFILTER_VIEW_MODEL_KEY)!!</span>

<span class="nc" id="L77">        viewModel = ViewModelProvider(this, viewModelFactory).get(SubfilterPageViewModel::class.java)</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        viewModel.start(category)</span>

<span class="nc" id="L80">        recyclerView = view.findViewById(R.id.content_recycler_view)</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        recyclerView.layoutManager = LinearLayoutManager(requireActivity())</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        recyclerView.adapter = SubfilterListAdapter(uiHelpers, statsUtils, seenUnseenWithCounterFeatureConfig)</span>

<span class="nc" id="L84">        emptyStateContainer = view.findViewById(R.id.empty_state_container)</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        title = emptyStateContainer.findViewById(R.id.title)</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        actionButton = emptyStateContainer.findViewById(R.id.action_button)</span>

<span class="nc" id="L88">        subFilterViewModel = ViewModelProvider(</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                requireParentFragment().parentFragment as ViewModelStoreOwner,</span>
<span class="nc" id="L90">                viewModelFactory</span>
<span class="nc" id="L91">        ).get(subfilterVmKey, SubFilterViewModel::class.java)</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        subFilterViewModel.subFilters.observe(viewLifecycleOwner, Observer {</span>
<span class="nc bnc" id="L94" title="All 6 branches missed.">            (recyclerView.adapter as? SubfilterListAdapter)?.let { adapter -&gt;</span>
<span class="nc bnc" id="L95" title="All 8 branches missed.">                var items = it?.filter { it.type == category.type } ?: listOf()</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">                val currentFilter = subFilterViewModel.getCurrentSubfilterValue()</span>

<span class="nc bnc" id="L99" title="All 8 branches missed.">                if (items.isNotEmpty() &amp;&amp; (currentFilter is Site || currentFilter is Tag)) {</span>
<span class="nc" id="L100">                    items = items.map {</span>
<span class="nc" id="L101">                        it.isSelected = it.isSameItem(currentFilter)</span>
<span class="nc" id="L102">                        it</span>
                    }
                }

<span class="nc bnc" id="L106" title="All 2 branches missed.">                viewModel.onSubFiltersChanged(items.isEmpty())</span>
<span class="nc" id="L107">                adapter.update(items)</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                subFilterViewModel.onSubfilterPageUpdated(category, items.size)</span>
<span class="nc" id="L109">            }</span>
<span class="nc" id="L110">        })</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">        viewModel.emptyState.observe(viewLifecycleOwner, Observer { uiState -&gt;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (isAdded) {</span>
<span class="nc" id="L114">                when (uiState) {</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">                    HiddenEmptyUiState -&gt; emptyStateContainer.visibility = View.GONE</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                    is VisibleEmptyUiState -&gt; {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                        emptyStateContainer.visibility = View.VISIBLE</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                        title.setText(uiState.title.stringRes)</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                        actionButton.setText(uiState.buttonText.stringRes)</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                        actionButton.setOnClickListener {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                            subFilterViewModel.onBottomSheetActionClicked(uiState.action)</span>
<span class="nc" id="L122">                        }</span>
                    }
                }
            }
<span class="nc" id="L126">        })</span>
<span class="nc" id="L127">    }</span>

    fun setNestedScrollBehavior(enable: Boolean) {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!isAdded) return</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">        recyclerView.isNestedScrollingEnabled = enable</span>
<span class="nc" id="L133">    }</span>
}

<span class="nc" id="L136">class SubfilterPagerAdapter(</span>
<span class="nc" id="L137">    val context: Context,</span>
<span class="nc" id="L138">    val fm: FragmentManager,</span>
<span class="nc" id="L139">    val subfilterViewModelKey: String,</span>
    categories: List&lt;SubfilterCategory&gt;
<span class="nc" id="L141">) : FragmentPagerAdapter(fm) {</span>
<span class="nc" id="L142">    private val filterCategory = categories</span>
<span class="nc" id="L143">    private val fragments = mutableMapOf&lt;SubfilterCategory, WeakReference&lt;SubfilterPageFragment&gt;&gt;()</span>

<span class="nc" id="L145">    override fun getCount(): Int = filterCategory.size</span>

    override fun getItem(position: Int): Fragment {
<span class="nc" id="L148">        val fragment = SubfilterPageFragment.newInstance(filterCategory[position], subfilterViewModelKey)</span>
<span class="nc" id="L149">        fragments[filterCategory[position]] = WeakReference(fragment)</span>
<span class="nc" id="L150">        return fragment</span>
    }

    override fun getPageTitle(position: Int): CharSequence? {
<span class="nc" id="L154">        return context.getString(filterCategory[position].titleRes)</span>
    }

    override fun setPrimaryItem(container: ViewGroup, position: Int, `object`: Any) {
<span class="nc" id="L158">        super.setPrimaryItem(container, position, `object`)</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">        for (i in 0 until fragments.size) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            val fragment = fragments[filterCategory[i]]?.get()</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">            fragment?.setNestedScrollBehavior(i == position)</span>
        }
<span class="nc" id="L163">        container.requestLayout()</span>
<span class="nc" id="L164">    }</span>
}

<span class="nc" id="L167">enum class SubfilterCategory(@StringRes val titleRes: Int, val type: ItemType) : Parcelable {</span>
<span class="nc" id="L168">    SITES(R.string.reader_filter_sites_title, SITE),</span>
<span class="nc" id="L169">    TAGS(R.string.reader_filter_tags_title, TAG);</span>

    override fun writeToParcel(parcel: Parcel, flags: Int) {
<span class="nc" id="L172">        parcel.writeInt(type.ordinal)</span>
<span class="nc" id="L173">    }</span>

    override fun describeContents(): Int {
<span class="nc" id="L176">        return 0</span>
    }

    companion object CREATOR : Creator&lt;SubfilterCategory&gt; {
        override fun createFromParcel(parcel: Parcel): SubfilterCategory {
<span class="nc" id="L181">            return values()[parcel.readInt()]</span>
        }

        override fun newArray(size: Int): Array&lt;SubfilterCategory?&gt; {
<span class="nc" id="L185">            return arrayOfNulls(size)</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>