<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuickStartFullScreenDialogFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.quickstart</a> &gt; <span class="el_source">QuickStartFullScreenDialogFragment.kt</span></div><h1>QuickStartFullScreenDialogFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.quickstart

import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.fragment.app.Fragment
import androidx.recyclerview.widget.DefaultItemAnimator
import androidx.recyclerview.widget.LinearLayoutManager
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.QuickStartDialogFragmentBinding
import org.wordpress.android.fluxc.store.QuickStartStore
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartNewSiteTask.CREATE_SITE
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTask
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTaskType
import org.wordpress.android.fluxc.store.QuickStartStore.QuickStartTaskType.UNKNOWN
import org.wordpress.android.ui.FullScreenDialogFragment.FullScreenDialogContent
import org.wordpress.android.ui.FullScreenDialogFragment.FullScreenDialogController
import org.wordpress.android.ui.mysite.SelectedSiteRepository
import org.wordpress.android.ui.mysite.cards.quickstart.QuickStartCardBuilder
import org.wordpress.android.ui.quickstart.QuickStartFullScreenDialogFragment.QuickStartListCard.QuickStartHeaderCard
import org.wordpress.android.ui.quickstart.QuickStartFullScreenDialogFragment.QuickStartListCard.QuickStartTaskCard
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.ui.utils.UiString
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.util.DisplayUtilsWrapper
import org.wordpress.android.util.QuickStartUtils.getQuickStartListSkippedTracker
import org.wordpress.android.util.QuickStartUtils.getQuickStartListTappedTracker
import org.wordpress.android.widgets.WPSnackbar.Companion.make
import java.io.Serializable
import javax.inject.Inject

@Suppress(&quot;TooManyFunctions&quot;)
<span class="nc" id="L36">class QuickStartFullScreenDialogFragment : Fragment(R.layout.quick_start_dialog_fragment),</span>
        FullScreenDialogContent {
    private var dialogController: FullScreenDialogController? = null
<span class="nc" id="L39">    private var tasksType: QuickStartTaskType = QuickStartTaskType.CUSTOMIZE</span>
    private lateinit var quickStartAdapter: QuickStartAdapter

<span class="nc bnc" id="L42" title="All 2 branches missed.">    @Inject lateinit var quickStartTracker: QuickStartTracker</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">    @Inject lateinit var quickStartStore: QuickStartStore</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">    @Inject lateinit var selectedSiteRepository: SelectedSiteRepository</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">    @Inject lateinit var quickStartCardBuilder: QuickStartCardBuilder</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">    @Inject lateinit var displayUtilsWrapper: DisplayUtilsWrapper</span>

    private var _binding: QuickStartDialogFragmentBinding? = null
<span class="nc" id="L50">    private val binding get() = _binding!!</span>

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L53">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc" id="L55">    }</span>

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
<span class="nc" id="L62">        _binding = QuickStartDialogFragmentBinding.inflate(inflater, container, false)</span>
<span class="nc" id="L63">        return binding.root</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc bnc" id="L67" title="All 4 branches missed.">        tasksType = arguments?.getSerializable(EXTRA_TYPE) as QuickStartTaskType? ?: QuickStartTaskType.UNKNOWN</span>
<span class="nc" id="L68">        quickStartTracker.trackQuickStartListViewed(tasksType)</span>
<span class="nc" id="L69">        binding.setupQuickStartList()</span>
<span class="nc" id="L70">    }</span>

    private fun QuickStartDialogFragmentBinding.setupQuickStartList() {
<span class="nc" id="L73">        quickStartAdapter = QuickStartAdapter(uiHelpers)</span>
<span class="nc" id="L74">        list.layoutManager = LinearLayoutManager(requireContext())</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        list.adapter = quickStartAdapter</span>
        // Disable default change animations to avoid blinking effect when adapter data is changed.
<span class="nc bnc" id="L77" title="All 2 branches missed.">        (list.itemAnimator as DefaultItemAnimator?)?.supportsChangeAnimations = false</span>
<span class="nc" id="L78">        updateQuickStartList()</span>
<span class="nc" id="L79">    }</span>

    private fun updateQuickStartList() {
<span class="nc" id="L82">        val quickStartList = mutableListOf&lt;QuickStartListCard&gt;().apply {</span>
<span class="nc" id="L83">            add(buildHeaderCard())</span>
<span class="nc" id="L84">            addAll(buildTaskCards())</span>
<span class="nc" id="L85">        }.toList()</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        quickStartAdapter.submitList(quickStartList)</span>
<span class="nc" id="L87">    }</span>

    override fun setController(controller: FullScreenDialogController) {
<span class="nc" id="L90">        dialogController = controller</span>
<span class="nc" id="L91">    }</span>

    override fun onConfirmClicked(controller: FullScreenDialogController): Boolean {
<span class="nc" id="L94">        return true</span>
    }

    override fun onDismissClicked(controller: FullScreenDialogController): Boolean {
<span class="nc" id="L98">        quickStartTracker.trackQuickStartListDismissed(tasksType)</span>
<span class="nc" id="L99">        controller.dismiss()</span>
<span class="nc" id="L100">        return true</span>
    }

    private fun onTaskTapped(task: QuickStartTask) {
<span class="nc" id="L104">        quickStartTracker.track(getQuickStartListTappedTracker(task))</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (!showSnackbarIfNeeded(task)) {</span>
<span class="nc" id="L106">            val result = Bundle()</span>
<span class="nc" id="L107">            result.putSerializable(RESULT_TASK, task as Serializable?)</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            dialogController?.confirm(result)</span>
        }
<span class="nc" id="L110">    }</span>

    private fun onSkipTaskTapped(task: QuickStartTask) {
<span class="nc" id="L113">        quickStartTracker.track(getQuickStartListSkippedTracker(task))</span>
<span class="nc" id="L114">        val selectedSiteLocalId = selectedSiteRepository.getSelectedSiteLocalId().toLong()</span>
<span class="nc" id="L115">        quickStartStore.setDoneTask(selectedSiteLocalId, task, true)</span>
<span class="nc" id="L116">        updateQuickStartList()</span>
<span class="nc" id="L117">    }</span>

    private fun showSnackbarIfNeeded(task: QuickStartTask?): Boolean {
<span class="nc bnc" id="L120" title="All 2 branches missed.">        return if (task === CREATE_SITE) {</span>
<span class="nc" id="L121">            make(</span>
<span class="nc" id="L122">                    requireView(),</span>
<span class="nc" id="L123">                    R.string.quick_start_list_create_site_message,</span>
<span class="nc" id="L124">                    Snackbar.LENGTH_LONG</span>
<span class="nc" id="L125">            ).show()</span>
<span class="nc" id="L126">            true</span>
        } else {
<span class="nc" id="L128">            false</span>
        }
    }

    override fun onDestroyView() {
<span class="nc" id="L133">        super.onDestroyView()</span>
<span class="nc" id="L134">        _binding = null</span>
<span class="nc" id="L135">    }</span>

<span class="nc" id="L137">    private fun buildHeaderCard() = QuickStartHeaderCard(</span>
<span class="nc" id="L138">            title = UiStringRes(quickStartCardBuilder.getTitle(tasksType)),</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            shouldShowHeaderImage = !displayUtilsWrapper.isPhoneLandscape()</span>
<span class="nc" id="L140">    )</span>

    private fun buildTaskCards(): List&lt;QuickStartTaskCard&gt; {
<span class="nc bnc" id="L143" title="All 4 branches missed.">        val tasks = QuickStartTask.getTasksByTaskType(tasksType).filterNot { it.taskType == UNKNOWN }</span>
<span class="nc" id="L144">        val selectedSiteLocalId = selectedSiteRepository.getSelectedSiteLocalId().toLong()</span>
<span class="nc" id="L145">        val tasksCompleted = quickStartStore.getCompletedTasksByType(selectedSiteLocalId, tasksType)</span>
<span class="nc" id="L146">        return tasks.mapToQuickStartTaskCard(tasksCompleted)</span>
    }

<span class="nc" id="L149">    private fun List&lt;QuickStartTask&gt;.mapToQuickStartTaskCard(tasksCompleted: List&lt;QuickStartTask&gt;) = this.map {</span>
<span class="nc" id="L150">        QuickStartTaskCard(</span>
<span class="nc" id="L151">                task = it,</span>
<span class="nc" id="L152">                isCompleted = tasksCompleted.contains(it),</span>
<span class="nc" id="L153">                onTaskTapped = this@QuickStartFullScreenDialogFragment::onTaskTapped,</span>
<span class="nc" id="L154">                onSkipTaskTapped = this@QuickStartFullScreenDialogFragment::onSkipTaskTapped</span>
        )
<span class="nc" id="L156">    }</span>

    sealed class QuickStartListCard {
<span class="nc" id="L159">        data class QuickStartHeaderCard(</span>
<span class="nc" id="L160">            val title: UiString,</span>
<span class="nc" id="L161">            val shouldShowHeaderImage: Boolean</span>
<span class="nc" id="L162">        ) : QuickStartListCard()</span>

<span class="nc" id="L164">        data class QuickStartTaskCard(</span>
<span class="nc" id="L165">            val task: QuickStartTask,</span>
<span class="nc" id="L166">            val isCompleted: Boolean,</span>
<span class="nc" id="L167">            val onTaskTapped: (task: QuickStartTask) -&gt; Unit,</span>
<span class="nc" id="L168">            val onSkipTaskTapped: (task: QuickStartTask) -&gt; Unit</span>
<span class="nc" id="L169">        ) : QuickStartListCard()</span>
    }

    companion object {
        const val EXTRA_TYPE = &quot;EXTRA_TYPE&quot;
        const val RESULT_TASK = &quot;RESULT_TASK&quot;
        fun newBundle(type: QuickStartTaskType?): Bundle {
<span class="nc" id="L176">            val bundle = Bundle()</span>
<span class="nc" id="L177">            bundle.putSerializable(EXTRA_TYPE, type)</span>
<span class="nc" id="L178">            return bundle</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>