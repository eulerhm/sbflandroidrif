<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PeopleUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.people.utils</a> &gt; <span class="el_source">PeopleUtils.java</span></div><h1>PeopleUtils.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.people.utils;

import com.android.volley.VolleyError;
import com.wordpress.rest.RestRequest;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.wordpress.android.WordPress;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.models.Person;
import org.wordpress.android.ui.people.utils.PeopleUtils.ValidateUsernameCallback.ValidationResult;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

<span class="nc" id="L24">public class PeopleUtils {</span>
    // We limit followers we display to 1000 to avoid API performance issues
    public static final int FOLLOWER_PAGE_LIMIT = 50;
    public static final int FETCH_LIMIT = 20;

    public static void fetchUsers(final SiteModel site, final int offset, final FetchUsersCallback callback) {
<span class="nc" id="L30">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L33" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
                    try {
<span class="nc" id="L35">                        JSONArray jsonArray = jsonObject.getJSONArray(&quot;users&quot;);</span>
<span class="nc" id="L36">                        List&lt;Person&gt; people = peopleListFromJSON(jsonArray, site.getId(), Person.PersonType.USER);</span>
<span class="nc" id="L37">                        int numberOfUsers = jsonObject.optInt(&quot;found&quot;);</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">                        boolean isEndOfList = (people.size() + offset) &gt;= numberOfUsers;</span>
<span class="nc" id="L39">                        callback.onSuccess(people, isEndOfList);</span>
<span class="nc" id="L40">                    } catch (JSONException e) {</span>
<span class="nc" id="L41">                        AppLog.e(T.API, &quot;JSON exception occurred while parsing the response for sites/%s/users: &quot; + e);</span>
<span class="nc" id="L42">                        callback.onError();</span>
<span class="nc" id="L43">                    }</span>
                }
<span class="nc" id="L45">            }</span>
        };

<span class="nc" id="L48">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L51">                AppLog.e(T.API, volleyError);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L53">                    callback.onError();</span>
                }
<span class="nc" id="L55">            }</span>
        };

<span class="nc" id="L58">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L59">        params.put(&quot;number&quot;, Integer.toString(PeopleUtils.FETCH_LIMIT));</span>
<span class="nc" id="L60">        params.put(&quot;offset&quot;, Integer.toString(offset));</span>
<span class="nc" id="L61">        params.put(&quot;order_by&quot;, &quot;display_name&quot;);</span>
<span class="nc" id="L62">        params.put(&quot;order&quot;, &quot;ASC&quot;);</span>
<span class="nc" id="L63">        String path = String.format(Locale.US, &quot;sites/%d/users&quot;, site.getSiteId());</span>
<span class="nc" id="L64">        WordPress.getRestClientUtilsV1_1().get(path, params, null, listener, errorListener);</span>
<span class="nc" id="L65">    }</span>

    public static void fetchRevisionAuthorsDetails(final SiteModel site, List&lt;String&gt; authors,
                                                   final FetchUsersCallback callback) {
<span class="nc" id="L69">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L72" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
                    try {
<span class="nc" id="L74">                        List&lt;Person&gt; people = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L76">                        Iterator&lt;String&gt; keys = jsonObject.keys();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">                        while (keys.hasNext()) {</span>
<span class="nc" id="L78">                            String key = keys.next();</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                            if (jsonObject.get(key) instanceof JSONObject) {</span>
<span class="nc" id="L80">                                JSONArray jsonArray = ((JSONObject) jsonObject.get(key)).getJSONArray(&quot;users&quot;);</span>
<span class="nc" id="L81">                                people.addAll(peopleListFromJSON(jsonArray, site.getId(), Person.PersonType.USER));</span>
                            }
<span class="nc" id="L83">                        }</span>

<span class="nc" id="L85">                        callback.onSuccess(people, true);</span>
<span class="nc" id="L86">                    } catch (JSONException e) {</span>
<span class="nc" id="L87">                        AppLog.e(T.API, &quot;JSON exception occurred while parsing the revision author details&quot;</span>
                                        + &quot; from batch response for sites/%s/users: &quot; + e);
<span class="nc" id="L89">                        callback.onError();</span>
<span class="nc" id="L90">                    }</span>
                }
<span class="nc" id="L92">            }</span>
        };

<span class="nc" id="L95">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L98">                AppLog.e(T.API, volleyError);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L100">                    callback.onError();</span>
                }
<span class="nc" id="L102">            }</span>
        };

<span class="nc" id="L105">        Map&lt;String, String&gt; batchParams = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        for (int i = 0; i &lt; authors.size(); i++) {</span>
<span class="nc" id="L108">            batchParams.put(String.format(Locale.US, &quot;urls[%d]&quot;, i),</span>
<span class="nc" id="L109">                    String.format(Locale.US, &quot;/sites/%d/users?search=%s&amp;search_columns=ID&quot;,</span>
<span class="nc" id="L110">                            site.getSiteId(), authors.get(i)));</span>
        }

<span class="nc" id="L113">        WordPress.getRestClientUtilsV1_1().get(&quot;batch/&quot;, batchParams, null, listener, errorListener);</span>
<span class="nc" id="L114">    }</span>

    public static void fetchFollowers(final SiteModel site, final int page, final FetchFollowersCallback callback) {
<span class="nc" id="L117">        fetchFollowers(site, page, callback, false);</span>
<span class="nc" id="L118">    }</span>

    public static void fetchEmailFollowers(final SiteModel site, final int page,
                                           final FetchFollowersCallback callback) {
<span class="nc" id="L122">        fetchFollowers(site, page, callback, true);</span>
<span class="nc" id="L123">    }</span>

    private static void fetchFollowers(final SiteModel site, final int page, final FetchFollowersCallback callback,
                                       final boolean isEmailFollower) {
<span class="nc" id="L127">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L130" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
                    try {
<span class="nc" id="L132">                        JSONArray jsonArray = jsonObject.getJSONArray(&quot;subscribers&quot;);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                        Person.PersonType personType = isEmailFollower</span>
<span class="nc" id="L134">                                ? Person.PersonType.EMAIL_FOLLOWER : Person.PersonType.FOLLOWER;</span>
<span class="nc" id="L135">                        List&lt;Person&gt; people = peopleListFromJSON(jsonArray, site.getId(), personType);</span>
<span class="nc" id="L136">                        int pageFetched = jsonObject.optInt(&quot;page&quot;);</span>
<span class="nc" id="L137">                        int numberOfPages = jsonObject.optInt(&quot;pages&quot;);</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">                        boolean isEndOfList = page &gt;= numberOfPages || page &gt;= FOLLOWER_PAGE_LIMIT;</span>
<span class="nc" id="L139">                        callback.onSuccess(people, pageFetched, isEndOfList);</span>
<span class="nc" id="L140">                    } catch (JSONException e) {</span>
<span class="nc" id="L141">                        AppLog.e(T.API, &quot;JSON exception occurred while parsing the response for &quot;</span>
                                        + &quot;sites/%s/stats/followers: &quot; + e);
<span class="nc" id="L143">                        callback.onError();</span>
<span class="nc" id="L144">                    }</span>
                }
<span class="nc" id="L146">            }</span>
        };

<span class="nc" id="L149">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L152">                AppLog.e(T.API, volleyError);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L154">                    callback.onError();</span>
                }
<span class="nc" id="L156">            }</span>
        };

<span class="nc" id="L159">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L160">        params.put(&quot;max&quot;, Integer.toString(FETCH_LIMIT));</span>
<span class="nc" id="L161">        params.put(&quot;page&quot;, Integer.toString(page));</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        params.put(&quot;type&quot;, isEmailFollower ? &quot;email&quot; : &quot;wp_com&quot;);</span>
<span class="nc" id="L163">        String path = String.format(Locale.US, &quot;sites/%d/stats/followers&quot;, site.getSiteId());</span>
<span class="nc" id="L164">        WordPress.getRestClientUtilsV1_1().get(path, params, null, listener, errorListener);</span>
<span class="nc" id="L165">    }</span>

    public static void fetchViewers(final SiteModel site, final int offset, final FetchViewersCallback callback) {
<span class="nc" id="L168">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L171" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
                    try {
<span class="nc" id="L173">                        JSONArray jsonArray = jsonObject.getJSONArray(&quot;viewers&quot;);</span>
<span class="nc" id="L174">                        List&lt;Person&gt; people = peopleListFromJSON(jsonArray, site.getId(), Person.PersonType.VIEWER);</span>
<span class="nc" id="L175">                        int numberOfUsers = jsonObject.optInt(&quot;found&quot;);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                        boolean isEndOfList = (people.size() + offset) &gt;= numberOfUsers;</span>
<span class="nc" id="L177">                        callback.onSuccess(people, isEndOfList);</span>
<span class="nc" id="L178">                    } catch (JSONException e) {</span>
<span class="nc" id="L179">                        AppLog.e(T.API, &quot;JSON exception occurred while parsing the response for &quot;</span>
                                        + &quot;sites/%s/viewers: &quot; + e);
<span class="nc" id="L181">                        callback.onError();</span>
<span class="nc" id="L182">                    }</span>
                }
<span class="nc" id="L184">            }</span>
        };

<span class="nc" id="L187">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L190">                AppLog.e(T.API, volleyError);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L192">                    callback.onError();</span>
                }
<span class="nc" id="L194">            }</span>
        };

<span class="nc" id="L197">        int page = (offset / FETCH_LIMIT) + 1;</span>
<span class="nc" id="L198">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L199">        params.put(&quot;number&quot;, Integer.toString(FETCH_LIMIT));</span>
<span class="nc" id="L200">        params.put(&quot;page&quot;, Integer.toString(page));</span>
<span class="nc" id="L201">        String path = String.format(Locale.US, &quot;sites/%d/viewers&quot;, site.getSiteId());</span>
<span class="nc" id="L202">        WordPress.getRestClientUtilsV1_1().get(path, params, null, listener, errorListener);</span>
<span class="nc" id="L203">    }</span>

    public static void updateRole(final SiteModel site, long personID, String newRole, final int localTableBlogId,
                                  final UpdateUserCallback callback) {
<span class="nc" id="L207">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L210" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
                    try {
<span class="nc" id="L212">                        Person person = Person.userFromJSON(jsonObject, localTableBlogId);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                        if (person != null) {</span>
<span class="nc" id="L214">                            callback.onSuccess(person);</span>
                        } else {
<span class="nc" id="L216">                            AppLog.e(T.API, &quot;Couldn't map jsonObject + &quot; + jsonObject + &quot; to person model.&quot;);</span>
<span class="nc" id="L217">                            callback.onError();</span>
                        }
<span class="nc" id="L219">                    } catch (JSONException e) {</span>
<span class="nc" id="L220">                        callback.onError();</span>
<span class="nc" id="L221">                    }</span>
                }
<span class="nc" id="L223">            }</span>
        };

<span class="nc" id="L226">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L229">                AppLog.e(T.API, volleyError);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L231">                    callback.onError();</span>
                }
<span class="nc" id="L233">            }</span>
        };

<span class="nc" id="L236">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L237">        params.put(&quot;roles&quot;, newRole);</span>
<span class="nc" id="L238">        String path = String.format(Locale.US, &quot;sites/%d/users/%d&quot;, site.getSiteId(), personID);</span>
<span class="nc" id="L239">        WordPress.getRestClientUtilsV1_1().post(path, params, null, listener, errorListener);</span>
<span class="nc" id="L240">    }</span>

    public static void removeUser(final SiteModel site, final long personID, final RemovePersonCallback callback) {
<span class="nc" id="L243">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L246" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
                    // check if the call was successful
<span class="nc" id="L248">                    boolean success = jsonObject.optBoolean(&quot;success&quot;);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                    if (success) {</span>
<span class="nc" id="L250">                        callback.onSuccess(personID, site.getId());</span>
                    } else {
<span class="nc" id="L252">                        callback.onError();</span>
                    }
                }
<span class="nc" id="L255">            }</span>
        };

<span class="nc" id="L258">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L261">                AppLog.e(T.API, volleyError);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L263">                    callback.onError();</span>
                }
<span class="nc" id="L265">            }</span>
        };

<span class="nc" id="L268">        String path = String.format(Locale.US, &quot;sites/%d/users/%d/delete&quot;, site.getSiteId(), personID);</span>
<span class="nc" id="L269">        WordPress.getRestClientUtilsV1_1().post(path, listener, errorListener);</span>
<span class="nc" id="L270">    }</span>

    public static void removeFollower(final SiteModel site, final long personID,
                                      Person.PersonType personType, final RemovePersonCallback callback) {
<span class="nc" id="L274">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L277" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
                    // check if the call was successful
<span class="nc" id="L279">                    boolean success = jsonObject.optBoolean(&quot;deleted&quot;);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">                    if (success) {</span>
<span class="nc" id="L281">                        callback.onSuccess(personID, site.getId());</span>
                    } else {
<span class="nc" id="L283">                        callback.onError();</span>
                    }
                }
<span class="nc" id="L286">            }</span>
        };

<span class="nc" id="L289">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L292">                AppLog.e(T.API, volleyError);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L294">                    callback.onError();</span>
                }
<span class="nc" id="L296">            }</span>
        };

        String path;
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (personType == Person.PersonType.EMAIL_FOLLOWER) {</span>
<span class="nc" id="L301">            path = String.format(Locale.US, &quot;sites/%d/email-followers/%d/delete&quot;, site.getSiteId(), personID);</span>
        } else {
<span class="nc" id="L303">            path = String.format(Locale.US, &quot;sites/%d/followers/%d/delete&quot;, site.getSiteId(), personID);</span>
        }
<span class="nc" id="L305">        WordPress.getRestClientUtilsV1_1().post(path, listener, errorListener);</span>
<span class="nc" id="L306">    }</span>

    public static void removeViewer(final SiteModel site, final long personID, final RemovePersonCallback callback) {
<span class="nc" id="L309">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L312" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
                    // check if the call was successful
<span class="nc" id="L314">                    boolean success = jsonObject.optBoolean(&quot;deleted&quot;);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                    if (success) {</span>
<span class="nc" id="L316">                        callback.onSuccess(personID, site.getId());</span>
                    } else {
<span class="nc" id="L318">                        callback.onError();</span>
                    }
                }
<span class="nc" id="L321">            }</span>
        };

<span class="nc" id="L324">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L327">                AppLog.e(T.API, volleyError);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L329">                    callback.onError();</span>
                }
<span class="nc" id="L331">            }</span>
        };

<span class="nc" id="L334">        String path = String.format(Locale.US, &quot;sites/%d/viewers/%d/delete&quot;, site.getSiteId(), personID);</span>
<span class="nc" id="L335">        WordPress.getRestClientUtilsV1_1().post(path, listener, errorListener);</span>
<span class="nc" id="L336">    }</span>

    private static List&lt;Person&gt; peopleListFromJSON(JSONArray jsonArray, int localTableBlogId,
                                                   Person.PersonType personType) throws JSONException {
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (jsonArray == null) {</span>
<span class="nc" id="L341">            return null;</span>
        }

<span class="nc" id="L344">        ArrayList&lt;Person&gt; peopleList = new ArrayList&lt;&gt;(jsonArray.length());</span>

<span class="nc bnc" id="L346" title="All 2 branches missed.">        for (int i = 0; i &lt; jsonArray.length(); i++) {</span>
            Person person;
<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (personType == Person.PersonType.USER) {</span>
<span class="nc" id="L349">                person = Person.userFromJSON(jsonArray.optJSONObject(i), localTableBlogId);</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            } else if (personType == Person.PersonType.VIEWER) {</span>
<span class="nc" id="L351">                person = Person.viewerFromJSON(jsonArray.optJSONObject(i), localTableBlogId);</span>
            } else {
<span class="nc bnc" id="L353" title="All 2 branches missed.">                boolean isEmailFollower = (personType == Person.PersonType.EMAIL_FOLLOWER);</span>
<span class="nc" id="L354">                person = Person.followerFromJSON(jsonArray.optJSONObject(i), localTableBlogId, isEmailFollower);</span>
            }
<span class="nc bnc" id="L356" title="All 2 branches missed.">            if (person != null) {</span>
<span class="nc" id="L357">                peopleList.add(person);</span>
            }
        }

<span class="nc" id="L361">        return peopleList;</span>
    }

    public interface FetchUsersCallback extends Callback {
        void onSuccess(List&lt;Person&gt; peopleList, boolean isEndOfList);
    }

    public interface FetchFollowersCallback extends Callback {
        void onSuccess(List&lt;Person&gt; peopleList, int pageFetched, boolean isEndOfList);
    }

    public interface FetchViewersCallback extends Callback {
        void onSuccess(List&lt;Person&gt; peopleList, boolean isEndOfList);
    }

    public interface RemovePersonCallback extends Callback {
        void onSuccess(long personID, int localTableBlogId);
    }

    public interface UpdateUserCallback extends Callback {
        void onSuccess(Person person);
    }

    public interface Callback {
        void onError();
    }

    public static void validateUsernames(final List&lt;String&gt; usernames, String role, long wpComBlogId, final
    ValidateUsernameCallback callback) {
<span class="nc" id="L390">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L393" title="All 4 branches missed.">                if (jsonObject != null &amp;&amp; callback != null) {</span>
<span class="nc" id="L394">                    JSONObject errors = jsonObject.optJSONObject(&quot;errors&quot;);</span>

<span class="nc" id="L396">                    int errorredUsernameCount = 0;</span>

<span class="nc bnc" id="L398" title="All 2 branches missed.">                    if (errors != null) {</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">                        for (String username : usernames) {</span>
<span class="nc" id="L400">                            JSONObject userError = errors.optJSONObject(username);</span>

<span class="nc bnc" id="L402" title="All 2 branches missed.">                            if (userError == null) {</span>
<span class="nc" id="L403">                                continue;</span>
                            }

<span class="nc" id="L406">                            errorredUsernameCount++;</span>

<span class="nc bnc" id="L408" title="All 5 branches missed.">                            switch (userError.optString(&quot;code&quot;)) {</span>
                                case &quot;invalid_input&quot;:
<span class="nc bnc" id="L410" title="All 2 branches missed.">                                    switch (userError.optString(&quot;message&quot;)) {</span>
                                        case &quot;Invalid email&quot;:
<span class="nc" id="L412">                                            callback.onUsernameValidation(username, ValidationResult.INVALID_EMAIL);</span>
<span class="nc" id="L413">                                            continue;</span>
                                        case &quot;User not found&quot;:
                                            // fall through to the default case
                                        default:
<span class="nc" id="L417">                                            callback.onUsernameValidation(username, ValidationResult.USER_NOT_FOUND);</span>
<span class="nc" id="L418">                                            continue;</span>
                                    }
                                case &quot;invalid_input_has_role&quot;:
<span class="nc" id="L421">                                    callback.onUsernameValidation(username, ValidationResult.ALREADY_MEMBER);</span>
<span class="nc" id="L422">                                    continue;</span>
                                case &quot;invalid_input_following&quot;:
<span class="nc" id="L424">                                    callback.onUsernameValidation(username, ValidationResult.ALREADY_FOLLOWING);</span>
<span class="nc" id="L425">                                    continue;</span>
                                case &quot;invalid_user_blocked_invites&quot;:
<span class="nc" id="L427">                                    callback.onUsernameValidation(username, ValidationResult.BLOCKED_INVITES);</span>
<span class="nc" id="L428">                                    continue;</span>
                            }

<span class="nc" id="L431">                            callback.onError();</span>
<span class="nc" id="L432">                            callback.onValidationFinished();</span>
<span class="nc" id="L433">                            return;</span>
                        }
                    }

<span class="nc" id="L437">                    JSONArray succeededUsernames = jsonObject.optJSONArray(&quot;success&quot;);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">                    if (succeededUsernames == null) {</span>
<span class="nc" id="L439">                        callback.onError();</span>
<span class="nc" id="L440">                        callback.onValidationFinished();</span>
<span class="nc" id="L441">                        return;</span>
                    }

<span class="nc" id="L444">                    int succeededUsernameCount = 0;</span>

<span class="nc bnc" id="L446" title="All 2 branches missed.">                    for (int i = 0; i &lt; succeededUsernames.length(); i++) {</span>
<span class="nc" id="L447">                        String username = succeededUsernames.optString(i);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                        if (usernames.contains(username)) {</span>
<span class="nc" id="L449">                            succeededUsernameCount++;</span>
<span class="nc" id="L450">                            callback.onUsernameValidation(username, ValidationResult.USER_FOUND);</span>
                        }
                    }

<span class="nc bnc" id="L454" title="All 2 branches missed.">                    if (errorredUsernameCount + succeededUsernameCount != usernames.size()) {</span>
<span class="nc" id="L455">                        callback.onError();</span>
<span class="nc" id="L456">                        callback.onValidationFinished();</span>
                    }

<span class="nc" id="L459">                    callback.onValidationFinished();</span>
                }
<span class="nc" id="L461">            }</span>
        };

<span class="nc" id="L464">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L467">                AppLog.e(AppLog.T.API, volleyError);</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L469">                    callback.onError();</span>
                }
<span class="nc" id="L471">            }</span>
        };

<span class="nc" id="L474">        String path = String.format(Locale.US, &quot;sites/%d/invites/validate&quot;, wpComBlogId);</span>
<span class="nc" id="L475">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">        for (String username : usernames) {</span>
<span class="nc" id="L477">            params.put(&quot;invitees[&quot; + username + &quot;]&quot;, username); // specify an array key so to make the map key unique</span>
<span class="nc" id="L478">        }</span>
<span class="nc" id="L479">        params.put(&quot;role&quot;, role);</span>
<span class="nc" id="L480">        WordPress.getRestClientUtilsV1_1().post(path, params, null, listener, errorListener);</span>
<span class="nc" id="L481">    }</span>

    public interface ValidateUsernameCallback {
<span class="nc" id="L484">        enum ValidationResult {</span>
<span class="nc" id="L485">            USER_NOT_FOUND,</span>
<span class="nc" id="L486">            ALREADY_MEMBER,</span>
<span class="nc" id="L487">            ALREADY_FOLLOWING,</span>
<span class="nc" id="L488">            BLOCKED_INVITES,</span>
<span class="nc" id="L489">            INVALID_EMAIL,</span>
<span class="nc" id="L490">            USER_FOUND</span>
        }

        void onUsernameValidation(String username, ValidationResult validationResult);

        void onValidationFinished();

        void onError();
    }

    public static void sendInvitations(final List&lt;String&gt; usernames, String role, String message, long wpComBlogId,
                                       final InvitationsSendCallback callback) {
<span class="nc" id="L502">        RestRequest.Listener listener = new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject jsonObject) {
<span class="nc bnc" id="L505" title="All 2 branches missed.">                if (callback == null) {</span>
<span class="nc" id="L506">                    return;</span>
                }

<span class="nc bnc" id="L509" title="All 2 branches missed.">                if (jsonObject == null) {</span>
<span class="nc" id="L510">                    callback.onError();</span>
<span class="nc" id="L511">                    return;</span>
                }

<span class="nc" id="L514">                Map&lt;String, String&gt; failedUsernames = new LinkedHashMap&lt;&gt;();</span>

<span class="nc" id="L516">                JSONObject errors = jsonObject.optJSONObject(&quot;errors&quot;);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">                if (errors != null) {</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                    for (String username : usernames) {</span>
<span class="nc" id="L519">                        JSONObject userError = errors.optJSONObject(username);</span>

<span class="nc bnc" id="L521" title="All 2 branches missed.">                        if (userError != null) {</span>
<span class="nc" id="L522">                            failedUsernames.put(username, userError.optString(&quot;message&quot;));</span>
                        }
<span class="nc" id="L524">                    }</span>
                }

<span class="nc" id="L527">                List&lt;String&gt; succeededUsernames = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L528">                JSONArray succeededUsernamesJson = jsonObject.optJSONArray(&quot;sent&quot;);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">                if (succeededUsernamesJson == null) {</span>
<span class="nc" id="L530">                    callback.onError();</span>
<span class="nc" id="L531">                    return;</span>
                }

<span class="nc bnc" id="L534" title="All 2 branches missed.">                for (int i = 0; i &lt; succeededUsernamesJson.length(); i++) {</span>
<span class="nc" id="L535">                    String username = succeededUsernamesJson.optString(i);</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                    if (usernames.contains(username)) {</span>
<span class="nc" id="L537">                        succeededUsernames.add(username);</span>
                    }
                }

<span class="nc bnc" id="L541" title="All 2 branches missed.">                if (failedUsernames.size() + succeededUsernames.size() != usernames.size()) {</span>
<span class="nc" id="L542">                    callback.onError();</span>
                }

<span class="nc" id="L545">                callback.onSent(succeededUsernames, failedUsernames);</span>
<span class="nc" id="L546">            }</span>
        };

<span class="nc" id="L549">        RestRequest.ErrorListener errorListener = new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError volleyError) {
<span class="nc" id="L552">                AppLog.e(AppLog.T.API, volleyError);</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">                if (callback != null) {</span>
<span class="nc" id="L554">                    callback.onError();</span>
                }
<span class="nc" id="L556">            }</span>
        };

<span class="nc" id="L559">        String path = String.format(Locale.US, &quot;sites/%s/invites/new&quot;, wpComBlogId);</span>
<span class="nc" id="L560">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">        for (String username : usernames) {</span>
<span class="nc" id="L562">            params.put(&quot;invitees[&quot; + username + &quot;]&quot;, username); // specify an array key so to make the map key unique</span>
<span class="nc" id="L563">        }</span>
<span class="nc" id="L564">        params.put(&quot;role&quot;, role);</span>
<span class="nc" id="L565">        params.put(&quot;message&quot;, message);</span>
<span class="nc" id="L566">        WordPress.getRestClientUtilsV1_1().post(path, params, null, listener, errorListener);</span>
<span class="nc" id="L567">    }</span>

    public interface InvitationsSendCallback {
        void onSent(List&lt;String&gt; succeededUsernames, Map&lt;String, String&gt; failedUsernameErrors);

        void onError();
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>