<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatsViewAllFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stats.refresh</a> &gt; <span class="el_source">StatsViewAllFragment.kt</span></div><h1>StatsViewAllFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stats.refresh

import android.os.Bundle
import android.os.Parcelable
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import androidx.fragment.app.FragmentActivity
import androidx.lifecycle.ViewModelProvider
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.appbar.AppBarLayout.LayoutParams
import com.google.android.material.snackbar.Snackbar
import com.google.android.material.tabs.TabLayout.OnTabSelectedListener
import com.google.android.material.tabs.TabLayout.Tab
import dagger.android.support.DaggerFragment
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.StatsViewAllFragmentBinding
import org.wordpress.android.fluxc.network.utils.StatsGranularity
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.stats.StatsViewType
import org.wordpress.android.ui.stats.refresh.lists.StatsBlock.EmptyBlock
import org.wordpress.android.ui.stats.refresh.lists.StatsBlock.Error
import org.wordpress.android.ui.stats.refresh.lists.StatsBlock.Loading
import org.wordpress.android.ui.stats.refresh.lists.StatsBlock.Success
import org.wordpress.android.ui.stats.refresh.lists.StatsBlock.Type
import org.wordpress.android.ui.stats.refresh.lists.StatsBlock.Type.LOADING
import org.wordpress.android.ui.stats.refresh.lists.sections.BlockListAdapter
import org.wordpress.android.ui.stats.refresh.lists.sections.BlockListItem
import org.wordpress.android.ui.stats.refresh.lists.sections.BlockListItem.TabsItem
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.SelectedDateProvider.SelectedDate
import org.wordpress.android.ui.stats.refresh.utils.StatsNavigator
import org.wordpress.android.ui.stats.refresh.utils.StatsSiteProvider
import org.wordpress.android.ui.stats.refresh.utils.drawDateSelector
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.WPSwipeToRefreshHelper
import org.wordpress.android.util.helpers.SwipeToRefreshHelper
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.widgets.WPSnackbar
import javax.inject.Inject

<span class="nc" id="L43">class StatsViewAllFragment : DaggerFragment(R.layout.stats_view_all_fragment) {</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">    @Inject lateinit var viewModelFactoryBuilder: StatsViewAllViewModelFactory.Builder</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">    @Inject lateinit var imageManager: ImageManager</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">    @Inject lateinit var navigator: StatsNavigator</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">    @Inject lateinit var statsSiteProvider: StatsSiteProvider</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
    private lateinit var viewModel: StatsViewAllViewModel
    private lateinit var swipeToRefreshHelper: SwipeToRefreshHelper
    private var binding: StatsViewAllFragmentBinding? = null

<span class="nc" id="L53">    private val listStateKey = &quot;list_state&quot;</span>

    companion object {
        const val SELECTED_TAB_KEY = &quot;selected_tab_key&quot;
        const val ARGS_VIEW_TYPE = &quot;ARGS_VIEW_TYPE&quot;
        const val ARGS_TIMEFRAME = &quot;ARGS_TIMEFRAME&quot;
        const val ARGS_SELECTED_DATE = &quot;ARGS_SELECTED_DATE&quot;
    }

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc bnc" id="L63" title="All 8 branches missed.">        binding?.statsListFragment?.recyclerView?.layoutManager?.let {</span>
<span class="nc" id="L64">            outState.putParcelable(listStateKey, it.onSaveInstanceState())</span>
<span class="nc" id="L65">        }</span>

<span class="nc bnc" id="L67" title="All 2 branches missed.">        val intent = activity?.intent</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (intent != null) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (intent.hasExtra(ARGS_VIEW_TYPE)) {</span>
<span class="nc" id="L70">                outState.putSerializable(</span>
<span class="nc" id="L71">                        ARGS_VIEW_TYPE,</span>
<span class="nc" id="L72">                        intent.getSerializableExtra(ARGS_VIEW_TYPE)</span>
                )
            }
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (intent.hasExtra(ARGS_TIMEFRAME)) {</span>
<span class="nc" id="L76">                outState.putSerializable(</span>
<span class="nc" id="L77">                        ARGS_TIMEFRAME,</span>
<span class="nc" id="L78">                        intent.getSerializableExtra(ARGS_TIMEFRAME)</span>
                )
            }
<span class="nc" id="L81">            outState.putInt(WordPress.LOCAL_SITE_ID, intent.getIntExtra(WordPress.LOCAL_SITE_ID, 0))</span>
        }
<span class="nc bnc" id="L83" title="All 2 branches missed.">        outState.putParcelable(ARGS_SELECTED_DATE, viewModel.getSelectedDate())</span>
<span class="nc" id="L84">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L85">    }</span>

    private fun StatsViewAllFragmentBinding.initializeViews(savedInstanceState: Bundle?) {
<span class="nc" id="L88">        val layoutManager = LinearLayoutManager(activity, RecyclerView.VERTICAL, false)</span>

<span class="nc bnc" id="L90" title="All 4 branches missed.">        savedInstanceState?.getParcelable&lt;Parcelable&gt;(listStateKey)?.let {</span>
<span class="nc" id="L91">            layoutManager.onRestoreInstanceState(it)</span>
<span class="nc" id="L92">        }</span>
<span class="nc" id="L93">        with(statsListFragment) {</span>
<span class="nc" id="L94">            recyclerView.layoutManager = layoutManager</span>
<span class="nc" id="L95">            loadingRecyclerView.layoutManager = LinearLayoutManager(activity, RecyclerView.VERTICAL, false)</span>
<span class="nc" id="L96">        }</span>

<span class="nc" id="L98">        swipeToRefreshHelper = WPSwipeToRefreshHelper.buildSwipeToRefreshHelper(pullToRefresh) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            viewModel.onPullToRefresh()</span>
<span class="nc" id="L100">        }</span>

<span class="nc" id="L102">        with(statsListFragment.dateSelector) {</span>
<span class="nc" id="L103">            nextDateButton.setOnClickListener {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                viewModel.onNextDateSelected()</span>
<span class="nc" id="L105">            }</span>
<span class="nc" id="L106">            previousDateButton.setOnClickListener {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                viewModel.onPreviousDateSelected()</span>
<span class="nc" id="L108">            }</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L113">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc" id="L115">        val nonNullActivity = requireActivity()</span>
<span class="nc" id="L116">        with(StatsViewAllFragmentBinding.bind(view)) {</span>
<span class="nc" id="L117">            this@StatsViewAllFragment.binding = this</span>
<span class="nc" id="L118">            with(nonNullActivity as AppCompatActivity) {</span>
<span class="nc" id="L119">                setSupportActionBar(toolbar)</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                supportActionBar?.let {</span>
<span class="nc" id="L121">                    it.setHomeButtonEnabled(true)</span>
<span class="nc" id="L122">                    it.setDisplayHomeAsUpEnabled(true)</span>
<span class="nc" id="L123">                }</span>
            }
<span class="nc" id="L125">            initializeViews(savedInstanceState)</span>
<span class="nc" id="L126">            initializeViewModels(nonNullActivity, savedInstanceState)</span>
<span class="nc" id="L127">        }</span>
<span class="nc" id="L128">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L131">        super.onDestroyView()</span>
<span class="nc" id="L132">        binding = null</span>
<span class="nc" id="L133">    }</span>

    override fun onActivityCreated(savedInstanceState: Bundle?) {
<span class="nc" id="L136">        super.onActivityCreated(savedInstanceState)</span>

<span class="nc bnc" id="L138" title="All 6 branches missed.">        (activity as AppCompatActivity).supportActionBar?.title = getString(viewModel.title)</span>
<span class="nc" id="L139">    }</span>

    private fun StatsViewAllFragmentBinding.initializeViewModels(
        activity: FragmentActivity,
        savedInstanceState: Bundle?
    ) {
<span class="nc bnc" id="L145" title="All 2 branches missed.">        val nonNullIntent = checkNotNull(activity.intent)</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        val type = if (savedInstanceState == null) {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            nonNullIntent.getSerializableExtra(ARGS_VIEW_TYPE) as StatsViewType</span>
        } else {
<span class="nc bnc" id="L149" title="All 2 branches missed.">            savedInstanceState.getSerializable(ARGS_VIEW_TYPE) as StatsViewType</span>
        }

<span class="nc bnc" id="L152" title="All 2 branches missed.">        val granularity = if (savedInstanceState == null) {</span>
<span class="nc" id="L153">            nonNullIntent.getSerializableExtra(ARGS_TIMEFRAME) as StatsGranularity?</span>
        } else {
<span class="nc" id="L155">            savedInstanceState.getSerializable(ARGS_TIMEFRAME) as StatsGranularity?</span>
        }

<span class="nc bnc" id="L158" title="All 4 branches missed.">        val siteId = savedInstanceState?.getInt(WordPress.LOCAL_SITE_ID, 0)</span>
<span class="nc" id="L159">                ?: nonNullIntent.getIntExtra(WordPress.LOCAL_SITE_ID, 0)</span>
<span class="nc" id="L160">        statsSiteProvider.start(siteId)</span>

<span class="nc" id="L162">        val viewModelFactory = viewModelFactoryBuilder.build(type, granularity)</span>
<span class="nc" id="L163">        viewModel = ViewModelProvider(activity, viewModelFactory).get(StatsViewAllViewModel::class.java)</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">        val selectedDate = if (savedInstanceState == null) {</span>
<span class="nc" id="L166">            nonNullIntent.getParcelableExtra(ARGS_SELECTED_DATE) as SelectedDate?</span>
        } else {
<span class="nc" id="L168">            savedInstanceState.getParcelable(ARGS_SELECTED_DATE) as SelectedDate?</span>
        }
<span class="nc" id="L170">        setupObservers(activity)</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">        viewModel.start(selectedDate)</span>
<span class="nc" id="L173">    }</span>

    private fun StatsViewAllFragmentBinding.setupObservers(activity: FragmentActivity) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        viewModel.isRefreshing.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            it?.let { isRefreshing -&gt;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                swipeToRefreshHelper.isRefreshing = isRefreshing</span>
<span class="nc" id="L179">            }</span>
<span class="nc" id="L180">        })</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        viewModel.showSnackbarMessage.observeEvent(viewLifecycleOwner, { holder -&gt;</span>
<span class="nc" id="L183">            showSnackbar(activity, holder)</span>
<span class="nc" id="L184">        })</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">        viewModel.data.observe(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (it != null) {</span>
<span class="nc" id="L188">                with(statsListFragment) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    recyclerView.visibility = if (it is Success) View.VISIBLE else View.GONE</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                    loadingContainer.visibility = if (it is Loading) View.VISIBLE else View.GONE</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                    val showErrorView = if (it is Error) View.VISIBLE else View.GONE</span>
<span class="nc" id="L192">                    errorView.statsErrorView.visibility = showErrorView</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                    val showEmptyView = if (it is EmptyBlock) View.VISIBLE else View.GONE</span>
<span class="nc" id="L194">                    emptyView.statsEmptyView.visibility = showEmptyView</span>
<span class="nc" id="L195">                    when (it) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                        is Success -&gt; {</span>
<span class="nc" id="L197">                            loadData(recyclerView, prepareLayout(it.data, it.type))</span>
                        }
<span class="nc bnc" id="L199" title="All 2 branches missed.">                        is Loading -&gt; {</span>
<span class="nc" id="L200">                            loadData(loadingRecyclerView, prepareLayout(it.data, it.type))</span>
                        }
<span class="nc bnc" id="L202" title="All 2 branches missed.">                        is Error -&gt; {</span>
<span class="nc" id="L203">                            errorView.statsErrorView.button.setOnClickListener {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                                viewModel.onRetryClick()</span>
<span class="nc" id="L205">                            }</span>
                        }
<span class="nc bnc" id="L207" title="All 2 branches missed.">                        is EmptyBlock -&gt; {</span>
                        }
                    }
<span class="nc" id="L210">                }</span>
            }
<span class="nc" id="L212">        })</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        viewModel.navigationTarget.observeEvent(viewLifecycleOwner, { target -&gt;</span>
<span class="nc" id="L214">            navigator.navigate(activity, target)</span>
<span class="nc" id="L215">        })</span>

<span class="nc bnc" id="L217" title="All 2 branches missed.">        viewModel.dateSelectorData.observe(viewLifecycleOwner, { dateSelectorUiModel -&gt;</span>
<span class="nc" id="L218">            statsListFragment.drawDateSelector(dateSelectorUiModel)</span>
<span class="nc" id="L219">        })</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">        viewModel.navigationTarget.observeEvent(viewLifecycleOwner, { target -&gt;</span>
<span class="nc" id="L222">            navigator.navigate(activity, target)</span>
<span class="nc" id="L223">        })</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">        viewModel.selectedDate.observe(viewLifecycleOwner, { event -&gt;</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            if (event != null) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                viewModel.onDateChanged()</span>
            }
<span class="nc" id="L229">        })</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">        viewModel.toolbarHasShadow.observe(viewLifecycleOwner, { hasShadow -&gt;</span>
<span class="nc" id="L232">            appBarLayout.showShadow(hasShadow == true)</span>
<span class="nc" id="L233">        })</span>
<span class="nc" id="L234">    }</span>

    private fun showSnackbar(
        activity: FragmentActivity,
        holder: SnackbarMessageHolder
    ) {
<span class="nc" id="L240">        val parent = activity.findViewById&lt;View&gt;(R.id.coordinatorLayout)</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (parent != null) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (holder.buttonTitle == null) {</span>
<span class="nc" id="L243">                WPSnackbar.make(</span>
<span class="nc" id="L244">                        parent,</span>
<span class="nc" id="L245">                        uiHelpers.getTextOfUiString(requireContext(), holder.message),</span>
<span class="nc" id="L246">                        Snackbar.LENGTH_LONG</span>
<span class="nc" id="L247">                ).show()</span>
            } else {
<span class="nc" id="L249">                val snackbar = WPSnackbar.make(</span>
<span class="nc" id="L250">                        parent,</span>
<span class="nc" id="L251">                        uiHelpers.getTextOfUiString(requireContext(), holder.message),</span>
<span class="nc" id="L252">                        Snackbar.LENGTH_LONG</span>
                )
<span class="nc" id="L254">                snackbar.setAction(</span>
<span class="nc" id="L255">                        uiHelpers.getTextOfUiString(requireContext(), holder.buttonTitle)</span>
<span class="nc" id="L256">                ) { holder.buttonAction() }</span>
<span class="nc" id="L257">                snackbar.show()</span>
            }
        }
<span class="nc" id="L260">    }</span>

    private fun loadData(recyclerView: RecyclerView, data: List&lt;BlockListItem&gt;) {
        val adapter: BlockListAdapter
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (recyclerView.adapter == null) {</span>
<span class="nc" id="L265">            adapter = BlockListAdapter(imageManager)</span>
<span class="nc" id="L266">            recyclerView.adapter = adapter</span>
        } else {
<span class="nc bnc" id="L268" title="All 2 branches missed.">            adapter = recyclerView.adapter as BlockListAdapter</span>
        }

<span class="nc bnc" id="L271" title="All 2 branches missed.">        val recyclerViewState = recyclerView.layoutManager?.onSaveInstanceState()</span>
<span class="nc" id="L272">        adapter.update(data)</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        recyclerView.layoutManager?.onRestoreInstanceState(recyclerViewState)</span>
<span class="nc" id="L274">    }</span>

    private fun StatsViewAllFragmentBinding.prepareLayout(
        data: List&lt;BlockListItem&gt;,
        type: Type
    ): List&lt;BlockListItem&gt; {
<span class="nc bnc" id="L280" title="All 4 branches missed.">        val tabs = data.firstOrNull { it is TabsItem } as? TabsItem</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        return if (tabs != null) {</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (tabLayout.tabCount == 0) {</span>
<span class="nc" id="L283">                tabLayout.clearOnTabSelectedListeners()</span>
<span class="nc" id="L284">                tabLayout.removeAllTabs()</span>
<span class="nc" id="L285">                tabs.tabs.forEach { tabItem -&gt;</span>
<span class="nc" id="L286">                    tabLayout.addTab(tabLayout.newTab().setText(tabItem))</span>
<span class="nc" id="L287">                }</span>
<span class="nc" id="L288">                tabLayout.addOnTabSelectedListener(object : OnTabSelectedListener {</span>
                    override fun onTabReselected(tab: Tab) {
<span class="nc" id="L290">                    }</span>

                    override fun onTabUnselected(tab: Tab) {
<span class="nc" id="L293">                    }</span>

                    override fun onTabSelected(tab: Tab) {
<span class="nc" id="L296">                        tabs.onTabSelected(tab.position)</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">                        activity?.intent?.putExtra(SELECTED_TAB_KEY, tab.position)</span>
<span class="nc" id="L298">                    }</span>
                })
<span class="nc bnc" id="L300" title="All 4 branches missed.">                val selectedTab = activity?.intent?.getIntExtra(SELECTED_TAB_KEY, 0) ?: 0</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                tabLayout.getTabAt(selectedTab)?.select()</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            } else if (tabLayout.selectedTabPosition != tabs.selectedTabPosition) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                tabLayout.getTabAt(tabs.selectedTabPosition)?.select()</span>
            }

<span class="nc bnc" id="L306" title="All 2 branches missed.">            (toolbar.layoutParams as LayoutParams).scrollFlags =</span>
<span class="nc" id="L307">                    LayoutParams.SCROLL_FLAG_SCROLL.or(LayoutParams.SCROLL_FLAG_ENTER_ALWAYS)</span>
<span class="nc" id="L308">            tabLayout.visibility = View.VISIBLE</span>

<span class="nc bnc" id="L310" title="All 4 branches missed.">            data.filter { it !is TabsItem }</span>
        } else {
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (type != LOADING) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                (toolbar.layoutParams as LayoutParams).scrollFlags = 0</span>
<span class="nc" id="L314">                tabLayout.visibility = View.GONE</span>
            }
<span class="nc" id="L316">            data</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>