<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddQuickPressShortcutActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui</a> &gt; <span class="el_source">AddQuickPressShortcutActivity.java</span></div><h1>AddQuickPressShortcutActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui;

import android.content.DialogInterface;
import android.content.Intent;
import android.os.Bundle;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.BaseAdapter;
import android.widget.ListView;
import android.widget.RelativeLayout;
import android.widget.TextView;

import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.widget.Toolbar;
import androidx.core.content.pm.ShortcutInfoCompat;
import androidx.core.content.pm.ShortcutManagerCompat;
import androidx.core.graphics.drawable.IconCompat;

import com.android.volley.toolbox.NetworkImageView;
import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.google.android.material.textfield.TextInputEditText;

import org.apache.commons.text.StringEscapeUtils;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.tools.FluxCImageLoader;
import org.wordpress.android.ui.posts.EditPostActivity;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.ToastUtils;

import java.util.ArrayList;
import java.util.List;

import javax.inject.Inject;

<span class="nc" id="L44">public class AddQuickPressShortcutActivity extends LocaleAwareActivity {</span>
    public String[] blogNames;
    public int[] siteIds;
    public String[] blogUrls;
    public String[] blavatars;
<span class="nc" id="L49">    public List&lt;String&gt; accountNames = new ArrayList&lt;&gt;();</span>

    @Inject SiteStore mSiteStore;
    @Inject FluxCImageLoader mImageLoader;

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L56">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L57">        ((WordPress) getApplication()).component().inject(this);</span>

<span class="nc" id="L59">        setContentView(R.layout.quickpress_widget_configure_activity);</span>
<span class="nc" id="L60">        Toolbar toolbar = findViewById(R.id.toolbar_main);</span>
<span class="nc" id="L61">        setSupportActionBar(toolbar);</span>
<span class="nc" id="L62">        ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L64">            actionBar.setHomeButtonEnabled(true);</span>
<span class="nc" id="L65">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
        }

<span class="nc" id="L68">        displayAccounts();</span>
<span class="nc" id="L69">    }</span>

    @Override
    public boolean onOptionsItemSelected(final MenuItem item) {
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (item.getItemId() == android.R.id.home) {</span>
<span class="nc" id="L74">            onBackPressed();</span>
<span class="nc" id="L75">            return true;</span>
        }
<span class="nc" id="L77">        return super.onOptionsItemSelected(item);</span>
    }

    private void displayAccounts() {
<span class="nc" id="L81">        List&lt;SiteModel&gt; sites = mSiteStore.getVisibleSites();</span>

<span class="nc" id="L83">        ListView listView = (ListView) findViewById(android.R.id.list);</span>

<span class="nc" id="L85">        listView.setVerticalFadingEdgeEnabled(false);</span>
<span class="nc" id="L86">        listView.setVerticalScrollBarEnabled(true);</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (sites.size() &gt; 0) {</span>
<span class="nc" id="L89">            blogNames = new String[sites.size()];</span>
<span class="nc" id="L90">            siteIds = new int[sites.size()];</span>
<span class="nc" id="L91">            blogUrls = new String[sites.size()];</span>
<span class="nc" id="L92">            blavatars = new String[sites.size()];</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">            for (int i = 0; i &lt; sites.size(); i++) {</span>
<span class="nc" id="L94">                SiteModel site = sites.get(i);</span>
<span class="nc" id="L95">                blogNames[i] = SiteUtils.getSiteNameOrHomeURL(site);</span>
<span class="nc" id="L96">                blogUrls[i] = site.getUrl();</span>
<span class="nc" id="L97">                siteIds[i] = site.getId();</span>
<span class="nc" id="L98">                blavatars[i] = SiteUtils.getSiteIconUrl(site, 60);</span>
<span class="nc" id="L99">                accountNames.add(i, blogNames[i]);</span>
            }

<span class="nc" id="L102">            listView.setAdapter(new HomeListAdapter());</span>

<span class="nc" id="L104">            listView.setOnItemClickListener(new OnItemClickListener() {</span>
                public void onItemClick(AdapterView&lt;?&gt; arg0, View row, int position, long id) {
<span class="nc" id="L106">                    AddQuickPressShortcutActivity.this.buildDialog(position);</span>
<span class="nc" id="L107">                }</span>
            });

<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (sites.size() == 1) {</span>
<span class="nc" id="L111">                AddQuickPressShortcutActivity.this.buildDialog(0);</span>
            }
        } else {
            // no account, load new account view
<span class="nc" id="L115">            ActivityLauncher.showSignInForResult(AddQuickPressShortcutActivity.this);</span>
        }
<span class="nc" id="L117">    }</span>

    private void buildDialog(final int position) {
<span class="nc" id="L120">        AlertDialog.Builder dialogBuilder = new MaterialAlertDialogBuilder(this);</span>
<span class="nc" id="L121">        dialogBuilder.setTitle(R.string.quickpress_add_alert_title);</span>

<span class="nc" id="L123">        LayoutInflater layoutInflater = LayoutInflater.from(this);</span>
        //noinspection InflateParams
<span class="nc" id="L125">        View dialogView = layoutInflater.inflate(R.layout.quick_press_input_dialog, null);</span>

<span class="nc" id="L127">        TextInputEditText quickPressShortcutName = dialogView.findViewById(R.id.quick_press_input_dialog_edit_text);</span>
<span class="nc" id="L128">        quickPressShortcutName.setText(getString(R.string.quickpress_shortcut_with_account_param,</span>
<span class="nc" id="L129">                StringEscapeUtils.unescapeHtml4(accountNames.get(position))));</span>

<span class="nc" id="L131">        dialogBuilder.setView(dialogView);</span>

<span class="nc" id="L133">        dialogBuilder.setPositiveButton(R.string.add, new DialogInterface.OnClickListener() {</span>
            public void onClick(DialogInterface dialog, int which) {
<span class="nc bnc" id="L135" title="All 2 branches missed.">                if (TextUtils.isEmpty(quickPressShortcutName.getText())) {</span>
<span class="nc" id="L136">                    ToastUtils.showToast(AddQuickPressShortcutActivity.this, R.string.quickpress_add_error,</span>
                            ToastUtils.Duration.LONG);
                } else {
<span class="nc" id="L139">                    Intent shortcutIntent = new Intent(getApplicationContext(), EditPostActivity.class);</span>
<span class="nc" id="L140">                    shortcutIntent.setAction(Intent.ACTION_MAIN);</span>
<span class="nc" id="L141">                    shortcutIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L142">                    shortcutIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);</span>
<span class="nc" id="L143">                    shortcutIntent.putExtra(EditPostActivity.EXTRA_QUICKPRESS_BLOG_ID, siteIds[position]);</span>
<span class="nc" id="L144">                    shortcutIntent.putExtra(EditPostActivity.EXTRA_IS_QUICKPRESS, true);</span>

<span class="nc" id="L146">                    String shortcutName = quickPressShortcutName.getText().toString();</span>

<span class="nc" id="L148">                    WordPress.wpDB.addQuickPressShortcut(siteIds[position], shortcutName);</span>

<span class="nc" id="L150">                    ShortcutInfoCompat pinShortcutInfo =</span>
<span class="nc" id="L151">                            new ShortcutInfoCompat.Builder(getApplicationContext(), shortcutName)</span>
<span class="nc" id="L152">                                    .setIcon(IconCompat.createWithResource(getApplicationContext(), R.mipmap.app_icon))</span>
<span class="nc" id="L153">                                    .setShortLabel(shortcutName)</span>
<span class="nc" id="L154">                                    .setIntent(shortcutIntent)</span>
<span class="nc" id="L155">                                    .build();</span>

<span class="nc" id="L157">                    ShortcutManagerCompat.requestPinShortcut(getApplicationContext(), pinShortcutInfo, null);</span>

<span class="nc" id="L159">                    AddQuickPressShortcutActivity.this.finish();</span>
                }
<span class="nc" id="L161">            }</span>
        });
<span class="nc" id="L163">        dialogBuilder.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {</span>
            // just let the dialog close
            public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L166">            }</span>
        });

<span class="nc" id="L169">        dialogBuilder.setCancelable(false);</span>
<span class="nc" id="L170">        dialogBuilder.create().show();</span>
<span class="nc" id="L171">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L175">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        switch (requestCode) {</span>
            case RequestCodes.ADD_ACCOUNT:
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if (resultCode == RESULT_OK) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                    if (mSiteStore.getVisibleSitesCount() &gt; 0) {</span>
<span class="nc" id="L180">                        displayAccounts();</span>
<span class="nc" id="L181">                        break;</span>
                    }
                }
<span class="nc" id="L184">                finish();</span>
                break;
        }
<span class="nc" id="L187">    }</span>

    protected class HomeListAdapter extends BaseAdapter {
<span class="nc" id="L190">        public HomeListAdapter() {</span>
<span class="nc" id="L191">        }</span>

        public int getCount() {
<span class="nc" id="L194">            return mSiteStore.getVisibleSitesCount();</span>
        }

        public Object getItem(int position) {
<span class="nc" id="L198">            return position;</span>
        }

        public long getItemId(int position) {
<span class="nc" id="L202">            return position;</span>
        }

        public View getView(int position, View convertView, ViewGroup parent) {
<span class="nc" id="L206">            RelativeLayout view = (RelativeLayout) convertView;</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (view == null) {</span>
<span class="nc" id="L208">                LayoutInflater inflater = getLayoutInflater();</span>
<span class="nc" id="L209">                view = (RelativeLayout) inflater.inflate(R.layout.quick_press_widget_configure_list_row, parent, false);</span>
            }
<span class="nc" id="L211">            view.setId(siteIds[position]);</span>

<span class="nc" id="L213">            TextView blogName = (TextView) view.findViewById(R.id.blogName);</span>
<span class="nc" id="L214">            TextView blogUrl = (TextView) view.findViewById(R.id.blogUrl);</span>
<span class="nc" id="L215">            NetworkImageView blavatar = (NetworkImageView) view.findViewById(R.id.blavatar);</span>
<span class="nc" id="L216">            blavatar.setDefaultImageResId(R.drawable.ic_placeholder_blavatar_grey_lighten_20_40dp);</span>

<span class="nc" id="L218">            blogName.setText(</span>
<span class="nc" id="L219">                    StringEscapeUtils.unescapeHtml4(blogNames[position]));</span>
<span class="nc" id="L220">            blogUrl.setText(</span>
<span class="nc" id="L221">                    StringEscapeUtils.unescapeHtml4(blogUrls[position]));</span>
<span class="nc" id="L222">            blavatar.setErrorImageResId(R.drawable.bg_rectangle_placeholder_globe_32dp);</span>
<span class="nc" id="L223">            blavatar.setImageUrl(blavatars[position], mImageLoader);</span>

<span class="nc" id="L225">            return view;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>