<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PageParentFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.pages</a> &gt; <span class="el_source">PageParentFragment.kt</span></div><h1>PageParentFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.pages

import android.app.Activity
import android.content.Intent
import android.os.Bundle
import android.os.Parcelable
import android.view.Menu
import android.view.MenuInflater
import android.view.MenuItem
import android.view.MenuItem.OnActionExpandListener
import android.view.View
import android.widget.LinearLayout
import androidx.appcompat.widget.SearchView
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentActivity
import androidx.lifecycle.Observer
import androidx.lifecycle.ViewModelProvider
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.Job
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.PageParentFragmentBinding
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.util.DisplayUtils
import org.wordpress.android.viewmodel.pages.PageParentViewModel
import org.wordpress.android.widgets.RecyclerItemDecoration
import javax.inject.Inject
import kotlin.coroutines.CoroutineContext

<span class="nc" id="L33">class PageParentFragment : Fragment(R.layout.page_parent_fragment), CoroutineScope {</span>
<span class="nc" id="L34">    private var job: Job = Job()</span>

    override val coroutineContext: CoroutineContext
<span class="nc" id="L37">        get() = Dispatchers.Main + job</span>

<span class="nc bnc" id="L39" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
    private lateinit var viewModel: PageParentViewModel

<span class="nc" id="L42">    private val listStateKey = &quot;list_state&quot;</span>

    private var linearLayoutManager: LinearLayoutManager? = null
    private var saveButton: MenuItem? = null
    private lateinit var searchAction: MenuItem

    private var pageId: Long? = null
    private var restorePreviousSearch = false
    private var binding: PageParentFragmentBinding? = null

    companion object {
        fun newInstance(): PageParentFragment {
<span class="nc" id="L54">            return PageParentFragment()</span>
        }
    }

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (item.itemId == android.R.id.home) {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            activity?.onBackPressed()</span>
<span class="nc" id="L61">            return true</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        } else if (item.itemId == R.id.save_parent) {</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            viewModel.onSaveButtonTapped()</span>
<span class="nc" id="L64">            return true</span>
        }

<span class="nc" id="L67">        return super.onOptionsItemSelected(item)</span>
    }

    private fun returnParentChoiceAndExit() {
<span class="nc" id="L71">        val result = Intent()</span>
<span class="nc" id="L72">        result.putExtra(EXTRA_PAGE_REMOTE_ID_KEY, pageId)</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        result.putExtra(EXTRA_PAGE_PARENT_ID_KEY, viewModel.currentParent.id)</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        activity?.setResult(Activity.RESULT_OK, result)</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        activity?.onBackPressed()</span>
<span class="nc" id="L76">    }</span>

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L79">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L80">        setHasOptionsMenu(true)</span>
<span class="nc" id="L81">    }</span>

    override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
<span class="nc" id="L84">        super.onCreateOptionsMenu(menu, inflater)</span>
<span class="nc" id="L85">        inflater.inflate(R.menu.page_parent_menu, menu)</span>

<span class="nc" id="L87">        saveButton = menu.findItem(R.id.save_parent)</span>
<span class="nc bnc" id="L88" title="All 6 branches missed.">        viewModel.isSaveButtonVisible.value?.let { saveButton?.isVisible = it }</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        searchAction = checkNotNull(menu.findItem(R.id.action_search)) {</span>
<span class="nc" id="L90">            &quot;Menu does not contain mandatory search item&quot;</span>
        }

<span class="nc" id="L93">        binding!!.initializeSearchView()</span>
<span class="nc" id="L94">    }</span>

    private fun PageParentFragmentBinding.initializeSearchView() {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        searchAction.setOnActionExpandListener(object : OnActionExpandListener {</span>
            override fun onMenuItemActionExpand(item: MenuItem?): Boolean {
<span class="nc bnc" id="L99" title="All 2 branches missed.">                viewModel.onSearchExpanded(restorePreviousSearch)</span>
<span class="nc" id="L100">                return true</span>
            }

            override fun onMenuItemActionCollapse(item: MenuItem?): Boolean {
<span class="nc bnc" id="L104" title="All 2 branches missed.">                viewModel.onSearchCollapsed()</span>
<span class="nc" id="L105">                return true</span>
            }
        })

<span class="nc bnc" id="L109" title="All 4 branches missed.">        val searchView = searchAction.actionView as SearchView</span>
<span class="nc" id="L110">        searchView.setOnQueryTextListener(object : SearchView.OnQueryTextListener {</span>
            override fun onQueryTextSubmit(query: String): Boolean {
<span class="nc bnc" id="L112" title="All 2 branches missed.">                viewModel.onSearch(query)</span>
<span class="nc" id="L113">                return true</span>
            }

            override fun onQueryTextChange(newText: String): Boolean {
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (restorePreviousSearch) {</span>
<span class="nc" id="L118">                    restorePreviousSearch = false</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                    searchView.setQuery(viewModel.lastSearchQuery, false)</span>
                } else {
<span class="nc bnc" id="L121" title="All 2 branches missed.">                    viewModel.onSearch(newText)</span>
                }
<span class="nc" id="L123">                return true</span>
            }
        })

<span class="nc bnc" id="L127" title="All 2 branches missed.">        val searchEditFrame = searchAction.actionView.findViewById&lt;LinearLayout&gt;(R.id.search_edit_frame)</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        (searchEditFrame.layoutParams as LinearLayout.LayoutParams)</span>
<span class="nc" id="L129">                .apply { this.leftMargin = DisplayUtils.dpToPx(activity, -8) }</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">        viewModel.isSearchExpanded.observe(this@PageParentFragment, Observer {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (it == true) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                showSearchList(searchAction)</span>
            } else {
<span class="nc bnc" id="L135" title="All 2 branches missed.">                hideSearchList(searchAction)</span>
            }
<span class="nc" id="L137">        })</span>
<span class="nc" id="L138">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L141">        super.onViewCreated(view, savedInstanceState)</span>

<span class="nc bnc" id="L143" title="All 4 branches missed.">        pageId = activity?.intent?.getLongExtra(EXTRA_PAGE_REMOTE_ID_KEY, 0)</span>

<span class="nc bnc" id="L145" title="All 2 branches missed.">        val nonNullPageId = checkNotNull(pageId)</span>
<span class="nc" id="L146">        val nonNullActivity = requireActivity()</span>

<span class="nc bnc" id="L148" title="All 6 branches missed.">        (nonNullActivity.application as? WordPress)?.component()?.inject(this)</span>
<span class="nc" id="L149">        with(PageParentFragmentBinding.bind(view)) {</span>
<span class="nc" id="L150">            binding = this</span>
<span class="nc" id="L151">            initializeViews(nonNullActivity, savedInstanceState)</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            initializeViewModels(nonNullActivity, nonNullPageId, savedInstanceState == null)</span>
<span class="nc" id="L153">        }</span>
<span class="nc" id="L154">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L157">        super.onDestroyView()</span>
<span class="nc" id="L158">        binding = null</span>
<span class="nc" id="L159">    }</span>

    private fun PageParentFragmentBinding.initializeViews(activity: FragmentActivity, savedInstanceState: Bundle?) {
<span class="nc" id="L162">        val layoutManager = LinearLayoutManager(activity, RecyclerView.VERTICAL, false)</span>
<span class="nc bnc" id="L163" title="All 4 branches missed.">        savedInstanceState?.getParcelable&lt;Parcelable&gt;(listStateKey)?.let {</span>
<span class="nc" id="L164">            layoutManager.onRestoreInstanceState(it)</span>
<span class="nc" id="L165">        }</span>

<span class="nc" id="L167">        linearLayoutManager = layoutManager</span>
<span class="nc" id="L168">        recyclerView.layoutManager = linearLayoutManager</span>
<span class="nc" id="L169">        recyclerView.addItemDecoration(RecyclerItemDecoration(0, DisplayUtils.dpToPx(activity, 1)))</span>

<span class="nc" id="L171">        val searchFragment = PageParentSearchFragment.newInstance()</span>
<span class="nc" id="L172">        activity.supportFragmentManager</span>
<span class="nc" id="L173">                .beginTransaction()</span>
<span class="nc" id="L174">                .replace(R.id.frameSearch, searchFragment)</span>
<span class="nc" id="L175">                .commit()</span>
<span class="nc" id="L176">    }</span>

    private fun PageParentFragmentBinding.initializeViewModels(
        activity: FragmentActivity,
        pageId: Long,
        isFirstStart: Boolean
    ) {
<span class="nc" id="L183">        viewModel = ViewModelProvider(activity, viewModelFactory)</span>
<span class="nc" id="L184">                .get(PageParentViewModel::class.java)</span>

<span class="nc" id="L186">        setupObservers()</span>

<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (isFirstStart) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">            val site = activity.intent?.getSerializableExtra(WordPress.SITE) as SiteModel?</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            val nonNullSite = checkNotNull(site)</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            viewModel.start(nonNullSite, pageId)</span>
        } else {
<span class="nc" id="L193">            restorePreviousSearch = true</span>
        }
<span class="nc" id="L195">    }</span>

    private fun PageParentFragmentBinding.setupObservers() {
<span class="nc bnc" id="L198" title="All 2 branches missed.">        viewModel.pages.observe(viewLifecycleOwner, { pages -&gt;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            pages?.let { setPages(pages) }</span>
<span class="nc" id="L200">        })</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">        viewModel.isSaveButtonVisible.observe(viewLifecycleOwner, { isVisible -&gt;</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">            isVisible?.let { saveButton?.isVisible = isVisible }</span>
<span class="nc" id="L204">        })</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">        viewModel.saveParent.observe(viewLifecycleOwner, {</span>
<span class="nc" id="L207">            returnParentChoiceAndExit()</span>
<span class="nc" id="L208">        })</span>
<span class="nc" id="L209">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">        linearLayoutManager?.let { outState.putParcelable(listStateKey, it.onSaveInstanceState()) }</span>
<span class="nc" id="L213">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L214">    }</span>

    private fun PageParentFragmentBinding.setPages(pages: List&lt;PageItem&gt;) {
        val adapter: PageParentAdapter
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (recyclerView.adapter == null) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            adapter = PageParentAdapter({ page -&gt; viewModel.onParentSelected(page) }, this@PageParentFragment)</span>
<span class="nc" id="L220">            recyclerView.adapter = adapter</span>
        } else {
<span class="nc bnc" id="L222" title="All 2 branches missed.">            adapter = recyclerView.adapter as PageParentAdapter</span>
        }
<span class="nc" id="L224">        adapter.update(pages)</span>
<span class="nc" id="L225">    }</span>

    private fun PageParentFragmentBinding.hideSearchList(myActionMenuItem: MenuItem) {
<span class="nc" id="L228">        recyclerView.visibility = View.VISIBLE</span>
<span class="nc" id="L229">        frameSearch.visibility = View.GONE</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (myActionMenuItem.isActionViewExpanded) {</span>
<span class="nc" id="L231">            myActionMenuItem.collapseActionView()</span>
        }
        /**Force the recyclerview to redraw if selection has changed while in search mode*/
<span class="nc bnc" id="L234" title="All 6 branches missed.">        if (viewModel.currentParent != viewModel.initialParent) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            recyclerView.adapter?.notifyDataSetChanged()</span>
        }
<span class="nc" id="L237">    }</span>

    private fun PageParentFragmentBinding.showSearchList(myActionMenuItem: MenuItem) {
<span class="nc" id="L240">        frameSearch.visibility = View.VISIBLE</span>
<span class="nc" id="L241">        recyclerView.visibility = View.GONE</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (!myActionMenuItem.isActionViewExpanded) {</span>
<span class="nc" id="L243">            myActionMenuItem.expandActionView()</span>
        }
<span class="nc" id="L245">    }</span>

    override fun onDestroy() {
<span class="nc" id="L248">        super.onDestroy()</span>
<span class="nc" id="L249">        job.cancel()</span>
<span class="nc" id="L250">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>