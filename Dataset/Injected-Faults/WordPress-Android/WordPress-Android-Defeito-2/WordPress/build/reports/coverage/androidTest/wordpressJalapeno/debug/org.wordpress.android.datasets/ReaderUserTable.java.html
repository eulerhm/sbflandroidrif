<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderUserTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.datasets</a> &gt; <span class="el_source">ReaderUserTable.java</span></div><h1>ReaderUserTable.java</h1><pre class="source lang-java linenums">package org.wordpress.android.datasets;

import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteStatement;

import org.wordpress.android.models.ReaderUser;
import org.wordpress.android.models.ReaderUserIdList;
import org.wordpress.android.models.ReaderUserList;
import org.wordpress.android.util.GravatarUtils;
import org.wordpress.android.util.SqlUtils;

import java.util.ArrayList;

/**
 * stores info about the current user and liking users
 */
<span class="nc" id="L18">public class ReaderUserTable {</span>
    protected static void createTables(SQLiteDatabase db) {
<span class="nc" id="L20">        db.execSQL(&quot;CREATE TABLE tbl_users (&quot;</span>
                   + &quot; user_id INTEGER PRIMARY KEY,&quot;
                   + &quot; blog_id INTEGER DEFAULT 0,&quot;
                   + &quot; user_name TEXT,&quot;
                   + &quot; display_name TEXT COLLATE NOCASE,&quot;
                   + &quot; url TEXT,&quot;
                   + &quot; profile_url TEXT,&quot;
                   + &quot; avatar_url TEXT)&quot;);
<span class="nc" id="L28">    }</span>

    protected static void dropTables(SQLiteDatabase db) {
<span class="nc" id="L31">        db.execSQL(&quot;DROP TABLE IF EXISTS tbl_users&quot;);</span>
<span class="nc" id="L32">    }</span>

    public static void addOrUpdateUser(ReaderUser user) {
<span class="nc bnc" id="L35" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L36">            return;</span>
        }

<span class="nc" id="L39">        ReaderUserList users = new ReaderUserList();</span>
<span class="nc" id="L40">        users.add(user);</span>
<span class="nc" id="L41">        addOrUpdateUsers(users);</span>
<span class="nc" id="L42">    }</span>

    private static final String COLUMN_NAMES =
            &quot; user_id,&quot; // 1
            + &quot; blog_id,&quot; // 2
            + &quot; user_name,&quot; // 3
            + &quot; display_name,&quot; // 4
            + &quot; url,&quot; // 5
            + &quot; profile_url,&quot; // 6
            + &quot; avatar_url&quot;; // 7

    public static void addOrUpdateUsers(ReaderUserList users) {
<span class="nc bnc" id="L54" title="All 4 branches missed.">        if (users == null || users.size() == 0) {</span>
<span class="nc" id="L55">            return;</span>
        }

<span class="nc" id="L58">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L59">        db.beginTransaction();</span>
<span class="nc" id="L60">        SQLiteStatement stmt = db.compileStatement(</span>
                &quot;INSERT OR REPLACE INTO tbl_users (&quot; + COLUMN_NAMES + &quot;) VALUES (?1,?2,?3,?4,?5,?6,?7)&quot;);
        try {
<span class="nc bnc" id="L63" title="All 2 branches missed.">            for (ReaderUser user : users) {</span>
<span class="nc" id="L64">                stmt.bindLong(1, user.userId);</span>
<span class="nc" id="L65">                stmt.bindLong(2, user.blogId);</span>
<span class="nc" id="L66">                stmt.bindString(3, user.getUserName());</span>
<span class="nc" id="L67">                stmt.bindString(4, user.getDisplayName());</span>
<span class="nc" id="L68">                stmt.bindString(5, user.getUrl());</span>
<span class="nc" id="L69">                stmt.bindString(6, user.getProfileUrl());</span>
<span class="nc" id="L70">                stmt.bindString(7, user.getAvatarUrl());</span>
<span class="nc" id="L71">                stmt.execute();</span>
<span class="nc" id="L72">            }</span>

<span class="nc" id="L74">            db.setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L76">            db.endTransaction();</span>
<span class="nc" id="L77">            SqlUtils.closeStatement(stmt);</span>
        }
<span class="nc" id="L79">    }</span>

    /*
     * returns avatar urls for the passed user ids - used by post detail to show avatars for liking users
     */
    public static ArrayList&lt;String&gt; getAvatarUrls(ReaderUserIdList userIds, int max, int avatarSz, long wpComUserId) {
<span class="nc" id="L85">        ArrayList&lt;String&gt; avatars = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L86" title="All 4 branches missed.">        if (userIds == null || userIds.size() == 0) {</span>
<span class="nc" id="L87">            return avatars;</span>
        }

<span class="nc" id="L90">        StringBuilder sb = new StringBuilder(&quot;SELECT user_id, avatar_url FROM tbl_users WHERE user_id IN (&quot;);</span>

        // make sure current user's avatar is returned if the passed list contains them - this is
        // important since it may not otherwise be returned when a &quot;max&quot; is passed, and we want
        // the current user to appear first in post detail when they like a post
<span class="nc" id="L95">        boolean containsCurrentUser = userIds.contains(wpComUserId);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (containsCurrentUser) {</span>
<span class="nc" id="L97">            sb.append(wpComUserId);</span>
        }

<span class="nc bnc" id="L100" title="All 2 branches missed.">        int numAdded = (containsCurrentUser ? 1 : 0);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        for (Long id : userIds) {</span>
            // skip current user since we added them already
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (id != wpComUserId) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                if (numAdded &gt; 0) {</span>
<span class="nc" id="L105">                    sb.append(&quot;,&quot;);</span>
                }
<span class="nc" id="L107">                sb.append(id);</span>
<span class="nc" id="L108">                numAdded++;</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">                if (max &gt; 0 &amp;&amp; numAdded &gt;= max) {</span>
<span class="nc" id="L110">                    break;</span>
                }
            }
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">        sb.append(&quot;)&quot;);</span>

<span class="nc" id="L116">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(sb.toString(), null);</span>
        try {
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L120">                    long userId = c.getLong(0);</span>
<span class="nc" id="L121">                    String url = GravatarUtils.fixGravatarUrl(c.getString(1), avatarSz);</span>
                    // add current user to the top
<span class="nc bnc" id="L123" title="All 2 branches missed.">                    if (userId == wpComUserId) {</span>
<span class="nc" id="L124">                        avatars.add(0, url);</span>
                    } else {
<span class="nc" id="L126">                        avatars.add(url);</span>
                    }
<span class="nc bnc" id="L128" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }
<span class="nc" id="L130">            return avatars;</span>
        } finally {
<span class="nc" id="L132">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static ReaderUser getCurrentUser(final long wpComUserId) {
<span class="nc" id="L137">        return getUser(wpComUserId);</span>
    }

    private static ReaderUser getUser(long userId) {
<span class="nc" id="L141">        String[] args = {Long.toString(userId)};</span>
<span class="nc" id="L142">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(&quot;SELECT * FROM tbl_users WHERE user_id=?&quot;, args);</span>
        try {
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if (!c.moveToFirst()) {</span>
<span class="nc" id="L145">                return null;</span>
            }
<span class="nc" id="L147">            return getUserFromCursor(c);</span>
        } finally {
<span class="nc" id="L149">            SqlUtils.closeCursor(c);</span>
        }
    }

    private static String getAvatarForUser(long userId) {
<span class="nc" id="L154">        String[] args = {Long.toString(userId)};</span>
<span class="nc" id="L155">        return SqlUtils</span>
<span class="nc" id="L156">                .stringForQuery(ReaderDatabase.getReadableDb(), &quot;SELECT avatar_url FROM tbl_users WHERE user_id=?&quot;,</span>
                                args);
    }

    public static ReaderUserList getUsersWhoLikePost(long blogId, long postId, int max) {
<span class="nc" id="L161">        String[] args = {Long.toString(blogId), Long.toString(postId)};</span>
<span class="nc" id="L162">        String sql = &quot;SELECT * from tbl_users WHERE user_id IN &quot;</span>
                     + &quot;(SELECT user_id FROM tbl_post_likes WHERE blog_id=? AND post_id=?) ORDER BY display_name&quot;;
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (max &gt; 0) {</span>
<span class="nc" id="L165">            sql += &quot; LIMIT &quot; + Integer.toString(max);</span>
        }

<span class="nc" id="L168">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(sql, args);</span>
        try {
<span class="nc" id="L170">            ReaderUserList users = new ReaderUserList();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L173">                    users.add(getUserFromCursor(c));</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }
<span class="nc" id="L176">            return users;</span>
        } finally {
<span class="nc" id="L178">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static ReaderUserList getUsersWhoLikeComment(long blogId, long commentId, int max) {
<span class="nc" id="L183">        String[] args = {Long.toString(blogId),</span>
<span class="nc" id="L184">                Long.toString(commentId)};</span>
<span class="nc" id="L185">        String sql = &quot;SELECT * from tbl_users WHERE user_id IN&quot;</span>
                     + &quot; (SELECT user_id FROM tbl_comment_likes WHERE blog_id=? AND comment_id=?)&quot;
                     + &quot; ORDER BY display_name&quot;;
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (max &gt; 0) {</span>
<span class="nc" id="L189">            sql += &quot; LIMIT &quot; + Integer.toString(max);</span>
        }

<span class="nc" id="L192">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(sql, args);</span>
        try {
<span class="nc" id="L194">            ReaderUserList users = new ReaderUserList();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L197">                    users.add(getUserFromCursor(c));</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }
<span class="nc" id="L200">            return users;</span>
        } finally {
<span class="nc" id="L202">            SqlUtils.closeCursor(c);</span>
        }
    }

    private static ReaderUser getUserFromCursor(Cursor c) {
<span class="nc" id="L207">        ReaderUser user = new ReaderUser();</span>

<span class="nc" id="L209">        user.userId = c.getLong(c.getColumnIndexOrThrow(&quot;user_id&quot;));</span>
<span class="nc" id="L210">        user.blogId = c.getLong(c.getColumnIndexOrThrow(&quot;blog_id&quot;));</span>
<span class="nc" id="L211">        user.setUserName(c.getString(c.getColumnIndexOrThrow(&quot;user_name&quot;)));</span>
<span class="nc" id="L212">        user.setDisplayName(c.getString(c.getColumnIndexOrThrow(&quot;display_name&quot;)));</span>
<span class="nc" id="L213">        user.setUrl(c.getString(c.getColumnIndexOrThrow(&quot;url&quot;)));</span>
<span class="nc" id="L214">        user.setProfileUrl(c.getString(c.getColumnIndexOrThrow(&quot;profile_url&quot;)));</span>
<span class="nc" id="L215">        user.setAvatarUrl(c.getString(c.getColumnIndexOrThrow(&quot;avatar_url&quot;)));</span>

<span class="nc" id="L217">        return user;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>