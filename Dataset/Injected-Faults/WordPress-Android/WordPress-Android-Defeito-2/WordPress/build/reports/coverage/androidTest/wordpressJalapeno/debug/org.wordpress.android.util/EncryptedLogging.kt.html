<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EncryptedLogging.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">EncryptedLogging.kt</span></div><h1>EncryptedLogging.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.util

import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.launch
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode.ASYNC
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.generated.EncryptedLogActionBuilder
import org.wordpress.android.fluxc.store.EncryptedLogStore
import org.wordpress.android.fluxc.store.EncryptedLogStore.OnEncryptedLogUploaded
import org.wordpress.android.fluxc.store.EncryptedLogStore.OnEncryptedLogUploaded.EncryptedLogFailedToUpload
import org.wordpress.android.fluxc.store.EncryptedLogStore.OnEncryptedLogUploaded.EncryptedLogUploadedSuccessfully
import org.wordpress.android.fluxc.store.EncryptedLogStore.UploadEncryptedLogPayload
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.util.AppLog.T
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import java.io.File
import java.util.UUID
import javax.inject.Inject
import javax.inject.Named
import javax.inject.Singleton

<span class="fc" id="L25">@Singleton</span>
<span class="fc" id="L26">class EncryptedLogging @Inject constructor(</span>
<span class="fc" id="L27">    private val dispatcher: Dispatcher,</span>
<span class="fc" id="L28">    private val encryptedLogStore: EncryptedLogStore,</span>
<span class="fc" id="L29">    private val networkUtilsWrapper: NetworkUtilsWrapper,</span>
<span class="fc" id="L30">    private val analyticsTrackerWrapper: AnalyticsTrackerWrapper,</span>
<span class="fc" id="L31">    @Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher</span>
) {
<span class="fc" id="L33">    private val coroutineScope = CoroutineScope(bgDispatcher)</span>

<span class="fc" id="L35">    init {</span>
<span class="fc" id="L36">        dispatcher.register(this)</span>
<span class="fc" id="L37">    }</span>

    fun start() {
<span class="fc" id="L40">        dispatcher.dispatch(EncryptedLogActionBuilder.newResetUploadStatesAction())</span>
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">        if (networkUtilsWrapper.isNetworkAvailable()) {</span>
<span class="fc" id="L42">            coroutineScope.launch {</span>
<span class="fc" id="L43">                encryptedLogStore.uploadQueuedEncryptedLogs()</span>
<span class="fc" id="L44">            }</span>
        }
<span class="fc" id="L46">    }</span>

    /**
     * Dispatches a FluxC action that will queue the given log to be uploaded as soon as possible.
     *
     * @param logFile Log file to be uploaded
     * @param shouldStartUploadImmediately This parameter will decide whether we should try to upload the log file
     * immediately. After a crash, we are unlikely to have enough time to complete the upload, so we can use this
     * parameter to avoid the unnecessary upload failure.
     */
    fun encryptAndUploadLogFile(logFile: File, shouldStartUploadImmediately: Boolean): String? {
<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (logFile.exists()) {</span>
<span class="nc" id="L58">            val uuid = UUID.randomUUID().toString()</span>
<span class="nc" id="L59">            val payload = UploadEncryptedLogPayload(</span>
<span class="nc" id="L60">                    uuid = uuid,</span>
<span class="nc" id="L61">                    file = logFile,</span>
                    // If the connection is not available, we shouldn't try to upload immediately
<span class="nc bnc" id="L63" title="All 2 branches missed.">                    shouldStartUploadImmediately = shouldStartUploadImmediately &amp;&amp;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                            networkUtilsWrapper.isNetworkAvailable()</span>
            )
<span class="nc" id="L66">            dispatcher.dispatch(EncryptedLogActionBuilder.newUploadLogAction(payload))</span>
<span class="nc" id="L67">            return uuid</span>
        }
<span class="nc" id="L69">        return null</span>
    }

    @Suppress(&quot;unused&quot;)
    @Subscribe(threadMode = ASYNC)
    fun onEncryptedLogUploaded(event: OnEncryptedLogUploaded) {
<span class="nc" id="L75">        when (event) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            is EncryptedLogUploadedSuccessfully -&gt; {</span>
<span class="nc" id="L77">                AppLog.i(T.MAIN, &quot;Encrypted log with uuid: ${event.uuid} uploaded successfully!&quot;)</span>
<span class="nc" id="L78">                analyticsTrackerWrapper.track(Stat.ENCRYPTED_LOGGING_UPLOAD_SUCCESSFUL)</span>
            }
<span class="nc bnc" id="L80" title="All 2 branches missed.">            is EncryptedLogFailedToUpload -&gt; {</span>
<span class="nc" id="L81">                AppLog.e(T.MAIN, &quot;Encrypted log with uuid: ${event.uuid} failed to upload with error: ${event.error}&quot;)</span>
                // Only track final errors
<span class="nc bnc" id="L83" title="All 2 branches missed.">                if (!event.willRetry) {</span>
<span class="nc" id="L84">                    analyticsTrackerWrapper.track(</span>
<span class="nc" id="L85">                            Stat.ENCRYPTED_LOGGING_UPLOAD_FAILED,</span>
<span class="nc" id="L86">                            mapOf(&quot;error_type&quot; to event.error.javaClass.simpleName)</span>
                    )
                }
            }
        }
<span class="nc" id="L91">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>