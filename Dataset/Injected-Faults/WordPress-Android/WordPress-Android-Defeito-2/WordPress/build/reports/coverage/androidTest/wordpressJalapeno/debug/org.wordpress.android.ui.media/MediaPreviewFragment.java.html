<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaPreviewFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.media</a> &gt; <span class="el_source">MediaPreviewFragment.java</span></div><h1>MediaPreviewFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.media;

import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.Bundle;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.FrameLayout;
import android.widget.ImageView;
import android.widget.ImageView.ScaleType;
import android.widget.RelativeLayout;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;

import com.github.chrisbanes.photoview.PhotoView;
import com.github.chrisbanes.photoview.PhotoViewAttacher;
import com.google.android.exoplayer2.Player;
import com.google.android.exoplayer2.SimpleExoPlayer;
import com.google.android.exoplayer2.source.MediaSource;
import com.google.android.exoplayer2.ui.PlayerControlView;
import com.google.android.exoplayer2.ui.PlayerView;

import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.fluxc.model.MediaModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.MediaStore;
import org.wordpress.android.ui.utils.AuthenticationUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.DisplayUtils;
import org.wordpress.android.util.MediaUtils;
import org.wordpress.android.util.PhotonUtils;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.UrlUtils;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageManager.RequestListener;
import org.wordpress.android.util.image.ImageType;

import javax.inject.Inject;

<span class="nc" id="L47">public class MediaPreviewFragment extends Fragment {</span>
    public static final String TAG = &quot;media_preview_fragment&quot;;

    static final String ARG_MEDIA_CONTENT_URI = &quot;content_uri&quot;;
    static final String ARG_MEDIA_ID = &quot;media_id&quot;;
    private static final String ARG_TITLE = &quot;title&quot;;
    private static final String ARG_POSITION = &quot;position&quot;;
    private static final String ARG_AUTOPLAY = &quot;autoplay&quot;;
    private static final String ARG_VIDEO_THUMB = &quot;video_thumb&quot;;

    public interface OnMediaTappedListener {
        void onMediaTapped();
    }

    private String mContentUri;
    private String mVideoThumbnailUrl;
    private String mTitle;
    private boolean mIsVideo;
    private boolean mIsAudio;
    private boolean mAutoPlay;
    private int mPosition;

    private SiteModel mSite;

    private PhotoView mImageView;
    private PlayerView mExoPlayerView;
    private PlayerControlView mExoPlayerControlsView;
    private ImageView mExoPlayerArtworkView;
    private OnMediaTappedListener mMediaTapListener;

    @Inject MediaStore mMediaStore;
    @Inject ImageManager mImageManager;
    @Inject AuthenticationUtils mAuthenticationUtils;
    @Inject ExoPlayerUtils mExoPlayerUtils;

    private SimpleExoPlayer mPlayer;

    /**
     * @param site       optional site this media is associated with
     * @param contentUri URI of media - can be local or remote
     */
    public static MediaPreviewFragment newInstance(
            @Nullable SiteModel site,
            @NonNull String contentUri,
            boolean autoPlay) {
<span class="nc" id="L92">        Bundle args = new Bundle();</span>
<span class="nc" id="L93">        args.putString(ARG_MEDIA_CONTENT_URI, contentUri);</span>
<span class="nc" id="L94">        args.putBoolean(ARG_AUTOPLAY, autoPlay);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (site != null) {</span>
<span class="nc" id="L96">            args.putSerializable(WordPress.SITE, site);</span>
        }

<span class="nc" id="L99">        MediaPreviewFragment fragment = new MediaPreviewFragment();</span>
<span class="nc" id="L100">        fragment.setArguments(args);</span>
<span class="nc" id="L101">        return fragment;</span>
    }

    /**
     * @param site     optional site this media is associated with
     * @param media    media model
     * @param autoPlay true = play video/audio after fragment is created
     */
    public static MediaPreviewFragment newInstance(
            @Nullable SiteModel site,
            @NonNull MediaModel media,
            boolean autoPlay) {
<span class="nc" id="L113">        Bundle args = new Bundle();</span>
<span class="nc" id="L114">        args.putString(ARG_MEDIA_CONTENT_URI, media.getUrl());</span>
<span class="nc" id="L115">        args.putString(ARG_TITLE, media.getTitle());</span>
<span class="nc" id="L116">        args.putBoolean(ARG_AUTOPLAY, autoPlay);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (site != null) {</span>
<span class="nc" id="L118">            args.putSerializable(WordPress.SITE, site);</span>
        }
<span class="nc bnc" id="L120" title="All 4 branches missed.">        if (media.isVideo() &amp;&amp; !TextUtils.isEmpty(media.getThumbnailUrl())) {</span>
<span class="nc" id="L121">            args.putString(ARG_VIDEO_THUMB, media.getThumbnailUrl());</span>
        }

<span class="nc" id="L124">        MediaPreviewFragment fragment = new MediaPreviewFragment();</span>
<span class="nc" id="L125">        fragment.setArguments(args);</span>
<span class="nc" id="L126">        return fragment;</span>
    }

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L131">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L132">        ((WordPress) getActivity().getApplication()).component().inject(this);</span>

<span class="nc" id="L134">        Bundle args = getArguments();</span>
<span class="nc" id="L135">        mSite = (SiteModel) args.getSerializable(WordPress.SITE);</span>
<span class="nc" id="L136">        mContentUri = args.getString(ARG_MEDIA_CONTENT_URI);</span>
<span class="nc" id="L137">        mTitle = args.getString(ARG_TITLE);</span>
<span class="nc" id="L138">        mAutoPlay = args.getBoolean(ARG_AUTOPLAY);</span>
<span class="nc" id="L139">        mVideoThumbnailUrl = args.getString(ARG_VIDEO_THUMB);</span>

<span class="nc" id="L141">        mIsVideo = MediaUtils.isVideo(mContentUri);</span>
<span class="nc" id="L142">        mIsAudio = MediaUtils.isAudio(mContentUri);</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L145">            mPosition = savedInstanceState.getInt(ARG_POSITION, 0);</span>
        }
<span class="nc" id="L147">    }</span>

    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L151">        super.onCreateView(inflater, container, savedInstanceState);</span>

<span class="nc" id="L153">        View view = inflater.inflate(R.layout.media_preview_fragment, container, false);</span>

<span class="nc" id="L155">        mImageView = view.findViewById(R.id.image_preview);</span>
<span class="nc" id="L156">        mExoPlayerView = view.findViewById(R.id.video_preview);</span>
<span class="nc" id="L157">        mExoPlayerArtworkView = mExoPlayerView.findViewById(R.id.exo_artwork);</span>
<span class="nc" id="L158">        mExoPlayerControlsView = view.findViewById(R.id.controls);</span>

<span class="nc" id="L160">        FrameLayout videoFrame = view.findViewById(R.id.frame_video);</span>
<span class="nc" id="L161">        RelativeLayout audioFrame = view.findViewById(R.id.frame_audio);</span>

<span class="nc bnc" id="L163" title="All 2 branches missed.">        videoFrame.setVisibility(mIsVideo ? View.VISIBLE : View.GONE);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        audioFrame.setVisibility(mIsAudio ? View.VISIBLE : View.GONE);</span>

<span class="nc bnc" id="L166" title="All 4 branches missed.">        if (mIsAudio &amp;&amp; !TextUtils.isEmpty(mTitle)) {</span>
<span class="nc" id="L167">            TextView txtAudioTitle = view.findViewById(R.id.text_audio_title);</span>
<span class="nc" id="L168">            txtAudioTitle.setText(mTitle);</span>
<span class="nc" id="L169">            txtAudioTitle.setVisibility(View.VISIBLE);</span>
        }

<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (showAudioOrVideo()) {</span>
<span class="nc" id="L173">            View.OnClickListener listener = v -&gt; {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                if (mMediaTapListener != null) {</span>
<span class="nc" id="L175">                    mMediaTapListener.onMediaTapped();</span>
                }
<span class="nc" id="L177">            };</span>
<span class="nc" id="L178">            audioFrame.setOnClickListener(listener);</span>
<span class="nc" id="L179">            videoFrame.setOnClickListener(listener);</span>
        }

<span class="nc" id="L182">        return view;</span>
    }

    @Override
    public void onStart() {
<span class="nc" id="L187">        super.onStart();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (showAudioOrVideo()) {</span>
<span class="nc" id="L189">            initializePlayer();</span>
        }
<span class="nc" id="L191">    }</span>

    @Override
    public void onStop() {
<span class="nc" id="L195">        super.onStop();</span>
<span class="nc bnc" id="L196" title="All 4 branches missed.">        if (showAudioOrVideo() || mPlayer != null) {</span>
<span class="nc" id="L197">            releasePlayer();</span>
        }
<span class="nc" id="L199">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L203">        super.onPause();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (mPlayer != null) releasePlayer();</span>
<span class="nc" id="L205">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L209">        super.onResume();</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (showAudioOrVideo()) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (mPlayer == null) initializePlayer();</span>
        } else {
<span class="nc" id="L213">            loadImage(mContentUri, mImageView);</span>
        }
<span class="nc" id="L215">    }</span>

    @Override
    public void onSaveInstanceState(@NonNull Bundle outState) {
<span class="nc" id="L219">        super.onSaveInstanceState(outState);</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (showAudioOrVideo()) {</span>
<span class="nc" id="L222">            outState.putInt(ARG_POSITION, mPosition);</span>
        }
<span class="nc" id="L224">    }</span>

    void setOnMediaTappedListener(OnMediaTappedListener listener) {
<span class="nc" id="L227">        mMediaTapListener = listener;</span>
<span class="nc" id="L228">    }</span>

    private void showProgress(boolean show) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            getView().findViewById(R.id.progress).setVisibility(show ? View.VISIBLE : View.GONE);</span>
        }
<span class="nc" id="L234">    }</span>

    private void showLoadingError() {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L238">            getView().findViewById(R.id.text_error).setVisibility(View.VISIBLE);</span>
        }
<span class="nc" id="L240">    }</span>

    /*
     * loads and displays a remote or local image
     */
    private void loadImage(String mediaUri, ImageView imageView) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (imageView == null) {</span>
<span class="nc" id="L247">            return;</span>
        }

<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (TextUtils.isEmpty(mediaUri)) {</span>
<span class="nc" id="L251">            showLoadingError();</span>
<span class="nc" id="L252">            return;</span>
        }

<span class="nc" id="L255">        imageView.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L256" title="All 6 branches missed.">        if ((mSite == null || SiteUtils.isPhotonCapable(mSite)) &amp;&amp; !UrlUtils.isContentUri(mediaUri)) {</span>
<span class="nc" id="L257">            int maxWidth = Math.max(DisplayUtils.getWindowPixelWidth(requireActivity()),</span>
<span class="nc" id="L258">                    DisplayUtils.getWindowPixelHeight(requireActivity()));</span>

<span class="nc bnc" id="L260" title="All 4 branches missed.">            boolean isPrivateAtomicSite = mSite != null &amp;&amp; mSite.isPrivateWPComAtomic();</span>
<span class="nc" id="L261">            mediaUri = PhotonUtils.getPhotonImageUrl(mediaUri, maxWidth, 0, isPrivateAtomicSite);</span>
        }
<span class="nc" id="L263">        showProgress(true);</span>

<span class="nc" id="L265">        mImageManager.loadWithResultListener(imageView, ImageType.IMAGE, Uri.parse(mediaUri), ScaleType.CENTER, null,</span>
<span class="nc" id="L266">                new RequestListener&lt;Drawable&gt;() {</span>
                    @Override
                    public void onResourceReady(@NonNull Drawable resource, @Nullable Object model) {
<span class="nc bnc" id="L269" title="All 2 branches missed.">                        if (isAdded()) {</span>
<span class="nc" id="L270">                            PhotoViewAttacher attacher = mImageView.getAttacher();</span>
<span class="nc" id="L271">                            attacher.setOnViewTapListener((view, x, y) -&gt; {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                                if (mMediaTapListener != null) {</span>
<span class="nc" id="L273">                                    mMediaTapListener.onMediaTapped();</span>
                                }
<span class="nc" id="L275">                            });</span>
<span class="nc" id="L276">                            showProgress(false);</span>
                        }
<span class="nc" id="L278">                    }</span>

                    @Override
                    public void onLoadFailed(@Nullable Exception e, @Nullable Object model) {
<span class="nc bnc" id="L282" title="All 2 branches missed.">                        if (isAdded()) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                            if (e != null) {</span>
<span class="nc" id="L284">                                AppLog.e(T.MEDIA, e);</span>
                            }
<span class="nc" id="L286">                            showProgress(false);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                            if (!mIsVideo) {</span>
<span class="nc" id="L288">                                showLoadingError();</span>
                            }
                        }
<span class="nc" id="L291">                    }</span>
                });
<span class="nc" id="L293">    }</span>

    private void initializePlayer() {
<span class="nc" id="L296">        mPlayer = (new SimpleExoPlayer.Builder(requireContext())).build();</span>
<span class="nc" id="L297">        mPlayer.addListener(new PlayerEventListener());</span>

<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (mIsVideo) {</span>
<span class="nc bnc" id="L300" title="All 4 branches missed.">            if (!mAutoPlay &amp;&amp; !TextUtils.isEmpty(mVideoThumbnailUrl)) {</span>
<span class="nc" id="L301">                loadImage(mVideoThumbnailUrl, mExoPlayerArtworkView);</span>
            }
<span class="nc" id="L303">            mExoPlayerView.setPlayer(mPlayer);</span>
<span class="nc" id="L304">            mExoPlayerView.requestFocus();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        } else if (mIsAudio) {</span>
<span class="nc" id="L306">            mExoPlayerControlsView.setPlayer(mPlayer);</span>
<span class="nc" id="L307">            mExoPlayerControlsView.requestFocus();</span>
        }

<span class="nc" id="L310">        Uri uri = Uri.parse(mContentUri);</span>
<span class="nc" id="L311">        mPlayer.setPlayWhenReady(mAutoPlay);</span>
<span class="nc" id="L312">        mPlayer.seekTo(0, mPosition);</span>

<span class="nc" id="L314">        MediaSource mediaSource = mExoPlayerUtils.buildMediaSource(uri);</span>
<span class="nc" id="L315">        showProgress(true);</span>
<span class="nc" id="L316">        mPlayer.prepare(mediaSource);</span>
<span class="nc" id="L317">    }</span>

    private void releasePlayer() {
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (mPlayer == null) {</span>
<span class="nc" id="L321">            return;</span>
        }
<span class="nc" id="L323">        mPosition = (int) mPlayer.getCurrentPosition();</span>
<span class="nc" id="L324">        mPlayer.release();</span>
<span class="nc" id="L325">        mPlayer = null;</span>
<span class="nc" id="L326">    }</span>

    boolean showAudioOrVideo() {
<span class="nc bnc" id="L329" title="All 4 branches missed.">        return mIsVideo || mIsAudio;</span>
    }

<span class="nc" id="L332">    private class PlayerEventListener implements Player.EventListener {</span>
        @Override public void onLoadingChanged(boolean isLoading) {
<span class="nc" id="L334">            showProgress(isLoading);</span>
<span class="nc" id="L335">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>