<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderDiscoverFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.discover</a> &gt; <span class="el_source">ReaderDiscoverFragment.kt</span></div><h1>ReaderDiscoverFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.discover

import android.app.Activity
import android.content.Intent
import android.os.Bundle
import android.view.View
import androidx.appcompat.app.AlertDialog
import androidx.lifecycle.ViewModelProvider
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.R.dimen
import org.wordpress.android.WordPress
import org.wordpress.android.databinding.ReaderDiscoverFragmentLayoutBinding
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.RequestCodes
import org.wordpress.android.ui.ViewPagerFragment
import org.wordpress.android.ui.main.SitePickerActivity
import org.wordpress.android.ui.mysite.SelectedSiteRepository
import org.wordpress.android.ui.pages.SnackbarMessageHolder
import org.wordpress.android.ui.reader.ReaderActivityLauncher
import org.wordpress.android.ui.reader.ReaderActivityLauncher.OpenUrlType
import org.wordpress.android.ui.reader.ReaderPostWebViewCachingFragment
import org.wordpress.android.ui.reader.comments.ThreadedCommentsActionSource.READER_POST_CARD
import org.wordpress.android.ui.reader.discover.ReaderDiscoverViewModel.DiscoverUiState.ContentUiState
import org.wordpress.android.ui.reader.discover.ReaderDiscoverViewModel.DiscoverUiState.EmptyUiState
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.OpenEditorForReblog
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.OpenPost
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.SharePost
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowBlogPreview
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowBookmarkedSavedOnlyLocallyDialog
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowBookmarkedTab
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowNoSitesToReblog
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowPostDetail
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowPostsByTag
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowReaderComments
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowReaderSubs
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowReportPost
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowSitePickerForResult
import org.wordpress.android.ui.reader.discover.ReaderNavigationEvents.ShowVideoViewer
import org.wordpress.android.ui.reader.tracker.ReaderTracker
import org.wordpress.android.ui.reader.usecases.BookmarkPostState.PreLoadPostContent
import org.wordpress.android.ui.reader.utils.ReaderUtilsWrapper
import org.wordpress.android.ui.reader.viewmodels.ReaderViewModel
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.WPSwipeToRefreshHelper
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.widgets.RecyclerItemDecoration
import org.wordpress.android.widgets.WPSnackbar
import javax.inject.Inject

<span class="nc" id="L55">class ReaderDiscoverFragment : ViewPagerFragment(R.layout.reader_discover_fragment_layout) {</span>
    private var bookmarksSavedLocallyDialog: AlertDialog? = null
<span class="nc bnc" id="L57" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">    @Inject lateinit var uiHelpers: UiHelpers</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">    @Inject lateinit var imageManager: ImageManager</span>
    private lateinit var viewModel: ReaderDiscoverViewModel
<span class="nc bnc" id="L61" title="All 2 branches missed.">    @Inject lateinit var readerUtilsWrapper: ReaderUtilsWrapper</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">    @Inject lateinit var readerTracker: ReaderTracker</span>
    private lateinit var parentViewModel: ReaderViewModel

    private var binding: ReaderDiscoverFragmentLayoutBinding? = null

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L68">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc" id="L70">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L73">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L74">        binding = ReaderDiscoverFragmentLayoutBinding.bind(view).apply {</span>
<span class="nc" id="L75">            recyclerView.layoutManager = LinearLayoutManager(context, RecyclerView.VERTICAL, false)</span>
<span class="nc" id="L76">            recyclerView.adapter = ReaderDiscoverAdapter(uiHelpers, imageManager, readerTracker)</span>

<span class="nc" id="L78">            val spacingHorizontal = resources.getDimensionPixelSize(dimen.reader_card_margin)</span>
<span class="nc" id="L79">            val spacingVertical = resources.getDimensionPixelSize(dimen.reader_card_gutters)</span>
<span class="nc" id="L80">            recyclerView.addItemDecoration(RecyclerItemDecoration(spacingHorizontal, spacingVertical, false))</span>

<span class="nc bnc" id="L82" title="All 2 branches missed.">            WPSwipeToRefreshHelper.buildSwipeToRefreshHelper(ptrLayout) { viewModel.swipeToRefresh() }</span>

<span class="nc" id="L84">            initViewModel()</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">    }</span>

    private fun ReaderDiscoverFragmentLayoutBinding.initViewModel() {
<span class="nc" id="L89">        viewModel = ViewModelProvider(this@ReaderDiscoverFragment, viewModelFactory)</span>
<span class="nc" id="L90">                .get(ReaderDiscoverViewModel::class.java)</span>
<span class="nc" id="L91">        parentViewModel = ViewModelProvider(requireParentFragment()).get(ReaderViewModel::class.java)</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        viewModel.uiState.observe(viewLifecycleOwner, {</span>
<span class="nc" id="L94">            when (it) {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                is ContentUiState -&gt; {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                    (recyclerView.adapter as ReaderDiscoverAdapter).update(it.cards)</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                    if (it.scrollToTop) {</span>
<span class="nc" id="L98">                        recyclerView.scrollToPosition(0)</span>
                    }
                }
<span class="nc bnc" id="L101" title="All 2 branches missed.">                is EmptyUiState -&gt; {</span>
<span class="nc" id="L102">                    uiHelpers.setTextOrHide(actionableEmptyView.title, it.titleResId)</span>
<span class="nc" id="L103">                    uiHelpers.setTextOrHide(actionableEmptyView.subtitle, it.subTitleRes)</span>
<span class="nc" id="L104">                    uiHelpers.setImageOrHide(actionableEmptyView.image, it.illustrationResId)</span>
<span class="nc" id="L105">                    uiHelpers.setTextOrHide(actionableEmptyView.button, it.buttonResId)</span>
<span class="nc" id="L106">                    actionableEmptyView.button.setOnClickListener { _ -&gt; it.action.invoke() }</span>
                }
            }

<span class="nc" id="L110">            uiHelpers.updateVisibility(recyclerView, it.contentVisiblity)</span>
<span class="nc" id="L111">            uiHelpers.updateVisibility(progressBar, it.fullscreenProgressVisibility)</span>
<span class="nc" id="L112">            uiHelpers.updateVisibility(progressText, it.fullscreenProgressVisibility)</span>
<span class="nc" id="L113">            uiHelpers.updateVisibility(progressLoadingMore, it.loadMoreProgressVisibility)</span>
<span class="nc" id="L114">            uiHelpers.updateVisibility(actionableEmptyView, it.fullscreenEmptyVisibility)</span>
<span class="nc" id="L115">            ptrLayout.isEnabled = it.swipeToRefreshEnabled</span>
<span class="nc" id="L116">            ptrLayout.isRefreshing = it.reloadProgressVisibility</span>
<span class="nc" id="L117">        })</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        viewModel.navigationEvents.observeEvent(viewLifecycleOwner) { handleNavigation(it) }</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        viewModel.snackbarEvents.observeEvent(viewLifecycleOwner, { it.showSnackbar() })</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        viewModel.preloadPostEvents.observeEvent(viewLifecycleOwner, { it.addWebViewCachingFragment() })</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">        viewModel.start(parentViewModel)</span>
<span class="nc" id="L122">    }</span>

    @Suppress(&quot;ComplexMethod&quot;)
<span class="nc" id="L125">    private fun handleNavigation(event: ReaderNavigationEvents) = when (event) {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        is ShowPostDetail -&gt; ReaderActivityLauncher.showReaderPostDetail(context, event.post.blogId, event.post.postId)</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        is SharePost -&gt; ReaderActivityLauncher.sharePost(context, event.post)</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        is OpenPost -&gt; ReaderActivityLauncher.openPost(context, event.post)</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        is ShowReaderComments -&gt; ReaderActivityLauncher.showReaderComments(</span>
<span class="nc" id="L130">                context,</span>
<span class="nc" id="L131">                event.blogId,</span>
<span class="nc" id="L132">                event.postId,</span>
<span class="nc" id="L133">                READER_POST_CARD.sourceDescription</span>
        )
<span class="nc bnc" id="L135" title="All 2 branches missed.">        is ShowNoSitesToReblog -&gt; ReaderActivityLauncher.showNoSiteToReblog(activity)</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        is ShowSitePickerForResult -&gt; ActivityLauncher.showSitePickerForResult(</span>
<span class="nc" id="L137">                this@ReaderDiscoverFragment,</span>
<span class="nc" id="L138">                event.preselectedSite,</span>
<span class="nc" id="L139">                event.mode</span>
        )
<span class="nc bnc" id="L141" title="All 2 branches missed.">        is OpenEditorForReblog -&gt; ActivityLauncher.openEditorForReblog(activity, event.site, event.post, event.source)</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        is ShowBookmarkedTab -&gt; ActivityLauncher.viewSavedPostsListInReader(activity)</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        is ShowBookmarkedSavedOnlyLocallyDialog -&gt; showBookmarkSavedLocallyDialog(event)</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        is ShowPostsByTag -&gt; ReaderActivityLauncher.showReaderTagPreview(</span>
<span class="nc" id="L145">                context,</span>
<span class="nc" id="L146">                event.tag,</span>
<span class="nc" id="L147">                ReaderTracker.SOURCE_DISCOVER,</span>
<span class="nc" id="L148">                readerTracker</span>
        )
<span class="nc bnc" id="L150" title="All 2 branches missed.">        is ShowVideoViewer -&gt; ReaderActivityLauncher.showReaderVideoViewer(context, event.videoUrl)</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        is ShowBlogPreview -&gt; ReaderActivityLauncher.showReaderBlogOrFeedPreview(</span>
<span class="nc" id="L152">                context,</span>
<span class="nc" id="L153">                event.siteId,</span>
<span class="nc" id="L154">                event.feedId,</span>
<span class="nc" id="L155">                event.isFollowed,</span>
<span class="nc" id="L156">                ReaderTracker.SOURCE_DISCOVER,</span>
<span class="nc" id="L157">                readerTracker</span>
        )
<span class="nc bnc" id="L159" title="All 2 branches missed.">        is ShowReportPost -&gt; ReaderActivityLauncher.openUrl(</span>
<span class="nc" id="L160">                context,</span>
<span class="nc" id="L161">                readerUtilsWrapper.getReportPostUrl(event.url),</span>
<span class="nc" id="L162">                OpenUrlType.INTERNAL</span>
        )
<span class="nc bnc" id="L164" title="All 2 branches missed.">        is ShowReaderSubs -&gt; ReaderActivityLauncher.showReaderSubs(context)</span>
<span class="nc" id="L165">        else -&gt; Unit // Do Nothing</span>
<span class="nc" id="L166">    }</span>

    private fun showBookmarkSavedLocallyDialog(bookmarkDialog: ShowBookmarkedSavedOnlyLocallyDialog) {
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (bookmarksSavedLocallyDialog == null) {</span>
<span class="nc" id="L170">            MaterialAlertDialogBuilder(requireActivity())</span>
<span class="nc" id="L171">                    .setTitle(getString(bookmarkDialog.title))</span>
<span class="nc" id="L172">                    .setMessage(getString(bookmarkDialog.message))</span>
<span class="nc" id="L173">                    .setPositiveButton(getString(bookmarkDialog.buttonLabel)) { _, _ -&gt;</span>
<span class="nc" id="L174">                        bookmarkDialog.okButtonAction.invoke()</span>
<span class="nc" id="L175">                    }</span>
<span class="nc" id="L176">                    .setOnDismissListener {</span>
<span class="nc" id="L177">                        bookmarksSavedLocallyDialog = null</span>
<span class="nc" id="L178">                    }</span>
<span class="nc" id="L179">                    .setCancelable(false)</span>
<span class="nc" id="L180">                    .create()</span>
<span class="nc" id="L181">                    .let {</span>
<span class="nc" id="L182">                        bookmarksSavedLocallyDialog = it</span>
<span class="nc" id="L183">                        it.show()</span>
<span class="nc" id="L184">                    }</span>
        }
<span class="nc" id="L186">    }</span>

    private fun SnackbarMessageHolder.showSnackbar() {
<span class="nc bnc" id="L189" title="All 4 branches missed.">        activity?.findViewById&lt;View&gt;(R.id.coordinator)?.let { coordinator -&gt;</span>
<span class="nc" id="L190">            val snackbar = WPSnackbar.make(</span>
<span class="nc" id="L191">                    coordinator,</span>
<span class="nc" id="L192">                    uiHelpers.getTextOfUiString(requireContext(), this.message),</span>
<span class="nc" id="L193">                    Snackbar.LENGTH_LONG</span>
            )
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (this.buttonTitle != null) {</span>
<span class="nc" id="L196">                snackbar.setAction(uiHelpers.getTextOfUiString(requireContext(), this.buttonTitle)) {</span>
<span class="nc" id="L197">                    this.buttonAction.invoke()</span>
<span class="nc" id="L198">                }</span>
            }
<span class="nc" id="L200">            snackbar.show()</span>
<span class="nc" id="L201">        }</span>
<span class="nc" id="L202">    }</span>

    private fun PreLoadPostContent.addWebViewCachingFragment() {
<span class="nc" id="L205">        val tag = &quot;$blogId$postId&quot;</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (parentFragmentManager.findFragmentByTag(tag) == null) {</span>
<span class="nc" id="L208">            parentFragmentManager.beginTransaction()</span>
<span class="nc" id="L209">                    .add(ReaderPostWebViewCachingFragment.newInstance(blogId, postId), tag)</span>
<span class="nc" id="L210">                    .commit()</span>
        }
<span class="nc" id="L212">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L215">        super.onDestroyView()</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        bookmarksSavedLocallyDialog?.dismiss()</span>
<span class="nc" id="L217">        binding = null</span>
<span class="nc" id="L218">    }</span>

    override fun getScrollableViewForUniqueIdProvision(): View? {
<span class="nc bnc" id="L221" title="All 2 branches missed.">        return binding?.recyclerView</span>
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
<span class="nc" id="L225">        super.onActivityResult(requestCode, resultCode, data)</span>
<span class="nc bnc" id="L226" title="All 6 branches missed.">        if (requestCode == RequestCodes.SITE_PICKER &amp;&amp; resultCode == Activity.RESULT_OK &amp;&amp; data != null) {</span>
<span class="nc" id="L227">            val siteLocalId = data.getIntExtra(</span>
<span class="nc" id="L228">                    SitePickerActivity.KEY_SITE_LOCAL_ID,</span>
<span class="nc" id="L229">                    SelectedSiteRepository.UNAVAILABLE</span>
            )
<span class="nc bnc" id="L231" title="All 2 branches missed.">            viewModel.onReblogSiteSelected(siteLocalId)</span>
        }
<span class="nc" id="L233">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>