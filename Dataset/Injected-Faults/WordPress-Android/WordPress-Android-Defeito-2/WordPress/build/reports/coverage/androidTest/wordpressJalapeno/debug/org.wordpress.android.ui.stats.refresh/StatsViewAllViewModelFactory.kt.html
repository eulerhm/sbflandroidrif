<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatsViewAllViewModelFactory.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stats.refresh</a> &gt; <span class="el_source">StatsViewAllViewModelFactory.kt</span></div><h1>StatsViewAllViewModelFactory.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stats.refresh

import androidx.annotation.StringRes
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import kotlinx.coroutines.CoroutineDispatcher
import org.wordpress.android.R
import org.wordpress.android.fluxc.network.utils.StatsGranularity
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.stats.StatsViewType
import org.wordpress.android.ui.stats.StatsViewType.ANNUAL_STATS
import org.wordpress.android.ui.stats.StatsViewType.AUTHORS
import org.wordpress.android.ui.stats.StatsViewType.CLICKS
import org.wordpress.android.ui.stats.StatsViewType.DETAIL_AVERAGE_VIEWS_PER_DAY
import org.wordpress.android.ui.stats.StatsViewType.DETAIL_MONTHS_AND_YEARS
import org.wordpress.android.ui.stats.StatsViewType.DETAIL_RECENT_WEEKS
import org.wordpress.android.ui.stats.StatsViewType.FILE_DOWNLOADS
import org.wordpress.android.ui.stats.StatsViewType.FOLLOWERS
import org.wordpress.android.ui.stats.StatsViewType.GEOVIEWS
import org.wordpress.android.ui.stats.StatsViewType.INSIGHTS_ALL_TIME
import org.wordpress.android.ui.stats.StatsViewType.INSIGHTS_LATEST_POST_SUMMARY
import org.wordpress.android.ui.stats.StatsViewType.INSIGHTS_MOST_POPULAR
import org.wordpress.android.ui.stats.StatsViewType.INSIGHTS_TODAY
import org.wordpress.android.ui.stats.StatsViewType.INSIGHTS_VIEWS_AND_VISITORS
import org.wordpress.android.ui.stats.StatsViewType.PUBLICIZE
import org.wordpress.android.ui.stats.StatsViewType.REFERRERS
import org.wordpress.android.ui.stats.StatsViewType.SEARCH_TERMS
import org.wordpress.android.ui.stats.StatsViewType.TAGS_AND_CATEGORIES
import org.wordpress.android.ui.stats.StatsViewType.TOP_POSTS_AND_PAGES
import org.wordpress.android.ui.stats.StatsViewType.VIDEO_PLAYS
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection
import org.wordpress.android.ui.stats.refresh.lists.StatsListViewModel.StatsSection.INSIGHTS
import org.wordpress.android.ui.stats.refresh.lists.detail.PostAverageViewsPerDayUseCase
import org.wordpress.android.ui.stats.refresh.lists.detail.PostMonthsAndYearsUseCase
import org.wordpress.android.ui.stats.refresh.lists.detail.PostRecentWeeksUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.BaseStatsUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.BaseStatsUseCase.UseCaseMode.VIEW_ALL
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.GranularUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.usecases.AuthorsUseCase.AuthorsUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.usecases.ClicksUseCase.ClicksUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.usecases.CountryViewsUseCase.CountryViewsUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.usecases.FileDownloadsUseCase.FileDownloadsUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.usecases.PostsAndPagesUseCase.PostsAndPagesUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.usecases.ReferrersUseCase.ReferrersUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.usecases.SearchTermsUseCase.SearchTermsUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.granular.usecases.VideoPlaysUseCase.VideoPlaysUseCaseFactory
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.AllTimeStatsUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.AnnualSiteStatsUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.FollowersUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.LatestPostSummaryUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.MostPopularInsightsUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.PublicizeUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.TagsAndCategoriesUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.TodayStatsUseCase
import org.wordpress.android.ui.stats.refresh.lists.sections.insights.usecases.ViewsAndVisitorsUseCase
import org.wordpress.android.ui.stats.refresh.utils.StatsDateSelector
import org.wordpress.android.ui.stats.refresh.utils.StatsSiteProvider
import org.wordpress.android.ui.stats.refresh.utils.toStatsSection
import java.security.InvalidParameterException
import javax.inject.Inject
import javax.inject.Named

<span class="nc" id="L64">class StatsViewAllViewModelFactory(</span>
<span class="nc" id="L65">    private val mainDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L66">    private val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L67">    private val useCase: BaseStatsUseCase&lt;*, *&gt;,</span>
<span class="nc" id="L68">    private val statsSiteProvider: StatsSiteProvider,</span>
<span class="nc" id="L69">    private val dateSelector: StatsDateSelector,</span>
<span class="nc" id="L70">    @StringRes private val titleResource: Int</span>
) : ViewModelProvider.Factory {
    override fun &lt;T : ViewModel&gt; create(modelClass: Class&lt;T&gt;): T {
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (modelClass.isAssignableFrom(StatsViewAllViewModel::class.java)) {</span>
            @Suppress(&quot;UNCHECKED_CAST&quot;)
<span class="nc" id="L75">            return StatsViewAllViewModel(</span>
<span class="nc" id="L76">                    mainDispatcher,</span>
<span class="nc" id="L77">                    bgDispatcher,</span>
<span class="nc" id="L78">                    useCase,</span>
<span class="nc" id="L79">                    statsSiteProvider,</span>
<span class="nc" id="L80">                    dateSelector,</span>
<span class="nc" id="L81">                    titleResource</span>
            ) as T
        } else {
<span class="nc" id="L84">            throw IllegalArgumentException(&quot;ViewModel Not Found&quot;)</span>
        }
    }

<span class="nc" id="L88">    class Builder @Inject constructor(</span>
<span class="nc" id="L89">        @Named(UI_THREAD) private val mainDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L90">        @Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L91">        @Named(GRANULAR_USE_CASE_FACTORIES)</span>
        private val granularFactories: List&lt;@JvmSuppressWildcards GranularUseCaseFactory&gt;,
<span class="nc" id="L93">        @Named(VIEW_ALL_INSIGHTS_USE_CASES)</span>
        private val insightsUseCases: List&lt;@JvmSuppressWildcards BaseStatsUseCase&lt;*, *&gt;&gt;,
<span class="nc" id="L95">        private val statsSiteProvider: StatsSiteProvider,</span>
<span class="nc" id="L96">        private val dateSelectorFactory: StatsDateSelector.Factory</span>
    ) {
        fun build(type: StatsViewType, granularity: StatsGranularity?): StatsViewAllViewModelFactory {
<span class="nc" id="L99">            return when {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                type == ANNUAL_STATS -&gt; buildAnnualStatsFactory()</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                granularity == null -&gt; buildFactory(type)</span>
<span class="nc" id="L102">                else -&gt; buildFactory(type, granularity)</span>
            }
        }

        private fun buildFactory(type: StatsViewType, granularity: StatsGranularity): StatsViewAllViewModelFactory {
<span class="nc" id="L107">            val (useCase, title) = getGranularUseCase(type, granularity, granularFactories)</span>
<span class="nc" id="L108">            return StatsViewAllViewModelFactory(</span>
<span class="nc" id="L109">                    mainDispatcher,</span>
<span class="nc" id="L110">                    bgDispatcher,</span>
<span class="nc" id="L111">                    useCase,</span>
<span class="nc" id="L112">                    statsSiteProvider,</span>
<span class="nc" id="L113">                    dateSelectorFactory.build(granularity.toStatsSection()),</span>
<span class="nc" id="L114">                    title</span>
            )
        }

        private fun buildFactory(type: StatsViewType): StatsViewAllViewModelFactory {
<span class="nc" id="L119">            val (useCase, title) = getInsightsUseCase(type, insightsUseCases)</span>
<span class="nc" id="L120">            return StatsViewAllViewModelFactory(</span>
<span class="nc" id="L121">                    mainDispatcher,</span>
<span class="nc" id="L122">                    bgDispatcher,</span>
<span class="nc" id="L123">                    useCase,</span>
<span class="nc" id="L124">                    statsSiteProvider,</span>
<span class="nc" id="L125">                    dateSelectorFactory.build(INSIGHTS),</span>
<span class="nc" id="L126">                    title</span>
            )
        }

        private fun buildAnnualStatsFactory(): StatsViewAllViewModelFactory {
<span class="nc bnc" id="L131" title="All 6 branches missed.">            val useCase = insightsUseCases.find {</span>
<span class="nc" id="L132">                it is AnnualSiteStatsUseCase</span>
            } as AnnualSiteStatsUseCase
<span class="nc" id="L134">            return StatsViewAllViewModelFactory(</span>
<span class="nc" id="L135">                    mainDispatcher,</span>
<span class="nc" id="L136">                    bgDispatcher,</span>
<span class="nc" id="L137">                    useCase,</span>
<span class="nc" id="L138">                    statsSiteProvider,</span>
<span class="nc" id="L139">                    dateSelectorFactory.build(StatsSection.ANNUAL_STATS),</span>
<span class="nc" id="L140">                    R.string.stats_insights_annual_site_stats</span>
            )
        }

        private fun getGranularUseCase(
            type: StatsViewType,
            granularity: StatsGranularity,
            granularFactories: List&lt;GranularUseCaseFactory&gt;
        ): Pair&lt;BaseStatsUseCase&lt;*, *&gt;, Int&gt; {
<span class="nc bnc" id="L149" title="All 9 branches missed.">            return when (type) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                TOP_POSTS_AND_PAGES -&gt; Pair(granularFactories.first { it is PostsAndPagesUseCaseFactory }</span>
<span class="nc" id="L151">                        .build(granularity, VIEW_ALL), R.string.stats_view_top_posts_and_pages)</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                REFERRERS -&gt; Pair(granularFactories.first { it is ReferrersUseCaseFactory }</span>
<span class="nc" id="L153">                        .build(granularity, VIEW_ALL), R.string.stats_view_referrers)</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                CLICKS -&gt; Pair(granularFactories.first { it is ClicksUseCaseFactory }</span>
<span class="nc" id="L155">                        .build(granularity, VIEW_ALL), R.string.stats_view_clicks)</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                AUTHORS -&gt; Pair(granularFactories.first { it is AuthorsUseCaseFactory }</span>
<span class="nc" id="L157">                        .build(granularity, VIEW_ALL), R.string.stats_view_authors)</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                GEOVIEWS -&gt; Pair(granularFactories.first { it is CountryViewsUseCaseFactory }</span>
<span class="nc" id="L159">                        .build(granularity, VIEW_ALL), R.string.stats_view_countries)</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                SEARCH_TERMS -&gt; Pair(granularFactories.first { it is SearchTermsUseCaseFactory }</span>
<span class="nc" id="L161">                        .build(granularity, VIEW_ALL), R.string.stats_view_search_terms)</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                VIDEO_PLAYS -&gt; Pair(granularFactories.first { it is VideoPlaysUseCaseFactory }</span>
<span class="nc" id="L163">                        .build(granularity, VIEW_ALL), R.string.stats_view_videos)</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                FILE_DOWNLOADS -&gt; Pair(granularFactories.first { it is FileDownloadsUseCaseFactory }</span>
<span class="nc" id="L165">                        .build(granularity, VIEW_ALL), R.string.stats_file_downloads)</span>
<span class="nc" id="L166">                else -&gt; throw InvalidParameterException(&quot;Invalid granular stats type: ${type.name}&quot;)</span>
            }
        }

        private fun getInsightsUseCase(
            type: StatsViewType,
            insightsUseCases: List&lt;BaseStatsUseCase&lt;*, *&gt;&gt;
        ): Pair&lt;BaseStatsUseCase&lt;*, *&gt;, Int&gt; {
<span class="nc bnc" id="L174" title="All 12 branches missed.">            return when (type) {</span>
<span class="nc" id="L175">                INSIGHTS_VIEWS_AND_VISITORS -&gt; Pair(</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                        insightsUseCases.first { it is ViewsAndVisitorsUseCase },</span>
<span class="nc" id="L177">                        R.string.stats_insights_views_and_visitors</span>
                )
<span class="nc" id="L179">                FOLLOWERS -&gt; Pair(</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                        insightsUseCases.first { it is FollowersUseCase },</span>
<span class="nc" id="L181">                        R.string.stats_view_followers</span>
                )
<span class="nc" id="L183">                TAGS_AND_CATEGORIES -&gt; Pair(</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                        insightsUseCases.first { it is TagsAndCategoriesUseCase },</span>
<span class="nc" id="L185">                        R.string.stats_view_tags_and_categories</span>
                )
<span class="nc" id="L187">                INSIGHTS_ALL_TIME -&gt; Pair(</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                        insightsUseCases.first { it is AllTimeStatsUseCase },</span>
<span class="nc" id="L189">                        R.string.stats_insights_all_time_stats</span>
                )
<span class="nc" id="L191">                INSIGHTS_LATEST_POST_SUMMARY -&gt; Pair(</span>
<span class="nc" id="L192">                        insightsUseCases</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                                .first { it is LatestPostSummaryUseCase }, R.string.stats_insights_latest_post_summary</span>
                )
<span class="nc" id="L195">                INSIGHTS_MOST_POPULAR -&gt; Pair(</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                        insightsUseCases.first { it is MostPopularInsightsUseCase },</span>
<span class="nc" id="L197">                        R.string.stats_insights_popular</span>
                )
<span class="nc" id="L199">                INSIGHTS_TODAY -&gt; Pair(</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                        insightsUseCases.first { it is TodayStatsUseCase },</span>
<span class="nc" id="L201">                        R.string.stats_insights_today</span>
                )
<span class="nc" id="L203">                PUBLICIZE -&gt; Pair(</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                        insightsUseCases.first { it is PublicizeUseCase },</span>
<span class="nc" id="L205">                        R.string.stats_view_publicize</span>
                )
                DETAIL_MONTHS_AND_YEARS -&gt;
<span class="nc" id="L208">                    insightsUseCases.first {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                        it is PostMonthsAndYearsUseCase</span>
<span class="nc" id="L210">                    } to R.string.stats_detail_months_and_years</span>
                DETAIL_AVERAGE_VIEWS_PER_DAY -&gt;
<span class="nc" id="L212">                    insightsUseCases.first {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                        it is PostAverageViewsPerDayUseCase</span>
<span class="nc" id="L214">                    } to R.string.stats_detail_average_views_per_day</span>
                DETAIL_RECENT_WEEKS -&gt;
<span class="nc" id="L216">                    insightsUseCases.first {</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                        it is PostRecentWeeksUseCase</span>
<span class="nc" id="L218">                    } to R.string.stats_detail_recent_weeks</span>
<span class="nc" id="L219">                else -&gt; throw InvalidParameterException(&quot;Invalid insights stats type: ${type.name}&quot;)</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>