<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaUtilsWrapper.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">MediaUtilsWrapper.kt</span></div><h1>MediaUtilsWrapper.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.util

import android.content.Context
import android.media.MediaMetadataRetriever
import android.net.Uri
import dagger.Reusable
import org.wordpress.android.editor.EditorMediaUtils
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.utils.MimeTypes.Plan
import org.wordpress.android.util.AppLog.T
import java.util.concurrent.TimeUnit
import javax.inject.Inject
import kotlin.IllegalArgumentException

/**
 * Injectable wrapper around MediaUtils, WPMediaUtils, FluxC's MediaUtils &amp; EditorMediaUtils.
 *
 * MediaUtils, WPMediaUtils, FluxC's MediaUtils &amp; EditorMediaUtils interfaces are consisted of static methods, which
 * makes the client code difficult to test/mock. Main purpose of this wrapper is to make testing easier.
 */
<span class="fc" id="L21">@Reusable</span>
<span class="fc" id="L22">class MediaUtilsWrapper @Inject constructor(private val appContext: Context) {</span>
    fun getRealPathFromURI(mediaUri: Uri): String? =
<span class="nc" id="L24">            MediaUtils.getRealPathFromURI(appContext, mediaUri)</span>

<span class="nc" id="L26">    fun isVideo(mediaUri: Uri) = MediaUtils.isVideo(mediaUri.toString())</span>

<span class="nc" id="L28">    fun isVideo(mediaUriString: String) = MediaUtils.isVideo(mediaUriString)</span>

<span class="nc" id="L30">    fun getLastRecordedVideoUri(): Uri = MediaUtils.getLastRecordedVideoUri(appContext)</span>

    fun getOptimizedMedia(path: String, isVideo: Boolean): Uri? =
<span class="nc" id="L33">            WPMediaUtils.getOptimizedMedia(appContext, path, isVideo)</span>

    fun fixOrientationIssue(path: String, isVideo: Boolean): Uri? =
<span class="nc" id="L36">            WPMediaUtils.fixOrientationIssue(appContext, path, isVideo)</span>

    fun isVideoMimeType(mimeType: String?): Boolean =
<span class="nc" id="L39">        org.wordpress.android.fluxc.utils.MediaUtils.isVideoMimeType(mimeType)</span>

    fun isInMediaStore(mediaUri: Uri?): Boolean =
<span class="nc" id="L42">            MediaUtils.isInMediaStore(mediaUri)</span>

<span class="nc" id="L44">    fun copyFileToAppStorage(imageUri: Uri, headers: Map&lt;String, String&gt;? = null): Uri? =</span>
<span class="nc" id="L45">            MediaUtils.downloadExternalMedia(appContext, imageUri, headers)</span>

    fun shouldAdvertiseImageOptimization(): Boolean =
<span class="nc" id="L48">            WPMediaUtils.shouldAdvertiseImageOptimization(appContext)</span>

<span class="nc" id="L50">    fun getMimeType(uri: Uri): String? = appContext.contentResolver.getType(uri)</span>

    fun getVideoThumbnail(videoPath: String, headers: Map&lt;String, String&gt;): String? =
<span class="nc" id="L53">            EditorMediaUtils.getVideoThumbnail(appContext, videoPath, headers)</span>

<span class="nc" id="L55">    fun isLocalFile(uploadState: String): Boolean = MediaUtils.isLocalFile(uploadState)</span>

<span class="nc" id="L57">    fun getExtensionForMimeType(mimeType: String?): String = MediaUtils.getExtensionForMimeType(mimeType)</span>

<span class="nc" id="L59">    fun isFile(mediaUri: Uri): Boolean = MediaUtils.isFile(mediaUri)</span>

<span class="nc" id="L61">    fun getSitePlanForMimeTypes(site: SiteModel?): Plan = WPMediaUtils.getSitePlanForMimeTypes(site)</span>

    fun isMimeTypeSupportedBySitePlan(site: SiteModel?, mimeType: String): Boolean =
<span class="nc" id="L64">            WPMediaUtils.isMimeTypeSupportedBySitePlan(site, mimeType)</span>

    fun isVideoFile(mediaUri: Uri): Boolean =
<span class="nc bnc" id="L67" title="All 4 branches missed.">        isVideo(mediaUri) || isVideoMimeType(getMimeType(mediaUri))</span>

    fun isProhibitedVideoDuration(context: Context, site: SiteModel, uri: Uri): Boolean {
<span class="nc bnc" id="L70" title="All 6 branches missed.">        if (isVideoFile(uri) &amp;&amp; site.hasFreePlan &amp;&amp; !site.isActiveModuleEnabled(&quot;videopress&quot;)) {</span>
<span class="nc" id="L71">            val retriever = MediaMetadataRetriever()</span>

<span class="nc" id="L73">            try {</span>
<span class="nc" id="L74">                retriever.setDataSource(context, uri)</span>
<span class="nc" id="L75">            } catch (e: IllegalArgumentException) {</span>
<span class="nc" id="L76">                AppLog.d(T.MEDIA, &quot;Cannot retrieve video file $e&quot;)</span>
            }

<span class="nc bnc" id="L79" title="All 2 branches missed.">            val videoDuration = retriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_DURATION)?.toLong() ?: 0</span>
<span class="nc" id="L80">            retriever.release()</span>

<span class="nc" id="L82">            val allowedVideoDurationForFreeSites = TimeUnit.MILLISECONDS.convert(DURATION_5_MIN, TimeUnit.MINUTES)</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            return allowedVideoDurationForFreeSites &lt; videoDuration</span>
        }

<span class="nc" id="L86">        return false</span>
    }

    companion object {
        private const val DURATION_5_MIN = 5L
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>