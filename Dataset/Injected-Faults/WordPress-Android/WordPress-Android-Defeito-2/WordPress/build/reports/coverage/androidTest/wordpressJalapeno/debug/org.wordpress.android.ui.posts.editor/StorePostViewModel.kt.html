<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StorePostViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts.editor</a> &gt; <span class="el_source">StorePostViewModel.kt</span></div><h1>StorePostViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts.editor

import android.content.Context
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import org.greenrobot.eventbus.Subscribe
import org.wordpress.android.editor.gutenberg.DialogVisibility
import org.wordpress.android.editor.gutenberg.DialogVisibility.Hidden
import org.wordpress.android.editor.gutenberg.DialogVisibility.Showing
import org.wordpress.android.editor.gutenberg.DialogVisibilityProvider
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.model.PostImmutableModel
import org.wordpress.android.fluxc.model.PostModel
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.PostStore.OnPostChanged
import org.wordpress.android.fluxc.store.PostStore.OnPostUploaded
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.posts.EditPostRepository
import org.wordpress.android.ui.posts.EditPostRepository.UpdatePostResult
import org.wordpress.android.ui.posts.PostUtilsWrapper
import org.wordpress.android.ui.posts.SavePostToDbUseCase
import org.wordpress.android.ui.posts.editor.StorePostViewModel.ActivityFinishState.SAVED_LOCALLY
import org.wordpress.android.ui.posts.editor.StorePostViewModel.ActivityFinishState.SAVED_ONLINE
import org.wordpress.android.ui.posts.editor.StorePostViewModel.UpdateFromEditor.Failed
import org.wordpress.android.ui.posts.editor.StorePostViewModel.UpdateFromEditor.PostFields
import org.wordpress.android.ui.uploads.UploadServiceFacade
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.NetworkUtilsWrapper
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ScopedViewModel
import javax.inject.Inject
import javax.inject.Named

private const val CHANGE_SAVE_DELAY = 500L
private const val MAX_UNSAVED_POSTS = 50

class StorePostViewModel
<span class="nc" id="L42">@Inject constructor(</span>
<span class="nc" id="L43">    @Named(UI_THREAD) private val uiCoroutineDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L44">    private val siteStore: SiteStore,</span>
<span class="nc" id="L45">    private val postUtils: PostUtilsWrapper,</span>
<span class="nc" id="L46">    private val uploadService: UploadServiceFacade,</span>
<span class="nc" id="L47">    private val savePostToDbUseCase: SavePostToDbUseCase,</span>
<span class="nc" id="L48">    private val networkUtils: NetworkUtilsWrapper,</span>
<span class="nc" id="L49">    private val dispatcher: Dispatcher</span>
<span class="nc" id="L50">) : ScopedViewModel(uiCoroutineDispatcher), DialogVisibilityProvider {</span>
    private var debounceCounter = 0
    private var saveJob: Job? = null
<span class="nc" id="L53">    private val _onSavePostTriggered = MutableLiveData&lt;Event&lt;Unit&gt;&gt;()</span>
<span class="nc" id="L54">    val onSavePostTriggered: LiveData&lt;Event&lt;Unit&gt;&gt; = _onSavePostTriggered</span>

<span class="nc" id="L56">    private val _onFinish = MutableLiveData&lt;Event&lt;ActivityFinishState&gt;&gt;()</span>
<span class="nc" id="L57">    val onFinish: LiveData&lt;Event&lt;ActivityFinishState&gt;&gt; = _onFinish</span>

    @Volatile
<span class="nc" id="L60">    var isSavingPostOnEditorExit = false</span>

<span class="nc" id="L62">    private val _savingProgressDialogVisibility = MutableLiveData&lt;DialogVisibility&gt;().apply {</span>
<span class="nc" id="L63">        postValue(Hidden)</span>
<span class="nc" id="L64">    }</span>
<span class="nc" id="L65">    override val savingInProgressDialogVisibility: LiveData&lt;DialogVisibility&gt; = _savingProgressDialogVisibility</span>

<span class="nc" id="L67">    init {</span>
<span class="nc" id="L68">        dispatcher.register(this)</span>
<span class="nc" id="L69">    }</span>

    override fun onCleared() {
<span class="nc" id="L72">        dispatcher.unregister(this)</span>
<span class="nc" id="L73">        super.onCleared()</span>
<span class="nc" id="L74">    }</span>

    fun savePostOnline(
        isFirstTimePublish: Boolean,
        context: Context,
        editPostRepository: EditPostRepository,
        site: SiteModel
    ): ActivityFinishState {
<span class="nc" id="L82">        savePostToDbUseCase.savePostToDb(editPostRepository, site)</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        return if (networkUtils.isNetworkAvailable()) {</span>
<span class="nc" id="L84">            postUtils.trackSavePostAnalytics(</span>
<span class="nc" id="L85">                    editPostRepository.getPost(),</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">                    requireNotNull(siteStore.getSiteByLocalId(editPostRepository.localSiteId))</span>
            )
<span class="nc" id="L88">            uploadService.uploadPost(context, editPostRepository.id, isFirstTimePublish)</span>
<span class="nc" id="L89">            SAVED_ONLINE</span>
        } else {
<span class="nc" id="L91">            SAVED_LOCALLY</span>
        }
    }

    fun savePostWithDelay() {
<span class="nc bnc" id="L96" title="All 2 branches missed.">        saveJob?.cancel()</span>
<span class="nc" id="L97">        saveJob = launch {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            if (debounceCounter &lt; MAX_UNSAVED_POSTS) {</span>
<span class="nc" id="L99">                debounceCounter++</span>
<span class="nc" id="L100">                delay(CHANGE_SAVE_DELAY)</span>
            }
<span class="nc" id="L102">            debounceCounter = 0</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (!isSavingPostOnEditorExit) _onSavePostTriggered.value = Event(Unit)</span>
<span class="nc" id="L104">        }</span>
<span class="nc" id="L105">    }</span>

    fun savePostToDb(
        postRepository: EditPostRepository,
        site: SiteModel
    ) {
<span class="nc" id="L111">        savePostToDbUseCase.savePostToDb(postRepository, site)</span>
<span class="nc" id="L112">    }</span>

<span class="nc" id="L114">    fun updatePostObjectWithUIAsync(</span>
        postRepository: EditPostRepository,
        getUpdatedTitleAndContent: (currentContent: String) -&gt; UpdateFromEditor,
<span class="nc" id="L117">        onCompleted: ((PostImmutableModel, UpdatePostResult) -&gt; Unit)? = null</span>
    ) {
<span class="nc" id="L119">        postRepository.updateAsync({ postModel -&gt;</span>
<span class="nc" id="L120">            updatePostObjectWithUI(</span>
<span class="nc" id="L121">                    getUpdatedTitleAndContent,</span>
<span class="nc" id="L122">                    postModel,</span>
<span class="nc" id="L123">                    postRepository</span>
            )
<span class="nc" id="L125">        }, onCompleted)</span>
<span class="nc" id="L126">    }</span>

    private fun updatePostObjectWithUI(
        getUpdatedTitleAndContent: (currentContent: String) -&gt; UpdateFromEditor,
        postModel: PostModel,
        postRepository: EditPostRepository
    ): Boolean {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (!postRepository.hasPost()) {</span>
<span class="nc" id="L134">            AppLog.e(AppLog.T.POSTS, &quot;Attempted to save an invalid Post.&quot;)</span>
<span class="nc" id="L135">            return false</span>
        }
<span class="nc" id="L137">        return when (val updateFromEditor = getUpdatedTitleAndContent(postModel.content)) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            is PostFields -&gt; {</span>
<span class="nc" id="L139">                val postTitleOrContentChanged = updatePostContentNewEditor(</span>
<span class="nc" id="L140">                        postModel,</span>
<span class="nc" id="L141">                        updateFromEditor.title,</span>
<span class="nc" id="L142">                        updateFromEditor.content</span>
                )

                // only makes sense to change the publish date and locally changed date if the Post was actually changed
<span class="nc bnc" id="L146" title="All 2 branches missed.">                if (postTitleOrContentChanged) {</span>
<span class="nc" id="L147">                    postRepository.updatePublishDateIfShouldBePublishedImmediately(</span>
<span class="nc" id="L148">                            postModel</span>
                    )
                }

<span class="nc" id="L152">                postTitleOrContentChanged</span>
            }
<span class="nc" id="L154">            is Failed -&gt; false</span>
        }
    }

    /**
     * Updates post object with given title and content
     */
    private fun updatePostContentNewEditor(
        editedPost: PostModel,
        title: String,
        content: String
    ): Boolean {
<span class="nc bnc" id="L166" title="All 2 branches missed.">        val titleChanged = editedPost.title != title</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (titleChanged) {</span>
<span class="nc" id="L168">            editedPost.setTitle(title)</span>
        }
<span class="nc bnc" id="L170" title="All 2 branches missed.">        val contentChanged: Boolean = editedPost.content != content</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (contentChanged) {</span>
<span class="nc" id="L172">            editedPost.setContent(content)</span>
        }
<span class="nc bnc" id="L174" title="All 4 branches missed.">        return titleChanged || contentChanged</span>
    }

    fun showSavingProgressDialog() {
<span class="nc" id="L178">        _savingProgressDialogVisibility.postValue(Showing)</span>
<span class="nc" id="L179">    }</span>

    fun hideSavingProgressDialog() {
<span class="nc" id="L182">        _savingProgressDialogVisibility.postValue(Hidden)</span>
<span class="nc" id="L183">    }</span>

    fun finish(state: ActivityFinishState) {
<span class="nc" id="L186">        hideSavingProgressDialog()</span>
<span class="nc" id="L187">        _onFinish.postValue(Event(state))</span>
<span class="nc" id="L188">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe
    fun onPostUploaded(event: OnPostUploaded) {
<span class="nc" id="L193">        hideSavingProgressDialog()</span>
<span class="nc" id="L194">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe
    fun onPostChanged(event: OnPostChanged) {
<span class="nc" id="L199">        hideSavingProgressDialog()</span>
<span class="nc" id="L200">    }</span>

    sealed class UpdateResult {
<span class="nc" id="L203">        object Error : UpdateResult()</span>
<span class="nc" id="L204">        data class Success(val postTitleOrContentChanged: Boolean) : UpdateResult()</span>
    }

    sealed class UpdateFromEditor {
<span class="nc" id="L208">        data class PostFields(val title: String, val content: String) : UpdateFromEditor()</span>
<span class="nc" id="L209">        data class Failed(val exception: Exception) : UpdateFromEditor()</span>
    }

    enum class ActivityFinishState {
<span class="nc" id="L213">        SAVED_ONLINE, SAVED_LOCALLY, CANCELLED</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>