<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImageEditorInitializer.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts.editor</a> &gt; <span class="el_source">ImageEditorInitializer.kt</span></div><h1>ImageEditorInitializer.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts.editor

import android.graphics.drawable.Drawable
import android.net.Uri
import android.widget.ImageView
import android.widget.ImageView.ScaleType
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.launch
import org.wordpress.android.WordPress
import org.wordpress.android.imageeditor.ImageEditor
import org.wordpress.android.imageeditor.ImageEditor.EditorAction
import org.wordpress.android.imageeditor.ImageEditor.EditorAction.CropSuccessful
import org.wordpress.android.imageeditor.ImageEditor.EditorAction.EditorCancelled
import org.wordpress.android.imageeditor.ImageEditor.EditorAction.EditorFinishedEditing
import org.wordpress.android.imageeditor.crop.CropViewModel.Companion.MEDIA_EDITING
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.util.image.ImageManager.RequestListener
import org.wordpress.android.util.image.ImageType.IMAGE
import java.io.File

<span class="nc" id="L21">class ImageEditorInitializer {</span>
    companion object {
        private const val IMAGE_STRING_URL_MSG = &quot;ImageEditor requires a not-null string image url.&quot;
        private const val ONE_DAY = 24 * 60 * 60 * 1000.toLong()
        private const val ONE_WEEK = ONE_DAY * 7

        // The actions made in a session.
<span class="pc" id="L28">        val actions = arrayListOf&lt;Action&gt;()</span>

<span class="nc" id="L30">        sealed class Action(val label: String) {</span>
<span class="nc" id="L31">            object Crop : Action(&quot;crop&quot;)</span>
        }

        fun init(
            imageManager: ImageManager,
            imageEditorTracker: ImageEditorTracker,
            imageEditorFileUtils: ImageEditorFileUtils,
            appScope: CoroutineScope
        ) {
            // Delete old output images
<span class="fc" id="L41">            val mediaEditingDirectoryPath = WordPress.getContext().cacheDir.path + &quot;/&quot; + MEDIA_EDITING</span>
<span class="fc" id="L42">            appScope.launch {</span>
<span class="fc" id="L43">                imageEditorFileUtils.deleteFilesOlderThanDurationFromDirectory(mediaEditingDirectoryPath, ONE_WEEK)</span>
<span class="fc" id="L44">            }</span>

<span class="fc" id="L46">            ImageEditor.init(</span>
<span class="fc" id="L47">                loadIntoImageViewWithResultListener(imageManager),</span>
<span class="fc" id="L48">                loadIntoFileWithResultListener(imageManager),</span>
<span class="fc" id="L49">                loadIntoImageView(imageManager),</span>
<span class="fc" id="L50">                onEditorAction(imageEditorTracker)</span>
            )
<span class="fc" id="L52">        }</span>

        private fun loadIntoImageViewWithResultListener(
            imageManager: ImageManager
        ): (String, ImageView, ScaleType, String?, ImageEditor.RequestListener&lt;Drawable&gt;) -&gt; Unit =
<span class="fc" id="L57">            { imageUrl, imageView, scaleType, thumbUrl, listener -&gt;</span>
<span class="nc" id="L58">                imageManager.loadWithResultListener(</span>
<span class="nc" id="L59">                    imageView,</span>
<span class="nc" id="L60">                    IMAGE,</span>
<span class="nc" id="L61">                    imageUrl,</span>
<span class="nc" id="L62">                    scaleType,</span>
<span class="nc" id="L63">                    thumbUrl,</span>
<span class="nc" id="L64">                    object : RequestListener&lt;Drawable&gt; {</span>
<span class="nc" id="L65">                        override fun onLoadFailed(e: Exception?, model: Any?) = onLoadFailed(model, listener, e)</span>
                        override fun onResourceReady(resource: Drawable, model: Any?) =
<span class="nc" id="L67">                            onResourceReady(model, listener, resource)</span>
                    }
                )
<span class="pc" id="L70">            }</span>

        private fun loadIntoFileWithResultListener(imageManager: ImageManager):
<span class="fc" id="L73">            (Uri, ImageEditor.RequestListener&lt;File&gt;) -&gt; Unit = { imageUri, listener -&gt;</span>
<span class="nc" id="L74">            imageManager.loadIntoFileWithResultListener(</span>
<span class="nc" id="L75">                imageUri,</span>
<span class="nc" id="L76">                object : RequestListener&lt;File&gt; {</span>
<span class="nc" id="L77">                    override fun onLoadFailed(e: Exception?, model: Any?) = onLoadFailed(model, listener, e)</span>
                    override fun onResourceReady(resource: File, model: Any?) =
<span class="nc" id="L79">                        onResourceReady(model, listener, resource)</span>
                }
            )
<span class="pc" id="L82">        }</span>

        private fun loadIntoImageView(imageManager: ImageManager):
<span class="fc" id="L85">            (String, ImageView, ScaleType) -&gt; Unit = { imageUrl, imageView, scaleType -&gt;</span>
<span class="nc" id="L86">            imageManager.load(imageView, IMAGE, imageUrl, scaleType)</span>
<span class="pc" id="L87">        }</span>

        private fun &lt;T : Any&gt; onResourceReady(model: Any?, listener: ImageEditor.RequestListener&lt;T&gt;, resource: T) =
<span class="nc bnc" id="L90" title="All 6 branches missed.">            if (model != null &amp;&amp; (model is String || model is Uri)) {</span>
<span class="nc" id="L91">                listener.onResourceReady(resource, model.toString())</span>
            } else {
<span class="nc" id="L93">                throw(IllegalArgumentException(IMAGE_STRING_URL_MSG))</span>
<span class="nc" id="L94">            }</span>

        private fun &lt;T : Any&gt; onLoadFailed(model: Any?, listener: ImageEditor.RequestListener&lt;T&gt;, e: Exception?) =
<span class="nc bnc" id="L97" title="All 6 branches missed.">            if (model != null &amp;&amp; (model is String || model is Uri)) {</span>
<span class="nc" id="L98">                listener.onLoadFailed(e, model.toString())</span>
            } else {
<span class="nc" id="L100">                throw(IllegalArgumentException(IMAGE_STRING_URL_MSG))</span>
<span class="nc" id="L101">            }</span>

<span class="fc" id="L103">        private fun onEditorAction(imageEditorTracker: ImageEditorTracker): (EditorAction) -&gt; Unit = { action -&gt;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (action is CropSuccessful) {</span>
<span class="nc" id="L105">                actions.add(Action.Crop)</span>
            }

<span class="nc" id="L108">            imageEditorTracker.trackEditorAction(action)</span>

<span class="nc bnc" id="L110" title="All 4 branches missed.">            val isSessionEnded = action is EditorCancelled || action is EditorFinishedEditing</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (isSessionEnded) {</span>
<span class="nc" id="L112">                actions.clear()</span>
            }
<span class="pc" id="L114">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>