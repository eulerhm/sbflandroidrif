<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SiteSettingsTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.datasets</a> &gt; <span class="el_source">SiteSettingsTable.java</span></div><h1>SiteSettingsTable.java</h1><pre class="source lang-java linenums">package org.wordpress.android.datasets;

import android.content.ContentValues;
import android.database.Cursor;
import android.database.SQLException;
import android.database.sqlite.SQLiteDatabase;

import androidx.collection.SparseArrayCompat;

import org.wordpress.android.WordPress;
import org.wordpress.android.models.CategoryModel;
import org.wordpress.android.models.SiteSettingsModel;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.SqlUtils;

<span class="nc" id="L17">public final class SiteSettingsTable {</span>
    private static final String CATEGORIES_TABLE_NAME = &quot;site_categories&quot;;
    private static final String CREATE_CATEGORIES_TABLE_SQL =
            &quot;CREATE TABLE IF NOT EXISTS &quot;
            + CATEGORIES_TABLE_NAME
            + &quot; (&quot;
            + CategoryModel.ID_COLUMN_NAME + &quot; INTEGER PRIMARY KEY, &quot;
            + CategoryModel.NAME_COLUMN_NAME + &quot; TEXT, &quot;
            + CategoryModel.SLUG_COLUMN_NAME + &quot; TEXT, &quot;
            + CategoryModel.DESC_COLUMN_NAME + &quot; TEXT, &quot;
            + CategoryModel.PARENT_ID_COLUMN_NAME + &quot; INTEGER, &quot;
            + CategoryModel.POST_COUNT_COLUMN_NAME + &quot; INTEGER&quot;
            + &quot;);&quot;;

    public static void createTable(SQLiteDatabase db) {
<span class="pc bpc" id="L32" title="1 of 2 branches missed.">        if (db != null) {</span>
<span class="fc" id="L33">            db.execSQL(SiteSettingsModel.CREATE_SETTINGS_TABLE_SQL);</span>
<span class="fc" id="L34">            db.execSQL(CREATE_CATEGORIES_TABLE_SQL);</span>
        }
<span class="fc" id="L36">    }</span>

    public static void addSharingColumnsToSiteSettingsTable(SQLiteDatabase db) {
<span class="nc bnc" id="L39" title="All 2 branches missed.">        if (db != null) {</span>
<span class="nc" id="L40">            db.execSQL(SiteSettingsModel.ADD_SHARING_LABEL);</span>
<span class="nc" id="L41">            db.execSQL(SiteSettingsModel.ADD_SHARING_BUTTON_STYLE);</span>
<span class="nc" id="L42">            db.execSQL(SiteSettingsModel.ADD_ALLOW_REBLOG_BUTTON);</span>
<span class="nc" id="L43">            db.execSQL(SiteSettingsModel.ADD_ALLOW_LIKE_BUTTON);</span>
<span class="nc" id="L44">            db.execSQL(SiteSettingsModel.ADD_ALLOW_COMMENT_LIKES);</span>
<span class="nc" id="L45">            db.execSQL(SiteSettingsModel.ADD_TWITTER_USERNAME);</span>
        }
<span class="nc" id="L47">    }</span>

    public static SparseArrayCompat&lt;CategoryModel&gt; getAllCategories() {
<span class="nc" id="L50">        String sqlCommand = sqlSelectAllCategories() + &quot;;&quot;;</span>
<span class="nc" id="L51">        Cursor cursor = WordPress.wpDB.getDatabase().rawQuery(sqlCommand, null);</span>
        try {
<span class="nc bnc" id="L53" title="All 6 branches missed.">            if (cursor == null || !cursor.moveToFirst() || cursor.getCount() == 0) {</span>
<span class="nc" id="L54">                return null;</span>
            }

<span class="nc" id="L57">            SparseArrayCompat&lt;CategoryModel&gt; models = new SparseArrayCompat&lt;&gt;();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">            for (int i = 0; i &lt; cursor.getCount(); ++i) {</span>
<span class="nc" id="L59">                CategoryModel model = new CategoryModel();</span>
<span class="nc" id="L60">                model.deserializeFromDatabase(cursor);</span>
<span class="nc" id="L61">                models.put(model.id, model);</span>
<span class="nc" id="L62">                cursor.moveToNext();</span>
            }

<span class="nc" id="L65">            return models;</span>
        } finally {
<span class="nc bnc" id="L67" title="All 4 branches missed.">            if (cursor != null &amp;&amp; !cursor.isClosed()) {</span>
<span class="nc" id="L68">                cursor.close();</span>
            }
        }
    }

    public static Cursor getCategory(long id) {
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (id &lt; 0) {</span>
<span class="nc" id="L75">            return null;</span>
        }

<span class="nc" id="L78">        String sqlCommand = sqlSelectAllCategories() + sqlWhere(CategoryModel.ID_COLUMN_NAME, Long.toString(id)) + &quot;;&quot;;</span>
<span class="nc" id="L79">        return WordPress.wpDB.getDatabase().rawQuery(sqlCommand, null);</span>
    }

    public static Cursor getSettings(long id) {
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (id &lt; 0) {</span>
<span class="nc" id="L84">            return null;</span>
        }

<span class="nc" id="L87">        String whereClause = sqlWhere(SiteSettingsModel.ID_COLUMN_NAME, Long.toString(id));</span>
<span class="nc" id="L88">        String sqlCommand = sqlSelectAllSettings() + whereClause + &quot;;&quot;;</span>
<span class="nc" id="L89">        return WordPress.wpDB.getDatabase().rawQuery(sqlCommand, null);</span>
    }

    public static void saveCategory(CategoryModel category) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (category == null) {</span>
<span class="nc" id="L94">            return;</span>
        }

<span class="nc" id="L97">        ContentValues values = category.serializeToDatabase();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        category.isInLocalTable = WordPress.wpDB.getDatabase().insertWithOnConflict(</span>
                CATEGORIES_TABLE_NAME, null, values, SQLiteDatabase.CONFLICT_REPLACE) != -1;
<span class="nc" id="L100">    }</span>

    public static void saveCategories(CategoryModel[] categories) {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (categories == null) {</span>
<span class="nc" id="L104">            return;</span>
        }

<span class="nc bnc" id="L107" title="All 2 branches missed.">        for (CategoryModel category : categories) {</span>
<span class="nc" id="L108">            saveCategory(category);</span>
        }
<span class="nc" id="L110">    }</span>

    public static void saveSettings(SiteSettingsModel settings) {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (settings == null) {</span>
<span class="nc" id="L114">            return;</span>
        }

<span class="nc" id="L117">        ContentValues values = settings.serializeToDatabase();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        settings.isInLocalTable = WordPress.wpDB.getDatabase().insertWithOnConflict(</span>
                SiteSettingsModel.SETTINGS_TABLE_NAME, null, values, SQLiteDatabase.CONFLICT_REPLACE) != -1;

<span class="nc" id="L121">        saveCategories(settings.categories);</span>
<span class="nc" id="L122">    }</span>

    private static String sqlSelectAllCategories() {
<span class="nc" id="L125">        return &quot;SELECT * FROM &quot; + CATEGORIES_TABLE_NAME + &quot; &quot;;</span>
    }

    private static String sqlSelectAllSettings() {
<span class="nc" id="L129">        return &quot;SELECT * FROM &quot; + SiteSettingsModel.SETTINGS_TABLE_NAME + &quot; &quot;;</span>
    }

    private static String sqlWhere(String variable, String value) {
<span class="nc" id="L133">        return &quot;WHERE &quot; + variable + &quot;=\&quot;&quot; + value + &quot;\&quot; &quot;;</span>
    }

    public static boolean migrateMediaOptimizeSettings(SQLiteDatabase db) {
<span class="nc" id="L137">        Cursor cursor = null;</span>
        try {
<span class="nc" id="L139">            String sqlCommand = &quot;SELECT * FROM &quot; + SiteSettingsModel.SETTINGS_TABLE_NAME + &quot;;&quot;;</span>
<span class="nc" id="L140">            cursor = db.rawQuery(sqlCommand, null);</span>
<span class="nc bnc" id="L141" title="All 6 branches missed.">            if (cursor == null || cursor.getCount() == 0 || !cursor.moveToFirst()) {</span>
<span class="nc" id="L142">                return false;</span>
            }
<span class="nc" id="L144">            int columnIndex = cursor.getColumnIndex(&quot;optimizedImage&quot;);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (columnIndex == -1) {</span>
                // No old columns for media optimization settings
<span class="nc" id="L147">                return false;</span>
            }
            // we're safe to read all the settings now since all the columns must be there
<span class="nc" id="L150">            int optimizeImageOldSettings = cursor.getInt(columnIndex);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            AppPrefs.setImageOptimize(optimizeImageOldSettings == 1);</span>
<span class="nc" id="L152">            AppPrefs.setImageOptimizeMaxSize(</span>
<span class="nc" id="L153">                    cursor.getInt(cursor.getColumnIndexOrThrow(&quot;maxImageWidth&quot;)));</span>
<span class="nc" id="L154">            AppPrefs.setImageOptimizeQuality(</span>
<span class="nc" id="L155">                    cursor.getInt(cursor.getColumnIndexOrThrow(&quot;imageEncoderQuality&quot;)));</span>
<span class="nc" id="L156">            AppPrefs.setVideoOptimize(</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                    cursor.getInt(cursor.getColumnIndexOrThrow(&quot;optimizedVideo&quot;)) == 1);</span>
<span class="nc" id="L158">            AppPrefs.setVideoOptimizeWidth(</span>
<span class="nc" id="L159">                    cursor.getInt(cursor.getColumnIndexOrThrow(&quot;maxVideoWidth&quot;)));</span>
<span class="nc" id="L160">            AppPrefs.setVideoOptimizeQuality(</span>
<span class="nc" id="L161">                    cursor.getInt(cursor.getColumnIndexOrThrow(&quot;videoEncoderBitrate&quot;)));</span>

            // Delete the old columns? --&gt; cannot drop a specific column in SQLite 3 ;(

<span class="nc" id="L165">            return true;</span>
<span class="nc" id="L166">        } catch (SQLException e) {</span>
<span class="nc" id="L167">            AppLog.e(AppLog.T.DB, &quot;Failed to copy media optimization settings&quot;, e);</span>
        } finally {
<span class="nc" id="L169">            SqlUtils.closeCursor(cursor);</span>
        }
<span class="nc" id="L171">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>