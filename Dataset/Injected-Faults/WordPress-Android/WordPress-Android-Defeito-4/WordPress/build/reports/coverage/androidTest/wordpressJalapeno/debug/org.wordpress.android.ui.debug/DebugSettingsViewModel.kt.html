<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DebugSettingsViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.debug</a> &gt; <span class="el_source">DebugSettingsViewModel.kt</span></div><h1>DebugSettingsViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.debug

import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.coroutines.CoroutineDispatcher
import org.wordpress.android.R
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.debug.DebugSettingsViewModel.NavigationAction.DebugCookies
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Button
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Feature
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Feature.State.DISABLED
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Feature.State.ENABLED
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Feature.State.UNKNOWN
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Header
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Row
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.ToggleAction
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Type.BUTTON
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Type.FEATURE
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Type.HEADER
import org.wordpress.android.ui.debug.DebugSettingsViewModel.UiItem.Type.ROW
import org.wordpress.android.ui.notifications.NotificationManagerWrapper
import org.wordpress.android.ui.utils.ListItemInteraction
import org.wordpress.android.ui.utils.ListItemInteraction.Companion.create
import org.wordpress.android.util.DebugUtils
import org.wordpress.android.util.config.FeaturesInDevelopment
import org.wordpress.android.util.config.ManualFeatureConfig
import org.wordpress.android.util.config.RemoteConfig
import org.wordpress.android.util.config.RemoteConfigDefaults
import org.wordpress.android.viewmodel.ContextProvider
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ScopedViewModel
import org.wordpress.android.workers.weeklyroundup.WeeklyRoundupNotifier
import javax.inject.Inject
import javax.inject.Named

class DebugSettingsViewModel
<span class="nc" id="L38">@Inject constructor(</span>
<span class="nc" id="L39">    @Named(UI_THREAD) private val mainDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L40">    @Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L41">    private val manualFeatureConfig: ManualFeatureConfig,</span>
<span class="nc" id="L42">    private val remoteConfig: RemoteConfig,</span>
<span class="nc" id="L43">    private val debugUtils: DebugUtils,</span>
<span class="nc" id="L44">    private val weeklyRoundupNotifier: WeeklyRoundupNotifier,</span>
<span class="nc" id="L45">    private val notificationManager: NotificationManagerWrapper,</span>
<span class="nc" id="L46">    private val contextProvider: ContextProvider</span>
<span class="nc" id="L47">) : ScopedViewModel(mainDispatcher) {</span>
<span class="nc" id="L48">    private val _uiState = MutableLiveData&lt;UiState&gt;()</span>
<span class="nc" id="L49">    val uiState: LiveData&lt;UiState&gt; = _uiState</span>
<span class="nc" id="L50">    private val _onNavigation = MutableLiveData&lt;Event&lt;NavigationAction&gt;&gt;()</span>
<span class="nc" id="L51">    val onNavigation: LiveData&lt;Event&lt;NavigationAction&gt;&gt; = _onNavigation</span>
    private var hasChange: Boolean = false

    fun start() {
<span class="nc bnc" id="L55" title="All 2 branches missed.">        launch {</span>
<span class="nc" id="L56">            refresh()</span>
<span class="nc" id="L57">        }</span>
<span class="nc" id="L58">    }</span>

    private fun refresh() {
<span class="nc" id="L61">        val uiItems = mutableListOf&lt;UiItem&gt;()</span>
<span class="nc" id="L62">        val remoteFeatures = buildRemoteFeatures()</span>
<span class="nc bnc" id="L63" title="All 4 branches missed.">        if (remoteFeatures.isNotEmpty()) {</span>
<span class="nc" id="L64">            uiItems.add(Header(R.string.debug_settings_remote_features))</span>
<span class="nc" id="L65">            uiItems.addAll(remoteFeatures)</span>
        }
<span class="nc" id="L67">        val developedFeatures = buildDevelopedFeatures()</span>
<span class="nc bnc" id="L68" title="All 4 branches missed.">        if (remoteFeatures.isNotEmpty()) {</span>
<span class="nc" id="L69">            uiItems.add(Header(R.string.debug_settings_features_in_development))</span>
<span class="nc" id="L70">            uiItems.addAll(developedFeatures)</span>
        }
<span class="nc" id="L72">        uiItems.add(Header(R.string.debug_settings_missing_developed_feature))</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (hasChange) {</span>
<span class="nc" id="L74">            uiItems.add(Button(R.string.debug_settings_restart_app, debugUtils::restartApp))</span>
        }
<span class="nc" id="L76">        uiItems.add(Header(R.string.debug_settings_tools))</span>
<span class="nc" id="L77">        uiItems.add(Row(R.string.debug_cookies_title, create(this::onDebugCookiesClick)))</span>
<span class="nc" id="L78">        uiItems.add(Row(R.string.debug_settings_force_show_weekly_roundup, create(this::onForceShowWeeklyRoundupClick)))</span>
<span class="nc" id="L79">        _uiState.value = UiState(uiItems)</span>
<span class="nc" id="L80">    }</span>

    private fun onDebugCookiesClick() {
<span class="nc" id="L83">        _onNavigation.value = Event(DebugCookies)</span>
<span class="nc" id="L84">    }</span>

<span class="nc" id="L86">    private fun onForceShowWeeklyRoundupClick() = launch(bgDispatcher) {</span>
<span class="nc" id="L87">        weeklyRoundupNotifier.buildNotifications().forEach {</span>
<span class="nc" id="L88">            notificationManager.notify(it.id, it.asNotificationCompatBuilder(contextProvider.getContext()).build())</span>
<span class="nc" id="L89">        }</span>
<span class="nc" id="L90">    }</span>

    private fun buildDevelopedFeatures(): List&lt;Feature&gt; {
<span class="nc" id="L93">        return FeaturesInDevelopment.featuresInDevelopment.map { name -&gt;</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            val value = if (manualFeatureConfig.hasManualSetup(name)) {</span>
<span class="nc" id="L95">                manualFeatureConfig.isManuallyEnabled(name)</span>
            } else {
<span class="nc" id="L97">                null</span>
            }
<span class="nc bnc" id="L99" title="All 4 branches missed.">            Feature(name, value, ToggleAction(name, value?.not() ?: true, this::toggleFeature))</span>
        }
    }

    private fun buildRemoteFeatures(): List&lt;Feature&gt; {
<span class="nc" id="L104">        return RemoteConfigDefaults.remoteConfigDefaults.mapNotNull { (key, defaultValue) -&gt;</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            val value = if (manualFeatureConfig.hasManualSetup(key)) {</span>
<span class="nc" id="L106">                manualFeatureConfig.isManuallyEnabled(key)</span>
            } else {
<span class="nc" id="L108">                when (defaultValue.toString()) {</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">                    &quot;true&quot;, &quot;false&quot; -&gt; remoteConfig.isEnabled(key)</span>
<span class="nc" id="L110">                    else -&gt; null</span>
                }
            }
<span class="nc bnc" id="L113" title="All 4 branches missed.">            if (value != null) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                Feature(key, value, ToggleAction(key, !value, this::toggleFeature))</span>
            } else {
<span class="nc" id="L116">                null</span>
            }
        }
    }

    private fun toggleFeature(remoteKey: String, value: Boolean) {
<span class="nc bnc" id="L122" title="All 2 branches missed.">        launch {</span>
<span class="nc" id="L123">            hasChange = true</span>
<span class="nc" id="L124">            manualFeatureConfig.setManuallyEnabled(remoteKey, value)</span>
<span class="nc" id="L125">            refresh()</span>
<span class="nc" id="L126">        }</span>
<span class="nc" id="L127">    }</span>

<span class="nc" id="L129">    data class UiState(val uiItems: List&lt;UiItem&gt;)</span>
<span class="nc" id="L130">    sealed class UiItem(val type: Type) {</span>
<span class="nc" id="L131">        data class Header(val header: Int) : UiItem(HEADER)</span>
<span class="nc" id="L132">        data class Button(val text: Int, val clickAction: () -&gt; Unit) : UiItem(BUTTON)</span>
<span class="nc" id="L133">        data class Feature(val title: String, val state: State, val toggleAction: ToggleAction) : UiItem(FEATURE) {</span>
<span class="nc" id="L134">            constructor(title: String, enabled: Boolean?, toggleAction: ToggleAction) : this(</span>
<span class="nc" id="L135">                    title,</span>
<span class="nc" id="L136">                    when (enabled) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                        true -&gt; ENABLED</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                        false -&gt; DISABLED</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                        null -&gt; UNKNOWN</span>
                    },
<span class="nc" id="L141">                    toggleAction</span>
<span class="nc" id="L142">            )</span>

<span class="nc" id="L144">            enum class State { ENABLED, DISABLED, UNKNOWN }</span>
        }

<span class="nc" id="L147">        data class Row(val title: Int, val onClick: ListItemInteraction) : UiItem(ROW)</span>

<span class="nc" id="L149">        data class ToggleAction(</span>
<span class="nc" id="L150">            val key: String,</span>
<span class="nc" id="L151">            val value: Boolean,</span>
<span class="nc" id="L152">            val toggleAction: (key: String, value: Boolean) -&gt; Unit</span>
        ) {
<span class="nc" id="L154">            fun toggle() = toggleAction(key, value)</span>
        }

        enum class Type {
<span class="nc" id="L158">            HEADER, FEATURE, BUTTON, ROW</span>
        }
    }

    sealed class NavigationAction {
<span class="nc" id="L163">        object DebugCookies : NavigationAction()</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>