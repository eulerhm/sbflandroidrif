<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MeFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.main</a> &gt; <span class="el_source">MeFragment.kt</span></div><h1>MeFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.main

import android.app.Activity
import android.app.ProgressDialog
import android.content.Intent
import android.content.pm.PackageManager
import android.graphics.drawable.BitmapDrawable
import android.graphics.drawable.Drawable
import android.net.Uri
import android.os.Bundle
import android.text.TextUtils
import android.view.View
import android.view.View.OnClickListener
import androidx.appcompat.app.AppCompatActivity
import androidx.core.view.isVisible
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import com.google.android.material.snackbar.Snackbar
import com.yalantis.ucrop.UCrop
import com.yalantis.ucrop.UCrop.Options
import com.yalantis.ucrop.UCropActivity
import org.greenrobot.eventbus.EventBus
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode
import org.wordpress.android.BuildConfig
import org.wordpress.android.R
import org.wordpress.android.R.attr
import org.wordpress.android.WordPress
import org.wordpress.android.analytics.AnalyticsTracker
import org.wordpress.android.analytics.AnalyticsTracker.Stat.ME_GRAVATAR_CROPPED
import org.wordpress.android.analytics.AnalyticsTracker.Stat.ME_GRAVATAR_GALLERY_PICKED
import org.wordpress.android.analytics.AnalyticsTracker.Stat.ME_GRAVATAR_SHOT_NEW
import org.wordpress.android.analytics.AnalyticsTracker.Stat.ME_GRAVATAR_TAPPED
import org.wordpress.android.analytics.AnalyticsTracker.Stat.ME_GRAVATAR_UPLOADED
import org.wordpress.android.databinding.MeFragmentBinding
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.store.AccountStore
import org.wordpress.android.fluxc.store.AccountStore.OnAccountChanged
import org.wordpress.android.fluxc.store.PostStore
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.networking.GravatarApi
import org.wordpress.android.networking.GravatarApi.GravatarUploadListener
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.RequestCodes
import org.wordpress.android.ui.about.UnifiedAboutActivity
import org.wordpress.android.ui.accounts.HelpActivity.Origin.ME_SCREEN_HELP
import org.wordpress.android.ui.main.MeViewModel.RecommendAppUiState
import org.wordpress.android.ui.main.WPMainActivity.OnScrollToTopListener
import org.wordpress.android.ui.main.utils.MeGravatarLoader
import org.wordpress.android.ui.notifications.utils.NotificationsUtils
import org.wordpress.android.ui.photopicker.MediaPickerConstants
import org.wordpress.android.ui.photopicker.MediaPickerLauncher
import org.wordpress.android.ui.photopicker.PhotoPickerActivity.PhotoPickerMediaSource
import org.wordpress.android.ui.photopicker.PhotoPickerActivity.PhotoPickerMediaSource.ANDROID_CAMERA
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T.MAIN
import org.wordpress.android.util.AppLog.T.UTILS
import org.wordpress.android.util.FluxCUtils
import org.wordpress.android.util.MediaUtils
import org.wordpress.android.util.SnackbarItem
import org.wordpress.android.util.SnackbarItem.Info
import org.wordpress.android.util.SnackbarSequencer
import org.wordpress.android.util.ToastUtils
import org.wordpress.android.util.ToastUtils.Duration.SHORT
import org.wordpress.android.util.WPMediaUtils
import org.wordpress.android.util.config.QRCodeAuthFlowFeatureConfig
import org.wordpress.android.util.config.RecommendTheAppFeatureConfig
import org.wordpress.android.util.config.UnifiedAboutFeatureConfig
import org.wordpress.android.util.extensions.getColorFromAttribute
import org.wordpress.android.util.image.ImageManager.RequestListener
import org.wordpress.android.util.image.ImageType.AVATAR_WITHOUT_BACKGROUND
import org.wordpress.android.viewmodel.observeEvent
import java.io.File
import javax.inject.Inject

<span class="nc" id="L78">class MeFragment : Fragment(R.layout.me_fragment), OnScrollToTopListener {</span>
    private var disconnectProgressDialog: ProgressDialog? = null
    private var isUpdatingGravatar = false
    private var binding: MeFragmentBinding? = null

<span class="nc bnc" id="L83" title="All 2 branches missed.">    @Inject lateinit var dispatcher: Dispatcher</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">    @Inject lateinit var accountStore: AccountStore</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">    @Inject lateinit var siteStore: SiteStore</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">    @Inject lateinit var postStore: PostStore</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">    @Inject lateinit var meGravatarLoader: MeGravatarLoader</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">    @Inject lateinit var viewModelFactory: ViewModelProvider.Factory</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">    @Inject lateinit var mediaPickerLauncher: MediaPickerLauncher</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">    @Inject lateinit var recommendTheAppFeatureConfig: RecommendTheAppFeatureConfig</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">    @Inject lateinit var sequencer: SnackbarSequencer</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">    @Inject lateinit var unifiedAboutFeatureConfig: UnifiedAboutFeatureConfig</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">    @Inject lateinit var qrCodeAuthFlowFeatureConfig: QRCodeAuthFlowFeatureConfig</span>
    private lateinit var viewModel: MeViewModel

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L97">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L100">            isUpdatingGravatar = savedInstanceState.getBoolean(IS_UPDATING_GRAVATAR)</span>
        }
<span class="nc" id="L102">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L105">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L106">        binding = MeFragmentBinding.bind(view).apply {</span>
<span class="nc" id="L107">            setupViews()</span>
<span class="nc" id="L108">            setupObservers(savedInstanceState)</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">    }</span>

    private fun MeFragmentBinding.setupViews() {
<span class="nc" id="L113">        with(requireActivity() as AppCompatActivity) {</span>
<span class="nc" id="L114">            setSupportActionBar(toolbarMain)</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            supportActionBar?.apply {</span>
<span class="nc" id="L116">                setHomeButtonEnabled(true)</span>
<span class="nc" id="L117">                setDisplayHomeAsUpEnabled(true)</span>
                // We need to set the title this way so it can be updated on locale change
<span class="nc" id="L119">                setTitle(packageManager.getActivityInfo(componentName, PackageManager.GET_META_DATA).labelRes)</span>
<span class="nc" id="L120">            }</span>
        }

<span class="nc" id="L123">        val showPickerListener = OnClickListener {</span>
<span class="nc" id="L124">            AnalyticsTracker.track(ME_GRAVATAR_TAPPED)</span>
<span class="nc" id="L125">            showPhotoPickerForGravatar()</span>
<span class="nc" id="L126">        }</span>
<span class="nc" id="L127">        avatarContainer.setOnClickListener(showPickerListener)</span>
<span class="nc" id="L128">        changePhoto.setOnClickListener(showPickerListener)</span>
<span class="nc" id="L129">        rowMyProfile.setOnClickListener {</span>
<span class="nc" id="L130">            ActivityLauncher.viewMyProfile(activity)</span>
<span class="nc" id="L131">        }</span>
<span class="nc" id="L132">        rowAccountSettings.setOnClickListener {</span>
<span class="nc" id="L133">            ActivityLauncher.viewAccountSettings(activity)</span>
<span class="nc" id="L134">        }</span>
<span class="nc" id="L135">        rowAppSettings.setOnClickListener {</span>
<span class="nc" id="L136">            ActivityLauncher.viewAppSettingsForResult(activity)</span>
<span class="nc" id="L137">        }</span>
<span class="nc" id="L138">        rowSupport.setOnClickListener {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            ActivityLauncher.viewHelpAndSupport(requireContext(), ME_SCREEN_HELP, viewModel.getSite(), null)</span>
<span class="nc" id="L140">        }</span>

<span class="nc" id="L142">        rowLogout.setOnClickListener {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (accountStore.hasAccessToken()) {</span>
<span class="nc" id="L144">                signOutWordPressComWithConfirmation()</span>
            } else {
<span class="nc" id="L146">                if (BuildConfig.IS_JETPACK_APP) {</span>
                    ActivityLauncher.showSignInForResultJetpackOnly(activity)
                } else {
<span class="nc" id="L149">                    ActivityLauncher.showSignInForResultWpComOnly(activity)</span>
                }
            }
<span class="nc" id="L152">        }</span>
<span class="nc" id="L153">    }</span>

    private fun MeFragmentBinding.setupObservers(savedInstanceState: Bundle?) {
<span class="nc" id="L156">        viewModel = ViewModelProvider(this@MeFragment, viewModelFactory).get(MeViewModel::class.java)</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (savedInstanceState.getBoolean(IS_DISCONNECTING, false)) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                viewModel.openDisconnectDialog()</span>
            }
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (savedInstanceState.getBoolean(IS_UPDATING_GRAVATAR, false)) {</span>
<span class="nc" id="L163">                showGravatarProgressBar(true)</span>
            }
        }

<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (unifiedAboutFeatureConfig.isEnabled()) {</span>
<span class="nc" id="L168">            aboutTheAppContainer.isVisible = true</span>

<span class="nc" id="L170">            rowAboutTheApp.setOnClickListener {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                viewModel.showUnifiedAbout()</span>
<span class="nc" id="L172">            }</span>
        }

<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (qrCodeAuthFlowFeatureConfig.isEnabled() &amp;&amp;</span>
<span class="nc" id="L176">                BuildConfig.ENABLE_QRCODE_AUTH_FLOW &amp;&amp;</span>
                accountStore.hasAccessToken()) {
            rowScanLoginCode.isVisible = true

            rowScanLoginCode.setOnClickListener {
<span class="nc bnc" id="L181" title="All 2 branches missed.">                viewModel.showScanLoginCode()</span>
<span class="nc" id="L182">            }</span>
        }

<span class="nc" id="L185">        initRecommendUiState()</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">        viewModel.showUnifiedAbout.observeEvent(viewLifecycleOwner, {</span>
<span class="nc" id="L188">            startActivity(Intent(activity, UnifiedAboutActivity::class.java))</span>
<span class="nc" id="L189">        })</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">        viewModel.showDisconnectDialog.observeEvent(viewLifecycleOwner, {</span>
<span class="nc" id="L192">            when (it) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                true -&gt; showDisconnectDialog()</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                false -&gt; hideDisconnectDialog()</span>
            }
<span class="nc" id="L196">        })</span>

<span class="nc bnc" id="L198" title="All 2 branches missed.">        viewModel.recommendUiState.observeEvent(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (!isAdded) return@observeEvent</span>

<span class="nc" id="L201">            manageRecommendUiState(it)</span>
<span class="nc" id="L202">        })</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">        viewModel.showScanLoginCode.observeEvent(viewLifecycleOwner) {</span>
<span class="nc" id="L205">            ActivityLauncher.startQRCodeAuthFlow(requireContext())</span>
<span class="nc" id="L206">        }</span>
<span class="nc" id="L207">    }</span>

    private fun MeFragmentBinding.setRecommendLoadingState(startShimmer: Boolean) {
<span class="nc" id="L210">        recommendTheAppShimmer.let {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            it.isEnabled = !startShimmer</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (startShimmer) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (it.isShimmerVisible) {</span>
<span class="nc" id="L215">                    it.startShimmer()</span>
                } else {
<span class="nc" id="L217">                    it.showShimmer(true)</span>
                }
            } else {
<span class="nc" id="L220">                it.hideShimmer()</span>
            }
<span class="nc" id="L222">        }</span>
<span class="nc" id="L223">    }</span>

    private fun MeFragmentBinding.initRecommendUiState() {
        // Limiting the feature to WordPress only in this v1
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (recommendTheAppFeatureConfig.isEnabled() &amp;&amp; !BuildConfig.IS_JETPACK_APP) {</span>
<span class="nc" id="L228">            setRecommendLoadingState(false)</span>
<span class="nc" id="L229">            recommendTheAppContainer.visibility = View.VISIBLE</span>
<span class="nc" id="L230">            rowRecommendTheApp.setOnClickListener {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                viewModel.onRecommendTheApp()</span>
<span class="nc" id="L232">            }</span>
        } else {
<span class="nc" id="L234">            recommendTheAppContainer.visibility = View.GONE</span>
        }
<span class="nc" id="L236">    }</span>

    private fun manageRecommendUiState(state: RecommendAppUiState) {
<span class="nc bnc" id="L239" title="All 2 branches missed.">        binding?.setRecommendLoadingState(state.showLoading)</span>

<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (!state.showLoading) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (state.isError()) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                view?.let { view -&gt;</span>
<span class="nc" id="L244">                    sequencer.enqueue(</span>
<span class="nc" id="L245">                            SnackbarItem(</span>
<span class="nc" id="L246">                                    Info(view, UiStringText(state.error!!), Snackbar.LENGTH_LONG),</span>
<span class="nc" id="L247">                                    null,</span>
<span class="nc" id="L248">                                    null</span>
                            )
                    )
<span class="nc" id="L251">                }</span>
            } else {
<span class="nc" id="L253">                val shareIntent = Intent(Intent.ACTION_SEND)</span>
<span class="nc" id="L254">                shareIntent.type = &quot;text/plain&quot;</span>
<span class="nc" id="L255">                shareIntent.putExtra(Intent.EXTRA_TEXT, &quot;${state.message}\n${state.link}&quot;)</span>
<span class="nc" id="L256">                shareIntent.putExtra(Intent.EXTRA_SUBJECT, resources.getString(R.string.recommend_app_subject))</span>

<span class="nc" id="L258">                startActivity(Intent.createChooser(shareIntent, resources.getString(R.string.share_link)))</span>
            }
        }
<span class="nc" id="L261">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (disconnectProgressDialog != null) {</span>
<span class="nc" id="L265">            outState.putBoolean(IS_DISCONNECTING, true)</span>
        }
<span class="nc" id="L267">        outState.putBoolean(IS_UPDATING_GRAVATAR, isUpdatingGravatar)</span>
<span class="nc" id="L268">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L269">    }</span>

    override fun onScrollToTop() {
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (isAdded) {</span>
<span class="nc bnc" id="L273" title="All 4 branches missed.">            binding?.scrollView?.smoothScrollTo(0, 0)</span>
        }
<span class="nc" id="L275">    }</span>

    override fun onStart() {
<span class="nc" id="L278">        super.onStart()</span>
<span class="nc" id="L279">        EventBus.getDefault().register(this)</span>
<span class="nc" id="L280">        dispatcher.register(this)</span>
<span class="nc" id="L281">    }</span>

    override fun onStop() {
<span class="nc" id="L284">        dispatcher.unregister(this)</span>
<span class="nc" id="L285">        EventBus.getDefault().unregister(this)</span>
<span class="nc" id="L286">        super.onStop()</span>
<span class="nc" id="L287">    }</span>

    override fun onResume() {
<span class="nc" id="L290">        super.onResume()</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        binding?.refreshAccountDetails()</span>
<span class="nc" id="L292">    }</span>

    override fun onDestroy() {
<span class="nc bnc" id="L295" title="All 2 branches missed.">        disconnectProgressDialog?.dismiss()</span>
<span class="nc" id="L296">        disconnectProgressDialog = null</span>
<span class="nc" id="L297">        super.onDestroy()</span>
<span class="nc" id="L298">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L301">        super.onDestroyView()</span>
<span class="nc" id="L302">        binding = null</span>
<span class="nc" id="L303">    }</span>

    private fun MeFragmentBinding.refreshAccountDetails() {
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (!FluxCUtils.isSignedInWPComOrHasWPOrgSite(accountStore, siteStore)) {</span>
<span class="nc" id="L307">            return</span>
        }
        // we only want to show user details for WordPress.com users
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (accountStore.hasAccessToken()) {</span>
<span class="nc" id="L311">            val defaultAccount = accountStore.account</span>
<span class="nc" id="L312">            meDisplayName.visibility = View.VISIBLE</span>
<span class="nc" id="L313">            meUsername.visibility = View.VISIBLE</span>
<span class="nc" id="L314">            cardAvatar.visibility = View.VISIBLE</span>
<span class="nc" id="L315">            rowMyProfile.visibility = View.VISIBLE</span>
<span class="nc" id="L316">            loadAvatar(null)</span>
<span class="nc" id="L317">            meUsername.text = getString(R.string.at_username, defaultAccount.userName)</span>
<span class="nc" id="L318">            meLoginLogoutTextView.setText(R.string.me_disconnect_from_wordpress_com)</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">            meDisplayName.text = defaultAccount.displayName.ifEmpty { defaultAccount.userName }</span>
        } else {
<span class="nc" id="L321">            meDisplayName.visibility = View.GONE</span>
<span class="nc" id="L322">            meUsername.visibility = View.GONE</span>
<span class="nc" id="L323">            cardAvatar.visibility = View.GONE</span>
<span class="nc" id="L324">            avatarProgress.visibility = View.GONE</span>
<span class="nc" id="L325">            rowMyProfile.visibility = View.GONE</span>
<span class="nc" id="L326">            rowAccountSettings.visibility = View.GONE</span>
<span class="nc" id="L327">            meLoginLogoutTextView.setText(R.string.me_connect_to_wordpress_com)</span>
        }
<span class="nc" id="L329">    }</span>

    private fun MeFragmentBinding.showGravatarProgressBar(isUpdating: Boolean) {
<span class="nc bnc" id="L332" title="All 2 branches missed.">        avatarProgress.visibility = if (isUpdating) View.VISIBLE else View.GONE</span>
<span class="nc" id="L333">        isUpdatingGravatar = isUpdating</span>
<span class="nc" id="L334">    }</span>

    private fun MeFragmentBinding.loadAvatar(injectFilePath: String?) {
<span class="nc bnc" id="L337" title="All 6 branches missed.">        val newAvatarUploaded = injectFilePath != null &amp;&amp; injectFilePath.isNotEmpty()</span>
<span class="nc" id="L338">        val avatarUrl = meGravatarLoader.constructGravatarUrl(accountStore.account.avatarUrl)</span>
<span class="nc" id="L339">        meGravatarLoader.load(</span>
<span class="nc" id="L340">                newAvatarUploaded,</span>
<span class="nc" id="L341">                avatarUrl,</span>
<span class="nc" id="L342">                injectFilePath,</span>
<span class="nc" id="L343">                meAvatar,</span>
<span class="nc" id="L344">                AVATAR_WITHOUT_BACKGROUND,</span>
<span class="nc" id="L345">                object : RequestListener&lt;Drawable&gt; {</span>
                    override fun onLoadFailed(e: Exception?, model: Any?) {
<span class="nc" id="L347">                        val appLogMessage = &quot;onLoadFailed while loading Gravatar image!&quot;</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                        if (e == null) {</span>
<span class="nc" id="L349">                            AppLog.e(</span>
<span class="nc" id="L350">                                    MAIN,</span>
<span class="nc" id="L351">                                    &quot;$appLogMessage e == null&quot;</span>
                            )
                        } else {
<span class="nc" id="L354">                            AppLog.e(</span>
<span class="nc" id="L355">                                    MAIN,</span>
<span class="nc" id="L356">                                    appLogMessage,</span>
<span class="nc" id="L357">                                    e</span>
                            )
                        }

                        // For some reason, the Activity can be null so, guard for it. See #8590.
<span class="nc bnc" id="L362" title="All 2 branches missed.">                        if (activity != null) {</span>
<span class="nc" id="L363">                            ToastUtils.showToast(</span>
<span class="nc" id="L364">                                    activity, R.string.error_refreshing_gravatar,</span>
<span class="nc" id="L365">                                    SHORT</span>
                            )
                        }
<span class="nc" id="L368">                    }</span>

                    override fun onResourceReady(
                        resource: Drawable,
                        model: Any?
                    ) {
<span class="nc bnc" id="L374" title="All 4 branches missed.">                        if (newAvatarUploaded &amp;&amp; resource is BitmapDrawable) {</span>
<span class="nc" id="L375">                            var bitmap = resource.bitmap</span>
                            // create a copy since the original bitmap may by automatically recycled
<span class="nc" id="L377">                            bitmap = bitmap.copy(bitmap.config, true)</span>
<span class="nc" id="L378">                            WordPress.getBitmapCache().put(</span>
<span class="nc" id="L379">                                    avatarUrl,</span>
<span class="nc" id="L380">                                    bitmap</span>
                            )
                        }
<span class="nc" id="L383">                    }</span>
                })
<span class="nc" id="L385">    }</span>

    private fun signOutWordPressComWithConfirmation() {
        // if there are local changes we need to let the user know they'll be lost if they logout, otherwise
        // we use a simpler (less scary!) confirmation
<span class="nc bnc" id="L390" title="All 2 branches missed.">        val message: String = if (postStore.numLocalChanges &gt; 0) {</span>
<span class="nc" id="L391">            getString(R.string.sign_out_wpcom_confirm_with_changes)</span>
<span class="nc" id="L392">        } else {</span>
<span class="nc" id="L393">            getString(R.string.sign_out_wpcom_confirm_with_no_changes)</span>
        }
<span class="nc" id="L395">        MaterialAlertDialogBuilder(requireActivity())</span>
<span class="nc" id="L396">                .setMessage(message)</span>
<span class="nc" id="L397">                .setPositiveButton(</span>
<span class="nc" id="L398">                        R.string.signout</span>
                ) { _, _ -&gt;
<span class="nc" id="L400">                    clearNotifications()</span>
<span class="nc" id="L401">                    signOutWordPressCom()</span>
<span class="nc" id="L402">                }</span>
<span class="nc" id="L403">                .setNegativeButton(R.string.cancel, null)</span>
<span class="nc" id="L404">                .setCancelable(true)</span>
<span class="nc" id="L405">                .create().show()</span>
<span class="nc" id="L406">    }</span>

    private fun signOutWordPressCom() {
<span class="nc bnc" id="L409" title="All 4 branches missed.">        viewModel.signOutWordPress(requireActivity().application as WordPress)</span>
<span class="nc" id="L410">    }</span>

    private fun clearNotifications() {
<span class="nc" id="L413">        NotificationsUtils.cancelAllNotifications(requireActivity())</span>
<span class="nc" id="L414">    }</span>

    private fun showDisconnectDialog() {
<span class="nc" id="L417">        disconnectProgressDialog = ProgressDialog.show(</span>
<span class="nc" id="L418">                requireContext(),</span>
<span class="nc" id="L419">                null,</span>
<span class="nc" id="L420">                requireContext().getText(R.string.signing_out),</span>
<span class="nc" id="L421">                false</span>
        )
<span class="nc" id="L423">    }</span>

    private fun hideDisconnectDialog() {
<span class="nc bnc" id="L426" title="All 6 branches missed.">        if (disconnectProgressDialog?.isShowing == true) {</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">            disconnectProgressDialog?.dismiss()</span>
        }
<span class="nc" id="L429">        disconnectProgressDialog = null</span>
<span class="nc" id="L430">    }</span>

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
<span class="nc" id="L433">        super.onActivityResult(requestCode, resultCode, data)</span>

        // If the fragment is not attached to the activity, we can't start the crop activity or upload the
        // cropped image.
<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (!isAdded) {</span>
<span class="nc" id="L438">            return</span>
        }
<span class="nc bnc" id="L440" title="All 3 branches missed.">        when (requestCode) {</span>
<span class="nc bnc" id="L441" title="All 4 branches missed.">            RequestCodes.PHOTO_PICKER -&gt; if (resultCode == Activity.RESULT_OK &amp;&amp; data != null) {</span>
<span class="nc" id="L442">                val mediaUriStringsArray = data.getStringArrayExtra(MediaPickerConstants.EXTRA_MEDIA_URIS)</span>
<span class="nc bnc" id="L443" title="All 4 branches missed.">                if (mediaUriStringsArray == null || mediaUriStringsArray.size == 0) {</span>
<span class="nc" id="L444">                    AppLog.e(</span>
<span class="nc" id="L445">                            UTILS,</span>
<span class="nc" id="L446">                            &quot;Can't resolve picked or captured image&quot;</span>
                    )
<span class="nc" id="L448">                    return</span>
                }
<span class="nc" id="L450">                val source = PhotoPickerMediaSource.fromString(</span>
<span class="nc" id="L451">                        data.getStringExtra(MediaPickerConstants.EXTRA_MEDIA_SOURCE)</span>
                )
<span class="nc bnc" id="L453" title="All 2 branches missed.">                val stat = if (source == ANDROID_CAMERA) ME_GRAVATAR_SHOT_NEW else ME_GRAVATAR_GALLERY_PICKED</span>
<span class="nc" id="L454">                AnalyticsTracker.track(stat)</span>
<span class="nc" id="L455">                val imageUri = Uri.parse(mediaUriStringsArray[0])</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                if (imageUri != null) {</span>
<span class="nc" id="L457">                    val didGoWell = WPMediaUtils.fetchMediaAndDoNext(</span>
<span class="nc" id="L458">                            activity,</span>
<span class="nc" id="L459">                            imageUri</span>
<span class="nc" id="L460">                    ) { uri: Uri -&gt; startCropActivity(uri) }</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                    if (!didGoWell) {</span>
<span class="nc" id="L462">                        AppLog.e(</span>
<span class="nc" id="L463">                                UTILS,</span>
<span class="nc" id="L464">                                &quot;Can't download picked or captured image&quot;</span>
                        )
                    }
                }
            }
            UCrop.REQUEST_CROP -&gt; {
<span class="nc" id="L470">                AnalyticsTracker.track(ME_GRAVATAR_CROPPED)</span>
<span class="nc bnc" id="L471" title="All 3 branches missed.">                if (resultCode == Activity.RESULT_OK) {</span>
<span class="nc" id="L472">                    WPMediaUtils.fetchMediaAndDoNext(</span>
<span class="nc" id="L473">                            activity, UCrop.getOutput(data!!)</span>
                    ) { uri: Uri? -&gt;
<span class="nc" id="L475">                        startGravatarUpload(</span>
<span class="nc" id="L476">                                MediaUtils.getRealPathFromURI(activity, uri)</span>
                        )
<span class="nc" id="L478">                    }</span>
                } else if (resultCode == UCrop.RESULT_ERROR) {
<span class="nc" id="L480">                    AppLog.e(</span>
<span class="nc" id="L481">                            MAIN,</span>
<span class="nc" id="L482">                            &quot;Image cropping failed!&quot;,</span>
<span class="nc" id="L483">                            UCrop.getError(data!!)</span>
                    )
<span class="nc" id="L485">                    ToastUtils.showToast(</span>
<span class="nc" id="L486">                            activity,</span>
<span class="nc" id="L487">                            R.string.error_cropping_image,</span>
<span class="nc" id="L488">                            SHORT</span>
                    )
                }
            }
        }
<span class="nc" id="L493">    }</span>

    private fun showPhotoPickerForGravatar() {
<span class="nc" id="L496">        mediaPickerLauncher.showGravatarPicker(this)</span>
<span class="nc" id="L497">    }</span>

    private fun startCropActivity(uri: Uri) {
<span class="nc bnc" id="L500" title="All 2 branches missed.">        val context = activity ?: return</span>
<span class="nc" id="L501">        val options = Options()</span>
<span class="nc" id="L502">        options.setShowCropGrid(false)</span>
<span class="nc" id="L503">        options.setStatusBarColor(context.getColorFromAttribute(android.R.attr.statusBarColor))</span>
<span class="nc" id="L504">        options.setToolbarColor(context.getColorFromAttribute(R.attr.wpColorAppBar))</span>
<span class="nc" id="L505">        options.setToolbarWidgetColor(context.getColorFromAttribute(attr.colorOnSurface))</span>
<span class="nc" id="L506">        options.setAllowedGestures(UCropActivity.SCALE, UCropActivity.NONE, UCropActivity.NONE)</span>
<span class="nc" id="L507">        options.setHideBottomControls(true)</span>
<span class="nc" id="L508">        UCrop.of(uri, Uri.fromFile(File(context.cacheDir, &quot;cropped_for_gravatar.jpg&quot;)))</span>
<span class="nc" id="L509">                .withAspectRatio(1f, 1f)</span>
<span class="nc" id="L510">                .withOptions(options)</span>
<span class="nc" id="L511">                .start(requireActivity(), this)</span>
<span class="nc" id="L512">    }</span>

    private fun startGravatarUpload(filePath: String) {
<span class="nc bnc" id="L515" title="All 2 branches missed.">        if (TextUtils.isEmpty(filePath)) {</span>
<span class="nc" id="L516">            ToastUtils.showToast(</span>
<span class="nc" id="L517">                    activity,</span>
<span class="nc" id="L518">                    R.string.error_locating_image,</span>
<span class="nc" id="L519">                    SHORT</span>
            )
<span class="nc" id="L521">            return</span>
        }
<span class="nc" id="L523">        val file = File(filePath)</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (!file.exists()) {</span>
<span class="nc" id="L525">            ToastUtils.showToast(</span>
<span class="nc" id="L526">                    activity,</span>
<span class="nc" id="L527">                    R.string.error_locating_image,</span>
<span class="nc" id="L528">                    SHORT</span>
            )
<span class="nc" id="L530">            return</span>
        }
<span class="nc bnc" id="L532" title="All 2 branches missed.">        binding?.showGravatarProgressBar(true)</span>
<span class="nc" id="L533">        GravatarApi.uploadGravatar(file, accountStore.account.email, accountStore.accessToken,</span>
<span class="nc" id="L534">                object : GravatarUploadListener {</span>
                    override fun onSuccess() {
<span class="nc" id="L536">                        EventBus.getDefault().post(GravatarUploadFinished(filePath, true))</span>
<span class="nc" id="L537">                    }</span>

                    override fun onError() {
<span class="nc" id="L540">                        EventBus.getDefault().post(GravatarUploadFinished(filePath, false))</span>
<span class="nc" id="L541">                    }</span>
                })
<span class="nc" id="L543">    }</span>

<span class="nc" id="L545">    class GravatarUploadFinished internal constructor(val filePath: String, val success: Boolean)</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    fun onEventMainThread(event: GravatarUploadFinished) {
<span class="nc bnc" id="L549" title="All 2 branches missed.">        binding?.showGravatarProgressBar(false)</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (event.success) {</span>
<span class="nc" id="L551">            AnalyticsTracker.track(ME_GRAVATAR_UPLOADED)</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">            binding?.loadAvatar(event.filePath)</span>
        } else {
<span class="nc" id="L554">            ToastUtils.showToast(</span>
<span class="nc" id="L555">                    activity,</span>
<span class="nc" id="L556">                    R.string.error_updating_gravatar,</span>
<span class="nc" id="L557">                    SHORT</span>
            )
        }
<span class="nc" id="L560">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    fun onAccountChanged(event: OnAccountChanged?) {
<span class="nc bnc" id="L564" title="All 2 branches missed.">        binding?.refreshAccountDetails()</span>
<span class="nc" id="L565">    }</span>

    companion object {
        private const val IS_DISCONNECTING = &quot;IS_DISCONNECTING&quot;
        private const val IS_UPDATING_GRAVATAR = &quot;IS_UPDATING_GRAVATAR&quot;
        fun newInstance(): MeFragment {
<span class="nc" id="L571">            return MeFragment()</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>