<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaginateCommentsUseCase.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.models.usecases</a> &gt; <span class="el_source">PaginateCommentsUseCase.kt</span></div><h1>PaginateCommentsUseCase.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.models.usecases

import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableSharedFlow
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.CommentStore.CommentError
import org.wordpress.android.fluxc.store.CommentStore.CommentErrorType.GENERIC_ERROR
import org.wordpress.android.fluxc.store.CommentsStore.CommentsActionPayload
import org.wordpress.android.fluxc.store.CommentsStore.CommentsData.PagingData
import org.wordpress.android.models.usecases.CommentsUseCaseType.PAGINATE_USE_CASE
import org.wordpress.android.models.usecases.PaginateCommentsUseCase.PaginateCommentsAction
import org.wordpress.android.models.usecases.PaginateCommentsUseCase.PaginateCommentsAction.OnGetPage
import org.wordpress.android.models.usecases.PaginateCommentsUseCase.PaginateCommentsAction.OnReloadFromCache
import org.wordpress.android.models.usecases.PaginateCommentsUseCase.PaginateCommentsState.Idle
import org.wordpress.android.models.usecases.PaginateCommentsUseCase.Parameters.GetPageParameters
import org.wordpress.android.models.usecases.PaginateCommentsUseCase.Parameters.ReloadFromCacheParameters
import org.wordpress.android.ui.comments.unified.CommentFilter
import org.wordpress.android.ui.comments.unified.CommentFilter.UNREPLIED
import org.wordpress.android.usecase.FlowFSMUseCase
import org.wordpress.android.usecase.UseCaseResult
import org.wordpress.android.usecase.UseCaseResult.Failure
import org.wordpress.android.usecase.UseCaseResult.Loading
import org.wordpress.android.usecase.UseCaseResult.Success
import javax.inject.Inject

<span class="nc" id="L27">class PaginateCommentsUseCase @Inject constructor(</span>
    paginateCommentsResourceProvider: PaginateCommentsResourceProvider
<span class="nc" id="L29">) : FlowFSMUseCase&lt;PaginateCommentsResourceProvider, PaginateCommentsAction, PagingData,</span>
        CommentsUseCaseType, CommentError&gt;(
<span class="nc" id="L31">        resourceProvider = paginateCommentsResourceProvider,</span>
<span class="nc" id="L32">        initialState = Idle</span>
) {
    @Suppress(&quot;LongMethod&quot;) // temporary suppress until we come up with better architecture for use cases
    sealed class PaginateCommentsState : StateInterface&lt;PaginateCommentsResourceProvider, PaginateCommentsAction,
            PagingData, CommentsUseCaseType,
            CommentError&gt; {
<span class="nc" id="L38">        object Idle : PaginateCommentsState() {</span>
<span class="nc" id="L39">            override suspend fun runAction(</span>
                utilsProvider: PaginateCommentsResourceProvider,
                action: PaginateCommentsAction,
                flowChannel: MutableSharedFlow&lt;UseCaseResult&lt;CommentsUseCaseType, CommentError, PagingData&gt;&gt;
            ): StateInterface&lt;PaginateCommentsResourceProvider, PaginateCommentsAction, PagingData, CommentsUseCaseType,
                    CommentError&gt; {
<span class="nc" id="L45">                val unrepliedCommentsUtils = utilsProvider.unrepliedCommentsUtils</span>
<span class="nc" id="L46">                return when (action) {</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">                    is OnGetPage -&gt; {</span>
<span class="nc" id="L48">                        val parameters = action.parameters</span>
<span class="nc" id="L49">                        val commentsStore = utilsProvider.commentsStore</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">                        if (parameters.offset == 0) {</span>
<span class="nc" id="L51">                            flowChannel.emit(Loading(PAGINATE_USE_CASE))</span>
<span class="nc" id="L52">                            delay(LOADING_STATE_DELAY)</span>
                        }
<span class="nc bnc" id="L54" title="All 2 branches missed.">                        val result = if (!utilsProvider.networkUtilsWrapper.isNetworkAvailable()) {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">                            val cachedComments = if (parameters.offset &gt; 0) {</span>
<span class="nc" id="L56">                                commentsStore.getCommentsForSite(</span>
<span class="nc" id="L57">                                        site = parameters.site,</span>
<span class="nc" id="L58">                                        orderByDateAscending = false,</span>
<span class="nc" id="L59">                                        limit = parameters.offset,</span>
<span class="nc" id="L60">                                        statuses = parameters.commentFilter.toCommentCacheStatuses().toTypedArray()</span>
                                )
                            } else {
<span class="nc" id="L63">                                listOf()</span>
                            }
<span class="nc" id="L65">                            CommentsActionPayload(</span>
<span class="nc" id="L66">                                    CommentError(</span>
<span class="nc" id="L67">                                            GENERIC_ERROR,</span>
<span class="nc" id="L68">                                            utilsProvider.resourceProvider.getString(R.string.no_network_message)</span>
<span class="nc" id="L69">                                    ), PagingData(</span>
<span class="nc" id="L70">                                    comments = cachedComments,</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">                                    hasMore = cachedComments.isNotEmpty()</span>
                            )
                            )
                        } else {
<span class="nc" id="L75">                            commentsStore.fetchCommentsPage(</span>
<span class="nc" id="L76">                                    site = parameters.site,</span>
<span class="nc" id="L77">                                    number = parameters.number,</span>
<span class="nc" id="L78">                                    offset = parameters.offset,</span>
<span class="nc" id="L79">                                    networkStatusFilter = parameters.commentFilter.toCommentStatus(),</span>
<span class="nc" id="L80">                                    cacheStatuses = parameters.commentFilter.toCommentCacheStatuses()</span>
                            )
                        }

<span class="nc bnc" id="L84" title="All 2 branches missed.">                        val data = (result.data ?: PagingData.empty()).let {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                            if (parameters.commentFilter == UNREPLIED) {</span>
<span class="nc" id="L86">                                it.copy(comments = unrepliedCommentsUtils.getUnrepliedComments(it.comments))</span>
<span class="nc" id="L87">                            } else it</span>
                        }

<span class="nc bnc" id="L90" title="All 2 branches missed.">                        if (result.isError) {</span>
<span class="nc" id="L91">                            flowChannel.emit(Failure(PAGINATE_USE_CASE, result.error, data))</span>
                        } else {
<span class="nc" id="L93">                            flowChannel.emit(Success(PAGINATE_USE_CASE, data))</span>
                        }

<span class="nc" id="L96">                        Idle</span>
                    }
<span class="nc" id="L98">                    is OnReloadFromCache -&gt; {</span>
<span class="nc" id="L99">                        val parameters = action.parameters</span>
<span class="nc" id="L100">                        val commentsStore = utilsProvider.commentsStore</span>

<span class="nc" id="L102">                        val result = commentsStore.getCachedComments(</span>
<span class="nc" id="L103">                                site = parameters.pagingParameters.site,</span>
<span class="nc" id="L104">                                cacheStatuses = parameters.pagingParameters.commentFilter.toCommentCacheStatuses(),</span>
<span class="nc" id="L105">                                imposeHasMore = parameters.hasMore</span>
                        )

<span class="nc bnc" id="L108" title="All 2 branches missed.">                        val data = (result.data ?: PagingData.empty()).let {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                            if (parameters.pagingParameters.commentFilter == UNREPLIED) {</span>
<span class="nc" id="L110">                                it.copy(comments = unrepliedCommentsUtils.getUnrepliedComments(it.comments))</span>
<span class="nc" id="L111">                            } else it</span>
                        }

<span class="nc bnc" id="L114" title="All 2 branches missed.">                        if (result.isError) {</span>
<span class="nc" id="L115">                            flowChannel.emit(Failure(PAGINATE_USE_CASE, result.error, data))</span>
                        } else {
<span class="nc" id="L117">                            flowChannel.emit(Success(PAGINATE_USE_CASE, data))</span>
                        }

<span class="nc" id="L120">                        Idle</span>
                    }
                }
            }
        }
    }

    sealed class PaginateCommentsAction {
<span class="nc" id="L128">        data class OnGetPage(</span>
<span class="nc" id="L129">            val parameters: GetPageParameters</span>
<span class="nc" id="L130">        ) : PaginateCommentsAction()</span>

<span class="nc" id="L132">        data class OnReloadFromCache(</span>
<span class="nc" id="L133">            val parameters: ReloadFromCacheParameters</span>
<span class="nc" id="L134">        ) : PaginateCommentsAction()</span>
    }

    sealed class Parameters {
<span class="nc" id="L138">        data class GetPageParameters(</span>
<span class="nc" id="L139">            val site: SiteModel,</span>
<span class="nc" id="L140">            val number: Int,</span>
<span class="nc" id="L141">            val offset: Int,</span>
<span class="nc" id="L142">            val commentFilter: CommentFilter</span>
<span class="nc" id="L143">        ) : Parameters()</span>

<span class="nc" id="L145">        data class ReloadFromCacheParameters(</span>
<span class="nc" id="L146">            val pagingParameters: GetPageParameters,</span>
<span class="nc" id="L147">            val hasMore: Boolean</span>
<span class="nc" id="L148">        ) : Parameters()</span>
    }

    companion object {
        const val LOADING_STATE_DELAY = 500L
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>