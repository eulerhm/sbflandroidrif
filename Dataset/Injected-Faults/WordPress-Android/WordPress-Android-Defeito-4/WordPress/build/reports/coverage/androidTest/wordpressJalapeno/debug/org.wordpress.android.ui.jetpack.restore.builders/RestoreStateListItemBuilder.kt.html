<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestoreStateListItemBuilder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.jetpack.restore.builders</a> &gt; <span class="el_source">RestoreStateListItemBuilder.kt</span></div><h1>RestoreStateListItemBuilder.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.jetpack.restore.builders

import androidx.annotation.ColorRes
import androidx.annotation.DimenRes
import androidx.annotation.DrawableRes
import androidx.annotation.StringRes
import dagger.Reusable
import org.wordpress.android.Constants
import org.wordpress.android.R
import org.wordpress.android.ui.jetpack.common.CheckboxSpannableLabel
import org.wordpress.android.ui.jetpack.common.JetpackBackupRestoreListItemState.BulletState
import org.wordpress.android.ui.jetpack.common.JetpackBackupRestoreListItemState.FootnoteState
import org.wordpress.android.ui.jetpack.common.JetpackBackupRestoreListItemState.SubHeaderState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.ActionButtonState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.CheckboxState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.DescriptionState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.HeaderState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.IconState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.ProgressState
import org.wordpress.android.ui.jetpack.common.ViewType.CHECKBOX
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItem
import org.wordpress.android.ui.jetpack.common.providers.JetpackAvailableItemsProvider.JetpackAvailableItemType
import org.wordpress.android.ui.jetpack.restore.RestoreErrorTypes
import org.wordpress.android.ui.jetpack.restore.RestoreErrorTypes.RemoteRequestFailure
import org.wordpress.android.ui.jetpack.restore.RestoreUiState
import org.wordpress.android.ui.utils.HtmlMessageUtils
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringResWithParams
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.extensions.toFormattedDateString
import org.wordpress.android.util.extensions.toFormattedTimeString
import java.util.Date
import javax.inject.Inject

<span class="nc" id="L36">@Reusable</span>
<span class="nc" id="L37">class RestoreStateListItemBuilder @Inject constructor(</span>
<span class="nc" id="L38">    private val checkboxSpannableLabel: CheckboxSpannableLabel,</span>
<span class="nc" id="L39">    private val htmlMessageUtils: HtmlMessageUtils</span>
) {
    @Suppress(&quot;LongParameterList&quot;)
    fun buildDetailsListStateItems(
        published: Date,
        availableItems: List&lt;JetpackAvailableItem&gt;,
        siteId: Long,
        isAwaitingCredentials: Boolean,
        onCreateDownloadClick: () -&gt; Unit,
        onCheckboxItemClicked: (availableItemType: JetpackAvailableItemType) -&gt; Unit,
        onEnterServerCredsIconClicked: () -&gt; Unit
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L51">        val items = mutableListOf(</span>
<span class="nc" id="L52">                buildIconState(</span>
<span class="nc" id="L53">                        R.drawable.ic_history_white_24dp,</span>
<span class="nc" id="L54">                        R.string.restore_details_icon_content_description,</span>
<span class="nc" id="L55">                        R.color.success</span>
                ),
<span class="nc" id="L57">                buildHeaderState(R.string.restore_details_header),</span>
<span class="nc" id="L58">                buildDescriptionState(published, R.string.restore_details_description_with_two_parameters),</span>
<span class="nc" id="L59">                buildActionButtonState(</span>
<span class="nc" id="L60">                        titleRes = R.string.restore_details_action_button,</span>
<span class="nc" id="L61">                        contentDescRes = R.string.restore_details_action_button_content_description,</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">                        isEnabled = !isAwaitingCredentials,</span>
<span class="nc" id="L63">                        onClick = onCreateDownloadClick</span>
                )
        )
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (isAwaitingCredentials) {</span>
<span class="nc" id="L67">            items.add(</span>
<span class="nc" id="L68">                    buildEnterServerCredsMessageState(</span>
<span class="nc" id="L69">                            onEnterServerCredsIconClicked,</span>
<span class="nc" id="L70">                            siteId = siteId,</span>
<span class="nc" id="L71">                            iconResId = R.drawable.ic_plus_white_24dp,</span>
<span class="nc" id="L72">                            iconColorResId = R.color.colorPrimary,</span>
<span class="nc" id="L73">                            iconSizeResId = R.dimen.jetpack_backup_restore_footnote_enter_server_creds_icon_size</span>
                    )
            )
        }
<span class="nc" id="L77">        items.add(buildSubHeaderState(R.string.restore_details_choose_items_header))</span>

<span class="nc" id="L79">        val availableItemsListItems: List&lt;CheckboxState&gt; = availableItems.map {</span>
<span class="nc" id="L80">            CheckboxState(</span>
<span class="nc" id="L81">                    availableItemType = it.availableItemType,</span>
<span class="nc" id="L82">                    label = UiStringRes(it.labelResId),</span>
<span class="nc" id="L83">                    labelSpannable = checkboxSpannableLabel.buildSpannableLabel(it.labelResId, it.labelHintResId),</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                    checked = !isAwaitingCredentials,</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    isEnabled = !isAwaitingCredentials,</span>
<span class="nc" id="L86">                    onClick = { onCheckboxItemClicked(it.availableItemType) }</span>
            )
        }
<span class="nc" id="L89">        items.addAll(availableItemsListItems)</span>
<span class="nc" id="L90">        return items</span>
    }

    fun buildWarningListStateItems(
        published: Date,
        onConfirmRestoreClick: () -&gt; Unit,
        onCancelClick: () -&gt; Unit
<span class="nc" id="L97">    ): List&lt;JetpackListItemState&gt; = listOf(</span>
<span class="nc" id="L98">            buildIconState(</span>
<span class="nc" id="L99">                    R.drawable.ic_notice_white_24dp,</span>
<span class="nc" id="L100">                    R.string.restore_warning_icon_content_description,</span>
<span class="nc" id="L101">                    R.color.error</span>
            ),
<span class="nc" id="L103">            buildHeaderState(R.string.restore_warning_header),</span>
<span class="nc" id="L104">            buildDescriptionState(published, R.string.restore_warning_description_with_two_parameters),</span>
<span class="nc" id="L105">            buildActionButtonState(</span>
<span class="nc" id="L106">                    titleRes = R.string.restore_warning_action_button,</span>
<span class="nc" id="L107">                    contentDescRes = R.string.restore_warning_action_button_content_description,</span>
<span class="nc" id="L108">                    onClick = onConfirmRestoreClick</span>
            ),
<span class="nc" id="L110">            buildActionButtonState(</span>
<span class="nc" id="L111">                    titleRes = R.string.cancel,</span>
<span class="nc" id="L112">                    contentDescRes = R.string.cancel,</span>
<span class="nc" id="L113">                    isSecondary = true,</span>
<span class="nc" id="L114">                    onClick = onCancelClick</span>
            )
<span class="nc" id="L116">    )</span>

<span class="nc" id="L118">    fun buildProgressListStateItems(</span>
<span class="nc" id="L119">        progress: Int = 0,</span>
        published: Date,
<span class="nc" id="L121">        isIndeterminate: Boolean = false</span>
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L123">        return mutableListOf(</span>
<span class="nc" id="L124">                buildIconState(</span>
<span class="nc" id="L125">                        R.drawable.ic_history_white_24dp,</span>
<span class="nc" id="L126">                        R.string.restore_progress_icon_content_description,</span>
<span class="nc" id="L127">                        R.color.success</span>
                ),
<span class="nc" id="L129">                buildHeaderState(R.string.restore_progress_header),</span>
<span class="nc" id="L130">                buildDescriptionState(published, R.string.restore_progress_description_with_two_parameters),</span>
<span class="nc" id="L131">                buildProgressState(progress, isIndeterminate),</span>
<span class="nc" id="L132">                buildFootnoteState(</span>
<span class="nc" id="L133">                        iconRes = R.drawable.ic_info_outline_white_24dp,</span>
<span class="nc" id="L134">                        iconSizeResId = R.dimen.jetpack_backup_restore_footnote_icon_size,</span>
<span class="nc" id="L135">                        textRes = R.string.restore_progress_footnote</span>
                )
        )
    }

    fun buildCompleteListStateItems(
        published: Date,
        onDoneClick: () -&gt; Unit,
        onVisitSiteClick: () -&gt; Unit
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L145">        return listOf(</span>
<span class="nc" id="L146">                buildIconState(</span>
<span class="nc" id="L147">                        R.drawable.ic_history_white_24dp,</span>
<span class="nc" id="L148">                        R.string.restore_complete_icon_content_description,</span>
<span class="nc" id="L149">                        R.color.success</span>
                ),
<span class="nc" id="L151">                buildHeaderState(R.string.restore_complete_header),</span>
<span class="nc" id="L152">                buildDescriptionState(published, R.string.restore_complete_description_with_two_parameters),</span>
<span class="nc" id="L153">                buildActionButtonState(</span>
<span class="nc" id="L154">                        titleRes = R.string.restore_complete_done_action_button,</span>
<span class="nc" id="L155">                        contentDescRes = R.string.restore_complete_done_button_content_description,</span>
<span class="nc" id="L156">                        onClick = onDoneClick</span>
                ),
<span class="nc" id="L158">                buildActionButtonState(</span>
<span class="nc" id="L159">                        titleRes = R.string.restore_complete_visit_site_action_button,</span>
<span class="nc" id="L160">                        contentDescRes = R.string.restore_complete_visit_site_button_content_description,</span>
<span class="nc" id="L161">                        isSecondary = true,</span>
<span class="nc" id="L162">                        onClick = onVisitSiteClick</span>
                )
        )
    }

    fun buildErrorListStateErrorItems(errorType: RestoreErrorTypes, onDoneClick: () -&gt; Unit) = (
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (errorType == RemoteRequestFailure) buildStatusErrorListStateItems(onDoneClick)</span>
<span class="nc" id="L169">            else buildGenericErrorListStateItems(onDoneClick)</span>
            )

<span class="nc" id="L172">    private fun buildStatusErrorListStateItems(onDoneClick: () -&gt; Unit) = listOf(</span>
<span class="nc" id="L173">            buildHeaderState(R.string.restore_status_failure_heading),</span>
<span class="nc" id="L174">            buildBulletState(</span>
<span class="nc" id="L175">                    R.drawable.ic_query_builder_white_24dp,</span>
<span class="nc" id="L176">                    R.string.restore_status_bullet_clock_icon_content_desc,</span>
<span class="nc" id="L177">                    R.color.warning,</span>
<span class="nc" id="L178">                    R.string.restore_status_failure_bullet1</span>
            ),
<span class="nc" id="L180">            buildBulletState(</span>
<span class="nc" id="L181">                    R.drawable.ic_gridicons_checkmark_circle,</span>
<span class="nc" id="L182">                    R.string.restore_status_bullet_checkmark_icon_content_desc,</span>
<span class="nc" id="L183">                    R.color.success,</span>
<span class="nc" id="L184">                    R.string.restore_status_failure_bullet2</span>
            ),
<span class="nc" id="L186">            buildBulletState(</span>
<span class="nc" id="L187">                    R.drawable.ic_gridicons_checkmark_circle,</span>
<span class="nc" id="L188">                    R.string.restore_status_bullet_checkmark_icon_content_desc,</span>
<span class="nc" id="L189">                    R.color.success,</span>
<span class="nc" id="L190">                    R.string.restore_status_failure_bullet3,</span>
<span class="nc" id="L191">                    R.dimen.jetpack_backup_restore_last_bullet_bottom_margin</span>
            ),
<span class="nc" id="L193">            buildActionButtonState(</span>
<span class="nc" id="L194">                    titleRes = R.string.restore_complete_failed_action_button,</span>
<span class="nc" id="L195">                    contentDescRes = R.string.restore_complete_failed_action_button_content_description,</span>
<span class="nc" id="L196">                    onClick = onDoneClick</span>
            )
<span class="nc" id="L198">    )</span>

<span class="nc" id="L200">    private fun buildGenericErrorListStateItems(onDoneClick: () -&gt; Unit) = listOf(</span>
<span class="nc" id="L201">            buildIconState(</span>
<span class="nc" id="L202">                    R.drawable.ic_notice_white_24dp,</span>
<span class="nc" id="L203">                    R.string.restore_complete_failed_icon_content_description,</span>
<span class="nc" id="L204">                    R.color.error</span>
            ),
<span class="nc" id="L206">            buildHeaderState(R.string.restore_complete_failed_description),</span>
<span class="nc" id="L207">            buildDescriptionState(descRes = R.string.request_failed_message),</span>
<span class="nc" id="L208">            buildActionButtonState(</span>
<span class="nc" id="L209">                    titleRes = R.string.restore_complete_failed_action_button,</span>
<span class="nc" id="L210">                    contentDescRes = R.string.restore_complete_failed_action_button_content_description,</span>
<span class="nc" id="L211">                    onClick = onDoneClick</span>
            )
<span class="nc" id="L213">    )</span>

    private fun buildIconState(
        @DrawableRes iconRes: Int,
        @StringRes contentDescRes: Int,
        @ColorRes colorRes: Int
<span class="nc" id="L219">    ) = IconState(</span>
<span class="nc" id="L220">            icon = iconRes,</span>
<span class="nc" id="L221">            contentDescription = UiStringRes(contentDescRes),</span>
<span class="nc" id="L222">            colorResId = colorRes</span>
<span class="nc" id="L223">    )</span>

<span class="nc" id="L225">    private fun buildHeaderState(@StringRes titleRes: Int) = HeaderState(UiStringRes(titleRes))</span>

<span class="nc" id="L227">    private fun buildDescriptionState(published: Date? = null, @StringRes descRes: Int) = DescriptionState(</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (published != null) {</span>
<span class="nc" id="L229">                UiStringResWithParams(</span>
<span class="nc" id="L230">                        descRes,</span>
<span class="nc" id="L231">                        listOf(</span>
<span class="nc" id="L232">                                UiStringText(published.toFormattedDateString()),</span>
<span class="nc" id="L233">                                UiStringText(published.toFormattedTimeString())</span>
                        )
                )
            } else {
<span class="nc" id="L237">                UiStringRes(descRes)</span>
            }
<span class="nc" id="L239">    )</span>

<span class="nc" id="L241">    private fun buildActionButtonState(</span>
        @StringRes titleRes: Int,
        @StringRes contentDescRes: Int,
<span class="nc" id="L244">        isSecondary: Boolean = false,</span>
<span class="nc" id="L245">        isEnabled: Boolean = true,</span>
        onClick: () -&gt; Unit
<span class="nc" id="L247">    ) = ActionButtonState(</span>
<span class="nc" id="L248">            text = UiStringRes(titleRes),</span>
<span class="nc" id="L249">            contentDescription = UiStringRes(contentDescRes),</span>
<span class="nc" id="L250">            isSecondary = isSecondary,</span>
<span class="nc" id="L251">            onClick = onClick,</span>
<span class="nc" id="L252">            isEnabled = isEnabled</span>
<span class="nc" id="L253">    )</span>

<span class="nc" id="L255">    private fun buildEnterServerCredsMessageState(</span>
        onEnterServerCredsIconClicked: () -&gt; Unit,
        siteId: Long,
<span class="nc" id="L258">        @DrawableRes iconResId: Int? = null,</span>
<span class="nc" id="L259">        @ColorRes iconColorResId: Int? = null,</span>
<span class="nc" id="L260">        @DimenRes iconSizeResId: Int? = null</span>
    ): FootnoteState {
<span class="nc" id="L262">        return FootnoteState(</span>
<span class="nc" id="L263">                iconRes = iconResId,</span>
<span class="nc" id="L264">                iconColorResId = iconColorResId,</span>
<span class="nc" id="L265">                iconSizeResId = iconSizeResId,</span>
<span class="nc" id="L266">                text = UiStringText(</span>
<span class="nc" id="L267">                        htmlMessageUtils.getHtmlMessageFromStringFormatResId(</span>
<span class="nc" id="L268">                                R.string.restore_details_enter_server_creds_msg,</span>
<span class="nc" id="L269">                                &quot;${Constants.URL_JETPACK_SETTINGS}/$siteId&quot;</span>
                        )
                ),
<span class="nc" id="L272">                onIconClick = onEnterServerCredsIconClicked</span>
        )
    }

<span class="nc" id="L276">    private fun buildSubHeaderState(</span>
        @StringRes textResId: Int,
<span class="nc" id="L278">        @DimenRes topMarginResId: Int? = null,</span>
<span class="nc" id="L279">        @DimenRes bottomMarginResId: Int? = null</span>
<span class="nc" id="L280">    ) = SubHeaderState(</span>
<span class="nc" id="L281">            text = UiStringRes(textResId),</span>
<span class="nc" id="L282">            itemTopMarginResId = topMarginResId,</span>
<span class="nc" id="L283">            itemBottomMarginResId = bottomMarginResId</span>
<span class="nc" id="L284">    )</span>

<span class="nc" id="L286">    private fun buildFootnoteState(</span>
<span class="nc" id="L287">        @DrawableRes iconRes: Int? = null,</span>
<span class="nc" id="L288">        @DimenRes iconSizeResId: Int? = null,</span>
        @StringRes textRes: Int
<span class="nc" id="L290">    ) = FootnoteState(</span>
<span class="nc" id="L291">            iconRes = iconRes,</span>
<span class="nc" id="L292">            iconSizeResId = iconSizeResId,</span>
<span class="nc" id="L293">            text = UiStringRes(textRes)</span>
<span class="nc" id="L294">    )</span>

<span class="nc" id="L296">    private fun buildProgressState(progress: Int, isIndeterminate: Boolean = false) = ProgressState(</span>
<span class="nc" id="L297">            progress = progress,</span>
<span class="nc" id="L298">            isIndeterminate = isIndeterminate,</span>
<span class="nc" id="L299">            progressLabel = UiStringResWithParams(</span>
<span class="nc" id="L300">                    R.string.restore_progress_label, listOf(UiStringText(progress.toString()))</span>
            )
<span class="nc" id="L302">    )</span>

<span class="nc" id="L304">    private fun buildBulletState(</span>
        @DrawableRes iconRes: Int,
        @StringRes contentDescRes: Int,
        @ColorRes colorRes: Int,
        @StringRes labelRes: Int,
<span class="nc" id="L309">        @DimenRes itemBottomMarginResId: Int? = null</span>
<span class="nc" id="L310">    ) = BulletState(</span>
<span class="nc" id="L311">            icon = iconRes,</span>
<span class="nc" id="L312">            contentDescription = UiStringRes(contentDescRes),</span>
<span class="nc" id="L313">            colorResId = colorRes,</span>
<span class="nc" id="L314">            label = UiStringRes(labelRes),</span>
<span class="nc" id="L315">            itemBottomMarginResId = itemBottomMarginResId</span>
<span class="nc" id="L316">    )</span>

    fun updateCheckboxes(
        uiState: RestoreUiState,
        itemType: JetpackAvailableItemType
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L322">        val updatedCheckboxes = uiState.items.map { state -&gt;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">            if (state.type == CHECKBOX) {</span>
<span class="nc" id="L324">                state as CheckboxState</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if (state.availableItemType == itemType) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                    state.copy(checked = !state.checked)</span>
                } else {
<span class="nc" id="L328">                    state</span>
                }
            } else {
<span class="nc" id="L331">                state</span>
            }
        }
<span class="nc bnc" id="L334" title="All 6 branches missed.">        val atLeastOneChecked = updatedCheckboxes.filterIsInstance&lt;CheckboxState&gt;().find { it.checked } != null</span>
<span class="nc" id="L335">        return updateDetailsActionButtonState(updatedCheckboxes, atLeastOneChecked)</span>
    }

    private fun updateDetailsActionButtonState(
        details: List&lt;JetpackListItemState&gt;,
        enableActionButton: Boolean
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L342">        return details.map { state -&gt;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if (state is ActionButtonState) {</span>
<span class="nc" id="L344">                state.copy(isEnabled = enableActionButton)</span>
            } else {
<span class="nc" id="L346">                state</span>
            }
        }
    }

    fun updateProgressActionButtonState(uiState: RestoreUiState, value: Boolean): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L352">        return uiState.items.map { state -&gt;</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (state is ActionButtonState) {</span>
<span class="nc" id="L354">                state.copy(isEnabled = value)</span>
            } else {
<span class="nc" id="L356">                state</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>