<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderLikingUsersView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.views</a> &gt; <span class="el_source">ReaderLikingUsersView.java</span></div><h1>ReaderLikingUsersView.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.views;

import android.content.Context;
import android.os.AsyncTask;
import android.util.AttributeSet;
import android.view.Gravity;
import android.view.LayoutInflater;
import android.widget.ImageView;
import android.widget.LinearLayout;

import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.datasets.ReaderLikeTable;
import org.wordpress.android.datasets.ReaderUserTable;
import org.wordpress.android.models.ReaderPost;
import org.wordpress.android.models.ReaderUserIdList;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageType;

import java.lang.ref.WeakReference;
import java.util.ArrayList;

import javax.inject.Inject;

/*
 * LinearLayout which shows liking users - used by ReaderPostDetailFragment
 */
public class ReaderLikingUsersView extends LinearLayout {
    @Inject ImageManager mImageManager;
    private LoadAvatarsTask mLoadAvatarsTask;
    private final int mLikeAvatarSz;

    public ReaderLikingUsersView(Context context) {
<span class="nc" id="L35">        this(context, null);</span>
<span class="nc" id="L36">    }</span>

    public ReaderLikingUsersView(Context context, AttributeSet attrs) {
<span class="nc" id="L39">        super(context, attrs);</span>
<span class="nc" id="L40">        ((WordPress) context.getApplicationContext()).component().inject(this);</span>

<span class="nc" id="L42">        setOrientation(HORIZONTAL);</span>
<span class="nc" id="L43">        setGravity(Gravity.CENTER_VERTICAL);</span>

<span class="nc" id="L45">        mLikeAvatarSz = context.getResources().getDimensionPixelSize(R.dimen.avatar_sz_small);</span>
<span class="nc" id="L46">    }</span>

    public void showLikingUsers(final ReaderPost post, final long currentUserId) {
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (post == null) {</span>
<span class="nc" id="L50">            return;</span>
        }

<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (mLoadAvatarsTask != null) {</span>
<span class="nc" id="L54">            mLoadAvatarsTask.cancel(false);</span>
        }
<span class="nc" id="L56">        mLoadAvatarsTask = new LoadAvatarsTask(this, currentUserId, mLikeAvatarSz, getMaxAvatars());</span>
<span class="nc" id="L57">        mLoadAvatarsTask.execute(post);</span>
<span class="nc" id="L58">    }</span>

    @Override
    protected void onDetachedFromWindow() {
<span class="nc" id="L62">        super.onDetachedFromWindow();</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (mLoadAvatarsTask != null) {</span>
<span class="nc" id="L64">            mLoadAvatarsTask.cancel(false);</span>
        }
<span class="nc" id="L66">    }</span>

    /*
     * returns count of avatars that can fit the current space
     */
    private int getMaxAvatars() {
<span class="nc" id="L72">        final int marginAvatar = getResources().getDimensionPixelSize(R.dimen.margin_extra_small);</span>
<span class="nc" id="L73">        final int marginReader = getResources().getDimensionPixelSize(R.dimen.reader_detail_margin);</span>
<span class="nc" id="L74">        int likeAvatarSizeWithMargin = mLikeAvatarSz + (marginAvatar * 2);</span>
<span class="nc" id="L75">        int spaceForAvatars = getWidth() - (marginReader * 2);</span>
<span class="nc" id="L76">        return spaceForAvatars / likeAvatarSizeWithMargin;</span>
    }

    /*
     * note that the passed list of avatar urls has already been Photon-ized,
     * so there's no need to do that here
     */
    private void showLikingAvatars(final ArrayList&lt;String&gt; avatarUrls) {
<span class="nc bnc" id="L84" title="All 4 branches missed.">        if (avatarUrls == null || avatarUrls.size() == 0) {</span>
<span class="nc" id="L85">            removeAllViews();</span>
<span class="nc" id="L86">            return;</span>
        }

        // remove excess existing views
<span class="nc" id="L90">        int numExistingViews = getChildCount();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (numExistingViews &gt; avatarUrls.size()) {</span>
<span class="nc" id="L92">            int numToRemove = numExistingViews - avatarUrls.size();</span>
<span class="nc" id="L93">            removeViews(numExistingViews - numToRemove, numToRemove);</span>
        }

<span class="nc" id="L96">        int index = 0;</span>
<span class="nc" id="L97">        LayoutInflater inflater = LayoutInflater.from(getContext());</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        for (String url : avatarUrls) {</span>
            ImageView imgAvatar;
            // reuse existing view when possible, otherwise inflate a new one
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (index &lt; numExistingViews) {</span>
<span class="nc" id="L102">                imgAvatar = (ImageView) getChildAt(index);</span>
            } else {
<span class="nc" id="L104">                imgAvatar = (ImageView) inflater.inflate(R.layout.reader_like_avatar, this, false);</span>
<span class="nc" id="L105">                addView(imgAvatar);</span>
            }
<span class="nc" id="L107">            mImageManager.loadIntoCircle(imgAvatar, ImageType.AVATAR, StringUtils.notNullStr(url));</span>
<span class="nc" id="L108">            index++;</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">    }</span>

    private static class LoadAvatarsTask extends AsyncTask&lt;ReaderPost, Void, ArrayList&lt;String&gt;&gt; {
        private final WeakReference&lt;ReaderLikingUsersView&gt; mViewReference;
        private final long mCurrentUserId;
        private final int mLikeAvatarSize;
        private final int mMaxAvatars;

<span class="nc" id="L118">        LoadAvatarsTask(ReaderLikingUsersView view, long currentUserId, int likeAvatarSz, int maxAvatars) {</span>
<span class="nc" id="L119">            mViewReference = new WeakReference&lt;&gt;(view);</span>
<span class="nc" id="L120">            mCurrentUserId = currentUserId;</span>
<span class="nc" id="L121">            mLikeAvatarSize = likeAvatarSz;</span>
<span class="nc" id="L122">            mMaxAvatars = maxAvatars;</span>
<span class="nc" id="L123">        }</span>

        @Override
        protected ArrayList&lt;String&gt; doInBackground(ReaderPost... posts) {
<span class="nc bnc" id="L127" title="All 4 branches missed.">            if (posts.length != 1 || posts[0] == null) {</span>
<span class="nc" id="L128">                return null;</span>
            }
<span class="nc" id="L130">            ReaderPost post = posts[0];</span>
<span class="nc" id="L131">            ReaderUserIdList avatarIds = ReaderLikeTable.getLikesForPost(post);</span>
<span class="nc" id="L132">            return ReaderUserTable.getAvatarUrls(avatarIds, mMaxAvatars, mLikeAvatarSize, mCurrentUserId);</span>
        }

        @Override
        protected void onPostExecute(ArrayList&lt;String&gt; avatars) {
<span class="nc" id="L137">            super.onPostExecute(avatars);</span>
<span class="nc" id="L138">            ReaderLikingUsersView view = mViewReference.get();</span>
<span class="nc bnc" id="L139" title="All 6 branches missed.">            if (view != null &amp;&amp; avatars != null &amp;&amp; !isCancelled()) {</span>
<span class="nc" id="L140">                view.mLoadAvatarsTask = null;</span>
<span class="nc" id="L141">                view.showLikingAvatars(avatars);</span>
            }
<span class="nc" id="L143">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>