<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderPostServiceStarter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.reader.services.post</a> &gt; <span class="el_source">ReaderPostServiceStarter.java</span></div><h1>ReaderPostServiceStarter.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.reader.services.post;

import android.app.job.JobInfo;
import android.app.job.JobScheduler;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.os.Build;
import android.os.PersistableBundle;

import org.wordpress.android.models.ReaderTag;
import org.wordpress.android.util.AppLog;

<span class="nc" id="L14">public class ReaderPostServiceStarter {</span>
    private static final int JOB_READER_POST_SERVICE_ID_TAG = 4001;
    private static final int JOB_READER_POST_SERVICE_ID_BLOG = 4002;
    private static final int JOB_READER_POST_SERVICE_ID_FEED = 4003;
    public static final String ARG_TAG = &quot;tag&quot;;
    public static final String ARG_ACTION = &quot;action&quot;;
    public static final String ARG_BLOG_ID = &quot;blog_id&quot;;
    public static final String ARG_FEED_ID = &quot;feed_id&quot;;

    public static final String ARG_TAG_PARAM_SLUG = &quot;tag-slug&quot;;
    public static final String ARG_TAG_PARAM_DISPLAY_NAME = &quot;tag-display-name&quot;;
    public static final String ARG_TAG_PARAM_TITLE = &quot;tag-title&quot;;
    public static final String ARG_TAG_PARAM_ENDPOINT = &quot;tag-endpoint&quot;;
    public static final String ARG_TAG_PARAM_TAGTYPE = &quot;tag-type&quot;;

<span class="nc" id="L29">    public enum UpdateAction {</span>
<span class="nc" id="L30">        REQUEST_NEWER, // request the newest posts for this tag/blog/feed</span>
<span class="nc" id="L31">        REQUEST_REFRESH, // request fresh data and get rid of the rest</span>
<span class="nc" id="L32">        REQUEST_OLDER, // request posts older than the oldest existing one for this tag/blog/feed</span>
<span class="nc" id="L33">        REQUEST_OLDER_THAN_GAP // request posts older than the one with the gap marker for this tag</span>
                               // (not supported for blog/feed)
    }

    /*
     * update posts with the passed tag
     */
    public static void startServiceForTag(Context context, ReaderTag tag, UpdateAction action) {
<span class="nc bnc" id="L41" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) {</span>
<span class="nc" id="L42">            Intent intent = new Intent(context, ReaderPostService.class);</span>
<span class="nc" id="L43">            intent.putExtra(ARG_TAG, tag);</span>
<span class="nc" id="L44">            intent.putExtra(ARG_ACTION, action);</span>
<span class="nc" id="L45">            context.startService(intent);</span>
<span class="nc" id="L46">        } else {</span>
<span class="nc" id="L47">            PersistableBundle extras = new PersistableBundle();</span>
<span class="nc" id="L48">            extras.putInt(ARG_ACTION, action.ordinal());</span>
<span class="nc" id="L49">            putReaderTagExtras(extras, tag);</span>
<span class="nc" id="L50">            doScheduleJobWithBundle(context, extras, JOB_READER_POST_SERVICE_ID_TAG + tag.getTagSlug().hashCode());</span>
        }
<span class="nc" id="L52">    }</span>

    /*
     * update posts in the passed blog
     */
    public static void startServiceForBlog(Context context, long blogId, UpdateAction action) {
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) {</span>
<span class="nc" id="L59">            Intent intent = new Intent(context, ReaderPostService.class);</span>
<span class="nc" id="L60">            intent.putExtra(ARG_BLOG_ID, blogId);</span>
<span class="nc" id="L61">            intent.putExtra(ARG_ACTION, action);</span>
<span class="nc" id="L62">            context.startService(intent);</span>
<span class="nc" id="L63">        } else {</span>
<span class="nc" id="L64">            PersistableBundle extras = new PersistableBundle();</span>
<span class="nc" id="L65">            extras.putLong(ARG_BLOG_ID, blogId);</span>
<span class="nc" id="L66">            extras.putInt(ARG_ACTION, action.ordinal());</span>
<span class="nc" id="L67">            doScheduleJobWithBundle(context, extras, JOB_READER_POST_SERVICE_ID_BLOG);</span>
        }
<span class="nc" id="L69">    }</span>

    /*
     * update posts in the passed feed
     */
    public static void startServiceForFeed(Context context, long feedId, UpdateAction action) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) {</span>
<span class="nc" id="L76">            Intent intent = new Intent(context, ReaderPostService.class);</span>
<span class="nc" id="L77">            intent.putExtra(ARG_FEED_ID, feedId);</span>
<span class="nc" id="L78">            intent.putExtra(ARG_ACTION, action);</span>
<span class="nc" id="L79">            context.startService(intent);</span>
<span class="nc" id="L80">        } else {</span>
<span class="nc" id="L81">            PersistableBundle extras = new PersistableBundle();</span>
<span class="nc" id="L82">            extras.putLong(ARG_FEED_ID, feedId);</span>
<span class="nc" id="L83">            extras.putInt(ARG_ACTION, action.ordinal());</span>
<span class="nc" id="L84">            doScheduleJobWithBundle(context, extras, JOB_READER_POST_SERVICE_ID_FEED);</span>
        }
<span class="nc" id="L86">    }</span>

    private static void doScheduleJobWithBundle(Context context, PersistableBundle extras, int jobId) {
        // schedule the JobService here for API &gt;= 26. The JobScheduler is available since API 21, but
        // it's preferable to use it only since enforcement in API 26 to not break any old behavior
<span class="nc" id="L91">        ComponentName componentName = new ComponentName(context, ReaderPostJobService.class);</span>

<span class="nc" id="L93">        JobInfo jobInfo = new JobInfo.Builder(jobId, componentName)</span>
<span class="nc" id="L94">                .setRequiresCharging(false)</span>
<span class="nc" id="L95">                .setRequiredNetworkType(JobInfo.NETWORK_TYPE_ANY)</span>
<span class="nc" id="L96">                .setOverrideDeadline(0) // if possible, try to run right away</span>
<span class="nc" id="L97">                .setExtras(extras)</span>
<span class="nc" id="L98">                .build();</span>

<span class="nc" id="L100">        JobScheduler jobScheduler = (JobScheduler) context.getSystemService(Context.JOB_SCHEDULER_SERVICE);</span>
<span class="nc" id="L101">        int resultCode = jobScheduler.schedule(jobInfo);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (resultCode == JobScheduler.RESULT_SUCCESS) {</span>
<span class="nc" id="L103">            AppLog.i(AppLog.T.READER, &quot;reader post service &gt; job scheduled&quot;);</span>
        } else {
<span class="nc" id="L105">            AppLog.e(AppLog.T.READER, &quot;reader post service &gt; job could not be scheduled&quot;);</span>
        }
<span class="nc" id="L107">    }</span>

    private static void putReaderTagExtras(PersistableBundle extras, ReaderTag tag) {
<span class="nc" id="L110">        extras.putString(ARG_TAG_PARAM_SLUG, tag.getTagSlug());</span>
<span class="nc" id="L111">        extras.putString(ARG_TAG_PARAM_DISPLAY_NAME, tag.getTagDisplayName());</span>
<span class="nc" id="L112">        extras.putString(ARG_TAG_PARAM_TITLE, tag.getTagTitle());</span>
<span class="nc" id="L113">        extras.putString(ARG_TAG_PARAM_ENDPOINT, tag.getEndpoint());</span>
<span class="nc" id="L114">        extras.putInt(ARG_TAG_PARAM_TAGTYPE, tag.tagType.toInt());</span>
<span class="nc" id="L115">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>