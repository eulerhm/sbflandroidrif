<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SiteCreationServiceManager.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.sitecreation.services</a> &gt; <span class="el_source">SiteCreationServiceManager.kt</span></div><h1>SiteCreationServiceManager.kt</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package org.wordpress.android.ui.sitecreation.services</span>

import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Job
import kotlinx.coroutines.launch
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.fluxc.store.SiteStore.OnNewSiteCreated
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.ui.sitecreation.misc.SiteCreationTracker
import org.wordpress.android.ui.sitecreation.services.SiteCreationServiceState.SiteCreationStep
import org.wordpress.android.ui.sitecreation.services.SiteCreationServiceState.SiteCreationStep.CREATE_SITE
import org.wordpress.android.ui.sitecreation.services.SiteCreationServiceState.SiteCreationStep.FAILURE
import org.wordpress.android.ui.sitecreation.services.SiteCreationServiceState.SiteCreationStep.IDLE
import org.wordpress.android.ui.sitecreation.services.SiteCreationServiceState.SiteCreationStep.SUCCESS
import org.wordpress.android.ui.sitecreation.usecases.CreateSiteUseCase
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import javax.inject.Inject
import javax.inject.Named
import kotlin.coroutines.CoroutineContext
import kotlin.properties.Delegates

<span class="nc" id="L25">class SiteCreationServiceManager @Inject constructor(</span>
<span class="nc" id="L26">    private val createSiteUseCase: CreateSiteUseCase,</span>
<span class="nc" id="L27">    private val dispatcher: Dispatcher,</span>
<span class="nc" id="L28">    private val tracker: SiteCreationTracker,</span>
<span class="nc" id="L29">    @Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher</span>
) : CoroutineScope {
<span class="nc" id="L31">    private val job = Job()</span>
    override val coroutineContext: CoroutineContext
<span class="nc" id="L33">        get() = bgDispatcher + job</span>

    private lateinit var siteData: SiteCreationServiceData
    private lateinit var languageId: String
    private lateinit var timeZoneId: String
    private lateinit var serviceListener: SiteCreationServiceManagerListener
<span class="nc" id="L39">    private var isRetry by Delegates.notNull&lt;Boolean&gt;()</span>
<span class="nc" id="L40">    private var newSiteRemoteId by Delegates.notNull&lt;Long&gt;()</span>
<span class="nc" id="L41">    private var newSiteUrl by Delegates.notNull&lt;String&gt;()</span>

    fun onStart(
        languageWordPressId: String,
        timeZoneId: String,
        previousState: String?,
        data: SiteCreationServiceData,
        serviceListener: SiteCreationServiceManagerListener
    ) {
<span class="nc" id="L50">        languageId = languageWordPressId</span>
<span class="nc" id="L51">        this.timeZoneId = timeZoneId</span>
<span class="nc" id="L52">        siteData = data</span>
<span class="nc" id="L53">        this.serviceListener = serviceListener</span>

<span class="nc" id="L55">        executePhase(IDLE)</span>

<span class="nc bnc" id="L57" title="All 2 branches missed.">        isRetry = previousState != null</span>

<span class="nc bnc" id="L59" title="All 2 branches missed.">        val phaseToExecute = if (isRetry) {</span>
<span class="nc" id="L60">            SiteCreationStep.valueOf(previousState!!)</span>
        } else {
<span class="nc" id="L62">            CREATE_SITE</span>
        }

<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (SiteCreationServiceState(phaseToExecute).isTerminal) {</span>
<span class="nc" id="L66">            AppLog.e(T.SITE_CREATION, &quot;IllegalState: SiteCreationService can't resume a terminal step!&quot;)</span>
        } else {
<span class="nc" id="L68">            executePhase(phaseToExecute)</span>
        }
<span class="nc" id="L70">    }</span>

    fun onCreate() {
<span class="nc" id="L73">        dispatcher.register(createSiteUseCase)</span>
<span class="nc" id="L74">    }</span>

    fun onDestroy() {
<span class="nc" id="L77">        dispatcher.unregister(createSiteUseCase)</span>
<span class="nc" id="L78">    }</span>

    private fun executePhase(phase: SiteCreationStep) {
<span class="nc bnc" id="L81" title="All 5 branches missed.">        when (phase) {</span>
<span class="nc" id="L82">            IDLE -&gt; updateServiceState(IDLE)</span>
            CREATE_SITE -&gt; {
<span class="nc" id="L84">                updateServiceState(CREATE_SITE)</span>
<span class="nc" id="L85">                createSite()</span>
            }
            SUCCESS -&gt; {
<span class="nc" id="L88">                updateServiceState(SUCCESS, Pair(newSiteRemoteId, newSiteUrl))</span>
                // This stat is part of a funnel that provides critical information.  Before
                // making ANY modification to this stat please refer to: p4qSXL-35X-p2
<span class="nc bnc" id="L91" title="All 2 branches missed.">                tracker.trackSiteCreated(siteData.siteDesign)</span>
            }
            FAILURE -&gt; {
<span class="nc bnc" id="L94" title="All 2 branches missed.">                val currentState = serviceListener.getCurrentState()</span>
<span class="nc" id="L95">                AppLog.e(T.SITE_CREATION,</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">                        &quot;SiteCreationService entered state FAILURE while on step: ${currentState?.step?.name}&quot;</span>
                )
<span class="nc" id="L98">                updateServiceState(FAILURE, currentState)</span>
            }
        }
<span class="nc" id="L101">    }</span>

    private fun createSite() {
<span class="nc" id="L104">        launch {</span>
<span class="nc" id="L105">            AppLog.i(</span>
<span class="nc" id="L106">                    T.SITE_CREATION,</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                    &quot;Dispatching Create Site Action, SiteName: ${siteData.domain}&quot;</span>
            )
            val createSiteEvent: OnNewSiteCreated
<span class="nc" id="L110">            try {</span>
<span class="nc bnc" id="L111" title="All 6 branches missed.">                createSiteEvent = createSiteUseCase.createSite(siteData, languageId, timeZoneId)</span>
<span class="nc" id="L112">            } catch (e: IllegalStateException) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                AppLog.e(T.SITE_CREATION, e.message ?: &quot;Unexpected error.&quot;)</span>
<span class="nc" id="L114">                executePhase(FAILURE)</span>
<span class="nc" id="L115">                return@launch</span>
            }

<span class="nc" id="L118">            newSiteRemoteId = createSiteEvent.newSiteRemoteId</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            newSiteUrl = createSiteEvent.url ?: &quot;&quot;</span>
<span class="nc" id="L120">            AppLog.i(T.SITE_CREATION, createSiteEvent.toString())</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (createSiteEvent.isError) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (createSiteEvent.error.type == SiteStore.NewSiteErrorType.SITE_NAME_EXISTS) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                    if (isRetry) {</span>
                        // Move to the next step. The site was already created on the server by our previous attempt.
<span class="nc" id="L125">                        AppLog.w(T.SITE_CREATION,</span>
<span class="nc" id="L126">                                &quot;WPCOM site already created but we are in retrying mode so, just move on.&quot;</span>
                        )
<span class="nc" id="L128">                        executePhase(SUCCESS)</span>
                    } else {
                        /**
                         * This state should not happen in production unless the domain suggestion endpoint is broken.
                         * There is a very low chance two users picked the same domain at the same time and only
                         * the first got it.
                         */
<span class="nc" id="L135">                        val errorMsg = &quot;Site already exists - seems like an issue with domain suggestions endpoint&quot;</span>
<span class="nc" id="L136">                        AppLog.e(T.SITE_CREATION, errorMsg)</span>
<span class="nc" id="L137">                        throw IllegalStateException(errorMsg)</span>
                    }
                } else {
<span class="nc" id="L140">                    executePhase(FAILURE)</span>
                }
            } else {
<span class="nc" id="L143">                executePhase(SUCCESS)</span>
            }
<span class="nc" id="L145">        }</span>
<span class="nc" id="L146">    }</span>

    /**
     * Helper method to create a new State object and set it as the new state.
     *
     * @param step The step of the new state
     * @param payload The payload to attach to the new state
     */
<span class="nc" id="L154">    private fun updateServiceState(step: SiteCreationStep, payload: Any? = null) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        serviceListener.updateState(SiteCreationServiceState(step, payload))</span>
<span class="nc" id="L156">    }</span>

    interface SiteCreationServiceManagerListener {
        fun getCurrentState(): SiteCreationServiceState?

        fun updateState(state: SiteCreationServiceState)
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>