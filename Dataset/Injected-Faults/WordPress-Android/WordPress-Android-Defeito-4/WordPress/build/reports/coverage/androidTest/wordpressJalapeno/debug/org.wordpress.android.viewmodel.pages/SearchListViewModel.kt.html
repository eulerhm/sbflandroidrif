<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchListViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.viewmodel.pages</a> &gt; <span class="el_source">SearchListViewModel.kt</span></div><h1>SearchListViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.viewmodel.pages

import android.content.Context
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.Observer
import kotlinx.coroutines.CoroutineDispatcher
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.page.PageModel
import org.wordpress.android.fluxc.model.page.PageStatus
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.pages.PageItem
import org.wordpress.android.ui.pages.PageItem.Action
import org.wordpress.android.ui.pages.PageItem.Divider
import org.wordpress.android.ui.pages.PageItem.DraftPage
import org.wordpress.android.ui.pages.PageItem.Empty
import org.wordpress.android.ui.pages.PageItem.Page
import org.wordpress.android.ui.pages.PageItem.PublishedPage
import org.wordpress.android.ui.pages.PageItem.ScheduledPage
import org.wordpress.android.ui.pages.PageItem.TrashedPage
import org.wordpress.android.viewmodel.ResourceProvider
import org.wordpress.android.viewmodel.ScopedViewModel
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType.DRAFTS
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType.PUBLISHED
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType.SCHEDULED
import org.wordpress.android.viewmodel.pages.PageListViewModel.PageListType.TRASHED
import java.util.SortedMap
import javax.inject.Inject
import javax.inject.Named

class SearchListViewModel
<span class="nc" id="L33">@Inject constructor(</span>
<span class="nc" id="L34">    private val createPageListItemLabelsUseCase: CreatePageListItemLabelsUseCase,</span>
<span class="nc" id="L35">    private val postModelUploadUiStateUseCase: PostModelUploadUiStateUseCase,</span>
<span class="nc" id="L36">    private val pageListItemActionsUseCase: CreatePageListItemActionsUseCase,</span>
<span class="nc" id="L37">    private val pageItemProgressUiStateUseCase: PageItemProgressUiStateUseCase,</span>
<span class="nc" id="L38">    private val resourceProvider: ResourceProvider,</span>
<span class="nc" id="L39">    @Named(UI_THREAD) private val uiDispatcher: CoroutineDispatcher</span>
<span class="nc" id="L40">) : ScopedViewModel(uiDispatcher) {</span>
<span class="nc" id="L41">    private val _searchResult: MutableLiveData&lt;List&lt;PageItem&gt;&gt; = MutableLiveData()</span>
<span class="nc" id="L42">    val searchResult: LiveData&lt;List&lt;PageItem&gt;&gt; = _searchResult</span>

    private var isStarted: Boolean = false
    private lateinit var pagesViewModel: PagesViewModel

    fun start(pagesViewModel: PagesViewModel) {
<span class="nc" id="L48">        this.pagesViewModel = pagesViewModel</span>

<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (!isStarted) {</span>
<span class="nc" id="L51">            isStarted = true</span>

<span class="nc" id="L53">            pagesViewModel.searchPages.observeForever(searchObserver)</span>
        }
<span class="nc" id="L55">    }</span>

    override fun onCleared() {
<span class="nc bnc" id="L58" title="All 2 branches missed.">        pagesViewModel.searchPages.removeObserver(searchObserver)</span>
<span class="nc" id="L59">    }</span>

<span class="nc" id="L61">    private val searchObserver = Observer&lt;SortedMap&lt;PageListType, List&lt;PageModel&gt;&gt;?&gt; { pages -&gt;</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (pages != null) {</span>
<span class="nc" id="L63">            loadFoundPages(pages)</span>

<span class="nc bnc" id="L65" title="All 2 branches missed.">            pagesViewModel.checkIfNewPageButtonShouldBeVisible()</span>
        } else {
<span class="nc" id="L67">            _searchResult.value = listOf(Empty(R.string.pages_search_suggestion, true))</span>
        }
<span class="nc" id="L69">    }</span>

<span class="nc" id="L71">    fun onMenuAction(action: Action, pageItem: Page, context: Context? = null): Boolean {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        return pagesViewModel.onMenuAction(action, pageItem, context)</span>
    }

    fun onItemTapped(pageItem: Page) {
<span class="nc bnc" id="L76" title="All 2 branches missed.">        pagesViewModel.onItemTapped(pageItem)</span>
<span class="nc" id="L77">    }</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">    private fun loadFoundPages(pages: SortedMap&lt;PageListType, List&lt;PageModel&gt;&gt;) = launch {</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">        if (pages.isNotEmpty()) {</span>
<span class="nc" id="L81">            val pageItems = pages</span>
<span class="nc" id="L82">                    .map { (listType, results) -&gt;</span>
<span class="nc" id="L83">                        listOf(Divider(resourceProvider.getString(listType.title))) +</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                                results.map { it.toPageItem(pagesViewModel.arePageActionsEnabled) }</span>
                    }
<span class="nc" id="L86">                    .fold(mutableListOf()) { acc: MutableList&lt;PageItem&gt;, list: List&lt;PageItem&gt; -&gt;</span>
<span class="nc" id="L87">                        acc.addAll(list)</span>
<span class="nc" id="L88">                        return@fold acc</span>
                    }
<span class="nc" id="L90">            _searchResult.value = pageItems</span>
        } else {
<span class="nc" id="L92">            _searchResult.value = listOf(Empty(R.string.pages_empty_search_result, true))</span>
        }
<span class="nc" id="L94">    }</span>

    private fun PageModel.toPageItem(areActionsEnabled: Boolean): PageItem {
<span class="nc" id="L97">        val uploadUiState = postModelUploadUiStateUseCase.createUploadUiState(</span>
<span class="nc" id="L98">                this.post,</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                pagesViewModel.site,</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                pagesViewModel.uploadStatusTracker</span>
        )
<span class="nc" id="L102">        val (progressBarUiState, showOverlay) = pageItemProgressUiStateUseCase.getProgressStateForPage(uploadUiState)</span>
<span class="nc" id="L103">        val (labels, labelColor) = createPageListItemLabelsUseCase.createLabels(this.post, uploadUiState)</span>

<span class="nc bnc" id="L105" title="All 4 branches missed.">        return when (status) {</span>
            PageStatus.PUBLISHED, PageStatus.PRIVATE -&gt;
<span class="nc" id="L107">                PublishedPage(</span>
<span class="nc" id="L108">                        remoteId = remoteId,</span>
<span class="nc" id="L109">                        localId = pageId,</span>
<span class="nc" id="L110">                        title = title,</span>
<span class="nc" id="L111">                        date = date,</span>
<span class="nc" id="L112">                        labels = labels,</span>
<span class="nc" id="L113">                        labelsColor = labelColor,</span>
<span class="nc" id="L114">                        actions = pageListItemActionsUseCase.setupPageActions(</span>
<span class="nc" id="L115">                                PUBLISHED,</span>
<span class="nc" id="L116">                                uploadUiState,</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                                pagesViewModel.site,</span>
<span class="nc" id="L118">                                remoteId</span>
                        ),
<span class="nc" id="L120">                        actionsEnabled = areActionsEnabled,</span>
<span class="nc" id="L121">                        progressBarUiState = progressBarUiState,</span>
<span class="nc" id="L122">                        showOverlay = showOverlay,</span>
<span class="nc" id="L123">                        author = post.authorDisplayName</span>
                )
<span class="nc" id="L125">            PageStatus.DRAFT, PageStatus.PENDING -&gt; DraftPage(</span>
<span class="nc" id="L126">                    remoteId = remoteId,</span>
<span class="nc" id="L127">                    localId = pageId,</span>
<span class="nc" id="L128">                    title = title,</span>
<span class="nc" id="L129">                    date = date,</span>
<span class="nc" id="L130">                    labels = labels,</span>
<span class="nc" id="L131">                    labelsColor = labelColor,</span>
<span class="nc" id="L132">                    actions = pageListItemActionsUseCase.setupPageActions(</span>
<span class="nc" id="L133">                            DRAFTS,</span>
<span class="nc" id="L134">                            uploadUiState,</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                            pagesViewModel.site,</span>
<span class="nc" id="L136">                            remoteId</span>
                    ),
<span class="nc" id="L138">                    actionsEnabled = areActionsEnabled,</span>
<span class="nc" id="L139">                    progressBarUiState = progressBarUiState,</span>
<span class="nc" id="L140">                    showOverlay = showOverlay,</span>
<span class="nc" id="L141">                    author = post.authorDisplayName</span>
            )
<span class="nc" id="L143">            PageStatus.TRASHED -&gt; TrashedPage(</span>
<span class="nc" id="L144">                    remoteId = remoteId,</span>
<span class="nc" id="L145">                    localId = pageId,</span>
<span class="nc" id="L146">                    title = title,</span>
<span class="nc" id="L147">                    date = date,</span>
<span class="nc" id="L148">                    labels = labels,</span>
<span class="nc" id="L149">                    labelsColor = labelColor,</span>
<span class="nc" id="L150">                    actions = pageListItemActionsUseCase.setupPageActions(</span>
<span class="nc" id="L151">                            TRASHED,</span>
<span class="nc" id="L152">                            uploadUiState,</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                            pagesViewModel.site,</span>
<span class="nc" id="L154">                            remoteId</span>
                    ),
<span class="nc" id="L156">                    actionsEnabled = areActionsEnabled,</span>
<span class="nc" id="L157">                    progressBarUiState = progressBarUiState,</span>
<span class="nc" id="L158">                    showOverlay = showOverlay,</span>
<span class="nc" id="L159">                    author = post.authorDisplayName</span>
            )
<span class="nc" id="L161">            PageStatus.SCHEDULED -&gt; ScheduledPage(</span>
<span class="nc" id="L162">                    remoteId = remoteId,</span>
<span class="nc" id="L163">                    localId = pageId,</span>
<span class="nc" id="L164">                    title = title,</span>
<span class="nc" id="L165">                    date = date,</span>
<span class="nc" id="L166">                    labels = labels,</span>
<span class="nc" id="L167">                    labelsColor = labelColor,</span>
<span class="nc" id="L168">                    actions = pageListItemActionsUseCase.setupPageActions(</span>
<span class="nc" id="L169">                            SCHEDULED,</span>
<span class="nc" id="L170">                            uploadUiState,</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                            pagesViewModel.site,</span>
<span class="nc" id="L172">                            remoteId</span>
                    ),
<span class="nc" id="L174">                    actionsEnabled = areActionsEnabled,</span>
<span class="nc" id="L175">                    progressBarUiState = progressBarUiState,</span>
<span class="nc" id="L176">                    showOverlay = showOverlay,</span>
<span class="nc" id="L177">                    author = post.authorDisplayName</span>
            )
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>