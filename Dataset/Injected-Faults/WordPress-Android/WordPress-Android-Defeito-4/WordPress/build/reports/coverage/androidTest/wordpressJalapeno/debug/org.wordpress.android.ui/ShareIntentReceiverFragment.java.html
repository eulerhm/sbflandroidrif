<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShareIntentReceiverFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui</a> &gt; <span class="el_source">ShareIntentReceiverFragment.java</span></div><h1>ShareIntentReceiverFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui;

import android.content.Context;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.TextView;

import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import androidx.recyclerview.widget.RecyclerView.Adapter;

import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.ui.main.SitePickerAdapter;
import org.wordpress.android.ui.main.SitePickerAdapter.SiteList;
import org.wordpress.android.ui.main.SitePickerAdapter.ViewHolderHandler;
import org.wordpress.android.ui.media.MediaBrowserActivity;
import org.wordpress.android.ui.posts.EditPostActivity;
import org.wordpress.android.util.image.ImageManager;

import javax.inject.Inject;

<span class="nc" id="L30">public class ShareIntentReceiverFragment extends Fragment {</span>
    public static final String TAG = &quot;share_intent_fragment_tag&quot;;

    private static final String ARG_SHARING_MEDIA = &quot;ARG_SHARING_MEDIA&quot;;
    private static final String ARG_LAST_USED_BLOG_LOCAL_ID = &quot;ARG_LAST_USED_BLOG_LOCAL_ID&quot;;

    @Inject AccountStore mAccountStore;
    @Inject ImageManager mImageManager;
    private ShareIntentFragmentListener mShareIntentFragmentListener;
    private SitePickerAdapter mAdapter;

    private Button mSharePostBtn;
    private Button mShareMediaBtn;

    private boolean mSharingMediaFile;
    private int mLastUsedBlogLocalId;
    private RecyclerView mRecyclerView;
    private View mBottomButtonsContainer;
    private View mBottomButtonsShadow;

    public static ShareIntentReceiverFragment newInstance(boolean sharingMediaFile, int lastUsedBlogLocalId) {
<span class="nc" id="L51">        ShareIntentReceiverFragment fragment = new ShareIntentReceiverFragment();</span>
<span class="nc" id="L52">        Bundle args = new Bundle();</span>
<span class="nc" id="L53">        args.putBoolean(ARG_SHARING_MEDIA, sharingMediaFile);</span>
<span class="nc" id="L54">        args.putInt(ARG_LAST_USED_BLOG_LOCAL_ID, lastUsedBlogLocalId);</span>
<span class="nc" id="L55">        fragment.setArguments(args);</span>
<span class="nc" id="L56">        return fragment;</span>
    }

    @Override
    public void onAttach(Context context) {
<span class="nc" id="L61">        super.onAttach(context);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (context instanceof ShareIntentFragmentListener) {</span>
<span class="nc" id="L63">            mShareIntentFragmentListener = (ShareIntentFragmentListener) context;</span>
        } else {
<span class="nc" id="L65">            throw new RuntimeException(&quot;The parent activity doesn't implement ShareIntentFragmentListener.&quot;);</span>
        }
<span class="nc" id="L67">    }</span>

    @Override public void onActivityCreated(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L70">        super.onActivityCreated(savedInstanceState);</span>
        // important for accessibility - talkback
<span class="nc" id="L72">        getActivity().setTitle(R.string.share_intent_screen_title);</span>
<span class="nc" id="L73">    }</span>

    @Nullable
    @Override
    public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container,
                             @Nullable Bundle savedInstanceState) {
<span class="nc" id="L79">        ViewGroup layout = (ViewGroup) inflater.inflate(R.layout.share_intent_receiver_fragment, container, false);</span>
<span class="nc" id="L80">        initButtonsContainer(layout);</span>
<span class="nc" id="L81">        initShareActionPostButton(layout);</span>
<span class="nc" id="L82">        initShareActionMediaButton(layout, mSharingMediaFile);</span>
<span class="nc" id="L83">        initRecyclerView(layout);</span>
<span class="nc" id="L84">        return layout;</span>
    }

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L89">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L90">        ((WordPress) getActivity().getApplication()).component().inject(this);</span>
<span class="nc" id="L91">        mSharingMediaFile = getArguments().getBoolean(ARG_SHARING_MEDIA);</span>
<span class="nc" id="L92">        mLastUsedBlogLocalId = getArguments().getInt(ARG_LAST_USED_BLOG_LOCAL_ID);</span>
<span class="nc" id="L93">        loadSavedState(savedInstanceState);</span>
<span class="nc" id="L94">    }</span>

    private void loadSavedState(Bundle savedInstanceState) {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L98">            mLastUsedBlogLocalId = savedInstanceState.getInt(ARG_LAST_USED_BLOG_LOCAL_ID);</span>
        }
<span class="nc" id="L100">    }</span>

    @Override
    public void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L104">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L105">        int selectedItemLocalId = mAdapter.getSelectedItemLocalId();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (selectedItemLocalId != -1) {</span>
<span class="nc" id="L107">            outState.putInt(ARG_LAST_USED_BLOG_LOCAL_ID, mAdapter.getSelectedItemLocalId());</span>
        }
<span class="nc" id="L109">    }</span>

    private void initButtonsContainer(ViewGroup layout) {
<span class="nc" id="L112">        mBottomButtonsContainer = layout.findViewById(R.id.bottom_buttons);</span>
<span class="nc" id="L113">        mBottomButtonsShadow = layout.findViewById(R.id.bottom_shadow);</span>
<span class="nc" id="L114">    }</span>

    private void initShareActionPostButton(final ViewGroup layout) {
<span class="nc" id="L117">        mSharePostBtn = layout.findViewById(R.id.primary_button);</span>
<span class="nc" id="L118">        addShareActionListener(mSharePostBtn, ShareAction.SHARE_TO_POST);</span>
<span class="nc" id="L119">    }</span>

    private void initShareActionMediaButton(final ViewGroup layout, boolean sharingMediaFile) {
<span class="nc" id="L122">        mShareMediaBtn = layout.findViewById(R.id.secondary_button);</span>
<span class="nc" id="L123">        addShareActionListener(mShareMediaBtn, ShareAction.SHARE_TO_MEDIA_LIBRARY);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        mShareMediaBtn.setVisibility(sharingMediaFile ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L125">    }</span>

    private void addShareActionListener(final Button button, final ShareAction shareAction) {
<span class="nc" id="L128">        button.setOnClickListener(new OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L131">                mShareIntentFragmentListener.share(shareAction, mAdapter.getSelectedItemLocalId());</span>
<span class="nc" id="L132">            }</span>
        });
<span class="nc" id="L134">    }</span>

    private void initRecyclerView(ViewGroup layout) {
<span class="nc" id="L137">        mRecyclerView = layout.findViewById(R.id.recycler_view);</span>
<span class="nc" id="L138">        mRecyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));</span>
<span class="nc" id="L139">        mRecyclerView.setScrollBarStyle(View.SCROLLBARS_OUTSIDE_OVERLAY);</span>
<span class="nc" id="L140">        mRecyclerView.setItemAnimator(null);</span>
<span class="nc" id="L141">        mRecyclerView.setAdapter(createSiteAdapter());</span>
<span class="nc" id="L142">    }</span>

    private Adapter createSiteAdapter() {
<span class="nc" id="L145">        mAdapter = new SitePickerAdapter(</span>
<span class="nc" id="L146">                getActivity(), R.layout.share_intent_sites_listitem, 0, &quot;&quot;, false,</span>
<span class="nc" id="L147">                new SitePickerAdapter.OnDataLoadedListener() {</span>
                    @Override
                    public void onBeforeLoad(boolean isEmpty) {
<span class="nc" id="L150">                    }</span>

                    @Override
                    public void onAfterLoad() {
<span class="nc" id="L154">                        mRecyclerView.post(new Runnable() {</span>
                            @Override
                            public void run() {
<span class="nc bnc" id="L157" title="All 2 branches missed.">                                if (!isAdded()) {</span>
<span class="nc" id="L158">                                    return;</span>
                                }

<span class="nc bnc" id="L161" title="All 2 branches missed.">                                if (mRecyclerView.computeVerticalScrollRange() &gt; mRecyclerView.getHeight()) {</span>
<span class="nc" id="L162">                                    mBottomButtonsShadow.setVisibility(View.VISIBLE);</span>
                                } else {
<span class="nc" id="L164">                                    mBottomButtonsShadow.setVisibility(View.GONE);</span>
                                }
<span class="nc" id="L166">                            }</span>
                        });
<span class="nc" id="L168">                        mAdapter.findAndSelect(mLastUsedBlogLocalId);</span>
<span class="nc" id="L169">                    }</span>
                },
<span class="nc" id="L171">                createHeaderHandler(),</span>
                null
        );
<span class="nc" id="L174">        mAdapter.setSingleItemSelectionEnabled(true);</span>
<span class="nc" id="L175">        return mAdapter;</span>
    }

    private ViewHolderHandler&lt;HeaderViewHolder&gt; createHeaderHandler() {
<span class="nc" id="L179">        return new ViewHolderHandler&lt;HeaderViewHolder&gt;() {</span>
            @Override
            public HeaderViewHolder onCreateViewHolder(LayoutInflater layoutInflater, ViewGroup parent,
                                                       boolean attachToRoot) {
<span class="nc" id="L183">                return new HeaderViewHolder(</span>
<span class="nc" id="L184">                        layoutInflater.inflate(R.layout.share_intent_receiver_header, parent, false));</span>
            }

            @Override
            public void onBindViewHolder(HeaderViewHolder holder, SiteList sites) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">                if (!isAdded()) {</span>
<span class="nc" id="L190">                    return;</span>
                }
<span class="nc" id="L192">                holder.bindText(getString(</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                        sites.size() == 1 ? R.string.share_intent_adding_to : R.string.share_intent_pick_site));</span>
<span class="nc" id="L194">            }</span>
        };
    }

    static class HeaderViewHolder extends RecyclerView.ViewHolder {
        private final TextView mHeaderTextView;

        HeaderViewHolder(View view) {
<span class="nc" id="L202">            super(view);</span>
<span class="nc" id="L203">            mHeaderTextView = view.findViewById(R.id.login_epilogue_header_sites_subheader);</span>
<span class="nc" id="L204">        }</span>

        void bindText(String text) {
<span class="nc" id="L207">            mHeaderTextView.setText(text);</span>
<span class="nc" id="L208">        }</span>
    }

<span class="nc" id="L211">    enum ShareAction {</span>
<span class="nc" id="L212">        SHARE_TO_POST(&quot;new_post&quot;, EditPostActivity.class),</span>
<span class="nc" id="L213">        SHARE_TO_MEDIA_LIBRARY(&quot;media_library&quot;, MediaBrowserActivity.class);</span>

        public final Class targetClass;
        public final String analyticsName;


<span class="nc" id="L219">        ShareAction(String analyticsName, Class targetClass) {</span>
<span class="nc" id="L220">            this.targetClass = targetClass;</span>
<span class="nc" id="L221">            this.analyticsName = analyticsName;</span>
<span class="nc" id="L222">        }</span>
    }

    interface ShareIntentFragmentListener {
        void share(ShareAction shareAction, int selectedSiteLocalId);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>