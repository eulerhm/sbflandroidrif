<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SaveStoryGutenbergBlockUseCase.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stories</a> &gt; <span class="el_source">SaveStoryGutenbergBlockUseCase.kt</span></div><h1>SaveStoryGutenbergBlockUseCase.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stories

import android.text.TextUtils
import com.automattic.android.tracks.crashlogging.CrashLogging
import com.google.gson.Gson
import com.wordpress.stories.compose.frame.FrameIndex
import com.wordpress.stories.compose.story.StoryFrameItem
import com.wordpress.stories.compose.story.StoryIndex
import org.wordpress.android.fluxc.model.PostModel
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.model.post.PostStatus.PRIVATE
import org.wordpress.android.ui.posts.EditPostRepository
import org.wordpress.android.ui.stories.prefs.StoriesPrefs
import org.wordpress.android.ui.stories.prefs.StoriesPrefs.TempId
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T.EDITOR
import org.wordpress.android.util.StringUtils
import org.wordpress.android.util.crashlogging.sendReportWithTag
import org.wordpress.android.util.helpers.MediaFile
import javax.inject.Inject

<span class="fc" id="L22">class SaveStoryGutenbergBlockUseCase @Inject constructor(</span>
<span class="fc" id="L23">    private val storiesPrefs: StoriesPrefs,</span>
<span class="fc" id="L24">    private val crashLogging: CrashLogging</span>
) {
    fun buildJetpackStoryBlockInPost(
        editPostRepository: EditPostRepository,
        mediaFiles: ArrayList&lt;MediaFile&gt;
    ) {
<span class="nc" id="L30">        editPostRepository.update { postModel: PostModel -&gt;</span>
<span class="nc" id="L31">            postModel.setContent(buildJetpackStoryBlockString(mediaFiles))</span>
<span class="nc" id="L32">            true</span>
        }
<span class="nc" id="L34">    }</span>

    private fun buildJetpackStoryBlockString(
        mediaFiles: List&lt;MediaFile&gt;
    ): String {
<span class="nc" id="L39">        val jsonArrayMediaFiles = ArrayList&lt;StoryMediaFileData&gt;() // holds media files</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">        for (mediaFile in mediaFiles) {</span>
<span class="nc" id="L41">            jsonArrayMediaFiles.add(buildMediaFileData(mediaFile))</span>
        }
<span class="nc" id="L43">        return buildJetpackStoryBlockStringFromStoryMediaFileData(jsonArrayMediaFiles)</span>
    }

    fun buildJetpackStoryBlockStringFromStoryMediaFileData(
        storyMediaFileDataList: ArrayList&lt;StoryMediaFileData&gt;
    ): String {
<span class="nc" id="L49">        return createGBStoryBlockStringFromJson(StoryBlockData(mediaFiles = storyMediaFileDataList))</span>
    }

    private fun buildMediaFileData(mediaFile: MediaFile): StoryMediaFileData {
<span class="nc" id="L53">        return StoryMediaFileData(</span>
<span class="nc" id="L54">                alt = mediaFile.alt,</span>
<span class="nc" id="L55">                id = mediaFile.id.toString(),</span>
<span class="nc" id="L56">                link = StringUtils.notNullStr(mediaFile.fileURL),</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">                type = if (mediaFile.isVideo) &quot;video&quot; else &quot;image&quot;,</span>
<span class="nc" id="L58">                mime = StringUtils.notNullStr(mediaFile.mimeType),</span>
<span class="nc" id="L59">                caption = &quot;&quot;,</span>
<span class="nc" id="L60">                url = StringUtils.notNullStr(mediaFile.fileURL)</span>
        )
    }

    fun buildMediaFileDataWithTemporaryId(mediaFile: MediaFile, temporaryId: String): StoryMediaFileData {
<span class="nc" id="L65">        return StoryMediaFileData(</span>
<span class="nc" id="L66">                alt = mediaFile.alt,</span>
<span class="nc" id="L67">                id = temporaryId, // mediaFile.id,</span>
<span class="nc" id="L68">                link = StringUtils.notNullStr(mediaFile.fileURL),</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                type = if (mediaFile.isVideo) &quot;video&quot; else &quot;image&quot;,</span>
<span class="nc" id="L70">                mime = StringUtils.notNullStr(mediaFile.mimeType),</span>
<span class="nc" id="L71">                caption = &quot;&quot;,</span>
<span class="nc" id="L72">                url = StringUtils.notNullStr(mediaFile.fileURL)</span>
        )
    }

    fun buildMediaFileDataWithTemporaryIdNoMediaFile(
        temporaryId: String,
        url: String,
        isVideo: Boolean
    ): StoryMediaFileData {
<span class="nc" id="L81">        return StoryMediaFileData(</span>
<span class="nc" id="L82">                alt = &quot;&quot;,</span>
<span class="nc" id="L83">                id = temporaryId, // mediaFile.id,</span>
<span class="nc" id="L84">                link = url,</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                type = if (isVideo) &quot;video&quot; else &quot;image&quot;,</span>
<span class="nc" id="L86">                mime = &quot;&quot;,</span>
<span class="nc" id="L87">                caption = &quot;&quot;,</span>
<span class="nc" id="L88">                url = url</span>
        )
    }

    fun getTempIdForStoryFrame(tempIdBase: Long, storyIndex: StoryIndex, frameIndex: FrameIndex): String {
<span class="nc" id="L93">        return TEMPORARY_ID_PREFIX + &quot;$tempIdBase-$storyIndex-$frameIndex&quot;</span>
    }

    fun findAllStoryBlocksInPostAndPerformOnEachMediaFilesJson(
        postModel: PostModel,
        siteModel: SiteModel?,
        listener: DoWithMediaFilesListener
    ) {
<span class="nc" id="L101">        var content = postModel.content</span>
        // val contentMutable = StringBuilder(postModel.content)

        // find next Story Block
        // evaluate if this has a temporary id mediafile
        // --&gt; remove mediaFiles entirely
        // set start index and go up.
<span class="nc" id="L108">        var storyBlockStartIndex = 0</span>
<span class="nc" id="L109">        var hasMediaFiles = true</span>
<span class="nc bnc" id="L110" title="All 6 branches missed.">        while (storyBlockStartIndex &gt; -1 &amp;&amp; storyBlockStartIndex &lt; content.length &amp;&amp; hasMediaFiles) {</span>
<span class="nc" id="L111">            storyBlockStartIndex = content.indexOf(HEADING_START, storyBlockStartIndex)</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (storyBlockStartIndex &gt; -1) {</span>
<span class="nc" id="L113">                val storyBlockEndIndex = content.indexOf(HEADING_END_NO_NEW_LINE, storyBlockStartIndex)</span>
<span class="nc" id="L114">                val mediaFilesStartIndex = storyBlockStartIndex + HEADING_START.length</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                hasMediaFiles = mediaFilesStartIndex &lt; storyBlockEndIndex</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (!hasMediaFiles) {</span>
<span class="nc" id="L117">                    break</span>
                }
<span class="nc" id="L119">                try {</span>
<span class="nc" id="L120">                    val jsonString: String = content.substring(</span>
                            mediaFilesStartIndex,
                            storyBlockEndIndex
                    )
<span class="nc" id="L124">                    content = listener.doWithMediaFilesJson(content, jsonString)</span>
<span class="nc" id="L125">                    storyBlockStartIndex += HEADING_START.length</span>
<span class="nc" id="L126">                } catch (exception: StringIndexOutOfBoundsException) {</span>
<span class="nc" id="L127">                    logException(exception, postModel, siteModel)</span>
                }
            }
        }

<span class="nc" id="L132">        postModel.setContent(content)</span>
<span class="nc" id="L133">    }</span>

    private fun logException(exception: Throwable, postModel: PostModel, siteModel: SiteModel?) {
<span class="nc" id="L136">        AppLog.e(EDITOR, &quot;Error while parsing Story blocks: ${exception.message}&quot;)</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (shouldLogContent(siteModel, postModel)) {</span>
<span class="nc" id="L138">            AppLog.e(EDITOR, &quot;HTML content of the post before the crash: ${postModel.content}&quot;)</span>
        }
<span class="nc" id="L140">        crashLogging.sendReportWithTag(exception = exception, tag = EDITOR)</span>
<span class="nc" id="L141">    }</span>

    // See: https://git.io/JqfhK
<span class="nc bnc" id="L144" title="All 2 branches missed.">    private fun shouldLogContent(siteModel: SiteModel?, postModel: PostModel) = siteModel != null &amp;&amp;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            siteModel.isWPCom &amp;&amp;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            !siteModel.isPrivate &amp;&amp;</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">            postModel.password.isEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            postModel.status != PRIVATE.toString()</span>

    fun replaceLocalMediaIdsWithRemoteMediaIdsInPost(
        postModel: PostModel,
        siteModel: SiteModel?,
        mediaFile: MediaFile
    ) {
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (TextUtils.isEmpty(mediaFile.mediaId)) {</span>
            // if for any reason we couldn't obtain a remote mediaId, it's not worth spending time
            // looking to replace anything in the Post. Skip processing for later in error handling.
<span class="nc" id="L158">            return</span>
        }
<span class="nc" id="L160">        val gson = Gson()</span>
<span class="nc" id="L161">        findAllStoryBlocksInPostAndPerformOnEachMediaFilesJson(</span>
<span class="nc" id="L162">                postModel,</span>
<span class="nc" id="L163">                siteModel,</span>
<span class="nc" id="L164">                object : DoWithMediaFilesListener {</span>
                    override fun doWithMediaFilesJson(content: String, mediaFilesJsonString: String): String {
<span class="nc" id="L166">                        var processedContent = content</span>
<span class="nc" id="L167">                        val storyBlockData: StoryBlockData? =</span>
<span class="nc" id="L168">                                gson.fromJson(mediaFilesJsonString, StoryBlockData::class.java)</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                        storyBlockData?.let { storyBlockDataNonNull -&gt;</span>
<span class="nc" id="L170">                            val localMediaId = mediaFile.id.toString()</span>
                            // now replace matching localMediaId with remoteMediaId in the mediaFileObjects, obtain the URLs and replace
<span class="nc bnc" id="L172" title="All 2 branches missed.">                            val mediaFiles = storyBlockDataNonNull.mediaFiles.filter { it.id == localMediaId }</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">                            if (mediaFiles.isNotEmpty()) {</span>
<span class="nc" id="L174">                                mediaFiles[0].apply {</span>
<span class="nc" id="L175">                                    id = mediaFile.mediaId</span>
<span class="nc" id="L176">                                    link = mediaFile.fileURL</span>
<span class="nc" id="L177">                                    url = mediaFile.fileURL</span>

                                    // look for the slide saved with the local id key (mediaFile.id), and re-convert to
                                    // mediaId.
<span class="nc" id="L181">                                    storiesPrefs.replaceLocalMediaIdKeyedSlideWithRemoteMediaIdKeyedSlide(</span>
<span class="nc" id="L182">                                            mediaFile.id,</span>
<span class="nc" id="L183">                                            mediaFile.mediaId.toLong(),</span>
<span class="nc" id="L184">                                            postModel.localSiteId.toLong()</span>
                                    )
<span class="nc" id="L186">                                }</span>
                            }
<span class="nc" id="L188">                            processedContent = content.replace(mediaFilesJsonString, gson.toJson(storyBlockDataNonNull))</span>
<span class="nc" id="L189">                        }</span>
<span class="nc" id="L190">                        return processedContent</span>
                    }
                }
        )
<span class="nc" id="L194">    }</span>

    fun saveNewLocalFilesToStoriesPrefsTempSlides(
        site: SiteModel,
        storyIndex: StoryIndex,
        frames: ArrayList&lt;StoryFrameItem&gt;
    ) {
<span class="nc bnc" id="L201" title="All 2 branches missed.">        for ((frameIndex, frame) in frames.withIndex()) {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            if (frame.id == null) {</span>
<span class="nc" id="L203">                val assignedTempId = getTempIdForStoryFrame(</span>
<span class="nc" id="L204">                        storiesPrefs.getNewIncrementalTempId(),</span>
<span class="nc" id="L205">                        storyIndex,</span>
<span class="nc" id="L206">                        frameIndex</span>
                )
<span class="nc" id="L208">                frame.id = assignedTempId</span>
            }
<span class="nc" id="L210">            storiesPrefs.saveSlideWithTempId(</span>
<span class="nc" id="L211">                    site.id.toLong(),</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                    TempId(requireNotNull(frame.id)), // should not be null at this point</span>
<span class="nc" id="L213">                    frame</span>
            )
        }
<span class="nc" id="L216">    }</span>

    fun assignAltOnEachMediaFile(
        frames: List&lt;StoryFrameItem&gt;,
        mediaFiles: ArrayList&lt;MediaFile&gt;
    ): List&lt;MediaFile&gt; {
<span class="nc" id="L222">        return mediaFiles.mapIndexed { index, mediaFile -&gt;</span>
<span class="nc" id="L223">            run {</span>
<span class="nc" id="L224">                mediaFile.alt = StoryFrameItem.getAltTextFromFrameAddedViews(frames[index])</span>
<span class="nc" id="L225">                mediaFile</span>
            }
<span class="nc" id="L227">            mediaFile</span>
        }
    }

    private fun createGBStoryBlockStringFromJson(storyBlock: StoryBlockData): String {
<span class="nc" id="L232">        val gson = Gson()</span>
<span class="nc" id="L233">        return HEADING_START + gson.toJson(storyBlock) + HEADING_END + DIV_PART + CLOSING_TAG</span>
    }

    interface DoWithMediaFilesListener {
        fun doWithMediaFilesJson(content: String, mediaFilesJsonString: String): String
    }

<span class="nc" id="L240">    data class StoryBlockData(</span>
<span class="nc" id="L241">        val mediaFiles: List&lt;StoryMediaFileData&gt;</span>
    )

<span class="nc" id="L244">    data class StoryMediaFileData(</span>
<span class="nc" id="L245">        var alt: String,</span>
<span class="nc" id="L246">        var id: String,</span>
<span class="nc" id="L247">        var link: String,</span>
<span class="nc" id="L248">        val type: String,</span>
<span class="nc" id="L249">        val mime: String,</span>
<span class="nc" id="L250">        val caption: String,</span>
<span class="nc" id="L251">        var url: String</span>
    )

    companion object {
        const val TEMPORARY_ID_PREFIX = &quot;tempid-&quot;
        const val HEADING_START = &quot;&lt;!-- wp:jetpack/story &quot;
        const val HEADING_END = &quot; --&gt;\n&quot;
        const val HEADING_END_NO_NEW_LINE = &quot; --&gt;&quot;
        const val DIV_PART = &quot;&lt;div class=\&quot;wp-story wp-block-jetpack-story\&quot;&gt;&lt;/div&gt;\n&quot;
        const val CLOSING_TAG = &quot;&lt;!-- /wp:jetpack/story --&gt;&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>