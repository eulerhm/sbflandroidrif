<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CollapseFullScreenDialogFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui</a> &gt; <span class="el_source">CollapseFullScreenDialogFragment.java</span></div><h1>CollapseFullScreenDialogFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui;

import android.annotation.SuppressLint;
import android.app.Dialog;
import android.content.Context;
import android.content.res.Resources;
import android.graphics.drawable.Drawable;
import android.os.Bundle;
import android.util.TypedValue;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.Window;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.annotation.StringRes;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.content.res.AppCompatResources;
import androidx.appcompat.widget.Toolbar;
import androidx.core.content.ContextCompat;
import androidx.core.content.res.ResourcesCompat;
import androidx.core.view.MenuItemCompat;
import androidx.core.view.ViewCompat;
import androidx.fragment.app.DialogFragment;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentActivity;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentTransaction;

import com.google.android.material.elevation.ElevationOverlayProvider;

import org.wordpress.android.R;

/**
 * A {@link DialogFragment} implementing the full-screen dialog pattern defined in the
 * &lt;a href=&quot;https://material.io/guidelines/components/dialogs.html#dialogs-full-screen-dialogs&quot;&gt;
 * Material Design guidelines&lt;/a&gt; with an icon rather than text action.
 */
<span class="nc" id="L43">public class CollapseFullScreenDialogFragment extends DialogFragment {</span>
    private Fragment mFragment;
    private CollapseFullScreenDialogController mController;
    private MenuItem mMenuAction;
    private OnConfirmListener mOnConfirmListener;
    private OnCollapseListener mOnCollapseListener;
    private String mAction;
    private String mTitle;
    private boolean mHideActivityBar;

    private static final String ARG_ACTION = &quot;ARG_ACTION&quot;;
    private static final String ARG_HIDE_ACTIVITY_BAR = &quot;ARG_HIDE_ACTIVITY_BAR&quot;;
    private static final String ARG_TITLE = &quot;ARG_TITLE&quot;;
    private static final int ID_ACTION = 1;

<span class="nc" id="L58">    public static final String TAG = CollapseFullScreenDialogFragment.class.getSimpleName();</span>

    public interface CollapseFullScreenDialogContent {
        boolean onCollapseClicked(CollapseFullScreenDialogController controller);

        boolean onConfirmClicked(CollapseFullScreenDialogController controller);

        void onViewCreated(CollapseFullScreenDialogController controller);
    }

    public interface CollapseFullScreenDialogController {
        void collapse(@Nullable Bundle result);

        void confirm(@Nullable Bundle result);

        void setConfirmEnabled(boolean enabled);
    }

    public interface OnCollapseListener {
        void onCollapse(@Nullable Bundle result);
    }

    public interface OnConfirmListener {
        void onConfirm(@Nullable Bundle result);
    }

    protected static CollapseFullScreenDialogFragment newInstance(Builder builder) {
<span class="nc" id="L85">        CollapseFullScreenDialogFragment dialog = new CollapseFullScreenDialogFragment();</span>
<span class="nc" id="L86">        dialog.setArguments(setArguments(builder));</span>
<span class="nc" id="L87">        dialog.setContent(Fragment.instantiate(builder.mContext, builder.mClass.getName(), builder.mArguments));</span>
<span class="nc" id="L88">        dialog.setOnCollapseListener(builder.mOnCollapseListener);</span>
<span class="nc" id="L89">        dialog.setOnConfirmListener(builder.mOnConfirmListener);</span>
<span class="nc" id="L90">        dialog.setHideActivityBar(builder.mHideActivityBar);</span>
<span class="nc" id="L91">        return dialog;</span>
    }

    private static Bundle setArguments(Builder builder) {
<span class="nc" id="L95">        Bundle bundle = new Bundle();</span>
<span class="nc" id="L96">        bundle.putString(ARG_ACTION, builder.mAction);</span>
<span class="nc" id="L97">        bundle.putString(ARG_TITLE, builder.mTitle);</span>
<span class="nc" id="L98">        bundle.putBoolean(ARG_HIDE_ACTIVITY_BAR, builder.mHideActivityBar);</span>
<span class="nc" id="L99">        return bundle;</span>
    }

    @Override
    public void onActivityCreated(Bundle savedInstanceState) {
<span class="nc" id="L104">        super.onActivityCreated(savedInstanceState);</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L107">            getChildFragmentManager()</span>
<span class="nc" id="L108">                    .beginTransaction()</span>
<span class="nc" id="L109">                    .setCustomAnimations(R.anim.full_screen_dialog_fragment_none, 0, 0,</span>
                            R.anim.full_screen_dialog_fragment_none)
<span class="nc" id="L111">                    .add(R.id.full_screen_dialog_fragment_content, mFragment)</span>
<span class="nc" id="L112">                    .commitNow();</span>
        }
<span class="nc" id="L114">    }</span>

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L118">        super.onCreate(savedInstanceState);</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc" id="L121">            mFragment = getChildFragmentManager().findFragmentById(R.id.full_screen_dialog_fragment_content);</span>
        }

<span class="nc" id="L124">        mController = new CollapseFullScreenDialogController() {</span>
            @Override
            public void collapse(@Nullable Bundle result) {
<span class="nc" id="L127">                CollapseFullScreenDialogFragment.this.collapse(result);</span>
<span class="nc" id="L128">            }</span>

            @Override
            public void confirm(@Nullable Bundle result) {
<span class="nc" id="L132">                CollapseFullScreenDialogFragment.this.confirm(result);</span>
<span class="nc" id="L133">            }</span>

            @Override
            public void setConfirmEnabled(boolean enabled) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if (CollapseFullScreenDialogFragment.this.mMenuAction != null) {</span>
<span class="nc" id="L138">                    CollapseFullScreenDialogFragment.this.mMenuAction.setEnabled(enabled);</span>
                }
<span class="nc" id="L140">            }</span>
        };
<span class="nc" id="L142">    }</span>

    @NonNull
    @Override
    public Dialog onCreateDialog(Bundle savedInstanceState) {
<span class="nc" id="L147">        initBuilderArguments();</span>

<span class="nc" id="L149">        Dialog dialog = new Dialog(requireContext(), getTheme()) {</span>
            @Override
            public void onBackPressed() {
<span class="nc" id="L152">                onCollapseClicked();</span>
<span class="nc" id="L153">            }</span>
        };

<span class="nc" id="L156">        dialog.requestWindowFeature(Window.FEATURE_NO_TITLE);</span>
<span class="nc" id="L157">        return dialog;</span>
    }

    @Nullable
    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container,
                             @Nullable Bundle savedInstanceState) {
<span class="nc" id="L164">        initBuilderArguments();</span>

<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (mHideActivityBar) {</span>
<span class="nc" id="L167">            hideActivityBar();</span>
        }

<span class="nc" id="L170">        ViewGroup view = (ViewGroup) inflater.inflate(R.layout.collapse_full_screen_dialog_fragment, container, false);</span>
<span class="nc" id="L171">        initToolbar(view);</span>
<span class="nc" id="L172">        setThemeBackground(view);</span>
<span class="nc" id="L173">        view.setFocusableInTouchMode(true);</span>
<span class="nc" id="L174">        view.requestFocus();</span>

<span class="nc" id="L176">        return view;</span>
    }

    @Override
    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
<span class="nc" id="L181">        ((CollapseFullScreenDialogContent) getContent()).onViewCreated(mController);</span>
<span class="nc" id="L182">    }</span>

    @Override
    public void dismiss() {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (mHideActivityBar) {</span>
<span class="nc" id="L187">            showActivityBar();</span>
        }

<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (getFragmentManager() != null) {</span>
<span class="nc" id="L191">            getFragmentManager().popBackStackImmediate();</span>
        }
<span class="nc" id="L193">    }</span>

    @Override
    @SuppressLint(&quot;CommitTransaction&quot;)
    public void show(FragmentManager manager, String tag) {
<span class="nc" id="L198">        show(manager.beginTransaction(), tag);</span>
<span class="nc" id="L199">    }</span>

    @Override
    public int show(FragmentTransaction transaction, String tag) {
<span class="nc" id="L203">        initBuilderArguments();</span>
<span class="nc" id="L204">        transaction.setCustomAnimations(R.anim.full_screen_dialog_fragment_slide_up, 0, 0,</span>
                R.anim.full_screen_dialog_fragment_slide_down);
<span class="nc" id="L206">        return transaction.add(android.R.id.content, this, tag).addToBackStack(null).commit();</span>
    }

    protected void collapse(Bundle result) {
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (mOnCollapseListener != null) {</span>
<span class="nc" id="L211">            mOnCollapseListener.onCollapse(result);</span>
        }

<span class="nc" id="L214">        dismiss();</span>
<span class="nc" id="L215">    }</span>

    protected void confirm(Bundle result) {
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (mOnConfirmListener != null) {</span>
<span class="nc" id="L219">            mOnConfirmListener.onConfirm(result);</span>
        }

<span class="nc" id="L222">        dismiss();</span>
<span class="nc" id="L223">    }</span>

    /**
     * Get {@link Fragment} to be able to interact directly with it.
     *
     * @return {@link Fragment} dialog content
     */
    public Fragment getContent() {
<span class="nc" id="L231">        return this.mFragment;</span>
    }

    /**
     * Hide {@link AppCompatActivity} bar when showing fullscreen dialog.
     */
    public void hideActivityBar() {
<span class="nc" id="L238">        FragmentActivity activity = getActivity();</span>

<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (activity instanceof AppCompatActivity) {</span>
<span class="nc" id="L241">            ActionBar actionBar = ((AppCompatActivity) activity).getSupportActionBar();</span>

<span class="nc bnc" id="L243" title="All 4 branches missed.">            if (actionBar != null &amp;&amp; actionBar.isShowing()) {</span>
<span class="nc" id="L244">                actionBar.hide();</span>
            }
        }
<span class="nc" id="L247">    }</span>

    /**
     * Initialize arguments passed in {@link Builder}.
     */
    private void initBuilderArguments() {
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (getArguments() != null) {</span>
<span class="nc" id="L254">            Bundle bundle = getArguments();</span>
<span class="nc" id="L255">            mAction = bundle.getString(ARG_ACTION);</span>
<span class="nc" id="L256">            mTitle = bundle.getString(ARG_TITLE);</span>
<span class="nc" id="L257">            mHideActivityBar = bundle.getBoolean(ARG_HIDE_ACTIVITY_BAR);</span>
        }
<span class="nc" id="L259">    }</span>

    /**
     * Initialize toolbar title and action.
     *
     * @param view {@link View}
     */
    private void initToolbar(View view) {
<span class="nc" id="L267">        Toolbar toolbar = view.findViewById(R.id.full_screen_dialog_fragment_toolbar);</span>

<span class="nc" id="L269">        ElevationOverlayProvider elevationOverlayProvider = new ElevationOverlayProvider(view.getContext());</span>
<span class="nc" id="L270">        float appbarElevation = getResources().getDimension(R.dimen.appbar_elevation);</span>
<span class="nc" id="L271">        int elevatedColor = elevationOverlayProvider.compositeOverlayWithThemeSurfaceColorIfNeeded(appbarElevation);</span>
<span class="nc" id="L272">        toolbar.setBackgroundColor(elevatedColor);</span>

<span class="nc" id="L274">        toolbar.setTitle(mTitle);</span>
<span class="nc" id="L275">        toolbar.setNavigationContentDescription(R.string.description_collapse);</span>
<span class="nc" id="L276">        toolbar.setNavigationIcon(ContextCompat.getDrawable(view.getContext(), R.drawable.ic_chevron_down_white_24dp));</span>
<span class="nc" id="L277">        toolbar.setNavigationOnClickListener(v -&gt; onCollapseClicked());</span>

<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (!mAction.isEmpty()) {</span>
<span class="nc" id="L280">            Menu menu = toolbar.getMenu();</span>
<span class="nc" id="L281">            mMenuAction = menu.add(0, ID_ACTION, 0, this.mAction);</span>
<span class="nc" id="L282">            mMenuAction.setIcon(R.drawable.ic_send_white_24dp);</span>
<span class="nc" id="L283">            MenuItemCompat.setIconTintList(mMenuAction,</span>
<span class="nc" id="L284">                    AppCompatResources.getColorStateList(view.getContext(), R.color.primary_neutral_30_selector));</span>
<span class="nc" id="L285">            mMenuAction.setEnabled(false);</span>
<span class="nc" id="L286">            mMenuAction.setShowAsAction(MenuItem.SHOW_AS_ACTION_ALWAYS);</span>
<span class="nc" id="L287">            mMenuAction.setOnMenuItemClickListener(</span>
                    item -&gt; {
<span class="nc bnc" id="L289" title="All 2 branches missed.">                        if (item.getItemId() == ID_ACTION) {</span>
<span class="nc" id="L290">                            onConfirmClicked();</span>
<span class="nc" id="L291">                            return true;</span>
                        } else {
<span class="nc" id="L293">                            return false;</span>
                        }
                    }
            );
        }
<span class="nc" id="L298">    }</span>

    public void onBackPressed() {
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (isAdded()) {</span>
<span class="nc" id="L302">            onCollapseClicked();</span>
        }
<span class="nc" id="L304">    }</span>

    protected void onConfirmClicked() {
<span class="nc" id="L307">        boolean isConsumed = ((CollapseFullScreenDialogContent) mFragment).onConfirmClicked(mController);</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (!isConsumed) {</span>
<span class="nc" id="L310">            mController.confirm(null);</span>
        }
<span class="nc" id="L312">    }</span>

    protected void onCollapseClicked() {
<span class="nc" id="L315">        boolean isConsumed = ((CollapseFullScreenDialogContent) mFragment).onCollapseClicked(mController);</span>

<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (!isConsumed) {</span>
<span class="nc" id="L318">            mController.collapse(null);</span>
        }
<span class="nc" id="L320">    }</span>

    /**
     * Set {@link Fragment} as dialog content.
     *
     * @param fragment {@link Fragment} to set as dialog content
     */
    private void setContent(Fragment fragment) {
<span class="nc" id="L328">        this.mFragment = fragment;</span>
<span class="nc" id="L329">    }</span>

    /**
     * Set flag to hide activity bar when showing fullscreen dialog.
     *
     * @param hide boolean to hide activity bar
     */
    public void setHideActivityBar(boolean hide) {
<span class="nc" id="L337">        this.mHideActivityBar = hide;</span>
<span class="nc" id="L338">    }</span>

    /**
     * Set callback to call when dialog is closed due to collapse click.
     *
     * @param listener {@link OnCollapseListener} interface to call on collapse click
     */
    public void setOnCollapseListener(@Nullable OnCollapseListener listener) {
<span class="nc" id="L346">        this.mOnCollapseListener = listener;</span>
<span class="nc" id="L347">    }</span>

    /**
     * Set callback to call when dialog is closed due to confirm click.
     *
     * @param listener {@link OnConfirmListener} interface to call on confirm click
     */
    public void setOnConfirmListener(@Nullable OnConfirmListener listener) {
<span class="nc" id="L355">        this.mOnConfirmListener = listener;</span>
<span class="nc" id="L356">    }</span>

    /**
     * Set theme background for {@link CollapseFullScreenDialogFragment} view.
     *
     * @param view {@link View} to set background
     */
    private void setThemeBackground(View view) {
<span class="nc" id="L364">        TypedValue value = new TypedValue();</span>
<span class="nc" id="L365">        requireActivity().getTheme().resolveAttribute(android.R.attr.windowBackground, value, true);</span>

<span class="nc bnc" id="L367" title="All 4 branches missed.">        if (value.type &gt;= TypedValue.TYPE_FIRST_COLOR_INT &amp;&amp; value.type &lt;= TypedValue.TYPE_LAST_COLOR_INT) {</span>
<span class="nc" id="L368">            view.setBackgroundColor(value.data);</span>
        } else {
            try {
<span class="nc" id="L371">                Drawable drawable = ResourcesCompat.getDrawable(requireActivity().getResources(), value.resourceId,</span>
<span class="nc" id="L372">                        requireActivity().getTheme());</span>
<span class="nc" id="L373">                ViewCompat.setBackground(view, drawable);</span>
<span class="nc" id="L374">            } catch (Resources.NotFoundException ignore) {</span>
<span class="nc" id="L375">            }</span>
        }
<span class="nc" id="L377">    }</span>

    /**
     * Show {@link AppCompatActivity} bar when hiding fullscreen dialog.
     */
    public void showActivityBar() {
<span class="nc" id="L383">        FragmentActivity activity = getActivity();</span>

<span class="nc bnc" id="L385" title="All 2 branches missed.">        if (activity instanceof AppCompatActivity) {</span>
<span class="nc" id="L386">            ActionBar actionBar = ((AppCompatActivity) activity).getSupportActionBar();</span>

<span class="nc bnc" id="L388" title="All 4 branches missed.">            if (actionBar != null &amp;&amp; !actionBar.isShowing()) {</span>
<span class="nc" id="L389">                actionBar.show();</span>
            }
        }
<span class="nc" id="L392">    }</span>

    public static class Builder {
        Bundle mArguments;
        Class&lt;? extends Fragment&gt; mClass;
        Context mContext;
        OnCollapseListener mOnCollapseListener;
        OnConfirmListener mOnConfirmListener;
<span class="nc" id="L400">        String mAction = &quot;&quot;;</span>
<span class="nc" id="L401">        String mTitle = &quot;&quot;;</span>
<span class="nc" id="L402">        boolean mHideActivityBar = false;</span>

        /**
         * Builder to construct {@link CollapseFullScreenDialogFragment}.
         *
         * @param context {@link Context}
         */
<span class="nc" id="L409">        public Builder(@NonNull Context context) {</span>
<span class="nc" id="L410">            this.mContext = context;</span>
<span class="nc" id="L411">        }</span>

        /**
         * Creates {@link CollapseFullScreenDialogFragment} with provided parameters.
         *
         * @return {@link CollapseFullScreenDialogFragment} instance created
         */
        public CollapseFullScreenDialogFragment build() {
<span class="nc" id="L419">            return CollapseFullScreenDialogFragment.newInstance(this);</span>
        }

        /**
         * Set {@link CollapseFullScreenDialogFragment} action text.
         *
         * @param text {@link String} to set as action text
         * @return {@link Builder} object to allow for chaining of calls to set methods
         */
        public Builder setAction(@NonNull String text) {
<span class="nc" id="L429">            this.mAction = text;</span>
<span class="nc" id="L430">            return this;</span>
        }

        /**
         * Set {@link CollapseFullScreenDialogFragment} action text.
         *
         * @param textId resource ID to set as action text
         */
        public Builder setAction(@StringRes int textId) {
<span class="nc" id="L439">            return setAction(mContext.getString(textId));</span>
        }

        /**
         * Set {@link Fragment} to be added as dialog, which must implement {@link CollapseFullScreenDialogContent}.
         *
         * @param contentClass     Fragment class to be instantiated
         * @param contentArguments arguments to be added to Fragment
         * @return {@link Builder} object to allow for chaining of calls to set methods
         * @throws IllegalArgumentException if content class does not implement
         *                                  {@link CollapseFullScreenDialogContent} interface
         */
        public Builder setContent(Class&lt;? extends Fragment&gt; contentClass, @Nullable Bundle contentArguments) {
<span class="nc bnc" id="L452" title="All 2 branches missed.">            if (!CollapseFullScreenDialogContent.class.isAssignableFrom(contentClass)) {</span>
<span class="nc" id="L453">                throw new IllegalArgumentException(</span>
                        &quot;The fragment class must implement CollapseFullScreenDialogContent interface&quot;);
            }

<span class="nc" id="L457">            this.mClass = contentClass;</span>
<span class="nc" id="L458">            this.mArguments = contentArguments;</span>
<span class="nc" id="L459">            return this;</span>
        }

        /**
         * Set flag to hide activity bar when showing fullscreen dialog.
         *
         * @param hide boolean to hide activity bar
         * @return {@link Builder} object to allow for chaining of calls to set methods
         */
        public Builder setHideActivityBar(boolean hide) {
<span class="nc" id="L469">            this.mHideActivityBar = hide;</span>
<span class="nc" id="L470">            return this;</span>
        }

        /**
         * Set callback to call when dialog is closed due to collapse click.
         *
         * @param listener {@link OnCollapseListener} interface to call on collapse click
         * @return {@link Builder} object to allow for chaining of calls to set methods
         */
        public Builder setOnCollapseListener(@Nullable OnCollapseListener listener) {
<span class="nc" id="L480">            this.mOnCollapseListener = listener;</span>
<span class="nc" id="L481">            return this;</span>
        }

        /**
         * Set callback to call when dialog is closed due to confirm click.
         *
         * @param listener {@link OnConfirmListener} interface to call on confirm click
         * @return {@link Builder} object to allow for chaining of calls to set methods
         */
        public Builder setOnConfirmListener(@Nullable OnConfirmListener listener) {
<span class="nc" id="L491">            this.mOnConfirmListener = listener;</span>
<span class="nc" id="L492">            return this;</span>
        }

        /**
         * Set {@link CollapseFullScreenDialogFragment} title text.
         *
         * @param text {@link String} to set as title text
         * @return {@link Builder} object to allow for chaining of calls to set methods
         */
        public Builder setTitle(@NonNull String text) {
<span class="nc" id="L502">            this.mTitle = text;</span>
<span class="nc" id="L503">            return this;</span>
        }

        /**
         * Set {@link CollapseFullScreenDialogFragment} title text.
         *
         * @param textId resource ID to set as title text
         * @return {@link Builder} object to allow for chaining of calls to set methods
         */
        public Builder setTitle(@StringRes int textId) {
<span class="nc" id="L513">            this.mTitle = mContext.getString(textId);</span>
<span class="nc" id="L514">            return this;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>