<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrepublishingHomeViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PrepublishingHomeViewModel.kt</span></div><h1>PrepublishingHomeViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.model.post.PostStatus
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.ui.posts.PrepublishingHomeItemUiState.ActionType
import org.wordpress.android.ui.posts.PrepublishingHomeItemUiState.ActionType.CATEGORIES
import org.wordpress.android.ui.posts.PrepublishingHomeItemUiState.ActionType.PUBLISH
import org.wordpress.android.ui.posts.PrepublishingHomeItemUiState.ActionType.TAGS
import org.wordpress.android.ui.posts.PrepublishingHomeItemUiState.HeaderUiState
import org.wordpress.android.ui.posts.PrepublishingHomeItemUiState.HomeUiState
import org.wordpress.android.ui.posts.PrepublishingHomeItemUiState.StoryTitleUiState
import org.wordpress.android.ui.posts.prepublishing.home.usecases.GetButtonUiStateUseCase
import org.wordpress.android.ui.stories.StoryRepositoryWrapper
import org.wordpress.android.ui.stories.usecase.UpdateStoryPostTitleUseCase
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.StringUtils
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.viewmodel.Event
import org.wordpress.android.viewmodel.ScopedViewModel
import javax.inject.Inject
import javax.inject.Named

private const val THROTTLE_DELAY = 500L

<span class="nc" id="L34">class PrepublishingHomeViewModel @Inject constructor(</span>
<span class="nc" id="L35">    private val getPostTagsUseCase: GetPostTagsUseCase,</span>
<span class="nc" id="L36">    private val postSettingsUtils: PostSettingsUtils,</span>
<span class="nc" id="L37">    private val getButtonUiStateUseCase: GetButtonUiStateUseCase,</span>
<span class="nc" id="L38">    private val analyticsTrackerWrapper: AnalyticsTrackerWrapper,</span>
<span class="nc" id="L39">    private val storyRepositoryWrapper: StoryRepositoryWrapper,</span>
<span class="nc" id="L40">    private val updateStoryPostTitleUseCase: UpdateStoryPostTitleUseCase,</span>
<span class="nc" id="L41">    private val getCategoriesUseCase: GetCategoriesUseCase,</span>
<span class="nc" id="L42">    @Named(BG_THREAD) private val bgDispatcher: CoroutineDispatcher</span>
<span class="nc" id="L43">) : ScopedViewModel(bgDispatcher) {</span>
    private var isStarted = false
    private var updateStoryTitleJob: Job? = null
    private lateinit var editPostRepository: EditPostRepository

<span class="nc" id="L48">    private val _uiState = MutableLiveData&lt;List&lt;PrepublishingHomeItemUiState&gt;&gt;()</span>
<span class="nc" id="L49">    val uiState: LiveData&lt;List&lt;PrepublishingHomeItemUiState&gt;&gt; = _uiState</span>

<span class="nc" id="L51">    private val _storyTitleUiState = MutableLiveData&lt;StoryTitleUiState&gt;()</span>
<span class="nc" id="L52">    val storyTitleUiState: LiveData&lt;StoryTitleUiState&gt; = _storyTitleUiState</span>

<span class="nc" id="L54">    private val _onActionClicked = MutableLiveData&lt;Event&lt;ActionType&gt;&gt;()</span>
<span class="nc" id="L55">    val onActionClicked: LiveData&lt;Event&lt;ActionType&gt;&gt; = _onActionClicked</span>

<span class="nc" id="L57">    private val _onSubmitButtonClicked = MutableLiveData&lt;Event&lt;PublishPost&gt;&gt;()</span>
<span class="nc" id="L58">    val onSubmitButtonClicked: LiveData&lt;Event&lt;PublishPost&gt;&gt; = _onSubmitButtonClicked</span>

    fun start(editPostRepository: EditPostRepository, site: SiteModel, isStoryPost: Boolean) {
<span class="nc" id="L61">        this.editPostRepository = editPostRepository</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (isStarted) return</span>
<span class="nc" id="L63">        isStarted = true</span>

<span class="nc" id="L65">        setupHomeUiState(editPostRepository, site, isStoryPost)</span>
<span class="nc" id="L66">    }</span>

    private fun setupHomeUiState(
        editPostRepository: EditPostRepository,
        site: SiteModel,
        isStoryPost: Boolean
    ) {
<span class="nc" id="L73">        val prepublishingHomeUiStateList = mutableListOf&lt;PrepublishingHomeItemUiState&gt;().apply {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            if (isStoryPost) {</span>
<span class="nc" id="L75">                _storyTitleUiState.postValue(StoryTitleUiState(</span>
<span class="nc" id="L76">                        storyTitle = UiStringText(StringUtils.notNullStr(editPostRepository.title)),</span>
<span class="nc" id="L77">                        storyThumbnailUrl = storyRepositoryWrapper.getCurrentStoryThumbnailUrl()</span>
                ) { storyTitle -&gt;
<span class="nc" id="L79">                    onStoryTitleChanged(storyTitle)</span>
<span class="nc" id="L80">                })</span>
            } else {
<span class="nc" id="L82">                add(HeaderUiState(UiStringText(site.name), StringUtils.notNullStr(site.iconUrl)))</span>
            }

<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (editPostRepository.status != PostStatus.PRIVATE) {</span>
<span class="nc" id="L86">                add(</span>
<span class="nc" id="L87">                        HomeUiState(</span>
<span class="nc" id="L88">                                actionType = PUBLISH,</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                                actionResult = editPostRepository.getEditablePost()</span>
<span class="nc" id="L90">                                        ?.let {</span>
<span class="nc" id="L91">                                            UiStringText(</span>
<span class="nc" id="L92">                                                    postSettingsUtils.getPublishDateLabel(</span>
<span class="nc" id="L93">                                                            it</span>
                                                    )
                                            )
                                        },
<span class="nc" id="L97">                                actionClickable = true,</span>
<span class="nc" id="L98">                                onActionClicked = ::onActionClicked</span>
                        )
                )
            } else {
<span class="nc" id="L102">                add(</span>
<span class="nc" id="L103">                        HomeUiState(</span>
<span class="nc" id="L104">                                actionType = PUBLISH,</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                                actionResult = editPostRepository.getEditablePost()</span>
<span class="nc" id="L106">                                        ?.let {</span>
<span class="nc" id="L107">                                            UiStringText(</span>
<span class="nc" id="L108">                                                    postSettingsUtils.getPublishDateLabel(</span>
<span class="nc" id="L109">                                                            it</span>
                                                    )
                                            )
                                        },
<span class="nc" id="L113">                                actionTypeColor = R.color.prepublishing_action_type_disabled_color,</span>
<span class="nc" id="L114">                                actionResultColor = R.color.prepublishing_action_result_disabled_color,</span>
<span class="nc" id="L115">                                actionClickable = false,</span>
<span class="nc" id="L116">                                onActionClicked = null</span>
                        )
                )
            }

<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (!editPostRepository.isPage) {</span>
<span class="nc" id="L122">                add(HomeUiState(</span>
<span class="nc" id="L123">                        actionType = TAGS,</span>
<span class="nc bnc" id="L124" title="All 4 branches missed.">                        actionResult = getPostTagsUseCase.getTags(editPostRepository)</span>
<span class="nc" id="L125">                                ?.let { UiStringText(it) }</span>
<span class="nc" id="L126">                                ?: run { UiStringRes(R.string.prepublishing_nudges_home_tags_not_set) },</span>
<span class="nc" id="L127">                        actionClickable = true,</span>
<span class="nc" id="L128">                        onActionClicked = ::onActionClicked</span>
                )
                )

<span class="nc" id="L132">                val categoryString: String = getCategoriesUseCase.getPostCategoriesString(</span>
<span class="nc" id="L133">                        editPostRepository,</span>
<span class="nc" id="L134">                        site</span>
                )
<span class="nc bnc" id="L136" title="All 4 branches missed.">                if (categoryString.isNotEmpty()) {</span>
<span class="nc" id="L137">                    UiStringText(categoryString)</span>
                }
            } else {
<span class="nc" id="L140">                UiStringRes(R.string.prepublishing_nudges_home_categories_not_set)</span>
            }

<span class="nc" id="L143">            val categoriesString = getCategoriesUseCase.getPostCategoriesString(</span>
<span class="nc" id="L144">                    editPostRepository,</span>
<span class="nc" id="L145">                    site</span>
            )

<span class="nc" id="L148">            add(HomeUiState(</span>
<span class="nc" id="L149">                    actionType = CATEGORIES,</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">                    actionResult = if (categoriesString.isNotEmpty()) {</span>
<span class="nc" id="L151">                        UiStringText(categoriesString)</span>
                    } else {
<span class="nc" id="L153">                        run { UiStringRes(R.string.prepublishing_nudges_home_categories_not_set) }</span>
                    },
<span class="nc" id="L155">                    actionClickable = true,</span>
<span class="nc" id="L156">                    onActionClicked = ::onActionClicked</span>
            ))

<span class="nc" id="L159">            add(getButtonUiStateUseCase.getUiState(editPostRepository, site) { publishPost -&gt;</span>
<span class="nc" id="L160">                launch(bgDispatcher) {</span>
<span class="nc" id="L161">                    waitForStoryTitleJobAndSubmit(publishPost)</span>
<span class="nc" id="L162">                }</span>
<span class="nc" id="L163">            })</span>
<span class="nc" id="L164">        }.toList()</span>

<span class="nc" id="L166">        _uiState.postValue(prepublishingHomeUiStateList)</span>
<span class="nc" id="L167">    }</span>

    private fun onStoryTitleChanged(storyTitle: String) {
<span class="nc bnc" id="L170" title="All 2 branches missed.">        updateStoryTitleJob?.cancel()</span>
<span class="nc" id="L171">        updateStoryTitleJob = launch(bgDispatcher) {</span>
            // there's a delay here since every single character change event triggers onStoryTitleChanged
            // and without a delay we would have multiple save operations being triggered unnecessarily.
<span class="nc" id="L174">            delay(THROTTLE_DELAY)</span>
<span class="nc" id="L175">            storyRepositoryWrapper.setCurrentStoryTitle(storyTitle)</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            updateStoryPostTitleUseCase.updateStoryTitle(storyTitle, editPostRepository)</span>
<span class="nc" id="L177">        }</span>
<span class="nc" id="L178">    }</span>

    private suspend fun waitForStoryTitleJobAndSubmit(publishPost: PublishPost) {
<span class="nc bnc" id="L181" title="All 2 branches missed.">        updateStoryTitleJob?.join()</span>
<span class="nc" id="L182">        analyticsTrackerWrapper.trackPrepublishingNudges(Stat.EDITOR_POST_PUBLISH_NOW_TAPPED)</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        _onSubmitButtonClicked.postValue(Event(publishPost))</span>
<span class="nc" id="L184">    }</span>

    override fun onCleared() {
<span class="nc" id="L187">        super.onCleared()</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        updateStoryTitleJob?.cancel()</span>
<span class="nc" id="L189">    }</span>

    private fun onActionClicked(actionType: ActionType) {
<span class="nc" id="L192">        _onActionClicked.postValue(Event(actionType))</span>
<span class="nc" id="L193">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>