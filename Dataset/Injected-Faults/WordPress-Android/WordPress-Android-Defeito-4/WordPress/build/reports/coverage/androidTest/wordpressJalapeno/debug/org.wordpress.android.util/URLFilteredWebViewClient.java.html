<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>URLFilteredWebViewClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">URLFilteredWebViewClient.java</span></div><h1>URLFilteredWebViewClient.java</h1><pre class="source lang-java linenums">package org.wordpress.android.util;

import android.content.Context;
import android.net.Uri;
import android.webkit.WebView;
import android.widget.Toast;

import org.wordpress.android.WordPress;
import org.wordpress.android.ui.reader.ReaderActivityLauncher;

import java.util.Collection;
import java.util.LinkedHashSet;
import java.util.Set;


/**
 * WebViewClient that adds the ability of restrict URL loading (navigation) to a list of allowed URLs.
 * Generally used to disable links and navigation in admin pages.
 */
public class URLFilteredWebViewClient extends ErrorManagedWebViewClient {
<span class="nc" id="L21">    private Set&lt;String&gt; mAllowedURLs = new LinkedHashSet&lt;&gt;();</span>

    private static final String WP_LOGIN_URL_SUFFIX = &quot;wp-login.php&quot;;
    private static final String REMOTE_LOGIN_URL_SUFFIX = &quot;remote-login.php&quot;;

    public URLFilteredWebViewClient(String url, ErrorManagedWebViewClientListener listener) {
<span class="nc" id="L27">        super(listener);</span>
<span class="nc" id="L28">        mAllowedURLs.add(url);</span>
<span class="nc" id="L29">    }</span>

    public URLFilteredWebViewClient(Collection&lt;String&gt; urls, ErrorManagedWebViewClientListener listener) {
<span class="nc" id="L32">        super(listener);</span>
<span class="nc bnc" id="L33" title="All 4 branches missed.">        if (urls == null || urls.size() == 0) {</span>
<span class="nc" id="L34">            AppLog.w(AppLog.T.UTILS, &quot;No valid URLs passed to URLFilteredWebViewClient! HTTP Links in the&quot;</span>
                                     + &quot; page are NOT disabled, and ALL URLs could be loaded by the user!!&quot;);
<span class="nc" id="L36">            return;</span>
        }
<span class="nc" id="L38">        mAllowedURLs.addAll(urls);</span>
<span class="nc" id="L39">    }</span>


    private boolean isAllURLsAllowed() {
<span class="nc bnc" id="L43" title="All 2 branches missed.">        return mAllowedURLs.size() == 0;</span>
    }

    private boolean isHttpUrlAllowed(String url) {
<span class="nc bnc" id="L47" title="All 2 branches missed.">        return mAllowedURLs.contains(url.replace(&quot;https://&quot;, &quot;http://&quot;))</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">               || mAllowedURLs.contains(StringUtils.removeTrailingSlash(url)</span>
<span class="nc" id="L49">                                                   .replace(&quot;https://&quot;, &quot;http://&quot;));</span>
    }

    @Override
    public boolean shouldOverrideUrlLoading(WebView view, String url) {
        // Found a bug on some pages where there is an incorrect
        // auto-redirect to file:///android_asset/webkit/.
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (url.equals(&quot;file:///android_asset/webkit/&quot;)) {</span>
<span class="nc" id="L57">            return true;</span>
        }

<span class="nc bnc" id="L60" title="All 4 branches missed.">        if (isAllURLsAllowed() || mAllowedURLs.contains(url)</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            || isHttpUrlAllowed(url) // Allow https redirection</span>
            // If a url is allowed without the trailing `/`, it should be allowed with it as well
<span class="nc bnc" id="L63" title="All 2 branches missed.">            || mAllowedURLs.contains(StringUtils.removeTrailingSlash(url))) {</span>
<span class="nc" id="L64">            boolean isComingFromLoginUrl =</span>
<span class="nc bnc" id="L65" title="All 4 branches missed.">                    view.getUrl().endsWith(WP_LOGIN_URL_SUFFIX) || view.getUrl().endsWith(REMOTE_LOGIN_URL_SUFFIX);</span>

<span class="nc" id="L67">            boolean isRemoteLoginUrl = url.endsWith(REMOTE_LOGIN_URL_SUFFIX);</span>
<span class="nc" id="L68">            boolean isLoginUrl = url.endsWith(WP_LOGIN_URL_SUFFIX);</span>

<span class="nc" id="L70">            Uri currentUri = Uri.parse((view.getUrl()));</span>
<span class="nc" id="L71">            Uri incomingUri = Uri.parse(url);</span>

<span class="nc" id="L73">            boolean newUrlIsOnTheSameHost =</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">                    currentUri.getHost() != null &amp;&amp; currentUri.getHost().equals(incomingUri.getHost());</span>

<span class="nc bnc" id="L76" title="All 8 branches missed.">            boolean openInExternalBrowser =</span>
                    !isRemoteLoginUrl &amp;&amp; !isLoginUrl &amp;&amp; !isComingFromLoginUrl &amp;&amp; !newUrlIsOnTheSameHost;

<span class="nc bnc" id="L79" title="All 2 branches missed.">            if (openInExternalBrowser) {</span>
<span class="nc" id="L80">                ReaderActivityLauncher.openUrl(view.getContext(), url, ReaderActivityLauncher.OpenUrlType.EXTERNAL);</span>
<span class="nc" id="L81">                return true;</span>
            }

<span class="nc" id="L84">            return false;</span>
        } else {
            // show &quot;links are disabled&quot; message.
<span class="nc" id="L87">            Context ctx = WordPress.getContext();</span>
<span class="nc" id="L88">            int linksDisabledMessageResId = org.wordpress.android.R.string.preview_screen_links_disabled;</span>
<span class="nc" id="L89">            Toast.makeText(ctx, ctx.getText(linksDisabledMessageResId), Toast.LENGTH_SHORT).show();</span>
        }
<span class="nc" id="L91">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>