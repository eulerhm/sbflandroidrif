<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadWorker.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.util</a> &gt; <span class="el_source">UploadWorker.kt</span></div><h1>UploadWorker.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.util

import android.content.Context
import androidx.work.Constraints
import androidx.work.ExistingPeriodicWorkPolicy
import androidx.work.ExistingWorkPolicy
import androidx.work.ListenableWorker
import androidx.work.NetworkType
import androidx.work.OneTimeWorkRequestBuilder
import androidx.work.Operation
import androidx.work.PeriodicWorkRequestBuilder
import androidx.work.WorkManager
import androidx.work.WorkRequest
import androidx.work.Worker
import androidx.work.WorkerFactory
import androidx.work.WorkerParameters
import androidx.work.workDataOf
import kotlinx.coroutines.runBlocking
import org.wordpress.android.WordPress
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.ui.uploads.UploadStarter
import java.util.concurrent.TimeUnit.HOURS

<span class="fc" id="L25">class UploadWorker(</span>
    appContext: Context,
    workerParams: WorkerParameters,
<span class="fc" id="L28">    private val uploadStarter: UploadStarter,</span>
<span class="fc" id="L29">    private val siteStore: SiteStore</span>
<span class="fc" id="L30">) : Worker(appContext, workerParams) {</span>
    companion object {
        private const val UPLOAD_FROM_ALL_SITES = -1
    }

    override fun doWork(): Result {
<span class="fc" id="L36">        runBlocking {</span>
<span class="fc" id="L37">            val job = when (val localSiteId = inputData.getInt(WordPress.LOCAL_SITE_ID, UPLOAD_FROM_ALL_SITES)) {</span>
<span class="pc bpc" id="L38" title="1 of 2 branches missed.">                UPLOAD_FROM_ALL_SITES -&gt; uploadStarter.queueUploadFromAllSites()</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">                else -&gt; siteStore.getSiteByLocalId(localSiteId)?.let { uploadStarter.queueUploadFromSite(it) }</span>
            }
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">            job?.join()</span>
        }
<span class="fc" id="L43">        return Result.success()</span>
    }

<span class="fc" id="L46">    class Factory(</span>
<span class="fc" id="L47">        private val uploadStarter: UploadStarter,</span>
<span class="fc" id="L48">        private val siteStore: SiteStore</span>
<span class="fc" id="L49">    ) : WorkerFactory() {</span>
        override fun createWorker(
            appContext: Context,
            workerClassName: String,
            workerParameters: WorkerParameters
        ): ListenableWorker? {
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">            return if (workerClassName == UploadWorker::class.java.name) {</span>
<span class="fc" id="L56">                UploadWorker(appContext, workerParameters, uploadStarter, siteStore)</span>
            } else {
<span class="nc" id="L58">                null</span>
            }
        }
    }
}

private fun getUploadConstraints(): Constraints {
<span class="fc" id="L65">    return Constraints.Builder()</span>
<span class="fc" id="L66">            .setRequiredNetworkType(NetworkType.NOT_ROAMING)</span>
<span class="fc" id="L67">            .build()</span>
}

fun enqueueUploadWorkRequestForSite(site: SiteModel): Pair&lt;WorkRequest, Operation&gt; {
<span class="nc" id="L71">    val request = OneTimeWorkRequestBuilder&lt;UploadWorker&gt;()</span>
<span class="nc" id="L72">            .setConstraints(getUploadConstraints())</span>
<span class="nc" id="L73">            .setInputData(workDataOf(WordPress.LOCAL_SITE_ID to site.id))</span>
<span class="nc" id="L74">            .build()</span>
<span class="nc" id="L75">    val operation = WorkManager.getInstance(WordPress.getContext()).enqueueUniqueWork(</span>
<span class="nc" id="L76">            &quot;auto-upload-&quot; + site.id,</span>
<span class="nc" id="L77">            ExistingWorkPolicy.KEEP, request</span>
    )
<span class="nc" id="L79">    return Pair(request, operation)</span>
}

fun enqueuePeriodicUploadWorkRequestForAllSites(): Pair&lt;WorkRequest, Operation&gt; {
<span class="fc" id="L83">    val request = PeriodicWorkRequestBuilder&lt;UploadWorker&gt;(8, HOURS, 6, HOURS)</span>
<span class="fc" id="L84">            .setConstraints(getUploadConstraints())</span>
<span class="fc" id="L85">            .build()</span>
<span class="fc" id="L86">    val operation = WorkManager.getInstance(WordPress.getContext()).enqueueUniquePeriodicWork(</span>
<span class="fc" id="L87">            &quot;periodic auto-upload&quot;,</span>
<span class="fc" id="L88">            ExistingPeriodicWorkPolicy.KEEP, request</span>
    )
<span class="fc" id="L90">    return Pair(request, operation)</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>