<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WPComSiteSettings.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs</a> &gt; <span class="el_source">WPComSiteSettings.java</span></div><h1>WPComSiteSettings.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs;

import android.content.Context;
import android.text.TextUtils;

import androidx.annotation.NonNull;

import com.android.volley.VolleyError;
import com.wordpress.rest.RestRequest;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.datasets.SiteSettingsTable;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.models.CategoryModel;
import org.wordpress.android.models.JetpackSettingsModel;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils;

import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

class WPComSiteSettings extends SiteSettingsInterface {
    // WP.com REST keys used in response to a settings GET and POST request
    private static final String LANGUAGE_ID_KEY = &quot;lang_id&quot;;
    private static final String SITE_ICON_KEY = &quot;site_icon&quot;;
    private static final String PRIVACY_KEY = &quot;blog_public&quot;;
    private static final String URL_KEY = &quot;URL&quot;;
    private static final String DEF_CATEGORY_KEY = &quot;default_category&quot;;
    private static final String DEF_POST_FORMAT_KEY = &quot;default_post_format&quot;;
    private static final String RELATED_POSTS_ALLOWED_KEY = &quot;jetpack_relatedposts_allowed&quot;;
    private static final String RELATED_POSTS_ENABLED_KEY = &quot;jetpack_relatedposts_enabled&quot;;
    private static final String RELATED_POSTS_HEADER_KEY = &quot;jetpack_relatedposts_show_headline&quot;;
    private static final String RELATED_POSTS_IMAGES_KEY = &quot;jetpack_relatedposts_show_thumbnails&quot;;
    private static final String ALLOW_COMMENTS_KEY = &quot;default_comment_status&quot;;
    private static final String SEND_PINGBACKS_KEY = &quot;default_pingback_flag&quot;;
    private static final String RECEIVE_PINGBACKS_KEY = &quot;default_ping_status&quot;;
    private static final String CLOSE_OLD_COMMENTS_KEY = &quot;close_comments_for_old_posts&quot;;
    private static final String CLOSE_OLD_COMMENTS_DAYS_KEY = &quot;close_comments_days_old&quot;;
    private static final String THREAD_COMMENTS_KEY = &quot;thread_comments&quot;;
    private static final String THREAD_COMMENTS_DEPTH_KEY = &quot;thread_comments_depth&quot;;
    private static final String PAGE_COMMENTS_KEY = &quot;page_comments&quot;;
    private static final String PAGE_COMMENT_COUNT_KEY = &quot;comments_per_page&quot;;
    private static final String COMMENT_SORT_ORDER_KEY = &quot;comment_order&quot;;
    private static final String COMMENT_MODERATION_KEY = &quot;comment_moderation&quot;;
    private static final String REQUIRE_IDENTITY_KEY = &quot;require_name_email&quot;;
    private static final String REQUIRE_USER_ACCOUNT_KEY = &quot;comment_registration&quot;;
    private static final String ALLOWLIST_KNOWN_USERS_KEY = &quot;comment_whitelist&quot;;
    private static final String MAX_LINKS_KEY = &quot;comment_max_links&quot;;
    private static final String MODERATION_KEYS_KEY = &quot;moderation_keys&quot;;
    private static final String DENYLIST_KEYS_KEY = &quot;blacklist_keys&quot;;
    private static final String SHARING_LABEL_KEY = &quot;sharing_label&quot;;
    private static final String SHARING_BUTTON_STYLE_KEY = &quot;sharing_button_style&quot;;
    private static final String SHARING_REBLOGS_DISABLED_KEY = &quot;disabled_reblogs&quot;;
    private static final String SHARING_LIKES_DISABLED_KEY = &quot;disabled_likes&quot;;
    private static final String SHARING_COMMENT_LIKES_KEY = &quot;jetpack_comment_likes_enabled&quot;;
    private static final String TWITTER_USERNAME_KEY = &quot;twitter_via&quot;;
    private static final String JP_MONITOR_EMAIL_NOTES_KEY = &quot;email_notifications&quot;;
    private static final String JP_MONITOR_WP_NOTES_KEY = &quot;wp_note_notifications&quot;;
    private static final String JP_PROTECT_ALLOWLIST_KEY = &quot;jetpack_protect_whitelist&quot;;
    // Jetpack modules
    private static final String SERVE_IMAGES_FROM_OUR_SERVERS = &quot;photon&quot;;
    private static final String SERVE_STATIC_FILES_FROM_OUR_SERVERS = &quot;photon-cdn&quot;;
    private static final String LAZY_LOAD_IMAGES = &quot;lazy-images&quot;;
    private static final String SHARING_MODULE = &quot;sharedaddy&quot;;

    private static final String AD_FREE_VIDEO_HOSTING_MODULE = &quot;videopress&quot;;
    private static final String SEARCH_MODULE = &quot;search&quot;;

    private static final String START_OF_WEEK_KEY = &quot;start_of_week&quot;;
    private static final String DATE_FORMAT_KEY = &quot;date_format&quot;;
    private static final String TIME_FORMAT_KEY = &quot;time_format&quot;;
    private static final String TIMEZONE_KEY = &quot;timezone_string&quot;;
    private static final String GMT_OFFSET_KEY = &quot;gmt_offset&quot;;
    private static final String POSTS_PER_PAGE_KEY = &quot;posts_per_page&quot;;
    private static final String AMP_SUPPORTED_KEY = &quot;amp_is_supported&quot;;
    private static final String AMP_ENABLED_KEY = &quot;amp_is_enabled&quot;;
    private static final String JETPACK_SEARCH_ENABLED_KEY = &quot;jetpack_search_enabled&quot;;
    private static final String JETPACK_SEARCH_SUPPORTED_KEY = &quot;jetpack_search_supported&quot;;
    private static final String COMMENT_LIKES = &quot;comment-likes&quot;;

    // WP.com REST keys used to GET certain site settings
    private static final String GET_TITLE_KEY = &quot;name&quot;;
    private static final String GET_DESC_KEY = &quot;description&quot;;

    // WP.com REST keys used to POST updates to site settings
    private static final String SET_TITLE_KEY = &quot;blogname&quot;;
    private static final String SET_DESC_KEY = &quot;blogdescription&quot;;

    // WP.com REST keys used in response to a categories GET request
    private static final String CAT_ID_KEY = &quot;ID&quot;;
    private static final String CAT_NAME_KEY = &quot;name&quot;;
    private static final String CAT_SLUG_KEY = &quot;slug&quot;;
    private static final String CAT_DESC_KEY = &quot;description&quot;;
    private static final String CAT_PARENT_ID_KEY = &quot;parent&quot;;
    private static final String CAT_POST_COUNT_KEY = &quot;post_count&quot;;
    private static final String CAT_NUM_POSTS_KEY = &quot;found&quot;;
    private static final String CATEGORIES_KEY = &quot;categories&quot;;
    private static final String DEFAULT_SHARING_BUTTON_STYLE = &quot;icon-only&quot;;

    private static final String SPEED_UP_SETTINGS_JETPACK_VERSION = &quot;5.8&quot;;
    private static final String ACTIVE = &quot;active&quot;;

    // used to track network fetches to prevent multiple errors from generating multiple toasts
<span class="nc" id="L113">    private int mFetchRequestCount = 0;</span>
<span class="nc" id="L114">    private int mSaveRequestCount = 0;</span>
<span class="nc" id="L115">    private boolean mWasFetchError = false;</span>
<span class="nc" id="L116">    private boolean mWasSaveError = false;</span>
<span class="nc" id="L117">    private Exception mFetchError = null;</span>
<span class="nc" id="L118">    private Exception mSaveError = null;</span>

    /**
     * Only instantiated by {@link SiteSettingsInterface}.
     */
    WPComSiteSettings(Context host, SiteModel site, SiteSettingsListener listener) {
<span class="nc" id="L124">        super(host, site, listener);</span>
<span class="nc" id="L125">    }</span>

    @Override
    public void saveSettings() {
<span class="nc" id="L129">        super.saveSettings();</span>

        // save any Jetpack changes
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (mSite.isJetpackConnected()) {</span>
<span class="nc" id="L133">            pushJetpackMonitorSettings();</span>
<span class="nc" id="L134">            pushJetpackProtectAndSsoSettings();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (supportsJetpackSiteAcceleratorSettings(mSite)) {</span>
<span class="nc" id="L136">                pushServeImagesFromOurServersModuleSettings();</span>
<span class="nc" id="L137">                pushServeStaticFilesFromOurServersModuleSettings();</span>
<span class="nc" id="L138">                pushLazyLoadModule();</span>
            }
<span class="nc" id="L140">            pushImprovedSearchModule();</span>
<span class="nc" id="L141">            pushAdFreeVideoHostingModule();</span>
        }

<span class="nc" id="L144">        pushWpSettings();</span>
<span class="nc" id="L145">    }</span>

    /**
     * Request remote site data via the WordPress REST API.
     */
    @Override
    protected void fetchRemoteData() {
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (mFetchRequestCount &gt; 0) {</span>
<span class="nc" id="L153">            AppLog.v(AppLog.T.SETTINGS, &quot;Network fetch prevented, there's already a fetch in progress.&quot;);</span>
<span class="nc" id="L154">            return;</span>
        }

<span class="nc" id="L157">        fetchCategories();</span>
<span class="nc" id="L158">        fetchWpSettings();</span>

<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (mSite.isJetpackConnected()) {</span>
<span class="nc" id="L161">            fetchJetpackSettings();</span>
        }
<span class="nc" id="L163">    }</span>

    static boolean supportsJetpackSiteAcceleratorSettings(SiteModel site) {
<span class="nc" id="L166">        return SiteUtils.checkMinimalJetpackVersion(site, SPEED_UP_SETTINGS_JETPACK_VERSION);</span>
    }

    private void fetchWpSettings() {
<span class="nc" id="L170">        ++mFetchRequestCount;</span>
<span class="nc" id="L171">        WordPress.getRestClientUtilsV1_1().getGeneralSettings(</span>
<span class="nc" id="L172">                mSite.getSiteId(), new RestRequest.Listener() {</span>
                    @Override
                    public void onResponse(JSONObject response) {
<span class="nc" id="L175">                        AppLog.d(AppLog.T.API, &quot;Received response to Settings REST request.&quot;);</span>
<span class="nc" id="L176">                        credentialsVerified(true);</span>

<span class="nc" id="L178">                        mRemoteSettings.localTableId = mSite.getId();</span>
<span class="nc" id="L179">                        deserializeWpComRestResponse(mSite, response);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                        if (!mRemoteSettings.equals(mSettings)) {</span>
                            // postFormats setting is not returned by this api call so copy it over
<span class="nc" id="L182">                            final Map&lt;String, String&gt; currentPostFormats = mSettings.postFormats;</span>

                            // Local settings
<span class="nc" id="L185">                            boolean location = mSettings.location;</span>
<span class="nc" id="L186">                            mSettings.copyFrom(mRemoteSettings);</span>
<span class="nc" id="L187">                            mSettings.postFormats = currentPostFormats;</span>
<span class="nc" id="L188">                            mSettings.location = location;</span>

<span class="nc" id="L190">                            SiteSettingsTable.saveSettings(mSettings);</span>
                        }
<span class="nc" id="L192">                        onFetchResponseReceived(null);</span>
<span class="nc" id="L193">                    }</span>
<span class="nc" id="L194">                }, new RestRequest.ErrorListener() {</span>
                    @Override
                    public void onErrorResponse(VolleyError error) {
<span class="nc" id="L197">                        AppLog.w(AppLog.T.API, &quot;Error response to Settings REST request: &quot; + error);</span>
<span class="nc" id="L198">                        onFetchResponseReceived(error);</span>
<span class="nc" id="L199">                    }</span>
                });
<span class="nc" id="L201">    }</span>

    /**
     * Request a list of post categories for a site via the WordPress REST API.
     */
    private void fetchCategories() {
<span class="nc" id="L207">        ++mFetchRequestCount;</span>
        // TODO: Replace with FluxC (GET_CATEGORIES + TaxonomyStore.getCategoriesForSite())
<span class="nc" id="L209">        WordPress.getRestClientUtilsV1_1().getCategories(mSite.getSiteId(),</span>
<span class="nc" id="L210">                new RestRequest.Listener() {</span>
                    @Override
                    public void onResponse(JSONObject response) {
<span class="nc" id="L213">                        AppLog.v(AppLog.T.API, &quot;Received site Categories&quot;);</span>
<span class="nc" id="L214">                        credentialsVerified(true);</span>

<span class="nc" id="L216">                        CategoryModel[] models = deserializeCategoryRestResponse(response);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                        if (models == null) return;</span>

<span class="nc" id="L219">                        SiteSettingsTable.saveCategories(models);</span>
<span class="nc" id="L220">                        mRemoteSettings.categories = models;</span>
<span class="nc" id="L221">                        mSettings.categories = models;</span>
<span class="nc" id="L222">                        onFetchResponseReceived(null);</span>
<span class="nc" id="L223">                    }</span>
<span class="nc" id="L224">                }, new RestRequest.ErrorListener() {</span>
                    @Override
                    public void onErrorResponse(VolleyError error) {
<span class="nc" id="L227">                        AppLog.d(AppLog.T.API, &quot;Error fetching WP.com categories:&quot; + error);</span>
<span class="nc" id="L228">                        onFetchResponseReceived(error);</span>
<span class="nc" id="L229">                    }</span>
                });
<span class="nc" id="L231">    }</span>

    private void fetchJetpackSettings() {
<span class="nc" id="L234">        fetchJetpackMonitorSettings();</span>
<span class="nc" id="L235">        fetchJetpackProtectAndSsoSettings();</span>
<span class="nc" id="L236">        fetchJetpackModuleSettings();</span>
<span class="nc" id="L237">    }</span>

    private void fetchJetpackProtectAndSsoSettings() {
<span class="nc" id="L240">        ++mFetchRequestCount;</span>
<span class="nc" id="L241">        WordPress.getRestClientUtilsV1_1().getJetpackSettings(mSite.getSiteId(), new RestRequest.Listener() {</span>
            @Override
            public void onResponse(JSONObject response) {
<span class="nc" id="L244">                final JSONObject data = response.optJSONObject(&quot;data&quot;);</span>

<span class="nc bnc" id="L246" title="All 2 branches missed.">                if (data == null) {</span>
<span class="nc" id="L247">                    AppLog.w(AppLog.T.API, &quot;Unexpected state: Received empty Jetpack settings response&quot;);</span>
<span class="nc" id="L248">                    onFetchResponseReceived(null);</span>
<span class="nc" id="L249">                    return;</span>
                }

<span class="nc" id="L252">                AppLog.v(AppLog.T.API, &quot;Received Jetpack settings response&quot;);</span>

<span class="nc" id="L254">                mRemoteJpSettings.monitorActive = data.optBoolean(&quot;monitor&quot;, false);</span>
<span class="nc" id="L255">                mRemoteJpSettings.jetpackProtectEnabled = data.optBoolean(&quot;protect&quot;, false);</span>
<span class="nc" id="L256">                mRemoteJpSettings.ssoActive = data.optBoolean(&quot;sso&quot;, false);</span>
<span class="nc" id="L257">                mRemoteJpSettings.ssoMatchEmail = data.optBoolean(&quot;jetpack_sso_match_by_email&quot;, false);</span>
<span class="nc" id="L258">                mRemoteJpSettings.ssoRequireTwoFactor = data.optBoolean(&quot;jetpack_sso_require_two_step&quot;, false);</span>
<span class="nc" id="L259">                mRemoteJpSettings.commentLikes = data.optBoolean(COMMENT_LIKES, false);</span>

<span class="nc" id="L261">                JSONObject jetpackProtectAllowlist = data.optJSONObject(&quot;jetpack_protect_global_whitelist&quot;);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                if (jetpackProtectAllowlist != null) {</span>
                    // clear existing allowlist entries before adding items from response
<span class="nc" id="L264">                    mRemoteJpSettings.jetpackProtectAllowlist.clear();</span>

<span class="nc" id="L266">                    JSONArray allowlistItems = jetpackProtectAllowlist.optJSONArray(&quot;local&quot;);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                    if (allowlistItems != null) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                        for (int i = 0; i &lt; allowlistItems.length(); ++i) {</span>
<span class="nc" id="L269">                            String item = allowlistItems.optString(i, &quot;&quot;);</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">                            if (!item.isEmpty() &amp;&amp; !mRemoteJpSettings.jetpackProtectAllowlist.contains(item)) {</span>
<span class="nc" id="L271">                                mRemoteJpSettings.jetpackProtectAllowlist.add(item);</span>
                            }
                        }
                    }
                }

<span class="nc" id="L277">                mJpSettings.monitorActive = mRemoteJpSettings.monitorActive;</span>
<span class="nc" id="L278">                mJpSettings.jetpackProtectEnabled = mRemoteJpSettings.jetpackProtectEnabled;</span>
<span class="nc" id="L279">                mJpSettings.jetpackProtectAllowlist.clear();</span>
<span class="nc" id="L280">                mJpSettings.jetpackProtectAllowlist.addAll(mRemoteJpSettings.jetpackProtectAllowlist);</span>
<span class="nc" id="L281">                mJpSettings.ssoActive = mRemoteJpSettings.ssoActive;</span>
<span class="nc" id="L282">                mJpSettings.ssoMatchEmail = mRemoteJpSettings.ssoMatchEmail;</span>
<span class="nc" id="L283">                mJpSettings.ssoRequireTwoFactor = mRemoteJpSettings.ssoRequireTwoFactor;</span>
<span class="nc" id="L284">                mJpSettings.commentLikes = mRemoteJpSettings.commentLikes;</span>
<span class="nc" id="L285">                onFetchResponseReceived(null);</span>
<span class="nc" id="L286">            }</span>
<span class="nc" id="L287">        }, new RestRequest.ErrorListener() {</span>
            @Override
            public void onErrorResponse(VolleyError error) {
<span class="nc" id="L290">                AppLog.w(AppLog.T.API, &quot;Error fetching Jetpack settings: &quot; + error);</span>
<span class="nc" id="L291">                onFetchResponseReceived(error);</span>
<span class="nc" id="L292">            }</span>
        });
<span class="nc" id="L294">    }</span>

    private void fetchJetpackMonitorSettings() {
<span class="nc" id="L297">        ++mFetchRequestCount;</span>
<span class="nc" id="L298">        WordPress.getRestClientUtilsV1_1().getJetpackMonitorSettings(</span>
<span class="nc" id="L299">                mSite.getSiteId(), new RestRequest.Listener() {</span>
                    @Override
                    public void onResponse(JSONObject response) {
<span class="nc" id="L302">                        AppLog.v(AppLog.T.API, &quot;Received Jetpack Monitor module options&quot;);</span>
<span class="nc" id="L303">                        mRemoteJpSettings.localTableId = mSite.getId();</span>
<span class="nc" id="L304">                        deserializeJetpackRestResponse(mSite, response);</span>
<span class="nc" id="L305">                        mJpSettings.localTableId = mRemoteJpSettings.localTableId;</span>
<span class="nc" id="L306">                        mJpSettings.emailNotifications = mRemoteJpSettings.emailNotifications;</span>
<span class="nc" id="L307">                        mJpSettings.wpNotifications = mRemoteJpSettings.wpNotifications;</span>
<span class="nc" id="L308">                        onFetchResponseReceived(null);</span>
<span class="nc" id="L309">                    }</span>
<span class="nc" id="L310">                }, new RestRequest.ErrorListener() {</span>
                    @Override
                    public void onErrorResponse(VolleyError error) {
<span class="nc" id="L313">                        AppLog.w(AppLog.T.API, &quot;Error fetching Jetpack Monitor module options: &quot; + error);</span>
<span class="nc" id="L314">                        onFetchResponseReceived(error);</span>
<span class="nc" id="L315">                    }</span>
                });
<span class="nc" id="L317">    }</span>

    private void fetchJetpackModuleSettings() {
<span class="nc" id="L320">        ++mFetchRequestCount;</span>
<span class="nc" id="L321">        WordPress.getRestClientUtilsV1_1().getJetpackModuleSettings(</span>
<span class="nc" id="L322">                mSite.getSiteId(), new RestRequest.Listener() {</span>
                    @Override
                    public void onResponse(JSONObject response) {
<span class="nc bnc" id="L325" title="All 2 branches missed.">                        if (response == null) {</span>
<span class="nc" id="L326">                            AppLog.w(AppLog.T.API, &quot;Unexpected state: Received empty Jetpack modules response&quot;);</span>
<span class="nc" id="L327">                            onFetchResponseReceived(null);</span>
<span class="nc" id="L328">                            return;</span>
                        }
<span class="nc" id="L330">                        AppLog.v(AppLog.T.API, &quot;Received Jetpack module settings&quot;);</span>
<span class="nc" id="L331">                        JSONArray array = response.optJSONArray(&quot;modules&quot;);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                        if (array != null) {</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                            for (int i = 0; i &lt; array.length(); i++) {</span>
<span class="nc" id="L334">                                JSONObject module = array.optJSONObject(i);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">                                if (module == null) {</span>
<span class="nc" id="L336">                                    continue;</span>
                                }
<span class="nc" id="L338">                                String id = module.optString(&quot;id&quot;);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                                if (id == null) {</span>
<span class="nc" id="L340">                                    continue;</span>
                                }
<span class="nc" id="L342">                                boolean isActive = module.optBoolean(ACTIVE, false);</span>
<span class="nc bnc" id="L343" title="All 7 branches missed.">                                switch (id) {</span>
                                    case SERVE_IMAGES_FROM_OUR_SERVERS:
<span class="nc" id="L345">                                        mRemoteJpSettings.serveImagesFromOurServers = isActive;</span>
<span class="nc" id="L346">                                        break;</span>
                                    case SERVE_STATIC_FILES_FROM_OUR_SERVERS:
<span class="nc" id="L348">                                        mRemoteJpSettings.serveStaticFilesFromOurServers = isActive;</span>
<span class="nc" id="L349">                                        break;</span>
                                    case LAZY_LOAD_IMAGES:
<span class="nc" id="L351">                                        mRemoteJpSettings.lazyLoadImages = isActive;</span>
<span class="nc" id="L352">                                        break;</span>
                                    case SHARING_MODULE:
<span class="nc" id="L354">                                        mRemoteJpSettings.sharingEnabled = isActive;</span>
<span class="nc" id="L355">                                        break;</span>
                                    case SEARCH_MODULE:
<span class="nc" id="L357">                                        mRemoteJpSettings.improvedSearch = isActive;</span>
<span class="nc" id="L358">                                        break;</span>
                                    case AD_FREE_VIDEO_HOSTING_MODULE:
<span class="nc" id="L360">                                        mRemoteJpSettings.adFreeVideoHosting = isActive;</span>
                                        break;
                                }
                            }
<span class="nc" id="L364">                            mJpSettings.serveImagesFromOurServers = mRemoteJpSettings.serveImagesFromOurServers;</span>
<span class="nc" id="L365">                            mJpSettings.serveStaticFilesFromOurServers =</span>
                                    mRemoteJpSettings.serveStaticFilesFromOurServers;
<span class="nc" id="L367">                            mJpSettings.lazyLoadImages = mRemoteJpSettings.lazyLoadImages;</span>
<span class="nc" id="L368">                            mJpSettings.sharingEnabled = mRemoteJpSettings.sharingEnabled;</span>
<span class="nc" id="L369">                            mJpSettings.improvedSearch = mRemoteJpSettings.improvedSearch;</span>
<span class="nc" id="L370">                            mJpSettings.adFreeVideoHosting = mRemoteJpSettings.adFreeVideoHosting;</span>
                        }
<span class="nc" id="L372">                        onFetchResponseReceived(null);</span>
<span class="nc" id="L373">                    }</span>
<span class="nc" id="L374">                }, new RestRequest.ErrorListener() {</span>
                    @Override
                    public void onErrorResponse(VolleyError error) {
<span class="nc" id="L377">                        AppLog.w(AppLog.T.API, &quot;Error fetching Jetpack module settings: &quot; + error);</span>
<span class="nc" id="L378">                        onFetchResponseReceived(error);</span>
<span class="nc" id="L379">                    }</span>
                });
<span class="nc" id="L381">    }</span>

    private void pushWpSettings() {
        JSONObject jsonParams;
        try {
<span class="nc" id="L386">            jsonParams = serializeWpComParamsToJSONObject();</span>
            // skip network requests if there are no changes
<span class="nc bnc" id="L388" title="All 2 branches missed.">            if (jsonParams.length() &lt;= 0) {</span>
<span class="nc" id="L389">                return;</span>
            }
<span class="nc" id="L391">        } catch (JSONException exception) {</span>
<span class="nc" id="L392">            AppLog.w(AppLog.T.API, &quot;Error serializing settings changes: &quot; + exception);</span>
<span class="nc" id="L393">            notifySaveErrorOnUiThread(exception);</span>
<span class="nc" id="L394">            return;</span>
<span class="nc" id="L395">        }</span>

<span class="nc" id="L397">        ++mSaveRequestCount;</span>
<span class="nc" id="L398">        WordPress.getRestClientUtilsV1_1().setGeneralSiteSettings(</span>
<span class="nc" id="L399">                mSite.getSiteId(), jsonParams, new RestRequest.Listener() {</span>
                    @Override
                    public void onResponse(JSONObject response) {
<span class="nc" id="L402">                        AppLog.d(AppLog.T.API, &quot;Site Settings saved remotely&quot;);</span>
<span class="nc" id="L403">                        mRemoteSettings.copyFrom(mSettings);</span>

<span class="nc bnc" id="L405" title="All 2 branches missed.">                        if (response != null) {</span>
<span class="nc" id="L406">                            JSONObject updated = response.optJSONObject(&quot;updated&quot;);</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">                            if (updated == null) return;</span>
<span class="nc" id="L408">                            HashMap&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L409">                            Iterator&lt;String&gt; keys = updated.keys();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                            while (keys.hasNext()) {</span>
<span class="nc" id="L411">                                String currentKey = keys.next();</span>
<span class="nc" id="L412">                                Object currentValue = updated.opt(currentKey);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">                                if (currentValue != null) {</span>
<span class="nc" id="L414">                                    properties.put(SAVED_ITEM_PREFIX + currentKey, currentValue);</span>
                                }
<span class="nc" id="L416">                            }</span>
<span class="nc" id="L417">                            AnalyticsUtils.trackWithSiteDetails(</span>
                                    AnalyticsTracker.Stat.SITE_SETTINGS_SAVED_REMOTELY, mSite, properties);
                        }
<span class="nc" id="L420">                        onSaveResponseReceived(null);</span>
<span class="nc" id="L421">                    }</span>
<span class="nc" id="L422">                }, new RestRequest.ErrorListener() {</span>
                    @Override
                    public void onErrorResponse(VolleyError error) {
<span class="nc" id="L425">                        AppLog.w(AppLog.T.API, &quot;Error POSTing site settings changes: &quot; + error);</span>
<span class="nc" id="L426">                        onSaveResponseReceived(error);</span>
<span class="nc" id="L427">                    }</span>
                });
<span class="nc" id="L429">    }</span>

    private void pushJetpackProtectAndSsoSettings() {
<span class="nc" id="L432">        final Map&lt;String, Object&gt; params = serializeJetpackProtectAndSsoParams();</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (params.isEmpty()) {</span>
<span class="nc" id="L434">            AppLog.v(AppLog.T.API, &quot;No Jetpack settings changes detected. Skipping network POST call.&quot;);</span>
<span class="nc" id="L435">            return;</span>
        }

        // The response object doesn't contain any relevant info so we have to create a copy of values
        // being sent over the network in case mJpSettings is modified while awaiting response
<span class="nc" id="L440">        final JetpackSettingsModel sentJpData = new JetpackSettingsModel(mJpSettings);</span>
<span class="nc" id="L441">        ++mSaveRequestCount;</span>
<span class="nc" id="L442">        WordPress.getRestClientUtilsV1_1().setJetpackSettings(mSite.getSiteId(), params,</span>
<span class="nc" id="L443">                new RestRequest.Listener() {</span>
                    @Override
                    public void onResponse(JSONObject response) {
<span class="nc" id="L446">                        AppLog.d(AppLog.T.API, &quot;Jetpack settings updated&quot;);</span>
<span class="nc" id="L447">                        mRemoteJpSettings.monitorActive = sentJpData.monitorActive;</span>
<span class="nc" id="L448">                        mRemoteJpSettings.jetpackProtectEnabled = sentJpData.jetpackProtectEnabled;</span>
<span class="nc" id="L449">                        mRemoteJpSettings.jetpackProtectAllowlist.clear();</span>
<span class="nc" id="L450">                        mRemoteJpSettings.jetpackProtectAllowlist.addAll(sentJpData.jetpackProtectAllowlist);</span>
<span class="nc" id="L451">                        mRemoteJpSettings.ssoActive = sentJpData.ssoActive;</span>
<span class="nc" id="L452">                        mRemoteJpSettings.ssoMatchEmail = sentJpData.ssoMatchEmail;</span>
<span class="nc" id="L453">                        mRemoteJpSettings.ssoRequireTwoFactor = sentJpData.ssoRequireTwoFactor;</span>
<span class="nc" id="L454">                        mRemoteJpSettings.commentLikes = sentJpData.commentLikes;</span>
<span class="nc" id="L455">                        onSaveResponseReceived(null);</span>
<span class="nc" id="L456">                    }</span>
<span class="nc" id="L457">                }, new RestRequest.ErrorListener() {</span>
                    @Override
                    public void onErrorResponse(VolleyError error) {
<span class="nc" id="L460">                        AppLog.w(AppLog.T.API, &quot;Error updating Jetpack settings: &quot; + error);</span>
<span class="nc" id="L461">                        onSaveResponseReceived(error);</span>
<span class="nc" id="L462">                    }</span>
                });
<span class="nc" id="L464">    }</span>

    private void pushJetpackMonitorSettings() {
        // The response object doesn't contain any relevant info so we have to create a copy of values
        // being sent over the network in case mJpSettings is modified while awaiting response
<span class="nc" id="L469">        final JetpackSettingsModel sentJpData = new JetpackSettingsModel(mJpSettings);</span>
<span class="nc" id="L470">        ++mSaveRequestCount;</span>
<span class="nc" id="L471">        WordPress.getRestClientUtilsV1_1().setJetpackMonitorSettings(</span>
<span class="nc" id="L472">                mSite.getSiteId(), serializeJetpackMonitorParams(), new RestRequest.Listener() {</span>
                    @Override
                    public void onResponse(JSONObject response) {
<span class="nc" id="L475">                        AppLog.d(AppLog.T.API, &quot;Jetpack Monitor module updated&quot;);</span>
<span class="nc" id="L476">                        mRemoteJpSettings.emailNotifications = sentJpData.emailNotifications;</span>
<span class="nc" id="L477">                        mRemoteJpSettings.wpNotifications = sentJpData.wpNotifications;</span>
<span class="nc" id="L478">                        onSaveResponseReceived(null);</span>
<span class="nc" id="L479">                    }</span>
<span class="nc" id="L480">                }, new RestRequest.ErrorListener() {</span>
                    @Override
                    public void onErrorResponse(VolleyError error) {
<span class="nc" id="L483">                        AppLog.w(AppLog.T.API, &quot;Error updating Jetpack Monitor module: &quot; + error.getMessage());</span>
<span class="nc" id="L484">                        onSaveResponseReceived(error);</span>
<span class="nc" id="L485">                    }</span>
                });
<span class="nc" id="L487">    }</span>

    private void pushServeImagesFromOurServersModuleSettings() {
<span class="nc" id="L490">        ++mSaveRequestCount;</span>
        // The API returns 400 if we try to sync the same value twice so we need to keep it locally.
<span class="nc bnc" id="L492" title="All 2 branches missed.">        if (mJpSettings.serveImagesFromOurServers != mRemoteJpSettings.serveImagesFromOurServers) {</span>
<span class="nc" id="L493">            final boolean fallbackValue = mRemoteJpSettings.serveImagesFromOurServers;</span>
<span class="nc" id="L494">            mRemoteJpSettings.serveImagesFromOurServers = mJpSettings.serveImagesFromOurServers;</span>
<span class="nc" id="L495">            WordPress.getRestClientUtilsV1_1().setJetpackModuleSettings(</span>
<span class="nc" id="L496">                    mSite.getSiteId(), SERVE_IMAGES_FROM_OUR_SERVERS, mJpSettings.serveImagesFromOurServers,</span>
<span class="nc" id="L497">                    new RestRequest.Listener() {</span>
                        @Override
                        public void onResponse(JSONObject response) {
<span class="nc" id="L500">                            AppLog.d(AppLog.T.API, &quot;Jetpack module updated - Serve images from our servers&quot;);</span>
<span class="nc" id="L501">                            onSaveResponseReceived(null);</span>
<span class="nc" id="L502">                        }</span>
<span class="nc" id="L503">                    }, new RestRequest.ErrorListener() {</span>
                        @Override
                        public void onErrorResponse(VolleyError error) {
<span class="nc" id="L506">                            mRemoteJpSettings.serveImagesFromOurServers = fallbackValue;</span>
<span class="nc" id="L507">                            error.printStackTrace();</span>
<span class="nc" id="L508">                            AppLog.w(AppLog.T.API,</span>
                                     &quot;Error updating Jetpack module - Serve images from our servers: &quot; + error);
<span class="nc" id="L510">                            onSaveResponseReceived(error);</span>
<span class="nc" id="L511">                        }</span>
                    });
        }
<span class="nc" id="L514">    }</span>

    private void pushServeStaticFilesFromOurServersModuleSettings() {
<span class="nc" id="L517">        ++mSaveRequestCount;</span>
        // The API returns 400 if we try to sync the same value twice so we need to keep it locally.
<span class="nc bnc" id="L519" title="All 2 branches missed.">        if (mJpSettings.serveStaticFilesFromOurServers != mRemoteJpSettings.serveStaticFilesFromOurServers) {</span>
<span class="nc" id="L520">            final boolean fallbackValue = mRemoteJpSettings.serveStaticFilesFromOurServers;</span>
<span class="nc" id="L521">            mRemoteJpSettings.serveStaticFilesFromOurServers = mJpSettings.serveStaticFilesFromOurServers;</span>
<span class="nc" id="L522">            WordPress.getRestClientUtilsV1_1().setJetpackModuleSettings(</span>
<span class="nc" id="L523">                    mSite.getSiteId(), SERVE_STATIC_FILES_FROM_OUR_SERVERS, mJpSettings.serveStaticFilesFromOurServers,</span>
<span class="nc" id="L524">                    new RestRequest.Listener() {</span>
                        @Override
                        public void onResponse(JSONObject response) {
<span class="nc" id="L527">                            AppLog.d(AppLog.T.API, &quot;Jetpack module updated - Serve static files from our servers&quot;);</span>
<span class="nc" id="L528">                            onSaveResponseReceived(null);</span>
<span class="nc" id="L529">                        }</span>
<span class="nc" id="L530">                    }, new RestRequest.ErrorListener() {</span>
                        @Override
                        public void onErrorResponse(VolleyError error) {
<span class="nc" id="L533">                            mRemoteJpSettings.serveStaticFilesFromOurServers = fallbackValue;</span>
<span class="nc" id="L534">                            error.printStackTrace();</span>
<span class="nc" id="L535">                            AppLog.w(AppLog.T.API,</span>
                                    &quot;Error updating Jetpack module - Serve static files from our servers: &quot; + error);
<span class="nc" id="L537">                            onSaveResponseReceived(error);</span>
<span class="nc" id="L538">                        }</span>
                    });
        }
<span class="nc" id="L541">    }</span>

    private void pushLazyLoadModule() {
<span class="nc" id="L544">        ++mSaveRequestCount;</span>
        // The API returns 400 if we try to sync the same value twice so we need to keep it locally.
<span class="nc bnc" id="L546" title="All 2 branches missed.">        if (mJpSettings.lazyLoadImages != mRemoteJpSettings.lazyLoadImages) {</span>
<span class="nc" id="L547">            final boolean fallbackValue = mRemoteJpSettings.lazyLoadImages;</span>
<span class="nc" id="L548">            mRemoteJpSettings.lazyLoadImages = mJpSettings.lazyLoadImages;</span>
<span class="nc" id="L549">            WordPress.getRestClientUtilsV1_1().setJetpackModuleSettings(</span>
<span class="nc" id="L550">                    mSite.getSiteId(), LAZY_LOAD_IMAGES, mJpSettings.lazyLoadImages, new RestRequest.Listener() {</span>
                        @Override
                        public void onResponse(JSONObject response) {
<span class="nc" id="L553">                            AppLog.d(AppLog.T.API, &quot;Jetpack module updated - Lazy load images&quot;);</span>
<span class="nc" id="L554">                            onSaveResponseReceived(null);</span>
<span class="nc" id="L555">                        }</span>
<span class="nc" id="L556">                    }, new RestRequest.ErrorListener() {</span>
                        @Override
                        public void onErrorResponse(VolleyError error) {
<span class="nc" id="L559">                            mRemoteJpSettings.lazyLoadImages = fallbackValue;</span>
<span class="nc" id="L560">                            error.printStackTrace();</span>
<span class="nc" id="L561">                            AppLog.w(AppLog.T.API, &quot;Error updating Jetpack module - Lazy load images: &quot; + error);</span>
<span class="nc" id="L562">                            onSaveResponseReceived(error);</span>
<span class="nc" id="L563">                        }</span>
                    });
        }
<span class="nc" id="L566">    }</span>

    private void pushImprovedSearchModule() {
<span class="nc" id="L569">        ++mSaveRequestCount;</span>
        // The API returns 400 if we try to sync the same value twice so we need to keep it locally.
<span class="nc bnc" id="L571" title="All 2 branches missed.">        if (mJpSettings.improvedSearch != mRemoteJpSettings.improvedSearch) {</span>
<span class="nc" id="L572">            final boolean fallbackValue = mRemoteJpSettings.improvedSearch;</span>
<span class="nc" id="L573">            mRemoteJpSettings.improvedSearch = mJpSettings.improvedSearch;</span>
<span class="nc" id="L574">            WordPress.getRestClientUtilsV1_1().setJetpackModuleSettings(</span>
<span class="nc" id="L575">                    mSite.getSiteId(), SEARCH_MODULE, mJpSettings.improvedSearch, new RestRequest.Listener() {</span>
                        @Override
                        public void onResponse(JSONObject response) {
<span class="nc" id="L578">                            AppLog.d(AppLog.T.API, &quot;Jetpack module updated - Improved search&quot;);</span>
<span class="nc" id="L579">                            onSaveResponseReceived(null);</span>
<span class="nc" id="L580">                        }</span>
<span class="nc" id="L581">                    }, new RestRequest.ErrorListener() {</span>
                        @Override
                        public void onErrorResponse(VolleyError error) {
<span class="nc" id="L584">                            mRemoteJpSettings.improvedSearch = fallbackValue;</span>
<span class="nc" id="L585">                            error.printStackTrace();</span>
<span class="nc" id="L586">                            AppLog.w(AppLog.T.API, &quot;Error updating Jetpack module - Improved search: &quot; + error);</span>
<span class="nc" id="L587">                            onSaveResponseReceived(error);</span>
<span class="nc" id="L588">                        }</span>
                    });
        }
<span class="nc" id="L591">    }</span>

    private void pushAdFreeVideoHostingModule() {
<span class="nc" id="L594">        ++mSaveRequestCount;</span>
        // The API returns 400 if we try to sync the same value twice so we need to keep it locally.
<span class="nc bnc" id="L596" title="All 2 branches missed.">        if (mJpSettings.adFreeVideoHosting != mRemoteJpSettings.adFreeVideoHosting) {</span>
<span class="nc" id="L597">            final boolean fallbackValue = mRemoteJpSettings.adFreeVideoHosting;</span>
<span class="nc" id="L598">            mRemoteJpSettings.adFreeVideoHosting = mJpSettings.adFreeVideoHosting;</span>
<span class="nc" id="L599">            WordPress.getRestClientUtilsV1_1().setJetpackModuleSettings(</span>
<span class="nc" id="L600">                    mSite.getSiteId(), AD_FREE_VIDEO_HOSTING_MODULE, mJpSettings.adFreeVideoHosting,</span>
<span class="nc" id="L601">                    new RestRequest.Listener() {</span>
                        @Override
                        public void onResponse(JSONObject response) {
<span class="nc" id="L604">                            AppLog.d(AppLog.T.API, &quot;Jetpack module updated - Videopress&quot;);</span>
<span class="nc" id="L605">                            onSaveResponseReceived(null);</span>
<span class="nc" id="L606">                        }</span>
<span class="nc" id="L607">                    }, new RestRequest.ErrorListener() {</span>
                        @Override
                        public void onErrorResponse(VolleyError error) {
<span class="nc" id="L610">                            mRemoteJpSettings.adFreeVideoHosting = fallbackValue;</span>
<span class="nc" id="L611">                            error.printStackTrace();</span>
<span class="nc" id="L612">                            AppLog.w(AppLog.T.API, &quot;Error updating Jetpack module - Videopress: &quot; + error);</span>
<span class="nc" id="L613">                            onSaveResponseReceived(error);</span>
<span class="nc" id="L614">                        }</span>
                    });
        }
<span class="nc" id="L617">    }</span>

    private void onFetchResponseReceived(Exception error) {
<span class="nc bnc" id="L620" title="All 2 branches missed.">        if (error != null) {</span>
<span class="nc" id="L621">            mWasFetchError = true;</span>
<span class="nc" id="L622">            mFetchError = error;</span>
        } else {
            // we received successful response to GET request, notify listener to update UI
<span class="nc" id="L625">            notifyUpdatedOnUiThread();</span>
        }
<span class="nc bnc" id="L627" title="All 4 branches missed.">        if (--mFetchRequestCount &lt;= 0 &amp;&amp; mWasFetchError) {</span>
            // all of our GET requests are completed and at least one had an error so we need to notify
<span class="nc" id="L629">            notifyFetchErrorOnUiThread(mFetchError);</span>
<span class="nc" id="L630">            mWasFetchError = false;</span>
<span class="nc" id="L631">            mFetchError = null;</span>
        }
<span class="nc" id="L633">    }</span>

    private void onSaveResponseReceived(Exception error) {
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (error != null) {</span>
<span class="nc" id="L637">            mWasSaveError = true;</span>
<span class="nc" id="L638">            mSaveError = error;</span>
        } else {
            // we received successful response to POST request, notify listener to update UI
<span class="nc" id="L641">            notifySavedOnUiThread();</span>
        }
<span class="nc bnc" id="L643" title="All 4 branches missed.">        if (--mSaveRequestCount &lt;= 0 &amp;&amp; mWasSaveError) {</span>
            // all of our POST requests are completed and at least one had an error so we need to notify
<span class="nc" id="L645">            notifySaveErrorOnUiThread(mSaveError);</span>
<span class="nc" id="L646">            mWasSaveError = false;</span>
<span class="nc" id="L647">            mSaveError = null;</span>
        }
<span class="nc" id="L649">    }</span>

    /**
     * Sets values from a .com REST response object.
     */
    private void deserializeWpComRestResponse(SiteModel site, JSONObject response) {
<span class="nc bnc" id="L655" title="All 4 branches missed.">        if (site == null || response == null) return;</span>
<span class="nc" id="L656">        JSONObject settingsObject = response.optJSONObject(&quot;settings&quot;);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">        if (settingsObject == null) {</span>
<span class="nc" id="L658">            AppLog.e(AppLog.T.API, &quot;Error: Settings response doesn't contain settings object&quot;);</span>
<span class="nc" id="L659">            return;</span>
        }

<span class="nc" id="L662">        mRemoteSettings.username = site.getUsername();</span>
<span class="nc" id="L663">        mRemoteSettings.password = site.getPassword();</span>
<span class="nc" id="L664">        mRemoteSettings.address = response.optString(URL_KEY, &quot;&quot;);</span>
<span class="nc" id="L665">        mRemoteSettings.title = response.optString(GET_TITLE_KEY, &quot;&quot;);</span>
<span class="nc" id="L666">        mRemoteSettings.tagline = response.optString(GET_DESC_KEY, &quot;&quot;);</span>
<span class="nc" id="L667">        mRemoteSettings.languageId = settingsObject.optInt(LANGUAGE_ID_KEY, -1);</span>
<span class="nc" id="L668">        mRemoteSettings.siteIconMediaId = settingsObject.optInt(SITE_ICON_KEY, 0);</span>
<span class="nc" id="L669">        mRemoteSettings.privacy = settingsObject.optInt(PRIVACY_KEY, -2);</span>
<span class="nc" id="L670">        mRemoteSettings.defaultCategory = settingsObject.optInt(DEF_CATEGORY_KEY, 1);</span>
<span class="nc" id="L671">        mRemoteSettings.defaultPostFormat = settingsObject.optString(DEF_POST_FORMAT_KEY, STANDARD_POST_FORMAT_KEY);</span>
<span class="nc" id="L672">        mRemoteSettings.language = languageIdToLanguageCode(Integer.toString(mRemoteSettings.languageId));</span>
<span class="nc" id="L673">        mRemoteSettings.allowComments = settingsObject.optBoolean(ALLOW_COMMENTS_KEY, true);</span>
<span class="nc" id="L674">        mRemoteSettings.sendPingbacks = settingsObject.optBoolean(SEND_PINGBACKS_KEY, false);</span>
<span class="nc" id="L675">        mRemoteSettings.receivePingbacks = settingsObject.optBoolean(RECEIVE_PINGBACKS_KEY, true);</span>
<span class="nc" id="L676">        mRemoteSettings.shouldCloseAfter = settingsObject.optBoolean(CLOSE_OLD_COMMENTS_KEY, false);</span>
<span class="nc" id="L677">        mRemoteSettings.closeCommentAfter = settingsObject.optInt(CLOSE_OLD_COMMENTS_DAYS_KEY, 0);</span>
<span class="nc" id="L678">        mRemoteSettings.shouldThreadComments = settingsObject.optBoolean(THREAD_COMMENTS_KEY, false);</span>
<span class="nc" id="L679">        mRemoteSettings.threadingLevels = settingsObject.optInt(THREAD_COMMENTS_DEPTH_KEY, 0);</span>
<span class="nc" id="L680">        mRemoteSettings.shouldPageComments = settingsObject.optBoolean(PAGE_COMMENTS_KEY, false);</span>
<span class="nc" id="L681">        mRemoteSettings.commentsPerPage = settingsObject.optInt(PAGE_COMMENT_COUNT_KEY, 0);</span>
<span class="nc" id="L682">        mRemoteSettings.commentApprovalRequired = settingsObject.optBoolean(COMMENT_MODERATION_KEY, false);</span>
<span class="nc" id="L683">        mRemoteSettings.commentsRequireIdentity = settingsObject.optBoolean(REQUIRE_IDENTITY_KEY, false);</span>
<span class="nc" id="L684">        mRemoteSettings.commentsRequireUserAccount = settingsObject.optBoolean(REQUIRE_USER_ACCOUNT_KEY, true);</span>
<span class="nc" id="L685">        mRemoteSettings.commentAutoApprovalKnownUsers = settingsObject.optBoolean(ALLOWLIST_KNOWN_USERS_KEY, false);</span>
<span class="nc" id="L686">        mRemoteSettings.maxLinks = settingsObject.optInt(MAX_LINKS_KEY, 0);</span>
<span class="nc" id="L687">        mRemoteSettings.holdForModeration = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L688">        mRemoteSettings.denylist = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L689">        mRemoteSettings.sharingLabel = settingsObject.optString(SHARING_LABEL_KEY, &quot;&quot;);</span>
<span class="nc" id="L690">        mRemoteSettings.sharingButtonStyle = settingsObject.optString(SHARING_BUTTON_STYLE_KEY,</span>
                                                                      DEFAULT_SHARING_BUTTON_STYLE);
<span class="nc" id="L692">        mRemoteSettings.allowCommentLikes = settingsObject.optBoolean(SHARING_COMMENT_LIKES_KEY, false);</span>
<span class="nc" id="L693">        mRemoteSettings.twitterUsername = settingsObject.optString(TWITTER_USERNAME_KEY, &quot;&quot;);</span>
<span class="nc" id="L694">        mRemoteSettings.startOfWeek = settingsObject.optString(START_OF_WEEK_KEY, &quot;&quot;);</span>
<span class="nc" id="L695">        mRemoteSettings.dateFormat = settingsObject.optString(DATE_FORMAT_KEY, &quot;&quot;);</span>
<span class="nc" id="L696">        mRemoteSettings.timeFormat = settingsObject.optString(TIME_FORMAT_KEY, &quot;&quot;);</span>

        // Android returns manual offsets as gmt_offset and not as UTC
<span class="nc" id="L699">        String remoteTimezone = settingsObject.optString(TIMEZONE_KEY, &quot;&quot;);</span>
<span class="nc" id="L700">        String remoteGmtOffset = settingsObject.optString(GMT_OFFSET_KEY, &quot;&quot;);</span>
        // UTC-7 comes back as gmt_offset: -7, UTC+7 as just gmt_offset: 7 without the +, hence adding prefix
<span class="nc bnc" id="L702" title="All 2 branches missed.">        String remoteGmtTimezone = remoteGmtOffset.startsWith(&quot;-&quot;) ? &quot;UTC&quot; + remoteGmtOffset : &quot;UTC+&quot; + remoteGmtOffset;</span>
        
<span class="nc bnc" id="L704" title="All 2 branches missed.">        mRemoteSettings.timezone = !TextUtils.isEmpty(remoteTimezone) ? remoteTimezone : remoteGmtTimezone;</span>

<span class="nc" id="L706">        mRemoteSettings.postsPerPage = settingsObject.optInt(POSTS_PER_PAGE_KEY, 0);</span>
<span class="nc" id="L707">        mRemoteSettings.ampSupported = settingsObject.optBoolean(AMP_SUPPORTED_KEY, false);</span>
<span class="nc" id="L708">        mRemoteSettings.ampEnabled = settingsObject.optBoolean(AMP_ENABLED_KEY, false);</span>
<span class="nc" id="L709">        mRemoteSettings.jetpackSearchSupported = settingsObject.optBoolean(JETPACK_SEARCH_SUPPORTED_KEY, false);</span>
<span class="nc" id="L710">        mRemoteSettings.jetpackSearchEnabled = settingsObject.optBoolean(JETPACK_SEARCH_ENABLED_KEY, false);</span>

<span class="nc" id="L712">        boolean reblogsDisabled = settingsObject.optBoolean(SHARING_REBLOGS_DISABLED_KEY, false);</span>
<span class="nc" id="L713">        boolean likesDisabled = settingsObject.optBoolean(SHARING_LIKES_DISABLED_KEY, false);</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">        mRemoteSettings.allowReblogButton = !reblogsDisabled;</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">        mRemoteSettings.allowLikeButton = !likesDisabled;</span>

<span class="nc" id="L717">        String modKeys = settingsObject.optString(MODERATION_KEYS_KEY, &quot;&quot;);</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">        if (modKeys.length() &gt; 0) {</span>
<span class="nc" id="L719">            Collections.addAll(mRemoteSettings.holdForModeration, modKeys.split(&quot;\n&quot;));</span>
        }
<span class="nc" id="L721">        String denylistKeys = settingsObject.optString(DENYLIST_KEYS_KEY, &quot;&quot;);</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">        if (denylistKeys.length() &gt; 0) {</span>
<span class="nc" id="L723">            Collections.addAll(mRemoteSettings.denylist, denylistKeys.split(&quot;\n&quot;));</span>
        }

<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (settingsObject.optString(COMMENT_SORT_ORDER_KEY, &quot;&quot;).equals(&quot;asc&quot;)) {</span>
<span class="nc" id="L727">            mRemoteSettings.sortCommentsBy = ASCENDING_SORT;</span>
        } else {
<span class="nc" id="L729">            mRemoteSettings.sortCommentsBy = DESCENDING_SORT;</span>
        }

<span class="nc" id="L732">        JSONObject jetpackProtectAllowlist = settingsObject.optJSONObject(JP_PROTECT_ALLOWLIST_KEY);</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">        if (jetpackProtectAllowlist != null) {</span>
<span class="nc" id="L734">            JSONArray allowlistItems = jetpackProtectAllowlist.optJSONArray(&quot;local&quot;);</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">            if (allowlistItems != null) {</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">                for (int i = 0; i &lt; allowlistItems.length(); ++i) {</span>
<span class="nc" id="L737">                    String item = allowlistItems.optString(i, &quot;&quot;);</span>
<span class="nc bnc" id="L738" title="All 4 branches missed.">                    if (!item.isEmpty() &amp;&amp; !mRemoteJpSettings.jetpackProtectAllowlist.contains(item)) {</span>
<span class="nc" id="L739">                        mRemoteJpSettings.jetpackProtectAllowlist.add(item);</span>
                    }
                }
            }
        }

<span class="nc bnc" id="L745" title="All 2 branches missed.">        if (settingsObject.optBoolean(RELATED_POSTS_ALLOWED_KEY, false)) {</span>
<span class="nc" id="L746">            mRemoteSettings.showRelatedPosts = settingsObject.optBoolean(RELATED_POSTS_ENABLED_KEY, false);</span>
<span class="nc" id="L747">            mRemoteSettings.showRelatedPostHeader = settingsObject.optBoolean(RELATED_POSTS_HEADER_KEY, false);</span>
<span class="nc" id="L748">            mRemoteSettings.showRelatedPostImages = settingsObject.optBoolean(RELATED_POSTS_IMAGES_KEY, false);</span>
        }
<span class="nc" id="L750">    }</span>

    /**
     * Need to use JSONObject's instead of HashMap&lt;String, String&gt; to serialize array values (Jetpack Allowlist)
     */
    private JSONObject serializeWpComParamsToJSONObject() throws JSONException {
<span class="nc" id="L756">        JSONObject params = new JSONObject();</span>

<span class="nc bnc" id="L758" title="All 4 branches missed.">        if (mSettings.title != null &amp;&amp; !mSettings.title.equals(mRemoteSettings.title)) {</span>
<span class="nc" id="L759">            params.put(SET_TITLE_KEY, mSettings.title);</span>
        }
<span class="nc bnc" id="L761" title="All 4 branches missed.">        if (mSettings.tagline != null &amp;&amp; !mSettings.tagline.equals(mRemoteSettings.tagline)) {</span>
<span class="nc" id="L762">            params.put(SET_DESC_KEY, mSettings.tagline);</span>
        }
<span class="nc bnc" id="L764" title="All 2 branches missed.">        if (mSettings.languageId != mRemoteSettings.languageId) {</span>
<span class="nc" id="L765">            params.put(LANGUAGE_ID_KEY, String.valueOf((mSettings.languageId)));</span>
        }
<span class="nc bnc" id="L767" title="All 2 branches missed.">        if (mSettings.siteIconMediaId != mRemoteSettings.siteIconMediaId) {</span>
<span class="nc" id="L768">            params.put(SITE_ICON_KEY, String.valueOf((mSettings.siteIconMediaId)));</span>
        }
<span class="nc bnc" id="L770" title="All 2 branches missed.">        if (mSettings.privacy != mRemoteSettings.privacy) {</span>
<span class="nc" id="L771">            params.put(PRIVACY_KEY, String.valueOf((mSettings.privacy)));</span>
        }
<span class="nc bnc" id="L773" title="All 2 branches missed.">        if (mSettings.defaultCategory != mRemoteSettings.defaultCategory) {</span>
<span class="nc" id="L774">            params.put(DEF_CATEGORY_KEY, String.valueOf(mSettings.defaultCategory));</span>
        }
<span class="nc bnc" id="L776" title="All 2 branches missed.">        if (mSettings.defaultPostFormat != null &amp;&amp; !mSettings.defaultPostFormat</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                .equals(mRemoteSettings.defaultPostFormat)) {</span>
<span class="nc" id="L778">            params.put(DEF_POST_FORMAT_KEY, mSettings.defaultPostFormat);</span>
        }
<span class="nc bnc" id="L780" title="All 6 branches missed.">        if (mSettings.showRelatedPosts != mRemoteSettings.showRelatedPosts</span>
                || mSettings.showRelatedPostHeader != mRemoteSettings.showRelatedPostHeader
                || mSettings.showRelatedPostImages != mRemoteSettings.showRelatedPostImages) {
<span class="nc" id="L783">            params.put(RELATED_POSTS_ENABLED_KEY, String.valueOf(mSettings.showRelatedPosts));</span>
<span class="nc" id="L784">            params.put(RELATED_POSTS_HEADER_KEY, String.valueOf(mSettings.showRelatedPostHeader));</span>
<span class="nc" id="L785">            params.put(RELATED_POSTS_IMAGES_KEY, String.valueOf(mSettings.showRelatedPostImages));</span>
        }
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (mSettings.allowComments != mRemoteSettings.allowComments) {</span>
<span class="nc" id="L788">            params.put(ALLOW_COMMENTS_KEY, String.valueOf(mSettings.allowComments));</span>
        }
<span class="nc bnc" id="L790" title="All 2 branches missed.">        if (mSettings.sendPingbacks != mRemoteSettings.sendPingbacks) {</span>
<span class="nc" id="L791">            params.put(SEND_PINGBACKS_KEY, String.valueOf(mSettings.sendPingbacks));</span>
        }
<span class="nc bnc" id="L793" title="All 2 branches missed.">        if (mSettings.receivePingbacks != mRemoteSettings.receivePingbacks) {</span>
<span class="nc" id="L794">            params.put(RECEIVE_PINGBACKS_KEY, String.valueOf(mSettings.receivePingbacks));</span>
        }
<span class="nc bnc" id="L796" title="All 2 branches missed.">        if (mSettings.commentApprovalRequired != mRemoteSettings.commentApprovalRequired) {</span>
<span class="nc" id="L797">            params.put(COMMENT_MODERATION_KEY, String.valueOf(mSettings.commentApprovalRequired));</span>
        }
<span class="nc bnc" id="L799" title="All 4 branches missed.">        if (mSettings.closeCommentAfter != mRemoteSettings.closeCommentAfter</span>
                || mSettings.shouldCloseAfter != mRemoteSettings.shouldCloseAfter) {
<span class="nc" id="L801">            params.put(CLOSE_OLD_COMMENTS_KEY, String.valueOf(mSettings.shouldCloseAfter));</span>
<span class="nc" id="L802">            params.put(CLOSE_OLD_COMMENTS_DAYS_KEY, String.valueOf(mSettings.closeCommentAfter));</span>
        }
<span class="nc bnc" id="L804" title="All 2 branches missed.">        if (mSettings.sortCommentsBy != mRemoteSettings.sortCommentsBy) {</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">            if (mSettings.sortCommentsBy == ASCENDING_SORT) {</span>
<span class="nc" id="L806">                params.put(COMMENT_SORT_ORDER_KEY, &quot;asc&quot;);</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">            } else if (mSettings.sortCommentsBy == DESCENDING_SORT) {</span>
<span class="nc" id="L808">                params.put(COMMENT_SORT_ORDER_KEY, &quot;desc&quot;);</span>
            }
        }
<span class="nc bnc" id="L811" title="All 4 branches missed.">        if (mSettings.threadingLevels != mRemoteSettings.threadingLevels</span>
                || mSettings.shouldThreadComments != mRemoteSettings.shouldThreadComments) {
<span class="nc" id="L813">            params.put(THREAD_COMMENTS_KEY, String.valueOf(mSettings.shouldThreadComments));</span>
<span class="nc" id="L814">            params.put(THREAD_COMMENTS_DEPTH_KEY, String.valueOf(mSettings.threadingLevels));</span>
        }
<span class="nc bnc" id="L816" title="All 4 branches missed.">        if (mSettings.commentsPerPage != mRemoteSettings.commentsPerPage</span>
                || mSettings.shouldPageComments != mRemoteSettings.shouldPageComments) {
<span class="nc" id="L818">            params.put(PAGE_COMMENTS_KEY, String.valueOf(mSettings.shouldPageComments));</span>
<span class="nc" id="L819">            params.put(PAGE_COMMENT_COUNT_KEY, String.valueOf(mSettings.commentsPerPage));</span>
        }
<span class="nc bnc" id="L821" title="All 2 branches missed.">        if (mSettings.commentsRequireIdentity != mRemoteSettings.commentsRequireIdentity) {</span>
<span class="nc" id="L822">            params.put(REQUIRE_IDENTITY_KEY, String.valueOf(mSettings.commentsRequireIdentity));</span>
        }
<span class="nc bnc" id="L824" title="All 2 branches missed.">        if (mSettings.commentsRequireUserAccount != mRemoteSettings.commentsRequireUserAccount) {</span>
<span class="nc" id="L825">            params.put(REQUIRE_USER_ACCOUNT_KEY, String.valueOf(mSettings.commentsRequireUserAccount));</span>
        }
<span class="nc bnc" id="L827" title="All 2 branches missed.">        if (mSettings.commentAutoApprovalKnownUsers != mRemoteSettings.commentAutoApprovalKnownUsers) {</span>
<span class="nc" id="L828">            params.put(ALLOWLIST_KNOWN_USERS_KEY, String.valueOf(mSettings.commentAutoApprovalKnownUsers));</span>
        }
<span class="nc bnc" id="L830" title="All 2 branches missed.">        if (mSettings.maxLinks != mRemoteSettings.maxLinks) {</span>
<span class="nc" id="L831">            params.put(MAX_LINKS_KEY, String.valueOf(mSettings.maxLinks));</span>
        }
<span class="nc bnc" id="L833" title="All 2 branches missed.">        if (mSettings.holdForModeration != null &amp;&amp; !mSettings.holdForModeration</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                .equals(mRemoteSettings.holdForModeration)) {</span>
<span class="nc" id="L835">            StringBuilder builder = new StringBuilder();</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">            for (String key : mSettings.holdForModeration) {</span>
<span class="nc" id="L837">                builder.append(key);</span>
<span class="nc" id="L838">                builder.append(&quot;\n&quot;);</span>
<span class="nc" id="L839">            }</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">            if (builder.length() &gt; 1) {</span>
<span class="nc" id="L841">                params.put(MODERATION_KEYS_KEY, builder.substring(0, builder.length() - 1));</span>
            } else {
<span class="nc" id="L843">                params.put(MODERATION_KEYS_KEY, &quot;&quot;);</span>
            }
        }
<span class="nc bnc" id="L846" title="All 4 branches missed.">        if (mSettings.denylist != null &amp;&amp; !mSettings.denylist.equals(mRemoteSettings.denylist)) {</span>
<span class="nc" id="L847">            StringBuilder builder = new StringBuilder();</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">            for (String key : mSettings.denylist) {</span>
<span class="nc" id="L849">                builder.append(key);</span>
<span class="nc" id="L850">                builder.append(&quot;\n&quot;);</span>
<span class="nc" id="L851">            }</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">            if (builder.length() &gt; 1) {</span>
<span class="nc" id="L853">                params.put(DENYLIST_KEYS_KEY, builder.substring(0, builder.length() - 1));</span>
            } else {
<span class="nc" id="L855">                params.put(DENYLIST_KEYS_KEY, &quot;&quot;);</span>
            }
        }
<span class="nc bnc" id="L858" title="All 4 branches missed.">        if (mSettings.sharingLabel != null &amp;&amp; !mSettings.sharingLabel.equals(mRemoteSettings.sharingLabel)) {</span>
<span class="nc" id="L859">            params.put(SHARING_LABEL_KEY, String.valueOf(mSettings.sharingLabel));</span>
        }
<span class="nc bnc" id="L861" title="All 2 branches missed.">        if (mSettings.sharingButtonStyle != null &amp;&amp; !mSettings.sharingButtonStyle</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">                .equals(mRemoteSettings.sharingButtonStyle)) {</span>
<span class="nc" id="L863">            params.put(SHARING_BUTTON_STYLE_KEY, mSettings.sharingButtonStyle);</span>
        }
<span class="nc bnc" id="L865" title="All 2 branches missed.">        if (mSettings.allowReblogButton != mRemoteSettings.allowReblogButton) {</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">            params.put(SHARING_REBLOGS_DISABLED_KEY, String.valueOf(!mSettings.allowReblogButton));</span>
        }
<span class="nc bnc" id="L868" title="All 2 branches missed.">        if (mSettings.allowLikeButton != mRemoteSettings.allowLikeButton) {</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">            params.put(SHARING_LIKES_DISABLED_KEY, String.valueOf(!mSettings.allowLikeButton));</span>
        }
<span class="nc bnc" id="L871" title="All 2 branches missed.">        if (mSettings.allowCommentLikes != mRemoteSettings.allowCommentLikes) {</span>
<span class="nc" id="L872">            params.put(SHARING_COMMENT_LIKES_KEY, String.valueOf(mSettings.allowCommentLikes));</span>
        }
<span class="nc bnc" id="L874" title="All 4 branches missed.">        if (mSettings.twitterUsername != null &amp;&amp; !mSettings.twitterUsername.equals(mRemoteSettings.twitterUsername)) {</span>
<span class="nc" id="L875">            params.put(TWITTER_USERNAME_KEY, mSettings.twitterUsername);</span>
        }
<span class="nc bnc" id="L877" title="All 4 branches missed.">        if (mSettings.startOfWeek != null &amp;&amp; !mSettings.startOfWeek.equals(mRemoteSettings.startOfWeek)) {</span>
<span class="nc" id="L878">            params.put(START_OF_WEEK_KEY, mSettings.startOfWeek);</span>
        }
<span class="nc bnc" id="L880" title="All 4 branches missed.">        if (mSettings.dateFormat != null &amp;&amp; !mSettings.dateFormat.equals(mRemoteSettings.dateFormat)) {</span>
<span class="nc" id="L881">            params.put(DATE_FORMAT_KEY, mSettings.dateFormat);</span>
        }
<span class="nc bnc" id="L883" title="All 4 branches missed.">        if (mSettings.timeFormat != null &amp;&amp; !mSettings.timeFormat.equals(mRemoteSettings.timeFormat)) {</span>
<span class="nc" id="L884">            params.put(TIME_FORMAT_KEY, mSettings.timeFormat);</span>
        }
<span class="nc bnc" id="L886" title="All 2 branches missed.">        if (!StringUtils.equals(mSettings.timezone, mRemoteSettings.timezone)) {</span>
<span class="nc" id="L887">            params.put(TIMEZONE_KEY, mSettings.timezone);</span>
        }
<span class="nc bnc" id="L889" title="All 2 branches missed.">        if (mSettings.postsPerPage != mRemoteSettings.postsPerPage) {</span>
<span class="nc" id="L890">            params.put(POSTS_PER_PAGE_KEY, String.valueOf(mSettings.postsPerPage));</span>
        }
<span class="nc bnc" id="L892" title="All 2 branches missed.">        if (mSettings.ampSupported != mRemoteSettings.ampSupported) {</span>
<span class="nc" id="L893">            params.put(AMP_SUPPORTED_KEY, String.valueOf(mSettings.ampSupported));</span>
        }
<span class="nc bnc" id="L895" title="All 2 branches missed.">        if (mSettings.ampEnabled != mRemoteSettings.ampEnabled) {</span>
<span class="nc" id="L896">            params.put(AMP_ENABLED_KEY, String.valueOf(mSettings.ampEnabled));</span>
        }
<span class="nc bnc" id="L898" title="All 2 branches missed.">        if (mSettings.jetpackSearchSupported != mRemoteSettings.jetpackSearchSupported) {</span>
<span class="nc" id="L899">            params.put(JETPACK_SEARCH_SUPPORTED_KEY, String.valueOf(mSettings.jetpackSearchSupported));</span>
        }
<span class="nc bnc" id="L901" title="All 2 branches missed.">        if (mSettings.jetpackSearchEnabled != mRemoteSettings.jetpackSearchEnabled) {</span>
<span class="nc" id="L902">            params.put(JETPACK_SEARCH_ENABLED_KEY, String.valueOf(mSettings.jetpackSearchEnabled));</span>
        }

<span class="nc" id="L905">        return params;</span>
    }

    private void deserializeJetpackRestResponse(SiteModel site, JSONObject response) {
<span class="nc bnc" id="L909" title="All 4 branches missed.">        if (site == null || response == null) return;</span>
<span class="nc" id="L910">        JSONObject settingsObject = response.optJSONObject(&quot;settings&quot;);</span>
<span class="nc" id="L911">        mRemoteJpSettings.emailNotifications = settingsObject.optBoolean(JP_MONITOR_EMAIL_NOTES_KEY, false);</span>
<span class="nc" id="L912">        mRemoteJpSettings.wpNotifications = settingsObject.optBoolean(JP_MONITOR_WP_NOTES_KEY, false);</span>
<span class="nc" id="L913">    }</span>

    private @NonNull Map&lt;String, String&gt; serializeJetpackMonitorParams() {
<span class="nc" id="L916">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L917">        params.put(JP_MONITOR_EMAIL_NOTES_KEY, String.valueOf(mJpSettings.emailNotifications));</span>
<span class="nc" id="L918">        params.put(JP_MONITOR_WP_NOTES_KEY, String.valueOf(mJpSettings.wpNotifications));</span>
<span class="nc" id="L919">        return params;</span>
    }

    private Map&lt;String, Object&gt; serializeJetpackProtectAndSsoParams() {
<span class="nc" id="L923">        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">        if (mJpSettings.monitorActive != mRemoteJpSettings.monitorActive) {</span>
<span class="nc" id="L925">            params.put(&quot;monitor&quot;, mJpSettings.monitorActive);</span>
        }
<span class="nc bnc" id="L927" title="All 2 branches missed.">        if (mJpSettings.jetpackProtectEnabled != mRemoteJpSettings.jetpackProtectEnabled) {</span>
<span class="nc" id="L928">            params.put(&quot;protect&quot;, mJpSettings.jetpackProtectEnabled);</span>
        }
<span class="nc bnc" id="L930" title="All 2 branches missed.">        if (!mJpSettings.allowlistMatches(mRemoteJpSettings.jetpackProtectAllowlist)) {</span>
<span class="nc" id="L931">            String allowlistArray = TextUtils.join(&quot;,&quot;, mJpSettings.jetpackProtectAllowlist);</span>
<span class="nc" id="L932">            params.put(&quot;jetpack_protect_global_whitelist&quot;, allowlistArray);</span>
        }
<span class="nc bnc" id="L934" title="All 2 branches missed.">        if (mJpSettings.ssoActive != mRemoteJpSettings.ssoActive) {</span>
<span class="nc" id="L935">            params.put(&quot;sso&quot;, mJpSettings.ssoActive);</span>
        }
<span class="nc bnc" id="L937" title="All 2 branches missed.">        if (mJpSettings.ssoMatchEmail != mRemoteJpSettings.ssoMatchEmail) {</span>
<span class="nc" id="L938">            params.put(&quot;jetpack_sso_match_by_email&quot;, mJpSettings.ssoMatchEmail);</span>
        }
<span class="nc bnc" id="L940" title="All 2 branches missed.">        if (mJpSettings.ssoRequireTwoFactor != mRemoteJpSettings.ssoRequireTwoFactor) {</span>
<span class="nc" id="L941">            params.put(&quot;jetpack_sso_require_two_step&quot;, mJpSettings.ssoRequireTwoFactor);</span>
        }
<span class="nc bnc" id="L943" title="All 2 branches missed.">        if (mJpSettings.commentLikes != mRemoteJpSettings.commentLikes) {</span>
<span class="nc" id="L944">            params.put(COMMENT_LIKES, mJpSettings.commentLikes);</span>
        }
<span class="nc" id="L946">        return params;</span>
    }

    private CategoryModel deserializeCategoryFromJson(JSONObject category) throws JSONException {
<span class="nc bnc" id="L950" title="All 2 branches missed.">        if (category == null) return null;</span>

<span class="nc" id="L952">        CategoryModel model = new CategoryModel();</span>
<span class="nc" id="L953">        model.id = category.getInt(CAT_ID_KEY);</span>
<span class="nc" id="L954">        model.name = category.getString(CAT_NAME_KEY);</span>
<span class="nc" id="L955">        model.slug = category.getString(CAT_SLUG_KEY);</span>
<span class="nc" id="L956">        model.description = category.getString(CAT_DESC_KEY);</span>
<span class="nc" id="L957">        model.parentId = category.getInt(CAT_PARENT_ID_KEY);</span>
<span class="nc" id="L958">        model.postCount = category.getInt(CAT_POST_COUNT_KEY);</span>

<span class="nc" id="L960">        return model;</span>
    }

    private CategoryModel[] deserializeCategoryRestResponse(JSONObject response) {
        try {
<span class="nc" id="L965">            int num = response.getInt(CAT_NUM_POSTS_KEY);</span>
<span class="nc" id="L966">            JSONArray categories = response.getJSONArray(CATEGORIES_KEY);</span>
<span class="nc" id="L967">            CategoryModel[] models = new CategoryModel[num];</span>

<span class="nc bnc" id="L969" title="All 2 branches missed.">            for (int i = 0; i &lt; num; ++i) {</span>
<span class="nc" id="L970">                JSONObject category = categories.getJSONObject(i);</span>
<span class="nc" id="L971">                models[i] = deserializeCategoryFromJson(category);</span>
            }

<span class="nc" id="L974">            AppLog.d(AppLog.T.API, &quot;Successfully fetched WP.com categories&quot;);</span>

<span class="nc" id="L976">            return models;</span>
<span class="nc" id="L977">        } catch (JSONException exception) {</span>
<span class="nc" id="L978">            AppLog.d(AppLog.T.API, &quot;Error parsing WP.com categories response:&quot; + response);</span>
<span class="nc" id="L979">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>