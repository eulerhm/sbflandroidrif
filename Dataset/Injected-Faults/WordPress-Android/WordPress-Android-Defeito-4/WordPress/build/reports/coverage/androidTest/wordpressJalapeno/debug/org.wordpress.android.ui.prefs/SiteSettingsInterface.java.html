<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SiteSettingsInterface.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs</a> &gt; <span class="el_source">SiteSettingsInterface.java</span></div><h1>SiteSettingsInterface.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs;

import android.content.Context;
import android.database.Cursor;
import android.os.Handler;
import android.text.Html;
import android.text.TextUtils;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.collection.SparseArrayCompat;

import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.datasets.SiteSettingsTable;
import org.wordpress.android.fluxc.Dispatcher;
import org.wordpress.android.fluxc.generated.SiteActionBuilder;
import org.wordpress.android.fluxc.model.PostFormatModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.store.SiteStore.OnAllSitesMobileEditorChanged;
import org.wordpress.android.fluxc.store.SiteStore.OnPostFormatsChanged;
import org.wordpress.android.fluxc.store.SiteStore.OnSiteEditorsChanged;
import org.wordpress.android.models.CategoryModel;
import org.wordpress.android.models.JetpackSettingsModel;
import org.wordpress.android.models.SiteSettingsModel;
import org.wordpress.android.ui.plans.PlansConstants;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.FormatUtils;
import org.wordpress.android.util.LanguageUtils;
import org.wordpress.android.util.LocaleManager;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.viewmodel.ResourceProvider;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import javax.inject.Inject;

/**
 * Interface for WordPress (.com and .org) Site Settings. The {@link SiteSettingsModel} class is
 * used to store the following settings:
 * &lt;p&gt;
 * - Title
 * - Tagline
 * - Address
 * - Privacy
 * - Language
 * - Site icon
 * - Username (.org only)
 * - Password (.org only)
 * - Default Category
 * - Default Format
 * - Related Posts
 * - Allow Comments
 * - Send Pingbacks
 * - Receive Pingbacks
 * - Identity Required
 * - User Account Required
 * - Close Comments After
 * - Comment Sort Order
 * - Comment Threading
 * - Comment Paging
 * - Comment User Allowlist
 * - Comment Link Limit
 * - Comment Moderation Hold Filter
 * - Comment Denylist Filter
 * &lt;p&gt;
 * This class is marked abstract. This is due to the fact that .org (self-hosted) and .com sites
 * expose different API's to query and edit their respective settings (even though the options
 * offered by each is roughly the same). To get an instance of this interface class use the
 * {@link SiteSettingsInterface#getInterface(Context, SiteModel, SiteSettingsListener)} method.
 */

public abstract class SiteSettingsInterface {
    /**
     * Identifies an Ascending (oldest to newest) sort order.
     */
    static final int ASCENDING_SORT = 0;

    /**
     * Identifies an Descending (newest to oldest) sort order.
     */
    static final int DESCENDING_SORT = 1;

    /**
     * Used to prefix keys in an analytics property list.
     */
    static final String SAVED_ITEM_PREFIX = &quot;item_saved_&quot;;

    /**
     * Key for the Standard post format. Used as default if post format is not set/known.
     */
    static final String STANDARD_POST_FORMAT_KEY = &quot;standard&quot;;

    /**
     * Standard sharing button style value. Used as default value if button style is unknown.
     */
    private static final String STANDARD_SHARING_BUTTON_STYLE = &quot;icon-text&quot;;

    /**
     * Standard post format value. Used as default display value if post format is unknown.
     */
    private static final String STANDARD_POST_FORMAT = &quot;Standard&quot;;

    /**
     * Instantiates the appropriate (self-hosted or .com) SiteSettingsInterface.
     */
    @Nullable
    public static SiteSettingsInterface getInterface(Context host, SiteModel site, SiteSettingsListener listener) {
<span class="nc bnc" id="L120" title="All 4 branches missed.">        if (host == null || site == null) {</span>
<span class="nc" id="L121">            return null;</span>
        }

<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (SiteUtils.isAccessedViaWPComRest(site)) {</span>
<span class="nc" id="L125">            return new WPComSiteSettings(host, site, listener);</span>
        }

<span class="nc" id="L128">        return new SelfHostedSiteSettings(host, site, listener);</span>
    }

    /**
     * Thrown when provided credentials are not valid.
     */
<span class="nc" id="L134">    public class AuthenticationError extends Exception {</span>
    }

    /**
     * Interface callbacks for settings events.
     */
    public interface SiteSettingsListener {
        void onSaveError(Exception error);

        void onFetchError(Exception error);

        /**
         * Called when settings have been updated with remote changes.
         */
        void onSettingsUpdated();

        /**
         * Called when attempt to update remote settings is finished.
         */
        void onSettingsSaved();

        /**
         * Called when a request to validate current credentials has completed.
         *
         * @param error null if successful
         */
        void onCredentialsValidated(Exception error);
    }

    /**
     * {@link SiteSettingsInterface} implementations should use this method to start a background
     * task to load settings data from a remote source.
     */
    protected abstract void fetchRemoteData();

    protected final SiteModel mSite;
    protected final SiteSettingsListener mListener;
    protected final SiteSettingsModel mSettings;
    protected final SiteSettingsModel mRemoteSettings;
    protected final JetpackSettingsModel mJpSettings;
    protected final JetpackSettingsModel mRemoteJpSettings;
    private final Map&lt;String, String&gt; mLanguageCodes;

    @Inject SiteStore mSiteStore;
    @Inject Dispatcher mDispatcher;
    @Inject AccountStore mAccountStore;
    @Inject ResourceProvider mResourceProvider;

<span class="nc" id="L182">    protected SiteSettingsInterface(Context host, SiteModel site, SiteSettingsListener listener) {</span>
<span class="nc" id="L183">        ((WordPress) host.getApplicationContext()).component().inject(this);</span>
<span class="nc" id="L184">        mDispatcher.register(this);</span>
<span class="nc" id="L185">        mSite = site;</span>
<span class="nc" id="L186">        mListener = listener;</span>
<span class="nc" id="L187">        mSettings = new SiteSettingsModel();</span>
<span class="nc" id="L188">        mRemoteSettings = new SiteSettingsModel();</span>
<span class="nc" id="L189">        mJpSettings = new JetpackSettingsModel();</span>
<span class="nc" id="L190">        mRemoteJpSettings = new JetpackSettingsModel();</span>
<span class="nc" id="L191">        mLanguageCodes = LocaleManager.generateLanguageMap(host);</span>
<span class="nc" id="L192">    }</span>

    @Override
    protected void finalize() throws Throwable {
<span class="nc" id="L196">        mDispatcher.unregister(this);</span>
<span class="nc" id="L197">        super.finalize();</span>
<span class="nc" id="L198">    }</span>

    public void clear() {
<span class="nc" id="L201">        mDispatcher.unregister(this);</span>
<span class="nc" id="L202">    }</span>

    public void saveSettings() {
<span class="nc" id="L205">        SiteSettingsTable.saveSettings(mSettings);</span>
<span class="nc" id="L206">    }</span>

    public int getLocalSiteId() {
<span class="nc" id="L209">        return mSite.getId();</span>
    }

    public @NonNull String getTitle() {
<span class="nc bnc" id="L213" title="All 2 branches missed.">        return mSettings.title == null ? &quot;&quot; : mSettings.title;</span>
    }

    public @NonNull String getTagline() {
<span class="nc bnc" id="L217" title="All 2 branches missed.">        return mSettings.tagline == null ? &quot;&quot; : mSettings.tagline;</span>
    }

    public @NonNull String getAddress() {
<span class="nc bnc" id="L221" title="All 2 branches missed.">        return mSettings.address == null ? &quot;&quot; : mSettings.address;</span>
    }

    public @NonNull String getQuotaDiskSpace() {
<span class="nc bnc" id="L225" title="All 2 branches missed.">        return mSettings.quotaDiskSpace == null ? &quot;&quot; : mSettings.quotaDiskSpace;</span>
    }

    public int getPrivacy() {
<span class="nc" id="L229">        return mSettings.privacy;</span>
    }

    public @NonNull String getPrivacyDescription() {
<span class="nc bnc" id="L233" title="All 4 branches missed.">        switch (getPrivacy()) {</span>
            case -1:
<span class="nc" id="L235">                return mResourceProvider.getString(R.string.site_settings_privacy_private_summary);</span>
            case 0:
<span class="nc" id="L237">                return mResourceProvider.getString(R.string.site_settings_privacy_hidden_summary);</span>
            case 1:
<span class="nc" id="L239">                return mResourceProvider.getString(R.string.site_settings_privacy_public_summary);</span>
        }
<span class="nc" id="L241">        return &quot;&quot;;</span>
    }

    public @NonNull String getLanguageCode() {
<span class="nc bnc" id="L245" title="All 2 branches missed.">        return mSettings.language == null ? &quot;&quot; : mSettings.language;</span>
    }

    public @NonNull String getUsername() {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        return mSettings.username == null ? &quot;&quot; : mSettings.username;</span>
    }

    public @NonNull String getPassword() {
<span class="nc bnc" id="L253" title="All 2 branches missed.">        return mSettings.password == null ? &quot;&quot; : mSettings.password;</span>
    }

    public @NonNull Map&lt;String, String&gt; getFormats() {
<span class="nc" id="L257">        mSettings.postFormats = new HashMap&lt;&gt;();</span>
<span class="nc" id="L258">        String[] postFormatDisplayNames = mResourceProvider.getStringArray(R.array.post_format_display_names);</span>
<span class="nc" id="L259">        String[] postFormatKeys = mResourceProvider.getStringArray(R.array.post_format_keys);</span>
        // Add standard post format (only for .com)
<span class="nc" id="L261">        mSettings.postFormats.put(STANDARD_POST_FORMAT_KEY, STANDARD_POST_FORMAT);</span>
        // Add default post formats
<span class="nc bnc" id="L263" title="All 4 branches missed.">        for (int i = 0; i &lt; postFormatKeys.length &amp;&amp; i &lt; postFormatDisplayNames.length; ++i) {</span>
<span class="nc" id="L264">            mSettings.postFormats.put(postFormatKeys[i], postFormatDisplayNames[i]);</span>
        }
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (mSite == null) {</span>
<span class="nc" id="L267">            return mSettings.postFormats;</span>
        }
        // Add (or replace) site-specific post formats
<span class="nc" id="L270">        List&lt;PostFormatModel&gt; postFormats = mSiteStore.getPostFormats(mSite);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">        for (PostFormatModel postFormat : postFormats) {</span>
<span class="nc" id="L272">            mSettings.postFormats.put(postFormat.getSlug(), postFormat.getDisplayName());</span>
<span class="nc" id="L273">        }</span>
<span class="nc" id="L274">        return mSettings.postFormats;</span>
    }

    public @NonNull CategoryModel[] getCategories() {
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (mSettings.categories == null) {</span>
<span class="nc" id="L279">            mSettings.categories = new CategoryModel[0];</span>
        }
<span class="nc" id="L281">        return mSettings.categories;</span>
    }

    public @NonNull SparseArrayCompat&lt;String&gt; getCategoryNames() {
<span class="nc" id="L285">        SparseArrayCompat&lt;String&gt; categoryNames = new SparseArrayCompat&lt;&gt;();</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">        if (mSettings.categories != null &amp;&amp; mSettings.categories.length &gt; 0) {</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">            for (CategoryModel model : mSettings.categories) {</span>
<span class="nc" id="L288">                categoryNames.put(model.id, Html.fromHtml(model.name).toString());</span>
            }
        }

<span class="nc" id="L292">        return categoryNames;</span>
    }

    public int getDefaultCategory() {
<span class="nc" id="L296">        return mSettings.defaultCategory;</span>
    }

    public @NonNull String getDefaultCategoryForDisplay() {
<span class="nc bnc" id="L300" title="All 2 branches missed.">        for (CategoryModel model : getCategories()) {</span>
<span class="nc bnc" id="L301" title="All 4 branches missed.">            if (model != null &amp;&amp; model.id == getDefaultCategory()) {</span>
<span class="nc" id="L302">                return Html.fromHtml(model.name).toString();</span>
            }
        }

<span class="nc" id="L306">        return &quot;&quot;;</span>
    }

    public @NonNull String getDefaultPostFormat() {
<span class="nc bnc" id="L310" title="All 4 branches missed.">        if (TextUtils.isEmpty(mSettings.defaultPostFormat) || !getFormats().containsKey(mSettings.defaultPostFormat)) {</span>
<span class="nc" id="L311">            mSettings.defaultPostFormat = STANDARD_POST_FORMAT_KEY;</span>
        }
<span class="nc" id="L313">        return mSettings.defaultPostFormat;</span>
    }

    public @NonNull String getDefaultPostFormatDisplay() {
<span class="nc" id="L317">        String defaultFormat = getFormats().get(getDefaultPostFormat());</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (TextUtils.isEmpty(defaultFormat)) {</span>
<span class="nc" id="L319">            defaultFormat = STANDARD_POST_FORMAT;</span>
        }
<span class="nc" id="L321">        return defaultFormat;</span>
    }

    public boolean getShowRelatedPosts() {
<span class="nc" id="L325">        return mSettings.showRelatedPosts;</span>
    }

    public boolean getShowRelatedPostHeader() {
<span class="nc" id="L329">        return mSettings.showRelatedPostHeader;</span>
    }

    public boolean getShowRelatedPostImages() {
<span class="nc" id="L333">        return mSettings.showRelatedPostImages;</span>
    }

    public @NonNull String getRelatedPostsDescription() {
<span class="nc bnc" id="L337" title="All 2 branches missed.">        String desc = mResourceProvider.getString(getShowRelatedPosts() ? R.string.on : R.string.off);</span>
<span class="nc" id="L338">        return StringUtils.capitalize(desc);</span>
    }

    public boolean getAllowComments() {
<span class="nc" id="L342">        return mSettings.allowComments;</span>
    }

    public boolean getSendPingbacks() {
<span class="nc" id="L346">        return mSettings.sendPingbacks;</span>
    }

    public boolean getReceivePingbacks() {
<span class="nc" id="L350">        return mSettings.receivePingbacks;</span>
    }

    public boolean getShouldCloseAfter() {
<span class="nc" id="L354">        return mSettings.shouldCloseAfter;</span>
    }

    public int getCloseAfter() {
<span class="nc" id="L358">        return mSettings.closeCommentAfter;</span>
    }

    public @NonNull String getCloseAfterDescriptionForPeriod() {
<span class="nc" id="L362">        return getCloseAfterDescriptionForPeriod(getCloseAfter());</span>
    }

    public int getCloseAfterPeriodForDescription() {
<span class="nc bnc" id="L366" title="All 2 branches missed.">        return !getShouldCloseAfter() ? 0 : getCloseAfter();</span>
    }

    public @NonNull String getCloseAfterDescription() {
<span class="nc" id="L370">        return getCloseAfterDescriptionForPeriod(getCloseAfterPeriodForDescription());</span>
    }

    public @NonNull String getCloseAfterDescriptionForPeriod(int period) {
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (!getShouldCloseAfter()) {</span>
<span class="nc" id="L375">            return mResourceProvider.getString(R.string.never);</span>
        }

<span class="nc" id="L378">        return mResourceProvider.getQuantityString(R.string.never, R.string.days_quantity_one,</span>
                R.string.days_quantity_other, period);
    }

    public int getCommentSorting() {
<span class="nc" id="L383">        return mSettings.sortCommentsBy;</span>
    }

    public @NonNull String getSortingDescription() {
<span class="nc" id="L387">        int order = getCommentSorting();</span>
<span class="nc bnc" id="L388" title="All 3 branches missed.">        switch (order) {</span>
            case SiteSettingsInterface.ASCENDING_SORT:
<span class="nc" id="L390">                return mResourceProvider.getString(R.string.oldest_first);</span>
            case SiteSettingsInterface.DESCENDING_SORT:
<span class="nc" id="L392">                return mResourceProvider.getString(R.string.newest_first);</span>
            default:
<span class="nc" id="L394">                return mResourceProvider.getString(R.string.unknown);</span>
        }
    }

    public boolean getShouldThreadComments() {
<span class="nc" id="L399">        return mSettings.shouldThreadComments;</span>
    }

    public int getThreadingLevels() {
<span class="nc" id="L403">        return mSettings.threadingLevels;</span>
    }

    public int getThreadingLevelsForDescription() {
<span class="nc bnc" id="L407" title="All 2 branches missed.">        return !getShouldThreadComments() ? 1 : getThreadingLevels();</span>
    }

    public @NonNull String getThreadingDescription() {
<span class="nc" id="L411">        return getThreadingDescriptionForLevel(getThreadingLevelsForDescription());</span>
    }

    public @NonNull String getThreadingDescriptionForLevel(int level) {
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (mResourceProvider == null) {</span>
<span class="nc" id="L416">            return &quot;&quot;;</span>
        }

<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (level &lt;= 1) {</span>
<span class="nc" id="L420">            return mResourceProvider.getString(R.string.none);</span>
        }
<span class="nc" id="L422">        return String.format(mResourceProvider.getString(R.string.site_settings_threading_summary), level);</span>
    }

    public boolean getShouldPageComments() {
<span class="nc" id="L426">        return mSettings.shouldPageComments;</span>
    }

    public int getPagingCount() {
<span class="nc" id="L430">        return mSettings.commentsPerPage;</span>
    }

    public int getPagingCountForDescription() {
<span class="nc bnc" id="L434" title="All 2 branches missed.">        return !getShouldPageComments() ? 0 : getPagingCount();</span>
    }

    public @NonNull String getPagingDescription() {
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (!getShouldPageComments()) {</span>
<span class="nc" id="L439">            return mResourceProvider.getString(R.string.disabled);</span>
        }

<span class="nc" id="L442">        int count = getPagingCountForDescription();</span>
<span class="nc" id="L443">        return mResourceProvider.getQuantityString(R.string.none, R.string.site_settings_paging_summary_one,</span>
                R.string.site_settings_paging_summary_other, count);
    }

    public boolean getManualApproval() {
<span class="nc" id="L448">        return mSettings.commentApprovalRequired;</span>
    }

    public boolean getIdentityRequired() {
<span class="nc" id="L452">        return mSettings.commentsRequireIdentity;</span>
    }

    public boolean getUserAccountRequired() {
<span class="nc" id="L456">        return mSettings.commentsRequireUserAccount;</span>
    }

    public boolean getUseCommentAllowlist() {
<span class="nc" id="L460">        return mSettings.commentAutoApprovalKnownUsers;</span>
    }

    public int getMultipleLinks() {
<span class="nc" id="L464">        return mSettings.maxLinks;</span>
    }

    public @NonNull List&lt;String&gt; getModerationKeys() {
<span class="nc bnc" id="L468" title="All 2 branches missed.">        if (mSettings.holdForModeration == null) {</span>
<span class="nc" id="L469">            mSettings.holdForModeration = new ArrayList&lt;&gt;();</span>
        }
<span class="nc" id="L471">        return mSettings.holdForModeration;</span>
    }

    public @NonNull String getModerationHoldDescription() {
<span class="nc" id="L475">        return getKeysDescription(getModerationKeys().size());</span>
    }

    public @NonNull List&lt;String&gt; getDenylistKeys() {
<span class="nc bnc" id="L479" title="All 2 branches missed.">        if (mSettings.denylist == null) {</span>
<span class="nc" id="L480">            mSettings.denylist = new ArrayList&lt;&gt;();</span>
        }
<span class="nc" id="L482">        return mSettings.denylist;</span>
    }

    public @NonNull String getDenylistDescription() {
<span class="nc" id="L486">        return getKeysDescription(getDenylistKeys().size());</span>
    }

    public @NonNull String getJetpackProtectAllowlistSummary() {
<span class="nc" id="L490">        return getKeysDescription(getJetpackAllowlistKeys().size());</span>
    }

    public String getSharingLabel() {
<span class="nc" id="L494">        return mSettings.sharingLabel;</span>
    }

    public @NonNull String getSharingButtonStyle(Context context) {
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (TextUtils.isEmpty(mSettings.sharingButtonStyle)) {</span>
<span class="nc" id="L499">            mSettings.sharingButtonStyle = context.getResources().getStringArray(R.array.sharing_button_style_array)[0];</span>
        }

<span class="nc" id="L502">        return mSettings.sharingButtonStyle;</span>
    }

    public @NonNull String getSharingButtonStyleDisplayText(Context context) {
<span class="nc" id="L506">        String sharingButtonStyle = getSharingButtonStyle(context);</span>
<span class="nc" id="L507">        String[] styleArray = context.getResources().getStringArray(R.array.sharing_button_style_array);</span>
<span class="nc" id="L508">        String[] styleDisplayArray = context.getResources().getStringArray(R.array.sharing_button_style_display_array);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">        for (int i = 0; i &lt; styleArray.length; i++) {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">            if (sharingButtonStyle.equals(styleArray[i])) {</span>
<span class="nc" id="L511">                return styleDisplayArray[i];</span>
            }
        }

<span class="nc" id="L515">        return styleDisplayArray[0];</span>
    }

    public boolean getAllowReblogButton() {
<span class="nc" id="L519">        return mSettings.allowReblogButton;</span>
    }

    public boolean getAllowLikeButton() {
<span class="nc" id="L523">        return mSettings.allowLikeButton;</span>
    }

    public boolean getAllowCommentLikes() {
        // We have different settings for comment likes for wpcom and Jetpack sites
<span class="nc bnc" id="L528" title="All 2 branches missed.">        return mSite.isJetpackConnected() ? mJpSettings.commentLikes : mSettings.allowCommentLikes;</span>
    }

    public @NonNull String getTwitterUsername() {
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (mSettings.twitterUsername == null) {</span>
<span class="nc" id="L533">            mSettings.twitterUsername = &quot;&quot;;</span>
        }
<span class="nc" id="L535">        return mSettings.twitterUsername;</span>
    }

    public @NonNull String getKeysDescription(int count) {
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (mResourceProvider == null) {</span>
<span class="nc" id="L540">            return &quot;&quot;;</span>
        }

<span class="nc" id="L543">        return mResourceProvider.getQuantityString(R.string.site_settings_list_editor_no_items_text,</span>
                R.string.site_settings_list_editor_summary_one,
                R.string.site_settings_list_editor_summary_other, count);
    }

    public String getStartOfWeek() {
<span class="nc" id="L549">        return mSettings.startOfWeek;</span>
    }

    public void setStartOfWeek(String startOfWeek) {
<span class="nc" id="L553">        mSettings.startOfWeek = startOfWeek;</span>
<span class="nc" id="L554">    }</span>

    public String getDateFormat() {
<span class="nc" id="L557">        return mSettings.dateFormat;</span>
    }

    public void setDateFormat(String dateFormat) {
<span class="nc" id="L561">        mSettings.dateFormat = dateFormat;</span>
<span class="nc" id="L562">    }</span>

    public String getTimeFormat() {
<span class="nc" id="L565">        return mSettings.timeFormat;</span>
    }

    public void setTimeFormat(String timeFormat) {
<span class="nc" id="L569">        mSettings.timeFormat = timeFormat;</span>
<span class="nc" id="L570">    }</span>

    public String getTimezone() {
<span class="nc" id="L573">        return mSettings.timezone;</span>
    }

    public void setTimezone(String timezone) {
<span class="nc" id="L577">        mSettings.timezone = timezone;</span>
<span class="nc" id="L578">    }</span>

    public int getPostsPerPage() {
<span class="nc" id="L581">        return mSettings.postsPerPage;</span>
    }

    public void setPostsPerPage(int postsPerPage) {
<span class="nc" id="L585">        mSettings.postsPerPage = postsPerPage;</span>
<span class="nc" id="L586">    }</span>

    public boolean getAmpSupported() {
<span class="nc" id="L589">        return mSettings.ampSupported;</span>
    }

    public void setAmpSupported(boolean supported) {
<span class="nc" id="L593">        mSettings.ampSupported = supported;</span>
<span class="nc" id="L594">    }</span>

    public boolean getAmpEnabled() {
<span class="nc" id="L597">        return mSettings.ampEnabled;</span>
    }

    public void setAmpEnabled(boolean enabled) {
<span class="nc" id="L601">        mSettings.ampEnabled = enabled;</span>
<span class="nc" id="L602">    }</span>

    public boolean getJetpackSearchSupported() {
<span class="nc" id="L605">        return mSettings.jetpackSearchSupported;</span>
    }

    public void setJetpackSearchSupported(boolean supported) {
<span class="nc" id="L609">        mSettings.jetpackSearchSupported = supported;</span>
<span class="nc" id="L610">    }</span>

    public boolean getJetpackSearchEnabled() {
<span class="nc" id="L613">        return mSettings.jetpackSearchEnabled;</span>
    }

    public void setJetpackSearchEnabled(boolean enabled) {
<span class="nc" id="L617">        mSettings.jetpackSearchEnabled = enabled;</span>
<span class="nc" id="L618">    }</span>

    public boolean isJetpackMonitorEnabled() {
<span class="nc" id="L621">        return mJpSettings.monitorActive;</span>
    }

    public boolean shouldSendJetpackMonitorEmailNotifications() {
<span class="nc" id="L625">        return mJpSettings.emailNotifications;</span>
    }

    public boolean shouldSendJetpackMonitorWpNotifications() {
<span class="nc" id="L629">        return mJpSettings.wpNotifications;</span>
    }

    public void enableJetpackMonitor(boolean monitorActive) {
<span class="nc" id="L633">        mJpSettings.monitorActive = monitorActive;</span>
<span class="nc" id="L634">    }</span>

    public void enableJetpackMonitorEmailNotifications(boolean emailNotifications) {
<span class="nc" id="L637">        mJpSettings.emailNotifications = emailNotifications;</span>
<span class="nc" id="L638">    }</span>

    public void enableJetpackMonitorWpNotifications(boolean wpNotifications) {
<span class="nc" id="L641">        mJpSettings.wpNotifications = wpNotifications;</span>
<span class="nc" id="L642">    }</span>

    public boolean isJetpackProtectEnabled() {
<span class="nc" id="L645">        return mJpSettings.jetpackProtectEnabled;</span>
    }

    public void enableJetpackProtect(boolean enabled) {
<span class="nc" id="L649">        mJpSettings.jetpackProtectEnabled = enabled;</span>
<span class="nc" id="L650">    }</span>

    public @NonNull List&lt;String&gt; getJetpackAllowlistKeys() {
<span class="nc" id="L653">        return mJpSettings.jetpackProtectAllowlist;</span>
    }

    public void setJetpackAllowlistKeys(@NonNull List&lt;String&gt; allowlistKeys) {
<span class="nc" id="L657">        mJpSettings.jetpackProtectAllowlist.clear();</span>
<span class="nc" id="L658">        mJpSettings.jetpackProtectAllowlist.addAll(allowlistKeys);</span>
<span class="nc" id="L659">    }</span>

    public void enableJetpackSsoMatchEmail(boolean enabled) {
<span class="nc" id="L662">        mJpSettings.ssoMatchEmail = enabled;</span>
<span class="nc" id="L663">    }</span>

    public void enableJetpackSso(boolean enabled) {
<span class="nc" id="L666">        mJpSettings.ssoActive = enabled;</span>
<span class="nc" id="L667">    }</span>

    public boolean isJetpackSsoEnabled() {
<span class="nc" id="L670">        return mJpSettings.ssoActive;</span>
    }

    public boolean isJetpackSsoMatchEmailEnabled() {
<span class="nc" id="L674">        return mJpSettings.ssoMatchEmail;</span>
    }

    public void enableJetpackSsoTwoFactor(boolean enabled) {
<span class="nc" id="L678">        mJpSettings.ssoRequireTwoFactor = enabled;</span>
<span class="nc" id="L679">    }</span>

    public boolean isJetpackSsoTwoFactorEnabled() {
<span class="nc" id="L682">        return mJpSettings.ssoRequireTwoFactor;</span>
    }

    void enableServeImagesFromOurServers(boolean enabled) {
<span class="nc" id="L686">        mJpSettings.serveImagesFromOurServers = enabled;</span>
<span class="nc" id="L687">    }</span>

    boolean isServeImagesFromOurServersEnabled() {
<span class="nc" id="L690">        return mJpSettings.serveImagesFromOurServers;</span>
    }

    void enableServeStaticFilesFromOurServers(boolean enabled) {
<span class="nc" id="L694">        mJpSettings.serveStaticFilesFromOurServers = enabled;</span>
<span class="nc" id="L695">    }</span>

    boolean isServeStaticFilesFromOurServersEnabled() {
<span class="nc" id="L698">        return mJpSettings.serveStaticFilesFromOurServers;</span>
    }

    void enableLazyLoadImages(boolean enabled) {
<span class="nc" id="L702">        mJpSettings.lazyLoadImages = enabled;</span>
<span class="nc" id="L703">    }</span>

    boolean isLazyLoadImagesEnabled() {
<span class="nc" id="L706">        return mJpSettings.lazyLoadImages;</span>
    }

    void enableAdFreeHosting(boolean enabled) {
<span class="nc" id="L710">        mJpSettings.adFreeVideoHosting = enabled;</span>
<span class="nc" id="L711">    }</span>

    boolean isAdFreeHostingEnabled() {
<span class="nc" id="L714">        return mJpSettings.adFreeVideoHosting;</span>
    }

    void enableImprovedSearch(boolean enabled) {
<span class="nc" id="L718">        mJpSettings.improvedSearch = enabled;</span>
<span class="nc" id="L719">    }</span>

    boolean isImprovedSearchEnabled() {
<span class="nc" id="L722">        return mJpSettings.improvedSearch;</span>
    }

    public boolean isSharingModuleEnabled() {
<span class="nc" id="L726">        return mJpSettings.sharingEnabled;</span>
    }

    public void setTitle(String title) {
<span class="nc" id="L730">        mSettings.title = title;</span>
<span class="nc" id="L731">    }</span>

    public void setTagline(String tagline) {
<span class="nc" id="L734">        mSettings.tagline = tagline;</span>
<span class="nc" id="L735">    }</span>

    public void setAddress(String address) {
<span class="nc" id="L738">        mSettings.address = address;</span>
<span class="nc" id="L739">    }</span>

    public void setQuotaDiskSpace(String quotaDiskSpace) {
<span class="nc" id="L742">        mSettings.quotaDiskSpace = quotaDiskSpace;</span>
<span class="nc" id="L743">    }</span>

    public void setPrivacy(int privacy) {
<span class="nc" id="L746">        mSettings.privacy = privacy;</span>
<span class="nc" id="L747">    }</span>

    public boolean setLanguageCode(String languageCode) {
<span class="nc bnc" id="L750" title="All 2 branches missed.">        if (!mLanguageCodes.containsKey(languageCode)</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">            || TextUtils.isEmpty(mLanguageCodes.get(languageCode))) {</span>
<span class="nc" id="L752">            return false;</span>
        }
<span class="nc" id="L754">        mSettings.language = languageCode;</span>
<span class="nc" id="L755">        mSettings.languageId = Integer.valueOf(mLanguageCodes.get(languageCode));</span>
<span class="nc" id="L756">        return true;</span>
    }

    public void setLanguageId(int languageId) {
        // want to prevent O(n) language code lookup if there is no change
<span class="nc bnc" id="L761" title="All 2 branches missed.">        if (mSettings.languageId != languageId) {</span>
<span class="nc" id="L762">            mSettings.languageId = languageId;</span>
<span class="nc" id="L763">            mSettings.language = languageIdToLanguageCode(Integer.toString(languageId));</span>
        }
<span class="nc" id="L765">    }</span>

    public void setSiteIconMediaId(int siteIconMediaId) {
<span class="nc" id="L768">        mSettings.siteIconMediaId = siteIconMediaId;</span>
<span class="nc" id="L769">    }</span>


    public void setUsername(String username) {
<span class="nc" id="L773">        mSettings.username = username;</span>
<span class="nc" id="L774">    }</span>

    public void setPassword(String password) {
<span class="nc" id="L777">        mSettings.password = password;</span>
<span class="nc" id="L778">    }</span>

    public void setAllowComments(boolean allowComments) {
<span class="nc" id="L781">        mSettings.allowComments = allowComments;</span>
<span class="nc" id="L782">    }</span>

    public void setSendPingbacks(boolean sendPingbacks) {
<span class="nc" id="L785">        mSettings.sendPingbacks = sendPingbacks;</span>
<span class="nc" id="L786">    }</span>

    public void setReceivePingbacks(boolean receivePingbacks) {
<span class="nc" id="L789">        mSettings.receivePingbacks = receivePingbacks;</span>
<span class="nc" id="L790">    }</span>

    public void setShouldCloseAfter(boolean shouldCloseAfter) {
<span class="nc" id="L793">        mSettings.shouldCloseAfter = shouldCloseAfter;</span>
<span class="nc" id="L794">    }</span>

    public void setCloseAfter(int period) {
<span class="nc" id="L797">        mSettings.closeCommentAfter = period;</span>
<span class="nc" id="L798">    }</span>

    public void setCommentSorting(int method) {
<span class="nc" id="L801">        mSettings.sortCommentsBy = method;</span>
<span class="nc" id="L802">    }</span>

    public void setShouldThreadComments(boolean shouldThread) {
<span class="nc" id="L805">        mSettings.shouldThreadComments = shouldThread;</span>
<span class="nc" id="L806">    }</span>

    public void setThreadingLevels(int levels) {
<span class="nc" id="L809">        mSettings.threadingLevels = levels;</span>
<span class="nc" id="L810">    }</span>

    public void setShouldPageComments(boolean shouldPage) {
<span class="nc" id="L813">        mSettings.shouldPageComments = shouldPage;</span>
<span class="nc" id="L814">    }</span>

    public void setPagingCount(int count) {
<span class="nc" id="L817">        mSettings.commentsPerPage = count;</span>
<span class="nc" id="L818">    }</span>

    public void setManualApproval(boolean required) {
<span class="nc" id="L821">        mSettings.commentApprovalRequired = required;</span>
<span class="nc" id="L822">    }</span>

    public void setIdentityRequired(boolean required) {
<span class="nc" id="L825">        mSettings.commentsRequireIdentity = required;</span>
<span class="nc" id="L826">    }</span>

    public void setUserAccountRequired(boolean required) {
<span class="nc" id="L829">        mSettings.commentsRequireUserAccount = required;</span>
<span class="nc" id="L830">    }</span>

    public void setUseCommentAllowlist(boolean useAllowlist) {
<span class="nc" id="L833">        mSettings.commentAutoApprovalKnownUsers = useAllowlist;</span>
<span class="nc" id="L834">    }</span>

    public void setMultipleLinks(int count) {
<span class="nc" id="L837">        mSettings.maxLinks = count;</span>
<span class="nc" id="L838">    }</span>

    public void setModerationKeys(List&lt;String&gt; keys) {
<span class="nc" id="L841">        mSettings.holdForModeration = keys;</span>
<span class="nc" id="L842">    }</span>

    public void setDenylistKeys(List&lt;String&gt; keys) {
<span class="nc" id="L845">        mSettings.denylist = keys;</span>
<span class="nc" id="L846">    }</span>

    public void setSharingLabel(String sharingLabel) {
<span class="nc" id="L849">        mSettings.sharingLabel = sharingLabel;</span>
<span class="nc" id="L850">    }</span>

    public void setSharingButtonStyle(String sharingButtonStyle) {
<span class="nc bnc" id="L853" title="All 2 branches missed.">        if (TextUtils.isEmpty(sharingButtonStyle)) {</span>
<span class="nc" id="L854">            mSettings.sharingButtonStyle = STANDARD_SHARING_BUTTON_STYLE;</span>
        } else {
<span class="nc" id="L856">            mSettings.sharingButtonStyle = sharingButtonStyle.toLowerCase(Locale.ROOT);</span>
        }
<span class="nc" id="L858">    }</span>

    public void setAllowReblogButton(boolean allowReblogButton) {
<span class="nc" id="L861">        mSettings.allowReblogButton = allowReblogButton;</span>
<span class="nc" id="L862">    }</span>

    public void setAllowLikeButton(boolean allowLikeButton) {
<span class="nc" id="L865">        mSettings.allowLikeButton = allowLikeButton;</span>
<span class="nc" id="L866">    }</span>

    public void setAllowCommentLikes(boolean allowCommentLikes) {
        // We have different settings for comment likes for wpcom and Jetpack sites
<span class="nc bnc" id="L870" title="All 2 branches missed.">        if (mSite.isJetpackConnected()) {</span>
<span class="nc" id="L871">            mJpSettings.commentLikes = allowCommentLikes;</span>
        } else {
<span class="nc" id="L873">            mSettings.allowCommentLikes = allowCommentLikes;</span>
        }
<span class="nc" id="L875">    }</span>

    public void setTwitterUsername(String twitterUsername) {
<span class="nc" id="L878">        mSettings.twitterUsername = twitterUsername;</span>
<span class="nc" id="L879">    }</span>

    public void setDefaultCategory(int category) {
<span class="nc" id="L882">        mSettings.defaultCategory = category;</span>
<span class="nc" id="L883">    }</span>

    /**
     * Sets the default post format.
     *
     * @param format if null or empty default format is set to {@link SiteSettingsInterface#STANDARD_POST_FORMAT_KEY}
     */
    public void setDefaultFormat(String format) {
<span class="nc bnc" id="L891" title="All 2 branches missed.">        if (TextUtils.isEmpty(format)) {</span>
<span class="nc" id="L892">            mSettings.defaultPostFormat = STANDARD_POST_FORMAT_KEY;</span>
        } else {
<span class="nc" id="L894">            mSettings.defaultPostFormat = format.toLowerCase(Locale.ROOT);</span>
        }
<span class="nc" id="L896">    }</span>

    public void setShowRelatedPosts(boolean relatedPosts) {
<span class="nc" id="L899">        mSettings.showRelatedPosts = relatedPosts;</span>
<span class="nc" id="L900">    }</span>

    public void setShowRelatedPostHeader(boolean showHeader) {
<span class="nc" id="L903">        mSettings.showRelatedPostHeader = showHeader;</span>
<span class="nc" id="L904">    }</span>

    public void setShowRelatedPostImages(boolean showImages) {
<span class="nc" id="L907">        mSettings.showRelatedPostImages = showImages;</span>
<span class="nc" id="L908">    }</span>

    /**
     * Determines if the current Moderation Hold list contains a given value.
     */
    public boolean moderationHoldListContains(String value) {
<span class="nc" id="L914">        return getModerationKeys().contains(value);</span>
    }

    /**
     * Determines if the current Denylist list contains a given value.
     */
    public boolean denylistListContains(String value) {
<span class="nc" id="L921">        return getDenylistKeys().contains(value);</span>
    }

    /**
     * Checks if the provided list of post format IDs is the same (order dependent) as the current
     * list of Post Formats in the local settings object.
     *
     * @param ids an array of post format IDs
     * @return true unless the provided IDs are different from the current IDs or in a different order
     */
    public boolean isSameFormatList(CharSequence[] ids) {
<span class="nc bnc" id="L932" title="All 2 branches missed.">        if (ids == null) {</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">            return mSettings.postFormats == null;</span>
        }
<span class="nc bnc" id="L935" title="All 4 branches missed.">        if (mSettings.postFormats == null || ids.length != mSettings.postFormats.size()) {</span>
<span class="nc" id="L936">            return false;</span>
        }

<span class="nc" id="L939">        String[] keys = mSettings.postFormats.keySet().toArray(new String[mSettings.postFormats.size()]);</span>
<span class="nc bnc" id="L940" title="All 2 branches missed.">        for (int i = 0; i &lt; ids.length; ++i) {</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">            if (!keys[i].equals(ids[i])) {</span>
<span class="nc" id="L942">                return false;</span>
            }
        }

<span class="nc" id="L946">        return true;</span>
    }

    /**
     * Checks if the provided list of category IDs is the same (order dependent) as the current
     * list of Categories in the local settings object.
     *
     * @param ids an array of integers stored as Strings (for convenience)
     * @return true unless the provided IDs are different from the current IDs or in a different order
     */
    public boolean isSameCategoryList(CharSequence[] ids) {
<span class="nc bnc" id="L957" title="All 2 branches missed.">        if (ids == null) {</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">            return mSettings.categories == null;</span>
        }
<span class="nc bnc" id="L960" title="All 4 branches missed.">        if (mSettings.categories == null || ids.length != mSettings.categories.length) {</span>
<span class="nc" id="L961">            return false;</span>
        }

<span class="nc bnc" id="L964" title="All 2 branches missed.">        for (int i = 0; i &lt; ids.length; ++i) {</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">            if (Integer.valueOf(ids[i].toString()) != mSettings.categories[i].id) {</span>
<span class="nc" id="L966">                return false;</span>
            }
        }

<span class="nc" id="L970">        return true;</span>
    }

    /**
     * Needed so that subclasses can be created before initializing. The final member variables
     * are null until object has been created so XML-RPC callbacks will not run.
     *
     * @return itself
     */
    public SiteSettingsInterface init(boolean fetchRemote) {
<span class="nc" id="L980">        loadCachedSettings();</span>

<span class="nc bnc" id="L982" title="All 2 branches missed.">        if (fetchRemote) {</span>
<span class="nc" id="L983">            fetchRemoteData();</span>
<span class="nc" id="L984">            mDispatcher.dispatch(SiteActionBuilder.newFetchPostFormatsAction(mSite));</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">            if (!AppPrefs.isDefaultAppWideEditorPreferenceSet()) {</span>
                // Check if the migration from app-wide to per-site setting has already happened - v12.9-&gt;13.0
                // before fetching site editors from the remote
<span class="nc" id="L988">                mDispatcher.dispatch(SiteActionBuilder.newFetchSiteEditorsAction(mSite));</span>
            }
        }

<span class="nc" id="L992">        return this;</span>
    }

    /**
     * If there is a change in verification status the listener is notified.
     */
    protected void credentialsVerified(boolean valid) {
<span class="nc bnc" id="L999" title="All 2 branches missed.">        Exception e = valid ? null : new AuthenticationError();</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">        if (mSettings.hasVerifiedCredentials != valid) {</span>
<span class="nc" id="L1001">            notifyCredentialsVerifiedOnUiThread(e);</span>
        }
<span class="nc" id="L1003">        mRemoteSettings.hasVerifiedCredentials = mSettings.hasVerifiedCredentials = valid;</span>
<span class="nc" id="L1004">    }</span>

    /**
     * Language IDs, used only by WordPress, are integer values that map to a language code.
     * http://bit.ly/2H7gksN
     * &lt;p&gt;
     * Language codes are unique two-letter identifiers defined by ISO 639-1. Region dialects can
     * be defined by appending a -** where ** is the region code (en-GB -&gt; English, Great Britain).
     * https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes
     */
    protected String languageIdToLanguageCode(String id) {
<span class="nc bnc" id="L1015" title="All 2 branches missed.">        if (id != null) {</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">            for (String key : mLanguageCodes.keySet()) {</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">                if (id.equals(mLanguageCodes.get(key))) {</span>
<span class="nc" id="L1018">                    return key;</span>
                }
<span class="nc" id="L1020">            }</span>
        }

<span class="nc" id="L1023">        return &quot;&quot;;</span>
    }

    /**
     * Need to defer loading the cached settings to a thread so it completes after initialization.
     */
    private void loadCachedSettings() {
<span class="nc" id="L1030">        Cursor localSettings = SiteSettingsTable.getSettings(mSite.getId());</span>

<span class="nc bnc" id="L1032" title="All 4 branches missed.">        if (localSettings != null &amp;&amp; localSettings.getCount() &gt; 0) {</span>
<span class="nc" id="L1033">            mSettings.isInLocalTable = true;</span>
<span class="nc" id="L1034">            SparseArrayCompat&lt;CategoryModel&gt; cachedModels = SiteSettingsTable.getAllCategories();</span>
<span class="nc" id="L1035">            mSettings.deserializeOptionsDatabaseCursor(localSettings, cachedModels);</span>
<span class="nc" id="L1036">            mSettings.language = languageIdToLanguageCode(Integer.toString(mSettings.languageId));</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">            if (mSettings.language == null) {</span>
<span class="nc" id="L1038">                setLanguageCode(LanguageUtils.getPatchedCurrentDeviceLanguage(null));</span>
            }
<span class="nc" id="L1040">            mRemoteSettings.language = mSettings.language;</span>
<span class="nc" id="L1041">            mRemoteSettings.languageId = mSettings.languageId;</span>
<span class="nc" id="L1042">            mRemoteSettings.siteIconMediaId = mSettings.siteIconMediaId;</span>
<span class="nc" id="L1043">        } else {</span>
<span class="nc" id="L1044">            mSettings.isInLocalTable = false;</span>
<span class="nc" id="L1045">            mSettings.localTableId = mSite.getId();</span>
<span class="nc" id="L1046">            setAddress(mSite.getUrl());</span>
<span class="nc" id="L1047">            setUsername(mSite.getUsername());</span>
<span class="nc" id="L1048">            setPassword(mSite.getPassword());</span>
<span class="nc" id="L1049">            setTitle(mSite.getName());</span>
        }
        // Quota information always comes from the main site table
<span class="nc bnc" id="L1052" title="All 2 branches missed.">        if (mSite.hasDiskSpaceQuotaInformation()) {</span>
<span class="nc" id="L1053">            String percentage = FormatUtils.formatPercentage(mSite.getSpacePercentUsed() / 100);</span>
<span class="nc" id="L1054">            final String[] units = new String[]{mResourceProvider.getString(R.string.file_size_in_bytes),</span>
<span class="nc" id="L1055">                    mResourceProvider.getString(R.string.file_size_in_kilobytes),</span>
<span class="nc" id="L1056">                    mResourceProvider.getString(R.string.file_size_in_megabytes),</span>
<span class="nc" id="L1057">                    mResourceProvider.getString(R.string.file_size_in_gigabytes),</span>
<span class="nc" id="L1058">                    mResourceProvider.getString(R.string.file_size_in_terabytes)};</span>

            String quotaAvailableSentence;
<span class="nc bnc" id="L1061" title="All 2 branches missed.">            if (mSite.getPlanId() == PlansConstants.BUSINESS_PLAN_ID) {</span>
<span class="nc" id="L1062">                String usedSpace = FormatUtils.formatFileSize(mSite.getSpaceUsed(), units);</span>
<span class="nc" id="L1063">                quotaAvailableSentence =</span>
<span class="nc" id="L1064">                        String.format(mResourceProvider.getString(R.string.site_settings_quota_space_unlimited),</span>
                                usedSpace);
<span class="nc" id="L1066">            } else {</span>
<span class="nc" id="L1067">                String spaceAllowed = FormatUtils.formatFileSize(mSite.getSpaceAllowed(), units);</span>
<span class="nc" id="L1068">                quotaAvailableSentence =</span>
<span class="nc" id="L1069">                        String.format(mResourceProvider.getString(R.string.site_settings_quota_space_value),</span>
                                percentage, spaceAllowed);
            }
<span class="nc" id="L1072">            setQuotaDiskSpace(quotaAvailableSentence);</span>
        }
        // Self hosted always read account data from the main table
<span class="nc bnc" id="L1075" title="All 2 branches missed.">        if (!SiteUtils.isAccessedViaWPComRest(mSite)) {</span>
<span class="nc" id="L1076">            setUsername(mSite.getUsername());</span>
<span class="nc" id="L1077">            setPassword(mSite.getPassword());</span>
        }

<span class="nc bnc" id="L1080" title="All 2 branches missed.">        if (localSettings != null) {</span>
<span class="nc" id="L1081">            localSettings.close();</span>
        }
<span class="nc" id="L1083">        notifyUpdatedOnUiThread();</span>
<span class="nc" id="L1084">    }</span>

    /**
     * Notifies listener that credentials have been validated or are incorrect.
     */
    private void notifyCredentialsVerifiedOnUiThread(final Exception error) {
<span class="nc bnc" id="L1090" title="All 4 branches missed.">        if (mResourceProvider == null || mListener == null) {</span>
<span class="nc" id="L1091">            return;</span>
        }

<span class="nc" id="L1094">        new Handler().post(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L1097">                mListener.onCredentialsValidated(error);</span>
<span class="nc" id="L1098">            }</span>
        });
<span class="nc" id="L1100">    }</span>

    protected void notifyFetchErrorOnUiThread(final Exception error) {
<span class="nc bnc" id="L1103" title="All 2 branches missed.">        if (mListener == null) {</span>
<span class="nc" id="L1104">            return;</span>
        }

<span class="nc" id="L1107">        new Handler().post(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L1110">                mListener.onFetchError(error);</span>
<span class="nc" id="L1111">            }</span>
        });
<span class="nc" id="L1113">    }</span>

    protected void notifySaveErrorOnUiThread(final Exception error) {
<span class="nc bnc" id="L1116" title="All 2 branches missed.">        if (mListener == null) {</span>
<span class="nc" id="L1117">            return;</span>
        }

<span class="nc" id="L1120">        new Handler().post(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L1123">                mListener.onSaveError(error);</span>
<span class="nc" id="L1124">            }</span>
        });
<span class="nc" id="L1126">    }</span>

    /**
     * Notifies listener that settings have been updated with the latest remote data.
     */
    protected void notifyUpdatedOnUiThread() {
<span class="nc bnc" id="L1132" title="All 2 branches missed.">        if (mListener == null) {</span>
<span class="nc" id="L1133">            return;</span>
        }

<span class="nc" id="L1136">        new Handler().post(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L1139">                mListener.onSettingsUpdated();</span>
<span class="nc" id="L1140">            }</span>
        });
<span class="nc" id="L1142">    }</span>

    /**
     * Notifies listener that settings have been saved or an error occurred while saving.
     */
    protected void notifySavedOnUiThread() {
<span class="nc bnc" id="L1148" title="All 2 branches missed.">        if (mListener == null) {</span>
<span class="nc" id="L1149">            return;</span>
        }

<span class="nc" id="L1152">        new Handler().post(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L1155">                mListener.onSettingsSaved();</span>
<span class="nc" id="L1156">            }</span>
        });
<span class="nc" id="L1158">    }</span>

    // FluxC OnChanged events

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPostFormatsChanged(OnPostFormatsChanged event) {
<span class="nc bnc" id="L1165" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1166">            AppLog.e(T.SETTINGS, &quot;An error occurred while updating the post formats with type: &quot; + event.error.type);</span>
<span class="nc" id="L1167">            return;</span>
        }
<span class="nc" id="L1169">        AppLog.v(T.SETTINGS, &quot;Post formats successfully fetched!&quot;);</span>
<span class="nc" id="L1170">        notifyUpdatedOnUiThread();</span>
<span class="nc" id="L1171">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onSiteEditorsChanged(OnSiteEditorsChanged event) {
        // When the site editor details are loaded from the remote backend, make sure to set a default if empty
<span class="nc bnc" id="L1177" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1178">            return;</span>
        }
<span class="nc" id="L1180">        updateAnalyticsAndUI();</span>
<span class="nc" id="L1181">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAllSitesMobileEditorChanged(OnAllSitesMobileEditorChanged event) {
<span class="nc bnc" id="L1186" title="All 2 branches missed.">        if (event.isError()) {</span>
<span class="nc" id="L1187">            return;</span>
        }
<span class="nc bnc" id="L1189" title="All 2 branches missed.">        if (event.isNetworkResponse) {</span>
            // We can remove the global app setting now, since we're sure the migration ended with success.
<span class="nc" id="L1191">            AppPrefs.removeAppWideEditorPreference();</span>
        }
<span class="nc" id="L1193">        updateAnalyticsAndUI();</span>
<span class="nc" id="L1194">    }</span>

    private void updateAnalyticsAndUI() {
        // Need to update the user property about GB enabled on any of the sites
<span class="nc" id="L1198">        AnalyticsUtils.refreshMetadata(mAccountStore, mSiteStore);</span>

<span class="nc" id="L1200">        notifyUpdatedOnUiThread();</span>
<span class="nc" id="L1201">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>