<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NestedWebView.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.widgets</a> &gt; <span class="el_source">NestedWebView.kt</span></div><h1>NestedWebView.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.widgets

import android.R.attr
import android.annotation.SuppressLint
import android.content.Context
import android.util.AttributeSet
import android.view.MotionEvent
import androidx.core.view.MotionEventCompat
import androidx.core.view.NestedScrollingChild3
import androidx.core.view.NestedScrollingChildHelper
import androidx.core.view.ViewCompat
import org.wordpress.android.ui.WPWebView

/**
 * To make WebView work with AppBar in Coordinator layout we need to put into a NestedScrollView
 * Which leads to some issues related to scrolling, and while majority of them could be solved through modifying layout
 * hierarchy, some are not so easily fixable.
 *
 * NestedWebView implements nested scroll properties and works well inside NestedScrollView.
 *
 * Variation of https://stackoverflow.com/a/45026679/569430 with NestedScrollingChild3
 */
<span class="nc" id="L23">class NestedWebView @JvmOverloads constructor(</span>
    context: Context,
<span class="nc" id="L25">    attrs: AttributeSet? = null,</span>
<span class="nc" id="L26">    defStyleAttr: Int = attr.webViewStyle</span>
<span class="nc" id="L27">) : WPWebView(context, attrs, defStyleAttr), NestedScrollingChild3 {</span>
    private var lastY = 0
<span class="nc" id="L29">    private val scrollOffset = IntArray(2)</span>
<span class="nc" id="L30">    private val scrollConsumed = IntArray(2)</span>
    private var nestedOffsetY = 0
<span class="nc" id="L32">    private val nestedScrollingChildHelper: NestedScrollingChildHelper = NestedScrollingChildHelper(this)</span>

    @SuppressLint(&quot;ClickableViewAccessibility&quot;)
    override fun onTouchEvent(ev: MotionEvent): Boolean {
<span class="nc" id="L36">        var returnValue = false</span>
<span class="nc" id="L37">        val event = MotionEvent.obtain(ev)</span>
<span class="nc" id="L38">        val action = MotionEventCompat.getActionMasked(event)</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">        if (action == MotionEvent.ACTION_DOWN) {</span>
<span class="nc" id="L40">            nestedOffsetY = 0</span>
        }
<span class="nc" id="L42">        val eventY = event.y.toInt()</span>
<span class="nc" id="L43">        event.offsetLocation(0f, nestedOffsetY.toFloat())</span>
<span class="nc bnc" id="L44" title="All 4 branches missed.">        when (action) {</span>
            MotionEvent.ACTION_MOVE -&gt; {
<span class="nc" id="L46">                var totalScrollOffset = 0</span>
<span class="nc" id="L47">                var deltaY = lastY - eventY</span>
                // NestedPreScroll
<span class="nc bnc" id="L49" title="All 2 branches missed.">                if (dispatchNestedPreScroll(0, deltaY, scrollConsumed, scrollOffset)) {</span>
<span class="nc" id="L50">                    totalScrollOffset += scrollOffset[1]</span>
<span class="nc" id="L51">                    deltaY -= scrollConsumed[1]</span>
<span class="nc" id="L52">                    event.offsetLocation(0f, (-scrollOffset[1]).toFloat())</span>
<span class="nc" id="L53">                    nestedOffsetY += scrollOffset[1]</span>
                }
<span class="nc" id="L55">                returnValue = super.onTouchEvent(event)</span>

                // NestedScroll
<span class="nc bnc" id="L58" title="All 2 branches missed.">                if (dispatchNestedScroll(0, scrollOffset[1], 0, deltaY, scrollOffset)) {</span>
<span class="nc" id="L59">                    totalScrollOffset += scrollOffset[1]</span>
<span class="nc" id="L60">                    event.offsetLocation(0f, scrollOffset[1].toFloat())</span>
<span class="nc" id="L61">                    nestedOffsetY += scrollOffset[1]</span>
<span class="nc" id="L62">                    lastY -= scrollOffset[1]</span>
                }
<span class="nc" id="L64">                lastY = eventY - totalScrollOffset</span>
            }
            MotionEvent.ACTION_DOWN -&gt; {
<span class="nc" id="L67">                returnValue = super.onTouchEvent(event)</span>
<span class="nc" id="L68">                lastY = eventY</span>
                // start NestedScroll
<span class="nc" id="L70">                startNestedScroll(ViewCompat.SCROLL_AXIS_VERTICAL)</span>
            }
            MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -&gt; {
                // end NestedScroll
<span class="nc" id="L74">                stopNestedScroll()</span>
<span class="nc" id="L75">                returnValue = super.onTouchEvent(event)</span>
            }
        }
<span class="nc" id="L78">        return returnValue</span>
    }

    override fun setNestedScrollingEnabled(enabled: Boolean) {
<span class="nc" id="L82">        nestedScrollingChildHelper.isNestedScrollingEnabled = enabled</span>
<span class="nc" id="L83">    }</span>

    override fun isNestedScrollingEnabled(): Boolean {
<span class="nc" id="L86">        return nestedScrollingChildHelper.isNestedScrollingEnabled</span>
    }

    override fun startNestedScroll(axes: Int, type: Int): Boolean {
<span class="nc" id="L90">        return nestedScrollingChildHelper.startNestedScroll(axes, type)</span>
    }

    override fun startNestedScroll(axes: Int): Boolean {
<span class="nc" id="L94">        return nestedScrollingChildHelper.startNestedScroll(axes)</span>
    }

    override fun stopNestedScroll(type: Int) {
<span class="nc" id="L98">        nestedScrollingChildHelper.stopNestedScroll(type)</span>
<span class="nc" id="L99">    }</span>

    override fun stopNestedScroll() {
<span class="nc" id="L102">        nestedScrollingChildHelper.stopNestedScroll()</span>
<span class="nc" id="L103">    }</span>

    override fun hasNestedScrollingParent(type: Int): Boolean {
<span class="nc" id="L106">        return nestedScrollingChildHelper.hasNestedScrollingParent(type)</span>
    }

    override fun hasNestedScrollingParent(): Boolean {
<span class="nc" id="L110">        return nestedScrollingChildHelper.hasNestedScrollingParent()</span>
    }

    override fun dispatchNestedScroll(
        dxConsumed: Int,
        dyConsumed: Int,
        dxUnconsumed: Int,
        dyUnconsumed: Int,
        offsetInWindow: IntArray?,
        type: Int,
        consumed: IntArray
    ) {
<span class="nc" id="L122">        nestedScrollingChildHelper.dispatchNestedScroll(</span>
<span class="nc" id="L123">                dxConsumed,</span>
<span class="nc" id="L124">                dyConsumed,</span>
<span class="nc" id="L125">                dxUnconsumed,</span>
<span class="nc" id="L126">                dyUnconsumed,</span>
<span class="nc" id="L127">                offsetInWindow,</span>
<span class="nc" id="L128">                type,</span>
<span class="nc" id="L129">                consumed</span>
        )
<span class="nc" id="L131">    }</span>

    override fun dispatchNestedScroll(
        dxConsumed: Int,
        dyConsumed: Int,
        dxUnconsumed: Int,
        dyUnconsumed: Int,
        offsetInWindow: IntArray?,
        type: Int
    ): Boolean {
<span class="nc" id="L141">        return nestedScrollingChildHelper.dispatchNestedScroll(</span>
<span class="nc" id="L142">                dxConsumed,</span>
<span class="nc" id="L143">                dyConsumed,</span>
<span class="nc" id="L144">                dxUnconsumed,</span>
<span class="nc" id="L145">                dyUnconsumed,</span>
<span class="nc" id="L146">                offsetInWindow,</span>
<span class="nc" id="L147">                type</span>
        )
    }

    override fun dispatchNestedScroll(
        dxConsumed: Int,
        dyConsumed: Int,
        dxUnconsumed: Int,
        dyUnconsumed: Int,
        offsetInWindow: IntArray?
    ): Boolean {
<span class="nc" id="L158">        return nestedScrollingChildHelper.dispatchNestedScroll(</span>
<span class="nc" id="L159">                dxConsumed,</span>
<span class="nc" id="L160">                dyConsumed,</span>
<span class="nc" id="L161">                dxUnconsumed,</span>
<span class="nc" id="L162">                dyUnconsumed,</span>
<span class="nc" id="L163">                offsetInWindow</span>
        )
    }

    override fun dispatchNestedPreScroll(
        dx: Int,
        dy: Int,
        consumed: IntArray?,
        offsetInWindow: IntArray?,
        type: Int
    ): Boolean {
<span class="nc" id="L174">        return nestedScrollingChildHelper.dispatchNestedPreScroll(dx, dy, consumed, offsetInWindow, type)</span>
    }

    override fun dispatchNestedPreScroll(dx: Int, dy: Int, consumed: IntArray?, offsetInWindow: IntArray?): Boolean {
<span class="nc" id="L178">        return nestedScrollingChildHelper.dispatchNestedPreScroll(dx, dy, consumed, offsetInWindow)</span>
    }

    override fun dispatchNestedFling(velocityX: Float, velocityY: Float, consumed: Boolean): Boolean {
<span class="nc" id="L182">        return nestedScrollingChildHelper.dispatchNestedFling(velocityX, velocityY, consumed)</span>
    }

    override fun dispatchNestedPreFling(velocityX: Float, velocityY: Float): Boolean {
<span class="nc" id="L186">        return nestedScrollingChildHelper.dispatchNestedPreFling(velocityX, velocityY)</span>
    }

<span class="nc" id="L189">    init {</span>
<span class="nc" id="L190">        isNestedScrollingEnabled = true</span>
<span class="nc" id="L191">    }</span>
<span class="nc" id="L192">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>