<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BloggingPromptsOnboardingDialogFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.bloggingprompts.onboarding</a> &gt; <span class="el_source">BloggingPromptsOnboardingDialogFragment.kt</span></div><h1>BloggingPromptsOnboardingDialogFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.bloggingprompts.onboarding

import android.app.Activity
import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.view.View
import androidx.activity.result.contract.ActivityResultContracts.StartActivityForResult
import androidx.core.text.bold
import androidx.core.text.buildSpannedString
import androidx.lifecycle.ViewModelProvider
import com.google.android.flexbox.FlexDirection
import com.google.android.flexbox.FlexWrap
import com.google.android.flexbox.FlexboxLayoutManager
import com.google.android.flexbox.JustifyContent
import com.google.android.material.snackbar.Snackbar
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.databinding.BloggingPromptsOnboardingDialogContentViewBinding
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.avatars.AVATAR_LEFT_OFFSET_DIMEN
import org.wordpress.android.ui.avatars.AvatarItemDecorator
import org.wordpress.android.ui.avatars.TrainOfAvatarsAdapter
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingAction.DismissDialog
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingAction.DoNothing
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingAction.OpenEditor
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingAction.OpenRemindersIntro
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingAction.OpenSitePicker
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingDialogFragment.DialogType.ONBOARDING
import org.wordpress.android.ui.bloggingprompts.onboarding.BloggingPromptsOnboardingUiState.Ready
import org.wordpress.android.ui.featureintroduction.FeatureIntroductionDialogFragment
import org.wordpress.android.ui.main.SitePickerActivity
import org.wordpress.android.ui.main.SitePickerAdapter.SitePickerMode.BLOGGING_PROMPTS_MODE
import org.wordpress.android.ui.main.UpdateSelectedSiteListener
import org.wordpress.android.ui.mysite.SelectedSiteRepository
import org.wordpress.android.ui.posts.PostUtils.EntryPoint.BLOGGING_PROMPTS_INTRODUCTION
import org.wordpress.android.util.RtlUtils
import org.wordpress.android.util.SnackbarItem
import org.wordpress.android.util.SnackbarItem.Action
import org.wordpress.android.util.SnackbarItem.Info
import org.wordpress.android.util.SnackbarSequencer
import org.wordpress.android.util.extensions.exhaustive
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.viewmodel.observeEvent
import javax.inject.Inject

<span class="nc" id="L48">class BloggingPromptsOnboardingDialogFragment : FeatureIntroductionDialogFragment() {</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">    @Inject lateinit var imageManager: ImageManager</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">    @Inject lateinit var snackbarSequencer: SnackbarSequencer</span>
    private lateinit var viewModel: BloggingPromptsOnboardingViewModel
    private lateinit var dialogType: DialogType
<span class="nc" id="L53">    private val sitePickerLauncher = registerForActivityResult(StartActivityForResult()) { result -&gt;</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (result.resultCode == Activity.RESULT_OK) {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">            val selectedSiteLocalId = result.data?.getIntExtra(</span>
<span class="nc" id="L56">                    SitePickerActivity.KEY_SITE_LOCAL_ID,</span>
<span class="nc" id="L57">                    SelectedSiteRepository.UNAVAILABLE</span>
<span class="nc" id="L58">            ) ?: SelectedSiteRepository.UNAVAILABLE</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">            viewModel.onSiteSelected(selectedSiteLocalId)</span>
<span class="nc bnc" id="L60" title="All 4 branches missed.">            (activity as? UpdateSelectedSiteListener)?.onUpdateSelectedSiteResult(result.resultCode, result.data)</span>
        }
<span class="nc" id="L62">    }</span>

    enum class DialogType {
<span class="nc" id="L65">        ONBOARDING,</span>
<span class="nc" id="L66">        INFORMATION</span>
    }

    companion object {
        const val TAG = &quot;BLOGGING_PROMPTS_ONBOARDING_DIALOG_FRAGMENT&quot;
        const val KEY_DIALOG_TYPE = &quot;KEY_DIALOG_TYPE&quot;

        @JvmStatic
        fun newInstance(type: DialogType): BloggingPromptsOnboardingDialogFragment =
<span class="nc" id="L75">                BloggingPromptsOnboardingDialogFragment().apply {</span>
<span class="nc" id="L76">                    arguments = Bundle().apply {</span>
<span class="nc" id="L77">                        putSerializable(KEY_DIALOG_TYPE, type)</span>
<span class="nc" id="L78">                    }</span>
<span class="nc" id="L79">                }</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L83">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L84">        viewModel = ViewModelProvider(this, viewModelFactory).get(BloggingPromptsOnboardingViewModel::class.java)</span>
<span class="nc" id="L85">        setupHeaderTitle()</span>
<span class="nc" id="L86">        setupHeaderIcon()</span>
<span class="nc" id="L87">        setupUiStateObserver()</span>
<span class="nc" id="L88">        setupActionObserver()</span>
<span class="nc" id="L89">        setupSnackbarObserver()</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">        viewModel.start(dialogType)</span>
<span class="nc" id="L91">    }</span>

    override fun onAttach(context: Context) {
<span class="nc" id="L94">        super.onAttach(context)</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        arguments?.let {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            dialogType = it.getSerializable(KEY_DIALOG_TYPE) as DialogType</span>
<span class="nc" id="L97">        }</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        (requireActivity().applicationContext as WordPress).component().inject(this)</span>
<span class="nc bnc" id="L99" title="All 6 branches missed.">        if (dialogType == ONBOARDING &amp;&amp; context !is BloggingPromptsReminderSchedulerListener) {</span>
<span class="nc" id="L100">            throw IllegalStateException(</span>
<span class="nc" id="L101">                    &quot;$context must implement ${BloggingPromptsReminderSchedulerListener::class.simpleName}&quot;</span>
            )
        }
<span class="nc" id="L104">    }</span>

    private fun setupHeaderTitle() {
<span class="nc" id="L107">        setHeaderTitle(R.string.blogging_prompts_onboarding_header_title)</span>
<span class="nc" id="L108">    }</span>

    private fun setupHeaderIcon() {
<span class="nc" id="L111">        setHeaderIcon(R.drawable.ic_outline_lightbulb_orange_gradient_40dp)</span>
<span class="nc" id="L112">    }</span>

    private fun setupContent(readyState: Ready) {
<span class="nc" id="L115">        val contentBinding = BloggingPromptsOnboardingDialogContentViewBinding.inflate(layoutInflater)</span>
<span class="nc" id="L116">        setContent(contentBinding.root)</span>
<span class="nc" id="L117">        with(contentBinding) {</span>
<span class="nc" id="L118">            contentTop.text = getString(readyState.contentTopRes)</span>
<span class="nc" id="L119">            cardCoverView.setOnClickListener { /*do nothing*/ }</span>
<span class="nc" id="L120">            promptCard.promptContent.text = getString(readyState.promptRes)</span>

<span class="nc" id="L122">            val layoutManager = FlexboxLayoutManager(</span>
<span class="nc" id="L123">                    context,</span>
<span class="nc" id="L124">                    FlexDirection.ROW,</span>
<span class="nc" id="L125">                    FlexWrap.NOWRAP</span>
<span class="nc" id="L126">            ).apply { justifyContent = JustifyContent.CENTER }</span>
<span class="nc" id="L127">            promptCard.answeredUsersRecycler.addItemDecoration(</span>
<span class="nc" id="L128">                    AvatarItemDecorator(RtlUtils.isRtl(context), requireContext(), AVATAR_LEFT_OFFSET_DIMEN)</span>
            )
<span class="nc" id="L130">            promptCard.answeredUsersRecycler.layoutManager = layoutManager</span>

<span class="nc" id="L132">            val adapter = TrainOfAvatarsAdapter(</span>
<span class="nc" id="L133">                    imageManager,</span>
<span class="nc" id="L134">                    uiHelpers</span>
            )
<span class="nc" id="L136">            promptCard.answeredUsersRecycler.adapter = adapter</span>
<span class="nc" id="L137">            adapter.loadData(readyState.respondents)</span>

<span class="nc" id="L139">            setPrimaryButtonText(readyState.primaryButtonLabel)</span>
<span class="nc" id="L140">            togglePrimaryButtonVisibility(readyState.isPrimaryButtonVisible)</span>
<span class="nc" id="L141">            setPrimaryButtonListener { readyState.onPrimaryButtonClick() }</span>

<span class="nc" id="L143">            setSecondaryButtonText(readyState.secondaryButtonLabel)</span>
<span class="nc" id="L144">            toggleSecondaryButtonVisibility(readyState.isSecondaryButtonVisible)</span>
<span class="nc" id="L145">            setSecondaryButtonListener { readyState.onSecondaryButtonClick() }</span>

<span class="nc" id="L147">            setDismissAnalyticsEvent(Stat.BLOGGING_PROMPTS_INTRODUCTION_SCREEN_DISMISSED, emptyMap())</span>

<span class="nc" id="L149">            contentBottom.text = getString(readyState.contentBottomRes)</span>
<span class="nc" id="L150">            contentNote.text = buildSpannedString {</span>
<span class="nc" id="L151">                bold { append(&quot;${getString(readyState.contentNoteTitle)} &quot;) }</span>
<span class="nc" id="L152">                append(getString(readyState.contentNoteContent))</span>
<span class="nc" id="L153">            }</span>
<span class="nc" id="L154">        }</span>
<span class="nc" id="L155">    }</span>

    private fun setupUiStateObserver() {
<span class="nc bnc" id="L158" title="All 2 branches missed.">        viewModel.uiState.observe(this) { uiState -&gt;</span>
<span class="nc" id="L159">            when (uiState) {</span>
<span class="nc" id="L160">                is Ready -&gt; {</span>
<span class="nc" id="L161">                    setupContent(uiState)</span>
                }
<span class="nc" id="L163">            }.exhaustive</span>
<span class="nc" id="L164">        }</span>
<span class="nc" id="L165">    }</span>

    private fun setupActionObserver() {
<span class="nc bnc" id="L168" title="All 2 branches missed.">        viewModel.action.observe(this) { action -&gt;</span>
<span class="nc" id="L169">            when (action) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                is OpenEditor -&gt; {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                    activity?.let {</span>
<span class="nc" id="L172">                        startActivity(</span>
<span class="nc" id="L173">                                ActivityLauncher.openEditorWithBloggingPrompt(</span>
<span class="nc" id="L174">                                        it, action.promptId, BLOGGING_PROMPTS_INTRODUCTION</span>
                                )
                        )
<span class="nc" id="L177">                    }</span>
                }
<span class="nc bnc" id="L179" title="All 2 branches missed.">                is OpenSitePicker -&gt; {</span>
<span class="nc" id="L180">                    val intent = Intent(context, SitePickerActivity::class.java).apply {</span>
<span class="nc" id="L181">                        putExtra(SitePickerActivity.KEY_SITE_LOCAL_ID, action.selectedSite)</span>
<span class="nc" id="L182">                        putExtra(SitePickerActivity.KEY_SITE_PICKER_MODE, BLOGGING_PROMPTS_MODE)</span>
<span class="nc" id="L183">                    }</span>
<span class="nc" id="L184">                    sitePickerLauncher.launch(intent)</span>
                }
<span class="nc bnc" id="L186" title="All 2 branches missed.">                is OpenRemindersIntro -&gt; {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                    activity?.let {</span>
<span class="nc" id="L188">                        dismiss()</span>
<span class="nc" id="L189">                        (it as BloggingPromptsReminderSchedulerListener)</span>
<span class="nc" id="L190">                                .onSetPromptReminderClick(action.selectedSiteLocalId)</span>
<span class="nc" id="L191">                    }</span>
                }
<span class="nc bnc" id="L193" title="All 2 branches missed.">                is DismissDialog -&gt; {</span>
<span class="nc" id="L194">                    dismiss()</span>
                }
<span class="nc" id="L196">                DoNothing -&gt; {} // noop</span>
<span class="nc" id="L197">            }.exhaustive</span>
<span class="nc" id="L198">        }</span>
<span class="nc" id="L199">    }</span>

    private fun setupSnackbarObserver() {
<span class="nc bnc" id="L202" title="All 2 branches missed.">        viewModel.snackBarMessage.observeEvent(viewLifecycleOwner) { holder -&gt;</span>
<span class="nc" id="L203">            snackbarSequencer.enqueue(</span>
<span class="nc" id="L204">                    SnackbarItem(</span>
<span class="nc" id="L205">                            Info(</span>
<span class="nc" id="L206">                                    view = getSuperBinding().coordinatorLayout,</span>
<span class="nc" id="L207">                                    textRes = holder.message,</span>
<span class="nc" id="L208">                                    duration = Snackbar.LENGTH_LONG</span>
                            ),
<span class="nc bnc" id="L210" title="All 2 branches missed.">                            holder.buttonTitle?.let {</span>
<span class="nc" id="L211">                                Action(</span>
<span class="nc" id="L212">                                        textRes = holder.buttonTitle,</span>
<span class="nc" id="L213">                                        clickListener = { holder.buttonAction() }</span>
                                )
                            },
<span class="nc" id="L216">                            dismissCallback = { _, event -&gt; holder.onDismissAction(event) }</span>
                    )
            )
<span class="nc" id="L219">        }</span>
<span class="nc" id="L220">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>