<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatsUtils.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stats.refresh.utils</a> &gt; <span class="el_source">StatsUtils.kt</span></div><h1>StatsUtils.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stats.refresh.utils

import androidx.annotation.StringRes
import org.wordpress.android.R
import org.wordpress.android.ui.stats.refresh.lists.sections.BlockListItem.BarChartItem.Bar
import org.wordpress.android.ui.stats.refresh.lists.sections.BlockListItem.LineChartItem.Line
import org.wordpress.android.util.LocaleManagerWrapper
import org.wordpress.android.viewmodel.ResourceProvider
import java.text.DecimalFormat
import java.util.TreeMap
import javax.inject.Inject
import kotlin.math.abs

const val ONE_THOUSAND = 1000
const val TEN_THOUSAND = 10000
const val HUNDRED_THOUSAND = 100000
const val MILLION = 1000000

<span class="fc" id="L19">class StatsUtils</span>
<span class="fc" id="L20">@Inject constructor(</span>
<span class="fc" id="L21">    private val resourceProvider: ResourceProvider,</span>
<span class="fc" id="L22">    private val localeManager: LocaleManagerWrapper</span>
) {
<span class="fc" id="L24">    private val suffixes = TreeMap(</span>
<span class="fc" id="L25">            mapOf(</span>
<span class="fc" id="L26">                    1_000L to R.string.suffix_1_000,</span>
<span class="fc" id="L27">                    1_000_000L to R.string.suffix_1_000_000,</span>
<span class="fc" id="L28">                    1_000_000_000L to R.string.suffix_1_000_000_000,</span>
<span class="fc" id="L29">                    1_000_000_000_000L to R.string.suffix_1_000_000_000_000,</span>
<span class="fc" id="L30">                    1_000_000_000_000_000L to R.string.suffix_1_000_000_000_000_000,</span>
<span class="fc" id="L31">                    1_000_000_000_000_000_000L to R.string.suffix_1_000_000_000_000_000_000</span>
            )
    )

<span class="nc" id="L35">    fun toFormattedString(number: Long?, startValue: Int = TEN_THOUSAND): String? {</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">        return number?.let { toFormattedString(it, startValue) }</span>
    }

<span class="nc" id="L39">    fun toFormattedString(number: Long?, startValue: Int = TEN_THOUSAND, defaultValue: String): String {</span>
<span class="nc bnc" id="L40" title="All 4 branches missed.">        return number?.let { toFormattedString(it, startValue) } ?: defaultValue</span>
    }

<span class="nc" id="L43">    fun toFormattedString(number: Double?, startValue: Int = TEN_THOUSAND): String? {</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">        return number?.let { toFormattedString(it, startValue) }</span>
    }

<span class="nc" id="L47">    fun toFormattedString(number: Double?, startValue: Int = TEN_THOUSAND, defaultValue: String): String {</span>
<span class="nc bnc" id="L48" title="All 4 branches missed.">        return number?.let { toFormattedString(it, startValue) } ?: defaultValue</span>
    }

<span class="nc" id="L51">    fun toFormattedString(number: Double, startValue: Int = TEN_THOUSAND): String {</span>
<span class="nc" id="L52">        return number.let {</span>
<span class="nc bnc" id="L53" title="All 4 branches missed.">            if (it &lt; startValue &amp;&amp; it &gt; (startValue * -1)) {</span>
<span class="nc" id="L54">                val formatter = DecimalFormat.getInstance(localeManager.getLocale())</span>
<span class="nc" id="L55">                formatter.maximumFractionDigits = 1</span>
<span class="nc" id="L56">                formatter.minimumFractionDigits = 0</span>
<span class="nc" id="L57">                formatter.format(it)</span>
            } else {
<span class="nc" id="L59">                toFormattedString(it.toLong(), startValue)</span>
            }
        }
    }

<span class="nc" id="L64">    fun toFormattedString(number: Int?, startValue: Int = TEN_THOUSAND): String? {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        return toFormattedString(number?.toLong(), startValue)</span>
    }

<span class="nc" id="L68">    fun toFormattedString(number: Int?, startValue: Int = TEN_THOUSAND, defaultValue: String): String {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        return toFormattedString(number?.toLong(), startValue, defaultValue)</span>
    }

<span class="nc" id="L72">    fun toFormattedString(number: Int, startValue: Int = TEN_THOUSAND): String {</span>
<span class="nc" id="L73">        return toFormattedString(number.toLong(), startValue)</span>
    }

<span class="nc" id="L76">    fun toFormattedString(</span>
        number: Long,
<span class="nc" id="L78">        startValue: Int = TEN_THOUSAND</span>
    ): String {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        val isNegative = number &lt; 0</span>
<span class="nc" id="L81">        val safeNumber = abs(</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                if (number == java.lang.Long.MIN_VALUE) {</span>
<span class="nc" id="L83">                    number + 1</span>
                } else {
<span class="nc" id="L85">                    number</span>
                }
        )
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (safeNumber &lt; startValue) {</span>
<span class="nc" id="L89">            return printNumber(safeNumber, isNegative)</span>
        }

<span class="nc" id="L92">        val e = suffixes.floorEntry(safeNumber)</span>
<span class="nc" id="L93">        val divideBy = e.key</span>
<span class="nc" id="L94">        val suffix = e.value</span>

<span class="nc" id="L96">        val truncated = safeNumber / (divideBy!! / 10)</span>
<span class="nc bnc" id="L97" title="All 6 branches missed.">        val hasDecimal = truncated &lt; 100 &amp;&amp; truncated / 10.0 != (truncated / 10).toDouble()</span>
<span class="nc" id="L98">        return printNumber(truncated, isNegative, suffix, hasDecimal)</span>
    }

<span class="nc" id="L101">    private fun printNumber(</span>
        number: Long,
        isNegative: Boolean,
<span class="nc" id="L104">        suffix: Int? = null,</span>
<span class="nc" id="L105">        hasDecimal: Boolean = false</span>
    ): String {
<span class="nc" id="L107">        val formattedNumber =</span>
<span class="nc" id="L108">                DecimalFormat.getInstance(localeManager.getLocale()).format(</span>
<span class="nc" id="L109">                        when {</span>
<span class="nc bnc" id="L110" title="All 4 branches missed.">                            suffix != null &amp;&amp; hasDecimal -&gt; number / 10.0</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                            suffix != null -&gt; number / 10</span>
<span class="nc" id="L112">                            else -&gt; number</span>
                        }
                )
<span class="nc bnc" id="L115" title="All 2 branches missed.">        return if (suffix != null) {</span>
<span class="nc" id="L116">            resourceProvider.getString(</span>
<span class="nc" id="L117">                    suffix,</span>
<span class="nc" id="L118">                    handleNegativeNumber(</span>
<span class="nc" id="L119">                            formattedNumber,</span>
<span class="nc" id="L120">                            isNegative</span>
                    )
            )
        } else {
<span class="nc" id="L124">            handleNegativeNumber(</span>
<span class="nc" id="L125">                    formattedNumber,</span>
<span class="nc" id="L126">                    isNegative</span>
            )
        }
    }

    private fun handleNegativeNumber(number: String, isNegative: Boolean): String {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        return if (isNegative) {</span>
<span class="nc" id="L133">            resourceProvider.getString(R.string.negative_prefix, number)</span>
        } else {
<span class="nc" id="L135">            number</span>
        }
    }

<span class="nc" id="L139">    fun getBarChartEntryContentDescriptions(</span>
        @StringRes entryType: Int,
        entries: List&lt;Bar&gt;,
<span class="nc" id="L142">        @StringRes overlappingEntryType: Int? = null,</span>
<span class="nc" id="L143">        overlappingEntries: List&lt;Bar&gt;? = null</span>
    ): List&lt;String&gt; {
<span class="nc" id="L145">        val contentDescriptions = mutableListOf&lt;String&gt;()</span>
<span class="nc" id="L146">        entries.forEachIndexed { index, bar -&gt;</span>
<span class="nc" id="L147">            var contentDescription = resourceProvider.getString(</span>
<span class="nc" id="L148">                    R.string.stats_bar_chart_accessibility_entry,</span>
<span class="nc" id="L149">                    bar.label,</span>
<span class="nc" id="L150">                    bar.value,</span>
<span class="nc" id="L151">                    resourceProvider.getString(entryType)</span>
            )

<span class="nc bnc" id="L154" title="All 4 branches missed.">            overlappingEntries?.getOrNull(index)?.let { overlappingBar -&gt;</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                overlappingEntryType?.let {</span>
<span class="nc" id="L156">                    contentDescription += resourceProvider.getString(</span>
<span class="nc" id="L157">                            R.string.stats_bar_chart_accessibility_overlapping_entry,</span>
<span class="nc" id="L158">                            overlappingBar.value,</span>
<span class="nc" id="L159">                            resourceProvider.getString(overlappingEntryType)</span>
                    )
<span class="nc" id="L161">                }</span>
            }

<span class="nc" id="L164">            contentDescriptions.add(contentDescription)</span>
<span class="nc" id="L165">        }</span>
<span class="nc" id="L166">        return contentDescriptions</span>
    }

    fun getLineChartEntryContentDescriptions(
        @StringRes entryType: Int,
        entries: List&lt;Line&gt;
    ): List&lt;String&gt; {
<span class="nc" id="L173">        val contentDescriptions = mutableListOf&lt;String&gt;()</span>
<span class="nc" id="L174">        entries.forEachIndexed { index, bar -&gt;</span>
<span class="nc" id="L175">            val contentDescription = resourceProvider.getString(</span>
<span class="nc" id="L176">                    R.string.stats_bar_chart_accessibility_entry,</span>
<span class="nc" id="L177">                    bar.label,</span>
<span class="nc" id="L178">                    bar.value,</span>
<span class="nc" id="L179">                    resourceProvider.getString(entryType)</span>
            )
<span class="nc" id="L181">            contentDescriptions.add(contentDescription)</span>
<span class="nc" id="L182">        }</span>
<span class="nc" id="L183">        return contentDescriptions</span>
    }

    fun buildChange(
        previousValue: Long?,
        value: Long,
        positive: Boolean,
        isFormattedNumber: Boolean
    ): String? {
<span class="nc bnc" id="L192" title="All 2 branches missed.">        return previousValue?.let {</span>
<span class="nc" id="L193">            val difference = value - previousValue</span>
<span class="nc" id="L194">            val percentage = when (previousValue) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                value -&gt; &quot;0&quot;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                0L -&gt; &quot;âˆž&quot;</span>
<span class="nc" id="L197">                else -&gt; mapLongToString((difference * 100 / previousValue), isFormattedNumber)</span>
            }
<span class="nc" id="L199">            val formattedDifference = mapLongToString(difference, isFormattedNumber)</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (positive) {</span>
<span class="nc" id="L201">                resourceProvider.getString(R.string.stats_traffic_increase, formattedDifference, percentage)</span>
            } else {
<span class="nc" id="L203">                resourceProvider.getString(R.string.stats_traffic_change, formattedDifference, percentage)</span>
            }
        }
    }

    private fun mapLongToString(value: Long, isFormattedNumber: Boolean): String {
<span class="nc" id="L209">        return when (isFormattedNumber) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            true -&gt; toFormattedString(value)</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            false -&gt; value.toString()</span>
        }
    }
}

<span class="nc" id="L216">fun getBarWidth(views: Int, maxViews: Int) = getBarWidth(views.toDouble(), maxViews.toDouble())</span>

<span class="nc" id="L218">fun getBarWidth(views: Long, maxViews: Long) = getBarWidth(views.toDouble(), maxViews.toDouble())</span>

private fun getBarWidth(
    views: Double,
    maxViews: Double
): Int? {
<span class="nc bnc" id="L224" title="All 2 branches missed.">    return if (maxViews &gt; 0) {</span>
<span class="nc" id="L225">        ((views / maxViews) * 100).toInt()</span>
    } else {
<span class="nc" id="L227">        null</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>