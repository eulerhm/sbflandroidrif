<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostListDialogHelper.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts</a> &gt; <span class="el_source">PostListDialogHelper.kt</span></div><h1>PostListDialogHelper.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts

import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker.Stat.UNPUBLISHED_REVISION_DIALOG_LOAD_LOCAL_VERSION_CLICKED
import org.wordpress.android.analytics.AnalyticsTracker.Stat.UNPUBLISHED_REVISION_DIALOG_LOAD_UNPUBLISHED_VERSION_CLICKED
import org.wordpress.android.analytics.AnalyticsTracker.Stat.UNPUBLISHED_REVISION_DIALOG_SHOWN
import org.wordpress.android.fluxc.model.PostModel
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.viewmodel.helpers.DialogHolder

private const val CONFIRM_DELETE_POST_DIALOG_TAG = &quot;CONFIRM_DELETE_POST_DIALOG_TAG&quot;
private const val CONFIRM_RESTORE_TRASHED_POST_DIALOG_TAG = &quot;CONFIRM_RESTORE_TRASHED_POST_DIALOG_TAG&quot;
private const val CONFIRM_TRASH_POST_WITH_LOCAL_CHANGES_DIALOG_TAG = &quot;CONFIRM_TRASH_POST_WITH_LOCAL_CHANGES_DIALOG_TAG&quot;
private const val CONFIRM_TRASH_POST_WITH_UNSAVED_CHANGES_DIALOG_TAG =
        &quot;CONFIRM_TRASH_POST_WITH_UNSAVED_CHANGES_DIALOG_TAG&quot;
private const val CONFIRM_ON_CONFLICT_LOAD_REMOTE_POST_DIALOG_TAG = &quot;CONFIRM_ON_CONFLICT_LOAD_REMOTE_POST_DIALOG_TAG&quot;
private const val CONFIRM_ON_AUTOSAVE_REVISION_DIALOG_TAG = &quot;CONFIRM_ON_AUTOSAVE_REVISION_DIALOG_TAG&quot;
private const val CONFIRM_SYNC_SCHEDULED_POST_DIALOG_TAG = &quot;CONFIRM_SYNC_SCHEDULED_POST_DIALOG_TAG&quot;
private const val COPY_CONFLICT_DIALOG_TAG = &quot;COPY_CONFLICT_DIALOG_TAG&quot;
private const val POST_TYPE = &quot;post_type&quot;

/**
 * This is a temporary class to make the PostListViewModel more manageable. Please feel free to refactor it any way
 * you see fit.
 */
<span class="nc" id="L28">class PostListDialogHelper(</span>
<span class="nc" id="L29">    private val showDialog: (DialogHolder) -&gt; Unit,</span>
<span class="nc" id="L30">    private val checkNetworkConnection: () -&gt; Boolean,</span>
<span class="nc" id="L31">    private val analyticsTracker: AnalyticsTrackerWrapper</span>
) {
    // Since we are using DialogFragments we need to hold onto which post will be published or trashed / resolved
    private var localPostIdForDeleteDialog: Int? = null
    private var localPostIdForMoveTrashedPostToDraftDialog: Int? = null
    private var localPostIdForTrashPostWithLocalChangesDialog: Int? = null
    private var localPostIdForTrashPostWithUnsavedChangesDialog: Int? = null
    private var localPostIdForConflictResolutionDialog: Int? = null
    private var localPostIdForAutosaveRevisionResolutionDialog: Int? = null
    private var localPostIdForScheduledPostSyncDialog: Int? = null
    private var localPostIdForCopyConflictDialog: Int? = null

    fun showMoveTrashedPostToDraftDialog(post: PostModel) {
<span class="nc" id="L44">        val dialogHolder = DialogHolder(</span>
<span class="nc" id="L45">                tag = CONFIRM_RESTORE_TRASHED_POST_DIALOG_TAG,</span>
<span class="nc" id="L46">                title = UiStringRes(R.string.post_list_move_trashed_post_to_draft_dialog_title),</span>
<span class="nc" id="L47">                message = UiStringRes(R.string.post_list_move_trashed_post_to_draft_dialog_message),</span>
<span class="nc" id="L48">                positiveButton = UiStringRes(R.string.post_list_move_trashed_post_to_draft_dialog_positive),</span>
<span class="nc" id="L49">                negativeButton = UiStringRes(R.string.post_list_move_trashed_post_to_draft_dialog_negative)</span>
        )
<span class="nc" id="L51">        localPostIdForMoveTrashedPostToDraftDialog = post.id</span>
<span class="nc" id="L52">        showDialog.invoke(dialogHolder)</span>
<span class="nc" id="L53">    }</span>

    fun showDeletePostConfirmationDialog(post: PostModel) {
        // We need network connection to delete a remote post, but not a local draft
<span class="nc bnc" id="L57" title="All 4 branches missed.">        if (!post.isLocalDraft &amp;&amp; !checkNetworkConnection.invoke()) {</span>
<span class="nc" id="L58">            return</span>
        }
<span class="nc" id="L60">        val dialogHolder = DialogHolder(</span>
<span class="nc" id="L61">                tag = CONFIRM_DELETE_POST_DIALOG_TAG,</span>
<span class="nc" id="L62">                title = UiStringRes(R.string.delete_post),</span>
<span class="nc" id="L63">                message = UiStringRes(R.string.dialog_confirm_delete_permanently_post),</span>
<span class="nc" id="L64">                positiveButton = UiStringRes(R.string.delete),</span>
<span class="nc" id="L65">                negativeButton = UiStringRes(R.string.cancel)</span>
        )
<span class="nc" id="L67">        localPostIdForDeleteDialog = post.id</span>
<span class="nc" id="L68">        showDialog.invoke(dialogHolder)</span>
<span class="nc" id="L69">    }</span>

    fun showSyncScheduledPostConfirmationDialog(post: PostModel) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (localPostIdForScheduledPostSyncDialog != null) {</span>
            // We can only handle one sync post dialog at once
<span class="nc" id="L74">            return</span>
        }
<span class="nc" id="L76">        val dialogHolder = DialogHolder(</span>
<span class="nc" id="L77">                tag = CONFIRM_SYNC_SCHEDULED_POST_DIALOG_TAG,</span>
<span class="nc" id="L78">                title = UiStringRes(R.string.dialog_confirm_scheduled_post_sync_title),</span>
<span class="nc" id="L79">                message = UiStringRes(R.string.dialog_confirm_scheduled_post_sync_message),</span>
<span class="nc" id="L80">                positiveButton = UiStringRes(R.string.dialog_confirm_scheduled_post_sync_yes),</span>
<span class="nc" id="L81">                negativeButton = UiStringRes(R.string.cancel)</span>
        )
<span class="nc" id="L83">        localPostIdForScheduledPostSyncDialog = post.id</span>
<span class="nc" id="L84">        showDialog.invoke(dialogHolder)</span>
<span class="nc" id="L85">    }</span>

    fun showTrashPostWithLocalChangesConfirmationDialog(post: PostModel) {
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (!checkNetworkConnection.invoke()) {</span>
<span class="nc" id="L89">            return</span>
        }
<span class="nc" id="L91">        val dialogHolder = DialogHolder(</span>
<span class="nc" id="L92">                tag = CONFIRM_TRASH_POST_WITH_LOCAL_CHANGES_DIALOG_TAG,</span>
<span class="nc" id="L93">                title = UiStringRes(R.string.dialog_confirm_trash_losing_local_changes_title),</span>
<span class="nc" id="L94">                message = UiStringRes(R.string.dialog_confirm_trash_losing_local_changes_message),</span>
<span class="nc" id="L95">                positiveButton = UiStringRes(R.string.dialog_button_ok),</span>
<span class="nc" id="L96">                negativeButton = UiStringRes(R.string.dialog_button_cancel)</span>
        )
<span class="nc" id="L98">        localPostIdForTrashPostWithLocalChangesDialog = post.id</span>
<span class="nc" id="L99">        showDialog.invoke(dialogHolder)</span>
<span class="nc" id="L100">    }</span>

    fun showTrashPostWithUnsavedChangesConfirmationDialog(post: PostModel) {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (!checkNetworkConnection.invoke()) {</span>
<span class="nc" id="L104">            return</span>
        }
<span class="nc" id="L106">        val dialogHolder = DialogHolder(</span>
<span class="nc" id="L107">                tag = CONFIRM_TRASH_POST_WITH_UNSAVED_CHANGES_DIALOG_TAG,</span>
<span class="nc" id="L108">                title = UiStringRes(R.string.dialog_confirm_trash_losing_unsaved_changes_title),</span>
<span class="nc" id="L109">                message = UiStringRes(R.string.dialog_confirm_trash_losing_unsaved_changes_message),</span>
<span class="nc" id="L110">                positiveButton = UiStringRes(R.string.dialog_button_ok),</span>
<span class="nc" id="L111">                negativeButton = UiStringRes(R.string.dialog_button_cancel)</span>
        )
<span class="nc" id="L113">        localPostIdForTrashPostWithUnsavedChangesDialog = post.id</span>
<span class="nc" id="L114">        showDialog.invoke(dialogHolder)</span>
<span class="nc" id="L115">    }</span>

    fun showConflictedPostResolutionDialog(post: PostModel) {
<span class="nc" id="L118">        val dialogHolder = DialogHolder(</span>
<span class="nc" id="L119">                tag = CONFIRM_ON_CONFLICT_LOAD_REMOTE_POST_DIALOG_TAG,</span>
<span class="nc" id="L120">                title = UiStringRes(R.string.dialog_confirm_load_remote_post_title),</span>
<span class="nc" id="L121">                message = UiStringText(PostUtils.getConflictedPostCustomStringForDialog(post)),</span>
<span class="nc" id="L122">                positiveButton = UiStringRes(R.string.dialog_confirm_load_remote_post_discard_local),</span>
<span class="nc" id="L123">                negativeButton = UiStringRes(R.string.dialog_confirm_load_remote_post_discard_web)</span>
        )
<span class="nc" id="L125">        localPostIdForConflictResolutionDialog = post.id</span>
<span class="nc" id="L126">        showDialog.invoke(dialogHolder)</span>
<span class="nc" id="L127">    }</span>

    fun showAutoSaveRevisionDialog(post: PostModel) {
<span class="nc" id="L130">        analyticsTracker.track(UNPUBLISHED_REVISION_DIALOG_SHOWN, mapOf(POST_TYPE to &quot;post&quot;))</span>
<span class="nc" id="L131">        val dialogHolder = DialogHolder(</span>
<span class="nc" id="L132">                tag = CONFIRM_ON_AUTOSAVE_REVISION_DIALOG_TAG,</span>
<span class="nc" id="L133">                title = UiStringRes(R.string.dialog_confirm_autosave_title),</span>
<span class="nc" id="L134">                message = PostUtils.getCustomStringForAutosaveRevisionDialog(post),</span>
<span class="nc" id="L135">                positiveButton = UiStringRes(R.string.dialog_confirm_autosave_restore_button),</span>
<span class="nc" id="L136">                negativeButton = UiStringRes(R.string.dialog_confirm_autosave_dont_restore_button)</span>
        )
<span class="nc" id="L138">        localPostIdForAutosaveRevisionResolutionDialog = post.id</span>
<span class="nc" id="L139">        showDialog.invoke(dialogHolder)</span>
<span class="nc" id="L140">    }</span>

    fun showCopyConflictDialog(post: PostModel) {
<span class="nc" id="L143">        val dialogHolder = DialogHolder(</span>
<span class="nc" id="L144">                tag = COPY_CONFLICT_DIALOG_TAG,</span>
<span class="nc" id="L145">                title = UiStringRes(R.string.dialog_confirm_copy_local_title),</span>
<span class="nc" id="L146">                message = UiStringRes(R.string.dialog_confirm_copy_local_message),</span>
<span class="nc" id="L147">                positiveButton = UiStringRes(R.string.dialog_confirm_copy_local_edit_button),</span>
<span class="nc" id="L148">                negativeButton = UiStringRes(R.string.dialog_confirm_copy_local_copy_button)</span>
        )
<span class="nc" id="L150">        localPostIdForCopyConflictDialog = post.id</span>
<span class="nc" id="L151">        showDialog.invoke(dialogHolder)</span>
<span class="nc" id="L152">    }</span>

    fun onPositiveClickedForBasicDialog(
        instanceTag: String,
        trashPostWithLocalChanges: (Int) -&gt; Unit,
        trashPostWithUnsavedChanges: (Int) -&gt; Unit,
        deletePost: (Int) -&gt; Unit,
        publishPost: (Int) -&gt; Unit,
        updateConflictedPostWithRemoteVersion: (Int) -&gt; Unit,
        editRestoredAutoSavePost: (Int) -&gt; Unit,
        moveTrashedPostToDraft: (Int) -&gt; Unit,
        resolveConflictsAndEditPost: (Int) -&gt; Unit
    ) {
<span class="nc bnc" id="L165" title="All 9 branches missed.">        when (instanceTag) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            CONFIRM_DELETE_POST_DIALOG_TAG -&gt; localPostIdForDeleteDialog?.let {</span>
<span class="nc" id="L167">                localPostIdForDeleteDialog = null</span>
<span class="nc" id="L168">                deletePost(it)</span>
<span class="nc" id="L169">            }</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            CONFIRM_SYNC_SCHEDULED_POST_DIALOG_TAG -&gt; localPostIdForScheduledPostSyncDialog?.let {</span>
<span class="nc" id="L171">                localPostIdForScheduledPostSyncDialog = null</span>
<span class="nc" id="L172">                publishPost(it)</span>
<span class="nc" id="L173">            }</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">            CONFIRM_ON_CONFLICT_LOAD_REMOTE_POST_DIALOG_TAG -&gt; localPostIdForConflictResolutionDialog?.let {</span>
<span class="nc" id="L175">                localPostIdForConflictResolutionDialog = null</span>
                // here load version from remote
<span class="nc" id="L177">                updateConflictedPostWithRemoteVersion(it)</span>
<span class="nc" id="L178">            }</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            CONFIRM_TRASH_POST_WITH_LOCAL_CHANGES_DIALOG_TAG -&gt; localPostIdForTrashPostWithLocalChangesDialog?.let {</span>
<span class="nc" id="L180">                localPostIdForTrashPostWithLocalChangesDialog = null</span>
<span class="nc" id="L181">                trashPostWithLocalChanges(it)</span>
<span class="nc" id="L182">            }</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            CONFIRM_TRASH_POST_WITH_UNSAVED_CHANGES_DIALOG_TAG -&gt; localPostIdForTrashPostWithUnsavedChangesDialog?.let {</span>
<span class="nc" id="L184">                localPostIdForTrashPostWithUnsavedChangesDialog = null</span>
<span class="nc" id="L185">                trashPostWithUnsavedChanges(it)</span>
<span class="nc" id="L186">            }</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            CONFIRM_RESTORE_TRASHED_POST_DIALOG_TAG -&gt; localPostIdForMoveTrashedPostToDraftDialog?.let {</span>
<span class="nc" id="L188">                localPostIdForMoveTrashedPostToDraftDialog = null</span>
<span class="nc" id="L189">                moveTrashedPostToDraft(it)</span>
<span class="nc" id="L190">            }</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            CONFIRM_ON_AUTOSAVE_REVISION_DIALOG_TAG -&gt; localPostIdForAutosaveRevisionResolutionDialog?.let {</span>
                // open the editor with the restored auto save
<span class="nc" id="L193">                localPostIdForAutosaveRevisionResolutionDialog = null</span>
<span class="nc" id="L194">                editRestoredAutoSavePost(it)</span>
<span class="nc" id="L195">                analyticsTracker.track(</span>
<span class="nc" id="L196">                        UNPUBLISHED_REVISION_DIALOG_LOAD_UNPUBLISHED_VERSION_CLICKED,</span>
<span class="nc" id="L197">                        mapOf(POST_TYPE to &quot;post&quot;))</span>
<span class="nc" id="L198">            }</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            COPY_CONFLICT_DIALOG_TAG -&gt; localPostIdForCopyConflictDialog?.let {</span>
<span class="nc" id="L200">                localPostIdForCopyConflictDialog = null</span>
<span class="nc" id="L201">                resolveConflictsAndEditPost(it)</span>
<span class="nc" id="L202">            }</span>
<span class="nc" id="L203">            else -&gt; throw IllegalArgumentException(&quot;Dialog's positive button click is not handled: $instanceTag&quot;)</span>
        }
<span class="nc" id="L205">    }</span>

    fun onNegativeClickedForBasicDialog(
        instanceTag: String,
        updateConflictedPostWithLocalVersion: (Int) -&gt; Unit,
        editLocalPost: (Int) -&gt; Unit,
        copyLocalPost: (Int) -&gt; Unit
    ) {
<span class="nc bnc" id="L213" title="All 9 branches missed.">        when (instanceTag) {</span>
<span class="nc" id="L214">            CONFIRM_DELETE_POST_DIALOG_TAG -&gt; localPostIdForDeleteDialog = null</span>
<span class="nc" id="L215">            CONFIRM_SYNC_SCHEDULED_POST_DIALOG_TAG -&gt; localPostIdForScheduledPostSyncDialog = null</span>
<span class="nc" id="L216">            CONFIRM_TRASH_POST_WITH_LOCAL_CHANGES_DIALOG_TAG -&gt; localPostIdForTrashPostWithLocalChangesDialog = null</span>
<span class="nc" id="L217">            CONFIRM_TRASH_POST_WITH_UNSAVED_CHANGES_DIALOG_TAG -&gt; localPostIdForTrashPostWithUnsavedChangesDialog = null</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            CONFIRM_ON_CONFLICT_LOAD_REMOTE_POST_DIALOG_TAG -&gt; localPostIdForConflictResolutionDialog?.let {</span>
<span class="nc" id="L219">                updateConflictedPostWithLocalVersion(it)</span>
<span class="nc" id="L220">            }</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            CONFIRM_ON_AUTOSAVE_REVISION_DIALOG_TAG -&gt; localPostIdForAutosaveRevisionResolutionDialog?.let {</span>
                // open the editor with the local post (don't use the auto save version)
<span class="nc" id="L223">                editLocalPost(it)</span>
<span class="nc" id="L224">                analyticsTracker.track(</span>
<span class="nc" id="L225">                        UNPUBLISHED_REVISION_DIALOG_LOAD_LOCAL_VERSION_CLICKED,</span>
<span class="nc" id="L226">                        mapOf(POST_TYPE to &quot;post&quot;)</span>
                )
<span class="nc" id="L228">            }</span>
<span class="nc" id="L229">            CONFIRM_RESTORE_TRASHED_POST_DIALOG_TAG -&gt; localPostIdForMoveTrashedPostToDraftDialog = null</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            COPY_CONFLICT_DIALOG_TAG -&gt; localPostIdForCopyConflictDialog?.let {</span>
<span class="nc" id="L231">                localPostIdForCopyConflictDialog = null</span>
<span class="nc" id="L232">                copyLocalPost(it)</span>
<span class="nc" id="L233">            }</span>
<span class="nc" id="L234">            else -&gt; throw IllegalArgumentException(&quot;Dialog's negative button click is not handled: $instanceTag&quot;)</span>
        }
<span class="nc" id="L236">    }</span>

    fun onDismissByOutsideTouchForBasicDialog(
        instanceTag: String,
        updateConflictedPostWithLocalVersion: (Int) -&gt; Unit,
        editLocalPost: (Int) -&gt; Unit,
        copyLocalPost: (Int) -&gt; Unit
    ) {
        // Cancel and outside touch dismiss works the same way for all, except for conflict and autosave revision
        // dialogs, for which tapping outside and actively tapping the &quot;edit local&quot; have different meanings
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (instanceTag != CONFIRM_ON_CONFLICT_LOAD_REMOTE_POST_DIALOG_TAG &amp;&amp;</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                instanceTag != CONFIRM_ON_AUTOSAVE_REVISION_DIALOG_TAG) {</span>
<span class="nc" id="L248">            onNegativeClickedForBasicDialog(</span>
<span class="nc" id="L249">                    instanceTag = instanceTag,</span>
<span class="nc" id="L250">                    updateConflictedPostWithLocalVersion = updateConflictedPostWithLocalVersion,</span>
<span class="nc" id="L251">                    editLocalPost = editLocalPost,</span>
<span class="nc" id="L252">                    copyLocalPost = copyLocalPost</span>
            )
        }
<span class="nc" id="L255">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>