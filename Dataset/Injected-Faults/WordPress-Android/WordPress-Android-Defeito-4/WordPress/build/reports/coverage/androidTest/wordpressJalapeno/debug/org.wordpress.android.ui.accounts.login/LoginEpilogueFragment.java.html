<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoginEpilogueFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.accounts.login</a> &gt; <span class="el_source">LoginEpilogueFragment.java</span></div><h1>LoginEpilogueFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.accounts.login;

import android.content.Context;
import android.content.res.Configuration;
import android.os.Bundle;
import android.text.Editable;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.TextView;

import androidx.annotation.LayoutRes;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.lifecycle.ViewModelProvider;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import org.wordpress.android.BuildConfig;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.fluxc.model.AccountModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.login.LoginBaseFormFragment;
import org.wordpress.android.ui.accounts.LoginEpilogueViewModel;
import org.wordpress.android.ui.accounts.UnifiedLoginTracker;
import org.wordpress.android.ui.accounts.UnifiedLoginTracker.Click;
import org.wordpress.android.ui.accounts.UnifiedLoginTracker.Step;
import org.wordpress.android.ui.main.SitePickerAdapter;
import org.wordpress.android.ui.main.SitePickerAdapter.OnDataLoadedListener;
import org.wordpress.android.ui.main.SitePickerAdapter.OnSiteClickListener;
import org.wordpress.android.ui.main.SitePickerAdapter.SiteList;
import org.wordpress.android.ui.main.SitePickerAdapter.SitePickerMode;
import org.wordpress.android.ui.main.SitePickerAdapter.SiteRecord;
import org.wordpress.android.ui.main.SitePickerAdapter.ViewHolderHandler;
import org.wordpress.android.util.BuildConfigWrapper;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.util.image.ImageManager;

import java.util.ArrayList;

import javax.inject.Inject;

<span class="nc" id="L48">public class LoginEpilogueFragment extends LoginBaseFormFragment&lt;LoginEpilogueListener&gt; {</span>
    public static final String TAG = &quot;login_epilogue_fragment_tag&quot;;

    private static final String ARG_DO_LOGIN_UPDATE = &quot;ARG_DO_LOGIN_UPDATE&quot;;
    private static final String ARG_SHOW_AND_RETURN = &quot;ARG_SHOW_AND_RETURN&quot;;
    private static final String ARG_OLD_SITES_IDS = &quot;ARG_OLD_SITES_IDS&quot;;

    private static final int EXPANDED_UI_THRESHOLD = 3;

    private RecyclerView mSitesList;
    @Nullable private View mBottomShadow;

    private SitePickerAdapter mAdapter;
    private boolean mDoLoginUpdate;
    private boolean mShowAndReturn;
    private ArrayList&lt;Integer&gt; mOldSitesIds;

    private LoginEpilogueListener mLoginEpilogueListener;

    @Inject ImageManager mImageManager;
    @Inject UnifiedLoginTracker mUnifiedLoginTracker;
    @Inject BuildConfigWrapper mBuildConfigWrapper;
    @Inject ViewModelProvider.Factory mViewModelFactory;
    @Inject LoginEpilogueViewModel mParentViewModel;

    public static LoginEpilogueFragment newInstance(boolean doLoginUpdate, boolean showAndReturn,
                                                    ArrayList&lt;Integer&gt; oldSitesIds) {
<span class="nc" id="L75">        LoginEpilogueFragment fragment = new LoginEpilogueFragment();</span>
<span class="nc" id="L76">        Bundle args = new Bundle();</span>
<span class="nc" id="L77">        args.putBoolean(ARG_DO_LOGIN_UPDATE, doLoginUpdate);</span>
<span class="nc" id="L78">        args.putBoolean(ARG_SHOW_AND_RETURN, showAndReturn);</span>
<span class="nc" id="L79">        args.putIntegerArrayList(ARG_OLD_SITES_IDS, oldSitesIds);</span>
<span class="nc" id="L80">        fragment.setArguments(args);</span>
<span class="nc" id="L81">        return fragment;</span>
    }

    @Override
    protected boolean listenForLogin() {
<span class="nc" id="L86">        return mDoLoginUpdate;</span>
    }

    @Override
    protected @LayoutRes int getContentLayout() {
<span class="nc" id="L91">        return 0; // nothing special here. The view is inflated in createMainView()</span>
    }

    @Override
    protected @LayoutRes int getProgressBarText() {
<span class="nc" id="L96">        return R.string.logging_in;</span>
    }

    @Override
    protected void setupLabel(@NonNull TextView label) {
        // nothing special to do, no main label on epilogue screen
<span class="nc" id="L102">    }</span>

    @Override
    protected ViewGroup createMainView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L106">        return (ViewGroup) inflater.inflate(loginEpilogueScreenResource(), container, false);</span>
    }

    @LayoutRes
    private int loginEpilogueScreenResource() {
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (isNewLoginEpilogueScreenEnabled()) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (mAdapter.getBlogsForCurrentView().size() &lt;= EXPANDED_UI_THRESHOLD</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                &amp;&amp; getResources().getConfiguration().orientation == Configuration.ORIENTATION_PORTRAIT) {</span>
<span class="nc" id="L114">                return R.layout.login_epilogue_screen_new;</span>
            } else {
<span class="nc" id="L116">                return R.layout.login_epilogue_screen_new_expanded;</span>
            }
        } else {
<span class="nc" id="L119">            return R.layout.login_epilogue_screen;</span>
        }
    }

    private boolean isNewLoginEpilogueScreenEnabled() {
<span class="nc bnc" id="L124" title="All 4 branches missed.">        return mBuildConfigWrapper.isSiteCreationEnabled()</span>
               &amp;&amp; !mShowAndReturn;
    }

    @Override
    protected void setupContent(ViewGroup rootView) {
<span class="nc" id="L130">        mBottomShadow = rootView.findViewById(R.id.bottom_shadow);</span>
<span class="nc" id="L131">        mSitesList = rootView.findViewById(R.id.recycler_view);</span>
<span class="nc" id="L132">        mSitesList.setLayoutManager(new LinearLayoutManager(requireActivity()));</span>
<span class="nc" id="L133">        mSitesList.setScrollBarStyle(View.SCROLLBARS_OUTSIDE_OVERLAY);</span>
<span class="nc" id="L134">        mSitesList.setItemAnimator(null);</span>
<span class="nc" id="L135">        mSitesList.setAdapter(mAdapter);</span>
<span class="nc" id="L136">    }</span>

    @Override
    protected void setupBottomButton(Button button) {
<span class="nc" id="L140">        button.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (mLoginEpilogueListener != null) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                if (isNewLoginEpilogueScreenEnabled()) {</span>
<span class="nc" id="L143">                    AnalyticsTracker.track(Stat.LOGIN_EPILOGUE_CREATE_NEW_SITE_TAPPED);</span>
<span class="nc" id="L144">                    mUnifiedLoginTracker.trackClick(Click.CREATE_NEW_SITE);</span>
<span class="nc" id="L145">                    mLoginEpilogueListener.onCreateNewSite();</span>
                } else {
<span class="nc" id="L147">                    mUnifiedLoginTracker.trackClick(Click.CONTINUE);</span>
<span class="nc" id="L148">                    mLoginEpilogueListener.onContinue();</span>
                }
            }
<span class="nc" id="L151">        });</span>
<span class="nc" id="L152">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L156">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L157">        ((WordPress) requireActivity().getApplication()).component().inject(this);</span>

<span class="nc" id="L159">        mDoLoginUpdate = requireArguments().getBoolean(ARG_DO_LOGIN_UPDATE, false);</span>
<span class="nc" id="L160">        mShowAndReturn = requireArguments().getBoolean(ARG_SHOW_AND_RETURN, false);</span>
<span class="nc" id="L161">        mOldSitesIds = requireArguments().getIntegerArrayList(ARG_OLD_SITES_IDS);</span>

<span class="nc" id="L163">        initAdapter();</span>
<span class="nc" id="L164">    }</span>

    @Override
    public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
<span class="nc" id="L168">        super.onViewCreated(view, savedInstanceState);</span>
<span class="nc" id="L169">        initViewModel();</span>
<span class="nc" id="L170">    }</span>

    @Override
    public void onActivityCreated(@Nullable Bundle savedInstanceState) {
<span class="nc" id="L174">        super.onActivityCreated(savedInstanceState);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L176">            mParentViewModel.checkAndSetVariantForMySiteDefaultTabExperiment();</span>
<span class="nc" id="L177">            AnalyticsTracker.track(AnalyticsTracker.Stat.LOGIN_EPILOGUE_VIEWED);</span>
<span class="nc" id="L178">            mUnifiedLoginTracker.track(Step.SUCCESS);</span>
        }
<span class="nc" id="L180">    }</span>

    private void initViewModel() {
<span class="nc" id="L183">        mParentViewModel = new ViewModelProvider(requireActivity(), mViewModelFactory)</span>
<span class="nc" id="L184">                .get(LoginEpilogueViewModel.class);</span>
<span class="nc" id="L185">    }</span>

    private void initAdapter() {
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (mAdapter == null) {</span>
<span class="nc" id="L189">            setNewAdapter();</span>
        }
<span class="nc" id="L191">    }</span>

    private void setNewAdapter() {
<span class="nc" id="L194">        mAdapter = new SitePickerAdapter(</span>
<span class="nc" id="L195">                requireActivity(),</span>
                R.layout.login_epilogue_sites_listitem,
                0,
                &quot;&quot;,
                false,
<span class="nc" id="L200">                dataLoadedListener(),</span>
<span class="nc" id="L201">                headerHandler(),</span>
<span class="nc" id="L202">                footerHandler(),</span>
                mOldSitesIds,
                SitePickerMode.DEFAULT_MODE,
                mShowAndReturn
        );
<span class="nc" id="L207">        setOnSiteClickListener();</span>
<span class="nc" id="L208">    }</span>

    @NonNull
    private OnDataLoadedListener dataLoadedListener() {
<span class="nc" id="L212">        return new OnDataLoadedListener() {</span>
            @Override
            public void onBeforeLoad(boolean isEmpty) {
<span class="nc" id="L215">            }</span>

            @Override
            public void onAfterLoad() {
<span class="nc" id="L219">                mSitesList.post(() -&gt; {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                    if (!isAdded()) {</span>
<span class="nc" id="L221">                        return;</span>
                    }

<span class="nc bnc" id="L224" title="All 2 branches missed.">                    if (mBottomShadow != null) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                        if (mSitesList.computeVerticalScrollRange() &gt; mSitesList.getHeight()) {</span>
<span class="nc" id="L226">                            mBottomShadow.setVisibility(View.VISIBLE);</span>
                        } else {
<span class="nc" id="L228">                            mBottomShadow.setVisibility(View.GONE);</span>
                        }
                    }
<span class="nc" id="L231">                });</span>
<span class="nc" id="L232">            }</span>
        };
    }

    @NonNull
    private ViewHolderHandler&lt;LoginHeaderViewHolder&gt; headerHandler() {
<span class="nc" id="L238">        return new ViewHolderHandler&lt;LoginHeaderViewHolder&gt;() {</span>
            @Override
            public LoginHeaderViewHolder onCreateViewHolder(LayoutInflater layoutInflater, ViewGroup parent,
                                                            boolean attachToRoot) {
<span class="nc bnc" id="L242" title="All 2 branches missed.">                if (isNewLoginEpilogueScreenEnabled()) {</span>
<span class="nc" id="L243">                    return new LoginHeaderViewHolder(</span>
<span class="nc" id="L244">                            layoutInflater.inflate(R.layout.login_epilogue_header_new, parent, false),</span>
                            true
                    );
                } else {
<span class="nc" id="L248">                    return new LoginHeaderViewHolder(</span>
<span class="nc" id="L249">                            layoutInflater.inflate(R.layout.login_epilogue_header, parent, false),</span>
                            false
                    );
                }
            }

            @Override
            public void onBindViewHolder(LoginHeaderViewHolder holder, SiteList sites) {
<span class="nc" id="L257">                bindHeaderViewHolder(holder, sites);</span>
<span class="nc" id="L258">            }</span>
        };
    }

    @Nullable
    private ViewHolderHandler&lt;LoginFooterViewHolder&gt; footerHandler() {
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (isNewLoginEpilogueScreenEnabled()) {</span>
<span class="nc" id="L265">            return null;</span>
        } else {
<span class="nc" id="L267">            return new ViewHolderHandler&lt;LoginFooterViewHolder&gt;() {</span>
                @Override
                public LoginFooterViewHolder onCreateViewHolder(LayoutInflater layoutInflater, ViewGroup parent,
                                                                boolean attachToRoot) {
<span class="nc" id="L271">                    return new LoginFooterViewHolder(</span>
<span class="nc" id="L272">                            layoutInflater.inflate(R.layout.login_epilogue_footer, parent, false));</span>
                }

                @Override
                public void onBindViewHolder(LoginFooterViewHolder holder, SiteList sites) {
<span class="nc" id="L277">                    bindFooterViewHolder(holder, sites);</span>
<span class="nc" id="L278">                }</span>
            };
        }
    }

    private void setOnSiteClickListener() {
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (isNewLoginEpilogueScreenEnabled()) {</span>
<span class="nc" id="L285">            mAdapter.setOnSiteClickListener(new OnSiteClickListener() {</span>
                @Override
                public void onSiteClick(SiteRecord site) {
<span class="nc" id="L288">                    AnalyticsTracker.track(Stat.LOGIN_EPILOGUE_CHOOSE_SITE_TAPPED);</span>
<span class="nc" id="L289">                    mUnifiedLoginTracker.trackClick(Click.CHOOSE_SITE);</span>
<span class="nc" id="L290">                    mLoginEpilogueListener.onSiteClick(site.getLocalId());</span>
<span class="nc" id="L291">                }</span>

                @Override
                public boolean onSiteLongClick(SiteRecord site) {
<span class="nc" id="L295">                    return false;</span>
                }
            });
        }
<span class="nc" id="L299">    }</span>

    @Override
    public void onAttach(Context context) {
<span class="nc" id="L303">        super.onAttach(context);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">        if (context instanceof LoginEpilogueListener) {</span>
<span class="nc" id="L305">            mLoginEpilogueListener = (LoginEpilogueListener) context;</span>
        } else {
<span class="nc" id="L307">            throw new RuntimeException(context.toString() + &quot; must implement LoginEpilogueListener&quot;);</span>
        }
<span class="nc" id="L309">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L313">        super.onResume();</span>

<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (mDoLoginUpdate) {</span>
            // when from magiclink, we need to complete the login process here (update account and settings)
<span class="nc" id="L317">            doFinishLogin();</span>
        }
<span class="nc" id="L319">        mParentViewModel.onLoginEpilogueResume(mDoLoginUpdate);</span>
<span class="nc" id="L320">    }</span>

    @Override
    protected boolean isJetpackAppLogin() {
<span class="nc bnc" id="L324" title="All 4 branches missed.">        return mDoLoginUpdate &amp;&amp; mBuildConfigWrapper.isJetpackApp();</span>
    }

    // INJECTED-FAULT (IF-CC): Negate hasSites condition
    private void bindHeaderViewHolder(LoginHeaderViewHolder holder, SiteList sites) {
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L330">            return;</span>
        }

<span class="nc" id="L333">        final boolean isWpcom = mAccountStore.hasAccessToken();</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">        final boolean hasSites = sites.size() == 0;</span>

<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (isWpcom) {</span>
<span class="nc" id="L337">            final AccountModel account = mAccountStore.getAccount();</span>
<span class="nc" id="L338">            holder.updateLoggedInAsHeading(getContext(), mImageManager, account);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        } else if (hasSites) {</span>
<span class="nc" id="L340">            final SiteModel site = mSiteStore.getSiteByLocalId(sites.get(0).getLocalId());</span>
<span class="nc" id="L341">            holder.updateLoggedInAsHeading(getContext(), mImageManager, site);</span>
        }

<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (hasSites) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">            if (isNewLoginEpilogueScreenEnabled()) {</span>
<span class="nc" id="L346">                holder.showSitesHeading();</span>
            } else {
<span class="nc" id="L348">                holder.showSitesHeading(StringUtils.getQuantityString(</span>
<span class="nc" id="L349">                        requireActivity(),</span>
                        R.string.login_epilogue_mysites_one,
                        R.string.login_epilogue_mysites_one,
                        R.string.login_epilogue_mysites_other,
<span class="nc" id="L353">                        sites.size())</span>
                );
            }
        } else {
<span class="nc" id="L357">            holder.hideSitesHeading();</span>
        }
<span class="nc" id="L359">    }</span>

    private void bindFooterViewHolder(LoginFooterViewHolder holder, SiteList sites) {
<span class="nc bnc" id="L362" title="All 2 branches missed.">        holder.itemView.setVisibility((mShowAndReturn || BuildConfig.IS_JETPACK_APP) ? View.GONE : View.VISIBLE);</span>
<span class="nc" id="L363">        holder.itemView.setOnClickListener(v -&gt; {</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">            if (mLoginEpilogueListener != null) {</span>
<span class="nc" id="L365">                mUnifiedLoginTracker.trackClick(Click.CONNECT_SITE);</span>
<span class="nc" id="L366">                mLoginEpilogueListener.onConnectAnotherSite();</span>
            }
<span class="nc" id="L368">        });</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (sites.size() == 0) {</span>
<span class="nc" id="L370">            holder.bindText(getString(R.string.connect_site));</span>
        } else {
<span class="nc" id="L372">            holder.bindText(getString(R.string.connect_more));</span>
        }
<span class="nc" id="L374">    }</span>

    @Override
    public void beforeTextChanged(CharSequence s, int start, int count, int after) {
<span class="nc" id="L378">    }</span>

    @Override
    public void onTextChanged(CharSequence s, int start, int before, int count) {
<span class="nc" id="L382">    }</span>

    @Override
    public void afterTextChanged(Editable s) {
<span class="nc" id="L386">    }</span>

    @Override
    protected void onHelp() {
        // nothing to do. No help button on the epilogue screen
<span class="nc" id="L391">    }</span>

    @Override
    protected void onLoginFinished() {
        // we needed to complete the login process so, now just show an updated screen to the user

<span class="nc" id="L397">        AnalyticsUtils.trackAnalyticsSignIn(mAccountStore, mSiteStore, true);</span>

<span class="nc" id="L399">        endProgress();</span>
<span class="nc" id="L400">        setNewAdapter();</span>
<span class="nc" id="L401">        mSitesList.setAdapter(mAdapter);</span>

<span class="nc" id="L403">        mParentViewModel.onLoginFinished(mDoLoginUpdate);</span>
<span class="nc" id="L404">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>