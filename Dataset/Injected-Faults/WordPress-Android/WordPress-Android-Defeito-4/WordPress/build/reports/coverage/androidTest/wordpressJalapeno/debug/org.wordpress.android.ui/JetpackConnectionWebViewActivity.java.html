<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JetpackConnectionWebViewActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui</a> &gt; <span class="el_source">JetpackConnectionWebViewActivity.java</span></div><h1>JetpackConnectionWebViewActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui;

import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.view.Menu;
import android.webkit.WebView;
import android.webkit.WebViewClient;

import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.login.LoginMode;
import org.wordpress.android.ui.JetpackConnectionWebViewClient.JetpackConnectionWebViewClientListener;
import org.wordpress.android.ui.accounts.LoginActivity;

import java.util.List;

import static org.wordpress.android.WordPress.SITE;
import static org.wordpress.android.ui.JetpackConnectionWebViewClient.JETPACK_CONNECTION_DEEPLINK;
import static org.wordpress.android.ui.RequestCodes.JETPACK_LOGIN;

/**
 * Activity that opens the Jetpack login flow and returns to StatsActivity when finished.
 * Use one of the static factory methods to start the flow.
 */
<span class="nc" id="L28">public class JetpackConnectionWebViewActivity extends WPWebViewActivity</span>
        implements JetpackConnectionWebViewClientListener {
    private static final String REDIRECT_PAGE_STATE_ITEM = &quot;redirectPage&quot;;
    private static final String TRACKING_SOURCE_KEY = &quot;tracking_source&quot;;

    private SiteModel mSite;
    private JetpackConnectionSource mSource;
    private JetpackConnectionWebViewClient mWebViewClient;

    public static void startJetpackConnectionFlow(Context context, JetpackConnectionSource source, SiteModel site,
                                                  boolean authorized) {
<span class="nc bnc" id="L39" title="All 2 branches missed.">        if (site.isJetpackInstalled()) {</span>
<span class="nc" id="L40">            startManualFlow(context, source, site, authorized);</span>
        } else {
<span class="nc" id="L42">            JetpackConnectionUtils.trackWithSource(AnalyticsTracker.Stat.INSTALL_JETPACK_SELECTED, source);</span>
<span class="nc" id="L43">            ActivityLauncher.startJetpackInstall(context, source, site);</span>
        }
<span class="nc" id="L45">    }</span>

    static void startManualFlow(Context context, JetpackConnectionSource source, SiteModel site, boolean authorized) {
<span class="nc" id="L48">        String url = &quot;https://wordpress.com/jetpack/connect?&quot;</span>
<span class="nc" id="L49">                     + &quot;url=&quot; + site.getUrl()</span>
                     + &quot;&amp;mobile_redirect=&quot; + JETPACK_CONNECTION_DEEPLINK
<span class="nc" id="L51">                     + &quot;?source=&quot; + source.toString();</span>
<span class="nc" id="L52">        startJetpackConnectionFlow(context, url, site, authorized, source);</span>
<span class="nc" id="L53">    }</span>

    private static void startJetpackConnectionFlow(Context context,
                                                   String url,
                                                   SiteModel site,
                                                   boolean authorized,
                                                   JetpackConnectionSource source) {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (!checkContextAndUrl(context, url)) {</span>
<span class="nc" id="L61">            return;</span>
        }

<span class="nc" id="L64">        Intent intent = new Intent(context, JetpackConnectionWebViewActivity.class);</span>
<span class="nc" id="L65">        intent.putExtra(WPWebViewActivity.URL_TO_LOAD, url);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (authorized) {</span>
<span class="nc" id="L67">            intent.putExtra(WPWebViewActivity.USE_GLOBAL_WPCOM_USER, true);</span>
<span class="nc" id="L68">            intent.putExtra(WPWebViewActivity.AUTHENTICATION_URL, WPCOM_LOGIN_URL);</span>
        }
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (site != null) {</span>
<span class="nc" id="L71">            intent.putExtra(WordPress.SITE, site);</span>
        }
<span class="nc" id="L73">        intent.putExtra(TRACKING_SOURCE_KEY, source);</span>
<span class="nc" id="L74">        context.startActivity(intent);</span>
<span class="nc" id="L75">        JetpackConnectionUtils.trackWithSource(AnalyticsTracker.Stat.CONNECT_JETPACK_SELECTED, source);</span>
<span class="nc" id="L76">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L80">        mSite = (SiteModel) getIntent().getSerializableExtra(WordPress.SITE);</span>
<span class="nc" id="L81">        mSource = (JetpackConnectionSource) getIntent().getSerializableExtra(TRACKING_SOURCE_KEY);</span>
        // We need to get the site before calling super since it'll create the web client
<span class="nc" id="L83">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L84">        toggleNavbarVisibility(false);</span>
<span class="nc" id="L85">    }</span>

    @Override
    protected WebViewClient createWebViewClient(List&lt;String&gt; allowedURL) {
<span class="nc" id="L89">        mWebViewClient = new JetpackConnectionWebViewClient(this, this, mSite.getUrl());</span>
<span class="nc" id="L90">        return mWebViewClient;</span>
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L95">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">        if (requestCode == JETPACK_LOGIN &amp;&amp; resultCode == RESULT_OK) {</span>
<span class="nc" id="L97">            JetpackConnectionWebViewActivity.startJetpackConnectionFlow(</span>
<span class="nc" id="L98">                    this, mWebViewClient.getRedirectPage(), mSite, mAccountStore.hasAccessToken(),</span>
<span class="nc" id="L99">                    (JetpackConnectionSource) getIntent().getSerializableExtra(TRACKING_SOURCE_KEY));</span>
        }
<span class="nc" id="L101">        finish();</span>
<span class="nc" id="L102">    }</span>

    @Override
    protected void cancel() {
<span class="nc" id="L106">        JetpackConnectionUtils.trackWithSource(AnalyticsTracker.Stat.INSTALL_JETPACK_CANCELLED,</span>
<span class="nc" id="L107">                (JetpackConnectionSource) getIntent().getSerializableExtra(TRACKING_SOURCE_KEY));</span>
<span class="nc" id="L108">    }</span>

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L112">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L113">        outState.putString(REDIRECT_PAGE_STATE_ITEM, mWebViewClient.getRedirectPage());</span>
<span class="nc" id="L114">    }</span>

    @Override
    protected void onRestoreInstanceState(Bundle savedInstanceState) {
<span class="nc" id="L118">        super.onRestoreInstanceState(savedInstanceState);</span>
<span class="nc" id="L119">        mWebViewClient.setRedirectPage(savedInstanceState.getString(REDIRECT_PAGE_STATE_ITEM));</span>
<span class="nc" id="L120">    }</span>

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
<span class="nc" id="L124">        return true;</span>
    }

    // JetpackConnectionWebViewClientListener

    @Override
    public void onRequiresWPComLogin(WebView webView, String redirectPage) {
<span class="nc" id="L131">        String authenticationUrl = WPWebViewActivity.getSiteLoginUrl(mSite);</span>
<span class="nc" id="L132">        String postData = WPWebViewActivity.getAuthenticationPostData(authenticationUrl, redirectPage,</span>
<span class="nc" id="L133">                                                                      mSite.getUsername(), mSite.getPassword(),</span>
<span class="nc" id="L134">                                                                      mAccountStore.getAccessToken());</span>
<span class="nc" id="L135">        webView.postUrl(authenticationUrl, postData.getBytes());</span>
<span class="nc" id="L136">    }</span>

    @Override
    public void onRequiresJetpackLogin() {
<span class="nc" id="L140">        Intent loginIntent = new Intent(this, LoginActivity.class);</span>
<span class="nc" id="L141">        LoginMode.JETPACK_STATS.putInto(loginIntent);</span>
<span class="nc" id="L142">        loginIntent.putExtra(LoginActivity.ARG_JETPACK_CONNECT_SOURCE, mSource);</span>
<span class="nc" id="L143">        startActivityForResult(loginIntent, JETPACK_LOGIN);</span>
<span class="nc" id="L144">    }</span>

    @Override
    public void onJetpackSuccessfullyConnected(Uri uri) {
<span class="nc" id="L148">        JetpackConnectionUtils.trackWithSource(AnalyticsTracker.Stat.INSTALL_JETPACK_COMPLETED,</span>
<span class="nc" id="L149">                (JetpackConnectionSource) getIntent().getSerializableExtra(TRACKING_SOURCE_KEY));</span>
<span class="nc" id="L150">        Intent intent = new Intent(this, JetpackConnectionResultActivity.class);</span>
<span class="nc" id="L151">        intent.setData(uri);</span>
<span class="nc" id="L152">        intent.putExtra(SITE, mSite);</span>
<span class="nc" id="L153">        startActivity(intent);</span>
<span class="nc" id="L154">        finish();</span>
<span class="nc" id="L155">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>