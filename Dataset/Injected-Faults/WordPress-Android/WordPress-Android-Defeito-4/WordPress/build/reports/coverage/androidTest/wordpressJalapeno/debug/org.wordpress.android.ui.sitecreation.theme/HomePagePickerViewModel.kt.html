<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HomePagePickerViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.sitecreation.theme</a> &gt; <span class="el_source">HomePagePickerViewModel.kt</span></div><h1>HomePagePickerViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.sitecreation.theme

import androidx.lifecycle.LiveData
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.withContext
import org.wordpress.android.R
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.modules.BG_THREAD
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.sitecreation.misc.SiteCreationErrorType.INTERNET_UNAVAILABLE_ERROR
import org.wordpress.android.ui.sitecreation.misc.SiteCreationErrorType.UNKNOWN
import org.wordpress.android.ui.sitecreation.misc.SiteCreationTracker
import org.wordpress.android.ui.layoutpicker.LayoutPickerUiState.Content
import org.wordpress.android.ui.layoutpicker.LayoutPickerUiState.Loading
import org.wordpress.android.ui.layoutpicker.LayoutPickerUiState.Error
import org.wordpress.android.ui.layoutpicker.LayoutPickerViewModel
import org.wordpress.android.ui.sitecreation.usecases.FetchHomePageLayoutsUseCase
import org.wordpress.android.util.NetworkUtilsWrapper
import org.wordpress.android.viewmodel.SingleLiveEvent
import javax.inject.Inject
import javax.inject.Named

const val defaultTemplateSlug = &quot;default&quot;

private const val ERROR_CONTEXT = &quot;design&quot;

@HiltViewModel
<span class="nc" id="L29">class HomePagePickerViewModel @Inject constructor(</span>
<span class="nc" id="L30">    override val networkUtils: NetworkUtilsWrapper,</span>
<span class="nc" id="L31">    private val dispatcher: Dispatcher,</span>
<span class="nc" id="L32">    private val fetchHomePageLayoutsUseCase: FetchHomePageLayoutsUseCase,</span>
<span class="nc" id="L33">    private val analyticsTracker: SiteCreationTracker,</span>
<span class="nc" id="L34">    @Named(BG_THREAD) override val bgDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L35">    @Named(UI_THREAD) override val mainDispatcher: CoroutineDispatcher,</span>
<span class="nc" id="L36">    private val recommendationProvider: SiteDesignRecommendationProvider</span>
<span class="nc" id="L37">) : LayoutPickerViewModel(mainDispatcher, bgDispatcher, networkUtils, analyticsTracker) {</span>
<span class="nc" id="L38">    private val _onDesignActionPressed = SingleLiveEvent&lt;DesignSelectionAction&gt;()</span>
<span class="nc" id="L39">    val onDesignActionPressed: LiveData&lt;DesignSelectionAction&gt; = _onDesignActionPressed</span>

<span class="nc" id="L41">    private val _onBackButtonPressed = SingleLiveEvent&lt;Unit&gt;()</span>
<span class="nc" id="L42">    val onBackButtonPressed: LiveData&lt;Unit&gt; = _onBackButtonPressed</span>

<span class="nc" id="L44">    private var vertical: String = &quot;&quot;</span>

<span class="nc" id="L46">    override val useCachedData: Boolean = false</span>
<span class="nc" id="L47">    override val shouldUseMobileThumbnail = true</span>
<span class="nc" id="L48">    override val thumbnailTapOpensPreview = true</span>

<span class="nc" id="L50">    sealed class DesignSelectionAction(val template: String) {</span>
<span class="nc" id="L51">        object Skip : DesignSelectionAction(defaultTemplateSlug)</span>
<span class="nc" id="L52">        class Choose(template: String) : DesignSelectionAction(template)</span>
    }

<span class="nc" id="L55">    init {</span>
<span class="nc" id="L56">        dispatcher.register(fetchHomePageLayoutsUseCase)</span>
<span class="nc" id="L57">    }</span>

    override fun onCleared() {
<span class="nc" id="L60">        super.onCleared()</span>
<span class="nc" id="L61">        dispatcher.unregister(fetchHomePageLayoutsUseCase)</span>
<span class="nc" id="L62">    }</span>

<span class="nc" id="L64">    fun start(intent: String? = null, isTablet: Boolean = false) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        val verticalChanged = vertical != intent</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (verticalChanged) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            vertical = intent ?: &quot;&quot;</span>
        }
<span class="nc" id="L69">        initializePreviewMode(isTablet)</span>
<span class="nc bnc" id="L70" title="All 4 branches missed.">        if (uiState.value !is Content || verticalChanged) {</span>
<span class="nc" id="L71">            analyticsTracker.trackSiteDesignViewed(selectedPreviewMode().key)</span>
<span class="nc" id="L72">            fetchLayouts()</span>
        }
<span class="nc" id="L74">    }</span>

    override fun fetchLayouts(preferCache: Boolean) {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (!networkUtils.isNetworkAvailable()) {</span>
<span class="nc" id="L78">            analyticsTracker.trackErrorShown(ERROR_CONTEXT, INTERNET_UNAVAILABLE_ERROR, &quot;Retry error&quot;)</span>
<span class="nc" id="L79">            updateUiState(Error(toast = R.string.hpp_retry_error))</span>
<span class="nc" id="L80">            return</span>
        }
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (isLoading) return</span>
<span class="nc" id="L83">        updateUiState(Loading)</span>
<span class="nc" id="L84">        launch {</span>
<span class="nc" id="L85">            val event = fetchHomePageLayoutsUseCase.fetchStarterDesigns()</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            withContext(mainDispatcher) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                if (event.isError) {</span>
<span class="nc" id="L88">                    analyticsTracker.trackErrorShown(ERROR_CONTEXT, UNKNOWN, &quot;Error fetching designs&quot;)</span>
<span class="nc" id="L89">                    updateUiState(Error())</span>
                } else {
<span class="nc" id="L91">                    recommendationProvider.handleResponse(</span>
<span class="nc" id="L92">                            vertical,</span>
<span class="nc" id="L93">                            event.designs,</span>
<span class="nc" id="L94">                            event.categories,</span>
<span class="nc" id="L95">                            this@HomePagePickerViewModel::handleResponse</span>
                    )
                }
<span class="nc" id="L98">            }</span>
<span class="nc" id="L99">        }</span>
<span class="nc" id="L100">    }</span>

    override fun onLayoutTapped(layoutSlug: String, isRecommended: Boolean) {
<span class="nc bnc" id="L103" title="All 4 branches missed.">        (uiState.value as? Content)?.let {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (it.loadedThumbnailSlugs.contains(layoutSlug)) {</span>
<span class="nc" id="L105">                updateUiState(it.copy(selectedLayoutSlug = layoutSlug, isSelectedLayoutRecommended = isRecommended))</span>
<span class="nc" id="L106">                onPreviewTapped()</span>
<span class="nc" id="L107">                loadLayouts()</span>
            }
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">    }</span>

    override fun onPreviewChooseTapped() {
<span class="nc" id="L113">        onChooseTapped()</span>
<span class="nc" id="L114">    }</span>

    fun onChooseTapped() {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        selectedLayout?.let { layout -&gt;</span>
<span class="nc" id="L118">            super.onPreviewChooseTapped()</span>
<span class="nc" id="L119">            val template = layout.slug</span>
<span class="nc bnc" id="L120" title="All 6 branches missed.">            val isRecommended = (uiState.value as? Content)?.isSelectedLayoutRecommended == true</span>
<span class="nc" id="L121">            analyticsTracker.trackSiteDesignSelected(template, isRecommended)</span>
<span class="nc" id="L122">            _onDesignActionPressed.value = DesignSelectionAction.Choose(template)</span>
<span class="nc" id="L123">            return</span>
        }
<span class="nc" id="L125">        analyticsTracker.trackErrorShown(ERROR_CONTEXT, UNKNOWN, &quot;Error choosing design&quot;)</span>
<span class="nc" id="L126">        updateUiState(Error(toast = R.string.hpp_choose_error))</span>
<span class="nc" id="L127">    }</span>

    fun onSkippedTapped() {
<span class="nc" id="L130">        analyticsTracker.trackSiteDesignSkipped()</span>
<span class="nc" id="L131">        _onDesignActionPressed.value = DesignSelectionAction.Skip</span>
<span class="nc" id="L132">    }</span>

<span class="nc" id="L134">    fun onBackPressed() = _onBackButtonPressed.call()</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>