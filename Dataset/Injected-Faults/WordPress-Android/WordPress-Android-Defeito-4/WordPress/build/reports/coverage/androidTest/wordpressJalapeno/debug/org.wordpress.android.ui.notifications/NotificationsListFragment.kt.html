<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationsListFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.notifications</a> &gt; <span class="el_source">NotificationsListFragment.kt</span></div><h1>NotificationsListFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.notifications

import android.app.Activity
import android.content.Intent
import android.os.Bundle
import android.os.Parcelable
import android.text.Html
import android.text.TextUtils
import android.view.Menu
import android.view.MenuInflater
import android.view.MenuItem
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentManager
import androidx.fragment.app.FragmentPagerAdapter
import com.google.android.material.appbar.AppBarLayout.LayoutParams
import com.google.android.material.tabs.TabLayout.OnTabSelectedListener
import com.google.android.material.tabs.TabLayout.Tab
import org.greenrobot.eventbus.EventBus
import org.wordpress.android.R
import org.wordpress.android.WordPress
import org.wordpress.android.analytics.AnalyticsTracker
import org.wordpress.android.analytics.AnalyticsTracker.NOTIFICATIONS_SELECTED_FILTER
import org.wordpress.android.analytics.AnalyticsTracker.Stat.NOTIFICATION_TAPPED_SEGMENTED_CONTROL
import org.wordpress.android.databinding.NotificationsListFragmentBinding
import org.wordpress.android.fluxc.store.AccountStore
import org.wordpress.android.ui.ActivityLauncher
import org.wordpress.android.ui.JetpackConnectionSource.NOTIFICATIONS
import org.wordpress.android.ui.JetpackConnectionWebViewActivity
import org.wordpress.android.ui.RequestCodes
import org.wordpress.android.ui.ScrollableViewInitializedListener
import org.wordpress.android.ui.WPWebViewActivity
import org.wordpress.android.ui.main.WPMainActivity
import org.wordpress.android.ui.notifications.NotificationEvents.NotificationsUnseenStatus
import org.wordpress.android.ui.notifications.adapters.NotesAdapter.FILTERS
import org.wordpress.android.ui.notifications.adapters.NotesAdapter.FILTERS.FILTER_ALL
import org.wordpress.android.ui.notifications.adapters.NotesAdapter.FILTERS.FILTER_COMMENT
import org.wordpress.android.ui.notifications.adapters.NotesAdapter.FILTERS.FILTER_FOLLOW
import org.wordpress.android.ui.notifications.adapters.NotesAdapter.FILTERS.FILTER_LIKE
import org.wordpress.android.ui.notifications.adapters.NotesAdapter.FILTERS.FILTER_UNREAD
import org.wordpress.android.ui.notifications.services.NotificationsUpdateServiceStarter
import org.wordpress.android.ui.notifications.services.NotificationsUpdateServiceStarter.IS_TAPPED_ON_NOTIFICATION
import org.wordpress.android.ui.stats.StatsConnectJetpackActivity
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T.NOTIFS
import org.wordpress.android.util.NetworkUtils
import org.wordpress.android.util.WPUrlUtils
import org.wordpress.android.util.extensions.setLiftOnScrollTargetViewIdAndRequestLayout
import java.util.HashMap
import javax.inject.Inject

<span class="nc" id="L53">class NotificationsListFragment : Fragment(R.layout.notifications_list_fragment), ScrollableViewInitializedListener {</span>
    private var shouldRefreshNotifications = false
    private var lastTabPosition = 0

<span class="nc bnc" id="L57" title="All 2 branches missed.">    @Inject lateinit var accountStore: AccountStore</span>

    private var binding: NotificationsListFragmentBinding? = null

    override fun onActivityCreated(savedInstanceState: Bundle?) {
<span class="nc" id="L62">        super.onActivityCreated(savedInstanceState)</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (savedInstanceState != null) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">            binding?.setSelectedTab(savedInstanceState.getInt(KEY_LAST_TAB_POSITION, TAB_POSITION_ALL))</span>
        }
<span class="nc" id="L66">    }</span>

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L69">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc" id="L71">        shouldRefreshNotifications = true</span>
<span class="nc" id="L72">    }</span>

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L75">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L76">        setHasOptionsMenu(true)</span>
<span class="nc" id="L77">        binding = NotificationsListFragmentBinding.bind(view).apply {</span>
<span class="nc" id="L78">            toolbarMain.setTitle(R.string.notifications_screen_title)</span>
<span class="nc" id="L79">            (requireActivity() as AppCompatActivity).setSupportActionBar(toolbarMain)</span>

<span class="nc" id="L81">            tabLayout.addOnTabSelectedListener(object : OnTabSelectedListener {</span>
                override fun onTabSelected(tab: Tab) {
<span class="nc" id="L83">                    val properties: MutableMap&lt;String, String?&gt; = HashMap(1)</span>
<span class="nc bnc" id="L84" title="All 6 branches missed.">                    when (tab.position) {</span>
<span class="nc" id="L85">                        TAB_POSITION_ALL -&gt; properties[NOTIFICATIONS_SELECTED_FILTER] = FILTER_ALL.toString()</span>
<span class="nc" id="L86">                        TAB_POSITION_COMMENT -&gt; properties[NOTIFICATIONS_SELECTED_FILTER] = FILTER_COMMENT.toString()</span>
<span class="nc" id="L87">                        TAB_POSITION_FOLLOW -&gt; properties[NOTIFICATIONS_SELECTED_FILTER] = FILTER_FOLLOW.toString()</span>
<span class="nc" id="L88">                        TAB_POSITION_LIKE -&gt; properties[NOTIFICATIONS_SELECTED_FILTER] = FILTER_LIKE.toString()</span>
<span class="nc" id="L89">                        TAB_POSITION_UNREAD -&gt; properties[NOTIFICATIONS_SELECTED_FILTER] = FILTER_UNREAD.toString()</span>
<span class="nc" id="L90">                        else -&gt; properties[NOTIFICATIONS_SELECTED_FILTER] = FILTER_ALL.toString()</span>
                    }
<span class="nc" id="L92">                    AnalyticsTracker.track(NOTIFICATION_TAPPED_SEGMENTED_CONTROL, properties)</span>
<span class="nc" id="L93">                    lastTabPosition = tab.position</span>
<span class="nc" id="L94">                }</span>

<span class="nc" id="L96">                override fun onTabUnselected(tab: Tab) {}</span>
<span class="nc" id="L97">                override fun onTabReselected(tab: Tab) {}</span>
            })
<span class="nc" id="L99">            viewPager.adapter = NotificationsFragmentAdapter(childFragmentManager, buildTitles())</span>
<span class="nc" id="L100">            viewPager.pageMargin = resources.getDimensionPixelSize(R.dimen.margin_extra_large)</span>
<span class="nc" id="L101">            tabLayout.setupWithViewPager(viewPager)</span>

<span class="nc" id="L103">            jetpackTermsAndConditions.text = Html.fromHtml(</span>
<span class="nc" id="L104">                    String.format(resources.getString(R.string.jetpack_connection_terms_and_conditions), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;)</span>
            )
<span class="nc" id="L106">            jetpackTermsAndConditions.setOnClickListener {</span>
<span class="nc" id="L107">                WPWebViewActivity.openURL(requireContext(), WPUrlUtils.buildTermsOfServiceUrl(context))</span>
<span class="nc" id="L108">            }</span>
<span class="nc" id="L109">            jetpackFaq.setOnClickListener {</span>
<span class="nc" id="L110">                WPWebViewActivity.openURL(requireContext(), StatsConnectJetpackActivity.FAQ_URL)</span>
<span class="nc" id="L111">            }</span>
<span class="nc" id="L112">        }</span>
<span class="nc" id="L113">    }</span>

    private fun buildTitles(): List&lt;String&gt; {
<span class="nc" id="L116">        val result: ArrayList&lt;String&gt; = ArrayList(TAB_COUNT)</span>
<span class="nc" id="L117">        result.add(TAB_POSITION_ALL, getString(R.string.notifications_tab_title_all))</span>
<span class="nc" id="L118">        result.add(TAB_POSITION_UNREAD, getString(R.string.notifications_tab_title_unread_notifications))</span>
<span class="nc" id="L119">        result.add(TAB_POSITION_COMMENT, getString(R.string.notifications_tab_title_comments))</span>
<span class="nc" id="L120">        result.add(TAB_POSITION_FOLLOW, getString(R.string.notifications_tab_title_follows))</span>
<span class="nc" id="L121">        result.add(TAB_POSITION_LIKE, getString(R.string.notifications_tab_title_likes))</span>
<span class="nc" id="L122">        return result</span>
    }

    override fun onPause() {
<span class="nc" id="L126">        super.onPause()</span>
<span class="nc" id="L127">        shouldRefreshNotifications = true</span>
<span class="nc" id="L128">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L131">        super.onDestroyView()</span>
<span class="nc" id="L132">        binding = null</span>
<span class="nc" id="L133">    }</span>

    override fun onResume() {
<span class="nc" id="L136">        super.onResume()</span>
<span class="nc" id="L137">        EventBus.getDefault().post(NotificationsUnseenStatus(false))</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        binding?.apply {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (!accountStore.hasAccessToken()) {</span>
<span class="nc" id="L140">                showConnectJetpackView()</span>
<span class="nc" id="L141">                connectJetpack.visibility = View.VISIBLE</span>
<span class="nc" id="L142">                tabLayout.visibility = View.GONE</span>
<span class="nc" id="L143">                viewPager.visibility = View.GONE</span>
            } else {
<span class="nc" id="L145">                connectJetpack.visibility = View.GONE</span>
<span class="nc" id="L146">                tabLayout.visibility = View.VISIBLE</span>
<span class="nc" id="L147">                viewPager.visibility = View.VISIBLE</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                if (shouldRefreshNotifications) {</span>
<span class="nc" id="L149">                    fetchNotesFromRemote()</span>
                }
            }
<span class="nc" id="L152">            setSelectedTab(lastTabPosition)</span>
<span class="nc" id="L153">        }</span>
<span class="nc" id="L154">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc" id="L157">        outState.putInt(KEY_LAST_TAB_POSITION, lastTabPosition)</span>
<span class="nc" id="L158">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L159">    }</span>

    private fun NotificationsListFragmentBinding.clearToolbarScrollFlags() {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (toolbarMain.layoutParams is LayoutParams) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            val params = toolbarMain.layoutParams as LayoutParams</span>
<span class="nc" id="L164">            params.scrollFlags = 0</span>
        }
<span class="nc" id="L166">    }</span>

    private fun fetchNotesFromRemote() {
<span class="nc bnc" id="L169" title="All 4 branches missed.">        if (!isAdded || !NetworkUtils.isNetworkAvailable(activity)) {</span>
<span class="nc" id="L170">            return</span>
        }
<span class="nc" id="L172">        NotificationsUpdateServiceStarter.startService(activity)</span>
<span class="nc" id="L173">    }</span>

    private fun NotificationsListFragmentBinding.setSelectedTab(position: Int) {
<span class="nc" id="L176">        lastTabPosition = position</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        tabLayout.getTabAt(lastTabPosition)?.select()</span>
<span class="nc" id="L178">    }</span>

    private fun NotificationsListFragmentBinding.showConnectJetpackView() {
<span class="nc" id="L181">        clearToolbarScrollFlags()</span>
<span class="nc" id="L182">        jetpackSetup.setOnClickListener {</span>
<span class="nc bnc" id="L183" title="All 4 branches missed.">            val selectedSite = (requireActivity() as? WPMainActivity)?.selectedSite</span>
<span class="nc" id="L184">            JetpackConnectionWebViewActivity.startJetpackConnectionFlow(activity, NOTIFICATIONS, selectedSite, false)</span>
<span class="nc" id="L185">        }</span>
<span class="nc" id="L186">    }</span>

<span class="nc" id="L188">    private class NotificationsFragmentAdapter(</span>
        fragmentManager: FragmentManager,
<span class="nc" id="L190">        private val titles: List&lt;String&gt;</span>
<span class="nc" id="L191">    ) : FragmentPagerAdapter(fragmentManager, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT) {</span>
        override fun getCount(): Int {
<span class="nc" id="L193">            return TAB_COUNT</span>
        }

        override fun getItem(position: Int): Fragment {
<span class="nc" id="L197">            return NotificationsListFragmentPage.newInstance(position)</span>
        }

        override fun getPageTitle(position: Int): CharSequence? {
<span class="nc bnc" id="L201" title="All 4 branches missed.">            if (titles.size &gt; position &amp;&amp; position &gt;= 0) {</span>
<span class="nc" id="L202">                return titles[position]</span>
            }
<span class="nc" id="L204">            return super.getPageTitle(position)</span>
        }

        override fun restoreState(state: Parcelable?, loader: ClassLoader?) {
<span class="nc" id="L208">            try {</span>
<span class="nc" id="L209">                super.restoreState(state, loader)</span>
<span class="nc" id="L210">            } catch (exception: IllegalStateException) {</span>
<span class="nc" id="L211">                AppLog.e(NOTIFS, exception)</span>
            }
<span class="nc" id="L213">        }</span>
    }

    override fun onPrepareOptionsMenu(menu: Menu) {
<span class="nc" id="L217">        val notificationSettings = menu.findItem(R.id.notifications_settings)</span>
<span class="nc" id="L218">        notificationSettings.isVisible = accountStore.hasAccessToken()</span>
<span class="nc" id="L219">        super.onPrepareOptionsMenu(menu)</span>
<span class="nc" id="L220">    }</span>

    override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
<span class="nc" id="L223">        inflater.inflate(R.menu.notifications_list_menu, menu)</span>
<span class="nc" id="L224">        super.onCreateOptionsMenu(menu, inflater)</span>
<span class="nc" id="L225">    }</span>

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (item.itemId == R.id.notifications_settings) {</span>
<span class="nc" id="L229">            ActivityLauncher.viewNotificationsSettings(activity)</span>
<span class="nc" id="L230">            return true</span>
        }
<span class="nc" id="L232">        return super.onOptionsItemSelected(item)</span>
    }

    companion object {
        const val NOTE_ID_EXTRA = &quot;noteId&quot;
        const val NOTE_INSTANT_REPLY_EXTRA = &quot;instantReply&quot;
        const val NOTE_PREFILLED_REPLY_EXTRA = &quot;prefilledReplyText&quot;
        const val NOTE_MODERATE_ID_EXTRA = &quot;moderateNoteId&quot;
        const val NOTE_MODERATE_STATUS_EXTRA = &quot;moderateNoteStatus&quot;
        const val NOTE_CURRENT_LIST_FILTER_EXTRA = &quot;currentFilter&quot;
        private const val TAB_COUNT = 5
        const val TAB_POSITION_ALL = 0
        const val TAB_POSITION_UNREAD = 1
        const val TAB_POSITION_COMMENT = 2
        const val TAB_POSITION_FOLLOW = 3
        const val TAB_POSITION_LIKE = 4
        private const val KEY_LAST_TAB_POSITION = &quot;lastTabPosition&quot;
        fun newInstance(): NotificationsListFragment {
<span class="nc" id="L250">            return NotificationsListFragment()</span>
        }

        private fun getOpenNoteIntent(activity: Activity, noteId: String): Intent {
<span class="nc" id="L254">            val detailIntent = Intent(activity, NotificationsDetailActivity::class.java)</span>
<span class="nc" id="L255">            detailIntent.putExtra(NOTE_ID_EXTRA, noteId)</span>
<span class="nc" id="L256">            return detailIntent</span>
        }

        @JvmStatic fun openNoteForReply(
            activity: Activity?,
            noteId: String?,
            shouldShowKeyboard: Boolean,
            replyText: String?,
            filter: FILTERS?,
            isTappedFromPushNotification: Boolean
        ) {
<span class="nc bnc" id="L267" title="All 4 branches missed.">            if (noteId == null || activity == null) {</span>
<span class="nc" id="L268">                return</span>
            }
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (activity.isFinishing) {</span>
<span class="nc" id="L271">                return</span>
            }
<span class="nc" id="L273">            val detailIntent = getOpenNoteIntent(activity, noteId)</span>
<span class="nc" id="L274">            detailIntent.putExtra(NOTE_INSTANT_REPLY_EXTRA, shouldShowKeyboard)</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">            if (!TextUtils.isEmpty(replyText)) {</span>
<span class="nc" id="L276">                detailIntent.putExtra(NOTE_PREFILLED_REPLY_EXTRA, replyText)</span>
            }
<span class="nc" id="L278">            detailIntent.putExtra(NOTE_CURRENT_LIST_FILTER_EXTRA, filter)</span>
<span class="nc" id="L279">            detailIntent.putExtra(IS_TAPPED_ON_NOTIFICATION, isTappedFromPushNotification)</span>
<span class="nc" id="L280">            openNoteForReplyWithParams(detailIntent, activity)</span>
<span class="nc" id="L281">        }</span>

        private fun openNoteForReplyWithParams(detailIntent: Intent, activity: Activity) {
<span class="nc" id="L284">            activity.startActivityForResult(detailIntent, RequestCodes.NOTE_DETAIL)</span>
<span class="nc" id="L285">        }</span>
    }

    override fun onScrollableViewInitialized(containerId: Int) {
<span class="nc bnc" id="L289" title="All 4 branches missed.">        binding?.appBar?.setLiftOnScrollTargetViewIdAndRequestLayout(containerId)</span>
<span class="nc" id="L290">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>