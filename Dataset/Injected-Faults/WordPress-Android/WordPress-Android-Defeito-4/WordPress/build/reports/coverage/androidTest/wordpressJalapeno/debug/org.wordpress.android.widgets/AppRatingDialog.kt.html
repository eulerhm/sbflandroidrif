<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppRatingDialog.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.widgets</a> &gt; <span class="el_source">AppRatingDialog.kt</span></div><h1>AppRatingDialog.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.widgets

import android.app.Dialog
import android.app.DialogFragment
import android.app.FragmentManager
import android.content.Context
import android.content.DialogInterface
import android.content.Intent
import android.content.SharedPreferences
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Bundle
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import org.wordpress.android.R
import org.wordpress.android.analytics.AnalyticsTracker
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import java.util.Date
import java.util.concurrent.TimeUnit

object AppRatingDialog {
    private const val PREF_NAME = &quot;rate_wpandroid&quot;
    private const val KEY_INSTALL_DATE = &quot;rate_install_date&quot;
    private const val KEY_LAUNCH_TIMES = &quot;rate_launch_times&quot;
    private const val KEY_OPT_OUT = &quot;rate_opt_out&quot;
    private const val KEY_ASK_LATER_DATE = &quot;rate_ask_later_date&quot;
    private const val KEY_INTERACTIONS = &quot;rate_interactions&quot;

    // app must have been installed this long before the rating dialog will appear
    private const val CRITERIA_INSTALL_DAYS: Int = 7
    // app must have been launched this many times before the rating dialog will appear
    private const val CRITERIA_LAUNCH_TIMES: Int = 10
    // user must have performed this many interactions before the rating dialog will appear
    private const val CRITERIA_INTERACTIONS: Int = 10

<span class="fc" id="L36">    private var installDate = Date()</span>
<span class="fc" id="L37">    private var askLaterDate = Date()</span>
    private var launchTimes = 0
    private var interactions = 0
    private var optOut = false

    private lateinit var preferences: SharedPreferences

    /**
     * Call this when the launcher activity is launched.
     */
    fun init(context: Context) {
<span class="fc" id="L48">        preferences = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)</span>
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">        val editor = preferences.edit()</span>

        // If it is the first launch, save the date in shared preference.
<span class="pc bpc" id="L52" title="2 of 4 branches missed.">        if (preferences.getLong(KEY_INSTALL_DATE, 0) == 0L) {</span>
<span class="nc" id="L53">            storeInstallDate(context)</span>
        }

        // Increment launch times
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        launchTimes = preferences.getInt(KEY_LAUNCH_TIMES, 0)</span>
<span class="fc" id="L58">        launchTimes++</span>
<span class="fc" id="L59">        editor.putInt(KEY_LAUNCH_TIMES, launchTimes)</span>
<span class="fc" id="L60">        editor.apply()</span>

<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        interactions = preferences.getInt(KEY_INTERACTIONS, 0)</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        optOut = preferences.getBoolean(KEY_OPT_OUT, false)</span>
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        installDate = Date(preferences.getLong(KEY_INSTALL_DATE, 0))</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        askLaterDate = Date(preferences.getLong(KEY_ASK_LATER_DATE, 0))</span>
<span class="fc" id="L66">    }</span>

    /**
     * Show the rate dialog if the criteria is satisfied.
     * @return true if shown, false otherwise.
     */
    fun showRateDialogIfNeeded(fragmentManger: FragmentManager): Boolean {
<span class="nc bnc" id="L73" title="All 2 branches missed.">        return if (shouldShowRateDialog()) {</span>
<span class="nc" id="L74">            showRateDialog(fragmentManger)</span>
<span class="nc" id="L75">            true</span>
        } else {
<span class="nc" id="L77">            false</span>
        }
    }

    /**
     * Called from various places in the app where the user has performed a non-trivial action, such as publishing post
     * or page. We use this to avoid showing the rating dialog to uninvolved users
     */
    fun incrementInteractions(incrementInteractionTracker: AnalyticsTracker.Stat) {
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!optOut) {</span>
<span class="nc" id="L87">            interactions++</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">            preferences.edit().putInt(KEY_INTERACTIONS, interactions)?.apply()</span>
<span class="nc" id="L89">            AnalyticsTracker.track(incrementInteractionTracker)</span>
        }
<span class="nc" id="L91">    }</span>

    /**
     * Check whether the rate dialog should be shown or not.
     * @return true if the dialog should be shown
     */
    private fun shouldShowRateDialog(): Boolean {
<span class="nc bnc" id="L98" title="All 6 branches missed.">        return if (optOut or (launchTimes &lt; CRITERIA_LAUNCH_TIMES) or (interactions &lt; CRITERIA_INTERACTIONS)) {</span>
<span class="nc" id="L99">            false</span>
        } else {
<span class="nc" id="L101">            val thresholdMs = TimeUnit.DAYS.toMillis(CRITERIA_INSTALL_DAYS.toLong())</span>
<span class="nc bnc" id="L102" title="All 4 branches missed.">            Date().time - installDate.time &gt;= thresholdMs &amp;&amp; Date().time - askLaterDate.time &gt;= thresholdMs</span>
        }
    }

    private fun showRateDialog(fragmentManger: FragmentManager) {
<span class="nc" id="L107">        var dialog = fragmentManger.findFragmentByTag(AppRatingDialog.TAG_APP_RATING_PROMPT_DIALOG)</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (dialog == null) {</span>
<span class="nc" id="L109">            dialog = AppRatingDialog()</span>
<span class="nc" id="L110">            dialog.show(fragmentManger, AppRatingDialog.TAG_APP_RATING_PROMPT_DIALOG)</span>
<span class="nc" id="L111">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_REVIEWS_SAW_PROMPT)</span>
        }
<span class="nc" id="L113">    }</span>

<span class="nc" id="L115">    class AppRatingDialog : DialogFragment() {</span>
        companion object {
            internal const val TAG_APP_RATING_PROMPT_DIALOG = &quot;TAG_APP_RATING_PROMPT_DIALOG&quot;
        }

        override fun onCreateDialog(savedInstanceState: Bundle?): Dialog {
<span class="nc" id="L121">            val builder = MaterialAlertDialogBuilder(activity)</span>
<span class="nc" id="L122">            builder.setTitle(R.string.app_rating_title)</span>
<span class="nc" id="L123">                    .setMessage(R.string.app_rating_message)</span>
<span class="nc" id="L124">                    .setCancelable(true)</span>
<span class="nc" id="L125">                    .setPositiveButton(R.string.app_rating_rate_now) { _, _ -&gt;</span>
<span class="nc" id="L126">                        val appPackage = activity.packageName</span>
<span class="nc" id="L127">                        val url: String? = &quot;market://details?id=$appPackage&quot;</span>
<span class="nc" id="L128">                        try {</span>
<span class="nc" id="L129">                            activity.startActivity(Intent(Intent.ACTION_VIEW, Uri.parse(url)))</span>
<span class="nc" id="L130">                        } catch (e: android.content.ActivityNotFoundException) {</span>
                            // play store app isn't on this device so open app's page in browser instead
<span class="nc" id="L132">                            activity.startActivity(</span>
<span class="nc" id="L133">                                    Intent(</span>
<span class="nc" id="L134">                                            Intent.ACTION_VIEW,</span>
<span class="nc" id="L135">                                            Uri.parse(</span>
<span class="nc" id="L136">                                                    &quot;http://play.google.com/store/apps/details?id=&quot; +</span>
<span class="nc" id="L137">                                                            activity.packageName</span>
                                            )
                                    )
                            )
                        }

<span class="nc" id="L143">                        setOptOut(true)</span>
<span class="nc" id="L144">                        AnalyticsTracker.track(AnalyticsTracker.Stat.APP_REVIEWS_RATED_APP)</span>
<span class="nc" id="L145">                    }</span>
<span class="nc" id="L146">                    .setNeutralButton(R.string.app_rating_rate_later) { _, _ -&gt;</span>
<span class="nc" id="L147">                        clearSharedPreferences()</span>
<span class="nc" id="L148">                        storeAskLaterDate()</span>
<span class="nc" id="L149">                        AnalyticsTracker.track(AnalyticsTracker.Stat.APP_REVIEWS_DECIDED_TO_RATE_LATER)</span>
<span class="nc" id="L150">                    }</span>
<span class="nc" id="L151">                    .setNegativeButton(R.string.app_rating_rate_never) { _, _ -&gt;</span>
<span class="nc" id="L152">                        setOptOut(true)</span>
<span class="nc" id="L153">                        AnalyticsTracker.track(AnalyticsTracker.Stat.APP_REVIEWS_DECLINED_TO_RATE_APP)</span>
<span class="nc" id="L154">                    }</span>
<span class="nc" id="L155">            return builder.create()</span>
        }

        override fun onCancel(dialog: DialogInterface?) {
<span class="nc" id="L159">            super.onCancel(dialog)</span>
<span class="nc" id="L160">            clearSharedPreferences()</span>
<span class="nc" id="L161">            storeAskLaterDate()</span>
<span class="nc" id="L162">            AnalyticsTracker.track(AnalyticsTracker.Stat.APP_REVIEWS_CANCELLED_PROMPT)</span>
<span class="nc" id="L163">        }</span>
    }

    /**
     * Clear data other than opt-out in shared preferences - called when the &quot;Later&quot; is pressed or dialog is canceled.
     */
    private fun clearSharedPreferences() {
<span class="nc bnc" id="L170" title="All 8 branches missed.">        preferences.edit().remove(KEY_INSTALL_DATE)?.remove(KEY_LAUNCH_TIMES)?.remove(KEY_INTERACTIONS)?.apply()</span>
<span class="nc" id="L171">    }</span>

    /**
     * Set opt out flag - when true, the rate dialog will never be shown unless app data is cleared.
     */
    private fun setOptOut(optOut: Boolean) {
<span class="nc bnc" id="L177" title="All 4 branches missed.">        preferences.edit().putBoolean(KEY_OPT_OUT, optOut)?.apply()</span>
<span class="nc" id="L178">        this.optOut = optOut</span>
<span class="nc" id="L179">    }</span>

    /**
     * Store install date - retrieved from package manager if possible.
     */
    private fun storeInstallDate(context: Context) {
<span class="nc" id="L185">        var installDate = Date()</span>
<span class="nc" id="L186">        val packMan = context.packageManager</span>
<span class="nc" id="L187">        try {</span>
<span class="nc" id="L188">            val pkgInfo = packMan.getPackageInfo(context.packageName, 0)</span>
<span class="nc" id="L189">            installDate = Date(pkgInfo.firstInstallTime)</span>
<span class="nc" id="L190">        } catch (e: PackageManager.NameNotFoundException) {</span>
<span class="nc" id="L191">            AppLog.e(T.UTILS, e)</span>
        }
<span class="nc bnc" id="L193" title="All 4 branches missed.">        preferences.edit().putLong(KEY_INSTALL_DATE, installDate.time)?.apply()</span>
<span class="nc" id="L194">    }</span>

    /**
     * Store the date the user asked for being asked again later.
     */
    private fun storeAskLaterDate() {
<span class="nc" id="L200">        val nextAskDate = System.currentTimeMillis()</span>
<span class="nc bnc" id="L201" title="All 4 branches missed.">        preferences.edit().putLong(KEY_ASK_LATER_DATE, nextAskDate)?.apply()</span>
<span class="nc" id="L202">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>