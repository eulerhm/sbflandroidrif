<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommentFullScreenDialogFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui</a> &gt; <span class="el_source">CommentFullScreenDialogFragment.kt</span></div><h1>CommentFullScreenDialogFragment.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui

import android.content.Context
import android.os.Bundle
import android.text.Editable
import android.text.TextUtils
import android.text.TextWatcher
import android.view.KeyEvent
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.view.inputmethod.EditorInfo
import android.view.inputmethod.InputMethodManager
import android.widget.TextView
import androidx.fragment.app.Fragment
import dagger.android.support.AndroidSupportInjection
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.store.SiteStore
import org.wordpress.android.ui.CollapseFullScreenDialogFragment.CollapseFullScreenDialogContent
import org.wordpress.android.ui.CollapseFullScreenDialogFragment.CollapseFullScreenDialogController
import org.wordpress.android.ui.suggestion.util.SuggestionServiceConnectionManager
import org.wordpress.android.ui.suggestion.util.SuggestionUtils
import org.wordpress.android.util.SiteUtils
import org.wordpress.android.viewmodel.observeEvent
import org.wordpress.android.widgets.SuggestionAutoCompleteText
import javax.inject.Inject

<span class="nc" id="L32">class CommentFullScreenDialogFragment : Fragment(), CollapseFullScreenDialogContent {</span>
<span class="nc bnc" id="L33" title="All 2 branches missed.">    @Inject lateinit var viewModel: CommentFullScreenDialogViewModel</span>
<span class="nc bnc" id="L34" title="All 2 branches missed.">    @Inject lateinit var siteStore: SiteStore</span>
    private lateinit var dialogController: CollapseFullScreenDialogController
    private lateinit var reply: SuggestionAutoCompleteText
<span class="nc" id="L37">    private val coroutineScope = CoroutineScope(Dispatchers.Default)</span>

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
<span class="nc bnc" id="L44" title="All 2 branches missed.">        val layout = inflater.inflate(R.layout.comment_dialog_fragment, container, false) as ViewGroup</span>
<span class="nc" id="L45">        reply = layout.findViewById(R.id.edit_comment_expand)</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        reply.initializeWithPrefix('@')</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        reply.requestFocus()</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">        reply.addTextChangedListener(object : TextWatcher {</span>
<span class="nc" id="L49">            override fun beforeTextChanged(s: CharSequence, start: Int, count: Int, after: Int) {}</span>

<span class="nc" id="L51">            override fun onTextChanged(s: CharSequence, start: Int, before: Int, count: Int) {}</span>

            override fun afterTextChanged(s: Editable) {
<span class="nc bnc" id="L54" title="All 4 branches missed.">                dialogController.setConfirmEnabled(!TextUtils.isEmpty(s.toString().trim()))</span>
<span class="nc" id="L55">            }</span>
        })

<span class="nc bnc" id="L58" title="All 2 branches missed.">        reply.setOnEditorActionListener { _: TextView?, actionId: Int, _: KeyEvent? -&gt;</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">            if (actionId == EditorInfo.IME_ACTION_DONE || actionId == EditorInfo.IME_ACTION_SEND) {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">                dialogController.confirm(saveResult())</span>
            }
<span class="nc" id="L62">            false</span>
        }

<span class="nc" id="L65">        viewModel.onKeyboardOpened.observeEvent(viewLifecycleOwner, {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            coroutineScope.launch {</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">                val imm = activity?.getSystemService(Context.INPUT_METHOD_SERVICE) as? InputMethodManager</span>
<span class="nc bnc" id="L68" title="All 4 branches missed.">                imm?.showSoftInput(reply, InputMethodManager.SHOW_IMPLICIT)</span>
<span class="nc" id="L69">            }</span>
<span class="nc" id="L70">        })</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">        arguments?.let {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            reply.setText(it.getString(EXTRA_REPLY))</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            reply.setSelection(it.getInt(EXTRA_SELECTION_START), it.getInt(EXTRA_SELECTION_END))</span>
<span class="nc" id="L75">            viewModel.init()</span>

            // Allow @username suggestion in full screen comment Editor on the Reader,
            // but only on sites in the siteStore (i.e: current user's site).
            // No suggestion is available for external sites that the user follows in the Reader.
<span class="nc" id="L80">            val siteModel: SiteModel? = siteStore.getSiteBySiteId(it.getLong(EXTRA_SITE_ID))</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            if (siteModel != null) {</span>
<span class="nc" id="L82">                setupSuggestionServiceAndAdapter(siteModel)</span>
            }
<span class="nc" id="L84">        }</span>

<span class="nc" id="L86">        return layout</span>
    }

    private fun setupSuggestionServiceAndAdapter(site: SiteModel) {
<span class="nc bnc" id="L90" title="All 4 branches missed.">        if (!isAdded || !SiteUtils.isAccessedViaWPComRest(site)) {</span>
<span class="nc" id="L91">            return</span>
        }
<span class="nc" id="L93">        val suggestionServiceConnectionManager = SuggestionServiceConnectionManager(</span>
<span class="nc" id="L94">                activity,</span>
<span class="nc" id="L95">                site.siteId</span>
        )
<span class="nc" id="L97">        val suggestionAdapter = SuggestionUtils.setupUserSuggestions(</span>
<span class="nc" id="L98">                site, requireActivity(),</span>
<span class="nc" id="L99">                suggestionServiceConnectionManager</span>
        )
<span class="nc bnc" id="L101" title="All 2 branches missed.">        this.reply.setAdapter(suggestionAdapter)</span>
<span class="nc" id="L102">    }</span>

    override fun onCollapseClicked(controller: CollapseFullScreenDialogController): Boolean {
<span class="nc" id="L105">        controller.collapse(saveResult())</span>
<span class="nc" id="L106">        return true</span>
    }

    override fun onConfirmClicked(controller: CollapseFullScreenDialogController): Boolean {
<span class="nc" id="L110">        controller.confirm(saveResult())</span>
<span class="nc" id="L111">        return true</span>
    }

    private fun saveResult(): Bundle {
<span class="nc" id="L115">        val result = Bundle()</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        result.putString(RESULT_REPLY, reply.text.toString())</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        result.putInt(RESULT_SELECTION_START, reply.selectionStart)</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        result.putInt(RESULT_SELECTION_END, reply.selectionEnd)</span>
<span class="nc" id="L119">        return result</span>
    }

    override fun onViewCreated(controller: CollapseFullScreenDialogController) {
<span class="nc" id="L123">        dialogController = controller</span>
<span class="nc" id="L124">    }</span>

    override fun onAttach(context: Context) {
<span class="nc" id="L127">        super.onAttach(context)</span>
<span class="nc" id="L128">        AndroidSupportInjection.inject(this)</span>
<span class="nc" id="L129">    }</span>

    companion object {
        const val RESULT_REPLY = &quot;RESULT_REPLY&quot;
        const val RESULT_SELECTION_START = &quot;RESULT_SELECTION_START&quot;
        const val RESULT_SELECTION_END = &quot;RESULT_SELECTION_END&quot;

        private const val EXTRA_REPLY = &quot;EXTRA_REPLY&quot;
        private const val EXTRA_SELECTION_START = &quot;EXTRA_SELECTION_START&quot;
        private const val EXTRA_SELECTION_END = &quot;EXTRA_SELECTION_END&quot;
        private const val EXTRA_SITE_ID = &quot;EXTRA_SITE_ID&quot;

        fun newBundle(reply: String, selectionStart: Int, selectionEnd: Int, siteId: Long): Bundle {
<span class="nc" id="L142">            val bundle = Bundle()</span>
<span class="nc" id="L143">            bundle.putString(EXTRA_REPLY, reply)</span>
<span class="nc" id="L144">            bundle.putInt(EXTRA_SELECTION_START, selectionStart)</span>
<span class="nc" id="L145">            bundle.putInt(EXTRA_SELECTION_END, selectionEnd)</span>
<span class="nc" id="L146">            bundle.putLong(EXTRA_SITE_ID, siteId)</span>
<span class="nc" id="L147">            return bundle</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>