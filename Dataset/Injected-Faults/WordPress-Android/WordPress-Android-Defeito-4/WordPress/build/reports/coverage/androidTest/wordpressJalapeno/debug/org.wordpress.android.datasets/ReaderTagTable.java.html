<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReaderTagTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.datasets</a> &gt; <span class="el_source">ReaderTagTable.java</span></div><h1>ReaderTagTable.java</h1><pre class="source lang-java linenums">package org.wordpress.android.datasets;

import android.database.Cursor;
import android.database.SQLException;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteStatement;
import android.text.TextUtils;

import androidx.annotation.Nullable;

import org.wordpress.android.models.ReaderTag;
import org.wordpress.android.models.ReaderTagList;
import org.wordpress.android.models.ReaderTagType;
import org.wordpress.android.ui.reader.ReaderConstants;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.AppLog.T;
import org.wordpress.android.util.DateTimeUtils;
import org.wordpress.android.util.SqlUtils;

import java.util.Date;

/**
 * tbl_tags stores the list of tags the user subscribed to or has by default
 */
<span class="nc" id="L25">public class ReaderTagTable {</span>
    protected static void createTables(SQLiteDatabase db) {
<span class="nc" id="L27">        db.execSQL(&quot;CREATE TABLE tbl_tags (&quot;</span>
                   + &quot; tag_slug TEXT COLLATE NOCASE,&quot;
                   + &quot; tag_display_name TEXT COLLATE NOCASE,&quot;
                   + &quot; tag_title TEXT COLLATE NOCASE,&quot;
                   + &quot; tag_type INTEGER DEFAULT 0,&quot;
                   + &quot; endpoint TEXT,&quot;
                   + &quot; date_updated TEXT,&quot;
                   + &quot; PRIMARY KEY (tag_slug, tag_type)&quot;
                   + &quot;)&quot;);
<span class="nc" id="L36">    }</span>

    protected static void dropTables(SQLiteDatabase db) {
<span class="nc" id="L39">        db.execSQL(&quot;DROP TABLE IF EXISTS tbl_tags&quot;);</span>
<span class="nc" id="L40">    }</span>

    /*
     * returns true if tbl_tags is empty
     */
    public static boolean isEmpty() {
<span class="nc bnc" id="L46" title="All 2 branches missed.">        return (SqlUtils.getRowCount(ReaderDatabase.getReadableDb(), &quot;tbl_tags&quot;) == 0);</span>
    }

    /*
     * replaces all tags with the passed list
     */
    public static void replaceTags(ReaderTagList tags) {
<span class="nc bnc" id="L53" title="All 4 branches missed.">        if (tags == null || tags.size() == 0) {</span>
<span class="nc" id="L54">            return;</span>
        }

<span class="nc" id="L57">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L58">        db.beginTransaction();</span>
        try {
            try {
                // first delete all existing tags, then insert the passed ones
<span class="nc" id="L62">                db.execSQL(&quot;DELETE FROM tbl_tags&quot;);</span>
<span class="nc" id="L63">                addOrUpdateTags(tags);</span>
<span class="nc" id="L64">                db.setTransactionSuccessful();</span>
<span class="nc" id="L65">            } catch (SQLException e) {</span>
<span class="nc" id="L66">                AppLog.e(T.READER, e);</span>
<span class="nc" id="L67">            }</span>
        } finally {
<span class="nc" id="L69">            db.endTransaction();</span>
        }
<span class="nc" id="L71">    }</span>

    /*
     * similar to the above but only replaces followed tags
     */
    public static void replaceFollowedTags(ReaderTagList tags) {
<span class="nc bnc" id="L77" title="All 4 branches missed.">        if (tags == null || tags.size() == 0) {</span>
<span class="nc" id="L78">            return;</span>
        }

<span class="nc" id="L81">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L82">        db.beginTransaction();</span>
        try {
            try {
                // first delete all existing followed tags, then insert the passed ones
<span class="nc" id="L86">                String[] args = {Integer.toString(ReaderTagType.FOLLOWED.toInt())};</span>
<span class="nc" id="L87">                db.execSQL(&quot;DELETE FROM tbl_tags WHERE tag_type=?&quot;, args);</span>
<span class="nc" id="L88">                addOrUpdateTags(tags);</span>
<span class="nc" id="L89">                db.setTransactionSuccessful();</span>
<span class="nc" id="L90">            } catch (SQLException e) {</span>
<span class="nc" id="L91">                AppLog.e(T.READER, e);</span>
<span class="nc" id="L92">            }</span>
        } finally {
<span class="nc" id="L94">            db.endTransaction();</span>
        }
<span class="nc" id="L96">    }</span>

    public static void addOrUpdateTag(ReaderTag tag) {
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L100">            return;</span>
        }
<span class="nc" id="L102">        ReaderTagList tags = new ReaderTagList();</span>
<span class="nc" id="L103">        tags.add(tag);</span>
<span class="nc" id="L104">        addOrUpdateTags(tags);</span>
<span class="nc" id="L105">    }</span>

    public static void addOrUpdateTags(ReaderTagList tagList) {
<span class="nc bnc" id="L108" title="All 4 branches missed.">        if (tagList == null || tagList.size() == 0) {</span>
<span class="nc" id="L109">            return;</span>
        }
<span class="nc" id="L111">        SQLiteStatement stmt = null;</span>
        try {
<span class="nc" id="L113">            stmt = ReaderDatabase.getWritableDb().compileStatement(</span>
                    &quot;INSERT OR REPLACE INTO tbl_tags (tag_slug, tag_display_name, tag_title, tag_type, endpoint) &quot;
                    + &quot;VALUES (?1,?2,?3,?4,?5)&quot;);

<span class="nc bnc" id="L117" title="All 2 branches missed.">            for (ReaderTag tag : tagList) {</span>
<span class="nc" id="L118">                stmt.bindString(1, tag.getTagSlug());</span>
<span class="nc" id="L119">                stmt.bindString(2, tag.getTagDisplayName());</span>
<span class="nc" id="L120">                stmt.bindString(3, tag.getTagTitle());</span>
<span class="nc" id="L121">                stmt.bindLong(4, tag.tagType.toInt());</span>
<span class="nc" id="L122">                stmt.bindString(5, tag.getEndpoint());</span>
<span class="nc" id="L123">                stmt.execute();</span>
<span class="nc" id="L124">            }</span>
        } finally {
<span class="nc" id="L126">            SqlUtils.closeStatement(stmt);</span>
        }
<span class="nc" id="L128">    }</span>

    /*
     * returns true if the passed tag exists, regardless of type
     */
    public static boolean tagExists(ReaderTag tag) {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L135">            return false;</span>
        }
<span class="nc" id="L137">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L138">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                                     &quot;SELECT 1 FROM tbl_tags WHERE tag_slug=?1 AND tag_type=?2&quot;,
                                     args);
    }

    /*
     * returns true if the passed tag exists and it has the passed type
     */
    private static boolean tagExistsOfType(String tagSlug, ReaderTagType tagType) {
<span class="nc bnc" id="L147" title="All 4 branches missed.">        if (TextUtils.isEmpty(tagSlug) || tagType == null) {</span>
<span class="nc" id="L148">            return false;</span>
        }

<span class="nc" id="L151">        String[] args = {tagSlug, Integer.toString(tagType.toInt())};</span>
<span class="nc" id="L152">        return SqlUtils.boolForQuery(ReaderDatabase.getReadableDb(),</span>
                                     &quot;SELECT 1 FROM tbl_tags WHERE tag_slug=?1 AND tag_type=?2&quot;,
                                     args);
    }

    public static boolean isFollowedTagName(String tagSlug) {
<span class="nc" id="L158">        return tagExistsOfType(tagSlug, ReaderTagType.FOLLOWED);</span>
    }

    private static ReaderTag getTagFromCursor(Cursor c) {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L163">            throw new IllegalArgumentException(&quot;null tag cursor&quot;);</span>
        }

<span class="nc" id="L166">        String tagSlug = c.getString(c.getColumnIndexOrThrow(&quot;tag_slug&quot;));</span>
<span class="nc" id="L167">        String tagDisplayName = c.getString(c.getColumnIndexOrThrow(&quot;tag_display_name&quot;));</span>
<span class="nc" id="L168">        String tagTitle = c.getString(c.getColumnIndexOrThrow(&quot;tag_title&quot;));</span>
<span class="nc" id="L169">        String endpoint = c.getString(c.getColumnIndexOrThrow(&quot;endpoint&quot;));</span>
<span class="nc" id="L170">        ReaderTagType tagType = ReaderTagType.fromInt(c.getInt(c.getColumnIndexOrThrow(&quot;tag_type&quot;)));</span>

<span class="nc" id="L172">        return new ReaderTag(tagSlug, tagDisplayName, tagTitle, endpoint, tagType);</span>
    }

    public static ReaderTag getTag(String tagSlug, ReaderTagType tagType) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (TextUtils.isEmpty(tagSlug)) {</span>
<span class="nc" id="L177">            return null;</span>
        }

<span class="nc" id="L180">        String[] args = {tagSlug, Integer.toString(tagType.toInt())};</span>
<span class="nc" id="L181">        Cursor c = ReaderDatabase.getReadableDb()</span>
<span class="nc" id="L182">                                 .rawQuery(&quot;SELECT * FROM tbl_tags WHERE tag_slug=? AND tag_type=? LIMIT 1&quot;, args);</span>
        try {
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (!c.moveToFirst()) {</span>
<span class="nc" id="L185">                return null;</span>
            }
<span class="nc" id="L187">            return getTagFromCursor(c);</span>
        } finally {
<span class="nc" id="L189">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static ReaderTag getTagFromEndpoint(String endpoint) {
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (TextUtils.isEmpty(endpoint)) {</span>
<span class="nc" id="L195">            return null;</span>
        }

<span class="nc" id="L198">        String[] args = {&quot;%&quot; + endpoint};</span>
<span class="nc" id="L199">        String query = &quot;SELECT * FROM tbl_tags WHERE endpoint LIKE ? LIMIT 1&quot;;</span>
<span class="nc" id="L200">        Cursor cursor = ReaderDatabase.getReadableDb().rawQuery(query, args);</span>

        try {
<span class="nc bnc" id="L203" title="All 2 branches missed.">            return cursor.moveToFirst() ? getTagFromCursor(cursor) : null;</span>
        } finally {
<span class="nc" id="L205">            SqlUtils.closeCursor(cursor);</span>
        }
    }

    public static String getEndpointForTag(ReaderTag tag) {
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L211">            return null;</span>
        }
<span class="nc" id="L213">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L214">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(),</span>
                                       &quot;SELECT endpoint FROM tbl_tags WHERE tag_slug=? AND tag_type=?&quot;,
                                       args);
    }

    public static ReaderTagList getDefaultTags() {
<span class="nc" id="L220">        return getTagsOfType(ReaderTagType.DEFAULT);</span>
    }

    public static ReaderTagList getFollowedTags() {
<span class="nc" id="L224">        return getTagsOfType(ReaderTagType.FOLLOWED);</span>
    }

    public static ReaderTagList getCustomListTags() {
<span class="nc" id="L228">        return getTagsOfType(ReaderTagType.CUSTOM_LIST);</span>
    }

    public static ReaderTagList getBookmarkTags() {
<span class="nc" id="L232">        return getTagsOfType(ReaderTagType.BOOKMARKED);</span>
    }

    private static ReaderTagList getTagsOfType(ReaderTagType tagType) {
<span class="nc" id="L236">        String[] args = {Integer.toString(tagType.toInt())};</span>
<span class="nc" id="L237">        Cursor c = ReaderDatabase.getReadableDb()</span>
<span class="nc" id="L238">                                 .rawQuery(&quot;SELECT * FROM tbl_tags WHERE tag_type=? ORDER BY tag_slug&quot;, args);</span>
        try {
<span class="nc" id="L240">            ReaderTagList tagList = new ReaderTagList();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L243">                    tagList.add(getTagFromCursor(c));</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }
<span class="nc" id="L246">            return tagList;</span>
        } finally {
<span class="nc" id="L248">            SqlUtils.closeCursor(c);</span>
        }
    }

    static ReaderTagList getAllTags() {
<span class="nc" id="L253">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(&quot;SELECT * FROM tbl_tags ORDER BY tag_slug&quot;, null);</span>
        try {
<span class="nc" id="L255">            ReaderTagList tagList = new ReaderTagList();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
                do {
<span class="nc" id="L258">                    tagList.add(getTagFromCursor(c));</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                } while (c.moveToNext());</span>
            }
<span class="nc" id="L261">            return tagList;</span>
        } finally {
<span class="nc" id="L263">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static @Nullable ReaderTag getFirstTag() {
<span class="nc" id="L268">        Cursor c = ReaderDatabase.getReadableDb().rawQuery(&quot;SELECT * FROM tbl_tags ORDER BY tag_slug LIMIT 1&quot;, null);</span>
        try {
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (c.moveToFirst()) {</span>
<span class="nc" id="L271">                return getTagFromCursor(c);</span>
            }
<span class="nc" id="L273">            return null;</span>
        } finally {
<span class="nc" id="L275">            SqlUtils.closeCursor(c);</span>
        }
    }

    public static void deleteTag(ReaderTag tag) {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L281">            return;</span>
        }
<span class="nc" id="L283">        ReaderTagList tags = new ReaderTagList();</span>
<span class="nc" id="L284">        tags.add(tag);</span>
<span class="nc" id="L285">        deleteTags(tags);</span>
<span class="nc" id="L286">    }</span>

    public static void deleteTags(ReaderTagList tagList) {
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if (tagList == null || tagList.size() == 0) {</span>
<span class="nc" id="L290">            return;</span>
        }

<span class="nc" id="L293">        SQLiteDatabase db = ReaderDatabase.getWritableDb();</span>
<span class="nc" id="L294">        db.beginTransaction();</span>
        try {
<span class="nc bnc" id="L296" title="All 2 branches missed.">            for (ReaderTag tag : tagList) {</span>
<span class="nc" id="L297">                String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L298">                ReaderDatabase.getWritableDb().delete(&quot;tbl_tags&quot;, &quot;tag_slug=? AND tag_type=?&quot;, args);</span>
<span class="nc" id="L299">            }</span>
<span class="nc" id="L300">            db.setTransactionSuccessful();</span>
        } finally {
<span class="nc" id="L302">            db.endTransaction();</span>
        }
<span class="nc" id="L304">    }</span>


    public static String getTagLastUpdated(ReaderTag tag) {
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L309">            return &quot;&quot;;</span>
        }
<span class="nc" id="L311">        String[] args = {tag.getTagSlug(), Integer.toString(tag.tagType.toInt())};</span>
<span class="nc" id="L312">        return SqlUtils.stringForQuery(ReaderDatabase.getReadableDb(),</span>
                                       &quot;SELECT date_updated FROM tbl_tags WHERE tag_slug=? AND tag_type=?&quot;,
                                       args);
    }

    public static void setTagLastUpdated(ReaderTag tag) {
<span class="nc" id="L318">        updateTagLastUpdated(tag, new Date());</span>
<span class="nc" id="L319">    }</span>

    public static void clearTagLastUpdated(ReaderTag tag) {
<span class="nc" id="L322">        updateTagLastUpdated(tag, new Date(0));</span>
<span class="nc" id="L323">    }</span>

    private static void updateTagLastUpdated(ReaderTag tag, Date newDate) {
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L327">            return;</span>
        }

<span class="nc" id="L330">        String date = DateTimeUtils.iso8601FromDate(newDate);</span>
<span class="nc" id="L331">        String sql = &quot;UPDATE tbl_tags SET date_updated=?1 WHERE tag_slug=?2 AND tag_type=?3&quot;;</span>
<span class="nc" id="L332">        SQLiteStatement stmt = ReaderDatabase.getWritableDb().compileStatement(sql);</span>
        try {
<span class="nc" id="L334">            stmt.bindString(1, date);</span>
<span class="nc" id="L335">            stmt.bindString(2, tag.getTagSlug());</span>
<span class="nc" id="L336">            stmt.bindLong(3, tag.tagType.toInt());</span>
<span class="nc" id="L337">            stmt.execute();</span>
        } finally {
<span class="nc" id="L339">            SqlUtils.closeStatement(stmt);</span>
        }
<span class="nc" id="L341">    }</span>

    /*
     * determine whether the passed tag should be auto-updated based on when it was last updated
     */
    public static boolean shouldAutoUpdateTag(ReaderTag tag) {
<span class="nc" id="L347">        int minutes = minutesSinceLastUpdate(tag);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (minutes == NEVER_UPDATED) {</span>
<span class="nc" id="L349">            return true;</span>
        }
<span class="nc bnc" id="L351" title="All 2 branches missed.">        return (minutes &gt;= ReaderConstants.READER_AUTO_UPDATE_DELAY_MINUTES);</span>
    }

    private static final int NEVER_UPDATED = -1;

    private static int minutesSinceLastUpdate(ReaderTag tag) {
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (tag == null) {</span>
<span class="nc" id="L358">            return 0;</span>
        }

<span class="nc" id="L361">        String updated = getTagLastUpdated(tag);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">        if (TextUtils.isEmpty(updated)) {</span>
<span class="nc" id="L363">            return NEVER_UPDATED;</span>
        }

<span class="nc" id="L366">        Date dtUpdated = DateTimeUtils.dateFromIso8601(updated);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (dtUpdated == null) {</span>
<span class="nc" id="L368">            return 0;</span>
        }

<span class="nc" id="L371">        Date dtNow = new Date();</span>
<span class="nc" id="L372">        return DateTimeUtils.minutesBetween(dtUpdated, dtNow);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>