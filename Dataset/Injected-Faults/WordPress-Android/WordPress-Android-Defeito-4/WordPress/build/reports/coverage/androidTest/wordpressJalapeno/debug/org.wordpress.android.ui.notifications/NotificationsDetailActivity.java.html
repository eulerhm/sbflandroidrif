<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationsDetailActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.notifications</a> &gt; <span class="el_source">NotificationsDetailActivity.java</span></div><h1>NotificationsDetailActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.notifications;

import android.content.Intent;
import android.os.Bundle;
import android.os.Parcelable;
import android.text.TextUtils;
import android.view.MenuItem;
import android.view.View;
import android.view.WindowManager;
import android.widget.ProgressBar;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.ActionBar;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentStatePagerAdapter;
import androidx.viewpager.widget.ViewPager;

import com.google.android.material.appbar.AppBarLayout;

import org.greenrobot.eventbus.EventBus;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.jetbrains.annotations.NotNull;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.datasets.NotificationsTable;
import org.wordpress.android.fluxc.model.CommentStatus;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.AccountStore;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.fluxc.tools.FormattableRangeType;
import org.wordpress.android.models.Note;
import org.wordpress.android.push.GCMMessageHandler;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.CollapseFullScreenDialogFragment;
import org.wordpress.android.ui.LocaleAwareActivity;
import org.wordpress.android.ui.ScrollableViewInitializedListener;
import org.wordpress.android.ui.WPWebViewActivity;
import org.wordpress.android.ui.comments.CommentActions;
import org.wordpress.android.ui.comments.CommentDetailFragment;
import org.wordpress.android.ui.engagement.EngagedPeopleListFragment;
import org.wordpress.android.ui.engagement.ListScenarioUtils;
import org.wordpress.android.ui.notifications.adapters.NotesAdapter;
import org.wordpress.android.ui.notifications.services.NotificationsUpdateServiceStarter;
import org.wordpress.android.ui.notifications.utils.NotificationsActions;
import org.wordpress.android.ui.notifications.utils.NotificationsUtils;
import org.wordpress.android.ui.posts.BasicFragmentDialog;
import org.wordpress.android.ui.posts.BasicFragmentDialog.BasicDialogPositiveClickInterface;
import org.wordpress.android.ui.prefs.AppPrefs;
import org.wordpress.android.ui.reader.ReaderActivityLauncher;
import org.wordpress.android.ui.reader.ReaderPostDetailFragment;
import org.wordpress.android.ui.reader.comments.ThreadedCommentsActionSource;
import org.wordpress.android.ui.reader.tracker.ReaderTracker;
import org.wordpress.android.ui.stats.StatsViewType;
import org.wordpress.android.util.extensions.AppBarLayoutExtensionsKt;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.StringUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils.AnalyticsCommentActionSource;
import org.wordpress.android.util.config.LikesEnhancementsFeatureConfig;
import org.wordpress.android.widgets.WPSwipeSnackbar;
import org.wordpress.android.widgets.WPViewPager;
import org.wordpress.android.widgets.WPViewPagerTransformer;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

import javax.inject.Inject;

import static org.wordpress.android.models.Note.NOTE_COMMENT_LIKE_TYPE;
import static org.wordpress.android.models.Note.NOTE_COMMENT_TYPE;
import static org.wordpress.android.models.Note.NOTE_FOLLOW_TYPE;
import static org.wordpress.android.models.Note.NOTE_LIKE_TYPE;
import static org.wordpress.android.ui.notifications.services.NotificationsUpdateServiceStarter.IS_TAPPED_ON_NOTIFICATION;

<span class="nc" id="L83">public class NotificationsDetailActivity extends LocaleAwareActivity implements</span>
        CommentActions.OnNoteCommentActionListener,
        BasicFragmentDialog.BasicDialogPositiveClickInterface, ScrollableViewInitializedListener {
    private static final String ARG_TITLE = &quot;activityTitle&quot;;
    private static final String DOMAIN_WPCOM = &quot;wordpress.com&quot;;

    @Inject AccountStore mAccountStore;
    @Inject SiteStore mSiteStore;
    @Inject GCMMessageHandler mGCMMessageHandler;
    @Inject ReaderTracker mReaderTracker;
    @Inject LikesEnhancementsFeatureConfig mLikesEnhancementsFeatureConfig;
    @Inject ListScenarioUtils mListScenarioUtils;

    private String mNoteId;
    private boolean mIsTappedOnNotification;

    private WPViewPager mViewPager;
    private ViewPager.OnPageChangeListener mOnPageChangeListener;
    private NotificationDetailFragmentAdapter mAdapter;
    private AppBarLayout mAppBarLayout;
    private Toolbar mToolbar;

    @Override
    public void onBackPressed() {
<span class="nc" id="L107">        CollapseFullScreenDialogFragment fragment = (CollapseFullScreenDialogFragment)</span>
<span class="nc" id="L108">                getSupportFragmentManager().findFragmentByTag(CollapseFullScreenDialogFragment.TAG);</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (fragment != null) {</span>
<span class="nc" id="L111">            fragment.onBackPressed();</span>
        } else {
<span class="nc" id="L113">            super.onBackPressed();</span>
        }
<span class="nc" id="L115">    }</span>

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L119">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L120">        ((WordPress) getApplication()).component().inject(this);</span>
<span class="nc" id="L121">        AppLog.i(AppLog.T.NOTIFS, &quot;Creating NotificationsDetailActivity&quot;);</span>

<span class="nc" id="L123">        setContentView(R.layout.notifications_detail_activity);</span>

<span class="nc" id="L125">        mToolbar = findViewById(R.id.toolbar_main);</span>
<span class="nc" id="L126">        setSupportActionBar(mToolbar);</span>

<span class="nc" id="L128">        mAppBarLayout = findViewById(R.id.appbar_main);</span>

<span class="nc" id="L130">        ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L132">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
        }

<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L136">            mNoteId = getIntent().getStringExtra(NotificationsListFragment.NOTE_ID_EXTRA);</span>
<span class="nc" id="L137">            mIsTappedOnNotification = getIntent().getBooleanExtra(IS_TAPPED_ON_NOTIFICATION, false);</span>
        } else {
<span class="nc bnc" id="L139" title="All 4 branches missed.">            if (savedInstanceState.containsKey(ARG_TITLE) &amp;&amp; getSupportActionBar() != null) {</span>
<span class="nc" id="L140">                getSupportActionBar().setTitle(StringUtils.notNullStr(savedInstanceState.getString(ARG_TITLE)));</span>
            }
<span class="nc" id="L142">            mNoteId = savedInstanceState.getString(NotificationsListFragment.NOTE_ID_EXTRA);</span>
<span class="nc" id="L143">            mIsTappedOnNotification = savedInstanceState.getBoolean(IS_TAPPED_ON_NOTIFICATION);</span>
        }

        // set up the viewpager and adapter for lateral navigation
<span class="nc" id="L147">        mViewPager = findViewById(R.id.viewpager);</span>
<span class="nc" id="L148">        mViewPager.setPageTransformer(false,</span>
                new WPViewPagerTransformer(WPViewPagerTransformer.TransformType.SLIDE_OVER));

<span class="nc" id="L151">        Note note = NotificationsTable.getNoteById(mNoteId);</span>
        // if this is coming from a tapped push notification, let's try refreshing it as its contents may have been
        // updated since the notification was first received and created on the system's dashboard
<span class="nc bnc" id="L154" title="All 4 branches missed.">        updateUIAndNote((note == null) || mIsTappedOnNotification);</span>

        // Hide the keyboard, unless we arrived here from the 'Reply' action in a push notification
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!getIntent().getBooleanExtra(NotificationsListFragment.NOTE_INSTANT_REPLY_EXTRA, false)) {</span>
<span class="nc" id="L158">            getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_HIDDEN);</span>
        }
        // track initial comment note view
<span class="nc bnc" id="L161" title="All 4 branches missed.">        if (savedInstanceState == null &amp;&amp; note != null) {</span>
<span class="nc" id="L162">            trackCommentNote(note);</span>
        }
<span class="nc" id="L164">    }</span>

    private void updateUIAndNote(boolean doRefresh) {
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (mNoteId == null) {</span>
<span class="nc" id="L168">            showErrorToastAndFinish();</span>
<span class="nc" id="L169">            return;</span>
        }

<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (doRefresh) {</span>
<span class="nc" id="L173">            setProgressVisible(true);</span>
            // here start the service and wait for it
<span class="nc" id="L175">            NotificationsUpdateServiceStarter.startService(this, mNoteId);</span>
<span class="nc" id="L176">            return;</span>
        }

<span class="nc" id="L179">        Note note = NotificationsTable.getNoteById(mNoteId);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (note == null) {</span>
            // no note found
<span class="nc" id="L182">            showErrorToastAndFinish();</span>
<span class="nc" id="L183">            return;</span>
        }

        // here compare the current Note - is it any different from the Note the user is
        // currently viewing?
        // if it is, then replace the dataset with the new one.
        // If not, just let it be.
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (mAdapter != null) {</span>
<span class="nc" id="L191">            Note currentNote = mAdapter.getNoteWithId(mNoteId);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (note.equalsTimeAndLength(currentNote)) {</span>
<span class="nc" id="L193">                return;</span>
            }
        }

<span class="nc" id="L197">        NotesAdapter.FILTERS filter = NotesAdapter.FILTERS.FILTER_ALL;</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (getIntent().hasExtra(NotificationsListFragment.NOTE_CURRENT_LIST_FILTER_EXTRA)) {</span>
<span class="nc" id="L199">            filter = (NotesAdapter.FILTERS) getIntent()</span>
<span class="nc" id="L200">                    .getSerializableExtra(NotificationsListFragment.NOTE_CURRENT_LIST_FILTER_EXTRA);</span>
        }

<span class="nc" id="L203">        mAdapter = buildNoteListAdapterAndSetPosition(note, filter);</span>

<span class="nc" id="L205">        resetOnPageChangeListener();</span>

        // set title
<span class="nc" id="L208">        setActionBarTitleForNote(note);</span>
<span class="nc" id="L209">        markNoteAsRead(note);</span>

        // If `note.getTimestamp()` is not the most recent seen note, the server will discard the value.
<span class="nc" id="L212">        NotificationsActions.updateSeenTimestamp(note);</span>

        // analytics tracking
<span class="nc" id="L215">        Map&lt;String, String&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L216">        properties.put(&quot;notification_type&quot;, note.getType());</span>
<span class="nc" id="L217">        AnalyticsTracker.track(AnalyticsTracker.Stat.NOTIFICATIONS_OPENED_NOTIFICATION_DETAILS, properties);</span>

<span class="nc" id="L219">        setProgressVisible(false);</span>
<span class="nc" id="L220">    }</span>

    private void resetOnPageChangeListener() {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (mOnPageChangeListener != null) {</span>
<span class="nc" id="L224">            mViewPager.removeOnPageChangeListener(mOnPageChangeListener);</span>
        } else {
<span class="nc" id="L226">            mOnPageChangeListener = new ViewPager.OnPageChangeListener() {</span>
                @Override
                public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) {
<span class="nc" id="L229">                }</span>

                @Override
                public void onPageSelected(int position) {
<span class="nc" id="L233">                    Fragment fragment = mAdapter.getItem(mViewPager.getCurrentItem());</span>
<span class="nc" id="L234">                    boolean hideToolbar = (fragment instanceof ReaderPostDetailFragment);</span>
<span class="nc" id="L235">                    showHideToolbar(hideToolbar);</span>

<span class="nc" id="L237">                    AnalyticsTracker.track(AnalyticsTracker.Stat.NOTIFICATION_SWIPE_PAGE_CHANGED);</span>
                    // change the action bar title for the current note
<span class="nc" id="L239">                    Note currentNote = mAdapter.getNoteAtPosition(position);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">                    if (currentNote != null) {</span>
<span class="nc" id="L241">                        setActionBarTitleForNote(currentNote);</span>
<span class="nc" id="L242">                        markNoteAsRead(currentNote);</span>
<span class="nc" id="L243">                        NotificationsActions.updateSeenTimestamp(currentNote);</span>
                        // track subsequent comment note views
<span class="nc" id="L245">                        trackCommentNote(currentNote);</span>
                    }
<span class="nc" id="L247">                }</span>

                @Override
                public void onPageScrollStateChanged(int state) {
<span class="nc" id="L251">                }</span>
            };
        }
<span class="nc" id="L254">        mViewPager.addOnPageChangeListener(mOnPageChangeListener);</span>
<span class="nc" id="L255">    }</span>

    private void trackCommentNote(@NotNull Note note) {
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (note.isCommentType()) {</span>
<span class="nc" id="L259">            SiteModel site = mSiteStore.getSiteBySiteId(note.getSiteId());</span>
<span class="nc" id="L260">            AnalyticsUtils.trackCommentActionWithSiteDetails(</span>
                    Stat.COMMENT_VIEWED, AnalyticsCommentActionSource.NOTIFICATIONS, site);
        }
<span class="nc" id="L263">    }</span>

    public void showHideToolbar(boolean hide) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (getSupportActionBar() != null) {</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">            if (hide) {</span>
<span class="nc" id="L268">                getSupportActionBar().hide();</span>
            } else {
<span class="nc" id="L270">                setSupportActionBar(mToolbar);</span>
<span class="nc" id="L271">                getSupportActionBar().show();</span>
            }
<span class="nc bnc" id="L273" title="All 2 branches missed.">            getSupportActionBar().setDisplayShowTitleEnabled(!hide);</span>
        }
<span class="nc" id="L275">    }</span>

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (item.getItemId() == android.R.id.home) {</span>
<span class="nc" id="L280">            finish();</span>
<span class="nc" id="L281">            return true;</span>
        }

<span class="nc" id="L284">        return super.onOptionsItemSelected(item);</span>
    }

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if (getSupportActionBar() != null &amp;&amp; getSupportActionBar().getTitle() != null) {</span>
<span class="nc" id="L290">            outState.putString(ARG_TITLE, getSupportActionBar().getTitle().toString());</span>
        }
<span class="nc" id="L292">        outState.putString(NotificationsListFragment.NOTE_ID_EXTRA, mNoteId);</span>
<span class="nc" id="L293">        outState.putBoolean(IS_TAPPED_ON_NOTIFICATION, mIsTappedOnNotification);</span>
<span class="nc" id="L294">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L295">    }</span>

    @Override
    protected void onStart() {
<span class="nc" id="L299">        super.onStart();</span>
<span class="nc" id="L300">        EventBus.getDefault().register(this);</span>
        // If the user hasn't used swipe yet and if the adapter is initialised and have at least 2 notifications,
        // show a hint to promote swipe usage on the ViewPager
<span class="nc bnc" id="L303" title="All 6 branches missed.">        if (!AppPrefs.isNotificationsSwipeToNavigateShown() &amp;&amp; mAdapter != null &amp;&amp; mAdapter.getCount() &gt; 1) {</span>
<span class="nc" id="L304">            WPSwipeSnackbar.show(mViewPager);</span>
<span class="nc" id="L305">            AppPrefs.setNotificationsSwipeToNavigateShown(true);</span>
        }
<span class="nc" id="L307">    }</span>

    @Override
    public void onStop() {
<span class="nc" id="L311">        EventBus.getDefault().unregister(this);</span>
<span class="nc" id="L312">        super.onStop();</span>
<span class="nc" id="L313">    }</span>

    private void showErrorToastAndFinish() {
<span class="nc" id="L316">        AppLog.e(AppLog.T.NOTIFS, &quot;Note could not be found.&quot;);</span>
<span class="nc" id="L317">        ToastUtils.showToast(this, R.string.error_notification_open);</span>
<span class="nc" id="L318">        finish();</span>
<span class="nc" id="L319">    }</span>

    private void markNoteAsRead(Note note) {
<span class="nc" id="L322">        mGCMMessageHandler.removeNotificationWithNoteIdFromSystemBar(this, note.getId());</span>
        // mark the note as read if it's unread
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (note.isUnread()) {</span>
<span class="nc" id="L325">            NotificationsActions.markNoteAsRead(note);</span>
<span class="nc" id="L326">            note.setRead();</span>
<span class="nc" id="L327">            NotificationsTable.saveNote(note);</span>
<span class="nc" id="L328">            EventBus.getDefault().post(new NotificationEvents.NotificationsChanged());</span>
        }
<span class="nc" id="L330">    }</span>

    private void setActionBarTitleForNote(Note note) {
<span class="nc bnc" id="L333" title="All 2 branches missed.">        if (getSupportActionBar() != null) {</span>
<span class="nc" id="L334">            String title = note.getTitle();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (TextUtils.isEmpty(title)) {</span>
                // set a default title if title is not set within the note
<span class="nc bnc" id="L337" title="All 5 branches missed.">                switch (note.getType()) {</span>
                    case NOTE_FOLLOW_TYPE:
<span class="nc" id="L339">                        title = getString(R.string.follows);</span>
<span class="nc" id="L340">                        break;</span>
                    case NOTE_COMMENT_LIKE_TYPE:
<span class="nc" id="L342">                        title = getString(R.string.comment_likes);</span>
<span class="nc" id="L343">                        break;</span>
                    case NOTE_LIKE_TYPE:
<span class="nc" id="L345">                        title = getString(R.string.like);</span>
<span class="nc" id="L346">                        break;</span>
                    case NOTE_COMMENT_TYPE:
<span class="nc" id="L348">                        title = getString(R.string.comment);</span>
                        break;
                }
            }

            // Force change the Action Bar title for 'new_post' notifications.
<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (note.isNewPostType()) {</span>
<span class="nc" id="L355">                title = getString(R.string.reader_title_post_detail);</span>
            }

<span class="nc" id="L358">            getSupportActionBar().setTitle(title);</span>
            // important for accessibility - talkback
<span class="nc" id="L360">            setTitle(getString(R.string.notif_detail_screen_title, title));</span>
        }
<span class="nc" id="L362">    }</span>

    private NotificationDetailFragmentAdapter buildNoteListAdapterAndSetPosition(Note note,
                                                                                 NotesAdapter.FILTERS filter) {
        NotificationDetailFragmentAdapter adapter;
<span class="nc" id="L367">        ArrayList&lt;Note&gt; notes = NotificationsTable.getLatestNotes();</span>
<span class="nc" id="L368">        ArrayList&lt;Note&gt; filteredNotes = new ArrayList&lt;&gt;();</span>

        // apply filter to the list so we show the same items that the list show vertically, but horizontally
<span class="nc" id="L371">        NotesAdapter.buildFilteredNotesList(filteredNotes, notes, filter);</span>
<span class="nc" id="L372">        adapter = new NotificationDetailFragmentAdapter(getSupportFragmentManager(), filteredNotes);</span>

<span class="nc" id="L374">        mViewPager.setAdapter(adapter);</span>
<span class="nc" id="L375">        mViewPager.setCurrentItem(NotificationsUtils.findNoteInNoteArray(filteredNotes, note.getId()));</span>

<span class="nc" id="L377">        return adapter;</span>
    }

    /**
     * Tries to pick the correct fragment detail type for a given note
     * Defaults to NotificationDetailListFragment
     */
    private Fragment getDetailFragmentForNote(Note note) {
<span class="nc bnc" id="L385" title="All 2 branches missed.">        if (note == null) {</span>
<span class="nc" id="L386">            return null;</span>
        }

        Fragment fragment;
<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (note.isCommentType()) {</span>
            // show comment detail for comment notifications
<span class="nc" id="L392">            boolean isInstantReply = getIntent().getBooleanExtra(NotificationsListFragment.NOTE_INSTANT_REPLY_EXTRA,</span>
                    false);
<span class="nc" id="L394">            fragment = CommentDetailFragment.newInstance(note.getId(),</span>
<span class="nc" id="L395">                    getIntent().getStringExtra(NotificationsListFragment.NOTE_PREFILLED_REPLY_EXTRA));</span>

<span class="nc bnc" id="L397" title="All 2 branches missed.">            if (isInstantReply) {</span>
<span class="nc" id="L398">                ((CommentDetailFragment) fragment).enableShouldFocusReplyField();</span>
            }
<span class="nc bnc" id="L400" title="All 2 branches missed.">        } else if (note.isAutomattcherType()) {</span>
            // show reader post detail for automattchers about posts - note that comment
            // automattchers are handled by note.isCommentType() above
<span class="nc bnc" id="L403" title="All 6 branches missed.">            boolean isPost = (note.getSiteId() != 0 &amp;&amp; note.getPostId() != 0 &amp;&amp; note.getCommentId() == 0);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (isPost) {</span>
<span class="nc" id="L405">                fragment = ReaderPostDetailFragment.Companion.newInstance(</span>
<span class="nc" id="L406">                        note.getSiteId(),</span>
<span class="nc" id="L407">                        note.getPostId()</span>
                );
            } else {
<span class="nc" id="L410">                fragment = NotificationsDetailListFragment.newInstance(note.getId());</span>
            }
<span class="nc bnc" id="L412" title="All 2 branches missed.">        } else if (note.isNewPostType()) {</span>
<span class="nc" id="L413">            fragment = ReaderPostDetailFragment.Companion.newInstance(</span>
<span class="nc" id="L414">                    note.getSiteId(),</span>
<span class="nc" id="L415">                    note.getPostId()</span>
            );
        } else {
<span class="nc bnc" id="L418" title="All 4 branches missed.">            if (mLikesEnhancementsFeatureConfig.isEnabled() &amp;&amp; note.isLikeType()) {</span>
<span class="nc" id="L419">                fragment = EngagedPeopleListFragment.newInstance(</span>
<span class="nc" id="L420">                        mListScenarioUtils.mapLikeNoteToListScenario(note, this)</span>
                );
            } else {
<span class="nc" id="L423">                fragment = NotificationsDetailListFragment.newInstance(note.getId());</span>
            }
        }

<span class="nc" id="L427">        return fragment;</span>
    }

    public void showBlogPreviewActivity(long siteId, @Nullable Boolean isFollowed) {
<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L432">            return;</span>
        }

<span class="nc" id="L435">        ReaderActivityLauncher.showReaderBlogPreview(</span>
                this,
                siteId,
                isFollowed,
                ReaderTracker.SOURCE_NOTIFICATION,
                mReaderTracker
        );
<span class="nc" id="L442">    }</span>

    public void showPostActivity(long siteId, long postId) {
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L446">            return;</span>
        }

<span class="nc" id="L449">        ReaderActivityLauncher.showReaderPostDetail(this, siteId, postId);</span>
<span class="nc" id="L450">    }</span>

    public void showScanActivityForSite(long siteId) {
<span class="nc" id="L453">        SiteModel site = getSiteOrToast(siteId);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">        if (site != null) {</span>
<span class="nc" id="L455">            ActivityLauncher.viewScan(this, site);</span>
        }
<span class="nc" id="L457">    }</span>

    public void showStatsActivityForSite(long siteId, FormattableRangeType rangeType) {
<span class="nc" id="L460">        SiteModel site = getSiteOrToast(siteId);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (site != null) {</span>
<span class="nc" id="L462">            showStatsActivityForSite(site, rangeType);</span>
        }
<span class="nc" id="L464">    }</span>

    public void showBackupForSite(long siteId) {
<span class="nc" id="L467">        SiteModel site = getSiteOrToast(siteId);</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">        if (site != null) {</span>
<span class="nc" id="L469">            showBackupActivityForSite(site);</span>
        }
<span class="nc" id="L471">    }</span>

    @Nullable
    private SiteModel getSiteOrToast(long siteId) {
<span class="nc" id="L475">        SiteModel site = mSiteStore.getSiteBySiteId(siteId);</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (site == null) {</span>
            // One way the site can be null: new site created, receive a notification from this site,
            // but the site list is not yet updated in the app.
<span class="nc" id="L479">            ToastUtils.showToast(this, R.string.blog_not_found);</span>
        }
<span class="nc" id="L481">        return site;</span>
    }

    private void showStatsActivityForSite(@NonNull SiteModel site, FormattableRangeType rangeType) {
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L486">            return;</span>
        }

<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (rangeType == FormattableRangeType.FOLLOW) {</span>
<span class="nc" id="L490">            ActivityLauncher.viewAllTabbedInsightsStats(this, StatsViewType.FOLLOWERS, 0,</span>
<span class="nc" id="L491">                    site.getId());</span>
        } else {
<span class="nc" id="L493">            ActivityLauncher.viewBlogStats(this, site);</span>
        }
<span class="nc" id="L495">    }</span>

    private void showBackupActivityForSite(@NonNull SiteModel site) {
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L499">            return;</span>
        }

<span class="nc" id="L502">        ActivityLauncher.viewBackupList(this, site);</span>
<span class="nc" id="L503">    }</span>

    public void showWebViewActivityForUrl(String url) {
<span class="nc bnc" id="L506" title="All 4 branches missed.">        if (isFinishing() || url == null) {</span>
<span class="nc" id="L507">            return;</span>
        }

<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (url.contains(DOMAIN_WPCOM)) {</span>
<span class="nc" id="L511">            WPWebViewActivity.openUrlByUsingGlobalWPCOMCredentials(this, url);</span>
        } else {
<span class="nc" id="L513">            WPWebViewActivity.openURL(this, url);</span>
        }
<span class="nc" id="L515">    }</span>

    public void showReaderPostLikeUsers(long blogId, long postId) {
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L519">            return;</span>
        }

<span class="nc" id="L522">        ReaderActivityLauncher.showReaderLikingUsers(this, blogId, postId);</span>
<span class="nc" id="L523">    }</span>

    public void showReaderCommentsList(long siteId, long postId, long commentId) {
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L527">            return;</span>
        }

<span class="nc" id="L530">        ReaderActivityLauncher.showReaderComments(</span>
                this,
                siteId,
                postId,
                commentId,
<span class="nc" id="L535">                ThreadedCommentsActionSource.COMMENT_NOTIFICATION.getSourceDescription()</span>
        );
<span class="nc" id="L537">    }</span>

    private void setProgressVisible(boolean visible) {
<span class="nc" id="L540">        final ProgressBar progress =</span>
<span class="nc" id="L541">                findViewById(R.id.progress_loading);</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">        if (progress != null) {</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">            progress.setVisibility(visible ? View.VISIBLE : View.GONE);</span>
        }
<span class="nc" id="L545">    }</span>

    @Override
    public void onModerateCommentForNote(Note note, CommentStatus newStatus) {
<span class="nc" id="L549">        Intent resultIntent = new Intent();</span>
<span class="nc" id="L550">        resultIntent.putExtra(NotificationsListFragment.NOTE_MODERATE_ID_EXTRA, note.getId());</span>
<span class="nc" id="L551">        resultIntent.putExtra(NotificationsListFragment.NOTE_MODERATE_STATUS_EXTRA, newStatus.toString());</span>

<span class="nc" id="L553">        setResult(RESULT_OK, resultIntent);</span>
<span class="nc" id="L554">        finish();</span>
<span class="nc" id="L555">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(final NotificationEvents.NotificationsRefreshCompleted event) {
<span class="nc" id="L560">        setProgressVisible(false);</span>
<span class="nc" id="L561">        updateUIAndNote(false);</span>
<span class="nc" id="L562">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(NotificationEvents.NotificationsRefreshError error) {
<span class="nc" id="L567">        setProgressVisible(false);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (mNoteId == null) {</span>
<span class="nc" id="L569">            showErrorToastAndFinish();</span>
<span class="nc" id="L570">            return;</span>
        }

<span class="nc" id="L573">        Note note = NotificationsTable.getNoteById(mNoteId);</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (note == null) {</span>
            // no note found
<span class="nc" id="L576">            showErrorToastAndFinish();</span>
<span class="nc" id="L577">            return;</span>
        }
<span class="nc" id="L579">    }</span>

    @Override
    public void onPositiveClicked(@NotNull String instanceTag) {
<span class="nc" id="L583">        Fragment fragment = mAdapter.getItem(mViewPager.getCurrentItem());</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">        if (fragment instanceof BasicFragmentDialog.BasicDialogPositiveClickInterface) {</span>
<span class="nc" id="L585">            ((BasicDialogPositiveClickInterface) fragment).onPositiveClicked(instanceTag);</span>
        }
<span class="nc" id="L587">    }</span>

    @Override
    public void onScrollableViewInitialized(int containerId) {
<span class="nc" id="L591">        AppBarLayoutExtensionsKt.setLiftOnScrollTargetViewIdAndRequestLayout(mAppBarLayout, containerId);</span>
<span class="nc" id="L592">    }</span>

    private class NotificationDetailFragmentAdapter extends FragmentStatePagerAdapter {
        private final ArrayList&lt;Note&gt; mNoteList;

<span class="nc" id="L597">        NotificationDetailFragmentAdapter(FragmentManager fm, ArrayList&lt;Note&gt; notes) {</span>
<span class="nc" id="L598">            super(fm, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT);</span>
<span class="nc" id="L599">            mNoteList = (ArrayList&lt;Note&gt;) notes.clone();</span>
<span class="nc" id="L600">        }</span>

        @Override
        public Fragment getItem(int position) {
<span class="nc" id="L604">            return getDetailFragmentForNote(mNoteList.get(position));</span>
        }

        @Override
        public int getCount() {
<span class="nc" id="L609">            return mNoteList.size();</span>
        }

        @Override
        public void restoreState(Parcelable state, ClassLoader loader) {
            // work around &quot;Fragment no longer exists for key&quot; Android bug
            // by catching the IllegalStateException
            // https://code.google.com/p/android/issues/detail?id=42601
            try {
<span class="nc" id="L618">                AppLog.d(AppLog.T.NOTIFS, &quot;notifications pager &gt; adapter restoreState&quot;);</span>
<span class="nc" id="L619">                super.restoreState(state, loader);</span>
<span class="nc" id="L620">            } catch (IllegalStateException e) {</span>
<span class="nc" id="L621">                AppLog.e(AppLog.T.NOTIFS, e);</span>
<span class="nc" id="L622">            }</span>
<span class="nc" id="L623">        }</span>

        @Override
        public Parcelable saveState() {
<span class="nc" id="L627">            AppLog.d(AppLog.T.NOTIFS, &quot;notifications pager &gt; adapter saveState&quot;);</span>
<span class="nc" id="L628">            Bundle bundle = (Bundle) super.saveState();</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">            if (bundle == null) {</span>
<span class="nc" id="L630">                bundle = new Bundle();</span>
            }
            // This is a possible solution to https://github.com/wordpress-mobile/WordPress-Android/issues/5456
            // See https://issuetracker.google.com/issues/37103380#comment77 for more details
<span class="nc" id="L634">            bundle.putParcelableArray(&quot;states&quot;, null);</span>
<span class="nc" id="L635">            return bundle;</span>
        }

        boolean isValidPosition(int position) {
<span class="nc bnc" id="L639" title="All 4 branches missed.">            return (position &gt;= 0 &amp;&amp; position &lt; getCount());</span>
        }

        private Note getNoteAtPosition(int position) {
<span class="nc bnc" id="L643" title="All 2 branches missed.">            if (isValidPosition(position)) {</span>
<span class="nc" id="L644">                return mNoteList.get(position);</span>
            } else {
<span class="nc" id="L646">                return null;</span>
            }
        }

        private Note getNoteWithId(String id) {
<span class="nc bnc" id="L651" title="All 2 branches missed.">            for (Note note : mNoteList) {</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">                if (note.getId().equalsIgnoreCase(id)) {</span>
<span class="nc" id="L653">                    return note;</span>
                }
<span class="nc" id="L655">            }</span>
<span class="nc" id="L656">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>