<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaUploadCompletionProcessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.posts.mediauploadcompletionprocessors</a> &gt; <span class="el_source">MediaUploadCompletionProcessor.java</span></div><h1>MediaUploadCompletionProcessor.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.posts.mediauploadcompletionprocessors;

import org.wordpress.android.util.helpers.MediaFile;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static org.wordpress.android.ui.posts.mediauploadcompletionprocessors.MediaUploadCompletionProcessorPatterns.PATTERN_BLOCK_HEADER;
import static org.wordpress.android.ui.posts.mediauploadcompletionprocessors.MediaUploadCompletionProcessorPatterns.PATTERN_TEMPLATE_BLOCK_BOUNDARY;

public class MediaUploadCompletionProcessor {
    private final BlockProcessorFactory mBlockProcessorFactory;

    /**
     * Processor used for replacing local media id(s) and url(s) with their remote counterparts after an upload has
     * completed.
     *
     * @param localId The local media id that needs replacement
     * @param mediaFile The mediaFile containing the remote id and remote url
     * @param siteUrl The site url - used to generate the attachmentPage url
     */
<span class="nc" id="L22">    public MediaUploadCompletionProcessor(String localId, MediaFile mediaFile, String siteUrl) {</span>
<span class="nc" id="L23">        mBlockProcessorFactory = new BlockProcessorFactory(this)</span>
<span class="nc" id="L24">                .init(localId, mediaFile, siteUrl);</span>
<span class="nc" id="L25">    }</span>

    /**
     * Processes content to replace the local ids and local urls of media with remote ids and remote urls. This method
     * delineates block boundaries for media-containing blocks and delegates further processing via itself and / or
     * {@link #processBlock(String)}, via direct and mutual recursion, respectively.
     *
     * @param content The content to be processed
     * @return A string containing the processed content, or the original content if no match was found
     */
    public String processContent(String content) {
<span class="nc" id="L36">        Matcher headerMatcher = PATTERN_BLOCK_HEADER.matcher(content);</span>

<span class="nc" id="L38">        int positionBlockStart, positionBlockEnd = content.length();</span>

<span class="nc bnc" id="L40" title="All 2 branches missed.">        if (headerMatcher.find()) {</span>
<span class="nc" id="L41">            positionBlockStart = headerMatcher.start();</span>
<span class="nc" id="L42">            String blockType = headerMatcher.group(1);</span>
<span class="nc" id="L43">            Matcher blockBoundaryMatcher = Pattern.compile(String.format(PATTERN_TEMPLATE_BLOCK_BOUNDARY, blockType),</span>
<span class="nc" id="L44">                    Pattern.DOTALL).matcher(content.substring(headerMatcher.end()));</span>

<span class="nc" id="L46">            int nestLevel = 1;</span>

<span class="nc bnc" id="L48" title="All 4 branches missed.">            while (0 &lt; nestLevel &amp;&amp; blockBoundaryMatcher.find()) {</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">                if (blockBoundaryMatcher.group(1).equals(&quot;/&quot;)) {</span>
<span class="nc" id="L50">                    positionBlockEnd = headerMatcher.end() + blockBoundaryMatcher.end();</span>
<span class="nc" id="L51">                    nestLevel--;</span>
                } else {
<span class="nc" id="L53">                    nestLevel++;</span>
                }
            }

<span class="nc" id="L57">            return new StringBuilder()</span>
<span class="nc" id="L58">                    .append(content.substring(0, positionBlockStart))</span>
<span class="nc" id="L59">                    .append(processBlock(content.substring(positionBlockStart, positionBlockEnd)))</span>
<span class="nc" id="L60">                    .append(processContent(content.substring(positionBlockEnd)))</span>
<span class="nc" id="L61">                    .toString();</span>
        } else {
<span class="nc" id="L63">            return content;</span>
        }
    }

    /**
     * Processes a media block returning a raw content replacement string
     *
     * @param block The raw block contents
     * @return A string containing content with ids and urls replaced
     */
    private String processBlock(String block) {
<span class="nc" id="L74">        final MediaBlockType blockType = MediaBlockType.detectBlockType(block);</span>
<span class="nc" id="L75">        final BlockProcessor blockProcessor = mBlockProcessorFactory.getProcessorForMediaBlockType(blockType);</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (blockProcessor != null) {</span>
<span class="nc" id="L78">            return blockProcessor.processBlock(block);</span>
        }

<span class="nc" id="L81">        return block;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>