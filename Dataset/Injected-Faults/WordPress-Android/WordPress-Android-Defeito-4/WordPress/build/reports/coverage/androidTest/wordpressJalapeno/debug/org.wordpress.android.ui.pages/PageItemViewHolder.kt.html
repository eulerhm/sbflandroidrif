<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PageItemViewHolder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.pages</a> &gt; <span class="el_source">PageItemViewHolder.kt</span></div><h1>PageItemViewHolder.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.pages

import android.graphics.drawable.Drawable
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.FrameLayout
import android.widget.ImageButton
import android.widget.ImageView
import android.widget.ImageView.ScaleType
import android.widget.PopupMenu
import android.widget.ProgressBar
import android.widget.RadioButton
import android.widget.TextView
import androidx.annotation.LayoutRes
import androidx.core.content.ContextCompat
import androidx.recyclerview.widget.RecyclerView
import org.wordpress.android.R
import org.wordpress.android.ui.ActionableEmptyView
import org.wordpress.android.ui.pages.PageItem.Divider
import org.wordpress.android.ui.pages.PageItem.Empty
import org.wordpress.android.ui.pages.PageItem.Page
import org.wordpress.android.ui.pages.PageItem.ParentPage
import org.wordpress.android.ui.reader.utils.ReaderUtils
import org.wordpress.android.ui.utils.UiHelpers
import org.wordpress.android.util.DateTimeUtils
import org.wordpress.android.util.DisplayUtils
import org.wordpress.android.util.ImageUtils
import org.wordpress.android.util.QuickStartUtils
import org.wordpress.android.util.extensions.capitalizeWithLocaleWithoutLint
import org.wordpress.android.util.extensions.currentLocale
import org.wordpress.android.util.extensions.getDrawableFromAttribute
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.util.image.ImageType
import org.wordpress.android.util.extensions.setVisible
import org.wordpress.android.viewmodel.uistate.ProgressBarUiState
import org.wordpress.android.viewmodel.uistate.ProgressBarUiState.Determinate
import org.wordpress.android.viewmodel.uistate.ProgressBarUiState.Indeterminate
import java.util.Date
import java.util.Locale

<span class="nc" id="L42">sealed class PageItemViewHolder(internal val parent: ViewGroup, @LayoutRes layout: Int) :</span>
<span class="nc" id="L43">        RecyclerView.ViewHolder(LayoutInflater.from(parent.context).inflate(layout, parent, false)) {</span>
    abstract fun onBind(pageItem: PageItem)

<span class="nc" id="L46">    class PageViewHolder(</span>
        parentView: ViewGroup,
<span class="nc" id="L48">        private val onMenuAction: (PageItem.Action, Page) -&gt; Boolean,</span>
<span class="nc" id="L49">        private val onItemTapped: (Page) -&gt; Unit,</span>
<span class="nc" id="L50">        private val imageManager: ImageManager? = null,</span>
<span class="nc" id="L51">        private val isSitePhotonCapable: Boolean = false,</span>
<span class="nc" id="L52">        private val isPrivateAtSite: Boolean = false,</span>
<span class="nc" id="L53">        private val uiHelper: UiHelpers</span>
<span class="nc" id="L54">    ) : PageItemViewHolder(parentView, R.layout.page_list_item) {</span>
<span class="nc" id="L55">        private val pageTitle = itemView.findViewById&lt;TextView&gt;(R.id.page_title)</span>
<span class="nc" id="L56">        private val pageMore = itemView.findViewById&lt;ImageButton&gt;(R.id.page_more)</span>
<span class="nc" id="L57">        private val pageSubtitle = itemView.findViewById&lt;TextView&gt;(R.id.page_subtitle)</span>
<span class="nc" id="L58">        private val pageSubtitleIcon = itemView.findViewById&lt;ImageView&gt;(R.id.page_subtitle_icon)</span>
<span class="nc" id="L59">        private val pageSubtitleSuffix = itemView.findViewById&lt;TextView&gt;(R.id.page_subtitle_suffix)</span>
<span class="nc" id="L60">        private val labels = itemView.findViewById&lt;TextView&gt;(R.id.labels)</span>
<span class="nc" id="L61">        private val featuredImage = itemView.findViewById&lt;ImageView&gt;(R.id.featured_image)</span>
<span class="nc" id="L62">        private val uploadProgressBar: ProgressBar = itemView.findViewById(R.id.upload_progress)</span>
<span class="nc" id="L63">        private val disabledOverlay: FrameLayout = itemView.findViewById(R.id.disabled_overlay)</span>
<span class="nc" id="L64">        private val pageItemContainer = itemView.findViewById&lt;ViewGroup&gt;(R.id.page_item)</span>
<span class="nc" id="L65">        private val pageLayout = itemView.findViewById&lt;ViewGroup&gt;(R.id.page_layout)</span>
<span class="nc" id="L66">        private val selectableBackground: Drawable? = parent.context.getDrawableFromAttribute(</span>
<span class="nc" id="L67">                android.R.attr.selectableItemBackground</span>
        )

        companion object {
            const val FEATURED_IMAGE_THUMBNAIL_SIZE_DP = 40
        }

        override fun onBind(pageItem: PageItem) {
<span class="nc" id="L75">            (pageItem as Page).let { page -&gt;</span>
<span class="nc" id="L76">                val indentWidth = DisplayUtils.dpToPx(parent.context, 16 * page.indent)</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">                val marginLayoutParams = pageItemContainer.layoutParams as ViewGroup.MarginLayoutParams</span>
<span class="nc" id="L78">                marginLayoutParams.leftMargin = indentWidth</span>
<span class="nc" id="L79">                pageItemContainer.layoutParams = marginLayoutParams</span>

<span class="nc bnc" id="L81" title="All 4 branches missed.">                pageTitle.text = if (page.title.isEmpty()) {</span>
<span class="nc" id="L82">                    parent.context.getString(R.string.untitled_in_parentheses)</span>
                } else {
<span class="nc" id="L84">                    page.title</span>
                }

<span class="nc" id="L87">                showSubtitle(page.date, page.author, page.subtitle, page.icon)</span>

<span class="nc" id="L89">                labels.text = page.labels.map { uiHelper.getTextOfUiString(parent.context, it).toString() }.sorted()</span>
<span class="nc" id="L90">                        .joinToString(separator = &quot; Â· &quot;)</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                page.labelsColor?.let { labelsColor -&gt;</span>
<span class="nc" id="L92">                    labels.setTextColor(</span>
<span class="nc" id="L93">                            ContextCompat.getColor(</span>
<span class="nc" id="L94">                                    itemView.context,</span>
<span class="nc" id="L95">                                    labelsColor</span>
                            )
                    )
<span class="nc" id="L98">                }</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">                uiHelper.updateVisibility(labels, page.labels.isNotEmpty())</span>

<span class="nc" id="L102">                itemView.setOnClickListener {</span>
<span class="nc" id="L103">                    QuickStartUtils.removeQuickStartFocusPoint(pageItemContainer)</span>
<span class="nc" id="L104">                    onItemTapped(page)</span>
<span class="nc" id="L105">                }</span>

<span class="nc" id="L107">                pageMore.setOnClickListener { view -&gt; moreClick(page, view) }</span>
<span class="nc" id="L108">                pageMore.visibility =</span>
<span class="nc bnc" id="L109" title="All 6 branches missed.">                        if (page.actions.isNotEmpty() &amp;&amp; page.actionsEnabled) View.VISIBLE else View.INVISIBLE</span>

<span class="nc" id="L111">                setBackground(page.tapActionEnabled)</span>
<span class="nc" id="L112">                showFeaturedImage(page.imageUrl)</span>

<span class="nc" id="L114">                uiHelper.updateVisibility(disabledOverlay, page.showOverlay)</span>
<span class="nc" id="L115">                updateProgressBarState(page.progressBarUiState)</span>

                // Clean up focus tip if there
<span class="nc" id="L118">                QuickStartUtils.removeQuickStartFocusPoint(pageItemContainer)</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (page.showQuickStartFocusPoint) {</span>
<span class="nc" id="L120">                    pageItemContainer.post {</span>
<span class="nc" id="L121">                        val horizontalOffset = pageItemContainer.width / 2</span>
<span class="nc" id="L122">                        val verticalOffset = (pageItemContainer.height)</span>
<span class="nc" id="L123">                        QuickStartUtils.addQuickStartFocusPointAboveTheView(</span>
<span class="nc" id="L124">                                pageItemContainer,</span>
<span class="nc" id="L125">                                pageMore,</span>
<span class="nc" id="L126">                                horizontalOffset,</span>
<span class="nc" id="L127">                                -verticalOffset</span>
                        )
<span class="nc" id="L129">                    }</span>
                }
<span class="nc" id="L131">            }</span>
<span class="nc" id="L132">        }</span>

        private fun updateProgressBarState(progressBarUiState: ProgressBarUiState) {
<span class="nc" id="L135">            uiHelper.updateVisibility(uploadProgressBar, progressBarUiState.visibility)</span>
<span class="nc" id="L136">            when (progressBarUiState) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                Indeterminate -&gt; uploadProgressBar.isIndeterminate = true</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                is Determinate -&gt; {</span>
<span class="nc" id="L139">                    uploadProgressBar.isIndeterminate = false</span>
<span class="nc" id="L140">                    uploadProgressBar.progress = progressBarUiState.progress</span>
                }
            }
<span class="nc" id="L143">        }</span>

        private fun setBackground(tapActionEnabled: Boolean) {
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (tapActionEnabled) {</span>
<span class="nc" id="L147">                pageLayout.background = selectableBackground</span>
            } else {
<span class="nc" id="L149">                pageLayout.background = null</span>
            }
<span class="nc" id="L151">        }</span>

        private fun moreClick(pageItem: Page, v: View) {
<span class="nc" id="L154">            val popup = PopupMenu(v.context, v)</span>
<span class="nc" id="L155">            popup.setOnMenuItemClickListener { item -&gt;</span>
<span class="nc" id="L156">                val action = PageItem.Action.fromItemId(item.itemId)</span>
<span class="nc" id="L157">                onMenuAction(action, pageItem)</span>
            }
<span class="nc" id="L159">            popup.menuInflater.inflate(R.menu.page_more, popup.menu)</span>
<span class="nc" id="L160">            PageItem.Action.values().forEach {</span>
<span class="nc" id="L161">                popup.menu.findItem(it.itemId).isVisible = pageItem.actions.contains(it)</span>
<span class="nc" id="L162">            }</span>
<span class="nc" id="L163">            popup.show()</span>
<span class="nc" id="L164">        }</span>

        private fun showFeaturedImage(imageUrl: String?) {
<span class="nc" id="L167">            val imageSize = DisplayUtils.dpToPx(parent.context, FEATURED_IMAGE_THUMBNAIL_SIZE_DP)</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (imageUrl == null) {</span>
<span class="nc" id="L169">                featuredImage.visibility = View.GONE</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                imageManager?.cancelRequestAndClearImageView(featuredImage)</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            } else if (imageUrl.startsWith(&quot;http&quot;)) {</span>
<span class="nc" id="L172">                featuredImage.visibility = View.VISIBLE</span>
<span class="nc" id="L173">                val photonUrl = ReaderUtils.getResizedImageUrl(</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                        imageUrl, imageSize, imageSize, !isSitePhotonCapable, isPrivateAtSite</span>
                )
<span class="nc bnc" id="L176" title="All 2 branches missed.">                imageManager?.load(featuredImage, ImageType.PHOTO, photonUrl, ScaleType.CENTER_CROP)</span>
            } else {
<span class="nc" id="L178">                val bmp = ImageUtils.getWPImageSpanThumbnailFromFilePath(featuredImage.context, imageUrl, imageSize)</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (bmp != null) {</span>
<span class="nc" id="L180">                    featuredImage.visibility = View.VISIBLE</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                    imageManager?.load(featuredImage, bmp)</span>
                } else {
<span class="nc" id="L183">                    featuredImage.visibility = View.GONE</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                    imageManager?.cancelRequestAndClearImageView(featuredImage)</span>
                }
            }
<span class="nc" id="L187">        }</span>

        private fun showSubtitle(inputDate: Date, author: String?, subtitle: Int?, icon: Int?) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            val date = if (inputDate == Date(0)) Date() else inputDate</span>
<span class="nc" id="L191">            val stringDate = DateTimeUtils.javaDateToTimeSpan(date, parent.context)</span>
<span class="nc" id="L192">                    .capitalizeWithLocaleWithoutLint(parent.context.currentLocale)</span>

            /** The subtitle is split in two TextViews:
             * - Date and Author (if not null) occupy the [pageSubtitle] TextView
             * - Subtitle fills the [pageSubtitleSuffix] TextView
             */
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (subtitle != null) {</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">                pageSubtitle.text = author?.let {</span>
<span class="nc" id="L200">                    String.format(</span>
<span class="nc" id="L201">                            Locale.getDefault(),</span>
<span class="nc" id="L202">                            parent.context.getString(R.string.pages_item_date_author_subtitle),</span>
<span class="nc" id="L203">                            stringDate,</span>
<span class="nc" id="L204">                            it</span>
                    )
<span class="nc" id="L206">                } ?: String.format(</span>
<span class="nc" id="L207">                        Locale.getDefault(),</span>
<span class="nc" id="L208">                        parent.context.getString(R.string.pages_item_date_subtitle),</span>
<span class="nc" id="L209">                        stringDate</span>
                )
<span class="nc" id="L211">                pageSubtitleSuffix.text = parent.context.getString(subtitle)</span>
            } else {
<span class="nc bnc" id="L213" title="All 2 branches missed.">                pageSubtitle.text = author?.let {</span>
<span class="nc" id="L214">                    String.format(</span>
<span class="nc" id="L215">                            Locale.getDefault(),</span>
<span class="nc" id="L216">                            parent.context.getString(R.string.pages_item_date_author),</span>
<span class="nc" id="L217">                            stringDate,</span>
<span class="nc" id="L218">                            it</span>
                    )
<span class="nc" id="L220">                } ?: stringDate</span>
<span class="nc" id="L221">                pageSubtitleSuffix.text = &quot;&quot;</span>
            }

<span class="nc bnc" id="L224" title="All 2 branches missed.">            icon?.let { pageSubtitleIcon.setImageResource(it) }</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            pageSubtitleIcon.setVisible(icon != null)</span>
<span class="nc" id="L226">        }</span>
<span class="nc" id="L227">    }</span>

<span class="nc" id="L229">    class PageDividerViewHolder(parentView: ViewGroup) : PageItemViewHolder(parentView, R.layout.page_divider_item) {</span>
<span class="nc" id="L230">        private val dividerTitle = itemView.findViewById&lt;TextView&gt;(R.id.divider_text)</span>

        override fun onBind(pageItem: PageItem) {
<span class="nc" id="L233">            (pageItem as Divider).apply {</span>
<span class="nc" id="L234">                dividerTitle.text = pageItem.title</span>
<span class="nc" id="L235">            }</span>
<span class="nc" id="L236">        }</span>
    }

<span class="nc" id="L239">    class PageParentViewHolder(</span>
        parentView: ViewGroup,
<span class="nc" id="L241">        private val onParentSelected: (ParentPage) -&gt; Unit,</span>
        @LayoutRes layout: Int
<span class="nc" id="L243">    ) : PageItemViewHolder(parentView, layout) {</span>
<span class="nc" id="L244">        private val pageTitle = itemView.findViewById&lt;TextView&gt;(R.id.page_title)</span>
<span class="nc" id="L245">        private val radioButton = itemView.findViewById&lt;RadioButton&gt;(R.id.radio_button)</span>

        override fun onBind(pageItem: PageItem) {
<span class="nc" id="L248">            (pageItem as ParentPage).apply {</span>
<span class="nc bnc" id="L249" title="All 4 branches missed.">                pageTitle.text = if (pageItem.title.isEmpty()) {</span>
<span class="nc" id="L250">                    parent.context.getString(R.string.untitled_in_parentheses)</span>
                } else {
<span class="nc" id="L252">                    pageItem.title</span>
                }
<span class="nc" id="L254">                radioButton.isChecked = pageItem.isSelected</span>
<span class="nc" id="L255">                itemView.setOnClickListener {</span>
<span class="nc" id="L256">                    onParentSelected(pageItem)</span>
<span class="nc" id="L257">                }</span>
<span class="nc" id="L258">                radioButton.setOnClickListener {</span>
<span class="nc" id="L259">                    onParentSelected(pageItem)</span>
<span class="nc" id="L260">                }</span>
<span class="nc" id="L261">            }</span>
<span class="nc" id="L262">        }</span>
    }

<span class="nc" id="L265">    class EmptyViewHolder(</span>
        parentView: ViewGroup,
<span class="nc" id="L267">        private val onActionButtonClicked: () -&gt; Unit</span>
<span class="nc" id="L268">    ) : PageItemViewHolder(parentView, R.layout.page_empty_item) {</span>
<span class="nc" id="L269">        private val emptyView = itemView.findViewById&lt;ActionableEmptyView&gt;(R.id.actionable_empty_view)</span>

        @Suppress(&quot;DEPRECATION&quot;)
        override fun onBind(pageItem: PageItem) {
<span class="nc" id="L273">            (pageItem as Empty).apply {</span>
<span class="nc" id="L274">                emptyView.title.text = emptyView.resources.getString(pageItem.textResource)</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">                if (pageItem.isButtonVisible) {</span>
<span class="nc" id="L277">                    emptyView.button.setOnClickListener {</span>
<span class="nc" id="L278">                        onActionButtonClicked()</span>
<span class="nc" id="L279">                    }</span>
<span class="nc" id="L280">                    emptyView.button.visibility = View.VISIBLE</span>
                } else {
<span class="nc" id="L282">                    emptyView.button.visibility = View.GONE</span>
                }

<span class="nc bnc" id="L285" title="All 2 branches missed.">                emptyView.image.visibility = if (pageItem.isImageVisible) View.VISIBLE else View.GONE</span>

<span class="nc" id="L287">                emptyView.updateLayoutForSearch(pageItem.isSearching, 0)</span>
<span class="nc" id="L288">            }</span>
<span class="nc" id="L289">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>