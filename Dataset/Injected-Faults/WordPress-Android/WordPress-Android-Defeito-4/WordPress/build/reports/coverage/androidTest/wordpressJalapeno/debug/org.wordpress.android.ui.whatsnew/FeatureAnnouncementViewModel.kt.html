<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FeatureAnnouncementViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.whatsnew</a> &gt; <span class="el_source">FeatureAnnouncementViewModel.kt</span></div><h1>FeatureAnnouncementViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.whatsnew

import android.text.TextUtils
import androidx.lifecycle.LiveData
import androidx.lifecycle.MediatorLiveData
import androidx.lifecycle.MutableLiveData
import kotlinx.coroutines.CoroutineDispatcher
import org.wordpress.android.analytics.AnalyticsTracker.Stat
import org.wordpress.android.modules.UI_THREAD
import org.wordpress.android.ui.prefs.AppPrefsWrapper
import org.wordpress.android.util.BuildConfigWrapper
import org.wordpress.android.util.analytics.AnalyticsTrackerWrapper
import org.wordpress.android.viewmodel.ScopedViewModel
import org.wordpress.android.viewmodel.SingleLiveEvent
import javax.inject.Inject
import javax.inject.Named

<span class="nc" id="L18">class FeatureAnnouncementViewModel @Inject constructor(</span>
<span class="nc" id="L19">    private val featureAnnouncementProvider: FeatureAnnouncementProvider,</span>
<span class="nc" id="L20">    private val analyticsTrackerWrapper: AnalyticsTrackerWrapper,</span>
<span class="nc" id="L21">    private val buildConfigWrapper: BuildConfigWrapper,</span>
<span class="nc" id="L22">    private val appPrefsWrapper: AppPrefsWrapper,</span>
<span class="nc" id="L23">    @Named(UI_THREAD) private val mainDispatcher: CoroutineDispatcher</span>
<span class="nc" id="L24">) : ScopedViewModel(mainDispatcher) {</span>
<span class="nc" id="L25">    private val _currentFeatureAnnouncement = MutableLiveData&lt;FeatureAnnouncement?&gt;()</span>

<span class="nc" id="L27">    private val timeOnScreenParameter = &quot;time_on_screen_sec&quot;</span>

    private var sessionStart: Long = 0
    private var totalSessionsLength: Long = 0

<span class="nc" id="L32">    private val _uiModel = MediatorLiveData&lt;FeatureAnnouncementUiModel&gt;()</span>
<span class="nc" id="L33">    val uiModel: LiveData&lt;FeatureAnnouncementUiModel&gt; = _uiModel</span>

<span class="nc" id="L35">    private val _onDialogClosed = SingleLiveEvent&lt;Unit&gt;()</span>
<span class="nc" id="L36">    val onDialogClosed: LiveData&lt;Unit&gt; = _onDialogClosed</span>

<span class="nc" id="L38">    private val _onAnnouncementDetailsRequested = SingleLiveEvent&lt;String&gt;()</span>
<span class="nc" id="L39">    val onAnnouncementDetailsRequested: LiveData&lt;String&gt; = _onAnnouncementDetailsRequested</span>

<span class="nc" id="L41">    private val _featureItems = MediatorLiveData&lt;List&lt;FeatureAnnouncementItem&gt;&gt;()</span>
<span class="nc" id="L42">    val featureItems: LiveData&lt;List&lt;FeatureAnnouncementItem&gt;&gt; = _featureItems</span>

    private var isStarted = false

<span class="nc" id="L46">    init {</span>
<span class="nc" id="L47">        _uiModel.addSource(_currentFeatureAnnouncement) { featureAnnouncement -&gt;</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">            _uiModel.value = _uiModel.value?.copy(</span>
<span class="nc bnc" id="L49" title="All 4 branches missed.">                    appVersion = featureAnnouncement?.appVersionName ?: &quot;&quot;,</span>
<span class="nc" id="L50">                    isProgressVisible = false,</span>
<span class="nc bnc" id="L51" title="All 4 branches missed.">                    isFindOutMoreVisible = !TextUtils.isEmpty(featureAnnouncement?.detailsUrl)</span>
            )
<span class="nc" id="L53">        }</span>

<span class="nc" id="L55">        _featureItems.addSource(_currentFeatureAnnouncement) { featureAnnouncement -&gt;</span>
<span class="nc bnc" id="L56" title="All 4 branches missed.">            featureAnnouncement?.features?.let { _featureItems.value = it }</span>
<span class="nc" id="L57">        }</span>
<span class="nc" id="L58">    }</span>

    fun start() {
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (isStarted) return</span>
<span class="nc" id="L62">        isStarted = true</span>

<span class="nc" id="L64">        _uiModel.value = FeatureAnnouncementUiModel(isProgressVisible = true)</span>

<span class="nc" id="L66">        loadFeatures()</span>
<span class="nc" id="L67">    }</span>

    private fun loadFeatures() {
<span class="nc" id="L70">        launch {</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            val latestAnnouncement = featureAnnouncementProvider.getLatestFeatureAnnouncement(true)</span>
<span class="nc" id="L72">                    ?: featureAnnouncementProvider.getLatestFeatureAnnouncement(false) // fallback to remote just in case. Should not happen.</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (latestAnnouncement != null) {</span>
<span class="nc" id="L74">                appPrefsWrapper.featureAnnouncementShownVersion = latestAnnouncement.announcementVersion</span>
<span class="nc" id="L75">                appPrefsWrapper.lastFeatureAnnouncementAppVersionCode = buildConfigWrapper.getAppVersionCode()</span>
            }
<span class="nc" id="L77">            _currentFeatureAnnouncement.value = latestAnnouncement</span>
<span class="nc" id="L78">        }</span>
<span class="nc" id="L79">    }</span>

    fun onCloseDialogButtonPressed() {
<span class="nc" id="L82">        _onDialogClosed.call()</span>
<span class="nc" id="L83">    }</span>

    fun onFindMoreButtonPressed() {
<span class="nc" id="L86">        analyticsTrackerWrapper.track(Stat.FEATURE_ANNOUNCEMENT_FIND_OUT_MORE_TAPPED)</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">        _currentFeatureAnnouncement.value?.detailsUrl?.let { _onAnnouncementDetailsRequested.value = it }</span>
<span class="nc" id="L88">    }</span>

<span class="nc" id="L90">    data class FeatureAnnouncementUiModel(</span>
<span class="nc" id="L91">        val appVersion: String = &quot;&quot;,</span>
<span class="nc" id="L92">        val isProgressVisible: Boolean = false,</span>
<span class="nc" id="L93">        val isFindOutMoreVisible: Boolean = true</span>
<span class="nc" id="L94">    )</span>

    fun onSessionStarted() {
<span class="nc" id="L97">        sessionStart = System.currentTimeMillis()</span>
<span class="nc" id="L98">    }</span>

    fun onSessionPaused() {
<span class="nc" id="L101">        val timeOnScreen = (System.currentTimeMillis() - sessionStart) / 1000</span>
<span class="nc" id="L102">        totalSessionsLength += timeOnScreen</span>
<span class="nc" id="L103">    }</span>

    fun onSessionEnded() {
<span class="nc" id="L106">        analyticsTrackerWrapper.track(</span>
<span class="nc" id="L107">                Stat.FEATURE_ANNOUNCEMENT_CLOSE_DIALOG_BUTTON_TAPPED,</span>
<span class="nc" id="L108">                mapOf(timeOnScreenParameter to totalSessionsLength)</span>
        )
<span class="nc" id="L110">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>