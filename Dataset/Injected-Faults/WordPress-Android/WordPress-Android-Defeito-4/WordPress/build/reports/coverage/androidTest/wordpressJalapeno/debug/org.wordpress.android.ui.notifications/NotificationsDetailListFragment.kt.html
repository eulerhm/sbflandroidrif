<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationsDetailListFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.notifications</a> &gt; <span class="el_source">NotificationsDetailListFragment.kt</span></div><h1>NotificationsDetailListFragment.kt</h1><pre class="source lang-java linenums">/**
 * One fragment to rule them all (Notes, that is)
 */
package org.wordpress.android.ui.notifications

import android.annotation.SuppressLint
import android.os.AsyncTask
import android.os.Bundle
import android.text.TextUtils
import android.view.Gravity
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.LinearLayout
import android.widget.ListView
import androidx.fragment.app.ListFragment
import com.airbnb.lottie.LottieAnimationView
import org.json.JSONArray
import org.json.JSONException
import org.wordpress.android.R
import org.wordpress.android.R.layout
import org.wordpress.android.R.string
import org.wordpress.android.WordPress
import org.wordpress.android.datasets.NotificationsTable
import org.wordpress.android.datasets.ReaderCommentTable
import org.wordpress.android.datasets.ReaderPostTable
import org.wordpress.android.fluxc.model.CommentStatus
import org.wordpress.android.fluxc.tools.FormattableContent
import org.wordpress.android.fluxc.tools.FormattableRangeType.COMMENT
import org.wordpress.android.fluxc.tools.FormattableRangeType.FOLLOW
import org.wordpress.android.fluxc.tools.FormattableRangeType.LIKE
import org.wordpress.android.fluxc.tools.FormattableRangeType.POST
import org.wordpress.android.fluxc.tools.FormattableRangeType.REWIND_DOWNLOAD_READY
import org.wordpress.android.fluxc.tools.FormattableRangeType.SCAN
import org.wordpress.android.fluxc.tools.FormattableRangeType.SITE
import org.wordpress.android.fluxc.tools.FormattableRangeType.STAT
import org.wordpress.android.fluxc.tools.FormattableRangeType.USER
import org.wordpress.android.models.Note
import org.wordpress.android.ui.ScrollableViewInitializedListener
import org.wordpress.android.ui.ViewPagerFragment.Companion.restoreOriginalViewId
import org.wordpress.android.ui.ViewPagerFragment.Companion.setUniqueIdToView
import org.wordpress.android.ui.engagement.ListScenarioUtils
import org.wordpress.android.ui.notifications.adapters.NoteBlockAdapter
import org.wordpress.android.ui.notifications.blocks.BlockType
import org.wordpress.android.ui.notifications.blocks.CommentUserNoteBlock
import org.wordpress.android.ui.notifications.blocks.CommentUserNoteBlock.OnCommentStatusChangeListener
import org.wordpress.android.ui.notifications.blocks.FooterNoteBlock
import org.wordpress.android.ui.notifications.blocks.GeneratedNoteBlock
import org.wordpress.android.ui.notifications.blocks.HeaderNoteBlock
import org.wordpress.android.ui.notifications.blocks.NoteBlock
import org.wordpress.android.ui.notifications.blocks.NoteBlock.OnNoteBlockTextClickListener
import org.wordpress.android.ui.notifications.blocks.NoteBlockClickableSpan
import org.wordpress.android.ui.notifications.blocks.UserNoteBlock
import org.wordpress.android.ui.notifications.blocks.UserNoteBlock.OnGravatarClickedListener
import org.wordpress.android.ui.notifications.utils.NotificationsUtilsWrapper
import org.wordpress.android.ui.reader.ReaderActivityLauncher
import org.wordpress.android.ui.reader.actions.ReaderPostActions
import org.wordpress.android.ui.reader.comments.ThreadedCommentsActionSource.COMMENT_NOTIFICATION
import org.wordpress.android.ui.reader.services.comment.ReaderCommentService
import org.wordpress.android.ui.reader.utils.ReaderUtils
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T.NOTIFS
import org.wordpress.android.util.ToastUtils
import org.wordpress.android.util.getRangeIdOrZero
import org.wordpress.android.util.image.ImageManager
import org.wordpress.android.util.image.ImageType.AVATAR_WITH_BACKGROUND
import org.wordpress.android.util.image.ImageType.BLAVATAR
import java.util.ArrayList
import javax.inject.Inject

// This file was ported from java and there were many complains from linter,
// fixed all of them but for the &quot;TooManyFunctions&quot; the total number of functions was reduced
// but seemed not easily fully avoidable.
// Skipping it for now since there will be probably more work around this area
// and so further opportunity to iterate for review/refactor
@Suppress(&quot;TooManyFunctions&quot;)
<span class="nc" id="L77">class NotificationsDetailListFragment : ListFragment(), NotificationFragment {</span>
    private var restoredListPosition = 0
    private var notification: Note? = null
    private var rootLayout: LinearLayout? = null
    private var footerView: ViewGroup? = null
    private var restoredNoteId: String? = null
<span class="nc" id="L83">    private var commentListPosition = ListView.INVALID_POSITION</span>
    private var onCommentStatusChangeListener: OnCommentStatusChangeListener? = null
    private var noteBlockAdapter: NoteBlockAdapter? = null
    private var confettiShown = false

<span class="nc bnc" id="L88" title="All 2 branches missed.">    @Inject lateinit var imageManager: ImageManager</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">    @Inject lateinit var notificationsUtilsWrapper: NotificationsUtilsWrapper</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">    @Inject lateinit var listScenarioUtils: ListScenarioUtils</span>

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L93">        super.onCreate(savedInstanceState)</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        (requireActivity().application as WordPress).component().inject(this)</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">        if (savedInstanceState != null &amp;&amp; savedInstanceState.containsKey(KEY_NOTE_ID)) {</span>
            // The note will be set in onResume()
            // See WordPress.deferredInit()
<span class="nc" id="L98">            restoredNoteId = savedInstanceState.getString(KEY_NOTE_ID)</span>
<span class="nc" id="L99">            restoredListPosition = savedInstanceState.getInt(KEY_LIST_POSITION, 0)</span>
        }
<span class="nc" id="L101">    }</span>

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
<span class="nc" id="L104">        val view = inflater.inflate(layout.notifications_fragment_detail_list, container, false)</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        rootLayout = view.findViewById(R.id.notifications_list_root) as LinearLayout</span>
<span class="nc" id="L106">        return view</span>
    }

    override fun onActivityCreated(bundle: Bundle?) {
<span class="nc" id="L110">        super.onActivityCreated(bundle)</span>
<span class="nc" id="L111">        val listView = listView</span>
<span class="nc" id="L112">        listView.divider = null</span>
<span class="nc" id="L113">        listView.dividerHeight = 0</span>
<span class="nc" id="L114">        listView.setHeaderDividersEnabled(false)</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (footerView != null) {</span>
<span class="nc" id="L116">            listView.addFooterView(footerView)</span>
        }
<span class="nc" id="L118">        reloadNoteBlocks()</span>
<span class="nc" id="L119">    }</span>

    override fun onResume() {
<span class="nc" id="L122">        super.onResume()</span>
<span class="nc" id="L123">        setUniqueIdToView(listView)</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (activity is ScrollableViewInitializedListener) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            (activity as ScrollableViewInitializedListener).onScrollableViewInitialized(listView.id)</span>
        }

        // Set the note if we retrieved the noteId from savedInstanceState
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (!TextUtils.isEmpty(restoredNoteId)) {</span>
<span class="nc" id="L130">            setNote(restoredNoteId)</span>
<span class="nc" id="L131">            reloadNoteBlocks()</span>
<span class="nc" id="L132">            restoredNoteId = null</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (note == null) {</span>
<span class="nc" id="L135">            showErrorToastAndFinish()</span>
        }

<span class="nc" id="L138">        val confetti: LottieAnimationView = requireActivity().findViewById(R.id.confetti)</span>
<span class="nc bnc" id="L139" title="All 6 branches missed.">        if (note?.isViewMilestoneType == true &amp;&amp; !confettiShown) {</span>
<span class="nc" id="L140">            confetti.playAnimation()</span>
<span class="nc" id="L141">            confettiShown = true</span>
        }
<span class="nc" id="L143">    }</span>

    override fun onPause() {
        // Stop the reader comment service if it is running
<span class="nc" id="L147">        ReaderCommentService.stopService(activity)</span>
<span class="nc" id="L148">        restoreOriginalViewId(listView)</span>
<span class="nc" id="L149">        super.onPause()</span>
<span class="nc" id="L150">    }</span>

    override fun getNote(): Note? {
<span class="nc" id="L153">        return notification</span>
    }

    override fun setNote(noteId: String?) {
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (noteId == null) {</span>
<span class="nc" id="L158">            showErrorToastAndFinish()</span>
<span class="nc" id="L159">            return</span>
        }
<span class="nc" id="L161">        val note: Note? = NotificationsTable.getNoteById(noteId)</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (note == null) {</span>
<span class="nc" id="L163">            showErrorToastAndFinish()</span>
<span class="nc" id="L164">            return</span>
        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (noteId != note.id) {</span>
<span class="nc" id="L167">            confettiShown = false</span>
        }
<span class="nc" id="L169">        notification = note</span>
<span class="nc" id="L170">    }</span>

    private fun showErrorToastAndFinish() {
<span class="nc" id="L173">        AppLog.e(NOTIFS, &quot;Note could not be found.&quot;)</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        activity?.let {</span>
<span class="nc" id="L175">            ToastUtils.showToast(activity, string.error_notification_open)</span>
<span class="nc" id="L176">            it.finish()</span>
<span class="nc" id="L177">        }</span>
<span class="nc" id="L178">    }</span>

    override fun onSaveInstanceState(outState: Bundle) {
<span class="nc bnc" id="L181" title="All 4 branches missed.">        notification?.let {</span>
<span class="nc" id="L182">            outState.putString(KEY_NOTE_ID, it.id)</span>
<span class="nc" id="L183">            outState.putInt(KEY_LIST_POSITION, listView.firstVisiblePosition)</span>
<span class="nc" id="L184">        } ?: run {</span>
            // This is done so the fragments pre-loaded by the view pager can store the already rescued restoredNoteId
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (!TextUtils.isEmpty(restoredNoteId)) {</span>
<span class="nc" id="L187">                outState.putString(KEY_NOTE_ID, restoredNoteId)</span>
            }
<span class="nc" id="L189">        }</span>

<span class="nc" id="L191">        super.onSaveInstanceState(outState)</span>
<span class="nc" id="L192">    }</span>

    private fun reloadNoteBlocks() {
<span class="nc" id="L195">        LoadNoteBlocksTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR)</span>
<span class="nc" id="L196">    }</span>

    fun setFooterView(footerView: ViewGroup?) {
<span class="nc" id="L199">        this.footerView = footerView</span>
<span class="nc" id="L200">    }</span>

<span class="nc" id="L202">    private val mOnNoteBlockTextClickListener: OnNoteBlockTextClickListener = object : OnNoteBlockTextClickListener {</span>
        override fun onNoteBlockTextClicked(clickedSpan: NoteBlockClickableSpan) {
<span class="nc bnc" id="L204" title="All 4 branches missed.">            if (!isAdded || activity !is NotificationsDetailActivity) {</span>
<span class="nc" id="L205">                return</span>
            }
<span class="nc bnc" id="L207" title="All 2 branches missed.">            handleNoteBlockSpanClick(activity as NotificationsDetailActivity, clickedSpan)</span>
<span class="nc" id="L208">        }</span>

        override fun showDetailForNoteIds() {
<span class="nc bnc" id="L211" title="All 6 branches missed.">            if (!isAdded || notification == null || activity !is NotificationsDetailActivity) {</span>
<span class="nc" id="L212">                return</span>
            }
<span class="nc bnc" id="L214" title="All 2 branches missed.">            val detailActivity = activity as NotificationsDetailActivity</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">            requireNotNull(notification).let { note -&gt;</span>
<span class="nc bnc" id="L217" title="All 6 branches missed.">                if (note.isCommentReplyType || !note.isCommentType &amp;&amp; note.commentId &gt; 0) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    val commentId = if (note.isCommentReplyType) note.parentCommentId else note.commentId</span>

                    // show comments list if it exists in the reader
<span class="nc bnc" id="L221" title="All 2 branches missed.">                    if (ReaderUtils.postAndCommentExists(note.siteId.toLong(), note.postId.toLong(), commentId)) {</span>
<span class="nc" id="L222">                        detailActivity.showReaderCommentsList(note.siteId.toLong(), note.postId.toLong(), commentId)</span>
                    } else {
<span class="nc" id="L224">                        detailActivity.showWebViewActivityForUrl(note.url)</span>
                    }
<span class="nc bnc" id="L226" title="All 2 branches missed.">                } else if (note.isFollowType) {</span>
<span class="nc" id="L227">                    detailActivity.showBlogPreviewActivity(note.siteId.toLong(), note.isFollowType)</span>
                } else {
                    // otherwise, load the post in the Reader
<span class="nc" id="L230">                    detailActivity.showPostActivity(note.siteId.toLong(), note.postId.toLong())</span>
                }
<span class="nc" id="L232">            }</span>
<span class="nc" id="L233">        }</span>

        override fun showReaderPostComments() {
<span class="nc bnc" id="L236" title="All 6 branches missed.">            if (!isAdded || notification == null || notification!!.commentId == 0L) {</span>
<span class="nc" id="L237">                return</span>
            }

<span class="nc bnc" id="L240" title="All 2 branches missed.">            requireNotNull(notification).let { note -&gt;</span>
<span class="nc" id="L241">                ReaderActivityLauncher.showReaderComments(</span>
<span class="nc" id="L242">                        activity, note.siteId.toLong(), note.postId.toLong(),</span>
<span class="nc" id="L243">                        note.commentId,</span>
<span class="nc" id="L244">                        COMMENT_NOTIFICATION.sourceDescription</span>
                )
<span class="nc" id="L246">            }</span>
<span class="nc" id="L247">        }</span>

        override fun showSitePreview(siteId: Long, siteUrl: String) {
<span class="nc bnc" id="L250" title="All 6 branches missed.">            if (!isAdded || notification == null || activity !is NotificationsDetailActivity) {</span>
<span class="nc" id="L251">                return</span>
            }
<span class="nc bnc" id="L253" title="All 2 branches missed.">            val detailActivity = activity as NotificationsDetailActivity</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (siteId != 0L) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                detailActivity.showBlogPreviewActivity(siteId, note?.isFollowType)</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            } else if (!TextUtils.isEmpty(siteUrl)) {</span>
<span class="nc" id="L257">                detailActivity.showWebViewActivityForUrl(siteUrl)</span>
            }
<span class="nc" id="L259">        }</span>

        fun handleNoteBlockSpanClick(
            activity: NotificationsDetailActivity,
            clickedSpan: NoteBlockClickableSpan
        ) {
<span class="nc bnc" id="L265" title="All 11 branches missed.">            when (clickedSpan.rangeType) {</span>
                SITE -&gt;
                    // Show blog preview
<span class="nc bnc" id="L268" title="All 2 branches missed.">                    activity.showBlogPreviewActivity(clickedSpan.id, note?.isFollowType)</span>
                USER -&gt;
                    // Show blog preview
<span class="nc bnc" id="L271" title="All 2 branches missed.">                    activity.showBlogPreviewActivity(clickedSpan.siteId, note?.isFollowType)</span>
                POST -&gt;
                    // Show post detail
<span class="nc" id="L274">                    activity.showPostActivity(clickedSpan.siteId, clickedSpan.id)</span>
                COMMENT -&gt;
                    // Load the comment in the reader list if it exists, otherwise show a webview
<span class="nc bnc" id="L277" title="All 2 branches missed.">                    if (ReaderUtils.postAndCommentExists(</span>
<span class="nc" id="L278">                                    clickedSpan.siteId, clickedSpan.postId,</span>
<span class="nc" id="L279">                                    clickedSpan.id</span>
                            )) {
<span class="nc" id="L281">                        activity.showReaderCommentsList(</span>
<span class="nc" id="L282">                                clickedSpan.siteId, clickedSpan.postId,</span>
<span class="nc" id="L283">                                clickedSpan.id</span>
                        )
                    } else {
<span class="nc" id="L286">                        activity.showWebViewActivityForUrl(clickedSpan.url)</span>
                    }
<span class="nc" id="L288">                SCAN -&gt; activity.showScanActivityForSite(clickedSpan.siteId)</span>
                STAT, FOLLOW -&gt;
                    // We can open native stats if the site is a wpcom or Jetpack sites
<span class="nc" id="L291">                    activity.showStatsActivityForSite(clickedSpan.siteId, clickedSpan.rangeType)</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                LIKE -&gt; if (ReaderPostTable.postExists(clickedSpan.siteId, clickedSpan.id)) {</span>
<span class="nc" id="L293">                    activity.showReaderPostLikeUsers(clickedSpan.siteId, clickedSpan.id)</span>
                } else {
<span class="nc" id="L295">                    activity.showPostActivity(clickedSpan.siteId, clickedSpan.id)</span>
                }
<span class="nc" id="L297">                REWIND_DOWNLOAD_READY -&gt; activity.showBackupForSite(clickedSpan.siteId)</span>
                else -&gt;
                    // We don't know what type of id this is, let's see if it has a URL and push a webview
<span class="nc bnc" id="L300" title="All 2 branches missed.">                    if (!TextUtils.isEmpty(clickedSpan.url)) {</span>
<span class="nc" id="L301">                        activity.showWebViewActivityForUrl(clickedSpan.url)</span>
                    }
            }
<span class="nc" id="L304">        }</span>
    }
<span class="nc" id="L306">    private val mOnGravatarClickedListener = OnGravatarClickedListener { siteId, userId, siteUrl -&gt;</span>
<span class="nc bnc" id="L307" title="All 4 branches missed.">        if (!isAdded || activity !is NotificationsDetailActivity) {</span>
<span class="nc" id="L308">            return@OnGravatarClickedListener</span>
        }
<span class="nc bnc" id="L310" title="All 2 branches missed.">        val detailActivity = activity as NotificationsDetailActivity</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">        if (siteId == 0L &amp;&amp; !TextUtils.isEmpty(siteUrl)) {</span>
<span class="nc" id="L312">            detailActivity.showWebViewActivityForUrl(siteUrl)</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        } else if (siteId != 0L) {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">            detailActivity.showBlogPreviewActivity(siteId, note?.isFollowType)</span>
        }
<span class="nc" id="L316">    }</span>

<span class="nc" id="L318">    private data class ManageUserBlockResults(val index: Int, val noteBlock: NoteBlock, val pingbackUrl: String?)</span>

    // Loop through the 'body' items in this note, and create blocks for each.
    // TODO replace this inner async task with a coroutine
    @SuppressLint(&quot;StaticFieldLeak&quot;)
<span class="nc" id="L323">    private inner class LoadNoteBlocksTask : AsyncTask&lt;Void, Void, List&lt;NoteBlock&gt;?&gt;() {</span>
        private var mIsBadgeView = false

        private fun addHeaderNoteBlock(note: Note, noteList: MutableList&lt;NoteBlock&gt;) {
<span class="nc bnc" id="L327" title="All 2 branches missed.">            val imageType = if (note.isFollowType) BLAVATAR else AVATAR_WITH_BACKGROUND</span>
<span class="nc" id="L328">            val headerNoteBlock = HeaderNoteBlock(</span>
<span class="nc" id="L329">                    activity,</span>
<span class="nc" id="L330">                    listScenarioUtils.transformToFormattableContentList(note.header),</span>
<span class="nc" id="L331">                    imageType,</span>
<span class="nc" id="L332">                    mOnNoteBlockTextClickListener,</span>
<span class="nc" id="L333">                    mOnGravatarClickedListener,</span>
<span class="nc" id="L334">                    imageManager,</span>
<span class="nc" id="L335">                    notificationsUtilsWrapper</span>
            )
<span class="nc" id="L337">            headerNoteBlock.setIsComment(note.isCommentType)</span>
<span class="nc" id="L338">            noteList.add(headerNoteBlock)</span>
<span class="nc" id="L339">        }</span>

        private fun manageUserBlock(
            note: Note,
            bodyArray: JSONArray,
            listSize: Int,
            initialIndex: Int,
            noteObject: FormattableContent
        ): ManageUserBlockResults {
<span class="nc" id="L348">            var index = initialIndex</span>
            var noteBlock: NoteBlock
<span class="nc" id="L350">            var pingbackUrl: String? = null</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">            if (note.isCommentType) {</span>
                // Set comment position so we can target it later
                // See refreshBlocksForCommentStatus()
<span class="nc" id="L354">                commentListPosition = index + listSize</span>
<span class="nc" id="L355">                var commentTextBlock: FormattableContent? = null</span>
                // Next item in the bodyArray is comment text
<span class="nc bnc" id="L357" title="All 2 branches missed.">                if (index + 1 &lt; bodyArray.length()) {</span>
<span class="nc" id="L358">                    commentTextBlock = notificationsUtilsWrapper</span>
<span class="nc" id="L359">                            .mapJsonToFormattableContent(bodyArray.getJSONObject(index + 1))</span>
<span class="nc" id="L360">                    index++</span>
                }
<span class="nc" id="L362">                noteBlock = CommentUserNoteBlock(</span>
<span class="nc" id="L363">                        activity,</span>
<span class="nc" id="L364">                        noteObject,</span>
<span class="nc" id="L365">                        commentTextBlock,</span>
<span class="nc" id="L366">                        note.timestamp,</span>
<span class="nc" id="L367">                        mOnNoteBlockTextClickListener,</span>
<span class="nc" id="L368">                        mOnGravatarClickedListener,</span>
<span class="nc" id="L369">                        imageManager,</span>
<span class="nc" id="L370">                        notificationsUtilsWrapper</span>
                )
<span class="nc" id="L372">                pingbackUrl = noteBlock.metaSiteUrl</span>

                // Set listener for comment status changes, so we can update bg and text colors
<span class="nc" id="L375">                val commentUserNoteBlock: CommentUserNoteBlock = noteBlock</span>
<span class="nc" id="L376">                onCommentStatusChangeListener = commentUserNoteBlock.onCommentChangeListener</span>
<span class="nc" id="L377">                commentUserNoteBlock.setCommentStatus(note.commentStatus)</span>
<span class="nc" id="L378">                commentUserNoteBlock.configureResources(activity)</span>
            } else {
<span class="nc" id="L380">                noteBlock = UserNoteBlock(</span>
<span class="nc" id="L381">                        activity,</span>
<span class="nc" id="L382">                        noteObject,</span>
<span class="nc" id="L383">                        mOnNoteBlockTextClickListener,</span>
<span class="nc" id="L384">                        mOnGravatarClickedListener,</span>
<span class="nc" id="L385">                        imageManager,</span>
<span class="nc" id="L386">                        notificationsUtilsWrapper</span>
                )
            }

<span class="nc" id="L390">            return ManageUserBlockResults(index, noteBlock, pingbackUrl)</span>
        }

        private fun addNotesBlock(
            note: Note,
            noteList: MutableList&lt;NoteBlock&gt;,
            bodyArray: JSONArray,
            isPingback: Boolean
        ): String? {
<span class="nc" id="L399">            var pingbackUrl: String? = null</span>
<span class="nc" id="L400">            var i = 0</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">            while (i &lt; bodyArray.length()) {</span>
<span class="nc" id="L402">                try {</span>
<span class="nc" id="L403">                    val noteObject = notificationsUtilsWrapper</span>
<span class="nc" id="L404">                            .mapJsonToFormattableContent(bodyArray.getJSONObject(i))</span>

                    // Determine NoteBlock type and add it to the array
                    var noteBlock: NoteBlock

<span class="nc bnc" id="L409" title="All 2 branches missed.">                    if (BlockType.fromString(noteObject.type) == BlockType.USER) {</span>
<span class="nc" id="L410">                        val manageUserBlockResults = manageUserBlock(note, bodyArray, noteList.size, i, noteObject)</span>
<span class="nc" id="L411">                        i = manageUserBlockResults.index</span>
<span class="nc" id="L412">                        noteBlock = manageUserBlockResults.noteBlock</span>
<span class="nc" id="L413">                        pingbackUrl = manageUserBlockResults.pingbackUrl</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">                    } else if (isFooterBlock(noteObject)) {</span>
<span class="nc" id="L415">                        noteBlock = FooterNoteBlock(</span>
<span class="nc" id="L416">                                noteObject, imageManager, notificationsUtilsWrapper,</span>
<span class="nc" id="L417">                                mOnNoteBlockTextClickListener</span>
<span class="nc" id="L418">                        ).also {</span>
<span class="nc bnc" id="L419" title="All 6 branches missed.">                            if (noteObject.ranges != null &amp;&amp; noteObject.ranges!!.isNotEmpty()) {</span>
<span class="nc" id="L420">                                val range = noteObject.ranges!![noteObject.ranges!!.size - 1]</span>
<span class="nc" id="L421">                                it.setClickableSpan(range, note.type)</span>
                            }
<span class="nc" id="L423">                        }</span>
                    } else {
<span class="nc" id="L425">                        noteBlock = NoteBlock(</span>
<span class="nc" id="L426">                                noteObject, imageManager, notificationsUtilsWrapper,</span>
<span class="nc" id="L427">                                mOnNoteBlockTextClickListener</span>
                        )
                    }

                    // Badge notifications apply different colors and formatting
<span class="nc bnc" id="L432" title="All 4 branches missed.">                    if (isAdded &amp;&amp; noteBlock.containsBadgeMediaType()) {</span>
<span class="nc" id="L433">                        mIsBadgeView = true</span>
                    }
<span class="nc bnc" id="L435" title="All 2 branches missed.">                    if (mIsBadgeView) {</span>
<span class="nc" id="L436">                        noteBlock.setIsBadge()</span>
                    }
<span class="nc bnc" id="L438" title="All 2 branches missed.">                    if (note.isViewMilestoneType) {</span>
<span class="nc" id="L439">                        noteBlock.setIsViewMilestone()</span>
                    }
<span class="nc bnc" id="L441" title="All 2 branches missed.">                    if (isPingback) {</span>
<span class="nc" id="L442">                        noteBlock.setIsPingback()</span>
                    }
<span class="nc" id="L444">                    noteList.add(noteBlock)</span>
<span class="nc" id="L445">                } catch (e: JSONException) {</span>
<span class="nc" id="L446">                    AppLog.e(NOTIFS, &quot;Invalid note data, could not parse.&quot;)</span>
                }
<span class="nc" id="L448">                i++</span>
            }

<span class="nc" id="L451">            return pingbackUrl</span>
        }

        override fun doInBackground(vararg params: Void): List&lt;NoteBlock&gt;? {
<span class="nc bnc" id="L455" title="All 2 branches missed.">            if (notification == null) {</span>
<span class="nc" id="L456">                return null</span>
            }
<span class="nc" id="L458">            requestReaderContentForNote()</span>

<span class="nc bnc" id="L460" title="All 2 branches missed.">            requireNotNull(notification).let { note -&gt;</span>
<span class="nc" id="L461">                val bodyArray = note.body</span>
<span class="nc" id="L462">                val noteList: MutableList&lt;NoteBlock&gt; = ArrayList()</span>

                // Add the note header if one was provided
<span class="nc bnc" id="L465" title="All 2 branches missed.">                if (note.header != null) {</span>
<span class="nc" id="L466">                    addHeaderNoteBlock(note, noteList)</span>
                }
<span class="nc" id="L468">                var pingbackUrl: String? = null</span>
<span class="nc" id="L469">                val isPingback = isPingback(note)</span>
<span class="nc bnc" id="L470" title="All 4 branches missed.">                if (bodyArray != null &amp;&amp; bodyArray.length() &gt; 0) {</span>
<span class="nc" id="L471">                    pingbackUrl = addNotesBlock(note, noteList, bodyArray, isPingback)</span>
                }
<span class="nc bnc" id="L473" title="All 2 branches missed.">                if (isPingback) {</span>
                    // Remove this when we start receiving &quot;Read the source post block&quot; from the backend
<span class="nc" id="L475">                    val generatedBlock = buildGeneratedLinkBlock(</span>
<span class="nc" id="L476">                            mOnNoteBlockTextClickListener, pingbackUrl,</span>
<span class="nc" id="L477">                            activity!!.getString(string.comment_read_source_post)</span>
                    )
<span class="nc" id="L479">                    generatedBlock.setIsPingback()</span>
<span class="nc" id="L480">                    noteList.add(generatedBlock)</span>
                }
<span class="nc" id="L482">                return noteList</span>
            }
        }

        private fun isPingback(note: Note): Boolean {
<span class="nc" id="L487">            var hasRangeOfTypeSite = false</span>
<span class="nc" id="L488">            var hasRangeOfTypePost = false</span>
<span class="nc" id="L489">            val rangesArray = note.subject.optJSONArray(&quot;ranges&quot;)</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (rangesArray != null) {</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">                for (i in 0 until rangesArray.length()) {</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">                    val rangeObject = rangesArray.optJSONObject(i) ?: continue</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                    if (&quot;site&quot; == rangeObject.optString(&quot;type&quot;)) {</span>
<span class="nc" id="L494">                        hasRangeOfTypeSite = true</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">                    } else if (&quot;post&quot; == rangeObject.optString(&quot;type&quot;)) {</span>
<span class="nc" id="L496">                        hasRangeOfTypePost = true</span>
                    }
                }
            }
<span class="nc bnc" id="L500" title="All 4 branches missed.">            return hasRangeOfTypePost &amp;&amp; hasRangeOfTypeSite</span>
        }

        private fun buildGeneratedLinkBlock(
            onNoteBlockTextClickListener: OnNoteBlockTextClickListener,
            pingbackUrl: String?,
            message: String
        ): NoteBlock {
<span class="nc" id="L508">            return GeneratedNoteBlock(</span>
<span class="nc" id="L509">                    message,</span>
<span class="nc" id="L510">                    imageManager,</span>
<span class="nc" id="L511">                    notificationsUtilsWrapper,</span>
<span class="nc" id="L512">                    onNoteBlockTextClickListener,</span>
<span class="nc" id="L513">                    pingbackUrl!!</span>
            )
        }

        override fun onPostExecute(noteList: List&lt;NoteBlock&gt;?) {
<span class="nc bnc" id="L518" title="All 4 branches missed.">            if (!isAdded || noteList == null) {</span>
<span class="nc" id="L519">                return</span>
            }
<span class="nc bnc" id="L521" title="All 2 branches missed.">            if (mIsBadgeView) {</span>
<span class="nc" id="L522">                rootLayout!!.gravity = Gravity.CENTER_VERTICAL</span>
            }
<span class="nc bnc" id="L524" title="All 2 branches missed.">            if (noteBlockAdapter == null) {</span>
<span class="nc" id="L525">                noteBlockAdapter = NoteBlockAdapter(activity, noteList)</span>
<span class="nc" id="L526">                listAdapter = noteBlockAdapter</span>
            } else {
<span class="nc" id="L528">                noteBlockAdapter!!.setNoteList(noteList)</span>
            }
<span class="nc bnc" id="L530" title="All 2 branches missed.">            if (restoredListPosition &gt; 0) {</span>
<span class="nc" id="L531">                listView.setSelectionFromTop(restoredListPosition, 0)</span>
<span class="nc" id="L532">                restoredListPosition = 0</span>
            }
<span class="nc" id="L534">        }</span>
    }

    private fun isFooterBlock(blockObject: FormattableContent?): Boolean {
<span class="nc bnc" id="L538" title="All 4 branches missed.">        if (notification == null || blockObject == null) {</span>
<span class="nc" id="L539">            return false</span>
        }

<span class="nc bnc" id="L542" title="All 2 branches missed.">        return requireNotNull(notification).let { note -&gt;</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">            if (note.isCommentType) {</span>
<span class="nc" id="L544">                val commentReplyId = blockObject.getRangeIdOrZero(1)</span>
                // Check if this is a comment notification that has been replied to
                // The block will not have a type, and its id will match the comment reply id in the Note.
<span class="nc bnc" id="L547" title="All 4 branches missed.">                (blockObject.type == null &amp;&amp; note.commentReplyId == commentReplyId)</span>
<span class="nc bnc" id="L548" title="All 6 branches missed.">            } else if (note.isFollowType || note.isLikeType || note.isReblogType) {</span>
                // User list notifications have a footer if they have 10 or more users in the body
                // The last block will not have a type, so we can use that to determine if it is the footer
<span class="nc bnc" id="L551" title="All 2 branches missed.">                blockObject.type == null</span>
            } else {
<span class="nc" id="L553">                false</span>
            }
        }
    }

    fun refreshBlocksForCommentStatus(newStatus: CommentStatus) {
<span class="nc bnc" id="L559" title="All 2 branches missed.">        onCommentStatusChangeListener?.let { listener -&gt;</span>
<span class="nc" id="L560">            listener.onCommentStatusChanged(newStatus)</span>
<span class="nc" id="L561">            val listView: ListView? = listView</span>
<span class="nc bnc" id="L562" title="All 4 branches missed.">            if (listView == null || commentListPosition == ListView.INVALID_POSITION) {</span>
<span class="nc" id="L563">                return</span>
            }

            // Redraw the comment row if it is visible so that the background and text colors update
            // See: http://stackoverflow.com/questions/4075975/redraw-a-single-row-in-a-listview/9987616#9987616
<span class="nc" id="L568">            val firstPosition = listView.firstVisiblePosition</span>
<span class="nc" id="L569">            val endPosition = listView.lastVisiblePosition</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">            for (i in firstPosition until endPosition) {</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                if (commentListPosition == i) {</span>
<span class="nc" id="L572">                    val view = listView.getChildAt(i - firstPosition)</span>
<span class="nc" id="L573">                    listView.adapter.getView(i, view, listView)</span>
<span class="nc" id="L574">                    break</span>
                }
            }
<span class="nc" id="L577">        }</span>
<span class="nc" id="L578">    }</span>

    fun refreshBlocksForEditedComment(noteId: String) {
<span class="nc" id="L581">        setNote(noteId)</span>
<span class="nc" id="L582">        reloadNoteBlocks()</span>
<span class="nc" id="L583">    }</span>

    // Requests Reader content for certain notification types
    private fun requestReaderContentForNote() {
<span class="nc bnc" id="L587" title="All 4 branches missed.">        if (notification == null || !isAdded) {</span>
<span class="nc" id="L588">            return</span>
        }

        // Request the reader post so that loading reader activities will work.
<span class="nc bnc" id="L592" title="All 4 branches missed.">        if (notification!!.isUserList &amp;&amp; !ReaderPostTable.postExists(</span>
<span class="nc" id="L593">                        notification!!.siteId.toLong(),</span>
<span class="nc" id="L594">                        notification!!.postId.toLong()</span>
                )) {
<span class="nc" id="L596">            ReaderPostActions.requestBlogPost(notification!!.siteId.toLong(), notification!!.postId.toLong(), null)</span>
        }

<span class="nc bnc" id="L599" title="All 2 branches missed.">        requireNotNull(notification).let { note -&gt;</span>
            // Request reader comments until we retrieve the comment for this note
<span class="nc bnc" id="L601" title="All 6 branches missed.">            val isReplyOrCommentLike = note.isCommentLikeType || note.isCommentReplyType || note.isCommentWithUserReply</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">            val commentNotExists = !ReaderCommentTable.commentExists(</span>
<span class="nc" id="L603">                    note.siteId.toLong(),</span>
<span class="nc" id="L604">                    note.postId.toLong(),</span>
<span class="nc" id="L605">                    note.commentId</span>
            )

<span class="nc bnc" id="L608" title="All 4 branches missed.">            if (isReplyOrCommentLike &amp;&amp; commentNotExists) {</span>
<span class="nc" id="L609">                ReaderCommentService.startServiceForComment(</span>
<span class="nc" id="L610">                        activity,</span>
<span class="nc" id="L611">                        note.siteId.toLong(),</span>
<span class="nc" id="L612">                        note.postId.toLong(),</span>
<span class="nc" id="L613">                        note.commentId</span>
                )
            }
<span class="nc" id="L616">        }</span>
<span class="nc" id="L617">    }</span>

    companion object {
        private const val KEY_NOTE_ID = &quot;noteId&quot;
        private const val KEY_LIST_POSITION = &quot;listPosition&quot;

        @JvmStatic
        fun newInstance(noteId: String?): NotificationsDetailListFragment {
<span class="nc" id="L625">            val fragment = NotificationsDetailListFragment()</span>
<span class="nc" id="L626">            fragment.setNote(noteId)</span>
<span class="nc" id="L627">            return fragment</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>