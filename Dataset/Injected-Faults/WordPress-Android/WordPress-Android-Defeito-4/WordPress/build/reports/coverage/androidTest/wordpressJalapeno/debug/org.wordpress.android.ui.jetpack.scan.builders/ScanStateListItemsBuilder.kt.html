<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScanStateListItemsBuilder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.jetpack.scan.builders</a> &gt; <span class="el_source">ScanStateListItemsBuilder.kt</span></div><h1>ScanStateListItemsBuilder.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.jetpack.scan.builders

import androidx.annotation.ColorRes
import androidx.annotation.DrawableRes
import androidx.annotation.StringRes
import dagger.Reusable
import org.wordpress.android.Constants
import org.wordpress.android.R
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.fluxc.model.scan.ScanStateModel
import org.wordpress.android.fluxc.model.scan.ScanStateModel.ScanProgressStatus
import org.wordpress.android.fluxc.model.scan.threat.ThreatModel
import org.wordpress.android.fluxc.store.ScanStore
import org.wordpress.android.ui.jetpack.common.JetpackListItemState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.ActionButtonState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.DescriptionState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.DescriptionState.ClickableTextInfo
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.HeaderState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.IconState
import org.wordpress.android.ui.jetpack.common.JetpackListItemState.ProgressState
import org.wordpress.android.ui.jetpack.scan.ScanListItemState.FootnoteState
import org.wordpress.android.ui.jetpack.scan.ScanListItemState.ThreatsHeaderItemState
import org.wordpress.android.ui.jetpack.scan.details.ThreatDetailsListItemsBuilder
import org.wordpress.android.ui.reader.utils.DateProvider
import org.wordpress.android.ui.utils.HtmlMessageUtils
import org.wordpress.android.ui.utils.UiString.UiStringRes
import org.wordpress.android.ui.utils.UiString.UiStringResWithParams
import org.wordpress.android.ui.utils.UiString.UiStringText
import org.wordpress.android.viewmodel.ResourceProvider
import javax.inject.Inject

<span class="nc" id="L32">@Reusable</span>
<span class="nc" id="L33">class ScanStateListItemsBuilder @Inject constructor(</span>
<span class="nc" id="L34">    private val dateProvider: DateProvider,</span>
<span class="nc" id="L35">    private val htmlMessageUtils: HtmlMessageUtils,</span>
<span class="nc" id="L36">    private val resourceProvider: ResourceProvider,</span>
<span class="nc" id="L37">    private val threatItemBuilder: ThreatItemBuilder,</span>
<span class="nc" id="L38">    private val threatDetailsListItemsBuilder: ThreatDetailsListItemsBuilder,</span>
<span class="nc" id="L39">    private val scanStore: ScanStore</span>
) {
    @Suppress(&quot;LongParameterList&quot;)
    suspend fun buildScanStateListItems(
        model: ScanStateModel,
        site: SiteModel,
        fixingThreatIds: List&lt;Long&gt;,
        onScanButtonClicked: () -&gt; Unit,
        onFixAllButtonClicked: () -&gt; Unit,
        onThreatItemClicked: (threatId: Long) -&gt; Unit,
        onHelpClicked: () -&gt; Unit,
        onEnterServerCredsIconClicked: () -&gt; Unit
    ): List&lt;JetpackListItemState&gt; {
<span class="nc bnc" id="L52" title="All 4 branches missed.">        return if (fixingThreatIds.isNotEmpty()) {</span>
<span class="nc" id="L53">            buildThreatsFixingStateItems(fixingThreatIds)</span>
<span class="nc bnc" id="L54" title="All 4 branches missed.">        } else when (model.state) {</span>
            ScanStateModel.State.IDLE -&gt; {
<span class="nc bnc" id="L56" title="All 10 branches missed.">                model.threats?.takeIf { threats -&gt; threats.isNotEmpty() }?.let { threats -&gt;</span>
<span class="nc" id="L57">                    buildThreatsFoundStateItems(</span>
<span class="nc" id="L58">                            model,</span>
<span class="nc" id="L59">                            threats,</span>
<span class="nc" id="L60">                            site,</span>
<span class="nc" id="L61">                            onScanButtonClicked,</span>
<span class="nc" id="L62">                            onFixAllButtonClicked,</span>
<span class="nc" id="L63">                            onThreatItemClicked,</span>
<span class="nc" id="L64">                            onHelpClicked,</span>
<span class="nc" id="L65">                            onEnterServerCredsIconClicked</span>
                    )
<span class="nc" id="L67">                } ?: buildThreatsNotFoundStateItems(model, onScanButtonClicked)</span>
            }
<span class="nc" id="L69">            ScanStateModel.State.SCANNING -&gt; buildScanningStateItems(model.mostRecentStatus, model.currentStatus)</span>
<span class="nc" id="L70">            ScanStateModel.State.PROVISIONING -&gt; buildProvisioningStateItems()</span>
<span class="nc" id="L71">            ScanStateModel.State.UNAVAILABLE, ScanStateModel.State.UNKNOWN -&gt; emptyList()</span>
        }
<span class="nc" id="L73">    }</span>

    private suspend fun buildThreatsFixingStateItems(fixingThreatIds: List&lt;Long&gt;): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L76">        val items = mutableListOf&lt;JetpackListItemState&gt;()</span>

<span class="nc" id="L78">        val scanIcon = buildScanIcon(R.drawable.ic_shield_warning_white, R.color.error)</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        val scanHeaderResId = if (fixingThreatIds.size &gt; 1) {</span>
<span class="nc" id="L80">            R.string.scan_fixing_threats_title_plural</span>
<span class="nc" id="L81">        } else R.string.scan_fixing_threats_title_singular</span>
<span class="nc" id="L82">        val scanHeader = HeaderState(UiStringRes(scanHeaderResId))</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        val scanDescriptionResId = if (fixingThreatIds.size &gt; 1) {</span>
<span class="nc" id="L84">            R.string.scan_fixing_threats_description_plural</span>
<span class="nc" id="L85">        } else R.string.scan_fixing_threats_description_singular</span>
<span class="nc" id="L86">        val scanDescription = DescriptionState(UiStringRes(scanDescriptionResId))</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        val scanProgress = ProgressState(isIndeterminate = true, isVisible = fixingThreatIds.isNotEmpty())</span>

<span class="nc" id="L89">        items.add(scanIcon)</span>
<span class="nc" id="L90">        items.add(scanHeader)</span>
<span class="nc" id="L91">        items.add(scanDescription)</span>
<span class="nc" id="L92">        items.add(scanProgress)</span>

<span class="nc" id="L94">        items.addAll(</span>
<span class="nc" id="L95">                fixingThreatIds.mapNotNull { threatId -&gt;</span>
<span class="nc" id="L96">                    items.add(ThreatsHeaderItemState(threatsCount = fixingThreatIds.size))</span>
<span class="nc bnc" id="L97" title="All 4 branches missed.">                    scanStore.getThreatModelByThreatId(threatId)?.let { threatModel -&gt;</span>
<span class="nc" id="L98">                        val threatItem = threatItemBuilder.buildThreatItem(threatModel).copy(</span>
<span class="nc" id="L99">                                isFixing = true,</span>
<span class="nc" id="L100">                                subHeader = threatDetailsListItemsBuilder.buildFixableThreatDescription(</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                                        requireNotNull(threatModel.baseThreatModel.fixable)</span>
<span class="nc" id="L102">                                ).text</span>
                        )
<span class="nc" id="L104">                        threatItem</span>
                    }
                }
        )

<span class="nc" id="L109">        return items</span>
    }

    @Suppress(&quot;LongParameterList&quot;)
    private fun buildThreatsFoundStateItems(
        model: ScanStateModel,
        threats: List&lt;ThreatModel&gt;,
        site: SiteModel,
        onScanButtonClicked: () -&gt; Unit,
        onFixAllButtonClicked: () -&gt; Unit,
        onThreatItemClicked: (threatId: Long) -&gt; Unit,
        onHelpClicked: () -&gt; Unit,
        onEnterServerCredsIconClicked: () -&gt; Unit
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L123">        val items = mutableListOf&lt;JetpackListItemState&gt;()</span>

<span class="nc" id="L125">        val scanIcon = buildScanIcon(R.drawable.ic_shield_warning_white, R.color.error)</span>
<span class="nc" id="L126">        val scanHeader = HeaderState(UiStringRes(R.string.scan_idle_threats_found_title))</span>
<span class="nc" id="L127">        val scanDescription = buildThreatsFoundDescription(site, threats.size, onHelpClicked)</span>
<span class="nc" id="L128">        val scanButton = buildScanButtonAction(titleRes = R.string.scan_again, onClick = onScanButtonClicked)</span>

<span class="nc" id="L130">        items.add(scanIcon)</span>
<span class="nc" id="L131">        items.add(scanHeader)</span>
<span class="nc" id="L132">        items.add(scanDescription)</span>

<span class="nc bnc" id="L134" title="All 4 branches missed.">        val fixableThreats = threats.filter { it.baseThreatModel.fixable != null }</span>
<span class="nc" id="L135">        buildFixAllButtonAction(</span>
<span class="nc" id="L136">                onFixAllButtonClicked = onFixAllButtonClicked,</span>
<span class="nc" id="L137">                isEnabled = model.hasValidCredentials</span>
<span class="nc bnc" id="L138" title="All 6 branches missed.">        ).takeIf { fixableThreats.isNotEmpty() }?.let { items.add(it) }</span>

<span class="nc bnc" id="L140" title="All 6 branches missed.">        if (!model.hasValidCredentials &amp;&amp; fixableThreats.isNotEmpty()) {</span>
<span class="nc" id="L141">            items.add(</span>
<span class="nc" id="L142">                    buildEnterServerCredsMessageState(</span>
<span class="nc" id="L143">                            onEnterServerCredsIconClicked,</span>
<span class="nc" id="L144">                            iconResId = R.drawable.ic_plus_white_24dp,</span>
<span class="nc" id="L145">                            iconColorResId = R.color.colorPrimary,</span>
<span class="nc" id="L146">                            threatsCount = threats.size,</span>
<span class="nc" id="L147">                            siteId = site.siteId</span>
                    )
            )
        }

<span class="nc" id="L152">        items.add(scanButton)</span>

<span class="nc bnc" id="L154" title="All 6 branches missed.">        threats.takeIf { it.isNotEmpty() }?.let {</span>
<span class="nc" id="L155">            items.add(ThreatsHeaderItemState(threatsCount = threats.size))</span>
<span class="nc" id="L156">            items.addAll(threats.map { threat -&gt; threatItemBuilder.buildThreatItem(threat, onThreatItemClicked) })</span>
        }

<span class="nc" id="L159">        return items</span>
    }

    private fun buildThreatsNotFoundStateItems(
        scanStateModel: ScanStateModel,
        onScanButtonClicked: () -&gt; Unit
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L166">        val items = mutableListOf&lt;JetpackListItemState&gt;()</span>

<span class="nc" id="L168">        val scanIcon = buildScanIcon(R.drawable.ic_shield_tick_white, R.color.jetpack_green_40)</span>
<span class="nc" id="L169">        val scanHeader = HeaderState(UiStringRes(R.string.scan_idle_no_threats_found_title))</span>
<span class="nc bnc" id="L170" title="All 6 branches missed.">        val scanDescription = scanStateModel.mostRecentStatus?.startDate?.time?.let {</span>
<span class="nc" id="L171">            buildLastScanDescription(it)</span>
<span class="nc" id="L172">        } ?: DescriptionState(UiStringRes(R.string.scan_idle_manual_scan_description))</span>
<span class="nc" id="L173">        val scanButton = buildScanButtonAction(titleRes = R.string.scan_now, onClick = onScanButtonClicked)</span>

<span class="nc" id="L175">        items.add(scanIcon)</span>
<span class="nc" id="L176">        items.add(scanHeader)</span>
<span class="nc" id="L177">        items.add(scanDescription)</span>
<span class="nc" id="L178">        items.add(scanButton)</span>

<span class="nc" id="L180">        return items</span>
    }

    private fun buildScanningStateItems(
        mostRecentStatus: ScanProgressStatus?,
        currentProgress: ScanProgressStatus?
    ): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L187">        val items = mutableListOf&lt;JetpackListItemState&gt;()</span>
        // TODO: ashiagr replace icon with stroke, using direct icon (color = null) causing issues with dynamic tinting
<span class="nc bnc" id="L189" title="All 2 branches missed.">        val progress = currentProgress?.progress ?: 0</span>
<span class="nc" id="L190">        val scanIcon = buildScanIcon(R.drawable.ic_shield_white, R.color.jetpack_green_5)</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">        val scanTitleRes = if (progress == 0) R.string.scan_preparing_to_scan_title else R.string.scan_scanning_title</span>
<span class="nc" id="L192">        val scanHeader = HeaderState(UiStringRes(scanTitleRes))</span>
<span class="nc bnc" id="L193" title="All 6 branches missed.">        val descriptionRes = if (mostRecentStatus?.isInitial == true) {</span>
<span class="nc" id="L194">            R.string.scan_scanning_is_initial_description</span>
        } else {
<span class="nc" id="L196">            R.string.scan_scanning_description</span>
        }
<span class="nc" id="L198">        val scanDescription = DescriptionState(UiStringRes(descriptionRes))</span>
<span class="nc" id="L199">        val scanProgress = ProgressState(</span>
<span class="nc" id="L200">                progress = progress,</span>
<span class="nc" id="L201">                progressLabel = UiStringResWithParams(</span>
<span class="nc" id="L202">                        R.string.scan_progress_label,</span>
<span class="nc" id="L203">                        listOf(UiStringText(progress.toString()))</span>
                )
        )

<span class="nc" id="L207">        items.add(scanIcon)</span>
<span class="nc" id="L208">        items.add(scanHeader)</span>
<span class="nc" id="L209">        items.add(scanDescription)</span>
<span class="nc" id="L210">        items.add(scanProgress)</span>

<span class="nc" id="L212">        return items</span>
    }

    private fun buildProvisioningStateItems(): List&lt;JetpackListItemState&gt; {
<span class="nc" id="L216">        val items = mutableListOf&lt;JetpackListItemState&gt;()</span>
<span class="nc" id="L217">        val scanIcon = buildScanIcon(R.drawable.ic_shield_white, R.color.jetpack_green_5)</span>
<span class="nc" id="L218">        val scanHeader = HeaderState(UiStringRes(R.string.scan_preparing_to_scan_title))</span>
<span class="nc" id="L219">        val scanDescription = DescriptionState(UiStringRes(R.string.scan_provisioning_description))</span>

<span class="nc" id="L221">        items.add(scanIcon)</span>
<span class="nc" id="L222">        items.add(scanHeader)</span>
<span class="nc" id="L223">        items.add(scanDescription)</span>

<span class="nc" id="L225">        return items</span>
    }

<span class="nc" id="L228">    private fun buildScanIcon(@DrawableRes icon: Int, @ColorRes color: Int?) = IconState(</span>
<span class="nc" id="L229">            icon = icon,</span>
<span class="nc" id="L230">            colorResId = color,</span>
<span class="nc" id="L231">            sizeResId = R.dimen.scan_icon_size,</span>
<span class="nc" id="L232">            marginResId = R.dimen.scan_icon_margin,</span>
<span class="nc" id="L233">            contentDescription = UiStringRes(R.string.scan_state_icon)</span>
<span class="nc" id="L234">    )</span>

<span class="nc" id="L236">    private fun buildScanButtonAction(@StringRes titleRes: Int, onClick: () -&gt; Unit) = ActionButtonState(</span>
<span class="nc" id="L237">            text = UiStringRes(titleRes),</span>
<span class="nc" id="L238">            onClick = onClick,</span>
<span class="nc" id="L239">            contentDescription = UiStringRes(titleRes),</span>
<span class="nc" id="L240">            isSecondary = true</span>
<span class="nc" id="L241">    )</span>

<span class="nc" id="L243">    private fun buildFixAllButtonAction(</span>
        onFixAllButtonClicked: () -&gt; Unit,
<span class="nc" id="L245">        isEnabled: Boolean = true</span>
    ): ActionButtonState {
<span class="nc" id="L247">        val title = UiStringRes(R.string.threats_fix_all)</span>
<span class="nc" id="L248">        return ActionButtonState(</span>
<span class="nc" id="L249">                text = title,</span>
<span class="nc" id="L250">                onClick = onFixAllButtonClicked,</span>
<span class="nc" id="L251">                contentDescription = title,</span>
<span class="nc" id="L252">                isEnabled = isEnabled</span>
        )
    }

    private fun buildLastScanDescription(timeInMs: Long): DescriptionState {
<span class="nc" id="L257">        val durationInMs = dateProvider.getCurrentDate().time - timeInMs</span>
<span class="nc" id="L258">        val hours = durationInMs / ONE_HOUR</span>
<span class="nc" id="L259">        val minutes = durationInMs / ONE_MINUTE</span>
<span class="nc" id="L260">        val displayDuration = when {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            hours &gt; 0 -&gt; UiStringResWithParams(R.string.scan_in_hours_ago, listOf(UiStringText(&quot;${hours.toInt()}&quot;)))</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">            minutes &gt; 0 -&gt; UiStringResWithParams(</span>
<span class="nc" id="L263">                    R.string.scan_in_minutes_ago,</span>
<span class="nc" id="L264">                    listOf(UiStringText(&quot;${minutes.toInt()}&quot;))</span>
            )
<span class="nc" id="L266">            else -&gt; UiStringRes(R.string.scan_in_few_seconds)</span>
        }

<span class="nc" id="L269">        return DescriptionState(</span>
<span class="nc" id="L270">                UiStringResWithParams(</span>
<span class="nc" id="L271">                        R.string.scan_idle_last_scan_description,</span>
<span class="nc" id="L272">                        listOf(displayDuration, UiStringRes(R.string.scan_idle_manual_scan_description))</span>
                )
        )
    }

    private fun buildThreatsFoundDescription(
        site: SiteModel,
        threatsCount: Int,
        onHelpClicked: () -&gt; Unit
    ): DescriptionState {
<span class="nc" id="L282">        val clickableText = resourceProvider.getString(R.string.scan_here_to_help)</span>

<span class="nc bnc" id="L284" title="All 2 branches missed.">        val descriptionText = if (threatsCount &gt; 1) {</span>
<span class="nc" id="L285">            htmlMessageUtils</span>
<span class="nc" id="L286">                    .getHtmlMessageFromStringFormatResId(</span>
<span class="nc" id="L287">                            R.string.scan_idle_threats_description_plural,</span>
<span class="nc" id="L288">                            &quot;&lt;b&gt;$threatsCount&lt;/b&gt;&quot;,</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                            &quot;&lt;b&gt;${site.name ?: resourceProvider.getString(R.string.scan_this_site)}&lt;/b&gt;&quot;,</span>
<span class="nc" id="L290">                            clickableText</span>
                    )
        } else {
<span class="nc" id="L293">            htmlMessageUtils</span>
<span class="nc" id="L294">                    .getHtmlMessageFromStringFormatResId(</span>
<span class="nc" id="L295">                            R.string.scan_idle_threats_description_singular,</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                            &quot;&lt;b&gt;${site.name ?: resourceProvider.getString(R.string.scan_this_site)}&lt;/b&gt;&quot;,</span>
<span class="nc" id="L297">                            clickableText</span>
                    )
        }

<span class="nc" id="L301">        val clickableTextStartIndex = descriptionText.indexOf(clickableText)</span>
<span class="nc" id="L302">        val clickableTextEndIndex = clickableTextStartIndex + clickableText.length</span>
<span class="nc" id="L303">        val clickableTextsInfo = listOf(</span>
<span class="nc" id="L304">                ClickableTextInfo(</span>
<span class="nc" id="L305">                        startIndex = clickableTextStartIndex,</span>
<span class="nc" id="L306">                        endIndex = clickableTextEndIndex,</span>
<span class="nc" id="L307">                        onClick = onHelpClicked</span>
                )
        )

<span class="nc" id="L311">        return DescriptionState(</span>
<span class="nc" id="L312">                text = UiStringText(descriptionText),</span>
<span class="nc" id="L313">                clickableTextsInfo = clickableTextsInfo</span>
        )
    }

<span class="nc" id="L317">    private fun buildEnterServerCredsMessageState(</span>
        onEnterServerCredsIconClicked: () -&gt; Unit,
<span class="nc" id="L319">        @DrawableRes iconResId: Int? = null,</span>
<span class="nc" id="L320">        @ColorRes iconColorResId: Int? = null,</span>
        threatsCount: Int,
        siteId: Long
    ): FootnoteState {
<span class="nc bnc" id="L324" title="All 2 branches missed.">        val messageResId = if (threatsCount &gt; 1) {</span>
<span class="nc" id="L325">            R.string.threat_fix_enter_server_creds_msg_plural</span>
        } else {
<span class="nc" id="L327">            R.string.threat_fix_enter_server_creds_msg_singular</span>
        }
<span class="nc" id="L329">        return FootnoteState(</span>
<span class="nc" id="L330">                iconResId = iconResId,</span>
<span class="nc" id="L331">                iconColorResId = iconColorResId,</span>
<span class="nc" id="L332">                text = UiStringText(</span>
<span class="nc" id="L333">                        htmlMessageUtils.getHtmlMessageFromStringFormatResId(</span>
<span class="nc" id="L334">                                messageResId,</span>
<span class="nc" id="L335">                                &quot;${Constants.URL_JETPACK_SETTINGS}/$siteId&quot;</span>
                        )
                ),
<span class="nc" id="L338">                onIconClick = onEnterServerCredsIconClicked</span>
        )
    }

    companion object {
        private const val ONE_MINUTE = 60 * 1000L
        private const val ONE_HOUR = 60 * ONE_MINUTE
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>