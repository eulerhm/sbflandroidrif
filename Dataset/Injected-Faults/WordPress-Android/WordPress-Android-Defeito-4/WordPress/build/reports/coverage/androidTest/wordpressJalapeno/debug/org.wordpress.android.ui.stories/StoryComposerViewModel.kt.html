<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StoryComposerViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.stories</a> &gt; <span class="el_source">StoryComposerViewModel.kt</span></div><h1>StoryComposerViewModel.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.stories

import android.net.Uri
import android.os.Bundle
import android.webkit.URLUtil
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.LifecycleOwner
import androidx.lifecycle.LifecycleRegistry
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.Observer
import androidx.lifecycle.ViewModel
import com.wordpress.stories.compose.frame.StorySaveEvents.StorySaveResult
import org.wordpress.android.viewmodel.SingleLiveEvent
import org.wordpress.android.WordPress
import org.wordpress.android.fluxc.Dispatcher
import org.wordpress.android.fluxc.generated.PostActionBuilder
import org.wordpress.android.fluxc.model.LocalOrRemoteId.LocalId
import org.wordpress.android.fluxc.model.PostImmutableModel
import org.wordpress.android.fluxc.model.SiteModel
import org.wordpress.android.push.NotificationType
import org.wordpress.android.ui.notifications.SystemNotificationsTracker
import org.wordpress.android.ui.posts.EditPostRepository
import org.wordpress.android.ui.posts.PostEditorAnalyticsSession
import org.wordpress.android.ui.posts.PostEditorAnalyticsSession.Outcome.CANCEL
import org.wordpress.android.ui.posts.PostEditorAnalyticsSession.Outcome.PUBLISH
import org.wordpress.android.ui.posts.PostEditorAnalyticsSession.Outcome.SAVE
import org.wordpress.android.ui.posts.PostEditorAnalyticsSessionWrapper
import org.wordpress.android.ui.posts.SavePostToDbUseCase
import org.wordpress.android.ui.stories.StoryComposerActivity.Companion.STATE_KEY_ORIGINAL_STORY_SAVE_RESULT
import org.wordpress.android.ui.stories.usecase.SetUntitledStoryTitleIfTitleEmptyUseCase
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.AppLog.T
import org.wordpress.android.util.helpers.MediaFile
import org.wordpress.android.viewmodel.Event
import javax.inject.Inject

<span class="nc" id="L38">class StoryComposerViewModel @Inject constructor(</span>
<span class="nc" id="L39">    private val systemNotificationsTracker: SystemNotificationsTracker,</span>
<span class="nc" id="L40">    private val saveInitialPostUseCase: SaveInitialPostUseCase,</span>
<span class="nc" id="L41">    private val savePostToDbUseCase: SavePostToDbUseCase,</span>
<span class="nc" id="L42">    private val setUntitledStoryTitleIfTitleEmptyUseCase: SetUntitledStoryTitleIfTitleEmptyUseCase,</span>
<span class="nc" id="L43">    private val postEditorAnalyticsSessionWrapper: PostEditorAnalyticsSessionWrapper,</span>
<span class="nc" id="L44">    private val dispatcher: Dispatcher</span>
<span class="nc" id="L45">) : ViewModel() {</span>
<span class="nc" id="L46">    private val lifecycleOwner = object : LifecycleOwner {</span>
<span class="nc" id="L47">        val lifecycleRegistry = LifecycleRegistry(this)</span>
<span class="nc" id="L48">        override fun getLifecycle(): Lifecycle = lifecycleRegistry</span>
    }

    private lateinit var editPostRepository: EditPostRepository
    private lateinit var site: SiteModel
    private var postEditorAnalyticsSession: PostEditorAnalyticsSession? = null
    private var originalIntentStorySaveResult: StorySaveResult? = null

<span class="nc" id="L56">    private val _mediaFilesUris = MutableLiveData&lt;List&lt;Uri&gt;&gt;()</span>
<span class="nc" id="L57">    val mediaFilesUris: LiveData&lt;List&lt;Uri&gt;&gt; = _mediaFilesUris</span>

<span class="nc" id="L59">    private val _openPrepublishingBottomSheet = SingleLiveEvent&lt;Event&lt;Unit&gt;&gt;()</span>
<span class="nc" id="L60">    val openPrepublishingBottomSheet = _openPrepublishingBottomSheet</span>

<span class="nc" id="L62">    private val _submitButtonClicked = SingleLiveEvent&lt;Event&lt;Unit&gt;&gt;()</span>
<span class="nc" id="L63">    val submitButtonClicked = _submitButtonClicked</span>

<span class="nc" id="L65">    init {</span>
<span class="nc" id="L66">        lifecycleOwner.lifecycleRegistry.currentState = Lifecycle.State.CREATED</span>
<span class="nc" id="L67">    }</span>

<span class="nc" id="L69">    private val _trackEditorCreatedPost = MutableLiveData&lt;Event&lt;Unit&gt;&gt;()</span>
<span class="nc" id="L70">    val trackEditorCreatedPost: LiveData&lt;Event&lt;Unit&gt;&gt; = _trackEditorCreatedPost</span>

    @Suppress(&quot;LongParameterList&quot;)
    fun start(
        site: SiteModel,
        editPostRepository: EditPostRepository,
        postId: LocalId,
        postEditorAnalyticsSession: PostEditorAnalyticsSession?,
        notificationType: NotificationType?,
        originalStorySaveResult: StorySaveResult?
    ): Boolean {
<span class="nc" id="L81">        this.editPostRepository = editPostRepository</span>
<span class="nc" id="L82">        this.site = site</span>
<span class="nc" id="L83">        this.originalIntentStorySaveResult = originalStorySaveResult</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">        notificationType?.let {</span>
<span class="nc" id="L86">            systemNotificationsTracker.trackTappedNotification(it)</span>
<span class="nc" id="L87">        }</span>

<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (postId.value == 0) {</span>
            // Create a new post
<span class="nc" id="L91">            saveInitialPostUseCase.saveInitialPost(editPostRepository, site)</span>
            // Bump post created analytics only once, first time the editor is opened
<span class="nc" id="L93">            _trackEditorCreatedPost.postValue(Event(Unit))</span>
        } else {
<span class="nc" id="L95">            editPostRepository.loadPostByLocalPostId(postId.value)</span>
        }

        // Ensure we have a valid post
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (!editPostRepository.hasPost()) {</span>
<span class="nc" id="L100">            AppLog.e(T.EDITOR, &quot;StoryComposerViewModel's EditPostRepository has no Post loaded: &quot; + postId.value)</span>
<span class="nc" id="L101">            return false</span>
        }

<span class="nc" id="L104">        setupPostEditorAnalyticsSession(postEditorAnalyticsSession)</span>

<span class="nc" id="L106">        lifecycleOwner.lifecycleRegistry.currentState = Lifecycle.State.STARTED</span>
<span class="nc" id="L107">        updateStoryPostWithChanges()</span>

<span class="nc" id="L109">        return true</span>
    }

    private fun setupPostEditorAnalyticsSession(postEditorAnalyticsSession: PostEditorAnalyticsSession?) {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        this.postEditorAnalyticsSession = postEditorAnalyticsSession ?: createPostEditorAnalyticsSessionTracker(</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                editPostRepository.getPost(),</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                site</span>
        )
<span class="nc" id="L117">    }</span>

    private fun createPostEditorAnalyticsSessionTracker(
        post: PostImmutableModel?,
        site: SiteModel?
    ): PostEditorAnalyticsSession {
<span class="nc" id="L123">        return postEditorAnalyticsSessionWrapper.getNewPostEditorAnalyticsSession(</span>
<span class="nc" id="L124">                PostEditorAnalyticsSession.Editor.WP_STORIES_CREATOR,</span>
<span class="nc" id="L125">                post, site, true</span>
        )
    }

    fun onStoryComposerStartAnalyticsSession() {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        this.postEditorAnalyticsSession?.start(null, null, null)</span>
<span class="nc" id="L131">    }</span>

    fun onStoryComposerAnalyticsSessionStartTimeReset() {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        this.postEditorAnalyticsSession?.resetStartTime()</span>
<span class="nc" id="L135">    }</span>

    fun writeToBundle(outState: Bundle) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        outState.putSerializable(WordPress.SITE, site)</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        outState.putInt(StoryComposerActivity.STATE_KEY_POST_LOCAL_ID, editPostRepository.id)</span>
<span class="nc" id="L140">        outState.putSerializable(StoryComposerActivity.STATE_KEY_EDITOR_SESSION_DATA, postEditorAnalyticsSession)</span>
<span class="nc" id="L141">        outState.putParcelable(STATE_KEY_ORIGINAL_STORY_SAVE_RESULT, originalIntentStorySaveResult)</span>
<span class="nc" id="L142">    }</span>

    fun onStorySaved() {
<span class="nc bnc" id="L145" title="All 2 branches missed.">        postEditorAnalyticsSession?.setOutcome(SAVE)</span>
<span class="nc" id="L146">    }</span>

    // returns true if user is discarding a Story out of a save retry (error handling state)
    // returns false otherwise
    fun onStoryDiscarded(deleteDiscardedPost: Boolean): Boolean {
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (deleteDiscardedPost) {</span>
            // delete empty post from database
<span class="nc bnc" id="L153" title="All 2 branches missed.">            dispatcher.dispatch(PostActionBuilder.newRemovePostAction(editPostRepository.getEditablePost()))</span>
        }
<span class="nc bnc" id="L155" title="All 2 branches missed.">        postEditorAnalyticsSession?.setOutcome(CANCEL)</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">        originalIntentStorySaveResult?.let {</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">            return (!it.isSuccess() || it.isRetry)</span>
<span class="nc" id="L159">        } ?: return false</span>
    }

    private fun updateStoryPostWithChanges() {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        editPostRepository.postChanged.observe(lifecycleOwner, Observer {</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">            savePostToDbUseCase.savePostToDb(editPostRepository, site)</span>
<span class="nc" id="L165">        })</span>
<span class="nc" id="L166">    }</span>

    fun appendMediaFiles(mediaFiles: Map&lt;String, MediaFile&gt;) {
<span class="nc" id="L169">        val uriList = ArrayList&lt;Uri&gt;()</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        for ((key) in mediaFiles.entries) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            val url = if (URLUtil.isNetworkUrl(key)) {</span>
<span class="nc" id="L172">                key</span>
            } else {
<span class="nc" id="L174">                &quot;file://$key&quot;</span>
            }
<span class="nc" id="L176">            uriList.add(Uri.parse(url))</span>
        }

<span class="nc" id="L179">        _mediaFilesUris.postValue(uriList)</span>
<span class="nc" id="L180">    }</span>

    fun onStorySaveButtonPressed() {
<span class="nc" id="L183">        _openPrepublishingBottomSheet.postValue(Event(Unit))</span>
<span class="nc" id="L184">    }</span>

    fun onSubmitButtonClicked() {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        setUntitledStoryTitleIfTitleEmptyUseCase.setUntitledStoryTitleIfTitleEmpty(editPostRepository)</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        postEditorAnalyticsSession?.setOutcome(PUBLISH)</span>
<span class="nc" id="L189">        _submitButtonClicked.postValue(Event(Unit))</span>
<span class="nc" id="L190">    }</span>

    override fun onCleared() {
<span class="nc" id="L193">        super.onCleared()</span>
<span class="nc" id="L194">        lifecycleOwner.lifecycleRegistry.currentState = Lifecycle.State.DESTROYED</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        postEditorAnalyticsSession?.end()</span>
<span class="nc" id="L196">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>