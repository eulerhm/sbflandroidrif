<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PublicizeListActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.publicize</a> &gt; <span class="el_source">PublicizeListActivity.java</span></div><h1>PublicizeListActivity.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.publicize;

import android.app.ProgressDialog;
import android.os.Bundle;
import android.view.MenuItem;

import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.DialogFragment;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentTransaction;

import com.google.android.material.appbar.AppBarLayout;
import com.google.android.material.dialog.MaterialAlertDialogBuilder;

import org.greenrobot.eventbus.EventBus;
import org.greenrobot.eventbus.Subscribe;
import org.greenrobot.eventbus.ThreadMode;
import org.jetbrains.annotations.NotNull;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.analytics.AnalyticsTracker.Stat;
import org.wordpress.android.datasets.PublicizeTable;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.models.PublicizeConnection;
import org.wordpress.android.models.PublicizeService;
import org.wordpress.android.ui.ActivityLauncher;
import org.wordpress.android.ui.LocaleAwareActivity;
import org.wordpress.android.ui.ScrollableViewInitializedListener;
import org.wordpress.android.ui.publicize.PublicizeConstants.ConnectAction;
import org.wordpress.android.ui.publicize.adapters.PublicizeServiceAdapter;
import org.wordpress.android.ui.publicize.services.PublicizeUpdateService;
import org.wordpress.android.util.extensions.AppBarLayoutExtensionsKt;
import org.wordpress.android.util.SiteUtils;
import org.wordpress.android.util.ToastUtils;
import org.wordpress.android.util.analytics.AnalyticsUtils;

import java.util.HashMap;
import java.util.Map;

import javax.inject.Inject;

<span class="nc" id="L46">public class PublicizeListActivity extends LocaleAwareActivity</span>
        implements
        PublicizeActions.OnPublicizeActionListener,
        PublicizeServiceAdapter.OnServiceClickListener,
        PublicizeListFragment.PublicizeButtonPrefsListener, ScrollableViewInitializedListener {
    private static final String WPCOM_CONNECTIONS_URL = &quot;https://wordpress.com/marketing/connections/&quot;;

    private SiteModel mSite;
    private ProgressDialog mProgressDialog;
    private AppBarLayout mAppBarLayout;

    @Inject SiteStore mSiteStore;

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L61">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L62">        ((WordPress) getApplication()).component().inject(this);</span>

<span class="nc" id="L64">        setContentView(R.layout.publicize_list_activity);</span>

<span class="nc" id="L66">        Toolbar toolbar = findViewById(R.id.toolbar_main);</span>
<span class="nc" id="L67">        setSupportActionBar(toolbar);</span>

<span class="nc" id="L69">        ActionBar actionBar = getSupportActionBar();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L71">            actionBar.setDisplayShowTitleEnabled(true);</span>
<span class="nc" id="L72">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
        }

<span class="nc" id="L75">        mAppBarLayout = findViewById(R.id.appbar_main);</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L78">            mSite = (SiteModel) getIntent().getSerializableExtra(WordPress.SITE);</span>
<span class="nc" id="L79">            PublicizeTable.createTables(WordPress.wpDB.getDatabase());</span>
<span class="nc" id="L80">            showListFragment();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            if (mSite == null) {</span>
<span class="nc" id="L82">                ToastUtils.showToast(this, R.string.blog_not_found, ToastUtils.Duration.SHORT);</span>
<span class="nc" id="L83">                finish();</span>
<span class="nc" id="L84">                return;</span>
            }
<span class="nc" id="L86">            PublicizeUpdateService.updateConnectionsForSite(this, mSite);</span>
        } else {
<span class="nc" id="L88">            mSite = (SiteModel) savedInstanceState.getSerializable(WordPress.SITE);</span>
        }
<span class="nc" id="L90">    }</span>

    @Override
    protected void onSaveInstanceState(@NotNull Bundle outState) {
<span class="nc" id="L94">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L95">        outState.putSerializable(WordPress.SITE, mSite);</span>
<span class="nc" id="L96">    }</span>

    @Override
    protected void onPause() {
<span class="nc" id="L100">        super.onPause();</span>
<span class="nc" id="L101">        EventBus.getDefault().unregister(this);</span>
<span class="nc" id="L102">    }</span>

    @Override
    protected void onResume() {
<span class="nc" id="L106">        super.onResume();</span>
<span class="nc" id="L107">        EventBus.getDefault().register(this);</span>
<span class="nc" id="L108">    }</span>

    private void showListFragment() {
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L112">            return;</span>
        }

<span class="nc" id="L115">        String tag = getString(R.string.fragment_tag_publicize_list);</span>
<span class="nc" id="L116">        Fragment fragment = PublicizeListFragment.newInstance(mSite);</span>
<span class="nc" id="L117">        getSupportFragmentManager()</span>
<span class="nc" id="L118">                .beginTransaction()</span>
<span class="nc" id="L119">                .replace(R.id.fragment_container, fragment, tag)</span>
<span class="nc" id="L120">                .commit();</span>
<span class="nc" id="L121">    }</span>

    private PublicizeListFragment getListFragment() {
<span class="nc" id="L124">        String tag = getString(R.string.fragment_tag_publicize_list);</span>
<span class="nc" id="L125">        Fragment fragment = getSupportFragmentManager().findFragmentByTag(tag);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (fragment != null) {</span>
<span class="nc" id="L127">            return (PublicizeListFragment) fragment;</span>
        } else {
<span class="nc" id="L129">            return null;</span>
        }
    }

    private void reloadListFragment() {
<span class="nc" id="L134">        PublicizeListFragment listFragment = getListFragment();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (listFragment != null) {</span>
<span class="nc" id="L136">            listFragment.reload();</span>
        }
<span class="nc" id="L138">    }</span>

    /*
     * close all but the first (list) fragment
     */
    private void returnToListFragment() {
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (getSupportFragmentManager().getBackStackEntryCount() == 0) {</span>
<span class="nc" id="L145">            return;</span>
        }

<span class="nc" id="L148">        String tag = getString(R.string.fragment_tag_publicize_detail);</span>
<span class="nc" id="L149">        getSupportFragmentManager().popBackStack(tag, FragmentManager.POP_BACK_STACK_INCLUSIVE);</span>
<span class="nc" id="L150">    }</span>

    private void showDetailFragment(PublicizeService service) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L154">            return;</span>
        }

<span class="nc" id="L157">        String tag = getString(R.string.fragment_tag_publicize_detail);</span>
<span class="nc" id="L158">        Fragment detailFragment = PublicizeDetailFragment.newInstance(mSite, service);</span>
<span class="nc" id="L159">        getSupportFragmentManager()</span>
<span class="nc" id="L160">                .beginTransaction()</span>
<span class="nc" id="L161">                .replace(R.id.fragment_container, detailFragment, tag)</span>
<span class="nc" id="L162">                .setTransition(FragmentTransaction.TRANSIT_FRAGMENT_OPEN)</span>
<span class="nc" id="L163">                .addToBackStack(tag)</span>
<span class="nc" id="L164">                .commit();</span>
<span class="nc" id="L165">    }</span>

    private PublicizeDetailFragment getDetailFragment() {
<span class="nc" id="L168">        String tag = getString(R.string.fragment_tag_publicize_detail);</span>
<span class="nc" id="L169">        Fragment fragment = getSupportFragmentManager().findFragmentByTag(tag);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (fragment != null) {</span>
<span class="nc" id="L171">            return (PublicizeDetailFragment) fragment;</span>
        } else {
<span class="nc" id="L173">            return null;</span>
        }
    }

    private void reloadDetailFragment() {
<span class="nc" id="L178">        PublicizeDetailFragment detailFragment = getDetailFragment();</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (detailFragment != null) {</span>
<span class="nc" id="L180">            detailFragment.loadData();</span>
        }
<span class="nc" id="L182">    }</span>

    private void showWebViewFragment(PublicizeService service, PublicizeConnection publicizeConnection) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L186">            return;</span>
        }

<span class="nc" id="L189">        String tag = getString(R.string.fragment_tag_publicize_webview);</span>
<span class="nc" id="L190">        Fragment webViewFragment = PublicizeWebViewFragment.newInstance(mSite, service, publicizeConnection);</span>
<span class="nc" id="L191">        getSupportFragmentManager()</span>
<span class="nc" id="L192">                .beginTransaction()</span>
<span class="nc" id="L193">                .replace(R.id.fragment_container, webViewFragment, tag)</span>
<span class="nc" id="L194">                .setTransition(FragmentTransaction.TRANSIT_FRAGMENT_OPEN)</span>
<span class="nc" id="L195">                .addToBackStack(tag)</span>
<span class="nc" id="L196">                .commit();</span>
<span class="nc" id="L197">    }</span>

    private void closeWebViewFragment() {
<span class="nc" id="L200">        String tag = getString(R.string.fragment_tag_publicize_webview);</span>
<span class="nc" id="L201">        getSupportFragmentManager().popBackStack(tag, FragmentManager.POP_BACK_STACK_INCLUSIVE);</span>
<span class="nc" id="L202">    }</span>

    @Override
    public boolean onOptionsItemSelected(final MenuItem item) {
<span class="nc" id="L206">        int itemId = item.getItemId();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (itemId == android.R.id.home) {</span>
<span class="nc" id="L208">            onBackPressed();</span>
<span class="nc" id="L209">            return true;</span>
        }
<span class="nc" id="L211">        return super.onOptionsItemSelected(item);</span>
    }

    @Override
    public void onBackPressed() {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (getSupportFragmentManager().getBackStackEntryCount() &gt; 0) {</span>
<span class="nc" id="L217">            getSupportFragmentManager().popBackStack();</span>
        } else {
<span class="nc" id="L219">            super.onBackPressed();</span>
        }
<span class="nc" id="L221">    }</span>

    /*
     * user tapped a service in the list fragment
     */
    @Override
    public void onServiceClicked(PublicizeService service) {
<span class="nc" id="L228">        showDetailFragment(service);</span>
<span class="nc" id="L229">    }</span>

    /*
     * user requested to connect to a service from the detail fragment
     */
    @Override
    public void onRequestConnect(PublicizeService service) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (isFacebook(service)) {</span>
<span class="nc" id="L237">            showFacebookWarning();</span>
        } else {
<span class="nc" id="L239">            showWebViewFragment(service, null);</span>
        }
<span class="nc" id="L241">    }</span>

    /*
     * user requested to reconnect a broken publicizeConnection from the detail fragment
     */
    @Override
    public void onRequestReconnect(PublicizeService service, PublicizeConnection publicizeConnection) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (isFacebook(service)) {</span>
<span class="nc" id="L249">            showFacebookWarning();</span>
        } else {
<span class="nc" id="L251">            PublicizeActions.reconnect(publicizeConnection);</span>
<span class="nc" id="L252">            showWebViewFragment(service, null);</span>
        }
<span class="nc" id="L254">    }</span>

    /*
     * user requested to disconnect a service publicizeConnection from the detail fragment
     */
    @Override
    public void onRequestDisconnect(PublicizeConnection publicizeConnection) {
<span class="nc" id="L261">        confirmDisconnect(publicizeConnection);</span>
<span class="nc" id="L262">    }</span>

    private boolean isFacebook(PublicizeService service) {
<span class="nc" id="L265">        return service.getId().equals(PublicizeConstants.FACEBOOK_ID);</span>
    }

    private String getConnectionsUrl(SiteModel site) {
<span class="nc" id="L269">        return WPCOM_CONNECTIONS_URL + SiteUtils.getHomeURLOrHostName(site);</span>
    }

    /*
     * As of Oct 5, 2021 Facebook has deprecated support for authentication on embedded browsers, so Publicize
     * connections can't be established through web views anymore (ref: pbArwn-3uU-p2).
     * This method shows a temporary warning message to the user instead.
     */
    private void showFacebookWarning() {
<span class="nc" id="L278">        new MaterialAlertDialogBuilder(this)</span>
<span class="nc" id="L279">                .setMessage(R.string.sharing_facebook_warning_message)</span>
<span class="nc" id="L280">                .setPositiveButton(R.string.sharing_facebook_warning_positive_button,</span>
<span class="nc" id="L281">                        (dialog, id) -&gt; ActivityLauncher.openUrlExternal(this, getConnectionsUrl(mSite)))</span>
<span class="nc" id="L282">                .setNegativeButton(R.string.cancel, null)</span>
<span class="nc" id="L283">                .setCancelable(true)</span>
<span class="nc" id="L284">                .create()</span>
<span class="nc" id="L285">                .show();</span>
<span class="nc" id="L286">    }</span>

    private void confirmDisconnect(final PublicizeConnection publicizeConnection) {
<span class="nc" id="L289">        AlertDialog.Builder builder = new MaterialAlertDialogBuilder(this);</span>
<span class="nc" id="L290">        builder.setMessage(</span>
<span class="nc" id="L291">                String.format(getString(R.string.dlg_confirm_publicize_disconnect), publicizeConnection.getLabel()));</span>
<span class="nc" id="L292">        builder.setTitle(R.string.share_btn_disconnect);</span>
<span class="nc" id="L293">        builder.setCancelable(true);</span>
<span class="nc" id="L294">        builder.setPositiveButton(R.string.share_btn_disconnect, (dialog, id) -&gt; {</span>
<span class="nc" id="L295">            PublicizeActions.disconnect(publicizeConnection);</span>
            // if the user disconnected from G+, return to the list fragment since the
            // detail fragment would give them the ability to reconnect
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (publicizeConnection.getService().equals(PublicizeConstants.GOOGLE_PLUS_ID)) {</span>
<span class="nc" id="L299">                returnToListFragment();</span>
            } else {
<span class="nc" id="L301">                reloadDetailFragment();</span>
            }
<span class="nc" id="L303">        });</span>
<span class="nc" id="L304">        builder.setNegativeButton(R.string.cancel, null);</span>
<span class="nc" id="L305">        AlertDialog alert = builder.create();</span>
<span class="nc" id="L306">        alert.show();</span>
<span class="nc" id="L307">    }</span>

    /*
     * list of available services or list of connections has changed
     */
    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(PublicizeEvents.ConnectionsChanged event) {
<span class="nc" id="L315">        reloadListFragment();</span>
<span class="nc" id="L316">    }</span>

    /*
     * request from fragment to connect/disconnect/reconnect completed
     */
    @SuppressWarnings(&quot;unused&quot;)
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(PublicizeEvents.ActionCompleted event) {
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L325">            return;</span>
        }

<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (event.getAction() != ConnectAction.RECONNECT) {</span>
<span class="nc" id="L329">            closeWebViewFragment();</span>
<span class="nc bnc" id="L330" title="All 4 branches missed.">            if (mProgressDialog != null &amp;&amp; mProgressDialog.isShowing()) {</span>
<span class="nc" id="L331">                mProgressDialog.dismiss();</span>
            }
<span class="nc" id="L333">            reloadDetailFragment();</span>
        }

<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (event.didSucceed()) {</span>
<span class="nc" id="L337">            Map&lt;String, Object&gt; analyticsProperties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L338">            analyticsProperties.put(&quot;service&quot;, event.getService());</span>


<span class="nc bnc" id="L341" title="All 2 branches missed.">            if (event.getAction() == ConnectAction.CONNECT) {</span>
<span class="nc" id="L342">                AnalyticsUtils.trackWithSiteDetails(Stat.PUBLICIZE_SERVICE_CONNECTED, mSite, analyticsProperties);</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            } else if (event.getAction() == ConnectAction.DISCONNECT) {</span>
<span class="nc" id="L344">                AnalyticsUtils.trackWithSiteDetails(Stat.PUBLICIZE_SERVICE_DISCONNECTED, mSite, analyticsProperties);</span>
            }
<span class="nc" id="L346">        } else {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (event.getReasonResId() != null) {</span>
<span class="nc" id="L348">                DialogFragment fragment = PublicizeErrorDialogFragment.newInstance(event.getReasonResId());</span>
<span class="nc" id="L349">                fragment.show(getSupportFragmentManager(), PublicizeErrorDialogFragment.TAG);</span>
<span class="nc" id="L350">            } else {</span>
<span class="nc" id="L351">                ToastUtils.showToast(this, R.string.error_generic);</span>
            }
        }
<span class="nc" id="L354">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(PublicizeEvents.ActionAccountChosen event) {
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L359">            return;</span>
        }

<span class="nc" id="L362">        PublicizeActions.connectStepTwo(event.getSiteId(), event.getKeychainId(),</span>
<span class="nc" id="L363">                event.getService(), event.getExternalUserId());</span>
<span class="nc" id="L364">        mProgressDialog = new ProgressDialog(this);</span>
<span class="nc" id="L365">        mProgressDialog.setMessage(getString(R.string.connecting_account));</span>
<span class="nc" id="L366">        mProgressDialog.show();</span>
<span class="nc" id="L367">    }</span>

    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEventMainThread(PublicizeEvents.ActionRequestChooseAccount event) {
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (isFinishing()) {</span>
<span class="nc" id="L372">            return;</span>
        }

<span class="nc" id="L375">        closeWebViewFragment();</span>

<span class="nc" id="L377">        SiteModel site = mSiteStore.getSiteBySiteId(event.getSiteId());</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (site == null) {</span>
<span class="nc" id="L379">            ToastUtils.showToast(this, R.string.blog_not_found, ToastUtils.Duration.SHORT);</span>
<span class="nc" id="L380">            return;</span>
        }

<span class="nc" id="L383">        PublicizeAccountChooserDialogFragment dialogFragment = new PublicizeAccountChooserDialogFragment();</span>
<span class="nc" id="L384">        Bundle args = new Bundle();</span>
<span class="nc" id="L385">        args.putString(PublicizeConstants.ARG_CONNECTION_ARRAY_JSON, event.getJSONObject().toString());</span>
<span class="nc" id="L386">        args.putSerializable(WordPress.SITE, site);</span>
<span class="nc" id="L387">        args.putString(PublicizeConstants.ARG_SERVICE_ID, event.getServiceId());</span>
<span class="nc" id="L388">        dialogFragment.setArguments(args);</span>
<span class="nc" id="L389">        dialogFragment.show(getSupportFragmentManager(), PublicizeAccountChooserDialogFragment.TAG);</span>
<span class="nc" id="L390">    }</span>

    @Override
    public void onButtonPrefsClicked() {
<span class="nc" id="L394">        AnalyticsUtils.trackWithSiteDetails(Stat.OPENED_SHARING_BUTTON_MANAGEMENT, mSite);</span>
<span class="nc" id="L395">        Fragment fragment = PublicizeButtonPrefsFragment.newInstance(mSite);</span>
<span class="nc" id="L396">        getSupportFragmentManager().beginTransaction()</span>
<span class="nc" id="L397">                                   .replace(R.id.fragment_container, fragment)</span>
<span class="nc" id="L398">                                   .addToBackStack(null)</span>
<span class="nc" id="L399">                                   .setTransition(FragmentTransaction.TRANSIT_FRAGMENT_FADE)</span>
<span class="nc" id="L400">                                   .commit();</span>
<span class="nc" id="L401">    }</span>

    @Override
    public void onScrollableViewInitialized(int containerId) {
<span class="nc" id="L405">        AppBarLayoutExtensionsKt.setLiftOnScrollTargetViewIdAndRequestLayout(mAppBarLayout, containerId);</span>
<span class="nc" id="L406">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>