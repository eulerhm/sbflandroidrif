<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrefMainSwitchToolbarView.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.prefs.notifications</a> &gt; <span class="el_source">PrefMainSwitchToolbarView.kt</span></div><h1>PrefMainSwitchToolbarView.kt</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.prefs.notifications

import android.content.Context
import android.util.AttributeSet
import android.view.View
import android.view.View.OnClickListener
import android.view.View.OnLongClickListener
import android.widget.CompoundButton
import android.widget.CompoundButton.OnCheckedChangeListener
import android.widget.LinearLayout
import android.widget.TextView
import android.widget.Toast
import androidx.annotation.AttrRes
import androidx.annotation.ColorInt
import androidx.appcompat.widget.SwitchCompat
import androidx.appcompat.widget.Toolbar
import androidx.core.view.ViewCompat
import org.wordpress.android.BuildConfig
import org.wordpress.android.R
import org.wordpress.android.util.AppLog
import org.wordpress.android.util.extensions.getColorFromAttribute
import org.wordpress.android.util.extensions.redirectContextClickToLongPressListener

/**
 * Custom view for main switch in toolbar for preferences.
 */
<span class="nc" id="L27">class PrefMainSwitchToolbarView @JvmOverloads constructor(</span>
    context: Context,
<span class="nc" id="L29">    attrs: AttributeSet? = null,</span>
<span class="nc" id="L30">    defStyle: Int = 0,</span>
<span class="nc" id="L31">    defStyleRes: Int = 0</span>
<span class="nc" id="L32">) : LinearLayout(context, attrs, defStyle, defStyleRes),</span>
        OnCheckedChangeListener,
        OnLongClickListener,
        OnClickListener {
    // We should refactor this part to use style attributes, since enum is not too theming friendly
<span class="nc" id="L37">    enum class PrefMainSwitchToolbarViewStyle constructor(</span>
<span class="nc" id="L38">        val value: Int,</span>
<span class="nc" id="L39">        @AttrRes val titleColorResId: Int,</span>
<span class="nc" id="L40">        @AttrRes val backgroundColorResId: Int</span>
    ) {
<span class="nc" id="L42">        HIGHLIGHTED(</span>
<span class="nc" id="L43">                0,</span>
<span class="nc" id="L44">                R.attr.colorOnPrimary,</span>
<span class="nc" id="L45">                R.attr.colorPrimary</span>
        ),
<span class="nc" id="L47">        NORMAL(</span>
<span class="nc" id="L48">                1,</span>
<span class="nc" id="L49">                R.attr.colorOnSurface,</span>
<span class="nc" id="L50">                R.attr.colorSurface</span>
        );

        companion object {
            fun fromInt(value: Int): PrefMainSwitchToolbarViewStyle? =
<span class="nc bnc" id="L55" title="All 4 branches missed.">                    values().firstOrNull { it.value == value }</span>
        }
    }

    private var hintOn: String? = null
    private var hintOff: String? = null
    private var mainSwitch: SwitchCompat
    private var mainSwitchToolbarListener: MainSwitchToolbarListener? = null
    private var toolbarSwitch: Toolbar
    private var titleOff: String? = null
    private var titleOn: String? = null
    private var viewStyle: PrefMainSwitchToolbarViewStyle? = null
    private var titleContentDescription: String? = null

    val isMainChecked: Boolean
<span class="nc" id="L70">        get() = mainSwitch.isChecked</span>

    /**
     * Interface definition for callbacks to be invoked on interaction with main switch toolbar.
     */
    interface MainSwitchToolbarListener {
        /**
         * Called when the checked state of main switch is changed.
         *
         * @param buttonView The main switch whose state has changed.
         * @param isChecked The new checked state of main switch.
         */
        fun onMainSwitchCheckedChanged(buttonView: CompoundButton?, isChecked: Boolean)
    }

<span class="nc" id="L85">    init {</span>
<span class="nc" id="L86">        inflate(context, R.layout.preferences_main_switch_toolbar, this)</span>

<span class="nc" id="L88">        toolbarSwitch = findViewById(R.id.toolbar_with_switch)</span>
<span class="nc" id="L89">        toolbarSwitch.inflateMenu(R.menu.notifications_settings_secondary)</span>

<span class="nc" id="L91">        val menuItem = toolbarSwitch.menu.findItem(R.id.main_switch)</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        mainSwitch = menuItem.actionView as SwitchCompat</span>
<span class="nc" id="L93">        setChecked(true)</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">        attrs?.let {</span>
<span class="nc" id="L96">            val typedArray = context.obtainStyledAttributes(</span>
<span class="nc" id="L97">                    it,</span>
<span class="nc" id="L98">                    R.styleable.PrefMainSwitchToolbarView, 0, 0</span>
            )
<span class="nc" id="L100">            try {</span>
<span class="nc" id="L101">                titleContentDescription = typedArray</span>
<span class="nc" id="L102">                        .getString(R.styleable.PrefMainSwitchToolbarView_mainContentDescription)</span>

<span class="nc" id="L104">                val titleOn = typedArray.getString(R.styleable.PrefMainSwitchToolbarView_mainTitleOn)</span>
<span class="nc" id="L105">                val titleOff = typedArray.getString(R.styleable.PrefMainSwitchToolbarView_mainTitleOff)</span>
<span class="nc" id="L106">                val hintOn = typedArray.getString(R.styleable.PrefMainSwitchToolbarView_mainHintOn)</span>
<span class="nc" id="L107">                val hintOff = typedArray.getString(R.styleable.PrefMainSwitchToolbarView_mainHintOff)</span>

<span class="nc" id="L109">                val contentInsetStart = resources.getDimensionPixelSize(</span>
<span class="nc" id="L110">                        typedArray.getResourceId(</span>
<span class="nc" id="L111">                                R.styleable.PrefMainSwitchToolbarView_mainContentInsetStart,</span>
<span class="nc" id="L112">                                R.dimen.toolbar_content_offset</span>
                        )
                )
<span class="nc" id="L115">                val offsetEndResId = typedArray.getResourceId(R.styleable.PrefMainSwitchToolbarView_mainOffsetEnd, -1)</span>
<span class="nc" id="L116">                var offsetEnd = -1</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (offsetEndResId != -1) {</span>
<span class="nc" id="L118">                    offsetEnd = resources.getDimensionPixelSize(offsetEndResId)</span>
                }
<span class="nc" id="L120">                val viewStyle = typedArray.getInt(R.styleable.PrefMainSwitchToolbarView_mainViewStyle, -1)</span>

<span class="nc" id="L122">                setTitleOn(titleOn)</span>
<span class="nc" id="L123">                setTitleOff(titleOff)</span>
<span class="nc" id="L124">                setHintOn(hintOn)</span>
<span class="nc" id="L125">                setHintOff(hintOff)</span>
<span class="nc" id="L126">                setContentOffset(contentInsetStart)</span>
<span class="nc" id="L127">                setOffsetEnd(offsetEnd)</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (viewStyle != -1) {</span>
<span class="nc" id="L130">                    setViewStyle(viewStyle)</span>
                }
            } finally {
<span class="nc" id="L133">                typedArray.recycle()</span>
            }
<span class="nc" id="L135">        }</span>

<span class="nc" id="L137">        mainSwitch.setOnCheckedChangeListener(this)</span>
<span class="nc" id="L138">        toolbarSwitch.setOnLongClickListener(this)</span>
<span class="nc" id="L139">        toolbarSwitch.setOnClickListener(this)</span>

<span class="nc" id="L141">        ViewCompat.setLabelFor(toolbarSwitch, mainSwitch.id)</span>
<span class="nc" id="L142">        setupFocusabilityForTalkBack()</span>
<span class="nc" id="L143">        toolbarSwitch.redirectContextClickToLongPressListener()</span>
<span class="nc" id="L144">    }</span>

    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun updateToolbarSwitchForAccessibility() {
<span class="nc bnc" id="L148" title="All 2 branches missed.">        titleContentDescription?.let {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">            for (i in 0 until toolbarSwitch.childCount) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                if (toolbarSwitch.getChildAt(i) is TextView) {</span>
<span class="nc" id="L151">                    toolbarSwitch.getChildAt(i).contentDescription = titleContentDescription</span>
                }
            }
<span class="nc" id="L154">        }</span>
<span class="nc" id="L155">    }</span>

    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun setContentOffset(offset: Int) {
<span class="nc" id="L159">        toolbarSwitch.setContentInsetsAbsolute(offset, 0)</span>
<span class="nc" id="L160">    }</span>

    /**
     * Applies end padding to the switch menu
     */
    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun setOffsetEnd(offsetEnd: Int) {
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (offsetEnd != -1) {</span>
<span class="nc" id="L168">            mainSwitch.setPaddingRelative(</span>
<span class="nc" id="L169">                    mainSwitch.left,</span>
<span class="nc" id="L170">                    mainSwitch.top,</span>
<span class="nc" id="L171">                    offsetEnd,</span>
<span class="nc" id="L172">                    mainSwitch.bottom</span>
            )
        }
<span class="nc" id="L175">    }</span>

    private fun setupFocusabilityForTalkBack() {
<span class="nc" id="L178">        mainSwitch.isFocusable = false</span>
<span class="nc" id="L179">        mainSwitch.isClickable = false</span>
<span class="nc" id="L180">        toolbarSwitch.isFocusableInTouchMode = false</span>
<span class="nc" id="L181">        toolbarSwitch.isFocusable = true</span>
<span class="nc" id="L182">        toolbarSwitch.isClickable = true</span>
<span class="nc" id="L183">    }</span>

    /**
     * Loads initial state of the main switch and toolbar
     */
    fun loadInitialState(checkMain: Boolean) {
<span class="nc" id="L189">        setChecked(checkMain)</span>
<span class="nc" id="L190">        setToolbarTitle(checkMain)</span>
<span class="nc" id="L191">        toolbarSwitch.visibility = View.VISIBLE</span>
<span class="nc" id="L192">        updateToolbarSwitchForAccessibility()</span>
<span class="nc" id="L193">    }</span>

    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun setTitleOn(titleOn: String?) {
<span class="nc bnc" id="L197" title="All 2 branches missed.">        this.titleOn = titleOn ?: resources.getString(R.string.main_switch_default_title_on)</span>
<span class="nc" id="L198">    }</span>

    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun setTitleOff(titleOff: String?) {
<span class="nc bnc" id="L202" title="All 2 branches missed.">        this.titleOff = titleOff ?: resources.getString(R.string.main_switch_default_title_off)</span>
<span class="nc" id="L203">    }</span>

    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun setHintOn(hintOn: String?) {
<span class="nc" id="L207">        this.hintOn = hintOn</span>
<span class="nc" id="L208">    }</span>

    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun setHintOff(hintOff: String?) {
<span class="nc" id="L212">        this.hintOff = hintOff</span>
<span class="nc" id="L213">    }</span>

    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun setViewStyle(viewStyleInt: Int) {
<span class="nc bnc" id="L217" title="All 6 branches missed.">        if (viewStyleInt == this.viewStyle?.value) {</span>
<span class="nc" id="L218">            return</span>
        }
<span class="nc" id="L220">        val nullableType = PrefMainSwitchToolbarViewStyle.fromInt(viewStyleInt)</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">        nullableType?.let {</span>
<span class="nc" id="L222">            updateViewStyle(nullableType)</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        } ?: if (BuildConfig.DEBUG) {</span>
<span class="nc" id="L224">            throw IllegalStateException(&quot;Unknown view style id: $viewStyleInt&quot;)</span>
        } else {
<span class="nc" id="L226">            AppLog.e(</span>
<span class="nc" id="L227">                    AppLog.T.SETTINGS,</span>
<span class="nc" id="L228">                    &quot;PrefMainSwitchToolbarView.setViewStyle called from xml with an unknown viewStyle.&quot;</span>
            )
        }
<span class="nc" id="L231">    }</span>

    @Suppress(&quot;MemberVisibilityCanBePrivate&quot;)
    fun updateViewStyle(viewStyle: PrefMainSwitchToolbarViewStyle) {
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (viewStyle == this.viewStyle) {</span>
<span class="nc" id="L236">            return</span>
        }
<span class="nc" id="L238">        this.viewStyle = viewStyle</span>
<span class="nc" id="L239">        loadResourcesForViewStyle(viewStyle)</span>
<span class="nc" id="L240">    }</span>

    private fun loadResourcesForViewStyle(viewStyle: PrefMainSwitchToolbarViewStyle) {
<span class="nc" id="L243">        val titleColor = context.getColorFromAttribute(viewStyle.titleColorResId)</span>
<span class="nc" id="L244">        val backgroundColor = context.getColorFromAttribute(viewStyle.backgroundColorResId)</span>

<span class="nc" id="L246">        toolbarSwitch.setTitleTextColor(titleColor)</span>
<span class="nc" id="L247">        toolbarSwitch.setBackgroundColor(backgroundColor)</span>
<span class="nc" id="L248">    }</span>

    override fun setBackgroundColor(@ColorInt color: Int) {
<span class="nc" id="L251">        toolbarSwitch.setBackgroundColor(color)</span>
<span class="nc" id="L252">    }</span>

    /*
     * User long clicked the toolbar
     */
    override fun onLongClick(v: View?): Boolean {
<span class="nc bnc" id="L258" title="All 2 branches missed.">        val toastText = if (mainSwitch.isChecked) {</span>
<span class="nc" id="L259">            hintOn</span>
        } else {
<span class="nc" id="L261">            hintOff</span>
        }

<span class="nc bnc" id="L264" title="All 8 branches missed.">        if (toastText?.isNotEmpty() == true) {</span>
<span class="nc" id="L265">            Toast.makeText(</span>
<span class="nc" id="L266">                    context,</span>
<span class="nc" id="L267">                    toastText,</span>
<span class="nc" id="L268">                    Toast.LENGTH_SHORT</span>
<span class="nc" id="L269">            ).show()</span>
        }
<span class="nc" id="L271">        return true</span>
    }

    /*
    * User clicked the toolbar
    */
    override fun onClick(v: View?) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">        setChecked(!mainSwitch.isChecked)</span>
<span class="nc" id="L279">    }</span>

    fun setChecked(isChecked: Boolean) {
<span class="nc" id="L282">        mainSwitch.isChecked = isChecked</span>
<span class="nc" id="L283">    }</span>

    private fun setToolbarTitle(checkMain: Boolean) {
<span class="nc bnc" id="L286" title="All 2 branches missed.">        toolbarSwitch.title = if (checkMain) {</span>
<span class="nc" id="L287">            titleOn</span>
        } else {
<span class="nc" id="L289">            titleOff</span>
        }
<span class="nc" id="L291">    }</span>

    /*
     * User toggled the main switch
     */
    override fun onCheckedChanged(buttonView: CompoundButton?, isChecked: Boolean) {
<span class="nc" id="L297">        setToolbarTitle(isChecked)</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        mainSwitchToolbarListener?.onMainSwitchCheckedChanged(buttonView, isChecked)</span>
<span class="nc" id="L299">    }</span>

    fun setMainSwitchToolbarListener(mainSwitchToolbarListener: MainSwitchToolbarListener) {
<span class="nc" id="L302">        this.mainSwitchToolbarListener = mainSwitchToolbarListener</span>
<span class="nc" id="L303">    }</span>
<span class="nc" id="L304">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>