<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PersonDetailFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wordpressJalapenoDebug</a> &gt; <a href="index.source.html" class="el_package">org.wordpress.android.ui.people</a> &gt; <span class="el_source">PersonDetailFragment.java</span></div><h1>PersonDetailFragment.java</h1><pre class="source lang-java linenums">package org.wordpress.android.ui.people;

import android.os.Bundle;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;

import androidx.appcompat.app.ActionBar;
import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;
import androidx.fragment.app.Fragment;

import org.apache.commons.text.StringEscapeUtils;
import org.jetbrains.annotations.NotNull;
import org.wordpress.android.R;
import org.wordpress.android.WordPress;
import org.wordpress.android.datasets.PeopleTable;
import org.wordpress.android.fluxc.model.RoleModel;
import org.wordpress.android.fluxc.model.SiteModel;
import org.wordpress.android.fluxc.store.SiteStore;
import org.wordpress.android.models.Person;
import org.wordpress.android.models.RoleUtils;
import org.wordpress.android.util.AppLog;
import org.wordpress.android.util.GravatarUtils;
import org.wordpress.android.util.image.ImageManager;
import org.wordpress.android.util.image.ImageType;

import java.text.SimpleDateFormat;
import java.util.List;

import javax.inject.Inject;

<span class="nc" id="L39">public class PersonDetailFragment extends Fragment {</span>
    private static final String ARG_CURRENT_USER_ID = &quot;current_user_id&quot;;
    private static final String ARG_PERSON_ID = &quot;person_id&quot;;
    private static final String ARG_LOCAL_TABLE_BLOG_ID = &quot;local_table_blog_id&quot;;
    private static final String ARG_PERSON_TYPE = &quot;person_type&quot;;

    private long mCurrentUserId;
    private long mPersonId;
    private int mLocalTableBlogId;
    private Person.PersonType mPersonType;

    private List&lt;RoleModel&gt; mUserRoles;

    private ImageView mAvatarImageView;
    private TextView mDisplayNameTextView;
    private TextView mUsernameTextView;
    private LinearLayout mRoleContainer;
    private TextView mRoleTextView;
    private LinearLayout mSubscribedDateContainer;
    private TextView mSubscribedDateTitleView;
    private TextView mSubscribedDateTextView;

    @Inject SiteStore mSiteStore;
    @Inject ImageManager mImageManager;

    public static PersonDetailFragment newInstance(long currentUserId, long personId, int localTableBlogId,
                                                   Person.PersonType personType) {
<span class="nc" id="L66">        PersonDetailFragment personDetailFragment = new PersonDetailFragment();</span>
<span class="nc" id="L67">        Bundle bundle = new Bundle();</span>
<span class="nc" id="L68">        bundle.putLong(ARG_CURRENT_USER_ID, currentUserId);</span>
<span class="nc" id="L69">        bundle.putLong(ARG_PERSON_ID, personId);</span>
<span class="nc" id="L70">        bundle.putInt(ARG_LOCAL_TABLE_BLOG_ID, localTableBlogId);</span>
<span class="nc" id="L71">        bundle.putSerializable(ARG_PERSON_TYPE, personType);</span>
<span class="nc" id="L72">        personDetailFragment.setArguments(bundle);</span>
<span class="nc" id="L73">        return personDetailFragment;</span>
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L78">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L79">        ((WordPress) getActivity().getApplicationContext()).component().inject(this);</span>

<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (savedInstanceState == null) {</span>
<span class="nc" id="L82">            mCurrentUserId = getArguments().getLong(ARG_CURRENT_USER_ID);</span>
<span class="nc" id="L83">            mPersonId = getArguments().getLong(ARG_PERSON_ID);</span>
<span class="nc" id="L84">            mLocalTableBlogId = getArguments().getInt(ARG_LOCAL_TABLE_BLOG_ID);</span>
<span class="nc" id="L85">            mPersonType = (Person.PersonType) getArguments().getSerializable(ARG_PERSON_TYPE);</span>
        } else {
<span class="nc" id="L87">            mCurrentUserId = savedInstanceState.getLong(ARG_CURRENT_USER_ID);</span>
<span class="nc" id="L88">            mPersonId = savedInstanceState.getLong(ARG_PERSON_ID);</span>
<span class="nc" id="L89">            mLocalTableBlogId = savedInstanceState.getInt(ARG_LOCAL_TABLE_BLOG_ID);</span>
<span class="nc" id="L90">            mPersonType = (Person.PersonType) savedInstanceState.getSerializable(ARG_PERSON_TYPE);</span>
        }

<span class="nc" id="L93">        SiteModel siteModel = mSiteStore.getSiteByLocalId(mLocalTableBlogId);</span>
<span class="nc" id="L94">        mUserRoles = mSiteStore.getUserRoles(siteModel);</span>
<span class="nc" id="L95">    }</span>

    @Override
    public void onSaveInstanceState(@NotNull Bundle outState) {
<span class="nc" id="L99">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L100">        outState.putLong(ARG_CURRENT_USER_ID, mCurrentUserId);</span>
<span class="nc" id="L101">        outState.putLong(ARG_PERSON_ID, mPersonId);</span>
<span class="nc" id="L102">        outState.putInt(ARG_LOCAL_TABLE_BLOG_ID, mLocalTableBlogId);</span>
<span class="nc" id="L103">        outState.putSerializable(ARG_PERSON_TYPE, mPersonType);</span>
<span class="nc" id="L104">    }</span>

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
<span class="nc" id="L108">        inflater.inflate(R.menu.person_detail, menu);</span>
<span class="nc" id="L109">        super.onCreateOptionsMenu(menu, inflater);</span>
<span class="nc" id="L110">    }</span>

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
<span class="nc" id="L114">        final ViewGroup rootView = (ViewGroup) inflater.inflate(R.layout.person_detail_fragment, container, false);</span>

<span class="nc" id="L116">        Toolbar toolbar = rootView.findViewById(R.id.toolbar_main);</span>
<span class="nc" id="L117">        ((AppCompatActivity) getActivity()).setSupportActionBar(toolbar);</span>
<span class="nc" id="L118">        ActionBar actionBar = ((AppCompatActivity) getActivity()).getSupportActionBar();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (actionBar != null) {</span>
<span class="nc" id="L120">            actionBar.setHomeButtonEnabled(true);</span>
<span class="nc" id="L121">            actionBar.setDisplayHomeAsUpEnabled(true);</span>
<span class="nc" id="L122">            actionBar.setTitle(null);</span>
        }

<span class="nc" id="L125">        mAvatarImageView = rootView.findViewById(R.id.person_avatar);</span>
<span class="nc" id="L126">        mDisplayNameTextView = rootView.findViewById(R.id.person_display_name);</span>
<span class="nc" id="L127">        mUsernameTextView = rootView.findViewById(R.id.person_username);</span>
<span class="nc" id="L128">        mRoleContainer = rootView.findViewById(R.id.person_role_container);</span>
<span class="nc" id="L129">        mRoleTextView = rootView.findViewById(R.id.person_role);</span>
<span class="nc" id="L130">        mSubscribedDateContainer = rootView.findViewById(R.id.subscribed_date_container);</span>
<span class="nc" id="L131">        mSubscribedDateTitleView = rootView.findViewById(R.id.subscribed_date_title);</span>
<span class="nc" id="L132">        mSubscribedDateTextView = rootView.findViewById(R.id.subscribed_date_text);</span>

<span class="nc bnc" id="L134" title="All 2 branches missed.">        boolean isCurrentUser = mCurrentUserId == mPersonId;</span>
<span class="nc" id="L135">        SiteModel site = mSiteStore.getSiteByLocalId(mLocalTableBlogId);</span>
<span class="nc bnc" id="L136" title="All 6 branches missed.">        if (!isCurrentUser &amp;&amp; site != null &amp;&amp; site.getHasCapabilityRemoveUsers()) {</span>
<span class="nc" id="L137">            setHasOptionsMenu(true);</span>
        }

<span class="nc" id="L140">        return rootView;</span>
    }

    @Override
    public void onResume() {
<span class="nc" id="L145">        super.onResume();</span>

<span class="nc" id="L147">        refreshPersonDetails();</span>
<span class="nc" id="L148">    }</span>

    void refreshPersonDetails() {
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (!isAdded()) {</span>
<span class="nc" id="L152">            return;</span>
        }

<span class="nc" id="L155">        Person person = loadPerson();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (person != null) {</span>
<span class="nc" id="L157">            int avatarSz = getResources().getDimensionPixelSize(R.dimen.people_avatar_sz);</span>
<span class="nc" id="L158">            String avatarUrl = GravatarUtils.fixGravatarUrl(person.getAvatarUrl(), avatarSz);</span>

<span class="nc" id="L160">            mImageManager.loadIntoCircle(mAvatarImageView, ImageType.AVATAR_WITH_BACKGROUND, avatarUrl);</span>
<span class="nc" id="L161">            mDisplayNameTextView.setText(StringEscapeUtils.unescapeHtml4(person.getDisplayName()));</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (person.getRole() != null) {</span>
<span class="nc" id="L163">                mRoleTextView.setText(RoleUtils.getDisplayName(person.getRole(), mUserRoles));</span>
            }

<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (!TextUtils.isEmpty(person.getUsername())) {</span>
<span class="nc" id="L167">                mUsernameTextView.setText(String.format(&quot;@%s&quot;, person.getUsername()));</span>
            }

<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (mPersonType == Person.PersonType.USER) {</span>
<span class="nc" id="L171">                mRoleContainer.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L172">                setupRoleContainerForCapability();</span>
            } else {
<span class="nc" id="L174">                mRoleContainer.setVisibility(View.GONE);</span>
            }

<span class="nc bnc" id="L177" title="All 4 branches missed.">            if (mPersonType == Person.PersonType.USER || mPersonType == Person.PersonType.VIEWER) {</span>
<span class="nc" id="L178">                mSubscribedDateContainer.setVisibility(View.GONE);</span>
            } else {
<span class="nc" id="L180">                mSubscribedDateContainer.setVisibility(View.VISIBLE);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (mPersonType == Person.PersonType.FOLLOWER) {</span>
<span class="nc" id="L182">                    mSubscribedDateTitleView.setText(R.string.title_follower);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                } else if (mPersonType == Person.PersonType.EMAIL_FOLLOWER) {</span>
<span class="nc" id="L184">                    mSubscribedDateTitleView.setText(R.string.title_email_follower);</span>
                }
<span class="nc" id="L186">                String dateSubscribed = SimpleDateFormat.getDateInstance().format(person.getDateSubscribed());</span>
<span class="nc" id="L187">                String dateText = getString(R.string.follower_subscribed_since, dateSubscribed);</span>
<span class="nc" id="L188">                mSubscribedDateTextView.setText(dateText);</span>
            }

            // Adds extra padding to display name for email followers to make it vertically centered
<span class="nc bnc" id="L192" title="All 2 branches missed.">            int padding = mPersonType == Person.PersonType.EMAIL_FOLLOWER</span>
<span class="nc" id="L193">                    ? (int) getResources().getDimension(R.dimen.margin_small) : 0;</span>
<span class="nc" id="L194">            changeDisplayNameTopPadding(padding);</span>
<span class="nc" id="L195">        } else {</span>
<span class="nc" id="L196">            AppLog.w(AppLog.T.PEOPLE, &quot;Person returned null from DB for personID: &quot; + mPersonId</span>
                                      + &quot; &amp; localTableBlogID: &quot; + mLocalTableBlogId);
        }
<span class="nc" id="L199">    }</span>

    void setPersonDetails(long personID, int localTableBlogID) {
<span class="nc" id="L202">        mPersonId = personID;</span>
<span class="nc" id="L203">        mLocalTableBlogId = localTableBlogID;</span>
<span class="nc" id="L204">        refreshPersonDetails();</span>
<span class="nc" id="L205">    }</span>

    // Checks current user's capabilities to decide whether she can change the role or not
    private void setupRoleContainerForCapability() {
<span class="nc" id="L209">        SiteModel site = mSiteStore.getSiteByLocalId(mLocalTableBlogId);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        boolean isCurrentUser = mCurrentUserId == mPersonId;</span>
<span class="nc bnc" id="L211" title="All 6 branches missed.">        boolean canChangeRole = (site != null) &amp;&amp; !isCurrentUser &amp;&amp; site.getHasCapabilityPromoteUsers();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (canChangeRole) {</span>
<span class="nc" id="L213">            mRoleContainer.setOnClickListener(v -&gt; showRoleChangeDialog());</span>
        } else {
            // Remove the selectableItemBackground if the user can't be edited
<span class="nc" id="L216">            mRoleContainer.setBackground(null);</span>
            // Change transparency to give a visual cue to the user that it's disabled
<span class="nc" id="L218">            mRoleContainer.setAlpha(0.5f);</span>
        }
<span class="nc" id="L220">    }</span>

    private void showRoleChangeDialog() {
<span class="nc" id="L223">        Person person = loadPerson();</span>
<span class="nc bnc" id="L224" title="All 4 branches missed.">        if (person == null || person.getRole() == null) {</span>
<span class="nc" id="L225">            return;</span>
        }

<span class="nc" id="L228">        RoleChangeDialogFragment dialog = RoleChangeDialogFragment.newInstance(person.getPersonID(),</span>
<span class="nc" id="L229">                mSiteStore.getSiteByLocalId(</span>
                        mLocalTableBlogId),
<span class="nc" id="L231">                person.getRole());</span>
<span class="nc" id="L232">        dialog.show(getFragmentManager(), null);</span>
<span class="nc" id="L233">    }</span>

    // used to optimistically update the role
    void changeRole(String newRole) {
<span class="nc" id="L237">        mRoleTextView.setText(RoleUtils.getDisplayName(newRole, mUserRoles));</span>
<span class="nc" id="L238">    }</span>

    private void changeDisplayNameTopPadding(int newPadding) {
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (mDisplayNameTextView == null) {</span>
<span class="nc" id="L242">            return;</span>
        }
<span class="nc" id="L244">        mDisplayNameTextView.setPadding(0, newPadding, 0, 0);</span>
<span class="nc" id="L245">    }</span>

    Person loadPerson() {
<span class="nc" id="L248">        return PeopleTable.getPerson(mPersonId, mLocalTableBlogId, mPersonType);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Generated by the Android Gradle plugin 7.1.1</div></body></html>