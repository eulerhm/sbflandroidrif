<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">agencyXGoogleDebug</a> &gt; <a href="index.source.html" class="el_package">org.onebusaway.android.io.request</a> &gt; <span class="el_source">RequestBase.java</span></div><h1>RequestBase.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2010-2016 Paul Watts (paulcwatts@gmail.com)
 * University of South Florida (cagricetin@mail.usf.edu)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onebusaway.android.io.request;

import org.onebusaway.android.io.ObaApi;
import org.onebusaway.android.io.ObaConnection;
import org.onebusaway.android.io.ObaContext;

import android.content.Context;
import android.net.Uri;
import android.os.Build;
import android.util.Log;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.Reader;
import java.net.HttpURLConnection;

/**
 * The base class for Oba requests.
 *
 * @author Paul Watts (paulcwatts@gmail.com)
 */
public class RequestBase {

    private static final String TAG = &quot;RequestBase&quot;;

    protected final Uri mUri;

    protected final String mPostData;

<span class="fc" id="L46">    protected RequestBase(Uri uri) {</span>
<span class="fc" id="L47">        mUri = uri;</span>
<span class="fc" id="L48">        mPostData = null;</span>
<span class="fc" id="L49">    }</span>

<span class="nc" id="L51">    protected RequestBase(Uri uri, String postData) {</span>
<span class="nc" id="L52">        mUri = uri;</span>
<span class="nc" id="L53">        mPostData = postData;</span>
<span class="nc" id="L54">    }</span>

    public Uri getUri() {
<span class="nc" id="L57">        return mUri;</span>
    }

    public static class BuilderBase {

        protected static final String BASE_PATH = &quot;api/where&quot;;

        protected final Uri.Builder mBuilder;

        protected ObaContext mObaContext;

        protected Context mContext;

<span class="fc" id="L70">        protected boolean mIsOtp = false;</span>

        protected BuilderBase(Context context, String path) {
<span class="fc" id="L73">            this(context, null, path);</span>
<span class="fc" id="L74">        }</span>

<span class="fc" id="L76">        protected BuilderBase(Context context, ObaContext obaContext, String path) {</span>
<span class="fc" id="L77">            mContext = context;</span>
<span class="fc" id="L78">            mObaContext = obaContext;</span>
<span class="fc" id="L79">            mBuilder = new Uri.Builder();</span>
<span class="fc" id="L80">            mBuilder.path(path);</span>
<span class="fc" id="L81">        }</span>

        protected static String getPathWithId(String pathElement, String id) {
<span class="fc" id="L84">            StringBuilder builder = new StringBuilder(BASE_PATH);</span>
<span class="fc" id="L85">            builder.append(pathElement);</span>
<span class="fc" id="L86">            builder.append(Uri.encode(id));</span>
<span class="fc" id="L87">            builder.append(&quot;.json&quot;);</span>
<span class="fc" id="L88">            return builder.toString();</span>
        }

        // INJECTED FAULT: IF-APC
        protected Uri buildUri() {
<span class="fc" id="L93">            ObaContext context = ObaApi.getDefaultContext();</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            if (mIsOtp) {</span>
<span class="nc" id="L95">                context.setBaseOtpUrl(mContext, mBuilder);</span>
            } else {
<span class="fc" id="L97">                context.setBaseUrl(mContext, mBuilder);</span>
<span class="fc" id="L98">                context.setAppInfo(mBuilder);</span>
<span class="fc" id="L99">                mBuilder.appendQueryParameter(&quot;version&quot;, &quot;2&quot;);</span>
<span class="fc" id="L100">                mBuilder.appendQueryParameter(&quot;key&quot;, context.getApiKey());</span>
            }
<span class="fc" id="L102">            return mBuilder.build();</span>
        }

        public ObaContext getObaContext() {
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (mObaContext == null) {</span>
<span class="nc" id="L107">                mObaContext = ObaApi.getDefaultContext().clone();</span>
            }
<span class="nc" id="L109">            return mObaContext;</span>
        }

        protected void setIsOtp(Boolean isOtp) {
<span class="nc" id="L113">            mIsOtp = isOtp;</span>
<span class="nc" id="L114">        }</span>
    }

    /**
     * Subclass for BuilderBase that can handle post data as well.
     *
     * @author paulw
     */
    public static class PostBuilderBase extends BuilderBase {

        protected final Uri.Builder mPostData;

        protected PostBuilderBase(Context context, String path) {
<span class="nc" id="L127">            super(context, path);</span>
<span class="nc" id="L128">            mPostData = new Uri.Builder();</span>
<span class="nc" id="L129">        }</span>

        public String buildPostData() {
<span class="nc" id="L132">            return mPostData.build().getEncodedQuery();</span>
        }
    }

    protected &lt;T&gt; T call(Class&lt;T&gt; cls) {
<span class="fc" id="L137">        ObaApi.SerializationHandler handler = ObaApi.getSerializer(cls);</span>
<span class="fc" id="L138">        ObaConnection conn = null;</span>
        try {
<span class="fc" id="L140">            conn = ObaApi.getDefaultContext().getConnectionFactory().newConnection(mUri);</span>
            Reader reader;
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">            if (mPostData != null) {</span>
<span class="nc" id="L143">                reader = conn.post(mPostData);</span>
            } else {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.GINGERBREAD) {</span>
                    // Theoretically you can't call ResponseCode before calling
                    // getInputStream, but you can't read from the input stream
                    // before you read the response???
<span class="fc" id="L149">                    int responseCode = conn.getResponseCode();</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                    if (responseCode != HttpURLConnection.HTTP_OK) {</span>
<span class="nc" id="L151">                        return handler.createFromError(cls, responseCode, &quot;&quot;);</span>
                    }
                }

<span class="fc" id="L155">                reader = conn.get();</span>
            }
<span class="fc" id="L157">            T t = handler.deserialize(reader, cls);</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">            if (t == null) {</span>
<span class="nc" id="L159">                t = handler.createFromError(cls, ObaApi.OBA_INTERNAL_ERROR, &quot;Json error&quot;);</span>
            }
<span class="fc" id="L161">            return t;</span>
<span class="nc" id="L162">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L163">            Log.e(TAG, e.toString());</span>
<span class="nc" id="L164">            return handler.createFromError(cls, ObaApi.OBA_NOT_FOUND, e.toString());</span>
<span class="nc" id="L165">        } catch (IOException e) {</span>
<span class="nc" id="L166">            Log.e(TAG, e.toString());</span>
<span class="nc" id="L167">            return handler.createFromError(cls, ObaApi.OBA_IO_EXCEPTION, e.toString());</span>
        } finally {
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">            if (conn != null) {</span>
<span class="fc" id="L170">                conn.disconnect();</span>
            }
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span>Generated by the Android Gradle plugin 8.2.0</div></body></html>